{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MTcwODc0", "number": 3054, "title": "[Bug]Fix invalid rollback for stream load txn", "bodyText": "For #3053", "createdAt": "2020-03-07T16:58:45Z", "url": "https://github.com/apache/incubator-doris/pull/3054", "merged": true, "mergeCommit": {"oid": "b9b9a11eae97249163c9d193745ee9bff2a889b6"}, "closed": true, "closedAt": "2020-03-09T14:07:37Z", "author": {"login": "WingsGo"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLXt0rgH2gAyMzg1MTcwODc0OjkwZDY4NzdmYWZiZDJjYmMzMTljNjQ2ZGQyNzQyNmRhOGVhYmRkNTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcL90qngFqTM3MTE3NTk3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "90d6877fafbd2cbc319c646dd27426da8eabdd54", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/90d6877fafbd2cbc319c646dd27426da8eabdd54", "committedDate": "2020-03-07T16:57:07Z", "message": "Fix invalid rollback for stream load txn"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwODc5OTI0", "url": "https://github.com/apache/incubator-doris/pull/3054#pullrequestreview-370879924", "createdAt": "2020-03-09T01:33:21Z", "commit": {"oid": "90d6877fafbd2cbc319c646dd27426da8eabdd54"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwMTozMzoyMVrOFzY8RQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwMTozMzoyMVrOFzY8RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQzMDM0MQ==", "bodyText": "If you change this code, when FE return PUBLISH_TIMEOUT, here it will just return Status:OK() to the upper caller?\nI think we should return PUBLISH_TIMEOUT directly, but set ctx->need_rollback = false to false", "url": "https://github.com/apache/incubator-doris/pull/3054#discussion_r389430341", "createdAt": "2020-03-09T01:33:21Z", "author": {"login": "morningman"}, "path": "be/src/runtime/stream_load/stream_load_executor.cpp", "diffHunk": "@@ -188,7 +188,7 @@ Status StreamLoadExecutor::commit_txn(StreamLoadContext* ctx) {\n     // Return if this transaction is committed successful; otherwise, we need try to\n     // rollback this transaction\n     Status status(result.status);\n-    if (!status.ok()) {\n+    if (!status.ok() && status.code() != TStatusCode::PUBLISH_TIMEOUT) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90d6877fafbd2cbc319c646dd27426da8eabdd54"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ca0de98ade49f9d91123aa9efd75cbc102dfb40", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/5ca0de98ade49f9d91123aa9efd75cbc102dfb40", "committedDate": "2020-03-09T02:00:13Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0928505757f7e0714f232517973e2237a7a07e3", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/d0928505757f7e0714f232517973e2237a7a07e3", "committedDate": "2020-03-09T03:31:00Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwOTAzNTc0", "url": "https://github.com/apache/incubator-doris/pull/3054#pullrequestreview-370903574", "createdAt": "2020-03-09T03:38:55Z", "commit": {"oid": "5ca0de98ade49f9d91123aa9efd75cbc102dfb40"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwMzozODo1NVrOFzaNGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwMzozODo1NVrOFzaNGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ1MTAzNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (status.code() != TStatusCode::PUBLISH_TIMEOUT) {\n          \n          \n            \n                    if (status.code() == TStatusCode::PUBLISH_TIMEOUT) {", "url": "https://github.com/apache/incubator-doris/pull/3054#discussion_r389451034", "createdAt": "2020-03-09T03:38:55Z", "author": {"login": "morningman"}, "path": "be/src/runtime/stream_load/stream_load_executor.cpp", "diffHunk": "@@ -178,19 +180,24 @@ Status StreamLoadExecutor::commit_txn(StreamLoadContext* ctx) {\n     TLoadTxnCommitResult result;\n #ifndef BE_TEST\n     RETURN_IF_ERROR(ThriftRpcHelper::rpc<FrontendServiceClient>(\n-        master_addr.hostname, master_addr.port,\n-        [&request, &result] (FrontendServiceConnection& client) {\n-            client->loadTxnCommit(result, request);\n-        }, config::txn_commit_rpc_timeout_ms));\n+            master_addr.hostname, master_addr.port,\n+            [&request, &result](FrontendServiceConnection& client) {\n+                client->loadTxnCommit(result, request);\n+            },\n+            config::txn_commit_rpc_timeout_ms));\n #else\n     result = k_stream_load_commit_result;\n #endif\n-    // Return if this transaction is committed successful; otherwise, we need try to\n+    // Return if this transaction is committed successful; otherwise, we need try\n+    // to\n     // rollback this transaction\n     Status status(result.status);\n-    if (!status.ok() && status.code() != TStatusCode::PUBLISH_TIMEOUT) {\n+    if (!status.ok()) {\n         LOG(WARNING) << \"commit transaction failed, errmsg=\" << status.get_error_msg()\n-            << ctx->brief();\n+                     << ctx->brief();\n+        if (status.code() != TStatusCode::PUBLISH_TIMEOUT) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ca0de98ade49f9d91123aa9efd75cbc102dfb40"}, "originalPosition": 167}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMTc1OTc1", "url": "https://github.com/apache/incubator-doris/pull/3054#pullrequestreview-371175975", "createdAt": "2020-03-09T13:20:59Z", "commit": {"oid": "d0928505757f7e0714f232517973e2237a7a07e3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3520, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}