{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMTcwOTQ2", "number": 3305, "title": "[Doris On ES] Add field context for string field keyword type", "bodyText": "#3304\nThis PR is just a transitional way\uff0cbut it is better to move the predicates transformation from Doris BE to Doris BE, in this way, Doris BE is responsible for fetching data from ES.\nAdd a  enable_keyword_sniff  configuration item in creating External Elasticsearch Table \uff0cit default to true , would to sniff the keyword type on the text analyzed Field and return the json_path which substitute the origin col name.\nCREATE EXTERNAL TABLE `test` (\n  `k1` varchar(20) COMMENT \"\",\n  `create_time` datetime COMMENT \"\"\n) ENGINE=ELASTICSEARCH\nPROPERTIES (\n\"hosts\" = \"http://10.74.167.16:8200\",\n\"user\" = \"root\",\n\"password\" = \"root\",\n\"index\" = \"test\",\n\"type\" = \"doc\",\n\"enable_keyword_sniff\" = \"true\"\n);\n\nnote: enable_keyword_sniff default to  \"true\"\nrun this SQL\uff1a\nselect * from test where k1 = \"wu yun feng\"\n\nOutput predicate DSL\uff1a\n{\"term\":{\"k1.keyword\":\"wu yun feng\"}}\n\nand in this PR, I remove the elasticsearch version detected logic for now this is useless, maybe future is needed.", "createdAt": "2020-04-11T10:25:34Z", "url": "https://github.com/apache/incubator-doris/pull/3305", "merged": true, "mergeCommit": {"oid": "a467c6f81f5c7bd81c94401ee75ad84ab1dc4739"}, "closed": true, "closedAt": "2020-04-13T15:07:33Z", "author": {"login": "wuyunfeng"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWjFbEgH2gAyNDAyMTcwOTQ2OjEyZWVkZmJjZTk0MTljMWUwMmUzYjFlNGY2ZDZkMWM5YjhmNjc5NDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXQUQmgFqTM5MjIwNDI1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946", "committedDate": "2020-04-11T10:25:01Z", "message": "Add field context for string field keyword type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzU1ODc0", "url": "https://github.com/apache/incubator-doris/pull/3305#pullrequestreview-391755874", "createdAt": "2020-04-11T10:42:01Z", "commit": {"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMDo0MjowMVrOGEMPcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMDo0MjowMVrOGEMPcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA0ODA1MA==", "bodyText": "!table.fieldsContext().isEmpty()\u662f\u4e0d\u662f\u66f4\u597d\u4e00\u70b9", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407048050", "createdAt": "2020-04-11T10:42:01Z", "author": {"login": "stalary"}, "path": "fe/src/main/java/org/apache/doris/planner/EsScanNode.java", "diffHunk": "@@ -123,6 +123,9 @@ protected void toThrift(TPlanNode msg) {\n         if (table.isDocValueScanEnable()) {\n             esScanNode.setDocvalue_context(table.docValueContext());\n         }\n+        if (table.isKeywordSniffEnable() && table.fieldsContext().size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzU2ODI1", "url": "https://github.com/apache/incubator-doris/pull/3305#pullrequestreview-391756825", "createdAt": "2020-04-11T10:57:52Z", "commit": {"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzY0OTc2", "url": "https://github.com/apache/incubator-doris/pull/3305#pullrequestreview-391764976", "createdAt": "2020-04-11T13:08:54Z", "commit": {"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMzowODo1NFrOGENGYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMzowODo1NFrOGENGYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2MjExMw==", "bodyText": "better to call set_ field_context", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407062113", "createdAt": "2020-04-11T13:08:54Z", "author": {"login": "morningman"}, "path": "be/src/exec/es/es_predicate.h", "diffHunk": "@@ -198,6 +198,10 @@ class EsPredicate {\n         return _es_query_status;\n     }\n \n+    void field_context(const std::map<std::string, std::string>& field_context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzY4MjY3", "url": "https://github.com/apache/incubator-doris/pull/3305#pullrequestreview-391768267", "createdAt": "2020-04-11T13:53:23Z", "commit": {"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMzo1MzoyNFrOGENYGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMzo1MzoyNFrOGENYGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2NjY0OQ==", "bodyText": "Repeat four times.\n        std::string col = slot_desc->col_name();\n        if (_field_context.find(col) != _field_context.end()) {\n            col = _field_context[col];\n        }", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407066649", "createdAt": "2020-04-11T13:53:24Z", "author": {"login": "kangkaisen"}, "path": "be/src/exec/es/es_predicate.cpp", "diffHunk": "@@ -298,8 +302,12 @@ Status EsPredicate::build_disjuncts_list(const Expr* conjunct) {\n         } else {\n             is_not_null = true;\n         }\n+        std::string col = slot_desc->col_name();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5fcb59fd873790382af6006bab880a0126e6947", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/e5fcb59fd873790382af6006bab880a0126e6947", "committedDate": "2020-04-11T15:51:46Z", "message": "modify some code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fc9980c7bdd27252de962ae39ce8218dd9d3386", "author": {"user": {"login": "wuyunfeng", "name": "Yunfeng,Wu"}}, "url": "https://github.com/apache/incubator-doris/commit/2fc9980c7bdd27252de962ae39ce8218dd9d3386", "committedDate": "2020-04-12T12:02:12Z", "message": "Change default value"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMTM5OTM2", "url": "https://github.com/apache/incubator-doris/pull/3305#pullrequestreview-392139936", "createdAt": "2020-04-13T13:22:55Z", "commit": {"oid": "2fc9980c7bdd27252de962ae39ce8218dd9d3386"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxMzoyMjo1NVrOGEmUrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxMzozOTowNVrOGEmwQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ3NTM3NA==", "bodyText": "If this is only used for keyword path, fields_context seems no relation with keyword", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407475374", "createdAt": "2020-04-13T13:22:55Z", "author": {"login": "imay"}, "path": "gensrc/thrift/PlanNodes.thrift", "diffHunk": "@@ -222,6 +222,18 @@ struct TEsScanNode {\n     // {\"city\": \"city.raw\"}\n     // use select city from table, if enable the docvalue, we will fetch the `city` field value from `city.raw`\n     3: optional map<string, string> docvalue_context\n+    // used to indicate which string-type field predicate should used xxx.keyword etc.\n+    // \"k1\": {\n+    //    \"type\": \"text\",\n+    //    \"fields\": {\n+    //        \"keyword\": {\n+    //            \"type\": \"keyword\",\n+    //            \"ignore_above\": 256\n+    //           }\n+    //    }\n+    // }\n+    // k1 > 'abc' -> k1.keyword > 'abc'\n+    4: optional map<string, string> fields_context", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc9980c7bdd27252de962ae39ce8218dd9d3386"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4MjQzMw==", "bodyText": "ignorecase compare?", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407482433", "createdAt": "2020-04-13T13:39:05Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/external/EsStateStore.java", "diffHunk": "@@ -209,36 +206,54 @@ public EsTableState parseClusterState55(String responseStr, EsTable esTable)\n                 }\n                 JSONObject fieldObject = schema.optJSONObject(colName);\n                 String fieldType = fieldObject.optString(\"type\");\n-                if (EsTable.DEFAULT_DOCVALUE_DISABLED_FIELDS.contains(fieldType)) {\n-                    JSONObject fieldsObject = fieldObject.optJSONObject(\"fields\");\n-                    if (fieldsObject != null) {\n-                        for (String key : fieldsObject.keySet()) {\n-                            JSONObject innerTypeObject = fieldsObject.optJSONObject(key);\n-                            if (EsTable.DEFAULT_DOCVALUE_DISABLED_FIELDS.contains(innerTypeObject.optString(\"type\"))) {\n-                                continue;\n-                            }\n-                            if (innerTypeObject.has(\"doc_values\")) {\n-                                boolean docValue = innerTypeObject.getBoolean(\"doc_values\");\n-                                if (docValue) {\n-                                    esTable.addDocValueField(colName, colName);\n+                // string-type field used keyword type to generate predicate\n+                if (esTable.isKeywordSniffEnable()) {\n+                    // if text field type seen, we should use the `field` keyword type?\n+                    if (\"text\".equals(fieldType)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc9980c7bdd27252de962ae39ce8218dd9d3386"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMjA0MjUz", "url": "https://github.com/apache/incubator-doris/pull/3305#pullrequestreview-392204253", "createdAt": "2020-04-13T15:06:57Z", "commit": {"oid": "2fc9980c7bdd27252de962ae39ce8218dd9d3386"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3229, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}