{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5NTk4Nzc5", "number": 3945, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjo0Mzo1NlrOEJHnMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjo1MzoyNlrOEJHzGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3OTk3MzYzOnYy", "diffSide": "RIGHT", "path": "be/src/util/file_cache.h", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjo0Mzo1NlrOGpfeQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQxMTowODo0MFrOGp8iDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MDQ0OQ==", "bodyText": "Here are 2 constructors of FileCache, and the difference is the first own the cache, the second does not own the cache.\nSo you should first add new field _is_cache_owned to indicate whether it owns the cache.\nSecondly, to modify the deconstructor of FileCache, only reset the cache if _is_cache_owned is true.", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446160449", "createdAt": "2020-06-26T12:43:56Z", "author": {"login": "morningman"}, "path": "be/src/util/file_cache.h", "diffHunk": "@@ -104,8 +104,16 @@ class FileCache {\n     // the number of files open at any given time.\n     FileCache(const std::string& cache_name, int max_open_files);\n \n+    // Creates a new file cache with given cache.\n+    //\n+    // The 'cache_name' is used to disambiguate amongst other file cache\n+    // instances.\n+    FileCache(const std::string& cache_name, std::shared_ptr<Cache> cache);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d3f884e28af0773893a8822f830c989b0a6ac85"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYzNjU1OA==", "bodyText": "done", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446636558", "createdAt": "2020-06-28T11:08:40Z", "author": {"login": "xy720"}, "path": "be/src/util/file_cache.h", "diffHunk": "@@ -104,8 +104,16 @@ class FileCache {\n     // the number of files open at any given time.\n     FileCache(const std::string& cache_name, int max_open_files);\n \n+    // Creates a new file cache with given cache.\n+    //\n+    // The 'cache_name' is used to disambiguate amongst other file cache\n+    // instances.\n+    FileCache(const std::string& cache_name, std::shared_ptr<Cache> cache);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MDQ0OQ=="}, "originalCommit": {"oid": "6d3f884e28af0773893a8822f830c989b0a6ac85"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3OTk4MTY3OnYy", "diffSide": "RIGHT", "path": "be/src/olap/storage_engine.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjo0NjoxMVrOGpfi5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQxMTowODoyMVrOGp8h-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MTYzOQ==", "bodyText": "remove the unused code.", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446161639", "createdAt": "2020-06-26T12:46:11Z", "author": {"login": "morningman"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -503,7 +507,8 @@ void StorageEngine::clear_transaction_task(const TTransactionId transaction_id,\n \n void StorageEngine::_start_clean_fd_cache() {\n     VLOG(10) << \"start clean file descritpor cache\";\n-    FileHandler::get_fd_cache()->prune();\n+    // FileHandler::get_fd_cache()->prune();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d3f884e28af0773893a8822f830c989b0a6ac85"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYzNjUzOA==", "bodyText": "ok", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446636538", "createdAt": "2020-06-28T11:08:21Z", "author": {"login": "xy720"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -503,7 +507,8 @@ void StorageEngine::clear_transaction_task(const TTransactionId transaction_id,\n \n void StorageEngine::_start_clean_fd_cache() {\n     VLOG(10) << \"start clean file descritpor cache\";\n-    FileHandler::get_fd_cache()->prune();\n+    // FileHandler::get_fd_cache()->prune();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MTYzOQ=="}, "originalCommit": {"oid": "6d3f884e28af0773893a8822f830c989b0a6ac85"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3OTk4MzQzOnYy", "diffSide": "RIGHT", "path": "be/src/olap/storage_engine.h", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjo0Njo0OFrOGpfkAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjo0Njo0OFrOGpfkAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MTkyMg==", "bodyText": "and comment for this field", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446161922", "createdAt": "2020-06-26T12:46:48Z", "author": {"login": "morningman"}, "path": "be/src/olap/storage_engine.h", "diffHunk": "@@ -297,6 +301,8 @@ class StorageEngine {\n     Cache* _file_descriptor_lru_cache;\n     Cache* _index_stream_lru_cache;\n \n+    std::shared_ptr<Cache> _file_cache;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d3f884e28af0773893a8822f830c989b0a6ac85"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3OTk5MTU4OnYy", "diffSide": "RIGHT", "path": "be/src/olap/storage_engine.cpp", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjo0OToxOFrOGpfo2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQxMToxMDoyNFrOGp8i3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MzE2MA==", "bodyText": "Add comment to emphasize that the _file_cache must be created before FileBlockManager.", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446163160", "createdAt": "2020-06-26T12:49:18Z", "author": {"login": "morningman"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -157,6 +158,8 @@ Status StorageEngine::_open() {\n \n     _index_stream_lru_cache = new_lru_cache(config::index_stream_cache_capacity);\n \n+    _file_cache.reset(new_lru_cache(config::file_descriptor_cache_capacity));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d3f884e28af0773893a8822f830c989b0a6ac85"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYzNjc2NQ==", "bodyText": "Add it above the _file_cache field.", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446636765", "createdAt": "2020-06-28T11:10:24Z", "author": {"login": "xy720"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -157,6 +158,8 @@ Status StorageEngine::_open() {\n \n     _index_stream_lru_cache = new_lru_cache(config::index_stream_cache_capacity);\n \n+    _file_cache.reset(new_lru_cache(config::file_descriptor_cache_capacity));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MzE2MA=="}, "originalCommit": {"oid": "6d3f884e28af0773893a8822f830c989b0a6ac85"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MDAwNDExOnYy", "diffSide": "RIGHT", "path": "be/src/olap/file_helper.cpp", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjo1MzoyN1rOGpfwqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQxMToxNjozNlrOGp8lGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2NTE2Mg==", "bodyText": "2 problems:\n\nYou should check that the storage engine is truly \"opened\", not just created, or the _file_cache in storage engine is sill null.\nIf StorageEngine::instance() == nullptr, the _s_fd_cache is null either. This could cause problems.\n\nFor problem 2, I suggest that you can modify the open_with_cache() method as below:\nOLAPStatus FileHandler::open_with_cache(const string& file_name, int flag) {\n    if (_cache == nullptr) {\n        return open(file_name, flag);\n    }\n\n    ....\n}", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446165162", "createdAt": "2020-06-26T12:53:27Z", "author": {"login": "morningman"}, "path": "be/src/olap/file_helper.cpp", "diffHunk": "@@ -44,9 +45,19 @@ FileHandler::FileHandler() :\n         _is_using_cache(false),\n         _cache_handle(NULL) {\n     static std::once_flag once_flag;\n-    std::call_once(once_flag, [] {\n-        _s_fd_cache = new_lru_cache(config::file_descriptor_cache_capacity);\n-    });\n+    #ifdef BE_TEST\n+        std::call_once(once_flag, [] {\n+            _s_fd_cache = new_lru_cache(config::file_descriptor_cache_capacity);\n+        });\n+    #else\n+        // storage engine may not be opened when doris try to read and write \n+        // temp file under the storage root path. So we need to check it.\n+        if (StorageEngine::instance() != nullptr) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d3f884e28af0773893a8822f830c989b0a6ac85"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE4NjA5Mg==", "bodyText": "And also, other place where _s_fd_cache is used should also be taken care of. The release method can be private, so it will only be called by close()", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446186092", "createdAt": "2020-06-26T13:32:29Z", "author": {"login": "morningman"}, "path": "be/src/olap/file_helper.cpp", "diffHunk": "@@ -44,9 +45,19 @@ FileHandler::FileHandler() :\n         _is_using_cache(false),\n         _cache_handle(NULL) {\n     static std::once_flag once_flag;\n-    std::call_once(once_flag, [] {\n-        _s_fd_cache = new_lru_cache(config::file_descriptor_cache_capacity);\n-    });\n+    #ifdef BE_TEST\n+        std::call_once(once_flag, [] {\n+            _s_fd_cache = new_lru_cache(config::file_descriptor_cache_capacity);\n+        });\n+    #else\n+        // storage engine may not be opened when doris try to read and write \n+        // temp file under the storage root path. So we need to check it.\n+        if (StorageEngine::instance() != nullptr) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2NTE2Mg=="}, "originalCommit": {"oid": "6d3f884e28af0773893a8822f830c989b0a6ac85"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYzNzMzNg==", "bodyText": "Thanks for advices! For problem 1, we can further check weather StorageEngine::instance()->file_cache() == nullptr.", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446637336", "createdAt": "2020-06-28T11:16:36Z", "author": {"login": "xy720"}, "path": "be/src/olap/file_helper.cpp", "diffHunk": "@@ -44,9 +45,19 @@ FileHandler::FileHandler() :\n         _is_using_cache(false),\n         _cache_handle(NULL) {\n     static std::once_flag once_flag;\n-    std::call_once(once_flag, [] {\n-        _s_fd_cache = new_lru_cache(config::file_descriptor_cache_capacity);\n-    });\n+    #ifdef BE_TEST\n+        std::call_once(once_flag, [] {\n+            _s_fd_cache = new_lru_cache(config::file_descriptor_cache_capacity);\n+        });\n+    #else\n+        // storage engine may not be opened when doris try to read and write \n+        // temp file under the storage root path. So we need to check it.\n+        if (StorageEngine::instance() != nullptr) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2NTE2Mg=="}, "originalCommit": {"oid": "6d3f884e28af0773893a8822f830c989b0a6ac85"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1314, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}