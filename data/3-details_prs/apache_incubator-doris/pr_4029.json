{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NzE0OTM0", "number": 4029, "title": "Support check committed txns before catalog drop meta, like db, table, partition etc", "bodyText": "This PR is to ensure that dropped db , table or partition can be with normal state after recovered by user.  Commited txns can not be aborted, because the partitions's commited versions have been changed, and some tablets may already have new visible versions. If user just don't want the meta(db, table or partition) anymore, just use dropp instead of drop to skip committed txn check.", "createdAt": "2020-07-06T11:30:18Z", "url": "https://github.com/apache/incubator-doris/pull/4029", "merged": true, "mergeCommit": {"oid": "150f8e0e2b5e6c0224554c75715d030efe64fa8d"}, "closed": true, "closedAt": "2020-07-28T07:18:53Z", "author": {"login": "caiconghui"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcySc4cAFqTQ0MzE0MzczOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4_-_oAFqTQ1NTY5MTAyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMTQzNzM5", "url": "https://github.com/apache/incubator-doris/pull/4029#pullrequestreview-443143739", "createdAt": "2020-07-06T14:46:19Z", "commit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo0NjoxOVrOGtaesA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo1MDozMlrOGtaqMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3Mjk0NA==", "bodyText": "Add a Preconditions.checkState( db.isWriteLockHeldByCurrentThread()) to NOTICE.", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450272944", "createdAt": "2020-07-06T14:46:19Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -716,7 +716,6 @@ public void processBatchDropRollup(List<AlterClause> dropRollupClauses, Database\n \n     public void processDropMaterializedView(DropMaterializedViewStmt dropMaterializedViewStmt, Database db,\n             OlapTable olapTable) throws DdlException, MetaNotFoundException {\n-        db.writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NDU2OA==", "bodyText": "There are still some transactions in the COMMITTED state waiting to be completed. The database cannot be dropped. If you want to force drop(cannot be recovered), please use \"DROPP database\";", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450274568", "createdAt": "2020-07-06T14:48:39Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -2666,6 +2666,13 @@ public void dropDb(DropDbStmt stmt) throws DdlException {\n             Database db = this.fullNameToDb.get(dbName);\n             db.writeLock();\n             try {\n+                if (stmt.isNeedCheckCommitedTxns()) {\n+                    if (Catalog.getCurrentCatalog().getGlobalTransactionMgr().existCommittedTxns(db.getId(), null, null)) {\n+                        throw new DdlException(\"There are still some commited txns cannot be aborted in db [\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NTMzOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public boolean isNeedCheckCommitedTxns() {\n          \n          \n            \n                public boolean isNeedCheckCommittedTxns() {", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450275338", "createdAt": "2020-07-06T14:49:44Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/DropTableStmt.java", "diffHunk": "@@ -61,6 +64,10 @@ public boolean isView() {\n         return isView;\n     }\n \n+    public boolean isNeedCheckCommitedTxns() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NTQyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public DropTableStmt(boolean ifExists, TableName tableName, boolean needCheckCommitedTxns) {\n          \n          \n            \n                public DropTableStmt(boolean ifExists, TableName tableName, boolean needCheckCommittedTxns) {", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450275423", "createdAt": "2020-07-06T14:49:50Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/DropTableStmt.java", "diffHunk": "@@ -32,17 +32,20 @@\n     private boolean ifExists;\n     private final TableName tableName;\n     private final boolean isView;\n+    private boolean needCheckCommitedTxns;\n \n-    public DropTableStmt(boolean ifExists, TableName tableName) {\n+    public DropTableStmt(boolean ifExists, TableName tableName, boolean needCheckCommitedTxns) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NTQ5OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean needCheckCommitedTxns;\n          \n          \n            \n                private boolean needCheckCommittedTxns;", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450275499", "createdAt": "2020-07-06T14:49:57Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/DropTableStmt.java", "diffHunk": "@@ -32,17 +32,20 @@\n     private boolean ifExists;\n     private final TableName tableName;\n     private final boolean isView;\n+    private boolean needCheckCommitedTxns;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NTY4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.needCheckCommitedTxns = needCheckCommitedTxns;\n          \n          \n            \n                    this.needCheckCommittedTxns = needCheckCommittedTxns;", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450275689", "createdAt": "2020-07-06T14:50:14Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/DropTableStmt.java", "diffHunk": "@@ -32,17 +32,20 @@\n     private boolean ifExists;\n     private final TableName tableName;\n     private final boolean isView;\n+    private boolean needCheckCommitedTxns;\n \n-    public DropTableStmt(boolean ifExists, TableName tableName) {\n+    public DropTableStmt(boolean ifExists, TableName tableName, boolean needCheckCommitedTxns) {\n         this.ifExists = ifExists;\n         this.tableName = tableName;\n         this.isView = false;\n+        this.needCheckCommitedTxns = needCheckCommitedTxns;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NTg5MQ==", "bodyText": "Duplicated if clause?", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450275891", "createdAt": "2020-07-06T14:50:32Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -3308,6 +3315,20 @@ public void dropPartition(Database db, OlapTable olapTable, DropPartitionClause\n         if (isTempPartition) {\n             olapTable.dropTempPartition(partitionName, true);\n         } else {\n+            if (clause.isNeedCheckCommitedTxns()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "032bbaf691e529f103ed8bd9acbc13b559087f83"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62de1eeff0d2b90f3881b012a341ccec2a92bc71", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/62de1eeff0d2b90f3881b012a341ccec2a92bc71", "committedDate": "2020-07-19T16:08:51Z", "message": "make force drop operation do not recycle meta"}, "afterCommit": {"oid": "4604338ca6d4f35a10aef464b51e2e4b839488aa", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/4604338ca6d4f35a10aef464b51e2e4b839488aa", "committedDate": "2020-07-23T02:39:36Z", "message": "make force drop operation do not recycle meta"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNTc0MjI4", "url": "https://github.com/apache/incubator-doris/pull/4029#pullrequestreview-443574228", "createdAt": "2020-07-07T05:36:08Z", "commit": {"oid": "c4c2ed10b9013d09f8d98d5c128f7337f88b2842"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNTozNjowOVrOGtvuxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQxMjo1Njo0MVrOGzvUHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYyMTEyNQ==", "bodyText": "DROPP is a not a good syntax. It's better to use\nDROP TABLE $table_name FORCE", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r450621125", "createdAt": "2020-07-07T05:36:09Z", "author": {"login": "chaoyli"}, "path": "fe/src/main/cup/sql_parser.cup", "diffHunk": "@@ -879,7 +879,11 @@ alter_table_clause ::=\n     :}\n     | KW_DROP opt_tmp:isTempPartition KW_PARTITION opt_if_exists:ifExists ident:partitionName\n     {:\n-        RESULT = new DropPartitionClause(ifExists, partitionName, isTempPartition);\n+        RESULT = new DropPartitionClause(ifExists, partitionName, isTempPartition, !isTempPartition);\n+    :}\n+    | KW_DROPP opt_tmp:isTempPartition KW_PARTITION opt_if_exists:ifExists ident:partitionName", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4c2ed10b9013d09f8d98d5c128f7337f88b2842"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkwNTc1Nw==", "bodyText": "DROP database FORCE. Use upper case will be better.", "url": "https://github.com/apache/incubator-doris/pull/4029#discussion_r456905757", "createdAt": "2020-07-19T12:56:41Z", "author": {"login": "chaoyli"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -2666,6 +2666,13 @@ public void dropDb(DropDbStmt stmt) throws DdlException {\n             Database db = this.fullNameToDb.get(dbName);\n             db.writeLock();\n             try {\n+                if (stmt.isNeedCheckCommittedTxns()) {\n+                    if (Catalog.getCurrentCatalog().getGlobalTransactionMgr().existCommittedTxns(db.getId(), null, null)) {\n+                       throw new DdlException(\"There are still some transactions in the COMMITTED state waiting to be completed. \" +\n+                               \"The database [\" + dbName +\"] cannot be dropped. If you want to forcibly drop(cannot be recovered),\" +\n+                               \" please use \\\"DROP database force\\\".\");\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6da313d589cef7426bfdad515ec89ea8f0c866d"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a88bfba98c0af0015757af23efaebb08a72a068", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/2a88bfba98c0af0015757af23efaebb08a72a068", "committedDate": "2020-07-27T06:45:45Z", "message": "Support check commited txns in Drop meta Stmt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae15642293ec866eb84ad39f3a9f2cef3d1cfedc", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/ae15642293ec866eb84ad39f3a9f2cef3d1cfedc", "committedDate": "2020-07-27T06:45:45Z", "message": "Fix drop meta check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a53df5f8f1cf99575f85937c3bc7381c49be9d63", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/a53df5f8f1cf99575f85937c3bc7381c49be9d63", "committedDate": "2020-07-27T06:45:45Z", "message": "Add Dropp stmt for force meta drop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9580912f416b94d74211a4fe68bf9ef1dfc643e2", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/9580912f416b94d74211a4fe68bf9ef1dfc643e2", "committedDate": "2020-07-27T06:45:46Z", "message": "Support commited txns check before drop db, table or partition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d57a8883f620eeb0b386ef5b3e5fc7c53241d038", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/d57a8883f620eeb0b386ef5b3e5fc7c53241d038", "committedDate": "2020-07-27T06:45:46Z", "message": "fix by review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f9484a91ef3c899dd6fdc2a9db75e58db2c05b4", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/3f9484a91ef3c899dd6fdc2a9db75e58db2c05b4", "committedDate": "2020-07-27T06:45:46Z", "message": "use drop force stmt to replace dropp stmt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59779e894a10e7864596680d7cc1f39b5e71b5e2", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/59779e894a10e7864596680d7cc1f39b5e71b5e2", "committedDate": "2020-07-27T06:57:32Z", "message": "make force drop operation do not recycle meta"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ee5998c3ba5347267adc74f5af838c45b48d911", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/5ee5998c3ba5347267adc74f5af838c45b48d911", "committedDate": "2020-07-27T07:08:20Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70b89d59dcca659f63c4bb8316e2f7a44736a488", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/70b89d59dcca659f63c4bb8316e2f7a44736a488", "committedDate": "2020-07-27T07:15:23Z", "message": "fix by review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4604338ca6d4f35a10aef464b51e2e4b839488aa", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/4604338ca6d4f35a10aef464b51e2e4b839488aa", "committedDate": "2020-07-23T02:39:36Z", "message": "make force drop operation do not recycle meta"}, "afterCommit": {"oid": "70b89d59dcca659f63c4bb8316e2f7a44736a488", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/70b89d59dcca659f63c4bb8316e2f7a44736a488", "committedDate": "2020-07-27T07:15:23Z", "message": "fix by review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e130fa8b04aab869e083239f4efbd0df57e11e41", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/e130fa8b04aab869e083239f4efbd0df57e11e41", "committedDate": "2020-07-27T07:28:32Z", "message": "revert add fe-core target file"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2ae4a578651e4a8ffad3f10f12bea409a508f25", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/e2ae4a578651e4a8ffad3f10f12bea409a508f25", "committedDate": "2020-07-27T07:25:50Z", "message": "revert add target files"}, "afterCommit": {"oid": "e130fa8b04aab869e083239f4efbd0df57e11e41", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/e130fa8b04aab869e083239f4efbd0df57e11e41", "committedDate": "2020-07-27T07:28:32Z", "message": "revert add fe-core target file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NjkxMDIz", "url": "https://github.com/apache/incubator-doris/pull/4029#pullrequestreview-455691023", "createdAt": "2020-07-27T11:18:40Z", "commit": {"oid": "e130fa8b04aab869e083239f4efbd0df57e11e41"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2317, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}