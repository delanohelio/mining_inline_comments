{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5Njg1MzQ4", "number": 3130, "title": "[Alter]Clear expire alterJobV2", "bodyText": "Too much AlterJobsV2 may consume too much memory, which may cause FullGC. Clear some data for finished or cancelled alterJobs and remove them when expire.", "createdAt": "2020-03-17T08:06:18Z", "url": "https://github.com/apache/incubator-doris/pull/3130", "merged": true, "mergeCommit": {"oid": "41815ef176bcf9c3704af2f0dfb4041d4e0c1b7b"}, "closed": true, "closedAt": "2020-03-18T12:27:10Z", "author": {"login": "WingsGo"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOdCAyAH2gAyMzg5Njg1MzQ4OjZhNTQyMGFmZWRiYjFiOGI2MDQ0YmQwMTVmZTJlMzE4YzIzYzg1ZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOj-AzAFqTM3NjExMjg5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6a5420afedbb1b8b6044bd015fe2e318c23c85e7", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/6a5420afedbb1b8b6044bd015fe2e318c23c85e7", "committedDate": "2020-03-17T06:50:28Z", "message": "[Alter]Clear expire finished or cancelled alter job avoid consume too much memory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fa3e23e7047f0d3ac7ad7f243eae9d2e718f303", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/8fa3e23e7047f0d3ac7ad7f243eae9d2e718f303", "committedDate": "2020-03-17T07:20:16Z", "message": "Fix codestyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8bdc81ef92d2f359c6e083377b9b7202457347e", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/c8bdc81ef92d2f359c6e083377b9b7202457347e", "committedDate": "2020-03-17T07:33:29Z", "message": "Fix compile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2db2bc4e8cc27a02d2ae1b39465c4e1705452413", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/2db2bc4e8cc27a02d2ae1b39465c4e1705452413", "committedDate": "2020-03-17T07:40:15Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MDc5MzE4", "url": "https://github.com/apache/incubator-doris/pull/3130#pullrequestreview-376079318", "createdAt": "2020-03-17T14:20:20Z", "commit": {"oid": "2db2bc4e8cc27a02d2ae1b39465c4e1705452413"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDoyMDoyMVrOF3eZ7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDoyMDozNFrOF3ealA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcxNDE1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            LOG.info(\"remove history {} jobV2[{}]. created at {}\", alterJobV2.getType(),\n          \n          \n            \n                            LOG.info(\"remove history {} jobV2[{}]. finish at {}\", alterJobV2.getType(),", "url": "https://github.com/apache/incubator-doris/pull/3130#discussion_r393714159", "createdAt": "2020-03-17T14:20:21Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/AlterHandler.java", "diffHunk": "@@ -119,6 +121,30 @@ public AlterJobV2 getUnfinishedAlterJobV2ByJobId(long jobId) {\n         return this.alterJobsV2;\n     }\n \n+    private void clearExpireFinishedOrCancelledAlterJobs() {\n+        long curTime = System.currentTimeMillis();\n+        // clean history job\n+        Iterator<AlterJob> iter = finishedOrCancelledAlterJobs.iterator();\n+        while (iter.hasNext()) {\n+            AlterJob historyJob = iter.next();\n+            if ((curTime - historyJob.getCreateTimeMs()) / 1000 > Config.history_job_keep_max_second) {\n+                iter.remove();\n+                LOG.info(\"remove history {} job[{}]. created at {}\", historyJob.getType(),\n+                        historyJob.getTableId(), TimeUtils.longToTimeString(historyJob.getCreateTimeMs()));\n+            }\n+        }\n+    }\n+\n+    private void clearExpireFinishedOrCancelledAlterJobsV2() {\n+        for (AlterJobV2 alterJobV2 : finishedOrCancelledAlterJobsV2) {\n+            if (alterJobV2.isExpire()) {\n+                finishedOrCancelledAlterJobsV2.remove(alterJobV2);\n+                LOG.info(\"remove history {} jobV2[{}]. created at {}\", alterJobV2.getType(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2db2bc4e8cc27a02d2ae1b39465c4e1705452413"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcxNDMyNA==", "bodyText": "change to \"finish at\"?", "url": "https://github.com/apache/incubator-doris/pull/3130#discussion_r393714324", "createdAt": "2020-03-17T14:20:34Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/AlterHandler.java", "diffHunk": "@@ -119,6 +121,30 @@ public AlterJobV2 getUnfinishedAlterJobV2ByJobId(long jobId) {\n         return this.alterJobsV2;\n     }\n \n+    private void clearExpireFinishedOrCancelledAlterJobs() {\n+        long curTime = System.currentTimeMillis();\n+        // clean history job\n+        Iterator<AlterJob> iter = finishedOrCancelledAlterJobs.iterator();\n+        while (iter.hasNext()) {\n+            AlterJob historyJob = iter.next();\n+            if ((curTime - historyJob.getCreateTimeMs()) / 1000 > Config.history_job_keep_max_second) {\n+                iter.remove();\n+                LOG.info(\"remove history {} job[{}]. created at {}\", historyJob.getType(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2db2bc4e8cc27a02d2ae1b39465c4e1705452413"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbf783be31b86fc0e0bc3d59abc11557fe701db2", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/bbf783be31b86fc0e0bc3d59abc11557fe701db2", "committedDate": "2020-03-17T14:24:48Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3991527bc4c04440b53c33babeb085c3f59564e0", "author": {"user": {"login": "WingsGo", "name": "WangCong"}}, "url": "https://github.com/apache/incubator-doris/commit/3991527bc4c04440b53c33babeb085c3f59564e0", "committedDate": "2020-03-17T14:54:21Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MTEyODk3", "url": "https://github.com/apache/incubator-doris/pull/3130#pullrequestreview-376112897", "createdAt": "2020-03-17T14:55:26Z", "commit": {"oid": "3991527bc4c04440b53c33babeb085c3f59564e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3303, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}