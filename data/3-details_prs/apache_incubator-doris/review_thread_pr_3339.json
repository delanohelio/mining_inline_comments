{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0ODk1MTI1", "number": 3339, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDoxMDo1OFrODywmIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDoyNjo0M1rODywvoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTUxNTg0OnYy", "diffSide": "RIGHT", "path": "be/src/olap/tablet.cpp", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDoxMDo1OFrOGG_UCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNTowMDo0MlrOGJjbdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTk2MA==", "bodyText": "CHECK_EQ takes no effect on release version.", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r409981960", "createdAt": "2020-04-17T04:10:58Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/tablet.cpp", "diffHunk": "@@ -135,16 +130,12 @@ OLAPStatus Tablet::set_tablet_state(TabletState state) {\n \n // should save tablet meta to remote meta store\n // if it's a primary replica\n-OLAPStatus Tablet::save_meta() {\n-    OLAPStatus res = _tablet_meta->save_meta(_data_dir);\n-    if (res != OLAP_SUCCESS) {\n-       LOG(FATAL) << \"fail to save tablet_meta. res=\" << res << \", root=\" << _data_dir->path();\n-    }\n+void Tablet::save_meta() {\n+    auto res = _tablet_meta->save_meta(_data_dir);\n+    CHECK_EQ(res, OLAP_SUCCESS) << \"fail to save tablet_meta. res=\" << res << \", root=\" << _data_dir->path();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk5MzAxNA==", "bodyText": "CHECK_EQ takes no effect on release version.\n\nDo you mean DCHECK_EQ takes no effect on release version?", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r409993014", "createdAt": "2020-04-17T04:58:26Z", "author": {"login": "acelyc111"}, "path": "be/src/olap/tablet.cpp", "diffHunk": "@@ -135,16 +130,12 @@ OLAPStatus Tablet::set_tablet_state(TabletState state) {\n \n // should save tablet meta to remote meta store\n // if it's a primary replica\n-OLAPStatus Tablet::save_meta() {\n-    OLAPStatus res = _tablet_meta->save_meta(_data_dir);\n-    if (res != OLAP_SUCCESS) {\n-       LOG(FATAL) << \"fail to save tablet_meta. res=\" << res << \", root=\" << _data_dir->path();\n-    }\n+void Tablet::save_meta() {\n+    auto res = _tablet_meta->save_meta(_data_dir);\n+    CHECK_EQ(res, OLAP_SUCCESS) << \"fail to save tablet_meta. res=\" << res << \", root=\" << _data_dir->path();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTk2MA=="}, "originalCommit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYxODMyMg==", "bodyText": "Yes, It has no effect.", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r412618322", "createdAt": "2020-04-22T02:15:35Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/tablet.cpp", "diffHunk": "@@ -135,16 +130,12 @@ OLAPStatus Tablet::set_tablet_state(TabletState state) {\n \n // should save tablet meta to remote meta store\n // if it's a primary replica\n-OLAPStatus Tablet::save_meta() {\n-    OLAPStatus res = _tablet_meta->save_meta(_data_dir);\n-    if (res != OLAP_SUCCESS) {\n-       LOG(FATAL) << \"fail to save tablet_meta. res=\" << res << \", root=\" << _data_dir->path();\n-    }\n+void Tablet::save_meta() {\n+    auto res = _tablet_meta->save_meta(_data_dir);\n+    CHECK_EQ(res, OLAP_SUCCESS) << \"fail to save tablet_meta. res=\" << res << \", root=\" << _data_dir->path();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTk2MA=="}, "originalCommit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY3MDgzNw==", "bodyText": "DCHECK_EQ has no effect, but here is CHECK_EQ  which has effect in release mode.", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r412670837", "createdAt": "2020-04-22T05:00:42Z", "author": {"login": "acelyc111"}, "path": "be/src/olap/tablet.cpp", "diffHunk": "@@ -135,16 +130,12 @@ OLAPStatus Tablet::set_tablet_state(TabletState state) {\n \n // should save tablet meta to remote meta store\n // if it's a primary replica\n-OLAPStatus Tablet::save_meta() {\n-    OLAPStatus res = _tablet_meta->save_meta(_data_dir);\n-    if (res != OLAP_SUCCESS) {\n-       LOG(FATAL) << \"fail to save tablet_meta. res=\" << res << \", root=\" << _data_dir->path();\n-    }\n+void Tablet::save_meta() {\n+    auto res = _tablet_meta->save_meta(_data_dir);\n+    CHECK_EQ(res, OLAP_SUCCESS) << \"fail to save tablet_meta. res=\" << res << \", root=\" << _data_dir->path();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTk2MA=="}, "originalCommit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTUzOTkzOnYy", "diffSide": "RIGHT", "path": "be/src/olap/rowset_graph.cpp", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDoyNjozNVrOGG_iEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNDoyODo1NFrOGKrEhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4NTU1NA==", "bodyText": "I think should not coupling outside VersionPath empty logic in this function.", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r409985554", "createdAt": "2020-04-17T04:26:35Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/rowset_graph.cpp", "diffHunk": "@@ -237,25 +232,26 @@ OLAPStatus RowsetGraph::capture_consistent_versions(const Version& spec_version,\n         reversed_path.push_back(tmp_vertex_index);\n     }\n \n-    // Make version_path from reversed_path.\n-    std::stringstream shortest_path_for_debug;\n-    for (size_t path_id = reversed_path.size() - 1; path_id > 0; --path_id) {\n-        int64_t tmp_start_vertex_value = _version_graph[reversed_path[path_id]].value;\n-        int64_t tmp_end_vertex_value = _version_graph[reversed_path[path_id - 1]].value;\n-\n-        // tmp_start_vertex_value mustn't be equal to tmp_end_vertex_value\n-        if (tmp_start_vertex_value <= tmp_end_vertex_value) {\n-            version_path->emplace_back(tmp_start_vertex_value, tmp_end_vertex_value - 1);\n-        } else {\n-            version_path->emplace_back(tmp_end_vertex_value, tmp_start_vertex_value - 1);\n-        }\n+    if (version_path != nullptr) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk5NzUzMA==", "bodyText": "I found RowsetGraph::capture_consistent_versions is now only called by Tablet::capture_consistent_versions, the latter is now called by two purposes. First, check version integrity, second, check version integrity and then capture versions when check success. For the first purpose, it's not needed to construct and fill a output parameter. Of course the function name capture_consistent_versions  maybe not accuracy in this case.", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r409997530", "createdAt": "2020-04-17T05:18:13Z", "author": {"login": "acelyc111"}, "path": "be/src/olap/rowset_graph.cpp", "diffHunk": "@@ -237,25 +232,26 @@ OLAPStatus RowsetGraph::capture_consistent_versions(const Version& spec_version,\n         reversed_path.push_back(tmp_vertex_index);\n     }\n \n-    // Make version_path from reversed_path.\n-    std::stringstream shortest_path_for_debug;\n-    for (size_t path_id = reversed_path.size() - 1; path_id > 0; --path_id) {\n-        int64_t tmp_start_vertex_value = _version_graph[reversed_path[path_id]].value;\n-        int64_t tmp_end_vertex_value = _version_graph[reversed_path[path_id - 1]].value;\n-\n-        // tmp_start_vertex_value mustn't be equal to tmp_end_vertex_value\n-        if (tmp_start_vertex_value <= tmp_end_vertex_value) {\n-            version_path->emplace_back(tmp_start_vertex_value, tmp_end_vertex_value - 1);\n-        } else {\n-            version_path->emplace_back(tmp_end_vertex_value, tmp_start_vertex_value - 1);\n-        }\n+    if (version_path != nullptr) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4NTU1NA=="}, "originalCommit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyMjA1NQ==", "bodyText": "I think there is no necessity for capture_consistent_versions() judge version_path is nullptr or not.\nSo you can DCHECK(version_path != nullptr) instead.\nOf course, you should guarantee that the caller should the version_path is not nullptr.", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r412622055", "createdAt": "2020-04-22T02:26:29Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/rowset_graph.cpp", "diffHunk": "@@ -237,25 +232,26 @@ OLAPStatus RowsetGraph::capture_consistent_versions(const Version& spec_version,\n         reversed_path.push_back(tmp_vertex_index);\n     }\n \n-    // Make version_path from reversed_path.\n-    std::stringstream shortest_path_for_debug;\n-    for (size_t path_id = reversed_path.size() - 1; path_id > 0; --path_id) {\n-        int64_t tmp_start_vertex_value = _version_graph[reversed_path[path_id]].value;\n-        int64_t tmp_end_vertex_value = _version_graph[reversed_path[path_id - 1]].value;\n-\n-        // tmp_start_vertex_value mustn't be equal to tmp_end_vertex_value\n-        if (tmp_start_vertex_value <= tmp_end_vertex_value) {\n-            version_path->emplace_back(tmp_start_vertex_value, tmp_end_vertex_value - 1);\n-        } else {\n-            version_path->emplace_back(tmp_end_vertex_value, tmp_start_vertex_value - 1);\n-        }\n+    if (version_path != nullptr) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4NTU1NA=="}, "originalCommit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg0NDYxNA==", "bodyText": "Either version_path  is nullptr or is valid for this function. If it's nullptr, just validate rowset graph; if it's not nullptr, validate rowset graph and return current versions.", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r413844614", "createdAt": "2020-04-23T14:28:54Z", "author": {"login": "acelyc111"}, "path": "be/src/olap/rowset_graph.cpp", "diffHunk": "@@ -237,25 +232,26 @@ OLAPStatus RowsetGraph::capture_consistent_versions(const Version& spec_version,\n         reversed_path.push_back(tmp_vertex_index);\n     }\n \n-    // Make version_path from reversed_path.\n-    std::stringstream shortest_path_for_debug;\n-    for (size_t path_id = reversed_path.size() - 1; path_id > 0; --path_id) {\n-        int64_t tmp_start_vertex_value = _version_graph[reversed_path[path_id]].value;\n-        int64_t tmp_end_vertex_value = _version_graph[reversed_path[path_id - 1]].value;\n-\n-        // tmp_start_vertex_value mustn't be equal to tmp_end_vertex_value\n-        if (tmp_start_vertex_value <= tmp_end_vertex_value) {\n-            version_path->emplace_back(tmp_start_vertex_value, tmp_end_vertex_value - 1);\n-        } else {\n-            version_path->emplace_back(tmp_end_vertex_value, tmp_start_vertex_value - 1);\n-        }\n+    if (version_path != nullptr) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4NTU1NA=="}, "originalCommit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTU0MDE3OnYy", "diffSide": "RIGHT", "path": "be/src/olap/rowset_graph.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDoyNjo0M1rOGG_iOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDoyNjo0M1rOGG_iOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4NTU5Mg==", "bodyText": "You can CHECK(VERSION_PATH != nullptr) to replace above logic.", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r409985592", "createdAt": "2020-04-17T04:26:43Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/rowset_graph.cpp", "diffHunk": "@@ -159,11 +159,6 @@ OLAPStatus RowsetGraph::capture_consistent_versions(const Version& spec_version,\n         return OLAP_ERR_INPUT_PARAMETER_ERROR;\n     }\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7"}, "originalPosition": 3}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1920, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}