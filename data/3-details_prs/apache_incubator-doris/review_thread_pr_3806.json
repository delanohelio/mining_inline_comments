{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNTkwMzUx", "number": 3806, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMzowNDo1NVrOEGvdjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNToxMToxNVrOEIOD-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NTA0NTI3OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/qe/SessionVariable.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMzowNDo1NVrOGluWhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMzowNDo1NVrOGluWhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIwOTkyNg==", "bodyText": "Update the document for this new variables.", "url": "https://github.com/apache/incubator-doris/pull/3806#discussion_r442209926", "createdAt": "2020-06-18T13:04:55Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/qe/SessionVariable.java", "diffHunk": "@@ -251,6 +253,9 @@\n     private int maxScanKeyNum = -1;\n     @VariableMgr.VarAttr(name = MAX_PUSHDOWN_CONDITIONS_PER_COLUMN)\n     private int maxPushdownConditionsPerColumn = -1;\n+    // TODO(Yangzhengguo) set this default value to true if we support spill data top disk\n+    @VariableMgr.VarAttr(name = ALLOW_IGNORE_ORDER_BY)\n+    private boolean allowIgnoreOrderBy = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5377c24f3fff7c1f79fe56fd211e15cde59bb694"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NTA0NTMzOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/analysis/QueryStmt.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMzowNDo1NlrOGluWjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMTo1MTo1MFrOGmFgzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIwOTkzNA==", "bodyText": "This strBuilder seems useless.", "url": "https://github.com/apache/incubator-doris/pull/3806#discussion_r442209934", "createdAt": "2020-06-18T13:04:56Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/QueryStmt.java", "diffHunk": "@@ -285,27 +285,29 @@ protected void createSortInfo(Analyzer analyzer) throws AnalysisException {\n         }\n \n         sortInfo = new SortInfo(orderingExprs, isAscOrder, nullsFirstParams);\n-        // order by w/o limit and offset in inline views, union operands and insert statements\n+        // order by w/o limit and offset in inline views, set operands and insert statements\n         // are ignored.\n-        // TODO chenhao, open this when we don't limit rows subquery returns by SortNode.\n-        /*if (!hasLimit() && !hasOffset() && !analyzer.isRootAnalyzer()) {\n-         *   evaluateOrderBy = false;\n-         *   // Return a warning that the order by was ignored.\n-         *   StringBuilder strBuilder = new StringBuilder();\n-         *   strBuilder.append(\"Ignoring ORDER BY clause without LIMIT or OFFSET: \");\n-         *   strBuilder.append(\"ORDER BY \");\n-         *   strBuilder.append(orderByElements.get(0).toSql());\n-         *   for (int i = 1; i < orderByElements.size(); ++i) {\n-         *       strBuilder.append(\", \").append(orderByElements.get(i).toSql());\n-         *   }\n-         *   strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, union operand, \");\n-         *   strBuilder.append(\"or an insert/ctas statement has no effect on the query result \");\n-         *   strBuilder.append(\"unless a LIMIT and/or OFFSET is used in conjunction \");\n-         *   strBuilder.append(\"with the ORDER BY.\");\n-         * } else {\n-         */\n-        evaluateOrderBy = true;\n-        //}\n+        boolean allowIgnore = false;\n+        if (ConnectContext.get() != null && ConnectContext.get().getSessionVariable().isAllowIgnoreOrderBy()) {\n+            allowIgnore = true;\n+        }\n+        if (allowIgnore && !hasLimit() && !hasOffset() && !analyzer.isRootAnalyzer()) {\n+            evaluateOrderBy = false;\n+            // Return a warning that the order by was ignored.\n+            StringBuilder strBuilder = new StringBuilder();\n+            strBuilder.append(\"Ignoring ORDER BY clause without LIMIT or OFFSET: \");\n+            strBuilder.append(\"ORDER BY \");\n+            strBuilder.append(orderByElements.get(0).toSql());\n+            for (int i = 1; i < orderByElements.size(); ++i) {\n+                strBuilder.append(\", \").append(orderByElements.get(i).toSql());\n+            }\n+            strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, union operand, \");\n+            strBuilder.append(\"or an insert/ctas statement has no effect on the query result \");\n+            strBuilder.append(\"unless a LIMIT and/or OFFSET is used in conjunction \");\n+            strBuilder.append(\"with the ORDER BY.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5377c24f3fff7c1f79fe56fd211e15cde59bb694"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU4OTM5MA==", "bodyText": "strBuilder is mainly used in the for loop, and this code is consistent with impala, in case there is a need for merge mpala code in the future, it is also more convenient", "url": "https://github.com/apache/incubator-doris/pull/3806#discussion_r442589390", "createdAt": "2020-06-19T01:51:50Z", "author": {"login": "yangzhg"}, "path": "fe/src/main/java/org/apache/doris/analysis/QueryStmt.java", "diffHunk": "@@ -285,27 +285,29 @@ protected void createSortInfo(Analyzer analyzer) throws AnalysisException {\n         }\n \n         sortInfo = new SortInfo(orderingExprs, isAscOrder, nullsFirstParams);\n-        // order by w/o limit and offset in inline views, union operands and insert statements\n+        // order by w/o limit and offset in inline views, set operands and insert statements\n         // are ignored.\n-        // TODO chenhao, open this when we don't limit rows subquery returns by SortNode.\n-        /*if (!hasLimit() && !hasOffset() && !analyzer.isRootAnalyzer()) {\n-         *   evaluateOrderBy = false;\n-         *   // Return a warning that the order by was ignored.\n-         *   StringBuilder strBuilder = new StringBuilder();\n-         *   strBuilder.append(\"Ignoring ORDER BY clause without LIMIT or OFFSET: \");\n-         *   strBuilder.append(\"ORDER BY \");\n-         *   strBuilder.append(orderByElements.get(0).toSql());\n-         *   for (int i = 1; i < orderByElements.size(); ++i) {\n-         *       strBuilder.append(\", \").append(orderByElements.get(i).toSql());\n-         *   }\n-         *   strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, union operand, \");\n-         *   strBuilder.append(\"or an insert/ctas statement has no effect on the query result \");\n-         *   strBuilder.append(\"unless a LIMIT and/or OFFSET is used in conjunction \");\n-         *   strBuilder.append(\"with the ORDER BY.\");\n-         * } else {\n-         */\n-        evaluateOrderBy = true;\n-        //}\n+        boolean allowIgnore = false;\n+        if (ConnectContext.get() != null && ConnectContext.get().getSessionVariable().isAllowIgnoreOrderBy()) {\n+            allowIgnore = true;\n+        }\n+        if (allowIgnore && !hasLimit() && !hasOffset() && !analyzer.isRootAnalyzer()) {\n+            evaluateOrderBy = false;\n+            // Return a warning that the order by was ignored.\n+            StringBuilder strBuilder = new StringBuilder();\n+            strBuilder.append(\"Ignoring ORDER BY clause without LIMIT or OFFSET: \");\n+            strBuilder.append(\"ORDER BY \");\n+            strBuilder.append(orderByElements.get(0).toSql());\n+            for (int i = 1; i < orderByElements.size(); ++i) {\n+                strBuilder.append(\", \").append(orderByElements.get(i).toSql());\n+            }\n+            strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, union operand, \");\n+            strBuilder.append(\"or an insert/ctas statement has no effect on the query result \");\n+            strBuilder.append(\"unless a LIMIT and/or OFFSET is used in conjunction \");\n+            strBuilder.append(\"with the ORDER BY.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIwOTkzNA=="}, "originalCommit": {"oid": "5377c24f3fff7c1f79fe56fd211e15cde59bb694"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDMxODU3OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/qe/SessionVariable.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMjo0MToyOFrOGoBBGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMjo0MToyOFrOGoBBGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxMjg5MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // TODO(Yangzhengguo) set this default value to true if we support spill data top disk\n          \n          \n            \n                // TODO set this default value to true if we support spill data top disk", "url": "https://github.com/apache/incubator-doris/pull/3806#discussion_r444612890", "createdAt": "2020-06-24T02:41:28Z", "author": {"login": "wuyunfeng"}, "path": "fe/src/main/java/org/apache/doris/qe/SessionVariable.java", "diffHunk": "@@ -251,6 +253,9 @@\n     private int maxScanKeyNum = -1;\n     @VariableMgr.VarAttr(name = MAX_PUSHDOWN_CONDITIONS_PER_COLUMN)\n     private int maxPushdownConditionsPerColumn = -1;\n+    // TODO(Yangzhengguo) set this default value to true if we support spill data top disk", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0c6e9d79b2a59ac217e48ae3113672966e9ef0d"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDM0Njg3OnYy", "diffSide": "RIGHT", "path": "docs/zh-CN/administrator-guide/variables.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMjo1OTo0OFrOGoBS4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMjo1OTo0OFrOGoBS4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxNzQ0MQ==", "bodyText": "maybe allow_ignore_order_by_in_subquery is more better?\nset, inline view, insert can think contain subquery.", "url": "https://github.com/apache/incubator-doris/pull/3806#discussion_r444617441", "createdAt": "2020-06-24T02:59:48Z", "author": {"login": "wutiangan"}, "path": "docs/zh-CN/administrator-guide/variables.md", "diffHunk": "@@ -334,3 +334,6 @@ SET forward_to_master = concat('tr', 'u', 'e');\n \n     \u662f\u5426\u5c06 bitmap \u548c hll \u7c7b\u578b\u7684 count distinct \u67e5\u8be2\u91cd\u5199\u4e3a bitmap_union_count \u548c hll_union_agg \u3002\n \n+* `allow_ignore_order_by`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0c6e9d79b2a59ac217e48ae3113672966e9ef0d"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDQwMjAyOnYy", "diffSide": "RIGHT", "path": "docs/en/administrator-guide/variables.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMzozODowNFrOGoB0_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMzozODowNFrOGoB0_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYyNjE3NQ==", "bodyText": "the parameter can remove.\nyou can decide to apply you REMOVE_SORT rule according to if order_by/sort  contain limit or offset.", "url": "https://github.com/apache/incubator-doris/pull/3806#discussion_r444626175", "createdAt": "2020-06-24T03:38:04Z", "author": {"login": "wutiangan"}, "path": "docs/en/administrator-guide/variables.md", "diffHunk": "@@ -334,3 +334,7 @@ SET forward_to_master = concat('tr', 'u', 'e');\n * `rewrite_count_distinct_to_bitmap_hll`\n \n     Whether to rewrite count distinct queries of bitmap and HLL types as bitmap_union_count and hll_union_agg.\n+\n+* `allow_ignore_order_by`\n+   Used to ignore order by w/o limit and offset in inline views, set operands and insert statements.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0c6e9d79b2a59ac217e48ae3113672966e9ef0d"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDU0NDU5OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/analysis/QueryStmt.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNToxMToxNVrOGoDJbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNToxMToxNVrOGoDJbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY0Nzc4OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, union operand, \");\n          \n          \n            \n                        strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, set operand, \");", "url": "https://github.com/apache/incubator-doris/pull/3806#discussion_r444647788", "createdAt": "2020-06-24T05:11:15Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/analysis/QueryStmt.java", "diffHunk": "@@ -285,27 +285,25 @@ protected void createSortInfo(Analyzer analyzer) throws AnalysisException {\n         }\n \n         sortInfo = new SortInfo(orderingExprs, isAscOrder, nullsFirstParams);\n-        // order by w/o limit and offset in inline views, union operands and insert statements\n+        // order by w/o limit and offset in inline views, set operands and insert statements\n         // are ignored.\n-        // TODO chenhao, open this when we don't limit rows subquery returns by SortNode.\n-        /*if (!hasLimit() && !hasOffset() && !analyzer.isRootAnalyzer()) {\n-         *   evaluateOrderBy = false;\n-         *   // Return a warning that the order by was ignored.\n-         *   StringBuilder strBuilder = new StringBuilder();\n-         *   strBuilder.append(\"Ignoring ORDER BY clause without LIMIT or OFFSET: \");\n-         *   strBuilder.append(\"ORDER BY \");\n-         *   strBuilder.append(orderByElements.get(0).toSql());\n-         *   for (int i = 1; i < orderByElements.size(); ++i) {\n-         *       strBuilder.append(\", \").append(orderByElements.get(i).toSql());\n-         *   }\n-         *   strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, union operand, \");\n-         *   strBuilder.append(\"or an insert/ctas statement has no effect on the query result \");\n-         *   strBuilder.append(\"unless a LIMIT and/or OFFSET is used in conjunction \");\n-         *   strBuilder.append(\"with the ORDER BY.\");\n-         * } else {\n-         */\n-        evaluateOrderBy = true;\n-        //}\n+        if (!hasLimit() && !hasOffset() && !analyzer.isRootAnalyzer()) {\n+            evaluateOrderBy = false;\n+            // Return a warning that the order by was ignored.\n+            StringBuilder strBuilder = new StringBuilder();\n+            strBuilder.append(\"Ignoring ORDER BY clause without LIMIT or OFFSET: \");\n+            strBuilder.append(\"ORDER BY \");\n+            strBuilder.append(orderByElements.get(0).toSql());\n+            for (int i = 1; i < orderByElements.size(); ++i) {\n+                strBuilder.append(\", \").append(orderByElements.get(i).toSql());\n+            }\n+            strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, union operand, \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc95e755302fbb06be38e53a20dd73ffb550f707"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1479, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}