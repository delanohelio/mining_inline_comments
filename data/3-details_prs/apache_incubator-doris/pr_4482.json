{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1NDk4MTU4", "number": 4482, "title": "Do not add exchange when table's distributioin satisfy the distribution requirements", "bodyText": "For #4481.\nProposed changes\nIn DistributedPlanner, do not add the unnecessary Exchanges.\nFor case 1, we only need to judge that the table's distribute hash keys is a subset of the aggregate keys.\nFor case 2, we should jude two conditions:\n\npartition keys are also hash keys.\nthe table's distribute hash keys is a subset of the aggregate keys.", "createdAt": "2020-08-28T16:11:58Z", "url": "https://github.com/apache/incubator-doris/pull/4482", "merged": true, "mergeCommit": {"oid": "f3a9f3f87c1f2e5b4f7647e27eca913d599198fe"}, "closed": true, "closedAt": "2020-09-01T03:34:54Z", "author": {"login": "liutang123"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDXTbrgH2gAyNDc1NDk4MTU4OjEyM2RjMTU1ZTEyMjQwNGIyYTcyZWE1NmVlMTFjMzkxMDI4YzBiN2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEIZUvAFqTQ3ODI1ODI0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "123dc155e122404b2a72ea56ee11c391028c0b7f", "author": {"user": {"login": "liutang123", "name": "Lijia Liu"}}, "url": "https://github.com/apache/incubator-doris/commit/123dc155e122404b2a72ea56ee11c391028c0b7f", "committedDate": "2020-08-28T16:08:03Z", "message": "Do not add exchange when table's distributioin satisfy the distribution requirements\n\nFor #4481.\nIn DistributedPlanner, do not add the unnecessary Exchanges.\nFor case 1, we only need to judge that the table's distribute hash keys is a subset of the aggregate keys.\nFor case 2, we should jude two conditions:\n - partition keys are also hash keys.\n - the table's distribute hash keys is a subset of the aggregate keys."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MTc3OTA1", "url": "https://github.com/apache/incubator-doris/pull/4482#pullrequestreview-478177905", "createdAt": "2020-08-30T07:12:28Z", "commit": {"oid": "123dc155e122404b2a72ea56ee11c391028c0b7f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQwNzoxMjoyOVrOHJgjHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQwNzoxMjoyOVrOHJgjHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTczMjUwOA==", "bodyText": "partitionExprs is null has checked in  if (partitionExprs == null) partitionExprs = groupingExprs;, So I think we could remove this check.", "url": "https://github.com/apache/incubator-doris/pull/4482#discussion_r479732508", "createdAt": "2020-08-30T07:12:29Z", "author": {"login": "kangkaisen"}, "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/OlapTable.java", "diffHunk": "@@ -1577,4 +1580,31 @@ public TStorageFormat getStorageFormat() {\n         }\n         return tableProperty.getStorageFormat();\n     }\n+\n+    public boolean satisfyHashDistribution(List<Expr> hashExprs) {\n+        if (hashExprs == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "123dc155e122404b2a72ea56ee11c391028c0b7f"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MTc4MTY5", "url": "https://github.com/apache/incubator-doris/pull/4482#pullrequestreview-478178169", "createdAt": "2020-08-30T07:17:25Z", "commit": {"oid": "123dc155e122404b2a72ea56ee11c391028c0b7f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQwNzoxNzoyNVrOHJgk9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQwNzoxNzoyNVrOHJgk9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTczMjk4Mw==", "bodyText": "Rename to couldLocalGorupBy or similar name?", "url": "https://github.com/apache/incubator-doris/pull/4482#discussion_r479732983", "createdAt": "2020-08-30T07:17:25Z", "author": {"login": "kangkaisen"}, "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/OlapTable.java", "diffHunk": "@@ -1577,4 +1580,31 @@ public TStorageFormat getStorageFormat() {\n         }\n         return tableProperty.getStorageFormat();\n     }\n+\n+    public boolean satisfyHashDistribution(List<Expr> hashExprs) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "123dc155e122404b2a72ea56ee11c391028c0b7f"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MTc4MzY2", "url": "https://github.com/apache/incubator-doris/pull/4482#pullrequestreview-478178366", "createdAt": "2020-08-30T07:21:13Z", "commit": {"oid": "123dc155e122404b2a72ea56ee11c391028c0b7f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQwNzoyMToxM1rOHJgmPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQwNzoyMToxM1rOHJgmPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTczMzMxMA==", "bodyText": "I think we move this check to createAggregationFragment 780 line is better?  Because createMergeAggregationFragment  should create a merge aggregate fragment.", "url": "https://github.com/apache/incubator-doris/pull/4482#discussion_r479733310", "createdAt": "2020-08-30T07:21:13Z", "author": {"login": "kangkaisen"}, "path": "fe/fe-core/src/main/java/org/apache/doris/planner/DistributedPlanner.java", "diffHunk": "@@ -863,6 +863,14 @@ private PlanFragment createMergeAggregationFragment(AggregationNode node, PlanFr\n             //     childFragment.addPlanRoot(node);\n             //     return childFragment;\n             // }\n+\n+            PlanNode childPlan = childFragment.getPlanRoot();\n+            if (childPlan instanceof OlapScanNode &&\n+                    ((OlapScanNode)childPlan).getOlapTable().satisfyHashDistribution(partitionExprs)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "123dc155e122404b2a72ea56ee11c391028c0b7f"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8adbd1356cf112894c7021ec850b4adb3525ea9c", "author": {"user": {"login": "liutang123", "name": "Lijia Liu"}}, "url": "https://github.com/apache/incubator-doris/commit/8adbd1356cf112894c7021ec850b4adb3525ea9c", "committedDate": "2020-08-30T10:25:08Z", "message": "Code style optimize."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4235db262f414b72f4310298b11c0137ea7ad2a9", "author": {"user": {"login": "liutang123", "name": "Lijia Liu"}}, "url": "https://github.com/apache/incubator-doris/commit/4235db262f414b72f4310298b11c0137ea7ad2a9", "committedDate": "2020-08-30T08:23:16Z", "message": "Code style optimize."}, "afterCommit": {"oid": "8adbd1356cf112894c7021ec850b4adb3525ea9c", "author": {"user": {"login": "liutang123", "name": "Lijia Liu"}}, "url": "https://github.com/apache/incubator-doris/commit/8adbd1356cf112894c7021ec850b4adb3525ea9c", "committedDate": "2020-08-30T10:25:08Z", "message": "Code style optimize."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MjU4MjQx", "url": "https://github.com/apache/incubator-doris/pull/4482#pullrequestreview-478258241", "createdAt": "2020-08-31T01:19:50Z", "commit": {"oid": "8adbd1356cf112894c7021ec850b4adb3525ea9c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4881, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}