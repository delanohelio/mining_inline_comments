{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MjY5MTA2", "number": 4310, "title": "Support batch delete [part 1]", "bodyText": "Proposed changes\n\nImplements the grammar of the batch delete #4051\nProcess create, alter table when table has delete sign column\nSupport the syntax for enabling the delete column\nAutomatically filtered deleted data in the select statement.\nAutomatically add delete sign when create  rollup table\nTODO:\nOptimize the reading and compaction logic on the be side, so that the data marked as deleted will be completely deleted during base compaction\n\nTypes of changes\nWhat types of changes does your code introduce to Doris?\nPut an x in the boxes that apply\n\n Bugfix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Breaking change (fix or feature that would cause existing functionality to not work as expected)\n Documentation Update (if none of the other choices apply)\n Code refactor (Modify the code structure, format the code, etc...)\n\nChecklist\nPut an x in the boxes that apply. You can also fill these out after creating the PR. If you're unsure about any of them, don't hesitate to ask. We're here to help! This is simply a reminder of what we are going to look for before merging your code.\n\n I have create an issue on #ISSUE, and have described the bug/feature there in detail\n Compiling and unit tests pass locally with my changes\n I have added tests that prove my fix is effective or that my feature works\n If this change need a document change, I have updated the document\n Any dependent changes have been merged", "createdAt": "2020-08-10T04:42:17Z", "url": "https://github.com/apache/incubator-doris/pull/4310", "merged": true, "mergeCommit": {"oid": "d61c10b76108fdbd04f7d86f89c646708a3934ea"}, "closed": true, "closedAt": "2020-08-21T14:57:17Z", "author": {"login": "yangzhg"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9e3CmAFqTQ2NDA4MTMxOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBF7qRgFqTQ3MjU1MTkwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MDgxMzE5", "url": "https://github.com/apache/incubator-doris/pull/4310#pullrequestreview-464081319", "createdAt": "2020-08-10T09:32:44Z", "commit": {"oid": "984dddff1743e8754cc53dc6be7c86f98cc45629"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTozMjo0NFrOG-Hhvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTozMjo0NFrOG-Hhvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc4ODIyMg==", "bodyText": "Place _name under _key_coder could make a lesser size of Field.", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r467788222", "createdAt": "2020-08-10T09:32:44Z", "author": {"login": "sduzh"}, "path": "be/src/olap/field.h", "diffHunk": "@@ -261,6 +262,7 @@ class Field {\n     const KeyCoder* _key_coder;\n     uint16_t _index_size;\n     bool _is_nullable;\n+    std::string _name;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "984dddff1743e8754cc53dc6be7c86f98cc45629"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MDgyOTI5", "url": "https://github.com/apache/incubator-doris/pull/4310#pullrequestreview-464082929", "createdAt": "2020-08-10T09:35:09Z", "commit": {"oid": "984dddff1743e8754cc53dc6be7c86f98cc45629"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTozNTowOVrOG-Hmuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTozNTowOVrOG-Hmuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc4OTQ5OQ==", "bodyText": "const std::string& name() const { return _name; }", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r467789499", "createdAt": "2020-08-10T09:35:09Z", "author": {"login": "sduzh"}, "path": "be/src/olap/field.h", "diffHunk": "@@ -55,6 +55,7 @@ class Field {\n     inline int32_t length() const { return _length; }\n     inline size_t field_size() const { return size() + 1; }\n     inline size_t index_size() const { return _index_size; }\n+    inline std::string name() const { return _name; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "984dddff1743e8754cc53dc6be7c86f98cc45629"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MDg1MTAx", "url": "https://github.com/apache/incubator-doris/pull/4310#pullrequestreview-464085101", "createdAt": "2020-08-10T09:38:47Z", "commit": {"oid": "984dddff1743e8754cc53dc6be7c86f98cc45629"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTozODo0N1rOG-HtbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTozODo0N1rOG-HtbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5MTIxMg==", "bodyText": "std::vector::at has extra runtime overhead, compared with operator[].", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r467791212", "createdAt": "2020-08-10T09:38:47Z", "author": {"login": "sduzh"}, "path": "be/src/olap/schema.h", "diffHunk": "@@ -53,19 +53,21 @@ class Schema {\n             }\n             columns.push_back(column);\n         }\n-\n+        _delete_sign_idx = tablet_schema.delete_sign_idx();\n         _init(columns, col_ids, num_key_columns);\n     }\n \n     // All the columns of one table may exist in the columns param, but col_ids is only a subset.\n     Schema(const std::vector<TabletColumn>& columns, const std::vector<ColumnId>& col_ids) {\n         size_t num_key_columns = 0;\n-        for (const auto& c: columns) {\n-            if (c.is_key()) {\n+        for (size_t i = 0; i < columns.size(); ++i) {\n+            if (columns.at(i).is_key()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "984dddff1743e8754cc53dc6be7c86f98cc45629"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "984dddff1743e8754cc53dc6be7c86f98cc45629", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/984dddff1743e8754cc53dc6be7c86f98cc45629", "committedDate": "2020-08-10T08:13:24Z", "message": "support batch delete"}, "afterCommit": {"oid": "3c6aac83543e0c4a64a248f111b6304b7417843c", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/3c6aac83543e0c4a64a248f111b6304b7417843c", "committedDate": "2020-08-10T11:52:42Z", "message": "support batch delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5387d586c1ebaf9f895456383360bbb789fbe99", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/c5387d586c1ebaf9f895456383360bbb789fbe99", "committedDate": "2020-08-11T01:48:09Z", "message": "support batch delete"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c6aac83543e0c4a64a248f111b6304b7417843c", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/3c6aac83543e0c4a64a248f111b6304b7417843c", "committedDate": "2020-08-10T11:52:42Z", "message": "support batch delete"}, "afterCommit": {"oid": "c5387d586c1ebaf9f895456383360bbb789fbe99", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/c5387d586c1ebaf9f895456383360bbb789fbe99", "committedDate": "2020-08-11T01:48:09Z", "message": "support batch delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "924eb33f997bdb30bbc7ac319b4e76b45da4bd3b", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/924eb33f997bdb30bbc7ac319b4e76b45da4bd3b", "committedDate": "2020-08-13T07:54:16Z", "message": "fix hadoop load"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2192b8d5b87938f198a3c7fd3c8fe4af954a1366", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/2192b8d5b87938f198a3c7fd3c8fe4af954a1366", "committedDate": "2020-08-12T06:02:14Z", "message": "test"}, "afterCommit": {"oid": "924eb33f997bdb30bbc7ac319b4e76b45da4bd3b", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/924eb33f997bdb30bbc7ac319b4e76b45da4bd3b", "committedDate": "2020-08-13T07:54:16Z", "message": "fix hadoop load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9273d17d9440dbf9de3aa28168cf1753921eba15", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/9273d17d9440dbf9de3aa28168cf1753921eba15", "committedDate": "2020-08-13T08:04:40Z", "message": "fix hadoop load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1291cb359dfc667c79dd650cc962928acf78597", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/d1291cb359dfc667c79dd650cc962928acf78597", "committedDate": "2020-08-13T08:12:20Z", "message": "fix hadoop load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8ca2330a94587a3b4d5ea8acc552310f2417b99", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/f8ca2330a94587a3b4d5ea8acc552310f2417b99", "committedDate": "2020-08-13T08:17:52Z", "message": "fix hadoop load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "913c628e5bf4c1da2a34b5541fa7c58d31cb2fa5", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/913c628e5bf4c1da2a34b5541fa7c58d31cb2fa5", "committedDate": "2020-08-13T09:15:20Z", "message": "fix hadoop load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d657ab4df9867431790a6cba7cbb21984fa5b11", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/4d657ab4df9867431790a6cba7cbb21984fa5b11", "committedDate": "2020-08-13T09:21:14Z", "message": "fix hadoop load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae8bd68e29547a13d0bf537e8004989aa96be6d3", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/ae8bd68e29547a13d0bf537e8004989aa96be6d3", "committedDate": "2020-08-13T09:27:00Z", "message": "fix hadoop load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72be46170b0533fd091328102ae096c8222c5065", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/72be46170b0533fd091328102ae096c8222c5065", "committedDate": "2020-08-13T09:44:07Z", "message": "fix hadoop load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acf5d0143fd2191d9309582c03fab3d327e42212", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/acf5d0143fd2191d9309582c03fab3d327e42212", "committedDate": "2020-08-13T10:09:20Z", "message": "fix hadoop load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2b084ad89cde603bcf85a7de3840c12e503705c", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/c2b084ad89cde603bcf85a7de3840c12e503705c", "committedDate": "2020-08-14T02:58:35Z", "message": "fix hadoop load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e1e58bfd55ae4eefcd298c13aa4b696b2224e75", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/7e1e58bfd55ae4eefcd298c13aa4b696b2224e75", "committedDate": "2020-08-14T03:00:22Z", "message": "fix hadoop load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a6dfd47ebf5c4503955106235f7c3bafed408aa", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/4a6dfd47ebf5c4503955106235f7c3bafed408aa", "committedDate": "2020-08-14T03:09:12Z", "message": "fix hadoop load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d541ed70e9837136888aac186afb0b0c8183aa97", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/d541ed70e9837136888aac186afb0b0c8183aa97", "committedDate": "2020-08-14T03:38:26Z", "message": "fix hadoop load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c50151776adf685a9d6e7bffefe575572bd2fee9", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/c50151776adf685a9d6e7bffefe575572bd2fee9", "committedDate": "2020-08-14T09:13:10Z", "message": "fix hadoop load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b", "committedDate": "2020-08-17T03:13:25Z", "message": "Merge branch 'master' into support_batch_delete"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NTU2NTk2", "url": "https://github.com/apache/incubator-doris/pull/4310#pullrequestreview-468556596", "createdAt": "2020-08-17T15:16:48Z", "commit": {"oid": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNToxNjo0OFrOHBtI8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTozMTowOFrOHBtvFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1MDE5Mw==", "bodyText": "Why?", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r471550193", "createdAt": "2020-08-17T15:16:48Z", "author": {"login": "morningman"}, "path": "fe/fe-core/pom.xml", "diffHunk": "@@ -36,7 +36,7 @@ under the License.\n \n     <properties>\n         <doris.home>${basedir}/../../</doris.home>\n-        <fe_ut_parallel>${env.FE_UT_PARALLEL}</fe_ut_parallel>\n+        <fe_ut_parallel>1</fe_ut_parallel>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1Mzg3MQ==", "bodyText": "miss to modify the base index?", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r471553871", "createdAt": "2020-08-17T15:22:02Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/AlterTableStmt.java", "diffHunk": "@@ -70,6 +76,50 @@ public void analyze(Analyzer analyzer) throws UserException {\n         }\n     }\n \n+    public void rewriteAlterClause(OlapTable table) throws UserException {\n+        List<AlterClause> clauses = new ArrayList<>();\n+        for (AlterClause alterClause : ops) {\n+            if (alterClause instanceof EnableFeatureClause\n+                    && ((EnableFeatureClause) alterClause).getFeature() == EnableFeatureClause.Features.BATCH_DELETE) {\n+                if (table.getKeysType() != KeysType.UNIQUE_KEYS) {\n+                    throw new AnalysisException(\"Batch delete only support in unique tables.\");\n+                }\n+                // has rollup table\n+                if (table.getVisibleIndex().size() > 1) {\n+                    for (MaterializedIndex idx : table.getVisibleIndex()) {\n+                        if (idx.getId() == table.getBaseIndexId()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1OTk1OA==", "bodyText": "code style", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r471559958", "createdAt": "2020-08-17T15:31:08Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/DataDescription.java", "diffHunk": "@@ -172,6 +183,9 @@ public DataDescription(String tableName,\n         this.columnMappingList = columnMappingList;\n         this.whereExpr = whereExpr;\n         this.srcTableName = srcTableName;\n+        this.mergeType = mergeType;\n+        this.deleteCondition = deleteCondition\n+        ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf0907e534feccbab449fa379d421f4228eac25d", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/cf0907e534feccbab449fa379d421f4228eac25d", "committedDate": "2020-08-18T02:38:39Z", "message": "fix comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90863c47b17425988fc1bfee565c8a49b956ef07", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/90863c47b17425988fc1bfee565c8a49b956ef07", "committedDate": "2020-08-20T09:49:11Z", "message": "add comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNDQ2NzU3", "url": "https://github.com/apache/incubator-doris/pull/4310#pullrequestreview-471446757", "createdAt": "2020-08-20T10:05:06Z", "commit": {"oid": "90863c47b17425988fc1bfee565c8a49b956ef07"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b0d76513f1e365fc9e7689c0686fd9df274ed45", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/5b0d76513f1e365fc9e7689c0686fd9df274ed45", "committedDate": "2020-08-21T14:42:40Z", "message": "Merge branch 'master' into support_batch_delete"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNTUxOTA2", "url": "https://github.com/apache/incubator-doris/pull/4310#pullrequestreview-472551906", "createdAt": "2020-08-21T14:45:51Z", "commit": {"oid": "5b0d76513f1e365fc9e7689c0686fd9df274ed45"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1764, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}