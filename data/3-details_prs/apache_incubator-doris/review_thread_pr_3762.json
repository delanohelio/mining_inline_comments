{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MTUwMDc1", "number": 3762, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNToxMDozNVrOEC_mSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwMTo1MzoxMlrOEDrvBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTc0NjAyOnYy", "diffSide": "RIGHT", "path": "be/src/olap/memory/mem_tablet.h", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNToxMDozNVrOGfyegg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNToxMDozNVrOGfyegg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4NjA1MA==", "bodyText": "Is this a incomplete implementation? If yes, better add a TODO", "url": "https://github.com/apache/incubator-doris/pull/3762#discussion_r435986050", "createdAt": "2020-06-05T15:10:35Z", "author": {"login": "morningman"}, "path": "be/src/olap/memory/mem_tablet.h", "diffHunk": "@@ -27,6 +27,15 @@ class MemSubTablet;\n class ScanSpec;\n class MemTabletScan;\n class WriteTxn;\n+class MemTablet;\n+using MemTabletSharedPtr = std::shared_ptr<MemTablet>;\n+\n+inline MemTabletSharedPtr to_mem_tablet(const BaseTabletSharedPtr& base) {\n+    if (base->is_memory()) {\n+        return std::static_pointer_cast<MemTablet>(base);\n+    }\n+    return MemTabletSharedPtr();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1543b26bac47991a677eacc0a56f0d293b874389"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTc1MDIyOnYy", "diffSide": "RIGHT", "path": "be/src/olap/tablet.h", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNToxMTo1MFrOGfyhPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwMzozMzoxOVrOGgOThA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4Njc1MA==", "bodyText": "incomplete?", "url": "https://github.com/apache/incubator-doris/pull/3762#discussion_r435986750", "createdAt": "2020-06-05T15:11:50Z", "author": {"login": "morningman"}, "path": "be/src/olap/tablet.h", "diffHunk": "@@ -46,47 +46,27 @@ class TabletMeta;\n \n using TabletSharedPtr = std::shared_ptr<Tablet>;\n \n+inline TabletSharedPtr to_tablet(const BaseTabletSharedPtr& base) {\n+    if (base->is_memory()) {\n+        return TabletSharedPtr();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1543b26bac47991a677eacc0a56f0d293b874389"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ0MTk4OA==", "bodyText": "Why is this incomplete? This utility function for pointer conversion is only used in some internal code, another option is inline them, because, after inlining, some logic is redundant.", "url": "https://github.com/apache/incubator-doris/pull/3762#discussion_r436441988", "createdAt": "2020-06-08T03:33:19Z", "author": {"login": "decster"}, "path": "be/src/olap/tablet.h", "diffHunk": "@@ -46,47 +46,27 @@ class TabletMeta;\n \n using TabletSharedPtr = std::shared_ptr<Tablet>;\n \n+inline TabletSharedPtr to_tablet(const BaseTabletSharedPtr& base) {\n+    if (base->is_memory()) {\n+        return TabletSharedPtr();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4Njc1MA=="}, "originalCommit": {"oid": "1543b26bac47991a677eacc0a56f0d293b874389"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMTA2MjE5OnYy", "diffSide": "RIGHT", "path": "be/src/olap/tablet_manager.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNToxODoyNFrOGgjeBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNToxODoyNFrOGgjeBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc4ODc0MA==", "bodyText": "Change the comment", "url": "https://github.com/apache/incubator-doris/pull/3762#discussion_r436788740", "createdAt": "2020-06-08T15:18:24Z", "author": {"login": "morningman"}, "path": "be/src/olap/tablet_manager.cpp", "diffHunk": "@@ -98,26 +99,34 @@ OLAPStatus TabletManager::_add_tablet_unlocked(TTabletId tablet_id, SchemaHash s\n \n     if (existed_tablet == nullptr) {\n         return _add_tablet_to_map_unlocked(tablet_id, schema_hash,\n-                                           tablet, update_meta,\n+                                           base_tablet, update_meta,\n                                            false /*keep_files*/, false /*drop_old*/);\n     }\n \n     if (!force) {\n-        if (existed_tablet->tablet_path() == tablet->tablet_path()) {\n+        if (existed_tablet->tablet_path() == base_tablet->tablet_path()) {\n             LOG(WARNING) << \"add the same tablet twice! tablet_id=\" << tablet_id\n                          << \", schema_hash=\" << schema_hash\n-                         << \", tablet_path=\" << tablet->tablet_path();\n+                         << \", tablet_path=\" << base_tablet->tablet_path();\n             return OLAP_ERR_ENGINE_INSERT_EXISTS_TABLE;\n         }\n-        if (existed_tablet->data_dir() == tablet->data_dir()) {\n+        if (existed_tablet->data_dir() == base_tablet->data_dir()) {\n             LOG(WARNING) << \"add tablet with same data dir twice! tablet_id=\" << tablet_id\n                          << \", schema_hash=\" << schema_hash;\n             return OLAP_ERR_ENGINE_INSERT_EXISTS_TABLE;\n         }\n     }\n \n+    if (base_tablet->is_memory() || existed_tablet->is_memory()) {\n+        LOG(WARNING) << \"add the same tablet twice! tablet_id=\" << tablet_id", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1543b26bac47991a677eacc0a56f0d293b874389"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMjk3NzM1OnYy", "diffSide": "RIGHT", "path": "be/src/olap/tablet_manager.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwMTo1MzoxMlrOGg2EMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwMTo1MzoxMlrOGg2EMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA5MzQyNg==", "bodyText": "You can return nullptr directly.", "url": "https://github.com/apache/incubator-doris/pull/3762#discussion_r437093426", "createdAt": "2020-06-09T01:53:12Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/tablet_manager.cpp", "diffHunk": "@@ -1374,16 +1482,29 @@ TabletSharedPtr TabletManager::_get_tablet_unlocked(TTabletId tablet_id, SchemaH\n \n     VLOG(3) << \"fail to get tablet. tablet_id=\" << tablet_id << \", schema_hash=\" << schema_hash;\n     // Return nullptr tablet if fail\n-    TabletSharedPtr tablet;\n+    BaseTabletSharedPtr tablet;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1543b26bac47991a677eacc0a56f0d293b874389"}, "originalPosition": 544}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1450, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}