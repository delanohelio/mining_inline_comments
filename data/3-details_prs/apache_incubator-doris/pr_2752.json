{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNDMwNTU1", "number": 2752, "title": "Add be bitmap udf ", "bodyText": "add bitmap_contains udf   #2540\nadd bitmap_has_any udf   #2541", "createdAt": "2020-01-14T03:52:18Z", "url": "https://github.com/apache/incubator-doris/pull/2752", "merged": true, "mergeCommit": {"oid": "7768629f0878bce386d18c825c20a560d2bc9b90"}, "closed": true, "closedAt": "2020-01-15T06:31:45Z", "author": {"login": "DanyBin"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6Ioo9AH2gAyMzYyNDMwNTU1OmVhNWIyNDkyOWYyODUzZWU4MDRlNTA4YTM2Yjg3MGVjNzNiOTBiODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6flmoAFqTM0MzAwOTUyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ea5b24929f2853ee804e508a36b870ec73b90b85", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/ea5b24929f2853ee804e508a36b870ec73b90b85", "committedDate": "2020-01-14T03:46:10Z", "message": "add bitmap udf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/4f1a1db03e1903f6ddcc8f642f620d7492af1635", "committedDate": "2020-01-14T03:47:48Z", "message": "add bitmap udf"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMjkyMDM1", "url": "https://github.com/apache/incubator-doris/pull/2752#pullrequestreview-342292035", "createdAt": "2020-01-14T04:59:43Z", "commit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNDo1OTo0M1rOFdMOPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNDo1OTo0M1rOFdMOPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MzI3OA==", "bodyText": "zero size means the src input is a object pointer", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366153278", "createdAt": "2020-01-14T04:59:43Z", "author": {"login": "kangkaisen"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,43 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext *ctx, const StringVal &src, const IntVal &input) {\n+    if (src.is_null || input.is_null) {\n+        return BooleanVal::null();\n+    }\n+\n+    if (src.len == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMjkyMTA1", "url": "https://github.com/apache/incubator-doris/pull/2752#pullrequestreview-342292105", "createdAt": "2020-01-14T05:00:09Z", "commit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNTowMDowOVrOFdMOeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNTowMDowOVrOFdMOeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MzMzOA==", "bodyText": "zero size means the src input is a object pointer", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366153338", "createdAt": "2020-01-14T05:00:09Z", "author": {"login": "kangkaisen"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,43 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext *ctx, const StringVal &src, const IntVal &input) {\n+    if (src.is_null || input.is_null) {\n+        return BooleanVal::null();\n+    }\n+\n+    if (src.len == 0) {\n+        return BooleanVal(false);\n+    }\n+\n+    RoaringBitmap bitmap;\n+    bitmap.update(input.val);\n+    bitmap.intersect(RoaringBitmap((char*)src.ptr));\n+\n+    if (bitmap.cardinality() == 1) {\n+        return BooleanVal(true);\n+    }\n+    return BooleanVal(false);\n+}\n+\n+BooleanVal BitmapFunctions::bitmap_has_any(FunctionContext *ctx, const StringVal &lhs, const StringVal &rhs) {\n+    if (lhs.is_null || rhs.is_null) {\n+        return BooleanVal::null();\n+    }\n+\n+    if (lhs.len == 0 || rhs.len == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMjkxMTM4", "url": "https://github.com/apache/incubator-doris/pull/2752#pullrequestreview-342291138", "createdAt": "2020-01-14T04:55:28Z", "commit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNDo1NToyOFrOFdMLNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNTowMDozNlrOFdMOtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MjUwMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            BooleanVal BitmapFunctions::bitmap_contains(FunctionContext *ctx, const StringVal &src, const IntVal &input) {\n          \n          \n            \n            BooleanVal BitmapFunctions::bitmap_contains(FunctionContext* ctx, const StringVal& src, const IntVal& input) {", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366152501", "createdAt": "2020-01-14T04:55:28Z", "author": {"login": "imay"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,43 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext *ctx, const StringVal &src, const IntVal &input) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MjgwMQ==", "bodyText": "when src.len == 0, src.ptr points to a bitmap object. we should handle that case", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366152801", "createdAt": "2020-01-14T04:57:20Z", "author": {"login": "imay"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,43 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext *ctx, const StringVal &src, const IntVal &input) {\n+    if (src.is_null || input.is_null) {\n+        return BooleanVal::null();\n+    }\n+\n+    if (src.len == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MzEyOQ==", "bodyText": "RoaringBitmap has already had contains method, you can use it directly", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366153129", "createdAt": "2020-01-14T04:58:55Z", "author": {"login": "imay"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,43 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext *ctx, const StringVal &src, const IntVal &input) {\n+    if (src.is_null || input.is_null) {\n+        return BooleanVal::null();\n+    }\n+\n+    if (src.len == 0) {\n+        return BooleanVal(false);\n+    }\n+\n+    RoaringBitmap bitmap;\n+    bitmap.update(input.val);\n+    bitmap.intersect(RoaringBitmap((char*)src.ptr));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1MzM5Nw==", "bodyText": "Because we don't have unsigned int, but the bit value can exceede the max int. Better use BigIntValue as bit index", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366153397", "createdAt": "2020-01-14T05:00:36Z", "author": {"login": "imay"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,43 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext *ctx, const StringVal &src, const IntVal &input) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f1a1db03e1903f6ddcc8f642f620d7492af1635"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da2e36b99e47fac59eee0c6fe575ff531492e5a0", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/da2e36b99e47fac59eee0c6fe575ff531492e5a0", "committedDate": "2020-01-14T06:56:40Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyOTM3MTU2", "url": "https://github.com/apache/incubator-doris/pull/2752#pullrequestreview-342937156", "createdAt": "2020-01-15T01:07:19Z", "commit": {"oid": "da2e36b99e47fac59eee0c6fe575ff531492e5a0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwMTowNzoxOVrOFdqslg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwMTowNzoxOVrOFdqslg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY1MjU2Ng==", "bodyText": "This operation is wasteful.\nIt is efficient to operate with src.ptr.", "url": "https://github.com/apache/incubator-doris/pull/2752#discussion_r366652566", "createdAt": "2020-01-15T01:07:19Z", "author": {"login": "imay"}, "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -465,6 +465,44 @@ StringVal BitmapFunctions::bitmap_from_string(FunctionContext* ctx, const String\n     return result;\n }\n \n+BooleanVal BitmapFunctions::bitmap_contains(FunctionContext* ctx, const StringVal& src, const BigIntVal& input) {\n+    if (src.is_null || input.is_null) {\n+        return BooleanVal::null();\n+    }\n+\n+    RoaringBitmap bitmap;\n+    if (src.len == 0) {\n+        bitmap.merge(*reinterpret_cast<RoaringBitmap*>(src.ptr));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da2e36b99e47fac59eee0c6fe575ff531492e5a0"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f40b4432f2ad3fc9b538ec3bb9a8c8525f180b69", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/f40b4432f2ad3fc9b538ec3bb9a8c8525f180b69", "committedDate": "2020-01-15T04:04:41Z", "message": "fix bitmap udf"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMDA5NTI4", "url": "https://github.com/apache/incubator-doris/pull/2752#pullrequestreview-343009528", "createdAt": "2020-01-15T06:30:40Z", "commit": {"oid": "f40b4432f2ad3fc9b538ec3bb9a8c8525f180b69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3947, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}