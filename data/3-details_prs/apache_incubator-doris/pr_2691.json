{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5OTU1ODI4", "number": 2691, "title": "add rowset state", "bodyText": "add rowset state to rowset\nadd close api to rowset to release resources\nissue: #2665", "createdAt": "2020-01-07T11:51:37Z", "url": "https://github.com/apache/incubator-doris/pull/2691", "merged": true, "mergeCommit": {"oid": "3690f3e917c4aea8127d1e02acf42a4174cdc44d"}, "closed": true, "closedAt": "2020-01-10T06:17:58Z", "author": {"login": "kangpinghuang"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4WkDpgFqTMzOTkwNTExMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb44ZzEgFqTM0MDk3MTExOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5OTA1MTEw", "url": "https://github.com/apache/incubator-doris/pull/2691#pullrequestreview-339905110", "createdAt": "2020-01-08T14:37:50Z", "commit": {"oid": "3661b6f129bf86b750b1248bafec944c9608f935"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNDozNzo1MFrOFbYzKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNDo0Nzo0NFrOFbZH7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI2MjE4Nw==", "bodyText": "give comment for the usage of these two lock", "url": "https://github.com/apache/incubator-doris/pull/2691#discussion_r364262187", "createdAt": "2020-01-08T14:37:50Z", "author": {"login": "imay"}, "path": "be/src/olap/rowset/rowset.h", "diffHunk": "@@ -152,8 +268,13 @@ class Rowset : public std::enable_shared_from_this<Rowset> {\n     bool _is_pending;    // rowset is pending iff it's not in visible state\n     bool _is_cumulative; // rowset is cumulative iff it's visible and start version < end version\n \n-    DorisCallOnce<OLAPStatus> _load_once;\n+    SpinLock _lock;\n+    Mutex _load_lock;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3661b6f129bf86b750b1248bafec944c9608f935"}, "originalPosition": 171}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI2MjQ4Nw==", "bodyText": "should be given a default value", "url": "https://github.com/apache/incubator-doris/pull/2691#discussion_r364262487", "createdAt": "2020-01-08T14:38:27Z", "author": {"login": "imay"}, "path": "be/src/olap/rowset/rowset.h", "diffHunk": "@@ -152,8 +268,13 @@ class Rowset : public std::enable_shared_from_this<Rowset> {\n     bool _is_pending;    // rowset is pending iff it's not in visible state\n     bool _is_cumulative; // rowset is cumulative iff it's visible and start version < end version\n \n-    DorisCallOnce<OLAPStatus> _load_once;\n+    SpinLock _lock;\n+    Mutex _load_lock;\n     bool _need_delete_file = false;\n+    // variable to indicate how many rowset readers owned this rowset\n+    std::atomic<uint64_t> _refs_by_reader;\n+    // rowset state machine\n+    RowsetStateMachine _rowset_state_machine;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3661b6f129bf86b750b1248bafec944c9608f935"}, "originalPosition": 176}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI2NDE5NA==", "bodyText": "better to call this out of lock block", "url": "https://github.com/apache/incubator-doris/pull/2691#discussion_r364264194", "createdAt": "2020-01-08T14:41:43Z", "author": {"login": "imay"}, "path": "be/src/olap/rowset/rowset.h", "diffHunk": "@@ -95,6 +151,37 @@ class Rowset : public std::enable_shared_from_this<Rowset> {\n     // TODO should we rename the method to remove_files() to be more specific?\n     virtual OLAPStatus remove() = 0;\n \n+    // close to clear the resource owned by rowset\n+    // including: open files, indexes and so on\n+    // NOTICE: can not call this function in multithreads\n+    void close() {\n+        RowsetState old_state = _rowset_state_machine.rowset_state();\n+        if (old_state == ROWSET_UNLOADED) {\n+            return;\n+        }\n+        OLAPStatus st = OLAP_SUCCESS;\n+        {\n+            std::lock_guard<SpinLock> l(_lock);\n+            old_state = _rowset_state_machine.rowset_state();\n+            if (old_state == ROWSET_UNLOADED) {\n+                return;\n+            }\n+            uint64_t current_refs = _refs_by_reader;\n+            st = _rowset_state_machine.on_close(current_refs);\n+            if (current_refs == 0) {\n+                do_close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3661b6f129bf86b750b1248bafec944c9608f935"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI2NDkyOQ==", "bodyText": "seems no usage, just leave a DCHECK(state == UNLOADED)", "url": "https://github.com/apache/incubator-doris/pull/2691#discussion_r364264929", "createdAt": "2020-01-08T14:43:03Z", "author": {"login": "imay"}, "path": "be/src/olap/rowset/rowset.h", "diffHunk": "@@ -127,6 +214,30 @@ class Rowset : public std::enable_shared_from_this<Rowset> {\n         return left->end_version() < right->end_version();\n     }\n \n+    // this function is called by reader to increase reference of rowset\n+    void aquire() {\n+        ++_refs_by_reader;\n+    }\n+\n+    void release() {\n+        // if the refs by reader is 0 and the rowset is closed, should release the resouce\n+        uint64_t current_refs = --_refs_by_reader;\n+        if (current_refs == 0 && _rowset_state_machine.rowset_state() == ROWSET_UNLOADING) {\n+            auto st = _rowset_state_machine.on_close(current_refs);\n+            if (st != OLAP_SUCCESS) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3661b6f129bf86b750b1248bafec944c9608f935"}, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI2NTg3Nw==", "bodyText": "When the state is unloading, seems OK to return", "url": "https://github.com/apache/incubator-doris/pull/2691#discussion_r364265877", "createdAt": "2020-01-08T14:44:48Z", "author": {"login": "imay"}, "path": "be/src/olap/rowset/rowset.h", "diffHunk": "@@ -95,6 +151,37 @@ class Rowset : public std::enable_shared_from_this<Rowset> {\n     // TODO should we rename the method to remove_files() to be more specific?\n     virtual OLAPStatus remove() = 0;\n \n+    // close to clear the resource owned by rowset\n+    // including: open files, indexes and so on\n+    // NOTICE: can not call this function in multithreads\n+    void close() {\n+        RowsetState old_state = _rowset_state_machine.rowset_state();\n+        if (old_state == ROWSET_UNLOADED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3661b6f129bf86b750b1248bafec944c9608f935"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI2NjI1NQ==", "bodyText": "UNLOADING", "url": "https://github.com/apache/incubator-doris/pull/2691#discussion_r364266255", "createdAt": "2020-01-08T14:45:29Z", "author": {"login": "imay"}, "path": "be/src/olap/rowset/rowset.h", "diffHunk": "@@ -95,6 +151,37 @@ class Rowset : public std::enable_shared_from_this<Rowset> {\n     // TODO should we rename the method to remove_files() to be more specific?\n     virtual OLAPStatus remove() = 0;\n \n+    // close to clear the resource owned by rowset\n+    // including: open files, indexes and so on\n+    // NOTICE: can not call this function in multithreads\n+    void close() {\n+        RowsetState old_state = _rowset_state_machine.rowset_state();\n+        if (old_state == ROWSET_UNLOADED) {\n+            return;\n+        }\n+        OLAPStatus st = OLAP_SUCCESS;\n+        {\n+            std::lock_guard<SpinLock> l(_lock);\n+            old_state = _rowset_state_machine.rowset_state();\n+            if (old_state == ROWSET_UNLOADED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3661b6f129bf86b750b1248bafec944c9608f935"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI2NzUwMw==", "bodyText": "Is this lock needed?", "url": "https://github.com/apache/incubator-doris/pull/2691#discussion_r364267503", "createdAt": "2020-01-08T14:47:44Z", "author": {"login": "imay"}, "path": "be/src/olap/rowset/rowset.cpp", "diffHunk": "@@ -36,7 +37,34 @@ Rowset::Rowset(const TabletSchema *schema,\n }\n \n OLAPStatus Rowset::load(bool use_cache) {\n-    return _load_once.call([this, use_cache] { return do_load_once(use_cache); });\n+    // if the state is ROWSET_UNLOADING it means close() is called\n+    // and the rowset is already loaded, and the resource is not closed yet.\n+    if (_rowset_state_machine.rowset_state() != ROWSET_UNLOADED) {\n+        return OLAP_SUCCESS;\n+    }\n+    std::string load_log = \"\";\n+    {\n+        MutexLock load_lock(&_load_lock);\n+        if (_rowset_state_machine.rowset_state() != ROWSET_UNLOADED) {\n+            return OLAP_SUCCESS;\n+        }\n+        RETURN_NOT_OK(_rowset_state_machine.on_load());\n+        RETURN_NOT_OK(do_load(use_cache));\n+        std::stringstream ss;\n+        ss << \"rowset is loaded. rowset version:\" << start_version() << \"-\" << end_version()\n+            << \", state from ROWSET_UNLOADED to ROWSET_LOADED. tabletid:\"\n+            << _rowset_meta->tablet_id();\n+        load_log = ss.str();\n+    }\n+    if (load_log != \"\") {\n+        LOG(INFO) << load_log;\n+    }\n+    return OLAP_SUCCESS;\n+}\n+\n+OLAPStatus Rowset::create_reader(std::shared_ptr<RowsetReader>* result) {\n+    std::lock_guard<SpinLock> l(_lock);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3661b6f129bf86b750b1248bafec944c9608f935"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNDM3NTM4", "url": "https://github.com/apache/incubator-doris/pull/2691#pullrequestreview-340437538", "createdAt": "2020-01-09T10:54:01Z", "commit": {"oid": "8e7cd47c84e72ae2bdbbe6f4a5137af65c2b86fa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMDo1NDowMVrOFbyCLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMDo1NDowMVrOFbyCLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY3NTYyOA==", "bodyText": "why lock? I think you should call load to make sure rowset is loaded?", "url": "https://github.com/apache/incubator-doris/pull/2691#discussion_r364675628", "createdAt": "2020-01-09T10:54:01Z", "author": {"login": "imay"}, "path": "be/src/olap/rowset/alpha_rowset.cpp", "diffHunk": "@@ -51,7 +51,8 @@ OLAPStatus AlphaRowset::do_load(bool use_cache) {\n     return OLAP_SUCCESS;\n }\n \n-OLAPStatus AlphaRowset::do_create_reader(std::shared_ptr<RowsetReader>* result) {\n+OLAPStatus AlphaRowset::create_reader(std::shared_ptr<RowsetReader>* result) {\n+    MutexLock release_lock(&_lock);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e7cd47c84e72ae2bdbbe6f4a5137af65c2b86fa"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fa054ffe5480b0688933eab634bce86d08b3d4b", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/8fa054ffe5480b0688933eab634bce86d08b3d4b", "committedDate": "2020-01-10T02:29:07Z", "message": "add rowset state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38c8816b3065d668cab2f6fb07429844ac9b1c99", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/38c8816b3065d668cab2f6fb07429844ac9b1c99", "committedDate": "2020-01-10T02:29:07Z", "message": "add state machine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b7de3e2bb411a0f57f856a25df8d2c615eb3b40", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/8b7de3e2bb411a0f57f856a25df8d2c615eb3b40", "committedDate": "2020-01-10T02:29:07Z", "message": "fix ut"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c9934d908d0f73a0b7482f60b18a493769b52c9", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/3c9934d908d0f73a0b7482f60b18a493769b52c9", "committedDate": "2020-01-10T02:29:07Z", "message": "remove lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7c228125d438aadc6a14b8480e2fa5f5fb5a59b", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/a7c228125d438aadc6a14b8480e2fa5f5fb5a59b", "committedDate": "2020-01-10T02:29:07Z", "message": "fix format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "461f2d2c14c86e479390eb501e14aeac7f3f0116", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/461f2d2c14c86e479390eb501e14aeac7f3f0116", "committedDate": "2020-01-10T02:29:07Z", "message": "optimize lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54cb603f49c63265fc43d6dee370b9399fab7f3d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/54cb603f49c63265fc43d6dee370b9399fab7f3d", "committedDate": "2020-01-10T02:29:07Z", "message": "fix pr problems"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e4cd13ad2468e57e0e01db16ebc79e14835ce7d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/8e4cd13ad2468e57e0e01db16ebc79e14835ce7d", "committedDate": "2020-01-10T02:29:07Z", "message": "fix pr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "358b5be1ee9f1f73d23f65176741fc5f513f6bba", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/358b5be1ee9f1f73d23f65176741fc5f513f6bba", "committedDate": "2020-01-10T02:29:07Z", "message": "modify Mutex to std::mutex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "effd4b872e72d03b012c78e714e20fe60aa032de", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/effd4b872e72d03b012c78e714e20fe60aa032de", "committedDate": "2020-01-10T02:29:08Z", "message": "remove lock in create reader"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "751cbd3cdd5dc98006bbf6fbfdb9923ecfa548f2", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/751cbd3cdd5dc98006bbf6fbfdb9923ecfa548f2", "committedDate": "2020-01-09T11:03:51Z", "message": "remove lock in create reader"}, "afterCommit": {"oid": "effd4b872e72d03b012c78e714e20fe60aa032de", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/effd4b872e72d03b012c78e714e20fe60aa032de", "committedDate": "2020-01-10T02:29:08Z", "message": "remove lock in create reader"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwOTcxMTE5", "url": "https://github.com/apache/incubator-doris/pull/2691#pullrequestreview-340971119", "createdAt": "2020-01-10T06:17:33Z", "commit": {"oid": "effd4b872e72d03b012c78e714e20fe60aa032de"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3893, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}