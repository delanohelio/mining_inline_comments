{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NDE0MTE4", "number": 3872, "title": "[Bug] Fix bug that BE crash when doing Insert Operation", "bodyText": "Fix: #3871\nMainly change:\n\nFix the bug in update_status(status) of PlanFragmentExecutor.\nWhen the FE Coordinator executes execRemoteFragmentAsync(), if it finds an RPC error, return a Future with an error code instead of exception.\nProtect the _status in RuntimeState with lock\nMove the _runtime_profile of RuntimeState before the _obj_pool, so that the profile will be\ndeconstructed after the object pool.\nRemove the unused ObjectPool param in RuntimeProfile constructor. If I don't remove it,\nRuntimeProfile will depends on the _obj_pool in RuntimeProfile.", "createdAt": "2020-06-15T09:38:02Z", "url": "https://github.com/apache/incubator-doris/pull/3872", "merged": true, "mergeCommit": {"oid": "51367abce76282fa713673868e7a3d3b1c09c3de"}, "closed": true, "closedAt": "2020-06-19T09:09:05Z", "author": {"login": "morningman"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrfGZOAFqTQzMDU2MTMxMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcspqiNgFqTQzMzc2NDMwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNTYxMzEz", "url": "https://github.com/apache/incubator-doris/pull/3872#pullrequestreview-430561313", "createdAt": "2020-06-15T11:38:52Z", "commit": {"oid": "ce38590182edb0771ec7166069a2467c66a07345"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMTozODo1MlrOGjudGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMTozODo1MlrOGjudGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExNDQ1OQ==", "bodyText": "black list  --> blacklist", "url": "https://github.com/apache/incubator-doris/pull/3872#discussion_r440114459", "createdAt": "2020-06-15T11:38:52Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/qe/Coordinator.java", "diffHunk": "@@ -1469,8 +1470,41 @@ public boolean isBackendStateHealthy() {\n             try {\n                 return BackendServiceProxy.getInstance().execPlanFragmentAsync(brpcAddress, rpcParams);\n             } catch (RpcException e) {\n-                SimpleScheduler.addToBlacklist(backend.getId());\n-                throw e;\n+                // Do not throw exception here.\n+                // return a completed future, the caller will check the result and do the cancel process.\n+                PExecPlanFragmentResult result = new PExecPlanFragmentResult();\n+                PStatus pStatus = new PStatus();\n+                pStatus.error_msgs.add(e.getMessage());\n+                // use THRIFT_RPC_ERROR so that this BE will be added to the black list later.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce38590182edb0771ec7166069a2467c66a07345"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce38590182edb0771ec7166069a2467c66a07345", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/ce38590182edb0771ec7166069a2467c66a07345", "committedDate": "2020-06-15T09:33:56Z", "message": "[Bug] Fix bug that BE crash when doing Insert Operation"}, "afterCommit": {"oid": "b0cb04ec83fcd571b699759c0431f3ad3e2c77d3", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/b0cb04ec83fcd571b699759c0431f3ad3e2c77d3", "committedDate": "2020-06-15T12:48:56Z", "message": "remerge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDIxMzk2", "url": "https://github.com/apache/incubator-doris/pull/3872#pullrequestreview-432021396", "createdAt": "2020-06-17T02:47:26Z", "commit": {"oid": "5a73cc2a94f9ae88019226bd430bc97d7d823ad4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMjo0NzoyNlrOGkzvvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMjo0NzoyNlrOGkzvvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI0OTcyNQ==", "bodyText": "If you have time. I think we would better use std::lock_guard and std:: mutex  instead of boost::lock_guard and boost::mutex.", "url": "https://github.com/apache/incubator-doris/pull/3872#discussion_r441249725", "createdAt": "2020-06-17T02:47:26Z", "author": {"login": "kangkaisen"}, "path": "be/src/runtime/plan_fragment_executor.cpp", "diffHunk": "@@ -323,7 +323,12 @@ Status PlanFragmentExecutor::open_internal() {\n     {\n         SCOPED_TIMER(profile()->total_time_counter());\n         collect_query_statistics();\n-        Status status = _sink->close(runtime_state(), _status);\n+        Status status;\n+        {\n+            boost::lock_guard<boost::mutex> l(_status_lock);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a73cc2a94f9ae88019226bd430bc97d7d823ad4"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDIxNDc1", "url": "https://github.com/apache/incubator-doris/pull/3872#pullrequestreview-432021475", "createdAt": "2020-06-17T02:47:41Z", "commit": {"oid": "5a73cc2a94f9ae88019226bd430bc97d7d823ad4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d08fc023cb3e8925283582db4c6cf49dc41b4dc", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/4d08fc023cb3e8925283582db4c6cf49dc41b4dc", "committedDate": "2020-06-18T13:11:11Z", "message": "remerge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6870491338a46ce2ce5d15cfab356f3e6d02f56e", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/6870491338a46ce2ce5d15cfab356f3e6d02f56e", "committedDate": "2020-06-18T13:11:11Z", "message": "add missing code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9201abf538f2a86520ccd4a244a324cb7dc251c", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/a9201abf538f2a86520ccd4a244a324cb7dc251c", "committedDate": "2020-06-18T13:11:11Z", "message": "fix ut"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a73cc2a94f9ae88019226bd430bc97d7d823ad4", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/5a73cc2a94f9ae88019226bd430bc97d7d823ad4", "committedDate": "2020-06-16T06:36:54Z", "message": "add missing code"}, "afterCommit": {"oid": "a9201abf538f2a86520ccd4a244a324cb7dc251c", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/a9201abf538f2a86520ccd4a244a324cb7dc251c", "committedDate": "2020-06-18T13:11:11Z", "message": "fix ut"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzY0MzA2", "url": "https://github.com/apache/incubator-doris/pull/3872#pullrequestreview-433764306", "createdAt": "2020-06-19T02:31:19Z", "commit": {"oid": "a9201abf538f2a86520ccd4a244a324cb7dc251c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2563, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}