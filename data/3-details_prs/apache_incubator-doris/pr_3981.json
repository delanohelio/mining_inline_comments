{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxNjY1MDY2", "number": 3981, "title": "[Feature] Batch update partition's property in one command", "bodyText": "#3389\nWe used to update single partition's properties by the following command:\nalter table tbl_name modify partition p1 set (\"replication_num\" = \"3\");\n\nNow this commit supports updating multiple partitions' properties of range table in one command.\nExample:\n\nreplication_num\n\nalter table tbl_name modify partition (p1, p2, p3) set (\"replication_num\" = \"3\");\n\n\nstorage_medium && storage_cooldown_time\n\nalter table tbl_name modify partition (p1, p2, p3) set (\"storage_medium\" = \"SSD\", \"storage_cooldown_time\" = \"2018-01-01 12:00:00\");\n\n\nin_memory\n\nalter table tbl_name modify partition (*) set (\"in_memory\" = \"true\");", "createdAt": "2020-06-29T21:42:42Z", "url": "https://github.com/apache/incubator-doris/pull/3981", "merged": true, "mergeCommit": {"oid": "d2ab38a5e00d95949a349c213c33a8cf78796b89"}, "closed": true, "closedAt": "2020-07-09T13:48:44Z", "author": {"login": "xy720"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwBhCJAH2gAyNDQxNjY1MDY2OmQzMWU3OWQ0YjI5ZGQxMWY1ZGY4MGFmNzJkMGEyNjZmY2M0NmU5YjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy7--mgFqTQ0NDg2OTgzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d31e79d4b29dd11f5df80af72d0a266fcc46e9b6", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/d31e79d4b29dd11f5df80af72d0a266fcc46e9b6", "committedDate": "2020-06-29T14:00:26Z", "message": "save code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "137662fdc60a2f4caa806b096be4ff23fc4b44e8", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/137662fdc60a2f4caa806b096be4ff23fc4b44e8", "committedDate": "2020-06-29T16:21:36Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e885cd21e9c01673fe2d99920299f54efe574e68", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/e885cd21e9c01673fe2d99920299f54efe574e68", "committedDate": "2020-06-29T21:17:38Z", "message": "add ut and doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5OTIzMDAw", "url": "https://github.com/apache/incubator-doris/pull/3981#pullrequestreview-439923000", "createdAt": "2020-06-30T11:29:32Z", "commit": {"oid": "e885cd21e9c01673fe2d99920299f54efe574e68"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMToyOTozMlrOGq4DYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMToyOTozMlrOGq4DYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYxMTc0Nw==", "bodyText": "\u4fdd\u7559 MODIFY PARTITION partition_name  \u8fd9\u79cd\u5199\u6cd5", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r447611747", "createdAt": "2020-06-30T11:29:32Z", "author": {"login": "morningman"}, "path": "docs/zh-CN/sql-reference/sql-statements/Data Definition/ALTER TABLE.md", "diffHunk": "@@ -64,7 +64,7 @@ under the License.\n             \n     3. \u4fee\u6539\u5206\u533a\u5c5e\u6027\n         \u8bed\u6cd5\uff1a\n-            MODIFY PARTITION partition_name SET (\"key\" = \"value\", ...)\n+            MODIFY PARTITION (p1[, p2, ...]) SET (\"key\" = \"value\", ...)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e885cd21e9c01673fe2d99920299f54efe574e68"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwOTA2NTQ3", "url": "https://github.com/apache/incubator-doris/pull/3981#pullrequestreview-440906547", "createdAt": "2020-07-01T14:11:01Z", "commit": {"oid": "e885cd21e9c01673fe2d99920299f54efe574e68"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNDoxMTowMVrOGrnnew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNDoxMjowN1rOGrnqZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM5MTAzNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static public ModifyPartitionClause createStarClause(Map<String, String> properties) {\n          \n          \n            \n                public static ModifyPartitionClause createStarClause(Map<String, String> properties) {", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r448391035", "createdAt": "2020-07-01T14:11:01Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/ModifyPartitionClause.java", "diffHunk": "@@ -48,10 +56,27 @@ public ModifyPartitionClause(String partitionName, Map<String, String> propertie\n         this.needTableStable = false;\n     }\n \n+    // c'tor for 'Modify Partition(*)' clause\n+    private ModifyPartitionClause(Map<String, String> properties) {\n+        super(AlterOpType.MODIFY_PARTITION);\n+        this.partitionNames = Lists.newArrayList();\n+        this.properties = properties;\n+        this.needExpand = true;\n+        this.needTableStable = false;\n+    }\n+\n+    static public ModifyPartitionClause createStarClause(Map<String, String> properties) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e885cd21e9c01673fe2d99920299f54efe574e68"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM5MTc4MQ==", "bodyText": "better to write meta in one edit log", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r448391781", "createdAt": "2020-07-01T14:12:07Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -3334,6 +3334,45 @@ public void replayRecoverPartition(RecoverInfo info) {\n         }\n     }\n \n+    /**\n+     * Batch update partitions' properties\n+     * caller should hold the db lock\n+     */\n+    public void modifyPartitionsProperty(Database db,\n+                                         OlapTable olapTable,\n+                                         List<String> partitionNames,\n+                                         Map<String, String> properties)\n+            throws DdlException {\n+        Preconditions.checkArgument(db.isWriteLockHeldByCurrentThread());\n+        if (olapTable.getState() != OlapTableState.NORMAL) {\n+            throw new DdlException(\"Table[\" + olapTable.getName() + \"]'s state is not NORMAL\");\n+        }\n+\n+        for (String partitionName : partitionNames) {\n+            Partition partition = olapTable.getPartition(partitionName);\n+            if (partition == null) {\n+                throw new DdlException(\n+                        \"Partition[\" + partitionName + \"] does not exist in table[\" + olapTable.getName() + \"]\");\n+            }\n+        }\n+\n+        // If error occurs tell user which partition is wrong.\n+        for (String partitionName : partitionNames) {\n+            try {\n+                Map<String, String> partitionProperties = Maps.newHashMap(properties);\n+                modifyPartitionProperty(db, olapTable, partitionName, partitionProperties);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e885cd21e9c01673fe2d99920299f54efe574e68"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba3e52296bf755df1870d7afb7edc8b15acda5bc", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/ba3e52296bf755df1870d7afb7edc8b15acda5bc", "committedDate": "2020-07-02T06:40:32Z", "message": "add editlog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ee92f9762ce8e89e86f258bfd4ac15d50253afa", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/5ee92f9762ce8e89e86f258bfd4ac15d50253afa", "committedDate": "2020-07-02T07:16:00Z", "message": "license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd49f51567c75c3d6e32d15781af76710bd06c08", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/dd49f51567c75c3d6e32d15781af76710bd06c08", "committedDate": "2020-07-02T07:19:10Z", "message": "remove unuse"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjU3ODkx", "url": "https://github.com/apache/incubator-doris/pull/3981#pullrequestreview-442657891", "createdAt": "2020-07-05T08:33:53Z", "commit": {"oid": "dd49f51567c75c3d6e32d15781af76710bd06c08"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwODozMzo1M1rOGtAtXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwODozNToxMlrOGtAt2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MDcxOQ==", "bodyText": "Wrong import.", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r449850719", "createdAt": "2020-07-05T08:33:53Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/ModifyPartitionClause.java", "diffHunk": "@@ -17,28 +17,36 @@\n \n package org.apache.doris.analysis;\n \n+import com.clearspring.analytics.util.Lists;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd49f51567c75c3d6e32d15781af76710bd06c08"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MDg0MA==", "bodyText": "Should print \"*\" if needExpand is true", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r449850840", "createdAt": "2020-07-05T08:35:12Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/ModifyPartitionClause.java", "diffHunk": "@@ -64,11 +89,17 @@ public void analyze(Analyzer analyzer) throws AnalysisException {\n         return this.properties;\n     }\n \n+    public boolean isNeedExpand() {\n+        return this.needExpand;\n+    }\n+\n     @Override\n     public String toSql() {\n         StringBuilder sb = new StringBuilder();\n         sb.append(\"MODIFY PARTITION \");\n-        sb.append(partitionName);\n+        sb.append(\"(\");\n+        sb.append(Joiner.on(\", \").join(partitionNames));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd49f51567c75c3d6e32d15781af76710bd06c08"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e23e88903f73aa65086f233d774eb03035cf2fd3", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/e23e88903f73aa65086f233d774eb03035cf2fd3", "committedDate": "2020-07-05T15:43:37Z", "message": "fix toSql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "988f576346bd6e50015e2bf60419f39764647c04", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/988f576346bd6e50015e2bf60419f39764647c04", "committedDate": "2020-07-06T07:52:19Z", "message": "save code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64a83cdcf85e2a7596dd1359bb61bbee40249ffd", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/64a83cdcf85e2a7596dd1359bb61bbee40249ffd", "committedDate": "2020-07-06T10:43:32Z", "message": "fix replay"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e468e22de02241d32d35858e1a3e27eefa4b1d74", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/e468e22de02241d32d35858e1a3e27eefa4b1d74", "committedDate": "2020-07-06T10:48:08Z", "message": "fix replay"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b4c3c210cd9bff03c43928335fef85fcaac51c7", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/0b4c3c210cd9bff03c43928335fef85fcaac51c7", "committedDate": "2020-07-07T01:41:08Z", "message": "adjust"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzOTk1MTMx", "url": "https://github.com/apache/incubator-doris/pull/3981#pullrequestreview-443995131", "createdAt": "2020-07-07T15:17:19Z", "commit": {"oid": "0b4c3c210cd9bff03c43928335fef85fcaac51c7"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNToxNzoxOVrOGuDfoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNToxOTo0OVrOGuDmXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk0NDkyOA==", "bodyText": "Import order", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r450944928", "createdAt": "2020-07-07T15:17:19Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/ModifyPartitionClause.java", "diffHunk": "@@ -17,28 +17,41 @@\n \n package org.apache.doris.analysis;\n \n+import com.google.common.base.Joiner;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Strings;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Maps;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b4c3c210cd9bff03c43928335fef85fcaac51c7"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk0NTI1Mg==", "bodyText": "private, and no need to be static. And method name can be changed to checkProperties.", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r450945252", "createdAt": "2020-07-07T15:17:45Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/analysis/ModifyPartitionClause.java", "diffHunk": "@@ -48,27 +61,80 @@ public ModifyPartitionClause(String partitionName, Map<String, String> propertie\n         this.needTableStable = false;\n     }\n \n+    // c'tor for 'Modify Partition(*)' clause\n+    private ModifyPartitionClause(Map<String, String> properties) {\n+        super(AlterOpType.MODIFY_PARTITION);\n+        this.partitionNames = Lists.newArrayList();\n+        this.properties = properties;\n+        this.needExpand = true;\n+        this.needTableStable = false;\n+    }\n+\n+    public static ModifyPartitionClause createStarClause(Map<String, String> properties) {\n+        return new ModifyPartitionClause(properties);\n+    }\n+\n     @Override\n     public void analyze(Analyzer analyzer) throws AnalysisException {\n-        if (Strings.isNullOrEmpty(partitionName)) {\n-            throw new AnalysisException(\"Partition name is not set\");\n+        if (partitionNames == null || (!needExpand && partitionNames.isEmpty())) {\n+            throw new AnalysisException(\"Partition names is not set or empty\");\n+        }\n+\n+        if (partitionNames.stream().anyMatch(entity -> Strings.isNullOrEmpty(entity))) {\n+            throw new AnalysisException(\"there are empty partition name\");\n         }\n \n         if (properties == null || properties.isEmpty()) {\n             throw new AnalysisException(\"Properties is not set\");\n         }\n+\n+        // check properties here\n+        preCheck(Maps.newHashMap(properties));\n+    }\n+\n+    // pre check the following properties' legality before modifying partition.\n+    // 1. replication_num\n+    // 2. storage_medium && storage_cooldown_time\n+    // 3. in_memory\n+    // 4. tablet type\n+    public static void preCheck(Map<String, String> properties) throws AnalysisException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b4c3c210cd9bff03c43928335fef85fcaac51c7"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk0NjY1NA==", "bodyText": "Add UT to test the read/write method of this class", "url": "https://github.com/apache/incubator-doris/pull/3981#discussion_r450946654", "createdAt": "2020-07-07T15:19:49Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/persist/BatchModifyPartitionsInfo.java", "diffHunk": "@@ -0,0 +1,55 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.persist;\n+\n+import com.google.gson.annotations.SerializedName;\n+import org.apache.doris.common.io.Text;\n+import org.apache.doris.common.io.Writable;\n+import org.apache.doris.persist.gson.GsonUtils;\n+\n+import java.io.DataInput;\n+import java.io.DataOutput;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/**\n+ * used for batch modify multi partitions in one atomic operation\n+ */\n+\n+public class BatchModifyPartitionsInfo implements Writable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b4c3c210cd9bff03c43928335fef85fcaac51c7"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09daa29956857aed386cea08f1f7149547167ded", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/09daa29956857aed386cea08f1f7149547167ded", "committedDate": "2020-07-08T03:15:43Z", "message": "fix import order and add ut"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODY5ODM0", "url": "https://github.com/apache/incubator-doris/pull/3981#pullrequestreview-444869834", "createdAt": "2020-07-08T15:15:29Z", "commit": {"oid": "09daa29956857aed386cea08f1f7149547167ded"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2223, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}