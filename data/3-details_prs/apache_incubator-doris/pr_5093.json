{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwOTk2NjQ2", "number": 5093, "title": "[Bug] Fix bug that routine load may lost some data", "bodyText": "Proposed changes\nIn the previous implementation, whether a subtask is in commit or abort state,\nwe will try to update the job progress, such as the consumed offset of kafka.\nUnder normal circumstances, the aborted transaction does not consume any data,\nand all progress is 0, so even we update the progress, the progress will remain\nunchanged.\nHowever, in the case of high cluster load, the subtask may fail half of the execution on the BE side.\nAt this time, although the task is aborted, part of the progress is updated.\nCause the next subtask to skip these data for consumption, resulting in data loss.\nBad case:\nLoadedRows = 0;\ncomittedOffset > 0\ntxn: aborted\nAlso modify some log level and config\nTypes of changes\n\n Bugfix (non-breaking change which fixes an issue)\n\nChecklist\n\n[] I have create an issue on (Fix #5095 ), and have described the bug/feature there in detail", "createdAt": "2020-12-16T08:49:03Z", "url": "https://github.com/apache/incubator-doris/pull/5093", "merged": true, "mergeCommit": {"oid": "c57145b4c2633c0152fc02995c8c1912f59d25a6"}, "closed": true, "closedAt": "2020-12-23T01:33:53Z", "author": {"login": "morningman"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmq7O0AH2gAyNTQwOTk2NjQ2OjJkYjg2ODk4OGY5YTlmYTE1YjdmZjI5ZDY0Y2ZkMGY0Yjc4ZjZlZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdojYw-AFqTU1NjgyMTY2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2db868988f9a9fa15b7ff29d64cfd0f4b78f6ee7", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/2db868988f9a9fa15b7ff29d64cfd0f4b78f6ee7", "committedDate": "2020-12-16T08:47:04Z", "message": "[Bug] Fix bug that routine load may lost some data\n\nIn the previous implementation, whether a subtask is in commit or abort state,\nwe will try to update the job progress, such as the consumed offset of kafka.\nUnder normal circumstances, the aborted transaction does not consume any data,\nand all progress is 0, so even we update the progress, the progress will remain\nunchanged.\nHowever, in the case of high cluster load, the subtask may fail half of the execution on the BE side.\nAt this time, although the task is aborted, part of the progress is updated.\nCause the next subtask to skip these data for consumption, resulting in data loss.\n\nAlso modify some log level and config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fc7b9006d2c0f1f8a06b9fcd455f8770a672f3e", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/5fc7b9006d2c0f1f8a06b9fcd455f8770a672f3e", "committedDate": "2020-12-16T13:40:30Z", "message": "fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6df889aa838fce6ff94e55c6ef58f46aca23279d", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/6df889aa838fce6ff94e55c6ef58f46aca23279d", "committedDate": "2020-12-17T07:07:39Z", "message": "fix bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MzM2NTk4", "url": "https://github.com/apache/incubator-doris/pull/5093#pullrequestreview-554336598", "createdAt": "2020-12-17T07:27:14Z", "commit": {"oid": "6df889aa838fce6ff94e55c6ef58f46aca23279d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwNzoyNzoxNFrOIHoAUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwNzoyNzoxNFrOIHoAUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDg2NjM4Ng==", "bodyText": "error commit...", "url": "https://github.com/apache/incubator-doris/pull/5093#discussion_r544866386", "createdAt": "2020-12-17T07:27:14Z", "author": {"login": "EmmyMiao87"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/routineload/RoutineLoadJob.java", "diffHunk": "@@ -1049,8 +1053,9 @@ private void executeTaskOnTxnStatusChanged(RoutineLoadTaskInfo routineLoadTaskIn\n                                           + \" maybe task was aborted by master when timeout\")\n                                   .build());\n             }\n-        } else if (checkCommitInfo(rlTaskTxnCommitAttachment, txnState.getTransactionStatus())) {\n+        } else if (checkCommitInfo(rlTaskTxnCommitAttachment, txnState)) {\n             // step2: update job progress\n+            // only committed task need to update progress", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6df889aa838fce6ff94e55c6ef58f46aca23279d"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef538470bb361bf714c4dd36cb3ed061d1a3dac8", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/ef538470bb361bf714c4dd36cb3ed061d1a3dac8", "committedDate": "2020-12-17T07:32:29Z", "message": "review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0Mzc4NzE1", "url": "https://github.com/apache/incubator-doris/pull/5093#pullrequestreview-554378715", "createdAt": "2020-12-17T08:36:07Z", "commit": {"oid": "ef538470bb361bf714c4dd36cb3ed061d1a3dac8"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NDM5MDcz", "url": "https://github.com/apache/incubator-doris/pull/5093#pullrequestreview-554439073", "createdAt": "2020-12-17T09:51:06Z", "commit": {"oid": "ef538470bb361bf714c4dd36cb3ed061d1a3dac8"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "350d304f73f47dec8f2ed8e99983142edf8c5cec", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/350d304f73f47dec8f2ed8e99983142edf8c5cec", "committedDate": "2020-12-19T04:44:53Z", "message": "fix ut"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4205e9fb601a40f8cb427d12de2fdb920bb6bdfa", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/4205e9fb601a40f8cb427d12de2fdb920bb6bdfa", "committedDate": "2020-12-19T08:21:15Z", "message": "fix codestyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d298be5be9bf1699667db4b1af14d5f6f8a9fb19", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/d298be5be9bf1699667db4b1af14d5f6f8a9fb19", "committedDate": "2020-12-19T12:07:32Z", "message": "fix bug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2fedbe163d494884f1e42e58eba494fa944cba3", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/e2fedbe163d494884f1e42e58eba494fa944cba3", "committedDate": "2020-12-19T11:59:14Z", "message": "fix bug"}, "afterCommit": {"oid": "d298be5be9bf1699667db4b1af14d5f6f8a9fb19", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/d298be5be9bf1699667db4b1af14d5f6f8a9fb19", "committedDate": "2020-12-19T12:07:32Z", "message": "fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66379508d9bde9f1862b132508a346ac15fe125f", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/66379508d9bde9f1862b132508a346ac15fe125f", "committedDate": "2020-12-19T12:56:31Z", "message": "fix bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MDk1MzA2", "url": "https://github.com/apache/incubator-doris/pull/5093#pullrequestreview-556095306", "createdAt": "2020-12-21T02:16:24Z", "commit": {"oid": "66379508d9bde9f1862b132508a346ac15fe125f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "143b3939d842bcbb0c268a713d0d180107f4313f", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/143b3939d842bcbb0c268a713d0d180107f4313f", "committedDate": "2020-12-21T10:27:36Z", "message": "5"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f53a4fe3896f02b241589734200f808035ec0866", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/f53a4fe3896f02b241589734200f808035ec0866", "committedDate": "2020-12-21T10:53:37Z", "message": "6"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2ODIxNjY3", "url": "https://github.com/apache/incubator-doris/pull/5093#pullrequestreview-556821667", "createdAt": "2020-12-22T05:07:56Z", "commit": {"oid": "f53a4fe3896f02b241589734200f808035ec0866"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3975, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}