{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MDUzNDQz", "number": 3260, "title": "[Storage] open data dirs parallelly", "bodyText": "Ref #3247", "createdAt": "2020-04-03T09:07:28Z", "url": "https://github.com/apache/incubator-doris/pull/3260", "merged": true, "mergeCommit": {"oid": "162b1c5d8bfd8afb7b01951ea5c5a79d1ffe1679"}, "closed": true, "closedAt": "2020-04-07T12:59:57Z", "author": {"login": "vagetablechicken"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcT8qkxgH2gAyMzk4MDUzNDQzOjQzMzk5ZTk5NmRhY2JhYTE1M2NmNzkzMDEyNjVjMmUzNWIxNzdkNTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVP48eAFqTM4ODk0Mjk4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "43399e996dacbaa153cf79301265c2e35b177d57", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/43399e996dacbaa153cf79301265c2e35b177d57", "committedDate": "2020-04-03T08:31:27Z", "message": "parallel open data dir"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6118dbfbe80e7f4883b6c93070f1ee7130fb19fa", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/6118dbfbe80e7f4883b6c93070f1ee7130fb19fa", "committedDate": "2020-04-03T08:56:14Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MjAxNTA1", "url": "https://github.com/apache/incubator-doris/pull/3260#pullrequestreview-387201505", "createdAt": "2020-04-03T12:15:58Z", "commit": {"oid": "6118dbfbe80e7f4883b6c93070f1ee7130fb19fa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMjoxNTo1OFrOGAS5Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMjoxNTo1OFrOGAS5Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk2MjY5MQ==", "bodyText": "Try to avoid using exceptions\nShould join all other threads before delete store, otherwise exceptions are prone to occur", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r402962691", "createdAt": "2020-04-03T12:15:58Z", "author": {"login": "imay"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -148,16 +148,33 @@ void StorageEngine::load_data_dirs(const std::vector<DataDir*>& data_dirs) {\n \n OLAPStatus StorageEngine::_open() {\n     // init store_map\n+    std::vector<std::pair<DataDir*,std::future<Status>>> tmp_vec;\n     for (auto& path : _options.store_paths) {\n+        LOG(INFO) << \"store_path \" << path.path;\n         DataDir* store = new DataDir(path.path, path.capacity_bytes, path.storage_medium,\n                                      _tablet_manager.get(), _txn_manager.get());\n-        auto st = store->init();\n-        if (!st.ok()) {\n-            LOG(WARNING) << \"Store load failed, path=\" << path.path;\n-            return OLAP_ERR_INVALID_ROOT_PATH;\n+        tmp_vec.emplace_back(std::make_pair(store,std::async([store](){ return store->init();})));\n+    }\n+\n+    try {\n+        for (auto& pair : tmp_vec) {\n+            DataDir* store = pair.first;\n+            auto st = pair.second.get();\n+            if (!st.ok()) {\n+                throw std::runtime_error(\"Store load failed, path=\" + store->path());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6118dbfbe80e7f4883b6c93070f1ee7130fb19fa"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b49c9cda542f8b4a0e1ac988340412b386dd468", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/2b49c9cda542f8b4a0e1ac988340412b386dd468", "committedDate": "2020-04-07T04:05:39Z", "message": "use threads"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5eb1a6cf23a7e47815fdfc8fc501fa24e525a16b", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/5eb1a6cf23a7e47815fdfc8fc501fa24e525a16b", "committedDate": "2020-04-07T04:09:17Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f87375c95c8418d01d215fda59ad23e1c53c296", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/3f87375c95c8418d01d215fda59ad23e1c53c296", "committedDate": "2020-04-07T05:23:37Z", "message": "fix name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4ODY0ODc4", "url": "https://github.com/apache/incubator-doris/pull/3260#pullrequestreview-388864878", "createdAt": "2020-04-07T07:47:51Z", "commit": {"oid": "3f87375c95c8418d01d215fda59ad23e1c53c296"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzo0Nzo1MlrOGB3HxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzo0ODo1MVrOGB3KDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYwNDg2OQ==", "bodyText": "should print st.to_string() too.", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r404604869", "createdAt": "2020-04-07T07:47:52Z", "author": {"login": "imay"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -185,6 +177,39 @@ OLAPStatus StorageEngine::_open() {\n     return OLAP_SUCCESS;\n }\n \n+OLAPStatus StorageEngine::_init_store_map() {\n+    std::vector < std::pair<DataDir*> tmp_stores;\n+    std::vector<std::thread> threads;\n+    std::atomic<bool> init_error{false};\n+    for (auto& path : _options.store_paths) {\n+        DataDir* store = new DataDir(path.path, path.capacity_bytes, path.storage_medium,\n+                                     _tablet_manager.get(), _txn_manager.get());\n+        tmp_stores.emplace_back(store);\n+        threads.emplace_back([store, &init_error]() {\n+            auto st = store->init();\n+            if (!st.ok()) {\n+                init_error = true;\n+                LOG(WARNING) << \"Store load failed, path=\" << store->path();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f87375c95c8418d01d215fda59ad23e1c53c296"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYwNTQ1Mw==", "bodyText": "???\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                std::vector < std::pair<DataDir*> tmp_stores;\n          \n          \n            \n                std::vector<DataDir*> tmp_stores;", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r404605453", "createdAt": "2020-04-07T07:48:51Z", "author": {"login": "imay"}, "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -185,6 +177,39 @@ OLAPStatus StorageEngine::_open() {\n     return OLAP_SUCCESS;\n }\n \n+OLAPStatus StorageEngine::_init_store_map() {\n+    std::vector < std::pair<DataDir*> tmp_stores;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f87375c95c8418d01d215fda59ad23e1c53c296"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08788c3a1d0f84847bdb38c2a28975781f5cb80b", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/08788c3a1d0f84847bdb38c2a28975781f5cb80b", "committedDate": "2020-04-07T08:12:42Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4OTQyOTg3", "url": "https://github.com/apache/incubator-doris/pull/3260#pullrequestreview-388942987", "createdAt": "2020-04-07T09:29:16Z", "commit": {"oid": "08788c3a1d0f84847bdb38c2a28975781f5cb80b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3161, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}