{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5OTQxODE2", "number": 3948, "title": "Support rpc_timeout property in stream load request to cancel request in fe in time when stream load request is timeout", "bodyText": "This PR is to enable cancel stream load request in fe in time when stream load request is timeout to make stream load more robust.", "createdAt": "2020-06-25T10:53:50Z", "url": "https://github.com/apache/incubator-doris/pull/3948", "merged": true, "mergeCommit": {"oid": "48d947edf46549bf87af521e9c4719880c9ec329"}, "closed": true, "closedAt": "2020-06-29T11:16:17Z", "author": {"login": "caiconghui"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuqVt-AH2gAyNDM5OTQxODE2OjA3ODkwZWU0OTVmN2M3NjlhOGM4NzE5NDFjZDEwODA5ZDJiMWQ2YzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvOxL1gFqTQzODY2NjUxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "07890ee495f7c769a8c871941cd10809d2b1d6c5", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/07890ee495f7c769a8c871941cd10809d2b1d6c5", "committedDate": "2020-06-25T08:26:20Z", "message": "Support rpc_timeout property in stream load requet to cancel request in fe in time when stream load request is timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a59b47c23ad07368d8db02ec32b8f074a3e26629", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/a59b47c23ad07368d8db02ec32b8f074a3e26629", "committedDate": "2020-06-25T08:29:17Z", "message": "fix time unit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MjQ3NzAz", "url": "https://github.com/apache/incubator-doris/pull/3948#pullrequestreview-438247703", "createdAt": "2020-06-26T12:19:21Z", "commit": {"oid": "a59b47c23ad07368d8db02ec32b8f074a3e26629"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjoxOToyMVrOGpewhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjoyMDowOFrOGpex4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE0ODc0Mw==", "bodyText": "new fields should be optional, for compatibility.\nAnd it need to be checked isset when use it.", "url": "https://github.com/apache/incubator-doris/pull/3948#discussion_r446148743", "createdAt": "2020-06-26T12:19:21Z", "author": {"login": "morningman"}, "path": "gensrc/thrift/FrontendService.thrift", "diffHunk": "@@ -600,6 +601,7 @@ struct TLoadTxnCommitRequest {\n     9: optional list<Types.TTabletCommitInfo> commitInfos\n     10: optional i64 auth_code\n     11: optional TTxnCommitAttachment txnCommitAttachment\n+    12: required i64 thrift_rpc_timeout_ms", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a59b47c23ad07368d8db02ec32b8f074a3e26629"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE0ODgxNg==", "bodyText": "optional", "url": "https://github.com/apache/incubator-doris/pull/3948#discussion_r446148816", "createdAt": "2020-06-26T12:19:30Z", "author": {"login": "morningman"}, "path": "gensrc/thrift/FrontendService.thrift", "diffHunk": "@@ -550,6 +550,7 @@ struct TStreamLoadPutRequest {\n     22: optional bool isTempPartition\n     23: optional bool strip_outer_array\n     24: optional string jsonpaths\n+    25: required i64 thrift_rpc_timeout_ms", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a59b47c23ad07368d8db02ec32b8f074a3e26629"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE0OTA5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new UserException(\"get database read lock timeout, database=\" + db.getFullName());\n          \n          \n            \n                        throw new UserException(\"get database write lock timeout, database=\" + db.getFullName());", "url": "https://github.com/apache/incubator-doris/pull/3948#discussion_r446149091", "createdAt": "2020-06-26T12:20:08Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/transaction/GlobalTransactionMgr.java", "diffHunk": "@@ -185,7 +186,9 @@ public boolean commitAndPublishTransaction(Database db, long transactionId,\n             List<TabletCommitInfo> tabletCommitInfos, long timeoutMillis,\n             TxnCommitAttachment txnCommitAttachment)\n             throws UserException {\n-        db.writeLock();\n+        if (!db.tryWriteLock(timeoutMillis, TimeUnit.MILLISECONDS)) {\n+            throw new UserException(\"get database read lock timeout, database=\" + db.getFullName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a59b47c23ad07368d8db02ec32b8f074a3e26629"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfe9587065166927865d4d19f8ec1c2e656b6c70", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/dfe9587065166927865d4d19f8ec1c2e656b6c70", "committedDate": "2020-06-26T14:01:55Z", "message": "Change from required to optional for thrift_prc_timeout_ms"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjY2NTEx", "url": "https://github.com/apache/incubator-doris/pull/3948#pullrequestreview-438666511", "createdAt": "2020-06-27T02:52:55Z", "commit": {"oid": "dfe9587065166927865d4d19f8ec1c2e656b6c70"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2201, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}