{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MjMyMTE3", "number": 3768, "title": "Disable Bitmap or Hll type in keys or in values with incorrect agg-type", "bodyText": "Bitmap and Hll type can not be used with incorrect aggregate functions, which will cause to BE crush.\nAdd some logical checks in FE's ColumnDef#analyze to avoid creating tables or changing schemas incorrectly.\n\nKeys never be bitmap or hll type\nvalues with bitmap or hll type have to be associated with bitmap_union or hll_union", "createdAt": "2020-06-03T14:14:38Z", "url": "https://github.com/apache/incubator-doris/pull/3768", "merged": true, "mergeCommit": {"oid": "c51f20bb7a2436954af70fdaccb81167f1c92183"}, "closed": true, "closedAt": "2020-06-06T03:36:07Z", "author": {"login": "spaces-X"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcn0uPdAFqTQyNDA2MTQ2OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcodBU-gFqTQyNTcwMjA0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MDYxNDY5", "url": "https://github.com/apache/incubator-doris/pull/3768#pullrequestreview-424061469", "createdAt": "2020-06-04T02:34:42Z", "commit": {"oid": "ecb4cdef5280d043ae4f17ca15e7020f065536de"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0Mjc0NDU0", "url": "https://github.com/apache/incubator-doris/pull/3768#pullrequestreview-424274454", "createdAt": "2020-06-04T09:41:20Z", "commit": {"oid": "2035bce6696d8770b98ff8921ae8e78c4ae40cc5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwOTo0MToyMFrOGe980Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwOTo0MToyMFrOGe980Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyNTQ1Nw==", "bodyText": "Why remove the primitiveTypeList.clear();.\nNow, the BITMAP_UNION is compatible with both BITMAP and HLL?", "url": "https://github.com/apache/incubator-doris/pull/3768#discussion_r435125457", "createdAt": "2020-06-04T09:41:20Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/AggregateType.java", "diffHunk": "@@ -85,20 +85,22 @@\n         compatibilityMap.put(MAX, EnumSet.copyOf(primitiveTypeList));\n \n         primitiveTypeList.clear();\n-        compatibilityMap.put(REPLACE, EnumSet.allOf(PrimitiveType.class));\n+        // all types except bitmap and hll.\n+        EnumSet<PrimitiveType> exc_bitmap_hll = EnumSet.allOf(PrimitiveType.class);\n+        exc_bitmap_hll.remove(PrimitiveType.BITMAP);\n+        exc_bitmap_hll.remove(PrimitiveType.HLL);\n+        compatibilityMap.put(REPLACE, EnumSet.copyOf(exc_bitmap_hll));\n+\n+        compatibilityMap.put(REPLACE_IF_NOT_NULL, EnumSet.copyOf(exc_bitmap_hll));\n \n-        primitiveTypeList.clear();\n-        compatibilityMap.put(REPLACE_IF_NOT_NULL, EnumSet.allOf(PrimitiveType.class));\n-       \n-        primitiveTypeList.clear();\n         primitiveTypeList.add(PrimitiveType.HLL);\n         compatibilityMap.put(HLL_UNION, EnumSet.copyOf(primitiveTypeList));\n \n-        primitiveTypeList.clear();\n+\n         primitiveTypeList.add(PrimitiveType.BITMAP);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2035bce6696d8770b98ff8921ae8e78c4ae40cc5"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f172e92481890a99176d726a786ab27c78ccec3", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/8f172e92481890a99176d726a786ab27c78ccec3", "committedDate": "2020-06-04T09:50:24Z", "message": "Disable Bitmap or Hll type in keys or in values with incorrect agg-type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0OTU2MzU5", "url": "https://github.com/apache/incubator-doris/pull/3768#pullrequestreview-424956359", "createdAt": "2020-06-05T02:27:16Z", "commit": {"oid": "8f172e92481890a99176d726a786ab27c78ccec3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwMjoyNzoxNlrOGfeW9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwMjoyNzoyNVrOGfeXGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY1NjQzNg==", "bodyText": "Should keep code style with original code.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if ( type.isBitmapType() || type.isHllType() ){\n          \n          \n            \n                    if (type.isBitmapType() || type.isHllType()) {", "url": "https://github.com/apache/incubator-doris/pull/3768#discussion_r435656436", "createdAt": "2020-06-05T02:27:16Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/analysis/ColumnDef.java", "diffHunk": "@@ -131,6 +131,16 @@ public void analyze(boolean isOlap) throws AnalysisException {\n \n         Type type = typeDef.getType();\n \n+        // disable Bitmap Hll type in keys, values without aggregate function.\n+        if ( type.isBitmapType() || type.isHllType() ){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f172e92481890a99176d726a786ab27c78ccec3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY1NjQ3Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (isKey){\n          \n          \n            \n                        if (isKey) {", "url": "https://github.com/apache/incubator-doris/pull/3768#discussion_r435656472", "createdAt": "2020-06-05T02:27:25Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/analysis/ColumnDef.java", "diffHunk": "@@ -131,6 +131,16 @@ public void analyze(boolean isOlap) throws AnalysisException {\n \n         Type type = typeDef.getType();\n \n+        // disable Bitmap Hll type in keys, values without aggregate function.\n+        if ( type.isBitmapType() || type.isHllType() ){\n+            if (isKey){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f172e92481890a99176d726a786ab27c78ccec3"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf09b2c1654ca90e99f1c7bd4081de5e5b940b1c", "author": {"user": {"login": "spaces-X", "name": "Xiang Wei"}}, "url": "https://github.com/apache/incubator-doris/commit/cf09b2c1654ca90e99f1c7bd4081de5e5b940b1c", "committedDate": "2020-06-05T02:40:46Z", "message": "Apply suggestions from code review\r\n\r\nkeep code style\n\nCo-authored-by: Zhao Chun <buaa.zhaoc@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDE3NDI2", "url": "https://github.com/apache/incubator-doris/pull/3768#pullrequestreview-425017426", "createdAt": "2020-06-05T06:05:19Z", "commit": {"oid": "cf09b2c1654ca90e99f1c7bd4081de5e5b940b1c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NzAyMDQ4", "url": "https://github.com/apache/incubator-doris/pull/3768#pullrequestreview-425702048", "createdAt": "2020-06-06T01:31:45Z", "commit": {"oid": "cf09b2c1654ca90e99f1c7bd4081de5e5b940b1c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2454, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}