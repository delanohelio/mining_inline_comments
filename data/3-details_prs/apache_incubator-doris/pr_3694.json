{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMjc0NTk5", "number": 3694, "title": "[Enhancement] Improve the performance of query with IN predicate ", "bodyText": "Fix: #3693\nThis CL mainly changes:\n\n\nAdd a new BE config max_pushdown_conditions_per_column to limit the number of conditions of a single column that can be pushed down to storage engine.\n\n\nAdd 2 new session variables max_scan_key_num and doris_max_scan_key_num which can set in session level and overwrite the config value in BE.", "createdAt": "2020-05-26T15:19:57Z", "url": "https://github.com/apache/incubator-doris/pull/3694", "merged": true, "mergeCommit": {"oid": "27046c5b6115fe0bf510757f41759ae7e98727ec"}, "closed": true, "closedAt": "2020-06-04T03:39:01Z", "author": {"login": "morningman"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclGj8LABqjMzNzQxNjMwNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn1ivzgFqTQyNDA3ODA0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c05408c879b6938b34f2fbd4b14e2ad9fbdeb5f", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/4c05408c879b6938b34f2fbd4b14e2ad9fbdeb5f", "committedDate": "2020-05-26T15:28:03Z", "message": "fix comment"}, "afterCommit": {"oid": "a915c56081bf094a11285b78ac25556e1f719093", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/a915c56081bf094a11285b78ac25556e1f719093", "committedDate": "2020-05-26T15:34:45Z", "message": "fix comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4ODI2Nzcx", "url": "https://github.com/apache/incubator-doris/pull/3694#pullrequestreview-418826771", "createdAt": "2020-05-27T03:06:32Z", "commit": {"oid": "a915c56081bf094a11285b78ac25556e1f719093"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzowNjozMlrOGa36pA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzowNjozMlrOGa36pA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgzMjI5Mg==", "bodyText": "I think we should do this work directly in FE, Not add a todo here. In FE we could directly get a empty set for this query.", "url": "https://github.com/apache/incubator-doris/pull/3694#discussion_r430832292", "createdAt": "2020-05-27T03:06:32Z", "author": {"login": "kangkaisen"}, "path": "be/src/exec/olap_scan_node.cpp", "diffHunk": "@@ -884,25 +910,54 @@ Status OlapScanNode::normalize_in_predicate(SlotDescriptor* slot, ColumnValueRan\n                     case TYPE_INT:\n                     case TYPE_BIGINT:\n                     case TYPE_LARGEINT: {\n+                        range->clear();\n                         range->add_fixed_value(*reinterpret_cast<T*>(value));\n                         break;\n                     }\n                     case TYPE_BOOLEAN: {\n                         bool v = *reinterpret_cast<bool*>(value);\n+                        range->clear();\n                         range->add_fixed_value(*reinterpret_cast<T*>(&v));\n                         break;\n                     }\n                     default: {\n                         LOG(WARNING) << \"Normalize filter fail, Unsupport Primitive type. [type=\"\n-                                     << expr->type() << \"]\";\n+                            << expr->type() << \"]\";\n                         return Status::InternalError(\"Normalize filter fail, Unsupport Primitive type\");\n                     }\n-                    }\n                 }\n+\n+                meet_eq_binary = true;\n+            } // end for each binary predicate child\n+        } // end of handling eq binary predicate\n+\n+        if (range->get_fixed_value_size() > 0) {\n+            // this columns already meet some eq predicates(IN or Binary),\n+            // There is no need to continue to iterate.\n+            // TODO(cmy): In fact, this part of the judgment should be completed in\n+            // the FE query planning stage. For the following predicate conditions,\n+            // it should be possible to eliminate at the FE side.\n+            //      WHERE A = 1 and A in (2,3,4)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a915c56081bf094a11285b78ac25556e1f719093"}, "originalPosition": 361}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4ODI3MTc1", "url": "https://github.com/apache/incubator-doris/pull/3694#pullrequestreview-418827175", "createdAt": "2020-05-27T03:07:51Z", "commit": {"oid": "a915c56081bf094a11285b78ac25556e1f719093"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzowNzo1MlrOGa373w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzowNzo1MlrOGa373w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgzMjYwNw==", "bodyText": "eq binary is also binary. So I think we would better also change the normalize_binary_predicate name.", "url": "https://github.com/apache/incubator-doris/pull/3694#discussion_r430832607", "createdAt": "2020-05-27T03:07:52Z", "author": {"login": "kangkaisen"}, "path": "be/src/exec/olap_scan_node.cpp", "diffHunk": "@@ -715,7 +714,7 @@ Status OlapScanNode::start_scan_thread(RuntimeState* state) {\n template<class T>\n Status OlapScanNode::normalize_predicate(ColumnValueRange<T>& range, SlotDescriptor* slot) {\n     // 1. Normalize InPredicate, add to ColumnValueRange\n-    RETURN_IF_ERROR(normalize_in_predicate(slot, &range));\n+    RETURN_IF_ERROR(normalize_in_and_eq_predicate(slot, &range));\n \n     // 2. Normalize BinaryPredicate , add to ColumnValueRange\n     RETURN_IF_ERROR(normalize_binary_predicate(slot, &range));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a915c56081bf094a11285b78ac25556e1f719093"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4ODMzOTE4", "url": "https://github.com/apache/incubator-doris/pull/3694#pullrequestreview-418833918", "createdAt": "2020-05-27T03:32:45Z", "commit": {"oid": "ddabaaaad252513aa5f449f4779e6c976fd168cc"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4ODQxOTU1", "url": "https://github.com/apache/incubator-doris/pull/3694#pullrequestreview-418841955", "createdAt": "2020-05-27T04:03:20Z", "commit": {"oid": "ddabaaaad252513aa5f449f4779e6c976fd168cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNDowMzoyMFrOGa4rzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNDowMzoyMFrOGa4rzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0NDg3OA==", "bodyText": "754 line can guarantee it's a single coulumn predicate?", "url": "https://github.com/apache/incubator-doris/pull/3694#discussion_r430844878", "createdAt": "2020-05-27T04:03:20Z", "author": {"login": "wutiangan"}, "path": "be/src/exec/olap_scan_node.cpp", "diffHunk": "@@ -736,100 +735,114 @@ static bool ignore_cast(SlotDescriptor* slot, Expr* expr) {\n     return false;\n }\n \n+// Construct the ColumnValueRange for one specified column\n+// It will only handle the InPredicate and eq BinaryPredicate in _conjunct_ctxs.\n+// It will try to push down conditions of that column as much as possible,\n+// But if the number of conditions exceeds the limit, none of conditions will be pushed down.\n template<class T>\n-Status OlapScanNode::normalize_in_predicate(SlotDescriptor* slot, ColumnValueRange<T>* range) {\n+Status OlapScanNode::normalize_in_and_eq_predicate(SlotDescriptor* slot, ColumnValueRange<T>* range) {\n+    bool meet_eq_binary = false;\n     for (int conj_idx = 0; conj_idx < _conjunct_ctxs.size(); ++conj_idx) {\n         // 1. Normalize in conjuncts like 'where col in (v1, v2, v3)'\n         if (TExprOpcode::FILTER_IN == _conjunct_ctxs[conj_idx]->root()->op()) {\n             InPredicate* pred = dynamic_cast<InPredicate*>(_conjunct_ctxs[conj_idx]->root());\n             if (pred->is_not_in()) {\n+                // can not push down NOT IN predicate to storage engine\n                 continue;\n             }\n \n             if (Expr::type_without_cast(pred->get_child(0)) != TExprNodeType::SLOT_REF) {\n+                // not a slot ref(column)\n+                continue;\n+            }\n+\n+            std::vector<SlotId> slot_ids;\n+            if (pred->get_child(0)->get_slot_ids(&slot_ids) != 1) {\n+                // not a single column predicate\n+                continue;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddabaaaad252513aa5f449f4779e6c976fd168cc"}, "originalPosition": 111}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4ODQyNzE1", "url": "https://github.com/apache/incubator-doris/pull/3694#pullrequestreview-418842715", "createdAt": "2020-05-27T04:06:17Z", "commit": {"oid": "ddabaaaad252513aa5f449f4779e6c976fd168cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNDowNjoxN1rOGa4uPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNDowNjoxN1rOGa4uPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0NTUwMg==", "bodyText": "Whether \u201drange->clear()\u201c can be preceded by the switch statement", "url": "https://github.com/apache/incubator-doris/pull/3694#discussion_r430845502", "createdAt": "2020-05-27T04:06:17Z", "author": {"login": "wutiangan"}, "path": "be/src/exec/olap_scan_node.cpp", "diffHunk": "@@ -838,39 +851,52 @@ Status OlapScanNode::normalize_in_predicate(SlotDescriptor* slot, ColumnValueRan\n                         != TExprNodeType::SLOT_REF) {\n                     continue;\n                 }\n+\n+                std::vector<SlotId> slot_ids;\n+                if (pred->get_child(child_idx)->get_slot_ids(&slot_ids) != 1) {\n+                    // not a single column predicate\n+                    continue;\n+                }\n+\n+                if (slot_ids[0] != slot->id()) {\n+                    // predicate not related to current column\n+                    continue;\n+                }\n+\n                 if (pred->get_child(child_idx)->type().type != slot->type().type) {\n                     if (!ignore_cast(slot, pred->get_child(child_idx))) {\n+                        // the type of predicate not match the slot's type\n                         continue;\n                     }\n                 }\n \n-                std::vector<SlotId> slot_ids;\n-                if (1 == pred->get_child(child_idx)->get_slot_ids(&slot_ids)) {\n-                    if (slot_ids[0] != slot->id()) {\n-                        continue;\n-                    }\n-\n-                    Expr* expr = pred->get_child(1 - child_idx);\n-                    if (!expr->is_constant()) {\n-                        continue;\n-                    }\n+                Expr* expr = pred->get_child(1 - child_idx);\n+                if (!expr->is_constant()) {\n+                    // only handle constant value\n+                    continue;\n+                }\n \n-                    void* value = _conjunct_ctxs[conj_idx]->get_value(expr, NULL);\n-                    // for case: where col = null\n-                    if (value == NULL) {\n-                        continue;\n-                    }\n+                void* value = _conjunct_ctxs[conj_idx]->get_value(expr, NULL);\n+                // for case: where col = null\n+                if (value == NULL) {\n+                    continue;\n+                }\n \n-                    switch (slot->type().type) {\n+                // begin to push condition value into ColumnValueRange\n+                // clear the ColumnValueRange before adding new fixed values.\n+                // because for AND compound predicates, it can overwrite previous conditions\n+                switch (slot->type().type) {\n                     case TYPE_TINYINT: {\n                         int32_t v = *reinterpret_cast<int8_t*>(value);\n+                        range->clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddabaaaad252513aa5f449f4779e6c976fd168cc"}, "originalPosition": 316}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNTE3MjAx", "url": "https://github.com/apache/incubator-doris/pull/3694#pullrequestreview-423517201", "createdAt": "2020-06-03T12:49:04Z", "commit": {"oid": "f326a404bf42031ae7e335bf6caa0b8836a18877"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f37b29e8e694a1b27891873d43c1756fa408b967", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/f37b29e8e694a1b27891873d43c1756fa408b967", "committedDate": "2020-06-04T01:57:05Z", "message": "first"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7363433a4a813186742a3fc739f62f0c56aa8ca", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/e7363433a4a813186742a3fc739f62f0c56aa8ca", "committedDate": "2020-06-04T01:57:05Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "981e37eb39a9a24752c81b6f7e346d83b91ebf98", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/981e37eb39a9a24752c81b6f7e346d83b91ebf98", "committedDate": "2020-06-04T01:57:05Z", "message": "change config name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc0667055da769162c544f0f1a9c9cf6a4c2dc63", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/bc0667055da769162c544f0f1a9c9cf6a4c2dc63", "committedDate": "2020-06-04T01:57:06Z", "message": "add session variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f49b46964865efee92af2b86ea13dcba31fd1563", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/f49b46964865efee92af2b86ea13dcba31fd1563", "committedDate": "2020-06-04T02:06:01Z", "message": "add doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89e2fa7bf8713066048a3d9705362914c7065623", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/89e2fa7bf8713066048a3d9705362914c7065623", "committedDate": "2020-06-04T02:06:01Z", "message": "fix comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6872a9b12c6d5e1e36a7b439763d0701ca2262b", "author": {"user": {"login": "morningman-cmy", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/d6872a9b12c6d5e1e36a7b439763d0701ca2262b", "committedDate": "2020-06-04T02:06:01Z", "message": "fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6e3e9d8176b02bda3843164b6f4c87073250ed3", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/e6e3e9d8176b02bda3843164b6f4c87073250ed3", "committedDate": "2020-06-04T02:06:01Z", "message": "change name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6466650bc8b3c6142fe957d20891ab217004ad86", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/6466650bc8b3c6142fe957d20891ab217004ad86", "committedDate": "2020-06-04T02:06:01Z", "message": "fix bug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f326a404bf42031ae7e335bf6caa0b8836a18877", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/f326a404bf42031ae7e335bf6caa0b8836a18877", "committedDate": "2020-05-27T09:07:37Z", "message": "fix bug"}, "afterCommit": {"oid": "6466650bc8b3c6142fe957d20891ab217004ad86", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/6466650bc8b3c6142fe957d20891ab217004ad86", "committedDate": "2020-06-04T02:06:01Z", "message": "fix bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MDc4MDQ5", "url": "https://github.com/apache/incubator-doris/pull/3694#pullrequestreview-424078049", "createdAt": "2020-06-04T03:32:03Z", "commit": {"oid": "6466650bc8b3c6142fe957d20891ab217004ad86"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2774, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}