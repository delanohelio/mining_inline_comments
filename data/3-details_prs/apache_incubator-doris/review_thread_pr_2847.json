{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNzQ4MzM3", "number": 2847, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMTozNzo1MlrODd4zaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozNDozMlrODgW9lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNjY1OTYzOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/catalog/OlapTable.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMTozNzo1MlrOFmv5pA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMjozMDozMFrOFmwopg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3NTAxMg==", "bodyText": "Could we put this isInMemory in tableProperty to avoid modifying meta version?", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r376175012", "createdAt": "2020-02-07T01:37:52Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/OlapTable.java", "diffHunk": "@@ -1011,17 +1010,17 @@ public void readFields(DataInput in) throws IOException {\n                 tableProperty = TableProperty.read(in);\n             }\n         }\n+        // inMemory\n+        if (Catalog.getCurrentCatalogJournalVersion() >= FeMetaVersion.VERSION_72) {\n+            isInMemory = in.readBoolean();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "773e0e34a57ed1c4edccc45735dc5fe80ba4d97f"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE4NzA0Ng==", "bodyText": "OK.\nI didn't notice the TableProperty,  Thanks for your reminder.", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r376187046", "createdAt": "2020-02-07T02:30:30Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/catalog/OlapTable.java", "diffHunk": "@@ -1011,17 +1010,17 @@ public void readFields(DataInput in) throws IOException {\n                 tableProperty = TableProperty.read(in);\n             }\n         }\n+        // inMemory\n+        if (Catalog.getCurrentCatalogJournalVersion() >= FeMetaVersion.VERSION_72) {\n+            isInMemory = in.readBoolean();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3NTAxMg=="}, "originalCommit": {"oid": "773e0e34a57ed1c4edccc45735dc5fe80ba4d97f"}, "originalPosition": 117}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjg5MDg3OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNDo1MDozOVrOFno4Uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwNDoxMDoyNFrOFn9FVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzEwODU2Mw==", "bodyText": "String errMsg; can be put in the following if clause", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r377108563", "createdAt": "2020-02-10T14:50:39Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeHandler.java", "diffHunk": "@@ -1405,6 +1420,88 @@ private void sendClearAlterTask(Database db, OlapTable olapTable) {\n         LOG.info(\"send clear alter task for table {}, number: {}\", olapTable.getName(), batchTask.getTaskNum());\n     }\n \n+    public void sendUpdateTabletMetaInfoTask(Database db, OlapTable olapTable, boolean isInMemory) throws DdlException {\n+        List<Partition> partitions = Lists.newArrayList();\n+        db.readLock();\n+        try {\n+            partitions.addAll(olapTable.getPartitions());\n+        } finally {\n+            db.readUnlock();\n+        }\n+        for(Partition partition: partitions) {\n+            sendUpdateTabletMetaTaskForPartition(db, olapTable, partition, isInMemory);\n+        }\n+    }\n+\n+    public void sendUpdateTabletMetaTaskForPartition(Database db,\n+                                                     OlapTable olapTable,\n+                                                     Partition partition,\n+                                                     boolean isInMemory) throws DdlException {\n+        // be id -> <tablet id,schemaHash>\n+        Map<Long, Set<Pair<Long, Integer>>> beIdToTabletIdWithHash = Maps.newHashMap();\n+        db.readLock();\n+        try {\n+            for (MaterializedIndex index : partition.getMaterializedIndices(IndexExtState.VISIBLE)) {\n+                int schemaHash = olapTable.getSchemaHashByIndexId(index.getId());\n+                for (Tablet tablet : index.getTablets()) {\n+                    for (Replica replica : tablet.getReplicas()) {\n+                        Set<Pair<Long, Integer>> tabletIdWithHash = beIdToTabletIdWithHash.computeIfAbsent(replica.getBackendId(), k -> Sets.newHashSet());\n+                        tabletIdWithHash.add(new Pair<>(tablet.getId(), schemaHash));\n+                    }\n+                }\n+            }\n+        } finally {\n+            db.readUnlock();\n+        }\n+\n+        int totalTaskNum = beIdToTabletIdWithHash.keySet().size();\n+        MarkedCountDownLatch<Long, Set<Pair<Long, Integer>>> countDownLatch = new MarkedCountDownLatch<>(totalTaskNum);\n+        AgentBatchTask batchTask = new AgentBatchTask();\n+        for(Map.Entry<Long, Set<Pair<Long, Integer>>> kv: beIdToTabletIdWithHash.entrySet()) {\n+            countDownLatch.addMark(kv.getKey(), kv.getValue());\n+            UpdateTabletMetaInfoTask task = new UpdateTabletMetaInfoTask(kv.getKey(), kv.getValue(),\n+                                                isInMemory,countDownLatch);\n+            batchTask.addTask(task);\n+        }\n+        if (!FeConstants.runningUnitTest) {\n+            // send all tasks and wait them finished\n+            AgentTaskQueue.addBatchTask(batchTask);\n+            AgentTaskExecutor.submit(batchTask);\n+            LOG.info(\"send update tablet meta task for table {}, partitions {}, number: {}\",\n+                    olapTable.getName(), partition.getName(), batchTask.getTaskNum());\n+\n+            // estimate timeout\n+            long timeout = Config.tablet_create_timeout_second * 1000L * totalTaskNum;\n+            timeout = Math.min(timeout, Config.max_create_table_timeout_second * 1000);\n+            boolean ok = false;\n+            try {\n+                ok = countDownLatch.await(timeout, TimeUnit.MILLISECONDS);\n+            } catch (InterruptedException e) {\n+                LOG.warn(\"InterruptedException: \", e);\n+            }\n+\n+            String errMsg;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "564e1cb6a7c600b197b1dbc57bfbdb168b1413a3"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzOTU3NQ==", "bodyText": "OK", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r377439575", "createdAt": "2020-02-11T04:10:24Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeHandler.java", "diffHunk": "@@ -1405,6 +1420,88 @@ private void sendClearAlterTask(Database db, OlapTable olapTable) {\n         LOG.info(\"send clear alter task for table {}, number: {}\", olapTable.getName(), batchTask.getTaskNum());\n     }\n \n+    public void sendUpdateTabletMetaInfoTask(Database db, OlapTable olapTable, boolean isInMemory) throws DdlException {\n+        List<Partition> partitions = Lists.newArrayList();\n+        db.readLock();\n+        try {\n+            partitions.addAll(olapTable.getPartitions());\n+        } finally {\n+            db.readUnlock();\n+        }\n+        for(Partition partition: partitions) {\n+            sendUpdateTabletMetaTaskForPartition(db, olapTable, partition, isInMemory);\n+        }\n+    }\n+\n+    public void sendUpdateTabletMetaTaskForPartition(Database db,\n+                                                     OlapTable olapTable,\n+                                                     Partition partition,\n+                                                     boolean isInMemory) throws DdlException {\n+        // be id -> <tablet id,schemaHash>\n+        Map<Long, Set<Pair<Long, Integer>>> beIdToTabletIdWithHash = Maps.newHashMap();\n+        db.readLock();\n+        try {\n+            for (MaterializedIndex index : partition.getMaterializedIndices(IndexExtState.VISIBLE)) {\n+                int schemaHash = olapTable.getSchemaHashByIndexId(index.getId());\n+                for (Tablet tablet : index.getTablets()) {\n+                    for (Replica replica : tablet.getReplicas()) {\n+                        Set<Pair<Long, Integer>> tabletIdWithHash = beIdToTabletIdWithHash.computeIfAbsent(replica.getBackendId(), k -> Sets.newHashSet());\n+                        tabletIdWithHash.add(new Pair<>(tablet.getId(), schemaHash));\n+                    }\n+                }\n+            }\n+        } finally {\n+            db.readUnlock();\n+        }\n+\n+        int totalTaskNum = beIdToTabletIdWithHash.keySet().size();\n+        MarkedCountDownLatch<Long, Set<Pair<Long, Integer>>> countDownLatch = new MarkedCountDownLatch<>(totalTaskNum);\n+        AgentBatchTask batchTask = new AgentBatchTask();\n+        for(Map.Entry<Long, Set<Pair<Long, Integer>>> kv: beIdToTabletIdWithHash.entrySet()) {\n+            countDownLatch.addMark(kv.getKey(), kv.getValue());\n+            UpdateTabletMetaInfoTask task = new UpdateTabletMetaInfoTask(kv.getKey(), kv.getValue(),\n+                                                isInMemory,countDownLatch);\n+            batchTask.addTask(task);\n+        }\n+        if (!FeConstants.runningUnitTest) {\n+            // send all tasks and wait them finished\n+            AgentTaskQueue.addBatchTask(batchTask);\n+            AgentTaskExecutor.submit(batchTask);\n+            LOG.info(\"send update tablet meta task for table {}, partitions {}, number: {}\",\n+                    olapTable.getName(), partition.getName(), batchTask.getTaskNum());\n+\n+            // estimate timeout\n+            long timeout = Config.tablet_create_timeout_second * 1000L * totalTaskNum;\n+            timeout = Math.min(timeout, Config.max_create_table_timeout_second * 1000);\n+            boolean ok = false;\n+            try {\n+                ok = countDownLatch.await(timeout, TimeUnit.MILLISECONDS);\n+            } catch (InterruptedException e) {\n+                LOG.warn(\"InterruptedException: \", e);\n+            }\n+\n+            String errMsg;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzEwODU2Mw=="}, "originalCommit": {"oid": "564e1cb6a7c600b197b1dbc57bfbdb168b1413a3"}, "originalPosition": 145}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjkwODIzOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeHandler.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNDo1NDo1NVrOFnpC5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwOToxNzo1OVrOFoBpbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzExMTI2OQ==", "bodyText": "sendUpdateTabletMetaTaskForPartition()\nwhat if this method is partial success? And some of the tablet's meta on BE changed to in memory and some are not?", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r377111269", "createdAt": "2020-02-10T14:54:55Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeHandler.java", "diffHunk": "@@ -1405,6 +1420,88 @@ private void sendClearAlterTask(Database db, OlapTable olapTable) {\n         LOG.info(\"send clear alter task for table {}, number: {}\", olapTable.getName(), batchTask.getTaskNum());\n     }\n \n+    public void sendUpdateTabletMetaInfoTask(Database db, OlapTable olapTable, boolean isInMemory) throws DdlException {\n+        List<Partition> partitions = Lists.newArrayList();\n+        db.readLock();\n+        try {\n+            partitions.addAll(olapTable.getPartitions());\n+        } finally {\n+            db.readUnlock();\n+        }\n+        for(Partition partition: partitions) {\n+            sendUpdateTabletMetaTaskForPartition(db, olapTable, partition, isInMemory);\n+        }\n+    }\n+\n+    public void sendUpdateTabletMetaTaskForPartition(Database db,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "564e1cb6a7c600b197b1dbc57bfbdb168b1413a3"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ0MDM0Mg==", "bodyText": "If partial success, we will return error to user, and the error msg warn user to retry.\nBecause this operation is idempotent\uff0cSo retry is OK.\nIf we want to avoid partial success, we need to support tablet meta rollback operation. I think which is complex and unnecessary.", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r377440342", "createdAt": "2020-02-11T04:16:10Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeHandler.java", "diffHunk": "@@ -1405,6 +1420,88 @@ private void sendClearAlterTask(Database db, OlapTable olapTable) {\n         LOG.info(\"send clear alter task for table {}, number: {}\", olapTable.getName(), batchTask.getTaskNum());\n     }\n \n+    public void sendUpdateTabletMetaInfoTask(Database db, OlapTable olapTable, boolean isInMemory) throws DdlException {\n+        List<Partition> partitions = Lists.newArrayList();\n+        db.readLock();\n+        try {\n+            partitions.addAll(olapTable.getPartitions());\n+        } finally {\n+            db.readUnlock();\n+        }\n+        for(Partition partition: partitions) {\n+            sendUpdateTabletMetaTaskForPartition(db, olapTable, partition, isInMemory);\n+        }\n+    }\n+\n+    public void sendUpdateTabletMetaTaskForPartition(Database db,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzExMTI2OQ=="}, "originalCommit": {"oid": "564e1cb6a7c600b197b1dbc57bfbdb168b1413a3"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ2NjU3Nw==", "bodyText": "I am more worried that if the user does not retry, there will be an inconsistent state, that is, some tablet properties on BE are in memory, and FE is not in memory. There is no mechanism to find it in this case.\nWe need a correction mechanism to handle this. For example, when reporting to FE, compare with this attribute of FE.", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r377466577", "createdAt": "2020-02-11T06:53:16Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeHandler.java", "diffHunk": "@@ -1405,6 +1420,88 @@ private void sendClearAlterTask(Database db, OlapTable olapTable) {\n         LOG.info(\"send clear alter task for table {}, number: {}\", olapTable.getName(), batchTask.getTaskNum());\n     }\n \n+    public void sendUpdateTabletMetaInfoTask(Database db, OlapTable olapTable, boolean isInMemory) throws DdlException {\n+        List<Partition> partitions = Lists.newArrayList();\n+        db.readLock();\n+        try {\n+            partitions.addAll(olapTable.getPartitions());\n+        } finally {\n+            db.readUnlock();\n+        }\n+        for(Partition partition: partitions) {\n+            sendUpdateTabletMetaTaskForPartition(db, olapTable, partition, isInMemory);\n+        }\n+    }\n+\n+    public void sendUpdateTabletMetaTaskForPartition(Database db,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzExMTI2OQ=="}, "originalCommit": {"oid": "564e1cb6a7c600b197b1dbc57bfbdb168b1413a3"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUxNDM0OQ==", "bodyText": "OK.", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r377514349", "createdAt": "2020-02-11T09:17:59Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeHandler.java", "diffHunk": "@@ -1405,6 +1420,88 @@ private void sendClearAlterTask(Database db, OlapTable olapTable) {\n         LOG.info(\"send clear alter task for table {}, number: {}\", olapTable.getName(), batchTask.getTaskNum());\n     }\n \n+    public void sendUpdateTabletMetaInfoTask(Database db, OlapTable olapTable, boolean isInMemory) throws DdlException {\n+        List<Partition> partitions = Lists.newArrayList();\n+        db.readLock();\n+        try {\n+            partitions.addAll(olapTable.getPartitions());\n+        } finally {\n+            db.readUnlock();\n+        }\n+        for(Partition partition: partitions) {\n+            sendUpdateTabletMetaTaskForPartition(db, olapTable, partition, isInMemory);\n+        }\n+    }\n+\n+    public void sendUpdateTabletMetaTaskForPartition(Database db,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzExMTI2OQ=="}, "originalCommit": {"oid": "564e1cb6a7c600b197b1dbc57bfbdb168b1413a3"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODQxMzczOnYy", "diffSide": "RIGHT", "path": "be/src/olap/page_cache.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMDoxOTo0OFrOFod4Uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjo1ODo1NlrOFogWAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3NjkxNQ==", "bodyText": "I think is_durable is a better name?", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r377976915", "createdAt": "2020-02-12T00:19:48Z", "author": {"login": "kangpinghuang"}, "path": "be/src/olap/page_cache.cpp", "diffHunk": "@@ -42,11 +42,18 @@ bool StoragePageCache::lookup(const CacheKey& key, PageCacheHandle* handle) {\n     return true;\n }\n \n-void StoragePageCache::insert(const CacheKey& key, const Slice& data, PageCacheHandle* handle) {\n+void StoragePageCache::insert(const CacheKey& key, const Slice& data, PageCacheHandle* handle,\n+                              bool in_memory) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63fed51361332b4d3ec4576874ae3fcf13eba28b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxNzI4Mg==", "bodyText": "No.\ndurable is for LRUCache,\nin_memory is for storage level.", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r378017282", "createdAt": "2020-02-12T02:58:56Z", "author": {"login": "kangkaisen"}, "path": "be/src/olap/page_cache.cpp", "diffHunk": "@@ -42,11 +42,18 @@ bool StoragePageCache::lookup(const CacheKey& key, PageCacheHandle* handle) {\n     return true;\n }\n \n-void StoragePageCache::insert(const CacheKey& key, const Slice& data, PageCacheHandle* handle) {\n+void StoragePageCache::insert(const CacheKey& key, const Slice& data, PageCacheHandle* handle,\n+                              bool in_memory) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3NjkxNQ=="}, "originalCommit": {"oid": "63fed51361332b4d3ec4576874ae3fcf13eba28b"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODQxNDc3OnYy", "diffSide": "RIGHT", "path": "be/src/olap/page_cache.h", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMDoyMDoyOFrOFod5AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjo1OToyOVrOFogWdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3NzA4OQ==", "bodyText": "add some comment for this variable", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r377977089", "createdAt": "2020-02-12T00:20:28Z", "author": {"login": "kangpinghuang"}, "path": "be/src/olap/page_cache.h", "diffHunk": "@@ -74,7 +74,7 @@ class StoragePageCache {\n     // Given hanlde will be set to valid reference.\n     // This function is thread-safe, and when two clients insert two same key\n     // concurrently, this function can assure that only one page is cached.\n-    void insert(const CacheKey& key, const Slice& data, PageCacheHandle* handle);\n+    void insert(const CacheKey& key, const Slice& data, PageCacheHandle* handle, bool in_memory = false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63fed51361332b4d3ec4576874ae3fcf13eba28b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxNzM5OQ==", "bodyText": "OK", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r378017399", "createdAt": "2020-02-12T02:59:29Z", "author": {"login": "kangkaisen"}, "path": "be/src/olap/page_cache.h", "diffHunk": "@@ -74,7 +74,7 @@ class StoragePageCache {\n     // Given hanlde will be set to valid reference.\n     // This function is thread-safe, and when two clients insert two same key\n     // concurrently, this function can assure that only one page is cached.\n-    void insert(const CacheKey& key, const Slice& data, PageCacheHandle* handle);\n+    void insert(const CacheKey& key, const Slice& data, PageCacheHandle* handle, bool in_memory = false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3NzA4OQ=="}, "originalCommit": {"oid": "63fed51361332b4d3ec4576874ae3fcf13eba28b"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODQ1OTQwOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/master/ReportHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMDo0MzoxOVrOFoeTZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjo1OTo0MVrOFogWpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4Mzg0Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static void handleSetTabletMetaInfo(long backendId, Set<Pair<Long, Integer>>tabletWithoutPartitionId) {\n          \n          \n            \n                private static void handleSetTabletMetaInfo(long backendId, Set<Pair<Long, Integer>> tabletWithoutPartitionId) {", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r377983847", "createdAt": "2020-02-12T00:43:19Z", "author": {"login": "kangpinghuang"}, "path": "fe/src/main/java/org/apache/doris/master/ReportHandler.java", "diffHunk": "@@ -884,13 +885,14 @@ private static void handleForceCreateReplica(List<CreateReplicaTask> createRepli\n     }\n     \n \n-    private static void handleSetTabletMetaInfo(long backendId, SetMultimap<Long, Integer> tabletWithoutPartitionId) {\n+    private static void handleSetTabletMetaInfo(long backendId, Set<Pair<Long, Integer>>tabletWithoutPartitionId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63fed51361332b4d3ec4576874ae3fcf13eba28b"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxNzQ0Ng==", "bodyText": "OK", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r378017446", "createdAt": "2020-02-12T02:59:41Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/master/ReportHandler.java", "diffHunk": "@@ -884,13 +885,14 @@ private static void handleForceCreateReplica(List<CreateReplicaTask> createRepli\n     }\n     \n \n-    private static void handleSetTabletMetaInfo(long backendId, SetMultimap<Long, Integer> tabletWithoutPartitionId) {\n+    private static void handleSetTabletMetaInfo(long backendId, Set<Pair<Long, Integer>>tabletWithoutPartitionId) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4Mzg0Nw=="}, "originalCommit": {"oid": "63fed51361332b4d3ec4576874ae3fcf13eba28b"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODQ2OTI0OnYy", "diffSide": "RIGHT", "path": "gensrc/thrift/AgentService.thrift", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMDo0ODoxNFrOFoeZOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzowMjo0MFrOFogZPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4NTMzOQ==", "bodyText": "I think this name is ambiguous, Is INMEMORY can not has partitionid?", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r377985339", "createdAt": "2020-02-12T00:48:14Z", "author": {"login": "kangpinghuang"}, "path": "gensrc/thrift/AgentService.thrift", "diffHunk": "@@ -233,10 +234,17 @@ struct TRecoverTabletReq {\n     4: optional Types.TVersionHash version_hash // Deprecated\n }\n \n+enum TTabletMetaType {\n+    PARTITIONID,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63fed51361332b4d3ec4576874ae3fcf13eba28b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxODEwOQ==", "bodyText": "I think that is no ambiguous. One meta has one type, which is clear. All meta could be combine.", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r378018109", "createdAt": "2020-02-12T03:02:40Z", "author": {"login": "kangkaisen"}, "path": "gensrc/thrift/AgentService.thrift", "diffHunk": "@@ -233,10 +234,17 @@ struct TRecoverTabletReq {\n     4: optional Types.TVersionHash version_hash // Deprecated\n }\n \n+enum TTabletMetaType {\n+    PARTITIONID,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4NTMzOQ=="}, "originalCommit": {"oid": "63fed51361332b4d3ec4576874ae3fcf13eba28b"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MjUyMjM3OnYy", "diffSide": "RIGHT", "path": "be/src/agent/task_worker_pool.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMToxNjoxMVrOFqg41w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMToxNjoxMVrOFqg41w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyMzM1MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            switch(tablet_meta_info.meta_type) {\n          \n          \n            \n                            switch (tablet_meta_info.meta_type) {", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r380123351", "createdAt": "2020-02-17T11:16:11Z", "author": {"login": "imay"}, "path": "be/src/agent/task_worker_pool.cpp", "diffHunk": "@@ -846,7 +846,19 @@ void* TaskWorkerPool::_update_tablet_meta_worker_thread_callback(void* arg_this)\n                 continue;\n             }\n             WriteLock wrlock(tablet->get_header_lock_ptr());\n-            tablet->set_partition_id(tablet_meta_info.partition_id);\n+            // update tablet meta\n+            if (!tablet_meta_info.__isset.meta_type) {\n+                 tablet->set_partition_id(tablet_meta_info.partition_id);\n+            } else {\n+                switch(tablet_meta_info.meta_type) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c1d00950ac102e00c0e89e6042538f793b28929"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MjU2MDUyOnYy", "diffSide": "RIGHT", "path": "be/src/olap/tablet_meta.h", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozMDowOVrOFqhP-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMzowNzo1M1rOFqj0xA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyOTI3NA==", "bodyText": "Prefer mutable_tablet_schema() to return a pointer.\nNormally, const modification is required when returning a reference", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r380129274", "createdAt": "2020-02-17T11:30:09Z", "author": {"login": "imay"}, "path": "be/src/olap/tablet_meta.h", "diffHunk": "@@ -155,7 +155,7 @@ class TabletMeta {\n     inline const bool in_restore_mode() const;\n     inline OLAPStatus set_in_restore_mode(bool in_restore_mode);\n \n-    inline const TabletSchema& tablet_schema() const;\n+    inline TabletSchema& tablet_schema();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c1d00950ac102e00c0e89e6042538f793b28929"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE3MTQ2MA==", "bodyText": "OK", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r380171460", "createdAt": "2020-02-17T13:07:53Z", "author": {"login": "kangkaisen"}, "path": "be/src/olap/tablet_meta.h", "diffHunk": "@@ -155,7 +155,7 @@ class TabletMeta {\n     inline const bool in_restore_mode() const;\n     inline OLAPStatus set_in_restore_mode(bool in_restore_mode);\n \n-    inline const TabletSchema& tablet_schema() const;\n+    inline TabletSchema& tablet_schema();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyOTI3NA=="}, "originalCommit": {"oid": "1c1d00950ac102e00c0e89e6042538f793b28929"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MjU3MjM4OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/task/UpdateTabletMetaInfoTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozNDozMlrOFqhXDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozNDozMlrOFqhXDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMTA4Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                for(Triple<Long, Integer, Boolean> triple: tabletToInMemory) {\n          \n          \n            \n                                for (Triple<Long, Integer, Boolean> triple: tabletToInMemory) {", "url": "https://github.com/apache/incubator-doris/pull/2847#discussion_r380131087", "createdAt": "2020-02-17T11:34:32Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/task/UpdateTabletMetaInfoTask.java", "diffHunk": "@@ -18,50 +18,134 @@\n package org.apache.doris.task;\n \n import java.util.List;\n-import java.util.Map;\n+import java.util.Set;\n \n+import org.apache.commons.lang3.tuple.Triple;\n import org.apache.doris.catalog.Catalog;\n import org.apache.doris.catalog.TabletMeta;\n+import org.apache.doris.common.MarkedCountDownLatch;\n+import org.apache.doris.common.Pair;\n+import org.apache.doris.common.Status;\n+import org.apache.doris.thrift.TStatusCode;\n import org.apache.doris.thrift.TTabletMetaInfo;\n+import org.apache.doris.thrift.TTabletMetaType;\n import org.apache.doris.thrift.TTaskType;\n import org.apache.doris.thrift.TUpdateTabletMetaInfoReq;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n \n import com.google.common.collect.Lists;\n-import com.google.common.collect.SetMultimap;\n \n public class UpdateTabletMetaInfoTask extends AgentTask {\n \n-    private static final Logger LOG = LogManager.getLogger(ClearTransactionTask.class);\n+    private static final Logger LOG = LogManager.getLogger(UpdateTabletMetaInfoTask.class);\n \n-    private SetMultimap<Long, Integer> tabletWithoutPartitionId;\n+    // used for synchronous process\n+    private MarkedCountDownLatch<Long, Set<Pair<Long, Integer>>> latch;\n \n-    public UpdateTabletMetaInfoTask(long backendId, SetMultimap<Long, Integer> tabletWithoutPartitionId) {\n-        super(null, backendId, TTaskType.UPDATE_TABLET_META_INFO, -1L, -1L, -1L, -1L, -1L, backendId);\n-        this.tabletWithoutPartitionId = tabletWithoutPartitionId;\n+    private Set<Pair<Long, Integer>> tableIdWithSchemaHash;\n+    private boolean isInMemory;\n+    private TTabletMetaType metaType;\n+\n+    // <tablet id, tablet schema hash, tablet in memory>\n+    private List<Triple<Long, Integer, Boolean>> tabletToInMemory;\n+\n+    public UpdateTabletMetaInfoTask(long backendId, Set<Pair<Long, Integer>> tableIdWithSchemaHash,\n+                                    TTabletMetaType metaType) {\n+        super(null, backendId, TTaskType.UPDATE_TABLET_META_INFO,\n+                -1L, -1L, -1L, -1L, -1L, tableIdWithSchemaHash.hashCode());\n+        this.tableIdWithSchemaHash = tableIdWithSchemaHash;\n+        this.metaType = metaType;\n+    }\n+\n+    public UpdateTabletMetaInfoTask(long backendId,\n+                                    Set<Pair<Long, Integer>> tableIdWithSchemaHash,\n+                                    boolean isInMemory,\n+                                    MarkedCountDownLatch<Long, Set<Pair<Long, Integer>>> latch) {\n+        this(backendId, tableIdWithSchemaHash, TTabletMetaType.INMEMORY);\n+        this.isInMemory = isInMemory;\n+        this.latch = latch;\n+    }\n+\n+    public UpdateTabletMetaInfoTask(long backendId,\n+                                    List<Triple<Long, Integer, Boolean>> tabletToInMemory) {\n+        super(null, backendId, TTaskType.UPDATE_TABLET_META_INFO,\n+                -1L, -1L, -1L, -1L, -1L, tabletToInMemory.hashCode());\n+        this.metaType = TTabletMetaType.INMEMORY;\n+        this.tabletToInMemory = tabletToInMemory;\n+    }\n+\n+    public void countDownLatch(long backendId, Set<Pair<Long, Integer>> tablets) {\n+        if (this.latch != null) {\n+            if (latch.markedCountDown(backendId, tablets)) {\n+                LOG.debug(\"UpdateTabletMetaInfoTask current latch count: {}, backend: {}, tablets:{}\",\n+                        latch.getCount(), backendId, tablets);\n+            }\n+        }\n+    }\n+\n+    // call this always means one of tasks is failed. count down to zero to finish entire task\n+    public void countDownToZero(String errMsg) {\n+        if (this.latch != null) {\n+            latch.countDownToZero(new Status(TStatusCode.CANCELLED, errMsg));\n+            LOG.debug(\"UpdateTabletMetaInfoTask count down to zero. error msg: {}\", errMsg);\n+        }\n+    }\n+\n+    public Set<Pair<Long, Integer>> getTablets() {\n+        return tableIdWithSchemaHash;\n     }\n     \n     public TUpdateTabletMetaInfoReq toThrift() {\n         TUpdateTabletMetaInfoReq updateTabletMetaInfoReq = new TUpdateTabletMetaInfoReq();\n         List<TTabletMetaInfo> metaInfos = Lists.newArrayList();\n-        int tabletEntryNum = 0;\n-        for (Map.Entry<Long, Integer> entry : tabletWithoutPartitionId.entries()) {\n-            // add at most 10000 tablet meta during one sync to avoid too large task\n-            if (tabletEntryNum > 10000) {\n+        switch (metaType) {\n+            case PARTITIONID: {\n+                int tabletEntryNum = 0;\n+                for (Pair<Long, Integer> pair : tableIdWithSchemaHash) {\n+                    // add at most 10000 tablet meta during one sync to avoid too large task\n+                    if (tabletEntryNum > 10000) {\n+                        break;\n+                    }\n+                    TTabletMetaInfo metaInfo = new TTabletMetaInfo();\n+                    metaInfo.setTablet_id(pair.first);\n+                    metaInfo.setSchema_hash(pair.second);\n+                    TabletMeta tabletMeta = Catalog.getInstance().getTabletInvertedIndex().getTabletMeta(pair.first);\n+                    if (tabletMeta == null) {\n+                        LOG.warn(\"could not find tablet [{}] in meta ignore it\", pair.second);\n+                        continue;\n+                    }\n+                    metaInfo.setPartition_id(tabletMeta.getPartitionId());\n+                    metaInfo.setMeta_type(metaType);\n+                    metaInfos.add(metaInfo);\n+                    ++tabletEntryNum;\n+                }\n                 break;\n             }\n-            TTabletMetaInfo metaInfo = new TTabletMetaInfo();\n-            metaInfo.setTablet_id(entry.getKey());\n-            metaInfo.setSchema_hash(entry.getValue());\n-            TabletMeta tabletMeta = Catalog.getInstance().getTabletInvertedIndex().getTabletMeta(entry.getKey());\n-            if (tabletMeta == null) {\n-                LOG.warn(\"could not find tablet [{}] in meta ignore it\", entry.getKey());\n-                continue;\n+            case INMEMORY: {\n+                if (latch != null) {\n+                    // for schema change\n+                    for (Pair<Long, Integer> pair: tableIdWithSchemaHash) {\n+                        TTabletMetaInfo metaInfo = new TTabletMetaInfo();\n+                        metaInfo.setTablet_id(pair.first);\n+                        metaInfo.setSchema_hash(pair.second);\n+                        metaInfo.setIs_in_memory(isInMemory);\n+                        metaInfo.setMeta_type(metaType);\n+                        metaInfos.add(metaInfo);\n+                    }\n+                } else {\n+                   // for ReportHandler\n+                    for(Triple<Long, Integer, Boolean> triple: tabletToInMemory) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c1d00950ac102e00c0e89e6042538f793b28929"}, "originalPosition": 139}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2200, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}