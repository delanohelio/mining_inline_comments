{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNzE2Njgy", "number": 2737, "title": "Support replication_num setting for table level", "bodyText": "Support replication_num setting for table level, so There is no need for user to set replication_num for every alter table add partition statement.", "createdAt": "2020-01-11T10:16:57Z", "url": "https://github.com/apache/incubator-doris/pull/2737", "merged": true, "mergeCommit": {"oid": "ae018043b06c529d76e2177485bf14308dac38c5"}, "closed": true, "closedAt": "2020-01-18T13:17:23Z", "author": {"login": "caiconghui"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5SqmXAFqTM0MTUyMTQ0Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7jLVTgFqTM0NDk0MzA5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNTIxNDQ3", "url": "https://github.com/apache/incubator-doris/pull/2737#pullrequestreview-341521447", "createdAt": "2020-01-11T12:53:22Z", "commit": {"oid": "d89c77bb68e0772a080e3d0620b503346a5003c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQxMjo1MzoyM1rOFcljrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQxMjo1MzoyM1rOFcljrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUxOTc5MQ==", "bodyText": "I don't think it is a good way to analyze this class with a input replicationNum. It is up to the caller to decide how to use this object.\nIf we do this through input arguments, there will be too many arguments.", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r365519791", "createdAt": "2020-01-11T12:53:23Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/analysis/SingleRangePartitionDesc.java", "diffHunk": "@@ -87,15 +87,13 @@ public short getReplicationNum() {\n         return this.properties;\n     }\n \n-    public void analyze(int partColNum, Map<String, String> otherProperties) throws AnalysisException {\n+    public void analyze(int partColNum, Map<String, String> otherProperties, Short replicationNum) throws AnalysisException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d89c77bb68e0772a080e3d0620b503346a5003c7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNTU3NzU1", "url": "https://github.com/apache/incubator-doris/pull/2737#pullrequestreview-341557755", "createdAt": "2020-01-12T07:24:04Z", "commit": {"oid": "d89c77bb68e0772a080e3d0620b503346a5003c7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMlQwNzoyNDowNFrOFcoLxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMlQwNzoyNTozMlrOFcoMCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2MjgyMw==", "bodyText": "I think you can add this this.replicationNum to the tableProperty so that we do not need to update the FeMetaVersion.", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r365562823", "createdAt": "2020-01-12T07:24:04Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/OlapTable.java", "diffHunk": "@@ -148,6 +150,8 @@ public OlapTable() {\n         this.indexes = null;\n       \n         this.tableProperty = null;\n+\n+        this.replicationNum = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d89c77bb68e0772a080e3d0620b503346a5003c7"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2Mjg3MA==", "bodyText": "Do not add replication num in create table stmt, cause it does not reflect the real replication num of each partition of a table.", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r365562870", "createdAt": "2020-01-12T07:25:19Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -3908,6 +3907,12 @@ public static void getDdlStmt(Table table, List<String> createTableStmt, List<St\n                 sb.append(olapTable.getTableProperty().getDynamicPartitionProperty().toString());\n             }\n \n+            // 7. replicationNum", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d89c77bb68e0772a080e3d0620b503346a5003c7"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2Mjg5MA==", "bodyText": "Do not use static import", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r365562890", "createdAt": "2020-01-12T07:25:32Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -242,6 +242,8 @@\n import java.util.concurrent.atomic.AtomicBoolean;\n import java.util.concurrent.atomic.AtomicLong;\n \n+import static org.apache.doris.common.util.PropertyAnalyzer.PROPERTIES_REPLICATION_NUM;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d89c77bb68e0772a080e3d0620b503346a5003c7"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMzA0ODc1", "url": "https://github.com/apache/incubator-doris/pull/2737#pullrequestreview-342304875", "createdAt": "2020-01-14T05:58:52Z", "commit": {"oid": "1c91dcdadfb5e0dd978a3044162a862fb1ed3c2a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNTo1ODo1MlrOFdM2ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwNTo1OTowNVrOFdM2jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE2MzU2Mg==", "bodyText": "how about just return FeConstants.default_replication_num is there is no default replica num?", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r366163562", "createdAt": "2020-01-14T05:58:52Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/OlapTable.java", "diffHunk": "@@ -1203,4 +1203,19 @@ public boolean convertRandomDistributionToHashDistribution() {\n         }\n         return hasChanged;\n     }\n+\n+    public void setReplicationNum(Short replicationNum) {\n+        if (tableProperty == null) {\n+            tableProperty = new TableProperty(new HashMap<String, String>());\n+        }\n+        tableProperty.getProperties().put(PropertyAnalyzer.PROPERTIES_REPLICATION_NUM, replicationNum.toString());\n+    }\n+\n+    public Short getReplicationNum() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c91dcdadfb5e0dd978a3044162a862fb1ed3c2a"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE2MzU5OQ==", "bodyText": "See comment of TableProperty about how to modify and use this class.\nYou should add a new field defaultReplicaNum in TableProperty, and this field is built from properties.\nAlso, a method buildDefaultReplicaNum() should be implemented.", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r366163599", "createdAt": "2020-01-14T05:59:05Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/OlapTable.java", "diffHunk": "@@ -1203,4 +1203,19 @@ public boolean convertRandomDistributionToHashDistribution() {\n         }\n         return hasChanged;\n     }\n+\n+    public void setReplicationNum(Short replicationNum) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c91dcdadfb5e0dd978a3044162a862fb1ed3c2a"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTMxMjcx", "url": "https://github.com/apache/incubator-doris/pull/2737#pullrequestreview-343931271", "createdAt": "2020-01-16T14:01:16Z", "commit": {"oid": "479de4a8eefe0137c004149d6b7f53b1f77f56e2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDowMToxNlrOFeaSNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDowMToxNlrOFeaSNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzMjI0NA==", "bodyText": "You do not need to log all properties in TableProperty, only properties is enough", "url": "https://github.com/apache/incubator-doris/pull/2737#discussion_r367432244", "createdAt": "2020-01-16T14:01:16Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -5117,15 +5118,28 @@ public void replayModifyTableDynamicPartition(ModifyDynamicPartitionInfo info) {\n             OlapTable olapTable = (OlapTable) db.getTable(tableId);\n             TableProperty tableProperty = olapTable.getTableProperty();\n             if (tableProperty == null) {\n-                olapTable.setTableProperty(new TableProperty(properties).buildDynamicProperty());\n+                olapTable.setTableProperty(new TableProperty(properties).buildProperty(opCode));\n             } else {\n                 tableProperty.modifyTableProperties(properties);\n+                tableProperty.buildProperty(opCode);\n             }\n         } finally {\n             db.writeUnlock();\n         }\n     }\n \n+    public void modifyTableReplicationNum(Database db, OlapTable table, Map<String, String> properties) throws DdlException {\n+        TableProperty tableProperty = table.getTableProperty();\n+        if (tableProperty == null) {\n+            tableProperty = new TableProperty(properties);\n+        } else {\n+            tableProperty.modifyTableProperties(properties);\n+        }\n+        tableProperty.buildReplicationNum();\n+        ModifyTablePropertyOperationLog info = new ModifyTablePropertyOperationLog(db.getId(), table.getId(), table.getTableProperty().getProperties());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "479de4a8eefe0137c004149d6b7f53b1f77f56e2"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bed3dd75dd6d2a80dd0671735756b251604aea0a", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/bed3dd75dd6d2a80dd0671735756b251604aea0a", "committedDate": "2020-01-17T16:08:23Z", "message": "Support replicationNum setting for table level"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8b04e13a9cba4570ee03dbe8b57cf1988aa118d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/e8b04e13a9cba4570ee03dbe8b57cf1988aa118d", "committedDate": "2020-01-17T16:11:35Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "047eb1464db3e3bd592df8acdbd58f72e0d1914f", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/047eb1464db3e3bd592df8acdbd58f72e0d1914f", "committedDate": "2020-01-17T16:11:39Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "159a201f691f437cbf83172b1c6543ded15f0f0d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/159a201f691f437cbf83172b1c6543ded15f0f0d", "committedDate": "2020-01-17T16:11:39Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "028565d8898f9b47a73d075449f6c014feffb3bf", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/028565d8898f9b47a73d075449f6c014feffb3bf", "committedDate": "2020-01-17T16:11:39Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9754dee703ab507aca12ff22e4bbde15c7953465", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/9754dee703ab507aca12ff22e4bbde15c7953465", "committedDate": "2020-01-17T16:11:39Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a123a032393538e04d84765b4e4b82c78f278c39", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/a123a032393538e04d84765b4e4b82c78f278c39", "committedDate": "2020-01-17T16:11:39Z", "message": "support tableProperty modification"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfee366751e2e15f2a41d3fece6ecbdb92fed53c", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/bfee366751e2e15f2a41d3fece6ecbdb92fed53c", "committedDate": "2020-01-17T16:11:39Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a144d8db381f2cad69ffff186653df06454f052", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/0a144d8db381f2cad69ffff186653df06454f052", "committedDate": "2020-01-17T16:11:39Z", "message": "fix set replication_num exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da99b3c1362c4f6f4b911d85ad3316f390650616", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/da99b3c1362c4f6f4b911d85ad3316f390650616", "committedDate": "2020-01-17T14:10:00Z", "message": "fix set replication_num exception"}, "afterCommit": {"oid": "0a144d8db381f2cad69ffff186653df06454f052", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/0a144d8db381f2cad69ffff186653df06454f052", "committedDate": "2020-01-17T16:11:39Z", "message": "fix set replication_num exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa9284b77dcab3e991ca73bbcf2ef16780680fe1", "author": {"user": {"login": "caiconghui", "name": "caiconghui"}}, "url": "https://github.com/apache/incubator-doris/commit/fa9284b77dcab3e991ca73bbcf2ef16780680fe1", "committedDate": "2020-01-18T12:34:37Z", "message": "Use default.replication_num instead of replication_num to alter table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d2e88ee5fa16e9b09d0ca3957553cf3dc4b4f7e", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/3d2e88ee5fa16e9b09d0ca3957553cf3dc4b4f7e", "committedDate": "2020-01-18T13:07:02Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTQzMDk4", "url": "https://github.com/apache/incubator-doris/pull/2737#pullrequestreview-344943098", "createdAt": "2020-01-18T13:15:31Z", "commit": {"oid": "3d2e88ee5fa16e9b09d0ca3957553cf3dc4b4f7e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3930, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}