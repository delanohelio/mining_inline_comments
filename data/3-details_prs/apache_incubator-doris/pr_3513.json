{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0NzU1NzMw", "number": 3513, "title": " [Doris On ES]fix bug of query failed in doc_value_mode when fields have none value", "bodyText": "#3479\nHere I try to explain the cause of the problem and how to fix it.\nThe Cause of The problem\nTake the case in issue(#3479 ) as an example:\nThe general results are as follows:\nGET table/_doc/_search\n{\"query\":{\"match_all\":{}},\"stored_fields\":\"_none_\",\"docvalue_fields\":[\"k1\"],\"sort\":[\"_doc\"],\"size\":100}\n\n{\n  \"took\": 6,\n  \"timed_out\": false,\n  \"_shards\": {\n    \u2026\u2026\n  },\n  \"hits\": {\n    \"total\": 3,\n    \"max_score\": null,\n    \"hits\": [\n      {\n        \"_index\": \"table\",\n        \"_score\": null,\n        \"sort\": [\n          0\n        ]\n      },\n      {\n        \"_index\": \"table\",\n        \"_score\": null,\n        \"fields\": {\n          \"k1\": [\n            \"kkk1\"\n          ]\n        },\n        \"sort\": [\n          0\n        ]\n      },\n      {\n        \"_index\": \"table\",\n        \"_score\": null,\n        \"sort\": [\n          0\n        ]\n      }\n    ]\n  }\n}\n\nBut in Doris on ES\uff0cBe fetched data parallelly on all shards, and use filter_path to reduce the network cost. The process will be as follows:\nGET table/_doc/_search?preference=_shards:1&filter_path=_scroll_id,hits.hits._source,hits.total,_id,hits.hits._source.fields,hits.hits.fields\n{\"query\":{\"match_all\":{}},\"stored_fields\":\"_none_\",\"docvalue_fields\":[\"k1\"],\"sort\":[\"_doc\"],\"size\":100}\n\n{\n  \"hits\": {\n    \"total\": 0\n  }\n}\n\nGET table/_doc/_search?preference=_shards:2&filter_path=_scroll_id,hits.hits._source,hits.total,_id,hits.hits._source.fields,hits.hits.fields\n{\"query\":{\"match_all\":{}},\"stored_fields\":\"_none_\",\"docvalue_fields\":[\"k1\"],\"sort\":[\"_doc\"],\"size\":100}\n{\n  \"hits\": {\n    \"total\": 1\n  }\n}\n\nGET table/_doc/_search?preference=_shards:3&filter_path=_scroll_id,hits.hits._source,hits.total,_id,hits.hits._source.fields,hits.hits.fields\n{\"query\":{\"match_all\":{}},\"stored_fields\":\"_none_\",\"docvalue_fields\":[\"k1\"],\"sort\":[\"_doc\"],\"size\":100}\n{\n  \"hits\": {\n    \"total\": 1,\n    \"hits\": [\n      {\n        \"fields\": {\n          \"k1\": [\n            \"kkk1\"\n          ]\n        }\n      }\n    ]\n  }\n}\n\nScan-Worker On BE which processed result of shard2  will failed.\nThe reasons are as follows:\n\n\"filter_path\" causes the hits.hits object not exist.\nIn the current implementation, if there are some data rows\uff08total > 0\uff09, the hits.hits. object must be an array\n\nHow To Fix it\nTwo Method:\n\nmodify \"filter_path\" to contain the hits.\nPros: Fixed Code is very simple\nCons: More network cost\nDeal with the case where fields are missing in a batch.\nPros: No loss of performance\nCons: Code is more complex\n\nPerformance first, I use Method2.\nDesign\n\nAdd a variable \"_doc_value_mode\" into Class \"EsScrollParser\" to =indicate whether the data processed by this parser is doc_value_mode or not.\n\"_doc_value_mode\" is passed from ESScollReader <- ESScanner <- ScrollQueryBuilder::build() that determines whether DSL is enable doc_value_mode\nWhen hits.hits of response from ES is empty and total > 0. We know there are data lines, but the corresponding fields do not exist. EsScrollParser will use \"_doc_value_mode\"  and _total to construct _total lines which fields are assigned with 'NULL'", "createdAt": "2020-05-07T15:21:07Z", "url": "https://github.com/apache/incubator-doris/pull/3513", "merged": true, "mergeCommit": {"oid": "5a57ecca15176fce28e3163321de5c75162050c9"}, "closed": true, "closedAt": "2020-05-11T07:34:13Z", "author": {"login": "blackfox1983"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABce-1PwgH2gAyNDE0NzU1NzMwOjRmZmI3MGM1ZDk3NjkwODA5YmY3N2JmNTBjYWI0OWE1MDgxYThkMTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfnLxAgFqTQwODY1MzY4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4ffb70c5d97690809bf77bf50cab49a5081a8d15", "author": {"user": {"login": "blackfox1983", "name": "\u4ee4\u72d0\u5c11\u4fa0"}}, "url": "https://github.com/apache/incubator-doris/commit/4ffb70c5d97690809bf77bf50cab49a5081a8d15", "committedDate": "2020-05-07T15:16:05Z", "message": "fix bug of query failed when column not exist"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3OTcxMDA4", "url": "https://github.com/apache/incubator-doris/pull/3513#pullrequestreview-407971008", "createdAt": "2020-05-08T03:19:48Z", "commit": {"oid": "4ffb70c5d97690809bf77bf50cab49a5081a8d15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwMzoxOTo0OVrOGSXmbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwMzoxOTo0OVrOGSXmbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkxNDIyMw==", "bodyText": "maybe _size should be total ? currently, the _size = inner_hits.size()", "url": "https://github.com/apache/incubator-doris/pull/3513#discussion_r421914223", "createdAt": "2020-05-08T03:19:49Z", "author": {"login": "wuyunfeng"}, "path": "be/src/exec/es/es_scroll_parser.cpp", "diffHunk": "@@ -275,7 +286,32 @@ int ScrollParser::get_total() {\n Status ScrollParser::fill_tuple(const TupleDescriptor* tuple_desc, \n             Tuple* tuple, MemPool* tuple_pool, bool* line_eof, const std::map<std::string, std::string>& docvalue_context) {\n     *line_eof = true;\n+\n     if (_size <= 0 || _line_index >= _size) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ffb70c5d97690809bf77bf50cab49a5081a8d15"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89b5f93fc62287a7eefccc64062bf58f5199de75", "author": {"user": {"login": "blackfox1983", "name": "\u4ee4\u72d0\u5c11\u4fa0"}}, "url": "https://github.com/apache/incubator-doris/commit/89b5f93fc62287a7eefccc64062bf58f5199de75", "committedDate": "2020-05-08T14:56:26Z", "message": "fix complier failed of ut"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjExMjA4", "url": "https://github.com/apache/incubator-doris/pull/3513#pullrequestreview-408611208", "createdAt": "2020-05-09T04:26:57Z", "commit": {"oid": "89b5f93fc62287a7eefccc64062bf58f5199de75"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDoyNjo1OFrOGS4ZRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDoyOTozOFrOGS4Z5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MTUyNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // _fields(doc_value) is fetched from E.S.\n          \n          \n            \n                    // _fields(doc_value) is fetched from ES", "url": "https://github.com/apache/incubator-doris/pull/3513#discussion_r422451524", "createdAt": "2020-05-09T04:26:58Z", "author": {"login": "wuyunfeng"}, "path": "be/src/exec/es/es_scroll_parser.cpp", "diffHunk": "@@ -275,7 +286,32 @@ int ScrollParser::get_total() {\n Status ScrollParser::fill_tuple(const TupleDescriptor* tuple_desc, \n             Tuple* tuple, MemPool* tuple_pool, bool* line_eof, const std::map<std::string, std::string>& docvalue_context) {\n     *line_eof = true;\n+\n     if (_size <= 0 || _line_index >= _size) {\n+        // _source is fetched from E.S.\n+        if (!_use_doc_value) {\n+            return Status::OK();\n+        }\n+        \n+        // _fields(doc_value) is fetched from E.S.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89b5f93fc62287a7eefccc64062bf58f5199de75"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MTU1Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // here is operations for `enable_doc_value_scan`.\n          \n          \n            \n                    // here is operations for `use_doc_value`.", "url": "https://github.com/apache/incubator-doris/pull/3513#discussion_r422451552", "createdAt": "2020-05-09T04:27:35Z", "author": {"login": "wuyunfeng"}, "path": "be/src/exec/es/es_scroll_parser.cpp", "diffHunk": "@@ -275,7 +286,32 @@ int ScrollParser::get_total() {\n Status ScrollParser::fill_tuple(const TupleDescriptor* tuple_desc, \n             Tuple* tuple, MemPool* tuple_pool, bool* line_eof, const std::map<std::string, std::string>& docvalue_context) {\n     *line_eof = true;\n+\n     if (_size <= 0 || _line_index >= _size) {\n+        // _source is fetched from E.S.\n+        if (!_use_doc_value) {\n+            return Status::OK();\n+        }\n+        \n+        // _fields(doc_value) is fetched from E.S.\n+        if (_total <= 0 || _line_index >= _total) {\n+            return Status::OK();\n+        }\n+       \n+       \n+        // here is operations for `enable_doc_value_scan`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89b5f93fc62287a7eefccc64062bf58f5199de75"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MTY4NA==", "bodyText": "maybe use doc_value_mode is more suitable\uff1f\nin future, we can use different parser for _source or doc_value mode", "url": "https://github.com/apache/incubator-doris/pull/3513#discussion_r422451684", "createdAt": "2020-05-09T04:29:38Z", "author": {"login": "wuyunfeng"}, "path": "be/src/exec/es/es_scroll_parser.h", "diffHunk": "@@ -50,5 +50,7 @@ class ScrollParser {\n \n     rapidjson::Document _document_node;\n     rapidjson::Value _inner_hits_node;\n+\n+    bool _use_doc_value;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89b5f93fc62287a7eefccc64062bf58f5199de75"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad34153beb641e3dc3d299bfde3da6d31d3c9a37", "author": {"user": {"login": "blackfox1983", "name": "\u4ee4\u72d0\u5c11\u4fa0"}}, "url": "https://github.com/apache/incubator-doris/commit/ad34153beb641e3dc3d299bfde3da6d31d3c9a37", "committedDate": "2020-05-09T06:45:11Z", "message": "fixed style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3fa2fb1f53f44f5583449b9031f88630afd03ec", "author": {"user": {"login": "blackfox1983", "name": "\u4ee4\u72d0\u5c11\u4fa0"}}, "url": "https://github.com/apache/incubator-doris/commit/f3fa2fb1f53f44f5583449b9031f88630afd03ec", "committedDate": "2020-05-09T06:55:36Z", "message": "add a todo comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjI0NzU1", "url": "https://github.com/apache/incubator-doris/pull/3513#pullrequestreview-408624755", "createdAt": "2020-05-09T07:58:52Z", "commit": {"oid": "f3fa2fb1f53f44f5583449b9031f88630afd03ec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjUzNjg5", "url": "https://github.com/apache/incubator-doris/pull/3513#pullrequestreview-408653689", "createdAt": "2020-05-09T14:16:53Z", "commit": {"oid": "f3fa2fb1f53f44f5583449b9031f88630afd03ec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2992, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}