{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMjE3OTA0", "number": 3286, "title": "unregister fragment mem tracker in close()", "bodyText": "ref #3273\nP.S.\n\n  \n    \n      incubator-doris/be/src/runtime/plan_fragment_executor.cpp\n    \n    \n        Lines 559 to 562\n      in\n      614a76b\n    \n    \n    \n    \n\n        \n          \n           // _mem_tracker init failed \n        \n\n        \n          \n           if (_mem_tracker.get() != nullptr) { \n        \n\n        \n          \n               _mem_tracker->release(_mem_tracker->consumption()); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nI think this piece of code is useless.\nThis _mem_tracker in PlanFragmentExecutor is set as fragment_mem_tracker of RuntimeState.\ndirect use\nWe use it in these code, when rowbatch reset, mem tracker's consumption will be released.\n\n  \n    \n      incubator-doris/be/src/exec/olap_rewrite_node.cpp\n    \n    \n        Lines 57 to 58\n      in\n      7eab12a\n    \n    \n    \n    \n\n        \n          \n           _child_row_batch.reset( \n        \n\n        \n          \n                   new RowBatch(child(0)->row_desc(), state->batch_size(), state->fragment_mem_tracker())); \n        \n    \n  \n\n\n\n  \n    \n      incubator-doris/be/src/exec/olap_scan_node.cpp\n    \n    \n        Lines 1217 to 1218\n      in\n      839ec45\n    \n    \n    \n    \n\n        \n          \n           RowBatch *row_batch = new RowBatch( \n        \n\n        \n          \n                   this->row_desc(), state->batch_size(), _runtime_state->fragment_mem_tracker()); \n        \n    \n  \n\n\nother usage\ne.g.\n\n  \n    \n      incubator-doris/be/src/exec/olap_scanner.cpp\n    \n    \n         Line 245\n      in\n      6c33f80\n    \n    \n    \n    \n\n        \n          \n           std::unique_ptr<MemTracker> tracker(new MemTracker(state->fragment_mem_tracker()->limit())); \n        \n    \n  \n\n\nwon't consume the fragment mem tracker. We don't need to worry about the fragment mem tracker consumption is not zero when we want to destroy it.\nOr we can add a consumption check before we close the mem tracker?", "createdAt": "2020-04-09T05:31:36Z", "url": "https://github.com/apache/incubator-doris/pull/3286", "merged": true, "mergeCommit": {"oid": "807499427cd308fb5992bbfa38ff3f451715138d"}, "closed": true, "closedAt": "2020-04-13T15:15:57Z", "author": {"login": "vagetablechicken"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV1a0MgH2gAyNDAxMjE3OTA0OjUyMDg3NTFlNDczMDIwOWVlMWFmZmUzYjVmMjk5M2NmYmQxZjFkYjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXQb_uAFqTM5MjIwOTk3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5208751e4730209ee1affe3b5f2993cfbd1f1db4", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/5208751e4730209ee1affe3b5f2993cfbd1f1db4", "committedDate": "2020-04-09T05:12:45Z", "message": "unregister fragment mem tracker in close()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNTIyNzgw", "url": "https://github.com/apache/incubator-doris/pull/3286#pullrequestreview-390522780", "createdAt": "2020-04-09T06:33:37Z", "commit": {"oid": "5208751e4730209ee1affe3b5f2993cfbd1f1db4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNjozMzozN1rOGDLTTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNjozMzozN1rOGDLTTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4NDA3Ng==", "bodyText": "Why not keep origin code and just add unregister_from_parent.\nIf you reset this mem_tracker here, I'm not sure if it will work in some situation, some runtime holder may access this tracker.\nSo, just to keep things simple, better not change origin code.\nBy the way, this tracker can be substituted by other tracker. Maybe it can be done in another issue.", "url": "https://github.com/apache/incubator-doris/pull/3286#discussion_r405984076", "createdAt": "2020-04-09T06:33:37Z", "author": {"login": "imay"}, "path": "be/src/runtime/plan_fragment_executor.cpp", "diffHunk": "@@ -556,10 +556,12 @@ void PlanFragmentExecutor::close() {\n         }\n     }\n      \n-    // _mem_tracker init failed\n+    // fragment mem tracker needs unregister\n     if (_mem_tracker.get() != nullptr) {\n-        _mem_tracker->release(_mem_tracker->consumption());\n+        _mem_tracker->unregister_from_parent();\n+        _mem_tracker->close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5208751e4730209ee1affe3b5f2993cfbd1f1db4"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23f9c1f812b4fbf06b1446f4a41bb35d0ff08cb9", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/23f9c1f812b4fbf06b1446f4a41bb35d0ff08cb9", "committedDate": "2020-04-13T09:27:07Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fc7803b28c76c6415edf2f58354f38f971d009d", "author": {"user": null}, "url": "https://github.com/apache/incubator-doris/commit/5fc7803b28c76c6415edf2f58354f38f971d009d", "committedDate": "2020-04-13T09:31:19Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMjA5OTcw", "url": "https://github.com/apache/incubator-doris/pull/3286#pullrequestreview-392209970", "createdAt": "2020-04-13T15:15:25Z", "commit": {"oid": "5fc7803b28c76c6415edf2f58354f38f971d009d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3198, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}