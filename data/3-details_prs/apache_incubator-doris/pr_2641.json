{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4Njg4NDE1", "number": 2641, "title": "CreateViewStmt/AlterViewStmt support cte and fix bug", "bodyText": "This commit contains the following changes:\n\nLet create/alter view statement support cte sql. (Issue #2625 )\n\ne.g.\nAlter view test_tbl_view (h1, h2)\nas\nwith testTbl_cte (w1, w2) as \n(\n    select col1, col2 from testDb.testTbl\n)\nselect w1 as c1, sum(w2) as c2 from testTbl_cte \nwhere w1 > 10 \ngroup by w1 order by w1\n\n\nFix the bug that view's schema remains unchanged after replaying alter view. (Issue #2624 )", "createdAt": "2020-01-02T15:04:22Z", "url": "https://github.com/apache/incubator-doris/pull/2641", "merged": true, "mergeCommit": {"oid": "f7cea6dda5fc731e96e43c4216b386804219fb0f"}, "closed": true, "closedAt": "2020-01-08T15:11:39Z", "author": {"login": "xy720"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2tCTagFqTMzODA0NzgwMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4WYjUgFqTMzOTkwNjE2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MDQ3ODAx", "url": "https://github.com/apache/incubator-doris/pull/2641#pullrequestreview-338047801", "createdAt": "2020-01-03T11:48:50Z", "commit": {"oid": "93f4f10e64c676095abdee8ca7d3d63d5e0999cc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxMTo0ODo1MFrOFZ-kuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxMTo1NTowMFrOFZ-pog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc4MzkyOQ==", "bodyText": "should use a new Analyzer", "url": "https://github.com/apache/incubator-doris/pull/2641#discussion_r362783929", "createdAt": "2020-01-03T11:48:50Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/analysis/CreateViewStmt.java", "diffHunk": "@@ -55,21 +55,17 @@ public String getComment() {\n \n     @Override\n     public void analyze(Analyzer analyzer) throws AnalysisException, UserException {\n-        if (cols != null) {\n-            cloneStmt = viewDefStmt.clone();\n-        }\n         tableName.analyze(analyzer);\n         viewDefStmt.setNeedToSql(true);\n-        // Analyze view define statement\n-        Analyzer viewAnalyzer = new Analyzer(analyzer);\n-        viewDefStmt.analyze(viewAnalyzer);\n \n         // check privilege\n         if (!Catalog.getCurrentCatalog().getAuth().checkTblPriv(ConnectContext.get(), tableName.getDb(),\n                                                                 tableName.getTbl(), PrivPredicate.CREATE)) {\n             ErrorReport.reportAnalysisException(ErrorCode.ERR_SPECIFIC_ACCESS_DENIED_ERROR, \"CREATE\");\n         }\n \n+        // Analyze view define statement\n+        viewDefStmt.analyze(analyzer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93f4f10e64c676095abdee8ca7d3d63d5e0999cc"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc4NDc1MA==", "bodyText": "I'm not sure that the following will be right for every case.", "url": "https://github.com/apache/incubator-doris/pull/2641#discussion_r362784750", "createdAt": "2020-01-03T11:52:49Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/analysis/BaseViewStmt.java", "diffHunk": "@@ -113,27 +113,21 @@ protected void createColumnAndViewDefs(Analyzer analyzer) throws AnalysisExcepti\n             return;\n         }\n \n-        Analyzer tmpAnalyzer = new Analyzer(analyzer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93f4f10e64c676095abdee8ca7d3d63d5e0999cc"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc4NTA5MQ==", "bodyText": "Is this work for a function call in select list?", "url": "https://github.com/apache/incubator-doris/pull/2641#discussion_r362785091", "createdAt": "2020-01-03T11:54:24Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/analysis/BaseViewStmt.java", "diffHunk": "@@ -113,27 +113,21 @@ protected void createColumnAndViewDefs(Analyzer analyzer) throws AnalysisExcepti\n             return;\n         }\n \n-        Analyzer tmpAnalyzer = new Analyzer(analyzer);\n-        List<String> colNames = cols.stream().map(c -> c.getColName()).collect(Collectors.toList());\n-        cloneStmt.substituteSelectList(tmpAnalyzer, colNames);\n-        inlineViewDef = cloneStmt.toSql();\n-\n-        // StringBuilder sb = new StringBuilder();\n-        // sb.append(\"SELECT \");\n-        // for (int i = 0; i < columnNames.size(); ++i) {\n-        //     if (i != 0) {\n-        //         sb.append(\", \");\n-        //     }\n-        //     String colRef = viewDefStmt.getColLabels().get(i);\n-        //     if (!colRef.startsWith(\"`\")) {\n-        //         colRef = \"`\" + colRef + \"`\";\n-        //     }\n-        //     String colAlias = finalCols.get(i).getName();\n-\n-        //     sb.append(String.format(\"`%s`.%s AS `%s`\", tableName.getTbl(), colRef, colAlias));\n-        // }\n-        // sb.append(String.format(\" FROM (%s) %s\", originalViewDef, tableName.getTbl()));\n-        // inlineViewDef = sb.toString();\n+        StringBuilder sb = new StringBuilder();\n+        sb.append(\"SELECT \");\n+        for (int i = 0; i < finalCols.size(); ++i) {\n+            if (i != 0) {\n+                sb.append(\", \");\n+            }\n+            String colRef = viewDefStmt.getColLabels().get(i);\n+            if (!colRef.startsWith(\"`\")) {\n+                colRef = \"`\" + colRef + \"`\";\n+            }\n+            String colAlias = finalCols.get(i).getName();\n+            sb.append(String.format(\"`%s`.%s AS `%s`\", tableName.getTbl(), colRef, colAlias));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93f4f10e64c676095abdee8ca7d3d63d5e0999cc"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc4NTE4Ng==", "bodyText": "must analyze view with a new analyzer.", "url": "https://github.com/apache/incubator-doris/pull/2641#discussion_r362785186", "createdAt": "2020-01-03T11:55:00Z", "author": {"login": "imay"}, "path": "fe/src/main/java/org/apache/doris/analysis/AlterViewStmt.java", "diffHunk": "@@ -54,20 +62,17 @@ public void analyze(Analyzer analyzer) throws AnalysisException, UserException {\n                     tableName.getTbl());\n         }\n \n-        if (cols != null) {\n-            cloneStmt = viewDefStmt.clone();\n-        }\n         viewDefStmt.setNeedToSql(true);\n-        Analyzer viewAnalyzer = new Analyzer(analyzer);\n+        viewDefStmt.analyze(analyzer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93f4f10e64c676095abdee8ca7d3d63d5e0999cc"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MzQ0NDMx", "url": "https://github.com/apache/incubator-doris/pull/2641#pullrequestreview-338344431", "createdAt": "2020-01-04T08:55:09Z", "commit": {"oid": "93f4f10e64c676095abdee8ca7d3d63d5e0999cc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNFQwODo1NTowOVrOFaNQSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNFQwODo1NTowOVrOFaNQSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAyNDQ1OQ==", "bodyText": "You can also add @SerializedName to newFullSchema", "url": "https://github.com/apache/incubator-doris/pull/2641#discussion_r363024459", "createdAt": "2020-01-04T08:55:09Z", "author": {"login": "morningman"}, "path": "fe/src/main/java/org/apache/doris/persist/AlterViewInfo.java", "diffHunk": "@@ -35,15 +38,18 @@\n     private String inlineViewDef;\n     @SerializedName(value = \"sqlMode\")\n     private long sqlMode;\n+    private List<Column> newFullSchema;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93f4f10e64c676095abdee8ca7d3d63d5e0999cc"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDI1MTAw", "url": "https://github.com/apache/incubator-doris/pull/2641#pullrequestreview-339025100", "createdAt": "2020-01-07T04:25:53Z", "commit": {"oid": "ec2289b319d36449f5291c0ddc4e7927a7097032"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec2289b319d36449f5291c0ddc4e7927a7097032", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/ec2289b319d36449f5291c0ddc4e7927a7097032", "committedDate": "2020-01-07T03:06:28Z", "message": "commit 9"}, "afterCommit": {"oid": "c9221d0507d7431de6dfddf1597c0aa125833f3a", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/c9221d0507d7431de6dfddf1597c0aa125833f3a", "committedDate": "2020-01-07T14:40:42Z", "message": "commit 9"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9941b94301194f069a2e15ec224334c0faf263cb", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/9941b94301194f069a2e15ec224334c0faf263cb", "committedDate": "2020-01-08T12:49:06Z", "message": "commit 1: support cte in view definition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d04a758da6c3c149923f27c7bc32edc508bf823", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/5d04a758da6c3c149923f27c7bc32edc508bf823", "committedDate": "2020-01-08T12:49:06Z", "message": "commit 2: fix replay alter-view bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f1d74609c9ab181f4f997d9aaaeb6bef5f3b78e", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/8f1d74609c9ab181f4f997d9aaaeb6bef5f3b78e", "committedDate": "2020-01-08T12:49:06Z", "message": "commit 3 : fix persist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aec799c84b63497a64b21df3498bb6885563741f", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/aec799c84b63497a64b21df3498bb6885563741f", "committedDate": "2020-01-08T12:49:06Z", "message": "commit 4 : fix persist alterViewInfo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9525d39a3989bf2670698ec3d669b50d712ded10", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/9525d39a3989bf2670698ec3d669b50d712ded10", "committedDate": "2020-01-08T12:52:58Z", "message": "commit 5: fix-persist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d193ce20cf32fafafbb15dea9df456ed88d7372", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/5d193ce20cf32fafafbb15dea9df456ed88d7372", "committedDate": "2020-01-08T12:54:28Z", "message": "commit 6: fix persist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b1fcd6a7d2d3d4ef1a4a10c75d29392afccea56", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/5b1fcd6a7d2d3d4ef1a4a10c75d29392afccea56", "committedDate": "2020-01-08T12:54:28Z", "message": "commit 7: fix persist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb023b6175f0a20761100b2c6359b6b48179b345", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/bb023b6175f0a20761100b2c6359b6b48179b345", "committedDate": "2020-01-08T12:54:28Z", "message": "commit 8: fix some typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e820d80bf053131930ffdadbb45286ded393f89", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/6e820d80bf053131930ffdadbb45286ded393f89", "committedDate": "2020-01-08T12:54:28Z", "message": "commit 8: add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c2655dc580aed0940c6e2e0dd8658af1916dd47", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/3c2655dc580aed0940c6e2e0dd8658af1916dd47", "committedDate": "2020-01-08T12:54:28Z", "message": "commit 9"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cf7b26975f6bd72d9f36e73fd1d5186ce068794", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/5cf7b26975f6bd72d9f36e73fd1d5186ce068794", "committedDate": "2020-01-08T12:54:29Z", "message": "commit 10"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "690a5f6e2ae14e0f363bb2b514fe082c3ce6616e", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/690a5f6e2ae14e0f363bb2b514fe082c3ce6616e", "committedDate": "2020-01-08T12:55:13Z", "message": "commit 11: add some comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d045f0cd8f9b407eee2fc62e4a64586c99344a7", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/3d045f0cd8f9b407eee2fc62e4a64586c99344a7", "committedDate": "2020-01-08T12:57:34Z", "message": "commit 12: Support GSON serialization for class Type"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2caef3f9037311425c08915ea9b93bf228dde61a", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/2caef3f9037311425c08915ea9b93bf228dde61a", "committedDate": "2020-01-08T07:23:15Z", "message": "commit 11: add some comments"}, "afterCommit": {"oid": "3d045f0cd8f9b407eee2fc62e4a64586c99344a7", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/3d045f0cd8f9b407eee2fc62e4a64586c99344a7", "committedDate": "2020-01-08T12:57:34Z", "message": "commit 12: Support GSON serialization for class Type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5ODY1NzQ5", "url": "https://github.com/apache/incubator-doris/pull/2641#pullrequestreview-339865749", "createdAt": "2020-01-08T13:35:21Z", "commit": {"oid": "3d045f0cd8f9b407eee2fc62e4a64586c99344a7"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22288acf6f66cd833367d6637a5d3b7fbf3ad33e", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/22288acf6f66cd833367d6637a5d3b7fbf3ad33e", "committedDate": "2020-01-08T14:17:32Z", "message": "Update GsonUtils.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7936fbeacf6a17c7bb5e3ea85f334a57234a8e20", "author": {"user": {"login": "xy720", "name": null}}, "url": "https://github.com/apache/incubator-doris/commit/7936fbeacf6a17c7bb5e3ea85f334a57234a8e20", "committedDate": "2020-01-08T14:19:42Z", "message": "Update Column.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5ODk2NTA2", "url": "https://github.com/apache/incubator-doris/pull/2641#pullrequestreview-339896506", "createdAt": "2020-01-08T14:24:55Z", "commit": {"oid": "7936fbeacf6a17c7bb5e3ea85f334a57234a8e20"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5OTA2MTYx", "url": "https://github.com/apache/incubator-doris/pull/2641#pullrequestreview-339906161", "createdAt": "2020-01-08T14:39:25Z", "commit": {"oid": "7936fbeacf6a17c7bb5e3ea85f334a57234a8e20"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3837, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}