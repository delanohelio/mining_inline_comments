{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MjYwMjk0", "number": 4088, "title": "[Bug][Alter] Cancel the alter job if database has been dropped", "bodyText": "Cancel the alter job in WAITING_TXN state if database has been dropped\nFix: #4087", "createdAt": "2020-07-13T13:34:55Z", "url": "https://github.com/apache/incubator-doris/pull/4088", "merged": true, "mergeCommit": {"oid": "bb35de2ccb1a879f3f527302828a60d780e57590"}, "closed": true, "closedAt": "2020-07-19T13:26:58Z", "author": {"login": "morningman"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0hdwngH2gAyNDQ4MjYwMjk0OjJhYWMyYjk2MjM1NDQyNDFlMDYwMDM0Y2U4ZmRjMTU3ZjlhNDExZTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1slbDAFqTQ1MDM3MzM1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2aac2b9623544241e060034ce8fdc157f9a411e0", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/2aac2b9623544241e060034ce8fdc157f9a411e0", "committedDate": "2020-07-13T13:29:31Z", "message": "[Bug][Alter] Cancel the alter job if database has been dropped\n\nCancel the alter job in WAITING_TXN state if database has been dropped"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzcwMzgz", "url": "https://github.com/apache/incubator-doris/pull/4088#pullrequestreview-447370383", "createdAt": "2020-07-13T15:40:12Z", "commit": {"oid": "2aac2b9623544241e060034ce8fdc157f9a411e0"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNTo0MDoxMlrOGwuUJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNTo0MDoxMlrOGwuUJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0MzY1Mg==", "bodyText": "SchedExcepition looks so stranger...", "url": "https://github.com/apache/incubator-doris/pull/4088#discussion_r453743652", "createdAt": "2020-07-13T15:40:12Z", "author": {"login": "wuyunfeng"}, "path": "fe/src/main/java/org/apache/doris/clone/TabletScheduler.java", "diffHunk": "@@ -879,9 +880,14 @@ private void deleteReplicaInternal(TabletSchedCtx tabletCtx, Replica replica, St\n             throw new SchedException(Status.SCHEDULE_FAILED, \"set watermark txn \" + nextTxnId);\n         } else if (replica.getState() == ReplicaState.DECOMMISSION && replica.getWatermarkTxnId() != -1) {\n             long watermarkTxnId = replica.getWatermarkTxnId();\n-            if (!Catalog.getCurrentGlobalTransactionMgr().isPreviousTransactionsFinished(watermarkTxnId,\n-                    tabletCtx.getDbId(), Lists.newArrayList(tabletCtx.getTblId()))) {\n-                throw new SchedException(Status.SCHEDULE_FAILED, \"wait txn before \" + watermarkTxnId + \" to be finished\");\n+            try {\n+                if (!Catalog.getCurrentGlobalTransactionMgr().isPreviousTransactionsFinished(watermarkTxnId,\n+                        tabletCtx.getDbId(), Lists.newArrayList(tabletCtx.getTblId()))) {\n+                    throw new SchedException(Status.SCHEDULE_FAILED,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2aac2b9623544241e060034ce8fdc157f9a411e0"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzczOTM3", "url": "https://github.com/apache/incubator-doris/pull/4088#pullrequestreview-447373937", "createdAt": "2020-07-13T15:44:31Z", "commit": {"oid": "2aac2b9623544241e060034ce8fdc157f9a411e0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNTo0NDozMlrOGwuhcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNTo0NDozMlrOGwuhcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0NzA1Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * check if there exists a load job before the endTransactionId have all\n          \n          \n            \n                 * Check whether a load job already exists before checking all `TransactionId` related with this load job have finished.", "url": "https://github.com/apache/incubator-doris/pull/4088#discussion_r453747057", "createdAt": "2020-07-13T15:44:32Z", "author": {"login": "wuyunfeng"}, "path": "fe/src/main/java/org/apache/doris/transaction/GlobalTransactionMgr.java", "diffHunk": "@@ -238,17 +238,25 @@ public void finishTransaction(long dbId, long transactionId, Set<Long> errorRepl\n     }\n \n     /**\n-     * check if there exists a load job before the endTransactionId have all finished\n+     * check if there exists a load job before the endTransactionId have all", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2aac2b9623544241e060034ce8fdc157f9a411e0"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f3bd2c6d032c96f83102026076bb2d9fb33f99c", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/9f3bd2c6d032c96f83102026076bb2d9fb33f99c", "committedDate": "2020-07-16T01:57:46Z", "message": "Update fe/src/main/java/org/apache/doris/transaction/GlobalTransactionMgr.java\n\nCo-authored-by: Yunfeng,Wu <wyfsky888@126.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NDU3NjUz", "url": "https://github.com/apache/incubator-doris/pull/4088#pullrequestreview-449457653", "createdAt": "2020-07-16T02:03:35Z", "commit": {"oid": "9f3bd2c6d032c96f83102026076bb2d9fb33f99c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzczMzUz", "url": "https://github.com/apache/incubator-doris/pull/4088#pullrequestreview-450373353", "createdAt": "2020-07-17T05:00:46Z", "commit": {"oid": "9f3bd2c6d032c96f83102026076bb2d9fb33f99c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2377, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}