{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MzUwMTA2", "number": 3246, "title": "[metrics] Add some metrics for container size in BE", "bodyText": "We can observe the workload of BE, and also it's a way to check\nwhether there is any problem in BE, like some container increase\ntoo large and lead to OOM.\nThis patch add the following metrics:\nName                                   Description\nrowset_count_generated_and_in_use      The total count of rowset id generated and in use since BE last start\nunused_rowsets_count                   The total count of unused rowset waiting to be GC\nbroker_count                           The total count of brokers in management\ndata_stream_receiver_count             The total count of data stream receivers in management\nfragment_endpoint_count                The total count of fragment endpoints of data stream in management, should always equal to data_stream_receiver_count\nactive_scan_context_count              The total count of active scan contexts\nplan_fragment_count                    The total count of plan fragments in executing\nload_channel_count                     The total count of load channels in management\nresult_buffer_block_count              The total count of result buffer blocks for queries, each block has a limited queue size (default 1024)\nresult_block_queue_count               The total count of queues for fragments, each queue has a limited size (default 20, by config::max_memory_sink_batch_count)\nroutine_load_task_count                The total count of routine load tasks in executing\nsmall_file_cache_count                 The total count of cached small files' digest info\nstream_load_pipe_count                 The total count of stream load pipes, each pipe has a limited buffer size (default 1M)\ntablet_writer_count                    The total count of tablet writers\nbrpc_endpoint_stub_count               The total count of brpc endpoints", "createdAt": "2020-04-02T04:31:52Z", "url": "https://github.com/apache/incubator-doris/pull/3246", "merged": true, "mergeCommit": {"oid": "72f308235819d4f99546a08c95b62d51ec356bdf"}, "closed": true, "closedAt": "2020-04-25T08:13:40Z", "author": {"login": "acelyc111"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTnhKnAFqTM4NjE4MTQ1OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbBkCHAFqTQwMDM3MTQyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MTgxNDU4", "url": "https://github.com/apache/incubator-doris/pull/3246#pullrequestreview-386181458", "createdAt": "2020-04-02T07:49:17Z", "commit": {"oid": "7265e5187b40ad754e2e5017da192ec1c56d554c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNzo0OToxOFrOF_fOMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNzo1MTozNFrOF_fTxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExNjE0Nw==", "bodyText": "EtlJobMgr is deprecated, it will be removed in next version.\nSo you don't need to add metrics for it.", "url": "https://github.com/apache/incubator-doris/pull/3246#discussion_r402116147", "createdAt": "2020-04-02T07:49:18Z", "author": {"login": "morningman"}, "path": "be/src/runtime/etl_job_mgr.cpp", "diffHunk": "@@ -62,6 +63,21 @@ const std::string ERROR_FILE_PREFIX = \"error_log\";\n \n EtlJobMgr::EtlJobMgr(ExecEnv* exec_env) :\n         _exec_env(exec_env), _success_jobs(5000), _failed_jobs(5000) {\n+    REGISTER_PRIVATE_VARIABLE_METRIC(running_etl_job_count);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7265e5187b40ad754e2e5017da192ec1c56d554c"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExNzU3Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    boost::lock_guard<boost::mutex> l(_lock);\n          \n          \n            \n                    std::lock_guard<boost::mutex> l(_lock);", "url": "https://github.com/apache/incubator-doris/pull/3246#discussion_r402117572", "createdAt": "2020-04-02T07:51:34Z", "author": {"login": "morningman"}, "path": "be/src/runtime/result_buffer_mgr.cpp", "diffHunk": "@@ -33,6 +34,11 @@ namespace doris {\n \n ResultBufferMgr::ResultBufferMgr()\n     : _is_stop(false) {\n+    REGISTER_PRIVATE_VARIABLE_METRIC(result_buffer_block_count);\n+    DorisMetrics::metrics()->register_hook(\"result_buffer_block_count\", [&]() {\n+        boost::lock_guard<boost::mutex> l(_lock);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7265e5187b40ad754e2e5017da192ec1c56d554c"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "317a4e0c4fb63c54375a4d40d988681a92329a05", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/317a4e0c4fb63c54375a4d40d988681a92329a05", "committedDate": "2020-04-03T09:02:17Z", "message": "fix"}, "afterCommit": {"oid": "c69697cb393c18dad0e721d5d6505035573eea8b", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/c69697cb393c18dad0e721d5d6505035573eea8b", "committedDate": "2020-04-03T09:03:45Z", "message": "[metrics] Add some metrics for container size in BE\n\nWe can observe the workload of BE, and also it's a way to check\nwhether there is any problem in BE, like some container increase\nto large and lead to OOM."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85c49b1ae8c9513d71013a0dbf112468be86dce7", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/85c49b1ae8c9513d71013a0dbf112468be86dce7", "committedDate": "2020-04-03T10:49:15Z", "message": "fix"}, "afterCommit": {"oid": "33a199d4dab1abfaf8e0726d16f4055bfab03a90", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/33a199d4dab1abfaf8e0726d16f4055bfab03a90", "committedDate": "2020-04-05T02:37:01Z", "message": "fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33a199d4dab1abfaf8e0726d16f4055bfab03a90", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/33a199d4dab1abfaf8e0726d16f4055bfab03a90", "committedDate": "2020-04-05T02:37:01Z", "message": "fix"}, "afterCommit": {"oid": "6baf8039473f8e8f473b98c0b049a2d5e3bc4d7a", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/6baf8039473f8e8f473b98c0b049a2d5e3bc4d7a", "committedDate": "2020-04-09T15:03:43Z", "message": "fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6baf8039473f8e8f473b98c0b049a2d5e3bc4d7a", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/6baf8039473f8e8f473b98c0b049a2d5e3bc4d7a", "committedDate": "2020-04-09T15:03:43Z", "message": "fix"}, "afterCommit": {"oid": "15c03e188b5fdbad74ab52ba3d51e716c0810653", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/15c03e188b5fdbad74ab52ba3d51e716c0810653", "committedDate": "2020-04-10T07:22:41Z", "message": "fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "441e21cf9df345eb33cfbe68ccf7ccfa3be16a42", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/441e21cf9df345eb33cfbe68ccf7ccfa3be16a42", "committedDate": "2020-04-12T11:41:55Z", "message": "include"}, "afterCommit": {"oid": "46ef7ff3d8ff215399b81e7f1bf3ec8b05e9c445", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/46ef7ff3d8ff215399b81e7f1bf3ec8b05e9c445", "committedDate": "2020-04-16T06:44:08Z", "message": "include"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46ef7ff3d8ff215399b81e7f1bf3ec8b05e9c445", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/46ef7ff3d8ff215399b81e7f1bf3ec8b05e9c445", "committedDate": "2020-04-16T06:44:08Z", "message": "include"}, "afterCommit": {"oid": "feef980bd14da163e47cf2088873d42ffac6dbe5", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/feef980bd14da163e47cf2088873d42ffac6dbe5", "committedDate": "2020-04-16T06:44:47Z", "message": "[metrics] Add some metrics for container size in BE\n\nWe can observe the workload of BE, and also it's a way to check\nwhether there is any problem in BE, like some container increase\nto large and lead to OOM."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "feef980bd14da163e47cf2088873d42ffac6dbe5", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/feef980bd14da163e47cf2088873d42ffac6dbe5", "committedDate": "2020-04-16T06:44:47Z", "message": "[metrics] Add some metrics for container size in BE\n\nWe can observe the workload of BE, and also it's a way to check\nwhether there is any problem in BE, like some container increase\nto large and lead to OOM."}, "afterCommit": {"oid": "7b1dbf4cd62032d999c6c49fea3b1220f47be090", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/7b1dbf4cd62032d999c6c49fea3b1220f47be090", "committedDate": "2020-04-16T06:51:59Z", "message": "[metrics] Add some metrics for container size in BE\n\nWe can observe the workload of BE, and also it's a way to check\nwhether there is any problem in BE, like some container increase\ntoo large and lead to OOM.\n\nThis patch add the following metrics:\nName                                   Description\nrowset_count_generated_and_in_use      The total count of rowset id generated and in use since BE last start\nunused_rowsets_count                   The total count of unused rowset waiting to be GC\nbroker_count                           The total count of brockers in management\ndata_stream_receiver_count             The total count of data stream receivers in management\nfragment_endpoint_count                The total count of fragment endpoints of data stream in management, should always equal to data_stream_receiver_count\nactive_scan_context_count              The total count of active scan contexts\nplan_fragment_count                    The total count of plan fragments in executing\nload_channel_count                     The total count of load channles in management\nresult_buffer_block_count              The total count of result buffer blocks for queries, each block has a limited queue size (default 1024)\nresult_block_queue_count               The total count of queues for fragments, each queue has a limited size (default 20, by config::max_memory_sink_batch_count)\nroutine_load_task_count                The total count of routine load tasks in executing\nsmall_file_cache_count                 The total count of cached small files' digest info\nstream_load_pipe_count                 The total count of stream load pipes, each pipe has a limited buffer size (default 1M)\ntablet_writer_count                    The total count of tablet writers\nbrpc_endpoint_stub_count               The total count of brpc endpoints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de836b6db87c79ab98a45a9cdce0d5beffb40cc3", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/de836b6db87c79ab98a45a9cdce0d5beffb40cc3", "committedDate": "2020-04-22T15:18:00Z", "message": "[metrics] Add some metrics for container size in BE\n\nWe can observe the workload of BE, and also it's a way to check\nwhether there is any problem in BE, like some container increase\ntoo large and lead to OOM.\n\nThis patch add the following metrics:\nName                                   Description\nrowset_count_generated_and_in_use      The total count of rowset id generated and in use since BE last start\nunused_rowsets_count                   The total count of unused rowset waiting to be GC\nbroker_count                           The total count of brockers in management\ndata_stream_receiver_count             The total count of data stream receivers in management\nfragment_endpoint_count                The total count of fragment endpoints of data stream in management, should always equal to data_stream_receiver_count\nactive_scan_context_count              The total count of active scan contexts\nplan_fragment_count                    The total count of plan fragments in executing\nload_channel_count                     The total count of load channles in management\nresult_buffer_block_count              The total count of result buffer blocks for queries, each block has a limited queue size (default 1024)\nresult_block_queue_count               The total count of queues for fragments, each queue has a limited size (default 20, by config::max_memory_sink_batch_count)\nroutine_load_task_count                The total count of routine load tasks in executing\nsmall_file_cache_count                 The total count of cached small files' digest info\nstream_load_pipe_count                 The total count of stream load pipes, each pipe has a limited buffer size (default 1M)\ntablet_writer_count                    The total count of tablet writers\nbrpc_endpoint_stub_count               The total count of brpc endpoints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15fde8067cd299834ac5203ccc61c2709376170b", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/15fde8067cd299834ac5203ccc61c2709376170b", "committedDate": "2020-04-22T15:18:00Z", "message": "fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4bbfd045ac7fb3c9a79543fbba688a0eb86c008", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/b4bbfd045ac7fb3c9a79543fbba688a0eb86c008", "committedDate": "2020-04-16T08:27:20Z", "message": "fix"}, "afterCommit": {"oid": "6ea79f27de92afab6f79bb863b11c5b85bf1d030", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/6ea79f27de92afab6f79bb863b11c5b85bf1d030", "committedDate": "2020-04-22T15:31:54Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66343051e6bd958609703f765b1804aefb14f809", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/66343051e6bd958609703f765b1804aefb14f809", "committedDate": "2020-04-22T15:53:48Z", "message": "fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ea79f27de92afab6f79bb863b11c5b85bf1d030", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/6ea79f27de92afab6f79bb863b11c5b85bf1d030", "committedDate": "2020-04-22T15:31:54Z", "message": "fix"}, "afterCommit": {"oid": "66343051e6bd958609703f765b1804aefb14f809", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/66343051e6bd958609703f765b1804aefb14f809", "committedDate": "2020-04-22T15:53:48Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzcxNDIy", "url": "https://github.com/apache/incubator-doris/pull/3246#pullrequestreview-400371422", "createdAt": "2020-04-25T08:11:18Z", "commit": {"oid": "66343051e6bd958609703f765b1804aefb14f809"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3156, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}