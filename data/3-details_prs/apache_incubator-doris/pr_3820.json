{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMzQ2Mzk4", "number": 3820, "title": "[Spill To Disk] Analytic_Eval_Node Support Spill Disk and Del Some Unless Code", "bodyText": "Add enable spilling in query option, upport spill disk in Analytic_Eval_Node, FE can open enable spilling by\n  set enable_spilling = true;\n\n\n\nNow, Sort Node and Analytic_Eval_Node can spill to disk.\n2. Delete merge merge_sorter code we do not use now.\n3. Replace buffered_tuple_stream by buffered_tuple_stream2 in Analytic_Eval_Node and support spill to disk. Delete the useless code of buffered_block_mgr and buffered_tuple_stream.\n4. Add DataStreamRecvr Profile. Move the counter belong to DataStreamRecvr from fragment to DataStreamRecvr Profile to make clear of Running Profile.", "createdAt": "2020-06-10T10:01:00Z", "url": "https://github.com/apache/incubator-doris/pull/3820", "merged": true, "mergeCommit": {"oid": "dac156b6b178248b62b36992441b7f6a9881d6f0"}, "closed": true, "closedAt": "2020-06-13T02:19:03Z", "author": {"login": "HappenLee"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp2WM3AH2gAyNDMyMzQ2Mzk4OmZmNmI4ZjI2OGVmYTI2M2VkMjIzNmNiOTg2Yjk4NjFjOTYxZjcxM2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqimmTAFqTQyOTcyNjI0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ff6b8f268efa263ed2236cb986b9861c961f713d", "author": {"user": {"login": "HappenLee", "name": "HappenLee"}}, "url": "https://github.com/apache/incubator-doris/commit/ff6b8f268efa263ed2236cb986b9861c961f713d", "committedDate": "2020-06-10T09:36:06Z", "message": "1. Add enable spilling in query option, support spill disk in Analytic_Eval_Node, FE can open enable spilling by\n\n         set enable_spilling = true;\n\nNow, Sort Node and Analytic_Eval_Node can spill to disk.\n2. Delete merge merge_sorter code we do not use now.\n3. Replace buffered_tuple_stream by buffered_tuple_stream2 in Analytic_Eval_Node and support spill to disk. Delete the useless code of buffered_block_mgr and buffered_tuple_stream.\n4. Add DataStreamRecvr Profile. Move the counter belong to DataStreamRecvr from fragment to DataStreamRecvr Profile to make clear of Running Profile."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61538fae25de0b1d1ad63173b75bde775cddd196", "author": {"user": {"login": "HappenLee", "name": "HappenLee"}}, "url": "https://github.com/apache/incubator-doris/commit/61538fae25de0b1d1ad63173b75bde775cddd196", "committedDate": "2020-06-10T09:52:28Z", "message": "change some hint in code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MTE2ODI4", "url": "https://github.com/apache/incubator-doris/pull/3820#pullrequestreview-428116828", "createdAt": "2020-06-10T14:31:56Z", "commit": {"oid": "61538fae25de0b1d1ad63173b75bde775cddd196"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDozMTo1NlrOGh3ufg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDozMTo1NlrOGh3ufg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE2OTIxNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                profile->add_child(_profile.get(), true, nullptr);\n          \n          \n            \n                _profile->add_child(_profile.get(), true, nullptr);", "url": "https://github.com/apache/incubator-doris/pull/3820#discussion_r438169214", "createdAt": "2020-06-10T14:31:56Z", "author": {"login": "wutiangan"}, "path": "be/src/runtime/data_stream_recvr.cc", "diffHunk": "@@ -360,9 +360,14 @@ DataStreamRecvr::DataStreamRecvr(\n             _row_desc(row_desc),\n             _is_merging(is_merging),\n             _num_buffered_bytes(0),\n-            _profile(profile),\n             _sub_plan_query_statistics_recvr(sub_plan_query_statistics_recvr) {\n-    _mem_tracker.reset(new MemTracker(-1, \"DataStreamRecvr\", parent_tracker));\n+    _profile.reset(new RuntimeProfile(nullptr, \"DataStreamRecvr\"));\n+    profile->add_child(_profile.get(), true, nullptr);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61538fae25de0b1d1ad63173b75bde775cddd196"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MjA4OTMz", "url": "https://github.com/apache/incubator-doris/pull/3820#pullrequestreview-428208933", "createdAt": "2020-06-10T16:04:04Z", "commit": {"oid": "61538fae25de0b1d1ad63173b75bde775cddd196"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjowNDowNFrOGh79kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjowNDowNFrOGh79kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzODYwOA==", "bodyText": "use enable_spill is better which is compatible to fe", "url": "https://github.com/apache/incubator-doris/pull/3820#discussion_r438238608", "createdAt": "2020-06-10T16:04:04Z", "author": {"login": "chaoyli"}, "path": "be/src/runtime/buffered_block_mgr2.cc", "diffHunk": "@@ -210,8 +210,7 @@ BufferedBlockMgr2::BufferedBlockMgr2(RuntimeState* state, TmpFileMgr* tmp_file_m\n     _max_block_size(block_size),\n     // Keep two writes in flight per scratch disk so the disks can stay busy.\n     _block_write_threshold(tmp_file_mgr->num_active_tmp_devices() * 2),\n-    // _disable_spill(state->query_ctx().disable_spilling),\n-    _disable_spill(false),\n+    _disable_spill(state->disable_spill()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61538fae25de0b1d1ad63173b75bde775cddd196"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "998b576d5b802a6b740689b3ab08b66725661c79", "author": {"user": {"login": "HappenLee", "name": "HappenLee"}}, "url": "https://github.com/apache/incubator-doris/commit/998b576d5b802a6b740689b3ab08b66725661c79", "committedDate": "2020-06-11T03:10:02Z", "message": "replace disable_spill with enable_spill which is better compatible to FE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NDE4ODY5", "url": "https://github.com/apache/incubator-doris/pull/3820#pullrequestreview-429418869", "createdAt": "2020-06-12T02:16:48Z", "commit": {"oid": "998b576d5b802a6b740689b3ab08b66725661c79"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NDU2NjE0", "url": "https://github.com/apache/incubator-doris/pull/3820#pullrequestreview-429456614", "createdAt": "2020-06-12T04:41:12Z", "commit": {"oid": "998b576d5b802a6b740689b3ab08b66725661c79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNDo0MToxM1rOGi21Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNDo0MToxM1rOGi21Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIwMzA5NQ==", "bodyText": "Please add this variable to doc.", "url": "https://github.com/apache/incubator-doris/pull/3820#discussion_r439203095", "createdAt": "2020-06-12T04:41:13Z", "author": {"login": "kangkaisen"}, "path": "gensrc/thrift/PaloInternalService.thrift", "diffHunk": "@@ -136,6 +136,8 @@ struct TQueryOptions {\n   // see BE config `max_pushdown_conditions_per_column` for details\n   // if set, this will overwrite the BE config.\n   30: optional i32 max_pushdown_conditions_per_column\n+  // whether enable spilling to disk\n+  31: optional bool enable_spilling = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "998b576d5b802a6b740689b3ab08b66725661c79"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NDU3Mzc0", "url": "https://github.com/apache/incubator-doris/pull/3820#pullrequestreview-429457374", "createdAt": "2020-06-12T04:43:56Z", "commit": {"oid": "998b576d5b802a6b740689b3ab08b66725661c79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNDo0Mzo1NlrOGi23fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNDo0Mzo1NlrOGi23fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIwMzcxMA==", "bodyText": "What's concrete problem will happen?", "url": "https://github.com/apache/incubator-doris/pull/3820#discussion_r439203710", "createdAt": "2020-06-12T04:43:56Z", "author": {"login": "kangkaisen"}, "path": "be/src/runtime/data_stream_recvr.cc", "diffHunk": "@@ -360,9 +360,14 @@ DataStreamRecvr::DataStreamRecvr(\n             _row_desc(row_desc),\n             _is_merging(is_merging),\n             _num_buffered_bytes(0),\n-            _profile(profile),\n             _sub_plan_query_statistics_recvr(sub_plan_query_statistics_recvr) {\n-    _mem_tracker.reset(new MemTracker(-1, \"DataStreamRecvr\", parent_tracker));\n+    _profile.reset(new RuntimeProfile(nullptr, \"DataStreamRecvr\"));\n+    profile->add_child(_profile.get(), true, nullptr);\n+\n+    // TODO: Now the parent tracker may cause problem when we need spill to disk, so we", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "998b576d5b802a6b740689b3ab08b66725661c79"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NDU3Njc2", "url": "https://github.com/apache/incubator-doris/pull/3820#pullrequestreview-429457676", "createdAt": "2020-06-12T04:45:03Z", "commit": {"oid": "998b576d5b802a6b740689b3ab08b66725661c79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNDo0NTowM1rOGi24dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNDo0NTowM1rOGi24dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIwMzk1OQ==", "bodyText": "directly remove it, not comment.", "url": "https://github.com/apache/incubator-doris/pull/3820#discussion_r439203959", "createdAt": "2020-06-12T04:45:03Z", "author": {"login": "kangkaisen"}, "path": "be/src/exec/exchange_node.cpp", "diffHunk": "@@ -110,7 +110,7 @@ Status ExchangeNode::close(RuntimeState* state) {\n     if (_stream_recvr != NULL) {\n         _stream_recvr->close();\n     }\n-    _stream_recvr.reset();\n+    // _stream_recvr.reset();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "998b576d5b802a6b740689b3ab08b66725661c79"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NDU3Nzkw", "url": "https://github.com/apache/incubator-doris/pull/3820#pullrequestreview-429457790", "createdAt": "2020-06-12T04:45:33Z", "commit": {"oid": "998b576d5b802a6b740689b3ab08b66725661c79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNDo0NTozM1rOGi247g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNDo0NTozM1rOGi247g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIwNDA3OA==", "bodyText": "would better give a better name.", "url": "https://github.com/apache/incubator-doris/pull/3820#discussion_r439204078", "createdAt": "2020-06-12T04:45:33Z", "author": {"login": "kangkaisen"}, "path": "be/src/exec/analytic_eval_node.cpp", "diffHunk": "@@ -195,9 +194,19 @@ Status AnalyticEvalNode::open(RuntimeState* state) {\n     RETURN_IF_CANCELLED(state);\n     //RETURN_IF_ERROR(QueryMaintenance(state));\n     RETURN_IF_ERROR(child(0)->open(state));\n-    // RETURN_IF_ERROR(state->block_mgr()->RegisterClient(2, mem_tracker(), state, &client_));\n-    _input_stream.reset(new BufferedTupleStream(state, child(0)->row_desc(), state->block_mgr()));\n-    RETURN_IF_ERROR(_input_stream->init(runtime_profile()));\n+    RETURN_IF_ERROR(state->block_mgr2()->register_client(2, mem_tracker(), state, &client_));\n+    _input_stream.reset(new BufferedTupleStream2(state, child(0)->row_desc(), state->block_mgr2(), client_, false, true));\n+    RETURN_IF_ERROR(_input_stream->init(id(), runtime_profile(), true));\n+\n+    bool got_read_buffer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "998b576d5b802a6b740689b3ab08b66725661c79"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NzI2MjQ1", "url": "https://github.com/apache/incubator-doris/pull/3820#pullrequestreview-429726245", "createdAt": "2020-06-12T13:09:50Z", "commit": {"oid": "998b576d5b802a6b740689b3ab08b66725661c79"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2526, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}