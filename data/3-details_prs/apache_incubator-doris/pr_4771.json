{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2NjEyNDcz", "number": 4771, "title": "[LoadBalance] make BeLoadRebalancer extends from base class Rebalancer", "bodyText": "Proposed changes\nCreate a base class Rebalancer, support to delete the specified replica(actually add a new priority in handling redundant replica).\nThe origin LoadBalancer, which will named as BeLoadRebalancer, just need to extend from Rebalancer without any logic change.\nTypes of changes\n\n Code refactor (Modify the code structure, format the code, etc...)\n\nChecklist\n\n I have create an issue on (Fix #4763), and have described the bug/feature there in detail\n Compiling and unit tests pass locally with my changes", "createdAt": "2020-10-20T09:03:10Z", "url": "https://github.com/apache/incubator-doris/pull/4771", "merged": true, "mergeCommit": {"oid": "80d5f6e3d86364e81c0a5c2ffbc4549aacbd9d1d"}, "closed": true, "closedAt": "2020-11-03T12:23:49Z", "author": {"login": "vagetablechicken"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUUys0AH2gAyNTA2NjEyNDczOmRkMWQ3OGIxYjE4ZjhlZTIxYjE3NmQ2ZTNjNzc1Yzc2Y2VhNTc1NmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY3lZxgFqTUyMjQxMTMyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dd1d78b1b18f8ee21b176d6e3c775c76cea5756d", "author": {"user": {"login": "vagetablechicken", "name": "HuangWei"}}, "url": "https://github.com/apache/incubator-doris/commit/dd1d78b1b18f8ee21b176d6e3c775c76cea5756d", "committedDate": "2020-10-20T08:49:12Z", "message": "[] base rebalancer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a91d931f6eae1873ed148c53411f6b867ae3421c", "author": {"user": {"login": "vagetablechicken", "name": "HuangWei"}}, "url": "https://github.com/apache/incubator-doris/commit/a91d931f6eae1873ed148c53411f6b867ae3421c", "committedDate": "2020-10-20T09:05:06Z", "message": "[] fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fe4ec93ace75e9b76fc9cdca9ddea2c95a4ec54", "author": {"user": {"login": "vagetablechicken", "name": "HuangWei"}}, "url": "https://github.com/apache/incubator-doris/commit/8fe4ec93ace75e9b76fc9cdca9ddea2c95a4ec54", "committedDate": "2020-10-20T09:46:45Z", "message": "[] fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c543d2d34f6ec07640114f3ada72d284e1e4f0c", "author": {"user": {"login": "vagetablechicken", "name": "HuangWei"}}, "url": "https://github.com/apache/incubator-doris/commit/8c543d2d34f6ec07640114f3ada72d284e1e4f0c", "committedDate": "2020-10-20T09:54:17Z", "message": "[] fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49b06d572541359eb667dfb6e8eb4a116fa02075", "author": {"user": {"login": "vagetablechicken", "name": "HuangWei"}}, "url": "https://github.com/apache/incubator-doris/commit/49b06d572541359eb667dfb6e8eb4a116fa02075", "committedDate": "2020-10-20T10:43:08Z", "message": "[] fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0Njk1MTI3", "url": "https://github.com/apache/incubator-doris/pull/4771#pullrequestreview-514695127", "createdAt": "2020-10-22T12:57:35Z", "commit": {"oid": "49b06d572541359eb667dfb6e8eb4a116fa02075"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMjo1NzozNVrOHmgZ4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMjo1NzozNVrOHmgZ4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEzODg0OA==", "bodyText": "For current scheduler principal, a tablet can only have one task running or pending at most. So we should delete the cache as soon as possible. It is better to change this function to getAndDeleteCachedSrcBackendId. And call it after scheduler cancelled, task running cancelled, and deleteSrcReplicaOfLB.", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r510138848", "createdAt": "2020-10-22T12:57:35Z", "author": {"login": "gengjun-git"}, "path": "fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.clone;\n+\n+import org.apache.doris.catalog.TabletInvertedIndex;\n+import org.apache.doris.clone.TabletScheduler.PathSlot;\n+import org.apache.doris.system.SystemInfoService;\n+import org.apache.doris.task.AgentBatchTask;\n+import org.apache.doris.thrift.TStorageMedium;\n+\n+import com.google.common.collect.Lists;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+/*\n+ * Rebalancer is responsible for\n+ * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n+ * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n+ * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n+ * 3. getCachedSrcBackendId: if the rebalance strategy wants to delete the replica of a specified be,\n+ * override this func.\n+ * NOTICE:\n+ * It may have a long interval between selectAlternativeTablets() & createBalanceTask(). So the concrete moves may be\n+ * invalid when we createBalanceTask(), you should check the moves' validation.\n+ */\n+public abstract class Rebalancer {\n+    // When Rebalancer init, the statisticMap is usually empty. So it's no need to be an arg.\n+    // Only use updateLoadStatistic() to load stats.\n+    protected Map<String, ClusterLoadStatistic> statisticMap = new HashMap<>();\n+    protected TabletInvertedIndex invertedIndex;\n+    protected SystemInfoService infoService;\n+\n+    public Rebalancer(SystemInfoService infoService, TabletInvertedIndex invertedIndex) {\n+        this.infoService = infoService;\n+        this.invertedIndex = invertedIndex;\n+    }\n+\n+    public List<TabletSchedCtx> selectAlternativeTablets() {\n+        List<TabletSchedCtx> alternativeTablets = Lists.newArrayList();\n+        for (Map.Entry<String, ClusterLoadStatistic> entry : statisticMap.entrySet()) {\n+            for (TStorageMedium medium : TStorageMedium.values()) {\n+                alternativeTablets.addAll(selectAlternativeTabletsForCluster(entry.getKey(),\n+                        entry.getValue(), medium));\n+            }\n+        }\n+        return alternativeTablets;\n+    }\n+\n+    protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n+            String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n+\n+    public abstract void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n+                                           AgentBatchTask batchTask) throws SchedException;\n+\n+    public Long getCachedSrcBackendId(Long tabletId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49b06d572541359eb667dfb6e8eb4a116fa02075"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NDIxMjU1", "url": "https://github.com/apache/incubator-doris/pull/4771#pullrequestreview-519421255", "createdAt": "2020-10-29T08:17:44Z", "commit": {"oid": "49b06d572541359eb667dfb6e8eb4a116fa02075"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwODoxNzo0NFrOHqQosw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwODoyMjoxMVrOHqQy7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NDgwMw==", "bodyText": "For a  general balance interface.  method name getCachedSrcBackendId is not very clear.   delete the replica of a specified be in  getCachedSrcBackendId is also strange.", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514074803", "createdAt": "2020-10-29T08:17:44Z", "author": {"login": "kangkaisen"}, "path": "fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.clone;\n+\n+import org.apache.doris.catalog.TabletInvertedIndex;\n+import org.apache.doris.clone.TabletScheduler.PathSlot;\n+import org.apache.doris.system.SystemInfoService;\n+import org.apache.doris.task.AgentBatchTask;\n+import org.apache.doris.thrift.TStorageMedium;\n+\n+import com.google.common.collect.Lists;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+/*\n+ * Rebalancer is responsible for\n+ * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n+ * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n+ * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n+ * 3. getCachedSrcBackendId: if the rebalance strategy wants to delete the replica of a specified be,\n+ * override this func.\n+ * NOTICE:\n+ * It may have a long interval between selectAlternativeTablets() & createBalanceTask(). So the concrete moves may be\n+ * invalid when we createBalanceTask(), you should check the moves' validation.\n+ */\n+public abstract class Rebalancer {\n+    // When Rebalancer init, the statisticMap is usually empty. So it's no need to be an arg.\n+    // Only use updateLoadStatistic() to load stats.\n+    protected Map<String, ClusterLoadStatistic> statisticMap = new HashMap<>();\n+    protected TabletInvertedIndex invertedIndex;\n+    protected SystemInfoService infoService;\n+\n+    public Rebalancer(SystemInfoService infoService, TabletInvertedIndex invertedIndex) {\n+        this.infoService = infoService;\n+        this.invertedIndex = invertedIndex;\n+    }\n+\n+    public List<TabletSchedCtx> selectAlternativeTablets() {\n+        List<TabletSchedCtx> alternativeTablets = Lists.newArrayList();\n+        for (Map.Entry<String, ClusterLoadStatistic> entry : statisticMap.entrySet()) {\n+            for (TStorageMedium medium : TStorageMedium.values()) {\n+                alternativeTablets.addAll(selectAlternativeTabletsForCluster(entry.getKey(),\n+                        entry.getValue(), medium));\n+            }\n+        }\n+        return alternativeTablets;\n+    }\n+\n+    protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n+            String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n+\n+    public abstract void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n+                                           AgentBatchTask batchTask) throws SchedException;\n+\n+    public Long getCachedSrcBackendId(Long tabletId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49b06d572541359eb667dfb6e8eb4a116fa02075"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NzQyMg==", "bodyText": "For a balance, the core strategy is how to choose which tablet, choose src backend, choose dest backend. But I don't see the interface about how to choose dest backend.", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514077422", "createdAt": "2020-10-29T08:22:11Z", "author": {"login": "kangkaisen"}, "path": "fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.clone;\n+\n+import org.apache.doris.catalog.TabletInvertedIndex;\n+import org.apache.doris.clone.TabletScheduler.PathSlot;\n+import org.apache.doris.system.SystemInfoService;\n+import org.apache.doris.task.AgentBatchTask;\n+import org.apache.doris.thrift.TStorageMedium;\n+\n+import com.google.common.collect.Lists;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+/*\n+ * Rebalancer is responsible for\n+ * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n+ * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n+ * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n+ * 3. getCachedSrcBackendId: if the rebalance strategy wants to delete the replica of a specified be,\n+ * override this func.\n+ * NOTICE:\n+ * It may have a long interval between selectAlternativeTablets() & createBalanceTask(). So the concrete moves may be\n+ * invalid when we createBalanceTask(), you should check the moves' validation.\n+ */\n+public abstract class Rebalancer {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49b06d572541359eb667dfb6e8eb4a116fa02075"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NDI1ODk1", "url": "https://github.com/apache/incubator-doris/pull/4771#pullrequestreview-519425895", "createdAt": "2020-10-29T08:24:37Z", "commit": {"oid": "49b06d572541359eb667dfb6e8eb4a116fa02075"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwODoyNDozN1rOHqQ4VA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwODoyNDozN1rOHqQ4VA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3ODgwNA==", "bodyText": "What's the meaning of LB \uff1f", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514078804", "createdAt": "2020-10-29T08:24:37Z", "author": {"login": "kangkaisen"}, "path": "fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java", "diffHunk": "@@ -826,12 +831,25 @@ private boolean deleteReplicaNotInCluster(TabletSchedCtx tabletCtx, boolean forc\n         return false;\n     }\n \n+    private boolean deleteSrcReplicaOfLB(TabletSchedCtx tabletCtx, boolean force) throws SchedException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49b06d572541359eb667dfb6e8eb4a116fa02075"}, "originalPosition": 144}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e16fbcf49cb24fcdc7d70f2f6d3e7e75b6a5abe", "author": {"user": {"login": "vagetablechicken", "name": "HuangWei"}}, "url": "https://github.com/apache/incubator-doris/commit/4e16fbcf49cb24fcdc7d70f2f6d3e7e75b6a5abe", "committedDate": "2020-10-29T10:35:33Z", "message": "[] fix naming"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3731d4a2f80f6e67fcf1d97d7dc73488cff4fb6b", "author": {"user": {"login": "vagetablechicken", "name": "HuangWei"}}, "url": "https://github.com/apache/incubator-doris/commit/3731d4a2f80f6e67fcf1d97d7dc73488cff4fb6b", "committedDate": "2020-10-30T02:41:02Z", "message": "[] fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNDM4NzE4", "url": "https://github.com/apache/incubator-doris/pull/4771#pullrequestreview-520438718", "createdAt": "2020-10-30T07:54:43Z", "commit": {"oid": "3731d4a2f80f6e67fcf1d97d7dc73488cff4fb6b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNzo1NDo0M1rOHrEZdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNzo1NDo0M1rOHrEZdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyMjg3MA==", "bodyText": "I don't understand why we need to delete the src replica of rebalance?", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514922870", "createdAt": "2020-10-30T07:54:43Z", "author": {"login": "kangkaisen"}, "path": "fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java", "diffHunk": "@@ -826,12 +832,25 @@ private boolean deleteReplicaNotInCluster(TabletSchedCtx tabletCtx, boolean forc\n         return false;\n     }\n \n+    private boolean deleteReplicaChosenByRebalancer(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n+        Long id = rebalancer.getSrcReplicaId(tabletCtx.getTabletId());\n+        if (id == -1L) {\n+            return false;\n+        }\n+        Replica chosenReplica = tabletCtx.getTablet().getReplicaById(id);\n+        if (chosenReplica != null) {\n+            deleteReplicaInternal(tabletCtx, chosenReplica, \"src replica of rebalance\", force);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3731d4a2f80f6e67fcf1d97d7dc73488cff4fb6b"}, "originalPosition": 161}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ee5cd1d3f855707967a4dad5da544df0e133577", "author": {"user": {"login": "vagetablechicken", "name": "HuangWei"}}, "url": "https://github.com/apache/incubator-doris/commit/4ee5cd1d3f855707967a4dad5da544df0e133577", "committedDate": "2020-11-02T03:50:45Z", "message": "[] add completePlan & comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "311204ccbfb6989c8626729d1ef157e5a6ddea94", "author": {"user": {"login": "vagetablechicken", "name": "HuangWei"}}, "url": "https://github.com/apache/incubator-doris/commit/311204ccbfb6989c8626729d1ef157e5a6ddea94", "committedDate": "2020-11-02T03:57:07Z", "message": "[] comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMzQ4MTE5", "url": "https://github.com/apache/incubator-doris/pull/4771#pullrequestreview-521348119", "createdAt": "2020-11-02T05:59:58Z", "commit": {"oid": "311204ccbfb6989c8626729d1ef157e5a6ddea94"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwNTo1OTo1OFrOHr3I5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwNTo1OTo1OFrOHr3I5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc1NDIxMg==", "bodyText": "In the whole FE balance module, we don't use Plan. So I think we could rename it to completeSchedCtx?", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r515754212", "createdAt": "2020-11-02T05:59:58Z", "author": {"login": "kangkaisen"}, "path": "fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java", "diffHunk": "@@ -0,0 +1,96 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.clone;\n+\n+import org.apache.doris.catalog.TabletInvertedIndex;\n+import org.apache.doris.clone.TabletScheduler.PathSlot;\n+import org.apache.doris.system.SystemInfoService;\n+import org.apache.doris.task.AgentBatchTask;\n+import org.apache.doris.thrift.TStorageMedium;\n+\n+import com.google.common.collect.Lists;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+/*\n+ * Rebalancer is responsible for\n+ * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n+ * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n+ * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n+ * 3. getToDeleteReplicaId: if the rebalance strategy wants to delete the specified replica,\n+ * override this func to let TabletScheduler know in handling redundant replica.\n+ * NOTICE:\n+ * 1. Adding the selected tablets by TabletScheduler may not succeed at all. And the move may be failed in some other places.\n+ * So the thing you need to know is, Rebalancer cannot know when the move is failed.\n+ * 2. If you want to make sure the move is succeed, you can assume that it's succeed when getToDeleteReplicaId called.\n+ */\n+public abstract class Rebalancer {\n+    // When Rebalancer init, the statisticMap is usually empty. So it's no need to be an arg.\n+    // Only use updateLoadStatistic() to load stats.\n+    protected Map<String, ClusterLoadStatistic> statisticMap = new HashMap<>();\n+    protected TabletInvertedIndex invertedIndex;\n+    protected SystemInfoService infoService;\n+\n+    public Rebalancer(SystemInfoService infoService, TabletInvertedIndex invertedIndex) {\n+        this.infoService = infoService;\n+        this.invertedIndex = invertedIndex;\n+    }\n+\n+    public List<TabletSchedCtx> selectAlternativeTablets() {\n+        List<TabletSchedCtx> alternativeTablets = Lists.newArrayList();\n+        for (Map.Entry<String, ClusterLoadStatistic> entry : statisticMap.entrySet()) {\n+            for (TStorageMedium medium : TStorageMedium.values()) {\n+                alternativeTablets.addAll(selectAlternativeTabletsForCluster(entry.getKey(),\n+                        entry.getValue(), medium));\n+            }\n+        }\n+        return alternativeTablets;\n+    }\n+\n+    // The return TabletSchedCtx should have the tablet id at least. {srcReplica, destBe} can be complete here or\n+    // later(when createBalanceTask called).\n+    protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n+            String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n+\n+\n+    public void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n+                                  AgentBatchTask batchTask) throws SchedException {\n+        completePlan(tabletCtx, backendsWorkingSlots);\n+        batchTask.addTask(tabletCtx.createCloneReplicaAndTask());\n+    }\n+\n+    // Before createCloneReplicaAndTask, we need to complete the TabletSchedCtx.\n+    // 1. If you generate {tabletId, srcReplica, destBe} in selectAlternativeTablets(), it may be invalid at\n+    // this point(it may have a long interval between selectAlternativeTablets & createBalanceTask).\n+    // You should check the moves' validation.\n+    // 2. If you want to generate {srcReplica, destBe} here, just do it.\n+    // 3. You should check the path slots of src & dest.\n+    protected abstract void completePlan(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "311204ccbfb6989c8626729d1ef157e5a6ddea94"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bb3ce37b814a5f80141b4f5ab76127971cae20e", "author": {"user": {"login": "vagetablechicken", "name": "HuangWei"}}, "url": "https://github.com/apache/incubator-doris/commit/8bb3ce37b814a5f80141b4f5ab76127971cae20e", "committedDate": "2020-11-02T06:44:10Z", "message": "[] fix naming"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e3c9641954a26747d6140614f026dc808812dc6", "author": {"user": {"login": "vagetablechicken", "name": "HuangWei"}}, "url": "https://github.com/apache/incubator-doris/commit/7e3c9641954a26747d6140614f026dc808812dc6", "committedDate": "2020-11-02T08:52:08Z", "message": "[] fix imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNDkwMDcy", "url": "https://github.com/apache/incubator-doris/pull/4771#pullrequestreview-521490072", "createdAt": "2020-11-02T10:08:52Z", "commit": {"oid": "7e3c9641954a26747d6140614f026dc808812dc6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNDExMzI1", "url": "https://github.com/apache/incubator-doris/pull/4771#pullrequestreview-522411325", "createdAt": "2020-11-03T11:37:03Z", "commit": {"oid": "7e3c9641954a26747d6140614f026dc808812dc6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4781, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}