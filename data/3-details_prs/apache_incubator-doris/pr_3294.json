{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNzkyODg3", "number": 3294, "title": "Use read lock when iterate tablet_map in TabletManager::start_trash_sweep", "bodyText": "For #3299\nIn our cluster, there are many stream load jobs.\nWe found that these jobs slow down periodically.\nBy add logs, we found that TabletManager::start_trash_sweep will take write lock for a long time.\nIn this PR, we split start_trash_sweep in two phases:\nFirst, iterate the tablet map with read lock.\nSecond, remove the empty tablet in map with write lock.", "createdAt": "2020-04-10T07:25:32Z", "url": "https://github.com/apache/incubator-doris/pull/3294", "merged": true, "mergeCommit": {"oid": "be090f5929c3ed866af9a8789b2008ae4dc7e921"}, "closed": true, "closedAt": "2020-04-13T03:18:34Z", "author": {"login": "liutang123"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWLrc9AH2gAyNDAxNzkyODg3OjA5NGFjOTgwYzdiZGZjNTBlYjNlODY4NTI1ZWRkMjNmZDk5NGNkZjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXGLTZgFqTM5MTkzNDg2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "094ac980c7bdfc50eb3e868525edd23fd994cdf0", "author": {"user": {"login": "liutang123", "name": "Lijia Liu"}}, "url": "https://github.com/apache/incubator-doris/commit/094ac980c7bdfc50eb3e868525edd23fd994cdf0", "committedDate": "2020-04-10T07:08:50Z", "message": "Use read lock when iterate tablet_map in TabletManager::start_trash_sweep"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzI0MTU4", "url": "https://github.com/apache/incubator-doris/pull/3294#pullrequestreview-391324158", "createdAt": "2020-04-10T08:13:33Z", "commit": {"oid": "094ac980c7bdfc50eb3e868525edd23fd994cdf0"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzI4MDc4", "url": "https://github.com/apache/incubator-doris/pull/3294#pullrequestreview-391328078", "createdAt": "2020-04-10T08:23:13Z", "commit": {"oid": "094ac980c7bdfc50eb3e868525edd23fd994cdf0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwODoyMzoxNFrOGD0cZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwODoyMzoxNFrOGD0cZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY1ODE1MA==", "bodyText": "You can put tablet->delete_expired_inc_rowsets() between the ReadLock and WriteLock.\nThis is bottleneck which consumes much resource.", "url": "https://github.com/apache/incubator-doris/pull/3294#discussion_r406658150", "createdAt": "2020-04-10T08:23:14Z", "author": {"login": "chaoyli"}, "path": "be/src/olap/tablet_manager.cpp", "diffHunk": "@@ -960,28 +960,36 @@ OLAPStatus TabletManager::start_trash_sweep() {\n     {\n         std::vector<int64_t> tablets_to_clean;\n         for (int32 i = 0; i < _tablet_map_lock_shard_size; i++) {\n-            WriteLock rlock(&_tablet_map_lock_array[i]);\n             tablet_map_t& tablet_map = _tablet_map_array[i];\n-            for (auto& item : tablet_map) {\n-                // try to clean empty item\n-                if (item.second.table_arr.empty()) {\n-                    // try to get schema change lock if could get schema change lock, then nobody\n-                    // own the lock could remove the item\n-                    // it will core if schema change thread may hold the lock and this thread will deconstruct lock\n-                    if (item.second.schema_change_lock.trylock() == OLAP_SUCCESS) {\n-                        item.second.schema_change_lock.unlock();\n+            {\n+                ReadLock r_lock(&_tablet_map_lock_array[i]);\n+                for (auto& item : tablet_map) {\n+                    // try to clean empty item\n+                    if (item.second.table_arr.empty()) {\n                         tablets_to_clean.push_back(item.first);\n                     }\n-                }\n-                for (TabletSharedPtr tablet : item.second.table_arr) {\n-                    tablet->delete_expired_inc_rowsets();\n+                    for (TabletSharedPtr tablet : item.second.table_arr) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "094ac980c7bdfc50eb3e868525edd23fd994cdf0"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aeb76ddb9ad94043e4321b91a61eea596f9c9b18", "author": {"user": {"login": "liutang123", "name": "Lijia Liu"}}, "url": "https://github.com/apache/incubator-doris/commit/aeb76ddb9ad94043e4321b91a61eea596f9c9b18", "committedDate": "2020-04-12T09:20:13Z", "message": "Do delete_expired_inc_rowsets out of read lock."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxODYyODk1", "url": "https://github.com/apache/incubator-doris/pull/3294#pullrequestreview-391862895", "createdAt": "2020-04-12T14:26:48Z", "commit": {"oid": "aeb76ddb9ad94043e4321b91a61eea596f9c9b18"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxOTI4NjE1", "url": "https://github.com/apache/incubator-doris/pull/3294#pullrequestreview-391928615", "createdAt": "2020-04-13T02:44:45Z", "commit": {"oid": "aeb76ddb9ad94043e4321b91a61eea596f9c9b18"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxOTM0ODYw", "url": "https://github.com/apache/incubator-doris/pull/3294#pullrequestreview-391934860", "createdAt": "2020-04-13T03:18:07Z", "commit": {"oid": "aeb76ddb9ad94043e4321b91a61eea596f9c9b18"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3209, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}