{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3Nzk4MjUz", "number": 3775, "reviewThreads": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMTozMjoxN1rOEC64Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMjozMzowNVrOFAx3wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDk3MjI2OnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMTozMjoxN1rOGfq3nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMTo0MDo1N1rOGfrGMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg2MTQwNA==", "bodyText": "Could use getTableOrThrowException", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r435861404", "createdAt": "2020-06-05T11:32:17Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -118,30 +118,30 @@ public void processDropMaterializedView(DropMaterializedViewStmt stmt) throws Dd\n             ErrorReport.reportDdlException(ErrorCode.ERR_BAD_DB_ERROR, dbName);\n         }\n \n-        db.writeLock();\n+        String tableName = stmt.getTableName().getTbl();\n+        Table table = db.getTable(tableName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9e9d8279a9ee1c664f26d6679ed0268f854aabf"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg2NTEzOA==", "bodyText": "Here should throw userException or try and catch then throw ddl exception because we need some detailed error message?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r435865138", "createdAt": "2020-06-05T11:40:57Z", "author": {"login": "caiconghui"}, "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -118,30 +118,30 @@ public void processDropMaterializedView(DropMaterializedViewStmt stmt) throws Dd\n             ErrorReport.reportDdlException(ErrorCode.ERR_BAD_DB_ERROR, dbName);\n         }\n \n-        db.writeLock();\n+        String tableName = stmt.getTableName().getTbl();\n+        Table table = db.getTable(tableName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg2MTQwNA=="}, "originalCommit": {"oid": "e9e9d8279a9ee1c664f26d6679ed0268f854aabf"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDk4NjQyOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMTozNzo0NlrOGfrAsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMTozNzo0NlrOGfrAsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg2MzczMA==", "bodyText": "Could use getTableOrThrowException", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r435863730", "createdAt": "2020-06-05T11:37:46Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -169,18 +169,19 @@ public void processAlterTable(AlterTableStmt stmt) throws UserException {\n         // some operations will take long time to process, need to be done outside the databse lock\n         boolean needProcessOutsideDatabaseLock = false;\n         String tableName = dbTableName.getTbl();\n-        db.writeLock();\n-        try {\n-            Table table = db.getTable(tableName);\n-            if (table == null) {\n-                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n-            }\n \n-            if (table.getType() != TableType.OLAP) {\n-                throw new DdlException(\"Do not support alter non-OLAP table[\" + tableName + \"]\");\n-            }\n-            OlapTable olapTable = (OlapTable) table;\n+        Table table = db.getTable(tableName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9e9d8279a9ee1c664f26d6679ed0268f854aabf"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDk4OTkzOnYy", "diffSide": "RIGHT", "path": "fe/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMTozOTowN1rOGfrDAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMTo1NTowNVrOGfrenQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg2NDMyMg==", "bodyText": "Why don't add the table lock\uff1f", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r435864322", "createdAt": "2020-06-05T11:39:07Z", "author": {"login": "kangkaisen"}, "path": "fe/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -1015,13 +1017,8 @@ private void runOldAlterJob() {\n                 continue;\n             }\n \n-            db.writeLock();\n-            try {\n-                OlapTable olapTable = (OlapTable) db.getTable(rollupJob.getTableId());\n-                rollupJob.cancel(olapTable, \"cancelled\");\n-            } finally {\n-                db.writeUnlock();\n-            }\n+            OlapTable olapTable = (OlapTable) db.getTable(rollupJob.getTableId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9e9d8279a9ee1c664f26d6679ed0268f854aabf"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg3MTM4OQ==", "bodyText": "because olap table could be null, so I add write lock in the cancel function\nif (olapTable != null) {\nolapTable.writeLock();\ntry {\nPreconditions.checkState(olapTable.getId() == tableId);\nfor (Partition partition : olapTable.getPartitions()) {\nif (partition.getState() == PartitionState.ROLLUP) {\npartition.setState(PartitionState.NORMAL);\n}\n}\n            if (olapTable.getState() == OlapTableState.ROLLUP) {\n                olapTable.setState(OlapTableState.NORMAL);\n            }\n        } finally {\n            olapTable.writeUnlock();\n        }\n    }", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r435871389", "createdAt": "2020-06-05T11:55:05Z", "author": {"login": "caiconghui"}, "path": "fe/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -1015,13 +1017,8 @@ private void runOldAlterJob() {\n                 continue;\n             }\n \n-            db.writeLock();\n-            try {\n-                OlapTable olapTable = (OlapTable) db.getTable(rollupJob.getTableId());\n-                rollupJob.cancel(olapTable, \"cancelled\");\n-            } finally {\n-                db.writeUnlock();\n-            }\n+            OlapTable olapTable = (OlapTable) db.getTable(rollupJob.getTableId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg2NDMyMg=="}, "originalCommit": {"oid": "e9e9d8279a9ee1c664f26d6679ed0268f854aabf"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNTk5OTI2OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMTo0NzoxN1rOH5vyhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOTowODo0NlrOH62SOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxMzg2Mw==", "bodyText": "Missing if (olapTable.getState() != OlapTableState.NORMAL) { check?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530313863", "createdAt": "2020-11-25T11:47:17Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -128,30 +124,10 @@ public void processDropMaterializedView(DropMaterializedViewStmt stmt) throws Dd\n             ErrorReport.reportDdlException(ErrorCode.ERR_BAD_DB_ERROR, dbName);\n         }\n \n-        db.writeLock();\n-        try {\n-            String tableName = stmt.getTableName().getTbl();\n-            Table table = db.getTable(tableName);\n-            // if table exists\n-            if (table == null) {\n-                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n-            }\n-            // check table type\n-            if (table.getType() != TableType.OLAP) {\n-                throw new DdlException(\"Do not support non-OLAP table [\" + tableName + \"] when drop materialized view\");\n-            }\n-            // check table state\n-            OlapTable olapTable = (OlapTable) table;\n-            if (olapTable.getState() != OlapTableState.NORMAL) {\n-                throw new DdlException(\"Table[\" + table.getName() + \"]'s state is not NORMAL. \"\n-                        + \"Do not allow doing DROP ops\");\n-            }\n-            // drop materialized view\n-            ((MaterializedViewHandler)materializedViewHandler).processDropMaterializedView(stmt, db, olapTable);\n-\n-        } finally {\n-            db.writeUnlock();\n-        }\n+        String tableName = stmt.getTableName().getTbl();\n+        OlapTable olapTable = (OlapTable) db.getTableOrThrowException(tableName, TableType.OLAP);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ2ODg1Ng==", "bodyText": "processDropMaterializedView has check table state operation", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531468856", "createdAt": "2020-11-27T09:08:46Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -128,30 +124,10 @@ public void processDropMaterializedView(DropMaterializedViewStmt stmt) throws Dd\n             ErrorReport.reportDdlException(ErrorCode.ERR_BAD_DB_ERROR, dbName);\n         }\n \n-        db.writeLock();\n-        try {\n-            String tableName = stmt.getTableName().getTbl();\n-            Table table = db.getTable(tableName);\n-            // if table exists\n-            if (table == null) {\n-                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n-            }\n-            // check table type\n-            if (table.getType() != TableType.OLAP) {\n-                throw new DdlException(\"Do not support non-OLAP table [\" + tableName + \"] when drop materialized view\");\n-            }\n-            // check table state\n-            OlapTable olapTable = (OlapTable) table;\n-            if (olapTable.getState() != OlapTableState.NORMAL) {\n-                throw new DdlException(\"Table[\" + table.getName() + \"]'s state is not NORMAL. \"\n-                        + \"Do not allow doing DROP ops\");\n-            }\n-            // drop materialized view\n-            ((MaterializedViewHandler)materializedViewHandler).processDropMaterializedView(stmt, db, olapTable);\n-\n-        } finally {\n-            db.writeUnlock();\n-        }\n+        String tableName = stmt.getTableName().getTbl();\n+        OlapTable olapTable = (OlapTable) db.getTableOrThrowException(tableName, TableType.OLAP);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxMzg2Mw=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjAzMjc3OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMTo1NjoxNlrOH5wGTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOTo0MjowN1rOH63apQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxODkyNw==", "bodyText": "I think we can just lock the table outside the switch, avoid call lock/unlock everywhere inside the processAlterOlapTable and processAlterExternalTable.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530318927", "createdAt": "2020-11-25T11:56:16Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -232,54 +223,61 @@ private void processAlterExternalTable(AlterTableStmt stmt, Table externalTable,\n         List<AlterClause> alterClauses = stmt.getOps();\n         AlterOperations currentAlterOps = new AlterOperations();\n         currentAlterOps.checkConflict(alterClauses);\n-\n         if (currentAlterOps.hasRenameOp()) {\n             processRename(db, externalTable, alterClauses);\n         } else if (currentAlterOps.hasSchemaChangeOp()) {\n-            schemaChangeHandler.processExternalTable(alterClauses, db, externalTable);\n+            externalTable.writeLock();\n+            try {\n+                schemaChangeHandler.processExternalTable(alterClauses, db, externalTable);\n+            } finally {\n+                externalTable.writeUnlock();\n+            }\n         }\n     }\n \n     public void processAlterTable(AlterTableStmt stmt) throws UserException {\n         TableName dbTableName = stmt.getTbl();\n         String dbName = dbTableName.getDb();\n+        String tableName = dbTableName.getTbl();\n         final String clusterName = stmt.getClusterName();\n \n         Database db = Catalog.getCurrentCatalog().getDb(dbName);\n         if (db == null) {\n             ErrorReport.reportDdlException(ErrorCode.ERR_BAD_DB_ERROR, dbName);\n         }\n+        Table table = db.getTable(tableName);\n+        if (table == null) {\n+            ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n+        }\n         List<AlterClause> alterClauses = Lists.newArrayList();\n+        // some operations will take long time to process, need to be done outside the table lock\n+        boolean needProcessOutsideTableLock = false;\n \n-        // some operations will take long time to process, need to be done outside the database lock\n-        boolean needProcessOutsideDatabaseLock = false;\n-        String tableName = dbTableName.getTbl();\n-        db.writeLock();\n-        try {\n-            Table table = db.getTable(tableName);\n-            if (table == null) {\n-                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n-            }\n+        // check conflict alter ops first\n+        AlterOperations currentAlterOps = new AlterOperations();\n+        currentAlterOps.checkConflict(alterClauses);\n+        // check cluster capacity and db quota outside table lock to escape dead lock, only need to check once.\n+        if (currentAlterOps.needCheckCapacity()) {\n+            Catalog.getCurrentSystemInfo().checkClusterCapacity(clusterName);\n+            db.checkQuota();\n+        }\n \n-            switch (table.getType()) {\n-                case OLAP:\n-                    OlapTable olapTable = (OlapTable) table;\n-                    needProcessOutsideDatabaseLock = processAlterOlapTable(stmt, olapTable, alterClauses, clusterName, db);\n-                    break;\n-                case ODBC:\n-                case MYSQL:\n-                case ELASTICSEARCH:\n-                    processAlterExternalTable(stmt, table, db);\n-                    return;\n-                default:\n-                    throw new DdlException(\"Do not support alter \" + table.getType().toString() + \" table[\" + tableName + \"]\");\n-            }\n-        } finally {\n-            db.writeUnlock();\n+        switch (table.getType()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 238}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ4NzM5Nw==", "bodyText": "some function need db lock and table lock but some function only need table lock, what't more, If the nesting function is too deep\uff0c it is easy to repeat locking\uff0c if we lock small scope for modificaion\uff0c which will be more clear although we may write many lock code", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531487397", "createdAt": "2020-11-27T09:42:07Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -232,54 +223,61 @@ private void processAlterExternalTable(AlterTableStmt stmt, Table externalTable,\n         List<AlterClause> alterClauses = stmt.getOps();\n         AlterOperations currentAlterOps = new AlterOperations();\n         currentAlterOps.checkConflict(alterClauses);\n-\n         if (currentAlterOps.hasRenameOp()) {\n             processRename(db, externalTable, alterClauses);\n         } else if (currentAlterOps.hasSchemaChangeOp()) {\n-            schemaChangeHandler.processExternalTable(alterClauses, db, externalTable);\n+            externalTable.writeLock();\n+            try {\n+                schemaChangeHandler.processExternalTable(alterClauses, db, externalTable);\n+            } finally {\n+                externalTable.writeUnlock();\n+            }\n         }\n     }\n \n     public void processAlterTable(AlterTableStmt stmt) throws UserException {\n         TableName dbTableName = stmt.getTbl();\n         String dbName = dbTableName.getDb();\n+        String tableName = dbTableName.getTbl();\n         final String clusterName = stmt.getClusterName();\n \n         Database db = Catalog.getCurrentCatalog().getDb(dbName);\n         if (db == null) {\n             ErrorReport.reportDdlException(ErrorCode.ERR_BAD_DB_ERROR, dbName);\n         }\n+        Table table = db.getTable(tableName);\n+        if (table == null) {\n+            ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n+        }\n         List<AlterClause> alterClauses = Lists.newArrayList();\n+        // some operations will take long time to process, need to be done outside the table lock\n+        boolean needProcessOutsideTableLock = false;\n \n-        // some operations will take long time to process, need to be done outside the database lock\n-        boolean needProcessOutsideDatabaseLock = false;\n-        String tableName = dbTableName.getTbl();\n-        db.writeLock();\n-        try {\n-            Table table = db.getTable(tableName);\n-            if (table == null) {\n-                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n-            }\n+        // check conflict alter ops first\n+        AlterOperations currentAlterOps = new AlterOperations();\n+        currentAlterOps.checkConflict(alterClauses);\n+        // check cluster capacity and db quota outside table lock to escape dead lock, only need to check once.\n+        if (currentAlterOps.needCheckCapacity()) {\n+            Catalog.getCurrentSystemInfo().checkClusterCapacity(clusterName);\n+            db.checkQuota();\n+        }\n \n-            switch (table.getType()) {\n-                case OLAP:\n-                    OlapTable olapTable = (OlapTable) table;\n-                    needProcessOutsideDatabaseLock = processAlterOlapTable(stmt, olapTable, alterClauses, clusterName, db);\n-                    break;\n-                case ODBC:\n-                case MYSQL:\n-                case ELASTICSEARCH:\n-                    processAlterExternalTable(stmt, table, db);\n-                    return;\n-                default:\n-                    throw new DdlException(\"Do not support alter \" + table.getType().toString() + \" table[\" + tableName + \"]\");\n-            }\n-        } finally {\n-            db.writeUnlock();\n+        switch (table.getType()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxODkyNw=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 238}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjA0OTk4OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMjowMDo1MlrOH5wQew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOTozOTowOVrOH63UHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyMTUzMQ==", "bodyText": "Better put these locks inside the renameTable method.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530321531", "createdAt": "2020-11-25T12:00:52Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -476,27 +464,48 @@ public void processAlterCluster(AlterSystemStmt stmt) throws UserException {\n     private void processRename(Database db, OlapTable table, List<AlterClause> alterClauses) throws DdlException {\n         for (AlterClause alterClause : alterClauses) {\n             if (alterClause instanceof TableRenameClause) {\n-                Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof RollupRenameClause) {\n-                Catalog.getCurrentCatalog().renameRollup(db, table, (RollupRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof PartitionRenameClause) {\n-                Catalog.getCurrentCatalog().renamePartition(db, table, (PartitionRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof ColumnRenameClause) {\n-                Catalog.getCurrentCatalog().renameColumn(db, table, (ColumnRenameClause) alterClause);\n+                db.writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 424}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ4NTcyNQ==", "bodyText": "done", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531485725", "createdAt": "2020-11-27T09:39:09Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -476,27 +464,48 @@ public void processAlterCluster(AlterSystemStmt stmt) throws UserException {\n     private void processRename(Database db, OlapTable table, List<AlterClause> alterClauses) throws DdlException {\n         for (AlterClause alterClause : alterClauses) {\n             if (alterClause instanceof TableRenameClause) {\n-                Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof RollupRenameClause) {\n-                Catalog.getCurrentCatalog().renameRollup(db, table, (RollupRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof PartitionRenameClause) {\n-                Catalog.getCurrentCatalog().renamePartition(db, table, (PartitionRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof ColumnRenameClause) {\n-                Catalog.getCurrentCatalog().renameColumn(db, table, (ColumnRenameClause) alterClause);\n+                db.writeLock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyMTUzMQ=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 424}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjA1MTA5OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMjowMTowOVrOH5wRHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOTozOTowM1rOH63T9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyMTY5NQ==", "bodyText": "Put lock inside the method", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530321695", "createdAt": "2020-11-25T12:01:09Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -476,27 +464,48 @@ public void processAlterCluster(AlterSystemStmt stmt) throws UserException {\n     private void processRename(Database db, OlapTable table, List<AlterClause> alterClauses) throws DdlException {\n         for (AlterClause alterClause : alterClauses) {\n             if (alterClause instanceof TableRenameClause) {\n-                Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof RollupRenameClause) {\n-                Catalog.getCurrentCatalog().renameRollup(db, table, (RollupRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof PartitionRenameClause) {\n-                Catalog.getCurrentCatalog().renamePartition(db, table, (PartitionRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof ColumnRenameClause) {\n-                Catalog.getCurrentCatalog().renameColumn(db, table, (ColumnRenameClause) alterClause);\n+                db.writeLock();\n+                table.writeLock();\n+                try {\n+                    Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n+                } finally {\n+                    table.writeUnlock();\n+                    db.writeUnlock();\n+                }\n                 break;\n             } else {\n-                Preconditions.checkState(false);\n+                table.writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 435}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ4NTY4NA==", "bodyText": "done", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531485684", "createdAt": "2020-11-27T09:39:03Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -476,27 +464,48 @@ public void processAlterCluster(AlterSystemStmt stmt) throws UserException {\n     private void processRename(Database db, OlapTable table, List<AlterClause> alterClauses) throws DdlException {\n         for (AlterClause alterClause : alterClauses) {\n             if (alterClause instanceof TableRenameClause) {\n-                Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof RollupRenameClause) {\n-                Catalog.getCurrentCatalog().renameRollup(db, table, (RollupRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof PartitionRenameClause) {\n-                Catalog.getCurrentCatalog().renamePartition(db, table, (PartitionRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof ColumnRenameClause) {\n-                Catalog.getCurrentCatalog().renameColumn(db, table, (ColumnRenameClause) alterClause);\n+                db.writeLock();\n+                table.writeLock();\n+                try {\n+                    Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n+                } finally {\n+                    table.writeUnlock();\n+                    db.writeUnlock();\n+                }\n                 break;\n             } else {\n-                Preconditions.checkState(false);\n+                table.writeLock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyMTY5NQ=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 435}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjA1MjYxOnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMjowMTozNFrOH5wSDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOTozODo1OVrOH63Txw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyMTkzNQ==", "bodyText": "Put lock inside the method", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530321935", "createdAt": "2020-11-25T12:01:34Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -476,27 +464,48 @@ public void processAlterCluster(AlterSystemStmt stmt) throws UserException {\n     private void processRename(Database db, OlapTable table, List<AlterClause> alterClauses) throws DdlException {\n         for (AlterClause alterClause : alterClauses) {\n             if (alterClause instanceof TableRenameClause) {\n-                Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof RollupRenameClause) {\n-                Catalog.getCurrentCatalog().renameRollup(db, table, (RollupRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof PartitionRenameClause) {\n-                Catalog.getCurrentCatalog().renamePartition(db, table, (PartitionRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof ColumnRenameClause) {\n-                Catalog.getCurrentCatalog().renameColumn(db, table, (ColumnRenameClause) alterClause);\n+                db.writeLock();\n+                table.writeLock();\n+                try {\n+                    Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n+                } finally {\n+                    table.writeUnlock();\n+                    db.writeUnlock();\n+                }\n                 break;\n             } else {\n-                Preconditions.checkState(false);\n+                table.writeLock();\n+                try {\n+                    if (alterClause instanceof RollupRenameClause) {\n+                        Catalog.getCurrentCatalog().renameRollup(db, table, (RollupRenameClause) alterClause);\n+                        break;\n+                    } else if (alterClause instanceof PartitionRenameClause) {\n+                        Catalog.getCurrentCatalog().renamePartition(db, table, (PartitionRenameClause) alterClause);\n+                        break;\n+                    } else if (alterClause instanceof ColumnRenameClause) {\n+                        Catalog.getCurrentCatalog().renameColumn(db, table, (ColumnRenameClause) alterClause);\n+                        break;\n+                    } else {\n+                        Preconditions.checkState(false);\n+                    }\n+                } finally {\n+                    table.writeUnlock();\n+                }\n             }\n         }\n     }\n \n     private void processRename(Database db, Table table, List<AlterClause> alterClauses) throws DdlException {\n         for (AlterClause alterClause : alterClauses) {\n             if (alterClause instanceof TableRenameClause) {\n-                Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n+                db.writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 460}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ4NTYzOQ==", "bodyText": "done", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531485639", "createdAt": "2020-11-27T09:38:59Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/Alter.java", "diffHunk": "@@ -476,27 +464,48 @@ public void processAlterCluster(AlterSystemStmt stmt) throws UserException {\n     private void processRename(Database db, OlapTable table, List<AlterClause> alterClauses) throws DdlException {\n         for (AlterClause alterClause : alterClauses) {\n             if (alterClause instanceof TableRenameClause) {\n-                Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof RollupRenameClause) {\n-                Catalog.getCurrentCatalog().renameRollup(db, table, (RollupRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof PartitionRenameClause) {\n-                Catalog.getCurrentCatalog().renamePartition(db, table, (PartitionRenameClause) alterClause);\n-                break;\n-            } else if (alterClause instanceof ColumnRenameClause) {\n-                Catalog.getCurrentCatalog().renameColumn(db, table, (ColumnRenameClause) alterClause);\n+                db.writeLock();\n+                table.writeLock();\n+                try {\n+                    Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n+                } finally {\n+                    table.writeUnlock();\n+                    db.writeUnlock();\n+                }\n                 break;\n             } else {\n-                Preconditions.checkState(false);\n+                table.writeLock();\n+                try {\n+                    if (alterClause instanceof RollupRenameClause) {\n+                        Catalog.getCurrentCatalog().renameRollup(db, table, (RollupRenameClause) alterClause);\n+                        break;\n+                    } else if (alterClause instanceof PartitionRenameClause) {\n+                        Catalog.getCurrentCatalog().renamePartition(db, table, (PartitionRenameClause) alterClause);\n+                        break;\n+                    } else if (alterClause instanceof ColumnRenameClause) {\n+                        Catalog.getCurrentCatalog().renameColumn(db, table, (ColumnRenameClause) alterClause);\n+                        break;\n+                    } else {\n+                        Preconditions.checkState(false);\n+                    }\n+                } finally {\n+                    table.writeUnlock();\n+                }\n             }\n         }\n     }\n \n     private void processRename(Database db, Table table, List<AlterClause> alterClauses) throws DdlException {\n         for (AlterClause alterClause : alterClauses) {\n             if (alterClause instanceof TableRenameClause) {\n-                Catalog.getCurrentCatalog().renameTable(db, table, (TableRenameClause) alterClause);\n+                db.writeLock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyMTkzNQ=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 460}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjA4ODQ2OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMjoxMTo1NlrOH5wn4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOTowOToxOFrOH62TaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyNzUyMA==", "bodyText": "Why lock again?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530327520", "createdAt": "2020-11-25T12:11:56Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -722,14 +732,21 @@ public void processBatchDropRollup(List<AlterClause> dropRollupClauses, Database\n             editLog.logBatchDropRollup(new BatchDropInfo(dbId, tableId, indexIdSet));\n             LOG.info(\"finished drop rollup index[{}] in table[{}]\", String.join(\"\", rollupNameSet), olapTable.getName());\n         } finally {\n-            db.writeUnlock();\n+            olapTable.writeUnlock();\n         }\n     }\n \n     public void processDropMaterializedView(DropMaterializedViewStmt dropMaterializedViewStmt, Database db,\n             OlapTable olapTable) throws DdlException, MetaNotFoundException {\n-        Preconditions.checkState(db.isWriteLockHeldByCurrentThread());\n+        Preconditions.checkState(olapTable.isWriteLockHeldByCurrentThread());\n+        olapTable.writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ2OTE2MQ==", "bodyText": "fix", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531469161", "createdAt": "2020-11-27T09:09:18Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/alter/MaterializedViewHandler.java", "diffHunk": "@@ -722,14 +732,21 @@ public void processBatchDropRollup(List<AlterClause> dropRollupClauses, Database\n             editLog.logBatchDropRollup(new BatchDropInfo(dbId, tableId, indexIdSet));\n             LOG.info(\"finished drop rollup index[{}] in table[{}]\", String.join(\"\", rollupNameSet), olapTable.getName());\n         } finally {\n-            db.writeUnlock();\n+            olapTable.writeUnlock();\n         }\n     }\n \n     public void processDropMaterializedView(DropMaterializedViewStmt dropMaterializedViewStmt, Database db,\n             OlapTable olapTable) throws DdlException, MetaNotFoundException {\n-        Preconditions.checkState(db.isWriteLockHeldByCurrentThread());\n+        Preconditions.checkState(olapTable.isWriteLockHeldByCurrentThread());\n+        olapTable.writeLock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyNzUyMA=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjE1OTg1OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/backup/BackupHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMjozMTo0OVrOH5xT_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOToxMToxN1rOH62XlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMzODgxMg==", "bodyText": "Why not using getOrThrowException?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530338812", "createdAt": "2020-11-25T12:31:49Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/backup/BackupHandler.java", "diffHunk": "@@ -274,25 +274,25 @@ private void backup(Repository repository, Database db, BackupStmt stmt) throws\n         // This is just a pre-check to avoid most of invalid backup requests.\n         // Also calculate the signature for incremental backup check.\n         List<TableRef> tblRefs = stmt.getTableRefs();\n-        BackupMeta curBackupMeta = null;\n-        db.readLock();\n-        try {\n-            List<Table> backupTbls = Lists.newArrayList();\n-            for (TableRef tblRef : tblRefs) {\n-                String tblName = tblRef.getName().getTbl();\n-                Table tbl = db.getTable(tblName);\n-                if (tbl == null) {\n-                    ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tblName);\n-                }\n-                if (tbl.getType() != TableType.OLAP) {\n-                    ErrorReport.reportDdlException(ErrorCode.ERR_NOT_OLAP_TABLE, tblName);\n-                }\n \n-                OlapTable olapTbl = (OlapTable) tbl;\n+        List<Table> backupTbls = Lists.newArrayList();\n+        for (TableRef tblRef : tblRefs) {\n+            String tblName = tblRef.getName().getTbl();\n+            Table tbl = db.getTable(tblName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ3MDIyOA==", "bodyText": "if use getOrThrowException, should cast MetaNotFoundException to DdlException, or should change to much throw exception declaraction from Ddl exception to MetaNotFoundException", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531470228", "createdAt": "2020-11-27T09:11:17Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/backup/BackupHandler.java", "diffHunk": "@@ -274,25 +274,25 @@ private void backup(Repository repository, Database db, BackupStmt stmt) throws\n         // This is just a pre-check to avoid most of invalid backup requests.\n         // Also calculate the signature for incremental backup check.\n         List<TableRef> tblRefs = stmt.getTableRefs();\n-        BackupMeta curBackupMeta = null;\n-        db.readLock();\n-        try {\n-            List<Table> backupTbls = Lists.newArrayList();\n-            for (TableRef tblRef : tblRefs) {\n-                String tblName = tblRef.getName().getTbl();\n-                Table tbl = db.getTable(tblName);\n-                if (tbl == null) {\n-                    ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tblName);\n-                }\n-                if (tbl.getType() != TableType.OLAP) {\n-                    ErrorReport.reportDdlException(ErrorCode.ERR_NOT_OLAP_TABLE, tblName);\n-                }\n \n-                OlapTable olapTbl = (OlapTable) tbl;\n+        List<Table> backupTbls = Lists.newArrayList();\n+        for (TableRef tblRef : tblRefs) {\n+            String tblName = tblRef.getName().getTbl();\n+            Table tbl = db.getTable(tblName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMzODgxMg=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjIxOTMxOnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/backup/RestoreJob.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMjo0Njo1OVrOH5x3yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOToxMjoxOVrOH62Z7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM0Nzk3OA==", "bodyText": "We can use db.createTableWithLock()", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530347978", "createdAt": "2020-11-25T12:46:59Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/backup/RestoreJob.java", "diffHunk": "@@ -664,18 +667,25 @@ private void checkAndPrepareMeta() {\n                                 remoteDataProperty, (short) restoreReplicationNum,\n                                 remotePartitionInfo.getIsInMemory(remotePartId));\n                         localTbl.addPartition(restoredPart);\n+                    } finally {\n+                        localTbl.writeUnlock();\n                     }\n \n-                    // add restored tables\n-                    for (OlapTable tbl : restoredTbls) {\n+                }\n+\n+                // add restored tables\n+                for (OlapTable tbl : restoredTbls) {\n+                    db.writeLock();\n+                    try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 297}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ3MDgzMQ==", "bodyText": "use this function use cause side effect that edit log write create table info.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531470831", "createdAt": "2020-11-27T09:12:19Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/backup/RestoreJob.java", "diffHunk": "@@ -664,18 +667,25 @@ private void checkAndPrepareMeta() {\n                                 remoteDataProperty, (short) restoreReplicationNum,\n                                 remotePartitionInfo.getIsInMemory(remotePartId));\n                         localTbl.addPartition(restoredPart);\n+                    } finally {\n+                        localTbl.writeUnlock();\n                     }\n \n-                    // add restored tables\n-                    for (OlapTable tbl : restoredTbls) {\n+                }\n+\n+                // add restored tables\n+                for (OlapTable tbl : restoredTbls) {\n+                    db.writeLock();\n+                    try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM0Nzk3OA=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 297}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjIyNzA3OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/backup/RestoreJob.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMjo0OTowM1rOH5x8aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOTozODo0OVrOH63Tcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM0OTE2Mw==", "bodyText": "Use db.dropTableWithLock()", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530349163", "createdAt": "2020-11-25T12:49:03Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/backup/RestoreJob.java", "diffHunk": "@@ -1347,42 +1374,53 @@ public void cancelInternal(boolean isReplay) {\n         // clean restored objs\n         Database db = catalog.getDb(dbId);\n         if (db != null) {\n-            db.writeLock();\n-            try {\n-                // rollback table's state to NORMAL\n-                setTableStateToNormal(db);\n+            // rollback table's state to NORMAL\n+            setTableStateToNormal(db);\n \n-                // remove restored tbls\n-                for (OlapTable restoreTbl : restoredTbls) {\n-                    LOG.info(\"remove restored table when cancelled: {}\", restoreTbl.getName());\n+            // remove restored tbls\n+            for (OlapTable restoreTbl : restoredTbls) {\n+                LOG.info(\"remove restored table when cancelled: {}\", restoreTbl.getName());\n+                restoreTbl.writeLock();\n+                try {\n                     for (Partition part : restoreTbl.getPartitions()) {\n                         for (MaterializedIndex idx : part.getMaterializedIndices(IndexExtState.VISIBLE)) {\n                             for (Tablet tablet : idx.getTablets()) {\n                                 Catalog.getCurrentInvertedIndex().deleteTablet(tablet.getId());\n                             }\n                         }\n                     }\n+                } finally {\n+                    restoreTbl.writeUnlock();\n+                }\n+                db.writeLock();\n+                try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 674}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ4NTU1NA==", "bodyText": "fix", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531485554", "createdAt": "2020-11-27T09:38:49Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/backup/RestoreJob.java", "diffHunk": "@@ -1347,42 +1374,53 @@ public void cancelInternal(boolean isReplay) {\n         // clean restored objs\n         Database db = catalog.getDb(dbId);\n         if (db != null) {\n-            db.writeLock();\n-            try {\n-                // rollback table's state to NORMAL\n-                setTableStateToNormal(db);\n+            // rollback table's state to NORMAL\n+            setTableStateToNormal(db);\n \n-                // remove restored tbls\n-                for (OlapTable restoreTbl : restoredTbls) {\n-                    LOG.info(\"remove restored table when cancelled: {}\", restoreTbl.getName());\n+            // remove restored tbls\n+            for (OlapTable restoreTbl : restoredTbls) {\n+                LOG.info(\"remove restored table when cancelled: {}\", restoreTbl.getName());\n+                restoreTbl.writeLock();\n+                try {\n                     for (Partition part : restoreTbl.getPartitions()) {\n                         for (MaterializedIndex idx : part.getMaterializedIndices(IndexExtState.VISIBLE)) {\n                             for (Tablet tablet : idx.getTablets()) {\n                                 Catalog.getCurrentInvertedIndex().deleteTablet(tablet.getId());\n                             }\n                         }\n                     }\n+                } finally {\n+                    restoreTbl.writeUnlock();\n+                }\n+                db.writeLock();\n+                try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM0OTE2Mw=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 674}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjI1MjY1OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/Catalog.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMjo1NToxM1rOH5yLmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwNzoxOTo1MlrOH6zUNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM1MzA0OQ==", "bodyText": "Is it safe to write db without lock?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530353049", "createdAt": "2020-11-25T12:55:13Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -2043,12 +2044,7 @@ public long saveDb(DataOutputStream dos, long checksum) throws IOException {\n             // Don't write information_schema db meta\n             if (!InfoSchemaDb.isInfoSchemaDb(dbName)) {\n                 checksum ^= entry.getKey();\n-                db.readLock();\n-                try {\n-                    db.write(dos);\n-                } finally {\n-                    db.readUnlock();\n-                }\n+                db.write(dos);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyMDIxMg==", "bodyText": "for Catalog dumpImage or saveImage will call this function. for the first, lock all dbs already. for second, only invoke by checkpoint thread, so it is thread safe", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531420212", "createdAt": "2020-11-27T07:19:52Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -2043,12 +2044,7 @@ public long saveDb(DataOutputStream dos, long checksum) throws IOException {\n             // Don't write information_schema db meta\n             if (!InfoSchemaDb.isInfoSchemaDb(dbName)) {\n                 checksum ^= entry.getKey();\n-                db.readLock();\n-                try {\n-                    db.write(dos);\n-                } finally {\n-                    db.readUnlock();\n-                }\n+                db.write(dos);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM1MzA0OQ=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjUxNDA1OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/Catalog.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMzo1OTo1M1rOH50rBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwNzoyNDoxNFrOH6zZtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5Mzg2Mg==", "bodyText": "Does checkPartitionNameExist  need table lock?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530393862", "createdAt": "2020-11-25T13:59:53Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -6673,86 +6680,75 @@ public void convertDistributionType(Database db, OlapTable tbl) throws DdlExcept\n             editLog.logModifyDistributionType(tableInfo);\n             LOG.info(\"finished to modify distribution type of table: \" + tbl.getName());\n         } finally {\n-            db.writeUnlock();\n+            tbl.writeUnlock();\n         }\n     }\n \n     public void replayConvertDistributionType(TableInfo tableInfo) {\n         Database db = getDb(tableInfo.getDbId());\n-        db.writeLock();\n+        OlapTable tbl = (OlapTable) db.getTable(tableInfo.getTableId());\n+        if (tbl == null) {\n+            return;\n+        }\n+        tbl.writeLock();\n         try {\n-            OlapTable tbl = (OlapTable) db.getTable(tableInfo.getTableId());\n             tbl.convertRandomDistributionToHashDistribution();\n             LOG.info(\"replay modify distribution type of table: \" + tbl.getName());\n         } finally {\n-            db.writeUnlock();\n+            tbl.writeUnlock();\n         }\n     }\n \n     /*\n      * The entry of replacing partitions with temp partitions.\n      */\n-    public void replaceTempPartition(Database db, String tableName, ReplacePartitionClause clause) throws DdlException {\n+    public void replaceTempPartition(Database db, OlapTable olapTable, ReplacePartitionClause clause) throws DdlException {\n+        Preconditions.checkState(olapTable.isWriteLockHeldByCurrentThread());\n         List<String> partitionNames = clause.getPartitionNames();\n         List<String> tempPartitionNames = clause.getTempPartitionNames();\n         boolean isStrictRange = clause.isStrictRange();\n         boolean useTempPartitionName = clause.useTempPartitionName();\n-        db.writeLock();\n-        try {\n-            Table table = db.getTable(tableName);\n-            if (table == null) {\n-                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n-            }\n-\n-            if (table.getType() != TableType.OLAP) {\n-                throw new DdlException(\"Table[\" + tableName + \"] is not OLAP table\");\n+        // check partition exist\n+        for (String partName : partitionNames) {\n+            if (!olapTable.checkPartitionNameExist(partName, false)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 1001}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyMTYyMA==", "bodyText": "already get table lock outside replaceTempPartition", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531421620", "createdAt": "2020-11-27T07:24:14Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -6673,86 +6680,75 @@ public void convertDistributionType(Database db, OlapTable tbl) throws DdlExcept\n             editLog.logModifyDistributionType(tableInfo);\n             LOG.info(\"finished to modify distribution type of table: \" + tbl.getName());\n         } finally {\n-            db.writeUnlock();\n+            tbl.writeUnlock();\n         }\n     }\n \n     public void replayConvertDistributionType(TableInfo tableInfo) {\n         Database db = getDb(tableInfo.getDbId());\n-        db.writeLock();\n+        OlapTable tbl = (OlapTable) db.getTable(tableInfo.getTableId());\n+        if (tbl == null) {\n+            return;\n+        }\n+        tbl.writeLock();\n         try {\n-            OlapTable tbl = (OlapTable) db.getTable(tableInfo.getTableId());\n             tbl.convertRandomDistributionToHashDistribution();\n             LOG.info(\"replay modify distribution type of table: \" + tbl.getName());\n         } finally {\n-            db.writeUnlock();\n+            tbl.writeUnlock();\n         }\n     }\n \n     /*\n      * The entry of replacing partitions with temp partitions.\n      */\n-    public void replaceTempPartition(Database db, String tableName, ReplacePartitionClause clause) throws DdlException {\n+    public void replaceTempPartition(Database db, OlapTable olapTable, ReplacePartitionClause clause) throws DdlException {\n+        Preconditions.checkState(olapTable.isWriteLockHeldByCurrentThread());\n         List<String> partitionNames = clause.getPartitionNames();\n         List<String> tempPartitionNames = clause.getTempPartitionNames();\n         boolean isStrictRange = clause.isStrictRange();\n         boolean useTempPartitionName = clause.useTempPartitionName();\n-        db.writeLock();\n-        try {\n-            Table table = db.getTable(tableName);\n-            if (table == null) {\n-                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n-            }\n-\n-            if (table.getType() != TableType.OLAP) {\n-                throw new DdlException(\"Table[\" + tableName + \"] is not OLAP table\");\n+        // check partition exist\n+        for (String partName : partitionNames) {\n+            if (!olapTable.checkPartitionNameExist(partName, false)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5Mzg2Mg=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 1001}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjUxNTQyOnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/Catalog.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNDowMDowN1rOH50ryw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwNzoyNDoyMVrOH6zZ2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5NDA1OQ==", "bodyText": "Does replaceTempPartitions need table lock?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530394059", "createdAt": "2020-11-25T14:00:07Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -6673,86 +6680,75 @@ public void convertDistributionType(Database db, OlapTable tbl) throws DdlExcept\n             editLog.logModifyDistributionType(tableInfo);\n             LOG.info(\"finished to modify distribution type of table: \" + tbl.getName());\n         } finally {\n-            db.writeUnlock();\n+            tbl.writeUnlock();\n         }\n     }\n \n     public void replayConvertDistributionType(TableInfo tableInfo) {\n         Database db = getDb(tableInfo.getDbId());\n-        db.writeLock();\n+        OlapTable tbl = (OlapTable) db.getTable(tableInfo.getTableId());\n+        if (tbl == null) {\n+            return;\n+        }\n+        tbl.writeLock();\n         try {\n-            OlapTable tbl = (OlapTable) db.getTable(tableInfo.getTableId());\n             tbl.convertRandomDistributionToHashDistribution();\n             LOG.info(\"replay modify distribution type of table: \" + tbl.getName());\n         } finally {\n-            db.writeUnlock();\n+            tbl.writeUnlock();\n         }\n     }\n \n     /*\n      * The entry of replacing partitions with temp partitions.\n      */\n-    public void replaceTempPartition(Database db, String tableName, ReplacePartitionClause clause) throws DdlException {\n+    public void replaceTempPartition(Database db, OlapTable olapTable, ReplacePartitionClause clause) throws DdlException {\n+        Preconditions.checkState(olapTable.isWriteLockHeldByCurrentThread());\n         List<String> partitionNames = clause.getPartitionNames();\n         List<String> tempPartitionNames = clause.getTempPartitionNames();\n         boolean isStrictRange = clause.isStrictRange();\n         boolean useTempPartitionName = clause.useTempPartitionName();\n-        db.writeLock();\n-        try {\n-            Table table = db.getTable(tableName);\n-            if (table == null) {\n-                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n-            }\n-\n-            if (table.getType() != TableType.OLAP) {\n-                throw new DdlException(\"Table[\" + tableName + \"] is not OLAP table\");\n+        // check partition exist\n+        for (String partName : partitionNames) {\n+            if (!olapTable.checkPartitionNameExist(partName, false)) {\n+                throw new DdlException(\"Partition[\" + partName + \"] does not exist\");\n             }\n-\n-            OlapTable olapTable = (OlapTable) table;\n-            // check partition exist\n-            for (String partName : partitionNames) {\n-                if (!olapTable.checkPartitionNameExist(partName, false)) {\n-                    throw new DdlException(\"Partition[\" + partName + \"] does not exist\");\n-                }\n-            }\n-            for (String partName : tempPartitionNames) {\n-                if (!olapTable.checkPartitionNameExist(partName, true)) {\n-                    throw new DdlException(\"Temp partition[\" + partName + \"] does not exist\");\n-                }\n+        }\n+        for (String partName : tempPartitionNames) {\n+            if (!olapTable.checkPartitionNameExist(partName, true)) {\n+                throw new DdlException(\"Temp partition[\" + partName + \"] does not exist\");\n             }\n-\n-            olapTable.replaceTempPartitions(partitionNames, tempPartitionNames, isStrictRange, useTempPartitionName);\n-\n-            // write log\n-            ReplacePartitionOperationLog info = new ReplacePartitionOperationLog(db.getId(), olapTable.getId(),\n-                    partitionNames, tempPartitionNames, isStrictRange, useTempPartitionName);\n-            editLog.logReplaceTempPartition(info);\n-            LOG.info(\"finished to replace partitions {} with temp partitions {} from table: {}\",\n-                    clause.getPartitionNames(), clause.getTempPartitionNames(), tableName);\n-        } finally {\n-            db.writeUnlock();\n         }\n+        olapTable.replaceTempPartitions(partitionNames, tempPartitionNames, isStrictRange, useTempPartitionName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 1033}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyMTY1OQ==", "bodyText": "already get table lock outside replaceTempPartition", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531421659", "createdAt": "2020-11-27T07:24:21Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -6673,86 +6680,75 @@ public void convertDistributionType(Database db, OlapTable tbl) throws DdlExcept\n             editLog.logModifyDistributionType(tableInfo);\n             LOG.info(\"finished to modify distribution type of table: \" + tbl.getName());\n         } finally {\n-            db.writeUnlock();\n+            tbl.writeUnlock();\n         }\n     }\n \n     public void replayConvertDistributionType(TableInfo tableInfo) {\n         Database db = getDb(tableInfo.getDbId());\n-        db.writeLock();\n+        OlapTable tbl = (OlapTable) db.getTable(tableInfo.getTableId());\n+        if (tbl == null) {\n+            return;\n+        }\n+        tbl.writeLock();\n         try {\n-            OlapTable tbl = (OlapTable) db.getTable(tableInfo.getTableId());\n             tbl.convertRandomDistributionToHashDistribution();\n             LOG.info(\"replay modify distribution type of table: \" + tbl.getName());\n         } finally {\n-            db.writeUnlock();\n+            tbl.writeUnlock();\n         }\n     }\n \n     /*\n      * The entry of replacing partitions with temp partitions.\n      */\n-    public void replaceTempPartition(Database db, String tableName, ReplacePartitionClause clause) throws DdlException {\n+    public void replaceTempPartition(Database db, OlapTable olapTable, ReplacePartitionClause clause) throws DdlException {\n+        Preconditions.checkState(olapTable.isWriteLockHeldByCurrentThread());\n         List<String> partitionNames = clause.getPartitionNames();\n         List<String> tempPartitionNames = clause.getTempPartitionNames();\n         boolean isStrictRange = clause.isStrictRange();\n         boolean useTempPartitionName = clause.useTempPartitionName();\n-        db.writeLock();\n-        try {\n-            Table table = db.getTable(tableName);\n-            if (table == null) {\n-                ErrorReport.reportDdlException(ErrorCode.ERR_BAD_TABLE_ERROR, tableName);\n-            }\n-\n-            if (table.getType() != TableType.OLAP) {\n-                throw new DdlException(\"Table[\" + tableName + \"] is not OLAP table\");\n+        // check partition exist\n+        for (String partName : partitionNames) {\n+            if (!olapTable.checkPartitionNameExist(partName, false)) {\n+                throw new DdlException(\"Partition[\" + partName + \"] does not exist\");\n             }\n-\n-            OlapTable olapTable = (OlapTable) table;\n-            // check partition exist\n-            for (String partName : partitionNames) {\n-                if (!olapTable.checkPartitionNameExist(partName, false)) {\n-                    throw new DdlException(\"Partition[\" + partName + \"] does not exist\");\n-                }\n-            }\n-            for (String partName : tempPartitionNames) {\n-                if (!olapTable.checkPartitionNameExist(partName, true)) {\n-                    throw new DdlException(\"Temp partition[\" + partName + \"] does not exist\");\n-                }\n+        }\n+        for (String partName : tempPartitionNames) {\n+            if (!olapTable.checkPartitionNameExist(partName, true)) {\n+                throw new DdlException(\"Temp partition[\" + partName + \"] does not exist\");\n             }\n-\n-            olapTable.replaceTempPartitions(partitionNames, tempPartitionNames, isStrictRange, useTempPartitionName);\n-\n-            // write log\n-            ReplacePartitionOperationLog info = new ReplacePartitionOperationLog(db.getId(), olapTable.getId(),\n-                    partitionNames, tempPartitionNames, isStrictRange, useTempPartitionName);\n-            editLog.logReplaceTempPartition(info);\n-            LOG.info(\"finished to replace partitions {} with temp partitions {} from table: {}\",\n-                    clause.getPartitionNames(), clause.getTempPartitionNames(), tableName);\n-        } finally {\n-            db.writeUnlock();\n         }\n+        olapTable.replaceTempPartitions(partitionNames, tempPartitionNames, isStrictRange, useTempPartitionName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5NDA1OQ=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 1033}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjU4MjMxOnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/clone/ColocateTableBalancer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNDoxNTozMFrOH51UiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwNzozNDozNVrOH6znyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQwNDQ4OA==", "bodyText": "is it safe to markGroupStable/markGroupUnstable outside the lock?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r530404488", "createdAt": "2020-11-25T14:15:30Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/clone/ColocateTableBalancer.java", "diffHunk": "@@ -233,16 +232,16 @@ private void matchGroup() {\n                             }\n                         }\n                     }\n-                } // end for tables\n-\n-                // mark group as stable or unstable\n-                if (isGroupStable) {\n-                    colocateIndex.markGroupStable(groupId, true);\n-                } else {\n-                    colocateIndex.markGroupUnstable(groupId, true);\n+                } finally {\n+                    olapTable.readUnlock();\n                 }\n-            } finally {\n-                db.readUnlock();\n+            } // end for tables\n+\n+            // mark group as stable or unstable\n+            if (isGroupStable) {\n+                colocateIndex.markGroupStable(groupId, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyNTIyNA==", "bodyText": "I think it is thread safe, for markGroupStable and markGroupUnstable function", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531425224", "createdAt": "2020-11-27T07:34:35Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/clone/ColocateTableBalancer.java", "diffHunk": "@@ -233,16 +232,16 @@ private void matchGroup() {\n                             }\n                         }\n                     }\n-                } // end for tables\n-\n-                // mark group as stable or unstable\n-                if (isGroupStable) {\n-                    colocateIndex.markGroupStable(groupId, true);\n-                } else {\n-                    colocateIndex.markGroupUnstable(groupId, true);\n+                } finally {\n+                    olapTable.readUnlock();\n                 }\n-            } finally {\n-                db.readUnlock();\n+            } // end for tables\n+\n+            // mark group as stable or unstable\n+            if (isGroupStable) {\n+                colocateIndex.markGroupStable(groupId, true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQwNDQ4OA=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMTEzNTEzOnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/load/Load.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNTozMjozMFrOH6gB0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwNzozODoxMFrOH6zsww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwNDIxMA==", "bodyText": "I think we should hold the table's readLock before checking table' state", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531104210", "createdAt": "2020-11-26T15:32:30Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -398,7 +398,7 @@ private void addLoadJob(LoadJob job, Database db) throws DdlException {\n         }\n \n         // check if table is in restore process\n-        db.readLock();\n+        readLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyNjQ5OQ==", "bodyText": "table's state is a volatile variable, so no need to hold table read lock", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531426499", "createdAt": "2020-11-27T07:38:10Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -398,7 +398,7 @@ private void addLoadJob(LoadJob job, Database db) throws DdlException {\n         }\n \n         // check if table is in restore process\n-        db.readLock();\n+        readLock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwNDIxMA=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMTE1MDIzOnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/load/Load.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNTozNjoxM1rOH6gKuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxMDozMDoxNFrOH65D9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwNjQ4OA==", "bodyText": "The lock order is wrong.\nthe origin lock order is db lock -> 'load lock'.\nBut here you use 'table lock' -> 'load lock'", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531106488", "createdAt": "2020-11-26T15:36:13Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -3229,19 +3234,19 @@ public void unprotectDelete(DeleteInfo deleteInfo, Database db) {\n \n     public void replayFinishAsyncDeleteJob(AsyncDeleteJob deleteJob, Catalog catalog) {\n         Database db = catalog.getDb(deleteJob.getDbId());\n-        db.writeLock();\n+        writeLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 243}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwNzAzMQ==", "bodyText": "All other place in Load.java should also be checked again.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531107031", "createdAt": "2020-11-26T15:37:09Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -3229,19 +3234,19 @@ public void unprotectDelete(DeleteInfo deleteInfo, Database db) {\n \n     public void replayFinishAsyncDeleteJob(AsyncDeleteJob deleteJob, Catalog catalog) {\n         Database db = catalog.getDb(deleteJob.getDbId());\n-        db.writeLock();\n+        writeLock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwNjQ4OA=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 243}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxNDM1OQ==", "bodyText": "done", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531514359", "createdAt": "2020-11-27T10:30:14Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -3229,19 +3234,19 @@ public void unprotectDelete(DeleteInfo deleteInfo, Database db) {\n \n     public void replayFinishAsyncDeleteJob(AsyncDeleteJob deleteJob, Catalog catalog) {\n         Database db = catalog.getDb(deleteJob.getDbId());\n-        db.writeLock();\n+        writeLock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwNjQ4OA=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 243}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMTE2NDQ4OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/load/LoadChecker.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNTo0MDowMVrOH6gTTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQwMzoyODo0NVrOH7fzGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwODY4NQ==", "bodyText": "This part should be protected by lock", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531108685", "createdAt": "2020-11-26T15:40:01Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/LoadChecker.java", "diffHunk": "@@ -565,18 +568,14 @@ private void runOneQuorumFinishedDeleteJob(AsyncDeleteJob job) {\n             load.removeDeleteJobAndSetState(job);\n             return;\n         }\n-        db.readLock();\n-        try {\n-            // if the delete job is quorum finished, just set it to finished\n-            job.clearTasks();\n-            job.setState(DeleteState.FINISHED);\n-            // log\n-            Catalog.getCurrentCatalog().getEditLog().logFinishAsyncDelete(job);\n-            load.removeDeleteJobAndSetState(job);\n-            LOG.info(\"delete job {} finished\", job.getJobId());\n-        } finally {\n-            db.readUnlock();\n-        }\n+\n+        // if the delete job is quorum finished, just set it to finished\n+        job.clearTasks();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ5MTY0Ng==", "bodyText": "I cannot find the suitable lock to protect this part", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531491646", "createdAt": "2020-11-27T09:49:36Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/LoadChecker.java", "diffHunk": "@@ -565,18 +568,14 @@ private void runOneQuorumFinishedDeleteJob(AsyncDeleteJob job) {\n             load.removeDeleteJobAndSetState(job);\n             return;\n         }\n-        db.readLock();\n-        try {\n-            // if the delete job is quorum finished, just set it to finished\n-            job.clearTasks();\n-            job.setState(DeleteState.FINISHED);\n-            // log\n-            Catalog.getCurrentCatalog().getEditLog().logFinishAsyncDelete(job);\n-            load.removeDeleteJobAndSetState(job);\n-            LOG.info(\"delete job {} finished\", job.getJobId());\n-        } finally {\n-            db.readUnlock();\n-        }\n+\n+        // if the delete job is quorum finished, just set it to finished\n+        job.clearTasks();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwODY4NQ=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjE0OTAxOQ==", "bodyText": "Never mind, the AsyncDeleteJob is deprecated, I will remove it later.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r532149019", "createdAt": "2020-11-29T03:28:45Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/LoadChecker.java", "diffHunk": "@@ -565,18 +568,14 @@ private void runOneQuorumFinishedDeleteJob(AsyncDeleteJob job) {\n             load.removeDeleteJobAndSetState(job);\n             return;\n         }\n-        db.readLock();\n-        try {\n-            // if the delete job is quorum finished, just set it to finished\n-            job.clearTasks();\n-            job.setState(DeleteState.FINISHED);\n-            // log\n-            Catalog.getCurrentCatalog().getEditLog().logFinishAsyncDelete(job);\n-            load.removeDeleteJobAndSetState(job);\n-            LOG.info(\"delete job {} finished\", job.getJobId());\n-        } finally {\n-            db.readUnlock();\n-        }\n+\n+        // if the delete job is quorum finished, just set it to finished\n+        job.clearTasks();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwODY4NQ=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 132}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMTE5NTAzOnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLoadPendingTask.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNTo0ODozMFrOH6glrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQwMzozMTo1OVrOH7f0QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTExMzM4OA==", "bodyText": "In origin implementation, this prepareTablePartitionInfos and following logic is within same db lock.\nBut now you put them into 2 lock phases, which becomes not atomic.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531113388", "createdAt": "2020-11-26T15:48:30Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLoadPendingTask.java", "diffHunk": "@@ -133,13 +136,18 @@ private void createEtlJobConf() throws LoadException {\n         }\n \n         Map<Long, EtlTable> tables = Maps.newHashMap();\n-        db.readLock();\n+        Map<Long, Set<Long>> tableIdToPartitionIds = Maps.newHashMap();\n+        Set<Long> allPartitionsTableIds = Sets.newHashSet();\n+        prepareTablePartitionInfos(db, tableIdToPartitionIds, allPartitionsTableIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ4NTM5OA==", "bodyText": "I think it doesn't matter? if i modify table meta or drop table after db read lock, the final result is still same?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531485398", "createdAt": "2020-11-27T09:38:33Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLoadPendingTask.java", "diffHunk": "@@ -133,13 +136,18 @@ private void createEtlJobConf() throws LoadException {\n         }\n \n         Map<Long, EtlTable> tables = Maps.newHashMap();\n-        db.readLock();\n+        Map<Long, Set<Long>> tableIdToPartitionIds = Maps.newHashMap();\n+        Set<Long> allPartitionsTableIds = Sets.newHashSet();\n+        prepareTablePartitionInfos(db, tableIdToPartitionIds, allPartitionsTableIds);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTExMzM4OA=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjE0OTMxMw==", "bodyText": "OK, LGTM", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r532149313", "createdAt": "2020-11-29T03:31:59Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/load/loadv2/SparkLoadPendingTask.java", "diffHunk": "@@ -133,13 +136,18 @@ private void createEtlJobConf() throws LoadException {\n         }\n \n         Map<Long, EtlTable> tables = Maps.newHashMap();\n-        db.readLock();\n+        Map<Long, Set<Long>> tableIdToPartitionIds = Maps.newHashMap();\n+        Set<Long> allPartitionsTableIds = Sets.newHashSet();\n+        prepareTablePartitionInfos(db, tableIdToPartitionIds, allPartitionsTableIds);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTExMzM4OA=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMjYyOTI4OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/master/ReportHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwMTo1MzoxN1rOH6ttFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOToxNDozOVrOH62fUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTMyODI3Ng==", "bodyText": "Why this license is different?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531328276", "createdAt": "2020-11-27T01:53:17Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/master/ReportHandler.java", "diffHunk": "@@ -14,6 +14,22 @@\n // KIND, either express or implied.  See the License for the\n // specific language governing permissions and limitations\n // under the License.\n+// Licensed to the Apache Software Foundation (ASF) under one", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ3MjIxMA==", "bodyText": "It is an incorrect modification.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531472210", "createdAt": "2020-11-27T09:14:39Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/master/ReportHandler.java", "diffHunk": "@@ -14,6 +14,22 @@\n // KIND, either express or implied.  See the License for the\n // specific language governing permissions and limitations\n // under the License.\n+// Licensed to the Apache Software Foundation (ASF) under one", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTMyODI3Ng=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMjY2MDYzOnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/qe/StmtExecutor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwMTo1OTowNVrOH6uBzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwNzoyOTowMVrOH6zgEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTMzMzU4Mg==", "bodyText": "Are you sure this can get table list in order?\nI think it is more safe and clear to change tableMap to tableList, and sort the tableList explicitly.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531333582", "createdAt": "2020-11-27T01:59:05Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/qe/StmtExecutor.java", "diffHunk": "@@ -456,23 +437,23 @@ public void analyze(TQueryOptions tQueryOptions) throws UserException {\n         if (parsedStmt instanceof QueryStmt\n                 || parsedStmt instanceof InsertStmt\n                 || parsedStmt instanceof CreateTableAsSelectStmt) {\n-            Map<String, Database> dbs = Maps.newTreeMap();\n+            Map<Long, Table> tableMap = Maps.newTreeMap();\n             QueryStmt queryStmt;\n             Set<String> parentViewNameSet = Sets.newHashSet();\n             if (parsedStmt instanceof QueryStmt) {\n                 queryStmt = (QueryStmt) parsedStmt;\n-                queryStmt.getDbs(analyzer, dbs, parentViewNameSet);\n+                queryStmt.getTables(analyzer, tableMap, parentViewNameSet);\n             } else {\n                 InsertStmt insertStmt;\n                 if (parsedStmt instanceof InsertStmt) {\n                     insertStmt = (InsertStmt) parsedStmt;\n                 } else {\n                     insertStmt = ((CreateTableAsSelectStmt) parsedStmt).getInsertStmt();\n                 }\n-                insertStmt.getDbs(analyzer, dbs, parentViewNameSet);\n+                insertStmt.getTables(analyzer, tableMap, parentViewNameSet);\n             }\n-\n-            lock(dbs);\n+            List<Table> tables = Lists.newArrayList(tableMap.values());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQyMzI0OQ==", "bodyText": "yes, tableMap is a treeMap which is used to for previous analysis, the treeMap will keep table id in In ascending order,", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531423249", "createdAt": "2020-11-27T07:29:01Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/qe/StmtExecutor.java", "diffHunk": "@@ -456,23 +437,23 @@ public void analyze(TQueryOptions tQueryOptions) throws UserException {\n         if (parsedStmt instanceof QueryStmt\n                 || parsedStmt instanceof InsertStmt\n                 || parsedStmt instanceof CreateTableAsSelectStmt) {\n-            Map<String, Database> dbs = Maps.newTreeMap();\n+            Map<Long, Table> tableMap = Maps.newTreeMap();\n             QueryStmt queryStmt;\n             Set<String> parentViewNameSet = Sets.newHashSet();\n             if (parsedStmt instanceof QueryStmt) {\n                 queryStmt = (QueryStmt) parsedStmt;\n-                queryStmt.getDbs(analyzer, dbs, parentViewNameSet);\n+                queryStmt.getTables(analyzer, tableMap, parentViewNameSet);\n             } else {\n                 InsertStmt insertStmt;\n                 if (parsedStmt instanceof InsertStmt) {\n                     insertStmt = (InsertStmt) parsedStmt;\n                 } else {\n                     insertStmt = ((CreateTableAsSelectStmt) parsedStmt).getInsertStmt();\n                 }\n-                insertStmt.getDbs(analyzer, dbs, parentViewNameSet);\n+                insertStmt.getTables(analyzer, tableMap, parentViewNameSet);\n             }\n-\n-            lock(dbs);\n+            List<Table> tables = Lists.newArrayList(tableMap.values());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTMzMzU4Mg=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMjcwMDI2OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/system/SystemInfoService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwMjowNjo0MlrOH6ucZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOTowNDo1MlrOH62KQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM0MDM5MA==", "bodyText": "In original implementation, we use db locks to ensure mutual exclusion and order.\nSo here we may still need to add table locks.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531340390", "createdAt": "2020-11-27T02:06:42Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/system/SystemInfoService.java", "diffHunk": "@@ -894,18 +893,8 @@ public long getBackendReportVersion(long backendId) {\n     public void updateBackendReportVersion(long backendId, long newReportVersion, long dbId) {\n         AtomicLong atomicLong = null;\n         if ((atomicLong = idToReportVersionRef.get(backendId)) != null) {\n-            Database db = Catalog.getCurrentCatalog().getDb(dbId);\n-            if (db != null) {\n-                db.readLock();\n-                try {\n-                    atomicLong.set(newReportVersion);\n-                    LOG.debug(\"update backend {} report version: {}, db: {}\", backendId, newReportVersion, dbId);\n-                } finally {\n-                    db.readUnlock();\n-                }\n-            } else {\n-                LOG.warn(\"failed to update backend report version, db {} does not exist\", dbId);\n-            }\n+            atomicLong.set(newReportVersion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ2NjgxOA==", "bodyText": "atomicLong is AtomicLong,so I think it is meanless for add table lock or db lock?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531466818", "createdAt": "2020-11-27T09:04:52Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/system/SystemInfoService.java", "diffHunk": "@@ -894,18 +893,8 @@ public long getBackendReportVersion(long backendId) {\n     public void updateBackendReportVersion(long backendId, long newReportVersion, long dbId) {\n         AtomicLong atomicLong = null;\n         if ((atomicLong = idToReportVersionRef.get(backendId)) != null) {\n-            Database db = Catalog.getCurrentCatalog().getDb(dbId);\n-            if (db != null) {\n-                db.readLock();\n-                try {\n-                    atomicLong.set(newReportVersion);\n-                    LOG.debug(\"update backend {} report version: {}, db: {}\", backendId, newReportVersion, dbId);\n-                } finally {\n-                    db.readUnlock();\n-                }\n-            } else {\n-                LOG.warn(\"failed to update backend report version, db {} does not exist\", dbId);\n-            }\n+            atomicLong.set(newReportVersion);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM0MDM5MA=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMjczMzU4OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/task/HadoopLoadPendingTask.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwMjoxMzowN1rOH6uymQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOTowNToxNlrOH62K9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM0NjA3Mw==", "bodyText": "Table's lock should be held to call method like createEtlPartitions()", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531346073", "createdAt": "2020-11-27T02:13:07Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/task/HadoopLoadPendingTask.java", "diffHunk": "@@ -70,41 +70,41 @@ public HadoopLoadPendingTask(LoadJob job) {\n \n     @Override\n     protected void createEtlRequest() throws Exception {\n-        db.readLock();\n-        try {\n-            EtlTaskConf taskConf = new EtlTaskConf();\n-            // output path\n-            taskConf.setOutputPath(getOutputPath());\n-            // output file pattern\n-            taskConf.setOutputFilePattern(job.getLabel() + \".%(table)s.%(view)s.%(bucket)s\");\n-            // tables (partitions)\n-            Map<String, EtlPartitionConf> etlPartitions = createEtlPartitions();\n-            Preconditions.checkNotNull(etlPartitions);\n-            taskConf.setEtlPartitions(etlPartitions);\n+        EtlTaskConf taskConf = new EtlTaskConf();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ2Njk5OQ==", "bodyText": "add table lock in createEtlPartitions", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531466999", "createdAt": "2020-11-27T09:05:16Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/task/HadoopLoadPendingTask.java", "diffHunk": "@@ -70,41 +70,41 @@ public HadoopLoadPendingTask(LoadJob job) {\n \n     @Override\n     protected void createEtlRequest() throws Exception {\n-        db.readLock();\n-        try {\n-            EtlTaskConf taskConf = new EtlTaskConf();\n-            // output path\n-            taskConf.setOutputPath(getOutputPath());\n-            // output file pattern\n-            taskConf.setOutputFilePattern(job.getLabel() + \".%(table)s.%(view)s.%(bucket)s\");\n-            // tables (partitions)\n-            Map<String, EtlPartitionConf> etlPartitions = createEtlPartitions();\n-            Preconditions.checkNotNull(etlPartitions);\n-            taskConf.setEtlPartitions(etlPartitions);\n+        EtlTaskConf taskConf = new EtlTaskConf();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM0NjA3Mw=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMjc2MTI5OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/transaction/PublishVersionDaemon.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwMjoyMzo0OVrOH6vEZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwNzo0NzozMFrOH6z6jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM1MDYyOA==", "bodyText": "Is it more safe to lock all tables at once outside the for loop?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531350628", "createdAt": "2020-11-27T02:23:49Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/transaction/PublishVersionDaemon.java", "diffHunk": "@@ -190,16 +190,18 @@ private void publishVersion() throws UserException {\n                             LOG.warn(\"Database [{}] has been dropped.\", transactionState.getDbId());\n                             continue;\n                         }\n-                        db.readLock();\n-                        try {\n-                            for (int i = 0; i < transactionState.getTableIdList().size(); i++) {\n-                                long tableId = transactionState.getTableIdList().get(i);\n-                                Table table = db.getTable(tableId);\n-                                if (table == null || table.getType() != Table.TableType.OLAP) {\n-                                    LOG.warn(\"Table [{}] in database [{}] has been dropped.\", tableId, db.getFullName());\n-                                    continue;\n-                                }\n-                                OlapTable olapTable = (OlapTable) table;\n+\n+\n+                        for (int i = 0; i < transactionState.getTableIdList().size(); i++) {\n+                            long tableId = transactionState.getTableIdList().get(i);\n+                            Table table = db.getTable(tableId);\n+                            if (table == null || table.getType() != Table.TableType.OLAP) {\n+                                LOG.warn(\"Table [{}] in database [{}] has been dropped.\", tableId, db.getFullName());\n+                                continue;\n+                            }\n+                            OlapTable olapTable = (OlapTable) table;\n+                            olapTable.readLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQzMDAzMA==", "bodyText": "I think the final result is same if the table is dropped before loop or in loop, we just make sure that it is thread safe, and we has already add committed txn check if user want to drop table during loading data", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r531430030", "createdAt": "2020-11-27T07:47:30Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/transaction/PublishVersionDaemon.java", "diffHunk": "@@ -190,16 +190,18 @@ private void publishVersion() throws UserException {\n                             LOG.warn(\"Database [{}] has been dropped.\", transactionState.getDbId());\n                             continue;\n                         }\n-                        db.readLock();\n-                        try {\n-                            for (int i = 0; i < transactionState.getTableIdList().size(); i++) {\n-                                long tableId = transactionState.getTableIdList().get(i);\n-                                Table table = db.getTable(tableId);\n-                                if (table == null || table.getType() != Table.TableType.OLAP) {\n-                                    LOG.warn(\"Table [{}] in database [{}] has been dropped.\", tableId, db.getFullName());\n-                                    continue;\n-                                }\n-                                OlapTable olapTable = (OlapTable) table;\n+\n+\n+                        for (int i = 0; i < transactionState.getTableIdList().size(); i++) {\n+                            long tableId = transactionState.getTableIdList().get(i);\n+                            Table table = db.getTable(tableId);\n+                            if (table == null || table.getType() != Table.TableType.OLAP) {\n+                                LOG.warn(\"Table [{}] in database [{}] has been dropped.\", tableId, db.getFullName());\n+                                continue;\n+                            }\n+                            OlapTable olapTable = (OlapTable) table;\n+                            olapTable.readLock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM1MDYyOA=="}, "originalCommit": {"oid": "1585a01d6746345b57a61fc904f18ea6a59731bd"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1NzMzMDMwOnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/common/util/MetaLockUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMToxOToyM1rOH-VV8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMjoyOTowMVrOH-ZRLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTEyMzQ0MA==", "bodyText": "I find a corner case as below:\nThere are three threads wants to get table lock:\nT1(thread 1) try lock(TableA,TableB)\nT2(thread 2) try lock(TableB,TableC)\nT3(thread 3) try lock(TableC,TableA)\nIf T1 get TableA's lock  and T2 get TableB's lock and T3 get TableC's lock at the same time ,\nThen three threads try get next table's lock ,dead lock happends.\nT1 try lock TableB, but TableB is held by T2.\nT2 try lock TableC,but TableC is held by T3.\nT3 try lock TableA,but TableA is held by T1.\nCan the current implementation solve this case?", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r535123440", "createdAt": "2020-12-03T11:19:23Z", "author": {"login": "wangbo"}, "path": "fe/fe-core/src/main/java/org/apache/doris/common/util/MetaLockUtils.java", "diffHunk": "@@ -0,0 +1,76 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.common.util;\n+\n+import org.apache.doris.catalog.Database;\n+import org.apache.doris.catalog.Table;\n+\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+public class MetaLockUtils {\n+\n+    public static void readLockDatabases(List<Database> databaseList) {\n+        for (Database database : databaseList) {\n+            database.readLock();\n+        }\n+    }\n+\n+    public static void readUnlockDatabases(List<Database> databaseList) {\n+        for (int i = databaseList.size() - 1; i >= 0; i--) {\n+            databaseList.get(i).readUnlock();\n+        }\n+    }\n+\n+    public static void readLockTables(List<Table> tableList) {\n+        for (Table table : tableList) {\n+            table.readLock();\n+        }\n+    }\n+\n+    public static void readUnlockTables(List<Table> tableList) {\n+        for (int i = tableList.size() - 1; i >= 0; i--) {\n+            tableList.get(i).readUnlock();\n+        }\n+    }\n+\n+    public static void writeLockTables(List<Table> tableList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0df43a0c0b8586ee3b73f579bac1a348485b5d8c"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4Nzc1Nw==", "bodyText": "@wangbo\nIt should not happen, because we should always ensure that all meta sorted by id asc before lock them, otherwise would cause dead lock.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r535187757", "createdAt": "2020-12-03T12:29:01Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/common/util/MetaLockUtils.java", "diffHunk": "@@ -0,0 +1,76 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.common.util;\n+\n+import org.apache.doris.catalog.Database;\n+import org.apache.doris.catalog.Table;\n+\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+public class MetaLockUtils {\n+\n+    public static void readLockDatabases(List<Database> databaseList) {\n+        for (Database database : databaseList) {\n+            database.readLock();\n+        }\n+    }\n+\n+    public static void readUnlockDatabases(List<Database> databaseList) {\n+        for (int i = databaseList.size() - 1; i >= 0; i--) {\n+            databaseList.get(i).readUnlock();\n+        }\n+    }\n+\n+    public static void readLockTables(List<Table> tableList) {\n+        for (Table table : tableList) {\n+            table.readLock();\n+        }\n+    }\n+\n+    public static void readUnlockTables(List<Table> tableList) {\n+        for (int i = tableList.size() - 1; i >= 0; i--) {\n+            tableList.get(i).readUnlock();\n+        }\n+    }\n+\n+    public static void writeLockTables(List<Table> tableList) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTEyMzQ0MA=="}, "originalCommit": {"oid": "0df43a0c0b8586ee3b73f579bac1a348485b5d8c"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MzYxNDA5OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/clone/DynamicPartitionScheduler.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMjozMzowNVrOH_O8Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMzo0NDoyOVrOH_Rf3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2NzEwMg==", "bodyText": "When drop a table from database, a db lock will be held;\nWhy not get a db read lock here when get a table from database.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r536067102", "createdAt": "2020-12-04T12:33:05Z", "author": {"login": "wangbo"}, "path": "fe/fe-core/src/main/java/org/apache/doris/clone/DynamicPartitionScheduler.java", "diffHunk": "@@ -265,17 +265,16 @@ private void executeDynamicPartition() {\n             String tableName;\n             boolean skipAddPartition = false;\n             OlapTable olapTable;\n-            db.readLock();\n+            olapTable = (OlapTable) db.getTable(tableId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17c0d45cad336510b52957be02bc50cfc6499cc1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA4Mjc4OA==", "bodyText": "@wangbo\nbecause when drop table, we need to prevent that other thread drop table or create table too. but for get table, we just need to ensure that the get table operation is thread safe, and the final result is ok, we don't purse the strict consistency here for  better performance.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r536082788", "createdAt": "2020-12-04T13:00:33Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/clone/DynamicPartitionScheduler.java", "diffHunk": "@@ -265,17 +265,16 @@ private void executeDynamicPartition() {\n             String tableName;\n             boolean skipAddPartition = false;\n             OlapTable olapTable;\n-            db.readLock();\n+            olapTable = (OlapTable) db.getTable(tableId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2NzEwMg=="}, "originalCommit": {"oid": "17c0d45cad336510b52957be02bc50cfc6499cc1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA4NDg2MA==", "bodyText": "Another consideration is to avoid deadlock\uff0c all lock sequence is db lock -> table lock -> other lock, and if we has get table lock and sometimes need to get table again from db, there may cause dead lock, so db get table operation not get db read lock anymore", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r536084860", "createdAt": "2020-12-04T13:04:17Z", "author": {"login": "caiconghui"}, "path": "fe/fe-core/src/main/java/org/apache/doris/clone/DynamicPartitionScheduler.java", "diffHunk": "@@ -265,17 +265,16 @@ private void executeDynamicPartition() {\n             String tableName;\n             boolean skipAddPartition = false;\n             OlapTable olapTable;\n-            db.readLock();\n+            olapTable = (OlapTable) db.getTable(tableId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2NzEwMg=="}, "originalCommit": {"oid": "17c0d45cad336510b52957be02bc50cfc6499cc1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEwOTAyMA==", "bodyText": "I get, you mean Performance is ahead of NPE.\nFor the second point about lock sequence .\nI think it should become programming specifications for Doris.\n1 If try to lock multiple tables or dbs, it should use getXXXInOrderMethod.\n2 If try to lock different type locks, lock sequence should be  guaranteed.\n3 The appearance of nested locks of the same type should be avoided.", "url": "https://github.com/apache/incubator-doris/pull/3775#discussion_r536109020", "createdAt": "2020-12-04T13:44:29Z", "author": {"login": "wangbo"}, "path": "fe/fe-core/src/main/java/org/apache/doris/clone/DynamicPartitionScheduler.java", "diffHunk": "@@ -265,17 +265,16 @@ private void executeDynamicPartition() {\n             String tableName;\n             boolean skipAddPartition = false;\n             OlapTable olapTable;\n-            db.readLock();\n+            olapTable = (OlapTable) db.getTable(tableId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2NzEwMg=="}, "originalCommit": {"oid": "17c0d45cad336510b52957be02bc50cfc6499cc1"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1461, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}