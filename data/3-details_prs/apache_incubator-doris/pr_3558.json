{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2NDQ1NTc2", "number": 3558, "title": "report error when subquery in case-when returns empty set", "bodyText": "fix #3483 step2, apply assert rule to subquery in case-when clause", "createdAt": "2020-05-12T02:22:45Z", "url": "https://github.com/apache/incubator-doris/pull/3558", "merged": true, "mergeCommit": {"oid": "a7e1c08624bdc13069df8d8c0e4f6572dddcab2d"}, "closed": true, "closedAt": "2020-05-15T04:32:06Z", "author": {"login": "yangzhg"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgN9p1AH2gAyNDE2NDQ1NTc2OjdjMjY3MmJiYjRjZWE5ODU2ZjE4Zjg1NDUwYmQ1Nzg5NjE1Y2VkOTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchaJieAFqTQxMjMzNTUxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7c2672bbb4cea9856f18f85450bd5789615ced95", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/7c2672bbb4cea9856f18f85450bd5789615ced95", "committedDate": "2020-05-11T11:27:46Z", "message": "report error when subquery in case-when returns empty set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1fe3a3879c4bca2ca5db6516e5ab2bb632679f1", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/c1fe3a3879c4bca2ca5db6516e5ab2bb632679f1", "committedDate": "2020-05-12T02:15:30Z", "message": "report error when subquery in case-when returns empty set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31ce10ee0c63bb41471c6596edad5cac8f374295", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/31ce10ee0c63bb41471c6596edad5cac8f374295", "committedDate": "2020-05-12T04:02:52Z", "message": "add correlated check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58ef16352496f898587100192e2e28f343539069", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/58ef16352496f898587100192e2e28f343539069", "committedDate": "2020-05-12T04:13:10Z", "message": "add correlated check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NzM3MDIz", "url": "https://github.com/apache/incubator-doris/pull/3558#pullrequestreview-409737023", "createdAt": "2020-05-12T06:36:50Z", "commit": {"oid": "58ef16352496f898587100192e2e28f343539069"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNjozNjo1MFrOGT4Asw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNjozNjo1MFrOGT4Asw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5MzgxMQ==", "bodyText": "why do you only throw exception when expr is \u2018when expr\u2019 and \u2018then expr\u2019\uff1f\nWhether to throw an exception when \u2018case expr\u2019 and \u2018else expr\u2019 is not scarlar type\uff1f", "url": "https://github.com/apache/incubator-doris/pull/3558#discussion_r423493811", "createdAt": "2020-05-12T06:36:50Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/analysis/CaseExpr.java", "diffHunk": "@@ -186,6 +189,9 @@ public void analyzeImpl(Analyzer analyzer) throws AnalysisException {\n             // Determine maximum compatible type of the then exprs seen so far.\n             // We will add casts to them at the very end.\n             Expr thenExpr = children.get(i + 1);\n+            if (!thenExpr.getType().isScalarType()) {\n+                throw new AnalysisException(\"subquery in case-when must return scala type\");\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58ef16352496f898587100192e2e28f343539069"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NzQ1NDc5", "url": "https://github.com/apache/incubator-doris/pull/3558#pullrequestreview-409745479", "createdAt": "2020-05-12T06:51:43Z", "commit": {"oid": "58ef16352496f898587100192e2e28f343539069"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNjo1MTo0M1rOGT4amg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNjo1MTo0M1rOGT4amg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwMDQ0Mg==", "bodyText": "why whenExpr must be BinaryPredicate? can we support query \u201cselect case (select sex from table limit 1) when ''1\u201d then 'male' else 'female'\uff1f", "url": "https://github.com/apache/incubator-doris/pull/3558#discussion_r423500442", "createdAt": "2020-05-12T06:51:43Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/analysis/SelectStmt.java", "diffHunk": "@@ -1391,9 +1391,8 @@ private void rewriteSelectList(ExprRewriter rewriter) throws AnalysisException {\n             CaseExpr caseExpr = (CaseExpr) item.getExpr();\n \n             int childIdx = 0;\n-            if (caseExpr.hasCaseExpr()\n-                    && caseExpr.getChild(childIdx++).contains(Predicates.instanceOf(Subquery.class))) {\n-                throw new AnalysisException(\"Only support subquery in binary predicate in case statement.\");\n+            if (caseExpr.hasCaseExpr()) {\n+                childIdx++;\n             }\n             while (childIdx + 2 <= caseExpr.getChildren().size()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58ef16352496f898587100192e2e28f343539069"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NzQ4MzA1", "url": "https://github.com/apache/incubator-doris/pull/3558#pullrequestreview-409748305", "createdAt": "2020-05-12T06:56:39Z", "commit": {"oid": "58ef16352496f898587100192e2e28f343539069"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNjo1NjozOVrOGT4jnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNjo1NjozOVrOGT4jnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwMjc0OA==", "bodyText": "maybe in 1397 line code , \"<=\" need to modify \"<\".\nfor example: case when expr0 then expr1 else expr2.   expr2 will be consider 'when expr' in In the following code", "url": "https://github.com/apache/incubator-doris/pull/3558#discussion_r423502748", "createdAt": "2020-05-12T06:56:39Z", "author": {"login": "wutiangan"}, "path": "fe/src/main/java/org/apache/doris/analysis/SelectStmt.java", "diffHunk": "@@ -1391,9 +1391,8 @@ private void rewriteSelectList(ExprRewriter rewriter) throws AnalysisException {\n             CaseExpr caseExpr = (CaseExpr) item.getExpr();\n \n             int childIdx = 0;\n-            if (caseExpr.hasCaseExpr()\n-                    && caseExpr.getChild(childIdx++).contains(Predicates.instanceOf(Subquery.class))) {\n-                throw new AnalysisException(\"Only support subquery in binary predicate in case statement.\");\n+            if (caseExpr.hasCaseExpr()) {\n+                childIdx++;\n             }\n             while (childIdx + 2 <= caseExpr.getChildren().size()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58ef16352496f898587100192e2e28f343539069"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNTQzNzk3", "url": "https://github.com/apache/incubator-doris/pull/3558#pullrequestreview-410543797", "createdAt": "2020-05-13T02:21:28Z", "commit": {"oid": "58ef16352496f898587100192e2e28f343539069"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab92e25bd6045c558c89501bed3dbebcbe281129", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/ab92e25bd6045c558c89501bed3dbebcbe281129", "committedDate": "2020-05-13T03:17:59Z", "message": "add esle check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c1d4a17fe41714f830ae3e2755405e40c81eadf", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/9c1d4a17fe41714f830ae3e2755405e40c81eadf", "committedDate": "2020-05-13T03:22:24Z", "message": "add esle check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "122ea694784f34f3e851ba13b2706790f9614bec", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/122ea694784f34f3e851ba13b2706790f9614bec", "committedDate": "2020-05-13T03:30:29Z", "message": "add esle check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e17e4343055cfdfc4cb075de89e680bef8dcaf1", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/3e17e4343055cfdfc4cb075de89e680bef8dcaf1", "committedDate": "2020-05-13T06:58:21Z", "message": "add esle check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fff7351182a0ed6897f1d704db59c59d5c646a0d", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/fff7351182a0ed6897f1d704db59c59d5c646a0d", "committedDate": "2020-05-13T07:05:00Z", "message": "add esle check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7480725c52f2942cec0ed49accdb253c52f89a8e", "author": {"user": {"login": "yangzhg", "name": "Zhengguo Yang"}}, "url": "https://github.com/apache/incubator-doris/commit/7480725c52f2942cec0ed49accdb253c52f89a8e", "committedDate": "2020-05-13T12:13:30Z", "message": "add esle check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMzM1NTEx", "url": "https://github.com/apache/incubator-doris/pull/3558#pullrequestreview-412335511", "createdAt": "2020-05-15T04:13:32Z", "commit": {"oid": "7480725c52f2942cec0ed49accdb253c52f89a8e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3052, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}