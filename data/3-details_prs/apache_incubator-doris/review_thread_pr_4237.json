{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMTE4Njcy", "number": 4237, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjo0ODo0OFrOEUl3HQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjo1Mjo1M1rOEUl8TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMDI3MjkzOnYy", "diffSide": "RIGHT", "path": "be/src/common/config.h", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjo0ODo0OFrOG64L4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjo0ODo0OFrOG64L4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM5MTEzOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // If batch size large than brpc_attachment_threashold, use attachment instead\n          \n          \n            \n                // If batch size is larger than brpc_attachment_threshold, use attachment instead\n          \n      \n    \n    \n  \n\nI have a question, why not use threshold directly for all the packets?", "url": "https://github.com/apache/incubator-doris/pull/4237#discussion_r464391138", "createdAt": "2020-08-03T12:48:48Z", "author": {"login": "imay"}, "path": "be/src/common/config.h", "diffHunk": "@@ -519,6 +519,8 @@ namespace config {\n     CONF_Int64(brpc_max_body_size, \"209715200\");\n     // Max unwritten bytes in each socket, if the limit is reached, Socket.Write fails with EOVERCROWDED\n     CONF_Int64(brpc_socket_max_unwritten_bytes, \"67108864\");\n+    // If batch size large than brpc_attachment_threashold, use attachment instead", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00f4d35f14bd6d8ff37258bddf0c2970c7a7ce7e"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMDI4MDY0OnYy", "diffSide": "RIGHT", "path": "be/src/runtime/data_stream_sender.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjo1MToxMFrOG64Qfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjo1MToxMFrOG64Qfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM5MjMxOA==", "bodyText": "why delete origin timer and counter?", "url": "https://github.com/apache/incubator-doris/pull/4237#discussion_r464392318", "createdAt": "2020-08-03T12:51:10Z", "author": {"login": "imay"}, "path": "be/src/runtime/data_stream_sender.cpp", "diffHunk": "@@ -270,12 +277,7 @@ Status DataStreamSender::Channel::add_row(TupleRow* row) {\n }\n \n Status DataStreamSender::Channel::send_current_batch(bool eos) {\n-    {\n-        SCOPED_TIMER(_parent->_serialize_batch_timer);\n-        int uncompressed_bytes = _batch->serialize(&_pb_batch);\n-        COUNTER_UPDATE(_parent->_bytes_sent_counter, RowBatch::get_batch_size(_pb_batch));\n-        COUNTER_UPDATE(_parent->_uncompressed_bytes_counter, uncompressed_bytes);\n-    }\n+    _parent->serialize_batch(_batch.get(), &_pb_batch, 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00f4d35f14bd6d8ff37258bddf0c2970c7a7ce7e"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMDI4NjIwOnYy", "diffSide": "RIGHT", "path": "be/src/runtime/data_stream_sender.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjo1Mjo1M1rOG64T2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjo1Mjo1M1rOG64T2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM5MzE3OA==", "bodyText": "Will this variable will cause memory leak?", "url": "https://github.com/apache/incubator-doris/pull/4237#discussion_r464393178", "createdAt": "2020-08-03T12:52:53Z", "author": {"login": "imay"}, "path": "be/src/runtime/data_stream_sender.cpp", "diffHunk": "@@ -227,7 +227,14 @@ Status DataStreamSender::Channel::send_batch(PRowBatch* batch, bool eos) {\n     }\n \n     _brpc_request.set_eos(eos);\n-    if (batch != nullptr) {\n+    if (batch != nullptr && RowBatch::get_batch_size(*batch) > config::brpc_socket_max_unwritten_bytes) {\n+        std::string* tuple_data_to_attachment = batch->release_tuple_data();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00f4d35f14bd6d8ff37258bddf0c2970c7a7ce7e"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1273, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}