{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5NTI1ODYx", "number": 3267, "title": "[Bug] Fix some bugs of install/uninstall plugins", "bodyText": "Avoid losing plugin if plugin failed to load when replaying\nWhen in replay process, the plugin should always be added to the plugin manager,\neven if that plugin failed to be loaded.\n\n\nshow plugin statement should show all plugins, not only the successfully installed plugins.\n\n\nplugin's name should be unique globally and case insensitive.\n\n\nAvoid creating new instances of plugins when doing metadata checkpoint.\n\n\nAdd a _builtin prefix for builtin plugins.\n\n\nISSUE: #3266", "createdAt": "2020-04-06T09:59:36Z", "url": "https://github.com/apache/incubator-doris/pull/3267", "merged": true, "mergeCommit": {"oid": "ce1d5ab9ab0461cf5c245a08825b9c999b5670f9"}, "closed": true, "closedAt": "2020-04-09T15:04:28Z", "author": {"login": "morningman"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcU7FDQgH2gAyMzk5NTI1ODYxOmViNTA0YTlhM2Q3MGNiNzIzN2IwN2UwMTdhNzg5Y2Q1MmZjODE4ODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcV90BDgFqTM5MDg3MzQ0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eb504a9a3d70cb7237b07e017a789cd52fc81889", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/eb504a9a3d70cb7237b07e017a789cd52fc81889", "committedDate": "2020-04-06T09:14:29Z", "message": "[Bug] Fix some bugs of install/uninstall plugins\n\n1. Avoid losing plugin if plugin failed to load when replaying\n    When in replay process, the plugin should always be added to the plugin manager,\n    even if that plugin failed to be loaded.\n\n2. `show plugin` statement should show all plugins, not only the successfully installed plugins.\n\n3. plugin's name should be unique globally and case insensitive.\n\n4. Avoid creating new instances of plugins when doing metadata checkpoint.\n\n5. Add a __builtin_ prefix for builtin plugins."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c47b7595eb1f252db6863132a9a8198a004fc62e", "author": {"user": {"login": "morningman", "name": "Mingyu Chen"}}, "url": "https://github.com/apache/incubator-doris/commit/c47b7595eb1f252db6863132a9a8198a004fc62e", "committedDate": "2020-04-07T03:40:00Z", "message": "add comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4Nzc1NTEz", "url": "https://github.com/apache/incubator-doris/pull/3267#pullrequestreview-388775513", "createdAt": "2020-04-07T04:29:45Z", "commit": {"oid": "c47b7595eb1f252db6863132a9a8198a004fc62e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzgwMjg4", "url": "https://github.com/apache/incubator-doris/pull/3267#pullrequestreview-388780288", "createdAt": "2020-04-07T04:46:21Z", "commit": {"oid": "eb504a9a3d70cb7237b07e017a789cd52fc81889"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNDo0NjoyMlrOGByr9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNDo0NjoyMlrOGByr9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUzMjIxMw==", "bodyText": "Maybe you need ConcurrentSkipListSet? I guess", "url": "https://github.com/apache/incubator-doris/pull/3267#discussion_r404532213", "createdAt": "2020-04-07T04:46:22Z", "author": {"login": "Seaven"}, "path": "fe/src/main/java/org/apache/doris/plugin/PluginMgr.java", "diffHunk": "@@ -41,17 +43,23 @@\n import java.util.List;\n import java.util.Map;\n import java.util.Objects;\n+import java.util.Set;\n \n public class PluginMgr implements Writable {\n     private final static Logger LOG = LogManager.getLogger(PluginMgr.class);\n \n+    public final static String BUILTIN_PLUGIN_PREFIX = \"__builtin_\";\n+\n     private final Map<String, PluginLoader>[] plugins;\n+    // all dynamic plugins should have unique names,\n+    private final Set<String> dynamicPluginNames;\n \n     public PluginMgr() {\n-        plugins = new Map[PluginType.MAX_PLUGIN_SIZE];\n-        for (int i = 0; i < PluginType.MAX_PLUGIN_SIZE; i++) {\n-            plugins[i] = Maps.newConcurrentMap();\n+        plugins = new Map[PluginType.MAX_PLUGIN_TYPE_SIZE];\n+        for (int i = 0; i < PluginType.MAX_PLUGIN_TYPE_SIZE; i++) {\n+            plugins[i] = Maps.newTreeMap(String.CASE_INSENSITIVE_ORDER);\n         }\n+        dynamicPluginNames = Sets.newTreeSet(String.CASE_INSENSITIVE_ORDER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb504a9a3d70cb7237b07e017a789cd52fc81889"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzgzMTky", "url": "https://github.com/apache/incubator-doris/pull/3267#pullrequestreview-388783192", "createdAt": "2020-04-07T04:56:25Z", "commit": {"oid": "eb504a9a3d70cb7237b07e017a789cd52fc81889"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNDo1NjoyNVrOGBy2UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNDo1NjoyNVrOGBy2UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUzNDg2NQ==", "bodyText": "Using two containers does not avoid concurrency problems", "url": "https://github.com/apache/incubator-doris/pull/3267#discussion_r404534865", "createdAt": "2020-04-07T04:56:25Z", "author": {"login": "Seaven"}, "path": "fe/src/main/java/org/apache/doris/plugin/PluginMgr.java", "diffHunk": "@@ -86,25 +112,26 @@ public PluginInfo installPlugin(InstallPluginStmt stmt) throws IOException, User\n \n         try {\n             PluginInfo info = pluginLoader.getPluginInfo();\n-\n-            if (plugins[info.getTypeId()].containsKey(info.getName())) {\n+            \n+            if (checkDynamicPluginNameExist(info.getName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb504a9a3d70cb7237b07e017a789cd52fc81889"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzgzNjg4", "url": "https://github.com/apache/incubator-doris/pull/3267#pullrequestreview-388783688", "createdAt": "2020-04-07T04:58:09Z", "commit": {"oid": "eb504a9a3d70cb7237b07e017a789cd52fc81889"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNDo1ODoxMFrOGBy4GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNDo1ODoxMFrOGBy4GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUzNTMyMQ==", "bodyText": "Can't uninstall in there, will cause uninstall and delete real plugin if install same plugin", "url": "https://github.com/apache/incubator-doris/pull/3267#discussion_r404535321", "createdAt": "2020-04-07T04:58:10Z", "author": {"login": "Seaven"}, "path": "fe/src/main/java/org/apache/doris/plugin/PluginMgr.java", "diffHunk": "@@ -86,25 +112,26 @@ public PluginInfo installPlugin(InstallPluginStmt stmt) throws IOException, User\n \n         try {\n             PluginInfo info = pluginLoader.getPluginInfo();\n-\n-            if (plugins[info.getTypeId()].containsKey(info.getName())) {\n+            \n+            if (checkDynamicPluginNameExist(info.getName())) {\n                 throw new UserException(\"plugin \" + info.getName() + \" has already been installed.\");\n             }\n             \n             // install plugin\n             pluginLoader.install();\n             pluginLoader.setStatus(PluginStatus.INSTALLED);\n             \n-            if (plugins[info.getTypeId()].putIfAbsent(info.getName(), pluginLoader) != null) {\n-                pluginLoader.uninstall();\n+            if (!addDynamicPluginNameIfAbsent(info.getName())) {\n                 throw new UserException(\"plugin \" + info.getName() + \" has already been installed.\");\n             }\n-\n+            \n+            plugins[info.getTypeId()].put(info.getName(), pluginLoader);\n+            \n             Catalog.getCurrentCatalog().getEditLog().logInstallPlugin(info);\n-            LOG.info(\"install plugin = \" + info.getName());\n+            LOG.info(\"install plugin {}\", info.getName());\n             return info;\n         } catch (IOException | UserException e) {\n-            pluginLoader.setStatus(PluginStatus.ERROR);\n+            pluginLoader.uninstall();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb504a9a3d70cb7237b07e017a789cd52fc81889"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4Nzg2NDM1", "url": "https://github.com/apache/incubator-doris/pull/3267#pullrequestreview-388786435", "createdAt": "2020-04-07T05:07:51Z", "commit": {"oid": "eb504a9a3d70cb7237b07e017a789cd52fc81889"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNTowNzo1MVrOGBzCHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNTowNzo1MVrOGBzCHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUzNzg4NQ==", "bodyText": "It is a good idea not to use PluginInfo for persist", "url": "https://github.com/apache/incubator-doris/pull/3267#discussion_r404537885", "createdAt": "2020-04-07T05:07:51Z", "author": {"login": "Seaven"}, "path": "fe/src/main/java/org/apache/doris/plugin/PluginMgr.java", "diffHunk": "@@ -113,30 +140,47 @@ public PluginInfo installPlugin(InstallPluginStmt stmt) throws IOException, User\n      * Dynamic uninstall plugin\n      */\n     public PluginInfo uninstallPlugin(String name) throws IOException, UserException {\n-        for (int i = 0; i < PluginType.MAX_PLUGIN_SIZE; i++) {\n+        if (!checkDynamicPluginNameExist(name)) {\n+            throw new DdlException(\"Plugin \" + name + \" does not exist\");\n+        }\n+\n+        for (int i = 0; i < PluginType.MAX_PLUGIN_TYPE_SIZE; i++) {\n             if (plugins[i].containsKey(name)) {\n                 PluginLoader loader = plugins[i].get(name);\n+                if (loader == null) {\n+                    // this is not a atomic operation, so even if containsKey() is true,\n+                    // we may still get null object by get() method\n+                    continue;\n+                }\n \n-                if (null != loader && loader.isDynamicPlugin()) {\n-                    loader.pluginUninstallValid();\n-                    loader.setStatus(PluginStatus.UNINSTALLING);\n-                    // uninstall plugin\n-                    loader.uninstall();\n-                    plugins[i].remove(name);\n-\n-                    loader.setStatus(PluginStatus.UNINSTALLED);\n-                    return loader.getPluginInfo();\n+                if (!loader.isDynamicPlugin()) {\n+                    throw new DdlException(\"Only support uninstall dynamic plugins\");\n                 }\n+\n+                loader.pluginUninstallValid();\n+                loader.setStatus(PluginStatus.UNINSTALLING);\n+                // uninstall plugin\n+                loader.uninstall();\n+                plugins[i].remove(name);\n+                loader.setStatus(PluginStatus.UNINSTALLED);\n+                removeDynamicPluginName(name);\n+\n+                // do not get plugin info by calling loader.getPluginInfo(). That method will try to\n+                // reload the plugin properties from source if this plugin is not installed successfully.\n+                // Here we only need the plugin's name for persisting.\n+                // TODO(cmy): This is a bad design to couple the persist info with PluginInfo, but for\n+                // the compatibility, I till use this method.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb504a9a3d70cb7237b07e017a789cd52fc81889"}, "originalPosition": 155}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDU1OTg5", "url": "https://github.com/apache/incubator-doris/pull/3267#pullrequestreview-390455989", "createdAt": "2020-04-09T02:42:35Z", "commit": {"oid": "c47b7595eb1f252db6863132a9a8198a004fc62e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwODczNDQx", "url": "https://github.com/apache/incubator-doris/pull/3267#pullrequestreview-390873441", "createdAt": "2020-04-09T14:59:31Z", "commit": {"oid": "c47b7595eb1f252db6863132a9a8198a004fc62e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3169, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}