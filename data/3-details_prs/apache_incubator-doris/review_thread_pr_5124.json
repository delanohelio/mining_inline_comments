{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0MTM1NTc5", "number": 5124, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQwOTo1NToxOVrOFLNxkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOVQwNTozMToxMVrOFMvPIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3MzA0MzM4OnYy", "diffSide": "RIGHT", "path": "be/src/olap/olap_server.cpp", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQwOTo1NToxOVrOIOQ3cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwNzoxMTo0NFrOIO0LVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgyNzMxNQ==", "bodyText": "You defined it as a mutable config, you should reassign interval  in while loop.", "url": "https://github.com/apache/incubator-doris/pull/5124#discussion_r551827315", "createdAt": "2021-01-05T09:55:19Z", "author": {"login": "acelyc111"}, "path": "be/src/olap/olap_server.cpp", "diffHunk": "@@ -314,6 +314,7 @@ void StorageEngine::_compaction_tasks_producer_callback() {\n     ProfilerRegisterThread();\n #endif\n     LOG(INFO) << \"try to start compaction producer process!\";\n+    int64_t interval = config::generate_compaction_tasks_min_interval_ms;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2ab4f2a9cd5fc65e66072f393a19227bbb73b3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQwNTg0Nw==", "bodyText": "It sounds reasonable.", "url": "https://github.com/apache/incubator-doris/pull/5124#discussion_r552405847", "createdAt": "2021-01-06T07:11:44Z", "author": {"login": "weizuo93"}, "path": "be/src/olap/olap_server.cpp", "diffHunk": "@@ -314,6 +314,7 @@ void StorageEngine::_compaction_tasks_producer_callback() {\n     ProfilerRegisterThread();\n #endif\n     LOG(INFO) << \"try to start compaction producer process!\";\n+    int64_t interval = config::generate_compaction_tasks_min_interval_ms;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgyNzMxNQ=="}, "originalCommit": {"oid": "ff2ab4f2a9cd5fc65e66072f393a19227bbb73b3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ4OTAwOTYwOnYy", "diffSide": "RIGHT", "path": "be/src/olap/olap_server.cpp", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOVQwNToyNzozM1rOIQncRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQwOToxOToyN1rOIRM_1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDI5NDM0MQ==", "bodyText": "Need to call THREAD_JOIN(_compaction_tasks_producer_thread); in StorageEngine::stop(), otherwise it's still unsafe as described in #5213", "url": "https://github.com/apache/incubator-doris/pull/5124#discussion_r554294341", "createdAt": "2021-01-09T05:27:33Z", "author": {"login": "acelyc111"}, "path": "be/src/olap/olap_server.cpp", "diffHunk": "@@ -390,7 +379,7 @@ void StorageEngine::_compaction_tasks_producer_callback() {\n         } else {\n             sleep(config::check_auto_compaction_interval_seconds);\n         }\n-    }\n+    } while (!_stop_background_threads_latch.wait_for(MonoDelta::FromMilliseconds(interval)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4744306d2072640eed7b2a3ad73a500f9e1f3fd9"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDMwNjc4Mg==", "bodyText": "OK.", "url": "https://github.com/apache/incubator-doris/pull/5124#discussion_r554306782", "createdAt": "2021-01-09T07:53:09Z", "author": {"login": "weizuo93"}, "path": "be/src/olap/olap_server.cpp", "diffHunk": "@@ -390,7 +379,7 @@ void StorageEngine::_compaction_tasks_producer_callback() {\n         } else {\n             sleep(config::check_auto_compaction_interval_seconds);\n         }\n-    }\n+    } while (!_stop_background_threads_latch.wait_for(MonoDelta::FromMilliseconds(interval)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDI5NDM0MQ=="}, "originalCommit": {"oid": "4744306d2072640eed7b2a3ad73a500f9e1f3fd9"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDg4MTY5Mw==", "bodyText": "@weizuo93 @acelyc111\nIs _compaction_thread_pool also need call shutdown?\nIt seems _compaction_thread_pool still depend on 'this->_permit_limiter'", "url": "https://github.com/apache/incubator-doris/pull/5124#discussion_r554881693", "createdAt": "2021-01-11T08:22:41Z", "author": {"login": "stdpain"}, "path": "be/src/olap/olap_server.cpp", "diffHunk": "@@ -390,7 +379,7 @@ void StorageEngine::_compaction_tasks_producer_callback() {\n         } else {\n             sleep(config::check_auto_compaction_interval_seconds);\n         }\n-    }\n+    } while (!_stop_background_threads_latch.wait_for(MonoDelta::FromMilliseconds(interval)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDI5NDM0MQ=="}, "originalCommit": {"oid": "4744306d2072640eed7b2a3ad73a500f9e1f3fd9"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDkwOTY1Mg==", "bodyText": "@stdpain\n_compaction_thread_pool has been shutdown in ~StorageEngine().", "url": "https://github.com/apache/incubator-doris/pull/5124#discussion_r554909652", "createdAt": "2021-01-11T09:19:27Z", "author": {"login": "weizuo93"}, "path": "be/src/olap/olap_server.cpp", "diffHunk": "@@ -390,7 +379,7 @@ void StorageEngine::_compaction_tasks_producer_callback() {\n         } else {\n             sleep(config::check_auto_compaction_interval_seconds);\n         }\n-    }\n+    } while (!_stop_background_threads_latch.wait_for(MonoDelta::FromMilliseconds(interval)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDI5NDM0MQ=="}, "originalCommit": {"oid": "4744306d2072640eed7b2a3ad73a500f9e1f3fd9"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ4OTAxMTU0OnYy", "diffSide": "RIGHT", "path": "be/src/olap/olap_server.cpp", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOVQwNTozMToxMVrOIQndLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQwMjozOTo1N1rOITNCAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDI5NDU3Mg==", "bodyText": "What's the reason not use std::set?", "url": "https://github.com/apache/incubator-doris/pull/5124#discussion_r554294572", "createdAt": "2021-01-09T05:31:11Z", "author": {"login": "acelyc111"}, "path": "be/src/olap/olap_server.cpp", "diffHunk": "@@ -412,4 +401,26 @@ std::vector<TabletSharedPtr> StorageEngine::_compaction_tasks_generator(\n     }\n     return tablets_compaction;\n }\n+\n+void StorageEngine::_push_tablet_into_submitted_compaction(TabletSharedPtr tablet) {\n+    std::unique_lock<std::mutex> lock(_tablet_submitted_compaction_mutex);\n+    _tablet_submitted_compaction[tablet->data_dir()].emplace_back(\n+            tablet->tablet_id());\n+}\n+\n+void StorageEngine::_pop_tablet_from_submitted_compaction(TabletSharedPtr tablet) {\n+    std::unique_lock<std::mutex> lock(_tablet_submitted_compaction_mutex);\n+    std::vector<TTabletId>::iterator it_tablet =\n+            find(_tablet_submitted_compaction[tablet->data_dir()].begin(),\n+                 _tablet_submitted_compaction[tablet->data_dir()].end(),\n+                 tablet->tablet_id());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4744306d2072640eed7b2a3ad73a500f9e1f3fd9"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjMyMzgyNg==", "bodyText": "You can do this refactor in another PR.", "url": "https://github.com/apache/incubator-doris/pull/5124#discussion_r556323826", "createdAt": "2021-01-13T07:55:40Z", "author": {"login": "acelyc111"}, "path": "be/src/olap/olap_server.cpp", "diffHunk": "@@ -412,4 +401,26 @@ std::vector<TabletSharedPtr> StorageEngine::_compaction_tasks_generator(\n     }\n     return tablets_compaction;\n }\n+\n+void StorageEngine::_push_tablet_into_submitted_compaction(TabletSharedPtr tablet) {\n+    std::unique_lock<std::mutex> lock(_tablet_submitted_compaction_mutex);\n+    _tablet_submitted_compaction[tablet->data_dir()].emplace_back(\n+            tablet->tablet_id());\n+}\n+\n+void StorageEngine::_pop_tablet_from_submitted_compaction(TabletSharedPtr tablet) {\n+    std::unique_lock<std::mutex> lock(_tablet_submitted_compaction_mutex);\n+    std::vector<TTabletId>::iterator it_tablet =\n+            find(_tablet_submitted_compaction[tablet->data_dir()].begin(),\n+                 _tablet_submitted_compaction[tablet->data_dir()].end(),\n+                 tablet->tablet_id());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDI5NDU3Mg=="}, "originalCommit": {"oid": "4744306d2072640eed7b2a3ad73a500f9e1f3fd9"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzAwNzM2MQ==", "bodyText": "OK.", "url": "https://github.com/apache/incubator-doris/pull/5124#discussion_r557007361", "createdAt": "2021-01-14T02:39:57Z", "author": {"login": "weizuo93"}, "path": "be/src/olap/olap_server.cpp", "diffHunk": "@@ -412,4 +401,26 @@ std::vector<TabletSharedPtr> StorageEngine::_compaction_tasks_generator(\n     }\n     return tablets_compaction;\n }\n+\n+void StorageEngine::_push_tablet_into_submitted_compaction(TabletSharedPtr tablet) {\n+    std::unique_lock<std::mutex> lock(_tablet_submitted_compaction_mutex);\n+    _tablet_submitted_compaction[tablet->data_dir()].emplace_back(\n+            tablet->tablet_id());\n+}\n+\n+void StorageEngine::_pop_tablet_from_submitted_compaction(TabletSharedPtr tablet) {\n+    std::unique_lock<std::mutex> lock(_tablet_submitted_compaction_mutex);\n+    std::vector<TTabletId>::iterator it_tablet =\n+            find(_tablet_submitted_compaction[tablet->data_dir()].begin(),\n+                 _tablet_submitted_compaction[tablet->data_dir()].end(),\n+                 tablet->tablet_id());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDI5NDU3Mg=="}, "originalCommit": {"oid": "4744306d2072640eed7b2a3ad73a500f9e1f3fd9"}, "originalPosition": 90}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 838, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}