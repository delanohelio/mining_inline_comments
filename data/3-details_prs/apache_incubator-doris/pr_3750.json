{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NDgyNDQ1", "number": 3750, "title": "[Bug] Fix a bug that tablet may be modified to BETA_ROWSET after cloned", "bodyText": "TabletMeta's _preferred_rowset_type is not initialized after object constructing and\nmay be a random value, and this field is not updated when create ALPHA_ROWSET tablet,\nand it will not be serialized into pb in this case. So if cloning an ALPHA_ROWSET\ntablet from another BE, this new created local tablet's _preferred_rowset_type field\nmay be random as BETA_ROWSET and can not be overwrote after cloned, then new input\nrows will be wrote as BETA_ROWSET format which is not we expect.\nThis patch fix this bug by giving _preferred_rowset_type a default value and updating\nthis field when create any type of tablet, and add an unit test and related overwrite\nequal operator functions.", "createdAt": "2020-06-02T10:03:52Z", "url": "https://github.com/apache/incubator-doris/pull/3750", "merged": true, "mergeCommit": {"oid": "3b6a781862abb5475c226da79b431510171c4756"}, "closed": true, "closedAt": "2020-06-06T03:36:29Z", "author": {"login": "acelyc111"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnRrTmgH2gAyNDI2NDgyNDQ1OmMzNWM4MzVmNzk1YzhmZTI2ZDVkOGM4MTc5YWMxM2E4YjVlYjhmNzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoJI2gAFqTQyNDk1NDg0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c35c835f795c8fe26d5d8c8179ac13a8b5eb8f76", "author": {"user": {"login": "acelyc111", "name": "Yingchun Lai"}}, "url": "https://github.com/apache/incubator-doris/commit/c35c835f795c8fe26d5d8c8179ac13a8b5eb8f76", "committedDate": "2020-06-02T09:44:49Z", "message": "[Bug] Fix a bug that tablet's _preferred_rowset_type may be modified to BETA_ROWSET after cloned\n\nTabletMeta's _preferred_rowset_type is not initialized after object constructing and\nmay be a random value, and this field is not updated when create ALPHA_ROWSET tablet,\nand it will not be serialized into pb in this case. So if cloning an ALPHA_ROWSET\ntablet from another BE, this new created local tablet's _preferred_rowset_type field\nmay be random as BETA_ROWSET and can not be overwrote after cloned, then new input\nrows will be wrote as BETA_ROWSET format which is not we expect.\nThis patch fix this bug by giving _preferred_rowset_type a default value and updating\nthis field when create any type of tablet, and add an unit test and related overwrite\nequal operator functions."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNjUwNjE2", "url": "https://github.com/apache/incubator-doris/pull/3750#pullrequestreview-422650616", "createdAt": "2020-06-02T13:00:59Z", "commit": {"oid": "c35c835f795c8fe26d5d8c8179ac13a8b5eb8f76"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzowMTowMFrOGdweJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzowMTowMFrOGdweJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1NjAzNg==", "bodyText": "I am not sure, but did you miss the _num_short_key_columns here?", "url": "https://github.com/apache/incubator-doris/pull/3750#discussion_r433856036", "createdAt": "2020-06-02T13:01:00Z", "author": {"login": "morningman"}, "path": "be/src/olap/tablet_schema.cpp", "diffHunk": "@@ -337,14 +337,12 @@ void TabletColumn::to_schema_pb(ColumnPB* column) {\n     }\n }\n \n-TabletSchema::TabletSchema()\n-    : _num_columns(0),\n-      _num_key_columns(0),\n-      _num_null_columns(0),\n-      _num_short_key_columns(0) { }\n-\n void TabletSchema::init_from_pb(const TabletSchemaPB& schema) {\n     _keys_type = schema.keys_type();\n+    _num_columns = 0;\n+    _num_key_columns = 0;\n+    _num_null_columns = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c35c835f795c8fe26d5d8c8179ac13a8b5eb8f76"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NTU5MDU3", "url": "https://github.com/apache/incubator-doris/pull/3750#pullrequestreview-424559057", "createdAt": "2020-06-04T15:18:59Z", "commit": {"oid": "c35c835f795c8fe26d5d8c8179ac13a8b5eb8f76"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNToxODo1OVrOGfLFZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNToxODo1OVrOGfLFZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM0MDY0Nw==", "bodyText": "Is this function used?", "url": "https://github.com/apache/incubator-doris/pull/3750#discussion_r435340647", "createdAt": "2020-06-04T15:18:59Z", "author": {"login": "imay"}, "path": "be/src/olap/tablet_schema.h", "diffHunk": "@@ -107,22 +113,30 @@ class TabletSchema {\n     inline void set_is_in_memory (bool is_in_memory) {\n         _is_in_memory = is_in_memory;\n     }\n+\n private:\n-    KeysType _keys_type;\n+    friend bool operator==(const TabletSchema& a, const TabletSchema& b);\n+    friend bool operator!=(const TabletSchema& a, const TabletSchema& b);\n+\n+private:\n+    KeysType _keys_type = DUP_KEYS;\n     std::vector<TabletColumn> _cols;\n-    size_t _num_columns;\n-    size_t _num_key_columns;\n-    size_t _num_null_columns;\n-    size_t _num_short_key_columns;\n-    size_t _num_rows_per_row_block;\n-    CompressKind _compress_kind;\n-    size_t _next_column_unique_id;\n+    size_t _num_columns = 0;\n+    size_t _num_key_columns = 0;\n+    size_t _num_null_columns = 0;\n+    size_t _num_short_key_columns = 0;\n+    size_t _num_rows_per_row_block = 0;\n+    CompressKind _compress_kind = COMPRESS_NONE;\n+    size_t _next_column_unique_id = 0;\n \n     bool _has_bf_fpp = false;\n     double _bf_fpp = 0;\n     bool _is_in_memory = false;\n };\n \n+bool operator==(const TabletSchema& a, const TabletSchema& b);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c35c835f795c8fe26d5d8c8179ac13a8b5eb8f76"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0OTU0ODQy", "url": "https://github.com/apache/incubator-doris/pull/3750#pullrequestreview-424954842", "createdAt": "2020-06-05T02:21:52Z", "commit": {"oid": "c35c835f795c8fe26d5d8c8179ac13a8b5eb8f76"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2419, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}