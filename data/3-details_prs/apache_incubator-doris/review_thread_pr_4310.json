{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MjY5MTA2", "number": 4310, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTozMjo0NFrOEWuHTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTozMTowOFrOEZGHxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjU5NjYxOnYy", "diffSide": "RIGHT", "path": "be/src/olap/field.h", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTozMjo0NFrOG-Hhvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTozMjo0NFrOG-Hhvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc4ODIyMg==", "bodyText": "Place _name under _key_coder could make a lesser size of Field.", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r467788222", "createdAt": "2020-08-10T09:32:44Z", "author": {"login": "sduzh"}, "path": "be/src/olap/field.h", "diffHunk": "@@ -261,6 +262,7 @@ class Field {\n     const KeyCoder* _key_coder;\n     uint16_t _index_size;\n     bool _is_nullable;\n+    std::string _name;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "984dddff1743e8754cc53dc6be7c86f98cc45629"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjYwNDk4OnYy", "diffSide": "RIGHT", "path": "be/src/olap/field.h", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTozNTowOVrOG-Hmuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTozNTowOVrOG-Hmuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc4OTQ5OQ==", "bodyText": "const std::string& name() const { return _name; }", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r467789499", "createdAt": "2020-08-10T09:35:09Z", "author": {"login": "sduzh"}, "path": "be/src/olap/field.h", "diffHunk": "@@ -55,6 +55,7 @@ class Field {\n     inline int32_t length() const { return _length; }\n     inline size_t field_size() const { return size() + 1; }\n     inline size_t index_size() const { return _index_size; }\n+    inline std::string name() const { return _name; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "984dddff1743e8754cc53dc6be7c86f98cc45629"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjYxNjQ4OnYy", "diffSide": "RIGHT", "path": "be/src/olap/schema.h", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTozODo0N1rOG-HtbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTozODo0N1rOG-HtbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5MTIxMg==", "bodyText": "std::vector::at has extra runtime overhead, compared with operator[].", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r467791212", "createdAt": "2020-08-10T09:38:47Z", "author": {"login": "sduzh"}, "path": "be/src/olap/schema.h", "diffHunk": "@@ -53,19 +53,21 @@ class Schema {\n             }\n             columns.push_back(column);\n         }\n-\n+        _delete_sign_idx = tablet_schema.delete_sign_idx();\n         _init(columns, col_ids, num_key_columns);\n     }\n \n     // All the columns of one table may exist in the columns param, but col_ids is only a subset.\n     Schema(const std::vector<TabletColumn>& columns, const std::vector<ColumnId>& col_ids) {\n         size_t num_key_columns = 0;\n-        for (const auto& c: columns) {\n-            if (c.is_key()) {\n+        for (size_t i = 0; i < columns.size(); ++i) {\n+            if (columns.at(i).is_key()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "984dddff1743e8754cc53dc6be7c86f98cc45629"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NzQzODgxOnYy", "diffSide": "RIGHT", "path": "fe/fe-core/pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNToxNjo0OFrOHBtI8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMjozNzo0MFrOHCBOSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1MDE5Mw==", "bodyText": "Why?", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r471550193", "createdAt": "2020-08-17T15:16:48Z", "author": {"login": "morningman"}, "path": "fe/fe-core/pom.xml", "diffHunk": "@@ -36,7 +36,7 @@ under the License.\n \n     <properties>\n         <doris.home>${basedir}/../../</doris.home>\n-        <fe_ut_parallel>${env.FE_UT_PARALLEL}</fe_ut_parallel>\n+        <fe_ut_parallel>1</fe_ut_parallel>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg3OTI0MQ==", "bodyText": "This can avoid the problem that intilj will prompt a pom syntax error when the environment variable is not set", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r471879241", "createdAt": "2020-08-18T02:37:40Z", "author": {"login": "yangzhg"}, "path": "fe/fe-core/pom.xml", "diffHunk": "@@ -36,7 +36,7 @@ under the License.\n \n     <properties>\n         <doris.home>${basedir}/../../</doris.home>\n-        <fe_ut_parallel>${env.FE_UT_PARALLEL}</fe_ut_parallel>\n+        <fe_ut_parallel>1</fe_ut_parallel>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1MDE5Mw=="}, "originalCommit": {"oid": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NzQ2MjY1OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/AlterTableStmt.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNToyMjowMlrOHBtXTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwODozMTo1MVrOHD0JKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1Mzg3MQ==", "bodyText": "miss to modify the base index?", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r471553871", "createdAt": "2020-08-17T15:22:02Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/AlterTableStmt.java", "diffHunk": "@@ -70,6 +76,50 @@ public void analyze(Analyzer analyzer) throws UserException {\n         }\n     }\n \n+    public void rewriteAlterClause(OlapTable table) throws UserException {\n+        List<AlterClause> clauses = new ArrayList<>();\n+        for (AlterClause alterClause : ops) {\n+            if (alterClause instanceof EnableFeatureClause\n+                    && ((EnableFeatureClause) alterClause).getFeature() == EnableFeatureClause.Features.BATCH_DELETE) {\n+                if (table.getKeysType() != KeysType.UNIQUE_KEYS) {\n+                    throw new AnalysisException(\"Batch delete only support in unique tables.\");\n+                }\n+                // has rollup table\n+                if (table.getVisibleIndex().size() > 1) {\n+                    for (MaterializedIndex idx : table.getVisibleIndex()) {\n+                        if (idx.getId() == table.getBaseIndexId()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg3ODU1MQ==", "bodyText": "add  a column to rollup index it will add to base table automaticlly, if add a column here it will duplicated", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r471878551", "createdAt": "2020-08-18T02:34:52Z", "author": {"login": "yangzhg"}, "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/AlterTableStmt.java", "diffHunk": "@@ -70,6 +76,50 @@ public void analyze(Analyzer analyzer) throws UserException {\n         }\n     }\n \n+    public void rewriteAlterClause(OlapTable table) throws UserException {\n+        List<AlterClause> clauses = new ArrayList<>();\n+        for (AlterClause alterClause : ops) {\n+            if (alterClause instanceof EnableFeatureClause\n+                    && ((EnableFeatureClause) alterClause).getFeature() == EnableFeatureClause.Features.BATCH_DELETE) {\n+                if (table.getKeysType() != KeysType.UNIQUE_KEYS) {\n+                    throw new AnalysisException(\"Batch delete only support in unique tables.\");\n+                }\n+                // has rollup table\n+                if (table.getVisibleIndex().size() > 1) {\n+                    for (MaterializedIndex idx : table.getVisibleIndex()) {\n+                        if (idx.getId() == table.getBaseIndexId()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1Mzg3MQ=="}, "originalCommit": {"oid": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc2MjA4OQ==", "bodyText": "Ok, better to add a comment here", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r473762089", "createdAt": "2020-08-20T08:31:51Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/AlterTableStmt.java", "diffHunk": "@@ -70,6 +76,50 @@ public void analyze(Analyzer analyzer) throws UserException {\n         }\n     }\n \n+    public void rewriteAlterClause(OlapTable table) throws UserException {\n+        List<AlterClause> clauses = new ArrayList<>();\n+        for (AlterClause alterClause : ops) {\n+            if (alterClause instanceof EnableFeatureClause\n+                    && ((EnableFeatureClause) alterClause).getFeature() == EnableFeatureClause.Features.BATCH_DELETE) {\n+                if (table.getKeysType() != KeysType.UNIQUE_KEYS) {\n+                    throw new AnalysisException(\"Batch delete only support in unique tables.\");\n+                }\n+                // has rollup table\n+                if (table.getVisibleIndex().size() > 1) {\n+                    for (MaterializedIndex idx : table.getVisibleIndex()) {\n+                        if (idx.getId() == table.getBaseIndexId()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1Mzg3MQ=="}, "originalCommit": {"oid": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NzUwMTQ4OnYy", "diffSide": "RIGHT", "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/DataDescription.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTozMTowOFrOHBtvFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTozMTowOFrOHBtvFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1OTk1OA==", "bodyText": "code style", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r471559958", "createdAt": "2020-08-17T15:31:08Z", "author": {"login": "morningman"}, "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/DataDescription.java", "diffHunk": "@@ -172,6 +183,9 @@ public DataDescription(String tableName,\n         this.columnMappingList = columnMappingList;\n         this.whereExpr = whereExpr;\n         this.srcTableName = srcTableName;\n+        this.mergeType = mergeType;\n+        this.deleteCondition = deleteCondition\n+        ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b"}, "originalPosition": 77}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1112, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}