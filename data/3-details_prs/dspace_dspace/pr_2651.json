{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2MzY1NDYw", "number": 2651, "title": "Dspace 7 shibboleth (REST)", "bodyText": "This PR provide changes to make the shibboleth authentication work as discussed in DS-4396\nA summary of what is done with this PR:\n\nadd a new ShibbolethRestController\nadd a new ShibbolethAuthenticationFilter\nadd the possibility to check a JWT token saved in a http cookie sent from client\n\nAs discussed in the issue DS-4396 this implementation doesn't handle the Access-Control-Allow-Origin header in the response to avoid CORS problem.\nTo solve it, we use in the rest VH the following apache configuration :\n# enable CORS headers for dspace7-demo.atmire.com and localhost\nSetEnvIf Origin \"^http(s)?://(www\\.)?(dspace7\\-demo\\.atmire\\.com|localhost|127\\.0\\.0\\.1)$\" AccessControlAllowOrigin=$0\n  Header set Access-Control-Allow-Origin %{AccessControlAllowOrigin}e env=AccessControlAllowOrigin\n  Header set Access-Control-Allow-Credentials true env=AccessControlAllowOrigin\n  Header set Access-Control-Expose-Headers: \"Authorization, expires, Location, Content-Disposition, WWW-Authenticate, Set-Cookie, X-Requested-With\"\n  Header merge Vary Origin\n\nthis PR has been already merged in the dspace-cris 7 codebase so it is possible to see the behavior here: https://dspacecris7.4science.cloud/home", "createdAt": "2020-01-23T13:36:40Z", "url": "https://github.com/DSpace/DSpace/pull/2651", "merged": true, "mergeCommit": {"oid": "b6b2e6c800f973f24c931aa51ecfd44e1b99f78c"}, "closed": true, "closedAt": "2020-03-27T14:52:12Z", "author": {"login": "atarix83"}, "timelineItems": {"totalCount": 61, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABbpPd2KAH2gAyMzY2MzY1NDYwOjEzNDgyYzJlYjdmYjVkNmMxNmU2NmRhZWJlNjBmYWY5YmZkNjE4MGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRfgQWgFqTM4MjIzODIwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "13482c2eb7fb5d6c16e66daebe60faf9bfd6180d", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/13482c2eb7fb5d6c16e66daebe60faf9bfd6180d", "committedDate": "2019-11-22T16:07:00Z", "message": "Added a cookie with JWT to response"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abbf3f736194f864581bcc9bf289a8c9e6749f0c", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/abbf3f736194f864581bcc9bf289a8c9e6749f0c", "committedDate": "2019-11-22T16:07:13Z", "message": "Handle redirect to client after shibboleth authentication succeded"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "705c8879988883c411ae1e06bf90c397cd3dd031", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/705c8879988883c411ae1e06bf90c397cd3dd031", "committedDate": "2019-11-22T16:07:23Z", "message": "Added login filter to /api/authn/shibboleth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85e253bb9fa8f789cc091d182bf2d2d45a6c2bd4", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/85e253bb9fa8f789cc091d182bf2d2d45a6c2bd4", "committedDate": "2019-11-22T16:07:29Z", "message": "Added shibboleth authentication filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ce9c2d98fd46a26373acd645c0f0e6c5e5d1d47", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/8ce9c2d98fd46a26373acd645c0f0e6c5e5d1d47", "committedDate": "2019-11-22T16:07:36Z", "message": "Chack if authentication cookie is present in Authentication Data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccb0efd2ea1260434dfa176b66535663b2a79de0", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/ccb0efd2ea1260434dfa176b66535663b2a79de0", "committedDate": "2019-11-22T16:07:41Z", "message": "use X-Requested-With header if Referer is empty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "787e2bbc97c926f238cff3b18a7ec0ca70828f62", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/787e2bbc97c926f238cff3b18a7ec0ca70828f62", "committedDate": "2020-01-02T17:28:30Z", "message": "Merge remote-tracking branch 'origin/master' into dspace-7-shibboleth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ce3c8cbda4b070b68673caefc4e70e91bfb8340", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/4ce3c8cbda4b070b68673caefc4e70e91bfb8340", "committedDate": "2020-01-08T17:38:41Z", "message": "Fixed checkstyle violations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10bbf8079b3f54be7b60d5ed973605dafb6d73b8", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/10bbf8079b3f54be7b60d5ed973605dafb6d73b8", "committedDate": "2020-01-09T11:08:55Z", "message": "Retrieve token from cookie only when checking an authenticated eperson"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5074004f4469f3268f6139e3a2e6e0996aace6f", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/e5074004f4469f3268f6139e3a2e6e0996aace6f", "committedDate": "2020-01-09T12:11:22Z", "message": "Revert \"Retrieve token from cookie only when checking an authenticated eperson\"\n\nThis reverts commit 10bbf8079b3f54be7b60d5ed973605dafb6d73b8."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e1de3c2e9d94bfae9e1fde1a075fb3917a4de37", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/1e1de3c2e9d94bfae9e1fde1a075fb3917a4de37", "committedDate": "2020-01-09T12:41:43Z", "message": "Add authorization cookie only in ShibbolethAuthenticationFilter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44210f92edcd5e5dddf1a95bc90dcd68619fd3b2", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/44210f92edcd5e5dddf1a95bc90dcd68619fd3b2", "committedDate": "2020-01-09T14:20:34Z", "message": "Fixed AuthenticationRestControllerIT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbfc373bdc24e795a9cf596084051283e3169108", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/bbfc373bdc24e795a9cf596084051283e3169108", "committedDate": "2020-01-09T14:58:17Z", "message": "Fixed checkstyle violations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf1e9780d4e39eb3dabe6b48aabdd40d772bb41b", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/bf1e9780d4e39eb3dabe6b48aabdd40d772bb41b", "committedDate": "2020-01-09T15:29:55Z", "message": "Invalidate authorization cookie on logout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64bc25f7c9f9e03f878809982235022bbe3af339", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/64bc25f7c9f9e03f878809982235022bbe3af339", "committedDate": "2020-01-09T17:04:42Z", "message": "add context commit after invalidating token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a1cb37bbdec5187cdb3096fa6bb4436935a2ac8", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/2a1cb37bbdec5187cdb3096fa6bb4436935a2ac8", "committedDate": "2020-01-09T17:19:06Z", "message": "Revert \"add context commit after invalidating token\"\n\nThis reverts commit 64bc25f7c9f9e03f878809982235022bbe3af339."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15087db2b6d9d70303d23623f9044af20b813af2", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/15087db2b6d9d70303d23623f9044af20b813af2", "committedDate": "2020-01-09T17:25:10Z", "message": "use authorization cookie only to check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4210605503eb9afdfbfc2659ab063183caa1ee5d", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/4210605503eb9afdfbfc2659ab063183caa1ee5d", "committedDate": "2020-01-09T17:36:41Z", "message": "fix use authorization cookie only to check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "beb975281d50bf8346e7e1f820d88c730ecc91b4", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/beb975281d50bf8346e7e1f820d88c730ecc91b4", "committedDate": "2020-01-09T18:02:31Z", "message": "Invalidate authentication cookie once used"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5530e7b7a3dbbe5ca264659f2b4516382d0692fd", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/5530e7b7a3dbbe5ca264659f2b4516382d0692fd", "committedDate": "2020-01-10T08:49:55Z", "message": "Add checck to user and password blank"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15d6b18ebf009328a9c0083e1da9078ea1cdfa8f", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/15d6b18ebf009328a9c0083e1da9078ea1cdfa8f", "committedDate": "2020-01-10T09:09:19Z", "message": "fix check user and password blank"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a32d11eb85eb50f122e718a8af60678176c33706", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/a32d11eb85eb50f122e718a8af60678176c33706", "committedDate": "2020-01-10T09:20:21Z", "message": "Revert check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "462f20a3389b6e9641a9af7f6992f3266bce6b45", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/462f20a3389b6e9641a9af7f6992f3266bce6b45", "committedDate": "2020-01-10T09:25:58Z", "message": "Check session salt in shib auth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba9d2095dc4317587ad2d42a57cba9f15e8362ea", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/ba9d2095dc4317587ad2d42a57cba9f15e8362ea", "committedDate": "2020-01-10T13:33:05Z", "message": "Revert \"Check session salt in shib auth\"\n\nThis reverts commit 462f20a3389b6e9641a9af7f6992f3266bce6b45."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50cf9b742ff3f0256e6d8605b5cf0225179bc3af", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/50cf9b742ff3f0256e6d8605b5cf0225179bc3af", "committedDate": "2020-01-10T13:39:54Z", "message": "add attemptAuthentication method to ShibbolethAuthenticationFilter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e884cc3d8cb738e1491fe08070a22082175dc6fd", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/e884cc3d8cb738e1491fe08070a22082175dc6fd", "committedDate": "2020-01-10T13:53:03Z", "message": "fix attemptAuthentication method on ShibbolethAuthenticationFilter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e919f99349de3b23f4509d9ad682ec603e8f40d", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/1e919f99349de3b23f4509d9ad682ec603e8f40d", "committedDate": "2020-01-16T14:02:02Z", "message": "Added WWW-Authenticate header to authn/status response"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0910916903f9ca45ec817530046a74057d59260c", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/0910916903f9ca45ec817530046a74057d59260c", "committedDate": "2020-01-17T08:14:33Z", "message": "Revert \"use authorization cookie only to check\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8531f43266096ee4c3eec7e4888023582d72aa9f", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/8531f43266096ee4c3eec7e4888023582d72aa9f", "committedDate": "2020-01-17T11:21:48Z", "message": "Merge remote-tracking branch 'origin/master' into dspace-7-shibboleth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4dba3836067b954c4df097724edf8040e313a20e", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/4dba3836067b954c4df097724edf8040e313a20e", "committedDate": "2020-01-20T16:22:36Z", "message": "replace Boolean type with primitive type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bb4b539d6c16828d64230675443fcfa3b149962", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/4bb4b539d6c16828d64230675443fcfa3b149962", "committedDate": "2020-01-21T10:17:36Z", "message": "use invalidateAuthenticationCookie method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c63b88141c70e998ee2c2c58521b5e952d693426", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/c63b88141c70e998ee2c2c58521b5e952d693426", "committedDate": "2020-01-23T13:15:00Z", "message": "Merge remote-tracking branch 'origin/master' into dspace-7-shibboleth"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NDcxMTA5", "url": "https://github.com/DSpace/DSpace/pull/2651#pullrequestreview-349471109", "createdAt": "2020-01-28T15:33:52Z", "commit": {"oid": "c63b88141c70e998ee2c2c58521b5e952d693426"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNTozMzo1MlrOFipiZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNTo1MTo1M1rOFiqSlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg3NjQ1Mg==", "bodyText": "Can you add inline comments explaining this is required for Angular to display the authentication options", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r371876452", "createdAt": "2020-01-28T15:33:52Z", "author": {"login": "benbosman"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/AuthenticationRestController.java", "diffHunk": "@@ -86,6 +92,12 @@ public AuthenticationStatusResource status(HttpServletRequest request) throws SQ\n         }\n \n         AuthenticationStatusRest authenticationStatusRest = new AuthenticationStatusRest(ePersonRest);\n+        if (!authenticationStatusRest.isAuthenticated()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c63b88141c70e998ee2c2c58521b5e952d693426"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg3OTUxNw==", "bodyText": "Can you add inline info explaining we need authentication cookies because Shibboleth can't use the authentication headers due to the redirects", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r371879517", "createdAt": "2020-01-28T15:38:31Z", "author": {"login": "benbosman"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/jwt/JWTTokenRestAuthenticationServiceImpl.java", "diffHunk": "@@ -140,18 +155,40 @@ public String getWwwAuthenticateHeaderValue(final HttpServletRequest request, fi\n         return wwwAuthenticate.toString();\n     }\n \n-    private void addTokenToResponse(final HttpServletResponse response, final String token) throws IOException {\n+    private void addTokenToResponse(final HttpServletResponse response, final String token, final Boolean addCookie)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c63b88141c70e998ee2c2c58521b5e952d693426"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg4ODc4OA==", "bodyText": "Please add setSecure. If necessary it can be explicitly configured to bypass setSecure for local development. But the default should enable setSecure", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r371888788", "createdAt": "2020-01-28T15:51:53Z", "author": {"login": "benbosman"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/jwt/JWTTokenRestAuthenticationServiceImpl.java", "diffHunk": "@@ -140,18 +155,40 @@ public String getWwwAuthenticateHeaderValue(final HttpServletRequest request, fi\n         return wwwAuthenticate.toString();\n     }\n \n-    private void addTokenToResponse(final HttpServletResponse response, final String token) throws IOException {\n+    private void addTokenToResponse(final HttpServletResponse response, final String token, final Boolean addCookie)\n+            throws IOException {\n+        if (addCookie) {\n+            Cookie cookie = new Cookie(AUTHORIZATION_COOKIE, token);\n+            cookie.setHttpOnly(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c63b88141c70e998ee2c2c58521b5e952d693426"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0336e831241f63f8f64c0d0963ba40ab4ea953f8", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/0336e831241f63f8f64c0d0963ba40ab4ea953f8", "committedDate": "2020-02-05T10:49:59Z", "message": "Added setSecure option to authetication cookie"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6230a88b8a4d9fb2534203cd72a68cadc587c9c5", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/6230a88b8a4d9fb2534203cd72a68cadc587c9c5", "committedDate": "2020-02-05T10:50:18Z", "message": "Added inline comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b3db78e4b7edc0b4f8f67eed6ea83015302c7df", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/7b3db78e4b7edc0b4f8f67eed6ea83015302c7df", "committedDate": "2020-02-06T14:15:36Z", "message": "Added more integration test for shibboleth authentication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82f2f60fc993b0fe670050aa4a9dd8ae11f3fe78", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/82f2f60fc993b0fe670050aa4a9dd8ae11f3fe78", "committedDate": "2020-02-06T14:15:54Z", "message": "Added integration test fo ShibbolethRestController"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc439d34719421c2003f761693a7220a573556df", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/cc439d34719421c2003f761693a7220a573556df", "committedDate": "2020-02-06T14:20:51Z", "message": "Fixed the default value of authentication-shibboleth.lazysession.loginurl param"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NDg2MTQ4", "url": "https://github.com/DSpace/DSpace/pull/2651#pullrequestreview-354486148", "createdAt": "2020-02-06T14:23:25Z", "commit": {"oid": "cc439d34719421c2003f761693a7220a573556df"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNDoyMzoyNVrOFmcxsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNDozODoxNlrOFmdTwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg2MTY4Mw==", "bodyText": "Please note that this property it's about to be changed to: dspace.server.url", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r375861683", "createdAt": "2020-02-06T14:23:25Z", "author": {"login": "paulo-graca"}, "path": "dspace-api/src/main/java/org/dspace/authenticate/ShibAuthentication.java", "diffHunk": "@@ -509,19 +510,17 @@ public String loginPageURL(Context context, HttpServletRequest request, HttpServ\n             int port = request.getServerPort();\n             String contextPath = request.getContextPath();\n \n-            String returnURL = request.getHeader(\"Referer\");\n-            if (returnURL == null) {\n-                if (request.isSecure() || forceHTTPS) {\n-                    returnURL = \"https://\";\n-                } else {\n-                    returnURL = \"http://\";\n-                }\n-                returnURL += host;\n-                if (!(port == 443 || port == 80)) {\n-                    returnURL += \":\" + port;\n-                }\n+            String redirectUrl = null;\n+            if (request.getHeader(\"Referer\") != null && StringUtils.isNotBlank(request.getHeader(\"Referer\"))) {\n+                redirectUrl = request.getHeader(\"Referer\");\n+            } else if (request.getHeader(\"X-Requested-With\") != null\n+                    && StringUtils.isNotBlank(request.getHeader(\"X-Requested-With\"))) {\n+                redirectUrl = request.getHeader(\"X-Requested-With\");\n             }\n \n+            String returnURL = ConfigurationManager.getProperty(\"dspace.baseUrl\") + \"/api/authn/shibboleth\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc439d34719421c2003f761693a7220a573556df"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg3MDQwMQ==", "bodyText": "Please note that this property it's about to be changed to: dspace.server.url", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r375870401", "createdAt": "2020-02-06T14:38:16Z", "author": {"login": "paulo-graca"}, "path": "dspace/config/modules/authentication-shibboleth.cfg", "diffHunk": "@@ -38,7 +38,7 @@\n authentication-shibboleth.lazysession = true\n \n # The url to start a shibboleth session (only for lazy sessions)\n-authentication-shibboleth.lazysession.loginurl = /Shibboleth.sso/Login\n+authentication-shibboleth.lazysession.loginurl = ${dspace.baseUrl}/Shibboleth.sso/Login", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc439d34719421c2003f761693a7220a573556df"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/c65bb086ef6777b27bf8b4a112ccfefca7e14ecb", "committedDate": "2020-02-07T13:49:43Z", "message": "Fixed checkstyle violations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjAyNDkz", "url": "https://github.com/DSpace/DSpace/pull/2651#pullrequestreview-358602493", "createdAt": "2020-02-13T22:37:07Z", "commit": {"oid": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMjozNzowN1rOFpmAjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMjozNzowN1rOFpmAjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1ODY3MA==", "bodyText": "Just a note here. You shouldn't need to import the ConfigurationManager, as this class already has access to the ConfigurationService.  The ConfigurationManager is deprecated in favor of the ConfigurationService.  So, you should remove this import and just use configurationService instead.", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r379158670", "createdAt": "2020-02-13T22:37:07Z", "author": {"login": "tdonohue"}, "path": "dspace-api/src/main/java/org/dspace/authenticate/ShibAuthentication.java", "diffHunk": "@@ -33,6 +33,7 @@\n import org.dspace.content.factory.ContentServiceFactory;\n import org.dspace.content.service.MetadataFieldService;\n import org.dspace.content.service.MetadataSchemaService;\n+import org.dspace.core.ConfigurationManager;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjAzMzIy", "url": "https://github.com/DSpace/DSpace/pull/2651#pullrequestreview-358603322", "createdAt": "2020-02-13T22:38:55Z", "commit": {"oid": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMjozODo1NVrOFpmDLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMjozODo1NVrOFpmDLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1OTM0Mw==", "bodyText": "This configuration needs updating as well to be dspace.ui.url.  Also, you should use ConfigurationService (which can be @Autowired like other services)", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r379159343", "createdAt": "2020-02-13T22:38:55Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/ShibbolethRestController.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+\n+import javax.servlet.http.HttpServletResponse;\n+\n+import org.dspace.app.rest.model.AuthnRest;\n+import org.dspace.core.ConfigurationManager;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.hateoas.Link;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestMethod;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+/**\n+ * Rest controller that handles redirect after shibboleth authentication succeded\n+ *\n+ * @author Andrea Bollini (andrea dot bollini at 4science dot it)\n+ * @author Giuseppe Digilio (giuseppe dot digilio at 4science dot it)\n+ */\n+@RequestMapping(value = \"/api/\" + AuthnRest.CATEGORY + \"/shibboleth\")\n+@RestController\n+public class ShibbolethRestController implements InitializingBean {\n+\n+    private static final Logger log = LoggerFactory.getLogger(ShibbolethRestController.class);\n+\n+    @Autowired\n+    DiscoverableEndpointsService discoverableEndpointsService;\n+\n+    @Override\n+    public void afterPropertiesSet() {\n+        discoverableEndpointsService\n+            .register(this, Arrays.asList(new Link(\"/api/\" + AuthnRest.CATEGORY, \"shibboleth\")));\n+    }\n+\n+    @RequestMapping(method = RequestMethod.GET)\n+    public void shibboleth(HttpServletResponse response,\n+            @RequestParam(name = \"redirectUrl\", required = false) String redirectUrl) throws IOException {\n+        if (redirectUrl == null) {\n+            redirectUrl = ConfigurationManager.getProperty(\"dspace.url\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4Mzc4OTc1", "url": "https://github.com/DSpace/DSpace/pull/2651#pullrequestreview-358378975", "createdAt": "2020-02-13T16:45:55Z", "commit": {"oid": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4OTM3NTk2", "url": "https://github.com/DSpace/DSpace/pull/2651#pullrequestreview-358937596", "createdAt": "2020-02-14T13:26:28Z", "commit": {"oid": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMzoyNjoyOVrOFp2dlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNDoxOTozM1rOFqmCZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyODI0NA==", "bodyText": "A logout configuration can be added to specify the path\nauthentication-shibboleth.lazysession.logouturl = ${dspace.baseUrl}/Shibboleth.sso/Logout", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r379428244", "createdAt": "2020-02-14T13:26:29Z", "author": {"login": "paulo-graca"}, "path": "dspace/config/modules/authentication-shibboleth.cfg", "diffHunk": "@@ -38,7 +38,7 @@\n authentication-shibboleth.lazysession = true\n \n # The url to start a shibboleth session (only for lazy sessions)\n-authentication-shibboleth.lazysession.loginurl = /Shibboleth.sso/Login\n+authentication-shibboleth.lazysession.loginurl = ${dspace.baseUrl}/Shibboleth.sso/Login", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwNzcxOQ==", "bodyText": "A verification can be used to identify if the current session is a shibboleth session and then call the configured logout parameter", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r380207719", "createdAt": "2020-02-17T14:19:33Z", "author": {"login": "paulo-graca"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/CustomLogoutHandler.java", "diffHunk": "@@ -45,7 +45,7 @@ public void logout(HttpServletRequest httpServletRequest, HttpServletResponse ht\n                        Authentication authentication) {\n         try {\n             Context context = ContextUtil.obtainContext(httpServletRequest);\n-            restAuthenticationService.invalidateAuthenticationData(httpServletRequest, context);\n+            restAuthenticationService.invalidateAuthenticationData(httpServletRequest, httpServletResponse, context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5ODAwMDQ0", "url": "https://github.com/DSpace/DSpace/pull/2651#pullrequestreview-359800044", "createdAt": "2020-02-17T15:05:43Z", "commit": {"oid": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a28cb7551c3ffe5d8e7e30bafc1a2e22308dc4f0", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/a28cb7551c3ffe5d8e7e30bafc1a2e22308dc4f0", "committedDate": "2020-02-20T13:40:41Z", "message": "Merge remote-tracking branch 'origin/master' into dspace-7-shibboleth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cbe3e1f308707734e5772713ae0edda9f9d739d", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/8cbe3e1f308707734e5772713ae0edda9f9d739d", "committedDate": "2020-02-24T09:02:49Z", "message": "Added getBaseUrl to Utils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fee734a2af8446ecc544d091fb9dc8b7eebf1f5", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/0fee734a2af8446ecc544d091fb9dc8b7eebf1f5", "committedDate": "2020-02-24T09:15:11Z", "message": "Fixed default value of authentication-shibboleth.lazysession.loginurl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a49bf4b3430eab3c695afeeb2f941809e1ce8e16", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/a49bf4b3430eab3c695afeeb2f941809e1ce8e16", "committedDate": "2020-02-24T09:15:50Z", "message": "Replace ConfigurationManager with ConfigurationService"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NjcyNzAz", "url": "https://github.com/DSpace/DSpace/pull/2651#pullrequestreview-368672703", "createdAt": "2020-03-04T10:42:41Z", "commit": {"oid": "a49bf4b3430eab3c695afeeb2f941809e1ce8e16"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MDEzNzI1", "url": "https://github.com/DSpace/DSpace/pull/2651#pullrequestreview-369013725", "createdAt": "2020-03-04T18:22:12Z", "commit": {"oid": "a49bf4b3430eab3c695afeeb2f941809e1ce8e16"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxODoyMjoxMlrOFx4a6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxODoyMjoxMlrOFx4a6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg0ODkzNw==", "bodyText": "A small comment.  You don't need to do all this string parsing of shibURL, as the ConfigurationService is much \"smarter\" than the old ConfigurationManager.  The string will already be trimmed.  Additionally, the if just before this is unneeded, as you can pass in a default value if it's unspecified.  So, both the if and the trim() can be removed in favor of just calling\nString shibURL = configurationService.getProperty(\"authentication-shibboleth.lazysession.loginurl\", \"/Shibboleth.sso/Login\");", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r387848937", "createdAt": "2020-03-04T18:22:12Z", "author": {"login": "tdonohue"}, "path": "dspace-api/src/main/java/org/dspace/authenticate/ShibAuthentication.java", "diffHunk": "@@ -1258,6 +1246,28 @@ protected String findSingleAttribute(HttpServletRequest request, String name) {\n         return valueList;\n     }\n \n+    private String getShibURL(HttpServletRequest request) {\n+        String shibURL = configurationService.getProperty(\"authentication-shibboleth.lazysession.loginurl\");\n+        boolean forceHTTPS =\n+                configurationService.getBooleanProperty(\"authentication-shibboleth.lazysession.secure\",true);\n+\n+        // Shibboleth authentication initiator\n+        if (shibURL == null || shibURL.length() == 0) {\n+            shibURL = \"/Shibboleth.sso/Login\";\n+        }\n+        shibURL = shibURL.trim();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a49bf4b3430eab3c695afeeb2f941809e1ce8e16"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MDE3NjI3", "url": "https://github.com/DSpace/DSpace/pull/2651#pullrequestreview-369017627", "createdAt": "2020-03-04T18:27:58Z", "commit": {"oid": "a49bf4b3430eab3c695afeeb2f941809e1ce8e16"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxODoyNzo1OFrOFx4nJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxODoyNzo1OFrOFx4nJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg1MjA3MA==", "bodyText": "@atarix83  What would happen if the Base URL includes a port number?  While it's less frequently seen, I have seen sites that run their DSpace on port 8080, for example.  It looks to me like Utils.getBaseUrl() would fail if the port is not either 80 (HTTP) or 443 (HTTPS)", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r387852070", "createdAt": "2020-03-04T18:27:58Z", "author": {"login": "tdonohue"}, "path": "dspace-api/src/test/java/org/dspace/core/UtilsTest.java", "diffHunk": "@@ -22,6 +22,27 @@\n  */\n public class UtilsTest extends AbstractUnitTest {\n \n+    /**\n+     * Test of getBaseUrl method, of class Utils\n+     */\n+    @Test\n+    public void testGetBaseUrl() {\n+        assertEquals(\"Test remove /server\", \"http://dspace.org\",\n+                     Utils.getBaseUrl(\"http://dspace.org/server\"));\n+\n+        assertEquals(\"Test remove /server/api/core/items\", \"https://dspace.org\",\n+                     Utils.getBaseUrl(\"https://dspace.org/server/api/core/items\"));\n+\n+        assertEquals(\"Test remove trailing slash\", \"https://dspace.org\",\n+                     Utils.getBaseUrl(\"https://dspace.org/\"));\n+\n+        assertEquals(\"Test keep url\", \"https://demo.dspace.org\",\n+                     Utils.getBaseUrl(\"https://demo.dspace.org\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a49bf4b3430eab3c695afeeb2f941809e1ce8e16"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3989987a41223ddbcbfd4ce30f29e091fdbccdb4", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/3989987a41223ddbcbfd4ce30f29e091fdbccdb4", "committedDate": "2020-03-13T11:52:19Z", "message": "Merge remote-tracking branch 'origin/master' into dspace-7-shibboleth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d66512578834cff29139bd6dfe631bf7e1dd008f", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/d66512578834cff29139bd6dfe631bf7e1dd008f", "committedDate": "2020-03-13T18:30:45Z", "message": "Added port to getBaseUrl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2044d33908872a1f2edbe369bd31a57d182b7bdf", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/2044d33908872a1f2edbe369bd31a57d182b7bdf", "committedDate": "2020-03-13T18:31:50Z", "message": "Use configurationService to set default authentication-shibboleth.lazysession.loginurl in getShibURL method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a3bce8eabe888b20963bc825a8bcbab05b2c74b", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/1a3bce8eabe888b20963bc825a8bcbab05b2c74b", "committedDate": "2020-03-13T18:33:13Z", "message": "Added methods to test shibboleth url using port"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0951d0ae077af78014f153cdb36da4f3f46b0ee6", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/0951d0ae077af78014f153cdb36da4f3f46b0ee6", "committedDate": "2020-03-13T18:40:43Z", "message": "Added comments for authentication-shibboleth.lazysession.loginurl in authentication-shibboleth.cfg"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3ODA2NjMy", "url": "https://github.com/DSpace/DSpace/pull/2651#pullrequestreview-377806632", "createdAt": "2020-03-19T15:02:35Z", "commit": {"oid": "0951d0ae077af78014f153cdb36da4f3f46b0ee6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d7ba9b841c5d8433caf71912bf18933e25c588b", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/0d7ba9b841c5d8433caf71912bf18933e25c588b", "committedDate": "2020-03-24T20:25:50Z", "message": "Merge remote-tracking branch 'origin/master' into dspace-7-shibboleth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "671faf3569a05ad7fc28bcf23a40203212f21253", "author": {"user": {"login": "atarix83", "name": "Giuseppe"}}, "url": "https://github.com/DSpace/DSpace/commit/671faf3569a05ad7fc28bcf23a40203212f21253", "committedDate": "2020-03-25T09:28:40Z", "message": "Fixed checkstyle violations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMjM4MjA5", "url": "https://github.com/DSpace/DSpace/pull/2651#pullrequestreview-382238209", "createdAt": "2020-03-26T17:25:05Z", "commit": {"oid": "671faf3569a05ad7fc28bcf23a40203212f21253"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1568, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}