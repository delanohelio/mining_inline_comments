{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NzM5NTM5", "number": 2726, "title": "Subresources should obey access restrictions", "bodyText": "References\n\nhttps://jira.lyrasis.org/browse/DS-4444\n\nDescription\nThis PR fixes a huge amount of security holes in REST. Permissions for linked resources were not verified in REST, and there were many solutions to access a private resource simply because there's a link from a public resource\nThe concept is that permissions are verified for each returned REST resource. So e.g. if a discovery search is performed, and one of the items is not accessible to the current user, it will not be returned. Similarly, if the bundles of an item are requested, and on of the bundles is not accessible to the current user, it will not be returned.\nThe Permission evaluators are used for this purpose because they can verify what data a user is in fact authorized to view. This ensure it's always verified, and REST developers don't have to manually check for the permissions, and forget it again (especially since we noticed a huge amount of security holes here)\nThe goal of this PR is not to prove for every endpoint that it fixes the security holes. More such tests can always be created after this PR, but given the design of this PR, it's not essential.\nInstructions for Reviewers\nThe ConverterService changes are the most important.\nList of changes in this PR:\n\nFor each BaseObjectRest, the permissions are verified. This implies that each BaseObjectRest now has a permissions implementation\nPermissions are retrieved based on the request, so ITs which directly use the converter (not a rest request) will need to avoid these permissions\n\nSample tests:\n\nThe tests from the ITs\nAfter discovery is up-to-date, remove the READ resource policy directly in the DB (discovery not updated) and verify the result is no longer included\n\nChecklist\n\n Most changes in the PR are the same, and can be reviewed quickly (Permissions implementations, IT refactoring)\n My PR passes Checkstyle validation based on the Code Style Guide\n My PR includes Javadoc for all new (or modified) public methods and classes. It also includes Javadoc for large or complex private methods.\n My PR passes all tests and includes new/updated Unit or Integration Tests for any bug fixes, improvements or new features. A few reminders about what constitutes good tests:\n\nInclude tests for different user types, including: (1) Anonymous user, (2) Logged in user (non-admin), and (3) Administrator.\nFor bug fixes, include a test that reproduces the bug and proves it is fixed.\n\n\n Restricted resources can no longer be accessed. An unauthorized response can't be thrown because embedding a single private response should not cause the entire response to fail, but only to exclude the single private response.\n My PR is compatible with master\n More Integration Tests may be included in the future", "createdAt": "2020-03-30T15:50:14Z", "url": "https://github.com/DSpace/DSpace/pull/2726", "merged": true, "mergeCommit": {"oid": "19ba3ddaeb9b56dcfd8cb576b916c6aa27dfb274"}, "closed": true, "closedAt": "2020-05-22T16:10:48Z", "author": {"login": "benbosman"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQzJpdAH2gAyMzk1NzM5NTM5OmY1Y2NiNDMyZjI2ZDM3NzkwNWNkNGM0NTNiMmM3ZDJjMjFlZmRlYTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjflFuAFqTQxNjI2NTA0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f5ccb432f26d377905cd4c453b2c7d2c21efdea9", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/f5ccb432f26d377905cd4c453b2c7d2c21efdea9", "committedDate": "2020-03-24T13:44:34Z", "message": "[Task 69976] initial implementation of extra permission check for subresources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "984de8434d315b549ae8ea55f020619ab39dcd55", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/984de8434d315b549ae8ea55f020619ab39dcd55", "committedDate": "2020-03-25T08:30:21Z", "message": "[Task 69976] moved uppercase instance to RestObjectPermissionEvaluatorPlugin and hid null values from the paged list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4a63316991f3bce5dc244616dcc4437546f6600", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/e4a63316991f3bce5dc244616dcc4437546f6600", "committedDate": "2020-03-25T13:01:51Z", "message": "[Task 69976] start fixing tests and permission checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d36fffa3486135286b52be2847ed28e759feca0b", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/d36fffa3486135286b52be2847ed28e759feca0b", "committedDate": "2020-03-26T07:19:09Z", "message": "[Task 70058] added permisson evaluators for several BaseObjectRest objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e79caf9970783d9103180b7c41bd55001eaca180", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/e79caf9970783d9103180b7c41bd55001eaca180", "committedDate": "2020-03-26T12:05:03Z", "message": "[Task 70058] start fixing tests + refactor toRestPage methods in utils to properly handle and skip null values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e5db834644eff2d9be23b0380e2d35399b2050d", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/7e5db834644eff2d9be23b0380e2d35399b2050d", "committedDate": "2020-03-27T08:10:09Z", "message": "[Task 70058] fixed the majority of the tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3492b6d8bc1c88ec1ad076284c75c8a24e1f42cf", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/3492b6d8bc1c88ec1ad076284c75c8a24e1f42cf", "committedDate": "2020-03-27T09:05:13Z", "message": "[Task 70058] fixed the tests and checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5656e3567450fd8f7bea85013e46aeb1674de382", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/5656e3567450fd8f7bea85013e46aeb1674de382", "committedDate": "2020-03-30T12:37:00Z", "message": "[Task 70087] added ITs for the subresource permissions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "165e39291013ece0b4120ea549a6968b3594ced9", "author": {"user": {"login": "benbosman", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/165e39291013ece0b4120ea549a6968b3594ced9", "committedDate": "2020-03-30T13:39:03Z", "message": "layout changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MTUxNjc1", "url": "https://github.com/DSpace/DSpace/pull/2726#pullrequestreview-384151675", "createdAt": "2020-03-30T19:11:37Z", "commit": {"oid": "165e39291013ece0b4120ea549a6968b3594ced9"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxOToxMTozN1rOF94Slg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxOToyNDoyN1rOF940Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQyOTcxOA==", "bodyText": "Please add JavaDoc to this new method. It's also important to contrast it against the other toRestPage() method, so please consider updating one or both JavaDocs to better describe each method's usage.", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r400429718", "createdAt": "2020-03-30T19:11:37Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/converter/ConverterService.java", "diffHunk": "@@ -97,33 +111,42 @@\n      *\n      * @param modelObjects the list of model objects.\n      * @param pageable the pageable.\n-     * @param total the total number of items.\n      * @param projection the projection to use.\n      * @param <M> the model object class.\n      * @param <R> the rest object class.\n      * @return the page.\n      * @throws IllegalArgumentException if there is no compatible converter.\n      * @throws ClassCastException if the converter's return type is not compatible with the inferred return type.\n      */\n-    public <M, R> Page<R> toRestPage(List<M> modelObjects, Pageable pageable, long total, Projection projection) {\n-        return new PageImpl<>(modelObjects, pageable, total).map((object) -> toRest(object, projection));\n+    public <M, R> Page<R> toRestPage(List<M> modelObjects, Pageable pageable, Projection projection) {\n+        List<R> transformedList = new LinkedList<>();\n+        for (M modelObject : modelObjects) {\n+            R transformedObject = toRest(modelObject, projection);\n+            if (transformedObject != null) {\n+                transformedList.add(transformedObject);\n+            }\n+        }\n+        if (pageable == null) {\n+            pageable = utils.getPageable(pageable);\n+        }\n+        return utils.getPage(transformedList, pageable);\n     }\n \n-    /**\n-     * Converts a list of model objects to a page of rest objects using the given {@link Projection}.\n-     *\n-     * @param modelObjects the page of model objects.\n-     * @param projection the projection to use.\n-     * @param <M> the model object class.\n-     * @param <R> the rest object class.\n-     * @return the page.\n-     * @throws IllegalArgumentException if there is no compatible converter.\n-     * @throws ClassCastException if the converter's return type is not compatible with the inferred return type.\n-     */\n-    public <M, R> Page<R> toRestPage(Page<M> modelObjects, Projection projection) {\n-        return modelObjects.map((object) -> toRest(object, projection));\n+    public <M, R> Page<R> toRestPage(List<M> modelObjects, Pageable pageable, long total, Projection projection) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165e39291013ece0b4120ea549a6968b3594ced9"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzMDc1NA==", "bodyText": "Please add JavaDocs to describe this new Plugin & what it is checking for.", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r400430754", "createdAt": "2020-03-30T19:13:30Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/AuthenticationStatusRestPermissionEvaluatorPlugin.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.security;\n+\n+import java.io.Serializable;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.model.AuthenticationStatusRest;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class AuthenticationStatusRestPermissionEvaluatorPlugin extends RestObjectPermissionEvaluatorPlugin {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165e39291013ece0b4120ea549a6968b3594ced9"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzMTU4MA==", "bodyText": "Again, please add JavaDocs.  It's important to also contrast this plugin with AuthenticationStatusRestPermissionEvaluatorPlugin, as they have very similar names. So, it'd be good to better understand what each is doing & why.", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r400431580", "createdAt": "2020-03-30T19:14:56Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/AuthnRestPermissionEvaluatorPlugin.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.security;\n+\n+import java.io.Serializable;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.model.AuthnRest;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class AuthnRestPermissionEvaluatorPlugin extends RestObjectPermissionEvaluatorPlugin {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165e39291013ece0b4120ea549a6968b3594ced9"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzMTg3MQ==", "bodyText": "Again, please add Javadocs.  (Sidenote, I'll stop here & I won't add this to every new *Plugin....it looks like most of them need JavaDocs though!)", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r400431871", "createdAt": "2020-03-30T19:15:29Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/BitstreamFormatRestPermissionEvaluatorPlugin.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.security;\n+\n+import java.io.Serializable;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.model.BitstreamFormatRest;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class BitstreamFormatRestPermissionEvaluatorPlugin extends RestObjectPermissionEvaluatorPlugin {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165e39291013ece0b4120ea549a6968b3594ced9"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzMjc5MA==", "bodyText": "This needs JavaDocs too, and also should likely have an EvaluatorPlugin suffix (just like other such Plugins)", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r400432790", "createdAt": "2020-03-30T19:17:09Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/EntityTypeRestPermissionEvaluator.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.security;\n+\n+import java.io.Serializable;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.model.EntityTypeRest;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class EntityTypeRestPermissionEvaluator extends RestObjectPermissionEvaluatorPlugin {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165e39291013ece0b4120ea549a6968b3594ced9"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzMzE0NA==", "bodyText": "Same here, JavaDocs & please change suffix to EvaluatorPlugin", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r400433144", "createdAt": "2020-03-30T19:17:32Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/ExternalSourceEntryRestPermissionEvaluator.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.security;\n+\n+import java.io.Serializable;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.model.ExternalSourceEntryRest;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class ExternalSourceEntryRestPermissionEvaluator extends RestObjectPermissionEvaluatorPlugin {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165e39291013ece0b4120ea549a6968b3594ced9"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzNzY3NA==", "bodyText": "I'm not sure I understand the JavaDoc description of this plugin or the purpose of all these individualized plugins. Could you describe why these are needed, as they don't seem to actually be checking any permissions? Instead, they seem to be looking to simply see if the targetType is a specific string value.", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r400437674", "createdAt": "2020-03-30T19:23:28Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/AuthorizationFeatureRestPermissionEvaluatorPlugin.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.security;\n+\n+import java.io.Serializable;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.model.AuthorizationFeatureRest;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * This class determines that any AuthorizationFeatureRest object can be viewed as it'll be a subresource of\n+ * AuthorizationRest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165e39291013ece0b4120ea549a6968b3594ced9"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzODE1Ng==", "bodyText": "Same here, JavaDocs and rename to EvaluatorPlugin", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r400438156", "createdAt": "2020-03-30T19:24:14Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/ExternalSourceRestPermissionEvaluator.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.security;\n+\n+import java.io.Serializable;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.model.ExternalSourceRest;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class ExternalSourceRestPermissionEvaluator extends RestObjectPermissionEvaluatorPlugin {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165e39291013ece0b4120ea549a6968b3594ced9"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzODI5MA==", "bodyText": "Same here, JavaDocs and rename to EvaluatorPlugin", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r400438290", "createdAt": "2020-03-30T19:24:27Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/FacetConfigurationRestPermissionEvaluator.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.security;\n+\n+import java.io.Serializable;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.model.FacetConfigurationRest;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class FacetConfigurationRestPermissionEvaluator extends RestObjectPermissionEvaluatorPlugin {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165e39291013ece0b4120ea549a6968b3594ced9"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1abdf556bda228a507439bd2cd551ffe49609673", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/1abdf556bda228a507439bd2cd551ffe49609673", "committedDate": "2020-03-31T08:12:38Z", "message": "Merge remote-tracking branch 'dspace/master' into w2p-69976_subresource-permissions\n\nConflicts:\n\tdspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunityCollectionLinkRepository.java\n\tdspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunityRestRepository.java\n\tdspace-server-webapp/src/main/java/org/dspace/app/rest/repository/CommunitySubcommunityLinkRepository.java\n\tdspace-server-webapp/src/test/java/org/dspace/app/rest/CollectionRestRepositoryIT.java\n\tdspace-server-webapp/src/test/java/org/dspace/app/rest/CommunityRestRepositoryIT.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34d8bd33bca9f1bb1a136c26de796e2d742b2db3", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/34d8bd33bca9f1bb1a136c26de796e2d742b2db3", "committedDate": "2020-03-31T08:13:04Z", "message": "[Task 70087] fixed checkstyle after master merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/563d3f12410258808c34fff4ecbc45f435ac11bc", "committedDate": "2020-04-02T14:25:24Z", "message": "[Task 70148] processed community feedback on Subresource permissions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NzgxMzg1", "url": "https://github.com/DSpace/DSpace/pull/2726#pullrequestreview-386781385", "createdAt": "2020-04-02T21:14:59Z", "commit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMToxNTowMFrOF_8w8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMToyOToyN1rOF_9MQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwMDE3OA==", "bodyText": "I'm not sure about this log message.  Do we really want an info message for every access denied on every object?  Also, this looks to just print out the class name (like \"ItemRest\") instead of any useful info.  I think we should either enhance the message here, or consider removing it.", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r402600178", "createdAt": "2020-04-02T21:15:00Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/converter/ConverterService.java", "diffHunk": "@@ -86,6 +93,13 @@\n         M transformedModel = projection.transformModel(modelObject);\n         DSpaceConverter<M, R> converter = requireConverter(modelObject.getClass());\n         R restObject = converter.convert(transformedModel, projection);\n+        if (restObject instanceof BaseObjectRest) {\n+            if (!dSpacePermissionEvaluator.hasPermission(SecurityContextHolder.getContext().getAuthentication(),\n+                                                         restObject, \"READ\")) {\n+                log.info(\"Access denied on \" + restObject.getClass());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwMjEzMQ==", "bodyText": "I'm confused about this change. Why did we remove the aborting of this new Context?  It seems like we are now leaving a Context open in this method.", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r402602131", "createdAt": "2020-04-02T21:19:00Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/scripts/handler/impl/RestDSpaceRunnableHandler.java", "diffHunk": "@@ -186,10 +186,6 @@ public Process getProcess() {\n             return processService.find(context, processId);\n         } catch (SQLException e) {\n             log.error(\"RestDSpaceRunnableHandler with process: \" + processId + \" could not be found\", e);\n-        } finally {\n-            if (context.isValid()) {\n-                context.abort();\n-            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwMjkzNg==", "bodyText": "Could we update the JavaDocs here to match that same/similar description as the other EvaluatorPlugin classes?  I like the new descriptions added to other classes, but this one doesn't seem to be as informative.", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r402602936", "createdAt": "2020-04-02T21:20:35Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/AuthorizationFeatureRestPermissionEvaluatorPlugin.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.security;\n+\n+import java.io.Serializable;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.model.AuthorizationFeatureRest;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * This class determines that any AuthorizationFeatureRest object can be viewed as it'll be a subresource of\n+ * AuthorizationRest", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzNzY3NA=="}, "originalCommit": {"oid": "165e39291013ece0b4120ea549a6968b3594ced9"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwMzY4Mw==", "bodyText": "It looks like JavaDocs were accidentally forgotten on this class.", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r402603683", "createdAt": "2020-04-02T21:22:08Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/ScriptRestPermissionEvaluatorPlugin.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.security;\n+\n+import java.io.Serializable;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.model.ScriptRest;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class ScriptRestPermissionEvaluatorPlugin extends RestObjectPermissionEvaluatorPlugin {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwNTE4MQ==", "bodyText": "If this is going to be left in this PR, then we should create a JIRA ticket to describe the problem with the test, so that it can be assigned for a followup PR.", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r402605181", "createdAt": "2020-04-02T21:25:15Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/ResourcePolicyRestRepositoryIT.java", "diffHunk": "@@ -503,7 +504,9 @@ public void findResourcePoliciesOfOneResourceWithoutActionTest() throws Exceptio\n             .andExpect(jsonPath(\"$.page.totalElements\", is(2)));\n     }\n \n+    // This test is currently not working as intended, needs to be reviewed.\n     @Test\n+    @Ignore", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwNzE2OQ==", "bodyText": "I don't understand the new setup() method here, as it doesn't seem to correspond with the new changes to ConverterService (but maybe I'm misunderstanding?).  Could you add comments as to why we need to mock the ServletRequest? (It's just not obvious to me, since the ServletRequest doesn't seem to be used in the new changes to ConverterService)", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r402607169", "createdAt": "2020-04-02T21:29:27Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/converter/ConverterServiceIT.java", "diffHunk": "@@ -57,6 +62,16 @@\n     @Mock\n     private Object mockEmbeddedResource;\n \n+    @Autowired\n+    private RequestService requestService;\n+\n+    @Before\n+    public void setup() {\n+        MockHttpServletRequest mockHttpServletRequest = new MockHttpServletRequest();\n+        mockHttpServletRequest.setAttribute(\"dspace.context\", new Context());\n+        MockHttpServletResponse mockHttpServletResponse = new MockHttpServletResponse();\n+        requestService.startRequest(mockHttpServletRequest, mockHttpServletResponse);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3Njk0NjA2", "url": "https://github.com/DSpace/DSpace/pull/2726#pullrequestreview-387694606", "createdAt": "2020-04-04T12:19:16Z", "commit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQxMjoxOToxNlrOGAxecA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQxMzowMzo1NVrOGAxuuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2Mzc5Mg==", "bodyText": "it is never used", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r403463792", "createdAt": "2020-04-04T12:19:16Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/RestResourceController.java", "diffHunk": "@@ -896,6 +896,17 @@ public ResourceSupport findRel(HttpServletRequest request, HttpServletResponse r\n \n     }\n \n+    private Page<? extends RestModel> getRestModelsWithoutNullValues(Pageable page,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2NDQ4Mg==", "bodyText": "I guess this change is not really related to this PR but I'm unable to get more information on the commits description... can you explain to purpose? if it is a bug fix, can you point to a test that will verify the change made?", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r403464482", "createdAt": "2020-04-04T12:27:01Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/ScriptProcessesController.java", "diffHunk": "@@ -55,8 +61,10 @@\n         if (log.isTraceEnabled()) {\n             log.trace(\"Starting Process for Script with name: \" + scriptName);\n         }\n-        ProcessRest processRest = scriptRestRepository.startProcess(scriptName);\n+        Context context = ContextUtil.obtainContext(requestService.getCurrentRequest().getServletRequest());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2NDkzNw==", "bodyText": "do this mean that we are assuming that READ permission are required on the embedded object? how this match with the permission that can be defined (annotated) in the link repository?", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r403464937", "createdAt": "2020-04-04T12:31:44Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/converter/ConverterService.java", "diffHunk": "@@ -86,6 +93,13 @@\n         M transformedModel = projection.transformModel(modelObject);\n         DSpaceConverter<M, R> converter = requireConverter(modelObject.getClass());\n         R restObject = converter.convert(transformedModel, projection);\n+        if (restObject instanceof BaseObjectRest) {\n+            if (!dSpacePermissionEvaluator.hasPermission(SecurityContextHolder.getContext().getAuthentication(),\n+                                                         restObject, \"READ\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2NjE1Mg==", "bodyText": "can you help me to understand why is this change required? why IT cannot use anymore the converterService and need to go directly to the specific converter?", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r403466152", "createdAt": "2020-04-04T12:43:50Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/AuthorizationRestRepositoryIT.java", "diffHunk": "@@ -68,8 +70,13 @@\n     private AuthorizationFeatureService authorizationFeatureService;\n \n     @Autowired\n-    private ConverterService converterService;\n+    private SiteConverter siteConverter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2NjM1Nw==", "bodyText": "why this test should change? can you please update the previous description to reflect the right expected behavior (I guess that we don't want to get the embargoed item here)", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r403466357", "createdAt": "2020-04-04T12:46:12Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/BrowsesResourceControllerIT.java", "diffHunk": "@@ -364,23 +364,18 @@ public void findBrowseByTitleItems() throws Exception {\n                    //We expect the content type to be \"application/hal+json;charset=UTF-8\"\n                    .andExpect(content().contentType(contentType))\n \n-                   //We expect only the two public items and the embargoed item to be present\n                    .andExpect(jsonPath(\"$.page.size\", is(20)))\n-                   .andExpect(jsonPath(\"$.page.totalElements\", is(3)))\n+                   .andExpect(jsonPath(\"$.page.totalElements\", is(2)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2NjY3NA==", "bodyText": "you should add a check to verify that the embargoed item is not here (as you are fixing the test removing it from the \"found\" check)", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r403466674", "createdAt": "2020-04-04T12:49:23Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/BrowsesResourceControllerIT.java", "diffHunk": "@@ -364,23 +364,18 @@ public void findBrowseByTitleItems() throws Exception {\n                    //We expect the content type to be \"application/hal+json;charset=UTF-8\"\n                    .andExpect(content().contentType(contentType))\n \n-                   //We expect only the two public items and the embargoed item to be present\n                    .andExpect(jsonPath(\"$.page.size\", is(20)))\n-                   .andExpect(jsonPath(\"$.page.totalElements\", is(3)))\n+                   .andExpect(jsonPath(\"$.page.totalElements\", is(2)))\n                    .andExpect(jsonPath(\"$.page.totalPages\", is(1)))\n                    .andExpect(jsonPath(\"$.page.number\", is(0)))\n \n-                   //Verify that the title of the public and embargoed items are present and sorted descending\n                    .andExpect(jsonPath(\"$._embedded.items\",\n                                        contains(ItemMatcher.matchItemWithTitleAndDateIssued(publicItem2,\n                                                                                             \"Public item 2\",\n                                                                                             \"2016-02-13\"),\n                                                 ItemMatcher.matchItemWithTitleAndDateIssued(publicItem1,\n                                                                                             \"Public item 1\",\n-                                                                                            \"2017-10-17\"),\n-                                                ItemMatcher.matchItemWithTitleAndDateIssued(embargoedItem,\n-                                                                                            \"An embargoed publication\",\n-                                                                                            \"2017-08-10\"))))\n+                                                                                            \"2017-10-17\"))))\n \n                    //The private and internal items must not be present\n                    .andExpect(jsonPath(\"$._embedded.items[*].metadata\", Matchers.allOf(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2Njk4NA==", "bodyText": "yes, it is important that get information about which is the wrong assumption in such test because only if the test is conceptually wrong we should remove / or flag as ignored (to be updated in a later PR) otherwise it is a flag that something is wrong in this PR", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r403466984", "createdAt": "2020-04-04T12:53:01Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/ResourcePolicyRestRepositoryIT.java", "diffHunk": "@@ -503,7 +504,9 @@ public void findResourcePoliciesOfOneResourceWithoutActionTest() throws Exceptio\n             .andExpect(jsonPath(\"$.page.totalElements\", is(2)));\n     }\n \n+    // This test is currently not working as intended, needs to be reviewed.\n     @Test\n+    @Ignore", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwNTE4MQ=="}, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2NzM0OQ==", "bodyText": "we need to test that anonymous cannot use this endpoint (as this fix seems to imply) and we should also add test for a normal user able to follow its own redirect. This can be also noted in a separate ticket", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r403467349", "createdAt": "2020-04-04T12:56:38Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/UUIDLookupRestControllerIT.java", "diffHunk": "@@ -237,7 +237,9 @@ public void testEPersonUUID() throws Exception {\n         String uuid = eperson.getID().toString();\n         String epersonDetail = REST_SERVER_URL + \"eperson/epersons/\" + uuid;\n \n-        getClient().perform(get(\"/api/dso/find?uuid={uuid}\",uuid))\n+        String token = getAuthToken(admin.getEmail(), password);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2NzM5Nw==", "bodyText": "we should have test with the anonymous user and normal user as well. This can be noted in a separated ticket", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r403467397", "createdAt": "2020-04-04T12:57:24Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/UUIDLookupRestControllerIT.java", "diffHunk": "@@ -262,7 +264,9 @@ public void testGroupUUID() throws Exception {\n         String uuid = group.getID().toString();\n         String groupDetail = REST_SERVER_URL + \"eperson/groups/\" + uuid;\n \n-        getClient().perform(get(\"/api/dso/find?uuid={uuid}\",uuid))\n+        String token = getAuthToken(admin.getEmail(), password);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2NzcxMA==", "bodyText": "we need to have test to check the access to an \"inprogress\" version that is the case (wrongly) checked by the previous version of this test. I'm ok to just note that in a separate ticket.", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r403467710", "createdAt": "2020-04-04T13:00:47Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/VersionRestRepositoryIT.java", "diffHunk": "@@ -166,6 +175,10 @@ public void findOneForbiddenTest() throws Exception {\n     @Test\n     public void versionForItemTest() throws Exception {\n \n+        context.turnOffAuthorisationSystem();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2Nzk2MQ==", "bodyText": "yes, I also need help to understand the needs here and probably it will be good to add a javadoc or comment in the code for other that will check that at a later time.\nIt seems to me that you need to have a separate context bound to the \"thread\" for this IT but I don't see where this context is released", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r403467961", "createdAt": "2020-04-04T13:03:55Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/converter/ConverterServiceIT.java", "diffHunk": "@@ -57,6 +62,16 @@\n     @Mock\n     private Object mockEmbeddedResource;\n \n+    @Autowired\n+    private RequestService requestService;\n+\n+    @Before\n+    public void setup() {\n+        MockHttpServletRequest mockHttpServletRequest = new MockHttpServletRequest();\n+        mockHttpServletRequest.setAttribute(\"dspace.context\", new Context());\n+        MockHttpServletResponse mockHttpServletResponse = new MockHttpServletResponse();\n+        requestService.startRequest(mockHttpServletRequest, mockHttpServletResponse);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwNzE2OQ=="}, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50c340a8b3768c44bbca7afb161975cd43fc40eb", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/50c340a8b3768c44bbca7afb161975cd43fc40eb", "committedDate": "2020-05-13T07:39:42Z", "message": "Merge remote-tracking branch 'dspace/master' into w2p-69976_subresource-permissions\n\nConflicts:\n\tdspace-server-webapp/src/main/java/org/dspace/app/rest/RestResourceController.java\n\tdspace-server-webapp/src/main/java/org/dspace/app/rest/WorkflowDefinitionCollectionsLinkRepository.java\n\tdspace-server-webapp/src/main/java/org/dspace/app/rest/WorkflowDefinitionStepsLinkRepository.java\n\tdspace-server-webapp/src/main/java/org/dspace/app/rest/WorkflowStepActionsLinkRepository.java\n\tdspace-server-webapp/src/main/java/org/dspace/app/rest/converter/ConverterService.java\n\tdspace-server-webapp/src/main/java/org/dspace/app/rest/repository/VersionsLinkRepository.java\n\tdspace-server-webapp/src/test/java/org/dspace/app/rest/CollectionRestRepositoryIT.java\n\tdspace-server-webapp/src/test/java/org/dspace/app/rest/converter/ConverterServiceIT.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adfce8e9f3dbe805325f94a24af3eb5a2de01253", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/adfce8e9f3dbe805325f94a24af3eb5a2de01253", "committedDate": "2020-05-13T07:40:01Z", "message": "Fixed issues after master merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea538d619b1d5dc226afe737ea92314eb808bfc6", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/ea538d619b1d5dc226afe737ea92314eb808bfc6", "committedDate": "2020-05-13T11:13:54Z", "message": "[Task 70871] fixed tests after master merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "262d81a33f25992311aa32363c15ab24386bdcb4", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/262d81a33f25992311aa32363c15ab24386bdcb4", "committedDate": "2020-05-13T12:50:42Z", "message": "[Task 70871] implemented default preauthorize setting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODExNDE3", "url": "https://github.com/DSpace/DSpace/pull/2726#pullrequestreview-412811417", "createdAt": "2020-05-15T16:51:27Z", "commit": {"oid": "262d81a33f25992311aa32363c15ab24386bdcb4"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNjo1MToyN1rOGWMiZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNjo1ODozMVrOGWMwuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkyNzI2OQ==", "bodyText": "It appears the changes in RestResourceController are unnecessary.  This private method is never used, and the only other changes are space-related.\nCan we simply undo all the changes to this controller?", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r425927269", "createdAt": "2020-05-15T16:51:27Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/RestResourceController.java", "diffHunk": "@@ -895,6 +895,17 @@ public RepresentationModel findRel(HttpServletRequest request, HttpServletRespon\n \n     }\n \n+    private Page<? extends RestModel> getRestModelsWithoutNullValues(Pageable page,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "262d81a33f25992311aa32363c15ab24386bdcb4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkyNzkzMA==", "bodyText": "I'm still not sure this log.info message is necessary.  It doesn't seem to provide any useful information.  Should we just remove it?", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r425927930", "createdAt": "2020-05-15T16:52:43Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/converter/ConverterService.java", "diffHunk": "@@ -86,6 +93,13 @@\n         M transformedModel = projection.transformModel(modelObject);\n         DSpaceConverter<M, R> converter = requireConverter(modelObject.getClass());\n         R restObject = converter.convert(transformedModel, projection);\n+        if (restObject instanceof BaseObjectRest) {\n+            if (!dSpacePermissionEvaluator.hasPermission(SecurityContextHolder.getContext().getAuthentication(),\n+                                                         restObject, \"READ\")) {\n+                log.info(\"Access denied on \" + restObject.getClass());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwMDE3OA=="}, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkyOTYxMg==", "bodyText": "Should we return an error here too?  I'm not sure I understand why this is just a warning if you've received an AccessDeniedException.  The comment above this is unclear to me though, so I'm not sure what to recommend here.", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r425929612", "createdAt": "2020-05-15T16:56:01Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/utils/Utils.java", "diffHunk": "@@ -668,7 +669,10 @@ void embedRelFromRepository(HALResource<? extends RestAddressableModel> resource\n                 Object linkedObject = method.invoke(linkRepository, null, contentId, null, projection);\n                 resource.embedResource(rel, wrapForEmbedding(resource, linkedObject, link, oldLinks));\n             } catch (InvocationTargetException e) {\n-                if (e.getTargetException() instanceof RuntimeException) {\n+                // Can't do this beforehand because we lack information to call Evaluators\n+                if (e.getTargetException() instanceof AccessDeniedException) {\n+                    log.warn(\"Tried fetching resource: \" + linkRest.name() + \" for DSpaceObject with ID: \" + contentId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "262d81a33f25992311aa32363c15ab24386bdcb4"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkzMDIzMQ==", "bodyText": "I think we should create a ticket for this & link to the ticket here.  I'll create the ticket & add a link in this comment once it is ready.\nUPDATE: I created this ticket https://jira.lyrasis.org/browse/DS-4505 Please feel free to enhance it as needed. I'm willing to also schedule this for beta3 if there's interest in moving this forward immediately.", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r425930231", "createdAt": "2020-05-15T16:57:10Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/CollectionGroupRestControllerIT.java", "diffHunk": "@@ -955,7 +956,10 @@ public void getCollectionItemReadGroupTest() throws Exception {\n                             jsonPath(\"$\", GroupMatcher.matchGroupEntry(role.getID(), role.getName())));\n     }\n \n+    // Put on ignore because there's no support to identify read rights on a group for a user in a special\n+    // com/coll admin group", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "262d81a33f25992311aa32363c15ab24386bdcb4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkzMDkzOQ==", "bodyText": "This looks to have unresolved feedback.  I think I need inline comments here to understand why these changes are needed... as noted they don't seem to correspond to the changes you've made to ConverterService itself.", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r425930939", "createdAt": "2020-05-15T16:58:31Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/converter/ConverterServiceIT.java", "diffHunk": "@@ -57,6 +62,16 @@\n     @Mock\n     private Object mockEmbeddedResource;\n \n+    @Autowired\n+    private RequestService requestService;\n+\n+    @Before\n+    public void setup() {\n+        MockHttpServletRequest mockHttpServletRequest = new MockHttpServletRequest();\n+        mockHttpServletRequest.setAttribute(\"dspace.context\", new Context());\n+        MockHttpServletResponse mockHttpServletResponse = new MockHttpServletResponse();\n+        requestService.startRequest(mockHttpServletRequest, mockHttpServletResponse);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwNzE2OQ=="}, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34bf7dd76b09bd20226e8b4a2317bae472eaf8d7", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/34bf7dd76b09bd20226e8b4a2317bae472eaf8d7", "committedDate": "2020-05-18T13:54:38Z", "message": "[Task 70927] applied feedback on the subresources permissions functionality"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzOTEzNTM0", "url": "https://github.com/DSpace/DSpace/pull/2726#pullrequestreview-413913534", "createdAt": "2020-05-18T20:24:06Z", "commit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDoyNDowNlrOGXGS1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMDoyNzowMVrOGXGYLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg3MzU1OA==", "bodyText": "Just realized this question wasn't answered either.  Looking at this method, my best guess is you might need the returned Process to be attached to an active Context.  If that's the case, this getProcess() method likely should take a Context object as a parameter.  Otherwise, this Context may never be closed, which could result in odd behaviors.", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r426873558", "createdAt": "2020-05-18T20:24:06Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/scripts/handler/impl/RestDSpaceRunnableHandler.java", "diffHunk": "@@ -186,10 +186,6 @@ public Process getProcess() {\n             return processService.find(context, processId);\n         } catch (SQLException e) {\n             log.error(\"RestDSpaceRunnableHandler with process: \" + processId + \" could not be found\", e);\n-        } finally {\n-            if (context.isValid()) {\n-                context.abort();\n-            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwMjEzMQ=="}, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg3NDI5MA==", "bodyText": "Another old request. New class needs JavaDocs please", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r426874290", "createdAt": "2020-05-18T20:25:35Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/ScriptRestPermissionEvaluatorPlugin.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.security;\n+\n+import java.io.Serializable;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.model.ScriptRest;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class ScriptRestPermissionEvaluatorPlugin extends RestObjectPermissionEvaluatorPlugin {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwMzY4Mw=="}, "originalCommit": {"oid": "563d3f12410258808c34fff4ecbc45f435ac11bc"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg3NDkyNA==", "bodyText": "This class needs updated JavaDocs, as noted above.  I think it should say something like: \"This class will handle calls made to AuthorizationRest endpoints. It will return true because access can be granted anytime it's linked from another resource.\"", "url": "https://github.com/DSpace/DSpace/pull/2726#discussion_r426874924", "createdAt": "2020-05-18T20:27:01Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/AuthorizationFeatureRestPermissionEvaluatorPlugin.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.security;\n+\n+import java.io.Serializable;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.dspace.app.rest.model.AuthorizationFeatureRest;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * This class determines that any AuthorizationFeatureRest object can be viewed as it'll be a subresource of\n+ * AuthorizationRest", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzNzY3NA=="}, "originalCommit": {"oid": "165e39291013ece0b4120ea549a6968b3594ced9"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68b91aa8f04ac71c1d469c8db704601853b26d8a", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/68b91aa8f04ac71c1d469c8db704601853b26d8a", "committedDate": "2020-05-19T13:56:07Z", "message": "Applied feedback to the subresource permissions functionality"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MjY1MDQ0", "url": "https://github.com/DSpace/DSpace/pull/2726#pullrequestreview-416265044", "createdAt": "2020-05-21T15:41:00Z", "commit": {"oid": "68b91aa8f04ac71c1d469c8db704601853b26d8a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1410, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}