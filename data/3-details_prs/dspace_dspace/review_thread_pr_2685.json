{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3NzAzMjU1", "number": 2685, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMDo1NzoxM1rODm2ksw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMTowNjowMlrODm2ywg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMDY2NjExOnYy", "diffSide": "RIGHT", "path": "dspace-api/src/main/java/org/dspace/xmlworkflow/state/actions/Action.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMDo1NzoxM1rOF0gtSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMzoyMTozM1rOF1eTnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYwNjE1NQ==", "bodyText": "Tiny thing, but this method name is confusing to me.  The JavaDocs description makes sense, though.  Shouldn't this be named something like isOptionInParam(request)?   The current name sounds like we are checking whether the Request is in the list of Options.\nAlternatively, this could be named something like hasValidOption(request), because it seems like it's really meant to validate whether the request includes one of the Options available to the action.", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r390606155", "createdAt": "2020-03-10T20:57:13Z", "author": {"login": "tdonohue"}, "path": "dspace-api/src/main/java/org/dspace/xmlworkflow/state/actions/Action.java", "diffHunk": "@@ -50,6 +50,20 @@ public abstract ActionResult execute(Context c, XmlWorkflowItem wfi, Step step,\n      */\n     public abstract List<String> getOptions();\n \n+    /**\n+     * Returns true if one of the options is a parameter of the request\n+     * @param request   Action request\n+     * @return  true if one of the options is a parameter of the request; false if none was found\n+     */\n+    protected boolean isInOptions(HttpServletRequest request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "222d769d375b5131f584ecfccdc36188ce4f5c19"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYxNTM4OA==", "bodyText": "Renamed", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r391615388", "createdAt": "2020-03-12T13:21:33Z", "author": {"login": "MarieVerdonck"}, "path": "dspace-api/src/main/java/org/dspace/xmlworkflow/state/actions/Action.java", "diffHunk": "@@ -50,6 +50,20 @@ public abstract ActionResult execute(Context c, XmlWorkflowItem wfi, Step step,\n      */\n     public abstract List<String> getOptions();\n \n+    /**\n+     * Returns true if one of the options is a parameter of the request\n+     * @param request   Action request\n+     * @return  true if one of the options is a parameter of the request; false if none was found\n+     */\n+    protected boolean isInOptions(HttpServletRequest request) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYwNjE1NQ=="}, "originalCommit": {"oid": "222d769d375b5131f584ecfccdc36188ce4f5c19"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMDY5ODM5OnYy", "diffSide": "RIGHT", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkflowItemRestRepository.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMTowNDo1NVrOF0hAXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMzoyMjoxM1rOF1eU-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxMTAzOA==", "bodyText": "This should provide a more useful error message or just be updated to new RuntimeException(e);  Simply returning e.getMessage() isn't useful here.", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r390611038", "createdAt": "2020-03-10T21:04:55Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkflowItemRestRepository.java", "diffHunk": "@@ -294,4 +317,30 @@ protected void delete(Context context, Integer id) {\n             throw new RuntimeException(e.getMessage(), e);\n         }\n     }\n+\n+    /**\n+     * Checks if @link{SUBMIT_EDIT_METADATA} is a valid option in the workflow step this task is currently at.\n+     * Patching and uploading is only allowed if this is the case.\n+     * @param context               Context\n+     * @param xmlWorkflowItem       WorkflowItem of the task\n+     */\n+    private void checkIfEditMetadataAllowedInCurrentStep(Context context, XmlWorkflowItem xmlWorkflowItem) {\n+        try {\n+            ClaimedTask claimedTask = claimedTaskService.findByWorkflowIdAndEPerson(context, xmlWorkflowItem,\n+                context.getCurrentUser());\n+            if (claimedTask == null) {\n+                throw new UnprocessableEntityException(\"WorkflowItem with id \" + xmlWorkflowItem.getID()\n+                    + \" has not been claimed yet.\");\n+            }\n+            Workflow workflow = workflowFactory.getWorkflow(claimedTask.getWorkflowItem().getCollection());\n+            Step step = workflow.getStep(claimedTask.getStepID());\n+            WorkflowActionConfig currentActionConfig = step.getActionConfig(claimedTask.getActionID());\n+            if (!currentActionConfig.getProcessingAction().getOptions().contains(SUBMIT_EDIT_METADATA)) {\n+                throw new UnprocessableEntityException(SUBMIT_EDIT_METADATA + \" is not a valid option on this \" +\n+                    \"action (\" + currentActionConfig.getProcessingAction().getClass() + \").\");\n+            }\n+        } catch (SQLException | WorkflowConfigurationException e) {\n+            throw new RuntimeException(e.getMessage(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "222d769d375b5131f584ecfccdc36188ce4f5c19"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYxNTczOA==", "bodyText": "All generic exceptions in this repo given relevant messages", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r391615738", "createdAt": "2020-03-12T13:22:13Z", "author": {"login": "MarieVerdonck"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkflowItemRestRepository.java", "diffHunk": "@@ -294,4 +317,30 @@ protected void delete(Context context, Integer id) {\n             throw new RuntimeException(e.getMessage(), e);\n         }\n     }\n+\n+    /**\n+     * Checks if @link{SUBMIT_EDIT_METADATA} is a valid option in the workflow step this task is currently at.\n+     * Patching and uploading is only allowed if this is the case.\n+     * @param context               Context\n+     * @param xmlWorkflowItem       WorkflowItem of the task\n+     */\n+    private void checkIfEditMetadataAllowedInCurrentStep(Context context, XmlWorkflowItem xmlWorkflowItem) {\n+        try {\n+            ClaimedTask claimedTask = claimedTaskService.findByWorkflowIdAndEPerson(context, xmlWorkflowItem,\n+                context.getCurrentUser());\n+            if (claimedTask == null) {\n+                throw new UnprocessableEntityException(\"WorkflowItem with id \" + xmlWorkflowItem.getID()\n+                    + \" has not been claimed yet.\");\n+            }\n+            Workflow workflow = workflowFactory.getWorkflow(claimedTask.getWorkflowItem().getCollection());\n+            Step step = workflow.getStep(claimedTask.getStepID());\n+            WorkflowActionConfig currentActionConfig = step.getActionConfig(claimedTask.getActionID());\n+            if (!currentActionConfig.getProcessingAction().getOptions().contains(SUBMIT_EDIT_METADATA)) {\n+                throw new UnprocessableEntityException(SUBMIT_EDIT_METADATA + \" is not a valid option on this \" +\n+                    \"action (\" + currentActionConfig.getProcessingAction().getClass() + \").\");\n+            }\n+        } catch (SQLException | WorkflowConfigurationException e) {\n+            throw new RuntimeException(e.getMessage(), e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxMTAzOA=="}, "originalCommit": {"oid": "222d769d375b5131f584ecfccdc36188ce4f5c19"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMDcwMTI5OnYy", "diffSide": "RIGHT", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMTowNTo0OFrOF0hCIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMzoyMzowMVrOF1eW-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxMTQ4OA==", "bodyText": "Not sure why this comment needs changing? It looked correct, so I think this change can be reverted.", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r390611488", "createdAt": "2020-03-10T21:05:48Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java", "diffHunk": "@@ -1439,7 +1449,7 @@ public void approvalForbiddenTest() throws Exception {\n                                            .withName(\"Sub Community\")\n                                            .build();\n \n-        // the reviewer2 is a reviewer in a different step for the col1 and with the same role than reviewer1 for\n+        // the reviewer2 is a reviewer in a different step for the colAA1 and with the same role than reviewer1 for", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "222d769d375b5131f584ecfccdc36188ce4f5c19"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYxNjI1MA==", "bodyText": "From restoring from (for the indentations), re-implemented correction", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r391616250", "createdAt": "2020-03-12T13:23:01Z", "author": {"login": "MarieVerdonck"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java", "diffHunk": "@@ -1439,7 +1449,7 @@ public void approvalForbiddenTest() throws Exception {\n                                            .withName(\"Sub Community\")\n                                            .build();\n \n-        // the reviewer2 is a reviewer in a different step for the col1 and with the same role than reviewer1 for\n+        // the reviewer2 is a reviewer in a different step for the colAA1 and with the same role than reviewer1 for", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxMTQ4OA=="}, "originalCommit": {"oid": "222d769d375b5131f584ecfccdc36188ce4f5c19"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMDcwMjEwOnYy", "diffSide": "RIGHT", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMTowNjowMlrOF0hCkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMTowNjowMlrOF0hCkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxMTYwMA==", "bodyText": "Same here, this comment change can be reverted.", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r390611600", "createdAt": "2020-03-10T21:06:02Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java", "diffHunk": "@@ -1613,7 +1623,7 @@ public void rejectForbiddenTest() throws Exception {\n                                            .withName(\"Sub Community\")\n                                            .build();\n \n-        // the reviewer2 is a reviewer in a different step for the col1 and with the same role than reviewer1 for\n+        // the reviewer2 is a reviewer in a different step for the colAA1 and with the same role than reviewer1 for", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "222d769d375b5131f584ecfccdc36188ce4f5c19"}, "originalPosition": 102}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1656, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}