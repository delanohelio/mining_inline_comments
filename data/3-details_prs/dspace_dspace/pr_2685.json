{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3NzAzMjU1", "number": 2685, "title": "Workflow step definitions: action validation", "bodyText": "This PR is a continuation of: #2646\nWhen a workflow action is performed which is not authorized in the current step, deny performing this action, this ensures:\n\nReject an item should not be possible if the current workflow action doesn't have the submit_reject option.\nEdit metadata should not be possible if the current workflow action doesn't have the submit_edit_metadata option.\nUploading of a file should not be possible if the current workflow action doesn't have the submit_edit_metadata option.\n...", "createdAt": "2020-02-20T11:31:15Z", "url": "https://github.com/DSpace/DSpace/pull/2685", "merged": true, "mergeCommit": {"oid": "4ab134b63220c91f81ac678423ad0b61b2ac484f"}, "closed": true, "closedAt": "2020-03-12T14:47:31Z", "author": {"login": "KevinVdV"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDQmU-AH2gAyMzc3NzAzMjU1OjJlODA0MmU5N2Q2ZDYxNWY2NmE4NjUwY2E5M2MyYmE0ZTY3NTIwMDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcM82W3gFqTM3MzYyMTgzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2e8042e97d6d615f66a8650ca93c2ba4e6752005", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/2e8042e97d6d615f66a8650ca93c2ba4e6752005", "committedDate": "2020-02-11T12:08:12Z", "message": "68726: Integration tests of Workflow in rest api - WIP,\nsome unexpected results in edit and final edit step, @ignore tests for now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "347606b6f12466a8d934a469732800cb67cc17be", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/347606b6f12466a8d934a469732800cb67cc17be", "committedDate": "2020-02-17T15:03:18Z", "message": "68726: Workflow action options tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8845c02145a7355ca8f8cd552e4c6e372ada8197", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/8845c02145a7355ca8f8cd552e4c6e372ada8197", "committedDate": "2020-02-17T17:32:14Z", "message": "68726: checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "743d35f098c2a03edab7acd995f615cfd4fa3a53", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/743d35f098c2a03edab7acd995f615cfd4fa3a53", "committedDate": "2020-02-18T10:33:48Z", "message": "68821: check if submit button is in valid options for current action in workflow + previously @ignore tests now work as expected"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64900a8791e0dde3c4b89457ae52e92331cd8a70", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/64900a8791e0dde3c4b89457ae52e92331cd8a70", "committedDate": "2020-02-18T15:54:43Z", "message": "68825: only allow patch/upload in workflow if claimed task w edit_metadata option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a12c658f6f6006c7904c406d7bdfb4fa406c4c9", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/4a12c658f6f6006c7904c406d7bdfb4fa406c4c9", "committedDate": "2020-02-18T17:42:39Z", "message": "68825: checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15abc3aeb5ad4907cc0ae446a02255afbad5790b", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/15abc3aeb5ad4907cc0ae446a02255afbad5790b", "committedDate": "2020-02-19T09:49:20Z", "message": "68860: latest changes from workflow-step-definitions &\nsome exceptions restored except generic exception in upload so UnprocessableEntityException can be thrown in WorkflowItemRestRepository &\ncheckIfEditMetadataAllowedInCurrentStep works with xmlWorkflowItem instead of id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50daac593737ef8089099a1bf3b4587771aa7b68", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/50daac593737ef8089099a1bf3b4587771aa7b68", "committedDate": "2020-02-19T09:51:43Z", "message": "Merge remote-tracking branch 'dspace-origin/master' into w2p-68726_Workflow-IT-in-rest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "701144b10537e5bcd48b25beecfd0db5f3162ff5", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/701144b10537e5bcd48b25beecfd0db5f3162ff5", "committedDate": "2020-02-19T14:14:29Z", "message": "68860: test fixes after merging latest dspace-origin/master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c434124a385d15e5fd5db753ce2faf524df419d0", "author": {"user": {"login": "KevinVdV", "name": "Kevin Van de Velde"}}, "url": "https://github.com/DSpace/DSpace/commit/c434124a385d15e5fd5db753ce2faf524df419d0", "committedDate": "2020-02-20T11:17:46Z", "message": "Merge branch 'workflow-step-definitions' into w2p-68726_Workflow-IT-in-rest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3680b1a3690c26bc6b0dfaf349f76ae7f467529", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/d3680b1a3690c26bc6b0dfaf349f76ae7f467529", "committedDate": "2020-02-24T13:33:43Z", "message": "Merge branch 'workflow-step-definitions' into w2p-68726_Workflow-IT-in-rest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de1076959561fa1a5e988271b4cb7a804f9b953c", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/de1076959561fa1a5e988271b4cb7a804f9b953c", "committedDate": "2020-02-24T14:11:05Z", "message": "Merge branch 'workflow-step-definitions' into w2p-68726_Workflow-IT-in-rest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "928987b3935ffb46d69e64d4b90285aa9df154ea", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/928987b3935ffb46d69e64d4b90285aa9df154ea", "committedDate": "2020-02-24T14:52:48Z", "message": "Merge branch 'workflow-step-definitions' into w2p-68726_Workflow-IT-in-rest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f43e3e807e968acbb89af92fec9e20cc1636cbb", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/3f43e3e807e968acbb89af92fec9e20cc1636cbb", "committedDate": "2020-02-25T09:38:28Z", "message": "is(HttpStatus.SC_BAD_REQUEST) to isBadRequest()"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "3f43e3e807e968acbb89af92fec9e20cc1636cbb", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/3f43e3e807e968acbb89af92fec9e20cc1636cbb", "committedDate": "2020-02-25T09:38:28Z", "message": "is(HttpStatus.SC_BAD_REQUEST) to isBadRequest()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d33115fde9147b10d2ce528ffd2b2215253f0003", "author": {"user": {"login": "KevinVdV", "name": "Kevin Van de Velde"}}, "url": "https://github.com/DSpace/DSpace/commit/d33115fde9147b10d2ce528ffd2b2215253f0003", "committedDate": "2020-02-26T15:29:40Z", "message": "Merge branch 'master' into w2p-68726_Workflow-IT-in-rest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDY2NDk0", "url": "https://github.com/DSpace/DSpace/pull/2685#pullrequestreview-369466494", "createdAt": "2020-03-05T10:46:50Z", "commit": {"oid": "d33115fde9147b10d2ce528ffd2b2215253f0003"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0863a0505d38e532046f20f3908da63f5f18f3b", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/f0863a0505d38e532046f20f3908da63f5f18f3b", "committedDate": "2020-03-06T09:40:10Z", "message": "only do step of workflow whose action is being tested"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "222d769d375b5131f584ecfccdc36188ce4f5c19", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/222d769d375b5131f584ecfccdc36188ce4f5c19", "committedDate": "2020-03-06T09:55:56Z", "message": "reinstated indents of master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMzE1OTY2", "url": "https://github.com/DSpace/DSpace/pull/2685#pullrequestreview-372315966", "createdAt": "2020-03-10T20:57:13Z", "commit": {"oid": "222d769d375b5131f584ecfccdc36188ce4f5c19"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMDo1NzoxM1rOF0gtSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMTowNjowMlrOF0hCkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYwNjE1NQ==", "bodyText": "Tiny thing, but this method name is confusing to me.  The JavaDocs description makes sense, though.  Shouldn't this be named something like isOptionInParam(request)?   The current name sounds like we are checking whether the Request is in the list of Options.\nAlternatively, this could be named something like hasValidOption(request), because it seems like it's really meant to validate whether the request includes one of the Options available to the action.", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r390606155", "createdAt": "2020-03-10T20:57:13Z", "author": {"login": "tdonohue"}, "path": "dspace-api/src/main/java/org/dspace/xmlworkflow/state/actions/Action.java", "diffHunk": "@@ -50,6 +50,20 @@ public abstract ActionResult execute(Context c, XmlWorkflowItem wfi, Step step,\n      */\n     public abstract List<String> getOptions();\n \n+    /**\n+     * Returns true if one of the options is a parameter of the request\n+     * @param request   Action request\n+     * @return  true if one of the options is a parameter of the request; false if none was found\n+     */\n+    protected boolean isInOptions(HttpServletRequest request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "222d769d375b5131f584ecfccdc36188ce4f5c19"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxMTAzOA==", "bodyText": "This should provide a more useful error message or just be updated to new RuntimeException(e);  Simply returning e.getMessage() isn't useful here.", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r390611038", "createdAt": "2020-03-10T21:04:55Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkflowItemRestRepository.java", "diffHunk": "@@ -294,4 +317,30 @@ protected void delete(Context context, Integer id) {\n             throw new RuntimeException(e.getMessage(), e);\n         }\n     }\n+\n+    /**\n+     * Checks if @link{SUBMIT_EDIT_METADATA} is a valid option in the workflow step this task is currently at.\n+     * Patching and uploading is only allowed if this is the case.\n+     * @param context               Context\n+     * @param xmlWorkflowItem       WorkflowItem of the task\n+     */\n+    private void checkIfEditMetadataAllowedInCurrentStep(Context context, XmlWorkflowItem xmlWorkflowItem) {\n+        try {\n+            ClaimedTask claimedTask = claimedTaskService.findByWorkflowIdAndEPerson(context, xmlWorkflowItem,\n+                context.getCurrentUser());\n+            if (claimedTask == null) {\n+                throw new UnprocessableEntityException(\"WorkflowItem with id \" + xmlWorkflowItem.getID()\n+                    + \" has not been claimed yet.\");\n+            }\n+            Workflow workflow = workflowFactory.getWorkflow(claimedTask.getWorkflowItem().getCollection());\n+            Step step = workflow.getStep(claimedTask.getStepID());\n+            WorkflowActionConfig currentActionConfig = step.getActionConfig(claimedTask.getActionID());\n+            if (!currentActionConfig.getProcessingAction().getOptions().contains(SUBMIT_EDIT_METADATA)) {\n+                throw new UnprocessableEntityException(SUBMIT_EDIT_METADATA + \" is not a valid option on this \" +\n+                    \"action (\" + currentActionConfig.getProcessingAction().getClass() + \").\");\n+            }\n+        } catch (SQLException | WorkflowConfigurationException e) {\n+            throw new RuntimeException(e.getMessage(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "222d769d375b5131f584ecfccdc36188ce4f5c19"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxMTQ4OA==", "bodyText": "Not sure why this comment needs changing? It looked correct, so I think this change can be reverted.", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r390611488", "createdAt": "2020-03-10T21:05:48Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java", "diffHunk": "@@ -1439,7 +1449,7 @@ public void approvalForbiddenTest() throws Exception {\n                                            .withName(\"Sub Community\")\n                                            .build();\n \n-        // the reviewer2 is a reviewer in a different step for the col1 and with the same role than reviewer1 for\n+        // the reviewer2 is a reviewer in a different step for the colAA1 and with the same role than reviewer1 for", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "222d769d375b5131f584ecfccdc36188ce4f5c19"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxMTYwMA==", "bodyText": "Same here, this comment change can be reverted.", "url": "https://github.com/DSpace/DSpace/pull/2685#discussion_r390611600", "createdAt": "2020-03-10T21:06:02Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/TaskRestRepositoriesIT.java", "diffHunk": "@@ -1613,7 +1623,7 @@ public void rejectForbiddenTest() throws Exception {\n                                            .withName(\"Sub Community\")\n                                            .build();\n \n-        // the reviewer2 is a reviewer in a different step for the col1 and with the same role than reviewer1 for\n+        // the reviewer2 is a reviewer in a different step for the colAA1 and with the same role than reviewer1 for", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "222d769d375b5131f584ecfccdc36188ce4f5c19"}, "originalPosition": 102}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65943dc0d6dc1eccd74e97acdd0e0f7bd8f8cc59", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/65943dc0d6dc1eccd74e97acdd0e0f7bd8f8cc59", "committedDate": "2020-03-12T09:52:05Z", "message": "Process feedback: Exception messages, renamed method & comment fix restored"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNjIxODMy", "url": "https://github.com/DSpace/DSpace/pull/2685#pullrequestreview-373621832", "createdAt": "2020-03-12T14:46:51Z", "commit": {"oid": "65943dc0d6dc1eccd74e97acdd0e0f7bd8f8cc59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1616, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}