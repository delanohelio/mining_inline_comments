{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyMzY3NTk3", "number": 2719, "title": "REST API should respect \"metadata.hide\" configurations", "bodyText": "This is the beta 2 feature to ensure e.g. dc.description.provenance is not exposed except for admins.\nAll metadata fields configured in metadata.hide will be omitted for non-admins", "createdAt": "2020-03-23T12:54:37Z", "url": "https://github.com/DSpace/DSpace/pull/2719", "merged": true, "mergeCommit": {"oid": "c529d1888065772112cc963e1fc48c2ff0c6ec26"}, "closed": true, "closedAt": "2020-04-09T16:29:54Z", "author": {"login": "benbosman"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPLPGsAH2gAyMzkyMzY3NTk3OjFiNTc2MWYyYjlhOWVmZjBiMDZmNmVlNTcxNDUzMTg1YTVkN2Y2ZWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcV3grlAH2gAyMzkyMzY3NTk3OjEwOWJlNzllZGQ2YzYzMzMwZDgyNjMwMWI0MzM5NzM1OTQ2MmYzMjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1b5761f2b9a9eff0b06f6ee571453185a5d7f6ee", "author": {"user": {"login": "YanaDePauw", "name": "Yana De Pauw"}}, "url": "https://github.com/DSpace/DSpace/commit/1b5761f2b9a9eff0b06f6ee571453185a5d7f6ee", "committedDate": "2020-03-19T12:40:24Z", "message": "69741: Restrict metadata exposure acccording to hidden metadata configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a03eb8d6d258f1545eddac2bda0c92a1b1d1767", "author": {"user": {"login": "YanaDePauw", "name": "Yana De Pauw"}}, "url": "https://github.com/DSpace/DSpace/commit/9a03eb8d6d258f1545eddac2bda0c92a1b1d1767", "committedDate": "2020-03-23T09:06:41Z", "message": "69944: ITs for metadata.hide"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9df42b3deaf8232742a8a31ded3390af0013dafa", "author": {"user": {"login": "YanaDePauw", "name": "Yana De Pauw"}}, "url": "https://github.com/DSpace/DSpace/commit/9df42b3deaf8232742a8a31ded3390af0013dafa", "committedDate": "2020-03-23T15:10:53Z", "message": "Merge remote-tracking branch 'upstream/master' into w2p-69741_Refactoring-Rest-Converters\n\n Conflicts:\n\tdspace-server-webapp/src/test/java/org/dspace/app/rest/ItemRestRepositoryIT.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzOTY1MzA0", "url": "https://github.com/DSpace/DSpace/pull/2719#pullrequestreview-383965304", "createdAt": "2020-03-30T15:21:20Z", "commit": {"oid": "9df42b3deaf8232742a8a31ded3390af0013dafa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNToyMToyMFrOF9vC4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNToyMToyMFrOF9vC4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI3ODI0MA==", "bodyText": "This setting should be moved to /dspace-api/src/test/data/dspaceFolder/config/local.cfg  That's the local.cfg file that is used for all tests.  (I'm surprised this works to add it to dspace-services).\nAlternatively, (and possibly the better method), this config could be simply removed and updated dynamically in the tests that require it by doing something like:\n@Autowired\nprivate ConfigurationService configurationService;\n\n... then, in method that needs it...\n\nconfigurationService.setProperty(\"metadata.hide.dc.description.provenance\", true);\n\nKeep in mind, the ConfigurationService auto-reloads (resets itself to default values) after every test.  So, this lets you only set it to true in methods that need this setting, and all others will default to false.", "url": "https://github.com/DSpace/DSpace/pull/2719#discussion_r400278240", "createdAt": "2020-03-30T15:21:20Z", "author": {"login": "tdonohue"}, "path": "dspace-services/src/test/resources/config/local.properties", "diffHunk": "@@ -29,3 +29,9 @@ include = included.properties\n # (We purposefully misspell DSpace and correct it in tests)\n # See DSpaceConfigurationServiceTest.testAutomaticReload()\n prop.to.auto.reload = D-space\n+\n+\n+# This default configuration hides the dc.description.provenance field,\n+# since that usually contains email addresses which ought to be kept\n+# private and is mainly of interest to administrators:\n+metadata.hide.dc.description.provenance = true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9df42b3deaf8232742a8a31ded3390af0013dafa"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c86e46b813bb1a4643070ffdaa2f75e574c4b6d", "author": {"user": {"login": "YanaDePauw", "name": "Yana De Pauw"}}, "url": "https://github.com/DSpace/DSpace/commit/3c86e46b813bb1a4643070ffdaa2f75e574c4b6d", "committedDate": "2020-03-31T09:37:26Z", "message": "Remove test config for metadata hide"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae4125054e738523693794f8fd6be1fdfc423d9d", "author": {"user": {"login": "YanaDePauw", "name": "Yana De Pauw"}}, "url": "https://github.com/DSpace/DSpace/commit/ae4125054e738523693794f8fd6be1fdfc423d9d", "committedDate": "2020-03-31T10:58:23Z", "message": "Merge remote-tracking branch 'upstream/master' into w2p-69741_Refactoring-Rest-Converters\n\n Conflicts:\n\tdspace-server-webapp/src/test/java/org/dspace/app/rest/CollectionRestRepositoryIT.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7de0baab8fcb7051745094caebb4cf7ad249139e", "author": {"user": {"login": "YanaDePauw", "name": "Yana De Pauw"}}, "url": "https://github.com/DSpace/DSpace/commit/7de0baab8fcb7051745094caebb4cf7ad249139e", "committedDate": "2020-03-31T10:58:36Z", "message": "Fix checkstyle issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NzU3NjMw", "url": "https://github.com/DSpace/DSpace/pull/2719#pullrequestreview-386757630", "createdAt": "2020-04-02T20:08:01Z", "commit": {"oid": "7de0baab8fcb7051745094caebb4cf7ad249139e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMDowODowMlrOF_7krg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMDowODoxN1rOF_7lIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4MDY1NA==", "bodyText": "Really tiny thing, but I prefer that we log more descriptive error messages.  For example, this could be something like:\nlog.error(\"Error filtering metadata based on permissions\", e);", "url": "https://github.com/DSpace/DSpace/pull/2719#discussion_r402580654", "createdAt": "2020-04-02T20:08:02Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/converter/DSpaceObjectConverter.java", "diffHunk": "@@ -35,10 +60,53 @@ public R convert(M obj, Projection projection) {\n             resource.setUuid(obj.getID().toString());\n         }\n         resource.setName(obj.getName());\n-        MetadataValueList metadataValues = new MetadataValueList(obj.getMetadata());\n+\n+        MetadataValueList metadataValues = getPermissionFilteredMetadata(getContext(), obj);\n         resource.setMetadata(converter.toRest(metadataValues, projection));\n         return resource;\n     }\n \n     protected abstract R newInstance();\n+\n+\n+    /**\n+     * Retrieves the metadata list filtered according to the hidden metadata configuration\n+     * When the context is null, it will return the metadatalist as for an anonymous user\n+     * @param context   The context\n+     * @param obj       The object of which the filtered metadata will be retrieved\n+     * @return A list of object metadata filtered based on the the hidden metadata configuration\n+     */\n+    public MetadataValueList getPermissionFilteredMetadata(Context context, M obj) {\n+        List<MetadataValue> metadata = obj.getMetadata();\n+        try {\n+            if (context != null && authorizeService.isAdmin(context)) {\n+                return new MetadataValueList(metadata);\n+            }\n+            for (MetadataValue mv : metadata) {\n+                MetadataField metadataField = mv.getMetadataField();\n+                if (metadataExposureService\n+                        .isHidden(context, metadataField.getMetadataSchema().getName(),\n+                                  metadataField.getElement(),\n+                                  metadataField.getQualifier())) {\n+                    metadata.remove(mv);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            log.error(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de0baab8fcb7051745094caebb4cf7ad249139e"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4MDc3MA==", "bodyText": "Similar to above, this could be a more useful error message", "url": "https://github.com/DSpace/DSpace/pull/2719#discussion_r402580770", "createdAt": "2020-04-02T20:08:17Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/converter/ItemConverter.java", "diffHunk": "@@ -47,13 +51,41 @@ public ItemRest convert(Item obj, Projection projection) {\n         item.setWithdrawn(obj.isWithdrawn());\n         item.setLastModified(obj.getLastModified());\n \n-        List<MetadataValue> fullList = itemService.getMetadata(obj, Item.ANY, Item.ANY, Item.ANY, Item.ANY, true);\n-        MetadataValueList metadataValues = new MetadataValueList(fullList);\n-        item.setMetadata(converter.toRest(metadataValues, projection));\n-\n         return item;\n     }\n \n+    /**\n+     * Retrieves the metadata list filtered according to the hidden metadata configuration\n+     * When the context is null, it will return the metadatalist as for an anonymous user\n+     * Overrides the parent method to include virtual metadata\n+     * @param context The context\n+     * @param obj     The object of which the filtered metadata will be retrieved\n+     * @return A list of object metadata (including virtual metadata) filtered based on the the hidden metadata\n+     * configuration\n+     */\n+    @Override\n+    public MetadataValueList getPermissionFilteredMetadata(Context context, Item obj) {\n+        List<MetadataValue> fullList = itemService.getMetadata(obj, Item.ANY, Item.ANY, Item.ANY, Item.ANY, true);\n+        List<MetadataValue> returnList = new LinkedList<>();\n+        try {\n+            if (context != null && authorizeService.isAdmin(context)) {\n+                return new MetadataValueList(fullList);\n+            }\n+            for (MetadataValue mv : fullList) {\n+                MetadataField metadataField = mv.getMetadataField();\n+                if (!metadataExposureService\n+                        .isHidden(context, metadataField.getMetadataSchema().getName(),\n+                                  metadataField.getElement(),\n+                                  metadataField.getQualifier())) {\n+                    returnList.add(mv);\n+                }\n+            }\n+        } catch (SQLException e) {\n+            log.error(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de0baab8fcb7051745094caebb4cf7ad249139e"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NzYwOTYx", "url": "https://github.com/DSpace/DSpace/pull/2719#pullrequestreview-386760961", "createdAt": "2020-04-02T20:13:44Z", "commit": {"oid": "7de0baab8fcb7051745094caebb4cf7ad249139e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NzAzMjcw", "url": "https://github.com/DSpace/DSpace/pull/2719#pullrequestreview-387703270", "createdAt": "2020-04-04T14:17:49Z", "commit": {"oid": "7de0baab8fcb7051745094caebb4cf7ad249139e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "109be79edd6c63330d826301b43397359462f323", "author": {"user": {"login": "YanaDePauw", "name": "Yana De Pauw"}}, "url": "https://github.com/DSpace/DSpace/commit/109be79edd6c63330d826301b43397359462f323", "committedDate": "2020-04-09T07:38:58Z", "message": "70236: Update log messages"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1656, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}