{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0MjQyNDk1", "number": 2747, "title": "Account profile management ", "bodyText": "This PR is related to the rest contract update mentioned in: DSpace/RestContract#113\n\nAdmin users can edit both the non-metadata information (email, netid etc) as well as the metadata information of all users\nNon admin user can edit their own metadata information\nNon admin user can not edit their non-metadata information (email, netid etc)\nNon admin users can not edit another person's information", "createdAt": "2020-04-16T09:48:12Z", "url": "https://github.com/DSpace/DSpace/pull/2747", "merged": true, "mergeCommit": {"oid": "ea746e2aebc2517b03fe5e9d5b757c3d64a072b5"}, "closed": true, "closedAt": "2020-05-10T11:52:07Z", "author": {"login": "jonas-atmire"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcX1um4gH2gAyNDA0MjQyNDk1OjczOGI4YzQzMjkyYjc5NDM0NjU0MmUzMDM1MzI1MjVmOGY2M2IwYWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcf5tZ3gFqTQwODczNzI0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "738b8c43292b794346542e303532525f8f63b0ae", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/738b8c43292b794346542e303532525f8f63b0ae", "committedDate": "2020-04-15T10:42:13Z", "message": "70402: authorization logic in EPersonRestRepository#Patch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5727d090a94a18a38c66ccd45d3174f4471bd56d", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/5727d090a94a18a38c66ccd45d3174f4471bd56d", "committedDate": "2020-04-15T11:11:15Z", "message": "70402: authorization logic via pre-authorize, in EPersonRestPermissionEvaluatorPlugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb1d5bd47acf5fe868e01662df426aff681e2f03", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/bb1d5bd47acf5fe868e01662df426aff681e2f03", "committedDate": "2020-04-15T11:12:51Z", "message": "70402: Tests for replace /metadata PATCH of own metadata at /eperson/epersons/<id>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MzM5NTgy", "url": "https://github.com/DSpace/DSpace/pull/2747#pullrequestreview-405339582", "createdAt": "2020-05-04T20:54:49Z", "commit": {"oid": "bb1d5bd47acf5fe868e01662df426aff681e2f03"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDo1NDo0OVrOGQRzrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMTowMDoyNFrOGQR_8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcyMjE1Ng==", "bodyText": "This method is missing a context.restoreAuthSystemState(); after creating the EPerson", "url": "https://github.com/DSpace/DSpace/pull/2747#discussion_r419722156", "createdAt": "2020-05-04T20:54:49Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java", "diffHunk": "@@ -1516,6 +1517,102 @@ private void runPatchMetadataTests(EPerson asUser, int expectedStatus) throws Ex\n         new MetadataPatchSuite().runWith(getClient(token), \"/api/eperson/epersons/\" + ePerson.getID(), expectedStatus);\n     }\n \n+    @Test\n+    public void patchMetadataByAdmin() throws Exception {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"Johndoe@fake-email.com\")\n+                                        .build();\n+\n+        String newName = \"JohnReplace\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1d5bd47acf5fe868e01662df426aff681e2f03"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcyMzAzOQ==", "bodyText": "Incorrect comment.  Say something like: \"// should be allowed (as an Eperson can update their own metadata), and eperson.firstname should be replaced.", "url": "https://github.com/DSpace/DSpace/pull/2747#discussion_r419723039", "createdAt": "2020-05-04T20:56:24Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java", "diffHunk": "@@ -1516,6 +1517,102 @@ private void runPatchMetadataTests(EPerson asUser, int expectedStatus) throws Ex\n         new MetadataPatchSuite().runWith(getClient(token), \"/api/eperson/epersons/\" + ePerson.getID(), expectedStatus);\n     }\n \n+    @Test\n+    public void patchMetadataByAdmin() throws Exception {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"Johndoe@fake-email.com\")\n+                                        .build();\n+\n+        String newName = \"JohnReplace\";\n+\n+        List<Operation> ops = new ArrayList<Operation>();\n+        ReplaceOperation replaceOperation = new ReplaceOperation(\"/metadata/eperson.firstname\", newName);\n+        ops.add(replaceOperation);\n+        String patchBody = getPatchContent(ops);\n+\n+        String token = getAuthToken(admin.getEmail(), password);\n+\n+        // should be allowed, and eperson.firstname should be replaced.\n+        getClient(token).perform(patch(\"/api/eperson/epersons/\" + ePerson.getID())\n+            .content(patchBody)\n+            .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                        .andExpect(status().isOk())\n+                        .andExpect(jsonPath(\"$.metadata\", Matchers.allOf(\n+                            MetadataMatcher.matchMetadata(\"eperson.firstname\", newName))));\n+    }\n+\n+    @Test\n+    public void patchOwnMetadataByNonAdminUser() throws Exception {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"Johndoe@fake-email.com\")\n+                                        .withPassword(password)\n+                                        .build();\n+\n+        String newName = \"JohnReplace\";\n+\n+        context.restoreAuthSystemState();\n+\n+        List<Operation> ops = new ArrayList<Operation>();\n+        ReplaceOperation replaceOperation = new ReplaceOperation(\"/metadata/eperson.firstname\", newName);\n+        ops.add(replaceOperation);\n+        String patchBody = getPatchContent(ops);\n+\n+        String token = getAuthToken(ePerson.getEmail(), password);\n+\n+        // updates password", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1d5bd47acf5fe868e01662df426aff681e2f03"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcyMzQ3OQ==", "bodyText": "Incorrect comment. Should say something like // not allowed, as a non-Admin cannot modify other users", "url": "https://github.com/DSpace/DSpace/pull/2747#discussion_r419723479", "createdAt": "2020-05-04T20:57:10Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java", "diffHunk": "@@ -1516,6 +1517,102 @@ private void runPatchMetadataTests(EPerson asUser, int expectedStatus) throws Ex\n         new MetadataPatchSuite().runWith(getClient(token), \"/api/eperson/epersons/\" + ePerson.getID(), expectedStatus);\n     }\n \n+    @Test\n+    public void patchMetadataByAdmin() throws Exception {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"Johndoe@fake-email.com\")\n+                                        .build();\n+\n+        String newName = \"JohnReplace\";\n+\n+        List<Operation> ops = new ArrayList<Operation>();\n+        ReplaceOperation replaceOperation = new ReplaceOperation(\"/metadata/eperson.firstname\", newName);\n+        ops.add(replaceOperation);\n+        String patchBody = getPatchContent(ops);\n+\n+        String token = getAuthToken(admin.getEmail(), password);\n+\n+        // should be allowed, and eperson.firstname should be replaced.\n+        getClient(token).perform(patch(\"/api/eperson/epersons/\" + ePerson.getID())\n+            .content(patchBody)\n+            .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                        .andExpect(status().isOk())\n+                        .andExpect(jsonPath(\"$.metadata\", Matchers.allOf(\n+                            MetadataMatcher.matchMetadata(\"eperson.firstname\", newName))));\n+    }\n+\n+    @Test\n+    public void patchOwnMetadataByNonAdminUser() throws Exception {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"Johndoe@fake-email.com\")\n+                                        .withPassword(password)\n+                                        .build();\n+\n+        String newName = \"JohnReplace\";\n+\n+        context.restoreAuthSystemState();\n+\n+        List<Operation> ops = new ArrayList<Operation>();\n+        ReplaceOperation replaceOperation = new ReplaceOperation(\"/metadata/eperson.firstname\", newName);\n+        ops.add(replaceOperation);\n+        String patchBody = getPatchContent(ops);\n+\n+        String token = getAuthToken(ePerson.getEmail(), password);\n+\n+        // updates password\n+        getClient(token).perform(patch(\"/api/eperson/epersons/\" + ePerson.getID())\n+                                     .content(patchBody)\n+                                     .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                        .andExpect(status().isOk())\n+                        .andExpect(jsonPath(\"$.metadata\", Matchers.allOf(\n+                            MetadataMatcher.matchMetadata(\"eperson.firstname\", newName))));\n+\n+    }\n+\n+    @Test\n+    public void patchNotOwnMetadataByNonAdminUser() throws Exception {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"Johndoe@fake-email.com\")\n+                                        .withPassword(password)\n+                                        .build();\n+\n+        EPerson ePerson2 = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"Jane\", \"Smith\")\n+                                        .withEmail(\"Janesmith@fake-email.com\")\n+                                        .withPassword(password)\n+                                        .build();\n+\n+        String newName = \"JohnReplace\";\n+\n+        context.restoreAuthSystemState();\n+\n+        List<Operation> ops = new ArrayList<Operation>();\n+        ReplaceOperation replaceOperation = new ReplaceOperation(\"/metadata/eperson.firstname\", newName);\n+        ops.add(replaceOperation);\n+        String patchBody = getPatchContent(ops);\n+\n+        String token = getAuthToken(ePerson2.getEmail(), password);\n+\n+        // updates password", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1d5bd47acf5fe868e01662df426aff681e2f03"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcyNTI5Nw==", "bodyText": "It's unclear why this is now @Autowired and imported into this class. I don't see any new code that uses it?  Are these changes to EPersonRestRepository necessary?", "url": "https://github.com/DSpace/DSpace/pull/2747#discussion_r419725297", "createdAt": "2020-05-04T21:00:24Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/EPersonRestRepository.java", "diffHunk": "@@ -44,6 +45,9 @@\n     @Autowired\n     AuthorizeService authorizeService;\n \n+    @Autowired\n+    DSpaceObjectMetadataPatchUtils metadataPatchUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1d5bd47acf5fe868e01662df426aff681e2f03"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MDY4NTEz", "url": "https://github.com/DSpace/DSpace/pull/2747#pullrequestreview-406068513", "createdAt": "2020-05-05T18:56:05Z", "commit": {"oid": "bb1d5bd47acf5fe868e01662df426aff681e2f03"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxODo1NjowNVrOGQ3PfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxOTowMjo0M1rOGQ3eAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMzNTQ4NA==", "bodyText": "is this redundant?", "url": "https://github.com/DSpace/DSpace/pull/2747#discussion_r420335484", "createdAt": "2020-05-05T18:56:05Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/EPersonRestPermissionEvaluatorPlugin.java", "diffHunk": "@@ -102,10 +103,12 @@ public boolean hasPatchPermission(Authentication authentication, Serializable ta\n         /**\n          * The entire Patch request should be denied if it contains operations that are\n          * restricted to Dspace administrators. The authenticated user is currently allowed to\n-         * update their own password.\n+         * update their own password and their own metadata.\n          */\n         for (Operation op: operations) {\n-            if (!op.getPath().contentEquals(EPersonPasswordReplaceOperation.OPERATION_PASSWORD_CHANGE)) {\n+            if (!(op.getPath().contentEquals(EPersonPasswordReplaceOperation.OPERATION_PASSWORD_CHANGE)\n+                || (op.getPath().startsWith(DSpaceObjectMetadataPatchUtils.OPERATION_METADATA_PATH)\n+                || op.getPath().equals(DSpaceObjectMetadataPatchUtils.OPERATION_METADATA_PATH)))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1d5bd47acf5fe868e01662df426aff681e2f03"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMzNjkwNQ==", "bodyText": "please take the chance to also change the email to something at example.com, it was noted by other (I guess mwood) that it is better to use this domain as it is reserved for this specific purpose", "url": "https://github.com/DSpace/DSpace/pull/2747#discussion_r420336905", "createdAt": "2020-05-05T18:58:36Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java", "diffHunk": "@@ -1516,6 +1517,102 @@ private void runPatchMetadataTests(EPerson asUser, int expectedStatus) throws Ex\n         new MetadataPatchSuite().runWith(getClient(token), \"/api/eperson/epersons/\" + ePerson.getID(), expectedStatus);\n     }\n \n+    @Test\n+    public void patchMetadataByAdmin() throws Exception {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"Johndoe@fake-email.com\")\n+                                        .build();\n+\n+        String newName = \"JohnReplace\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcyMjE1Ng=="}, "originalCommit": {"oid": "bb1d5bd47acf5fe868e01662df426aff681e2f03"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMzNzU1OA==", "bodyText": "please check that the changes are persisted with an additional get", "url": "https://github.com/DSpace/DSpace/pull/2747#discussion_r420337558", "createdAt": "2020-05-05T18:59:46Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java", "diffHunk": "@@ -1516,6 +1517,102 @@ private void runPatchMetadataTests(EPerson asUser, int expectedStatus) throws Ex\n         new MetadataPatchSuite().runWith(getClient(token), \"/api/eperson/epersons/\" + ePerson.getID(), expectedStatus);\n     }\n \n+    @Test\n+    public void patchMetadataByAdmin() throws Exception {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"Johndoe@fake-email.com\")\n+                                        .build();\n+\n+        String newName = \"JohnReplace\";\n+\n+        List<Operation> ops = new ArrayList<Operation>();\n+        ReplaceOperation replaceOperation = new ReplaceOperation(\"/metadata/eperson.firstname\", newName);\n+        ops.add(replaceOperation);\n+        String patchBody = getPatchContent(ops);\n+\n+        String token = getAuthToken(admin.getEmail(), password);\n+\n+        // should be allowed, and eperson.firstname should be replaced.\n+        getClient(token).perform(patch(\"/api/eperson/epersons/\" + ePerson.getID())\n+            .content(patchBody)\n+            .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                        .andExpect(status().isOk())\n+                        .andExpect(jsonPath(\"$.metadata\", Matchers.allOf(\n+                            MetadataMatcher.matchMetadata(\"eperson.firstname\", newName))));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1d5bd47acf5fe868e01662df426aff681e2f03"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMzODkxOQ==", "bodyText": "please use an additional get to check that changes are persisted", "url": "https://github.com/DSpace/DSpace/pull/2747#discussion_r420338919", "createdAt": "2020-05-05T19:02:13Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java", "diffHunk": "@@ -1516,6 +1517,102 @@ private void runPatchMetadataTests(EPerson asUser, int expectedStatus) throws Ex\n         new MetadataPatchSuite().runWith(getClient(token), \"/api/eperson/epersons/\" + ePerson.getID(), expectedStatus);\n     }\n \n+    @Test\n+    public void patchMetadataByAdmin() throws Exception {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"Johndoe@fake-email.com\")\n+                                        .build();\n+\n+        String newName = \"JohnReplace\";\n+\n+        List<Operation> ops = new ArrayList<Operation>();\n+        ReplaceOperation replaceOperation = new ReplaceOperation(\"/metadata/eperson.firstname\", newName);\n+        ops.add(replaceOperation);\n+        String patchBody = getPatchContent(ops);\n+\n+        String token = getAuthToken(admin.getEmail(), password);\n+\n+        // should be allowed, and eperson.firstname should be replaced.\n+        getClient(token).perform(patch(\"/api/eperson/epersons/\" + ePerson.getID())\n+            .content(patchBody)\n+            .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                        .andExpect(status().isOk())\n+                        .andExpect(jsonPath(\"$.metadata\", Matchers.allOf(\n+                            MetadataMatcher.matchMetadata(\"eperson.firstname\", newName))));\n+    }\n+\n+    @Test\n+    public void patchOwnMetadataByNonAdminUser() throws Exception {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"Johndoe@fake-email.com\")\n+                                        .withPassword(password)\n+                                        .build();\n+\n+        String newName = \"JohnReplace\";\n+\n+        context.restoreAuthSystemState();\n+\n+        List<Operation> ops = new ArrayList<Operation>();\n+        ReplaceOperation replaceOperation = new ReplaceOperation(\"/metadata/eperson.firstname\", newName);\n+        ops.add(replaceOperation);\n+        String patchBody = getPatchContent(ops);\n+\n+        String token = getAuthToken(ePerson.getEmail(), password);\n+\n+        // updates password\n+        getClient(token).perform(patch(\"/api/eperson/epersons/\" + ePerson.getID())\n+                                     .content(patchBody)\n+                                     .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                        .andExpect(status().isOk())\n+                        .andExpect(jsonPath(\"$.metadata\", Matchers.allOf(\n+                            MetadataMatcher.matchMetadata(\"eperson.firstname\", newName))));\n+\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1d5bd47acf5fe868e01662df426aff681e2f03"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMzOTIwMA==", "bodyText": "please verify that no changes have been applied", "url": "https://github.com/DSpace/DSpace/pull/2747#discussion_r420339200", "createdAt": "2020-05-05T19:02:43Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java", "diffHunk": "@@ -1516,6 +1517,102 @@ private void runPatchMetadataTests(EPerson asUser, int expectedStatus) throws Ex\n         new MetadataPatchSuite().runWith(getClient(token), \"/api/eperson/epersons/\" + ePerson.getID(), expectedStatus);\n     }\n \n+    @Test\n+    public void patchMetadataByAdmin() throws Exception {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"Johndoe@fake-email.com\")\n+                                        .build();\n+\n+        String newName = \"JohnReplace\";\n+\n+        List<Operation> ops = new ArrayList<Operation>();\n+        ReplaceOperation replaceOperation = new ReplaceOperation(\"/metadata/eperson.firstname\", newName);\n+        ops.add(replaceOperation);\n+        String patchBody = getPatchContent(ops);\n+\n+        String token = getAuthToken(admin.getEmail(), password);\n+\n+        // should be allowed, and eperson.firstname should be replaced.\n+        getClient(token).perform(patch(\"/api/eperson/epersons/\" + ePerson.getID())\n+            .content(patchBody)\n+            .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                        .andExpect(status().isOk())\n+                        .andExpect(jsonPath(\"$.metadata\", Matchers.allOf(\n+                            MetadataMatcher.matchMetadata(\"eperson.firstname\", newName))));\n+    }\n+\n+    @Test\n+    public void patchOwnMetadataByNonAdminUser() throws Exception {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"Johndoe@fake-email.com\")\n+                                        .withPassword(password)\n+                                        .build();\n+\n+        String newName = \"JohnReplace\";\n+\n+        context.restoreAuthSystemState();\n+\n+        List<Operation> ops = new ArrayList<Operation>();\n+        ReplaceOperation replaceOperation = new ReplaceOperation(\"/metadata/eperson.firstname\", newName);\n+        ops.add(replaceOperation);\n+        String patchBody = getPatchContent(ops);\n+\n+        String token = getAuthToken(ePerson.getEmail(), password);\n+\n+        // updates password\n+        getClient(token).perform(patch(\"/api/eperson/epersons/\" + ePerson.getID())\n+                                     .content(patchBody)\n+                                     .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                        .andExpect(status().isOk())\n+                        .andExpect(jsonPath(\"$.metadata\", Matchers.allOf(\n+                            MetadataMatcher.matchMetadata(\"eperson.firstname\", newName))));\n+\n+    }\n+\n+    @Test\n+    public void patchNotOwnMetadataByNonAdminUser() throws Exception {\n+\n+        context.turnOffAuthorisationSystem();\n+\n+        EPerson ePerson = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"John\", \"Doe\")\n+                                        .withEmail(\"Johndoe@fake-email.com\")\n+                                        .withPassword(password)\n+                                        .build();\n+\n+        EPerson ePerson2 = EPersonBuilder.createEPerson(context)\n+                                        .withNameInMetadata(\"Jane\", \"Smith\")\n+                                        .withEmail(\"Janesmith@fake-email.com\")\n+                                        .withPassword(password)\n+                                        .build();\n+\n+        String newName = \"JohnReplace\";\n+\n+        context.restoreAuthSystemState();\n+\n+        List<Operation> ops = new ArrayList<Operation>();\n+        ReplaceOperation replaceOperation = new ReplaceOperation(\"/metadata/eperson.firstname\", newName);\n+        ops.add(replaceOperation);\n+        String patchBody = getPatchContent(ops);\n+\n+        String token = getAuthToken(ePerson2.getEmail(), password);\n+\n+        // updates password\n+        getClient(token).perform(patch(\"/api/eperson/epersons/\" + ePerson.getID())\n+                                     .content(patchBody)\n+                                     .contentType(MediaType.APPLICATION_JSON_PATCH_JSON))\n+                        .andExpect(status().isForbidden());\n+\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1d5bd47acf5fe868e01662df426aff681e2f03"}, "originalPosition": 106}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92cc64c30a82b71eba5f3864404adfa3fce5f122", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/92cc64c30a82b71eba5f3864404adfa3fce5f122", "committedDate": "2020-05-06T09:54:26Z", "message": "70701: Process PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NTY4NDU0", "url": "https://github.com/DSpace/DSpace/pull/2747#pullrequestreview-407568454", "createdAt": "2020-05-07T15:08:24Z", "commit": {"oid": "92cc64c30a82b71eba5f3864404adfa3fce5f122"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNTowODoyNFrOGSDL9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNTowODoyNFrOGSDL9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU3OTc2NA==", "bodyText": "there are only formatting change in this class, can you revert them please?", "url": "https://github.com/DSpace/DSpace/pull/2747#discussion_r421579764", "createdAt": "2020-05-07T15:08:24Z", "author": {"login": "abollini"}, "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/EPersonRestRepository.java", "diffHunk": "@@ -54,7 +54,7 @@ public EPersonRestRepository(EPersonService dsoService) {\n \n     @Override\n     protected EPersonRest createAndReturn(Context context)\n-            throws AuthorizeException {\n+        throws AuthorizeException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92cc64c30a82b71eba5f3864404adfa3fce5f122"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "b93145d2d3d3cebabaf2e9a93459f170152e1b19", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/b93145d2d3d3cebabaf2e9a93459f170152e1b19", "committedDate": "2020-05-08T08:17:09Z", "message": "Revert format changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "b93145d2d3d3cebabaf2e9a93459f170152e1b19", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/b93145d2d3d3cebabaf2e9a93459f170152e1b19", "committedDate": "2020-05-08T08:17:09Z", "message": "Revert format changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "36914e1d85cd4ae4f4705da95822e8ba62f5180e", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/36914e1d85cd4ae4f4705da95822e8ba62f5180e", "committedDate": "2020-05-08T08:27:31Z", "message": "Revert format changes - EPersonRestRepository"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "36914e1d85cd4ae4f4705da95822e8ba62f5180e", "author": {"user": {"login": "MarieVerdonck", "name": "Marie Verdonck"}}, "url": "https://github.com/DSpace/DSpace/commit/36914e1d85cd4ae4f4705da95822e8ba62f5180e", "committedDate": "2020-05-08T08:27:31Z", "message": "Revert format changes - EPersonRestRepository"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4Mjk5NTA5", "url": "https://github.com/DSpace/DSpace/pull/2747#pullrequestreview-408299509", "createdAt": "2020-05-08T14:57:21Z", "commit": {"oid": "36914e1d85cd4ae4f4705da95822e8ba62f5180e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NzM3MjQ3", "url": "https://github.com/DSpace/DSpace/pull/2747#pullrequestreview-408737247", "createdAt": "2020-05-10T11:51:55Z", "commit": {"oid": "36914e1d85cd4ae4f4705da95822e8ba62f5180e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1436, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}