{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMTkxMjcx", "number": 2746, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMTo0NDoxNVrOEzA2yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxOToxMzozMVrOE_TPqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxOTI2ODU3OnYy", "diffSide": "RIGHT", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/RelationshipRestRepositoryIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMTo0NDoxNVrOHp-pfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMTo0NDoxNVrOHp-pfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc4MDA5Mg==", "bodyText": "@benbosman : Just a quick note that this PR needs a rebase & cleanup.  It looks like nearly all the changes to RelationshipRestRepositoryIT are space changes (where the IDE seems to have made a lot of unrelated alignment changes).  If you could revert those space changes it'd make this PR easier to review (and it might even fall into the \"1 approval\" category).", "url": "https://github.com/DSpace/DSpace/pull/2746#discussion_r513780092", "createdAt": "2020-10-28T21:44:15Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/RelationshipRestRepositoryIT.java", "diffHunk": "@@ -105,60 +116,60 @@ public void setUp() throws Exception {\n         context.turnOffAuthorisationSystem();\n \n         parentCommunity = CommunityBuilder.createCommunity(context)\n-                                          .withName(\"Parent Community\")\n-                                          .build();\n+                .withName(\"Parent Community\")\n+                .build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "effd6410658b15859d6c83479e83a471e4b73397"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzNDIzMjM2OnYy", "diffSide": "RIGHT", "path": "dspace-api/src/main/java/org/dspace/content/dao/impl/RelationshipDAOImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNjowMDoyMFrOHsKsXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNjo1NDowNFrOH-mtaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA3NDU4OQ==", "bodyText": "I don't specially like the approach of passing parameters that in my perspective describe the property of an object. In this particular case the object Relationship. The concept of Left and Right item are always subjective and relative to the person that defines it. I think a different approach that could be considered in the future is to probably considers an Item not for the location/position which is it, but if it's itself in a relation verification.\nBut I understand the reason for having this boolean here. And considering the required effort for a different approach, I'm ok with having it this way in this version.", "url": "https://github.com/DSpace/DSpace/pull/2746#discussion_r516074589", "createdAt": "2020-11-02T16:00:20Z", "author": {"login": "paulo-graca"}, "path": "dspace-api/src/main/java/org/dspace/content/dao/impl/RelationshipDAOImpl.java", "diffHunk": "@@ -201,18 +201,24 @@ public int countRows(Context context) throws SQLException {\n     }\n \n     @Override\n-    public int countByItemAndRelationshipType(Context context, Item item, RelationshipType relationshipType)\n-            throws SQLException {\n+    public int countByItemAndRelationshipType(Context context, Item item, RelationshipType relationshipType,\n+                                              boolean isLeft) throws SQLException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccb18daeb03ea19cf7de3b380380b0618c2e7497"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY1ODk5Mw==", "bodyText": "I agree with @paulo-graca 's comment here.  It seems like this isLeft is needed, but it's an awkward implementation...the left/right concept is turning out to be quite confusing (and it is subjective).  I'm not sure what to replace it with though, as that would take more detailed discussion that would likely need to be delayed for post 7.0", "url": "https://github.com/DSpace/DSpace/pull/2746#discussion_r533658993", "createdAt": "2020-12-01T19:15:30Z", "author": {"login": "tdonohue"}, "path": "dspace-api/src/main/java/org/dspace/content/dao/impl/RelationshipDAOImpl.java", "diffHunk": "@@ -201,18 +201,24 @@ public int countRows(Context context) throws SQLException {\n     }\n \n     @Override\n-    public int countByItemAndRelationshipType(Context context, Item item, RelationshipType relationshipType)\n-            throws SQLException {\n+    public int countByItemAndRelationshipType(Context context, Item item, RelationshipType relationshipType,\n+                                              boolean isLeft) throws SQLException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA3NDU4OQ=="}, "originalCommit": {"oid": "ccb18daeb03ea19cf7de3b380380b0618c2e7497"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQwNzk3OQ==", "bodyText": "The Left/Right contents is indeed not pre-defined, and just dependent on how the relation is configured. The concept of Left/Right was chosen to make it easier if you draw the relationship on paper.\nIt's not an easy concept to support any relationship in code, but feel free to create a ticket with suggestions to make this easier to understand.\nFor 7.0 it's indeed not realistic to adjust this", "url": "https://github.com/DSpace/DSpace/pull/2746#discussion_r535407979", "createdAt": "2020-12-03T16:54:04Z", "author": {"login": "benbosman"}, "path": "dspace-api/src/main/java/org/dspace/content/dao/impl/RelationshipDAOImpl.java", "diffHunk": "@@ -201,18 +201,24 @@ public int countRows(Context context) throws SQLException {\n     }\n \n     @Override\n-    public int countByItemAndRelationshipType(Context context, Item item, RelationshipType relationshipType)\n-            throws SQLException {\n+    public int countByItemAndRelationshipType(Context context, Item item, RelationshipType relationshipType,\n+                                              boolean isLeft) throws SQLException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA3NDU4OQ=="}, "originalCommit": {"oid": "ccb18daeb03ea19cf7de3b380380b0618c2e7497"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0ODEwNjk4OnYy", "diffSide": "RIGHT", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/RelationshipRestRepositoryIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxOToxMjoyNVrOH872nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMzoyMTowOFrOH_QoKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY1NzI0NA==", "bodyText": "This post() and all the others in this IT do not seem to be cleaning up after themselves.  Remember we should be using a try/finally, using an .andDo() to capture the ID of the created object (I suspect this code was just written prior to that best practice being established).  In any case, here's an example: https://github.com/DSpace/DSpace/blob/main/dspace-server-webapp/src/test/java/org/dspace/app/rest/ScriptRestRepositoryIT.java#L195-L207", "url": "https://github.com/DSpace/DSpace/pull/2746#discussion_r533657244", "createdAt": "2020-12-01T19:12:25Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/RelationshipRestRepositoryIT.java", "diffHunk": "@@ -2482,5 +2500,160 @@ public void putRelationshipWithJson() throws Exception {\n \n     }\n \n+    @Test\n+    public void orgUnitAndOrgUnitRelationshipVirtualMetadataTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n+\n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        MvcResult mvcResult = getClient(adminToken).perform(post(\"/api/core/relationships\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccb18daeb03ea19cf7de3b380380b0618c2e7497"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA5NDc2Mw==", "bodyText": "This has been updated", "url": "https://github.com/DSpace/DSpace/pull/2746#discussion_r536094763", "createdAt": "2020-12-04T13:21:08Z", "author": {"login": "benbosman"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/RelationshipRestRepositoryIT.java", "diffHunk": "@@ -2482,5 +2500,160 @@ public void putRelationshipWithJson() throws Exception {\n \n     }\n \n+    @Test\n+    public void orgUnitAndOrgUnitRelationshipVirtualMetadataTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n+\n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        MvcResult mvcResult = getClient(adminToken).perform(post(\"/api/core/relationships\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY1NzI0NA=="}, "originalCommit": {"oid": "ccb18daeb03ea19cf7de3b380380b0618c2e7497"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0ODEwODcyOnYy", "diffSide": "RIGHT", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/RelationshipRestRepositoryIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxOToxMjo1N1rOH873yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMzoyMToxMlrOH_QoWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY1NzU0NQ==", "bodyText": "Again, post should cleanup after itself", "url": "https://github.com/DSpace/DSpace/pull/2746#discussion_r533657545", "createdAt": "2020-12-01T19:12:57Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/RelationshipRestRepositoryIT.java", "diffHunk": "@@ -2482,5 +2500,160 @@ public void putRelationshipWithJson() throws Exception {\n \n     }\n \n+    @Test\n+    public void orgUnitAndOrgUnitRelationshipVirtualMetadataTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n+\n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        MvcResult mvcResult = getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                                                .param(\"relationshipType\",\n+                                                                       isParentOrgUnitOf.getID().toString())\n+                                                                .contentType(MediaType.parseMediaType\n+                                                                    (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                                         .TEXT_URI_LIST_VALUE))\n+                                                                .content(\n+                                                                    \"https://localhost:8080/server/api/core/items/\" + orgUnit1\n+                                                                        .getID() + \"\\n\" +\n+                                                                        \"https://localhost:8080/server/api/core/items\" +\n+                                                                        \"/\" + orgUnit2\n+                                                                        .getID()))\n+                                                   .andExpect(status().isCreated())\n+                                                   .andReturn();\n+\n+\n+        itemService.getMetadata(orgUnit1, \"*\", \"*\", \"*\", \"*\", true);\n+\n+        getClient(adminToken).perform(get(\"/api/core/items/\" + orgUnit1.getID()))\n+                             .andExpect(status().isOk())\n+                             .andExpect(jsonPath(\"$.metadata['relation.isParentOrgUnitOf'][0].value\",\n+                                                 is(String.valueOf(orgUnit2.getID()))));\n+        getClient(adminToken).perform(get(\"/api/core/items/\" + orgUnit2.getID()))\n+                             .andExpect(status().isOk())\n+                             .andExpect(jsonPath(\"$.metadata['relation.isChildOrgUnitOf'][0].value\",\n+                                                 is(String.valueOf(orgUnit1.getID()))));\n+\n+\n+\n+    }\n+\n+    @Test\n+    public void orgUnitFindByLabelParentChildOfCountTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n+\n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccb18daeb03ea19cf7de3b380380b0618c2e7497"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA5NDgwOQ==", "bodyText": "This has been updated", "url": "https://github.com/DSpace/DSpace/pull/2746#discussion_r536094809", "createdAt": "2020-12-04T13:21:12Z", "author": {"login": "benbosman"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/RelationshipRestRepositoryIT.java", "diffHunk": "@@ -2482,5 +2500,160 @@ public void putRelationshipWithJson() throws Exception {\n \n     }\n \n+    @Test\n+    public void orgUnitAndOrgUnitRelationshipVirtualMetadataTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n+\n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        MvcResult mvcResult = getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                                                .param(\"relationshipType\",\n+                                                                       isParentOrgUnitOf.getID().toString())\n+                                                                .contentType(MediaType.parseMediaType\n+                                                                    (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                                         .TEXT_URI_LIST_VALUE))\n+                                                                .content(\n+                                                                    \"https://localhost:8080/server/api/core/items/\" + orgUnit1\n+                                                                        .getID() + \"\\n\" +\n+                                                                        \"https://localhost:8080/server/api/core/items\" +\n+                                                                        \"/\" + orgUnit2\n+                                                                        .getID()))\n+                                                   .andExpect(status().isCreated())\n+                                                   .andReturn();\n+\n+\n+        itemService.getMetadata(orgUnit1, \"*\", \"*\", \"*\", \"*\", true);\n+\n+        getClient(adminToken).perform(get(\"/api/core/items/\" + orgUnit1.getID()))\n+                             .andExpect(status().isOk())\n+                             .andExpect(jsonPath(\"$.metadata['relation.isParentOrgUnitOf'][0].value\",\n+                                                 is(String.valueOf(orgUnit2.getID()))));\n+        getClient(adminToken).perform(get(\"/api/core/items/\" + orgUnit2.getID()))\n+                             .andExpect(status().isOk())\n+                             .andExpect(jsonPath(\"$.metadata['relation.isChildOrgUnitOf'][0].value\",\n+                                                 is(String.valueOf(orgUnit1.getID()))));\n+\n+\n+\n+    }\n+\n+    @Test\n+    public void orgUnitFindByLabelParentChildOfCountTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n+\n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY1NzU0NQ=="}, "originalCommit": {"oid": "ccb18daeb03ea19cf7de3b380380b0618c2e7497"}, "originalPosition": 122}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0ODEwOTQ5OnYy", "diffSide": "RIGHT", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/RelationshipRestRepositoryIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxOToxMzoxMlrOH874TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMzoyMToxNlrOH_QofQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY1NzY3Nw==", "bodyText": "Again, post should cleanup after itself", "url": "https://github.com/DSpace/DSpace/pull/2746#discussion_r533657677", "createdAt": "2020-12-01T19:13:12Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/RelationshipRestRepositoryIT.java", "diffHunk": "@@ -2482,5 +2500,160 @@ public void putRelationshipWithJson() throws Exception {\n \n     }\n \n+    @Test\n+    public void orgUnitAndOrgUnitRelationshipVirtualMetadataTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n+\n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        MvcResult mvcResult = getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                                                .param(\"relationshipType\",\n+                                                                       isParentOrgUnitOf.getID().toString())\n+                                                                .contentType(MediaType.parseMediaType\n+                                                                    (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                                         .TEXT_URI_LIST_VALUE))\n+                                                                .content(\n+                                                                    \"https://localhost:8080/server/api/core/items/\" + orgUnit1\n+                                                                        .getID() + \"\\n\" +\n+                                                                        \"https://localhost:8080/server/api/core/items\" +\n+                                                                        \"/\" + orgUnit2\n+                                                                        .getID()))\n+                                                   .andExpect(status().isCreated())\n+                                                   .andReturn();\n+\n+\n+        itemService.getMetadata(orgUnit1, \"*\", \"*\", \"*\", \"*\", true);\n+\n+        getClient(adminToken).perform(get(\"/api/core/items/\" + orgUnit1.getID()))\n+                             .andExpect(status().isOk())\n+                             .andExpect(jsonPath(\"$.metadata['relation.isParentOrgUnitOf'][0].value\",\n+                                                 is(String.valueOf(orgUnit2.getID()))));\n+        getClient(adminToken).perform(get(\"/api/core/items/\" + orgUnit2.getID()))\n+                             .andExpect(status().isOk())\n+                             .andExpect(jsonPath(\"$.metadata['relation.isChildOrgUnitOf'][0].value\",\n+                                                 is(String.valueOf(orgUnit1.getID()))));\n+\n+\n+\n+    }\n+\n+    @Test\n+    public void orgUnitFindByLabelParentChildOfCountTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n+\n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                                                .param(\"relationshipType\",\n+                                                                       isParentOrgUnitOf.getID().toString())\n+                                                                .contentType(MediaType.parseMediaType\n+                                                                    (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                                         .TEXT_URI_LIST_VALUE))\n+                                                                .content(\n+                                                                    \"https://localhost:8080/server/api/core/items/\" + orgUnit1\n+                                                                        .getID() + \"\\n\" +\n+                                                                        \"https://localhost:8080/server/api/core/items\" +\n+                                                                        \"/\" + orgUnit2\n+                                                                        .getID()))\n+                                                   .andExpect(status().isCreated());\n+\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                                                .param(\"relationshipType\",\n+                                                                       isParentOrgUnitOf.getID().toString())\n+                                                                .contentType(MediaType.parseMediaType\n+                                                                    (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                                         .TEXT_URI_LIST_VALUE))\n+                                                                .content(\n+                                                                    \"https://localhost:8080/server/api/core/items/\" + orgUnit2\n+                                                                        .getID() + \"\\n\" +\n+                                                                        \"https://localhost:8080/server/api/core/items\" +\n+                                                                        \"/\" + orgUnit3\n+                                                                        .getID()))\n+                                                   .andExpect(status().isCreated());\n+\n+        getClient().perform(get(\"/api/core/relationships/search/byLabel\")\n+                                .param(\"label\", \"isChildOrgUnitOf\")\n+                                .param(\"dso\", String.valueOf(orgUnit2.getID()))\n+                                .param(\"page\", \"0\")\n+                                .param(\"size\", \"1\"))\n+                    .andExpect(status().isOk())\n+                    .andExpect(jsonPath(\"$.page\", PageMatcher.pageEntryWithTotalPagesAndElements(0, 1, 1, 1)));\n+\n+\n+    }\n+\n+\n+    @Test\n+    public void orgUnitLeftMaxCardinalityTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n \n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccb18daeb03ea19cf7de3b380380b0618c2e7497"}, "originalPosition": 178}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA5NDg0NQ==", "bodyText": "This has been updated", "url": "https://github.com/DSpace/DSpace/pull/2746#discussion_r536094845", "createdAt": "2020-12-04T13:21:16Z", "author": {"login": "benbosman"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/RelationshipRestRepositoryIT.java", "diffHunk": "@@ -2482,5 +2500,160 @@ public void putRelationshipWithJson() throws Exception {\n \n     }\n \n+    @Test\n+    public void orgUnitAndOrgUnitRelationshipVirtualMetadataTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n+\n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        MvcResult mvcResult = getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                                                .param(\"relationshipType\",\n+                                                                       isParentOrgUnitOf.getID().toString())\n+                                                                .contentType(MediaType.parseMediaType\n+                                                                    (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                                         .TEXT_URI_LIST_VALUE))\n+                                                                .content(\n+                                                                    \"https://localhost:8080/server/api/core/items/\" + orgUnit1\n+                                                                        .getID() + \"\\n\" +\n+                                                                        \"https://localhost:8080/server/api/core/items\" +\n+                                                                        \"/\" + orgUnit2\n+                                                                        .getID()))\n+                                                   .andExpect(status().isCreated())\n+                                                   .andReturn();\n+\n+\n+        itemService.getMetadata(orgUnit1, \"*\", \"*\", \"*\", \"*\", true);\n+\n+        getClient(adminToken).perform(get(\"/api/core/items/\" + orgUnit1.getID()))\n+                             .andExpect(status().isOk())\n+                             .andExpect(jsonPath(\"$.metadata['relation.isParentOrgUnitOf'][0].value\",\n+                                                 is(String.valueOf(orgUnit2.getID()))));\n+        getClient(adminToken).perform(get(\"/api/core/items/\" + orgUnit2.getID()))\n+                             .andExpect(status().isOk())\n+                             .andExpect(jsonPath(\"$.metadata['relation.isChildOrgUnitOf'][0].value\",\n+                                                 is(String.valueOf(orgUnit1.getID()))));\n+\n+\n+\n+    }\n+\n+    @Test\n+    public void orgUnitFindByLabelParentChildOfCountTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n+\n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                                                .param(\"relationshipType\",\n+                                                                       isParentOrgUnitOf.getID().toString())\n+                                                                .contentType(MediaType.parseMediaType\n+                                                                    (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                                         .TEXT_URI_LIST_VALUE))\n+                                                                .content(\n+                                                                    \"https://localhost:8080/server/api/core/items/\" + orgUnit1\n+                                                                        .getID() + \"\\n\" +\n+                                                                        \"https://localhost:8080/server/api/core/items\" +\n+                                                                        \"/\" + orgUnit2\n+                                                                        .getID()))\n+                                                   .andExpect(status().isCreated());\n+\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                                                .param(\"relationshipType\",\n+                                                                       isParentOrgUnitOf.getID().toString())\n+                                                                .contentType(MediaType.parseMediaType\n+                                                                    (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                                         .TEXT_URI_LIST_VALUE))\n+                                                                .content(\n+                                                                    \"https://localhost:8080/server/api/core/items/\" + orgUnit2\n+                                                                        .getID() + \"\\n\" +\n+                                                                        \"https://localhost:8080/server/api/core/items\" +\n+                                                                        \"/\" + orgUnit3\n+                                                                        .getID()))\n+                                                   .andExpect(status().isCreated());\n+\n+        getClient().perform(get(\"/api/core/relationships/search/byLabel\")\n+                                .param(\"label\", \"isChildOrgUnitOf\")\n+                                .param(\"dso\", String.valueOf(orgUnit2.getID()))\n+                                .param(\"page\", \"0\")\n+                                .param(\"size\", \"1\"))\n+                    .andExpect(status().isOk())\n+                    .andExpect(jsonPath(\"$.page\", PageMatcher.pageEntryWithTotalPagesAndElements(0, 1, 1, 1)));\n+\n+\n+    }\n+\n+\n+    @Test\n+    public void orgUnitLeftMaxCardinalityTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n \n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY1NzY3Nw=="}, "originalCommit": {"oid": "ccb18daeb03ea19cf7de3b380380b0618c2e7497"}, "originalPosition": 178}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0ODExMDQ4OnYy", "diffSide": "RIGHT", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/RelationshipRestRepositoryIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxOToxMzozMVrOH8746g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMzoyMToyMFrOH_Qong==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY1NzgzNA==", "bodyText": "Again, post should cleanup after itself", "url": "https://github.com/DSpace/DSpace/pull/2746#discussion_r533657834", "createdAt": "2020-12-01T19:13:31Z", "author": {"login": "tdonohue"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/RelationshipRestRepositoryIT.java", "diffHunk": "@@ -2482,5 +2500,160 @@ public void putRelationshipWithJson() throws Exception {\n \n     }\n \n+    @Test\n+    public void orgUnitAndOrgUnitRelationshipVirtualMetadataTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n+\n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        MvcResult mvcResult = getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                                                .param(\"relationshipType\",\n+                                                                       isParentOrgUnitOf.getID().toString())\n+                                                                .contentType(MediaType.parseMediaType\n+                                                                    (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                                         .TEXT_URI_LIST_VALUE))\n+                                                                .content(\n+                                                                    \"https://localhost:8080/server/api/core/items/\" + orgUnit1\n+                                                                        .getID() + \"\\n\" +\n+                                                                        \"https://localhost:8080/server/api/core/items\" +\n+                                                                        \"/\" + orgUnit2\n+                                                                        .getID()))\n+                                                   .andExpect(status().isCreated())\n+                                                   .andReturn();\n+\n+\n+        itemService.getMetadata(orgUnit1, \"*\", \"*\", \"*\", \"*\", true);\n+\n+        getClient(adminToken).perform(get(\"/api/core/items/\" + orgUnit1.getID()))\n+                             .andExpect(status().isOk())\n+                             .andExpect(jsonPath(\"$.metadata['relation.isParentOrgUnitOf'][0].value\",\n+                                                 is(String.valueOf(orgUnit2.getID()))));\n+        getClient(adminToken).perform(get(\"/api/core/items/\" + orgUnit2.getID()))\n+                             .andExpect(status().isOk())\n+                             .andExpect(jsonPath(\"$.metadata['relation.isChildOrgUnitOf'][0].value\",\n+                                                 is(String.valueOf(orgUnit1.getID()))));\n+\n+\n+\n+    }\n+\n+    @Test\n+    public void orgUnitFindByLabelParentChildOfCountTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n+\n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                                                .param(\"relationshipType\",\n+                                                                       isParentOrgUnitOf.getID().toString())\n+                                                                .contentType(MediaType.parseMediaType\n+                                                                    (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                                         .TEXT_URI_LIST_VALUE))\n+                                                                .content(\n+                                                                    \"https://localhost:8080/server/api/core/items/\" + orgUnit1\n+                                                                        .getID() + \"\\n\" +\n+                                                                        \"https://localhost:8080/server/api/core/items\" +\n+                                                                        \"/\" + orgUnit2\n+                                                                        .getID()))\n+                                                   .andExpect(status().isCreated());\n+\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                                                .param(\"relationshipType\",\n+                                                                       isParentOrgUnitOf.getID().toString())\n+                                                                .contentType(MediaType.parseMediaType\n+                                                                    (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                                         .TEXT_URI_LIST_VALUE))\n+                                                                .content(\n+                                                                    \"https://localhost:8080/server/api/core/items/\" + orgUnit2\n+                                                                        .getID() + \"\\n\" +\n+                                                                        \"https://localhost:8080/server/api/core/items\" +\n+                                                                        \"/\" + orgUnit3\n+                                                                        .getID()))\n+                                                   .andExpect(status().isCreated());\n+\n+        getClient().perform(get(\"/api/core/relationships/search/byLabel\")\n+                                .param(\"label\", \"isChildOrgUnitOf\")\n+                                .param(\"dso\", String.valueOf(orgUnit2.getID()))\n+                                .param(\"page\", \"0\")\n+                                .param(\"size\", \"1\"))\n+                    .andExpect(status().isOk())\n+                    .andExpect(jsonPath(\"$.page\", PageMatcher.pageEntryWithTotalPagesAndElements(0, 1, 1, 1)));\n+\n+\n+    }\n+\n+\n+    @Test\n+    public void orgUnitLeftMaxCardinalityTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n \n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                          .param(\"relationshipType\",\n+                                                 isParentOrgUnitOf.getID().toString())\n+                                          .contentType(MediaType.parseMediaType\n+                                              (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                   .TEXT_URI_LIST_VALUE))\n+                                          .content(\n+                                              \"https://localhost:8080/server/api/core/items/\" + orgUnit1\n+                                                  .getID() + \"\\n\" +\n+                                                  \"https://localhost:8080/server/api/core/items\" +\n+                                                  \"/\" + orgUnit2\n+                                                  .getID()))\n+                             .andExpect(status().isCreated());\n+\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccb18daeb03ea19cf7de3b380380b0618c2e7497"}, "originalPosition": 192}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA5NDg3OA==", "bodyText": "This has been updated", "url": "https://github.com/DSpace/DSpace/pull/2746#discussion_r536094878", "createdAt": "2020-12-04T13:21:20Z", "author": {"login": "benbosman"}, "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/RelationshipRestRepositoryIT.java", "diffHunk": "@@ -2482,5 +2500,160 @@ public void putRelationshipWithJson() throws Exception {\n \n     }\n \n+    @Test\n+    public void orgUnitAndOrgUnitRelationshipVirtualMetadataTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n+\n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        MvcResult mvcResult = getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                                                .param(\"relationshipType\",\n+                                                                       isParentOrgUnitOf.getID().toString())\n+                                                                .contentType(MediaType.parseMediaType\n+                                                                    (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                                         .TEXT_URI_LIST_VALUE))\n+                                                                .content(\n+                                                                    \"https://localhost:8080/server/api/core/items/\" + orgUnit1\n+                                                                        .getID() + \"\\n\" +\n+                                                                        \"https://localhost:8080/server/api/core/items\" +\n+                                                                        \"/\" + orgUnit2\n+                                                                        .getID()))\n+                                                   .andExpect(status().isCreated())\n+                                                   .andReturn();\n+\n+\n+        itemService.getMetadata(orgUnit1, \"*\", \"*\", \"*\", \"*\", true);\n+\n+        getClient(adminToken).perform(get(\"/api/core/items/\" + orgUnit1.getID()))\n+                             .andExpect(status().isOk())\n+                             .andExpect(jsonPath(\"$.metadata['relation.isParentOrgUnitOf'][0].value\",\n+                                                 is(String.valueOf(orgUnit2.getID()))));\n+        getClient(adminToken).perform(get(\"/api/core/items/\" + orgUnit2.getID()))\n+                             .andExpect(status().isOk())\n+                             .andExpect(jsonPath(\"$.metadata['relation.isChildOrgUnitOf'][0].value\",\n+                                                 is(String.valueOf(orgUnit1.getID()))));\n+\n+\n+\n+    }\n+\n+    @Test\n+    public void orgUnitFindByLabelParentChildOfCountTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n+\n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                                                .param(\"relationshipType\",\n+                                                                       isParentOrgUnitOf.getID().toString())\n+                                                                .contentType(MediaType.parseMediaType\n+                                                                    (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                                         .TEXT_URI_LIST_VALUE))\n+                                                                .content(\n+                                                                    \"https://localhost:8080/server/api/core/items/\" + orgUnit1\n+                                                                        .getID() + \"\\n\" +\n+                                                                        \"https://localhost:8080/server/api/core/items\" +\n+                                                                        \"/\" + orgUnit2\n+                                                                        .getID()))\n+                                                   .andExpect(status().isCreated());\n+\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                                                .param(\"relationshipType\",\n+                                                                       isParentOrgUnitOf.getID().toString())\n+                                                                .contentType(MediaType.parseMediaType\n+                                                                    (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                                         .TEXT_URI_LIST_VALUE))\n+                                                                .content(\n+                                                                    \"https://localhost:8080/server/api/core/items/\" + orgUnit2\n+                                                                        .getID() + \"\\n\" +\n+                                                                        \"https://localhost:8080/server/api/core/items\" +\n+                                                                        \"/\" + orgUnit3\n+                                                                        .getID()))\n+                                                   .andExpect(status().isCreated());\n+\n+        getClient().perform(get(\"/api/core/relationships/search/byLabel\")\n+                                .param(\"label\", \"isChildOrgUnitOf\")\n+                                .param(\"dso\", String.valueOf(orgUnit2.getID()))\n+                                .param(\"page\", \"0\")\n+                                .param(\"size\", \"1\"))\n+                    .andExpect(status().isOk())\n+                    .andExpect(jsonPath(\"$.page\", PageMatcher.pageEntryWithTotalPagesAndElements(0, 1, 1, 1)));\n+\n+\n+    }\n+\n+\n+    @Test\n+    public void orgUnitLeftMaxCardinalityTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        EntityType orgUnit = entityTypeService.findByEntityType(context, \"OrgUnit\");\n+        RelationshipType isParentOrgUnitOf = relationshipTypeService\n+            .findbyTypesAndTypeName(context, orgUnit, orgUnit, \"isParentOrgUnitOf\", \"isChildOrgUnitOf\");\n \n+        MetadataSchema metadataSchema = metadataSchemaService.find(context, \"relation\");\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isParentOrgUnitOf\", null, null).build();\n+        MetadataFieldBuilder.createMetadataField(context, metadataSchema, \"isChildOrgUnitOf\", null, null).build();\n+\n+        String adminToken = getAuthToken(admin.getEmail(), password);\n+\n+        context.restoreAuthSystemState();\n+        // Here we create our first Relationship to the Publication to give it a dc.contributor.author virtual\n+        // metadata field.\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")\n+                                          .param(\"relationshipType\",\n+                                                 isParentOrgUnitOf.getID().toString())\n+                                          .contentType(MediaType.parseMediaType\n+                                              (org.springframework.data.rest.webmvc.RestMediaTypes\n+                                                   .TEXT_URI_LIST_VALUE))\n+                                          .content(\n+                                              \"https://localhost:8080/server/api/core/items/\" + orgUnit1\n+                                                  .getID() + \"\\n\" +\n+                                                  \"https://localhost:8080/server/api/core/items\" +\n+                                                  \"/\" + orgUnit2\n+                                                  .getID()))\n+                             .andExpect(status().isCreated());\n+\n+        getClient(adminToken).perform(post(\"/api/core/relationships\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY1NzgzNA=="}, "originalCommit": {"oid": "ccb18daeb03ea19cf7de3b380380b0618c2e7497"}, "originalPosition": 192}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1495, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}