{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4Nzc1OTYz", "number": 2930, "title": "Default Anonymous READ rights for the site object", "bodyText": "References\nAdd references/links to any related issues or PRs. These may include:\n\nFixes GitHub issue\nRelated to PR where this was first noticed\n\nDescription\nThis PR adds in a general Anonymous read rights resource policy for the Site object.\nThis is required for the different Authorization calls that can be done through the REST api.\nSince REST uses an explicit check through the PreAuthorize for example, if a site does not have this resource policy, it would be considered NOT to be authorized for the current user.\nInstructions for Reviewers\nThe rights weren't able to be added in flyway as the Site object and Group objects get created after the migrations have ran.\nThis means that it\u2019s impossible to add resourcePolicies for those in flyway because no objects are present to create this object on.\nTo handle this, we updated the SiteServiceInitializer that is also responsible for the actual site object creation. Similar to the site creation, this is also done only once.\nAdditional tests were created to make sure that the Site object has anonymous read rights as well\nChecklist\nThis checklist provides a reminder of what we are going to look for when reviewing your PR. You need not complete this checklist prior to creating your PR (draft PRs are always welcome). If you are unsure about an item in the checklist, don't hesitate to ask. We're here to help!\n\n My PR is small in size (e.g. less than 1,000 lines of code, not including comments & integration tests). Exceptions may be made if previously agreed upon.\n My PR passes Checkstyle validation based on the Code Style Guide.\n My PR includes Javadoc for all new (or modified) public methods and classes. It also includes Javadoc for large or complex private methods.\n My PR passes all tests and includes new/updated Unit or Integration Tests based on the Code Testing Guide.\n If my PR includes new, third-party dependencies (in any pom.xml), I've made sure their licenses align with the DSpace BSD License based on the Licensing of Contributions documentation.\n If my PR modifies the REST API, I've linked to the REST Contract page (or open PR) related to this change.", "createdAt": "2020-08-17T11:38:24Z", "url": "https://github.com/DSpace/DSpace/pull/2930", "merged": true, "mergeCommit": {"oid": "74f88197c2f354e237395d12ec2aca38a378610e"}, "closed": true, "closedAt": "2020-09-17T16:28:38Z", "author": {"login": "jonas-atmire"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-yu4lgH2gAyNDY4Nzc1OTYzOjYzY2EwMDdkYzJmODhkNGZhOGY3OTQ2MmQ0ODkxYTBmYjg1NzYxMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJNmyQgFqTQ4OTAzNTUwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "63ca007dc2f88d4fa8f79462d4891a0fb8576133", "author": {"user": {"login": "Raf-atmire", "name": null}}, "url": "https://github.com/DSpace/DSpace/commit/63ca007dc2f88d4fa8f79462d4891a0fb8576133", "committedDate": "2020-08-14T11:15:51Z", "message": "[Task 72503] added the default Anon READ policy for the site object"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3ODg0OTY3", "url": "https://github.com/DSpace/DSpace/pull/2930#pullrequestreview-477884967", "createdAt": "2020-08-28T16:55:11Z", "commit": {"oid": "63ca007dc2f88d4fa8f79462d4891a0fb8576133"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNjo1NToxMVrOHJNxMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNjo1NToxMVrOHJNxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQyNDgxOA==", "bodyText": "I think we are going to want to have a way to call this same logic via a (new) Flyway Java Migration.  Where this code is right now, it is in a Flyway Callback...and this callback only gets run after a new migration runs.  This means that, for example, on my local DSpace 7 installation, I cannot get this logic to trigger...as I'm already up to date on my migrations.\nThis same issue will appear on the DSpace 7 demo site if deployed there. It won't ever trigger this logic until a new FlywayMigration is created.\nSo, I think you'll likely need to move this logic into a public method, and then create a new Java-based migration (see examples in org.dspace.storage.rdbms.migration) which calls this method.  That way it'll be guaranteed to be triggered immediately, instead of waiting until the database needs to run a new migration.", "url": "https://github.com/DSpace/DSpace/pull/2930#discussion_r479424818", "createdAt": "2020-08-28T16:55:11Z", "author": {"login": "tdonohue"}, "path": "dspace-api/src/main/java/org/dspace/storage/rdbms/SiteServiceInitializer.java", "diffHunk": "@@ -37,10 +48,19 @@ public void initializeSiteObject() {\n             context.turnOffAuthorisationSystem();\n             // While it's not really a formal \"registry\", we need to ensure the\n             // default, required Groups exist in the DSpace database\n+            Site site = null;\n             if (siteService.findSite(context) == null) {\n-                siteService.createSite(context);\n+                site = siteService.createSite(context);\n             }\n             context.restoreAuthSystemState();\n+            if (!authorizeService.authorizeActionBoolean(context, site, Constants.READ)) {\n+                context.turnOffAuthorisationSystem();\n+                Group anonGroup = groupService.findByName(context, Group.ANONYMOUS);\n+                if (anonGroup != null) {\n+                    authorizeService.addPolicy(context, site, Constants.READ, anonGroup);\n+                }\n+                context.restoreAuthSystemState();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63ca007dc2f88d4fa8f79462d4891a0fb8576133"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MDM1NTAz", "url": "https://github.com/DSpace/DSpace/pull/2930#pullrequestreview-489035503", "createdAt": "2020-09-15T20:13:41Z", "commit": {"oid": "63ca007dc2f88d4fa8f79462d4891a0fb8576133"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1316, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}