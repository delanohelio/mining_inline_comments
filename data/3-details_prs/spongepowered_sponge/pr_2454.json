{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4NzY5NzEw", "number": 2454, "title": "Implement SerializationBehaviors.NONE and SerializationBehaviors.METADATA_ONLY.", "bodyText": "SpongeAPI | SpongeCommon | SpongeForge\nFor test code, use the existing MultiWorldTest plugin - the world folders should not appear.\nFixes #2291.", "createdAt": "2020-01-02T19:39:19Z", "url": "https://github.com/SpongePowered/Sponge/pull/2454", "merged": true, "mergeCommit": {"oid": "8e075aed12ced32015284d35bb8b1c8ec3f21298"}, "closed": true, "closedAt": "2020-05-31T22:12:08Z", "author": {"login": "JBYoshi"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3bm_FgFqTMzODQxMzkzMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcl0ijUgH2gAyMzU4NzY5NzEwOjEzMzJjNDI5ODQ5OTAzNDlmMzc4MTI5ZmQxNWU0NWMxYTA4ZjZjZDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDEzOTMy", "url": "https://github.com/SpongePowered/Sponge/pull/2454#pullrequestreview-338413932", "createdAt": "2020-01-05T18:10:46Z", "commit": {"oid": "a65d7632a0af47b40d95d4824a3ebe96c5d5b532"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQxODoxMDo0N1rOFaSYfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQxODoxMDo0N1rOFaSYfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEwODQ3OQ==", "bodyText": "this.", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r363108479", "createdAt": "2020-01-05T18:10:47Z", "author": {"login": "Zidane"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/storage/SaveHandlerMixin.java", "diffHunk": "@@ -70,9 +77,45 @@\n \n     @Shadow @Final private File worldDirectory;\n \n+    @Shadow protected abstract void setSessionLock();\n+\n     @Nullable private Exception impl$capturedException;\n     // player join stuff\n     @Nullable private Path impl$file;\n+    private Set<File> impl$directoriesToCreate = new HashSet<>();\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n+    private boolean impl$mkdirs(File dir) {\n+        if (WorldManager.NO_FILE_CREATION) {\n+            impl$directoriesToCreate.add(dir);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a65d7632a0af47b40d95d4824a3ebe96c5d5b532"}, "originalPosition": 48}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a65d7632a0af47b40d95d4824a3ebe96c5d5b532", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/a65d7632a0af47b40d95d4824a3ebe96c5d5b532", "committedDate": "2020-01-02T19:34:29Z", "message": "Don't create world files when using SerializationBehaviors.NONE.\n\nFixes #2291."}, "afterCommit": {"oid": "d4b9819248b7a26862f2aff8b1558001a8a0ea23", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/d4b9819248b7a26862f2aff8b1558001a8a0ea23", "committedDate": "2020-02-02T04:00:57Z", "message": "Implement METADATA_ONLY and fix a few bugs."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MzQ2Nzcx", "url": "https://github.com/SpongePowered/Sponge/pull/2454#pullrequestreview-359346771", "createdAt": "2020-02-15T13:59:35Z", "commit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQxMzo1OTozNlrOFqPLLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQxMzo1OTozNlrOFqPLLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMzEzMw==", "bodyText": "I don't like that this is an overwrite, to be honest, but I see why you've done it.\n@Zidane Should we prefer head injection and cancel in this case? I know you've done that in the past. Could also replace with a Redirect followed by a cancellable injection - but that then wanders into LVT land.", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r379833133", "createdAt": "2020-02-15T13:59:36Z", "author": {"login": "dualspiral"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/chunk/storage/RegionFileCacheMixin.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * This file is part of Sponge, licensed under the MIT License (MIT).\n+ *\n+ * Copyright (c) SpongePowered <https://www.spongepowered.org>\n+ * Copyright (c) contributors\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.spongepowered.common.mixin.core.world.chunk.storage;\n+\n+import net.minecraft.world.chunk.storage.RegionFile;\n+import net.minecraft.world.chunk.storage.RegionFileCache;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Overwrite;\n+import org.spongepowered.asm.mixin.Shadow;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+\n+import java.io.DataInputStream;\n+import java.io.File;\n+\n+@Mixin(RegionFileCache.class)\n+public abstract class RegionFileCacheMixin {\n+\n+    @Shadow public static RegionFile getRegionFileIfExists(File worldDir, int chunkX, int chunkZ) {return null;}\n+\n+    /**\n+     * @author JBYoshi\n+     * @reason Support for ChunkSerializationBehaviors that don't save chunks:\n+     * don't create files if they aren't necessary. (The original method\n+     * already returns null if the chunk doesn't exist.)\n+     */\n+    @Overwrite\n+    public static DataInputStream getChunkInputStream(File worldDir, int chunkX, int chunkZ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzk4MTE4", "url": "https://github.com/SpongePowered/Sponge/pull/2454#pullrequestreview-362398118", "createdAt": "2020-02-21T04:50:55Z", "commit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNDo1MDo1NVrOFsrnfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNDo1MDo1NVrOFsrnfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5NjI4NQ==", "bodyText": "s/listFiles/impl$listFilesIfDirectoryExists", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382396285", "createdAt": "2020-02-21T04:50:55Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/advancements/AdvancementManagerMixin.java", "diffHunk": "@@ -24,19 +24,40 @@\n  */\n package org.spongepowered.common.mixin.core.advancements;\n \n+import com.google.common.collect.ImmutableSet;\n import net.minecraft.advancements.AdvancementManager;\n+import org.apache.commons.io.FileUtils;\n import org.spongepowered.asm.mixin.Mixin;\n import org.spongepowered.asm.mixin.injection.At;\n import org.spongepowered.asm.mixin.injection.Inject;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;\n import org.spongepowered.common.SpongeImpl;\n import org.spongepowered.common.bridge.server.management.PlayerListBridge;\n+import org.spongepowered.common.world.WorldManager;\n+\n+import java.io.File;\n+import java.util.Collection;\n \n @Mixin(AdvancementManager.class)\n public class AdvancementManagerMixin {\n \n+    @Redirect(method = \"loadCustomAdvancements\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n+    private boolean impl$createDirectory(File dir) {\n+        return WorldManager.mkdirsIfSaveable(dir);\n+    }\n+\n     @Inject(method = \"reload\", at = @At(\"RETURN\"))\n     private void impl$reloadAdvancementProgressforPlayerList(final CallbackInfo ci) {\n         ((PlayerListBridge) SpongeImpl.getServer().getPlayerList()).bridge$reloadAdvancementProgress();\n     }\n+\n+    @Redirect(method = \"loadCustomAdvancements\", at = @At(value = \"INVOKE\",\n+            target = \"Lorg/apache/commons/io/FileUtils;listFiles(Ljava/io/File;[Ljava/lang/String;Z)Ljava/util/Collection;\", remap = false))\n+    private Collection<File> listFiles(File directory, String[] extensions, boolean recursive) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzk4MTgx", "url": "https://github.com/SpongePowered/Sponge/pull/2454#pullrequestreview-362398181", "createdAt": "2020-02-21T04:51:17Z", "commit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNDo1MToxN1rOFsrnrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNDo1MToxN1rOFsrnrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5NjMzNQ==", "bodyText": "Same here", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382396335", "createdAt": "2020-02-21T04:51:17Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/advancements/FunctionManagerMixin.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * This file is part of Sponge, licensed under the MIT License (MIT).\n+ *\n+ * Copyright (c) SpongePowered <https://www.spongepowered.org>\n+ * Copyright (c) contributors\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.spongepowered.common.mixin.core.advancements;\n+\n+import com.google.common.collect.ImmutableSet;\n+import net.minecraft.advancements.FunctionManager;\n+import org.apache.commons.io.FileUtils;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.Inject;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;\n+import org.spongepowered.common.SpongeImpl;\n+import org.spongepowered.common.bridge.server.management.PlayerListBridge;\n+import org.spongepowered.common.world.WorldManager;\n+\n+import java.io.File;\n+import java.util.Collection;\n+\n+@Mixin(FunctionManager.class)\n+public abstract class FunctionManagerMixin {\n+    @Redirect(method = \"loadFunctions\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n+    private boolean impl$createDirectory(File dir) {\n+        return WorldManager.mkdirsIfSaveable(dir);\n+    }\n+\n+    @Redirect(method = \"loadFunctions\", at = @At(value = \"INVOKE\",\n+            target = \"Lorg/apache/commons/io/FileUtils;listFiles(Ljava/io/File;[Ljava/lang/String;Z)Ljava/util/Collection;\", remap = false))\n+    private Collection<File> listFiles(File directory, String[] extensions, boolean recursive) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzk4Njc2", "url": "https://github.com/SpongePowered/Sponge/pull/2454#pullrequestreview-362398676", "createdAt": "2020-02-21T04:53:09Z", "commit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNDo1MzowOVrOFsrpXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNDo1MzowOVrOFsrpXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5Njc2NQ==", "bodyText": "prefix with shadow$ ( I get that this is in maintenance, and api-8 branch is moving towards prefixing shadows always, but I'd like to keep it in line here as well).", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382396765", "createdAt": "2020-02-21T04:53:09Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/gen/ChunkProviderServerMixin.java", "diffHunk": "@@ -92,6 +93,8 @@\n     @Shadow protected abstract void saveChunkExtraData(Chunk chunkIn);\n     @Shadow protected abstract void saveChunkData(Chunk chunkIn);\n \n+    @Shadow public abstract boolean canSave();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzk4ODI0", "url": "https://github.com/SpongePowered/Sponge/pull/2454#pullrequestreview-362398824", "createdAt": "2020-02-21T04:53:43Z", "commit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNDo1Mzo0M1rOFsrp5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNTowMTozN1rOFsrwHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5NjkwMg==", "bodyText": "variable can be final.", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382396902", "createdAt": "2020-02-21T04:53:43Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/gen/ChunkProviderServerMixin.java", "diffHunk": "@@ -250,7 +253,14 @@ public void queueUnload(final Chunk chunkIn)\n     @Overwrite\n     public boolean tick()\n     {\n-        if (!this.world.disableLevelSaving && !((WorldBridge) this.world).bridge$isFake())\n+        // Sponge start\n+        SerializationBehavior serializationBehavior = ((WorldProperties) this.world.getWorldInfo()).getSerializationBehavior();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5NzA0Mg==", "bodyText": "method name needs to reflect what it's actually doing. impl$checkSerializationBehaviorForCanSave or something", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382397042", "createdAt": "2020-02-21T04:54:31Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/gen/ChunkProviderServerMixin.java", "diffHunk": "@@ -325,4 +335,20 @@ public boolean tick()\n         this.loadedChunks.remove(ChunkPos.asLong(chunk.x, chunk.z));\n         ((ChunkBridge) chunk).bridge$setScheduledForUnload(-1);\n     }\n+\n+    // This still returns true for METADATA_ONLY because other places (e.g. WorldServer) use it.\n+    @Inject(method = \"canSave\", at = @At(\"HEAD\"), cancellable = true)\n+    public void onCanSave(CallbackInfoReturnable<Boolean> cir) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5NzA2Mg==", "bodyText": "Same here", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382397062", "createdAt": "2020-02-21T04:54:38Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/gen/ChunkProviderServerMixin.java", "diffHunk": "@@ -325,4 +335,20 @@ public boolean tick()\n         this.loadedChunks.remove(ChunkPos.asLong(chunk.x, chunk.z));\n         ((ChunkBridge) chunk).bridge$setScheduledForUnload(-1);\n     }\n+\n+    // This still returns true for METADATA_ONLY because other places (e.g. WorldServer) use it.\n+    @Inject(method = \"canSave\", at = @At(\"HEAD\"), cancellable = true)\n+    public void onCanSave(CallbackInfoReturnable<Boolean> cir) {\n+        if (((WorldProperties) this.world.getWorldInfo()).getSerializationBehavior() == SerializationBehaviors.NONE) {\n+            cir.setReturnValue(false);\n+        }\n+    }\n+\n+    @Inject(method = \"saveChunks\", at = @At(\"HEAD\"), cancellable = true)\n+    public void onSaveChunks(CallbackInfoReturnable<Boolean> cir) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5NzA5Mg==", "bodyText": "Prefix with shadow$", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382397092", "createdAt": "2020-02-21T04:54:48Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/storage/SaveHandlerMixin.java", "diffHunk": "@@ -70,9 +77,45 @@\n \n     @Shadow @Final private File worldDirectory;\n \n+    @Shadow protected abstract void setSessionLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5NzIyMA==", "bodyText": "mkdirs should be actually named what we're doing on top of making directories.", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382397220", "createdAt": "2020-02-21T04:55:27Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/storage/SaveHandlerMixin.java", "diffHunk": "@@ -70,9 +77,45 @@\n \n     @Shadow @Final private File worldDirectory;\n \n+    @Shadow protected abstract void setSessionLock();\n+\n     @Nullable private Exception impl$capturedException;\n     // player join stuff\n     @Nullable private Path impl$file;\n+    private Set<File> impl$directoriesToCreate = new HashSet<>();\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n+    private boolean impl$mkdirs(File dir) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5NzM3OA==", "bodyText": "change onCheckSessionLock to actually mean what this method is doing.", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382397378", "createdAt": "2020-02-21T04:56:04Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/storage/SaveHandlerMixin.java", "diffHunk": "@@ -70,9 +77,45 @@\n \n     @Shadow @Final private File worldDirectory;\n \n+    @Shadow protected abstract void setSessionLock();\n+\n     @Nullable private Exception impl$capturedException;\n     // player join stuff\n     @Nullable private Path impl$file;\n+    private Set<File> impl$directoriesToCreate = new HashSet<>();\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n+    private boolean impl$mkdirs(File dir) {\n+        if (WorldManager.NO_FILE_CREATION) {\n+            impl$directoriesToCreate.add(dir);\n+            return false;\n+        }\n+        return dir.mkdirs();\n+    }\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Lnet/minecraft/world/storage/SaveHandler;setSessionLock()V\"))\n+    private void impl$onSetSessionLock(SaveHandler self) {\n+        if (!WorldManager.NO_FILE_CREATION) {\n+            this.setSessionLock();\n+        }\n+    }\n+\n+    @Redirect(method = \"checkSessionLock\",\n+        at = @At(value = \"NEW\", target = \"java/io/FileInputStream\", remap = false))\n+    private FileInputStream impl$onCheckSessionLock(File file) throws FileNotFoundException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5NzYyMA==", "bodyText": "I really don't like this sort of static flag flip and check. Is it possible to add this check through an IPhaseState.allowsFileCreation() method and switching in?", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382397620", "createdAt": "2020-02-21T04:57:16Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/world/WorldManager.java", "diffHunk": "@@ -432,7 +436,14 @@ public static WorldProperties createWorldProperties(final String folderName, fin\n             return optWorldProperties.get();\n         }\n \n-        final ISaveHandler saveHandler = new AnvilSaveHandler(WorldManager.getCurrentSavesDirectory().get().toFile(), folderName, true, ((MinecraftServerAccessor) SpongeImpl.getServer()).accessor$getDataFixer());\n+        NO_FILE_CREATION = archetype.getSerializationBehavior() == SerializationBehaviors.NONE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5Nzc3OA==", "bodyText": "Same with here.. Especially since later you do a try block with finally. It screams that the state should be switching in.", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382397778", "createdAt": "2020-02-21T04:58:02Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/world/WorldManager.java", "diffHunk": "@@ -623,12 +636,19 @@ public static void saveWorld(final WorldServer worldServer, final boolean flush)\n         }\n \n         final Path worldFolder = currentSavesDir.resolve(worldName);\n-        if (!Files.isDirectory(worldFolder)) {\n+        if (!Files.isDirectory(worldFolder) && properties.getSerializationBehavior() != SerializationBehaviors.NONE) {\n             SpongeImpl.getLogger().error(\"Unable to load world [{}]. We cannot find its folder under [{}].\", worldFolder, currentSavesDir);\n             return Optional.empty();\n         }\n \n-        final ISaveHandler saveHandler = new AnvilSaveHandler(currentSavesDir.toFile(), worldName, true, ((MinecraftServerAccessor) SpongeImpl.getServer()).accessor$getDataFixer());\n+        NO_FILE_CREATION = properties.getSerializationBehavior() == SerializationBehaviors.NONE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5NzkxNA==", "bodyText": "Does this method have to be public?", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382397914", "createdAt": "2020-02-21T04:58:42Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/world/WorldManager.java", "diffHunk": "@@ -893,6 +911,39 @@ private static WorldServer createWorldFromProperties(\n         }\n     }\n \n+    public static boolean mkdirsIfSaveable(File dir) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5ODAzNA==", "bodyText": "If you do end up making this a PhaseTracker.getCurrentState().allowsFileCreation() check, is there a case where this should be checked for threadedness?", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382398034", "createdAt": "2020-02-21T04:59:17Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/world/WorldManager.java", "diffHunk": "@@ -893,6 +911,39 @@ private static WorldServer createWorldFromProperties(\n         }\n     }\n \n+    public static boolean mkdirsIfSaveable(File dir) {\n+        if (NO_FILE_CREATION) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5ODA3MA==", "bodyText": "Variable should be final", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382398070", "createdAt": "2020-02-21T04:59:31Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/world/WorldManager.java", "diffHunk": "@@ -1299,8 +1350,8 @@ public static NBTTagCompound saveDimensionDataMap() {\n         if (optWorldServer.isPresent()) {\n             return Optional.of(optWorldServer.get().getSaveHandler().getWorldDirectory().toPath());\n         } else if (SpongeImpl.getGame().getState().ordinal() >= GameState.SERVER_ABOUT_TO_START.ordinal()) {\n-            final SaveHandler saveHandler = (SaveHandler) SpongeImpl.getServer().getActiveAnvilConverter().getSaveLoader(SpongeImpl.getServer().getFolderName(), false);\n-            return Optional.of(saveHandler.getWorldDirectory().toPath());\n+            MinecraftServer server = SpongeImpl.getServer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5ODE5Mw==", "bodyText": "Pull out the Sponge.getServer() as a local variable at this point with how many times it's being called.", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382398193", "createdAt": "2020-02-21T05:00:08Z", "author": {"login": "gabizou"}, "path": "testplugins/src/main/java/org/spongepowered/test/MultiWorldTest.java", "diffHunk": "@@ -40,22 +40,38 @@\n \n     @Override\n     public void disable(CommandSource src) {\n-        Sponge.getServer().getWorld(\"temp\").ifPresent(world -> Sponge.getServer().unloadWorld(world));\n+        Sponge.getServer().getWorld(\"no-save\").ifPresent(world -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5ODI0Mw==", "bodyText": "Why the change?", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382398243", "createdAt": "2020-02-21T05:00:27Z", "author": {"login": "gabizou"}, "path": "testplugins/src/main/java/org/spongepowered/test/MultiWorldTest.java", "diffHunk": "@@ -40,22 +40,38 @@\n \n     @Override\n     public void disable(CommandSource src) {\n-        Sponge.getServer().getWorld(\"temp\").ifPresent(world -> Sponge.getServer().unloadWorld(world));\n+        Sponge.getServer().getWorld(\"no-save\").ifPresent(world -> {\n+            Sponge.getServer().unloadWorld(world);\n+            Sponge.getServer().deleteWorld(world.getProperties());\n+        });\n+        Sponge.getServer().getWorld(\"metadata-only\").ifPresent(world -> {\n+            Sponge.getServer().unloadWorld(world);\n+            Sponge.getServer().deleteWorld(world.getProperties());\n+        });\n     }\n \n     @Override\n     public void enable(CommandSource src) {\n         try {\n-            final WorldArchetype archetype = Sponge.getRegistry().getType(WorldArchetype.class, \"multi-world-test:overnether\").orElse(\n+            final WorldArchetype archetype1 = Sponge.getRegistry().getType(WorldArchetype.class, \"multi-world-test:overnether\").orElseGet(() ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5ODQ5NQ==", "bodyText": "Should be explicit with the types here for variable names, if there's an \"original\" and \"re-generated\" or \"nonSerializedArchetype\" make it so, otherwise this looks like obfuscated smurf naming..", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r382398495", "createdAt": "2020-02-21T05:01:37Z", "author": {"login": "gabizou"}, "path": "testplugins/src/main/java/org/spongepowered/test/MultiWorldTest.java", "diffHunk": "@@ -40,22 +40,38 @@\n \n     @Override\n     public void disable(CommandSource src) {\n-        Sponge.getServer().getWorld(\"temp\").ifPresent(world -> Sponge.getServer().unloadWorld(world));\n+        Sponge.getServer().getWorld(\"no-save\").ifPresent(world -> {\n+            Sponge.getServer().unloadWorld(world);\n+            Sponge.getServer().deleteWorld(world.getProperties());\n+        });\n+        Sponge.getServer().getWorld(\"metadata-only\").ifPresent(world -> {\n+            Sponge.getServer().unloadWorld(world);\n+            Sponge.getServer().deleteWorld(world.getProperties());\n+        });\n     }\n \n     @Override\n     public void enable(CommandSource src) {\n         try {\n-            final WorldArchetype archetype = Sponge.getRegistry().getType(WorldArchetype.class, \"multi-world-test:overnether\").orElse(\n+            final WorldArchetype archetype1 = Sponge.getRegistry().getType(WorldArchetype.class, \"multi-world-test:overnether\").orElseGet(() ->\n                 WorldArchetype.builder().\n                     from(WorldArchetypes.THE_NETHER)\n                     .serializationBehavior(SerializationBehaviors.NONE)\n                     .generator(GeneratorTypes.OVERWORLD)\n                     .build(\"multi-world-test:overnether\", \"Overnether\")\n             );\n-            final WorldProperties worldProperties = Sponge.getServer().createWorldProperties(\"temp\", archetype);\n+            final WorldProperties world1 = Sponge.getServer().createWorldProperties(\"no-save\", archetype1);\n+            Sponge.getServer().loadWorld(world1);\n \n-            Sponge.getServer().loadWorld(worldProperties);\n+            final WorldArchetype archetype2 = Sponge.getRegistry().getType(WorldArchetype.class, \"multi-world-test:overend\").orElseGet(() ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/3e535caf428760e2cb428fe2e2386cf1df4e243f", "committedDate": "2020-05-05T03:14:26Z", "message": "Implement SerializationBehaviors.NONE and .METADATA_ONLY.\n\nFixes #2291."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a61b311dcf88bb0dbe764d955acce6e4817cf3e", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/1a61b311dcf88bb0dbe764d955acce6e4817cf3e", "committedDate": "2020-03-24T00:56:25Z", "message": "Add additional comments to RegionFileCacheMixin."}, "afterCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/3e535caf428760e2cb428fe2e2386cf1df4e243f", "committedDate": "2020-05-05T03:14:26Z", "message": "Implement SerializationBehaviors.NONE and .METADATA_ONLY.\n\nFixes #2291."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NzcyOTMw", "url": "https://github.com/SpongePowered/Sponge/pull/2454#pullrequestreview-409772930", "createdAt": "2020-05-12T07:34:32Z", "commit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNzozNDozMlrOGT5www==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNzo0MToyNFrOGT5_iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyMjQ5OQ==", "bodyText": "Can this potentially be pooled?", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423522499", "createdAt": "2020-05-12T07:34:32Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/event/tracking/phase/general/SaveHandlerCreationPhase.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * This file is part of Sponge, licensed under the MIT License (MIT).\n+ *\n+ * Copyright (c) SpongePowered <https://www.spongepowered.org>\n+ * Copyright (c) contributors\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.spongepowered.common.event.tracking.phase.general;\n+\n+public class SaveHandlerCreationPhase extends GeneralState<SaveHandlerCreationContext> {\n+\n+    @Override\n+    protected SaveHandlerCreationContext createNewContext() {\n+        return new SaveHandlerCreationContext(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyMjg0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Redirect(method = \"loadCustomAdvancements\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n          \n          \n            \n                @Redirect(method = \"loadCustomAdvancements\",\n          \n          \n            \n                      at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false)\n          \n          \n            \n                )", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423522847", "createdAt": "2020-05-12T07:35:11Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/advancements/AdvancementManagerMixin.java", "diffHunk": "@@ -24,19 +24,40 @@\n  */\n package org.spongepowered.common.mixin.core.advancements;\n \n+import com.google.common.collect.ImmutableSet;\n import net.minecraft.advancements.AdvancementManager;\n+import org.apache.commons.io.FileUtils;\n import org.spongepowered.asm.mixin.Mixin;\n import org.spongepowered.asm.mixin.injection.At;\n import org.spongepowered.asm.mixin.injection.Inject;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;\n import org.spongepowered.common.SpongeImpl;\n import org.spongepowered.common.bridge.server.management.PlayerListBridge;\n+import org.spongepowered.common.world.WorldManager;\n+\n+import java.io.File;\n+import java.util.Collection;\n \n @Mixin(AdvancementManager.class)\n public class AdvancementManagerMixin {\n \n+    @Redirect(method = \"loadCustomAdvancements\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyMzgxMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Redirect(method = \"loadCustomAdvancements\", at = @At(value = \"INVOKE\",\n          \n          \n            \n                        target = \"Lorg/apache/commons/io/FileUtils;listFiles(Ljava/io/File;[Ljava/lang/String;Z)Ljava/util/Collection;\", remap = false))\n          \n          \n            \n                @Redirect(method = \"loadCustomAdvancements\", \n          \n          \n            \n                    at = @At(value = \"INVOKE\",\n          \n          \n            \n                         target = \"Lorg/apache/commons/io/FileUtils;listFiles(Ljava/io/File;[Ljava/lang/String;Z)Ljava/util/Collection;\",\n          \n          \n            \n                         remap = false\n          \n          \n            \n                    )\n          \n          \n            \n                )", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423523810", "createdAt": "2020-05-12T07:36:53Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/advancements/AdvancementManagerMixin.java", "diffHunk": "@@ -24,19 +24,40 @@\n  */\n package org.spongepowered.common.mixin.core.advancements;\n \n+import com.google.common.collect.ImmutableSet;\n import net.minecraft.advancements.AdvancementManager;\n+import org.apache.commons.io.FileUtils;\n import org.spongepowered.asm.mixin.Mixin;\n import org.spongepowered.asm.mixin.injection.At;\n import org.spongepowered.asm.mixin.injection.Inject;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;\n import org.spongepowered.common.SpongeImpl;\n import org.spongepowered.common.bridge.server.management.PlayerListBridge;\n+import org.spongepowered.common.world.WorldManager;\n+\n+import java.io.File;\n+import java.util.Collection;\n \n @Mixin(AdvancementManager.class)\n public class AdvancementManagerMixin {\n \n+    @Redirect(method = \"loadCustomAdvancements\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n+    private boolean impl$createDirectory(File dir) {\n+        return WorldManager.mkdirsIfSaveable(dir);\n+    }\n+\n     @Inject(method = \"reload\", at = @At(\"RETURN\"))\n     private void impl$reloadAdvancementProgressforPlayerList(final CallbackInfo ci) {\n         ((PlayerListBridge) SpongeImpl.getServer().getPlayerList()).bridge$reloadAdvancementProgress();\n     }\n+\n+    @Redirect(method = \"loadCustomAdvancements\", at = @At(value = \"INVOKE\",\n+            target = \"Lorg/apache/commons/io/FileUtils;listFiles(Ljava/io/File;[Ljava/lang/String;Z)Ljava/util/Collection;\", remap = false))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNDA2Mw==", "bodyText": "indentation", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423524063", "createdAt": "2020-05-12T07:37:24Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/advancements/FunctionManagerMixin.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * This file is part of Sponge, licensed under the MIT License (MIT).\n+ *\n+ * Copyright (c) SpongePowered <https://www.spongepowered.org>\n+ * Copyright (c) contributors\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.spongepowered.common.mixin.core.advancements;\n+\n+import com.google.common.collect.ImmutableSet;\n+import net.minecraft.advancements.FunctionManager;\n+import org.apache.commons.io.FileUtils;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.Inject;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;\n+import org.spongepowered.common.SpongeImpl;\n+import org.spongepowered.common.bridge.server.management.PlayerListBridge;\n+import org.spongepowered.common.world.WorldManager;\n+\n+import java.io.File;\n+import java.util.Collection;\n+\n+@Mixin(FunctionManager.class)\n+public abstract class FunctionManagerMixin {\n+    @Redirect(method = \"loadFunctions\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n+    private boolean impl$createDirectory(File dir) {\n+        return WorldManager.mkdirsIfSaveable(dir);\n+    }\n+\n+    @Redirect(method = \"loadFunctions\", at = @At(value = \"INVOKE\",\n+            target = \"Lorg/apache/commons/io/FileUtils;listFiles(Ljava/io/File;[Ljava/lang/String;Z)Ljava/util/Collection;\", remap = false))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNDM0OA==", "bodyText": "I'd say the overwrite is fine.", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423524348", "createdAt": "2020-05-12T07:37:55Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/chunk/storage/RegionFileCacheMixin.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * This file is part of Sponge, licensed under the MIT License (MIT).\n+ *\n+ * Copyright (c) SpongePowered <https://www.spongepowered.org>\n+ * Copyright (c) contributors\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.spongepowered.common.mixin.core.world.chunk.storage;\n+\n+import net.minecraft.world.chunk.storage.RegionFile;\n+import net.minecraft.world.chunk.storage.RegionFileCache;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Overwrite;\n+import org.spongepowered.asm.mixin.Shadow;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+\n+import java.io.DataInputStream;\n+import java.io.File;\n+\n+@Mixin(RegionFileCache.class)\n+public abstract class RegionFileCacheMixin {\n+\n+    @Shadow public static RegionFile getRegionFileIfExists(File worldDir, int chunkX, int chunkZ) {return null;}\n+\n+    /**\n+     * @author JBYoshi\n+     * @reason Support for ChunkSerializationBehaviors that don't save chunks:\n+     * don't create files if they aren't necessary. (The original method\n+     * already returns null if the chunk doesn't exist.)\n+     */\n+    @Overwrite\n+    public static DataInputStream getChunkInputStream(File worldDir, int chunkX, int chunkZ) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgzMzEzMw=="}, "originalCommit": {"oid": "d05bf2390c934dc21d9ea74696fd3240a8ea1e77"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNDQ4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @author JBYoshi\n          \n          \n            \n                 * @author JBYoshi - February xx, 2020 - Minecraft 1.12.2", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423524489", "createdAt": "2020-05-12T07:38:11Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/chunk/storage/RegionFileCacheMixin.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * This file is part of Sponge, licensed under the MIT License (MIT).\n+ *\n+ * Copyright (c) SpongePowered <https://www.spongepowered.org>\n+ * Copyright (c) contributors\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.spongepowered.common.mixin.core.world.chunk.storage;\n+\n+import net.minecraft.world.chunk.storage.RegionFile;\n+import net.minecraft.world.chunk.storage.RegionFileCache;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Overwrite;\n+import org.spongepowered.asm.mixin.Shadow;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+\n+import java.io.DataInputStream;\n+import java.io.File;\n+\n+@Mixin(RegionFileCache.class)\n+public abstract class RegionFileCacheMixin {\n+\n+    @Shadow public static RegionFile getRegionFileIfExists(File worldDir, int chunkX, int chunkZ) {return null;}\n+\n+    /**\n+     * @author JBYoshi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNDYwMg==", "bodyText": "empty line.", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423524602", "createdAt": "2020-05-12T07:38:24Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/gen/ChunkProviderServerMixin.java", "diffHunk": "@@ -92,6 +93,8 @@\n     @Shadow protected abstract void saveChunkExtraData(Chunk chunkIn);\n     @Shadow protected abstract void saveChunkData(Chunk chunkIn);\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNDg1OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final SerializationBehavior serializationBehavior = ((WorldProperties) this.world.getWorldInfo()).getSerializationBehavior();\n          \n          \n            \n                    if (serializationBehavior != SerializationBehaviors.AUTOMATIC) {\n          \n          \n            \n                    final SerializationBehavior behavior = ((WorldProperties) this.world.getWorldInfo()).getSerializationBehavior();\n          \n          \n            \n                    if (behavior != SerializationBehaviors.AUTOMATIC) {", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423524858", "createdAt": "2020-05-12T07:38:53Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/gen/ChunkProviderServerMixin.java", "diffHunk": "@@ -250,7 +253,14 @@ public void queueUnload(final Chunk chunkIn)\n     @Overwrite\n     public boolean tick()\n     {\n-        if (!this.world.disableLevelSaving && !((WorldBridge) this.world).bridge$isFake())\n+        // Sponge start\n+        final SerializationBehavior serializationBehavior = ((WorldProperties) this.world.getWorldInfo()).getSerializationBehavior();\n+        if (serializationBehavior != SerializationBehaviors.AUTOMATIC) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTA2OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    SerializationBehavior serializationBehavior = ((WorldProperties) this.world.getWorldInfo()).getSerializationBehavior();\n          \n          \n            \n                    final SerializationBehavior serializationBehavior = ((WorldProperties) this.world.getWorldInfo()).getSerializationBehavior();", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423525068", "createdAt": "2020-05-12T07:39:20Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/gen/ChunkProviderServerMixin.java", "diffHunk": "@@ -325,4 +335,20 @@ public boolean tick()\n         this.loadedChunks.remove(ChunkPos.asLong(chunk.x, chunk.z));\n         ((ChunkBridge) chunk).bridge$setScheduledForUnload(-1);\n     }\n+\n+    // This still returns true for METADATA_ONLY because other places (e.g. WorldServer) use it.\n+    @Inject(method = \"canSave\", at = @At(\"HEAD\"), cancellable = true)\n+    public void impl$checkSerializationBehaviorForCanSave(CallbackInfoReturnable<Boolean> cir) {\n+        if (((WorldProperties) this.world.getWorldInfo()).getSerializationBehavior() == SerializationBehaviors.NONE) {\n+            cir.setReturnValue(false);\n+        }\n+    }\n+\n+    @Inject(method = \"saveChunks\", at = @At(\"HEAD\"), cancellable = true)\n+    public void impl$checkSerializationBehaviorForSaveChunks(CallbackInfoReturnable<Boolean> cir) {\n+        SerializationBehavior serializationBehavior = ((WorldProperties) this.world.getWorldInfo()).getSerializationBehavior();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTIyOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    SerializationBehavior serializationBehavior = ((WorldProperties) this.world.getWorldInfo()).getSerializationBehavior();\n          \n          \n            \n                    if (serializationBehavior == SerializationBehaviors.NONE || serializationBehavior == SerializationBehaviors.METADATA_ONLY) {\n          \n          \n            \n                    final SerializationBehavior behavior = ((WorldProperties) this.world.getWorldInfo()).getSerializationBehavior();\n          \n          \n            \n                    if (behavior == SerializationBehaviors.NONE || behavior == SerializationBehaviors.METADATA_ONLY) {", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423525229", "createdAt": "2020-05-12T07:39:38Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/gen/ChunkProviderServerMixin.java", "diffHunk": "@@ -325,4 +335,20 @@ public boolean tick()\n         this.loadedChunks.remove(ChunkPos.asLong(chunk.x, chunk.z));\n         ((ChunkBridge) chunk).bridge$setScheduledForUnload(-1);\n     }\n+\n+    // This still returns true for METADATA_ONLY because other places (e.g. WorldServer) use it.\n+    @Inject(method = \"canSave\", at = @At(\"HEAD\"), cancellable = true)\n+    public void impl$checkSerializationBehaviorForCanSave(CallbackInfoReturnable<Boolean> cir) {\n+        if (((WorldProperties) this.world.getWorldInfo()).getSerializationBehavior() == SerializationBehaviors.NONE) {\n+            cir.setReturnValue(false);\n+        }\n+    }\n+\n+    @Inject(method = \"saveChunks\", at = @At(\"HEAD\"), cancellable = true)\n+    public void impl$checkSerializationBehaviorForSaveChunks(CallbackInfoReturnable<Boolean> cir) {\n+        SerializationBehavior serializationBehavior = ((WorldProperties) this.world.getWorldInfo()).getSerializationBehavior();\n+        if (serializationBehavior == SerializationBehaviors.NONE || serializationBehavior == SerializationBehaviors.METADATA_ONLY) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTU0Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    IPhaseState state = PhaseTracker.getInstance().getCurrentState();\n          \n          \n            \n                    final IPhaseState state = PhaseTracker.getInstance().getCurrentState();", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423525546", "createdAt": "2020-05-12T07:40:07Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/storage/SaveHandlerMixin.java", "diffHunk": "@@ -70,9 +79,49 @@\n \n     @Shadow @Final private File worldDirectory;\n \n+    @Shadow protected abstract void shadow$setSessionLock();\n+\n     @Nullable private Exception impl$capturedException;\n     // player join stuff\n     @Nullable private Path impl$file;\n+    private Set<File> impl$directoriesToCreate = new HashSet<>();\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    private boolean impl$createDirectoryIfSavingFiles(File dir) {\n+        IPhaseState state = PhaseTracker.getInstance().getCurrentState();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTYxNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    IPhaseState state = PhaseTracker.getInstance().getCurrentState();\n          \n          \n            \n                    final IPhaseState state = PhaseTracker.getInstance().getCurrentState();", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423525616", "createdAt": "2020-05-12T07:40:15Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/storage/SaveHandlerMixin.java", "diffHunk": "@@ -70,9 +79,49 @@\n \n     @Shadow @Final private File worldDirectory;\n \n+    @Shadow protected abstract void shadow$setSessionLock();\n+\n     @Nullable private Exception impl$capturedException;\n     // player join stuff\n     @Nullable private Path impl$file;\n+    private Set<File> impl$directoriesToCreate = new HashSet<>();\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    private boolean impl$createDirectoryIfSavingFiles(File dir) {\n+        IPhaseState state = PhaseTracker.getInstance().getCurrentState();\n+        if (!state.shouldCreateWorldDirectories(PhaseTracker.getInstance().getCurrentContext())) {\n+            this.impl$directoriesToCreate.add(dir);\n+            return false;\n+        }\n+        return dir.mkdirs();\n+    }\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Lnet/minecraft/world/storage/SaveHandler;setSessionLock()V\"))\n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    private void impl$setSessionLockIfCreatingFiles(SaveHandler self) {\n+        IPhaseState state = PhaseTracker.getInstance().getCurrentState();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTg0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Lnet/minecraft/world/storage/SaveHandler;setSessionLock()V\"))\n          \n          \n            \n                @Redirect(method = \"<init>\", \n          \n          \n            \n                    at = @At(value = \"INVOKE\", \n          \n          \n            \n                        target = \"Lnet/minecraft/world/storage/SaveHandler;setSessionLock()V\"\n          \n          \n            \n                    )\n          \n          \n            \n                )", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423525840", "createdAt": "2020-05-12T07:40:38Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/storage/SaveHandlerMixin.java", "diffHunk": "@@ -70,9 +79,49 @@\n \n     @Shadow @Final private File worldDirectory;\n \n+    @Shadow protected abstract void shadow$setSessionLock();\n+\n     @Nullable private Exception impl$capturedException;\n     // player join stuff\n     @Nullable private Path impl$file;\n+    private Set<File> impl$directoriesToCreate = new HashSet<>();\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    private boolean impl$createDirectoryIfSavingFiles(File dir) {\n+        IPhaseState state = PhaseTracker.getInstance().getCurrentState();\n+        if (!state.shouldCreateWorldDirectories(PhaseTracker.getInstance().getCurrentContext())) {\n+            this.impl$directoriesToCreate.add(dir);\n+            return false;\n+        }\n+        return dir.mkdirs();\n+    }\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Lnet/minecraft/world/storage/SaveHandler;setSessionLock()V\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNjAyNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        WorldProperties props = Sponge.getServer().getWorldProperties(this.worldDirectory.getName()).get();\n          \n          \n            \n                        final WorldProperties props = Sponge.getServer().getWorldProperties(this.worldDirectory.getName()).get();", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423526025", "createdAt": "2020-05-12T07:40:57Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/storage/SaveHandlerMixin.java", "diffHunk": "@@ -70,9 +79,49 @@\n \n     @Shadow @Final private File worldDirectory;\n \n+    @Shadow protected abstract void shadow$setSessionLock();\n+\n     @Nullable private Exception impl$capturedException;\n     // player join stuff\n     @Nullable private Path impl$file;\n+    private Set<File> impl$directoriesToCreate = new HashSet<>();\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    private boolean impl$createDirectoryIfSavingFiles(File dir) {\n+        IPhaseState state = PhaseTracker.getInstance().getCurrentState();\n+        if (!state.shouldCreateWorldDirectories(PhaseTracker.getInstance().getCurrentContext())) {\n+            this.impl$directoriesToCreate.add(dir);\n+            return false;\n+        }\n+        return dir.mkdirs();\n+    }\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Lnet/minecraft/world/storage/SaveHandler;setSessionLock()V\"))\n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    private void impl$setSessionLockIfCreatingFiles(SaveHandler self) {\n+        IPhaseState state = PhaseTracker.getInstance().getCurrentState();\n+        if (state.shouldCreateWorldDirectories(PhaseTracker.getInstance().getCurrentContext())) {\n+            this.shadow$setSessionLock();\n+        }\n+    }\n+\n+    @Redirect(method = \"checkSessionLock\",\n+        at = @At(value = \"NEW\", target = \"java/io/FileInputStream\", remap = false))\n+    private FileInputStream impl$createSessionLockAndCreateDirectories(File file) throws FileNotFoundException {\n+        if (!file.exists()) {\n+            WorldProperties props = Sponge.getServer().getWorldProperties(this.worldDirectory.getName()).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNjEyNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private FileInputStream impl$createSessionLockAndCreateDirectories(File file) throws FileNotFoundException {\n          \n          \n            \n                private FileInputStream impl$createSessionLockAndCreateDirectories(final File file) throws FileNotFoundException {", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423526127", "createdAt": "2020-05-12T07:41:08Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/storage/SaveHandlerMixin.java", "diffHunk": "@@ -70,9 +79,49 @@\n \n     @Shadow @Final private File worldDirectory;\n \n+    @Shadow protected abstract void shadow$setSessionLock();\n+\n     @Nullable private Exception impl$capturedException;\n     // player join stuff\n     @Nullable private Path impl$file;\n+    private Set<File> impl$directoriesToCreate = new HashSet<>();\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    private boolean impl$createDirectoryIfSavingFiles(File dir) {\n+        IPhaseState state = PhaseTracker.getInstance().getCurrentState();\n+        if (!state.shouldCreateWorldDirectories(PhaseTracker.getInstance().getCurrentContext())) {\n+            this.impl$directoriesToCreate.add(dir);\n+            return false;\n+        }\n+        return dir.mkdirs();\n+    }\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Lnet/minecraft/world/storage/SaveHandler;setSessionLock()V\"))\n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    private void impl$setSessionLockIfCreatingFiles(SaveHandler self) {\n+        IPhaseState state = PhaseTracker.getInstance().getCurrentState();\n+        if (state.shouldCreateWorldDirectories(PhaseTracker.getInstance().getCurrentContext())) {\n+            this.shadow$setSessionLock();\n+        }\n+    }\n+\n+    @Redirect(method = \"checkSessionLock\",\n+        at = @At(value = \"NEW\", target = \"java/io/FileInputStream\", remap = false))\n+    private FileInputStream impl$createSessionLockAndCreateDirectories(File file) throws FileNotFoundException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNjE4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void impl$setSessionLockIfCreatingFiles(SaveHandler self) {\n          \n          \n            \n                private void impl$setSessionLockIfCreatingFiles(final SaveHandler self) {", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423526189", "createdAt": "2020-05-12T07:41:15Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/storage/SaveHandlerMixin.java", "diffHunk": "@@ -70,9 +79,49 @@\n \n     @Shadow @Final private File worldDirectory;\n \n+    @Shadow protected abstract void shadow$setSessionLock();\n+\n     @Nullable private Exception impl$capturedException;\n     // player join stuff\n     @Nullable private Path impl$file;\n+    private Set<File> impl$directoriesToCreate = new HashSet<>();\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    private boolean impl$createDirectoryIfSavingFiles(File dir) {\n+        IPhaseState state = PhaseTracker.getInstance().getCurrentState();\n+        if (!state.shouldCreateWorldDirectories(PhaseTracker.getInstance().getCurrentContext())) {\n+            this.impl$directoriesToCreate.add(dir);\n+            return false;\n+        }\n+        return dir.mkdirs();\n+    }\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Lnet/minecraft/world/storage/SaveHandler;setSessionLock()V\"))\n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    private void impl$setSessionLockIfCreatingFiles(SaveHandler self) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNjI4MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean impl$createDirectoryIfSavingFiles(File dir) {\n          \n          \n            \n                private boolean impl$createDirectoryIfSavingFiles(final File dir) {", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r423526281", "createdAt": "2020-05-12T07:41:24Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/storage/SaveHandlerMixin.java", "diffHunk": "@@ -70,9 +79,49 @@\n \n     @Shadow @Final private File worldDirectory;\n \n+    @Shadow protected abstract void shadow$setSessionLock();\n+\n     @Nullable private Exception impl$capturedException;\n     // player join stuff\n     @Nullable private Path impl$file;\n+    private Set<File> impl$directoriesToCreate = new HashSet<>();\n+\n+    @Redirect(method = \"<init>\", at = @At(value = \"INVOKE\", target = \"Ljava/io/File;mkdirs()Z\", remap = false))\n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    private boolean impl$createDirectoryIfSavingFiles(File dir) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e535caf428760e2cb428fe2e2386cf1df4e243f"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "934311b4d88dff87cad2d67ff36e408a0e4a72d4", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/934311b4d88dff87cad2d67ff36e408a0e4a72d4", "committedDate": "2020-05-21T22:40:24Z", "message": "Change SaveHandlerCreationPhase to pool contexts, and style fixes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODE0OTQ1", "url": "https://github.com/SpongePowered/Sponge/pull/2454#pullrequestreview-419814945", "createdAt": "2020-05-28T06:37:38Z", "commit": {"oid": "934311b4d88dff87cad2d67ff36e408a0e4a72d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNjozNzozOFrOGbnf6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNjozNzozOFrOGbnf6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYxMTg4MA==", "bodyText": "Note the MC Version (in case this can be updated for 1.14 or gets lost in transition)", "url": "https://github.com/SpongePowered/Sponge/pull/2454#discussion_r431611880", "createdAt": "2020-05-28T06:37:38Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/chunk/storage/RegionFileCacheMixin.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * This file is part of Sponge, licensed under the MIT License (MIT).\n+ *\n+ * Copyright (c) SpongePowered <https://www.spongepowered.org>\n+ * Copyright (c) contributors\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.spongepowered.common.mixin.core.world.chunk.storage;\n+\n+import net.minecraft.world.chunk.storage.RegionFile;\n+import net.minecraft.world.chunk.storage.RegionFileCache;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Overwrite;\n+import org.spongepowered.asm.mixin.Shadow;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+\n+import java.io.DataInputStream;\n+import java.io.File;\n+\n+@Mixin(RegionFileCache.class)\n+public abstract class RegionFileCacheMixin {\n+\n+    @Shadow public static RegionFile getRegionFileIfExists(File worldDir, int chunkX, int chunkZ) {return null;}\n+\n+    /**\n+     * @author JBYoshi - January 2, 2020", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "934311b4d88dff87cad2d67ff36e408a0e4a72d4"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODE1NzEz", "url": "https://github.com/SpongePowered/Sponge/pull/2454#pullrequestreview-419815713", "createdAt": "2020-05-28T06:39:09Z", "commit": {"oid": "934311b4d88dff87cad2d67ff36e408a0e4a72d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1332c42984990349f378129fd15e45c1a08f6cd6", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/1332c42984990349f378129fd15e45c1a08f6cd6", "committedDate": "2020-05-28T21:14:05Z", "message": "Add Minecraft version to javadoc."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 932, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}