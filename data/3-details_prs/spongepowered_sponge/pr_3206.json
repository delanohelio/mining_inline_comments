{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0NTg1Mzg2", "number": 3206, "title": "Add max-chunk-lifetime setting used by chunk gc (#3167) - fixed", "bodyText": "Fixed a bug in my previous edition of this PR.\n\nIf the chunk is not queued for unload, and the max-lifetime setting is disabled - the chunk gets saved to disk. Every tick.\nThat else if should look like else if (max-lifetime <= 0 || !delay_expired || !isDirty) {continue;}.\n\nNow that else if looks like it should've. :)\n(If only GitHub allowed to reopen merged pull-requests by reverting it's merge commit or something...)", "createdAt": "2020-11-20T09:52:05Z", "url": "https://github.com/SpongePowered/Sponge/pull/3206", "merged": true, "mergeCommit": {"oid": "a0a5428227c2cc2a98aca218da7c62d84866fdd1"}, "closed": true, "closedAt": "2020-12-21T14:02:53Z", "author": {"login": "PolyacovYury"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeXX7dgFqTUzNTQyNjQ4MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdoVEpIgBqjQxMzU3NjA0Mzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDI2NDgw", "url": "https://github.com/SpongePowered/Sponge/pull/3206#pullrequestreview-535426480", "createdAt": "2020-11-20T13:28:55Z", "commit": {"oid": "edd1d1df3baeb133c1aca17550eaa5245ee896b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzoyODo1NVrOH3PqEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzoyODo1NVrOH3PqEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY5MDI1Nw==", "bodyText": "Just clarify something for me here: this seems to change the logic such that chunk data and extra chunk data will never be saved if the max chunk lifetime is disabled because this check will then always succeed and fall through to the continue? Shouldn't this check only pass if the chunk isn't due to be unloaded in the first place?", "url": "https://github.com/SpongePowered/Sponge/pull/3206#discussion_r527690257", "createdAt": "2020-11-20T13:28:55Z", "author": {"login": "dualspiral"}, "path": "src/main/java/org/spongepowered/common/mixin/core/world/gen/ChunkProviderServerMixin.java", "diffHunk": "@@ -268,22 +270,34 @@ public boolean tick()\n             final Iterator<Chunk> iterator = this.loadedChunks.values().iterator();\n             int chunksUnloaded = 0;\n             final long now = System.currentTimeMillis();\n+            final long world_time = this.world.getTotalWorldTime();\n             while (chunksUnloaded < this.impl$maxChunkUnloads && iterator.hasNext()) {\n                 final Chunk chunk = iterator.next();\n                 final ChunkBridge spongeChunk = (ChunkBridge) chunk;\n-                if (chunk != null && chunk.unloadQueued && !spongeChunk.bridge$isPersistedChunk()) {\n+                if (chunk == null || spongeChunk.bridge$isPersistedChunk()) {\n+                    continue;\n+                }\n+                if (chunk.unloadQueued) {\n                     if (this.bridge$getChunkUnloadDelay() > 0) {\n                         if ((now - spongeChunk.bridge$getScheduledForUnload()) < this.impl$chunkUnloadDelay) {\n                             continue;\n                         }\n                         spongeChunk.bridge$setScheduledForUnload(-1);\n                     }\n                     chunk.onUnload();\n-                    this.saveChunkData(chunk);\n-                    this.saveChunkExtraData(chunk);\n+                }\n+                // max lifetime only applies to chunks that should stay loaded but still need saving once in a while\n+                else if (this.impl$maxChunkLifetime <= 0 // if setting is disabled", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edd1d1df3baeb133c1aca17550eaa5245ee896b8"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8d7ba2d534a7fcb00e192f8af8bd241fa1c7763", "author": {"user": {"login": "PolyacovYury", "name": null}}, "url": "https://github.com/SpongePowered/Sponge/commit/b8d7ba2d534a7fcb00e192f8af8bd241fa1c7763", "committedDate": "2020-12-21T12:23:45Z", "message": "Add max-chunk-lifetime setting used by chunk gc (#3167) - fixed\n\n- mostly useful for those who need to disable full auto-saves controlled by auto-save-interval\n- spreads out server load induced by chunk saving\n- allows to periodically save chunks kept active by players for a long time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "edd1d1df3baeb133c1aca17550eaa5245ee896b8", "author": {"user": {"login": "PolyacovYury", "name": null}}, "url": "https://github.com/SpongePowered/Sponge/commit/edd1d1df3baeb133c1aca17550eaa5245ee896b8", "committedDate": "2020-11-20T09:45:24Z", "message": "Add max-chunk-lifetime setting used by chunk gc (#3167) - fixed\n\n- mostly useful for those who need to disable full auto-saves controlled by auto-save-interval\n- spreads out server load induced by chunk saving\n- allows to periodically save chunks kept active by players for a long time"}, "afterCommit": {"oid": "b8d7ba2d534a7fcb00e192f8af8bd241fa1c7763", "author": {"user": {"login": "PolyacovYury", "name": null}}, "url": "https://github.com/SpongePowered/Sponge/commit/b8d7ba2d534a7fcb00e192f8af8bd241fa1c7763", "committedDate": "2020-12-21T12:23:45Z", "message": "Add max-chunk-lifetime setting used by chunk gc (#3167) - fixed\n\n- mostly useful for those who need to disable full auto-saves controlled by auto-save-interval\n- spreads out server load induced by chunk saving\n- allows to periodically save chunks kept active by players for a long time"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 762, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}