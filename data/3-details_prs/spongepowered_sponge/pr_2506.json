{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NzU3MTIz", "number": 2506, "title": "Replace craft preview transaction list with a single entry.", "bodyText": "Basically everything that uses the crafting transaction list relies on it having only a single entry. However, when the player drags in the crafting table, slotChangedCraftingGrid is called multiple times, putting multiple entries into the list. This PR merges these calls into a single transaction to prevent issues like this.\nFixes #2505.", "createdAt": "2020-02-15T20:58:50Z", "url": "https://github.com/SpongePowered/Sponge/pull/2506", "merged": true, "mergeCommit": {"oid": "0a934a1e7d9ff883f432eca3cd77b18818ce041d"}, "closed": true, "closedAt": "2020-07-26T15:24:58Z", "author": {"login": "JBYoshi"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGsU35gFqTM2MzAwODE4MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcv0oV3gBqjM0OTA3NTQ2MzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDA4MTgw", "url": "https://github.com/SpongePowered/Sponge/pull/2506#pullrequestreview-363008180", "createdAt": "2020-02-22T04:04:43Z", "commit": {"oid": "de04873cc8e81a9279cece915a2343c9bbc98a08"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwNDowNDo0M1rOFtJYug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwNDowNzoyNVrOFtJZTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4NDAyNg==", "bodyText": "(nitpick) final this value please.", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r382884026", "createdAt": "2020-02-22T04:04:43Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/event/tracking/phase/packet/drag/DragInventoryStopState.java", "diffHunk": "@@ -64,13 +65,13 @@ public static void unwindCraftPreview(InventoryPacketContext context) {\n \n         Inventory craftInv = ((Inventory) player.openContainer).query(QueryOperationTypes.INVENTORY_TYPE.of(CraftingInventory.class));\n         if (craftInv instanceof CraftingInventory) {\n-            List<SlotTransaction> previewTransactions = ((ContainerBridge) player.openContainer).bridge$getPreviewTransactions();\n-            if (!previewTransactions.isEmpty()) {\n+            SlotTransaction previewTransaction = ((ContainerBridge) player.openContainer).bridge$getPreviewTransaction();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de04873cc8e81a9279cece915a2343c9bbc98a08"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4NDA2NA==", "bodyText": "(nitpick) final this variable please", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r382884064", "createdAt": "2020-02-22T04:05:33Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/event/tracking/phase/packet/inventory/PlaceRecipePacketState.java", "diffHunk": "@@ -79,15 +80,14 @@ public void unwind(final InventoryPacketContext context) {\n             return;\n         }\n \n-        final List<SlotTransaction> previewTransactions = ((ContainerBridge) player.openContainer).bridge$getPreviewTransactions();\n-        if (previewTransactions.isEmpty()) {\n+        SlotTransaction previewTransaction = ((ContainerBridge) player.openContainer).bridge$getPreviewTransaction();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de04873cc8e81a9279cece915a2343c9bbc98a08"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4NDE0Nw==", "bodyText": "Could this be configurable?", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r382884147", "createdAt": "2020-02-22T04:06:45Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java", "diffHunk": "@@ -431,26 +424,35 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n         final ItemStackSnapshot repl = ItemStackUtil.snapshotOf(output.getStackInSlot(index));\n \n         final SlotAdapter slot = this.impl$getAdapters().get(index);\n-        this.impl$capturedCraftPreviewTransactions.add(new SlotTransaction(slot, orig, repl));\n+        if (this.impl$capturedCraftPreviewTransaction == null) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, orig, repl);\n+        } else if (this.impl$capturedCraftPreviewTransaction.getSlot().equals(slot)\n+                && this.impl$capturedCraftPreviewTransaction.getFinal().equals(orig)) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, this.impl$capturedCraftPreviewTransaction.getOriginal(), repl);\n+        } else {\n+            SlotTransaction replace = new SlotTransaction(slot, orig, repl);\n+            SpongeImpl.getLogger().warn(\"Could not merge craft preview transactions - some events may break (original {}, replace {})\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de04873cc8e81a9279cece915a2343c9bbc98a08"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4NDE3NQ==", "bodyText": "(nitpick) final this variable please", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r382884175", "createdAt": "2020-02-22T04:07:25Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/inventory/SlotCraftingMixin.java", "diffHunk": "@@ -174,23 +175,21 @@ private void afterTake(final EntityPlayer thePlayer, final ItemStack stack, fina\n         ((ContainerBridge) container).bridge$setFirePreview(true);\n         this.impl$craftedStack = null;\n \n-        final List<SlotTransaction> previewTransactions = ((ContainerBridge) container).bridge$getPreviewTransactions();\n+        SlotTransaction previewTransaction = ((ContainerBridge) container).bridge$getPreviewTransaction();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de04873cc8e81a9279cece915a2343c9bbc98a08"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjkxOTM3", "url": "https://github.com/SpongePowered/Sponge/pull/2506#pullrequestreview-363291937", "createdAt": "2020-02-24T10:32:40Z", "commit": {"oid": "0526f87d3e8cbf53306d41e4bd550fbb1f3a9d41"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMDozMjo0MFrOFtb3VA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMDozMjo0MFrOFtb3VA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE4Njc3Mg==", "bodyText": "I know @gabizou said \"could this be configurable?\" and attached it to the log line, but I'm not sure this is what he meant - I think we should always be reporting a failure to the log.\nWas the meaning that this entire behaviour on failure should be configurable - as in, original vs replacement?", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r383186772", "createdAt": "2020-02-24T10:32:40Z", "author": {"login": "dualspiral"}, "path": "src/main/java/org/spongepowered/common/config/category/LoggingCategory.java", "diffHunk": "@@ -179,6 +181,10 @@ public void setLogEntitySpeedRemoval(boolean flag) {\n         this.logEntitySpeedRemoval = flag;\n     }\n \n+    public boolean logTransactionMergeFailure() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0526f87d3e8cbf53306d41e4bd550fbb1f3a9d41"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0526f87d3e8cbf53306d41e4bd550fbb1f3a9d41", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/0526f87d3e8cbf53306d41e4bd550fbb1f3a9d41", "committedDate": "2020-02-24T04:47:49Z", "message": "Logging and final variables"}, "afterCommit": {"oid": "0f417cfd86180a51c995021d6a499ae7e57b1463", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/0f417cfd86180a51c995021d6a499ae7e57b1463", "committedDate": "2020-03-24T01:18:20Z", "message": "Make the number of log messages configurable."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NzEwNzU3", "url": "https://github.com/SpongePowered/Sponge/pull/2506#pullrequestreview-427710757", "createdAt": "2020-06-10T04:57:56Z", "commit": {"oid": "0f417cfd86180a51c995021d6a499ae7e57b1463"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwNDo1Nzo1NlrOGhk3qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwNTowNDoyMVrOGhk93A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg2MDI2Ng==", "bodyText": "Should this comment be multi-lined to roughly 100 characters?", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r437860266", "createdAt": "2020-06-10T04:57:56Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/config/category/LoggingCategory.java", "diffHunk": "@@ -64,6 +64,9 @@\n     private boolean logEntityCollisionChecks = false;\n     @Setting(value = \"entity-speed-removal\", comment = \"Whether to log entity removals due to speed\")\n     private boolean logEntitySpeedRemoval = false;\n+    @Setting(value = \"transaction-merge-fail\", comment = \"Log when two conflicting changes are merged into one. (This number specifies the maximum \"\n+            + \"number of messages to log. Set to 0 to show all messages.)\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f417cfd86180a51c995021d6a499ae7e57b1463"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg2MDgxNw==", "bodyText": "Are you doing the correct equality check here? Or are you aiming to just allow instance equality checking the ItemStackSnapshot?", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r437860817", "createdAt": "2020-06-10T05:00:08Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java", "diffHunk": "@@ -431,26 +425,43 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n         final ItemStackSnapshot repl = ItemStackUtil.snapshotOf(output.getStackInSlot(index));\n \n         final SlotAdapter slot = this.impl$getAdapters().get(index);\n-        this.impl$capturedCraftPreviewTransactions.add(new SlotTransaction(slot, orig, repl));\n+        if (this.impl$capturedCraftPreviewTransaction == null) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, orig, repl);\n+        } else if (this.impl$capturedCraftPreviewTransaction.getSlot().equals(slot)\n+                && this.impl$capturedCraftPreviewTransaction.getFinal().equals(orig)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f417cfd86180a51c995021d6a499ae7e57b1463"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg2MDkyNw==", "bodyText": "Off the top of my head, do SlotAdapters implement equals?", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r437860927", "createdAt": "2020-06-10T05:00:35Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java", "diffHunk": "@@ -431,26 +425,43 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n         final ItemStackSnapshot repl = ItemStackUtil.snapshotOf(output.getStackInSlot(index));\n \n         final SlotAdapter slot = this.impl$getAdapters().get(index);\n-        this.impl$capturedCraftPreviewTransactions.add(new SlotTransaction(slot, orig, repl));\n+        if (this.impl$capturedCraftPreviewTransaction == null) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, orig, repl);\n+        } else if (this.impl$capturedCraftPreviewTransaction.getSlot().equals(slot)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f417cfd86180a51c995021d6a499ae7e57b1463"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg2MTA1Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        SlotTransaction replace = new SlotTransaction(slot, orig, repl);\n          \n          \n            \n                        final SlotTransaction replace = new SlotTransaction(slot, orig, repl);", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r437861052", "createdAt": "2020-06-10T05:01:01Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java", "diffHunk": "@@ -431,26 +425,43 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n         final ItemStackSnapshot repl = ItemStackUtil.snapshotOf(output.getStackInSlot(index));\n \n         final SlotAdapter slot = this.impl$getAdapters().get(index);\n-        this.impl$capturedCraftPreviewTransactions.add(new SlotTransaction(slot, orig, repl));\n+        if (this.impl$capturedCraftPreviewTransaction == null) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, orig, repl);\n+        } else if (this.impl$capturedCraftPreviewTransaction.getSlot().equals(slot)\n+                && this.impl$capturedCraftPreviewTransaction.getFinal().equals(orig)) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, this.impl$capturedCraftPreviewTransaction.getOriginal(), repl);\n+        } else {\n+            SlotTransaction replace = new SlotTransaction(slot, orig, repl);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f417cfd86180a51c995021d6a499ae7e57b1463"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg2MTQwOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        int maxLogs = SpongeImpl.getGlobalConfigAdapter().getConfig().getLogging().logTransactionMergeFailure();\n          \n          \n            \n                        final int maxLogs = SpongeImpl.getGlobalConfigAdapter().getConfig().getLogging().logTransactionMergeFailure();", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r437861409", "createdAt": "2020-06-10T05:02:36Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java", "diffHunk": "@@ -431,26 +425,43 @@ private void beforeSlotChangedCraftingGrid(final InventoryCraftResult output, fi\n         final ItemStackSnapshot repl = ItemStackUtil.snapshotOf(output.getStackInSlot(index));\n \n         final SlotAdapter slot = this.impl$getAdapters().get(index);\n-        this.impl$capturedCraftPreviewTransactions.add(new SlotTransaction(slot, orig, repl));\n+        if (this.impl$capturedCraftPreviewTransaction == null) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, orig, repl);\n+        } else if (this.impl$capturedCraftPreviewTransaction.getSlot().equals(slot)\n+                && this.impl$capturedCraftPreviewTransaction.getFinal().equals(orig)) {\n+            this.impl$capturedCraftPreviewTransaction = new SlotTransaction(slot, this.impl$capturedCraftPreviewTransaction.getOriginal(), repl);\n+        } else {\n+            SlotTransaction replace = new SlotTransaction(slot, orig, repl);\n+            ContainerMixin.impl$numTransactionErrorsLogged++;\n+            int maxLogs = SpongeImpl.getGlobalConfigAdapter().getConfig().getLogging().logTransactionMergeFailure();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f417cfd86180a51c995021d6a499ae7e57b1463"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg2MTg1Mg==", "bodyText": "Static fields should be in their own body imo. Make it well aware they are static.", "url": "https://github.com/SpongePowered/Sponge/pull/2506#discussion_r437861852", "createdAt": "2020-06-10T05:04:21Z", "author": {"login": "gabizou"}, "path": "src/main/java/org/spongepowered/common/mixin/core/inventory/ContainerMixin.java", "diffHunk": "@@ -119,7 +120,8 @@\n     //private boolean postPreCraftEvent = true; // used to prevent multiple craft events to fire when setting multiple slots simultaneously\n     private List<SlotTransaction> impl$capturedSlotTransactions = new ArrayList<>();\n     private List<SlotTransaction> impl$capturedCraftShiftTransactions = new ArrayList<>();\n-    private List<SlotTransaction> impl$capturedCraftPreviewTransactions = new ArrayList<>();\n+    @Nullable private SlotTransaction impl$capturedCraftPreviewTransaction;\n+    private static int impl$numTransactionErrorsLogged = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f417cfd86180a51c995021d6a499ae7e57b1463"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdcae79551695b85118d269dbd3ac38fb1b1932a", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/bdcae79551695b85118d269dbd3ac38fb1b1932a", "committedDate": "2020-06-28T22:57:54Z", "message": "Replace craft preview transaction list with a single entry.\n\nFixes #2505."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7914452b0ccad466e34890876820a4723996cd2d", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/7914452b0ccad466e34890876820a4723996cd2d", "committedDate": "2020-06-28T22:59:05Z", "message": "Logging and final variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "baa9a08bbd13889630939526105d9405e2ff00bf", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/baa9a08bbd13889630939526105d9405e2ff00bf", "committedDate": "2020-06-28T22:59:26Z", "message": "Make the number of log messages configurable."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a334460ade447f3b23b4c1ace7cf3aaa470df591", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/a334460ade447f3b23b4c1ace7cf3aaa470df591", "committedDate": "2020-06-28T22:59:27Z", "message": "More fixes for @gabizou."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f417cfd86180a51c995021d6a499ae7e57b1463", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/0f417cfd86180a51c995021d6a499ae7e57b1463", "committedDate": "2020-03-24T01:18:20Z", "message": "Make the number of log messages configurable."}, "afterCommit": {"oid": "a334460ade447f3b23b4c1ace7cf3aaa470df591", "author": {"user": {"login": "JBYoshi", "name": "Jonathan Browne"}}, "url": "https://github.com/SpongePowered/Sponge/commit/a334460ade447f3b23b4c1ace7cf3aaa470df591", "committedDate": "2020-06-28T22:59:27Z", "message": "More fixes for @gabizou."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 856, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}