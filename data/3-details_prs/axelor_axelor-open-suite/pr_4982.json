{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5NjIyNTYx", "number": 4982, "title": "RM22812 Invoicing graphics involving revenue based both sales and refunds.", "bodyText": "", "createdAt": "2020-02-25T14:42:16Z", "url": "https://github.com/axelor/axelor-open-suite/pull/4982", "merged": true, "mergeCommit": {"oid": "baecd5e4e19d710c04600b54972ae5f4b390f9aa"}, "closed": true, "closedAt": "2020-03-03T15:12:50Z", "author": {"login": "erg-axelor"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHbKfjgH2gAyMzc5NjIyNTYxOjZhNThlN2ViNmM2NzMwNDlhYTA0OTA5OWUxZDYxMTEzYzVlNzAyZWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKDz0BAH2gAyMzc5NjIyNTYxOjE1OGVjODc0MjkyY2EzYTAwY2RmYWVjMGI2YzVkNWEyN2NmZjFkOTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6a58e7eb6c673049aa049099e1d61113c5e702ea", "author": {"user": {"login": "erg-axelor", "name": null}}, "url": "https://github.com/axelor/axelor-open-suite/commit/6a58e7eb6c673049aa049099e1d61113c5e702ea", "committedDate": "2020-02-24T10:42:27Z", "message": "Adding customer assets in the turnover calculation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78d16468643fd5252f437053ee206fc6972bb994", "author": {"user": {"login": "erg-axelor", "name": null}}, "url": "https://github.com/axelor/axelor-open-suite/commit/78d16468643fd5252f437053ee206fc6972bb994", "committedDate": "2020-02-25T14:35:10Z", "message": "Correction for customer assets on revenue graphs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "689a7a99f3221965f7bcf0a1a099a93db9c25cc0", "author": {"user": {"login": "erg-axelor", "name": null}}, "url": "https://github.com/axelor/axelor-open-suite/commit/689a7a99f3221965f7bcf0a1a099a93db9c25cc0", "committedDate": "2020-02-25T14:36:56Z", "message": "spotlessApply"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bafb7efa750dc16bafe9a0bd1662142c4c2cb9c", "author": {"user": {"login": "erg-axelor", "name": null}}, "url": "https://github.com/axelor/axelor-open-suite/commit/2bafb7efa750dc16bafe9a0bd1662142c4c2cb9c", "committedDate": "2020-02-26T11:11:02Z", "message": "Merge branch '5.2-dev' into dev-22812"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MjA2Nzc4", "url": "https://github.com/axelor/axelor-open-suite/pull/4982#pullrequestreview-367206778", "createdAt": "2020-03-02T13:44:15Z", "commit": {"oid": "2bafb7efa750dc16bafe9a0bd1662142c4c2cb9c"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxMzo0NDoxNVrOFwf9RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxMzo0Nzo1NFrOFwgEPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM5OTU1Ng==", "bodyText": "Create a JPQL query using SUM instead of computing the sum in java", "url": "https://github.com/axelor/axelor-open-suite/pull/4982#discussion_r386399556", "createdAt": "2020-03-02T13:44:15Z", "author": {"login": "ale-axelor"}, "path": "axelor-account/src/main/java/com/axelor/apps/account/web/AccountChartController.java", "diffHunk": "@@ -58,4 +68,259 @@ public void installChart(ActionRequest request, ActionResponse response) throws\n \n     } else response.setFlash(I18n.get(IExceptionMessage.ACCOUNT_CHART_3));\n   }\n+\n+  public void chartInvoicedTurnoverThisYearVsLastyear(\n+      ActionRequest request, ActionResponse response) {\n+    List<Map<String, Object>> dataList = new ArrayList<>();\n+    InvoiceRepository repo = Beans.get(InvoiceRepository.class);\n+    BigDecimal salesThisYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=3 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add);\n+    BigDecimal salesLastYear =\n+        repo.all()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bafb7efa750dc16bafe9a0bd1662142c4c2cb9c"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMDIwNg==", "bodyText": "Please refactor this controller to use a service", "url": "https://github.com/axelor/axelor-open-suite/pull/4982#discussion_r386400206", "createdAt": "2020-03-02T13:45:36Z", "author": {"login": "ale-axelor"}, "path": "axelor-account/src/main/java/com/axelor/apps/account/web/AccountChartController.java", "diffHunk": "@@ -58,4 +68,259 @@ public void installChart(ActionRequest request, ActionResponse response) throws\n \n     } else response.setFlash(I18n.get(IExceptionMessage.ACCOUNT_CHART_3));\n   }\n+\n+  public void chartInvoicedTurnoverThisYearVsLastyear(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bafb7efa750dc16bafe9a0bd1662142c4c2cb9c"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMDM5OQ==", "bodyText": "use signum() to check if a big decimal is equal to 0", "url": "https://github.com/axelor/axelor-open-suite/pull/4982#discussion_r386400399", "createdAt": "2020-03-02T13:45:58Z", "author": {"login": "ale-axelor"}, "path": "axelor-account/src/main/java/com/axelor/apps/account/web/AccountChartController.java", "diffHunk": "@@ -58,4 +68,259 @@ public void installChart(ActionRequest request, ActionResponse response) throws\n \n     } else response.setFlash(I18n.get(IExceptionMessage.ACCOUNT_CHART_3));\n   }\n+\n+  public void chartInvoicedTurnoverThisYearVsLastyear(\n+      ActionRequest request, ActionResponse response) {\n+    List<Map<String, Object>> dataList = new ArrayList<>();\n+    InvoiceRepository repo = Beans.get(InvoiceRepository.class);\n+    BigDecimal salesThisYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=3 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add);\n+    BigDecimal salesLastYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=3 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) - 1 \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add);\n+    BigDecimal totalThisYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=4 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add)\n+            .negate()\n+            .add(salesThisYear);\n+    BigDecimal totalLastYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=4 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) - 1 \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add)\n+            .negate()\n+            .add(salesLastYear);\n+    if (!totalLastYear.equals(BigDecimal.ZERO)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bafb7efa750dc16bafe9a0bd1662142c4c2cb9c"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMTM0MA==", "bodyText": "please replace LocalDate.now() by appBaseService.getTodayDate()", "url": "https://github.com/axelor/axelor-open-suite/pull/4982#discussion_r386401340", "createdAt": "2020-03-02T13:47:54Z", "author": {"login": "ale-axelor"}, "path": "axelor-account/src/main/java/com/axelor/apps/account/web/AccountChartController.java", "diffHunk": "@@ -58,4 +68,259 @@ public void installChart(ActionRequest request, ActionResponse response) throws\n \n     } else response.setFlash(I18n.get(IExceptionMessage.ACCOUNT_CHART_3));\n   }\n+\n+  public void chartInvoicedTurnoverThisYearVsLastyear(\n+      ActionRequest request, ActionResponse response) {\n+    List<Map<String, Object>> dataList = new ArrayList<>();\n+    InvoiceRepository repo = Beans.get(InvoiceRepository.class);\n+    BigDecimal salesThisYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=3 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add);\n+    BigDecimal salesLastYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=3 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) - 1 \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add);\n+    BigDecimal totalThisYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=4 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add)\n+            .negate()\n+            .add(salesThisYear);\n+    BigDecimal totalLastYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=4 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) - 1 \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add)\n+            .negate()\n+            .add(salesLastYear);\n+    if (!totalLastYear.equals(BigDecimal.ZERO)) {\n+      Map<String, Object> dataMap = new HashMap<>();\n+      dataMap.put(\"_year\", LocalDate.now().getYear() - 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bafb7efa750dc16bafe9a0bd1662142c4c2cb9c"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "824dff2b76b7e9a7c9d947da6c4a40603912a86a", "author": {"user": {"login": "erg-axelor", "name": null}}, "url": "https://github.com/axelor/axelor-open-suite/commit/824dff2b76b7e9a7c9d947da6c4a40603912a86a", "committedDate": "2020-03-03T08:59:53Z", "message": "Getting chart back from rpc dataset to sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70acfbfe444184f642b861434123243019d22271", "author": {"user": {"login": "erg-axelor", "name": null}}, "url": "https://github.com/axelor/axelor-open-suite/commit/70acfbfe444184f642b861434123243019d22271", "committedDate": "2020-03-03T09:00:17Z", "message": "Merge branch 'dev-22812' of github.com:erg-axelor/axelor-open-suite into dev-22812"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77b34725583347327465e7c543769b9e997d3ac9", "author": {"user": {"login": "erg-axelor", "name": null}}, "url": "https://github.com/axelor/axelor-open-suite/commit/77b34725583347327465e7c543769b9e997d3ac9", "committedDate": "2020-03-03T09:02:54Z", "message": "spotlessApply"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10629d9f6c009cb15180c7eec0c0c2f87f4d5d9d", "author": {"user": {"login": "erg-axelor", "name": null}}, "url": "https://github.com/axelor/axelor-open-suite/commit/10629d9f6c009cb15180c7eec0c0c2f87f4d5d9d", "committedDate": "2020-03-03T09:05:29Z", "message": "Merge branch '5.2-dev' into dev-22812"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "158ec874292ca3a00cdfaec0b6c5d5a27cff1d99", "author": {"user": {"login": "ale-axelor", "name": null}}, "url": "https://github.com/axelor/axelor-open-suite/commit/158ec874292ca3a00cdfaec0b6c5d5a27cff1d99", "committedDate": "2020-03-03T15:11:38Z", "message": "Merge branch '5.2-dev' into dev-22812"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2038, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}