{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NTY5MTkx", "number": 4264, "title": "[GEOS-9633] Pregeneralized DataStore and Vector-tile", "bodyText": "Hi,\nfollowing up the discussion from the users mailing list\nThe PR is a first draft just to show what is missing related to GEOS-9633 feel free to comment and share your thoughts.\nI've started looking at org.geotools.renderer.lite.StreamingRenderer and most of the code comes from there, I've tryied to simplify it as much as possible removing features not strictly related to this feature.\nChecklist\n\nReviewing is a process done by project maintainers, mostly on a volunteer basis. We try to keep the overhead as small as possible and appreciate if you help us to do so by completing the following items. Feel free to ask in a comment if you have troubles with any of them.\n\nFor all pull requests:\n\n Confirm you have read the contribution guidelines\n You have sent a Contribution Licence Agreement (CLA) as necessary (not required for small changes, e.g., fixing typos in documentation)\n Make sure the first PR targets the master branch, eventual backports will be managed later. This can be ignored if the PR is fixing an issue that only happens in a specific branch, but not in newer ones.\n\nThe following are required only for core and extension modules (they are welcomed, but not required, for community modules):\n\n There is a ticket in Jira describing the issue/improvement/feature (a notable exemptions is, changes not visible to end users)\n PR for bug fixes and small new features are presented as a single commit\n Commit message must be in the form \"[GEOS-XYZW] Title of the Jira ticket\" (export to XML in Jira generates the message in this exact form)\n The pull request contains changes related to a single objective. If multiple focuses cannot be avoided, each one is in its own commit and has a separate ticket describing it.\n New unit tests have been added covering the changes\n This PR passes all existing unit tests (test results will be reported by travis-ci after opening this PR)\n This PR passes the QA checks (QA checks results will be reported by travis-ci after opening this PR)\n Commits changing the UI, existing user workflows, or adding new functionality, need to include documentation updates (screenshots, text)\n Commits changing the REST API, or any configuration object, should check if the REST API docs (Swagger YAML files and classic documentation) need to be updated.\n\nSubmitting the PR does not require you to check all items, but by the time it gets merged, they should be either satisfied or inapplicable.", "createdAt": "2020-05-28T15:35:39Z", "url": "https://github.com/geoserver/geoserver/pull/4264", "merged": true, "mergeCommit": {"oid": "e30cdcc49ae6937f62c913747838fc64f00ea33c"}, "closed": true, "closedAt": "2020-08-17T09:47:35Z", "author": {"login": "ccancellieri"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpN4DVAFqTQyNjA5MjYyNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9TTxHgBqjM2MzY3Mzg4MDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDkyNjI2", "url": "https://github.com/geoserver/geoserver/pull/4264#pullrequestreview-426092626", "createdAt": "2020-06-08T10:16:01Z", "commit": {"oid": "ae30de389f847a654021b6dcea91a126bfa30d8f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMDoxNjowMVrOGgXhcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMDoyNTozNFrOGgX0bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU5MzAwOQ==", "bodyText": "No need for the comment, the change must be covered by a test case anyways.", "url": "https://github.com/geoserver/geoserver/pull/4264#discussion_r436593009", "createdAt": "2020-06-08T10:16:01Z", "author": {"login": "aaime"}, "path": "src/extension/vectortiles/src/main/java/org/geoserver/wms/vector/VectorTileMapOutputFormat.java", "diffHunk": "@@ -203,7 +203,10 @@ void run(\n                     continue;\n                 }\n \n-                final String layerName = feature.getName().getLocalPart();\n+                final String layerName =\n+                        feature.getType()\n+                                .getName()\n+                                .getLocalPart(); // Pregeneralized have null getName()!!!", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae30de389f847a654021b6dcea91a126bfa30d8f"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU5NzQ1OQ==", "bodyText": "The screenmap is already set at the PipelineBuilder level, should probably be using that one (a code path to make it available needs to be created), but if you do, then the PreProcess step needs have the screenamap usage disabled.\nEven if they are kept separate, the two screenmaps should at least have the exact same config.", "url": "https://github.com/geoserver/geoserver/pull/4264#discussion_r436597459", "createdAt": "2020-06-08T10:24:46Z", "author": {"login": "aaime"}, "path": "src/extension/vectortiles/src/main/java/org/geotools/renderer/lite/VectorMapRenderUtils.java", "diffHunk": "@@ -105,10 +110,99 @@ public static Query getStyleQuery(Layer layer, WMSMapContent mapContent) throws\n         query.setProperties(Query.ALL_PROPERTIES);\n \n         Hints hints = query.getHints();\n+\n         hints.put(Hints.FEATURE_2D, Boolean.TRUE);\n \n+        // update the screenmaps\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae30de389f847a654021b6dcea91a126bfa30d8f"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU5Nzg3MA==", "bodyText": "Code should be updated to match the vector tiles context (there is no \"renderer screenmap\", but the code could be referring to the PreProcess pipeline step screenmap instead).", "url": "https://github.com/geoserver/geoserver/pull/4264#discussion_r436597870", "createdAt": "2020-06-08T10:25:34Z", "author": {"login": "aaime"}, "path": "src/extension/vectortiles/src/main/java/org/geotools/renderer/lite/VectorMapRenderUtils.java", "diffHunk": "@@ -105,10 +110,99 @@ public static Query getStyleQuery(Layer layer, WMSMapContent mapContent) throws\n         query.setProperties(Query.ALL_PROPERTIES);\n \n         Hints hints = query.getHints();\n+\n         hints.put(Hints.FEATURE_2D, Boolean.TRUE);\n \n+        // update the screenmaps\n+        try {\n+            CoordinateReferenceSystem crs = schema.getCoordinateReferenceSystem();\n+            if (crs != null) {\n+                FeatureSource<FeatureType, Feature> source =\n+                        (FeatureSource<FeatureType, Feature>) layer.getFeatureSource();\n+                Set<RenderingHints.Key> fsHints = source.getSupportedHints();\n+                CoordinateReferenceSystem destSRS = query.getCoordinateSystemReproject();\n+                MathTransform sourceToScreen =\n+                        buildFullTransform(\n+                                crs,\n+                                destSRS != null ? destSRS : crs,\n+                                mapContent.getRenderingTransform());\n+                double[] spans =\n+                        // fallback, use the entire rendering area\n+                        Decimator.computeGeneralizationDistances(\n+                                sourceToScreen.inverse(), screenSize, generalizationDistance);\n+                for (LiteFeatureTypeStyle fts : styleList) {\n+                    if (fts.screenMap != null) {\n+                        fts.screenMap.setTransform(sourceToScreen);\n+                        fts.screenMap.setSpans(spans[0], spans[1]);\n+                        if (fsHints.contains(Hints.SCREENMAP)) {\n+                            // replace the renderer screenmap with the hint, and avoid doing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae30de389f847a654021b6dcea91a126bfa30d8f"}, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae30de389f847a654021b6dcea91a126bfa30d8f", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/ae30de389f847a654021b6dcea91a126bfa30d8f", "committedDate": "2020-05-28T12:39:01Z", "message": "[GEOS-9633] first draft"}, "afterCommit": {"oid": "5543d5fb93e5e6785b5428da73a47c8a8e739000", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/5543d5fb93e5e6785b5428da73a47c8a8e739000", "committedDate": "2020-06-22T15:35:55Z", "message": "[GEOS-9633] first draft\nintegrating with the pipeline builder\n\nleverage on target distance\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5543d5fb93e5e6785b5428da73a47c8a8e739000", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/5543d5fb93e5e6785b5428da73a47c8a8e739000", "committedDate": "2020-06-22T15:35:55Z", "message": "[GEOS-9633] first draft\nintegrating with the pipeline builder\n\nleverage on target distance\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables"}, "afterCommit": {"oid": "0906d4a46a3b21f05b3615a791f53f1b7d7a2150", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/0906d4a46a3b21f05b3615a791f53f1b7d7a2150", "committedDate": "2020-06-22T17:14:37Z", "message": "[GEOS-9633] first draft\nintegrating with the pipeline builder\n\nleverage on target distance\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nfix WFS3 module build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2ODI2NzUy", "url": "https://github.com/geoserver/geoserver/pull/4264#pullrequestreview-436826752", "createdAt": "2020-06-24T16:46:04Z", "commit": {"oid": "0906d4a46a3b21f05b3615a791f53f1b7d7a2150"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNjo0NjowNVrOGoajyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNjo0NjowNVrOGoajyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTAzMTM3MA==", "bodyText": "Not so sure about this (actually copied from other Renderer). in case of GEOMETRY_SIMPLIFICATION do we have to skip the GEOMETRY_DISTANCE hint? why can't we leverage on both?\nNote also that with VectorTile GEOMETRY_SIMPLIFICATION is causing invalid geometries as discussed here", "url": "https://github.com/geoserver/geoserver/pull/4264#discussion_r445031370", "createdAt": "2020-06-24T16:46:05Z", "author": {"login": "ccancellieri"}, "path": "src/extension/vectortiles/src/main/java/org/geoserver/wms/vector/PipelineBuilder.java", "diffHunk": "@@ -268,8 +278,27 @@ public PipelineBuilder transform(final boolean transformToScreenCoordinates) {\n      *\n      * @param isTransformToScreenCoordinates Use screen coordinate space simplification tolerance\n      */\n-    public PipelineBuilder simplify(boolean isTransformToScreenCoordinates) {\n+    public PipelineBuilder simplify(\n+            boolean isTransformToScreenCoordinates,\n+            final Set<RenderingHints.Key> fsHints,\n+            final Hints qHints) {\n \n+        if (fsHints != null && qHints != null) {\n+            // ... if possible we let the datastore do the generalization\n+            if (fsHints.contains(Hints.GEOMETRY_SIMPLIFICATION)) {\n+                // good, we don't need to perform in memory generalization, the datastore\n+                // does it all for us\n+                qHints.put(Hints.GEOMETRY_SIMPLIFICATION, context.sourceCRSSimplificationDistance);\n+\n+                return this;\n+\n+            } else if (fsHints.contains(Hints.GEOMETRY_DISTANCE)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0906d4a46a3b21f05b3615a791f53f1b7d7a2150"}, "originalPosition": 82}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0906d4a46a3b21f05b3615a791f53f1b7d7a2150", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/0906d4a46a3b21f05b3615a791f53f1b7d7a2150", "committedDate": "2020-06-22T17:14:37Z", "message": "[GEOS-9633] first draft\nintegrating with the pipeline builder\n\nleverage on target distance\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nfix WFS3 module build"}, "afterCommit": {"oid": "60a5ac89f1a37741b2a0c82a188348328fd32b25", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/60a5ac89f1a37741b2a0c82a188348328fd32b25", "committedDate": "2020-08-02T08:39:51Z", "message": "[GEOS-9633] first draft\nintegrating with the pipeline builder\n\nleverage on target distance\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nfix WFS3 module build\n\nFinalize pull request with tests and comments\n\nFinalize pull request with tests and comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "60a5ac89f1a37741b2a0c82a188348328fd32b25", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/60a5ac89f1a37741b2a0c82a188348328fd32b25", "committedDate": "2020-08-02T08:39:51Z", "message": "[GEOS-9633] first draft\nintegrating with the pipeline builder\n\nleverage on target distance\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nfix WFS3 module build\n\nFinalize pull request with tests and comments\n\nFinalize pull request with tests and comments"}, "afterCommit": {"oid": "3146247d5c366476f978c36a68934a285ca71ccb", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/3146247d5c366476f978c36a68934a285ca71ccb", "committedDate": "2020-08-03T07:31:28Z", "message": "[GEOS-9633] first draft\nintegrating with the pipeline builder\n\nleverage on target distance\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nfix WFS3 module build\n\nFinalize pull request with tests and comments\n\nFinalize pull request with tests and comments\n\nlet's startup again the pipeline"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3146247d5c366476f978c36a68934a285ca71ccb", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/3146247d5c366476f978c36a68934a285ca71ccb", "committedDate": "2020-08-03T07:31:28Z", "message": "[GEOS-9633] first draft\nintegrating with the pipeline builder\n\nleverage on target distance\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nfix WFS3 module build\n\nFinalize pull request with tests and comments\n\nFinalize pull request with tests and comments\n\nlet's startup again the pipeline"}, "afterCommit": {"oid": "7d132135997419cef530f968da6f978a5e2111bf", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/7d132135997419cef530f968da6f978a5e2111bf", "committedDate": "2020-08-03T15:48:34Z", "message": "[GEOS-9633] first draft\nintegrating with the pipeline builder\n\nleverage on target distance\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nfix WFS3 module build\n\nFinalize pull request with tests and comments\n\nFinalize pull request with tests and comments\n\nlet's startup again the pipeline"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d132135997419cef530f968da6f978a5e2111bf", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/7d132135997419cef530f968da6f978a5e2111bf", "committedDate": "2020-08-03T15:48:34Z", "message": "[GEOS-9633] first draft\nintegrating with the pipeline builder\n\nleverage on target distance\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nrefactor to reduce code duplication and variables\n\nfix WFS3 module build\n\nFinalize pull request with tests and comments\n\nFinalize pull request with tests and comments\n\nlet's startup again the pipeline"}, "afterCommit": {"oid": "79e58873102141ee7f52c2067ff7fb69c2ecb64d", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/79e58873102141ee7f52c2067ff7fb69c2ecb64d", "committedDate": "2020-08-05T16:32:58Z", "message": "[GEOS-9633] Provide Pre-Generalized support to VectorTile extension"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79e58873102141ee7f52c2067ff7fb69c2ecb64d", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/79e58873102141ee7f52c2067ff7fb69c2ecb64d", "committedDate": "2020-08-05T16:32:58Z", "message": "[GEOS-9633] Provide Pre-Generalized support to VectorTile extension"}, "afterCommit": {"oid": "cd9ed93db1475b4d7016856e56a459beed447373", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/cd9ed93db1475b4d7016856e56a459beed447373", "committedDate": "2020-08-06T17:07:07Z", "message": "[GEOS-9633] Provide Pre-Generalized support to VectorTile extension"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00d68dbeab7a938847c88455f43b7b0a9d2c3d85", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/00d68dbeab7a938847c88455f43b7b0a9d2c3d85", "committedDate": "2020-08-09T20:03:56Z", "message": "[GEOS-9633] Provide Pre-Generalized support to VectorTile extension"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd9ed93db1475b4d7016856e56a459beed447373", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/cd9ed93db1475b4d7016856e56a459beed447373", "committedDate": "2020-08-06T17:07:07Z", "message": "[GEOS-9633] Provide Pre-Generalized support to VectorTile extension"}, "afterCommit": {"oid": "00d68dbeab7a938847c88455f43b7b0a9d2c3d85", "author": {"user": {"login": "ccancellieri", "name": "Carlo Cancellieri"}}, "url": "https://github.com/geoserver/geoserver/commit/00d68dbeab7a938847c88455f43b7b0a9d2c3d85", "committedDate": "2020-08-09T20:03:56Z", "message": "[GEOS-9633] Provide Pre-Generalized support to VectorTile extension"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1447, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}