{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0OTU0NDQ2", "number": 4627, "title": "[GEOS-9830] Allow the possibility to define allowedArea in a SRID different from 4326 in geofence [GEOS-9831] Possibility to use SpatialFilter in Geofence also to clip features", "bodyText": "This pull request\n\nadds srid handling on allowed area (geofence) https://osgeo-org.atlassian.net/browse/GEOS-9830\nadds the possibility to define clip spatial filter (geofence) https://osgeo-org.atlassian.net/browse/GEOS-9831\nupdates geofence version https://osgeo-org.atlassian.net/browse/GEOS-9875\n\nblocked by geotools: https://osgeo-org.atlassian.net/browse/GEOT-6769\nChecklist\n\nReviewing is a process done by project maintainers, mostly on a volunteer basis. We try to keep the overhead as small as possible and appreciate if you help us to do so by completing the following items. Feel free to ask in a comment if you have troubles with any of them.\n\nSubmitting the PR does not require you to check all items, but by the time it gets merged, they should be either satisfied or not applicable.\nFor all pull requests:\n\n Confirm you have read the contribution guidelines\n You have sent a Contribution Licence Agreement (CLA) as necessary (not required for small changes, e.g., fixing typos in documentation)\n Make sure the first PR targets the master branch, eventual backports will be managed later. This can be ignored if the PR is fixing an issue that only happens in a specific branch, but not in newer ones.\n\nThe following are required only for core and extension modules (they are welcomed, but not required, for community modules):\n\n There is a ticket in Jira describing the issue/improvement/feature (a notable exemptions is, changes not visible to end users)\n PR for bug fixes and small new features are presented as a single commit\n Commit message must be in the form \"[GEOS-XYZW] Title of the Jira ticket\" (export to XML in Jira generates the message in this exact form)\n The pull request contains changes related to a single objective. If multiple focuses cannot be avoided, each one is in its own commit and has a separate ticket describing it.\n New unit tests have been added covering the changes\n This PR passes all existing unit tests (test results will be reported by Continuous Integration after opening this PR)\n This PR passes the QA checks (QA checks results will be reported by Continuous Integration after opening this PR)\n Commits changing the UI, existing user workflows, or adding new functionality, need to include documentation updates (screenshots, text)\n Commits changing the REST API, or any configuration object, should check if the REST API docs (Swagger YAML files and classic documentation) need to be updated.", "createdAt": "2020-12-23T17:36:49Z", "url": "https://github.com/geoserver/geoserver/pull/4627", "merged": true, "mergeCommit": {"oid": "bcf742065884f0ddeceee67e08beb995e5517a16"}, "closed": true, "closedAt": "2021-01-28T09:46:06Z", "author": {"login": "taba90"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqnXBhABqjQxNTIyMzQzMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdz5mfMABqjQyNTAxNjQzNTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10f778514012e685c608f0aca491d45a119307ae", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/10f778514012e685c608f0aca491d45a119307ae", "committedDate": "2020-12-23T17:30:43Z", "message": "[GEOS-9831] Possibility to use SpatialFilter in Geofence also to clip features"}, "afterCommit": {"oid": "78cad59622ec265f824f9ba9cce40df195cfe757", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/78cad59622ec265f824f9ba9cce40df195cfe757", "committedDate": "2020-12-28T14:53:10Z", "message": "[GEOS-9831] Possibility to use SpatialFilter in Geofence also to clip features"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "78cad59622ec265f824f9ba9cce40df195cfe757", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/78cad59622ec265f824f9ba9cce40df195cfe757", "committedDate": "2020-12-28T14:53:10Z", "message": "[GEOS-9831] Possibility to use SpatialFilter in Geofence also to clip features"}, "afterCommit": {"oid": "4c25e0340564f3c568f7c1896659e2adbd29eb39", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/4c25e0340564f3c568f7c1896659e2adbd29eb39", "committedDate": "2021-01-05T20:55:23Z", "message": "[GEOS-9831] Possibility to use SpatialFilter in Geofence also to clip features"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0NDQ0ODU1", "url": "https://github.com/geoserver/geoserver/pull/4627#pullrequestreview-564444855", "createdAt": "2021-01-08T17:25:07Z", "commit": {"oid": "4c25e0340564f3c568f7c1896659e2adbd29eb39"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOFQxNzoyNTowN1rOIQatGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOFQxNzoyNzo0OFrOIQayoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4NTY1Nw==", "bodyText": "As noted in the GeoTools PR, this approach is inefficient. Better to check if there is a intersectFilter while working in getReadQuery and \"and\" an intersection filter there, so that it send down to the data source for efficient processing.", "url": "https://github.com/geoserver/geoserver/pull/4627#discussion_r554085657", "createdAt": "2021-01-08T17:25:07Z", "author": {"login": "aaime"}, "path": "src/main/src/main/java/org/geoserver/security/decorators/SecuredFeatureSource.java", "diffHunk": "@@ -104,12 +105,37 @@ protected SecuredFeatureSource(FeatureSource<T, F> delegate, WrapperPolicy polic\n                                         + \"by security (because they are required by the schema). \"\n                                         + \"Either the security setup is broken or you have a security breach\");\n                     }\n-                    return SecuredObjects.secure(fc, policy);\n+                    result = SecuredObjects.secure(fc, policy);\n                 }\n             } else {\n-                return SecuredObjects.secure(fc, policy);\n+                result = SecuredObjects.secure(fc, policy);\n             }\n         }\n+        AccessLimits limits = policy.getLimits();\n+        if (limits instanceof VectorAccessLimits) {\n+            VectorAccessLimits vectorLimits = (VectorAccessLimits) limits;\n+            result = decoratesForClipping(vectorLimits, result);\n+        }\n+        return result;\n+    }\n+\n+    private FeatureCollection decoratesForClipping(\n+            VectorAccessLimits limits, FeatureCollection collection) {\n+        if (!(collection instanceof SimpleFeatureCollection))\n+            throw new RuntimeException(\"Cannot clip on Complex Features\");\n+        Geometry clipFilter = limits.getClipVectorFilter();\n+        Geometry intersectFilter = limits.getIntersectVectorFilter();\n+        if (clipFilter != null) {\n+            if (intersectFilter != null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c25e0340564f3c568f7c1896659e2adbd29eb39"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4NjIzNw==", "bodyText": "Actually, since there is read filter, wondering if GeoFence cannot just build the full read filter by itself, rather than adding this field. This would also simplify SecuredFeatureSource.", "url": "https://github.com/geoserver/geoserver/pull/4627#discussion_r554086237", "createdAt": "2021-01-08T17:26:08Z", "author": {"login": "aaime"}, "path": "src/main/src/main/java/org/geoserver/security/VectorAccessLimits.java", "diffHunk": "@@ -166,6 +183,22 @@ private void writeProperties(List<PropertyName> attributes, ObjectOutputStream o\n         }\n     }\n \n+    public Geometry getClipVectorFilter() {\n+        return clipVectorFilter;\n+    }\n+\n+    public void setClipVectorFilter(Geometry clipVectorFilter) {\n+        this.clipVectorFilter = clipVectorFilter;\n+    }\n+\n+    public Geometry getIntersectVectorFilter() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c25e0340564f3c568f7c1896659e2adbd29eb39"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4NzA3Mw==", "bodyText": "Ok so it seems to be already here. Why does it need to be added as a separate field too?", "url": "https://github.com/geoserver/geoserver/pull/4627#discussion_r554087073", "createdAt": "2021-01-08T17:27:48Z", "author": {"login": "aaime"}, "path": "src/extension/geofence/src/main/java/org/geoserver/geofence/GeofenceAccessManager.java", "diffHunk": "@@ -580,8 +661,12 @@ AccessLimits buildResourceAccessLimits(\n         AccessLimits accessLimits = null;\n         if (info instanceof FeatureTypeInfo) {\n             // merge the area among the filters\n-            if (reprojArea != null) {\n-                Filter areaFilter = FF.intersects(FF.property(\"\"), FF.literal(reprojArea));\n+            if (intersectsArea != null) {\n+                Filter areaFilter = FF.intersects(FF.property(\"\"), FF.literal(intersectsArea));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c25e0340564f3c568f7c1896659e2adbd29eb39"}, "originalPosition": 330}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c25e0340564f3c568f7c1896659e2adbd29eb39", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/4c25e0340564f3c568f7c1896659e2adbd29eb39", "committedDate": "2021-01-05T20:55:23Z", "message": "[GEOS-9831] Possibility to use SpatialFilter in Geofence also to clip features"}, "afterCommit": {"oid": "9e93439132ed4831c724e7de350459a35272eb93", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/9e93439132ed4831c724e7de350459a35272eb93", "committedDate": "2021-01-24T12:05:33Z", "message": "update geofence version"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e93439132ed4831c724e7de350459a35272eb93", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/9e93439132ed4831c724e7de350459a35272eb93", "committedDate": "2021-01-24T12:05:33Z", "message": "update geofence version"}, "afterCommit": {"oid": "e31d062cfeb6c4292969418177006b09c58170da", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/e31d062cfeb6c4292969418177006b09c58170da", "committedDate": "2021-01-25T10:03:26Z", "message": "update geofence version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc1MjcwOTM0", "url": "https://github.com/geoserver/geoserver/pull/4627#pullrequestreview-575270934", "createdAt": "2021-01-25T10:44:00Z", "commit": {"oid": "e31d062cfeb6c4292969418177006b09c58170da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQxMDo0NDowMVrOIZg6zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQxMDo0NDowMVrOIZg6zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzYyNDY1NA==", "bodyText": "This bit seems weird too. A multi-geometry is still cosidered \"one\", while here it's taken apart in smaller bits?\nSay the geometry is Italy and all its big and small islands, if I undrestand correctly, only the bits of that large multipolygon intersecting the geometry filter would be returned? That's now how spatial databases work, it's surprising behavior to me.", "url": "https://github.com/geoserver/geoserver/pull/4627#discussion_r563624654", "createdAt": "2021-01-25T10:44:01Z", "author": {"login": "aaime"}, "path": "src/main/src/main/java/org/geoserver/security/decorators/ClipIntersectsFeatureIterator.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+package org.geoserver.security.decorators;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.geotools.data.simple.SimpleFeatureIterator;\n+import org.geotools.feature.collection.ClippedFeatureIterator;\n+import org.locationtech.jts.geom.Geometry;\n+import org.locationtech.jts.geom.GeometryCollection;\n+import org.locationtech.jts.geom.GeometryFactory;\n+import org.locationtech.jts.geom.LineString;\n+import org.locationtech.jts.geom.MultiLineString;\n+import org.locationtech.jts.geom.MultiPoint;\n+import org.locationtech.jts.geom.MultiPolygon;\n+import org.locationtech.jts.geom.Point;\n+import org.locationtech.jts.geom.Polygon;\n+import org.opengis.feature.simple.SimpleFeature;\n+import org.opengis.feature.simple.SimpleFeatureType;\n+import org.opengis.feature.type.AttributeDescriptor;\n+import org.opengis.feature.type.GeometryDescriptor;\n+import org.opengis.feature.type.Name;\n+\n+/**\n+ * A SimpleFeatureCollection that can filter features' geometries by a clip (crop) spatialFilter and\n+ * by an intersects spatialFilter. If a geometry is hit by both the result of the two filters is\n+ * merged.\n+ */\n+class ClipIntersectsFeatureIterator extends ClippedFeatureIterator {\n+    private Geometry intersects;\n+\n+    /**\n+     * @param delegate delegate Iterator to be used as a delegate.\n+     * @param clip the geometry to be used to clip (crop features).\n+     * @param intersects the geometry to be used to intersects features.\n+     * @param schema the featureType\n+     * @param preserveZ flag to set to true if the clipping process should preserve the z dimension\n+     */\n+    ClipIntersectsFeatureIterator(\n+            SimpleFeatureIterator delegate,\n+            Geometry clip,\n+            Geometry intersects,\n+            SimpleFeatureType schema,\n+            boolean preserveZ) {\n+        super(delegate, clip, schema, preserveZ);\n+        this.intersects = intersects;\n+    }\n+\n+    @Override\n+    public boolean hasNext() {\n+\n+        while (next == null && delegate.hasNext()) {\n+            // try building the clipped feature out of the original feature, if the\n+            // default geometry is clipped out, skip it\n+            SimpleFeature f = delegate.next();\n+\n+            boolean doTheClip = intersects == null ? true : false;\n+\n+            Map<Name, Geometry> intersectedGeometries = null;\n+            if (intersects != null) {\n+                Map<Name, Geometry> geometryAttributes = extractGeometryAttributes(f);\n+                intersectedGeometries =\n+                        getIntersectingGeometries(geometryAttributes, f.getFeatureType());\n+                // if there is at least one geometryCollection or not all the geometry\n+                // attributes were intersected performs also the clip\n+                if (intersectedGeometries != null)\n+                    doTheClip =\n+                            intersectedGeometries\n+                                            .values()\n+                                            .stream()\n+                                            .anyMatch(g -> g instanceof GeometryCollection)\n+                                    || geometryAttributes.size() > intersectedGeometries.size();\n+            }\n+\n+            boolean clippedOut = false;\n+            if (doTheClip) clippedOut = prepareBuilderForNextFeature(f);\n+\n+            if (!clippedOut) {\n+                // build the next feature\n+                next = fb.buildFeature(f.getID());\n+                unionWithIntersected(intersectedGeometries);\n+\n+            } else if (intersectedGeometries != null && !intersectedGeometries.isEmpty()) {\n+                next = fb.buildFeature(f.getID());\n+                for (Name name : intersectedGeometries.keySet()) {\n+                    next.setAttribute(name, intersectedGeometries.get(name));\n+                }\n+            }\n+\n+            fb.reset();\n+        }\n+\n+        return next != null;\n+    }\n+\n+    // union the clipped geometries with the intersected one\n+    private void unionWithIntersected(Map<Name, Geometry> intersectedGeometries) {\n+        for (Name name : intersectedGeometries.keySet()) {\n+            Geometry intersected = intersectedGeometries.get(name);\n+            if (intersected != null && !intersected.isEmpty())\n+                next.setAttribute(name, ((Geometry) next.getAttribute(name)).union(intersected));\n+        }\n+    }\n+\n+    private Map<Name, Geometry> getIntersectingGeometries(\n+            Map<Name, Geometry> geometryAttributes, SimpleFeatureType type) {\n+        Map<Name, Geometry> intersectedGeometries = new HashMap<>();\n+        for (Name name : geometryAttributes.keySet()) {\n+            Geometry geom = geometryAttributes.get(name);\n+            if (geom instanceof GeometryCollection) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e31d062cfeb6c4292969418177006b09c58170da"}, "originalPosition": 126}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e9edfe82d199724ca94b3230b9ac57258dab0f2", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/6e9edfe82d199724ca94b3230b9ac57258dab0f2", "committedDate": "2021-01-25T12:06:25Z", "message": "review feedback applied"}, "afterCommit": {"oid": "d97a6388a65149c9d0fa7d4ed945f5ea1e997819", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/d97a6388a65149c9d0fa7d4ed945f5ea1e997819", "committedDate": "2021-01-25T15:54:49Z", "message": "review feedback applied"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85b45320ed8baa8e57316a5f6069c4482548af08", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/85b45320ed8baa8e57316a5f6069c4482548af08", "committedDate": "2021-01-26T09:20:22Z", "message": "[GEOS-9830] Allow the possibility to define allowedArea in a SRID different from 4326 in geofence"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d97a6388a65149c9d0fa7d4ed945f5ea1e997819", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/d97a6388a65149c9d0fa7d4ed945f5ea1e997819", "committedDate": "2021-01-25T15:54:49Z", "message": "review feedback applied"}, "afterCommit": {"oid": "d2511ab0015c0d2f42261043b22cb49b91b29673", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/d2511ab0015c0d2f42261043b22cb49b91b29673", "committedDate": "2021-01-26T10:04:58Z", "message": "review feedback applied"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b905c247b7382b32ceebe9fa8dafb80ac70ec6f", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/8b905c247b7382b32ceebe9fa8dafb80ac70ec6f", "committedDate": "2021-01-26T11:10:36Z", "message": "[GEOS-9831] Possibility to use SpatialFilter in Geofence also to clip features"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffb29deb2340aa13270eaef6e8ca631d6407008b", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/ffb29deb2340aa13270eaef6e8ca631d6407008b", "committedDate": "2021-01-26T11:12:55Z", "message": "[GEOS-9875] Update geofence version to 3.4.7"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2511ab0015c0d2f42261043b22cb49b91b29673", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/d2511ab0015c0d2f42261043b22cb49b91b29673", "committedDate": "2021-01-26T10:04:58Z", "message": "review feedback applied"}, "afterCommit": {"oid": "ffb29deb2340aa13270eaef6e8ca631d6407008b", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geoserver/geoserver/commit/ffb29deb2340aa13270eaef6e8ca631d6407008b", "committedDate": "2021-01-26T11:12:55Z", "message": "[GEOS-9875] Update geofence version to 3.4.7"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1501, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}