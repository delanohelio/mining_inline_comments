{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3Njk1ODU4", "number": 4074, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNjoyNjoxMlrODj30gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNjoyODo0M1rODj34XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTQxMzE1OnYy", "diffSide": "RIGHT", "path": "src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNjoyNjoxMlrOFv64Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxMDo0MToyN1rOFwa5og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MjA3MA==", "bodyText": "This resolution dance, is this the only place where it needs to happen? No usage in UI for example?", "url": "https://github.com/geoserver/geoserver/pull/4074#discussion_r385792070", "createdAt": "2020-02-28T16:26:12Z", "author": {"login": "aaime"}, "path": "src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java", "diffHunk": "@@ -293,4 +313,55 @@ private String findTitle(Layer layer, Catalog catalog) {\n         public BufferedImage legend;\n         public GetLegendGraphicRequest request;\n     }\n+\n+    private LegendInfo resolveLegendInfo(\n+            LegendInfo legendInfo, GetLegendGraphicRequest request, StyleInfo context) {\n+        if (legendInfo == null) {\n+            return null; // not available\n+        }\n+        String onlineResource = legendInfo.getOnlineResource();\n+        String baseUrl = request.getBaseUrl();\n+        if (onlineResource == null) {\n+            return null;\n+        }\n+        URL url = null;\n+        try {\n+            URI uri = new URI(onlineResource);\n+            GeoServerResourceLoader resources = wms.getCatalog().getResourceLoader();\n+            if (uri.isAbsolute()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0725832dfad77baa9322fe31fecb28a7f5e3bffa"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMxNjcwNg==", "bodyText": "No indeed it happens in the GetLegendGraphicKvpReader class. I change the code to use that method instead.", "url": "https://github.com/geoserver/geoserver/pull/4074#discussion_r386316706", "createdAt": "2020-03-02T10:41:27Z", "author": {"login": "taba90"}, "path": "src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java", "diffHunk": "@@ -293,4 +313,55 @@ private String findTitle(Layer layer, Catalog catalog) {\n         public BufferedImage legend;\n         public GetLegendGraphicRequest request;\n     }\n+\n+    private LegendInfo resolveLegendInfo(\n+            LegendInfo legendInfo, GetLegendGraphicRequest request, StyleInfo context) {\n+        if (legendInfo == null) {\n+            return null; // not available\n+        }\n+        String onlineResource = legendInfo.getOnlineResource();\n+        String baseUrl = request.getBaseUrl();\n+        if (onlineResource == null) {\n+            return null;\n+        }\n+        URL url = null;\n+        try {\n+            URI uri = new URI(onlineResource);\n+            GeoServerResourceLoader resources = wms.getCatalog().getResourceLoader();\n+            if (uri.isAbsolute()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MjA3MA=="}, "originalCommit": {"oid": "0725832dfad77baa9322fe31fecb28a7f5e3bffa"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTQxNjg4OnYy", "diffSide": "RIGHT", "path": "src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNjoyNzoxMlrOFv66gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxMDo0MTozOFrOFwa6GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MjY0MQ==", "bodyText": "Hmm... LegendInfo is part of the catalog configuration, are we sure that it can be modified just like this without side effects? Is it wrapped in a ModificationProxy at runtime? If so, unless it gets saved, there are no problems, otherwise, best to clone it before changing it.", "url": "https://github.com/geoserver/geoserver/pull/4074#discussion_r385792641", "createdAt": "2020-02-28T16:27:12Z", "author": {"login": "aaime"}, "path": "src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java", "diffHunk": "@@ -293,4 +313,55 @@ private String findTitle(Layer layer, Catalog catalog) {\n         public BufferedImage legend;\n         public GetLegendGraphicRequest request;\n     }\n+\n+    private LegendInfo resolveLegendInfo(\n+            LegendInfo legendInfo, GetLegendGraphicRequest request, StyleInfo context) {\n+        if (legendInfo == null) {\n+            return null; // not available\n+        }\n+        String onlineResource = legendInfo.getOnlineResource();\n+        String baseUrl = request.getBaseUrl();\n+        if (onlineResource == null) {\n+            return null;\n+        }\n+        URL url = null;\n+        try {\n+            URI uri = new URI(onlineResource);\n+            GeoServerResourceLoader resources = wms.getCatalog().getResourceLoader();\n+            if (uri.isAbsolute()) {\n+                if (baseUrl != null && onlineResource.startsWith(baseUrl + \"styles/\")) {\n+                    // convert relative to styles durectory\n+                    onlineResource = onlineResource.substring(baseUrl.length() + 7);\n+                } else {\n+                    legendInfo.setOnlineResource(new URL(onlineResource).toString());\n+                    return legendInfo; // an actual external graphic reference\n+                }\n+            } else {\n+                // not absolute, try relative to the style if available, otherwise search\n+                // in the styles directory\n+                if (context != null) {\n+                    GeoServerDataDirectory dd = new GeoServerDataDirectory(resources);\n+                    Resource styleParentResource = dd.get(context);\n+                    if (styleParentResource != null\n+                            && styleParentResource.getType() == Resource.Type.DIRECTORY) {\n+                        url =\n+                                URLs.fileToUrl(\n+                                        new File(\n+                                                styleParentResource.dir().getCanonicalPath(),\n+                                                onlineResource));\n+                    }\n+                }\n+            }\n+            if (url == null) {\n+                File styles = resources.findOrCreateDirectory(\"styles\");\n+                URL base = URLs.fileToUrl(styles);\n+                url = new URL(base, onlineResource);\n+            }\n+        } catch (Exception e) {\n+            return null; // Do not try this online resource\n+        }\n+        legendInfo.setOnlineResource(url.toExternalForm());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0725832dfad77baa9322fe31fecb28a7f5e3bffa"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMxNjgyNA==", "bodyText": "fixed", "url": "https://github.com/geoserver/geoserver/pull/4074#discussion_r386316824", "createdAt": "2020-03-02T10:41:38Z", "author": {"login": "taba90"}, "path": "src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java", "diffHunk": "@@ -293,4 +313,55 @@ private String findTitle(Layer layer, Catalog catalog) {\n         public BufferedImage legend;\n         public GetLegendGraphicRequest request;\n     }\n+\n+    private LegendInfo resolveLegendInfo(\n+            LegendInfo legendInfo, GetLegendGraphicRequest request, StyleInfo context) {\n+        if (legendInfo == null) {\n+            return null; // not available\n+        }\n+        String onlineResource = legendInfo.getOnlineResource();\n+        String baseUrl = request.getBaseUrl();\n+        if (onlineResource == null) {\n+            return null;\n+        }\n+        URL url = null;\n+        try {\n+            URI uri = new URI(onlineResource);\n+            GeoServerResourceLoader resources = wms.getCatalog().getResourceLoader();\n+            if (uri.isAbsolute()) {\n+                if (baseUrl != null && onlineResource.startsWith(baseUrl + \"styles/\")) {\n+                    // convert relative to styles durectory\n+                    onlineResource = onlineResource.substring(baseUrl.length() + 7);\n+                } else {\n+                    legendInfo.setOnlineResource(new URL(onlineResource).toString());\n+                    return legendInfo; // an actual external graphic reference\n+                }\n+            } else {\n+                // not absolute, try relative to the style if available, otherwise search\n+                // in the styles directory\n+                if (context != null) {\n+                    GeoServerDataDirectory dd = new GeoServerDataDirectory(resources);\n+                    Resource styleParentResource = dd.get(context);\n+                    if (styleParentResource != null\n+                            && styleParentResource.getType() == Resource.Type.DIRECTORY) {\n+                        url =\n+                                URLs.fileToUrl(\n+                                        new File(\n+                                                styleParentResource.dir().getCanonicalPath(),\n+                                                onlineResource));\n+                    }\n+                }\n+            }\n+            if (url == null) {\n+                File styles = resources.findOrCreateDirectory(\"styles\");\n+                URL base = URLs.fileToUrl(styles);\n+                url = new URL(base, onlineResource);\n+            }\n+        } catch (Exception e) {\n+            return null; // Do not try this online resource\n+        }\n+        legendInfo.setOnlineResource(url.toExternalForm());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MjY0MQ=="}, "originalCommit": {"oid": "0725832dfad77baa9322fe31fecb28a7f5e3bffa"}, "originalPosition": 125}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTQxOTEzOnYy", "diffSide": "RIGHT", "path": "src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNjoyNzo0OVrOFv671w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxMDo0MTo0N1rOFwa6Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5Mjk4Mw==", "bodyText": "GeoServer is prone to have dangling style references, best to filter out null styles in this loop.", "url": "https://github.com/geoserver/geoserver/pull/4074#discussion_r385792983", "createdAt": "2020-02-28T16:27:49Z", "author": {"login": "aaime"}, "path": "src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java", "diffHunk": "@@ -101,6 +107,22 @@ public Dimension findOptimalSize(Graphics2D g2d, WMSMapContent mapContext) {\n                 request.setKvp(dispatcherRequest.getKvp());\n                 request.setRawKvp(dispatcherRequest.getRawKvp());\n             }\n+            // online resource handling\n+            LayerInfo info = wms.getLayerByName(layer.getTitle());\n+            StyleInfo defaultStyle = info.getDefaultStyle();\n+            StyleInfo sInfo =\n+                    info.getStyles()\n+                            .stream()\n+                            .filter(s -> s.getName().equals(layer.getStyle().getName()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0725832dfad77baa9322fe31fecb28a7f5e3bffa"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMxNjkwMw==", "bodyText": "fixed", "url": "https://github.com/geoserver/geoserver/pull/4074#discussion_r386316903", "createdAt": "2020-03-02T10:41:47Z", "author": {"login": "taba90"}, "path": "src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java", "diffHunk": "@@ -101,6 +107,22 @@ public Dimension findOptimalSize(Graphics2D g2d, WMSMapContent mapContext) {\n                 request.setKvp(dispatcherRequest.getKvp());\n                 request.setRawKvp(dispatcherRequest.getRawKvp());\n             }\n+            // online resource handling\n+            LayerInfo info = wms.getLayerByName(layer.getTitle());\n+            StyleInfo defaultStyle = info.getDefaultStyle();\n+            StyleInfo sInfo =\n+                    info.getStyles()\n+                            .stream()\n+                            .filter(s -> s.getName().equals(layer.getStyle().getName()))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5Mjk4Mw=="}, "originalCommit": {"oid": "0725832dfad77baa9322fe31fecb28a7f5e3bffa"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTQyMzAwOnYy", "diffSide": "RIGHT", "path": "src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNjoyODo0M1rOFv6-MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxMDo0MTo1OFrOFwa6xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MzU4NA==", "bodyText": "All this preparation is done to get the LegendInfo, right? If so, best to move it in a separate method, and just return the legend info, without cluttering this method with otherwise unused variables.", "url": "https://github.com/geoserver/geoserver/pull/4074#discussion_r385793584", "createdAt": "2020-02-28T16:28:43Z", "author": {"login": "aaime"}, "path": "src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java", "diffHunk": "@@ -101,6 +107,22 @@ public Dimension findOptimalSize(Graphics2D g2d, WMSMapContent mapContext) {\n                 request.setKvp(dispatcherRequest.getKvp());\n                 request.setRawKvp(dispatcherRequest.getRawKvp());\n             }\n+            // online resource handling\n+            LayerInfo info = wms.getLayerByName(layer.getTitle());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0725832dfad77baa9322fe31fecb28a7f5e3bffa"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMxNjk5OA==", "bodyText": "applied", "url": "https://github.com/geoserver/geoserver/pull/4074#discussion_r386316998", "createdAt": "2020-03-02T10:41:58Z", "author": {"login": "taba90"}, "path": "src/wms/src/main/java/org/geoserver/wms/decoration/LegendDecoration.java", "diffHunk": "@@ -101,6 +107,22 @@ public Dimension findOptimalSize(Graphics2D g2d, WMSMapContent mapContext) {\n                 request.setKvp(dispatcherRequest.getKvp());\n                 request.setRawKvp(dispatcherRequest.getRawKvp());\n             }\n+            // online resource handling\n+            LayerInfo info = wms.getLayerByName(layer.getTitle());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5MzU4NA=="}, "originalCommit": {"oid": "0725832dfad77baa9322fe31fecb28a7f5e3bffa"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4092, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}