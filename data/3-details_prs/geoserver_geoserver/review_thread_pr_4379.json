{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MDM1MzQ5", "number": 4379, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNzozMDozM1rOELTY8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNzo0MTo0NVrOELTerg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMjg3NDcyOnYy", "diffSide": "RIGHT", "path": "src/main/src/main/java/org/geoserver/catalog/Predicates.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNzozMDozM1rOGs1fjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNzozMDozM1rOGs1fjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY2Njk1OA==", "bodyText": "Why not \ud83e\udd23.", "url": "https://github.com/geoserver/geoserver/pull/4379#discussion_r449666958", "createdAt": "2020-07-03T17:30:33Z", "author": {"login": "nmco"}, "path": "src/main/src/main/java/org/geoserver/catalog/Predicates.java", "diffHunk": "@@ -218,6 +219,17 @@ public static Filter and(Filter op1, Filter op2) {\n         return factory.and(children);\n     }\n \n+    /**\n+     * Returns a negated filter. If the filter was already a negation, its child fiter will be\n+     * returned instead (simplifying out the double negation)\n+     */\n+    public static Filter not(Filter filter) {\n+        if (filter instanceof Not) {\n+            return ((Not) filter).getFilter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83f975dc3084b256fcfcc635123c627996802740"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMjg3ODI3OnYy", "diffSide": "RIGHT", "path": "src/main/src/main/java/org/geoserver/security/impl/DefaultResourceAccessManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNzozMzoyOVrOGs1hpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNzozMzoyOVrOGs1hpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY2NzQ5Mg==", "bodyText": "I see the filter was missing.", "url": "https://github.com/geoserver/geoserver/pull/4379#discussion_r449667492", "createdAt": "2020-07-03T17:33:29Z", "author": {"login": "nmco"}, "path": "src/main/src/main/java/org/geoserver/security/impl/DefaultResourceAccessManager.java", "diffHunk": "@@ -562,14 +562,27 @@ public Filter getSecurityFilter(Authentication user, Class<? extends CatalogInfo\n                         wsNode.getChildren().entrySet()) {\n                     String layerName = layerEntry.getKey();\n                     SecureTreeNode layerNode = layerEntry.getValue();\n+                    String prefixedName = wsName + \":\" + layerName;\n+                    Filter typeFilter = getTypeFilter(prefixedName, clazz);\n+                    if (typeFilter == null) {\n+                        // dangling rule, referencing a non existing layer/group, continue\n+                        continue;\n+                    }\n+\n                     boolean layerAccess = canAccess(user, layerNode);\n                     if (layerAccess != wsAccess) {\n                         if (wsAccess) {\n                             layerExceptions.add(\n-                                    Predicates.notEqual(\"prefixedName\", wsName + \":\" + layerName));\n+                                    Predicates.not(\n+                                            Predicates.and(\n+                                                    typeFilter,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83f975dc3084b256fcfcc635123c627996802740"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMjg4OTQyOnYy", "diffSide": "RIGHT", "path": "src/main/src/main/java/org/geoserver/security/impl/DefaultResourceAccessManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNzo0MTo0NVrOGs1nzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNzo0MTo0NVrOGs1nzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY2OTA2OA==", "bodyText": "Basically we want o exclude layer groups right?", "url": "https://github.com/geoserver/geoserver/pull/4379#discussion_r449669068", "createdAt": "2020-07-03T17:41:45Z", "author": {"login": "nmco"}, "path": "src/main/src/main/java/org/geoserver/security/impl/DefaultResourceAccessManager.java", "diffHunk": "@@ -641,6 +644,20 @@ public Filter getSecurityFilter(Authentication user, Class<? extends CatalogInfo\n         }\n     }\n \n+    private Filter getTypeFilter(String prefixedName, Class clazz) {\n+        if (rawCatalog.getLayerByName(prefixedName) != null)\n+            if (clazz.equals(PublishedInfo.class)) {\n+                // restrict to layers in this case\n+                return Predicates.isInstanceOf(LayerInfo.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83f975dc3084b256fcfcc635123c627996802740"}, "originalPosition": 57}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3960, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}