{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyOTcwMzQ0", "number": 738, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNDoxNjowMFrOEcFzag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwODo0Mjo1NFrOEdjRjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODkwNjY2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNDoxNjowMFrOHGaQCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjo0OTo0MlrOHKAidQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4MzU5Mw==", "bodyText": "Should add an 'else' before if?", "url": "https://github.com/vmware/singleton/pull/738#discussion_r476483593", "createdAt": "2020-08-25T14:16:00Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -105,14 +105,19 @@ public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n+    \t\tif (cacheItem.getCachedData().isEmpty()) { // This means that the data to be used is from a fallback locale.\n+\t\t\t\t// If expired, try to first create and store cacheItem for the requested locale in a separate thread.\n+\t\t\t\tif (cacheItem.isExpired())\n+\t\t\t\t\tthis.createCacheItemTask(fallbackLocalesIter);\n+\n+    \t\t\t// Use cached data of cacheItem.getLocale() --> fallback locale\n+\t\t\t\tMessagesDTO fallbackLocaleDTO = new MessagesDTO(dto.getComponent(), cacheItem.getLocale(), dto.getProductID(), dto.getVersion());\n+\t\t\t\tcacheItem = new ComponentService(fallbackLocaleDTO).getMessages(null);\n+\t\t\t}\n+\t\t\tif (cacheItem.isExpired()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9935a6c9a2230700023edd56f9442c1adf12d4e8"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQzNjI0Nw==", "bodyText": "No, we still want to refresh expired cacheItem even if it is for the fallback locale (returned in line 115).", "url": "https://github.com/vmware/singleton/pull/738#discussion_r477436247", "createdAt": "2020-08-26T16:36:46Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -105,14 +105,19 @@ public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n+    \t\tif (cacheItem.getCachedData().isEmpty()) { // This means that the data to be used is from a fallback locale.\n+\t\t\t\t// If expired, try to first create and store cacheItem for the requested locale in a separate thread.\n+\t\t\t\tif (cacheItem.isExpired())\n+\t\t\t\t\tthis.createCacheItemTask(fallbackLocalesIter);\n+\n+    \t\t\t// Use cached data of cacheItem.getLocale() --> fallback locale\n+\t\t\t\tMessagesDTO fallbackLocaleDTO = new MessagesDTO(dto.getComponent(), cacheItem.getLocale(), dto.getProductID(), dto.getVersion());\n+\t\t\t\tcacheItem = new ComponentService(fallbackLocaleDTO).getMessages(null);\n+\t\t\t}\n+\t\t\tif (cacheItem.isExpired()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4MzU5Mw=="}, "originalCommit": {"oid": "9935a6c9a2230700023edd56f9442c1adf12d4e8"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ1Mjg0Ng==", "bodyText": "Lines 117-119 is actually not new. It is the fix for #664 and #662\nLines 108-116 is only a replacement for lines 113-115 of old code. See that in old code, there is also no \"else\", only 2 \"ifs\"", "url": "https://github.com/vmware/singleton/pull/738#discussion_r477452846", "createdAt": "2020-08-26T17:02:29Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -105,14 +105,19 @@ public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n+    \t\tif (cacheItem.getCachedData().isEmpty()) { // This means that the data to be used is from a fallback locale.\n+\t\t\t\t// If expired, try to first create and store cacheItem for the requested locale in a separate thread.\n+\t\t\t\tif (cacheItem.isExpired())\n+\t\t\t\t\tthis.createCacheItemTask(fallbackLocalesIter);\n+\n+    \t\t\t// Use cached data of cacheItem.getLocale() --> fallback locale\n+\t\t\t\tMessagesDTO fallbackLocaleDTO = new MessagesDTO(dto.getComponent(), cacheItem.getLocale(), dto.getProductID(), dto.getVersion());\n+\t\t\t\tcacheItem = new ComponentService(fallbackLocaleDTO).getMessages(null);\n+\t\t\t}\n+\t\t\tif (cacheItem.isExpired()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4MzU5Mw=="}, "originalCommit": {"oid": "9935a6c9a2230700023edd56f9442c1adf12d4e8"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk3NDExNw==", "bodyText": "I think it's necessary to add it because the cache of fallback locale will be refreshed in line 115 because of the call getMessages with default locale.\nIf no 'else', it will be refreshed twice, right?", "url": "https://github.com/vmware/singleton/pull/738#discussion_r478974117", "createdAt": "2020-08-28T08:58:53Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -105,14 +105,19 @@ public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n+    \t\tif (cacheItem.getCachedData().isEmpty()) { // This means that the data to be used is from a fallback locale.\n+\t\t\t\t// If expired, try to first create and store cacheItem for the requested locale in a separate thread.\n+\t\t\t\tif (cacheItem.isExpired())\n+\t\t\t\t\tthis.createCacheItemTask(fallbackLocalesIter);\n+\n+    \t\t\t// Use cached data of cacheItem.getLocale() --> fallback locale\n+\t\t\t\tMessagesDTO fallbackLocaleDTO = new MessagesDTO(dto.getComponent(), cacheItem.getLocale(), dto.getProductID(), dto.getVersion());\n+\t\t\t\tcacheItem = new ComponentService(fallbackLocaleDTO).getMessages(null);\n+\t\t\t}\n+\t\t\tif (cacheItem.isExpired()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4MzU5Mw=="}, "originalCommit": {"oid": "9935a6c9a2230700023edd56f9442c1adf12d4e8"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI1NjYyOQ==", "bodyText": "You are right. I have updated it.", "url": "https://github.com/vmware/singleton/pull/738#discussion_r480256629", "createdAt": "2020-08-31T16:49:42Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -105,14 +105,19 @@ public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n+    \t\tif (cacheItem.getCachedData().isEmpty()) { // This means that the data to be used is from a fallback locale.\n+\t\t\t\t// If expired, try to first create and store cacheItem for the requested locale in a separate thread.\n+\t\t\t\tif (cacheItem.isExpired())\n+\t\t\t\t\tthis.createCacheItemTask(fallbackLocalesIter);\n+\n+    \t\t\t// Use cached data of cacheItem.getLocale() --> fallback locale\n+\t\t\t\tMessagesDTO fallbackLocaleDTO = new MessagesDTO(dto.getComponent(), cacheItem.getLocale(), dto.getProductID(), dto.getVersion());\n+\t\t\t\tcacheItem = new ComponentService(fallbackLocaleDTO).getMessages(null);\n+\t\t\t}\n+\t\t\tif (cacheItem.isExpired()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4MzU5Mw=="}, "originalCommit": {"oid": "9935a6c9a2230700023edd56f9442c1adf12d4e8"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5NDIyMDk1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwODo0Mjo1NFrOHIxA0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMDo0ODoxNFrOHKIs7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk1MzY4Mw==", "bodyText": "For creating second time, it doesn't need to do fallback. How about using 'resreshCache' without locale fallback? This will improve performance.", "url": "https://github.com/vmware/singleton/pull/738#discussion_r478953683", "createdAt": "2020-08-28T08:42:54Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -105,14 +105,19 @@ public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n+    \t\tif (cacheItem.getCachedData().isEmpty()) { // This means that the data to be used is from a fallback locale.\n+\t\t\t\t// If expired, try to first create and store cacheItem for the requested locale in a separate thread.\n+\t\t\t\tif (cacheItem.isExpired())\n+\t\t\t\t\tthis.createCacheItemTask(fallbackLocalesIter);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9935a6c9a2230700023edd56f9442c1adf12d4e8"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM5MDM4MQ==", "bodyText": "Changed line 111 to this.createCacheItemTask(null); Passing null means locale fallback will not be applied.", "url": "https://github.com/vmware/singleton/pull/738#discussion_r480390381", "createdAt": "2020-08-31T20:48:14Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -105,14 +105,19 @@ public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n+    \t\tif (cacheItem.getCachedData().isEmpty()) { // This means that the data to be used is from a fallback locale.\n+\t\t\t\t// If expired, try to first create and store cacheItem for the requested locale in a separate thread.\n+\t\t\t\tif (cacheItem.isExpired())\n+\t\t\t\t\tthis.createCacheItemTask(fallbackLocalesIter);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk1MzY4Mw=="}, "originalCommit": {"oid": "9935a6c9a2230700023edd56f9442c1adf12d4e8"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4518, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}