{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5Nzk2MTM5", "number": 673, "reviewThreads": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwMjo0NToyOVrOEO8PPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNToxMDowMVrOETGJww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MTAyNDYwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwMjo0NToyOVrOGyYGbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQyMjo0MToyMlrOGy_Pzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3Njg0NQ==", "bodyText": "Don't need to pass msgSourceQueueIter because the invoked methods can get it from config.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r455476845", "createdAt": "2020-07-16T02:45:29Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +51,39 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "beab1483a10b248c243fe2c3c6dc63107d8204f2"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjExODIyMg==", "bodyText": "The iterator needs to be a parameter so that it can be used in the recursive method call (which I forgot to include -- I have just added it now)", "url": "https://github.com/vmware/singleton/pull/673#discussion_r456118222", "createdAt": "2020-07-16T22:41:22Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +51,39 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3Njg0NQ=="}, "originalCommit": {"oid": "beab1483a10b248c243fe2c3c6dc63107d8204f2"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MTAyNjMxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwMjo0NjozOFrOGyYHhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQyMjo0MjozMFrOGy_RRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3NzEyNg==", "bodyText": "If the map is empty, still need to get from the next iter in the queue.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r455477126", "createdAt": "2020-07-16T02:46:38Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +51,39 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    dto.setComponent(((String) component).trim());\n+                    dto.setLocale(LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim());\n+                    Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    private Map<String, String> getLanguages(Iterator<DataSourceEnum> msgSourceQueueIter) {\n+        if (!msgSourceQueueIter.hasNext())\n+            return null;\n+\n+        DataSourceEnum dataSource = msgSourceQueueIter.next();\n+        LocaleOpt opt = dataSource.createLocaleOpt();\n+        return opt.getLanguages(LocaleUtility.getDefaultLocale().toLanguageTag());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "beab1483a10b248c243fe2c3c6dc63107d8204f2"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjExODU5OQ==", "bodyText": "Fixed.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r456118599", "createdAt": "2020-07-16T22:42:30Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +51,39 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    dto.setComponent(((String) component).trim());\n+                    dto.setLocale(LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim());\n+                    Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    private Map<String, String> getLanguages(Iterator<DataSourceEnum> msgSourceQueueIter) {\n+        if (!msgSourceQueueIter.hasNext())\n+            return null;\n+\n+        DataSourceEnum dataSource = msgSourceQueueIter.next();\n+        LocaleOpt opt = dataSource.createLocaleOpt();\n+        return opt.getLanguages(LocaleUtility.getDefaultLocale().toLanguageTag());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3NzEyNg=="}, "originalCommit": {"oid": "beab1483a10b248c243fe2c3c6dc63107d8204f2"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MTAyNzA4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwMjo0NzowMFrOGyYH-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQyMjo0Mjo0MFrOGy_ReA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3NzI0MA==", "bodyText": "If the return value is empty, still need to get from the next iter in the queue.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r455477240", "createdAt": "2020-07-16T02:47:00Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +51,39 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    dto.setComponent(((String) component).trim());\n+                    dto.setLocale(LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim());\n+                    Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    private Map<String, String> getLanguages(Iterator<DataSourceEnum> msgSourceQueueIter) {\n+        if (!msgSourceQueueIter.hasNext())\n+            return null;\n+\n+        DataSourceEnum dataSource = msgSourceQueueIter.next();\n+        LocaleOpt opt = dataSource.createLocaleOpt();\n+        return opt.getLanguages(LocaleUtility.getDefaultLocale().toLanguageTag());\n+    }\n+\n+    private List<String> getComponents (Iterator<DataSourceEnum> msgSourceQueueIter) {\n+        if (!msgSourceQueueIter.hasNext())\n+            return null;\n+\n+        DataSourceEnum dataSource = msgSourceQueueIter.next();\n+        ComponentOpt opt = dataSource.createComponentOpt(dto);\n+        return opt.getComponents();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "beab1483a10b248c243fe2c3c6dc63107d8204f2"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjExODY0OA==", "bodyText": "Fixed.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r456118648", "createdAt": "2020-07-16T22:42:40Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +51,39 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    dto.setComponent(((String) component).trim());\n+                    dto.setLocale(LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim());\n+                    Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    private Map<String, String> getLanguages(Iterator<DataSourceEnum> msgSourceQueueIter) {\n+        if (!msgSourceQueueIter.hasNext())\n+            return null;\n+\n+        DataSourceEnum dataSource = msgSourceQueueIter.next();\n+        LocaleOpt opt = dataSource.createLocaleOpt();\n+        return opt.getLanguages(LocaleUtility.getDefaultLocale().toLanguageTag());\n+    }\n+\n+    private List<String> getComponents (Iterator<DataSourceEnum> msgSourceQueueIter) {\n+        if (!msgSourceQueueIter.hasNext())\n+            return null;\n+\n+        DataSourceEnum dataSource = msgSourceQueueIter.next();\n+        ComponentOpt opt = dataSource.createComponentOpt(dto);\n+        return opt.getComponents();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3NzI0MA=="}, "originalCommit": {"oid": "beab1483a10b248c243fe2c3c6dc63107d8204f2"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MTAzOTA5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/api/opt/local/LocalComponentOpt.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwMjo1NDozNVrOGyYPSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxOTo0MzowMFrOGy6D6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3OTExNQ==", "bodyText": "It seems all the folder under the root are added rather the components belong to the product and version. Please check.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r455479115", "createdAt": "2020-07-16T02:54:35Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/api/opt/local/LocalComponentOpt.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.vmware.vipclient.i18n.messages.api.opt.local;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.nio.file.*;\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.stream.Stream;\n+\n+import com.vmware.vipclient.i18n.VIPCfg;\n+import com.vmware.vipclient.i18n.messages.api.opt.ComponentOpt;\n+import com.vmware.vipclient.i18n.messages.dto.BaseDTO;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class LocalComponentOpt implements ComponentOpt {\n+    private Logger logger = LoggerFactory.getLogger(LocalComponentOpt.class);\n+    private BaseDTO dto;\n+    public LocalComponentOpt(BaseDTO dto) {\n+        this.dto = dto;\n+    }\n+\n+    @Override\n+    public List<String> getComponents() {\n+        List<String> components = new LinkedList<String>();\n+        try {\n+\n+            Path path = Paths.get(VIPCfg.getInstance().getOfflineResourcesBaseUrl());\n+\n+            URI uri = Thread.currentThread().getContextClassLoader().\n+                    getResource(path.toString()).toURI();\n+\n+            if (uri.getScheme().equals(\"jar\")) {\n+                try (FileSystem fileSystem = FileSystems.newFileSystem(uri, Collections.<String, Object>emptyMap())) {\n+                    path = fileSystem.getPath(path.toString());\n+                    getComponents(path, components);\n+                }\n+            } else {\n+                path = Paths.get(uri);\n+                getComponents(path, components);\n+            }\n+\n+        } catch (Exception e) {\n+            logger.debug(e.getMessage());\n+        }\n+        return components;\n+    }\n+\n+    private void getComponents(Path path, List<String> components) throws IOException {\n+        try (Stream<Path> listOfFiles = Files.walk(path).filter(p -> !Files.isRegularFile(p))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "beab1483a10b248c243fe2c3c6dc63107d8204f2"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAzMzI1OQ==", "bodyText": "There is no \"product\" or \"version\" in offline mode. Directly under the offlineResourcesBaseUrl are the component folders.\nIt was incorrectly including the offlineResourcesBaseUrl in the result. I have just fixed that. I have also added tests.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r456033259", "createdAt": "2020-07-16T19:43:00Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/api/opt/local/LocalComponentOpt.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.vmware.vipclient.i18n.messages.api.opt.local;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.nio.file.*;\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.stream.Stream;\n+\n+import com.vmware.vipclient.i18n.VIPCfg;\n+import com.vmware.vipclient.i18n.messages.api.opt.ComponentOpt;\n+import com.vmware.vipclient.i18n.messages.dto.BaseDTO;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class LocalComponentOpt implements ComponentOpt {\n+    private Logger logger = LoggerFactory.getLogger(LocalComponentOpt.class);\n+    private BaseDTO dto;\n+    public LocalComponentOpt(BaseDTO dto) {\n+        this.dto = dto;\n+    }\n+\n+    @Override\n+    public List<String> getComponents() {\n+        List<String> components = new LinkedList<String>();\n+        try {\n+\n+            Path path = Paths.get(VIPCfg.getInstance().getOfflineResourcesBaseUrl());\n+\n+            URI uri = Thread.currentThread().getContextClassLoader().\n+                    getResource(path.toString()).toURI();\n+\n+            if (uri.getScheme().equals(\"jar\")) {\n+                try (FileSystem fileSystem = FileSystems.newFileSystem(uri, Collections.<String, Object>emptyMap())) {\n+                    path = fileSystem.getPath(path.toString());\n+                    getComponents(path, components);\n+                }\n+            } else {\n+                path = Paths.get(uri);\n+                getComponents(path, components);\n+            }\n+\n+        } catch (Exception e) {\n+            logger.debug(e.getMessage());\n+        }\n+        return components;\n+    }\n+\n+    private void getComponents(Path path, List<String> components) throws IOException {\n+        try (Stream<Path> listOfFiles = Files.walk(path).filter(p -> !Files.isRegularFile(p))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3OTExNQ=="}, "originalCommit": {"oid": "beab1483a10b248c243fe2c3c6dc63107d8204f2"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NTQ4Mjc4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMTo0ODo1NFrOGzCmaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxODo1NDozOVrOG26UjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3MzE2MA==", "bodyText": "Internally, client use English.\nLike in CLDR, all the characters are English.\nSo don't need to provide locale as a parameter. Just get English locale names  from bundles.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r456173160", "createdAt": "2020-07-17T01:48:54Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +56,63 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    dto.setComponent(((String) component).trim());\n+                    dto.setLocale(LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim());\n+                    dto.setProductID(VIPCfg.getInstance().getProductName());\n+                    dto.setVersion(VIPCfg.getInstance().getVersion());\n+                    Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    private Map<String, String> getLanguages(Iterator<DataSourceEnum> msgSourceQueueIter) {\n+        if (!msgSourceQueueIter.hasNext())\n+            return null;\n+\n+        DataSourceEnum dataSource = msgSourceQueueIter.next();\n+        LocaleOpt opt = dataSource.createLocaleOpt();\n+        Map<String, String> languages =  opt.getLanguages(LocaleUtility.getDefaultLocale().toLanguageTag());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0NDEzOA==", "bodyText": "@Xiaochao8 , what do you mean by \"get English locale names from bundles\"? We do not even have the English display name inside the bundle.\nI use Java's Locale.forLanguageTag to get the display name in case of offline mode: Locale inLocale = Locale.forLanguageTag(displayLanguage); \nAs much as possible, I do not want to hardcode English (or any language) anywhere in the client library. Anyway, only the language tags (keys) are used for now. The display names (values) are not used, but can potentially be used later if the result has to be displayed to the user.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r457544138", "createdAt": "2020-07-20T16:35:48Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +56,63 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    dto.setComponent(((String) component).trim());\n+                    dto.setLocale(LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim());\n+                    dto.setProductID(VIPCfg.getInstance().getProductName());\n+                    dto.setVersion(VIPCfg.getInstance().getVersion());\n+                    Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    private Map<String, String> getLanguages(Iterator<DataSourceEnum> msgSourceQueueIter) {\n+        if (!msgSourceQueueIter.hasNext())\n+            return null;\n+\n+        DataSourceEnum dataSource = msgSourceQueueIter.next();\n+        LocaleOpt opt = dataSource.createLocaleOpt();\n+        Map<String, String> languages =  opt.getLanguages(LocaleUtility.getDefaultLocale().toLanguageTag());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3MzE2MA=="}, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYwMDc5Ng==", "bodyText": "We get supported locales from bundle file names trimmed prefix 'messages_' and suffix '.json'. This has nothing to do with display language. It's pure English and must be consistent with bundle file names.\nThese locale names are used to query translation.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r458600796", "createdAt": "2020-07-22T07:48:08Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +56,63 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    dto.setComponent(((String) component).trim());\n+                    dto.setLocale(LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim());\n+                    dto.setProductID(VIPCfg.getInstance().getProductName());\n+                    dto.setVersion(VIPCfg.getInstance().getVersion());\n+                    Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    private Map<String, String> getLanguages(Iterator<DataSourceEnum> msgSourceQueueIter) {\n+        if (!msgSourceQueueIter.hasNext())\n+            return null;\n+\n+        DataSourceEnum dataSource = msgSourceQueueIter.next();\n+        LocaleOpt opt = dataSource.createLocaleOpt();\n+        Map<String, String> languages =  opt.getLanguages(LocaleUtility.getDefaultLocale().toLanguageTag());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3MzE2MA=="}, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0MzQ5NQ==", "bodyText": "I think you may be confused between locale's \"name\" (display name) and locale's \"language tag\".\nIn a bundle named messages_en.json, the suffix 'en' is the \"language tag\", not the \"display name\". The display name would be \"English\" if the display language is \"en\". If the display language is \"es\", the display name would be \"Ingles\".\nSo where in the bundle file can we get the word \"English\"/ \"Ingles\" ?\nWhat is \"pure English\" that you are talking about? The bundle file name only has language tags, not display names. The language tag \"en\" can be displayed in many languages as \"English\", \"Ingles\", \"Anglais\", etc. which all refer to the same \"en\" language.\nLocale names are not used to query translation. Language tags are used to query translation. However, locale names (display names) can be used later on if in the future, the list of supported locales has to be displayed to the user.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r459543495", "createdAt": "2020-07-23T15:38:09Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +56,63 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    dto.setComponent(((String) component).trim());\n+                    dto.setLocale(LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim());\n+                    dto.setProductID(VIPCfg.getInstance().getProductName());\n+                    dto.setVersion(VIPCfg.getInstance().getVersion());\n+                    Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    private Map<String, String> getLanguages(Iterator<DataSourceEnum> msgSourceQueueIter) {\n+        if (!msgSourceQueueIter.hasNext())\n+            return null;\n+\n+        DataSourceEnum dataSource = msgSourceQueueIter.next();\n+        LocaleOpt opt = dataSource.createLocaleOpt();\n+        Map<String, String> languages =  opt.getLanguages(LocaleUtility.getDefaultLocale().toLanguageTag());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3MzE2MA=="}, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0ODExMg==", "bodyText": "To further explain \"display names\" to you, here is part of the getSupportedLocales response from the service with display language = es.\n\"languages\": [\n{\n\"languageTag\": \"en\",\n\"displayName\": \"ingl\u00e9s\",\n\"displayName_sentenceBeginning\": \"Ingl\u00e9s\",\n\"displayName_uiListOrMenu\": \"Ingl\u00e9s\",\n\"displayName_standalone\": \"Ingl\u00e9s\"\n},\n{\n\"languageTag\": \"de\",\n\"displayName\": \"alem\u00e1n\",\n\"displayName_sentenceBeginning\": \"Alem\u00e1n\",\n\"displayName_uiListOrMenu\": \"Alem\u00e1n\",\n\"displayName_standalone\": \"Alem\u00e1n\"\n},\n{\n\"languageTag\": \"zh-Hans\",\n\"displayName\": \"chino simplificado\",\n\"displayName_sentenceBeginning\": \"Chino simplificado\",\n\"displayName_uiListOrMenu\": \"Chino simplificado\",\n\"displayName_standalone\": \"Chino simplificado\"\n},\n{\n\"languageTag\": \"ja\",\n\"displayName\": \"japon\u00e9s\",\n\"displayName_sentenceBeginning\": \"Japon\u00e9s\",\n\"displayName_uiListOrMenu\": \"Japon\u00e9s\",\n\"displayName_standalone\": \"Japon\u00e9s\"\n},\n{\n\"languageTag\": \"zh-Hant\",\n\"displayName\": \"chino tradicional\",\n\"displayName_sentenceBeginning\": \"Chino tradicional\",\n\"displayName_uiListOrMenu\": \"Chino tradicional\",\n\"displayName_standalone\": \"Chino tradicional\"\n},\n{\n\"languageTag\": \"es\",\n\"displayName\": \"espa\u00f1ol\",\n\"displayName_sentenceBeginning\": \"Espa\u00f1ol\",\n\"displayName_uiListOrMenu\": \"Espa\u00f1ol\",\n\"displayName_standalone\": \"Espa\u00f1ol\"\n},\n{\n\"languageTag\": \"ko\",\n\"displayName\": \"coreano\",\n\"displayName_sentenceBeginning\": \"Coreano\",\n\"displayName_uiListOrMenu\": \"Coreano\",\n\"displayName_standalone\": \"Coreano\"\n},\n{\n\"languageTag\": \"fr\",\n\"displayName\": \"franc\u00e9s\",\n\"displayName_sentenceBeginning\": \"Franc\u00e9s\",\n\"displayName_uiListOrMenu\": \"Franc\u00e9s\",\n\"displayName_standalone\": \"Franc\u00e9s\"\n},\n{\n\"languageTag\": \"fr-CA\",\n\"displayName\": \"franc\u00e9s canadiense\",\n\"displayName_sentenceBeginning\": \"Franc\u00e9s canadiense\",\n\"displayName_uiListOrMenu\": \"Franc\u00e9s canadiense\",\n\"displayName_standalone\": \"Franc\u00e9s canadiense\"\n}\n],\nIn a similar fashion, the offline mode code also gives a \"display name\", only it is simplified by what we get using Locale inLocale = Locale.forLanguageTag(displayLanguage)", "url": "https://github.com/vmware/singleton/pull/673#discussion_r459548112", "createdAt": "2020-07-23T15:44:52Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +56,63 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    dto.setComponent(((String) component).trim());\n+                    dto.setLocale(LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim());\n+                    dto.setProductID(VIPCfg.getInstance().getProductName());\n+                    dto.setVersion(VIPCfg.getInstance().getVersion());\n+                    Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    private Map<String, String> getLanguages(Iterator<DataSourceEnum> msgSourceQueueIter) {\n+        if (!msgSourceQueueIter.hasNext())\n+            return null;\n+\n+        DataSourceEnum dataSource = msgSourceQueueIter.next();\n+        LocaleOpt opt = dataSource.createLocaleOpt();\n+        Map<String, String> languages =  opt.getLanguages(LocaleUtility.getDefaultLocale().toLanguageTag());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3MzE2MA=="}, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MDAyNg==", "bodyText": "I think you are totally lost. In this interface, the only needed is the locale names from bundle file names. That's what I said: bundle file names trim prefix 'messages_' and suffix '.json'. This has nothing to do with display language.  Don't mix different things together to make things become complex. Forget display language here.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r459880026", "createdAt": "2020-07-24T06:51:46Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +56,63 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    dto.setComponent(((String) component).trim());\n+                    dto.setLocale(LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim());\n+                    dto.setProductID(VIPCfg.getInstance().getProductName());\n+                    dto.setVersion(VIPCfg.getInstance().getVersion());\n+                    Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    private Map<String, String> getLanguages(Iterator<DataSourceEnum> msgSourceQueueIter) {\n+        if (!msgSourceQueueIter.hasNext())\n+            return null;\n+\n+        DataSourceEnum dataSource = msgSourceQueueIter.next();\n+        LocaleOpt opt = dataSource.createLocaleOpt();\n+        Map<String, String> languages =  opt.getLanguages(LocaleUtility.getDefaultLocale().toLanguageTag());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3MzE2MA=="}, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzMTgyMA==", "bodyText": "Oh, I am not lost at all. :)\nI think you do not get my point. I KNOW that we are not using display names here. I said it up there in my comment.\nThe point is that we can USE THE SAME METHOD that L2 uses to get the list of supported locales. That method requires display language, yes -- which is no problem because we can use the fallback locale as display language too. Then ignore the display names. Do you get it now? No need to write new code. Avoid redundant like the redundant endpoints mentioned above in the service API.\nAnyway, this part of the code is outdated, it will also be updated once Huihui merge her PR.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r460231820", "createdAt": "2020-07-24T18:54:39Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +56,63 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    dto.setComponent(((String) component).trim());\n+                    dto.setLocale(LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim());\n+                    dto.setProductID(VIPCfg.getInstance().getProductName());\n+                    dto.setVersion(VIPCfg.getInstance().getVersion());\n+                    Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    private Map<String, String> getLanguages(Iterator<DataSourceEnum> msgSourceQueueIter) {\n+        if (!msgSourceQueueIter.hasNext())\n+            return null;\n+\n+        DataSourceEnum dataSource = msgSourceQueueIter.next();\n+        LocaleOpt opt = dataSource.createLocaleOpt();\n+        Map<String, String> languages =  opt.getLanguages(LocaleUtility.getDefaultLocale().toLanguageTag());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3MzE2MA=="}, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NTU3MDgyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/api/opt/local/LocalComponentOpt.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMjo0MDowOFrOGzDaKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMjo0MDowOFrOGzDaKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE4NjQwOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     try (Stream<Path> listOfFiles = Files.walk(path).filter(\n          \n          \n            \n                             p -> !Files.isRegularFile(p) && !p.equals(path))) {\n          \n          \n            \n                         listOfFiles.map(dir -> dir.getFileName().toString()).forEach(s->components.add(s));\n          \n          \n            \n                    try (Stream<Path> listOfFiles = Files.list(path).filter(p -> !p.toFile().isFile())) {\n          \n          \n            \n                        listOfFiles.forEach(s -> components.add(s.getFileName().toString()));\n          \n          \n            \n                    }", "url": "https://github.com/vmware/singleton/pull/673#discussion_r456186408", "createdAt": "2020-07-17T02:40:08Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/api/opt/local/LocalComponentOpt.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2019 VMware, Inc.\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package com.vmware.vipclient.i18n.messages.api.opt.local;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.nio.file.*;\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.stream.Stream;\n+\n+import com.vmware.vipclient.i18n.VIPCfg;\n+import com.vmware.vipclient.i18n.messages.api.opt.ComponentOpt;\n+import com.vmware.vipclient.i18n.messages.dto.BaseDTO;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class LocalComponentOpt implements ComponentOpt {\n+    private Logger logger = LoggerFactory.getLogger(LocalComponentOpt.class);\n+    private BaseDTO dto;\n+    public LocalComponentOpt(BaseDTO dto) {\n+        this.dto = dto;\n+    }\n+\n+    @Override\n+    public List<String> getComponents() {\n+        List<String> components = new LinkedList<String>();\n+        try {\n+\n+            Path path = Paths.get(VIPCfg.getInstance().getOfflineResourcesBaseUrl());\n+\n+            URI uri = Thread.currentThread().getContextClassLoader().\n+                    getResource(path.toString()).toURI();\n+\n+            if (uri.getScheme().equals(\"jar\")) {\n+                try (FileSystem fileSystem = FileSystems.newFileSystem(uri, Collections.<String, Object>emptyMap())) {\n+                    path = fileSystem.getPath(path.toString());\n+                    getComponents(path, components);\n+                }\n+            } else {\n+                path = Paths.get(uri);\n+                getComponents(path, components);\n+            }\n+\n+        } catch (Exception e) {\n+            logger.debug(e.getMessage());\n+        }\n+        return components;\n+    }\n+\n+    private void getComponents(Path path, List<String> components) throws IOException {\n+         try (Stream<Path> listOfFiles = Files.walk(path).filter(\n+                 p -> !Files.isRegularFile(p) && !p.equals(path))) {\n+             listOfFiles.map(dir -> dir.getFileName().toString()).forEach(s->components.add(s));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NjgyNzA5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMToxMTo0MFrOGzPFTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMToxMTo0MFrOGzPFTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM3NzY3Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!msgSourceQueueIter.hasNext())\n          \n          \n            \n                        return null;\n          \n          \n            \n            \n          \n          \n            \n                    DataSourceEnum dataSource = msgSourceQueueIter.next();\n          \n          \n            \n                    LocaleOpt opt = dataSource.createLocaleOpt();\n          \n          \n            \n                    Map<String, String> languages =  opt.getLanguages(LocaleUtility.getDefaultLocale().toLanguageTag());\n          \n          \n            \n                    // If failed to get languages from the data source\n          \n          \n            \n                    if (languages == null) {\n          \n          \n            \n                        // Try the next dataSource in the queue\n          \n          \n            \n                        if (msgSourceQueueIter.hasNext()) {\n          \n          \n            \n                            languages = getLanguages(msgSourceQueueIter);\n          \n          \n            \n                            // If no more data source in queue, log the error. This means that neither online nor offline fetch succeeded.\n          \n          \n            \n                        } else {\n          \n          \n            \n                            logger.error(FormatUtils.format(ConstantsMsg.GET_LANGUAGES_FAILED, dataSource.toString()));\n          \n          \n            \n                        }\n          \n          \n            \n                    }\n          \n          \n            \n                    return languages;\n          \n          \n            \n                    if (!msgSourceQueueIter.hasNext()) {\n          \n          \n            \n                        return null;\n          \n          \n            \n                    }\n          \n          \n            \n                    \n          \n          \n            \n                    DataSourceEnum dataSource = msgSourceQueueIter.next();\n          \n          \n            \n                    LocaleOpt opt = dataSource.createLocaleOpt();\n          \n          \n            \n                    Map<String, String> languages =  opt.getLanguages(LocaleUtility.getDefaultLocale().toLanguageTag());\n          \n          \n            \n                    // If failed to get languages from the data source\n          \n          \n            \n                    if (languages == null) {                \n          \n          \n            \n                    logger.error(FormatUtils.format(ConstantsMsg.GET_LANGUAGES_FAILED, dataSource.toString()));\n          \n          \n            \n                languages = getLanguages(msgSourceQueueIter);\n          \n          \n            \n                    }\n          \n          \n            \n                    \n          \n          \n            \n                        return languages;", "url": "https://github.com/vmware/singleton/pull/673#discussion_r456377677", "createdAt": "2020-07-17T11:11:40Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +56,63 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    dto.setComponent(((String) component).trim());\n+                    dto.setLocale(LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim());\n+                    dto.setProductID(VIPCfg.getInstance().getProductName());\n+                    dto.setVersion(VIPCfg.getInstance().getVersion());\n+                    Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    private Map<String, String> getLanguages(Iterator<DataSourceEnum> msgSourceQueueIter) {\n+        if (!msgSourceQueueIter.hasNext())\n+            return null;\n+\n+        DataSourceEnum dataSource = msgSourceQueueIter.next();\n+        LocaleOpt opt = dataSource.createLocaleOpt();\n+        Map<String, String> languages =  opt.getLanguages(LocaleUtility.getDefaultLocale().toLanguageTag());\n+        // If failed to get languages from the data source\n+        if (languages == null) {\n+            // Try the next dataSource in the queue\n+            if (msgSourceQueueIter.hasNext()) {\n+                languages = getLanguages(msgSourceQueueIter);\n+                // If no more data source in queue, log the error. This means that neither online nor offline fetch succeeded.\n+            } else {\n+                logger.error(FormatUtils.format(ConstantsMsg.GET_LANGUAGES_FAILED, dataSource.toString()));\n+            }\n+        }\n+        return languages;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NzQ3NTM5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNDoyNzoyMlrOGzVKaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDoxNzo1NVrOG0dyAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ3NzI4OQ==", "bodyText": "Now client supports multiple configurations, VIPCfg.getInstance() gets only one product. It isn't correct.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r456477289", "createdAt": "2020-07-17T14:27:22Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +56,63 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    dto.setComponent(((String) component).trim());\n+                    dto.setLocale(LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim());\n+                    dto.setProductID(VIPCfg.getInstance().getProductName());\n+                    dto.setVersion(VIPCfg.getInstance().getVersion());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY2NzA3NA==", "bodyText": "Fixed.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r457667074", "createdAt": "2020-07-20T20:17:55Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -44,23 +56,63 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n \n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        Map<String, String> locales = this.getLanguages(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    dto.setComponent(((String) component).trim());\n+                    dto.setLocale(LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim());\n+                    dto.setProductID(VIPCfg.getInstance().getProductName());\n+                    dto.setVersion(VIPCfg.getInstance().getVersion());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ3NzI4OQ=="}, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MjI3MzgwOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/vmware/vip/i18n/TranslationMessageTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwNzozMDozNVrOGz9Elw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNToxOTo1M1rOG0SxDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzEzMTE1OQ==", "bodyText": "What's the reason for setting these properties again?", "url": "https://github.com/vmware/singleton/pull/673#discussion_r457131159", "createdAt": "2020-07-20T07:30:35Z", "author": {"login": "huihuiw01"}, "path": "src/test/java/com/vmware/vip/i18n/TranslationMessageTest.java", "diffHunk": "@@ -261,6 +256,23 @@ public void testGetAllComponentTranslation() {\n         Assert.assertTrue(list.size() > 0);\n     }\n \n+    @Test\n+    public void testGetAllComponentTranslationMixedMode() {\n+        String offlineResourcesBaseUrlOrig = vipCfg.getOfflineResourcesBaseUrl();\n+        vipCfg.setOfflineResourcesBaseUrl(\"offlineBundles/\");\n+        List<DataSourceEnum> msgOriginsQueueOrig = vipCfg.getMsgOriginsQueue();\n+        vipCfg.setMsgOriginsQueue(new LinkedList<DataSourceEnum>(Arrays.asList(DataSourceEnum.VIP, DataSourceEnum.Bundle)));\n+        String vipServerOrig = vipCfg.getVipServer();\n+        vipCfg.setVipServer(\"http://1.1.1.1:80\");\n+\n+        List<Map> list = new ProductService(dto).getAllComponentTranslation();\n+        Assert.assertTrue(list.size() > 0);\n+\n+        vipCfg.setOfflineResourcesBaseUrl(offlineResourcesBaseUrlOrig);\n+        vipCfg.setMsgOriginsQueue(msgOriginsQueueOrig);\n+        vipCfg.setVipServer(vipServerOrig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ4NjYwNA==", "bodyText": "@huihuiw01 , for the next tests. Tests share the same configurations, unless modified inside the test.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r457486604", "createdAt": "2020-07-20T15:19:53Z", "author": {"login": "jessiejuachon"}, "path": "src/test/java/com/vmware/vip/i18n/TranslationMessageTest.java", "diffHunk": "@@ -261,6 +256,23 @@ public void testGetAllComponentTranslation() {\n         Assert.assertTrue(list.size() > 0);\n     }\n \n+    @Test\n+    public void testGetAllComponentTranslationMixedMode() {\n+        String offlineResourcesBaseUrlOrig = vipCfg.getOfflineResourcesBaseUrl();\n+        vipCfg.setOfflineResourcesBaseUrl(\"offlineBundles/\");\n+        List<DataSourceEnum> msgOriginsQueueOrig = vipCfg.getMsgOriginsQueue();\n+        vipCfg.setMsgOriginsQueue(new LinkedList<DataSourceEnum>(Arrays.asList(DataSourceEnum.VIP, DataSourceEnum.Bundle)));\n+        String vipServerOrig = vipCfg.getVipServer();\n+        vipCfg.setVipServer(\"http://1.1.1.1:80\");\n+\n+        List<Map> list = new ProductService(dto).getAllComponentTranslation();\n+        Assert.assertTrue(list.size() > 0);\n+\n+        vipCfg.setOfflineResourcesBaseUrl(offlineResourcesBaseUrlOrig);\n+        vipCfg.setMsgOriginsQueue(msgOriginsQueueOrig);\n+        vipCfg.setVipServer(vipServerOrig);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzEzMTE1OQ=="}, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1Mjg4NTY4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/base/DataSourceEnum.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwOTozMDoxN1rOG0CdMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDowMTo0NVrOG28J4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxOTM3OA==", "bodyText": "Need to add an interface to get supported locales. supported locales have nothing to do with displayLanguage. They are from names of bundle files.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r457219378", "createdAt": "2020-07-20T09:30:17Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/base/DataSourceEnum.java", "diffHunk": "@@ -34,7 +43,13 @@ public MessageOpt createMessageOpt(MessagesDTO dto) {\n \t\tpublic LocaleOpt createLocaleOpt() {\n \t\t\treturn new RemoteLocaleOpt();\n \t\t}\n+\n+        @Override\n+        public ComponentOpt createComponentOpt(BaseDTO dto) {\n+            return new RemoteComponentOpt(dto);\n+        }\n     };\n     public abstract MessageOpt createMessageOpt(MessagesDTO dto);\n     public abstract LocaleOpt createLocaleOpt();\n+    public abstract ComponentOpt createComponentOpt(BaseDTO dto);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY1MzgyNw==", "bodyText": "Why do you say \"supported locales have nothing to do with displayLanguage\"? A locale is composed of language tag and display name. The display name can be translated in multiple languages, and that is the use of \"display language\". The client is not using the display name here, but it can potentially be used later on if the result needs to be displayed. The default language can be used in the request, and the display names can be ignored for now.\nFor offline mode, the client library uses Java's Locale.forLanguageTag to get the display name: Locale.forLanguageTag(displayLanguage). See LocalLocaleOpt.getSupportedLocales.\nOn the service side, we do not need 2 separate endpoints:\n\nGET /i18n/api/v2/translation/products/{productName}/versions/{version}/localelist\nGET /i18n/api/v2/locale/supportedLanguageList\nEndpoint 1 returns the language tags.\nEndpoint 2 returns language tags AND display names. It uses the \"locale\" in the path, which is a language tag to determine the \"display language\".\nWe do not need endpoint 1. It is redundant.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r457653827", "createdAt": "2020-07-20T19:52:03Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/base/DataSourceEnum.java", "diffHunk": "@@ -34,7 +43,13 @@ public MessageOpt createMessageOpt(MessagesDTO dto) {\n \t\tpublic LocaleOpt createLocaleOpt() {\n \t\t\treturn new RemoteLocaleOpt();\n \t\t}\n+\n+        @Override\n+        public ComponentOpt createComponentOpt(BaseDTO dto) {\n+            return new RemoteComponentOpt(dto);\n+        }\n     };\n     public abstract MessageOpt createMessageOpt(MessagesDTO dto);\n     public abstract LocaleOpt createLocaleOpt();\n+    public abstract ComponentOpt createComponentOpt(BaseDTO dto);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxOTM3OA=="}, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU1MTU0OQ==", "bodyText": "@Xiaochao8 , may I close this now, or do you not agree?\nWe do not need to 2 separate interfaces (one with and one without the display language parameter). Keep the parameter, we can always pass the configured default language as the display language. That way, the display language won't be hardcoded. It is also okay that the display name is not used in here.\nThat is why we have the default language configured in the config file.  I do not want to see anything hardcoded\nto English (or any other language) in the code.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r459551549", "createdAt": "2020-07-23T15:49:56Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/base/DataSourceEnum.java", "diffHunk": "@@ -34,7 +43,13 @@ public MessageOpt createMessageOpt(MessagesDTO dto) {\n \t\tpublic LocaleOpt createLocaleOpt() {\n \t\t\treturn new RemoteLocaleOpt();\n \t\t}\n+\n+        @Override\n+        public ComponentOpt createComponentOpt(BaseDTO dto) {\n+            return new RemoteComponentOpt(dto);\n+        }\n     };\n     public abstract MessageOpt createMessageOpt(MessagesDTO dto);\n     public abstract LocaleOpt createLocaleOpt();\n+    public abstract ComponentOpt createComponentOpt(BaseDTO dto);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxOTM3OA=="}, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MDc5MQ==", "bodyText": "In level 3, we only need the names from bundle file names. Please forget display names. It's unnecessary.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r459880791", "createdAt": "2020-07-24T06:54:14Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/base/DataSourceEnum.java", "diffHunk": "@@ -34,7 +43,13 @@ public MessageOpt createMessageOpt(MessagesDTO dto) {\n \t\tpublic LocaleOpt createLocaleOpt() {\n \t\t\treturn new RemoteLocaleOpt();\n \t\t}\n+\n+        @Override\n+        public ComponentOpt createComponentOpt(BaseDTO dto) {\n+            return new RemoteComponentOpt(dto);\n+        }\n     };\n     public abstract MessageOpt createMessageOpt(MessagesDTO dto);\n     public abstract LocaleOpt createLocaleOpt();\n+    public abstract ComponentOpt createComponentOpt(BaseDTO dto);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxOTM3OA=="}, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzNjk4MA==", "bodyText": "I think you do not get my point. I KNOW that we are not using display names here. I said it up there in my comment : \"The client is not using the display name here, but it can potentially be used later on if the result needs to be displayed.\"\nThe point is that we can USE THE SAME METHOD that L2 uses to get the list of supported locales. That method requires display language, yes -- which is no problem here because we can use the fallback locale as display language as well. Then just ignore the display names. Do you get it now? No need to write new code. Avoid redundant code like the redundant endpoints mentioned above in the service API.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r460236980", "createdAt": "2020-07-24T19:05:53Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/base/DataSourceEnum.java", "diffHunk": "@@ -34,7 +43,13 @@ public MessageOpt createMessageOpt(MessagesDTO dto) {\n \t\tpublic LocaleOpt createLocaleOpt() {\n \t\t\treturn new RemoteLocaleOpt();\n \t\t}\n+\n+        @Override\n+        public ComponentOpt createComponentOpt(BaseDTO dto) {\n+            return new RemoteComponentOpt(dto);\n+        }\n     };\n     public abstract MessageOpt createMessageOpt(MessagesDTO dto);\n     public abstract LocaleOpt createLocaleOpt();\n+    public abstract ComponentOpt createComponentOpt(BaseDTO dto);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxOTM3OA=="}, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2MTg1Nw==", "bodyText": "Since you do not want to see a parameter in the method, I have created a parameterless LocaleService.getSupportedLanguages.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r460261857", "createdAt": "2020-07-24T20:01:45Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/base/DataSourceEnum.java", "diffHunk": "@@ -34,7 +43,13 @@ public MessageOpt createMessageOpt(MessagesDTO dto) {\n \t\tpublic LocaleOpt createLocaleOpt() {\n \t\t\treturn new RemoteLocaleOpt();\n \t\t}\n+\n+        @Override\n+        public ComponentOpt createComponentOpt(BaseDTO dto) {\n+            return new RemoteComponentOpt(dto);\n+        }\n     };\n     public abstract MessageOpt createMessageOpt(MessagesDTO dto);\n     public abstract LocaleOpt createLocaleOpt();\n+    public abstract ComponentOpt createComponentOpt(BaseDTO dto);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxOTM3OA=="}, "originalCommit": {"oid": "e13b694a1a12048760e0a8dd3980ddb585c71a9a"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MDM1NDAyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzo0MzozNFrOG4Aj8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjowNDo0NlrOG51cJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4MjY0MA==", "bodyText": "As an interface, users don't need to know msgSourceQueueIter.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461382640", "createdAt": "2020-07-28T07:43:34Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -42,25 +55,56 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n         return dao.getSupportedLocalesFromRemoteVIP();\n     }\n \n+    /**\n+     * Retrieves translated messages of all components of a product in the requested locale (See the dto object).\n+     *\n+     * @return translated messages of all components of a product locale specified in the dto object\n+     */\n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        LocaleDTO localeDTO = new LocaleDTO(dto.getProductID(), dto.getVersion());\n+        Map<String, String> locales = new LocaleService(localeDTO).getSupportedLanguages();\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    MessagesDTO msgDTO = new MessagesDTO(((String) component).trim(), LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim(),\n+                            dto.getProductID(), dto.getVersion());\n+                    Iterator<Locale> fallbackLocalesIter = LocaleUtility.getFallbackLocales().iterator();\n+                    Map<String, String> retMap = new ComponentService(msgDTO).getMessages(fallbackLocalesIter).getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    /**\n+     * Retrieves the list of components of a product. It recursively applies data source fallback mechanism in case of failure.\n+     *\n+     * @param msgSourceQueueIter Iterator of DataSourceEnum sources\n+     * @return list of components of the product specified in the dto object\n+     */\n+    public List<String> getComponents (Iterator<DataSourceEnum> msgSourceQueueIter) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3ODAyNA==", "bodyText": "ProductService is service layer. This should not be exposed to users! Only *Message.java should contain user-exposed APIs", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461878024", "createdAt": "2020-07-28T21:04:20Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -42,25 +55,56 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n         return dao.getSupportedLocalesFromRemoteVIP();\n     }\n \n+    /**\n+     * Retrieves translated messages of all components of a product in the requested locale (See the dto object).\n+     *\n+     * @return translated messages of all components of a product locale specified in the dto object\n+     */\n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        LocaleDTO localeDTO = new LocaleDTO(dto.getProductID(), dto.getVersion());\n+        Map<String, String> locales = new LocaleService(localeDTO).getSupportedLanguages();\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    MessagesDTO msgDTO = new MessagesDTO(((String) component).trim(), LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim(),\n+                            dto.getProductID(), dto.getVersion());\n+                    Iterator<Locale> fallbackLocalesIter = LocaleUtility.getFallbackLocales().iterator();\n+                    Map<String, String> retMap = new ComponentService(msgDTO).getMessages(fallbackLocalesIter).getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    /**\n+     * Retrieves the list of components of a product. It recursively applies data source fallback mechanism in case of failure.\n+     *\n+     * @param msgSourceQueueIter Iterator of DataSourceEnum sources\n+     * @return list of components of the product specified in the dto object\n+     */\n+    public List<String> getComponents (Iterator<DataSourceEnum> msgSourceQueueIter) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4MjY0MA=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3MDAxOQ==", "bodyText": "Different layers have their own interfaces even client internally. Here, message layer is the user of service layer.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461970019", "createdAt": "2020-07-29T00:32:09Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -42,25 +55,56 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n         return dao.getSupportedLocalesFromRemoteVIP();\n     }\n \n+    /**\n+     * Retrieves translated messages of all components of a product in the requested locale (See the dto object).\n+     *\n+     * @return translated messages of all components of a product locale specified in the dto object\n+     */\n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        LocaleDTO localeDTO = new LocaleDTO(dto.getProductID(), dto.getVersion());\n+        Map<String, String> locales = new LocaleService(localeDTO).getSupportedLanguages();\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    MessagesDTO msgDTO = new MessagesDTO(((String) component).trim(), LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim(),\n+                            dto.getProductID(), dto.getVersion());\n+                    Iterator<Locale> fallbackLocalesIter = LocaleUtility.getFallbackLocales().iterator();\n+                    Map<String, String> retMap = new ComponentService(msgDTO).getMessages(fallbackLocalesIter).getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    /**\n+     * Retrieves the list of components of a product. It recursively applies data source fallback mechanism in case of failure.\n+     *\n+     * @param msgSourceQueueIter Iterator of DataSourceEnum sources\n+     * @return list of components of the product specified in the dto object\n+     */\n+    public List<String> getComponents (Iterator<DataSourceEnum> msgSourceQueueIter) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4MjY0MA=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI5NzU3Mg==", "bodyText": "Ahh, I get what you are saying. Your use of the word \"user\" confused me.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r463297572", "createdAt": "2020-07-30T22:04:46Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -42,25 +55,56 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n         return dao.getSupportedLocalesFromRemoteVIP();\n     }\n \n+    /**\n+     * Retrieves translated messages of all components of a product in the requested locale (See the dto object).\n+     *\n+     * @return translated messages of all components of a product locale specified in the dto object\n+     */\n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        LocaleDTO localeDTO = new LocaleDTO(dto.getProductID(), dto.getVersion());\n+        Map<String, String> locales = new LocaleService(localeDTO).getSupportedLanguages();\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    MessagesDTO msgDTO = new MessagesDTO(((String) component).trim(), LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim(),\n+                            dto.getProductID(), dto.getVersion());\n+                    Iterator<Locale> fallbackLocalesIter = LocaleUtility.getFallbackLocales().iterator();\n+                    Map<String, String> retMap = new ComponentService(msgDTO).getMessages(fallbackLocalesIter).getCachedData();\n+                    if (retMap != null) {\n+                        list.add(retMap);\n+                    }\n                 }\n             }\n         }\n         return list;\n     }\n+\n+    /**\n+     * Retrieves the list of components of a product. It recursively applies data source fallback mechanism in case of failure.\n+     *\n+     * @param msgSourceQueueIter Iterator of DataSourceEnum sources\n+     * @return list of components of the product specified in the dto object\n+     */\n+    public List<String> getComponents (Iterator<DataSourceEnum> msgSourceQueueIter) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4MjY0MA=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MDM1OTMzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/LocaleService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzo0NTowMlrOG4AnOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMDo1Mzo1N1rOG4ecYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4MzQ4Mg==", "bodyText": "This interface should belong to productService. Does a locale support any languages?", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461383482", "createdAt": "2020-07-28T07:45:02Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/LocaleService.java", "diffHunk": "@@ -4,28 +4,115 @@\n  */\n package com.vmware.vipclient.i18n.messages.service;\n \n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.ListIterator;\n-import java.util.Map;\n-\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n+import java.util.*;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.FutureTask;\n \n import com.vmware.vipclient.i18n.VIPCfg;\n import com.vmware.vipclient.i18n.base.DataSourceEnum;\n import com.vmware.vipclient.i18n.base.cache.Cache;\n import com.vmware.vipclient.i18n.base.cache.FormatCacheItem;\n+import com.vmware.vipclient.i18n.common.ConstantsMsg;\n import com.vmware.vipclient.i18n.messages.api.opt.server.RemoteLocaleOpt;\n+import com.vmware.vipclient.i18n.messages.dto.LocaleDTO;\n+import com.vmware.vipclient.i18n.util.FormatUtils;\n import com.vmware.vipclient.i18n.util.JSONUtils;\n+import com.vmware.vipclient.i18n.util.LocaleUtility;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n public class LocaleService {\n-\n-    Logger                      logger        = LoggerFactory.getLogger(LocaleService.class.getName());\n+    Logger logger = LoggerFactory.getLogger(LocaleService.class.getName());\n     private static final String REGION_PREFIX = \"region_\";\n     public static final String DISPN_PREFIX  = \"dispn_\";\n+    private LocaleDTO dto;\n \n     public LocaleService() {\n+\n+    }\n+    public LocaleService(LocaleDTO dto) {\n+        this.dto = dto;\n+    }\n+\n+    public Map<String, String> getSupportedLanguages() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3MjIyNQ==", "bodyText": "Yes, I actually put the exact same code as suggestion in Huihui's PR, so the transfer to \"ProductService\" should be taken care of there.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461872225", "createdAt": "2020-07-28T20:53:57Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/LocaleService.java", "diffHunk": "@@ -4,28 +4,115 @@\n  */\n package com.vmware.vipclient.i18n.messages.service;\n \n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.ListIterator;\n-import java.util.Map;\n-\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n+import java.util.*;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.FutureTask;\n \n import com.vmware.vipclient.i18n.VIPCfg;\n import com.vmware.vipclient.i18n.base.DataSourceEnum;\n import com.vmware.vipclient.i18n.base.cache.Cache;\n import com.vmware.vipclient.i18n.base.cache.FormatCacheItem;\n+import com.vmware.vipclient.i18n.common.ConstantsMsg;\n import com.vmware.vipclient.i18n.messages.api.opt.server.RemoteLocaleOpt;\n+import com.vmware.vipclient.i18n.messages.dto.LocaleDTO;\n+import com.vmware.vipclient.i18n.util.FormatUtils;\n import com.vmware.vipclient.i18n.util.JSONUtils;\n+import com.vmware.vipclient.i18n.util.LocaleUtility;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n public class LocaleService {\n-\n-    Logger                      logger        = LoggerFactory.getLogger(LocaleService.class.getName());\n+    Logger logger = LoggerFactory.getLogger(LocaleService.class.getName());\n     private static final String REGION_PREFIX = \"region_\";\n     public static final String DISPN_PREFIX  = \"dispn_\";\n+    private LocaleDTO dto;\n \n     public LocaleService() {\n+\n+    }\n+    public LocaleService(LocaleDTO dto) {\n+        this.dto = dto;\n+    }\n+\n+    public Map<String, String> getSupportedLanguages() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4MzQ4Mg=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MDM2OTEwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/LocaleService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzo0Nzo1MFrOG4AtXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMDo1NToxMFrOG4efOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4NTA1NQ==", "bodyText": "This interface should belong to productService. Does a locale support any languages?", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461385055", "createdAt": "2020-07-28T07:47:50Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/LocaleService.java", "diffHunk": "@@ -4,28 +4,115 @@\n  */\n package com.vmware.vipclient.i18n.messages.service;\n \n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.ListIterator;\n-import java.util.Map;\n-\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n+import java.util.*;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.FutureTask;\n \n import com.vmware.vipclient.i18n.VIPCfg;\n import com.vmware.vipclient.i18n.base.DataSourceEnum;\n import com.vmware.vipclient.i18n.base.cache.Cache;\n import com.vmware.vipclient.i18n.base.cache.FormatCacheItem;\n+import com.vmware.vipclient.i18n.common.ConstantsMsg;\n import com.vmware.vipclient.i18n.messages.api.opt.server.RemoteLocaleOpt;\n+import com.vmware.vipclient.i18n.messages.dto.LocaleDTO;\n+import com.vmware.vipclient.i18n.util.FormatUtils;\n import com.vmware.vipclient.i18n.util.JSONUtils;\n+import com.vmware.vipclient.i18n.util.LocaleUtility;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n public class LocaleService {\n-\n-    Logger                      logger        = LoggerFactory.getLogger(LocaleService.class.getName());\n+    Logger logger = LoggerFactory.getLogger(LocaleService.class.getName());\n     private static final String REGION_PREFIX = \"region_\";\n     public static final String DISPN_PREFIX  = \"dispn_\";\n+    private LocaleDTO dto;\n \n     public LocaleService() {\n+\n+    }\n+    public LocaleService(LocaleDTO dto) {\n+        this.dto = dto;\n+    }\n+\n+    public Map<String, String> getSupportedLanguages() {\n+        return getSupportedLanguages(null, LocaleUtility.getFallbackLocales().iterator());\n+    }\n+\n+    public Map<String, String> getSupportedLanguages(Iterator<Locale> fallbackLocalesIter) {\n+        return getSupportedLanguages(null, fallbackLocalesIter);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3Mjk1NA==", "bodyText": "AS I said above,  I actually put the exact same code as suggestion in Huihui's PR, so the transfer to \"ProductService\" should be taken care of there.\nUsers won't directly use this method because this is Service layer so fallbackLocalesIter belong here.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461872954", "createdAt": "2020-07-28T20:55:10Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/LocaleService.java", "diffHunk": "@@ -4,28 +4,115 @@\n  */\n package com.vmware.vipclient.i18n.messages.service;\n \n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.ListIterator;\n-import java.util.Map;\n-\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n+import java.util.*;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.FutureTask;\n \n import com.vmware.vipclient.i18n.VIPCfg;\n import com.vmware.vipclient.i18n.base.DataSourceEnum;\n import com.vmware.vipclient.i18n.base.cache.Cache;\n import com.vmware.vipclient.i18n.base.cache.FormatCacheItem;\n+import com.vmware.vipclient.i18n.common.ConstantsMsg;\n import com.vmware.vipclient.i18n.messages.api.opt.server.RemoteLocaleOpt;\n+import com.vmware.vipclient.i18n.messages.dto.LocaleDTO;\n+import com.vmware.vipclient.i18n.util.FormatUtils;\n import com.vmware.vipclient.i18n.util.JSONUtils;\n+import com.vmware.vipclient.i18n.util.LocaleUtility;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n public class LocaleService {\n-\n-    Logger                      logger        = LoggerFactory.getLogger(LocaleService.class.getName());\n+    Logger logger = LoggerFactory.getLogger(LocaleService.class.getName());\n     private static final String REGION_PREFIX = \"region_\";\n     public static final String DISPN_PREFIX  = \"dispn_\";\n+    private LocaleDTO dto;\n \n     public LocaleService() {\n+\n+    }\n+    public LocaleService(LocaleDTO dto) {\n+        this.dto = dto;\n+    }\n+\n+    public Map<String, String> getSupportedLanguages() {\n+        return getSupportedLanguages(null, LocaleUtility.getFallbackLocales().iterator());\n+    }\n+\n+    public Map<String, String> getSupportedLanguages(Iterator<Locale> fallbackLocalesIter) {\n+        return getSupportedLanguages(null, fallbackLocalesIter);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4NTA1NQ=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MDM3MDYzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/LocaleService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzo0ODoxOFrOG4AuWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMDo1NTozOVrOG4egKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4NTMwNA==", "bodyText": "This interface should belong to productService. Does a locale support any languages?\nAlso, fallbackLoclesIter should be remove from parameters.\nUsers don't need to know fallbackLoclesIter, please handle it in the method.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461385304", "createdAt": "2020-07-28T07:48:18Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/LocaleService.java", "diffHunk": "@@ -4,28 +4,115 @@\n  */\n package com.vmware.vipclient.i18n.messages.service;\n \n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.ListIterator;\n-import java.util.Map;\n-\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n+import java.util.*;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.FutureTask;\n \n import com.vmware.vipclient.i18n.VIPCfg;\n import com.vmware.vipclient.i18n.base.DataSourceEnum;\n import com.vmware.vipclient.i18n.base.cache.Cache;\n import com.vmware.vipclient.i18n.base.cache.FormatCacheItem;\n+import com.vmware.vipclient.i18n.common.ConstantsMsg;\n import com.vmware.vipclient.i18n.messages.api.opt.server.RemoteLocaleOpt;\n+import com.vmware.vipclient.i18n.messages.dto.LocaleDTO;\n+import com.vmware.vipclient.i18n.util.FormatUtils;\n import com.vmware.vipclient.i18n.util.JSONUtils;\n+import com.vmware.vipclient.i18n.util.LocaleUtility;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n public class LocaleService {\n-\n-    Logger                      logger        = LoggerFactory.getLogger(LocaleService.class.getName());\n+    Logger logger = LoggerFactory.getLogger(LocaleService.class.getName());\n     private static final String REGION_PREFIX = \"region_\";\n     public static final String DISPN_PREFIX  = \"dispn_\";\n+    private LocaleDTO dto;\n \n     public LocaleService() {\n+\n+    }\n+    public LocaleService(LocaleDTO dto) {\n+        this.dto = dto;\n+    }\n+\n+    public Map<String, String> getSupportedLanguages() {\n+        return getSupportedLanguages(null, LocaleUtility.getFallbackLocales().iterator());\n+    }\n+\n+    public Map<String, String> getSupportedLanguages(Iterator<Locale> fallbackLocalesIter) {\n+        return getSupportedLanguages(null, fallbackLocalesIter);\n+    }\n+\n+    public Map<String, String> getSupportedLanguages(String displayLanguageTag, Iterator<Locale> fallbackLocalesIter) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3MzE5NA==", "bodyText": "Same comment as above.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461873194", "createdAt": "2020-07-28T20:55:39Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/LocaleService.java", "diffHunk": "@@ -4,28 +4,115 @@\n  */\n package com.vmware.vipclient.i18n.messages.service;\n \n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.ListIterator;\n-import java.util.Map;\n-\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n+import java.util.*;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.FutureTask;\n \n import com.vmware.vipclient.i18n.VIPCfg;\n import com.vmware.vipclient.i18n.base.DataSourceEnum;\n import com.vmware.vipclient.i18n.base.cache.Cache;\n import com.vmware.vipclient.i18n.base.cache.FormatCacheItem;\n+import com.vmware.vipclient.i18n.common.ConstantsMsg;\n import com.vmware.vipclient.i18n.messages.api.opt.server.RemoteLocaleOpt;\n+import com.vmware.vipclient.i18n.messages.dto.LocaleDTO;\n+import com.vmware.vipclient.i18n.util.FormatUtils;\n import com.vmware.vipclient.i18n.util.JSONUtils;\n+import com.vmware.vipclient.i18n.util.LocaleUtility;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n public class LocaleService {\n-\n-    Logger                      logger        = LoggerFactory.getLogger(LocaleService.class.getName());\n+    Logger logger = LoggerFactory.getLogger(LocaleService.class.getName());\n     private static final String REGION_PREFIX = \"region_\";\n     public static final String DISPN_PREFIX  = \"dispn_\";\n+    private LocaleDTO dto;\n \n     public LocaleService() {\n+\n+    }\n+    public LocaleService(LocaleDTO dto) {\n+        this.dto = dto;\n+    }\n+\n+    public Map<String, String> getSupportedLanguages() {\n+        return getSupportedLanguages(null, LocaleUtility.getFallbackLocales().iterator());\n+    }\n+\n+    public Map<String, String> getSupportedLanguages(Iterator<Locale> fallbackLocalesIter) {\n+        return getSupportedLanguages(null, fallbackLocalesIter);\n+    }\n+\n+    public Map<String, String> getSupportedLanguages(String displayLanguageTag, Iterator<Locale> fallbackLocalesIter) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4NTMwNA=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MDM5OTU3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/dto/LocaleDTO.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzo1NTo1OFrOG4A_7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjowMDo1N1rOG51V4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4OTgwNw==", "bodyText": "LocaleDTO should have a locale name as its attribute.\nShouldn't have product name and version. They are about translation.\nLocale related data include pattern data, locale data, doesn't include translation.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461389807", "createdAt": "2020-07-28T07:55:58Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/dto/LocaleDTO.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Copyright 2019 VMware, Inc.\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package com.vmware.vipclient.i18n.messages.dto;\n+\n+import com.vmware.vipclient.i18n.VIPCfg;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class LocaleDTO extends BaseDTO {\n+    Logger logger = LoggerFactory.getLogger(LocaleDTO.class);\n+\n+    public LocaleDTO() {\n+        super.setProductID(VIPCfg.getInstance().getProductName());\n+        super.setVersion(VIPCfg.getInstance().getVersion());\n+    }\n+    public LocaleDTO(String productName, String version) {\n+        this.setProductID(productName);\n+        this.setVersion(version);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg2NDY2OQ==", "bodyText": "You already know that I disagree that product name and version are for \"translations only\". As I had expressed in the past, I view L2 resources as just another \"type\" of localized resource used by any product version. So product version applies here too. This is the same discussion we had for service API endpoints V3.\nFor example, an offline mode product version may only support 4 locales (only a subset of CLDR data) in the jar file, while the next version may have added one more locale, so 5 locales are supported in that version.\nWe are planning to use the same jar file for both online and offline mode bundles, but the jar file may be different per product version.\nLet's park this conversation.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461864669", "createdAt": "2020-07-28T20:40:16Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/dto/LocaleDTO.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Copyright 2019 VMware, Inc.\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package com.vmware.vipclient.i18n.messages.dto;\n+\n+import com.vmware.vipclient.i18n.VIPCfg;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class LocaleDTO extends BaseDTO {\n+    Logger logger = LoggerFactory.getLogger(LocaleDTO.class);\n+\n+    public LocaleDTO() {\n+        super.setProductID(VIPCfg.getInstance().getProductName());\n+        super.setVersion(VIPCfg.getInstance().getVersion());\n+    }\n+    public LocaleDTO(String productName, String version) {\n+        this.setProductID(productName);\n+        this.setVersion(version);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4OTgwNw=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4MzM4MA==", "bodyText": "What do you by locale name? Do you mean the language tag?\nLet's use the same terminologies:\n\nA \"Locale\" has a \"language tag\" and 1 or more \"display names\".\nA full \"language tag\" is in the following format : language-extlang-script-region-variant-extension-privateuse. The minimum is just a language (e.g.  \"en\")\n\nI agree that the language tag and a list of display names (0 or more) should be part of the LocaleDTO.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461883380", "createdAt": "2020-07-28T21:14:06Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/dto/LocaleDTO.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Copyright 2019 VMware, Inc.\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package com.vmware.vipclient.i18n.messages.dto;\n+\n+import com.vmware.vipclient.i18n.VIPCfg;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class LocaleDTO extends BaseDTO {\n+    Logger logger = LoggerFactory.getLogger(LocaleDTO.class);\n+\n+    public LocaleDTO() {\n+        super.setProductID(VIPCfg.getInstance().getProductName());\n+        super.setVersion(VIPCfg.getInstance().getVersion());\n+    }\n+    public LocaleDTO(String productName, String version) {\n+        this.setProductID(productName);\n+        this.setVersion(version);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4OTgwNw=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3MDUyNg==", "bodyText": "Only a product has its supported locales. A locale never has any data about a product.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461970526", "createdAt": "2020-07-29T00:34:03Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/dto/LocaleDTO.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Copyright 2019 VMware, Inc.\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package com.vmware.vipclient.i18n.messages.dto;\n+\n+import com.vmware.vipclient.i18n.VIPCfg;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class LocaleDTO extends BaseDTO {\n+    Logger logger = LoggerFactory.getLogger(LocaleDTO.class);\n+\n+    public LocaleDTO() {\n+        super.setProductID(VIPCfg.getInstance().getProductName());\n+        super.setVersion(VIPCfg.getInstance().getVersion());\n+    }\n+    public LocaleDTO(String productName, String version) {\n+        this.setProductID(productName);\n+        this.setVersion(version);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4OTgwNw=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI5NTk2OQ==", "bodyText": "I disagree with this as I said over slack. Let's park this discussion to later.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r463295969", "createdAt": "2020-07-30T22:00:57Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/dto/LocaleDTO.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Copyright 2019 VMware, Inc.\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package com.vmware.vipclient.i18n.messages.dto;\n+\n+import com.vmware.vipclient.i18n.VIPCfg;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class LocaleDTO extends BaseDTO {\n+    Logger logger = LoggerFactory.getLogger(LocaleDTO.class);\n+\n+    public LocaleDTO() {\n+        super.setProductID(VIPCfg.getInstance().getProductName());\n+        super.setVersion(VIPCfg.getInstance().getVersion());\n+    }\n+    public LocaleDTO(String productName, String version) {\n+        this.setProductID(productName);\n+        this.setVersion(version);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4OTgwNw=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MDg1MDY4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOTo1Mjo1N1rOG4FWww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjowNToxOVrOG51dCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ2MTE4Nw==", "bodyText": "I see you write new method to get componet list, this method isn't exposed to user, why not remove it?", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461461187", "createdAt": "2020-07-28T09:52:57Z", "author": {"login": "huihuiw01"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -4,27 +4,36 @@\n  */\n package com.vmware.vipclient.i18n.messages.service;\n \n-import java.util.ArrayList;\n-import java.util.List;\n-import java.util.Map;\n-\n-import org.json.simple.JSONArray;\n+import java.util.*;\n \n import com.vmware.vipclient.i18n.VIPCfg;\n import com.vmware.vipclient.i18n.base.DataSourceEnum;\n+import com.vmware.vipclient.i18n.common.ConstantsMsg;\n+import com.vmware.vipclient.i18n.messages.api.opt.ComponentOpt;\n import com.vmware.vipclient.i18n.messages.api.opt.server.ProductBasedOpt;\n import com.vmware.vipclient.i18n.messages.dto.BaseDTO;\n+import com.vmware.vipclient.i18n.messages.dto.LocaleDTO;\n import com.vmware.vipclient.i18n.messages.dto.MessagesDTO;\n+import com.vmware.vipclient.i18n.util.FormatUtils;\n import com.vmware.vipclient.i18n.util.LocaleUtility;\n+import org.json.simple.JSONArray;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n public class ProductService {\n-    private MessagesDTO dto = null;\n+    private BaseDTO dto = null;\n+    Logger logger = LoggerFactory.getLogger(ProductService.class);\n \n-    public ProductService(MessagesDTO dto) {\n+    public ProductService(BaseDTO dto) {\n         this.dto = dto;\n     }\n \n-    // get supported components defined in vip service\n+    /**\n+     * get supported components defined in vip service\n+     * @return JSONArray\n+     * @deprecated Replaced by {@link #getComponents(Iterator<>)}\n+     */\n+    @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3NzQ4OA==", "bodyText": "I'll do it in the next PR, or you can actually remove it in your PR.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461877488", "createdAt": "2020-07-28T21:03:13Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -4,27 +4,36 @@\n  */\n package com.vmware.vipclient.i18n.messages.service;\n \n-import java.util.ArrayList;\n-import java.util.List;\n-import java.util.Map;\n-\n-import org.json.simple.JSONArray;\n+import java.util.*;\n \n import com.vmware.vipclient.i18n.VIPCfg;\n import com.vmware.vipclient.i18n.base.DataSourceEnum;\n+import com.vmware.vipclient.i18n.common.ConstantsMsg;\n+import com.vmware.vipclient.i18n.messages.api.opt.ComponentOpt;\n import com.vmware.vipclient.i18n.messages.api.opt.server.ProductBasedOpt;\n import com.vmware.vipclient.i18n.messages.dto.BaseDTO;\n+import com.vmware.vipclient.i18n.messages.dto.LocaleDTO;\n import com.vmware.vipclient.i18n.messages.dto.MessagesDTO;\n+import com.vmware.vipclient.i18n.util.FormatUtils;\n import com.vmware.vipclient.i18n.util.LocaleUtility;\n+import org.json.simple.JSONArray;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n public class ProductService {\n-    private MessagesDTO dto = null;\n+    private BaseDTO dto = null;\n+    Logger logger = LoggerFactory.getLogger(ProductService.class);\n \n-    public ProductService(MessagesDTO dto) {\n+    public ProductService(BaseDTO dto) {\n         this.dto = dto;\n     }\n \n-    // get supported components defined in vip service\n+    /**\n+     * get supported components defined in vip service\n+     * @return JSONArray\n+     * @deprecated Replaced by {@link #getComponents(Iterator<>)}\n+     */\n+    @Deprecated", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ2MTE4Nw=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI5NzgwMA==", "bodyText": "I'll do it in this PR", "url": "https://github.com/vmware/singleton/pull/673#discussion_r463297800", "createdAt": "2020-07-30T22:05:19Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -4,27 +4,36 @@\n  */\n package com.vmware.vipclient.i18n.messages.service;\n \n-import java.util.ArrayList;\n-import java.util.List;\n-import java.util.Map;\n-\n-import org.json.simple.JSONArray;\n+import java.util.*;\n \n import com.vmware.vipclient.i18n.VIPCfg;\n import com.vmware.vipclient.i18n.base.DataSourceEnum;\n+import com.vmware.vipclient.i18n.common.ConstantsMsg;\n+import com.vmware.vipclient.i18n.messages.api.opt.ComponentOpt;\n import com.vmware.vipclient.i18n.messages.api.opt.server.ProductBasedOpt;\n import com.vmware.vipclient.i18n.messages.dto.BaseDTO;\n+import com.vmware.vipclient.i18n.messages.dto.LocaleDTO;\n import com.vmware.vipclient.i18n.messages.dto.MessagesDTO;\n+import com.vmware.vipclient.i18n.util.FormatUtils;\n import com.vmware.vipclient.i18n.util.LocaleUtility;\n+import org.json.simple.JSONArray;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n public class ProductService {\n-    private MessagesDTO dto = null;\n+    private BaseDTO dto = null;\n+    Logger logger = LoggerFactory.getLogger(ProductService.class);\n \n-    public ProductService(MessagesDTO dto) {\n+    public ProductService(BaseDTO dto) {\n         this.dto = dto;\n     }\n \n-    // get supported components defined in vip service\n+    /**\n+     * get supported components defined in vip service\n+     * @return JSONArray\n+     * @deprecated Replaced by {@link #getComponents(Iterator<>)}\n+     */\n+    @Deprecated", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ2MTE4Nw=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MDg1NjQzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOTo1NDozNFrOG4FaUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjowNjowNVrOG51eIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ2MjA5OA==", "bodyText": "This method isn't exposed to user, why not remove it?", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461462098", "createdAt": "2020-07-28T09:54:34Z", "author": {"login": "huihuiw01"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -33,7 +42,11 @@ public JSONArray getComponentsFromRemoteVIP() {\n         return dao.getComponentsFromRemoteVIP();\n     }\n \n-    // get supported locales defined in vip service\n+    /**\n+     * get supported locales defined in vip service\n+     * @deprecated Replaced by {@link com.vmware.vipclient.i18n.messages.service.LocaleService#getSupportedLanguages(Iterator<>)}\n+     */\n+    @Deprecated\n     public JSONArray getSupportedLocalesFromRemoteVIP() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3NzU3Ng==", "bodyText": "I'll do it in the next PR, or you can actually remove it in your PR.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461877576", "createdAt": "2020-07-28T21:03:26Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -33,7 +42,11 @@ public JSONArray getComponentsFromRemoteVIP() {\n         return dao.getComponentsFromRemoteVIP();\n     }\n \n-    // get supported locales defined in vip service\n+    /**\n+     * get supported locales defined in vip service\n+     * @deprecated Replaced by {@link com.vmware.vipclient.i18n.messages.service.LocaleService#getSupportedLanguages(Iterator<>)}\n+     */\n+    @Deprecated\n     public JSONArray getSupportedLocalesFromRemoteVIP() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ2MjA5OA=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI5ODA4Mw==", "bodyText": "I'll do it in this PR", "url": "https://github.com/vmware/singleton/pull/673#discussion_r463298083", "createdAt": "2020-07-30T22:06:05Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -33,7 +42,11 @@ public JSONArray getComponentsFromRemoteVIP() {\n         return dao.getComponentsFromRemoteVIP();\n     }\n \n-    // get supported locales defined in vip service\n+    /**\n+     * get supported locales defined in vip service\n+     * @deprecated Replaced by {@link com.vmware.vipclient.i18n.messages.service.LocaleService#getSupportedLanguages(Iterator<>)}\n+     */\n+    @Deprecated\n     public JSONArray getSupportedLocalesFromRemoteVIP() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ2MjA5OA=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MDkwOTg1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMDoxMDoxNVrOG4F79w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjowMzoxOVrOG51Zsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ3MDcxMQ==", "bodyText": "Refer to the comments xiaochao added to my PR, the fallback logic should move to a new method, thus one method is for getting exact translation(without fallback),  another is for getting translation with fallback.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461470711", "createdAt": "2020-07-28T10:10:15Z", "author": {"login": "huihuiw01"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -43,57 +43,65 @@ private void fetchMessages(final MessageCacheItem cacheItem, Iterator<DataSource\n     \t\treturn;\n     \t\n     \tlong timestampOld = cacheItem.getTimestamp();\n-    \tDataSourceEnum dataSource = (DataSourceEnum) msgSourceQueueIter.next();\n+    \tDataSourceEnum dataSource = msgSourceQueueIter.next();\n     \tdataSource.createMessageOpt(dto).getComponentMessages(cacheItem);\n-    \tlong timestampNew = cacheItem.getTimestamp();\n+    \tlong timestamp = cacheItem.getTimestamp();\n+    \tif (timestampOld == timestamp) {\n+    \t\tlogger.debug(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED, dto.getComponent(), dto.getLocale(), dataSource.toString()));\n+    \t}\n     \t\n-    \t// If failed to get messages from the data source\n-    \tif (timestampNew == timestampOld) {\n+    \t// Skip this block if timestamp is not 0 (which means cacheItem is in the cache) regardless if cacheItem is expired or not.\n+    \t// Otherwise, try the next dataSource in the queue.\n+    \tif (timestamp == 0) {\n     \t\t// Try the next dataSource in the queue\n     \t\tif (msgSourceQueueIter.hasNext()) {\n     \t\t\tfetchMessages(cacheItem, msgSourceQueueIter);\n     \t\t// If no more data source in queue, log the error. This means that neither online nor offline fetch succeeded.\n     \t\t} else {\n-    \t\t\tlogger.error(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED, dto.getComponent(), dto.getLocale(), dataSource.toString()));\n+    \t\t\tlogger.debug(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED_ALL, dto.getComponent(), dto.getLocale()));\n     \t\t}\n     \t}\n     }\n     \n     /**\n      * Get messages from cache\n      */\n-    public MessageCacheItem getMessages() {\n+    public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tCacheService cacheService = new CacheService(dto);\n-    \tMap<String, String> cacheOfComponent = null;\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tcacheOfComponent = cacheItem.getCachedData();\n     \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n     \t\t\t// Update the cache in a separate thread\n-    \t\t\tpopulateCacheTask(cacheItem); \t\t\n+    \t\t\tpopulateCacheTask(cacheItem);\n     \t\t}\n     \t} else { // Item is not in cache\n     \t\t// Create a new cacheItem object to be stored in cache\n-    \t\tcacheItem = new MessageCacheItem();  \n+    \t\tcacheItem = new MessageCacheItem();\n     \t\tfetchMessages(cacheItem, VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n-    \t\tcacheOfComponent = cacheItem.getCachedData();\n+    \t\tlong timestamp = cacheItem.getTimestamp();\n     \t\t\n-    \t\tif (cacheOfComponent != null && !cacheOfComponent.isEmpty()) {\n-    \t\t\tcacheService.addCacheOfComponent(cacheItem);\n-    \t\t}\n-    \t} \n+    \t\tif(!dto.getLocale().equals(ConstantsKeys.SOURCE)) {\n+    \t\t\t// If failed to fetch message, use MessageCacheItem of the next fallback locale.\n+    \t\t\tif (timestamp == 0 && fallbackLocalesIter.hasNext()) {\n+    \t\t\t\tMessagesDTO fallbackLocaleDTO = new MessagesDTO(dto.getComponent(), fallbackLocalesIter.next().toLanguageTag(), dto.getProductID(), dto.getVersion());\n+    \t\t\t\tcacheItem = new ComponentService(fallbackLocaleDTO).getMessages(fallbackLocalesIter);\n+    \t\t\t}\n+\t\t\t\tif (!cacheItem.getCachedData().isEmpty()) {\n+\t\t\t\t\tcacheService.addCacheOfComponent(cacheItem);\n+\t\t\t\t}\n+\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg2NjkwMA==", "bodyText": "I agree. Let's merge this PR and your PR first then I'd make the change in my next PR (so we finish this sooner)", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461866900", "createdAt": "2020-07-28T20:44:12Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -43,57 +43,65 @@ private void fetchMessages(final MessageCacheItem cacheItem, Iterator<DataSource\n     \t\treturn;\n     \t\n     \tlong timestampOld = cacheItem.getTimestamp();\n-    \tDataSourceEnum dataSource = (DataSourceEnum) msgSourceQueueIter.next();\n+    \tDataSourceEnum dataSource = msgSourceQueueIter.next();\n     \tdataSource.createMessageOpt(dto).getComponentMessages(cacheItem);\n-    \tlong timestampNew = cacheItem.getTimestamp();\n+    \tlong timestamp = cacheItem.getTimestamp();\n+    \tif (timestampOld == timestamp) {\n+    \t\tlogger.debug(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED, dto.getComponent(), dto.getLocale(), dataSource.toString()));\n+    \t}\n     \t\n-    \t// If failed to get messages from the data source\n-    \tif (timestampNew == timestampOld) {\n+    \t// Skip this block if timestamp is not 0 (which means cacheItem is in the cache) regardless if cacheItem is expired or not.\n+    \t// Otherwise, try the next dataSource in the queue.\n+    \tif (timestamp == 0) {\n     \t\t// Try the next dataSource in the queue\n     \t\tif (msgSourceQueueIter.hasNext()) {\n     \t\t\tfetchMessages(cacheItem, msgSourceQueueIter);\n     \t\t// If no more data source in queue, log the error. This means that neither online nor offline fetch succeeded.\n     \t\t} else {\n-    \t\t\tlogger.error(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED, dto.getComponent(), dto.getLocale(), dataSource.toString()));\n+    \t\t\tlogger.debug(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED_ALL, dto.getComponent(), dto.getLocale()));\n     \t\t}\n     \t}\n     }\n     \n     /**\n      * Get messages from cache\n      */\n-    public MessageCacheItem getMessages() {\n+    public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tCacheService cacheService = new CacheService(dto);\n-    \tMap<String, String> cacheOfComponent = null;\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tcacheOfComponent = cacheItem.getCachedData();\n     \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n     \t\t\t// Update the cache in a separate thread\n-    \t\t\tpopulateCacheTask(cacheItem); \t\t\n+    \t\t\tpopulateCacheTask(cacheItem);\n     \t\t}\n     \t} else { // Item is not in cache\n     \t\t// Create a new cacheItem object to be stored in cache\n-    \t\tcacheItem = new MessageCacheItem();  \n+    \t\tcacheItem = new MessageCacheItem();\n     \t\tfetchMessages(cacheItem, VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n-    \t\tcacheOfComponent = cacheItem.getCachedData();\n+    \t\tlong timestamp = cacheItem.getTimestamp();\n     \t\t\n-    \t\tif (cacheOfComponent != null && !cacheOfComponent.isEmpty()) {\n-    \t\t\tcacheService.addCacheOfComponent(cacheItem);\n-    \t\t}\n-    \t} \n+    \t\tif(!dto.getLocale().equals(ConstantsKeys.SOURCE)) {\n+    \t\t\t// If failed to fetch message, use MessageCacheItem of the next fallback locale.\n+    \t\t\tif (timestamp == 0 && fallbackLocalesIter.hasNext()) {\n+    \t\t\t\tMessagesDTO fallbackLocaleDTO = new MessagesDTO(dto.getComponent(), fallbackLocalesIter.next().toLanguageTag(), dto.getProductID(), dto.getVersion());\n+    \t\t\t\tcacheItem = new ComponentService(fallbackLocaleDTO).getMessages(fallbackLocalesIter);\n+    \t\t\t}\n+\t\t\t\tif (!cacheItem.getCachedData().isEmpty()) {\n+\t\t\t\t\tcacheService.addCacheOfComponent(cacheItem);\n+\t\t\t\t}\n+\t\t\t}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ3MDcxMQ=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI5Njk0Nw==", "bodyText": "Okay will do this now in this PR", "url": "https://github.com/vmware/singleton/pull/673#discussion_r463296947", "createdAt": "2020-07-30T22:03:19Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -43,57 +43,65 @@ private void fetchMessages(final MessageCacheItem cacheItem, Iterator<DataSource\n     \t\treturn;\n     \t\n     \tlong timestampOld = cacheItem.getTimestamp();\n-    \tDataSourceEnum dataSource = (DataSourceEnum) msgSourceQueueIter.next();\n+    \tDataSourceEnum dataSource = msgSourceQueueIter.next();\n     \tdataSource.createMessageOpt(dto).getComponentMessages(cacheItem);\n-    \tlong timestampNew = cacheItem.getTimestamp();\n+    \tlong timestamp = cacheItem.getTimestamp();\n+    \tif (timestampOld == timestamp) {\n+    \t\tlogger.debug(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED, dto.getComponent(), dto.getLocale(), dataSource.toString()));\n+    \t}\n     \t\n-    \t// If failed to get messages from the data source\n-    \tif (timestampNew == timestampOld) {\n+    \t// Skip this block if timestamp is not 0 (which means cacheItem is in the cache) regardless if cacheItem is expired or not.\n+    \t// Otherwise, try the next dataSource in the queue.\n+    \tif (timestamp == 0) {\n     \t\t// Try the next dataSource in the queue\n     \t\tif (msgSourceQueueIter.hasNext()) {\n     \t\t\tfetchMessages(cacheItem, msgSourceQueueIter);\n     \t\t// If no more data source in queue, log the error. This means that neither online nor offline fetch succeeded.\n     \t\t} else {\n-    \t\t\tlogger.error(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED, dto.getComponent(), dto.getLocale(), dataSource.toString()));\n+    \t\t\tlogger.debug(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED_ALL, dto.getComponent(), dto.getLocale()));\n     \t\t}\n     \t}\n     }\n     \n     /**\n      * Get messages from cache\n      */\n-    public MessageCacheItem getMessages() {\n+    public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tCacheService cacheService = new CacheService(dto);\n-    \tMap<String, String> cacheOfComponent = null;\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tcacheOfComponent = cacheItem.getCachedData();\n     \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n     \t\t\t// Update the cache in a separate thread\n-    \t\t\tpopulateCacheTask(cacheItem); \t\t\n+    \t\t\tpopulateCacheTask(cacheItem);\n     \t\t}\n     \t} else { // Item is not in cache\n     \t\t// Create a new cacheItem object to be stored in cache\n-    \t\tcacheItem = new MessageCacheItem();  \n+    \t\tcacheItem = new MessageCacheItem();\n     \t\tfetchMessages(cacheItem, VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n-    \t\tcacheOfComponent = cacheItem.getCachedData();\n+    \t\tlong timestamp = cacheItem.getTimestamp();\n     \t\t\n-    \t\tif (cacheOfComponent != null && !cacheOfComponent.isEmpty()) {\n-    \t\t\tcacheService.addCacheOfComponent(cacheItem);\n-    \t\t}\n-    \t} \n+    \t\tif(!dto.getLocale().equals(ConstantsKeys.SOURCE)) {\n+    \t\t\t// If failed to fetch message, use MessageCacheItem of the next fallback locale.\n+    \t\t\tif (timestamp == 0 && fallbackLocalesIter.hasNext()) {\n+    \t\t\t\tMessagesDTO fallbackLocaleDTO = new MessagesDTO(dto.getComponent(), fallbackLocalesIter.next().toLanguageTag(), dto.getProductID(), dto.getVersion());\n+    \t\t\t\tcacheItem = new ComponentService(fallbackLocaleDTO).getMessages(fallbackLocalesIter);\n+    \t\t\t}\n+\t\t\t\tif (!cacheItem.getCachedData().isEmpty()) {\n+\t\t\t\t\tcacheService.addCacheOfComponent(cacheItem);\n+\t\t\t\t}\n+\t\t\t}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ3MDcxMQ=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MTAxNjIyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/api/opt/server/ProductBasedOpt.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMDo0Mzo0N1rOG4G9sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMDozNjo0N1rOG4d3bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ4NzUzOQ==", "bodyText": "I see you re-implement getComponents in new classes RemoteComponentOpt and LocalComponentOpt, why not re-implement in this class directly, since this method is not exposed to user, you can change it freely; and in Singleton service side, componentlist API is put under product.\nIn my PR\uff0cI put it this method in ProductOpt, so we need reach agreement about this, or there will be duplicate/conflict code.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461487539", "createdAt": "2020-07-28T10:43:47Z", "author": {"login": "huihuiw01"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/api/opt/server/ProductBasedOpt.java", "diffHunk": "@@ -6,29 +6,30 @@\n \n import java.util.Map;\n \n-import org.json.simple.JSONArray;\n-\n import com.vmware.vipclient.i18n.VIPCfg;\n import com.vmware.vipclient.i18n.messages.api.opt.BaseOpt;\n import com.vmware.vipclient.i18n.messages.api.opt.Opt;\n import com.vmware.vipclient.i18n.messages.api.url.URLUtils;\n import com.vmware.vipclient.i18n.messages.api.url.V2URL;\n import com.vmware.vipclient.i18n.messages.dto.BaseDTO;\n import com.vmware.vipclient.i18n.util.ConstantsKeys;\n+import org.json.simple.JSONArray;\n \n+@Deprecated\n public class ProductBasedOpt extends BaseOpt implements Opt {\n     private BaseDTO dto = null;\n \n     public ProductBasedOpt(BaseDTO dto) {\n         this.dto = dto;\n     }\n \n-    /*\n+    /**\n      * get supported components from vip(non-Javadoc)\n      * \n      * @see com.vmware.vipclient.i18n.messages.dao.IComponentDao#getComponents()\n+     * @Deprecated Replaced by {@link com.vmware.vipclient.i18n.messages.api.opt.server.RemoteComponentOpt#getComponents()}\n      */\n-    public JSONArray getComponentsFromRemoteVIP() {\n+    @Deprecated public JSONArray getComponentsFromRemoteVIP() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg2Mjc2Ng==", "bodyText": "I saw ProductOpt in your PR and I am okay with it. I did not change the code here because you already have the code (and more) in your PR.  I would like to merge this PR first to g11n-java-client branch, so I do not repeat your code. Then could you take care of changing this when you merge your PR?", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461862766", "createdAt": "2020-07-28T20:36:47Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/api/opt/server/ProductBasedOpt.java", "diffHunk": "@@ -6,29 +6,30 @@\n \n import java.util.Map;\n \n-import org.json.simple.JSONArray;\n-\n import com.vmware.vipclient.i18n.VIPCfg;\n import com.vmware.vipclient.i18n.messages.api.opt.BaseOpt;\n import com.vmware.vipclient.i18n.messages.api.opt.Opt;\n import com.vmware.vipclient.i18n.messages.api.url.URLUtils;\n import com.vmware.vipclient.i18n.messages.api.url.V2URL;\n import com.vmware.vipclient.i18n.messages.dto.BaseDTO;\n import com.vmware.vipclient.i18n.util.ConstantsKeys;\n+import org.json.simple.JSONArray;\n \n+@Deprecated\n public class ProductBasedOpt extends BaseOpt implements Opt {\n     private BaseDTO dto = null;\n \n     public ProductBasedOpt(BaseDTO dto) {\n         this.dto = dto;\n     }\n \n-    /*\n+    /**\n      * get supported components from vip(non-Javadoc)\n      * \n      * @see com.vmware.vipclient.i18n.messages.dao.IComponentDao#getComponents()\n+     * @Deprecated Replaced by {@link com.vmware.vipclient.i18n.messages.api.opt.server.RemoteComponentOpt#getComponents()}\n      */\n-    public JSONArray getComponentsFromRemoteVIP() {\n+    @Deprecated public JSONArray getComponentsFromRemoteVIP() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ4NzUzOQ=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MTA1MTU1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/api/opt/ComponentOpt.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMDo1NDo1N1rOG4HTaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMDozMTo0MlrOG4dtEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ5MzA5OQ==", "bodyText": "on Singleton service side, componentlist API is put under product, so is it better rename the class name as 'ProductOpt'?", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461493099", "createdAt": "2020-07-28T10:54:57Z", "author": {"login": "huihuiw01"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/api/opt/ComponentOpt.java", "diffHunk": "@@ -0,0 +1,11 @@\n+/*\n+ * Copyright 2019 VMware, Inc.\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package com.vmware.vipclient.i18n.messages.api.opt;\n+\n+import java.util.List;\n+\n+public interface ComponentOpt {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg2MDExNA==", "bodyText": "Yes, you already have ProductOpt in your PR so did not bother to change here. Let's approve this PR then please merge it in your PR so that we can move forward?", "url": "https://github.com/vmware/singleton/pull/673#discussion_r461860114", "createdAt": "2020-07-28T20:31:42Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/api/opt/ComponentOpt.java", "diffHunk": "@@ -0,0 +1,11 @@\n+/*\n+ * Copyright 2019 VMware, Inc.\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package com.vmware.vipclient.i18n.messages.api.opt;\n+\n+import java.util.List;\n+\n+public interface ComponentOpt {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ5MzA5OQ=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDUzMTc0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/base/instances/TranslationMessage.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDozNTowN1rOG4oONg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMToxNjowMFrOG549bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzMjQzOA==", "bodyText": "Please don't fallback locale. Don't change the behavior of an existing interface", "url": "https://github.com/vmware/singleton/pull/673#discussion_r462032438", "createdAt": "2020-07-29T04:35:07Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/base/instances/TranslationMessage.java", "diffHunk": "@@ -303,7 +275,8 @@ public boolean postString(final Locale locale, final String component,\n             dto.setVersion(this.cfg.getVersion());\n         }\n         ComponentService cs = new ComponentService(dto);\n-        return cs.getMessages().getCachedData();\n+        Iterator<Locale> fallbackLocalesIter = LocaleUtility.getFallbackLocales().iterator();\n+        return cs.getMessages(fallbackLocalesIter).getCachedData();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI5NjY4Ng==", "bodyText": "Okay, I understood from Huihui's comment!\nNext time, please be more specific with the comment. When you said \"don't fallback locale\", it means to me that there should be no fallback behavior at all, which is incorrect. However, what you actually want (based on Huihui's comment)  is to move the fallback logic to another method.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r463296686", "createdAt": "2020-07-30T22:02:40Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/base/instances/TranslationMessage.java", "diffHunk": "@@ -303,7 +275,8 @@ public boolean postString(final Locale locale, final String component,\n             dto.setVersion(this.cfg.getVersion());\n         }\n         ComponentService cs = new ComponentService(dto);\n-        return cs.getMessages().getCachedData();\n+        Iterator<Locale> fallbackLocalesIter = LocaleUtility.getFallbackLocales().iterator();\n+        return cs.getMessages(fallbackLocalesIter).getCachedData();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzMjQzOA=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1NTI0Nw==", "bodyText": "You understand me correctly. There is no need to do locale fallback anywhere because there is no locale fallback at the beginning.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r463355247", "createdAt": "2020-07-31T01:16:00Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/base/instances/TranslationMessage.java", "diffHunk": "@@ -303,7 +275,8 @@ public boolean postString(final Locale locale, final String component,\n             dto.setVersion(this.cfg.getVersion());\n         }\n         ComponentService cs = new ComponentService(dto);\n-        return cs.getMessages().getCachedData();\n+        Iterator<Locale> fallbackLocalesIter = LocaleUtility.getFallbackLocales().iterator();\n+        return cs.getMessages(fallbackLocalesIter).getCachedData();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzMjQzOA=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDU3NDM3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDo1OTo0MFrOG4onfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjoxNzo1N1rOG51vfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzODkwOQ==", "bodyText": "Move this into the below if block because it's only used there.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r462038909", "createdAt": "2020-07-29T04:59:40Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -43,57 +43,65 @@ private void fetchMessages(final MessageCacheItem cacheItem, Iterator<DataSource\n     \t\treturn;\n     \t\n     \tlong timestampOld = cacheItem.getTimestamp();\n-    \tDataSourceEnum dataSource = (DataSourceEnum) msgSourceQueueIter.next();\n+    \tDataSourceEnum dataSource = msgSourceQueueIter.next();\n     \tdataSource.createMessageOpt(dto).getComponentMessages(cacheItem);\n-    \tlong timestampNew = cacheItem.getTimestamp();\n+    \tlong timestamp = cacheItem.getTimestamp();\n+    \tif (timestampOld == timestamp) {\n+    \t\tlogger.debug(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED, dto.getComponent(), dto.getLocale(), dataSource.toString()));\n+    \t}\n     \t\n-    \t// If failed to get messages from the data source\n-    \tif (timestampNew == timestampOld) {\n+    \t// Skip this block if timestamp is not 0 (which means cacheItem is in the cache) regardless if cacheItem is expired or not.\n+    \t// Otherwise, try the next dataSource in the queue.\n+    \tif (timestamp == 0) {\n     \t\t// Try the next dataSource in the queue\n     \t\tif (msgSourceQueueIter.hasNext()) {\n     \t\t\tfetchMessages(cacheItem, msgSourceQueueIter);\n     \t\t// If no more data source in queue, log the error. This means that neither online nor offline fetch succeeded.\n     \t\t} else {\n-    \t\t\tlogger.error(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED, dto.getComponent(), dto.getLocale(), dataSource.toString()));\n+    \t\t\tlogger.debug(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED_ALL, dto.getComponent(), dto.getLocale()));\n     \t\t}\n     \t}\n     }\n     \n     /**\n      * Get messages from cache\n      */\n-    public MessageCacheItem getMessages() {\n+    public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tCacheService cacheService = new CacheService(dto);\n-    \tMap<String, String> cacheOfComponent = null;\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tcacheOfComponent = cacheItem.getCachedData();\n     \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n     \t\t\t// Update the cache in a separate thread\n-    \t\t\tpopulateCacheTask(cacheItem); \t\t\n+    \t\t\tpopulateCacheTask(cacheItem);\n     \t\t}\n     \t} else { // Item is not in cache\n     \t\t// Create a new cacheItem object to be stored in cache\n-    \t\tcacheItem = new MessageCacheItem();  \n+    \t\tcacheItem = new MessageCacheItem();\n     \t\tfetchMessages(cacheItem, VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n-    \t\tcacheOfComponent = cacheItem.getCachedData();\n+    \t\tlong timestamp = cacheItem.getTimestamp();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMwMjUyNA==", "bodyText": "Okay", "url": "https://github.com/vmware/singleton/pull/673#discussion_r463302524", "createdAt": "2020-07-30T22:17:57Z", "author": {"login": "jessiejuachon"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -43,57 +43,65 @@ private void fetchMessages(final MessageCacheItem cacheItem, Iterator<DataSource\n     \t\treturn;\n     \t\n     \tlong timestampOld = cacheItem.getTimestamp();\n-    \tDataSourceEnum dataSource = (DataSourceEnum) msgSourceQueueIter.next();\n+    \tDataSourceEnum dataSource = msgSourceQueueIter.next();\n     \tdataSource.createMessageOpt(dto).getComponentMessages(cacheItem);\n-    \tlong timestampNew = cacheItem.getTimestamp();\n+    \tlong timestamp = cacheItem.getTimestamp();\n+    \tif (timestampOld == timestamp) {\n+    \t\tlogger.debug(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED, dto.getComponent(), dto.getLocale(), dataSource.toString()));\n+    \t}\n     \t\n-    \t// If failed to get messages from the data source\n-    \tif (timestampNew == timestampOld) {\n+    \t// Skip this block if timestamp is not 0 (which means cacheItem is in the cache) regardless if cacheItem is expired or not.\n+    \t// Otherwise, try the next dataSource in the queue.\n+    \tif (timestamp == 0) {\n     \t\t// Try the next dataSource in the queue\n     \t\tif (msgSourceQueueIter.hasNext()) {\n     \t\t\tfetchMessages(cacheItem, msgSourceQueueIter);\n     \t\t// If no more data source in queue, log the error. This means that neither online nor offline fetch succeeded.\n     \t\t} else {\n-    \t\t\tlogger.error(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED, dto.getComponent(), dto.getLocale(), dataSource.toString()));\n+    \t\t\tlogger.debug(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED_ALL, dto.getComponent(), dto.getLocale()));\n     \t\t}\n     \t}\n     }\n     \n     /**\n      * Get messages from cache\n      */\n-    public MessageCacheItem getMessages() {\n+    public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tCacheService cacheService = new CacheService(dto);\n-    \tMap<String, String> cacheOfComponent = null;\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tcacheOfComponent = cacheItem.getCachedData();\n     \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n     \t\t\t// Update the cache in a separate thread\n-    \t\t\tpopulateCacheTask(cacheItem); \t\t\n+    \t\t\tpopulateCacheTask(cacheItem);\n     \t\t}\n     \t} else { // Item is not in cache\n     \t\t// Create a new cacheItem object to be stored in cache\n-    \t\tcacheItem = new MessageCacheItem();  \n+    \t\tcacheItem = new MessageCacheItem();\n     \t\tfetchMessages(cacheItem, VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n-    \t\tcacheOfComponent = cacheItem.getCachedData();\n+    \t\tlong timestamp = cacheItem.getTimestamp();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzODkwOQ=="}, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDU3NzMxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNTowMToyMlrOG4opWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNTowMToyMlrOG4opWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzOTM4NA==", "bodyText": "If cacheItem.getCachedData().isEmpty() is false, should it return directly?", "url": "https://github.com/vmware/singleton/pull/673#discussion_r462039384", "createdAt": "2020-07-29T05:01:22Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -43,57 +43,65 @@ private void fetchMessages(final MessageCacheItem cacheItem, Iterator<DataSource\n     \t\treturn;\n     \t\n     \tlong timestampOld = cacheItem.getTimestamp();\n-    \tDataSourceEnum dataSource = (DataSourceEnum) msgSourceQueueIter.next();\n+    \tDataSourceEnum dataSource = msgSourceQueueIter.next();\n     \tdataSource.createMessageOpt(dto).getComponentMessages(cacheItem);\n-    \tlong timestampNew = cacheItem.getTimestamp();\n+    \tlong timestamp = cacheItem.getTimestamp();\n+    \tif (timestampOld == timestamp) {\n+    \t\tlogger.debug(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED, dto.getComponent(), dto.getLocale(), dataSource.toString()));\n+    \t}\n     \t\n-    \t// If failed to get messages from the data source\n-    \tif (timestampNew == timestampOld) {\n+    \t// Skip this block if timestamp is not 0 (which means cacheItem is in the cache) regardless if cacheItem is expired or not.\n+    \t// Otherwise, try the next dataSource in the queue.\n+    \tif (timestamp == 0) {\n     \t\t// Try the next dataSource in the queue\n     \t\tif (msgSourceQueueIter.hasNext()) {\n     \t\t\tfetchMessages(cacheItem, msgSourceQueueIter);\n     \t\t// If no more data source in queue, log the error. This means that neither online nor offline fetch succeeded.\n     \t\t} else {\n-    \t\t\tlogger.error(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED, dto.getComponent(), dto.getLocale(), dataSource.toString()));\n+    \t\t\tlogger.debug(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED_ALL, dto.getComponent(), dto.getLocale()));\n     \t\t}\n     \t}\n     }\n     \n     /**\n      * Get messages from cache\n      */\n-    public MessageCacheItem getMessages() {\n+    public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tCacheService cacheService = new CacheService(dto);\n-    \tMap<String, String> cacheOfComponent = null;\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tcacheOfComponent = cacheItem.getCachedData();\n     \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n     \t\t\t// Update the cache in a separate thread\n-    \t\t\tpopulateCacheTask(cacheItem); \t\t\n+    \t\t\tpopulateCacheTask(cacheItem);\n     \t\t}\n     \t} else { // Item is not in cache\n     \t\t// Create a new cacheItem object to be stored in cache\n-    \t\tcacheItem = new MessageCacheItem();  \n+    \t\tcacheItem = new MessageCacheItem();\n     \t\tfetchMessages(cacheItem, VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n-    \t\tcacheOfComponent = cacheItem.getCachedData();\n+    \t\tlong timestamp = cacheItem.getTimestamp();\n     \t\t\n-    \t\tif (cacheOfComponent != null && !cacheOfComponent.isEmpty()) {\n-    \t\t\tcacheService.addCacheOfComponent(cacheItem);\n-    \t\t}\n-    \t} \n+    \t\tif(!dto.getLocale().equals(ConstantsKeys.SOURCE)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDU4MzQ5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNTowNTowOVrOG4otOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNTowNTowOVrOG4otOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA0MDM3Nw==", "bodyText": "It's unnecessary to do local fallback here because the locales used here are supported no doubt.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r462040377", "createdAt": "2020-07-29T05:05:09Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ProductService.java", "diffHunk": "@@ -42,25 +55,56 @@ public JSONArray getSupportedLocalesFromRemoteVIP() {\n         return dao.getSupportedLocalesFromRemoteVIP();\n     }\n \n+    /**\n+     * Retrieves translated messages of all components of a product in the requested locale (See the dto object).\n+     *\n+     * @return translated messages of all components of a product locale specified in the dto object\n+     */\n     public List<Map> getAllComponentTranslation() {\n         List<Map> list = new ArrayList<Map>();\n-        Object[] locales = {};\n-        Object[] components = {};\n-        if (VIPCfg.getInstance().getMessageOrigin() == DataSourceEnum.VIP) {\n-            locales = this.getSupportedLocalesFromRemoteVIP().toArray();\n-            components = this.getComponentsFromRemoteVIP()\n-                    .toArray();\n-        }\n-        for (Object locale : locales) {\n-            for (Object component : components) {\n-                dto.setComponent(((String) component).trim());\n-                dto.setLocale(LocaleUtility.fmtToMappedLocale((String) locale).toString().trim());\n-                Map<String, String> retMap = new ComponentService(dto).getMessages().getCachedData();\n-                if (retMap != null) {\n-                    list.add(retMap);\n+        LocaleDTO localeDTO = new LocaleDTO(dto.getProductID(), dto.getVersion());\n+        Map<String, String> locales = new LocaleService(localeDTO).getSupportedLanguages();\n+        List<String> components = this.getComponents(VIPCfg.getInstance().getMsgOriginsQueue().iterator());\n+        if (locales != null) {\n+            for (String languageTag : locales.keySet()) {\n+                for (Object component : components) {\n+                    MessagesDTO msgDTO = new MessagesDTO(((String) component).trim(), LocaleUtility.fmtToMappedLocale(Locale.forLanguageTag(languageTag)).toString().trim(),\n+                            dto.getProductID(), dto.getVersion());\n+                    Iterator<Locale> fallbackLocalesIter = LocaleUtility.getFallbackLocales().iterator();\n+                    Map<String, String> retMap = new ComponentService(msgDTO).getMessages(fallbackLocalesIter).getCachedData();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDU5MjAzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/StringService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNToxMDowMVrOG4oybA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNToxMDowMVrOG4oybA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA0MTcwOA==", "bodyText": "Please don't do locale fallback in this method because this will change behavior of existing interface.", "url": "https://github.com/vmware/singleton/pull/673#discussion_r462041708", "createdAt": "2020-07-29T05:10:01Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/StringService.java", "diffHunk": "@@ -33,27 +33,10 @@\n     @SuppressWarnings(\"unchecked\")\n     @Deprecated\n     public String getString(MessagesDTO dto) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a698f202047d29cd793d87cd5718b4cb691ed2ec"}, "originalPosition": 3}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4487, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}