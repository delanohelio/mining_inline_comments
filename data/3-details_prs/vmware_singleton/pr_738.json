{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyOTcwMzQ0", "number": 738, "title": "[g11n-java-client] Fix for issue #717 - non-supported locales trigger a request to VIP service in a separate thread for every getMessage/getMessages request", "bodyText": "", "createdAt": "2020-08-25T06:20:10Z", "url": "https://github.com/vmware/singleton/pull/738", "merged": true, "mergeCommit": {"oid": "e8c3dde63ae25f36f967cd89435cbf26ef7457e5"}, "closed": true, "closedAt": "2020-09-01T16:28:39Z", "author": {"login": "jessiejuachon"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCRAhBAH2gAyNDcyOTcwMzQ0OmI1OGJiMjViNGY5NTEzMGVlNWJjZmQ1YjUwNGJhYjZmZmMxZDM4OWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEnKMjAFqTQ3OTcyNDQ0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b58bb25b4f95130ee5bcfd5b504bab6ffc1d389d", "author": {"user": {"login": "jessiejuachon", "name": "JESSIELY JUACHON"}}, "url": "https://github.com/vmware/singleton/commit/b58bb25b4f95130ee5bcfd5b504bab6ffc1d389d", "committedDate": "2020-08-25T06:14:02Z", "message": "Fix for bug 717"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MTkyMjEx", "url": "https://github.com/vmware/singleton/pull/738#pullrequestreview-474192211", "createdAt": "2020-08-25T07:08:50Z", "commit": {"oid": "b58bb25b4f95130ee5bcfd5b504bab6ffc1d389d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9935a6c9a2230700023edd56f9442c1adf12d4e8", "author": {"user": {"login": "jessiejuachon", "name": "JESSIELY JUACHON"}}, "url": "https://github.com/vmware/singleton/commit/9935a6c9a2230700023edd56f9442c1adf12d4e8", "committedDate": "2020-08-25T13:22:09Z", "message": "Updating license headers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NTI2MzMw", "url": "https://github.com/vmware/singleton/pull/738#pullrequestreview-474526330", "createdAt": "2020-08-25T14:16:00Z", "commit": {"oid": "9935a6c9a2230700023edd56f9442c1adf12d4e8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNDoxNjowMFrOHGaQCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNDoxNjowMFrOHGaQCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4MzU5Mw==", "bodyText": "Should add an 'else' before if?", "url": "https://github.com/vmware/singleton/pull/738#discussion_r476483593", "createdAt": "2020-08-25T14:16:00Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -105,14 +105,19 @@ public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n+    \t\tif (cacheItem.getCachedData().isEmpty()) { // This means that the data to be used is from a fallback locale.\n+\t\t\t\t// If expired, try to first create and store cacheItem for the requested locale in a separate thread.\n+\t\t\t\tif (cacheItem.isExpired())\n+\t\t\t\t\tthis.createCacheItemTask(fallbackLocalesIter);\n+\n+    \t\t\t// Use cached data of cacheItem.getLocale() --> fallback locale\n+\t\t\t\tMessagesDTO fallbackLocaleDTO = new MessagesDTO(dto.getComponent(), cacheItem.getLocale(), dto.getProductID(), dto.getVersion());\n+\t\t\t\tcacheItem = new ComponentService(fallbackLocaleDTO).getMessages(null);\n+\t\t\t}\n+\t\t\tif (cacheItem.isExpired()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9935a6c9a2230700023edd56f9442c1adf12d4e8"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NTQwOTc0", "url": "https://github.com/vmware/singleton/pull/738#pullrequestreview-474540974", "createdAt": "2020-08-25T14:30:37Z", "commit": {"oid": "b58bb25b4f95130ee5bcfd5b504bab6ffc1d389d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NTM1MTgx", "url": "https://github.com/vmware/singleton/pull/738#pullrequestreview-477535181", "createdAt": "2020-08-28T08:42:54Z", "commit": {"oid": "9935a6c9a2230700023edd56f9442c1adf12d4e8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwODo0Mjo1NFrOHIxA0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwODo1ODo1M1rOHIyQpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk1MzY4Mw==", "bodyText": "For creating second time, it doesn't need to do fallback. How about using 'resreshCache' without locale fallback? This will improve performance.", "url": "https://github.com/vmware/singleton/pull/738#discussion_r478953683", "createdAt": "2020-08-28T08:42:54Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -105,14 +105,19 @@ public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n+    \t\tif (cacheItem.getCachedData().isEmpty()) { // This means that the data to be used is from a fallback locale.\n+\t\t\t\t// If expired, try to first create and store cacheItem for the requested locale in a separate thread.\n+\t\t\t\tif (cacheItem.isExpired())\n+\t\t\t\t\tthis.createCacheItemTask(fallbackLocalesIter);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9935a6c9a2230700023edd56f9442c1adf12d4e8"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk3NDExNw==", "bodyText": "I think it's necessary to add it because the cache of fallback locale will be refreshed in line 115 because of the call getMessages with default locale.\nIf no 'else', it will be refreshed twice, right?", "url": "https://github.com/vmware/singleton/pull/738#discussion_r478974117", "createdAt": "2020-08-28T08:58:53Z", "author": {"login": "Xiaochao8"}, "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -105,14 +105,19 @@ public MessageCacheItem getMessages(Iterator<Locale> fallbackLocalesIter) {\n     \tMessageCacheItem cacheItem = null;\n     \tif (cacheService.isContainComponent()) { // Item is in cache\n     \t\tcacheItem = cacheService.getCacheOfComponent();\n-    \t\tif (cacheItem.isExpired()) { // cacheItem has expired\n+    \t\tif (cacheItem.getCachedData().isEmpty()) { // This means that the data to be used is from a fallback locale.\n+\t\t\t\t// If expired, try to first create and store cacheItem for the requested locale in a separate thread.\n+\t\t\t\tif (cacheItem.isExpired())\n+\t\t\t\t\tthis.createCacheItemTask(fallbackLocalesIter);\n+\n+    \t\t\t// Use cached data of cacheItem.getLocale() --> fallback locale\n+\t\t\t\tMessagesDTO fallbackLocaleDTO = new MessagesDTO(dto.getComponent(), cacheItem.getLocale(), dto.getProductID(), dto.getVersion());\n+\t\t\t\tcacheItem = new ComponentService(fallbackLocaleDTO).getMessages(null);\n+\t\t\t}\n+\t\t\tif (cacheItem.isExpired()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4MzU5Mw=="}, "originalCommit": {"oid": "9935a6c9a2230700023edd56f9442c1adf12d4e8"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1341e72cb76fc48b59159e94bd69b138317484f6", "author": {"user": {"login": "jessiejuachon", "name": "JESSIELY JUACHON"}}, "url": "https://github.com/vmware/singleton/commit/1341e72cb76fc48b59159e94bd69b138317484f6", "committedDate": "2020-08-31T20:59:46Z", "message": "Updates after code review - code optimization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NDc0Nzky", "url": "https://github.com/vmware/singleton/pull/738#pullrequestreview-479474792", "createdAt": "2020-09-01T07:37:15Z", "commit": {"oid": "1341e72cb76fc48b59159e94bd69b138317484f6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NzI0NDQ1", "url": "https://github.com/vmware/singleton/pull/738#pullrequestreview-479724445", "createdAt": "2020-09-01T13:10:22Z", "commit": {"oid": "1341e72cb76fc48b59159e94bd69b138317484f6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4281, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}