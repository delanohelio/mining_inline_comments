{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1ODAwODQ2", "number": 8389, "title": "KAFKA-9777; Remove txn purgatory to fix race condition on txn completion", "bodyText": "This patch addresses a locking issue with DelayTxnMarker completion. Because of the reliance on the shared read lock in TransactionStateManager and the deadlock avoidance algorithm in DelayedOperation, we cannot guarantee that a call to checkAndComplete will offer an opportunity to complete the job. This patch removes the reliance on this lock in two ways:\n\nWe replace the transaction marker purgatory with a map of transaction with pending markers. We were not using purgatory expiration anyway, so this avoids the locking issue and simplifies usage.\nWe were also relying on the read lock for the DelayedProduce completion when calling ReplicaManager.appendRecords. As far as I can tell, this was not necessary. The lock order is always 1) state read/write lock, 2) txn metadata locks. Since we only call appendRecords while holding the read lock, a deadlock does not seem possible.\n\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-03-30T17:45:24Z", "url": "https://github.com/apache/kafka/pull/8389", "merged": true, "mergeCommit": {"oid": "75e8ee1d1add308095d11bcf6d7ea8c499d92fc9"}, "closed": true, "closedAt": "2020-03-31T00:47:05Z", "author": {"login": "hachikuji"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSyCpmAH2gAyMzk1ODAwODQ2OmFjMzE2MzA0MmMyNWY2ZDdmMzdmZmU3YTUxOGQ4N2ZmYzg3MTMyMTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcS4pk-gFqTM4NDMzOTU5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ac3163042c25f6d7f37ffe7a518d87ffc8713216", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/ac3163042c25f6d7f37ffe7a518d87ffc8713216", "committedDate": "2020-03-30T17:34:52Z", "message": "KAFKA-9777; Remove txn purgatory to fix race condition on txn completion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MTI3Njgy", "url": "https://github.com/apache/kafka/pull/8389#pullrequestreview-384127682", "createdAt": "2020-03-30T18:38:01Z", "commit": {"oid": "ac3163042c25f6d7f37ffe7a518d87ffc8713216"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxODozODowMVrOF93FxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxODozODowMVrOF93FxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQxMDA1Mw==", "bodyText": "Since this is used for both CompleteCommit and CompleteAbort, perhaps it's clearer to name it PendingCompleteTxn?", "url": "https://github.com/apache/kafka/pull/8389#discussion_r400410053", "createdAt": "2020-03-30T18:38:01Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/coordinator/transaction/TransactionMarkerChannelManager.scala", "diffHunk": "@@ -373,19 +402,17 @@ class TransactionMarkerChannelManager(config: KafkaConfig,\n   }\n \n   def removeMarkersForTxnId(transactionalId: String): Unit = {\n-    // we do not need to clear the queue since it should have\n-    // already been drained by the sender thread\n-    txnMarkerPurgatory.cancelForKey(transactionalId)\n+    transactionsWithPendingMarkers.remove(transactionalId)\n   }\n \n   def completeSendMarkersForTxnId(transactionalId: String): Unit = {\n-    txnMarkerPurgatory.checkAndComplete(transactionalId)\n+    maybeWriteTxnCompletion(transactionalId)\n   }\n }\n \n case class TxnIdAndMarkerEntry(txnId: String, txnMarkerEntry: TxnMarkerEntry)\n \n-case class TxnLogAppend(transactionalId: String, coordinatorEpoch: Int, txnMetadata: TransactionMetadata, newMetadata: TxnTransitMetadata) {\n+case class PendingCommitTxn(transactionalId: String, coordinatorEpoch: Int, txnMetadata: TransactionMetadata, newMetadata: TxnTransitMetadata) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac3163042c25f6d7f37ffe7a518d87ffc8713216"}, "originalPosition": 269}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88b8b0fa10695bbcbbc40a554a2977481b31f8be", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/88b8b0fa10695bbcbbc40a554a2977481b31f8be", "committedDate": "2020-03-30T20:37:07Z", "message": "PendingCommitTxn -> PendingCompleteTxn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ffe6c0ec012debb77e9053048551ccf2416bdb9", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/2ffe6c0ec012debb77e9053048551ccf2416bdb9", "committedDate": "2020-03-30T22:34:12Z", "message": "Add new concurrency test case to reproduce bug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "2ffe6c0ec012debb77e9053048551ccf2416bdb9", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/2ffe6c0ec012debb77e9053048551ccf2416bdb9", "committedDate": "2020-03-30T22:34:12Z", "message": "Add new concurrency test case to reproduce bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0Mjg1NTI1", "url": "https://github.com/apache/kafka/pull/8389#pullrequestreview-384285525", "createdAt": "2020-03-30T22:45:36Z", "commit": {"oid": "2ffe6c0ec012debb77e9053048551ccf2416bdb9"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzM5NTkw", "url": "https://github.com/apache/kafka/pull/8389#pullrequestreview-384339590", "createdAt": "2020-03-31T01:16:49Z", "commit": {"oid": "2ffe6c0ec012debb77e9053048551ccf2416bdb9"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}