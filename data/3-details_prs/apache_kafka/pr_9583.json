{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4NjA5OTQw", "number": 9583, "title": "[KAFKA-10705]: Make state stores not readable by others", "bodyText": "Change permissions on the folders for the state store so they're no readable or writable by \"others\", but still accessible by owner and group members.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-11-10T16:26:57Z", "url": "https://github.com/apache/kafka/pull/9583", "merged": true, "mergeCommit": {"oid": "0b9c7512bf20da2b7123e0e14ec38790906651b8"}, "closed": true, "closedAt": "2020-11-13T18:44:09Z", "author": {"login": "lct45"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbMN0sgFqTUyNzM5MjQ3OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcLrunAFqTUzMDMxODIyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MzkyNDc4", "url": "https://github.com/apache/kafka/pull/9583#pullrequestreview-527392478", "createdAt": "2020-11-10T16:38:28Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjozODoyOFrOHwlVOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjo0NjoxOVrOHwlrSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwNTMzNw==", "bodyText": "Did we need to move this?", "url": "https://github.com/apache/kafka/pull/9583#discussion_r520705337", "createdAt": "2020-11-10T16:38:28Z", "author": {"login": "wcarlson5"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StateDirectory.java", "diffHunk": "@@ -30,11 +30,16 @@\n import java.nio.channels.FileChannel;\n import java.nio.channels.FileLock;\n import java.nio.channels.OverlappingFileLockException;\n-import java.nio.file.NoSuchFileException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcxMDk4Ng==", "bodyText": "Is changing the baseDir sufficient?", "url": "https://github.com/apache/kafka/pull/9583#discussion_r520710986", "createdAt": "2020-11-10T16:46:19Z", "author": {"login": "wcarlson5"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StateDirectory.java", "diffHunk": "@@ -102,6 +107,13 @@ public StateDirectory(final StreamsConfig config, final Time time, final boolean\n             log.warn(\"Using /tmp directory in the state.dir property can cause failures with writing the checkpoint file\" +\n                 \" due to the fact that this directory can be cleared by the OS\");\n         }\n+        final Path path = Paths.get(baseDir.getPath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79f387cc7f3307d621a38bf139b32a8593a43814", "author": {"user": {"login": "lct45", "name": "leah"}}, "url": "https://github.com/apache/kafka/commit/79f387cc7f3307d621a38bf139b32a8593a43814", "committedDate": "2020-11-10T17:15:32Z", "message": "make state store more secure"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "79f387cc7f3307d621a38bf139b32a8593a43814", "author": {"user": {"login": "lct45", "name": "leah"}}, "url": "https://github.com/apache/kafka/commit/79f387cc7f3307d621a38bf139b32a8593a43814", "committedDate": "2020-11-10T17:15:32Z", "message": "make state store more secure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NTg5Mzg1", "url": "https://github.com/apache/kafka/pull/9583#pullrequestreview-527589385", "createdAt": "2020-11-10T20:40:20Z", "commit": {"oid": "79f387cc7f3307d621a38bf139b32a8593a43814"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMDo0MDoyMFrOHwuxgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMDo0NTowM1rOHwu7lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2MDAzMw==", "bodyText": "Recently, we prefer to use assertThat() instead of assertEquals().", "url": "https://github.com/apache/kafka/pull/9583#discussion_r520860033", "createdAt": "2020-11-10T20:40:20Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StateDirectoryTest.java", "diffHunk": "@@ -106,6 +110,27 @@ public void shouldCreateBaseDirectory() {\n         assertTrue(appDir.isDirectory());\n     }\n \n+    @Test\n+    public void shouldHaveSecurePermissions() {\n+        final Set<PosixFilePermission> expectedPermissions = EnumSet.of(\n+            PosixFilePermission.OWNER_EXECUTE,\n+            PosixFilePermission.GROUP_READ,\n+            PosixFilePermission.OWNER_WRITE,\n+            PosixFilePermission.GROUP_EXECUTE,\n+            PosixFilePermission.OWNER_READ);\n+\n+        final Path statePath = Paths.get(stateDir.getPath());\n+        final Path basePath = Paths.get(appDir.getPath());\n+        try {\n+            final Set<PosixFilePermission> baseFilePermissions = Files.getPosixFilePermissions(statePath);\n+            final Set<PosixFilePermission> appFilePermissions = Files.getPosixFilePermissions(basePath);\n+            assertEquals(expectedPermissions, baseFilePermissions);\n+            assertEquals(expectedPermissions, appFilePermissions);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79f387cc7f3307d621a38bf139b32a8593a43814"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2MjYxMg==", "bodyText": "If we swallow the exception here, and the test always throws an IO exception, we will never notice. I guess it would be better to use fail() with a message.", "url": "https://github.com/apache/kafka/pull/9583#discussion_r520862612", "createdAt": "2020-11-10T20:45:03Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StateDirectoryTest.java", "diffHunk": "@@ -106,6 +110,27 @@ public void shouldCreateBaseDirectory() {\n         assertTrue(appDir.isDirectory());\n     }\n \n+    @Test\n+    public void shouldHaveSecurePermissions() {\n+        final Set<PosixFilePermission> expectedPermissions = EnumSet.of(\n+            PosixFilePermission.OWNER_EXECUTE,\n+            PosixFilePermission.GROUP_READ,\n+            PosixFilePermission.OWNER_WRITE,\n+            PosixFilePermission.GROUP_EXECUTE,\n+            PosixFilePermission.OWNER_READ);\n+\n+        final Path statePath = Paths.get(stateDir.getPath());\n+        final Path basePath = Paths.get(appDir.getPath());\n+        try {\n+            final Set<PosixFilePermission> baseFilePermissions = Files.getPosixFilePermissions(statePath);\n+            final Set<PosixFilePermission> appFilePermissions = Files.getPosixFilePermissions(basePath);\n+            assertEquals(expectedPermissions, baseFilePermissions);\n+            assertEquals(expectedPermissions, appFilePermissions);\n+        } catch (final IOException e) {\n+            // okay", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79f387cc7f3307d621a38bf139b32a8593a43814"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0909d8a23bfc259b6b91568f444f93db9c82261", "author": {"user": {"login": "lct45", "name": "leah"}}, "url": "https://github.com/apache/kafka/commit/d0909d8a23bfc259b6b91568f444f93db9c82261", "committedDate": "2020-11-10T21:42:22Z", "message": "clean up testing language"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NDc5OTU5", "url": "https://github.com/apache/kafka/pull/9583#pullrequestreview-529479959", "createdAt": "2020-11-12T20:40:32Z", "commit": {"oid": "d0909d8a23bfc259b6b91568f444f93db9c82261"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NTk3ODU0", "url": "https://github.com/apache/kafka/pull/9583#pullrequestreview-529597854", "createdAt": "2020-11-12T23:53:18Z", "commit": {"oid": "d0909d8a23bfc259b6b91568f444f93db9c82261"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMzo1MzoxOFrOHyTyMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMzo1MzoxOFrOHyTyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUxNDk5Mg==", "bodyText": "Just wondering, why \"read\" and \"execute\" permissions for the group?", "url": "https://github.com/apache/kafka/pull/9583#discussion_r522514992", "createdAt": "2020-11-12T23:53:18Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StateDirectory.java", "diffHunk": "@@ -102,6 +107,15 @@ public StateDirectory(final StreamsConfig config, final Time time, final boolean\n             log.warn(\"Using /tmp directory in the state.dir property can cause failures with writing the checkpoint file\" +\n                 \" due to the fact that this directory can be cleared by the OS\");\n         }\n+        final Path basePath = Paths.get(baseDir.getPath());\n+        final Path statePath = Paths.get(stateDir.getPath());\n+        final Set<PosixFilePermission> perms = PosixFilePermissions.fromString(\"rwxr-x---\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0909d8a23bfc259b6b91568f444f93db9c82261"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMzE4MjIw", "url": "https://github.com/apache/kafka/pull/9583#pullrequestreview-530318220", "createdAt": "2020-11-13T18:43:50Z", "commit": {"oid": "d0909d8a23bfc259b6b91568f444f93db9c82261"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2756, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}