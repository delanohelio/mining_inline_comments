{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0OTA3NzE2", "number": 8876, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMTozMzoxM1rOEFwDXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMTozODowMVrOEGkcxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NDY1NjMxOnYy", "diffSide": "RIGHT", "path": "clients/src/test/java/org/apache/kafka/clients/admin/MockAdminClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMTozMzoxM1rOGkILHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMTozMzoxM1rOGkILHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNTgzNg==", "bodyText": "nit: empty line.", "url": "https://github.com/apache/kafka/pull/8876#discussion_r440535836", "createdAt": "2020-06-16T01:33:13Z", "author": {"login": "mjsax"}, "path": "clients/src/test/java/org/apache/kafka/clients/admin/MockAdminClient.java", "diffHunk": "@@ -834,6 +855,13 @@ public AlterClientQuotasResult alterClientQuotas(Collection<ClientQuotaAlteratio\n     @Override\n     synchronized public void close(Duration timeout) {}\n \n+    public synchronized void updateBeginningOffsets(Map<TopicPartition, Long> newOffsets) {\n+        beginningOffsets.putAll(newOffsets);\n+    }\n+    public synchronized void updateEndOffsets(final Map<TopicPartition, Long> newOffsets) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NDY1ODE2OnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMTozNDozM1rOGkIMTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMjo1NjoyNVrOGkz4qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNjE0Mg==", "bodyText": "Why do we need this distinction? Seems we set adminClient in any case and it should never be null?", "url": "https://github.com/apache/kafka/pull/8876#discussion_r440536142", "createdAt": "2020-06-16T01:34:33Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -564,8 +576,15 @@ private void restoreChangelog(final ChangelogMetadata changelogMetadata) {\n             return Collections.emptyMap();\n \n         try {\n-            return restoreConsumer.endOffsets(partitions);\n-        } catch (final TimeoutException e) {\n+            if (adminClient != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwMjMyMw==", "bodyText": "I also do not understand the distinction. When would we want to call restoreConsumer.endOffsets(partitions)?", "url": "https://github.com/apache/kafka/pull/8876#discussion_r440802323", "createdAt": "2020-06-16T12:13:10Z", "author": {"login": "cadonna"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -564,8 +576,15 @@ private void restoreChangelog(final ChangelogMetadata changelogMetadata) {\n             return Collections.emptyMap();\n \n         try {\n-            return restoreConsumer.endOffsets(partitions);\n-        } catch (final TimeoutException e) {\n+            if (adminClient != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNjE0Mg=="}, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwOTMzMQ==", "bodyText": "req: Could you add a test (or adapt an existing one) and verify whether during restore() a call to adminClient.listOffsets() with isolation level READ_UNCOMMITTED is done?", "url": "https://github.com/apache/kafka/pull/8876#discussion_r440809331", "createdAt": "2020-06-16T12:26:25Z", "author": {"login": "cadonna"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -564,8 +576,15 @@ private void restoreChangelog(final ChangelogMetadata changelogMetadata) {\n             return Collections.emptyMap();\n \n         try {\n-            return restoreConsumer.endOffsets(partitions);\n-        } catch (final TimeoutException e) {\n+            if (adminClient != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNjE0Mg=="}, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzODQ2NQ==", "bodyText": "This is just a hack-around: I will always use admin-client by passing it via the constructor.\nI will add a unit test.", "url": "https://github.com/apache/kafka/pull/8876#discussion_r441038465", "createdAt": "2020-06-16T17:57:24Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -564,8 +576,15 @@ private void restoreChangelog(final ChangelogMetadata changelogMetadata) {\n             return Collections.emptyMap();\n \n         try {\n-            return restoreConsumer.endOffsets(partitions);\n-        } catch (final TimeoutException e) {\n+            if (adminClient != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNjE0Mg=="}, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIzNzE5OQ==", "bodyText": "Should we remove this check then?", "url": "https://github.com/apache/kafka/pull/8876#discussion_r441237199", "createdAt": "2020-06-17T01:59:10Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -564,8 +576,15 @@ private void restoreChangelog(final ChangelogMetadata changelogMetadata) {\n             return Collections.emptyMap();\n \n         try {\n-            return restoreConsumer.endOffsets(partitions);\n-        } catch (final TimeoutException e) {\n+            if (adminClient != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNjE0Mg=="}, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI0OTUxMQ==", "bodyText": "I think we can remove this null check? If you really want to add one, add it to the constructor?\nthis.adminClient = Objects.notNull(adminClient);", "url": "https://github.com/apache/kafka/pull/8876#discussion_r441249511", "createdAt": "2020-06-17T02:46:40Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -564,8 +576,15 @@ private void restoreChangelog(final ChangelogMetadata changelogMetadata) {\n             return Collections.emptyMap();\n \n         try {\n-            return restoreConsumer.endOffsets(partitions);\n-        } catch (final TimeoutException e) {\n+            if (adminClient != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNjE0Mg=="}, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1MjAwOQ==", "bodyText": "I just saw that we kinda need to pass null as AdminClient in TDD -- however, StoreChangelogReader#restore() is never called by TTD, and thus I still think we should remove the null check and fail hard with a NPE as it would indicate a bug if adminClient is null in a regular deployment.", "url": "https://github.com/apache/kafka/pull/8876#discussion_r441252009", "createdAt": "2020-06-17T02:56:25Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -564,8 +576,15 @@ private void restoreChangelog(final ChangelogMetadata changelogMetadata) {\n             return Collections.emptyMap();\n \n         try {\n-            return restoreConsumer.endOffsets(partitions);\n-        } catch (final TimeoutException e) {\n+            if (adminClient != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNjE0Mg=="}, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NDY2MzI0OnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMTozNzoyMVrOGkIPUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMToyODo1NVrOGkygfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNjkxNQ==", "bodyText": "Why is adminClient not final any longer? We still pass it into the StreamThread constructor.", "url": "https://github.com/apache/kafka/pull/8876#discussion_r440536915", "createdAt": "2020-06-16T01:37:21Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -273,13 +273,13 @@ public boolean isRunning() {\n     private volatile ThreadMetadata threadMetadata;\n     private StreamThread.StateListener stateListener;\n \n-    private final Admin adminClient;\n     private final ChangelogReader changelogReader;\n \n     // package-private for testing\n     final ConsumerRebalanceListener rebalanceListener;\n     final Consumer<byte[], byte[]> mainConsumer;\n     final Consumer<byte[], byte[]> restoreConsumer;\n+    final Admin adminClient;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc5OTUxOA==", "bodyText": "You mean private, right? It is not private anymore.\nInstead of making the adminClient field package private for testing, I would either add a setter setAdmin() to MockClientSupplier or instantiate the admin in a private field of the MockClientSupplier and use the existing getter to set up the admin, or instantiate the admin in a public field of the MockClientSupplier and accessing it directly to set it up (similarly to the producer and consumer).", "url": "https://github.com/apache/kafka/pull/8876#discussion_r440799518", "createdAt": "2020-06-16T12:07:58Z", "author": {"login": "cadonna"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -273,13 +273,13 @@ public boolean isRunning() {\n     private volatile ThreadMetadata threadMetadata;\n     private StreamThread.StateListener stateListener;\n \n-    private final Admin adminClient;\n     private final ChangelogReader changelogReader;\n \n     // package-private for testing\n     final ConsumerRebalanceListener rebalanceListener;\n     final Consumer<byte[], byte[]> mainConsumer;\n     final Consumer<byte[], byte[]> restoreConsumer;\n+    final Admin adminClient;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNjkxNQ=="}, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIyOTQzNw==", "bodyText": "Yeah I agree, will move all these variables to private and add getters.", "url": "https://github.com/apache/kafka/pull/8876#discussion_r441229437", "createdAt": "2020-06-17T01:28:55Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -273,13 +273,13 @@ public boolean isRunning() {\n     private volatile ThreadMetadata threadMetadata;\n     private StreamThread.StateListener stateListener;\n \n-    private final Admin adminClient;\n     private final ChangelogReader changelogReader;\n \n     // package-private for testing\n     final ConsumerRebalanceListener rebalanceListener;\n     final Consumer<byte[], byte[]> mainConsumer;\n     final Consumer<byte[], byte[]> restoreConsumer;\n+    final Admin adminClient;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNjkxNQ=="}, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NDcxNTk3OnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMjowODo0OFrOGkIwPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMjowODo0OFrOGkIwPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU0NTM0Mw==", "bodyText": "This is not used.", "url": "https://github.com/apache/kafka/pull/8876#discussion_r440545343", "createdAt": "2020-06-16T02:08:48Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -199,12 +204,19 @@ int bufferedLimitIndex() {\n     // to update offset limit for standby tasks;\n     private Consumer<byte[], byte[]> mainConsumer;\n \n+    // the changelog reader needs the admin client to list end offsets\n+    private Admin adminClient;\n+\n     private long lastUpdateOffsetTime;\n \n     void setMainConsumer(final Consumer<byte[], byte[]> consumer) {\n         this.mainConsumer = consumer;\n     }\n \n+    void setAdminClient(final Admin adminClient) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NjMxMzM5OnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjoxMDo0M1rOGkYXAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNToyNzozN1rOGkg8kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwMTAyNg==", "bodyText": "Q: Why do you not pass the admin client in the constructor?", "url": "https://github.com/apache/kafka/pull/8876#discussion_r440801026", "createdAt": "2020-06-16T12:10:43Z", "author": {"login": "cadonna"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -369,6 +369,7 @@ public static StreamThread create(final InternalTopologyBuilder builder,\n \n         final Consumer<byte[], byte[]> mainConsumer = clientSupplier.getConsumer(consumerConfigs);\n         changelogReader.setMainConsumer(mainConsumer);\n+        changelogReader.setAdminClient(adminClient);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk0MTcxNQ==", "bodyText": "Yeah that's the plan, I was just hacking it around so that I do not need to change 30+ unit tests. Once it is confirmed to fix the issue I will refactor this PR.", "url": "https://github.com/apache/kafka/pull/8876#discussion_r440941715", "createdAt": "2020-06-16T15:27:37Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -369,6 +369,7 @@ public static StreamThread create(final InternalTopologyBuilder builder,\n \n         final Consumer<byte[], byte[]> mainConsumer = clientSupplier.getConsumer(consumerConfigs);\n         changelogReader.setMainConsumer(mainConsumer);\n+        changelogReader.setAdminClient(adminClient);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwMTAyNg=="}, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NjM2NzYyOnYy", "diffSide": "RIGHT", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamThreadTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjoyNzowNlrOGkY44A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjoyNzowNlrOGkY44A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwOTY5Ng==", "bodyText": "See my comment in StreamThread.", "url": "https://github.com/apache/kafka/pull/8876#discussion_r440809696", "createdAt": "2020-06-16T12:27:06Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamThreadTest.java", "diffHunk": "@@ -1634,6 +1634,7 @@ public void shouldRecoverFromInvalidOffsetExceptionOnRestoreAndFinishRestore() t\n         final StreamThread thread = createStreamThread(\"clientId\", config, false);\n         final MockConsumer<byte[], byte[]> mockConsumer = (MockConsumer<byte[], byte[]>) thread.mainConsumer;\n         final MockConsumer<byte[], byte[]> mockRestoreConsumer = (MockConsumer<byte[], byte[]>) thread.restoreConsumer;\n+        final MockAdminClient mockAdminClient = (MockAdminClient) thread.adminClient;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9a27a8f8c57336cac9a1ad551f3c142049c07a2"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0OTA5OTAzOnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMjo0Nzo1NlrOGkzwPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMDo1OTo0NlrOGlXOXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI0OTg1NQ==", "bodyText": "Can this case ever apply? TTD should never restore any task from my understanding.", "url": "https://github.com/apache/kafka/pull/8876#discussion_r441249855", "createdAt": "2020-06-17T02:47:56Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -564,8 +574,16 @@ private void restoreChangelog(final ChangelogMetadata changelogMetadata) {\n             return Collections.emptyMap();\n \n         try {\n-            return restoreConsumer.endOffsets(partitions);\n-        } catch (final TimeoutException e) {\n+            if (adminClient != null) {\n+                final ListOffsetsResult result = adminClient.listOffsets(partitions.stream().collect(\n+                        Collectors.toMap(Function.identity(), tp -> OffsetSpec.latest())));\n+                return result.all().get().entrySet().stream().collect(\n+                        Collectors.toMap(Map.Entry::getKey, entry -> entry.getValue().offset()));\n+            } else {\n+                // we only fall back to use restore consumer if admin client is not set in TTD", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f816995d3a2c4e4eddae6c9db87a80f645389a8"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgzMTAwNw==", "bodyText": "TTD would still call this function though... after some thinking I've decided to add a mock-admin to streams:test-utils (the existing mock is in clients:test and hence cannot be relied on).", "url": "https://github.com/apache/kafka/pull/8876#discussion_r441831007", "createdAt": "2020-06-17T20:59:46Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -564,8 +574,16 @@ private void restoreChangelog(final ChangelogMetadata changelogMetadata) {\n             return Collections.emptyMap();\n \n         try {\n-            return restoreConsumer.endOffsets(partitions);\n-        } catch (final TimeoutException e) {\n+            if (adminClient != null) {\n+                final ListOffsetsResult result = adminClient.listOffsets(partitions.stream().collect(\n+                        Collectors.toMap(Function.identity(), tp -> OffsetSpec.latest())));\n+                return result.all().get().entrySet().stream().collect(\n+                        Collectors.toMap(Map.Entry::getKey, entry -> entry.getValue().offset()));\n+            } else {\n+                // we only fall back to use restore consumer if admin client is not set in TTD", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI0OTg1NQ=="}, "originalCommit": {"oid": "7f816995d3a2c4e4eddae6c9db87a80f645389a8"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0OTExODI4OnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMjo1OTo1MVrOGkz8Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMDo1OTo1M1rOGlXOjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1Mjg5NA==", "bodyText": "Should we set isolation.level explicitly? -- In case the default if ever changed, we would have a safe guard?", "url": "https://github.com/apache/kafka/pull/8876#discussion_r441252894", "createdAt": "2020-06-17T02:59:51Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -564,8 +574,16 @@ private void restoreChangelog(final ChangelogMetadata changelogMetadata) {\n             return Collections.emptyMap();\n \n         try {\n-            return restoreConsumer.endOffsets(partitions);\n-        } catch (final TimeoutException e) {\n+            if (adminClient != null) {\n+                final ListOffsetsResult result = adminClient.listOffsets(partitions.stream().collect(\n+                        Collectors.toMap(Function.identity(), tp -> OffsetSpec.latest())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f816995d3a2c4e4eddae6c9db87a80f645389a8"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgzMTA1NQ==", "bodyText": "Good point, will do.", "url": "https://github.com/apache/kafka/pull/8876#discussion_r441831055", "createdAt": "2020-06-17T20:59:53Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -564,8 +574,16 @@ private void restoreChangelog(final ChangelogMetadata changelogMetadata) {\n             return Collections.emptyMap();\n \n         try {\n-            return restoreConsumer.endOffsets(partitions);\n-        } catch (final TimeoutException e) {\n+            if (adminClient != null) {\n+                final ListOffsetsResult result = adminClient.listOffsets(partitions.stream().collect(\n+                        Collectors.toMap(Function.identity(), tp -> OffsetSpec.latest())));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1Mjg5NA=="}, "originalCommit": {"oid": "7f816995d3a2c4e4eddae6c9db87a80f645389a8"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzAzNDEyOnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMzozMDoyM1rOGlashQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMzozMDoyM1rOGlashQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg4Nzg3Nw==", "bodyText": "Did you check out the new methods in ClientUtils?", "url": "https://github.com/apache/kafka/pull/8876#discussion_r441887877", "createdAt": "2020-06-17T23:30:23Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -564,8 +576,13 @@ private void restoreChangelog(final ChangelogMetadata changelogMetadata) {\n             return Collections.emptyMap();\n \n         try {\n-            return restoreConsumer.endOffsets(partitions);\n-        } catch (final TimeoutException e) {\n+            final ListOffsetsResult result = adminClient.listOffsets(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6934cd6209d2db22d9ebc4a1fe8e0d296aac0072"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzI0MTAzOnYy", "diffSide": "RIGHT", "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMTozODowMVrOGlcr-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMjoyOTozN1rOGldeNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkyMDUwNA==", "bodyText": "This is the only thing I am wondering about. Why not just pass null?", "url": "https://github.com/apache/kafka/pull/8876#discussion_r441920504", "createdAt": "2020-06-18T01:38:01Z", "author": {"login": "mjsax"}, "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java", "diffHunk": "@@ -478,6 +479,7 @@ private void setupTask(final StreamsConfig streamsConfig,\n                     mockWallClockTime,\n                     streamsConfig,\n                     logContext,\n+                    createAdminClient(processorTopology.storeToChangelogTopic()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6934cd6209d2db22d9ebc4a1fe8e0d296aac0072"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzMzM2Ng==", "bodyText": "After thinking a bit more I agree with you now: I removed the mock admin client and instead just pass a mock register (since the register function may still be called)", "url": "https://github.com/apache/kafka/pull/8876#discussion_r441933366", "createdAt": "2020-06-18T02:29:37Z", "author": {"login": "guozhangwang"}, "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java", "diffHunk": "@@ -478,6 +479,7 @@ private void setupTask(final StreamsConfig streamsConfig,\n                     mockWallClockTime,\n                     streamsConfig,\n                     logContext,\n+                    createAdminClient(processorTopology.storeToChangelogTopic()),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkyMDUwNA=="}, "originalCommit": {"oid": "6934cd6209d2db22d9ebc4a1fe8e0d296aac0072"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2386, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}