{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3NTA5MDkz", "number": 8536, "title": "KAFKA-9883: Add better error message when REST API forwards a request and leader is not known", "bodyText": "When the Connect worker forwards a REST API request to the leader, it might get back a RequestTargetException that suggests the worker should forward the request to a different worker. This can happen when the leader changes, and the worker that receives the original request forwards the request to the worker that it thinks is the current leader, but that worker is not the current leader. In this case. In most cases, the worker that received the forwarded request includes the URL of the current leader, but it is possible (albeit rare) that the worker doesn\u2019t know the current leader and will include a null leader URL in the resulting RequestTargetException.\nWhen this rare case happens, the user gets a null pointer exception in their response and the NPE is logged. Instead, the worker should catch this condition and provide a more useful error message that is similar to other existing error messages that might occur.\nAdded a unit test that verifies this corner case is caught and this particular NPE does not occur.\nI recommend this be backported a few branches, as is typical for bug fixes.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-04-22T19:54:20Z", "url": "https://github.com/apache/kafka/pull/8536", "merged": true, "mergeCommit": {"oid": "2ecdca2814e232e038909c562fbfd667935ab69e"}, "closed": true, "closedAt": "2020-04-23T18:37:45Z", "author": {"login": "rhauch"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaNzkEAH2gAyNDA3NTA5MDkzOjFkNjZhNjMwMWU4NzI1NjFjMGFiMGM4MmU1ZGRkMjYwZjE5M2UwMDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcag_9QAFqTM5OTM1Njc2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1d66a6301e872561c0ab0c82e5ddd260f193e005", "author": {"user": {"login": "rhauch", "name": "Randall Hauch"}}, "url": "https://github.com/apache/kafka/commit/1d66a6301e872561c0ab0c82e5ddd260f193e005", "committedDate": "2020-04-22T19:53:12Z", "message": "KAFKA-9883: Add better error message when REST API forwards a request and leader is not known\n\nWhen the Connect worker forwards a REST API request to the leader, it might get back a `RequestTargetException` that suggests the worker should forward the request to a different worker. This can happen when the leader changes, and the worker that receives the original request forwards the request to the worker that it thinks is the current leader, but that worker is not the current leader. In this case. In most cases, the worker that received the forwarded request includes the URL of the current leader, but it is possible (albeit rare) that the worker doesn\u2019t know the current leader and will include a null leader URL in the resulting `RequestTargetException`.\n\nWhen this rare case happens, the user gets a null pointer exception in their response and the NPE is logged. Instead, the worker should catch this condition and provide a more useful error message that is similar to other existing error messages that might occur.\n\nAdded a unit test that verifies this corner case is caught and this particular NPE does not occur."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4Nzk5MTQ2", "url": "https://github.com/apache/kafka/pull/8536#pullrequestreview-398799146", "createdAt": "2020-04-23T06:41:21Z", "commit": {"oid": "1d66a6301e872561c0ab0c82e5ddd260f193e005"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNjo0MToyMVrOGKZCaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNjo0Njo0NVrOGKZM0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU0OTE2MQ==", "bodyText": "this second comment line doesn't read very clearly for me.\nwho's \"we\" in this case?\nwouldn't this probably means that a rebalance has taken place be as good?", "url": "https://github.com/apache/kafka/pull/8536#discussion_r413549161", "createdAt": "2020-04-23T06:41:21Z", "author": {"login": "kkonstantine"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/rest/resources/ConnectorsResource.java", "diffHunk": "@@ -341,7 +341,15 @@ private void checkAndPutConnectorConfigName(String connectorName, Map<String, St\n                     // this gives two total hops to resolve the request before giving up.\n                     boolean recursiveForward = forward == null;\n                     RequestTargetException targetException = (RequestTargetException) cause;\n-                    String forwardUrl = UriBuilder.fromUri(targetException.forwardUrl())\n+                    String forwardedUrl = targetException.forwardUrl();\n+                    if (forwardedUrl == null) {\n+                        // the target didn't know of the leader at this moment.\n+                        // we don't, it probably means that a rebalance has taken place.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d66a6301e872561c0ab0c82e5ddd260f193e005"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU1MTgyNA==", "bodyText": "nit: due to no known leader URL ... or similar", "url": "https://github.com/apache/kafka/pull/8536#discussion_r413551824", "createdAt": "2020-04-23T06:46:45Z", "author": {"login": "kkonstantine"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/rest/resources/ConnectorsResource.java", "diffHunk": "@@ -341,7 +341,15 @@ private void checkAndPutConnectorConfigName(String connectorName, Map<String, St\n                     // this gives two total hops to resolve the request before giving up.\n                     boolean recursiveForward = forward == null;\n                     RequestTargetException targetException = (RequestTargetException) cause;\n-                    String forwardUrl = UriBuilder.fromUri(targetException.forwardUrl())\n+                    String forwardedUrl = targetException.forwardUrl();\n+                    if (forwardedUrl == null) {\n+                        // the target didn't know of the leader at this moment.\n+                        // we don't, it probably means that a rebalance has taken place.\n+                        throw new ConnectRestException(Response.Status.CONFLICT.getStatusCode(),\n+                                \"Cannot complete request momentarily due no known leader URL, \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d66a6301e872561c0ab0c82e5ddd260f193e005"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a8291e646be08f30856dc98db148bfad203b3b5", "author": {"user": {"login": "rhauch", "name": "Randall Hauch"}}, "url": "https://github.com/apache/kafka/commit/2a8291e646be08f30856dc98db148bfad203b3b5", "committedDate": "2020-04-23T17:57:44Z", "message": "KAFKA-9883: Incorporate review feedback to clean up comment and exception message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MzU2NzYw", "url": "https://github.com/apache/kafka/pull/8536#pullrequestreview-399356760", "createdAt": "2020-04-23T18:14:56Z", "commit": {"oid": "2a8291e646be08f30856dc98db148bfad203b3b5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1186, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}