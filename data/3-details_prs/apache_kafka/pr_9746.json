{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5NDA1NTI4", "number": 9746, "title": "MINOR: Replace ApiVersion by auto-generated protocol", "bodyText": "This PR includes following changes.\n\nrename (auto-generated) ApiVersionsResponseKey to ApiVersion\nreplace clients/src/main/java/org/apache/kafka/clients/ApiVersion.java by auto-generated ApiVersion\n\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-12-14T12:12:30Z", "url": "https://github.com/apache/kafka/pull/9746", "merged": true, "mergeCommit": {"oid": "f7c0b0d1728c0d5ccac90776be86d2c4740633cc"}, "closed": true, "closedAt": "2021-01-19T16:37:46Z", "author": {"login": "chia7712"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmm3W-gBqjQxMTc3MTg5MDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdxtoCXgFqTU3MTQwMjc4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5f5f6cf24f2855ad8bbd690aa344e21c59674be", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/f5f5f6cf24f2855ad8bbd690aa344e21c59674be", "committedDate": "2020-12-14T12:11:09Z", "message": "MINOR: substitue ApiVersionsResponseKey for ApiVersion"}, "afterCommit": {"oid": "9732583ba265ec15a2993bc90bf6272b73219b00", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/9732583ba265ec15a2993bc90bf6272b73219b00", "committedDate": "2020-12-16T04:02:56Z", "message": "MINOR: substitue ApiVersionsResponseKey for ApiVersion"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9732583ba265ec15a2993bc90bf6272b73219b00", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/9732583ba265ec15a2993bc90bf6272b73219b00", "committedDate": "2020-12-16T04:02:56Z", "message": "MINOR: substitue ApiVersionsResponseKey for ApiVersion"}, "afterCommit": {"oid": "fc66801595cde68ab73a0db9427af801655d17ac", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/fc66801595cde68ab73a0db9427af801655d17ac", "committedDate": "2020-12-16T15:33:25Z", "message": "MINOR: substitue ApiVersionsResponseKey for ApiVersion"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc66801595cde68ab73a0db9427af801655d17ac", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/fc66801595cde68ab73a0db9427af801655d17ac", "committedDate": "2020-12-16T15:33:25Z", "message": "MINOR: substitue ApiVersionsResponseKey for ApiVersion"}, "afterCommit": {"oid": "a2d90e4647535f6a70717608013430fccfa70588", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/a2d90e4647535f6a70717608013430fccfa70588", "committedDate": "2021-01-04T17:40:05Z", "message": "MINOR: substitue ApiVersionsResponseKey for ApiVersion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyNzczMDQ0", "url": "https://github.com/apache/kafka/pull/9746#pullrequestreview-562773044", "createdAt": "2021-01-06T14:56:25Z", "commit": {"oid": "a2d90e4647535f6a70717608013430fccfa70588"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQxNDo1NjoyNVrOIPFZmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQxNDo1NjoyNVrOIPFZmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjY4ODAyNg==", "bodyText": "Should we rename the generated class to have a more concise name? It seems unnecessarily verbose.", "url": "https://github.com/apache/kafka/pull/9746#discussion_r552688026", "createdAt": "2021-01-06T14:56:25Z", "author": {"login": "ijuma"}, "path": "clients/src/main/java/org/apache/kafka/clients/NodeApiVersions.java", "diffHunk": "@@ -37,18 +36,18 @@\n public class NodeApiVersions {\n \n     // A map of the usable versions of each API, keyed by the ApiKeys instance\n-    private final Map<ApiKeys, ApiVersion> supportedVersions = new EnumMap<>(ApiKeys.class);\n+    private final Map<ApiKeys, ApiVersionsResponseKey> supportedVersions = new EnumMap<>(ApiKeys.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2d90e4647535f6a70717608013430fccfa70588"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a2d90e4647535f6a70717608013430fccfa70588", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/a2d90e4647535f6a70717608013430fccfa70588", "committedDate": "2021-01-04T17:40:05Z", "message": "MINOR: substitue ApiVersionsResponseKey for ApiVersion"}, "afterCommit": {"oid": "58cf3a6925f63259aac315c4097aa8dde85c0eb3", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/58cf3a6925f63259aac315c4097aa8dde85c0eb3", "committedDate": "2021-01-06T15:36:30Z", "message": "raname ApiVersionsResponseKey to ApiVersion"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58cf3a6925f63259aac315c4097aa8dde85c0eb3", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/58cf3a6925f63259aac315c4097aa8dde85c0eb3", "committedDate": "2021-01-06T15:36:30Z", "message": "raname ApiVersionsResponseKey to ApiVersion"}, "afterCommit": {"oid": "c79c29c466a951db682dd1beec3bd9eecd2ade09", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/c79c29c466a951db682dd1beec3bd9eecd2ade09", "committedDate": "2021-01-11T13:59:15Z", "message": "fix style"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b53bb9353dbc1dae03a99bbd43ade50a3fa23c98", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/b53bb9353dbc1dae03a99bbd43ade50a3fa23c98", "committedDate": "2021-01-15T19:19:22Z", "message": "Merge branch 'trunk' into MINOR-9746"}, "afterCommit": {"oid": "81dd7d62549e42ff72e6b6305eeb89b3220c4735", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/81dd7d62549e42ff72e6b6305eeb89b3220c4735", "committedDate": "2021-01-16T19:05:53Z", "message": "MINOR: Replace ApiVersion by auto-generated protocol"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2cd983d263746fa57731b5cfab6d5de40a75ae2", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/d2cd983d263746fa57731b5cfab6d5de40a75ae2", "committedDate": "2021-01-16T19:09:16Z", "message": "MINOR: Replace ApiVersion by auto-generated protocol"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81dd7d62549e42ff72e6b6305eeb89b3220c4735", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/81dd7d62549e42ff72e6b6305eeb89b3220c4735", "committedDate": "2021-01-16T19:05:53Z", "message": "MINOR: Replace ApiVersion by auto-generated protocol"}, "afterCommit": {"oid": "d2cd983d263746fa57731b5cfab6d5de40a75ae2", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/d2cd983d263746fa57731b5cfab6d5de40a75ae2", "committedDate": "2021-01-16T19:09:16Z", "message": "MINOR: Replace ApiVersion by auto-generated protocol"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwODQwODEw", "url": "https://github.com/apache/kafka/pull/9746#pullrequestreview-570840810", "createdAt": "2021-01-19T00:58:06Z", "commit": {"oid": "d2cd983d263746fa57731b5cfab6d5de40a75ae2"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQwMDo1ODowNlrOIV6wHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQwMTowMzowOVrOIV60TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTg1MzU5Nw==", "bodyText": "Can we import ApiVersion directly? I don't think ApiVersionsResponseData adds any value here and other similar places.", "url": "https://github.com/apache/kafka/pull/9746#discussion_r559853597", "createdAt": "2021-01-19T00:58:06Z", "author": {"login": "ijuma"}, "path": "clients/src/main/java/org/apache/kafka/clients/NodeApiVersions.java", "diffHunk": "@@ -39,18 +38,18 @@\n public class NodeApiVersions {\n \n     // A map of the usable versions of each API, keyed by the ApiKeys instance\n-    private final Map<ApiKeys, ApiVersion> supportedVersions = new EnumMap<>(ApiKeys.class);\n+    private final Map<ApiKeys, ApiVersionsResponseData.ApiVersion> supportedVersions = new EnumMap<>(ApiKeys.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2cd983d263746fa57731b5cfab6d5de40a75ae2"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTg1MzgwNQ==", "bodyText": "It would be good to have a helper method somewhere that converts ApiKeys to ApiVersion.", "url": "https://github.com/apache/kafka/pull/9746#discussion_r559853805", "createdAt": "2021-01-19T00:58:59Z", "author": {"login": "ijuma"}, "path": "clients/src/main/java/org/apache/kafka/clients/NodeApiVersions.java", "diffHunk": "@@ -60,18 +59,21 @@ public static NodeApiVersions create() {\n      *                  value.\n      * @return A new NodeApiVersions object.\n      */\n-    public static NodeApiVersions create(Collection<ApiVersion> overrides) {\n-        List<ApiVersion> apiVersions = new LinkedList<>(overrides);\n+    public static NodeApiVersions create(Collection<ApiVersionsResponseData.ApiVersion> overrides) {\n+        List<ApiVersionsResponseData.ApiVersion> apiVersions = new LinkedList<>(overrides);\n         for (ApiKeys apiKey : ApiKeys.enabledApis()) {\n             boolean exists = false;\n-            for (ApiVersion apiVersion : apiVersions) {\n-                if (apiVersion.apiKey == apiKey.id) {\n+            for (ApiVersionsResponseData.ApiVersion apiVersion : apiVersions) {\n+                if (apiVersion.apiKey() == apiKey.id) {\n                     exists = true;\n                     break;\n                 }\n             }\n             if (!exists) {\n-                apiVersions.add(new ApiVersion(apiKey));\n+                apiVersions.add(new ApiVersionsResponseData.ApiVersion()\n+                        .setApiKey(apiKey.id)\n+                        .setMinVersion(apiKey.oldestVersion())\n+                        .setMaxVersion(apiKey.latestVersion()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2cd983d263746fa57731b5cfab6d5de40a75ae2"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTg1NDU0Mg==", "bodyText": "It's a bit weird that we only check if other is null. Do we need this check at all?", "url": "https://github.com/apache/kafka/pull/9746#discussion_r559854542", "createdAt": "2021-01-19T01:02:29Z", "author": {"login": "ijuma"}, "path": "clients/src/main/java/org/apache/kafka/common/requests/ApiVersionsResponse.java", "diffHunk": "@@ -220,4 +217,16 @@ private static FinalizedFeatureKeyCollection createFinalizedFeatureKeys(\n \n         return converted;\n     }\n+\n+    public static Optional<ApiVersionsResponseData.ApiVersion> intersect(ApiVersionsResponseData.ApiVersion thisVersion,\n+                                                                         ApiVersionsResponseData.ApiVersion other) {\n+        if (other == null) return Optional.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2cd983d263746fa57731b5cfab6d5de40a75ae2"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTg1NDY2OA==", "bodyText": "We can use the helper that converts from ApiKey to ApiVersion here too.", "url": "https://github.com/apache/kafka/pull/9746#discussion_r559854668", "createdAt": "2021-01-19T01:03:09Z", "author": {"login": "ijuma"}, "path": "clients/src/test/java/org/apache/kafka/clients/NodeApiVersionsTest.java", "diffHunk": "@@ -56,12 +54,18 @@ public void testUnknownApiVersionsToString() {\n \n     @Test\n     public void testVersionsToString() {\n-        List<ApiVersion> versionList = new ArrayList<>();\n+        List<ApiVersionsResponseData.ApiVersion> versionList = new ArrayList<>();\n         for (ApiKeys apiKey : ApiKeys.values()) {\n             if (apiKey == ApiKeys.DELETE_TOPICS) {\n-                versionList.add(new ApiVersion(apiKey.id, (short) 10000, (short) 10001));\n+                versionList.add(new ApiVersionsResponseData.ApiVersion()\n+                        .setApiKey(apiKey.id)\n+                        .setMinVersion((short) 10000)\n+                        .setMaxVersion((short) 10001));\n             } else {\n-                versionList.add(new ApiVersion(apiKey));\n+                versionList.add(new ApiVersionsResponseData.ApiVersion()\n+                        .setApiKey(apiKey.id)\n+                        .setMinVersion(apiKey.oldestVersion())\n+                        .setMaxVersion(apiKey.latestVersion()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2cd983d263746fa57731b5cfab6d5de40a75ae2"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7da8093e7f5fade3707f3349789d3bbad4c76689", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/7da8093e7f5fade3707f3349789d3bbad4c76689", "committedDate": "2021-01-19T04:30:00Z", "message": "Merge branch 'trunk' into MINOR-9746"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwOTA5NDQy", "url": "https://github.com/apache/kafka/pull/9746#pullrequestreview-570909442", "createdAt": "2021-01-19T05:07:56Z", "commit": {"oid": "7da8093e7f5fade3707f3349789d3bbad4c76689"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQwNTowNzo1N1rOIV-m3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQwNTowNzo1N1rOIV-m3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTkxNjc2NA==", "bodyText": "Indent change here seems unintentional.", "url": "https://github.com/apache/kafka/pull/9746#discussion_r559916764", "createdAt": "2021-01-19T05:07:57Z", "author": {"login": "ijuma"}, "path": "core/src/test/scala/unit/kafka/server/AbstractApiVersionsRequestTest.scala", "diffHunk": "@@ -52,9 +52,9 @@ abstract class AbstractApiVersionsRequestTest extends BaseRequestTest {\n     if (listenerName == controlPlaneListenerName) {\n       expectedApis.add(ApiKeys.ENVELOPE)\n     }\n-    assertEquals(\"API keys in ApiVersionsResponse must match API keys supported by broker.\",\n-      expectedApis.size(), apiVersionsResponse.data.apiKeys().size())\n-    for (expectedApiVersion: ApiVersionsResponseData.ApiVersion <- ApiVersionsResponse.DEFAULT_API_VERSIONS_RESPONSE.data.apiKeys().asScala) {\n+    assertEquals(expectedApis.size(), apiVersionsResponse.data.apiKeys().size(),\n+      \"API keys in ApiVersionsResponse must match API keys supported by broker.\")\n+      for (expectedApiVersion: ApiVersionsResponseData.ApiVersion <- ApiVersionsResponse.DEFAULT_API_VERSIONS_RESPONSE.data.apiKeys().asScala) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7da8093e7f5fade3707f3349789d3bbad4c76689"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "364f4de7dd7eac01d3ead065106903afad30f0e1", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/364f4de7dd7eac01d3ead065106903afad30f0e1", "committedDate": "2021-01-19T05:36:17Z", "message": "import inner classes; improve ApiVersionsResponse.intersect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4584d0dbc769428c2712734f42e84692f9832e42", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/4584d0dbc769428c2712734f42e84692f9832e42", "committedDate": "2021-01-19T10:19:46Z", "message": "Merge branch 'trunk' into MINOR-9746"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcxNDAyNzgw", "url": "https://github.com/apache/kafka/pull/9746#pullrequestreview-571402780", "createdAt": "2021-01-19T16:08:59Z", "commit": {"oid": "4584d0dbc769428c2712734f42e84692f9832e42"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2294, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}