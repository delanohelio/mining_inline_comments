{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NTcwNDc2", "number": 8118, "title": "KAFKA-9472: Remove deleted Connect tasks from status store", "bodyText": "Jira\nAlthough the statuses for tasks are removed from the status store when their connector is deleted, their statuses are not removed when only the task is deleted, which happens in the case that the number of tasks for a connector is reduced.\nThese changes add logic for deleting the statuses for those tasks from the status store whenever a rebalance has completed and the leader of a distributed cluster has detected that there are recently-deleted tasks. Standalone is also updated to accomplish this.\nUnit tests for the DistributedHerder and StandaloneHerder classes are updated, and an integration test has been added.", "createdAt": "2020-02-14T20:58:16Z", "url": "https://github.com/apache/kafka/pull/8118", "merged": true, "mergeCommit": {"oid": "de6468ae5915298279e229dc64721e01e7d14fab"}, "closed": true, "closedAt": "2020-05-25T16:10:04Z", "author": {"login": "C0urante"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEWIO6gH2gAyMzc1NTcwNDc2OmYzYWExZGYzYzMyY2I2YTEwZTBkZmVhZWVhNTA2MTYyNTY2MDkyNmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABckyVy-gFqTQxNzc5NTM4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f3aa1df3c32cb6a10e0dfeaeea5061625660926d", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/f3aa1df3c32cb6a10e0dfeaeea5061625660926d", "committedDate": "2020-02-14T21:08:41Z", "message": "KAFKA-9472: Add failing integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "930561a05ef26ec3fcf090df7f64f0ed59b13746", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/930561a05ef26ec3fcf090df7f64f0ed59b13746", "committedDate": "2020-02-14T21:08:41Z", "message": "KAFKA-9472: Delete statuses of no-longer-needed tasks in distributed mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02d97ec9e6126a2a8230b2e287143e762ea02c16", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/02d97ec9e6126a2a8230b2e287143e762ea02c16", "committedDate": "2020-02-14T21:08:41Z", "message": "KAFKA-9472: Delete statuses of no-longer-needed tasks in standalone mode"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "02d97ec9e6126a2a8230b2e287143e762ea02c16", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/02d97ec9e6126a2a8230b2e287143e762ea02c16", "committedDate": "2020-02-14T21:08:41Z", "message": "KAFKA-9472: Delete statuses of no-longer-needed tasks in standalone mode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NTkzODQz", "url": "https://github.com/apache/kafka/pull/8118#pullrequestreview-367593843", "createdAt": "2020-03-02T23:02:13Z", "commit": {"oid": "02d97ec9e6126a2a8230b2e287143e762ea02c16"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMzowMjoxM1rOFwyiww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMzowMjoxM1rOFwyiww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjcwNDA2Nw==", "bodyText": "Will the DESTROYED tasks show up in REST so that we can add an assertion to make sure they are not UNASSIGNED?", "url": "https://github.com/apache/kafka/pull/8118#discussion_r386704067", "createdAt": "2020-03-02T23:02:13Z", "author": {"login": "ncliang"}, "path": "connect/runtime/src/test/java/org/apache/kafka/connect/integration/ConnectWorkerIntegrationTest.java", "diffHunk": "@@ -236,4 +236,39 @@ public void testBrokerCoordinator() throws Exception {\n                 \"Connector tasks did not start in time.\");\n     }\n \n+    /**\n+     * Verify that the number of tasks listed in the REST API is updated correctly after changes to\n+     * the \"tasks.max\" connector configuration.\n+     */\n+    @Test\n+    public void testTaskStatuses() throws Exception {\n+        connect = connectBuilder.build();\n+        // start the clusters\n+        connect.start();\n+\n+        connect.assertions().assertAtLeastNumWorkersAreUp(NUM_WORKERS,\n+            \"Initial group of workers did not start in time.\");\n+\n+        // base connector props\n+        Map<String, String> connectorProps = new HashMap<>();\n+        connectorProps.put(CONNECTOR_CLASS_CONFIG, MonitorableSourceConnector.class.getSimpleName());\n+\n+        // start the connector with only one task\n+        final int initialNumTasks = 1;\n+        connectorProps.put(TASKS_MAX_CONFIG, String.valueOf(initialNumTasks));\n+        connect.configureConnector(CONNECTOR_NAME, connectorProps);\n+        connect.assertions().assertConnectorAndExactlyNumTasksAreRunning(CONNECTOR_NAME, initialNumTasks, \"Connector tasks did not start in time\");\n+\n+        // then reconfigure it to use more tasks\n+        final int increasedNumTasks = 5;\n+        connectorProps.put(TASKS_MAX_CONFIG, String.valueOf(increasedNumTasks));\n+        connect.configureConnector(CONNECTOR_NAME, connectorProps);\n+        connect.assertions().assertConnectorAndExactlyNumTasksAreRunning(CONNECTOR_NAME, increasedNumTasks, \"Connector task statuses did not update in time.\");\n+\n+        // then reconfigure it to use fewer tasks\n+        final int decreasedNumTasks = 3;\n+        connectorProps.put(TASKS_MAX_CONFIG, String.valueOf(decreasedNumTasks));\n+        connect.configureConnector(CONNECTOR_NAME, connectorProps);\n+        connect.assertions().assertConnectorAndExactlyNumTasksAreRunning(CONNECTOR_NAME, decreasedNumTasks, \"Connector task statuses did not update in time.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02d97ec9e6126a2a8230b2e287143e762ea02c16"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1ODkwODE0", "url": "https://github.com/apache/kafka/pull/8118#pullrequestreview-415890814", "createdAt": "2020-05-21T05:39:30Z", "commit": {"oid": "02d97ec9e6126a2a8230b2e287143e762ea02c16"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNTozOTozMFrOGYm0fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNTozOTozMFrOGYm0fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ1NTAzOQ==", "bodyText": "Invoked when the task is deleted because the connector tasks where reduced or the connector itself was deleted.", "url": "https://github.com/apache/kafka/pull/8118#discussion_r428455039", "createdAt": "2020-05-21T05:39:30Z", "author": {"login": "kkonstantine"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/TaskStatus.java", "diffHunk": "@@ -61,5 +61,16 @@ public TaskStatus(ConnectorTaskId id, State state, String workerUrl, int generat\n          */\n         void onShutdown(ConnectorTaskId id);\n \n+        /**\n+         * Invoked after the task is no longer needed. This differs from\n+         * {@link #onShutdown(ConnectorTaskId)} in that a shut down task may be expected to restart\n+         * soon (as in the case of a rebalance), whereas a destroyed task will not be restarted\n+         * until and unless a reconfiguration of its connector occurs.\n+         * \n+         * This may occur after the number of tasks for a connector is reduced.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02d97ec9e6126a2a8230b2e287143e762ea02c16"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bd4bc32249c50608039b95ffe8ab338a9c2126b", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/4bd4bc32249c50608039b95ffe8ab338a9c2126b", "committedDate": "2020-05-21T20:30:54Z", "message": "KAFKA-9472: Make javadoc for added method conform to style of other methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3Nzk1Mzg2", "url": "https://github.com/apache/kafka/pull/8118#pullrequestreview-417795386", "createdAt": "2020-05-25T16:06:25Z", "commit": {"oid": "4bd4bc32249c50608039b95ffe8ab338a9c2126b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1441, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}