{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2MDEyMzE5", "number": 9792, "title": "KAFKA-10870: handle REBALANCE_IN_PROGRESS error in JoinGroup", "bodyText": "handle REBALANCE_IN_PROGRESS error in JoinGroup to log correct info and request a rejoin.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-12-28T09:24:57Z", "url": "https://github.com/apache/kafka/pull/9792", "merged": true, "mergeCommit": {"oid": "e3ce4a6e11dd8f3d8e08f39c22c4f19f30ff65b8"}, "closed": true, "closedAt": "2021-01-04T22:20:24Z", "author": {"login": "showuon"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqio3oAH2gAyNTQ2MDEyMzE5OjUwZGIwODc5OGIzZTQ4NWU5Y2RhODk4ODFlMzBjNWMxYzdkNTY4NGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABds96uFgFqTU2MTM4NzU2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "50db08798b3e485e9cda89881e30c5c1c7d5684a", "author": {"user": {"login": "showuon", "name": "Luke Chen"}}, "url": "https://github.com/apache/kafka/commit/50db08798b3e485e9cda89881e30c5c1c7d5684a", "committedDate": "2020-12-28T09:23:28Z", "message": "KAFKA-10870: handle REBALANCE_IN_PROGRESS error in JoinGroup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwMTM4ODk2", "url": "https://github.com/apache/kafka/pull/9792#pullrequestreview-560138896", "createdAt": "2020-12-30T17:32:47Z", "commit": {"oid": "50db08798b3e485e9cda89881e30c5c1c7d5684a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxNzozMjo0N1rOIMx4eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxNzo0MDoyMlrOIMyBJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MTA5OA==", "bodyText": "I think the call to requestRejoin is not needed. We only reset the rejoinNeeded flag after the subsequent SyncGroup request. Or is there a case that this misses?", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550271098", "createdAt": "2020-12-30T17:32:47Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -658,6 +658,10 @@ public void handle(JoinGroupResponse joinResponse, RequestFuture<ByteBuffer> fut\n                     AbstractCoordinator.this.generation = new Generation(OffsetCommitRequest.DEFAULT_GENERATION_ID, memberId, null);\n                 }\n                 future.raise(error);\n+            } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n+                log.info(\"JoinGroup failed due to the group began another rebalance. Need to re-join the group.\");\n+                requestRejoin();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50db08798b3e485e9cda89881e30c5c1c7d5684a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MzA3Ng==", "bodyText": "I guess it's kind of a confusing error to see. The case on the broker is when the write to the log failed because of a timeout. I wonder if it would be useful to suggest the cause in the message. For example:\n\nJoinGroup failed with a REBALANCE_IN_PROGRESS error, which could indicate a replication timeout on the broker. Will retry.", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550273076", "createdAt": "2020-12-30T17:39:27Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -658,6 +658,10 @@ public void handle(JoinGroupResponse joinResponse, RequestFuture<ByteBuffer> fut\n                     AbstractCoordinator.this.generation = new Generation(OffsetCommitRequest.DEFAULT_GENERATION_ID, memberId, null);\n                 }\n                 future.raise(error);\n+            } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n+                log.info(\"JoinGroup failed due to the group began another rebalance. Need to re-join the group.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50db08798b3e485e9cda89881e30c5c1c7d5684a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MzMxNw==", "bodyText": "Can we verify that the JoinGroup gets retried on the next poll?", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550273317", "createdAt": "2020-12-30T17:40:22Z", "author": {"login": "hachikuji"}, "path": "clients/src/test/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinatorTest.java", "diffHunk": "@@ -823,6 +823,24 @@ public void testJoinGroupRequestWithGroupInstanceIdNotFound() {\n         assertTrue(coordinator.hasUnknownGeneration());\n     }\n \n+    @Test\n+    public void testJoinGroupRequestWithRebalanceInProgress() {\n+        setupCoordinator();\n+        mockClient.prepareResponse(groupCoordinatorResponse(node, Errors.NONE));\n+        coordinator.ensureCoordinatorReady(mockTime.timer(0));\n+\n+        mockClient.prepareResponse(\n+            joinGroupFollowerResponse(defaultGeneration, memberId, JoinGroupRequest.UNKNOWN_MEMBER_ID, Errors.REBALANCE_IN_PROGRESS));\n+\n+        RequestFuture<ByteBuffer> future = coordinator.sendJoinGroupRequest();\n+\n+        assertTrue(consumerClient.poll(future, mockTime.timer(REQUEST_TIMEOUT_MS)));\n+        assertTrue(future.exception().getClass().isInstance(Errors.REBALANCE_IN_PROGRESS.exception()));\n+        assertEquals(Errors.REBALANCE_IN_PROGRESS.message(), future.exception().getMessage());\n+        // should request rejoin\n+        assertTrue(coordinator.rejoinNeededOrPending());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50db08798b3e485e9cda89881e30c5c1c7d5684a"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62c3c76ddb8b8d1163281b837c2b273824a9e1ec", "author": {"user": {"login": "showuon", "name": "Luke Chen"}}, "url": "https://github.com/apache/kafka/commit/62c3c76ddb8b8d1163281b837c2b273824a9e1ec", "committedDate": "2020-12-31T06:26:09Z", "message": "KAFKA-10870: address reviewer's comments to refactor fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNzg1NzYw", "url": "https://github.com/apache/kafka/pull/9792#pullrequestreview-560785760", "createdAt": "2021-01-04T05:22:58Z", "commit": {"oid": "62c3c76ddb8b8d1163281b837c2b273824a9e1ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNToyMjo1OFrOINl4SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNToyMjo1OFrOINl4SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTEyMzAxNw==", "bodyText": "Could we mention in the log that the error is non-fatal, similar to MEMBER_ID_REQUIRED?", "url": "https://github.com/apache/kafka/pull/9792#discussion_r551123017", "createdAt": "2021-01-04T05:22:58Z", "author": {"login": "abbccdda"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -658,6 +658,10 @@ public void handle(JoinGroupResponse joinResponse, RequestFuture<ByteBuffer> fut\n                     AbstractCoordinator.this.generation = new Generation(OffsetCommitRequest.DEFAULT_GENERATION_ID, memberId, null);\n                 }\n                 future.raise(error);\n+            } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n+                log.info(\"JoinGroup failed with a REBALANCE_IN_PROGRESS error, which could indicate a replication timeout \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62c3c76ddb8b8d1163281b837c2b273824a9e1ec"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "558b1883efcf71cf006f4277b4d1f61d7ce8172e", "author": {"user": {"login": "showuon", "name": "Luke Chen"}}, "url": "https://github.com/apache/kafka/commit/558b1883efcf71cf006f4277b4d1f61d7ce8172e", "committedDate": "2021-01-04T05:53:39Z", "message": "KAFKA-10870: address reviewer's comment to mention non-fatal error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMzg3NTY3", "url": "https://github.com/apache/kafka/pull/9792#pullrequestreview-561387567", "createdAt": "2021-01-04T22:18:15Z", "commit": {"oid": "558b1883efcf71cf006f4277b4d1f61d7ce8172e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2402, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}