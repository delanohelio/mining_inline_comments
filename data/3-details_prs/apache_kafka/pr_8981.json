{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NDM5MDQy", "number": 8981, "title": "KAFKA-10235 Fix flaky transactions_test.py", "bodyText": "Reducing timeout of transaction can quickly cleanup the unstable offsets. IN hard_bounce mode, transaction is broke ungracefully. Hence, it produces unstable offsets which obstructs TransactionalMessageCopier from receiving position of group.\nissue: https://issues.apache.org/jira/browse/KAFKA-10235\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-07-05T17:47:51Z", "url": "https://github.com/apache/kafka/pull/8981", "merged": true, "mergeCommit": {"oid": "e099b58df5b3e4f87173fc55880f9c343308739f"}, "closed": true, "closedAt": "2020-07-09T16:33:07Z", "author": {"login": "chia7712"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyWSxvgFqTQ0MzM0NDE4NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABczD-viAH2gAyNDQ0NDM5MDQyOjZkZjY5NzlmZjVmZTcxOTdjNDcxOGE5YmVjYjcyZWQ1NzljMjk3YjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMzQ0MTg1", "url": "https://github.com/apache/kafka/pull/8981#pullrequestreview-443344185", "createdAt": "2020-07-06T19:17:48Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOToxNzo0OFrOGtkCVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOToyMDowM1rOGtkGjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyOTUyNA==", "bodyText": "transaction_timeout => transaction_cleanup_interval?", "url": "https://github.com/apache/kafka/pull/8981#discussion_r450429524", "createdAt": "2020-07-06T19:17:48Z", "author": {"login": "junrao"}, "path": "tests/kafkatest/services/kafka/kafka.py", "diffHunk": "@@ -101,7 +101,7 @@ def __init__(self, context, num_nodes, zk, security_protocol=SecurityConfig.PLAI\n                  jmx_attributes=None, zk_connect_timeout=5000, zk_session_timeout=6000, server_prop_overides=None, zk_chroot=None,\n                  zk_client_secure=False,\n                  listener_security_config=ListenerSecurityConfig(), per_node_server_prop_overrides=None,\n-                 extra_kafka_opts=\"\", tls_version=None):\n+                 extra_kafka_opts=\"\", tls_version=None, transaction_timeout=10000):", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyOTY1Mg==", "bodyText": "This is reducing the transaction cleanup interval.", "url": "https://github.com/apache/kafka/pull/8981#discussion_r450429652", "createdAt": "2020-07-06T19:18:01Z", "author": {"login": "junrao"}, "path": "tests/kafkatest/tests/core/transactions_test.py", "diffHunk": "@@ -53,7 +53,11 @@ def __init__(self, test_context):\n         self.zk = ZookeeperService(test_context, num_nodes=1)\n         self.kafka = KafkaService(test_context,\n                                   num_nodes=self.num_brokers,\n-                                  zk=self.zk)\n+                                  zk=self.zk,\n+                                  # Reducing timeout of transaction can quickly cleanup the unstable offsets.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQzMDYwNA==", "bodyText": "The default transaction.abort.timed.out.transaction.cleanup.interval.ms is 10 secs. In the jira, the consumer seems to have failed without making progress for 30 secs. So, will reducing this timeout help?", "url": "https://github.com/apache/kafka/pull/8981#discussion_r450430604", "createdAt": "2020-07-06T19:20:03Z", "author": {"login": "junrao"}, "path": "tests/kafkatest/tests/core/transactions_test.py", "diffHunk": "@@ -53,7 +53,11 @@ def __init__(self, test_context):\n         self.zk = ZookeeperService(test_context, num_nodes=1)\n         self.kafka = KafkaService(test_context,\n                                   num_nodes=self.num_brokers,\n-                                  zk=self.zk)\n+                                  zk=self.zk,\n+                                  # Reducing timeout of transaction can quickly cleanup the unstable offsets.\n+                                  # IN hard_bounce mode, transaction is broke ungracefully. Hence, it produces unstable\n+                                  # offsets which obstructs TransactionalMessageCopier from receiving position of group.\n+                                  transaction_timeout=2000)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0Mjc4NTU1", "url": "https://github.com/apache/kafka/pull/8981#pullrequestreview-444278555", "createdAt": "2020-07-07T21:57:07Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMTo1NzowN1rOGuRDbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjoyNzo1N1rOGuRzbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE2NzA4Ng==", "bodyText": "broker => broken", "url": "https://github.com/apache/kafka/pull/8981#discussion_r451167086", "createdAt": "2020-07-07T21:57:07Z", "author": {"login": "junrao"}, "path": "tests/kafkatest/tests/core/transactions_test.py", "diffHunk": "@@ -47,7 +47,10 @@ def __init__(self, test_context):\n         self.num_output_partitions = 3\n         self.num_seed_messages = 100000\n         self.transaction_size = 750\n-        self.transaction_timeout = 40000\n+        # This is reducing the transaction cleanup interval.\n+        # IN hard_bounce mode, transaction is broke ungracefully. Hence, it produces unstable", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3OTM3NA==", "bodyText": "Hmm, still not sure about this. In a hard bounce, the broker failure will be detected after ZK session expiration, with a default of 18 sec. After that, new leaders will be elected and the client should recover. So, the transactional producer should be unblocked after 18 secs, even with a 40 sec transaction_timeout?", "url": "https://github.com/apache/kafka/pull/8981#discussion_r451179374", "createdAt": "2020-07-07T22:27:57Z", "author": {"login": "junrao"}, "path": "tests/kafkatest/tests/core/transactions_test.py", "diffHunk": "@@ -47,7 +47,10 @@ def __init__(self, test_context):\n         self.num_output_partitions = 3\n         self.num_seed_messages = 100000\n         self.transaction_size = 750\n-        self.transaction_timeout = 40000\n+        # This is reducing the transaction cleanup interval.\n+        # IN hard_bounce mode, transaction is broke ungracefully. Hence, it produces unstable\n+        # offsets which obstructs TransactionalMessageCopier from receiving position of group.\n+        self.transaction_timeout = 5000", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MzQ1OTEw", "url": "https://github.com/apache/kafka/pull/8981#pullrequestreview-444345910", "createdAt": "2020-07-08T01:04:29Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMTowNDoyOVrOGuUlTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMTowNDoyOVrOGuUlTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNDkwOA==", "bodyText": "@chia7712 : Thanks for the reply. That makes sense. Perhaps we can adjust the comment to make it clear that the hard bounce is for the client.", "url": "https://github.com/apache/kafka/pull/8981#discussion_r451224908", "createdAt": "2020-07-08T01:04:29Z", "author": {"login": "junrao"}, "path": "tests/kafkatest/tests/core/transactions_test.py", "diffHunk": "@@ -47,7 +47,10 @@ def __init__(self, test_context):\n         self.num_output_partitions = 3\n         self.num_seed_messages = 100000\n         self.transaction_size = 750\n-        self.transaction_timeout = 40000\n+        # This is reducing the transaction cleanup interval.\n+        # IN hard_bounce mode, transaction is broke ungracefully. Hence, it produces unstable\n+        # offsets which obstructs TransactionalMessageCopier from receiving position of group.\n+        self.transaction_timeout = 5000", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3OTM3NA=="}, "originalCommit": null, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3377dc3d121d1e51666498c8ac0db58368077548", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/3377dc3d121d1e51666498c8ac0db58368077548", "committedDate": "2020-07-09T00:24:47Z", "message": "KAFKA-10235 Fix flaky transactions_test.py"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "695662390f7f1888d6eb355288822d3c1fceef96", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/695662390f7f1888d6eb355288822d3c1fceef96", "committedDate": "2020-07-09T00:24:55Z", "message": "KAFKA-10235 reduce the transaction timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63cd6b3c3dcb608c28ff6716ccbbef1cb95add13", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/63cd6b3c3dcb608c28ff6716ccbbef1cb95add13", "committedDate": "2020-07-09T00:24:55Z", "message": "KAFKA-10235 fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa66df9ee3a3e51219a94f1c2af7dca567cabd7c", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/aa66df9ee3a3e51219a94f1c2af7dca567cabd7c", "committedDate": "2020-07-09T00:32:14Z", "message": "add comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "aa66df9ee3a3e51219a94f1c2af7dca567cabd7c", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/aa66df9ee3a3e51219a94f1c2af7dca567cabd7c", "committedDate": "2020-07-09T00:32:14Z", "message": "add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d062a540895df76a9f88f4b138167952bd12a21", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/0d062a540895df76a9f88f4b138167952bd12a21", "committedDate": "2020-07-09T00:33:59Z", "message": "remove useless stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6df6979ff5fe7197c4718a9becb72ed579c297b2", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/6df6979ff5fe7197c4718a9becb72ed579c297b2", "committedDate": "2020-07-09T00:34:28Z", "message": "remove useless stuff"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1164, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}