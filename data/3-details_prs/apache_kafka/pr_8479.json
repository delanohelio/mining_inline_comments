{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyOTM2NzY2", "number": 8479, "title": "KAFKA-9769: Finish operations for leaderEpoch-updated partitions up to point ZK Exception", "bodyText": "KAFKA-9769: Finish operations for leaderEpoch-updated partitions up to point ZK Exception occurs.\nhttps://issues.apache.org/jira/browse/KAFKA-9769\nFor example, in such case, we will have the following mechanism :\n1 - P1 and P2 succeeds. leaderEpoch for them are incremented because no ZkException occurs\n2 - while making follower for P3, ZkException occurs and the leaderEpoch is not updated and thus thepartitionsToMakeFollower += partition isn\u2019t executed. We catch this ZkException in line 1498 and log it as an error. No Exception is thrown.\n3 - After catching the exception, makeFollower for P4 is then not executed.\n4 - so the partitionsToMakeFollower only contains P1, P2. And fetchers are added to these partitionsToMakeFollower\nSigned-off-by: Andrew Choi li_andchoi@microsoft.com\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-04-14T02:38:36Z", "url": "https://github.com/apache/kafka/pull/8479", "merged": true, "mergeCommit": {"oid": "3a55fb9f28365c0bf9e91fadf68de0c504c2a27e"}, "closed": true, "closedAt": "2020-07-06T18:25:40Z", "author": {"login": "andrewchoi5"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXaFNrAH2gAyNDAyOTM2NzY2OjQ1Mzc4Y2RiZDUzZjA1ZmY0YjdmYjQxMDY1NzBkMWMzYTdkYTEzYzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyVFUtgFqTQ0MzI5MjkyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "45378cdbd53f05ff4b7fb4106570d1c3a7da13c3", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/45378cdbd53f05ff4b7fb4106570d1c3a7da13c3", "committedDate": "2020-04-14T02:29:34Z", "message": "Finish operations for leaderEpoch-updated partitions up to point ZK exception occurs\n\n1 - Remove fetchers for partitions whose leader epoch is updated.\n2 - Finish delayed fetch and produce requests for those same partitions\n3 - Re-add fetchers for those same partitions.\n4 - Don't throw exception, but rather log it as an error about this occurrence.\n\nSigned-off-by: Andrew Choi <li_andchoi@microsoft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7de15ed047f55c0a1f05b6bcd81de4ca79134a36", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/7de15ed047f55c0a1f05b6bcd81de4ca79134a36", "committedDate": "2020-06-04T00:06:57Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into andchoi_zkCatch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26c6fba96237df5f47de456b703fed77d116702c", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/26c6fba96237df5f47de456b703fed77d116702c", "committedDate": "2020-06-11T23:35:52Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into andchoi_zkCatch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6d405ceb13414a52dafe455589130efd58ee5cb", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/b6d405ceb13414a52dafe455589130efd58ee5cb", "committedDate": "2020-06-12T01:12:45Z", "message": "populate the response map with error\n\nSigned-off-by: Andrew Choi <li_andchoi@microsoft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4491d3bf1121236d0f7ba8602cf90aa34dc6b1c7", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/4491d3bf1121236d0f7ba8602cf90aa34dc6b1c7", "committedDate": "2020-06-16T01:43:19Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into andchoi_zkCatch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "964746136501256568e6980b1414dab571525292", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/964746136501256568e6980b1414dab571525292", "committedDate": "2020-06-16T01:43:55Z", "message": "Merge branch 'andchoi_zkCatch' of https://github.com/andrewchoi5/kafka into andchoi_zkCatch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfa33eb9e87dfde769b39de4d6065921fa80c6bd", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/dfa33eb9e87dfde769b39de4d6065921fa80c6bd", "committedDate": "2020-06-16T01:48:06Z", "message": "remove sending back the error code. since the controller only checks KAFKA_STORAGE_ERROR in LeaderAndIsrResponse now, just log an error without sending an error code back for now.\n\nSigned-off-by: Andrew Choi <li_andchoi@microsoft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDgzMDQ1", "url": "https://github.com/apache/kafka/pull/8479#pullrequestreview-437083045", "createdAt": "2020-06-24T23:57:30Z", "commit": {"oid": "dfa33eb9e87dfde769b39de4d6065921fa80c6bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMzo1NzozMFrOGom-Dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMzo1NzozMFrOGom-Dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIzNDcwMg==", "bodyText": "It's probably better to do this in Partition.makeFollower() instead of here. That way, we only skip partitions that have incurred ZK error.\nAlso, the same ZK exception can happen in Partition.makeLeader(). So, we want to do the same thing there as well.", "url": "https://github.com/apache/kafka/pull/8479#discussion_r445234702", "createdAt": "2020-06-24T23:57:30Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "diffHunk": "@@ -1556,6 +1557,11 @@ class ReplicaManager(val config: KafkaConfig,\n             error(s\"Error while making broker the follower for partition $partition with leader \" +\n               s\"$newLeaderBrokerId in dir $dirOpt\", e)\n             responseMap.put(partition.topicPartition, Errors.KAFKA_STORAGE_ERROR)\n+          case e: ZooKeeperClientException =>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfa33eb9e87dfde769b39de4d6065921fa80c6bd"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "320a567799e924bee4cb63b280ebbc0997c88be9", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/320a567799e924bee4cb63b280ebbc0997c88be9", "committedDate": "2020-06-26T00:04:39Z", "message": "change the logic to partition.scala\n\nSigned-off-by: Andrew Choi <li_andchoi@microsoft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3300a9033f6f63fa00d64d7bd01b5f7f3f91cdc", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/c3300a9033f6f63fa00d64d7bd01b5f7f3f91cdc", "committedDate": "2020-06-26T00:06:03Z", "message": "remove import\n\nSigned-off-by: Andrew Choi <li_andchoi@microsoft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTM5NDA3", "url": "https://github.com/apache/kafka/pull/8479#pullrequestreview-437939407", "createdAt": "2020-06-26T00:14:14Z", "commit": {"oid": "c3300a9033f6f63fa00d64d7bd01b5f7f3f91cdc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDoxNDoxNFrOGpP2ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDoxOToyOFrOGpP7kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNDU0Nw==", "bodyText": "The message seem inaccurate since we only skip this partition now. Ditto in makeFollower().", "url": "https://github.com/apache/kafka/pull/8479#discussion_r445904547", "createdAt": "2020-06-26T00:14:14Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -499,7 +500,16 @@ class Partition(val topicPartition: TopicPartition,\n         addingReplicas = addingReplicas,\n         removingReplicas = removingReplicas\n       )\n-      createLogIfNotExists(partitionState.isNew, isFutureReplica = false, highWatermarkCheckpoints)\n+      try {\n+        this.createLogIfNotExists(partitionState.isNew, isFutureReplica = false, highWatermarkCheckpoints)\n+      } catch {\n+        case e: ZooKeeperClientException =>\n+          stateChangeLogger.info(s\"Because a ZooKeeper client exception has occurred, completed become leader \" +\n+            s\"state change from epoch $leaderEpoch only for those updated partitions with before \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3300a9033f6f63fa00d64d7bd01b5f7f3f91cdc"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNTgxMA==", "bodyText": "Do we need ' before \"?\nAlso, the text could probably be sth like \"ZooKeeper client error occurred while becoming leader for $topicPartition.\"\nDitto in makeFollower().", "url": "https://github.com/apache/kafka/pull/8479#discussion_r445905810", "createdAt": "2020-06-26T00:19:28Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -499,7 +500,16 @@ class Partition(val topicPartition: TopicPartition,\n         addingReplicas = addingReplicas,\n         removingReplicas = removingReplicas\n       )\n-      createLogIfNotExists(partitionState.isNew, isFutureReplica = false, highWatermarkCheckpoints)\n+      try {\n+        this.createLogIfNotExists(partitionState.isNew, isFutureReplica = false, highWatermarkCheckpoints)\n+      } catch {\n+        case e: ZooKeeperClientException =>\n+          stateChangeLogger.info(s\"Because a ZooKeeper client exception has occurred, completed become leader \" +\n+            s\"state change from epoch $leaderEpoch only for those updated partitions with before \" +\n+            s\"ZooKeeper disconnect occurred.\", e)\n+          error(s\"ZooKeeper client occurred while rendering a $topicPartition's leader through zkClient.'\", e)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3300a9033f6f63fa00d64d7bd01b5f7f3f91cdc"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "889e375c094d87e2c97a8076c8ce2b347b5efe94", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/889e375c094d87e2c97a8076c8ce2b347b5efe94", "committedDate": "2020-06-26T03:49:45Z", "message": "accurate error log statement\n\nSigned-off-by: Andrew Choi <li_andchoi@microsoft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDU5MjEy", "url": "https://github.com/apache/kafka/pull/8479#pullrequestreview-438459212", "createdAt": "2020-06-26T17:07:27Z", "commit": {"oid": "889e375c094d87e2c97a8076c8ce2b347b5efe94"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzowNzoyN1rOGpoX6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzowNzoyN1rOGpoX6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMwNjI4MA==", "bodyText": "We probably can just keep the state change logging. Also, the logging level probably should be error instead of info. Ditto below.", "url": "https://github.com/apache/kafka/pull/8479#discussion_r446306280", "createdAt": "2020-06-26T17:07:27Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -499,7 +500,16 @@ class Partition(val topicPartition: TopicPartition,\n         addingReplicas = addingReplicas,\n         removingReplicas = removingReplicas\n       )\n-      createLogIfNotExists(partitionState.isNew, isFutureReplica = false, highWatermarkCheckpoints)\n+      try {\n+        this.createLogIfNotExists(partitionState.isNew, isFutureReplica = false, highWatermarkCheckpoints)\n+      } catch {\n+        case e: ZooKeeperClientException =>\n+          stateChangeLogger.info(s\"A ZooKeeper client exception has occurred and makeLeader will be skipping the \" +\n+            s\"state change for the partition with leader epoch: $leaderEpoch \", e)\n+          error(s\"ZooKeeper client error occurred while this partition was becoming the leader for $topicPartition.\", e)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "889e375c094d87e2c97a8076c8ce2b347b5efe94"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f95844a4bbaa855f69eeffb5e19182de171936fc", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/f95844a4bbaa855f69eeffb5e19182de171936fc", "committedDate": "2020-06-26T17:32:20Z", "message": "removal of error and keep the state change log error\n\nSigned-off-by: Andrew Choi <li_andchoi@microsoft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMzIwODgy", "url": "https://github.com/apache/kafka/pull/8479#pullrequestreview-440320882", "createdAt": "2020-06-30T19:27:49Z", "commit": {"oid": "f95844a4bbaa855f69eeffb5e19182de171936fc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxOToyNzo0OVrOGrLVqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxOToyNzo0OVrOGrLVqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzkyNzcyMg==", "bodyText": "Do we need this? Ditto below.", "url": "https://github.com/apache/kafka/pull/8479#discussion_r447927722", "createdAt": "2020-06-30T19:27:49Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -499,7 +500,15 @@ class Partition(val topicPartition: TopicPartition,\n         addingReplicas = addingReplicas,\n         removingReplicas = removingReplicas\n       )\n-      createLogIfNotExists(partitionState.isNew, isFutureReplica = false, highWatermarkCheckpoints)\n+      try {\n+        this.createLogIfNotExists(partitionState.isNew, isFutureReplica = false, highWatermarkCheckpoints)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f95844a4bbaa855f69eeffb5e19182de171936fc"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDU2NjA3", "url": "https://github.com/apache/kafka/pull/8479#pullrequestreview-441056607", "createdAt": "2020-07-01T17:14:48Z", "commit": {"oid": "f95844a4bbaa855f69eeffb5e19182de171936fc"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18514200830bc1707332348545ed5fd1c7a4f41e", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/18514200830bc1707332348545ed5fd1c7a4f41e", "committedDate": "2020-07-01T19:23:45Z", "message": "remove this keyword\n\nSigned-off-by: Andrew Choi <li_andchoi@microsoft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMjkyOTIz", "url": "https://github.com/apache/kafka/pull/8479#pullrequestreview-443292923", "createdAt": "2020-07-06T17:56:07Z", "commit": {"oid": "18514200830bc1707332348545ed5fd1c7a4f41e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1498, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}