{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNTM1NjM4", "number": 9619, "title": "MINOR: Reduce sends created by `SendBuilder`", "bodyText": "In #9401, I observed some strange latency behavior when testing locally (on macos). The behavior seemed to be caused by slightly different write behavior as a result of the new SendBuilder class. After the change, we were making several calls down to both GatheringByteChannel.write(ByteBuffer[]) as well as WritableByteChannel.write(ByteBuffer) whereas previously there would be just one path through the former. The difference is clearly seen in the flame graphs posted here: #9401 (comment).\nThis patch changes the grouping of Send objects created by SendBuilder to try and restore the previous write behavior. Rather than creating a single ByteBufferSend for each ByteBuffer, we attempt to group consecutive buffers into a single ByteBufferSend. I confirmed that did indeed address the latency issue I observed using the same test setup with a single broker that was discussed in #9401.\nbin/kafka-topics.sh --create --topic foo --replication-factor 1 --partitions 10 --bootstrap-server $BROKER\nbin/kafka-producer-perf-test.sh --topic foo --num-records 250000000 --throughput -1  --record-size 256 --producer-props bootstrap.servers=$BROKER\n\nHere are the results:\nBefore KAFKA-9628:\n250000000 records sent, 1398546.630342 records/sec (341.44 MB/sec), 39.71 ms avg latency, 424.00 ms max latency, 16 ms 50th, 137 ms 95th, 194 ms 99th, 270 ms 99.9th.\n\nTrunk:\n250000000 records sent, 1413619.374502 records/sec (345.12 MB/sec), 87.72 ms avg latency, 2058.00 ms max latency, 64 ms 50th, 247 ms 95th, 429 ms 99th, 790 ms 99.9th.                                             \n\nThis patch:\n250000000 records sent, 1469723.691946 records/sec (358.82 MB/sec), 12.72 ms avg latency, 320.00 ms max latency, 2 ms 50th, 83 ms 95th, 162 ms 99th, 256 ms 99.9th.                                                \n\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-11-18T22:33:47Z", "url": "https://github.com/apache/kafka/pull/9619", "merged": true, "mergeCommit": {"oid": "6054837c0a88800451027d17b86fdb9b4b2b3a34"}, "closed": true, "closedAt": "2020-11-19T20:45:23Z", "author": {"login": "hachikuji"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdd1ZoMAH2gAyNTIzNTM1NjM4OmNlMmZjNzNjMzZkZjQ0NDM4N2QyZWY3ZDE2ODE5MzYxY2EzYzExZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeGgrMgH2gAyNTIzNTM1NjM4OjViNTQzYWNmZDAzYmZhZDlkOTQ4ZTQ0Zjc2MDI3MzY5MWU3MDFjNGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ce2fc73c36df444387d2ef7d16819361ca3c11de", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/ce2fc73c36df444387d2ef7d16819361ca3c11de", "committedDate": "2020-11-18T21:54:00Z", "message": "MINOR: Reduce sends created by `SendBuilder`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDUxMzcw", "url": "https://github.com/apache/kafka/pull/9619#pullrequestreview-534051370", "createdAt": "2020-11-19T03:14:53Z", "commit": {"oid": "ce2fc73c36df444387d2ef7d16819361ca3c11de"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMzoxNDo1NFrOH2LFQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMzoxNzoxMVrOH2LH-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU2NjcyMQ==", "bodyText": "why sends is ArrayDeque and buffers is ArrayList?", "url": "https://github.com/apache/kafka/pull/9619#discussion_r526566721", "createdAt": "2020-11-19T03:14:54Z", "author": {"login": "chia7712"}, "path": "clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java", "diffHunk": "@@ -39,6 +42,7 @@\n  */\n public class SendBuilder implements Writable {\n     private final Queue<Send> sends = new ArrayDeque<>();\n+    private final List<ByteBuffer> buffers = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce2fc73c36df444387d2ef7d16819361ca3c11de"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU2NzQxNw==", "bodyText": "How about setting initial size of sends to 1 as auto-generated code use only MemoryRecords", "url": "https://github.com/apache/kafka/pull/9619#discussion_r526567417", "createdAt": "2020-11-19T03:17:11Z", "author": {"login": "chia7712"}, "path": "clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java", "diffHunk": "@@ -130,13 +139,25 @@ public void writeVarlong(long i) {\n      */\n     @Override\n     public void writeRecords(BaseRecords records) {\n-        flushCurrentBuffer();\n-        sends.add(records.toSend(destinationId));\n+        flushPendingBuffer();\n+\n+        if (records instanceof MemoryRecords) {\n+            buffers.add(((MemoryRecords) records).buffer());\n+        } else {\n+            flushPendingSend();\n+            sends.add(records.toSend(destinationId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce2fc73c36df444387d2ef7d16819361ca3c11de"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33fbae5f7a2f6a7e2803a2a82b2b45beacc732ba", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/33fbae5f7a2f6a7e2803a2a82b2b45beacc732ba", "committedDate": "2020-11-19T04:19:14Z", "message": "Initialize size of `ArrayDeque` to 1"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MjI1MjU2", "url": "https://github.com/apache/kafka/pull/9619#pullrequestreview-534225256", "createdAt": "2020-11-19T09:25:49Z", "commit": {"oid": "33fbae5f7a2f6a7e2803a2a82b2b45beacc732ba"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwOToyNTo0OVrOH2T4bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwOToyNTo0OVrOH2T4bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcxMDg5Mw==", "bodyText": "I just noticed that ByteBufferSend re-iterates over the byte buffers to compute the total size. We could compute the size while we accumulate them. I suppose that the number of buffers is usually small so it should not make a big difference.", "url": "https://github.com/apache/kafka/pull/9619#discussion_r526710893", "createdAt": "2020-11-19T09:25:49Z", "author": {"login": "dajac"}, "path": "clients/src/main/java/org/apache/kafka/common/protocol/SendBuilder.java", "diffHunk": "@@ -122,6 +123,14 @@ public void writeVarlong(long i) {\n         ByteUtils.writeVarlong(i, buffer);\n     }\n \n+    private void flushPendingSend() {\n+        if (!buffers.isEmpty()) {\n+            ByteBuffer[] byteBufferArray = buffers.toArray(new ByteBuffer[0]);\n+            sends.add(new ByteBufferSend(destinationId, byteBufferArray));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33fbae5f7a2f6a7e2803a2a82b2b45beacc732ba"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32332c2db2a24edeb2d0e50d28d638325939a33d", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/32332c2db2a24edeb2d0e50d28d638325939a33d", "committedDate": "2020-11-19T17:34:58Z", "message": "Compute size while building `Send`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0Njk3MjY3", "url": "https://github.com/apache/kafka/pull/9619#pullrequestreview-534697267", "createdAt": "2020-11-19T17:44:15Z", "commit": {"oid": "32332c2db2a24edeb2d0e50d28d638325939a33d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b543acfd03bfad9d948e44f760273691e701c4f", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/5b543acfd03bfad9d948e44f760273691e701c4f", "committedDate": "2020-11-19T17:50:05Z", "message": "Fix compilation error in benchmark"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2825, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}