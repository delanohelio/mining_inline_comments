{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1MDYwMzk0", "number": 8111, "title": "KAFKA-9206: throw a KafkaException when encountering CORRUPT_MESSAGE", "bodyText": "If the completed fetch has an error code signifying a corrupt message, throw a KafkaException that notes the offset and the topic-partition.\n\n\nAlso added a test that triggers the warning and verifies it is thrown.\n\n\nJira: https://issues.apache.org/jira/browse/KAFKA-9206\n\n\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-02-13T19:58:39Z", "url": "https://github.com/apache/kafka/pull/8111", "merged": true, "mergeCommit": {"oid": "84c4025fdd13fb6943568ebaf78d7ea2faa35540"}, "closed": true, "closedAt": "2020-02-21T18:03:10Z", "author": {"login": "agam"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcECAuhgFqTM1ODU3MjE0OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGQtNCgH2gAyMzc1MDYwMzk0OjIzOGVjZWQzOWEwMTE1NGQwOTcxOGVjMGIwNTM2YTNhNDY4MDM3YWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NTcyMTQ5", "url": "https://github.com/apache/kafka/pull/8111#pullrequestreview-358572149", "createdAt": "2020-02-13T21:42:22Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMTo0MjoyMlrOFpkjLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMTo0MjoyMlrOFpkjLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEzNDc2Nw==", "bodyText": "Why is this needed? Supposedly the slf4jlog4j dependency brings this too?", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379134767", "createdAt": "2020-02-13T21:42:22Z", "author": {"login": "ijuma"}, "path": "build.gradle", "diffHunk": "@@ -998,6 +998,7 @@ project(':clients') {\n     testCompile libs.bcpkix\n     testCompile libs.junit\n     testCompile libs.mockitoCore\n+    testCompile libs.log4j", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4Njg0NzQ5", "url": "https://github.com/apache/kafka/pull/8111#pullrequestreview-358684749", "createdAt": "2020-02-14T02:49:14Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMjo0OToxNVrOFpqOQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMjo0OToxNVrOFpqOQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIyNzcxMg==", "bodyText": "I think the main question here is whether we want to raise this error to the user. If we happen to see message corruption in the fetched data, we raise that to the user, so should this case be different?", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379227712", "createdAt": "2020-02-14T02:49:15Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java", "diffHunk": "@@ -1272,6 +1272,8 @@ private CompletedFetch initializeCompletedFetch(CompletedFetch nextCompletedFetc\n                 log.debug(\"Received unknown leader epoch error in fetch for partition {}\", tp);\n             } else if (error == Errors.UNKNOWN_SERVER_ERROR) {\n                 log.warn(\"Unknown error fetching data for topic-partition {}\", tp);\n+            } else if (error == Errors.CORRUPT_MESSAGE) {\n+                log.warn(\"Encountered corrupt message while fetching data for topic-partition {}\", tp);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efa1736c7340b8f81ff7c60ef05fd8ad33c4fd20", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/efa1736c7340b8f81ff7c60ef05fd8ad33c4fd20", "committedDate": "2020-02-14T21:35:48Z", "message": "KAFKA-9206: throw a KafkaException when encountering `CORRUPT_MESSAGE` after a fetch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "969295daf0b277c7c33092ca31953fdd233863e6", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/969295daf0b277c7c33092ca31953fdd233863e6", "committedDate": "2020-02-14T21:53:06Z", "message": "nit: formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a58e1be8f9c09937fab1182af62450ea38310d10", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/a58e1be8f9c09937fab1182af62450ea38310d10", "committedDate": "2020-02-14T21:53:30Z", "message": "added test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "a58e1be8f9c09937fab1182af62450ea38310d10", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/a58e1be8f9c09937fab1182af62450ea38310d10", "committedDate": "2020-02-14T21:53:30Z", "message": "added test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MjUxMjA4", "url": "https://github.com/apache/kafka/pull/8111#pullrequestreview-359251208", "createdAt": "2020-02-14T22:17:55Z", "commit": {"oid": "a58e1be8f9c09937fab1182af62450ea38310d10"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMjoxNzo1NVrOFqFOOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMjoxNzo1NVrOFqFOOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MDA3NA==", "bodyText": "nit: just calling fetchedRecords() should work here, or is compiler not liking it and forcing the return value assignment?", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379670074", "createdAt": "2020-02-14T22:17:55Z", "author": {"login": "soondenana"}, "path": "clients/src/test/java/org/apache/kafka/clients/consumer/internals/FetcherTest.java", "diffHunk": "@@ -3835,6 +3835,31 @@ public void testFetchCompletedBeforeHandlerAdded() {\n         assertEquals(1, fetcher.sendFetches());\n     }\n \n+    @Test\n+    public void testCorruptMessageError() {\n+        buildFetcher();\n+        assignFromUser(singleton(tp0));\n+        subscriptions.seek(tp0, 0);\n+\n+        assertEquals(1, fetcher.sendFetches());\n+        assertFalse(fetcher.hasCompletedFetches());\n+\n+        // Prepare a response with the CORRUPT_MESSAGE error.\n+        client.prepareResponse(fullFetchResponse(\n+                tp0,\n+                buildRecords(1L, 1, 1),\n+                Errors.CORRUPT_MESSAGE,\n+                100L, 0));\n+        consumerClient.poll(time.timer(0));\n+        assertTrue(fetcher.hasCompletedFetches());\n+\n+        // Trigger the exception.\n+        assertThrows(KafkaException.class, () -> {\n+            Map<TopicPartition, List<ConsumerRecord<byte[], byte[]>>> partitionRecords =\n+                    fetchedRecords();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a58e1be8f9c09937fab1182af62450ea38310d10"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "152323baa85ee0ab4396e2af7e1d7e25133cafec", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/152323baa85ee0ab4396e2af7e1d7e25133cafec", "committedDate": "2020-02-14T23:12:02Z", "message": "Review: throw away return value from fetchedRecords() in test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NDM4NTI0", "url": "https://github.com/apache/kafka/pull/8111#pullrequestreview-359438524", "createdAt": "2020-02-16T23:28:21Z", "commit": {"oid": "152323baa85ee0ab4396e2af7e1d7e25133cafec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQyMzoyODoyMlrOFqV5rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQyMzoyODoyMlrOFqV5rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk0MzM0MA==", "bodyText": "While we're at it, could we add the fetch offset to the IllegalStateException message below and the UNKNOWN_SERVER_ERROR log message above?", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379943340", "createdAt": "2020-02-16T23:28:22Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java", "diffHunk": "@@ -1272,6 +1272,11 @@ private CompletedFetch initializeCompletedFetch(CompletedFetch nextCompletedFetc\n                 log.debug(\"Received unknown leader epoch error in fetch for partition {}\", tp);\n             } else if (error == Errors.UNKNOWN_SERVER_ERROR) {\n                 log.warn(\"Unknown error fetching data for topic-partition {}\", tp);\n+            } else if (error == Errors.CORRUPT_MESSAGE) {\n+                throw new KafkaException(\"Encountered corrupt message when fetching offset \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "152323baa85ee0ab4396e2af7e1d7e25133cafec"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8afd7e73ead72d0f3c037f61b1164fe6ebefd3f", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/d8afd7e73ead72d0f3c037f61b1164fe6ebefd3f", "committedDate": "2020-02-18T19:08:31Z", "message": "Review: expanded log warnings to include fetch-offset"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMjg0NjEw", "url": "https://github.com/apache/kafka/pull/8111#pullrequestreview-361284610", "createdAt": "2020-02-19T17:22:11Z", "commit": {"oid": "d8afd7e73ead72d0f3c037f61b1164fe6ebefd3f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNzoyMjoxMVrOFrwU_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNzoyMjoxMVrOFrwU_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQyNDg5NA==", "bodyText": "nit: for log messages, can we use the {} placeholders?", "url": "https://github.com/apache/kafka/pull/8111#discussion_r381424894", "createdAt": "2020-02-19T17:22:11Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java", "diffHunk": "@@ -1271,9 +1271,20 @@ private CompletedFetch initializeCompletedFetch(CompletedFetch nextCompletedFetc\n             } else if (error == Errors.UNKNOWN_LEADER_EPOCH) {\n                 log.debug(\"Received unknown leader epoch error in fetch for partition {}\", tp);\n             } else if (error == Errors.UNKNOWN_SERVER_ERROR) {\n-                log.warn(\"Unknown error fetching data for topic-partition {}\", tp);\n+                log.warn(\"Unknown error fetching data while fetching offset \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8afd7e73ead72d0f3c037f61b1164fe6ebefd3f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cd5c55a133a36591e4cd911d3298481a09e1dfc", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/8cd5c55a133a36591e4cd911d3298481a09e1dfc", "committedDate": "2020-02-19T17:45:22Z", "message": "Review: use \"{}\" in log warnings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMTA2ODIx", "url": "https://github.com/apache/kafka/pull/8111#pullrequestreview-362106821", "createdAt": "2020-02-20T17:48:25Z", "commit": {"oid": "8cd5c55a133a36591e4cd911d3298481a09e1dfc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "238eced39a01154d09718ec0b0536a3a468037ab", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/238eced39a01154d09718ec0b0536a3a468037ab", "committedDate": "2020-02-20T19:57:29Z", "message": "Review: add reference to the CORRUPT_MESSAGE error in docs for `FetchResponse`"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1889, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}