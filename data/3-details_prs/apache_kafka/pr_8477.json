{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyOTI0ODQy", "number": 8477, "title": "KAFKA-9864: avoid expensive QuotaViolationException usage", "bodyText": "QuotaViolationException generates an exception message via String.format which uses regexes, and it does not use it as it is only used for control flow, e.g. https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/server/ClientQuotaManager.scala#L258. It also generates an unnecessary stack trace, which is now avoided using the same pattern as in ApiException.\nI have also avoided use of QuotaViolationException for control flow in ReplicationQuotaManager which is another hotspot that we have seen in practice.\nExample profile showing a small overall cost, measuring 0.5%. This could be large in cases where quotas are exceeded frequently.", "createdAt": "2020-04-14T01:49:30Z", "url": "https://github.com/apache/kafka/pull/8477", "merged": true, "mergeCommit": {"oid": "0a5097323bce270440697201d359bc67bf646f28"}, "closed": true, "closedAt": "2020-04-15T16:30:44Z", "author": {"login": "lbradstreet"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXZclFgH2gAyNDAyOTI0ODQyOjIyN2NhODZkZjI0MjIwNzI3MTc1Yjk0NjVlOTA2MTI2OGYyNzkwNDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcX6qqbAFqTM5MzkzODYwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "227ca86df24220727175b9465e9061268f279041", "author": {"user": {"login": "lbradstreet", "name": "Lucas Bradstreet"}}, "url": "https://github.com/apache/kafka/commit/227ca86df24220727175b9465e9061268f279041", "committedDate": "2020-04-14T01:45:11Z", "message": "MINOR: QuotaViolationException should avoid String.format and stack trace"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNTU5MTA1", "url": "https://github.com/apache/kafka/pull/8477#pullrequestreview-392559105", "createdAt": "2020-04-14T02:19:23Z", "commit": {"oid": "227ca86df24220727175b9465e9061268f279041"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjoxOToyM1rOGE7vZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjoxOToyM1rOGE7vZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjI3OA==", "bodyText": "I think we want to make the string computation lazy, but not lose info. We could do that by overriding toString.", "url": "https://github.com/apache/kafka/pull/8477#discussion_r407826278", "createdAt": "2020-04-14T02:19:23Z", "author": {"login": "ijuma"}, "path": "clients/src/main/java/org/apache/kafka/common/metrics/QuotaViolationException.java", "diffHunk": "@@ -30,11 +30,7 @@\n     private final double bound;\n \n     public QuotaViolationException(MetricName metricName, double value, double bound) {\n-        super(String.format(\n-                \"'%s' violated quota. Actual: %f, Threshold: %f\",\n-                metricName,\n-                value,\n-                bound));\n+        super(metricName + \" violated quota.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "227ca86df24220727175b9465e9061268f279041"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d5d7a38003a93d4ab3fe9c08593d046cc2fc058", "author": {"user": {"login": "lbradstreet", "name": "Lucas Bradstreet"}}, "url": "https://github.com/apache/kafka/commit/3d5d7a38003a93d4ab3fe9c08593d046cc2fc058", "committedDate": "2020-04-14T02:36:24Z", "message": "Include additional information in toString"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyOTYwMjc0", "url": "https://github.com/apache/kafka/pull/8477#pullrequestreview-392960274", "createdAt": "2020-04-14T14:05:05Z", "commit": {"oid": "3d5d7a38003a93d4ab3fe9c08593d046cc2fc058"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNDowNTowNlrOGFQShg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNDowNTowNlrOGFQShg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE2Mjk1MA==", "bodyText": "Do we need String.format here? Seems like String concat would be fine.", "url": "https://github.com/apache/kafka/pull/8477#discussion_r408162950", "createdAt": "2020-04-14T14:05:06Z", "author": {"login": "ijuma"}, "path": "clients/src/main/java/org/apache/kafka/common/metrics/QuotaViolationException.java", "diffHunk": "@@ -51,4 +47,20 @@ public double value() {\n     public double bound() {\n         return bound;\n     }\n+\n+    @Override\n+    public String toString() {\n+        return String.format(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d5d7a38003a93d4ab3fe9c08593d046cc2fc058"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0556d490ead260ec3c67790aa80855344e29ebd2", "author": {"user": {"login": "lbradstreet", "name": "Lucas Bradstreet"}}, "url": "https://github.com/apache/kafka/commit/0556d490ead260ec3c67790aa80855344e29ebd2", "committedDate": "2020-04-14T14:08:45Z", "message": "Avoid string building, rely on toString now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1ebc12bc98c16b8587b1ca965c2f3f50c30b761", "author": {"user": {"login": "lbradstreet", "name": "Lucas Bradstreet"}}, "url": "https://github.com/apache/kafka/commit/a1ebc12bc98c16b8587b1ca965c2f3f50c30b761", "committedDate": "2020-04-14T14:28:19Z", "message": "Avoid String.format use, avoid exceptional control flow in\nReplicationQuotaManager."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMTkwMDQ2", "url": "https://github.com/apache/kafka/pull/8477#pullrequestreview-393190046", "createdAt": "2020-04-14T18:31:14Z", "commit": {"oid": "a1ebc12bc98c16b8587b1ca965c2f3f50c30b761"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzOTM4NjA3", "url": "https://github.com/apache/kafka/pull/8477#pullrequestreview-393938607", "createdAt": "2020-04-15T16:27:26Z", "commit": {"oid": "a1ebc12bc98c16b8587b1ca965c2f3f50c30b761"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1491, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}