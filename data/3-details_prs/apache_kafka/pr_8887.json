{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NzY5NTQw", "number": 8887, "title": "KAFKA-10135: Extract Task#executeAndMaybeSwallow to be a general utility function into TaskManager\u2026", "bodyText": "Committer Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-06-17T10:52:00Z", "url": "https://github.com/apache/kafka/pull/8887", "merged": true, "mergeCommit": {"oid": "f7c38d83c727310f4b0678886ba410ae2fae9379"}, "closed": true, "closedAt": "2020-06-22T22:54:36Z", "author": {"login": "feyman2016"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsHbtUgH2gAyNDM1NzY5NTQwOmYwZTI2N2FjMGJlMGZlZjFhZjJkYWNiYWU2YTlhZjUzNTBiYTNhNmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABct32xsgFqTQzNTI5MTc2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f0e267ac0be0fef1af2dacbae6a9af5350ba3a6b", "author": {"user": {"login": "feyman2016", "name": null}}, "url": "https://github.com/apache/kafka/commit/f0e267ac0be0fef1af2dacbae6a9af5350ba3a6b", "committedDate": "2020-06-17T10:38:21Z", "message": "Extract Task#executeAndMaybeSwallow to be a general utility function into TaskManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f8360aff1b0fb964515ad87ef37d7f2d1e4e446", "author": {"user": {"login": "feyman2016", "name": null}}, "url": "https://github.com/apache/kafka/commit/4f8360aff1b0fb964515ad87ef37d7f2d1e4e446", "committedDate": "2020-06-17T11:05:44Z", "message": "Merge branch 'trunk' into KAFKA-10135"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMjk4NzU1", "url": "https://github.com/apache/kafka/pull/8887#pullrequestreview-432298755", "createdAt": "2020-06-17T11:14:38Z", "commit": {"oid": "4f8360aff1b0fb964515ad87ef37d7f2d1e4e446"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMToxNDozOVrOGlBHxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMToxNDozOVrOGlBHxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2ODg2OA==", "bodyText": "At first thought, the not clean case normally just do some logs. with only the log string different,  I would like to still use the executeAndMaybeSwallow  in Task.scala, but since callers may need different log levels or they may want do more than just a log, so just pass a more generic argument actionIfNotClean.\nAnd yeah, java.util.function.Consumer looks ugly but I am not aware of some elegant way for import alias...", "url": "https://github.com/apache/kafka/pull/8887#discussion_r441468868", "createdAt": "2020-06-17T11:14:39Z", "author": {"login": "feyman2016"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -1048,4 +1042,28 @@ public String toString(final String indent) {\n     Set<TaskId> lockedTaskDirectories() {\n         return Collections.unmodifiableSet(lockedTaskDirectories);\n     }\n+\n+    public static void executeAndMaybeSwallow(final boolean clean,\n+                                              final Runnable runnable,\n+                                              final java.util.function.Consumer<RuntimeException> actionIfClean,\n+                                              final java.util.function.Consumer<RuntimeException> actionIfNotClean) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f8360aff1b0fb964515ad87ef37d7f2d1e4e446"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyOTIzMzI0", "url": "https://github.com/apache/kafka/pull/8887#pullrequestreview-432923324", "createdAt": "2020-06-18T03:56:06Z", "commit": {"oid": "4f8360aff1b0fb964515ad87ef37d7f2d1e4e446"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMzo1NjowNlrOGlevxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMzo1ODo0M1rOGleyDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk1NDI0NQ==", "bodyText": "It seems not possible in Java", "url": "https://github.com/apache/kafka/pull/8887#discussion_r441954245", "createdAt": "2020-06-18T03:56:06Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -1048,4 +1042,28 @@ public String toString(final String indent) {\n     Set<TaskId> lockedTaskDirectories() {\n         return Collections.unmodifiableSet(lockedTaskDirectories);\n     }\n+\n+    public static void executeAndMaybeSwallow(final boolean clean,\n+                                              final Runnable runnable,\n+                                              final java.util.function.Consumer<RuntimeException> actionIfClean,\n+                                              final java.util.function.Consumer<RuntimeException> actionIfNotClean) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2ODg2OA=="}, "originalCommit": {"oid": "4f8360aff1b0fb964515ad87ef37d7f2d1e4e446"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk1NDgyOQ==", "bodyText": "could be replaced by lambda.", "url": "https://github.com/apache/kafka/pull/8887#discussion_r441954829", "createdAt": "2020-06-18T03:58:43Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -741,29 +741,23 @@ void shutdown(final boolean clean) {\n \n         for (final Task task : tasks.values()) {\n             if (task.isActive()) {\n-                try {\n-                    activeTaskCreator.closeAndRemoveTaskProducerIfNeeded(task.id());\n-                } catch (final RuntimeException e) {\n-                    if (clean) {\n-                        firstException.compareAndSet(null, e);\n-                    } else {\n-                        log.warn(\"Ignoring an exception while closing task \" + task.id() + \" producer.\", e);\n-                    }\n-                }\n+                executeAndMaybeSwallow(\n+                    clean,\n+                    () -> activeTaskCreator.closeAndRemoveTaskProducerIfNeeded(task.id()),\n+                    e -> firstException.compareAndSet(null, e),\n+                    e -> log.warn(\"Ignoring an exception while closing task \" + task.id() + \" producer.\", e)\n+                );\n             }\n         }\n \n         tasks.clear();\n \n-        try {\n-            activeTaskCreator.closeThreadProducerIfNeeded();\n-        } catch (final RuntimeException e) {\n-            if (clean) {\n-                firstException.compareAndSet(null, e);\n-            } else {\n-                log.warn(\"Ignoring an exception while closing thread producer.\", e);\n-            }\n-        }\n+        executeAndMaybeSwallow(\n+            clean,\n+            () -> activeTaskCreator.closeThreadProducerIfNeeded(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f8360aff1b0fb964515ad87ef37d7f2d1e4e446"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9298c28815fa9a6c5ef20bdf9c74dde67b68af1a", "author": {"user": {"login": "feyman2016", "name": null}}, "url": "https://github.com/apache/kafka/commit/9298c28815fa9a6c5ef20bdf9c74dde67b68af1a", "committedDate": "2020-06-20T06:08:28Z", "message": "fix based on comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MTk5ODIw", "url": "https://github.com/apache/kafka/pull/8887#pullrequestreview-435199820", "createdAt": "2020-06-22T19:08:42Z", "commit": {"oid": "9298c28815fa9a6c5ef20bdf9c74dde67b68af1a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MjkxNzY5", "url": "https://github.com/apache/kafka/pull/8887#pullrequestreview-435291769", "createdAt": "2020-06-22T21:37:17Z", "commit": {"oid": "9298c28815fa9a6c5ef20bdf9c74dde67b68af1a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 649, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}