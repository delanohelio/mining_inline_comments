{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MjMwNTAw", "number": 8253, "title": "KAFKA-9656: Return COORDINATOR_NOT_AVAILABLE for older producer clients", "bodyText": "Txn commit has a bug for lower versions where it would treat COORDINATOR_LOAD_IN_PROGRESS as fatal. This PR fixes the handling of older client to return\nCOORDINATOR_NOT_AVAILABLE so that it won't crash upon doing txn commit.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-03-08T05:57:53Z", "url": "https://github.com/apache/kafka/pull/8253", "merged": true, "mergeCommit": {"oid": "b586283c53ba235f2194ca4923266ad0653064b4"}, "closed": true, "closedAt": "2020-03-18T19:25:37Z", "author": {"login": "abbccdda"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLi55yABqjMxMDgxOTcyMjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOw81pgBqjMxNDAwNjgzNDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MjQ2NjE1", "url": "https://github.com/apache/kafka/pull/8253#pullrequestreview-376246615", "createdAt": "2020-03-17T17:21:25Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzoyMToyNVrOF3mWlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzoyNDowNVrOF3mc2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg0NDM3NQ==", "bodyText": "nit: I think it's ok to KAFKA-7296 to explain this check, but do we need to mention KAFKA-9656 as well?", "url": "https://github.com/apache/kafka/pull/8253#discussion_r393844375", "createdAt": "2020-03-17T17:21:25Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -2164,14 +2164,25 @@ class KafkaApis(val requestChannel: RequestChannel,\n \n       // the callback for sending an offset commit response\n       def sendResponseCallback(authorizedTopicErrors: Map[TopicPartition, Errors]): Unit = {\n-        val combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n+        var combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n         if (isDebugEnabled)\n           combinedCommitStatus.foreach { case (topicPartition, error) =>\n             if (error != Errors.NONE) {\n               debug(s\"TxnOffsetCommit with correlation id ${header.correlationId} from client ${header.clientId} \" +\n                 s\"on partition $topicPartition failed due to ${error.exceptionName}\")\n             }\n           }\n+\n+        // For KAFKA-9656, we need to replace COORDINATOR_LOAD_IN_PROGRESS with COORDINATOR_NOT_AVAILABLE", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg0NTk3OA==", "bodyText": "Just doublechecking, but does this cover any client version prior to 2.0? I think it would be good to mention this in the comment.", "url": "https://github.com/apache/kafka/pull/8253#discussion_r393845978", "createdAt": "2020-03-17T17:24:05Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -2164,14 +2164,25 @@ class KafkaApis(val requestChannel: RequestChannel,\n \n       // the callback for sending an offset commit response\n       def sendResponseCallback(authorizedTopicErrors: Map[TopicPartition, Errors]): Unit = {\n-        val combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n+        var combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n         if (isDebugEnabled)\n           combinedCommitStatus.foreach { case (topicPartition, error) =>\n             if (error != Errors.NONE) {\n               debug(s\"TxnOffsetCommit with correlation id ${header.correlationId} from client ${header.clientId} \" +\n                 s\"on partition $topicPartition failed due to ${error.exceptionName}\")\n             }\n           }\n+\n+        // For KAFKA-9656, we need to replace COORDINATOR_LOAD_IN_PROGRESS with COORDINATOR_NOT_AVAILABLE\n+        // for older producer client which could potentially fail due to a later bug fix in KAFKA-7296.\n+        if (txnOffsetCommitRequest.version < 2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NDUwNzIx", "url": "https://github.com/apache/kafka/pull/8253#pullrequestreview-376450721", "createdAt": "2020-03-17T22:32:17Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QyMjozMjoxN1rOF3wZlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QyMjozMjo1MFrOF3wbEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwODk4MA==", "bodyText": "typo: \"on onwards\"", "url": "https://github.com/apache/kafka/pull/8253#discussion_r394008980", "createdAt": "2020-03-17T22:32:17Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -2164,14 +2164,28 @@ class KafkaApis(val requestChannel: RequestChannel,\n \n       // the callback for sending an offset commit response\n       def sendResponseCallback(authorizedTopicErrors: Map[TopicPartition, Errors]): Unit = {\n-        val combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n+        var combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n         if (isDebugEnabled)\n           combinedCommitStatus.foreach { case (topicPartition, error) =>\n             if (error != Errors.NONE) {\n               debug(s\"TxnOffsetCommit with correlation id ${header.correlationId} from client ${header.clientId} \" +\n                 s\"on partition $topicPartition failed due to ${error.exceptionName}\")\n             }\n           }\n+\n+        // We need to replace COORDINATOR_LOAD_IN_PROGRESS with COORDINATOR_NOT_AVAILABLE\n+        // for older producer client from 0.11 to prior 2.0, which could potentially crash due\n+        // to unexpected loading error. This bug is fixed later by KAFKA-7296 in version 2.0.\n+        // Clients using txn commit protocol >= 2 (version 2.3 and on onwards)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwOTM2Mw==", "bodyText": "nit: you probably mean 2.0.1? We could probably leave this out since the jira has the details.", "url": "https://github.com/apache/kafka/pull/8253#discussion_r394009363", "createdAt": "2020-03-17T22:32:50Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -2164,14 +2164,28 @@ class KafkaApis(val requestChannel: RequestChannel,\n \n       // the callback for sending an offset commit response\n       def sendResponseCallback(authorizedTopicErrors: Map[TopicPartition, Errors]): Unit = {\n-        val combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n+        var combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n         if (isDebugEnabled)\n           combinedCommitStatus.foreach { case (topicPartition, error) =>\n             if (error != Errors.NONE) {\n               debug(s\"TxnOffsetCommit with correlation id ${header.correlationId} from client ${header.clientId} \" +\n                 s\"on partition $topicPartition failed due to ${error.exceptionName}\")\n             }\n           }\n+\n+        // We need to replace COORDINATOR_LOAD_IN_PROGRESS with COORDINATOR_NOT_AVAILABLE\n+        // for older producer client from 0.11 to prior 2.0, which could potentially crash due\n+        // to unexpected loading error. This bug is fixed later by KAFKA-7296 in version 2.0.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NDc2MzA0", "url": "https://github.com/apache/kafka/pull/8253#pullrequestreview-376476304", "createdAt": "2020-03-17T23:39:42Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbeac813ce1938c8f0834e2a23c6e3139b8c45d6", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/dbeac813ce1938c8f0834e2a23c6e3139b8c45d6", "committedDate": "2020-03-18T06:02:45Z", "message": "for old"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1953c6c3ab13e4325f0f05bd89ddbd07c1d96443", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/1953c6c3ab13e4325f0f05bd89ddbd07c1d96443", "committedDate": "2020-03-18T06:02:45Z", "message": "unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12414cd7c2730b865d9272945a37dcc73a79dfd1", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/12414cd7c2730b865d9272945a37dcc73a79dfd1", "committedDate": "2020-03-18T06:02:45Z", "message": "fix comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a213332e3d2cd8412e3ce81e81d7348d17f86f9", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/3a213332e3d2cd8412e3ce81e81d7348d17f86f9", "committedDate": "2020-03-18T06:02:45Z", "message": "fix small comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "3a213332e3d2cd8412e3ce81e81d7348d17f86f9", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/3a213332e3d2cd8412e3ce81e81d7348d17f86f9", "committedDate": "2020-03-18T06:02:45Z", "message": "fix small comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 164, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}