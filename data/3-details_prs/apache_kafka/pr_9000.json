{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NzUzNzc3", "number": 9000, "title": "KAFKA-10036 Improve handling and documentation of Suppliers", "bodyText": "Following up on #8752 which seems to have gone stale.\n@mjsax can you continue the review?", "createdAt": "2020-07-09T09:59:17Z", "url": "https://github.com/apache/kafka/pull/9000", "merged": true, "mergeCommit": {"oid": "b3e77dfad93b9e4d2798ecf84e777c99905d380f"}, "closed": true, "closedAt": "2020-11-04T01:30:16Z", "author": {"login": "soarez"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7coP1gFqTQ2MDQzOTQ0OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY5e1QgH2gAyNDQ2NzUzNzc3OmZhOGM5YzEwNzdjMTQ3ZjQzZWE0ZmIyMzQ2ZDU2NTMwY2IwYzdiZTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNDM5NDQ5", "url": "https://github.com/apache/kafka/pull/9000#pullrequestreview-460439449", "createdAt": "2020-08-04T01:36:51Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMTozNjo1MlrOG7OApg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMTo0NjozNlrOG7OKbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0ODcxMA==", "bodyText": "nit each time {@link  ProcessorSupplier#get()} is called. (similar elsewhere -- please fix throughout the whole PR)", "url": "https://github.com/apache/kafka/pull/9000#discussion_r464748710", "createdAt": "2020-08-04T01:36:52Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/StreamsBuilder.java", "diffHunk": "@@ -521,6 +521,10 @@ public synchronized StreamsBuilder addStateStore(final StoreBuilder<?> builder)\n      * <p>\n      * It is not required to connect a global store to {@link Processor Processors}, {@link Transformer Transformers},\n      * or {@link ValueTransformer ValueTransformer}; those have read-only access to all global stores by default.\n+     * <p>\n+     * The supplier should always generate a new instance each time invoking {@link  ProcessorSupplier#get()}. Creating", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0ODgwMQ==", "bodyText": "{@link Processor}(similar elsewhere -- please fix throughout the whole PR)", "url": "https://github.com/apache/kafka/pull/9000#discussion_r464748801", "createdAt": "2020-08-04T01:37:16Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/StreamsBuilder.java", "diffHunk": "@@ -521,6 +521,10 @@ public synchronized StreamsBuilder addStateStore(final StoreBuilder<?> builder)\n      * <p>\n      * It is not required to connect a global store to {@link Processor Processors}, {@link Transformer Transformers},\n      * or {@link ValueTransformer ValueTransformer}; those have read-only access to all global stores by default.\n+     * <p>\n+     * The supplier should always generate a new instance each time invoking {@link  ProcessorSupplier#get()}. Creating\n+     * a single Processor object and returning the same object reference in {@link ProcessorSupplier#get()} would be", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0OTMyMA==", "bodyText": "{@link Transformer} (also elsewhere)", "url": "https://github.com/apache/kafka/pull/9000#discussion_r464749320", "createdAt": "2020-08-04T01:39:16Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/KStream.java", "diffHunk": "@@ -2522,8 +2522,12 @@ void to(final TopicNameExtractor<K, V> topicExtractor,\n      * If in {@link Transformer#transform(Object, Object) Transformer#transform()} multiple records need to be emitted\n      * for each input record, it is recommended to use {@link #flatTransform(TransformerSupplier, String...)\n      * flatTransform()}.\n+     * The supplier should always generate a new instance each time invoking {@link TransformerSupplier#get()}. Creating\n+     * a single Transformer object and returning the same object reference in {@link TransformerSupplier#get()} would be", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0OTcyNw==", "bodyText": "I think we can be more elaborate and add something like TransformerSupplier#get() must return a new Transformer object each time it is called.", "url": "https://github.com/apache/kafka/pull/9000#discussion_r464749727", "createdAt": "2020-08-04T01:41:05Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KStreamUtil.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.streams.kstream.internals;\n+\n+import org.apache.kafka.streams.kstream.TransformerSupplier;\n+\n+/**\n+ * Shared functions to handle verifications of a valid {@link org.apache.kafka.streams.kstream.KStream}.\n+ */\n+final class KStreamUtil {\n+\n+    private KStreamUtil() {}\n+\n+    /**\n+     * @throws IllegalArgumentException if the same transformer instance is obtained each time\n+     */\n+    static void checkTransformerSupplier(final TransformerSupplier<?, ?, ?> supplier) {\n+        if (supplier.get() == supplier.get()) {\n+            throw new IllegalArgumentException(\"TransformerSupplier generates single transformer reference. Supplier \" +\n+                    \"pattern violated.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0OTk4MA==", "bodyText": "As above.", "url": "https://github.com/apache/kafka/pull/9000#discussion_r464749980", "createdAt": "2020-08-04T01:42:04Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TopologyUtil.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.streams.processor.internals;\n+\n+import org.apache.kafka.streams.errors.TopologyException;\n+import org.apache.kafka.streams.processor.ProcessorSupplier;\n+\n+/**\n+ * Shared functions to handle verifications of a valid {@link org.apache.kafka.streams.Topology}.\n+ */\n+public final class TopologyUtil {\n+\n+    private TopologyUtil() {}\n+\n+    /**\n+     * @throws TopologyException if the same processor instance is obtained each time\n+     */\n+    public static void checkProcessorSupplier(final ProcessorSupplier<?, ?> supplier) {\n+        if (supplier.get() == supplier.get()) {\n+            throw new TopologyException(\"ProcessorSupplier generates single processor reference. Supplier pattern\" +\n+                    \" violated.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc1MDM2OQ==", "bodyText": "We should use aasertThrows and verify the error message similar to the TransformerSupplier test", "url": "https://github.com/apache/kafka/pull/9000#discussion_r464750369", "createdAt": "2020-08-04T01:43:23Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilderTest.java", "diffHunk": "@@ -175,6 +177,12 @@ public void testAddProcessorWithNullParents() {\n         builder.addProcessor(\"processor\", new MockProcessorSupplier<>(), (String) null);\n     }\n \n+    @Test(expected = TopologyException.class)\n+    public void testAddProcessorWithBadSupplier() {\n+        final Processor<Object, Object> processor = new MockProcessor<>();\n+        builder.addProcessor(\"processor\", () -> processor, (String) null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc1MDg5MQ==", "bodyText": "It might be nice to replicate this test for all \"siblings\" of flatTransform (including the \"Value\" variants). -- Also note that there is KStream#process() and `StreamsBuilder#addGlobalStateStore), too, that should also be tested.", "url": "https://github.com/apache/kafka/pull/9000#discussion_r464750891", "createdAt": "2020-08-04T01:45:14Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamImplTest.java", "diffHunk": "@@ -1865,6 +1865,17 @@ public void shouldNotAllowNullNamedOnTransformWithStoreName() {\n         assertThat(exception.getMessage(), equalTo(\"named can't be null\"));\n     }\n \n+    @Test\n+    public void shouldNotAllowBadTransformerSupplierOnFlatTransform() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc1MTIxMg==", "bodyText": "We should also test addGlobalStateStore()", "url": "https://github.com/apache/kafka/pull/9000#discussion_r464751212", "createdAt": "2020-08-04T01:46:36Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilderTest.java", "diffHunk": "@@ -175,6 +177,12 @@ public void testAddProcessorWithNullParents() {\n         builder.addProcessor(\"processor\", new MockProcessorSupplier<>(), (String) null);\n     }\n \n+    @Test(expected = TopologyException.class)\n+    public void testAddProcessorWithBadSupplier() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1OTI2MjA3", "url": "https://github.com/apache/kafka/pull/9000#pullrequestreview-475926207", "createdAt": "2020-08-26T22:17:39Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMjoxNzo0MFrOHHfouA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMjoxNzo0MFrOHHfouA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYyMDQwOA==", "bodyText": "I am wondering if we actually need three methods? Could we use java.util.function.Supplier instead (we don't really care about generic types.\nTo customize the error message we just pass an additional String or use supplier.getClass().getName() ?", "url": "https://github.com/apache/kafka/pull/9000#discussion_r477620408", "createdAt": "2020-08-26T22:17:40Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KStreamUtil.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.streams.kstream.internals;\n+\n+import org.apache.kafka.streams.kstream.TransformerSupplier;\n+import org.apache.kafka.streams.kstream.ValueTransformerSupplier;\n+import org.apache.kafka.streams.kstream.ValueTransformerWithKeySupplier;\n+\n+/**\n+ * Shared functions to handle verifications of a valid {@link org.apache.kafka.streams.kstream.KStream}.\n+ */\n+final class KStreamUtil {\n+\n+    private KStreamUtil() {}\n+\n+    /**\n+     * @throws IllegalArgumentException if the same transformer instance is obtained each time\n+     */\n+    static void checkSupplier(final TransformerSupplier<?, ?, ?> supplier) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "20ba02a727b6af3bcdc059f54375f458fccaf889", "author": {"user": {"login": "soarez", "name": "Igor Soarez"}}, "url": "https://github.com/apache/kafka/commit/20ba02a727b6af3bcdc059f54375f458fccaf889", "committedDate": "2020-10-22T09:21:38Z", "message": "KAFKA-10036 Detect singleton suppliers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "20ba02a727b6af3bcdc059f54375f458fccaf889", "author": {"user": {"login": "soarez", "name": "Igor Soarez"}}, "url": "https://github.com/apache/kafka/commit/20ba02a727b6af3bcdc059f54375f458fccaf889", "committedDate": "2020-10-22T09:21:38Z", "message": "KAFKA-10036 Detect singleton suppliers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "041c51a5c3a70dde7be18a006a3b14b63d2f9199", "author": {"user": {"login": "soarez", "name": "Igor Soarez"}}, "url": "https://github.com/apache/kafka/commit/041c51a5c3a70dde7be18a006a3b14b63d2f9199", "committedDate": "2020-10-22T20:35:20Z", "message": "Missed compilation error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxOTc0NzE4", "url": "https://github.com/apache/kafka/pull/9000#pullrequestreview-521974718", "createdAt": "2020-11-02T20:37:32Z", "commit": {"oid": "041c51a5c3a70dde7be18a006a3b14b63d2f9199"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDozNzozM1rOHsUyPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDozNzozM1rOHsUyPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzOTkzNQ==", "bodyText": "This seems to be a public API change that we cannot do without a KIP. Seem you added it so you can pass the different suppliers into checkSupplier ? Also not sure if checkSupplier must be as \"complicated\" as proposed.", "url": "https://github.com/apache/kafka/pull/9000#discussion_r516239935", "createdAt": "2020-11-02T20:37:33Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/ValueTransformerSupplier.java", "diffHunk": "@@ -33,12 +38,17 @@\n  * @see TransformerSupplier\n  * @see KStream#transform(TransformerSupplier, String...)\n  */\n-public interface ValueTransformerSupplier<V, VR> extends ConnectedStoreProvider {\n+public interface ValueTransformerSupplier<V, VR> extends ConnectedStoreProvider, Supplier<ValueTransformer<V, VR>> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041c51a5c3a70dde7be18a006a3b14b63d2f9199"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxOTc1Nzk1", "url": "https://github.com/apache/kafka/pull/9000#pullrequestreview-521975795", "createdAt": "2020-11-02T20:39:23Z", "commit": {"oid": "041c51a5c3a70dde7be18a006a3b14b63d2f9199"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDozOToyM1rOHsU1gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDozOToyM1rOHsU1gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0MDc2OQ==", "bodyText": "Do we really need to try to extract the concrete interface name?", "url": "https://github.com/apache/kafka/pull/9000#discussion_r516240769", "createdAt": "2020-11-02T20:39:23Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/internals/ApiUtils.java", "diffHunk": "@@ -75,4 +81,31 @@ public static long validateMillisecondInstant(final Instant instant, final Strin\n     public static String prepareMillisCheckFailMsgPrefix(final Object value, final String name) {\n         return format(MILLISECOND_VALIDATION_FAIL_MSG_FRMT, name, value);\n     }\n+\n+    /**\n+     * @throws IllegalArgumentException if the same instance is obtained each time\n+     */\n+    public static void checkSupplier(final Supplier<?> supplier) {\n+        if (supplier.get() == supplier.get()) {\n+            final String supplierClass = getAllImplementedInterfaces(supplier.getClass()).stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041c51a5c3a70dde7be18a006a3b14b63d2f9199"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa8c9c1077c147f43ea4fb2346d56530cb0c7be1", "author": {"user": {"login": "soarez", "name": "Igor Soarez"}}, "url": "https://github.com/apache/kafka/commit/fa8c9c1077c147f43ea4fb2346d56530cb0c7be1", "committedDate": "2020-11-03T13:49:41Z", "message": "Overload and simplify checkSupplier"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1226, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}