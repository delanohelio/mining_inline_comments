{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0OTMzOTgx", "number": 9631, "title": "KAFKA-9672: Leader with ISR as a superset of replicas", "bodyText": "It is possible for the the controller to send LeaderAndIsr requests with\nan ISR that contains ids not in the replica set. This is used during\nreassignment so that the partition leader doesn't add replicas back to\nthe ISR. This is needed because the controller updates ZK and the\nreplicas through two rounds:\n\n\nThe first round of ZK updates and LeaderAndIsr requests shrinks the ISR.\n\n\nThe second round of ZK updates and LeaderAndIsr requests shrinks the replica\nset.\n\n\nThis could be avoided by doing 1. and 2. in one round. Unfortunately the\ncurrent controller implementation makes that non-trivial.\nThis commit changes the leader to allow the state where the ISR contains\nids that are not in the replica set and to remove such ids from the ISR\nif required.\nMore detailed description of your change,\nif necessary. The PR title and PR message become\nthe squashed commit message, so use a separate\ncomment to ping reviewers.\nSummary of testing strategy (including rationale)\nfor the feature or bug fix. Unit and/or integration\ntests are expected for any behaviour change and\nsystem tests should be considered for larger changes.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-11-20T20:26:39Z", "url": "https://github.com/apache/kafka/pull/9631", "merged": true, "mergeCommit": {"oid": "d3612ebc775ea401e6170b3248d146b228d85d1f"}, "closed": true, "closedAt": "2021-02-20T01:07:01Z", "author": {"login": "jsancio"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdedMo-gH2gAyNTI0OTMzOTgxOjY1YjllYmRiOTc4ZmMyYTk2NGU3NzY0OWJmMjdmYTVjYzA0ODAzOTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd7r9M6AH2gAyNTI0OTMzOTgxOjIxNDQ5Y2U4MGI1ZjA5ZDdmYWNkNmJjOWFjOTE2MTk1NjRlMzFmMzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "65b9ebdb978fc2a964e77649bf27fa5cc0480396", "author": {"user": {"login": "jsancio", "name": "Jos\u00e9 Armando Garc\u00eda Sancio"}}, "url": "https://github.com/apache/kafka/commit/65b9ebdb978fc2a964e77649bf27fa5cc0480396", "committedDate": "2020-11-20T20:16:01Z", "message": "KAFKA-9672: Leader with ISR as a superset of replicas\n\nIt is possible for the the controller to send LeaderAndIsr requests with\nan ISR that contains ids not in the replica set. This is used during\nreassignment so that the partition leader doesn't add replicas back to\nthe ISR. This is needed because the controller updates ZK and the\nreplicas through two rounds:\n\n1. The first round of ZK updates and LeaderAndIsr requests shrinks the ISR.\n\n2. The second round of ZK updates and LeaderAndIsr requests shrinks the replica\nset.\n\nThis could be avoided by doing 1. and 2. in one round. Unfortunately the\ncurrent controller implementation makes that non-trivial.\n\nThis commit changes the leader to allow the state where the ISR contains\nids that are not in the replica set and to remove such ids from the ISR\nif required."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2OTMzNzkx", "url": "https://github.com/apache/kafka/pull/9631#pullrequestreview-536933791", "createdAt": "2020-11-23T23:49:22Z", "commit": {"oid": "65b9ebdb978fc2a964e77649bf27fa5cc0480396"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMzo0OToyMlrOH4j50g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMzo0OToyMlrOH4j50g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA3MDU0Ng==", "bodyText": "For the reassignment case, once the controller shrinks the assigned replica set, the next step is for the controller to remove the remove replica from ISR and bump up the leader epoch. The shrunk isr will then be propagated to the leader. With fold(true), we allow to leader to shrink ISR immediately. This might be ok, but is unnecessary work since the controller will be doing that soon.\nAnother option is to use fold(false). This way, the leader won't shrink the removed replica from ISR. Only the controller will do.", "url": "https://github.com/apache/kafka/pull/9631#discussion_r529070546", "createdAt": "2020-11-23T23:49:22Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -947,9 +947,10 @@ class Partition(val topicPartition: TopicPartition,\n                                   leaderEndOffset: Long,\n                                   currentTimeMs: Long,\n                                   maxLagMs: Long): Boolean = {\n-    val followerReplica = getReplicaOrException(replicaId)\n-    followerReplica.logEndOffset != leaderEndOffset &&\n-      (currentTimeMs - followerReplica.lastCaughtUpTimeMs) > maxLagMs\n+    getReplica(replicaId).fold(true) { followerReplica =>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65b9ebdb978fc2a964e77649bf27fa5cc0480396"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzY4MDc3", "url": "https://github.com/apache/kafka/pull/9631#pullrequestreview-541368077", "createdAt": "2020-11-30T23:10:37Z", "commit": {"oid": "65b9ebdb978fc2a964e77649bf27fa5cc0480396"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMzoxMDozN1rOH8RfqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMzoxMDozN1rOH8RfqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2MzI0MQ==", "bodyText": "@jsancio : Yes, we can keep the logic in the PR. On the leader, the logic for shrinking ISR is checked every 10 secs by default. So, in the common case when completing a reassignment, the reduced ISR by the controller will be propagated to the leader before the leader's ISR shrinking logic kicks in.", "url": "https://github.com/apache/kafka/pull/9631#discussion_r532963241", "createdAt": "2020-11-30T23:10:37Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -947,9 +947,10 @@ class Partition(val topicPartition: TopicPartition,\n                                   leaderEndOffset: Long,\n                                   currentTimeMs: Long,\n                                   maxLagMs: Long): Boolean = {\n-    val followerReplica = getReplicaOrException(replicaId)\n-    followerReplica.logEndOffset != leaderEndOffset &&\n-      (currentTimeMs - followerReplica.lastCaughtUpTimeMs) > maxLagMs\n+    getReplica(replicaId).fold(true) { followerReplica =>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA3MDU0Ng=="}, "originalCommit": {"oid": "65b9ebdb978fc2a964e77649bf27fa5cc0480396"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21449ce80b5f09d7facd6bc9ac91619564e31f37", "author": {"user": {"login": "jsancio", "name": "Jos\u00e9 Armando Garc\u00eda Sancio"}}, "url": "https://github.com/apache/kafka/commit/21449ce80b5f09d7facd6bc9ac91619564e31f37", "committedDate": "2021-02-19T15:51:32Z", "message": "Merge remote-tracking branch 'upstream/trunk' into KAFKA-9672-isr-greater-replicas"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2439, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}