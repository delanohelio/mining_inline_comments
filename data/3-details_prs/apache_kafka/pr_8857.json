{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzNDc5NDQ3", "number": 8857, "title": "KAFKA-10157: Fix broken tests due to InterruptedException from FinalizedFeatureChangeListener", "bodyText": "This PR fixes the cause of failing tests mentioned in the jira:\n\nkafka.network.DynamicConnectionQuotaTest\nkafka.api.CustomQuotaCallbackTest\nkafka.server.DynamicBrokerReconfigurationTest\n\nIssue:\nThe call to ChangeNotificationProcessorThread.queue.take() could throw an InterruptedException.  While the queue is empty and the thread is blocking on taking an item from the queue, a concurrent call to FinalizedFeatureChangeListener.close() could interrupt the thread and cause an InterruptedException to be raised from queue.take(). In such a case, it is safe to ignore the exception since the thread is being shutdown.\nDefinitely ignoring the InterruptedException for the above reason was the intent of the code that used the ignoring clause for the same. But it seems unfortunately the ignoring clause does not ignore InterruptedException, so that doesn't work for us. To confirm this theory, I found the following code in scala.util.control.Exception.scala: https://github.com/scala/scala/blob/v2.12.0/src/library/scala/util/control/Exception.scala#L167-L176.\nFix:\nThe fix in this PR is to just not use the ignoring clause. We rely on existing mechanism in ShutdownableThread that ignores the exception during shutdown.\nTest plan:\nRan the unit and integration tests and found that the test failures are gone now.\nI will wait for CI to pass before merging this PR.", "createdAt": "2020-06-12T05:51:36Z", "url": "https://github.com/apache/kafka/pull/8857", "merged": true, "mergeCommit": {"oid": "3d45e1f09ee91a3233eec9adc416ff9c15c2b5c8"}, "closed": true, "closedAt": "2020-06-12T21:17:20Z", "author": {"login": "kowshik"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqcHZDgH2gAyNDMzNDc5NDQ3OmQxMzFlY2JjNTc0N2I4OWM0NDEwNDAxYWYzMjRkN2I2ZTAyNDIxMzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqpEDPAFqTQzMDAyNTY5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d131ecbc5747b89c4410401af324d7b6e0242131", "author": {"user": {"login": "kowshik", "name": "Kowshik Prakasam"}}, "url": "https://github.com/apache/kafka/commit/d131ecbc5747b89c4410401af324d7b6e0242131", "committedDate": "2020-06-12T05:36:19Z", "message": "KAFKA-10157: Fix broken tests due to FinalizedFeatureChangeListener ignoring clause"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NTIwNjA1", "url": "https://github.com/apache/kafka/pull/8857#pullrequestreview-429520605", "createdAt": "2020-06-12T07:29:24Z", "commit": {"oid": "d131ecbc5747b89c4410401af324d7b6e0242131"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNzoyOToyNFrOGi59FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNzoyOToyNFrOGi59FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1NDI5Mg==", "bodyText": "How about using match pattern?\n        case _: InterruptedException =>\n          // We ignore InterruptedException. While the queue is empty and this thread is blocking on\n          // taking an item from the queue, a concurrent call to FinalizedFeatureChangeListener.close()\n          // could interrupt the thread and cause an InterruptedException to be raised from queue.take().\n          // In such a case, it is safe to ignore the exception since the thread is being shutdown.\n        case e: Exception =>\n          error(\"Failed to process feature ZK node change event. The broker will eventually exit.\", e)\n          throw new FatalExitError(1)", "url": "https://github.com/apache/kafka/pull/8857#discussion_r439254292", "createdAt": "2020-06-12T07:29:24Z", "author": {"login": "chia7712"}, "path": "core/src/main/scala/kafka/server/FinalizedFeatureChangeListener.scala", "diffHunk": "@@ -143,13 +142,17 @@ class FinalizedFeatureChangeListener(zkClient: KafkaZkClient) extends Logging {\n   private class ChangeNotificationProcessorThread(name: String) extends ShutdownableThread(name = name) {\n     override def doWork(): Unit = {\n       try {\n-        ignoring(classOf[InterruptedException]) {\n-          queue.take.updateLatestOrThrow()\n-        }\n+        queue.take.updateLatestOrThrow()\n       } catch {\n         case e: Exception => {\n-          error(\"Failed to process feature ZK node change event. The broker will eventually exit.\", e)\n-          throw new FatalExitError(1)\n+          // We ignore InterruptedException. While the queue is empty and this thread is blocking on\n+          // taking an item from the queue, a concurrent call to FinalizedFeatureChangeListener.close()\n+          // could interrupt the thread and cause an InterruptedException to be raised from queue.take().\n+          // In such a case, it is safe to ignore the exception since the thread is being shutdown.\n+          if (!e.isInstanceOf[InterruptedException]) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d131ecbc5747b89c4410401af324d7b6e0242131"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NTIzMjcy", "url": "https://github.com/apache/kafka/pull/8857#pullrequestreview-429523272", "createdAt": "2020-06-12T07:34:08Z", "commit": {"oid": "d131ecbc5747b89c4410401af324d7b6e0242131"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNzozNDowOVrOGi6E0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNzozNDowOVrOGi6E0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1NjI3Mw==", "bodyText": "Done.", "url": "https://github.com/apache/kafka/pull/8857#discussion_r439256273", "createdAt": "2020-06-12T07:34:09Z", "author": {"login": "kowshik"}, "path": "core/src/main/scala/kafka/server/FinalizedFeatureChangeListener.scala", "diffHunk": "@@ -143,13 +142,17 @@ class FinalizedFeatureChangeListener(zkClient: KafkaZkClient) extends Logging {\n   private class ChangeNotificationProcessorThread(name: String) extends ShutdownableThread(name = name) {\n     override def doWork(): Unit = {\n       try {\n-        ignoring(classOf[InterruptedException]) {\n-          queue.take.updateLatestOrThrow()\n-        }\n+        queue.take.updateLatestOrThrow()\n       } catch {\n         case e: Exception => {\n-          error(\"Failed to process feature ZK node change event. The broker will eventually exit.\", e)\n-          throw new FatalExitError(1)\n+          // We ignore InterruptedException. While the queue is empty and this thread is blocking on\n+          // taking an item from the queue, a concurrent call to FinalizedFeatureChangeListener.close()\n+          // could interrupt the thread and cause an InterruptedException to be raised from queue.take().\n+          // In such a case, it is safe to ignore the exception since the thread is being shutdown.\n+          if (!e.isInstanceOf[InterruptedException]) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1NDI5Mg=="}, "originalCommit": {"oid": "d131ecbc5747b89c4410401af324d7b6e0242131"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5Nzk3OTAy", "url": "https://github.com/apache/kafka/pull/8857#pullrequestreview-429797902", "createdAt": "2020-06-12T14:41:01Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNDo0MTowMlrOGjGjiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNDo0MTowMlrOGjGjiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ2MDc0Nw==", "bodyText": "I think we can just propagate this exception to ShutdownableThread. It ignores this exception if the thread is stopped.", "url": "https://github.com/apache/kafka/pull/8857#discussion_r439460747", "createdAt": "2020-06-12T14:41:02Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/server/FinalizedFeatureChangeListener.scala", "diffHunk": "@@ -143,10 +142,13 @@ class FinalizedFeatureChangeListener(zkClient: KafkaZkClient) extends Logging {\n   private class ChangeNotificationProcessorThread(name: String) extends ShutdownableThread(name = name) {\n     override def doWork(): Unit = {\n       try {\n-        ignoring(classOf[InterruptedException]) {\n-          queue.take.updateLatestOrThrow()\n-        }\n+        queue.take.updateLatestOrThrow()\n       } catch {\n+        case _: InterruptedException =>\n+          // We ignore InterruptedException. While the queue is empty and this thread is blocking on", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b296d827941e1d4797db420160f4d50ccaa2f08", "author": {"user": {"login": "kowshik", "name": "Kowshik Prakasam"}}, "url": "https://github.com/apache/kafka/commit/0b296d827941e1d4797db420160f4d50ccaa2f08", "committedDate": "2020-06-12T17:32:12Z", "message": "Address comment from @chia7712"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "0b296d827941e1d4797db420160f4d50ccaa2f08", "author": {"user": {"login": "kowshik", "name": "Kowshik Prakasam"}}, "url": "https://github.com/apache/kafka/commit/0b296d827941e1d4797db420160f4d50ccaa2f08", "committedDate": "2020-06-12T17:32:12Z", "message": "Address comment from @chia7712"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5OTE3MDgy", "url": "https://github.com/apache/kafka/pull/8857#pullrequestreview-429917082", "createdAt": "2020-06-12T17:27:05Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNzoyNzowNVrOGjMEMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNzoyNzowNVrOGjMEMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1MTAyNw==", "bodyText": "Done. Great point.", "url": "https://github.com/apache/kafka/pull/8857#discussion_r439551027", "createdAt": "2020-06-12T17:27:05Z", "author": {"login": "kowshik"}, "path": "core/src/main/scala/kafka/server/FinalizedFeatureChangeListener.scala", "diffHunk": "@@ -143,10 +142,13 @@ class FinalizedFeatureChangeListener(zkClient: KafkaZkClient) extends Logging {\n   private class ChangeNotificationProcessorThread(name: String) extends ShutdownableThread(name = name) {\n     override def doWork(): Unit = {\n       try {\n-        ignoring(classOf[InterruptedException]) {\n-          queue.take.updateLatestOrThrow()\n-        }\n+        queue.take.updateLatestOrThrow()\n       } catch {\n+        case _: InterruptedException =>\n+          // We ignore InterruptedException. While the queue is empty and this thread is blocking on", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ2MDc0Nw=="}, "originalCommit": null, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5OTIzOTM3", "url": "https://github.com/apache/kafka/pull/8857#pullrequestreview-429923937", "createdAt": "2020-06-12T17:38:03Z", "commit": {"oid": "0b296d827941e1d4797db420160f4d50ccaa2f08"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5OTIzODUw", "url": "https://github.com/apache/kafka/pull/8857#pullrequestreview-429923850", "createdAt": "2020-06-12T17:37:52Z", "commit": {"oid": "0b296d827941e1d4797db420160f4d50ccaa2f08"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNzozNzo1M1rOGjMYhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNzozNzo1M1rOGjMYhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1NjIyOQ==", "bodyText": "nit: if it is shutting down -> when shutting down.", "url": "https://github.com/apache/kafka/pull/8857#discussion_r439556229", "createdAt": "2020-06-12T17:37:53Z", "author": {"login": "abbccdda"}, "path": "core/src/main/scala/kafka/server/FinalizedFeatureChangeListener.scala", "diffHunk": "@@ -143,10 +142,15 @@ class FinalizedFeatureChangeListener(zkClient: KafkaZkClient) extends Logging {\n   private class ChangeNotificationProcessorThread(name: String) extends ShutdownableThread(name = name) {\n     override def doWork(): Unit = {\n       try {\n-        ignoring(classOf[InterruptedException]) {\n-          queue.take.updateLatestOrThrow()\n-        }\n+        queue.take.updateLatestOrThrow()\n       } catch {\n+        case ie: InterruptedException =>\n+          // While the queue is empty and this thread is blocking on taking an item from the queue,\n+          // a concurrent call to FinalizedFeatureChangeListener.close() could interrupt the thread\n+          // and cause an InterruptedException to be raised from queue.take(). In such a case, it is\n+          // safe to ignore the exception if the thread is being shutdown. We raise the exception\n+          // here again, because, it is ignored by ShutdownableThread if it is shutting down.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b296d827941e1d4797db420160f4d50ccaa2f08"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMDI1Njkx", "url": "https://github.com/apache/kafka/pull/8857#pullrequestreview-430025691", "createdAt": "2020-06-12T20:41:26Z", "commit": {"oid": "0b296d827941e1d4797db420160f4d50ccaa2f08"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 609, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}