{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1ODA3ODc0", "number": 8258, "title": "HOTFIX: Task#dirtyClose should not throw", "bodyText": "We need to swallow exceptions from StateManagerUtil#close in dirtyClose for both active and standby tasks", "createdAt": "2020-03-09T20:40:48Z", "url": "https://github.com/apache/kafka/pull/8258", "merged": true, "mergeCommit": {"oid": "33f6e1a1cd4c38728112ca697bb04293d65cd968"}, "closed": true, "closedAt": "2020-03-10T17:13:41Z", "author": {"login": "ableegoldman"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMD-4HAH2gAyMzg1ODA3ODc0OmM0MWRhNzc0NTFlZDc0YTFlYzk1NTEwOTBkOTEwODBhMjM5MjQ0N2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMH5UbgH2gAyMzg1ODA3ODc0Ojg2Yjk4MTMyNDQxYTRlY2YxZGI1YjJhYjg5MDhjMTE5MDc2OGFjZTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c41da77451ed74a1ec9551090d91080a2392447e", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/c41da77451ed74a1ec9551090d91080a2392447e", "committedDate": "2020-03-09T20:31:34Z", "message": "catch all exceptions in dirty close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d855b3781367745350585f5767a7523314ccc0fe", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/d855b3781367745350585f5767a7523314ccc0fe", "committedDate": "2020-03-09T21:09:09Z", "message": "should swallow in state manager close as well"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNTMzNTY0", "url": "https://github.com/apache/kafka/pull/8258#pullrequestreview-371533564", "createdAt": "2020-03-09T21:13:56Z", "commit": {"oid": "d855b3781367745350585f5767a7523314ccc0fe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMToxMzo1NlrOFz5l4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMToxMzo1NlrOFz5l4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk2NTI4MA==", "bodyText": "Pulled this up into AbstractTask so we can log in the executeAndMaybeSwallow method I also extracted", "url": "https://github.com/apache/kafka/pull/8258#discussion_r389965280", "createdAt": "2020-03-09T21:13:56Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/AbstractTask.java", "diffHunk": "@@ -17,18 +17,24 @@\n package org.apache.kafka.streams.processor.internals;\n \n import org.apache.kafka.common.TopicPartition;\n+import org.apache.kafka.common.utils.LogContext;\n import org.apache.kafka.streams.processor.StateStore;\n import org.apache.kafka.streams.processor.TaskId;\n \n import java.util.Collection;\n import java.util.Set;\n+import org.slf4j.Logger;\n \n+import static java.lang.String.format;\n import static org.apache.kafka.streams.processor.internals.Task.State.CLOSED;\n import static org.apache.kafka.streams.processor.internals.Task.State.CREATED;\n \n public abstract class AbstractTask implements Task {\n     private Task.State state = CREATED;\n \n+    protected final Logger log;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d855b3781367745350585f5767a7523314ccc0fe"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNTMzODIy", "url": "https://github.com/apache/kafka/pull/8258#pullrequestreview-371533822", "createdAt": "2020-03-09T21:14:23Z", "commit": {"oid": "d855b3781367745350585f5767a7523314ccc0fe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMToxNDoyNFrOFz5mrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMToxNDoyNFrOFz5mrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk2NTQ4NA==", "bodyText": "Not sure how this slipped by checkstyle?", "url": "https://github.com/apache/kafka/pull/8258#discussion_r389965484", "createdAt": "2020-03-09T21:14:24Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StandbyTask.java", "diffHunk": "@@ -172,15 +169,18 @@ private void close(final boolean clean) {\n             transitionTo(State.CLOSING);\n         } else {\n             if (state() == State.RUNNING) {\n-                if (clean)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d855b3781367745350585f5767a7523314ccc0fe"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e135628aa9194e05f5bf3d04f2ccf9b2ac691310", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/e135628aa9194e05f5bf3d04f2ccf9b2ac691310", "committedDate": "2020-03-09T21:14:58Z", "message": "match spacing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e49b4aaf14f741daa0216ca2a87f808c94bef44", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/8e49b4aaf14f741daa0216ca2a87f808c94bef44", "committedDate": "2020-03-09T21:17:29Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46892f0a81a6a738304722b650d5eaa0bd58c7cf", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/46892f0a81a6a738304722b650d5eaa0bd58c7cf", "committedDate": "2020-03-09T21:18:31Z", "message": "compile test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6561f8874e7974c9ee080905088600973b44e5be", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/6561f8874e7974c9ee080905088600973b44e5be", "committedDate": "2020-03-09T21:28:21Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "718e64a26f1e5d309e1cbbfd1b67503b9c9c4706", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/718e64a26f1e5d309e1cbbfd1b67503b9c9c4706", "committedDate": "2020-03-09T21:30:55Z", "message": "fix streamtask string"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNTU3NjEz", "url": "https://github.com/apache/kafka/pull/8258#pullrequestreview-371557613", "createdAt": "2020-03-09T21:58:36Z", "commit": {"oid": "718e64a26f1e5d309e1cbbfd1b67503b9c9c4706"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMTo1ODozNlrOFz6zbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMjowMzowOVrOFz660Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4NTEzNQ==", "bodyText": "What exception is possibly thrown from this close(false) call?", "url": "https://github.com/apache/kafka/pull/8258#discussion_r389985135", "createdAt": "2020-03-09T21:58:36Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StandbyTask.java", "diffHunk": "@@ -154,7 +145,11 @@ public void closeClean() {\n \n     @Override\n     public void closeDirty() {\n-        close(false);\n+        try {\n+            close(false);\n+        } catch (final RuntimeException e) {\n+            log.warn(String.format(\"Ignoring uncaught error in unclean close of standby task %s\", id), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "718e64a26f1e5d309e1cbbfd1b67503b9c9c4706"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4NzAyNQ==", "bodyText": "Ditto here, if we have swallowed all possible exception inside close, then it is unnecessary to have another swallow here.", "url": "https://github.com/apache/kafka/pull/8258#discussion_r389987025", "createdAt": "2020-03-09T22:03:09Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -389,7 +380,11 @@ public void closeClean() {\n \n     @Override\n     public void closeDirty() {\n-        close(false);\n+        try {\n+            close(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "718e64a26f1e5d309e1cbbfd1b67503b9c9c4706"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNTg3MTQ3", "url": "https://github.com/apache/kafka/pull/8258#pullrequestreview-371587147", "createdAt": "2020-03-09T23:11:38Z", "commit": {"oid": "718e64a26f1e5d309e1cbbfd1b67503b9c9c4706"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMzoxMTozOFrOFz8Xng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMzoxMjo1MlrOFz8ZDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAxMDc4Mg==", "bodyText": "Hmmm... Seems to not align with OO principles to pass in the task type... maybe better pass the Logger into executeAndMaybeSwallow ?", "url": "https://github.com/apache/kafka/pull/8258#discussion_r390010782", "createdAt": "2020-03-09T23:11:38Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/AbstractTask.java", "diffHunk": "@@ -17,18 +17,24 @@\n package org.apache.kafka.streams.processor.internals;\n \n import org.apache.kafka.common.TopicPartition;\n+import org.apache.kafka.common.utils.LogContext;\n import org.apache.kafka.streams.processor.StateStore;\n import org.apache.kafka.streams.processor.TaskId;\n \n import java.util.Collection;\n import java.util.Set;\n+import org.slf4j.Logger;\n \n+import static java.lang.String.format;\n import static org.apache.kafka.streams.processor.internals.Task.State.CLOSED;\n import static org.apache.kafka.streams.processor.internals.Task.State.CREATED;\n \n public abstract class AbstractTask implements Task {\n     private Task.State state = CREATED;\n \n+    protected final Logger log;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk2NTI4MA=="}, "originalCommit": {"oid": "d855b3781367745350585f5767a7523314ccc0fe"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAxMDg4NA==", "bodyText": "Seems this method could be static?", "url": "https://github.com/apache/kafka/pull/8258#discussion_r390010884", "createdAt": "2020-03-09T23:11:59Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/AbstractTask.java", "diffHunk": "@@ -100,4 +112,16 @@ final void transitionTo(final Task.State newState) {\n             throw new IllegalStateException(\"Invalid transition from \" + oldState + \" to \" + newState);\n         }\n     }\n+\n+    void executeAndMaybeSwallow(final boolean clean, final Runnable runnable, final String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "718e64a26f1e5d309e1cbbfd1b67503b9c9c4706"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAxMTE0OQ==", "bodyText": "I think checkstyle does not enforce it... Even if I think it should...", "url": "https://github.com/apache/kafka/pull/8258#discussion_r390011149", "createdAt": "2020-03-09T23:12:52Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StandbyTask.java", "diffHunk": "@@ -172,15 +169,18 @@ private void close(final boolean clean) {\n             transitionTo(State.CLOSING);\n         } else {\n             if (state() == State.RUNNING) {\n-                if (clean)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk2NTQ4NA=="}, "originalCommit": {"oid": "d855b3781367745350585f5767a7523314ccc0fe"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f39f9761a399e38eec949bb698a8843defd79bbc", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/f39f9761a399e38eec949bb698a8843defd79bbc", "committedDate": "2020-03-10T00:09:12Z", "message": "handle exceptions in caller"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1817b93c6ae29a10036a151c2f38b556f2f4e49e", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/1817b93c6ae29a10036a151c2f38b556f2f4e49e", "committedDate": "2020-03-10T00:10:24Z", "message": "revert test changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec84654907be83f23d8001121848a6aa2938b954", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/ec84654907be83f23d8001121848a6aa2938b954", "committedDate": "2020-03-10T00:13:22Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7067f4766208bfded607295360998b41977ef16d", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/7067f4766208bfded607295360998b41977ef16d", "committedDate": "2020-03-10T00:54:07Z", "message": "revert handling"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "7067f4766208bfded607295360998b41977ef16d", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/7067f4766208bfded607295360998b41977ef16d", "committedDate": "2020-03-10T00:54:07Z", "message": "revert handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9da7d1d0c4daf2011e4d1d64cbe18670515a0585", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/9da7d1d0c4daf2011e4d1d64cbe18670515a0585", "committedDate": "2020-03-10T00:57:11Z", "message": "fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNjE5OTY5", "url": "https://github.com/apache/kafka/pull/8258#pullrequestreview-371619969", "createdAt": "2020-03-10T00:57:43Z", "commit": {"oid": "7067f4766208bfded607295360998b41977ef16d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86b98132441a4ecf1db5b2ab8908c1190768ace9", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/86b98132441a4ecf1db5b2ab8908c1190768ace9", "committedDate": "2020-03-10T01:05:07Z", "message": "add unit test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 185, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}