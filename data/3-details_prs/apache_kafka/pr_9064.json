{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1NzI4NTk3", "number": 9064, "title": "KAFKA-10205: Documentation and handling of non deterministic Topologies", "bodyText": "Kafka Streams topologies must be defined in a deterministic order, otherwise users can run into confusing NPE.\nThis patch adds a more descriptive exception and documentation clarifying the deterministic requirement.\nhttps://issues.apache.org/jira/browse/KAFKA-10205\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-07-23T13:59:15Z", "url": "https://github.com/apache/kafka/pull/9064", "merged": true, "mergeCommit": {"oid": "d1c82a9baf5f3a0d3bde3ec35157358f7a62ecc8"}, "closed": true, "closedAt": "2020-09-30T19:06:12Z", "author": {"login": "soarez"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3yQqNAFqTQ1NDMwOTcyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdD-NxhABqjM3MDczMDg1NTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MzA5NzI1", "url": "https://github.com/apache/kafka/pull/9064#pullrequestreview-454309725", "createdAt": "2020-07-23T16:37:21Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNjozNzoyMVrOG2SpFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNjo0NTowNlrOG2S7FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MTcxNw==", "bodyText": "Nit: insert <p> tag to actually get the new paragraph rendered.\nNit: Topology -> {@link Topology}`\nIt's not really clear what \"deterministic\" means. We should elaborate more.", "url": "https://github.com/apache/kafka/pull/9064#discussion_r459581717", "createdAt": "2020-07-23T16:37:21Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/StreamsBuilder.java", "diffHunk": "@@ -49,6 +49,9 @@\n /**\n  * {@code StreamsBuilder} provide the high-level Kafka Streams DSL to specify a Kafka Streams topology.\n  *\n+ * It is a requirement that the processing logic (Topology) be defined in a deterministic way.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MjgwMA==", "bodyText": "\"different\" for sure, but this implies that one might have an operator the other does not. The observed issue is, that even if both contain the same operator, they might be added in different order (and thus be named differently) to the Topology, thus we should stretch that order matters.", "url": "https://github.com/apache/kafka/pull/9064#discussion_r459582800", "createdAt": "2020-07-23T16:39:08Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/StreamsBuilder.java", "diffHunk": "@@ -49,6 +49,9 @@\n /**\n  * {@code StreamsBuilder} provide the high-level Kafka Streams DSL to specify a Kafka Streams topology.\n  *\n+ * It is a requirement that the processing logic (Topology) be defined in a deterministic way.\n+ * If different instances build different runtime code logic the resulting behavior may be unexpected.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4NTQyMw==", "bodyText": "Topic not found sounds like as-if the topic was not found in the cluster -- however, what actually happened is that we received a record but the record's topic is unknown in the sub-topology.\nSimilar to above, \"deterministic\" is not really easy to understand. I would also not phrase it as a question, but as a statement:\n... This may happen if different KafkaStreams instances of the same application execute different Topologies. Note that Topologies are only identical if all operators are added in the same order.\n\nOr similar.", "url": "https://github.com/apache/kafka/pull/9064#discussion_r459585423", "createdAt": "2020-07-23T16:43:33Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -181,8 +182,16 @@ public StreamTask(final TaskId id,\n \n         final TimestampExtractor defaultTimestampExtractor = config.defaultTimestampExtractor();\n         final DeserializationExceptionHandler defaultDeserializationExceptionHandler = config.defaultDeserializationExceptionHandler();\n+        final Set<String> sourceTopics = topology.sourceTopics();\n         for (final TopicPartition partition : partitions) {\n-            final SourceNode source = topology.source(partition.topic());\n+            final String topicName = partition.topic();\n+            if (!sourceTopics.contains(topicName)) {\n+                throw new TopologyException(\n+                        \"Topic not found \" + topicName + \". Is the Streams Topology built in a deterministic way?\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4NjMyNA==", "bodyText": "We should not use this annotation but rather use assertThrows (we still have some code that does not use assertThrows but we try to lazily migrate our tests, as it provides a better test pattern).", "url": "https://github.com/apache/kafka/pull/9064#discussion_r459586324", "createdAt": "2020-07-23T16:45:06Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java", "diffHunk": "@@ -1984,6 +1985,24 @@ public void shouldThrowWakeupExceptionOnInitializeOffsetsWhenWakeupException() {\n         task.initializeStateStores();\n     }\n \n+    @Test(expected = TopologyException.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNDQ0MTQ5", "url": "https://github.com/apache/kafka/pull/9064#pullrequestreview-460444149", "createdAt": "2020-08-04T01:53:09Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMTo1MzowOVrOG7ORWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMTo1OToyNlrOG7OXlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc1Mjk4Nw==", "bodyText": "{@link KafkaStreams}", "url": "https://github.com/apache/kafka/pull/9064#discussion_r464752987", "createdAt": "2020-08-04T01:53:09Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/StreamsBuilder.java", "diffHunk": "@@ -50,6 +50,14 @@\n /**\n  * {@code StreamsBuilder} provide the high-level Kafka Streams DSL to specify a Kafka Streams topology.\n  *\n+ * <p>\n+ * It is a requirement that the processing logic ({@link Topology}) be defined in a deterministic way,\n+ * as in, the order in which all operators are added must be predictable and the same across all application\n+ * instances.\n+ * Topologies are only identical if all operators are added in the same order.\n+ * If different KafkaStream instances of the same application build different topologies the result may be", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc1MzI0NA==", "bodyText": "incompatible runtimes and unexpected results -> incompatible runtime code and unexpected results or errors.", "url": "https://github.com/apache/kafka/pull/9064#discussion_r464753244", "createdAt": "2020-08-04T01:54:05Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/StreamsBuilder.java", "diffHunk": "@@ -50,6 +50,14 @@\n /**\n  * {@code StreamsBuilder} provide the high-level Kafka Streams DSL to specify a Kafka Streams topology.\n  *\n+ * <p>\n+ * It is a requirement that the processing logic ({@link Topology}) be defined in a deterministic way,\n+ * as in, the order in which all operators are added must be predictable and the same across all application\n+ * instances.\n+ * Topologies are only identical if all operators are added in the same order.\n+ * If different KafkaStream instances of the same application build different topologies the result may be\n+ * incompatible runtimes and unexpected results.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc1MzkzOA==", "bodyText": "nit: formatting: (we should also get the exception an verify the error message)\nfinal TopologyException  exception = assertThrows(\n    TopologyException.class,\n    () -> new StreamTask(\n        ...\n    )\n);\n\nassertThat(exception.getMessage(), equalTo(\"...\"));", "url": "https://github.com/apache/kafka/pull/9064#discussion_r464753938", "createdAt": "2020-08-04T01:56:47Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java", "diffHunk": "@@ -1916,6 +1917,40 @@ public void shouldAlwaysSuspendRunningTasks() {\n         assertThat(task.state(), equalTo(SUSPENDED));\n     }\n \n+    @Test\n+    public void szTest() {\n+        final InternalProcessorContext context = new ProcessorContextImpl(\n+                taskId,\n+                createConfig(false, \"100\"),\n+                stateManager,\n+                streamsMetrics,\n+                null\n+        );\n+        final StreamsMetricsImpl metrics = new StreamsMetricsImpl(this.metrics, \"test\", StreamsConfig.METRICS_LATEST);\n+        EasyMock.expect(stateManager.changelogPartitions()).andReturn(Collections.emptySet());\n+        EasyMock.replay(stateManager);\n+\n+        // The processor topology is missing the topics\n+        final ProcessorTopology topology = withSources(asList(), mkMap());\n+\n+        assertThrows(TopologyException.class, () ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc1NDU4Mg==", "bodyText": "szTest is a terrible test name: shouldThrowTopologyExceptionIfTaskCreatedForUnknownTopic", "url": "https://github.com/apache/kafka/pull/9064#discussion_r464754582", "createdAt": "2020-08-04T01:59:26Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java", "diffHunk": "@@ -1916,6 +1917,40 @@ public void shouldAlwaysSuspendRunningTasks() {\n         assertThat(task.state(), equalTo(SUSPENDED));\n     }\n \n+    @Test\n+    public void szTest() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNzYzOTI5", "url": "https://github.com/apache/kafka/pull/9064#pullrequestreview-472763929", "createdAt": "2020-08-21T19:18:38Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNzY5NDU1", "url": "https://github.com/apache/kafka/pull/9064#pullrequestreview-472769455", "createdAt": "2020-08-21T19:29:04Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "b82dd38f9033020331466681dbe525eeea564faf", "author": {"user": {"login": "soarez", "name": "Igor Soarez"}}, "url": "https://github.com/apache/kafka/commit/b82dd38f9033020331466681dbe525eeea564faf", "committedDate": "2020-08-30T13:25:32Z", "message": "KAFKA-10205: Documentation and handling of non deterministic Topologies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "b82dd38f9033020331466681dbe525eeea564faf", "author": {"user": {"login": "soarez", "name": "Igor Soarez"}}, "url": "https://github.com/apache/kafka/commit/b82dd38f9033020331466681dbe525eeea564faf", "committedDate": "2020-08-30T13:25:32Z", "message": "KAFKA-10205: Documentation and handling of non deterministic Topologies"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1369, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}