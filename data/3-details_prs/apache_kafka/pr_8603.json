{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNTA2NDcy", "number": 8603, "title": "MINOR: Fix ProcessorContext JavaDocs", "bodyText": "We changed how \"stream time\" is computed in 2.3 release. This should be cherry-picked to older branches.", "createdAt": "2020-05-02T20:49:54Z", "url": "https://github.com/apache/kafka/pull/8603", "merged": true, "mergeCommit": {"oid": "778d04d4f94636771cf1765633c53426ae7e1b89"}, "closed": true, "closedAt": "2020-05-12T22:19:47Z", "author": {"login": "mjsax"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdcmC5gH2gAyNDEyNTA2NDcyOjdiODBjNjFiZjA3ZmY5NDBmMjIyY2U3YzJkYTM1M2YyNTQwZWNmOWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgXcOJAFqTQwOTU3NjE2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7b80c61bf07ff940f222ce7c2da353f2540ecf9c", "author": {"user": {"login": "mjsax", "name": "Matthias J. Sax"}}, "url": "https://github.com/apache/kafka/commit/7b80c61bf07ff940f222ce7c2da353f2540ecf9c", "committedDate": "2020-05-02T20:48:47Z", "message": "MINOR: Fix ProcessorContext JavaDocs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MTIwMjUz", "url": "https://github.com/apache/kafka/pull/8603#pullrequestreview-406120253", "createdAt": "2020-05-05T20:12:31Z", "commit": {"oid": "7b80c61bf07ff940f222ce7c2da353f2540ecf9c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQyMDoxMjozMVrOGQ5zEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQyMDoxMjozMVrOGQ5zEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM3NzM2MQ==", "bodyText": "I just took another look at the definition of streamTime, and it actually looks like it might be computed wrongly.\nThe way it works is that the \"stream time\" for a task is computed most of the time in org.apache.kafka.streams.processor.internals.PartitionGroup#nextRecord, i.e., it's the max timestamp of any record polled from the PartitionGroup.\nHowever, when we commit, we commit the \"partition time\" for each TopicPartition, which is set when we move a record into the head position for that queue. During restoration, we read these committed timestamps for each TopicPartition, and we (incorrectly) set the \"stream time\" to be the maximum over the \"partition time\" of each partition in the PartitionGroup (aka Task).\nThis is incorrect in two ways:\n\nit should be the minimum, not the maximum (since we would choose the record with the minimum timestamp to process next)\nthe timestamp of the head enqueued record (partition time) is not the timestamp of the last dequeued record (stream time).\n\nI'll file a Jira ticket capturing all this. In the mean time, I'd suggest that we just update the docs to reflect the correct definition of \"stream time\": which is defined as the largest timestamp of any record processed by the task. Then, we can fix the code to make this true all the time. Currently, it's only true in steady state, not immediately after restoration.", "url": "https://github.com/apache/kafka/pull/8603#discussion_r420377361", "createdAt": "2020-05-05T20:12:31Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java", "diffHunk": "@@ -209,49 +211,52 @@ Cancellable schedule(final Duration interval,\n     <K1 extends K, V1 extends V> void forward(final K1 key, final V1 value, final String childName);\n \n     /**\n-     * Requests a commit\n+     * Requests a commit.\n      */\n     void commit();\n \n     /**\n      * Returns the topic name of the current input record; could be null if it is not\n-     * available (for example, if this method is invoked from the punctuate call)\n+     * available (for example, if this method is invoked from the punctuate call).\n      *\n      * @return the topic name\n      */\n     String topic();\n \n     /**\n      * Returns the partition id of the current input record; could be -1 if it is not\n-     * available (for example, if this method is invoked from the punctuate call)\n+     * available (for example, if this method is invoked from the punctuate call).\n      *\n      * @return the partition id\n      */\n     int partition();\n \n     /**\n      * Returns the offset of the current input record; could be -1 if it is not\n-     * available (for example, if this method is invoked from the punctuate call)\n+     * available (for example, if this method is invoked from the punctuate call).\n      *\n      * @return the offset\n      */\n     long offset();\n \n     /**\n-     * Returns the headers of the current input record; could be null if it is not available\n+     * Returns the headers of the current input record; could be null if it is not\n+     * available (for example, if this method is invoked from the punctuate call).\n+     *\n      * @return the headers\n      */\n     Headers headers();\n \n     /**\n      * Returns the current timestamp.\n      *\n-     * If it is triggered while processing a record streamed from the source processor, timestamp is defined as the timestamp of the current input record; the timestamp is extracted from\n+     * <p> If it is triggered while processing a record streamed from the source processor,\n+     * timestamp is defined as the timestamp of the current input record; the timestamp is extracted from\n      * {@link org.apache.kafka.clients.consumer.ConsumerRecord ConsumerRecord} by {@link TimestampExtractor}.\n      *\n-     * If it is triggered while processing a record generated not from the source processor (for example,\n+     * <p> If it is triggered while processing a record generated not from the source processor (for example,\n      * if this method is invoked from the punctuate call), timestamp is defined as the current\n-     * task's stream time, which is defined as the smallest among all its input stream partition timestamps.\n+     * task's stream time, which is defined as the largest among all its input stream partition timestamps.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b80c61bf07ff940f222ce7c2da353f2540ecf9c"}, "originalPosition": 119}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60eabac9bb93b22b7cc5e47e58e92f4ff2e52655", "author": {"user": {"login": "mjsax", "name": "Matthias J. Sax"}}, "url": "https://github.com/apache/kafka/commit/60eabac9bb93b22b7cc5e47e58e92f4ff2e52655", "committedDate": "2020-05-06T00:00:07Z", "message": "Github comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTc2MTY2", "url": "https://github.com/apache/kafka/pull/8603#pullrequestreview-409576166", "createdAt": "2020-05-11T22:30:18Z", "commit": {"oid": "60eabac9bb93b22b7cc5e47e58e92f4ff2e52655"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1325, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}