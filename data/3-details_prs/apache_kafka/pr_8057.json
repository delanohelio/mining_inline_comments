{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMTY3ODEx", "number": 8057, "title": "KAFKA-9507 AdminClient should check for missing committed offsets", "bodyText": "JIRA: https://issues.apache.org/jira/browse/KAFKA-9507\nAddresses exception being thrown by AdminClient when listConsumerGroupOffsets returns a negative offset.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-02-06T23:48:02Z", "url": "https://github.com/apache/kafka/pull/8057", "merged": true, "mergeCommit": {"oid": "7a2a198d1e8755ec367a3d95c68aaf35b8ad9ede"}, "closed": true, "closedAt": "2020-02-08T00:43:52Z", "author": {"login": "splett2"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBzi8cAH2gAyMzcyMTY3ODExOjBhN2UyYTZlODIwZmFlMjYzMmE5ODcwNTQ5NGNkMWEzNzRkNDZmOWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCI8xYgFqTM1NTUxMTE4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0a7e2a6e820fae2632a98705494cd1a374d46f9f", "author": {"user": {"login": "splett2", "name": "David Mao"}}, "url": "https://github.com/apache/kafka/commit/0a7e2a6e820fae2632a98705494cd1a374d46f9f", "committedDate": "2020-02-06T23:43:20Z", "message": "KAFKA-9507 AdminClient should check for missing committed offsets"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODUzNTQ4", "url": "https://github.com/apache/kafka/pull/8057#pullrequestreview-354853548", "createdAt": "2020-02-06T23:52:34Z", "commit": {"oid": "0a7e2a6e820fae2632a98705494cd1a374d46f9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMzo1MjozNVrOFmuNaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMzo1MjozNVrOFmuNaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE0NzMwNQ==", "bodyText": "maybe add a comment here that negative offset indicates there is no committed offset for the topic partition? Would be easier for other people to understand the code.", "url": "https://github.com/apache/kafka/pull/8057#discussion_r376147305", "createdAt": "2020-02-06T23:52:35Z", "author": {"login": "apovzner"}, "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -3100,7 +3100,11 @@ void handleResponse(AbstractResponse abstractResponse) {\n                         final Long offset = partitionData.offset;\n                         final String metadata = partitionData.metadata;\n                         final Optional<Integer> leaderEpoch = partitionData.leaderEpoch;\n-                        groupOffsetsListing.put(topicPartition, new OffsetAndMetadata(offset, leaderEpoch, metadata));\n+                        if (offset < 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a7e2a6e820fae2632a98705494cd1a374d46f9f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODUzMzA5", "url": "https://github.com/apache/kafka/pull/8057#pullrequestreview-354853309", "createdAt": "2020-02-06T23:51:47Z", "commit": {"oid": "0a7e2a6e820fae2632a98705494cd1a374d46f9f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMzo1MTo0OFrOFmuMrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMzo1NjoxNVrOFmuROQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE0NzExNw==", "bodyText": "Let's use OffsetFetchResponse.INVALID_OFFSET", "url": "https://github.com/apache/kafka/pull/8057#discussion_r376147117", "createdAt": "2020-02-06T23:51:48Z", "author": {"login": "hachikuji"}, "path": "clients/src/test/java/org/apache/kafka/clients/admin/KafkaAdminClientTest.java", "diffHunk": "@@ -1502,15 +1503,18 @@ public void testDescribeConsumerGroupOffsets() throws Exception {\n                     Optional.empty(), \"\", Errors.NONE));\n             responseData.put(myTopicPartition2, new OffsetFetchResponse.PartitionData(20,\n                     Optional.empty(), \"\", Errors.NONE));\n+            responseData.put(myTopicPartition3, new OffsetFetchResponse.PartitionData(-1,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a7e2a6e820fae2632a98705494cd1a374d46f9f"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE0NzEzMA==", "bodyText": "Could we assert that the map contains the key myTopicPartition3?", "url": "https://github.com/apache/kafka/pull/8057#discussion_r376147130", "createdAt": "2020-02-06T23:51:52Z", "author": {"login": "hachikuji"}, "path": "clients/src/test/java/org/apache/kafka/clients/admin/KafkaAdminClientTest.java", "diffHunk": "@@ -1502,15 +1503,18 @@ public void testDescribeConsumerGroupOffsets() throws Exception {\n                     Optional.empty(), \"\", Errors.NONE));\n             responseData.put(myTopicPartition2, new OffsetFetchResponse.PartitionData(20,\n                     Optional.empty(), \"\", Errors.NONE));\n+            responseData.put(myTopicPartition3, new OffsetFetchResponse.PartitionData(-1,\n+                    Optional.empty(), \"\", Errors.NONE));\n             env.kafkaClient().prepareResponse(new OffsetFetchResponse(Errors.NONE, responseData));\n \n             final ListConsumerGroupOffsetsResult result = env.adminClient().listConsumerGroupOffsets(\"group-0\");\n             final Map<TopicPartition, OffsetAndMetadata> partitionToOffsetAndMetadata = result.partitionsToOffsetAndMetadata().get();\n \n-            assertEquals(3, partitionToOffsetAndMetadata.size());\n+            assertEquals(4, partitionToOffsetAndMetadata.size());\n             assertEquals(10, partitionToOffsetAndMetadata.get(myTopicPartition0).offset());\n             assertEquals(0, partitionToOffsetAndMetadata.get(myTopicPartition1).offset());\n             assertEquals(20, partitionToOffsetAndMetadata.get(myTopicPartition2).offset());\n+            assertNull(partitionToOffsetAndMetadata.get(myTopicPartition3));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a7e2a6e820fae2632a98705494cd1a374d46f9f"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE0ODI4MQ==", "bodyText": "I'd suggest rephrasing this:\n\nIf the group does not have a committed offset for this partition, the corresponding value in the returned map will be null.", "url": "https://github.com/apache/kafka/pull/8057#discussion_r376148281", "createdAt": "2020-02-06T23:56:15Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/admin/ListConsumerGroupOffsetsResult.java", "diffHunk": "@@ -40,6 +40,7 @@\n \n     /**\n      * Return a future which yields a map of topic partitions to OffsetAndMetadata objects.\n+     * If the partition does not have a committed offset, the corresponding value will be null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a7e2a6e820fae2632a98705494cd1a374d46f9f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9847c4aec837a89172fc9a09f7fefc7de6af9e51", "author": {"user": {"login": "splett2", "name": "David Mao"}}, "url": "https://github.com/apache/kafka/commit/9847c4aec837a89172fc9a09f7fefc7de6af9e51", "committedDate": "2020-02-07T00:11:02Z", "message": "addresses PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTExMTg5", "url": "https://github.com/apache/kafka/pull/8057#pullrequestreview-355511189", "createdAt": "2020-02-08T00:39:33Z", "commit": {"oid": "9847c4aec837a89172fc9a09f7fefc7de6af9e51"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1784, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}