{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNDk3MjU2", "number": 8455, "title": "KAFKA-9845: Warn users about using config providers with plugin.path property", "bodyText": "Jira\nThe initially-attempted fix (present as the first commit in this PR) caused the transformed worker configuration to be passed to the Plugins instance which performs plugin path scanning, instead of the raw (pre-transform) worker configuration. This had the added benefit that worker configuration validation would take place before plugin path scanning, which in some environments can take a while.\nUnfortunately, as a side effect, the loading of properties of type CLASS from the WorkerConfig was broken. No clear fix is apparent due to this circular dependency issue: Plugins needs to be instantiated and compareAndSwapWithDelegatingLoader invoked before creating the worker config since it loads classes when instantiated, and the config provider logic specified in the worker config needs to be performed on the plugin.path property before instantiating the Plugins instance. This is especially complicated by the fact that config providers are loaded as plugins.\nAs a result, the new proposal is to simply warn the user whenever it appears they are using a config provider in the value for the plugin.path property and link to KAFKA-9845.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-04-09T15:38:07Z", "url": "https://github.com/apache/kafka/pull/8455", "merged": true, "mergeCommit": {"oid": "92d56ed93325c3849a36fc6dceb9ccab1c42edce"}, "closed": true, "closedAt": "2020-06-11T03:06:39Z", "author": {"login": "C0urante"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV-SUggH2gAyNDAxNDk3MjU2Ojk2Y2FhYTlhNDkzNGJjZWY3OGQ3YjE0NWQxOGFhMTcxOGNiMTAwMDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqFNLKgH2gAyNDAxNDk3MjU2OmNjZWM3MTNkMGJiYmQ1YzZhYjg1Zjc2ZGNiZmQyNTkyYzU3YzIxNTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "96caaa9a4934bcef78d7b145d18aa1718cb10009", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/96caaa9a4934bcef78d7b145d18aa1718cb10009", "committedDate": "2020-04-09T15:32:37Z", "message": "KAFKA-9845: Fix plugin.path when config provider is used"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab16154ff778e36eb509a43639438e8692cb048e", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/ab16154ff778e36eb509a43639438e8692cb048e", "committedDate": "2020-04-09T17:37:48Z", "message": "Revert \"KAFKA-9845: Fix plugin.path when config provider is used\"\n\nThis reverts commit 96caaa9a4934bcef78d7b145d18aa1718cb10009."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9387144bffd9257df08c49aa8a177ee7fc5c451", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/f9387144bffd9257df08c49aa8a177ee7fc5c451", "committedDate": "2020-04-09T21:46:19Z", "message": "KAFKA-9845: Emit ERROR-level log message when config provider is used for plugin.path property"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMjAzNDgy", "url": "https://github.com/apache/kafka/pull/8455#pullrequestreview-391203482", "createdAt": "2020-04-10T00:04:39Z", "commit": {"oid": "f9387144bffd9257df08c49aa8a177ee7fc5c451"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwMDowNDo0MFrOGDtOtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwMDowNDo0MFrOGDtOtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzOTk1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.error(\n          \n          \n            \n                        log.warn(", "url": "https://github.com/apache/kafka/pull/8455#discussion_r406539959", "createdAt": "2020-04-10T00:04:40Z", "author": {"login": "ncliang"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -379,6 +380,20 @@ private void logDeprecatedProperty(String propName, String propValue, String def\n         }\n     }\n \n+    private void logPluginPathConfigProviderWarning(Map<String, String> rawOriginals) {\n+        String rawPluginPath = rawOriginals.get(PLUGIN_PATH_CONFIG);\n+        String transformedPluginPath = originalsStrings().get(PLUGIN_PATH_CONFIG);\n+        if (!Objects.equals(rawPluginPath, transformedPluginPath)) {\n+            log.error(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9387144bffd9257df08c49aa8a177ee7fc5c451"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e9dae6efad90e6588aeddf030253c569c458731", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/1e9dae6efad90e6588aeddf030253c569c458731", "committedDate": "2020-04-10T05:26:17Z", "message": "KAFKA-9845: Demote log message level from ERROR to WARN\n\nCo-Authored-By: Nigel Liang <nigel@nigelliang.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2f339c438e1c91ef7b646941fc1ae584d0b2cda", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/a2f339c438e1c91ef7b646941fc1ae584d0b2cda", "committedDate": "2020-04-10T17:54:35Z", "message": "KAFKA-94845: Fix failing unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d8af18e03e17361d430727a8b44e3f7a4077af4", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/5d8af18e03e17361d430727a8b44e3f7a4077af4", "committedDate": "2020-04-10T18:35:34Z", "message": "KAFKA-9845: Add warning message to docstring for plugin.path config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTk5NDcy", "url": "https://github.com/apache/kafka/pull/8455#pullrequestreview-391599472", "createdAt": "2020-04-10T18:42:55Z", "commit": {"oid": "5d8af18e03e17361d430727a8b44e3f7a4077af4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTU2NTkw", "url": "https://github.com/apache/kafka/pull/8455#pullrequestreview-428556590", "createdAt": "2020-06-11T02:48:04Z", "commit": {"oid": "5d8af18e03e17361d430727a8b44e3f7a4077af4"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMjo0ODowNVrOGiMs2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMjo1MTo0N1rOGiMwVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMjg1OQ==", "bodyText": "How about:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        + \"/opt/connectors\\n\" \n          \n          \n            \n                        + \"Warning: Config providers will not take effect if used for the value of this \" \n          \n          \n            \n                        + \"property, and instead the raw, non-transformed value will be used.\";\n          \n          \n            \n                        + \"/opt/connectors\\n\" \n          \n          \n            \n                        + \"Do not use config provider variables in this property, since the raw path is used \"\n          \n          \n            \n                        + \"by the worker's scanner before config providers are initialized and used to \"\n          \n          \n            \n                        + \"replace variables.\";", "url": "https://github.com/apache/kafka/pull/8455#discussion_r438512859", "createdAt": "2020-06-11T02:48:05Z", "author": {"login": "rhauch"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -205,7 +206,9 @@\n             + \"plugins and their dependencies\\n\"\n             + \"Note: symlinks will be followed to discover dependencies or plugins.\\n\"\n             + \"Examples: plugin.path=/usr/local/share/java,/usr/local/share/kafka/plugins,\"\n-            + \"/opt/connectors\";\n+            + \"/opt/connectors\\n\" \n+            + \"Warning: Config providers will not take effect if used for the value of this \" \n+            + \"property, and instead the raw, non-transformed value will be used.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d8af18e03e17361d430727a8b44e3f7a4077af4"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMzc0OA==", "bodyText": "How about:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"Config providers do not work with the plugin.path property. The raw value '{}' \" \n          \n          \n            \n                                + \"will be used for plugin scanning, as opposed to the transformed value '{}'. \" \n          \n          \n            \n                                + \"See https://issues.apache.org/jira/browse/KAFKA-9845 for more information.\",\n          \n          \n            \n                            \"Variables cannot be used in the 'plugin.path' property, since the property is \"\n          \n          \n            \n                            + \"used by plugin scanning before the config providers that replace the \" \n          \n          \n            \n                            + \"variables are initialized. The raw value '{}' was used for plugin scanning, as \" \n          \n          \n            \n                            + \"opposed to the transformed value '{}', and this may cause unexpected results.\",", "url": "https://github.com/apache/kafka/pull/8455#discussion_r438513748", "createdAt": "2020-06-11T02:51:47Z", "author": {"login": "rhauch"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -379,6 +382,22 @@ private void logDeprecatedProperty(String propName, String propValue, String def\n         }\n     }\n \n+    private void logPluginPathConfigProviderWarning(Map<String, String> rawOriginals) {\n+        String rawPluginPath = rawOriginals.get(PLUGIN_PATH_CONFIG);\n+        // Can't use AbstractConfig::originalsStrings here since some values may be null, which\n+        // causes that method to fail\n+        String transformedPluginPath = Objects.toString(originals().get(PLUGIN_PATH_CONFIG));\n+        if (!Objects.equals(rawPluginPath, transformedPluginPath)) {\n+            log.warn(\n+                \"Config providers do not work with the plugin.path property. The raw value '{}' \" \n+                    + \"will be used for plugin scanning, as opposed to the transformed value '{}'. \" \n+                    + \"See https://issues.apache.org/jira/browse/KAFKA-9845 for more information.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d8af18e03e17361d430727a8b44e3f7a4077af4"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccec713d0bbbd5c6ab85f76dcbfd2592c57c2158", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/ccec713d0bbbd5c6ab85f76dcbfd2592c57c2158", "committedDate": "2020-06-11T02:54:49Z", "message": "KAFKA-9845: Apply suggestions from code review\n\nCo-authored-by: Randall Hauch <rhauch@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1445, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}