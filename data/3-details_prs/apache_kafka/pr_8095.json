{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0MTMyMTAw", "number": 8095, "title": "MINOR: Fix unnecessary metadata fetch before group assignment", "bodyText": "I tracked the recent increase in the flakiness of one of the offset reset tests (KAFKA-9538) back to #7941. After investigation, I found that following this patch, the consumer was sending an additional metadata request prior to performing the group assignment. This slight timing difference was enough to trigger the test failures. The problem turned out to be due to a bug in SubscriptionState.groupSubscribe, which no longer counted the local subscription when determining if there were new topics to fetch metadata for. Hence the extra metadata update.\nWithout the fix, I saw 30-50% test failures locally. With it, I could no longer reproduce the failure. However, #6561 is probably still needed to improve the resilience of this test.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-02-12T06:30:10Z", "url": "https://github.com/apache/kafka/pull/8095", "merged": true, "mergeCommit": {"oid": "0a5dec0b3a3e1b027230ba766fee0c08b70cc63c"}, "closed": true, "closedAt": "2020-02-12T19:45:07Z", "author": {"login": "hachikuji"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDgUQ2gH2gAyMzc0MTMyMTAwOjQyNGIwOTYyYmJlYzllMWJjNjU2YjQ2N2M3YWVjNjk2NzZjZDg5NmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDpQf5gH2gAyMzc0MTMyMTAwOmY0YjFjMzcyNzg4YzZjOThlMGI5MzIzYjgyZjE5MmM4MGNlOWM3ZDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "424b0962bbec9e1bc656b467c7aec69676cd896f", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/424b0962bbec9e1bc656b467c7aec69676cd896f", "committedDate": "2020-02-12T06:26:57Z", "message": "MINOR: Fix unnecessary metadata fetch before group assignment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MzAzMzkx", "url": "https://github.com/apache/kafka/pull/8095#pullrequestreview-357303391", "createdAt": "2020-02-12T09:34:29Z", "commit": {"oid": "424b0962bbec9e1bc656b467c7aec69676cd896f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozNDoyOVrOFonaZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOTozNDoyOVrOFonaZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEzMzA5NA==", "bodyText": "We were accumulating topics earlier, but now we are replacing groupSubscription. I guess that is fine since we are passing in all the topics. May be worth updating the comment and also verifying that we are no longer accumulating in the unit test.", "url": "https://github.com/apache/kafka/pull/8095#discussion_r378133094", "createdAt": "2020-02-12T09:34:29Z", "author": {"login": "rajinisivaram"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/SubscriptionState.java", "diffHunk": "@@ -188,13 +188,15 @@ private boolean changeSubscription(Set<String> topicsToSubscribe) {\n     /**\n      * Add topics to the current group subscription. This is used by the group leader to ensure\n      * that it receives metadata updates for all topics that the group is interested in.\n+     *\n      * @param topics The topics to add to the group subscription\n+     * @return true if the group subscription contains topics which are not part of the local subscription\n      */\n     synchronized boolean groupSubscribe(Collection<String> topics) {\n         if (!hasAutoAssignedPartitions())\n             throw new IllegalStateException(SUBSCRIPTION_EXCEPTION_MESSAGE);\n-        groupSubscription = new HashSet<>(groupSubscription);\n-        return groupSubscription.addAll(topics);\n+        groupSubscription = new HashSet<>(topics);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "424b0962bbec9e1bc656b467c7aec69676cd896f"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4b1c372788c6c98e0b9323b82f192c80ce9c7d5", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/f4b1c372788c6c98e0b9323b82f192c80ce9c7d5", "committedDate": "2020-02-12T16:51:59Z", "message": "Make it clear `groupSubscribe` does not accumulate"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1859, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}