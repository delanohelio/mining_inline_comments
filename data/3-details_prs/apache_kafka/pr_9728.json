{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2MTAzNTUx", "number": 9728, "title": "MINOR: make sure all dir jobs are completed", "bodyText": "revert the change introduced by #9680 and add a unit test to verify\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-12-10T17:25:43Z", "url": "https://github.com/apache/kafka/pull/9728", "merged": true, "mergeCommit": {"oid": "b80cf9c240989b5c7c742ef7594411eb24a3cf9f"}, "closed": true, "closedAt": "2021-01-06T06:52:16Z", "author": {"login": "chia7712"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdk5DAhgFqTU0OTU1OTkxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtOFW4gFqTU2MTk3MTA5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NTU5OTEx", "url": "https://github.com/apache/kafka/pull/9728#pullrequestreview-549559911", "createdAt": "2020-12-10T20:06:22Z", "commit": {"oid": "26ec243bdea88799250de703256bef7cfe231034"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMDowNjoyMlrOIDbKZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMDowNjoyMlrOIDbKZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ2MTY3MA==", "bodyText": "The name makes this look generic, but it's not. The logging is very specific. I would change the name to be specific.", "url": "https://github.com/apache/kafka/pull/9728#discussion_r540461670", "createdAt": "2020-12-10T20:06:22Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/log/LogManager.scala", "diffHunk": "@@ -435,6 +436,20 @@ class LogManager(logDirs: Seq[File],\n       cleaner.startup()\n   }\n \n+  /**\n+   * wait all jobs to complete\n+   * @param jobs jobs\n+   * @return true if all pass. Otherwise, false\n+   */\n+  private[log] def allPass(jobs: Seq[Future[_]]): Boolean = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26ec243bdea88799250de703256bef7cfe231034"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NTc4ODQ4", "url": "https://github.com/apache/kafka/pull/9728#pullrequestreview-549578848", "createdAt": "2020-12-10T20:33:34Z", "commit": {"oid": "26ec243bdea88799250de703256bef7cfe231034"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMDozMzozNVrOIDcIKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMDozNDoyOFrOIDcKOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ3NzQ4MA==", "bodyText": "This refactoring is good.", "url": "https://github.com/apache/kafka/pull/9728#discussion_r540477480", "createdAt": "2020-12-10T20:33:35Z", "author": {"login": "kowshik"}, "path": "core/src/main/scala/kafka/log/LogManager.scala", "diffHunk": "@@ -478,17 +493,8 @@ class LogManager(logDirs: Seq[File],\n     }\n \n     try {\n-      for ((dir, dirJobs) <- jobs) {\n-        val hasErrors = dirJobs.exists  { future =>\n-          Try(future.get) match {\n-            case Success(_) => false\n-            case Failure(e) =>\n-              warn(s\"There was an error in one of the threads during LogManager shutdown: ${e.getCause}\")\n-              true\n-          }\n-        }\n-\n-        if (!hasErrors) {\n+      jobs.forKeyValue { (dir, dirJobs) =>\n+        if (allPass(dirJobs)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26ec243bdea88799250de703256bef7cfe231034"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ3ODAwOQ==", "bodyText": "This test may not still catch the bug introduced in #9680.\nWe can continue more discussion under this review comment in #9680: https://github.com/apache/kafka/pull/9680/files#r540476157.\nWe should still get this PR merged though, since it fixes the problem.\ncc @ijuma", "url": "https://github.com/apache/kafka/pull/9728#discussion_r540478009", "createdAt": "2020-12-10T20:34:28Z", "author": {"login": "kowshik"}, "path": "core/src/test/scala/unit/kafka/log/LogManagerTest.scala", "diffHunk": "@@ -680,4 +680,15 @@ class LogManagerTest {\n     time.sleep(logConfig.fileDeleteDelayMs + 1)\n     verifyMetrics(1)\n   }\n+\n+  @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26ec243bdea88799250de703256bef7cfe231034"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5Nzk2MzMy", "url": "https://github.com/apache/kafka/pull/9728#pullrequestreview-549796332", "createdAt": "2020-12-11T04:37:52Z", "commit": {"oid": "3d97a74fbbd6ee03cfdd8c5eb10d8aeadd46b95f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNTE4MjAz", "url": "https://github.com/apache/kafka/pull/9728#pullrequestreview-552518203", "createdAt": "2020-12-15T14:31:53Z", "commit": {"oid": "3d97a74fbbd6ee03cfdd8c5eb10d8aeadd46b95f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNDozMTo1NFrOIGOSAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNDozMTo1NFrOIGOSAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM5NjM1NQ==", "bodyText": "I would add a callback here for the failures and do the logging in the callback. That way you can keep the name generic.", "url": "https://github.com/apache/kafka/pull/9728#discussion_r543396355", "createdAt": "2020-12-15T14:31:54Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/log/LogManager.scala", "diffHunk": "@@ -435,6 +436,20 @@ class LogManager(logDirs: Seq[File],\n       cleaner.startup()\n   }\n \n+  /**\n+   * wait all jobs to complete\n+   * @param jobs jobs\n+   * @return true if all pass. Otherwise, false\n+   */\n+  private[log] def waitForAllToComplete(jobs: Seq[Future[_]]): Boolean = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d97a74fbbd6ee03cfdd8c5eb10d8aeadd46b95f"}, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d97a74fbbd6ee03cfdd8c5eb10d8aeadd46b95f", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/3d97a74fbbd6ee03cfdd8c5eb10d8aeadd46b95f", "committedDate": "2020-12-10T21:07:51Z", "message": "rename and add more tests"}, "afterCommit": {"oid": "65f983cea0014373c37ccd7cae70f7d41f18df69", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/65f983cea0014373c37ccd7cae70f7d41f18df69", "committedDate": "2020-12-15T14:43:43Z", "message": "move LogManagerTest to companion object and add callback to it"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxOTMwMzEx", "url": "https://github.com/apache/kafka/pull/9728#pullrequestreview-561930311", "createdAt": "2021-01-05T16:18:49Z", "commit": {"oid": "65f983cea0014373c37ccd7cae70f7d41f18df69"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxNjoxODo0OVrOIOdsKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxNjoyMTo0OVrOIOdztg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjAzNzQxNw==", "bodyText": "We should mention that this will be called for each future that throws an exception.", "url": "https://github.com/apache/kafka/pull/9728#discussion_r552037417", "createdAt": "2021-01-05T16:18:49Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/log/LogManager.scala", "diffHunk": "@@ -1167,6 +1160,21 @@ class LogManager(logDirs: Seq[File],\n \n object LogManager {\n \n+  /**\n+   * wait all jobs to complete\n+   * @param jobs jobs\n+   * @param callback handle the exception caused by Future#get", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65f983cea0014373c37ccd7cae70f7d41f18df69"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjAzNzUwOQ==", "bodyText": "Nit: start with capital?", "url": "https://github.com/apache/kafka/pull/9728#discussion_r552037509", "createdAt": "2021-01-05T16:18:58Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/log/LogManager.scala", "diffHunk": "@@ -1167,6 +1160,21 @@ class LogManager(logDirs: Seq[File],\n \n object LogManager {\n \n+  /**\n+   * wait all jobs to complete", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65f983cea0014373c37ccd7cae70f7d41f18df69"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjAzOTM1MA==", "bodyText": "Should we not return true in this answer?", "url": "https://github.com/apache/kafka/pull/9728#discussion_r552039350", "createdAt": "2021-01-05T16:21:49Z", "author": {"login": "ijuma"}, "path": "core/src/test/scala/unit/kafka/log/LogManagerTest.scala", "diffHunk": "@@ -680,4 +681,31 @@ class LogManagerTest {\n     time.sleep(logConfig.fileDeleteDelayMs + 1)\n     verifyMetrics(1)\n   }\n+\n+  @Test\n+  def testWaitForAllToComplete(): Unit = {\n+    var invokedCount = 0\n+    val success: Future[Boolean] = Mockito.mock(classOf[Future[Boolean]])\n+    Mockito.when(success.get()).thenAnswer(_ => invokedCount += 1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65f983cea0014373c37ccd7cae70f7d41f18df69"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cb6d892ba183cf2f727df37f44be2d5eeba3bd5", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/1cb6d892ba183cf2f727df37f44be2d5eeba3bd5", "committedDate": "2021-01-05T16:24:33Z", "message": "MINOR: make sure all dir jobs are completed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe6ef2750fdd79b8a542ddb9bfc559bb69b2ed5f", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/fe6ef2750fdd79b8a542ddb9bfc559bb69b2ed5f", "committedDate": "2021-01-05T16:24:33Z", "message": "rename and add more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "969e8d2b862b694dd5f5c362492d33027c670bbe", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/969e8d2b862b694dd5f5c362492d33027c670bbe", "committedDate": "2021-01-05T16:24:33Z", "message": "move LogManagerTest to companion object and add callback to it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7dc8ca698f79cb70103497a57eb1ed4fc9634fc", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/d7dc8ca698f79cb70103497a57eb1ed4fc9634fc", "committedDate": "2021-01-05T16:40:06Z", "message": "tweak comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "65f983cea0014373c37ccd7cae70f7d41f18df69", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/65f983cea0014373c37ccd7cae70f7d41f18df69", "committedDate": "2020-12-15T14:43:43Z", "message": "move LogManagerTest to companion object and add callback to it"}, "afterCommit": {"oid": "d7dc8ca698f79cb70103497a57eb1ed4fc9634fc", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/d7dc8ca698f79cb70103497a57eb1ed4fc9634fc", "committedDate": "2021-01-05T16:40:06Z", "message": "tweak comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxOTcxMDk3", "url": "https://github.com/apache/kafka/pull/9728#pullrequestreview-561971097", "createdAt": "2021-01-05T17:08:21Z", "commit": {"oid": "d7dc8ca698f79cb70103497a57eb1ed4fc9634fc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2227, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}