{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MTM4NTI5", "number": 8979, "title": "KAFKA-10223; Use NOT_LEADER_OR_FOLLOWER instead of non-retriable REPLICA_NOT_AVAILABLE for consumers", "bodyText": "Brokers currently return NOT_LEADER_FOR_PARTITION to producers and REPLICA_NOT_AVAILABLE to consumers if a replica is not available on the broker during reassignments. Non-Java clients treat REPLICA_NOT_AVAILABLE as a non-retriable exception, Java consumers handle this error by explicitly matching the error code even though it is not an InvalidMetadataException. This PR renames NOT_LEADER_FOR_PARTITION to NOT_LEADER_OR_FOLLOWER and uses the same error for producers and consumers. This is compatible with both Java and non-Java clients since all clients handle this error code (6) as retriable exception. The PR also makes ReplicaNotAvailableException a subclass of InvalidMetadataException.\n\nALTER_REPLICA_LOG_DIRS continues to return REPLICA_NOT_AVAILABLE. Retained this for compatibility since this request never returned NOT_LEADER_FOR_PARTITION earlier.  Did not  deprecate ReplicaNotAvailableException because of this.\nMetadataRequest  version 0 also returns REPLICA_NOT_AVAILABLE for compatibility. Newer versions filter these out and\nreturn Errors.NONE, so didn't change this.\nPartition responses in MetadataRequest return REPLICA_NOT_AVAILABLE to indicate that one of the replicas is not available. Did not change this since NOT_LEADER_FOR_PARTITION is not suitable in this case.\n\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-07-03T16:56:35Z", "url": "https://github.com/apache/kafka/pull/8979", "merged": true, "mergeCommit": {"oid": "9c8f75c4b624084c954b4da69f092211a9ac4689"}, "closed": true, "closedAt": "2020-07-17T19:05:12Z", "author": {"login": "rajinisivaram"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczgZsngBqjM1MzMxNjk3Nzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc10_-0gFqTQ1MDcyMjE0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NjQ5Mzkw", "url": "https://github.com/apache/kafka/pull/8979#pullrequestreview-447649390", "createdAt": "2020-07-13T22:18:34Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMjoxODozNFrOGw8alw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMjoxOTo1NVrOGw8duw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk3NDY3OQ==", "bodyText": "Can we remove this now?", "url": "https://github.com/apache/kafka/pull/8979#discussion_r453974679", "createdAt": "2020-07-13T22:18:34Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/server/DelayedFetch.scala", "diffHunk": "@@ -121,8 +120,8 @@ class DelayedFetch(delayMs: Long,\n             }\n           }\n         } catch {\n-          case _: NotLeaderForPartitionException =>  // Case A\n-            debug(s\"Broker is no longer the leader of $topicPartition, satisfy $fetchMetadata immediately\")\n+          case _: NotLeaderOrFollowerException =>  // Case A\n+            debug(s\"Broker is no longer the leader or follower of $topicPartition, satisfy $fetchMetadata immediately\")\n             return forceComplete()\n           case _: ReplicaNotAvailableException =>  // Case B", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk3NTQ4Mw==", "bodyText": "Would we want to change this for new IBPs?", "url": "https://github.com/apache/kafka/pull/8979#discussion_r453975483", "createdAt": "2020-07-13T22:19:55Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "diffHunk": "@@ -716,8 +712,12 @@ class ReplicaManager(val config: KafkaConfig,\n                   _: LogDirNotFoundException |\n                   _: ReplicaNotAvailableException |\n                   _: KafkaStorageException) =>\n-            warn(\"Unable to alter log dirs for %s\".format(topicPartition), e)\n+            warn(s\"Unable to alter log dirs for $topicPartition\", e)\n             (topicPartition, Errors.forException(e))\n+          case e: NotLeaderOrFollowerException =>\n+            // Retaining REPLICA_NOT_AVAILABLE exception for ALTER_REPLICA_LOG_DIRS for compatibility\n+            warn(s\"Unable to alter log dirs for $topicPartition\", e)\n+            (topicPartition, Errors.REPLICA_NOT_AVAILABLE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "116b7b034a99c759d12ed1f2526fd79e8ebc1fa1", "author": {"user": {"login": "rajinisivaram", "name": "Rajini Sivaram"}}, "url": "https://github.com/apache/kafka/commit/116b7b034a99c759d12ed1f2526fd79e8ebc1fa1", "committedDate": "2020-07-14T12:36:38Z", "message": "KAFKA-10223; Replace REPLICA_NOT_AVAILABLE with NOT_LEADER_OR_FOLLOWER"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bcda5eb1adb331246de81fdb225540b990f557a", "author": {"user": {"login": "rajinisivaram", "name": "Rajini Sivaram"}}, "url": "https://github.com/apache/kafka/commit/8bcda5eb1adb331246de81fdb225540b990f557a", "committedDate": "2020-07-14T12:41:08Z", "message": "Address review comments, remove some more usages of ReplicaNotAvailable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "8bcda5eb1adb331246de81fdb225540b990f557a", "author": {"user": {"login": "rajinisivaram", "name": "Rajini Sivaram"}}, "url": "https://github.com/apache/kafka/commit/8bcda5eb1adb331246de81fdb225540b990f557a", "committedDate": "2020-07-14T12:41:08Z", "message": "Address review comments, remove some more usages of ReplicaNotAvailable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NDAwNTEz", "url": "https://github.com/apache/kafka/pull/8979#pullrequestreview-449400513", "createdAt": "2020-07-15T23:02:32Z", "commit": {"oid": "8bcda5eb1adb331246de81fdb225540b990f557a"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMzowMjozMlrOGyUPFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMzoyMDoxOVrOGyUmZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMzUyNw==", "bodyText": "One nitpick on the naming. It seems a little strange that followers might return NOT_LEADER_OR_FOLLOWER for requests which are intended for the leader. I think my suggestion to frame the name around the broker not being the intended target of the request was a little more accurate, though I admit the name was clumsier. Perhaps this class would be a good place to document the semantics? Maybe worth mentioning the Produce/Fetch behavior explicitly.", "url": "https://github.com/apache/kafka/pull/8979#discussion_r455413527", "createdAt": "2020-07-15T23:02:32Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/common/errors/NotLeaderOrFollowerException.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.errors;\n+\n+/**\n+ * This server is not the leader or follower for the given partition.\n+ * This could a transient exception during reassignments.\n+ */\n+@SuppressWarnings(\"deprecation\")\n+public class NotLeaderOrFollowerException extends NotLeaderForPartitionException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bcda5eb1adb331246de81fdb225540b990f557a"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxNDU2Mg==", "bodyText": "This would also be a good place to be clearer about the interpretation of this error. Maybe something like this?\n\nFor requests intended only for the leader, this error indicates that the broker is not the current leader. For requests intended for any replica, this error indicates that the broker is not a replica of the topic partition.", "url": "https://github.com/apache/kafka/pull/8979#discussion_r455414562", "createdAt": "2020-07-15T23:05:25Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/common/protocol/Errors.java", "diffHunk": "@@ -139,8 +139,8 @@\n             InvalidFetchSizeException::new),\n     LEADER_NOT_AVAILABLE(5, \"There is no leader for this topic-partition as we are in the middle of a leadership election.\",\n             LeaderNotAvailableException::new),\n-    NOT_LEADER_FOR_PARTITION(6, \"This server is not the leader for that topic-partition.\",\n-            NotLeaderForPartitionException::new),\n+    NOT_LEADER_OR_FOLLOWER(6, \"This server is not the leader or follower for that topic-partition.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bcda5eb1adb331246de81fdb225540b990f557a"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxNjUzNg==", "bodyText": "Is it worth adding a note about the use of REPLICA_NOT_AVAILABLE below? I think we are effectively deprecating its usage in this PR.", "url": "https://github.com/apache/kafka/pull/8979#discussion_r455416536", "createdAt": "2020-07-15T23:11:19Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/common/protocol/Errors.java", "diffHunk": "@@ -139,8 +139,8 @@\n             InvalidFetchSizeException::new),\n     LEADER_NOT_AVAILABLE(5, \"There is no leader for this topic-partition as we are in the middle of a leadership election.\",\n             LeaderNotAvailableException::new),\n-    NOT_LEADER_FOR_PARTITION(6, \"This server is not the leader for that topic-partition.\",\n-            NotLeaderForPartitionException::new),\n+    NOT_LEADER_OR_FOLLOWER(6, \"This server is not the leader or follower for that topic-partition.\",\n+            NotLeaderOrFollowerException::new),\n     REQUEST_TIMED_OUT(7, \"The request timed out.\",\n             TimeoutException::new),\n     BROKER_NOT_AVAILABLE(8, \"The broker is not available.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bcda5eb1adb331246de81fdb225540b990f557a"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxOTQ5NQ==", "bodyText": "Hmm.. Wouldn't it make more sense to tie this to a version bump to this protocol rather than the IBP?", "url": "https://github.com/apache/kafka/pull/8979#discussion_r455419495", "createdAt": "2020-07-15T23:20:19Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "diffHunk": "@@ -712,10 +708,13 @@ class ReplicaManager(val config: KafkaConfig,\n         } catch {\n           case e@(_: InvalidTopicException |\n                   _: LogDirNotFoundException |\n-                  _: ReplicaNotAvailableException |\n                   _: KafkaStorageException) =>\n-            warn(\"Unable to alter log dirs for %s\".format(topicPartition), e)\n+            warn(s\"Unable to alter log dirs for $topicPartition\", e)\n             (topicPartition, Errors.forException(e))\n+          case e: NotLeaderOrFollowerException =>\n+            warn(s\"Unable to alter log dirs for $topicPartition\", e)\n+            // Retaining REPLICA_NOT_AVAILABLE exception for ALTER_REPLICA_LOG_DIRS for older versions for compatibility\n+            (topicPartition, if (config.interBrokerProtocolVersion >= KAFKA_2_7_IV0) Errors.NOT_LEADER_OR_FOLLOWER else Errors.REPLICA_NOT_AVAILABLE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bcda5eb1adb331246de81fdb225540b990f557a"}, "originalPosition": 102}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eedd6e2731946f414fb20c667733153849efa854", "author": {"user": {"login": "rajinisivaram", "name": "Rajini Sivaram"}}, "url": "https://github.com/apache/kafka/commit/eedd6e2731946f414fb20c667733153849efa854", "committedDate": "2020-07-16T09:12:28Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMTMyMDcx", "url": "https://github.com/apache/kafka/pull/8979#pullrequestreview-450132071", "createdAt": "2020-07-16T19:04:21Z", "commit": {"oid": "eedd6e2731946f414fb20c667733153849efa854"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxOTowNDoyMVrOGy4iog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxOTowNDoyMVrOGy4iog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAwODM1NA==", "bodyText": "Is the note about the range from 2.4 to 2.6 correct? I think this error has always been possible in the case of a reassignment.", "url": "https://github.com/apache/kafka/pull/8979#discussion_r456008354", "createdAt": "2020-07-16T19:04:21Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/common/requests/FetchResponse.java", "diffHunk": "@@ -58,8 +58,8 @@\n  *\n  * - {@link Errors#OFFSET_OUT_OF_RANGE} If the fetch offset is out of range for a requested partition\n  * - {@link Errors#TOPIC_AUTHORIZATION_FAILED} If the user does not have READ access to a requested topic\n- * - {@link Errors#REPLICA_NOT_AVAILABLE} If the request is received by a broker which is not a replica\n- * - {@link Errors#NOT_LEADER_FOR_PARTITION} If the broker is not a leader and either the provided leader epoch\n+ * - {@link Errors#REPLICA_NOT_AVAILABLE} If the request is received by a broker with version 2.4 to 2.6 which is not a replica", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eedd6e2731946f414fb20c667733153849efa854"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMjExOTAw", "url": "https://github.com/apache/kafka/pull/8979#pullrequestreview-450211900", "createdAt": "2020-07-16T20:59:13Z", "commit": {"oid": "eedd6e2731946f414fb20c667733153849efa854"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQyMDo1OToxM1rOGy8kcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQyMDo1OToxM1rOGy8kcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA3NDM1NQ==", "bodyText": "@hachikuji @rajinisivaram Since this is still used outside of produce/fetch, maybe the backwards compatibility message needs to be qualified?", "url": "https://github.com/apache/kafka/pull/8979#discussion_r456074355", "createdAt": "2020-07-16T20:59:13Z", "author": {"login": "ijuma"}, "path": "clients/src/main/java/org/apache/kafka/common/protocol/Errors.java", "diffHunk": "@@ -139,13 +139,15 @@\n             InvalidFetchSizeException::new),\n     LEADER_NOT_AVAILABLE(5, \"There is no leader for this topic-partition as we are in the middle of a leadership election.\",\n             LeaderNotAvailableException::new),\n-    NOT_LEADER_FOR_PARTITION(6, \"This server is not the leader for that topic-partition.\",\n-            NotLeaderForPartitionException::new),\n+    NOT_LEADER_OR_FOLLOWER(6, \"For requests intended only for the leader, this error indicates that the broker is not the current leader. \" +\n+            \"For requests intended for any replica, this error indicates that the broker is not a replica of the topic partition.\",\n+            NotLeaderOrFollowerException::new),\n     REQUEST_TIMED_OUT(7, \"The request timed out.\",\n             TimeoutException::new),\n     BROKER_NOT_AVAILABLE(8, \"The broker is not available.\",\n             BrokerNotAvailableException::new),\n-    REPLICA_NOT_AVAILABLE(9, \"The replica is not available for the requested topic-partition.\",\n+    REPLICA_NOT_AVAILABLE(9, \"The replica is not available for the requested topic-partition. This is used for backward compatibility for \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eedd6e2731946f414fb20c667733153849efa854"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzA4ODI2", "url": "https://github.com/apache/kafka/pull/8979#pullrequestreview-450308826", "createdAt": "2020-07-17T00:57:48Z", "commit": {"oid": "eedd6e2731946f414fb20c667733153849efa854"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "991b61d764d3ea11feebe2977890fefed9bfa8b9", "author": {"user": {"login": "rajinisivaram", "name": "Rajini Sivaram"}}, "url": "https://github.com/apache/kafka/commit/991b61d764d3ea11feebe2977890fefed9bfa8b9", "committedDate": "2020-07-17T10:20:02Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNjU4Nzgy", "url": "https://github.com/apache/kafka/pull/8979#pullrequestreview-450658782", "createdAt": "2020-07-17T13:31:14Z", "commit": {"oid": "991b61d764d3ea11feebe2977890fefed9bfa8b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMzozMToxNFrOGzTGZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMzozMToxNFrOGzTGZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0MzQ5NQ==", "bodyText": "Should it be leader or follower her and in the ReplicaNotAvailable message?", "url": "https://github.com/apache/kafka/pull/8979#discussion_r456443495", "createdAt": "2020-07-17T13:31:14Z", "author": {"login": "ijuma"}, "path": "clients/src/main/java/org/apache/kafka/common/errors/ReplicaNotAvailableException.java", "diffHunk": "@@ -16,7 +16,13 @@\n  */\n package org.apache.kafka.common.errors;\n \n-public class ReplicaNotAvailableException extends ApiException {\n+/**\n+ * The replica is not available for the requested topic partition. This may be\n+ * a transient exception during reassignments. From version 2.6 onwards, Fetch requests\n+ * and other requests intended only for the leader of the topic partition return", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "991b61d764d3ea11feebe2977890fefed9bfa8b9"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65d4f62be75ad44bb14910b178e073d56b5ea586", "author": {"user": {"login": "rajinisivaram", "name": "Rajini Sivaram"}}, "url": "https://github.com/apache/kafka/commit/65d4f62be75ad44bb14910b178e073d56b5ea586", "committedDate": "2020-07-17T14:14:01Z", "message": "Address review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNzIyMTQ4", "url": "https://github.com/apache/kafka/pull/8979#pullrequestreview-450722148", "createdAt": "2020-07-17T14:49:01Z", "commit": {"oid": "65d4f62be75ad44bb14910b178e073d56b5ea586"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1159, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}