{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMjkzMjc0", "number": 8618, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNjozNjo1NVrOD5fDjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwMTozODozN1rOD6Dqtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNjA0MjM3OnYy", "diffSide": "RIGHT", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/WorkerSinkTaskTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNjozNjo1NVrOGQx6jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNjozNjo1NVrOGQx6jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI0ODIwNQ==", "bodyText": "If we're going to refer to this later while making assertions, a more descriptive name might help readability. Something like putFailure here and closeFailure below, maybe?", "url": "https://github.com/apache/kafka/pull/8618#discussion_r420248205", "createdAt": "2020-05-05T16:36:55Z", "author": {"login": "C0urante"}, "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/WorkerSinkTaskTest.java", "diffHunk": "@@ -856,6 +857,49 @@ public void run() {\n         PowerMock.verifyAll();\n     }\n \n+    @Test\n+    public void testSinkTasksHandleCloseErrors() throws Exception {\n+        createTask(initialState);\n+        expectInitializeTask();\n+        expectTaskGetTopic(true);\n+\n+        // Put one message through the task to get some offsets to commit\n+        expectConsumerPoll(1);\n+        expectConversionAndTransformation(1);\n+        sinkTask.put(EasyMock.anyObject());\n+        PowerMock.expectLastCall().andVoid();\n+\n+        // Throw an exception on the next put to trigger shutdown behavior\n+        // This exception is the true \"cause\" of the failure\n+        expectConsumerPoll(1);\n+        expectConversionAndTransformation(1);\n+        Throwable a = new RuntimeException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b12f65a3c929207ca61deca4946fe9fbd942f7e1"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNjA3MzU3OnYy", "diffSide": "RIGHT", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/WorkerSinkTaskTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNjo0NDo1M1rOGQyOkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNjo0NDo1M1rOGQyOkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI1MzMyOA==", "bodyText": "The call to fail() above is going to get caught here, isn't it? Think that might make this difficult to debug if a future change causes this to fail for some reason.\nBased on the deliverMessages method where SinkTask::put is invoked, it looks like we might be able to narrow this down to a ConnectException.", "url": "https://github.com/apache/kafka/pull/8618#discussion_r420253328", "createdAt": "2020-05-05T16:44:53Z", "author": {"login": "C0urante"}, "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/WorkerSinkTaskTest.java", "diffHunk": "@@ -856,6 +857,49 @@ public void run() {\n         PowerMock.verifyAll();\n     }\n \n+    @Test\n+    public void testSinkTasksHandleCloseErrors() throws Exception {\n+        createTask(initialState);\n+        expectInitializeTask();\n+        expectTaskGetTopic(true);\n+\n+        // Put one message through the task to get some offsets to commit\n+        expectConsumerPoll(1);\n+        expectConversionAndTransformation(1);\n+        sinkTask.put(EasyMock.anyObject());\n+        PowerMock.expectLastCall().andVoid();\n+\n+        // Throw an exception on the next put to trigger shutdown behavior\n+        // This exception is the true \"cause\" of the failure\n+        expectConsumerPoll(1);\n+        expectConversionAndTransformation(1);\n+        Throwable a = new RuntimeException();\n+        sinkTask.put(EasyMock.anyObject());\n+        PowerMock.expectLastCall().andThrow(a);\n+\n+        // Throw another exception while closing the task's assignment\n+        EasyMock.expect(sinkTask.preCommit(EasyMock.anyObject()))\n+            .andStubReturn(Collections.emptyMap());\n+        Throwable b = new RuntimeException();\n+        sinkTask.close(EasyMock.anyObject());\n+        PowerMock.expectLastCall().andThrow(b);\n+\n+        PowerMock.replayAll();\n+\n+        workerTask.initialize(TASK_CONFIG);\n+        try {\n+            workerTask.execute();\n+            fail();\n+        } catch (Throwable t) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b12f65a3c929207ca61deca4946fe9fbd942f7e1"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNjA4NDk5OnYy", "diffSide": "RIGHT", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/WorkerSinkTaskTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNjo0Nzo1N1rOGQyV1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNjo0Nzo1N1rOGQyV1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI1NTE5MQ==", "bodyText": "Might be better to use this text as the message for the assertions instead of putting it here as a comment?", "url": "https://github.com/apache/kafka/pull/8618#discussion_r420255191", "createdAt": "2020-05-05T16:47:57Z", "author": {"login": "C0urante"}, "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/WorkerSinkTaskTest.java", "diffHunk": "@@ -856,6 +857,49 @@ public void run() {\n         PowerMock.verifyAll();\n     }\n \n+    @Test\n+    public void testSinkTasksHandleCloseErrors() throws Exception {\n+        createTask(initialState);\n+        expectInitializeTask();\n+        expectTaskGetTopic(true);\n+\n+        // Put one message through the task to get some offsets to commit\n+        expectConsumerPoll(1);\n+        expectConversionAndTransformation(1);\n+        sinkTask.put(EasyMock.anyObject());\n+        PowerMock.expectLastCall().andVoid();\n+\n+        // Throw an exception on the next put to trigger shutdown behavior\n+        // This exception is the true \"cause\" of the failure\n+        expectConsumerPoll(1);\n+        expectConversionAndTransformation(1);\n+        Throwable a = new RuntimeException();\n+        sinkTask.put(EasyMock.anyObject());\n+        PowerMock.expectLastCall().andThrow(a);\n+\n+        // Throw another exception while closing the task's assignment\n+        EasyMock.expect(sinkTask.preCommit(EasyMock.anyObject()))\n+            .andStubReturn(Collections.emptyMap());\n+        Throwable b = new RuntimeException();\n+        sinkTask.close(EasyMock.anyObject());\n+        PowerMock.expectLastCall().andThrow(b);\n+\n+        PowerMock.replayAll();\n+\n+        workerTask.initialize(TASK_CONFIG);\n+        try {\n+            workerTask.execute();\n+            fail();\n+        } catch (Throwable t) {\n+            PowerMock.verifyAll();\n+            // The exception from close should not shadow the exception from put.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b12f65a3c929207ca61deca4946fe9fbd942f7e1"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNjI5MjU3OnYy", "diffSide": "RIGHT", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSinkTask.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNzozODoyNVrOGQ0ZVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNzowNTo1NlrOGRcydw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI4ODg1Mw==", "bodyText": "I am not sure I understand how the suppressed exception is logged and not just silently swallowed? Do we need to call  getSuppressed and log those somewhere or use one of those closeQuietly methods on Utils?", "url": "https://github.com/apache/kafka/pull/8618#discussion_r420288853", "createdAt": "2020-05-05T17:38:25Z", "author": {"login": "ncliang"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSinkTask.java", "diffHunk": "@@ -193,13 +194,11 @@ public void transitionTo(TargetState state) {\n     @Override\n     public void execute() {\n         initializeAndStart();\n-        try {\n+        // Make sure any uncommitted data has been committed and the task has\n+        // a chance to clean up its state\n+        try (QuietClosable ignored = this::closePartitions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4deafc55e3ba2330690949e8ed78c7cdc1f0ef6"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI5ODA4MQ==", "bodyText": "This PR is not changing any of the printing logic, and that's still handled by the caller, WorkerTask::doRun. This is roughly what a suppressed exception looks like when it gets logged (from the test setup, not a live connector):\norg.apache.kafka.connect.errors.ConnectException: Exiting WorkerSinkTask due to unrecoverable exception.\n\tat org.apache.kafka.connect.runtime.WorkerSinkTask.deliverMessages(WorkerSinkTask.java:569)\n\tat org.apache.kafka.connect.runtime.WorkerSinkTask.poll(WorkerSinkTask.java:327)\n\tat org.apache.kafka.connect.runtime.WorkerSinkTask.iteration(WorkerSinkTask.java:229)\n\tat org.apache.kafka.connect.runtime.WorkerSinkTask.execute(WorkerSinkTask.java:201)\n\t<snipped>\n\tSuppressed: java.lang.RuntimeException\n\t\tat org.easymock.internal.MockInvocationHandler.invoke(MockInvocationHandler.java:46)\n\t\tat org.easymock.internal.ObjectMethodsFilter.invoke(ObjectMethodsFilter.java:101)\n\t\tat org.easymock.internal.ClassProxyFactory$MockMethodInterceptor.intercept(ClassProxyFactory.java:97)\n\t\tat org.apache.kafka.connect.sink.SinkTask$$EnhancerByCGLIB$$713f645b.close(&lt;generated&gt;)\n\t\tat org.apache.kafka.connect.runtime.WorkerSinkTask.commitOffsets(WorkerSinkTask.java:402)\n\t\tat org.apache.kafka.connect.runtime.WorkerSinkTask.closePartitions(WorkerSinkTask.java:599)\n\t\tat org.apache.kafka.connect.runtime.WorkerSinkTask.execute(WorkerSinkTask.java:202)\n\t\t... 57 more\nCaused by: java.lang.RuntimeException\n\tat org.easymock.internal.MockInvocationHandler.invoke(MockInvocationHandler.java:46)\n\tat org.easymock.internal.ObjectMethodsFilter.invoke(ObjectMethodsFilter.java:101)\n\tat org.easymock.internal.ClassProxyFactory$MockMethodInterceptor.intercept(ClassProxyFactory.java:68)\n\tat org.apache.kafka.connect.sink.SinkTask$$EnhancerByCGLIB$$713f645b.put(&lt;generated&gt;)\n\tat org.apache.kafka.connect.runtime.WorkerSinkTask.deliverMessages(WorkerSinkTask.java:547)\n\t... 60 more\n\nSuppressed exceptions are a native Java feature, and log4j supports printing their stacktraces.", "url": "https://github.com/apache/kafka/pull/8618#discussion_r420298081", "createdAt": "2020-05-05T17:53:18Z", "author": {"login": "gharris1727"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSinkTask.java", "diffHunk": "@@ -193,13 +194,11 @@ public void transitionTo(TargetState state) {\n     @Override\n     public void execute() {\n         initializeAndStart();\n-        try {\n+        // Make sure any uncommitted data has been committed and the task has\n+        // a chance to clean up its state\n+        try (QuietClosable ignored = this::closePartitions) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI4ODg1Mw=="}, "originalCommit": {"oid": "a4deafc55e3ba2330690949e8ed78c7cdc1f0ef6"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg5NTc0Mg==", "bodyText": "Again naming here can be misleading. ignored is more like unused in the try block.\nBut also that's not the point of this idiom. It's about suppressing exceptions from finally instead of the originator.\nHow about suppressible? Also, unused might be even better, because ignored is untrue especially if closePartitions is the only method that throws. But I think suppressible highlights the intentions here specifically.", "url": "https://github.com/apache/kafka/pull/8618#discussion_r420895742", "createdAt": "2020-05-06T15:45:16Z", "author": {"login": "kkonstantine"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSinkTask.java", "diffHunk": "@@ -193,13 +194,11 @@ public void transitionTo(TargetState state) {\n     @Override\n     public void execute() {\n         initializeAndStart();\n-        try {\n+        // Make sure any uncommitted data has been committed and the task has\n+        // a chance to clean up its state\n+        try (QuietClosable ignored = this::closePartitions) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI4ODg1Mw=="}, "originalCommit": {"oid": "a4deafc55e3ba2330690949e8ed78c7cdc1f0ef6"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk1MDY0Nw==", "bodyText": "I used ignored as a way to trigger the IDE to avoid highlighting the unused variable.\nI can change this to suppressible since the behavior is better described (suppressible \"if another exception occurs first\").", "url": "https://github.com/apache/kafka/pull/8618#discussion_r420950647", "createdAt": "2020-05-06T17:05:56Z", "author": {"login": "gharris1727"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSinkTask.java", "diffHunk": "@@ -193,13 +194,11 @@ public void transitionTo(TargetState state) {\n     @Override\n     public void execute() {\n         initializeAndStart();\n-        try {\n+        // Make sure any uncommitted data has been committed and the task has\n+        // a chance to clean up its state\n+        try (QuietClosable ignored = this::closePartitions) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI4ODg1Mw=="}, "originalCommit": {"oid": "a4deafc55e3ba2330690949e8ed78c7cdc1f0ef6"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMDEzMjY3OnYy", "diffSide": "RIGHT", "path": "clients/src/main/java/org/apache/kafka/common/utils/Utils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTozNjo0NlrOGRZELQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTozNjo0NlrOGRZELQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg4OTY0NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public interface QuietClosable extends AutoCloseable {\n          \n          \n            \n                public interface QuietClosable extends AutoCloseable {\n          \n      \n    \n    \n  \n\nI don't think the name is very accurate. The interface does not prevent implementation of close from throwing (as opposed to the methods below) and its demonstrated use does not either. (there's also a typo, if typos in non-words matter).\nHow about UncheckedCloseable?", "url": "https://github.com/apache/kafka/pull/8618#discussion_r420889645", "createdAt": "2020-05-06T15:36:46Z", "author": {"login": "kkonstantine"}, "path": "clients/src/main/java/org/apache/kafka/common/utils/Utils.java", "diffHunk": "@@ -885,6 +885,18 @@ public static void closeAll(Closeable... closeables) throws IOException {\n             throw exception;\n     }\n \n+    /**\n+     * An {@link AutoCloseable} interface without a throws clause in the signature\n+     *\n+     * This is used with lambda expressions in try-with-resources clauses\n+     * to avoid casting un-checked exceptions to checked exceptions unnecessarily.\n+     */\n+    @FunctionalInterface\n+    public interface QuietClosable extends AutoCloseable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4deafc55e3ba2330690949e8ed78c7cdc1f0ef6"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMDE5MDk3OnYy", "diffSide": "RIGHT", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/WorkerSinkTaskTest.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTo1MDoyOVrOGRZqQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwMTozNTowOFrOGRrSPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg5OTM5Mw==", "bodyText": "Can you also write a test where an exception is thrown only by sinkTask.close? Actually, we could keep the name for this new test here as is, and the new test could be named in a way that tells us that the exceptions on close are suppressed in the presence of exceptions in the main try block.", "url": "https://github.com/apache/kafka/pull/8618#discussion_r420899393", "createdAt": "2020-05-06T15:50:29Z", "author": {"login": "kkonstantine"}, "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/WorkerSinkTaskTest.java", "diffHunk": "@@ -856,6 +858,47 @@ public void run() {\n         PowerMock.verifyAll();\n     }\n \n+    @Test\n+    public void testSinkTasksHandleCloseErrors() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4deafc55e3ba2330690949e8ed78c7cdc1f0ef6"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5ODM2OQ==", "bodyText": "Ive written the test as described, and verified that the exception from close is caught by WorkerTask::doRun.\nHowever, it never gets wrapped in a ConnectException like exceptions from the other connector methods, but i'm not sure that it's in-scope to change this in this PR.", "url": "https://github.com/apache/kafka/pull/8618#discussion_r420998369", "createdAt": "2020-05-06T18:20:47Z", "author": {"login": "gharris1727"}, "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/WorkerSinkTaskTest.java", "diffHunk": "@@ -856,6 +858,47 @@ public void run() {\n         PowerMock.verifyAll();\n     }\n \n+    @Test\n+    public void testSinkTasksHandleCloseErrors() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg5OTM5Mw=="}, "originalCommit": {"oid": "a4deafc55e3ba2330690949e8ed78c7cdc1f0ef6"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAwNTE1Ng==", "bodyText": "Let me see if I understand what you are describing as wrapped.\nMy use case is as follows:\nSinkTask#close attempts to release resources and if it fails it throws a ConnectException as we'd expect from connector developers to do (currently it throws a RuntimeException which might be less representative).\nWith your fix this exception can appear as suppressed when an exception happens in SinkTask#put and that's what your test is guarding against.\nMy point is to add the missing test case for when the exception on close is the only exception that is thrown. There is a variety of ways to do that, but I agree with you, this test is not there now. However, I don't think this necessarily makes it out of scope.", "url": "https://github.com/apache/kafka/pull/8618#discussion_r421005156", "createdAt": "2020-05-06T18:32:13Z", "author": {"login": "kkonstantine"}, "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/WorkerSinkTaskTest.java", "diffHunk": "@@ -856,6 +858,47 @@ public void run() {\n         PowerMock.verifyAll();\n     }\n \n+    @Test\n+    public void testSinkTasksHandleCloseErrors() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg5OTM5Mw=="}, "originalCommit": {"oid": "a4deafc55e3ba2330690949e8ed78c7cdc1f0ef6"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAwOTQ5MQ==", "bodyText": "I added that test, so please look at the diff.\nBy wrapping, i'm completely disregarding the behavior from the connector, I'm only discussing the additional layers of exceptions added by the framework before printing.\nAt the moment, the RuntimeException from put is wrapped by a ConnectException, but the RuntimeException from close is never wrapped in a ConnectException. I'm questioning whether this is the ideal behavior, and whether we should add that wrapping layer, or consider it out-of-scope for this PR.", "url": "https://github.com/apache/kafka/pull/8618#discussion_r421009491", "createdAt": "2020-05-06T18:39:15Z", "author": {"login": "gharris1727"}, "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/WorkerSinkTaskTest.java", "diffHunk": "@@ -856,6 +858,47 @@ public void run() {\n         PowerMock.verifyAll();\n     }\n \n+    @Test\n+    public void testSinkTasksHandleCloseErrors() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg5OTM5Mw=="}, "originalCommit": {"oid": "a4deafc55e3ba2330690949e8ed78c7cdc1f0ef6"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE4ODE1OQ==", "bodyText": "That's the testing I had in mind. That's great.\nNo need to change the exception type right now.", "url": "https://github.com/apache/kafka/pull/8618#discussion_r421188159", "createdAt": "2020-05-07T01:35:08Z", "author": {"login": "kkonstantine"}, "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/WorkerSinkTaskTest.java", "diffHunk": "@@ -856,6 +858,47 @@ public void run() {\n         PowerMock.verifyAll();\n     }\n \n+    @Test\n+    public void testSinkTasksHandleCloseErrors() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg5OTM5Mw=="}, "originalCommit": {"oid": "a4deafc55e3ba2330690949e8ed78c7cdc1f0ef6"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMjA0MDg2OnYy", "diffSide": "RIGHT", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSinkTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwMTozODozN1rOGRrWAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMToxNTozMFrOGSQjzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE4OTEyMg==", "bodyText": "Although I dig supressible with 1 p, like \"sup? exception what are you up to?\"\nI'm afraid I'll have to abide by the usual rules and recommend: suppressible here \ud83d\ude04\n(probably the IDE will complain about a typo too).", "url": "https://github.com/apache/kafka/pull/8618#discussion_r421189122", "createdAt": "2020-05-07T01:38:37Z", "author": {"login": "kkonstantine"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSinkTask.java", "diffHunk": "@@ -193,13 +194,11 @@ public void transitionTo(TargetState state) {\n     @Override\n     public void execute() {\n         initializeAndStart();\n-        try {\n+        // Make sure any uncommitted data has been committed and the task has\n+        // a chance to clean up its state\n+        try (UncheckedCloseable supressible = this::closePartitions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e41bc8f889505c3275f9036d2570c4ae19d8408d"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc5ODg2MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try (UncheckedCloseable supressible = this::closePartitions) {\n          \n          \n            \n                    try (UncheckedCloseable suppressible = this::closePartitions) {", "url": "https://github.com/apache/kafka/pull/8618#discussion_r421798861", "createdAt": "2020-05-07T21:15:30Z", "author": {"login": "gharris1727"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSinkTask.java", "diffHunk": "@@ -193,13 +194,11 @@ public void transitionTo(TargetState state) {\n     @Override\n     public void execute() {\n         initializeAndStart();\n-        try {\n+        // Make sure any uncommitted data has been committed and the task has\n+        // a chance to clean up its state\n+        try (UncheckedCloseable supressible = this::closePartitions) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE4OTEyMg=="}, "originalCommit": {"oid": "e41bc8f889505c3275f9036d2570c4ae19d8408d"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2880, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}