{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1MTM1ODYy", "number": 8116, "title": "KAFKA-9562: part 1: ignore exceptions while flushing stores in close(dirty)", "bodyText": "Committer Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-02-13T23:18:37Z", "url": "https://github.com/apache/kafka/pull/8116", "merged": true, "mergeCommit": {"oid": "c3da9ac86a21ff9bae459f8bc5d3d491360bc758"}, "closed": true, "closedAt": "2020-02-20T21:28:12Z", "author": {"login": "vvcephei"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEDa79gFqTM1ODYyMDkyMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGR_jjAFqTM2MjI0NTc3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjIwOTIy", "url": "https://github.com/apache/kafka/pull/8116#pullrequestreview-358620922", "createdAt": "2020-02-13T23:19:09Z", "commit": {"oid": "e506b287ec56d67d4e70c2b42b6fd432067c6ba3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMzoxOTowOVrOFpm52w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMzoyMDozMlrOFpm70Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3MzMzOQ==", "bodyText": "I added the exception to the log message, so we can see where the TaskMigratedException is actually caused.", "url": "https://github.com/apache/kafka/pull/8116#discussion_r379173339", "createdAt": "2020-02-13T23:19:09Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -701,10 +701,13 @@ private void runLoop() {\n                     enforceRebalance();\n                 }\n             } catch (final TaskMigratedException ignoreAndRejoinGroup) {\n-                log.warn(\"Detected task {} that got migrated to another thread. \" +\n-                        \"This implies that this thread missed a rebalance and dropped out of the consumer group. \" +\n-                        \"Will try to rejoin the consumer group. Below is the detailed description of the task:\\n{}\",\n-                    ignoreAndRejoinGroup.migratedTask().id(), ignoreAndRejoinGroup.migratedTask().toString(\">\"));\n+                log.warn(\"Detected task \" + ignoreAndRejoinGroup.migratedTask().id() +\n+                             \" that got migrated to another thread. This implies that this thread missed\" +\n+                             \" a rebalance and dropped out of the consumer group. Will try to rejoin the\" +\n+                             \" consumer group. Below is the detailed description of the task:\\n\" +\n+                             ignoreAndRejoinGroup.migratedTask().toString(\">\"),\n+                         ignoreAndRejoinGroup\n+                         );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e506b287ec56d67d4e70c2b42b6fd432067c6ba3"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3Mzg0MQ==", "bodyText": "Judging from the stacktrace generated in the prior logging change, this is where we're throwing a TaskMigratedException, even though this block is an \"unclean close\". Just trying out ignoring the exception to see what happens.", "url": "https://github.com/apache/kafka/pull/8116#discussion_r379173841", "createdAt": "2020-02-13T23:20:32Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -655,7 +655,11 @@ void suspend(final boolean clean,\n             }\n         } else {\n             // In the case of unclean close we still need to make sure all the stores are flushed before closing any\n-            super.flushState();\n+            try {\n+                stateMgr.flush();\n+            } catch (final ProcessorStateException e) {\n+                // ignore any exceptions while flushing (all stores would have had a chance to flush anyway)\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e506b287ec56d67d4e70c2b42b6fd432067c6ba3"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ba79bf6de34142dff929bae3d5c9e50b96800c1", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/5ba79bf6de34142dff929bae3d5c9e50b96800c1", "committedDate": "2020-02-20T20:36:23Z", "message": "KAFKA-9562: part 1: ignore exceptions while flushing stores in close(dirty)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjQ1Nzc5", "url": "https://github.com/apache/kafka/pull/8116#pullrequestreview-362245779", "createdAt": "2020-02-20T21:27:26Z", "commit": {"oid": "5ba79bf6de34142dff929bae3d5c9e50b96800c1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1437, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}