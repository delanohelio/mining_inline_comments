{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNDg3MjY2", "number": 7970, "title": "KAFKA-9338; Fetch session should cache request leader epoch", "bodyText": "Since the leader epoch was not maintained in the fetch session cache, no validation would be done except for the initial (full) fetch request. This patch adds the leader epoch to the session cache and addresses the testing gaps.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-01-16T06:58:06Z", "url": "https://github.com/apache/kafka/pull/7970", "merged": true, "mergeCommit": {"oid": "faf46de5156ac8e0f02cc98227ed449ddcdea307"}, "closed": true, "closedAt": "2020-01-17T22:36:05Z", "author": {"login": "hachikuji"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb60iYMgH2gAyMzYzNDg3MjY2OjAwNjQ5MjkwNGQyNmRhYzI2NjIxNjZjYjM5NzQ4OTk5Y2Q1MWIyMTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7T7ZWAFqTM0NDc5NDQ4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "006492904d26dac2662166cb39748999cd51b216", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/006492904d26dac2662166cb39748999cd51b216", "committedDate": "2020-01-16T06:55:09Z", "message": "KAFKA-9338; Fetch session should cache request leader epoch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTczMzYy", "url": "https://github.com/apache/kafka/pull/7970#pullrequestreview-343973362", "createdAt": "2020-01-16T14:57:10Z", "commit": {"oid": "006492904d26dac2662166cb39748999cd51b216"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDo1NzoxMFrOFecOEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDo1NzoxMFrOFecOEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2Mzk1NQ==", "bodyText": "Does this test fail without the fix?", "url": "https://github.com/apache/kafka/pull/7970#discussion_r367463955", "createdAt": "2020-01-16T14:57:10Z", "author": {"login": "ijuma"}, "path": "core/src/test/scala/unit/kafka/server/FetchRequestTest.scala", "diffHunk": "@@ -248,6 +248,55 @@ class FetchRequestTest extends BaseRequestTest {\n     assertResponseErrorForEpoch(Errors.FENCED_LEADER_EPOCH, followerId, Optional.of(secondLeaderEpoch - 1))\n   }\n \n+  @Test\n+  def testEpochValidationWithinFetchSession(): Unit = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "006492904d26dac2662166cb39748999cd51b216"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MDQ4Mjg4", "url": "https://github.com/apache/kafka/pull/7970#pullrequestreview-344048288", "createdAt": "2020-01-16T16:31:09Z", "commit": {"oid": "006492904d26dac2662166cb39748999cd51b216"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNjozMTowOVrOFeft9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNjozMTowOVrOFeft9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUyMTI2OA==", "bodyText": "The decision not to use TopicPartition was actually deliberate here.  TP has an extra \"hash\" field which we don't need, which would add 4 bytes of overhead per partition.  It also adds the overhead of a Java object, which is probably at least 8 bytes per partition.", "url": "https://github.com/apache/kafka/pull/7970#discussion_r367521268", "createdAt": "2020-01-16T16:31:09Z", "author": {"login": "cmccabe"}, "path": "core/src/main/scala/kafka/server/FetchSession.scala", "diffHunk": "@@ -71,49 +71,46 @@ object FetchSession {\n   * Note that fetcherLogStartOffset is the LSO of the follower performing the fetch, whereas\n   * localLogStartOffset is the log start offset of the partition on this broker.\n   */\n-class CachedPartition(val topic: String,\n-                      val partition: Int,\n+class CachedPartition(val topicPartition: TopicPartition,\n                       var maxBytes: Int,\n                       var fetchOffset: Long,\n                       var highWatermark: Long,\n+                      var leaderEpoch: Optional[Integer],\n                       var fetcherLogStartOffset: Long,\n                       var localLogStartOffset: Long)\n     extends ImplicitLinkedHashCollection.Element {\n \n   var cachedNext: Int = ImplicitLinkedHashCollection.INVALID_INDEX\n   var cachedPrev: Int = ImplicitLinkedHashCollection.INVALID_INDEX\n \n-  override def next = cachedNext\n-  override def setNext(next: Int) = this.cachedNext = next\n-  override def prev = cachedPrev\n-  override def setPrev(prev: Int) = this.cachedPrev = prev\n+  override def next: Int = cachedNext\n+  override def setNext(next: Int): Unit = this.cachedNext = next\n+  override def prev: Int = cachedPrev\n+  override def setPrev(prev: Int): Unit = this.cachedPrev = prev\n \n   def this(topic: String, partition: Int) =\n-    this(topic, partition, -1, -1, -1, -1, -1)\n+    this(new TopicPartition(topic, partition), -1, -1, -1, Optional.empty(), -1, -1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "006492904d26dac2662166cb39748999cd51b216"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MDU1Mjc5", "url": "https://github.com/apache/kafka/pull/7970#pullrequestreview-344055279", "createdAt": "2020-01-16T16:40:11Z", "commit": {"oid": "006492904d26dac2662166cb39748999cd51b216"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNjo0MDoxMVrOFegC2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNjo0MDoxMVrOFegC2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUyNjYxOQ==", "bodyText": "It seems like rather than use None for older fetch requests, we could just initialize the leaderEpoch to the current leader epoch.  That way, we could at least detect epoch changes.  Although we'd have to figure out how to handle the error-- probably just by dropping the session.", "url": "https://github.com/apache/kafka/pull/7970#discussion_r367526619", "createdAt": "2020-01-16T16:40:11Z", "author": {"login": "cmccabe"}, "path": "core/src/main/scala/kafka/server/FetchSession.scala", "diffHunk": "@@ -71,49 +71,46 @@ object FetchSession {\n   * Note that fetcherLogStartOffset is the LSO of the follower performing the fetch, whereas\n   * localLogStartOffset is the log start offset of the partition on this broker.\n   */\n-class CachedPartition(val topic: String,\n-                      val partition: Int,\n+class CachedPartition(val topicPartition: TopicPartition,\n                       var maxBytes: Int,\n                       var fetchOffset: Long,\n                       var highWatermark: Long,\n+                      var leaderEpoch: Optional[Integer],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "006492904d26dac2662166cb39748999cd51b216"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18e1837c95a3d1082205b965121fedcce78c63ff", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/18e1837c95a3d1082205b965121fedcce78c63ff", "committedDate": "2020-01-16T17:02:59Z", "message": "Revert change to FetchSession TopicPartition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fdddbb25403d2e5f5a60579a9514d62c26ef753", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/3fdddbb25403d2e5f5a60579a9514d62c26ef753", "committedDate": "2020-01-16T17:53:30Z", "message": "More efficient equals implementation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "3fdddbb25403d2e5f5a60579a9514d62c26ef753", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/3fdddbb25403d2e5f5a60579a9514d62c26ef753", "committedDate": "2020-01-16T17:53:30Z", "message": "More efficient equals implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "accca8208544725928f00dda822d160c1f4be048", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/accca8208544725928f00dda822d160c1f4be048", "committedDate": "2020-01-16T18:31:26Z", "message": "Use || instead of `if`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0Nzk0NDg4", "url": "https://github.com/apache/kafka/pull/7970#pullrequestreview-344794488", "createdAt": "2020-01-17T19:29:32Z", "commit": {"oid": "accca8208544725928f00dda822d160c1f4be048"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2030, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}