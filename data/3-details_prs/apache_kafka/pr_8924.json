{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5NTU3MTQ4", "number": 8924, "title": "KAFKA-10198: guard against recycling dirty state", "bodyText": "We just needed to add the check in StreamTask#closeClean  to closeAndRecycleState as well. I also renamed closeAndRecycleState to closeCleanAndRecycleState to drive this point home: it needs to be clean.\nThis should be cherry-picked back to the 2.6 branch", "createdAt": "2020-06-24T22:44:58Z", "url": "https://github.com/apache/kafka/pull/8924", "merged": true, "mergeCommit": {"oid": "3348fc49d8824155e737b866f633e14684da5fe9"}, "closed": true, "closedAt": "2020-06-25T01:57:39Z", "author": {"login": "ableegoldman"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuh_mYAH2gAyNDM5NTU3MTQ4OmMyN2EwZmZiMjYzMjJhNzhmMTRhZDRmZDIwNWIyNmFiZmVhNWQzZjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcujOmCgFqTQzNzA4NzAwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c27a0ffb26322a78f14ad4fd205b26abfea5d3f6", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/c27a0ffb26322a78f14ad4fd205b26abfea5d3f6", "committedDate": "2020-06-24T22:42:56Z", "message": "validateClean"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDU3MjI3", "url": "https://github.com/apache/kafka/pull/8924#pullrequestreview-437057227", "createdAt": "2020-06-24T22:46:45Z", "commit": {"oid": "c27a0ffb26322a78f14ad4fd205b26abfea5d3f6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMjo0Njo0NVrOGoloXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMjo0Njo0NVrOGoloXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIxMjc2NQ==", "bodyText": "This diff turned out a bit awkward, basically I just factored this check out into a separate method that we should call at the beginning of both flavors of clean close", "url": "https://github.com/apache/kafka/pull/8924#discussion_r445212765", "createdAt": "2020-06-24T22:46:45Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -515,17 +517,20 @@ private void writeCheckpoint() {\n         stateMgr.checkpoint(checkpointableOffsets());\n     }\n \n-    /**\n-     * You must commit a task and checkpoint the state manager before closing as this will release the state dir lock\n-     */\n-    private void close(final boolean clean) {\n-        if (clean && commitNeeded) {\n-            // It may be that we failed to commit a task during handleRevocation, but \"forgot\" this and tried to\n-            // closeClean in handleAssignment. We should throw if we detect this to force the TaskManager to closeDirty\n+    private void validateClean() {\n+        // It may be that we failed to commit a task during handleRevocation, but \"forgot\" this and tried to\n+        // closeClean in handleAssignment. We should throw if we detect this to force the TaskManager to closeDirty\n+        if (commitNeeded) {\n             log.debug(\"Tried to close clean but there was pending uncommitted data, this means we failed to\"\n                           + \" commit and should close as dirty instead\");\n             throw new TaskMigratedException(\"Tried to close dirty task as clean\");\n         }\n+    }\n+\n+    /**\n+     * You must commit a task and checkpoint the state manager before closing as this will release the state dir lock\n+     */\n+    private void close(final boolean clean) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c27a0ffb26322a78f14ad4fd205b26abfea5d3f6"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c8967f8f336c653a56575d2c29c15db4b16d33a", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/3c8967f8f336c653a56575d2c29c15db4b16d33a", "committedDate": "2020-06-24T22:51:03Z", "message": "add unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc71861dfcb093d5d430f8e7a3fa8786c1d12fb1", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/fc71861dfcb093d5d430f8e7a3fa8786c1d12fb1", "committedDate": "2020-06-24T22:55:21Z", "message": "fix test setup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDY2NzQ1", "url": "https://github.com/apache/kafka/pull/8924#pullrequestreview-437066745", "createdAt": "2020-06-24T23:11:28Z", "commit": {"oid": "fc71861dfcb093d5d430f8e7a3fa8786c1d12fb1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDg3MDA4", "url": "https://github.com/apache/kafka/pull/8924#pullrequestreview-437087008", "createdAt": "2020-06-25T00:09:13Z", "commit": {"oid": "fc71861dfcb093d5d430f8e7a3fa8786c1d12fb1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 726, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}