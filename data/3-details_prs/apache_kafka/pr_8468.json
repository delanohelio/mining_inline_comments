{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMjY5Njcz", "number": 8468, "title": "MINOR: reduce impact of trace logging in replica hot path", "bodyText": "The impact of trace logging is normally small, on the order of 40ns per getEffectiveLevel check, however this adds up with trace is called multiple times per partition in the replica fetch hot path.\nThis PR removes some trace logs that are not very useful and reduces cases where the level is checked over and over for one fetch request.\nBack of envelope savings calculation\nAssume 1500 leader replicas on a broker, 8 followers fetching 200 times per second.\nPartitions per fetch request = 1500 * 2 (replication) / 8 (followers) = 375\nPartition reads per second = 375 * 8 * 200 = 6000000\nCPU time in ms used per second for single trace call saved = 40 * 6000000 / 1000000 = 24ms\nAssuming 4 cores each trace call we save saves approximately 24/1000/4 = 0.6%.", "createdAt": "2020-04-12T01:10:28Z", "url": "https://github.com/apache/kafka/pull/8468", "merged": true, "mergeCommit": {"oid": "851b45c842a9d35c8299f87725b52b1b6523271e"}, "closed": true, "closedAt": "2020-04-17T21:22:31Z", "author": {"login": "lbradstreet"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVFjmTAH2gAyNDAyMjY5NjczOmIzY2E0YmFmYjBiYTc0OWEwYzk5NWM0NGQzNzQ5NDgwMjY5ZDI2ZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYkwtXgFqTM5NTY0Mjc5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b3ca4bafb0ba749a0c995c44d3749480269d26f3", "author": {"user": {"login": "lbradstreet", "name": "Lucas Bradstreet"}}, "url": "https://github.com/apache/kafka/commit/b3ca4bafb0ba749a0c995c44d3749480269d26f3", "committedDate": "2020-04-06T21:26:54Z", "message": "MINOR: reduce impact of trace logging in replica hot path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b", "author": {"user": {"login": "lbradstreet", "name": "Lucas Bradstreet"}}, "url": "https://github.com/apache/kafka/commit/58d7677904fe8fa17ae7e9fbf509c7266dd0da0b", "committedDate": "2020-04-06T21:27:01Z", "message": "Perform trace check once per partition in replica fetcher thread"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxODEyNDA3", "url": "https://github.com/apache/kafka/pull/8468#pullrequestreview-391812407", "createdAt": "2020-04-12T01:11:20Z", "commit": {"oid": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToxMToyMFrOGERPxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToxMToyMFrOGERPxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMDA1Mg==", "bodyText": "I need a way to do this more cleanly. Is it OK to put an isTraceEnabled call into the logger rather than access the underlying directly?", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407130052", "createdAt": "2020-04-12T01:11:20Z", "author": {"login": "lbradstreet"}, "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "diffHunk": "@@ -785,7 +785,7 @@ class ReplicaManager(val config: KafkaConfig,\n                                origin: AppendOrigin,\n                                entriesPerPartition: Map[TopicPartition, MemoryRecords],\n                                requiredAcks: Short): Map[TopicPartition, LogAppendResult] = {\n-\n+    val isTraceEnabled = logger.underlying.isTraceEnabled", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxODEyNDI5", "url": "https://github.com/apache/kafka/pull/8468#pullrequestreview-391812429", "createdAt": "2020-04-12T01:11:58Z", "commit": {"oid": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToxMTo1OFrOGERP8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToxMTo1OFrOGERP8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMDA5OQ==", "bodyText": "Saves 3 getEffectiveLevel checks.", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407130099", "createdAt": "2020-04-12T01:11:58Z", "author": {"login": "lbradstreet"}, "path": "core/src/main/scala/kafka/server/ReplicaFetcherThread.scala", "diffHunk": "@@ -149,6 +149,7 @@ class ReplicaFetcherThread(name: String,\n   override def processPartitionData(topicPartition: TopicPartition,\n                                     fetchOffset: Long,\n                                     partitionData: FetchData): Option[LogAppendInfo] = {\n+    val logTrace = isTraceEnabled", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxODEyNTM0", "url": "https://github.com/apache/kafka/pull/8468#pullrequestreview-391812534", "createdAt": "2020-04-12T01:14:28Z", "commit": {"oid": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToxNDoyOVrOGERQwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToxNDoyOVrOGERQwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMDMwNQ==", "bodyText": "Looking up the trace level outside of the map allows us to save a isTraceEnabled lookup for every partition being produced to.", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407130305", "createdAt": "2020-04-12T01:14:29Z", "author": {"login": "lbradstreet"}, "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "diffHunk": "@@ -820,8 +822,10 @@ class ReplicaManager(val config: KafkaConfig,\n           brokerTopicStats.topicStats(topicPartition.topic).messagesInRate.mark(numAppendedMessages)\n           brokerTopicStats.allTopicsStats.messagesInRate.mark(numAppendedMessages)\n \n-          trace(s\"${records.sizeInBytes} written to log $topicPartition beginning at offset \" +\n-            s\"${info.firstOffset.getOrElse(-1)} and ending at offset ${info.lastOffset}\")\n+          if (isTraceEnabled)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxODEzMTQx", "url": "https://github.com/apache/kafka/pull/8468#pullrequestreview-391813141", "createdAt": "2020-04-12T01:28:46Z", "commit": {"oid": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToyODo0NlrOGERUvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToyODo0NlrOGERUvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMTMyNQ==", "bodyText": "Looking up the trace level above means we only need to get the effective level once even though read() may be called once for each partition.", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407131325", "createdAt": "2020-04-12T01:28:46Z", "author": {"login": "lbradstreet"}, "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "diffHunk": "@@ -978,9 +983,10 @@ class ReplicaManager(val config: KafkaConfig,\n \n       val adjustedMaxBytes = math.min(fetchInfo.maxBytes, limitBytes)\n       try {\n-        trace(s\"Fetching log segment for partition $tp, offset $offset, partition fetch size $partitionFetchSize, \" +\n-          s\"remaining response limit $limitBytes\" +\n-          (if (minOneMessage) s\", ignoring response/partition size limits\" else \"\"))\n+        if (isTraceEnabled)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c206dd906d6e5cd0893cdf86bbd1535f42aecb69", "author": {"user": {"login": "lbradstreet", "name": "Lucas Bradstreet"}}, "url": "https://github.com/apache/kafka/commit/c206dd906d6e5cd0893cdf86bbd1535f42aecb69", "committedDate": "2020-04-12T01:29:01Z", "message": "Avoid calling the underlying logger"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNTY2MzI1", "url": "https://github.com/apache/kafka/pull/8468#pullrequestreview-392566325", "createdAt": "2020-04-14T02:43:11Z", "commit": {"oid": "c206dd906d6e5cd0893cdf86bbd1535f42aecb69"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjo0MzoxMVrOGE8IGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjo0MzoxMVrOGE8IGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMjYwMg==", "bodyText": "I don't think this trace call is worthwhile given the cost. It would be hard to turn it on without being deluged with logs.", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407832602", "createdAt": "2020-04-14T02:43:11Z", "author": {"login": "lbradstreet"}, "path": "core/src/main/scala/kafka/cluster/Replica.scala", "diffHunk": "@@ -83,7 +83,6 @@ class Replica(val brokerId: Int, val topicPartition: TopicPartition) extends Log\n     lastFetchLeaderLogEndOffset = leaderEndOffset\n     lastFetchTimeMs = followerFetchTimeMs\n     updateLastSentHighWatermark(lastSentHighwatermark)\n-    trace(s\"Updated state of replica to $this\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c206dd906d6e5cd0893cdf86bbd1535f42aecb69"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNTY2Mzc5", "url": "https://github.com/apache/kafka/pull/8468#pullrequestreview-392566379", "createdAt": "2020-04-14T02:43:22Z", "commit": {"oid": "c206dd906d6e5cd0893cdf86bbd1535f42aecb69"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjo0MzoyMlrOGE8IQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjo0MzoyMlrOGE8IQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMjY0Mg==", "bodyText": "I don't think this trace call is worthwhile given the cost. It would be hard to turn it on without being deluged with logs..", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407832642", "createdAt": "2020-04-14T02:43:22Z", "author": {"login": "lbradstreet"}, "path": "core/src/main/scala/kafka/cluster/Replica.scala", "diffHunk": "@@ -96,7 +95,6 @@ class Replica(val brokerId: Int, val topicPartition: TopicPartition) extends Log\n     */\n   private def updateLastSentHighWatermark(highWatermark: Long): Unit = {\n     _lastSentHighWatermark = highWatermark\n-    trace(s\"Updated HW of replica to $highWatermark\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c206dd906d6e5cd0893cdf86bbd1535f42aecb69"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NjQyNzk0", "url": "https://github.com/apache/kafka/pull/8468#pullrequestreview-395642794", "createdAt": "2020-04-17T17:30:03Z", "commit": {"oid": "c206dd906d6e5cd0893cdf86bbd1535f42aecb69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1474, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}