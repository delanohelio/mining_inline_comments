{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNDA5Njkx", "number": 8963, "title": "KAFKA-10017: fix flaky EosBetaUpgradeIntegrationTest", "bodyText": "The current failures we're seeing with this test are due to faulty assumptions that it makes and not any real bug in eos-beta (at least, from what I've seen so far).\nThe test relies on tightly controlling the commits, which it does by setting the commit interval to MAX_VALUE and manually requesting commits on the context. In two phases, the test assumes that any pending data will be committed after a rebalance. But we actually take care to avoid unnecessary commits -- with eos-alpha, we only commit tasks that are revoked while in eos-beta we must commit all tasks if any are revoked, but only if the revoked tasks themselves need a commit.\nThe failure we see occurs when we try to verify the committed data after a second client is started and the group rebalances. The already-running client has to give up two tasks to the newly started client, but those tasks may not need to be committed in which case none of the tasks would be. So we still have an open transaction on the partitions where we try to read committed data.\nWe can use a punctuator to force a commit on the running client", "createdAt": "2020-07-01T03:00:45Z", "url": "https://github.com/apache/kafka/pull/8963", "merged": true, "mergeCommit": {"oid": "cd2f5f030b353dfcaa7c3c8e18f69c681ea8e0f1"}, "closed": true, "closedAt": "2020-07-06T21:04:37Z", "author": {"login": "ableegoldman"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwhFbzgH2gAyNDQyNDA5NjkxOjNmMTMwMGUwYTMyOWRkMmVlMTA5MTQ2NGMyYzFmYTUyM2M1MWUxZmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyWzVugFqTQ0MzM2NjgwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3f1300e0a329dd2ee1091464c2c1fa523c51e1fc", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/3f1300e0a329dd2ee1091464c2c1fa523c51e1fc", "committedDate": "2020-07-01T02:47:15Z", "message": "use punctuator to request commit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjcyODUw", "url": "https://github.com/apache/kafka/pull/8963#pullrequestreview-441272850", "createdAt": "2020-07-02T00:21:07Z", "commit": {"oid": "3f1300e0a329dd2ee1091464c2c1fa523c51e1fc"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4186531247e56862f0f74ed002a995e77b7eff99", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/4186531247e56862f0f74ed002a995e77b7eff99", "committedDate": "2020-07-02T04:21:20Z", "message": "env flakiness fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNzMxNDUw", "url": "https://github.com/apache/kafka/pull/8963#pullrequestreview-441731450", "createdAt": "2020-07-02T14:26:46Z", "commit": {"oid": "4186531247e56862f0f74ed002a995e77b7eff99"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNDoyNjo0N1rOGsPVeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNDozMTowNVrOGsPiBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MTc4NA==", "bodyText": "Would it speed up the test to choose a smaller number here?", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449041784", "createdAt": "2020-07-02T14:26:47Z", "author": {"login": "vvcephei"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/EosBetaUpgradeIntegrationTest.java", "diffHunk": "@@ -837,6 +866,11 @@ public void init(final ProcessorContext context) {\n                             crash = errorInjectedClient2;\n                             sharedCommit = commitCounterClient2;\n                         }\n+                        punctuator = context.schedule(\n+                            Duration.ofSeconds(5),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4186531247e56862f0f74ed002a995e77b7eff99"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MzkwOQ==", "bodyText": "There should never be multiple requests, right? If there were, a second request might arrive between 168 and 169, violating the desired property. In that case, we should grab a lock instead. As long as there's only one requesting thread, and it always waits for the commit right after requesting, then we should be good.", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449043909", "createdAt": "2020-07-02T14:29:40Z", "author": {"login": "vvcephei"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/EosBetaUpgradeIntegrationTest.java", "diffHunk": "@@ -147,6 +152,25 @@\n     private final AtomicInteger commitCounterClient2 = new AtomicInteger(-1);\n     private final AtomicInteger commitRequested = new AtomicInteger(0);\n \n+    private final AtomicBoolean requestCommit = new AtomicBoolean(false);\n+    private static class CommitPunctuator implements Punctuator {\n+        final ProcessorContext context;\n+        final AtomicBoolean requestCommit;\n+\n+        public CommitPunctuator(final ProcessorContext context, final AtomicBoolean requestCommit) {\n+            this.context = context;\n+            this.requestCommit = requestCommit;\n+        }\n+\n+        @Override\n+        public void punctuate(final long timestamp) {\n+            if (requestCommit.get()) {\n+                context.commit();\n+                requestCommit.set(false);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4186531247e56862f0f74ed002a995e77b7eff99"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0NDk5OQ==", "bodyText": "There's going to be a separate punctuator per task, right? Does the test account for this?", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449044999", "createdAt": "2020-07-02T14:31:05Z", "author": {"login": "vvcephei"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/EosBetaUpgradeIntegrationTest.java", "diffHunk": "@@ -837,6 +866,11 @@ public void init(final ProcessorContext context) {\n                             crash = errorInjectedClient2;\n                             sharedCommit = commitCounterClient2;\n                         }\n+                        punctuator = context.schedule(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4186531247e56862f0f74ed002a995e77b7eff99"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b4b8c635c2887902f405bcfbb6e252678700290", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/3b4b8c635c2887902f405bcfbb6e252678700290", "committedDate": "2020-07-02T19:27:08Z", "message": "clarify usage and reduce punctuation interval"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMDQwMDY2", "url": "https://github.com/apache/kafka/pull/8963#pullrequestreview-442040066", "createdAt": "2020-07-02T21:54:43Z", "commit": {"oid": "3b4b8c635c2887902f405bcfbb6e252678700290"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjI2ODIw", "url": "https://github.com/apache/kafka/pull/8963#pullrequestreview-442626820", "createdAt": "2020-07-04T19:14:50Z", "commit": {"oid": "3b4b8c635c2887902f405bcfbb6e252678700290"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQxOToxNDo1MFrOGs9gQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQxOToxNTo0MFrOGs9gkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5ODIxMQ==", "bodyText": "In this test we would have multiple punctuator indeed but they would be executed by a single thread sequentially so that's fine.", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449798211", "createdAt": "2020-07-04T19:14:50Z", "author": {"login": "guozhangwang"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/EosBetaUpgradeIntegrationTest.java", "diffHunk": "@@ -837,6 +866,11 @@ public void init(final ProcessorContext context) {\n                             crash = errorInjectedClient2;\n                             sharedCommit = commitCounterClient2;\n                         }\n+                        punctuator = context.schedule(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0NDk5OQ=="}, "originalCommit": {"oid": "4186531247e56862f0f74ed002a995e77b7eff99"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5ODI5MQ==", "bodyText": "Makes sense to me.", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449798291", "createdAt": "2020-07-04T19:15:40Z", "author": {"login": "guozhangwang"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/utils/IntegrationTestUtils.java", "diffHunk": "@@ -1273,7 +1273,7 @@ public void prepareForRebalance() {\n          */\n         public void waitForNextStableAssignment(final long maxWaitMs) throws InterruptedException {\n             waitForCondition(\n-                () -> nextExpectedNumStableAssignments == numStableAssignments(),\n+                () -> numStableAssignments() >= nextExpectedNumStableAssignments,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b4b8c635c2887902f405bcfbb6e252678700290"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMzY2ODAz", "url": "https://github.com/apache/kafka/pull/8963#pullrequestreview-443366803", "createdAt": "2020-07-06T19:56:17Z", "commit": {"oid": "3b4b8c635c2887902f405bcfbb6e252678700290"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1420, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}