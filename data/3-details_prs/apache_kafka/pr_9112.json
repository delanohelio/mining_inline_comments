{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYxODQ1MDg4", "number": 9112, "title": "KAFKA-10312 Fix error code returned by getPartitionMetadata", "bodyText": "MetadataCache#getPartitionMetadata returns an error when the topic's leader Id\nis present at MetadataCache but listener endpoint is not present for this leader.\nFor older version, LEADER_NOT_AVAILABLE is returned while LISTENER_NOT_FOUND is\nreturned for new metadata version.\ngetPartitionMetadata was looking up MetadataCache's host brokerId rather\nthan the topic's leader id while determining what error to return. This\ncould result in the call returning LISTENER_NOT_FOUND when it should\nhave returned LEADER_NOT_AVAILABLE. This commit corrects this behavior.\nUnit tests were already present to test out the error codes returned\nunder different situations but they were giving out a false positive.\nThe test was using same broker id for both the MetadataCache's host as\nwell as for the topic's leader. Error manifests when the MetadataCache's\nhost id is changed. Improved the test.\nThis commit also consolidated couple of related tests to reduce code\nduplication.\nMore detailed description of your change,\nif necessary. The PR title and PR message become\nthe squashed commit message, so use a separate\ncomment to ping reviewers.\nSummary of testing strategy (including rationale)\nfor the feature or bug fix. Unit and/or integration\ntests are expected for any behaviour change and\nsystem tests should be considered for larger changes.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-08-02T18:50:18Z", "url": "https://github.com/apache/kafka/pull/9112", "merged": true, "mergeCommit": {"oid": "f19cd6ca48ccd2971948c9589279bb8ee20e5d88"}, "closed": true, "closedAt": "2020-08-24T18:18:59Z", "author": {"login": "RamanVerma"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9sTtmgFqTQ2NDY4NDg5OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-YorCAH2gAyNDYxODQ1MDg4Ojc5NTYwMGY2MDk3ZGRhNzJlNGMyODBlZGZmNzM3OWVlNzY5NDQyZmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0Njg0ODk5", "url": "https://github.com/apache/kafka/pull/9112#pullrequestreview-464684899", "createdAt": "2020-08-11T01:12:34Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMToxMjozNFrOG-k7yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMToxMjozNFrOG-k7yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3MDAyNw==", "bodyText": "nit: maybe it would be clearer if we passed brokerId as an argument? Then we could use broker 0 in the test case, for example, so that the UpdateMetadata request makes more sense.", "url": "https://github.com/apache/kafka/pull/9112#discussion_r468270027", "createdAt": "2020-08-11T01:12:34Z", "author": {"login": "hachikuji"}, "path": "core/src/test/scala/unit/kafka/server/MetadataCacheTest.scala", "diffHunk": "@@ -229,7 +205,7 @@ class MetadataCacheTest {\n                                                                        errorUnavailableListeners: Boolean): Unit = {\n     val topic = \"topic\"\n \n-    val cache = new MetadataCache(1)\n+    val cache = new MetadataCache(9)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1f0b3653b978cecf17c5d1baa8aec63e8b078f5", "author": {"user": {"login": "RamanVerma", "name": "Raman Verma"}}, "url": "https://github.com/apache/kafka/commit/b1f0b3653b978cecf17c5d1baa8aec63e8b078f5", "committedDate": "2020-08-11T07:15:17Z", "message": "KAFKA-10312 Fix error code returned by getPartitionMetadata\n\nMetadataCache#getPartitionMetadata returns an error when the topic's leader Id\nis present at MetadataCache but listener endpoint is not present for this leader.\nFor older version, LEADER_NOT_AVAILABLE is returned while LISTENER_NOT_FOUND is\nreturned for new metadata version.\n\ngetPartitionMetadata was looking up MetadataCache's host brokerId rather\nthan the topic's leader id while determining what error to return. This\ncould result in the call returning LISTENER_NOT_FOUND when it should\nhave returned LEADER_NOT_AVAILABLE. This commit corrects this behavior.\n\nUnit tests were already present to test out the error codes returned\nunder different situations but they were giving out a false positive.\nThe test was using same broker id for both the MetadataCache's host as\nwell as for the topic's leader. Error manifests when the MetadataCache's\nhost id is changed. Improved the test.\n\nThis commit also consolidated couple of related tests to reduce code\nduplication."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf6671f4afdd13f67bab8376b5ba93f549ebcb7a", "author": {"user": {"login": "RamanVerma", "name": "Raman Verma"}}, "url": "https://github.com/apache/kafka/commit/cf6671f4afdd13f67bab8376b5ba93f549ebcb7a", "committedDate": "2020-08-11T07:15:17Z", "message": "Minor refactoring to introduce brokerId for metadata cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "cf6671f4afdd13f67bab8376b5ba93f549ebcb7a", "author": {"user": {"login": "RamanVerma", "name": "Raman Verma"}}, "url": "https://github.com/apache/kafka/commit/cf6671f4afdd13f67bab8376b5ba93f549ebcb7a", "committedDate": "2020-08-11T07:15:17Z", "message": "Minor refactoring to introduce brokerId for metadata cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1Mjk4NDAy", "url": "https://github.com/apache/kafka/pull/9112#pullrequestreview-465298402", "createdAt": "2020-08-11T17:54:36Z", "commit": {"oid": "cf6671f4afdd13f67bab8376b5ba93f549ebcb7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNzo1NDozNlrOG_C6fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNzo1NDozNlrOG_C6fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2MTIxNQ==", "bodyText": "Would 0 work just as well? It would make the test more coherent if we used one of the ids included in the UpdateMetadata request.", "url": "https://github.com/apache/kafka/pull/9112#discussion_r468761215", "createdAt": "2020-08-11T17:54:36Z", "author": {"login": "hachikuji"}, "path": "core/src/test/scala/unit/kafka/server/MetadataCacheTest.scala", "diffHunk": "@@ -187,49 +191,24 @@ class MetadataCacheTest {\n       new UpdateMetadataBroker()\n         .setId(1)\n         .setEndpoints(broker1Endpoints.asJava))\n-    verifyTopicMetadataPartitionLeaderOrEndpointNotAvailable(brokers, sslListenerName,\n+    val metadataCacheBrokerId = 9", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf6671f4afdd13f67bab8376b5ba93f549ebcb7a"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "795600f6097dda72e4c280edff7379ee769442fd", "author": {"user": {"login": "RamanVerma", "name": "Raman Verma"}}, "url": "https://github.com/apache/kafka/commit/795600f6097dda72e4c280edff7379ee769442fd", "committedDate": "2020-08-13T04:51:32Z", "message": "Minor fix - Changed the metadataCache brokerId in tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1037, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}