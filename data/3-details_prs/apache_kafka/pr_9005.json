{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3MTYwNTk3", "number": 9005, "title": "KAFKA-10263: Do not assign standby for revoking stateless tasks", "bodyText": "Also piggy-back a small fix to use TreeMap other than HashMap to preserve iteration ordering.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-07-10T00:36:58Z", "url": "https://github.com/apache/kafka/pull/9005", "merged": true, "mergeCommit": {"oid": "f209b3c5c1efbd80d709244a41f55c19c5c1c4de"}, "closed": true, "closedAt": "2020-07-10T23:51:01Z", "author": {"login": "guozhangwang"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczYjqvAH2gAyNDQ3MTYwNTk3OmVhMzc0ODQ5ZmEzMjc4Y2MzZGIzOTA3ODk2ODMzZTQzNDU5MTI3ZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczodOwgFqTQ0NjYzODQ3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ea374849fa3278cc3db3907896833e43459127df", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/ea374849fa3278cc3db3907896833e43459127df", "committedDate": "2020-07-10T00:32:54Z", "message": "first fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDUzODEz", "url": "https://github.com/apache/kafka/pull/9005#pullrequestreview-446053813", "createdAt": "2020-07-10T00:37:26Z", "commit": {"oid": "ea374849fa3278cc3db3907896833e43459127df"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMDozNzoyNlrOGvmN8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMDozNzo0MFrOGvmOJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU2MjQxNw==", "bodyText": "I found it was always true because we are comparing a list of tasks with a list of partitions ;)", "url": "https://github.com/apache/kafka/pull/9005#discussion_r452562417", "createdAt": "2020-07-10T00:37:26Z", "author": {"login": "guozhangwang"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignorTest.java", "diffHunk": "@@ -1402,9 +1404,13 @@ public void shouldTriggerImmediateRebalanceOnTasksRevoked() {\n         final Map<String, Assignment> assignment = partitionAssignor.assign(metadata, new GroupSubscription(subscriptions)).groupAssignment();\n \n         // Verify at least one partition was revoked\n-        assertThat(assignment.get(CONSUMER_1).partitions(), not(allTasks));\n+        assertThat(assignment.get(CONSUMER_1).partitions(), not(allPartitions));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea374849fa3278cc3db3907896833e43459127df"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU2MjQ2OA==", "bodyText": "Verified that without the fix, this line will fail.", "url": "https://github.com/apache/kafka/pull/9005#discussion_r452562468", "createdAt": "2020-07-10T00:37:40Z", "author": {"login": "guozhangwang"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignorTest.java", "diffHunk": "@@ -1402,9 +1404,13 @@ public void shouldTriggerImmediateRebalanceOnTasksRevoked() {\n         final Map<String, Assignment> assignment = partitionAssignor.assign(metadata, new GroupSubscription(subscriptions)).groupAssignment();\n \n         // Verify at least one partition was revoked\n-        assertThat(assignment.get(CONSUMER_1).partitions(), not(allTasks));\n+        assertThat(assignment.get(CONSUMER_1).partitions(), not(allPartitions));\n         assertThat(assignment.get(CONSUMER_2).partitions(), equalTo(emptyList()));\n \n+        // Verify that stateless revoked tasks would not be assigned as standbys\n+        assertThat(AssignmentInfo.decode(assignment.get(CONSUMER_2).userData()).activeTasks(), equalTo(emptyList()));\n+        assertThat(AssignmentInfo.decode(assignment.get(CONSUMER_2).userData()).standbyTasks(), equalTo(emptyMap()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea374849fa3278cc3db3907896833e43459127df"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDYyMTMz", "url": "https://github.com/apache/kafka/pull/9005#pullrequestreview-446062133", "createdAt": "2020-07-10T01:09:24Z", "commit": {"oid": "ea374849fa3278cc3db3907896833e43459127df"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMTowOToyNFrOGvmrvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMTowOToyNFrOGvmrvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU3MDA0NA==", "bodyText": "Whoops", "url": "https://github.com/apache/kafka/pull/9005#discussion_r452570044", "createdAt": "2020-07-10T01:09:24Z", "author": {"login": "ableegoldman"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignorTest.java", "diffHunk": "@@ -1402,9 +1404,13 @@ public void shouldTriggerImmediateRebalanceOnTasksRevoked() {\n         final Map<String, Assignment> assignment = partitionAssignor.assign(metadata, new GroupSubscription(subscriptions)).groupAssignment();\n \n         // Verify at least one partition was revoked\n-        assertThat(assignment.get(CONSUMER_1).partitions(), not(allTasks));\n+        assertThat(assignment.get(CONSUMER_1).partitions(), not(allPartitions));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU2MjQxNw=="}, "originalCommit": {"oid": "ea374849fa3278cc3db3907896833e43459127df"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c78d3b2474b13a3bc84b528b2e2d93ddc056328e", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/c78d3b2474b13a3bc84b528b2e2d93ddc056328e", "committedDate": "2020-07-10T17:48:39Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KXXX-fix-ha-partition-assignor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de6fefa5d44ce1ebd9b2ae312ec1edd58f411779", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/de6fefa5d44ce1ebd9b2ae312ec1edd58f411779", "committedDate": "2020-07-10T18:14:49Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NjM4NDcz", "url": "https://github.com/apache/kafka/pull/9005#pullrequestreview-446638473", "createdAt": "2020-07-10T19:04:07Z", "commit": {"oid": "de6fefa5d44ce1ebd9b2ae312ec1edd58f411779"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxOTowNDowN1rOGwComA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxOTowNDowN1rOGwComA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAyNzk5Mg==", "bodyText": "Oh, boy...", "url": "https://github.com/apache/kafka/pull/9005#discussion_r453027992", "createdAt": "2020-07-10T19:04:07Z", "author": {"login": "vvcephei"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignorTest.java", "diffHunk": "@@ -1402,9 +1404,13 @@ public void shouldTriggerImmediateRebalanceOnTasksRevoked() {\n         final Map<String, Assignment> assignment = partitionAssignor.assign(metadata, new GroupSubscription(subscriptions)).groupAssignment();\n \n         // Verify at least one partition was revoked\n-        assertThat(assignment.get(CONSUMER_1).partitions(), not(allTasks));\n+        assertThat(assignment.get(CONSUMER_1).partitions(), not(allPartitions));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU2MjQxNw=="}, "originalCommit": {"oid": "ea374849fa3278cc3db3907896833e43459127df"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1253, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}