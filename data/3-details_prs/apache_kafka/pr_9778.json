{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0MDE4MDQ5", "number": 9778, "title": "KAFKA-10874 Fix flaky ClientQuotasRequestTest.testAlterIpQuotasRequest", "bodyText": "The error  occcur when dynamic ip config  update after borker's config  get .\nsolve this by waiting dynamic ip config update.", "createdAt": "2020-12-22T10:14:33Z", "url": "https://github.com/apache/kafka/pull/9778", "merged": true, "mergeCommit": {"oid": "71540c03b86f55111ca7cc9b0f87724b40e0bda2"}, "closed": true, "closedAt": "2021-01-07T08:46:08Z", "author": {"login": "g1geordie"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdonqsOAH2gAyNTQ0MDE4MDQ5OjZiMDAxMGM3MzQwZDdhY2Q0MTEzMWU1ZThlZGE4MDZmNDE4MTliNWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtwExcgFqTU2MzMwMDM0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6b0010c7340d7acd41131e5e8eda806f41819b5a", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/6b0010c7340d7acd41131e5e8eda806f41819b5a", "committedDate": "2020-12-22T10:07:08Z", "message": "KAFKA-10874 Fix flaky ClientQuotasRequestTest.testAlterIpQuotasRequest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MjU2NjEw", "url": "https://github.com/apache/kafka/pull/9778#pullrequestreview-557256610", "createdAt": "2020-12-22T17:49:13Z", "commit": {"oid": "6b0010c7340d7acd41131e5e8eda806f41819b5a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzo0OToxM1rOIKDkUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzo0OToxM1rOIKDkUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQxNTEyMg==", "bodyText": "Is it overkill to retry whole method?", "url": "https://github.com/apache/kafka/pull/9778#discussion_r547415122", "createdAt": "2020-12-22T17:49:13Z", "author": {"login": "chia7712"}, "path": "core/src/test/scala/unit/kafka/server/ClientQuotasRequestTest.scala", "diffHunk": "@@ -200,7 +202,7 @@ class ClientQuotasRequestTest extends BaseRequestTest {\n     val defaultEntityFilter = ClientQuotaFilterComponent.ofDefaultEntity(ClientQuotaEntity.IP)\n     val allIpEntityFilter = ClientQuotaFilterComponent.ofEntityType(ClientQuotaEntity.IP)\n \n-    def verifyIpQuotas(entityFilter: ClientQuotaFilterComponent, expectedMatches: Map[ClientQuotaEntity, Double]): Unit = {\n+    def verifyIpQuotas(entityFilter: ClientQuotaFilterComponent, expectedMatches: Map[ClientQuotaEntity, Double]): Unit = TestUtils.retry(10000L){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b0010c7340d7acd41131e5e8eda806f41819b5a"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ace984d8caf7eb37a0ceea32dd3d8dc66513f19", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/4ace984d8caf7eb37a0ceea32dd3d8dc66513f19", "committedDate": "2020-12-23T03:15:07Z", "message": "retry specified assert"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MzI4Njc2", "url": "https://github.com/apache/kafka/pull/9778#pullrequestreview-558328676", "createdAt": "2020-12-24T04:20:17Z", "commit": {"oid": "4ace984d8caf7eb37a0ceea32dd3d8dc66513f19"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwNDoyMDoxN1rOIK-MMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwNDoyMDoxN1rOIK-MMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM3NTYwMQ==", "bodyText": "Could you add comment for this retry?", "url": "https://github.com/apache/kafka/pull/9778#discussion_r548375601", "createdAt": "2020-12-24T04:20:17Z", "author": {"login": "chia7712"}, "path": "core/src/test/scala/unit/kafka/server/ClientQuotasRequestTest.scala", "diffHunk": "@@ -212,7 +214,9 @@ class ClientQuotasRequestTest extends BaseRequestTest {\n           InetAddress.getByName(unknownHost)\n         else\n           InetAddress.getByName(entityName)\n-        assertEquals(expectedMatches(entity), servers.head.socketServer.connectionQuotas.connectionRateForIp(entityIp), 0.01)\n+        TestUtils.retry(10000L) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ace984d8caf7eb37a0ceea32dd3d8dc66513f19"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0815845bb45092ab25cd1d1a9687b637167408e", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/d0815845bb45092ab25cd1d1a9687b637167408e", "committedDate": "2020-12-24T04:30:36Z", "message": "add comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDAyMTQx", "url": "https://github.com/apache/kafka/pull/9778#pullrequestreview-559002141", "createdAt": "2020-12-28T05:37:00Z", "commit": {"oid": "d0815845bb45092ab25cd1d1a9687b637167408e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwNTozNzowMVrOILx0Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwNTozNzowMVrOILx0Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTIyMTM3OA==", "bodyText": "It seems to me waitUntilTrue is more suitable since the exception is not necessary in this test case.", "url": "https://github.com/apache/kafka/pull/9778#discussion_r549221378", "createdAt": "2020-12-28T05:37:01Z", "author": {"login": "chia7712"}, "path": "core/src/test/scala/unit/kafka/server/ClientQuotasRequestTest.scala", "diffHunk": "@@ -212,7 +214,10 @@ class ClientQuotasRequestTest extends BaseRequestTest {\n           InetAddress.getByName(unknownHost)\n         else\n           InetAddress.getByName(entityName)\n-        assertEquals(expectedMatches(entity), servers.head.socketServer.connectionQuotas.connectionRateForIp(entityIp), 0.01)\n+        TestUtils.retry(10000L) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0815845bb45092ab25cd1d1a9687b637167408e"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c5e25813057a0d70060676b17e7e7c4b100d3d1", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/2c5e25813057a0d70060676b17e7e7c4b100d3d1", "committedDate": "2020-12-28T14:55:11Z", "message": "waitUntilTure replace retry"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NDA4NDky", "url": "https://github.com/apache/kafka/pull/9778#pullrequestreview-559408492", "createdAt": "2020-12-29T07:28:39Z", "commit": {"oid": "2c5e25813057a0d70060676b17e7e7c4b100d3d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwNzoyODozOVrOIMI2PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwNzoyODozOVrOIMI2PQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU5ODc4MQ==", "bodyText": "Could we rename \"prop\" to \"quotas\"?", "url": "https://github.com/apache/kafka/pull/9778#discussion_r549598781", "createdAt": "2020-12-29T07:28:39Z", "author": {"login": "chia7712"}, "path": "core/src/test/scala/unit/kafka/server/ClientQuotasRequestTest.scala", "diffHunk": "@@ -212,7 +214,9 @@ class ClientQuotasRequestTest extends BaseRequestTest {\n           InetAddress.getByName(unknownHost)\n         else\n           InetAddress.getByName(entityName)\n-        assertEquals(expectedMatches(entity), servers.head.socketServer.connectionQuotas.connectionRateForIp(entityIp), 0.01)\n+        TestUtils.waitUntilTrue(\n+          () => expectedMatches(entity) - servers.head.socketServer.connectionQuotas.connectionRateForIp(entityIp) < 0.01\n+          ,\"Broker didn't update prop from Zookeeper\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c5e25813057a0d70060676b17e7e7c4b100d3d1"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79f5f054ee0e36a0ad91ed023e4ea3f696175da2", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/79f5f054ee0e36a0ad91ed023e4ea3f696175da2", "committedDate": "2020-12-29T09:23:08Z", "message": "change prop to quotas"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMDA0NTc0", "url": "https://github.com/apache/kafka/pull/9778#pullrequestreview-561004574", "createdAt": "2021-01-04T12:49:13Z", "commit": {"oid": "79f5f054ee0e36a0ad91ed023e4ea3f696175da2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxMjo0OToxM1rOINwkbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxMjo0OToxM1rOINwkbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI5ODE1OQ==", "bodyText": "We usually put the , at the end of the previous line when we break a line.\nCould we add the expected value and the current value in the message? We could say something like Expected connection quota $expected for $entity, got $actual.", "url": "https://github.com/apache/kafka/pull/9778#discussion_r551298159", "createdAt": "2021-01-04T12:49:13Z", "author": {"login": "dajac"}, "path": "core/src/test/scala/unit/kafka/server/ClientQuotasRequestTest.scala", "diffHunk": "@@ -212,7 +214,9 @@ class ClientQuotasRequestTest extends BaseRequestTest {\n           InetAddress.getByName(unknownHost)\n         else\n           InetAddress.getByName(entityName)\n-        assertEquals(expectedMatches(entity), servers.head.socketServer.connectionQuotas.connectionRateForIp(entityIp), 0.01)\n+        TestUtils.waitUntilTrue(\n+          () => expectedMatches(entity) - servers.head.socketServer.connectionQuotas.connectionRateForIp(entityIp) < 0.01\n+          ,\"Broker didn't update quotas from Zookeeper\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79f5f054ee0e36a0ad91ed023e4ea3f696175da2"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1b9277c5d46bf18d262382f8121639bb813c60d", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/a1b9277c5d46bf18d262382f8121639bb813c60d", "committedDate": "2021-01-04T17:35:27Z", "message": "fix compare value  , add message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e8c744a13a99982ae08a350129e00aae3f79823", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/8e8c744a13a99982ae08a350129e00aae3f79823", "committedDate": "2021-01-06T17:03:18Z", "message": "fix error message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMzAwMzQ1", "url": "https://github.com/apache/kafka/pull/9778#pullrequestreview-563300345", "createdAt": "2021-01-07T08:44:29Z", "commit": {"oid": "8e8c744a13a99982ae08a350129e00aae3f79823"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2370, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}