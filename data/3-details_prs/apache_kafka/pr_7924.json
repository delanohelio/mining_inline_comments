{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMjA2MjMw", "number": 7924, "title": "MINOR: Remove updatePartitionReplicaAssignment from ControllerContext", "bodyText": "The method updatePartitionReplicaAssignment allows the user to direcly\nmodify the replicas assigned to a partition without also modifying the\naddingReplicas and removingReplicas fields. This is not a safe operation\nfor all inputs.\nClients should instead use updatePartitionFullReplicaAssignment.\nMore detailed description of your change,\nif necessary. The PR title and PR message become\nthe squashed commit message, so use a separate\ncomment to ping reviewers.\nSummary of testing strategy (including rationale)\nfor the feature or bug fix. Unit and/or integration\ntests are expected for any behaviour change and\nsystem tests should be considered for larger changes.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-01-09T23:21:40Z", "url": "https://github.com/apache/kafka/pull/7924", "merged": true, "mergeCommit": {"oid": "36805b8ba9803a44775a5eb711ac9d763c71598e"}, "closed": true, "closedAt": "2020-01-11T04:21:45Z", "author": {"login": "jsancio"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4yZoKAH2gAyMzYxMjA2MjMwOjEzNzU2M2UxOWUxYzExNmVkYzA4MThlNTdiN2MxYjRmN2M5N2QxMTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb5HpebgFqTM0MTQ4MTExOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "137563e19e1c116edc0818e57b7c1b4f7c97d115", "author": {"user": {"login": "jsancio", "name": "Jos\u00e9 Armando Garc\u00eda Sancio"}}, "url": "https://github.com/apache/kafka/commit/137563e19e1c116edc0818e57b7c1b4f7c97d115", "committedDate": "2020-01-09T23:17:56Z", "message": "MINOR: Remove updatePartitionReplicaAssignment from ControllerContext\n\nThe method updatePartitionReplicaAssignment allows the user to direcly\nmodify the replicas assigned to a partition without also modifying the\naddingReplicas and removingReplicas fields. This is not a safe operation\nfor all inputs.\n\nClients should instead use updatePartitionFullReplicaAssignment."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwODc2ODgx", "url": "https://github.com/apache/kafka/pull/7924#pullrequestreview-340876881", "createdAt": "2020-01-09T23:22:45Z", "commit": {"oid": "137563e19e1c116edc0818e57b7c1b4f7c97d115"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQyMzoyMjo0NVrOFcGVsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQyMzoyMzo0M1rOFcGW3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTAwODMwNQ==", "bodyText": "This method was not used by the controller after we introduced reassignTo. This functionality was moved to reassignTo.", "url": "https://github.com/apache/kafka/pull/7924#discussion_r365008305", "createdAt": "2020-01-09T23:22:45Z", "author": {"login": "jsancio"}, "path": "core/src/main/scala/kafka/controller/ControllerContext.scala", "diffHunk": "@@ -23,18 +23,11 @@ import org.apache.kafka.common.TopicPartition\n import scala.collection.{Map, Seq, Set, mutable}\n \n object ReplicaAssignment {\n-  def fromOldAndNewReplicas(oldReplicas: Seq[Int], newReplicas: Seq[Int]): ReplicaAssignment = {\n-    val fullReplicaSet = (newReplicas ++ oldReplicas).distinct\n-    ReplicaAssignment(\n-      fullReplicaSet,\n-      fullReplicaSet.diff(oldReplicas),\n-      fullReplicaSet.diff(newReplicas)\n-    )\n-  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "137563e19e1c116edc0818e57b7c1b4f7c97d115"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTAwODYwNw==", "bodyText": "The bulk of this change is the removal of this method and the changes related to this removal.", "url": "https://github.com/apache/kafka/pull/7924#discussion_r365008607", "createdAt": "2020-01-09T23:23:43Z", "author": {"login": "jsancio"}, "path": "core/src/main/scala/kafka/controller/ControllerContext.scala", "diffHunk": "@@ -126,29 +132,8 @@ class ControllerContext {\n   }\n \n   def partitionFullReplicaAssignment(topicPartition: TopicPartition): ReplicaAssignment = {\n-    partitionAssignments.getOrElse(topicPartition.topic, mutable.Map.empty).get(topicPartition.partition) match {\n-      case Some(partitionAssignment) => partitionAssignment\n-      case None => ReplicaAssignment(Seq(), Seq(), Seq())\n-    }\n-  }\n-\n-  def updatePartitionReplicaAssignment(topicPartition: TopicPartition, newReplicas: Seq[Int]): Unit = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "137563e19e1c116edc0818e57b7c1b4f7c97d115"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMzM5MDEy", "url": "https://github.com/apache/kafka/pull/7924#pullrequestreview-341339012", "createdAt": "2020-01-10T18:20:59Z", "commit": {"oid": "137563e19e1c116edc0818e57b7c1b4f7c97d115"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNDQwNTgw", "url": "https://github.com/apache/kafka/pull/7924#pullrequestreview-341440580", "createdAt": "2020-01-10T21:49:10Z", "commit": {"oid": "137563e19e1c116edc0818e57b7c1b4f7c97d115"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQyMTo0OToxMFrOFcg72A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQyMTo1Njo0M1rOFchE9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ0NDA1Ng==", "bodyText": "nit: is this conventional? I don't think we use this ordering anywhere else in the code?", "url": "https://github.com/apache/kafka/pull/7924#discussion_r365444056", "createdAt": "2020-01-10T21:49:10Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/controller/ControllerContext.scala", "diffHunk": "@@ -44,9 +37,9 @@ object ReplicaAssignment {\n  * @param addingReplicas the replicas that are being added if there is a pending reassignment\n  * @param removingReplicas the replicas that are being removed if there is a pending reassignment\n  */\n-case class ReplicaAssignment(replicas: Seq[Int],\n-                             addingReplicas: Seq[Int],\n-                             removingReplicas: Seq[Int]) {\n+case class ReplicaAssignment private (replicas: Seq[Int],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "137563e19e1c116edc0818e57b7c1b4f7c97d115"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ0NjM4OQ==", "bodyText": "This code smells a bit (not from this PR). Feels like we need to refetch the assignment state in order to confirm whether the replicaId should be there or not. I guess after zk removal, the controller context will be guaranteed to be up to date and we can improve this.", "url": "https://github.com/apache/kafka/pull/7924#discussion_r365446389", "createdAt": "2020-01-10T21:56:43Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/controller/ReplicaStateMachine.scala", "diffHunk": "@@ -192,9 +192,11 @@ class ZkReplicaStateMachine(config: KafkaConfig,\n \n           currentState match {\n             case NewReplica =>\n-              val assignment = controllerContext.partitionReplicaAssignment(partition)\n-              if (!assignment.contains(replicaId)) {\n-                controllerContext.updatePartitionReplicaAssignment(partition, assignment :+ replicaId)\n+              val assignment = controllerContext.partitionFullReplicaAssignment(partition)\n+              if (!assignment.replicas.contains(replicaId)) {\n+                error(s\"Adding replica ($replicaId) that is not part of the assignment $assignment\")\n+                val newAssignment = assignment.copy(replicas = assignment.replicas :+ replicaId)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "137563e19e1c116edc0818e57b7c1b4f7c97d115"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNDgxMTE4", "url": "https://github.com/apache/kafka/pull/7924#pullrequestreview-341481118", "createdAt": "2020-01-11T00:03:15Z", "commit": {"oid": "137563e19e1c116edc0818e57b7c1b4f7c97d115"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1923, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}