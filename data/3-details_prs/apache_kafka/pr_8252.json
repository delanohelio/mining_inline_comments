{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MTkzMzEz", "number": 8252, "title": "KAFKA-6145: Pt 2.5 Compute overall task lag per client", "bodyText": "Once we have encoded the offset sums per task for each client, we can compute the overall lag during assign by fetching the end offsets for all changelog and subtracting.\nIf the listOffsets request fails, we simply return a \"completely sticky\" assignment, ie all active tasks are given to previous owners regardless of balance.\nBuilds (but does not yet use) the statefulTasksToRankedCandidates map with the ranking:\nRank -1:    active running task\nRank 0:     standby or restoring task whose overall lag is within acceptableRecoveryLag\nRank 1:      tasks whose lag is unknown (eg during version probing)\nRank 1+:    all other tasks are ranked according to their actual total lag", "createdAt": "2020-03-07T21:08:09Z", "url": "https://github.com/apache/kafka/pull/8252", "merged": true, "mergeCommit": {"oid": "6cf27c9c771900baf43cc47f9b010dbf7a86fa22"}, "closed": true, "closedAt": "2020-03-21T18:40:35Z", "author": {"login": "ableegoldman"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOSL49ABqjMxMzQ0MDYzMTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPpKFSAH2gAyMzg1MTkzMzEzOmUzZGMyYTUyMzc4ZWZlN2JiMTExOTgyYzcyNTc2MGJiNGU3YTFlOWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "d83f64be9f93ce9d0f79a23d089042dd3de1f269", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/d83f64be9f93ce9d0f79a23d089042dd3de1f269", "committedDate": "2020-03-19T18:32:43Z", "message": "get admin from assignor config and add offset sums to ClientState\nfetch end offsets\nadd lag to each clienttate\nbuild ranks\nadd ClientState tests\nadd tests for building client rankings\nfall back to prev assignment if fetching offsets fails"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "c937bfb6e4ff1a3f1ebb558ba7a9aad2baf9fdd4", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/c937bfb6e4ff1a3f1ebb558ba7a9aad2baf9fdd4", "committedDate": "2020-03-20T19:24:42Z", "message": "get admin from assignor config and add offset sums to ClientState\nfetch end offsets\nadd lag to each clienttate\nbuild ranks\nadd ClientState tests\nadd tests for building client rankings\nfall back to prev assignment if fetching offsets fails"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "a86546e386fa885fba55c68bb6ee9d529c0e8329", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/a86546e386fa885fba55c68bb6ee9d529c0e8329", "committedDate": "2020-03-20T19:26:07Z", "message": "rank UNKNOWN_OFFSET_SUM behind caught-up clients, but above others"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e67aaef709572c7320869e38e23fac0fef87e354", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/e67aaef709572c7320869e38e23fac0fef87e354", "committedDate": "2020-03-20T19:26:07Z", "message": "can't resist further assignor test cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a5f53faff235167d05c18b7ceb06cbf12b44af5", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/5a5f53faff235167d05c18b7ceb06cbf12b44af5", "committedDate": "2020-03-20T19:26:07Z", "message": "don't violate active task stickiness if offset fetch fails and add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cf72e06965a476424cd40f213958c67306f66ea", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/3cf72e06965a476424cd40f213958c67306f66ea", "committedDate": "2020-03-20T19:26:07Z", "message": "timeout admin client request"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "3cf72e06965a476424cd40f213958c67306f66ea", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/3cf72e06965a476424cd40f213958c67306f66ea", "committedDate": "2020-03-20T19:26:07Z", "message": "timeout admin client request"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MDA3NzM3", "url": "https://github.com/apache/kafka/pull/8252#pullrequestreview-378007737", "createdAt": "2020-03-19T18:57:04Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxODo1NzowNFrOF48PpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMTo0NDowNFrOF5kBIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI1MTYyMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                default ListOffsetsResult  listOffsets(Map<TopicPartition, OffsetSpec> topicPartitionOffsets) {\n          \n          \n            \n                default ListOffsetsResult listOffsets(Map<TopicPartition, OffsetSpec> topicPartitionOffsets) {", "url": "https://github.com/apache/kafka/pull/8252#discussion_r395251621", "createdAt": "2020-03-19T18:57:04Z", "author": {"login": "vvcephei"}, "path": "clients/src/main/java/org/apache/kafka/clients/admin/Admin.java", "diffHunk": "@@ -1119,7 +1119,7 @@ default AlterConsumerGroupOffsetsResult alterConsumerGroupOffsets(String groupId\n      * @param topicPartitionOffsets The mapping from partition to the OffsetSpec to look up.\n      * @return The ListOffsetsResult.\n      */\n-    default ListOffsetsResult listOffsets(Map<TopicPartition, OffsetSpec> topicPartitionOffsets) {\n+    default ListOffsetsResult  listOffsets(Map<TopicPartition, OffsetSpec> topicPartitionOffsets) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg3OTYyNg==", "bodyText": "The fact that this is static and has nothing in particular to do with the KafkaStreams class indicates that it probably belongs in a util class for use by KafkaStreams and StreamsPartitionAssignor.", "url": "https://github.com/apache/kafka/pull/8252#discussion_r395879626", "createdAt": "2020-03-20T20:40:50Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -1244,4 +1238,28 @@ public void cleanUp() {\n \n         return Collections.unmodifiableMap(localStorePartitionLags);\n     }\n+\n+    static Map<TopicPartition, ListOffsetsResultInfo> fetchEndOffsetsWithoutTimeout(final Collection<TopicPartition> partitions,\n+                                                                                    final Admin adminClient) {\n+        return fetchEndOffsets(partitions, adminClient, null);\n+    }\n+\n+    public static Map<TopicPartition, ListOffsetsResultInfo> fetchEndOffsets(final Collection<TopicPartition> partitions,\n+                                                                             final Admin adminClient,\n+                                                                             final Duration timeout) {\n+        final Map<TopicPartition, ListOffsetsResultInfo> endOffsets;\n+        try {\n+            final KafkaFuture<Map<TopicPartition, ListOffsetsResultInfo>> future =  adminClient.listOffsets(\n+                partitions.stream().collect(Collectors.toMap(Function.identity(), tp -> OffsetSpec.latest())))\n+                                                                                        .all();\n+            if (timeout == null) {\n+                endOffsets = future.get();\n+            } else {\n+                endOffsets = future.get(timeout.toMillis(), TimeUnit.MILLISECONDS);\n+            }\n+        } catch (final TimeoutException | RuntimeException | InterruptedException | ExecutionException e) {\n+            throw new StreamsException(\"Unable to obtain end offsets from kafka\", e);\n+        }\n+        return endOffsets;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cf72e06965a476424cd40f213958c67306f66ea"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg4Njg3Ng==", "bodyText": "I couldn't find the reason these needed to change. What did I miss? Is it just that they are nullable if the config is unspecified?", "url": "https://github.com/apache/kafka/pull/8252#discussion_r395886876", "createdAt": "2020-03-20T20:58:41Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/assignment/AssignorConfiguration.java", "diffHunk": "@@ -263,11 +276,11 @@ public AssignmentConfigs getAssignmentConfigs() {\n     }\n \n     public static class AssignmentConfigs {\n-        public final long acceptableRecoveryLag;\n-        public final int balanceFactor;\n-        public final int maxWarmupReplicas;\n-        public final int numStandbyReplicas;\n-        public final long probingRebalanceIntervalMs;\n+        public final Long acceptableRecoveryLag;\n+        public final Integer balanceFactor;\n+        public final Integer maxWarmupReplicas;\n+        public final Integer numStandbyReplicas;\n+        public final Long probingRebalanceIntervalMs;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cf72e06965a476424cd40f213958c67306f66ea"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwMzI2NA==", "bodyText": "Does this test pass on the current code base, or is it a consequence of this PR?", "url": "https://github.com/apache/kafka/pull/8252#discussion_r395903264", "createdAt": "2020-03-20T21:44:04Z", "author": {"login": "vvcephei"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/assignment/StickyTaskAssignorTest.java", "diffHunk": "@@ -674,6 +674,19 @@ public void shouldAssignTasksToNewClientWithoutFlippingAssignmentBetweenExisting\n         assertThat(newClient.activeTaskCount(), equalTo(2));\n     }\n \n+    @Test\n+    public void shouldViolateBalanceToPreserveActiveTaskStickiness() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cf72e06965a476424cd40f213958c67306f66ea"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb5ea3000bb0e02413da92f2a7cf162809e4d31b", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/bb5ea3000bb0e02413da92f2a7cf162809e4d31b", "committedDate": "2020-03-20T22:46:07Z", "message": "remove extra space"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3dc2a52378efe7bb111982c725760bb4e7a1e9d", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/e3dc2a52378efe7bb111982c725760bb4e7a1e9d", "committedDate": "2020-03-20T23:32:04Z", "message": "unbox assignment configs"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 160, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}