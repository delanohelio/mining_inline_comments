{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNDYyMjQ0", "number": 9617, "title": "MINOR: Factor out common response parsing logic", "bodyText": "This patch factors out some common parsing logic from NetworkClient.parseResponse and AbstractResponse.parseResponse. As a result of this refactor, we are now verifying the correlationId in forwarded requests. This patch also adds a test case to verify handling in this case.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-11-18T20:50:08Z", "url": "https://github.com/apache/kafka/pull/9617", "merged": true, "mergeCommit": {"oid": "438749bb5d78f2ca34aaf306739f210794f8e3f9"}, "closed": true, "closedAt": "2020-11-20T03:00:53Z", "author": {"login": "hachikuji"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddyRWzgH2gAyNTIzNDYyMjQ0OmY4N2RhMGFjZjk5YzljMjU0ODZmZDU0Y2U5ZDQyOWI1ZmYwOTVhMjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeG8UugH2gAyNTIzNDYyMjQ0OjUxODZmMGY2NDY1MjZhMGU3NDg4ODA1ZDFlMzNkYzliY2M4NzI4YWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f87da0acf99c9c25486fd54ce9d429b5ff095a27", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/f87da0acf99c9c25486fd54ce9d429b5ff095a27", "committedDate": "2020-11-18T18:15:15Z", "message": "MINOR: Factor out common response parsing logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4ef6275e068991643b27402e540f5c3de934dd5", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/f4ef6275e068991643b27402e540f5c3de934dd5", "committedDate": "2020-11-18T20:47:19Z", "message": "Add test case for mismatched correlationId for forwarded request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3fae878b46fe147ac33c5979a11b72df5b3013f", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/d3fae878b46fe147ac33c5979a11b72df5b3013f", "committedDate": "2020-11-18T21:04:16Z", "message": "Remove unused `correlate` method in `NetworkClient`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTY4MDIy", "url": "https://github.com/apache/kafka/pull/9617#pullrequestreview-533968022", "createdAt": "2020-11-18T23:37:05Z", "commit": {"oid": "d3fae878b46fe147ac33c5979a11b72df5b3013f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzozNzowNlrOH2GpTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzo1MTozOFrOH2G-sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5NDAyOA==", "bodyText": "nit: we could put this exception into common/internals to indicate that we don't plan to let external user catch it.", "url": "https://github.com/apache/kafka/pull/9617#discussion_r526494028", "createdAt": "2020-11-18T23:37:06Z", "author": {"login": "abbccdda"}, "path": "clients/src/main/java/org/apache/kafka/common/requests/CorrelationIdMismatchException.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.requests;\n+\n+/**\n+ * Raised if the correlationId in a response header does not match\n+ * the expected value from the request header.\n+ */\n+public class CorrelationIdMismatchException extends IllegalStateException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3fae878b46fe147ac33c5979a11b72df5b3013f"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5NDIyMg==", "bodyText": "This field is not used.", "url": "https://github.com/apache/kafka/pull/9617#discussion_r526494222", "createdAt": "2020-11-18T23:37:39Z", "author": {"login": "abbccdda"}, "path": "clients/src/main/java/org/apache/kafka/common/requests/CorrelationIdMismatchException.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.requests;\n+\n+/**\n+ * Raised if the correlationId in a response header does not match\n+ * the expected value from the request header.\n+ */\n+public class CorrelationIdMismatchException extends IllegalStateException {\n+    private final int requestCorrelationId;\n+    private final int responseCorrelationId;\n+\n+    public CorrelationIdMismatchException(\n+        String message,\n+        int requestCorrelationId,\n+        int responseCorrelationId\n+    ) {\n+        super(message);\n+        this.requestCorrelationId = requestCorrelationId;\n+        this.responseCorrelationId = responseCorrelationId;\n+    }\n+\n+    public int requestCorrelationId() {\n+        return requestCorrelationId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3fae878b46fe147ac33c5979a11b72df5b3013f"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5OTUwNQ==", "bodyText": "nit: I don't think we need to remove this helper", "url": "https://github.com/apache/kafka/pull/9617#discussion_r526499505", "createdAt": "2020-11-18T23:51:38Z", "author": {"login": "abbccdda"}, "path": "clients/src/main/java/org/apache/kafka/clients/NetworkClient.java", "diffHunk": "@@ -974,21 +969,6 @@ private void handleInitiateApiVersionRequests(long now) {\n         }\n     }\n \n-    /**\n-     * Validate that the response corresponds to the request we expect or else explode\n-     */\n-    private static void correlate(RequestHeader requestHeader, ResponseHeader responseHeader) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3fae878b46fe147ac33c5979a11b72df5b3013f"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDYyNzEy", "url": "https://github.com/apache/kafka/pull/9617#pullrequestreview-534062712", "createdAt": "2020-11-19T03:51:12Z", "commit": {"oid": "d3fae878b46fe147ac33c5979a11b72df5b3013f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMzo1MToxMlrOH2Lt3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMzo1MToxMlrOH2Lt3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU3NzExNg==", "bodyText": "As ForwardingManager does not extend BrokerToControllerChannelManagerImpl, the requestQueue can be declared as private now.\nhttps://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/server/BrokerToControllerChannelManagerImpl.scala#L58", "url": "https://github.com/apache/kafka/pull/9617#discussion_r526577116", "createdAt": "2020-11-19T03:51:12Z", "author": {"login": "chia7712"}, "path": "core/src/main/scala/kafka/server/ForwardingManager.scala", "diffHunk": "@@ -17,25 +17,17 @@\n \n package kafka.server\n \n-import kafka.metrics.KafkaMetricsGroup\n+import java.nio.ByteBuffer\n+\n import kafka.network.RequestChannel\n+import kafka.utils.Logging\n import org.apache.kafka.clients.ClientResponse\n-import org.apache.kafka.common.metrics.Metrics\n import org.apache.kafka.common.protocol.Errors\n-import org.apache.kafka.common.requests.{AbstractRequest, AbstractResponse, EnvelopeRequest, EnvelopeResponse}\n-import org.apache.kafka.common.utils.Time\n+import org.apache.kafka.common.requests.{AbstractRequest, AbstractResponse, EnvelopeRequest, EnvelopeResponse, RequestHeader}\n \n import scala.compat.java8.OptionConverters._\n \n-class ForwardingManager(metadataCache: kafka.server.MetadataCache,\n-                        time: Time,\n-                        metrics: Metrics,\n-                        config: KafkaConfig,\n-                        threadNamePrefix: Option[String] = None) extends\n-  BrokerToControllerChannelManagerImpl(metadataCache, time, metrics,\n-    config, \"forwardingChannel\", threadNamePrefix) with KafkaMetricsGroup {\n-\n-  private val forwardingMetricName = \"NumRequestsForwardingToControllerPerSec\"\n+class ForwardingManager(channelManager: BrokerToControllerChannelManager) extends Logging {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3fae878b46fe147ac33c5979a11b72df5b3013f"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5186f0f646526a0e7488805d1e33dc9bcc8728ac", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/5186f0f646526a0e7488805d1e33dc9bcc8728ac", "committedDate": "2020-11-19T18:20:17Z", "message": "Reduce visibility of request queue"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2823, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}