{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1MDA2OTc2", "number": 8108, "title": "KAFKA-9533: ValueTransform forwards `null` values", "bodyText": "Fixes a bug where KStream#transformValues would forward null values from the provided ValueTransform#transform operation.\nA test was added for verification KStreamTransformValuesTest#shouldEmitNoRecordIfTransformReturnsNull. A parallel test for non-key ValueTransformer was not added, as they share the same code path.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-02-13T17:51:14Z", "url": "https://github.com/apache/kafka/pull/8108", "merged": true, "mergeCommit": {"oid": "a41d3d86c13a55a75e67b1635bc74361ebe6d7af"}, "closed": true, "closedAt": "2020-02-19T21:20:36Z", "author": {"login": "mviamari"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFTdEXgFqTM1OTk1NTMxNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcF5vARAH2gAyMzc1MDA2OTc2OjMzYWFkZDcwMzZmYTA0YTk3ZGY1NDAzMWMzM2IxZGY2MWZkODZiNTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5OTU1MzE0", "url": "https://github.com/apache/kafka/pull/8108#pullrequestreview-359955314", "createdAt": "2020-02-17T20:35:39Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5OTYxNTU2", "url": "https://github.com/apache/kafka/pull/8108#pullrequestreview-359961556", "createdAt": "2020-02-17T20:54:48Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMDo1NDo0OFrOFqvf2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMToxNDozMFrOFqv0cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM2MjcxMw==", "bodyText": "req: Please add a unit test in KStreamTransformValuesTest instead of this integration test. A unit test is simpler to maintain in this case. Have a look at KStreamFlatTransformValuesTest#shouldEmitNoRecordIfTransformReturnsNull() for an example.", "url": "https://github.com/apache/kafka/pull/8108#discussion_r380362713", "createdAt": "2020-02-17T20:54:48Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/KStreamTransformIntegrationTest.java", "diffHunk": "@@ -244,6 +244,43 @@ public void close() {\n         verifyResult(expected);\n     }\n \n+    @Test\n+    public void shouldNotFowardNullTransformValuesWithValueTransformerWithKey() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM2Nzk4NQ==", "bodyText": "req: Please use 4 spaces indentation.", "url": "https://github.com/apache/kafka/pull/8108#discussion_r380367985", "createdAt": "2020-02-17T21:14:30Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/KStreamTransformIntegrationTest.java", "diffHunk": "@@ -244,6 +244,43 @@ public void close() {\n         verifyResult(expected);\n     }\n \n+    @Test\n+    public void shouldNotFowardNullTransformValuesWithValueTransformerWithKey() {\n+        stream\n+                .transformValues(() -> new ValueTransformerWithKey<Integer, Integer, Integer>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4589d0703592b4f27fa8c541a25acaa5cf31718", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/b4589d0703592b4f27fa8c541a25acaa5cf31718", "committedDate": "2020-02-17T23:05:43Z", "message": "Fixes KAFKA-9533: ValueTransform forwards `null` values\n\n* Fix for KStreamTransformValues to filter `null` values returned from ValueTransformer\n* Tests for `shouldNotForwardNullTransformValuesWithValueTransformerWithKey()`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8efedf8d78fd2742f0c702f14ab1007c023a783b", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/8efedf8d78fd2742f0c702f14ab1007c023a783b", "committedDate": "2020-02-17T23:05:43Z", "message": "Replace integration test with unit test\n\n* Remove integration test KStreamTransformIntegrationTest#esWithValueTransformerWithKey\n* Add unit test KStreamTransformValuesTest#shouldEmitNoRecordIfTransformReturnsNull"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "8efedf8d78fd2742f0c702f14ab1007c023a783b", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/8efedf8d78fd2742f0c702f14ab1007c023a783b", "committedDate": "2020-02-17T23:05:43Z", "message": "Replace integration test with unit test\n\n* Remove integration test KStreamTransformIntegrationTest#esWithValueTransformerWithKey\n* Add unit test KStreamTransformValuesTest#shouldEmitNoRecordIfTransformReturnsNull"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMTg5OTU4", "url": "https://github.com/apache/kafka/pull/8108#pullrequestreview-360189958", "createdAt": "2020-02-18T09:38:13Z", "commit": {"oid": "8efedf8d78fd2742f0c702f14ab1007c023a783b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwOTozODoxM1rOFq7TNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwOTozODoxM1rOFq7TNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU1NjA4Nw==", "bodyText": "req: I guess, I was not clear enough in my previous comment. Sorry for that! I see that the other unit tests in KStreamTransformValuesTest are also TopologyTestDriver tests. However, I think that is not needed in this case. TopologyTestDriver tests are harder to maintain and slower to run as a simple unit test like KStreamFlatTransformValuesTest#shouldEmitNoRecordIfTransformReturnsNull(). We need to rewrite TopologyTestDriver tests in KStreamTransformValueTest to simple unit tests at some point (not in this PR). Please use a simple unit test similar to the following.\n    @Test\n    public void shouldEmitNoRecordIfTransformReturnsNull() {\n        final ProcessorContext context = mock(ProcessorContext.class);\n        final ValueTransformerWithKey<Integer, Integer, Iterable<String>> valueTransformer = mock(ValueTransformerWithKey.class);\n        EasyMock.expect(valueTransformer.transform(inputKey, inputValue)).andReturn(null);\n        EasyMock.replay(context, valueTransfomer);\n        final Integer inputKey = 1;\n        final Integer inputValue = 10;\n        final KStreamFlatTransformValuesProcessor<Integer, Integer, String> processor = new KStreamFlatTransformValuesProcessor<>(valueTransformer);\n        processor.init(context);\n\n        processor.process(inputKey, inputValue);\n\n        EasyMock.verify(context, valueTransformer);\n    }", "url": "https://github.com/apache/kafka/pull/8108#discussion_r380556087", "createdAt": "2020-02-18T09:38:13Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamTransformValuesTest.java", "diffHunk": "@@ -138,6 +138,54 @@ public void close() { }\n         assertArrayEquals(expected, supplier.theCapturedProcessor().processed.toArray());\n     }\n \n+    @Test\n+    public void shouldEmitNoRecordIfTransformReturnsNull() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8efedf8d78fd2742f0c702f14ab1007c023a783b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e835f4787a4591bdcab28521b0ba9a83aeee3706", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/e835f4787a4591bdcab28521b0ba9a83aeee3706", "committedDate": "2020-02-18T17:05:33Z", "message": "update KStreamTransformValuesTest#shouldEmitNoRecordIfTransformReturnsNull to use EasyMock instead of TestDriver."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNTg2ODE4", "url": "https://github.com/apache/kafka/pull/8108#pullrequestreview-360586818", "createdAt": "2020-02-18T18:51:47Z", "commit": {"oid": "e835f4787a4591bdcab28521b0ba9a83aeee3706"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODo1MTo0OFrOFrORpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODo1Njo1NFrOFrOcpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2Njk4MQ==", "bodyText": "req: Could you please remove context from the reset()? Since we did not specify any behavior for it, we also do not need to reset it.", "url": "https://github.com/apache/kafka/pull/8108#discussion_r380866981", "createdAt": "2020-02-18T18:51:48Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamTransformValuesTest.java", "diffHunk": "@@ -138,6 +140,24 @@ public void close() { }\n         assertArrayEquals(expected, supplier.theCapturedProcessor().processed.toArray());\n     }\n \n+    @Test\n+    public void shouldEmitNoRecordIfTransformReturnsNull() {\n+        final ProcessorContext context = mock(ProcessorContext.class);\n+        final ValueTransformerWithKey<Integer, Integer, Integer> valueTransformer = mock(ValueTransformerWithKey.class);\n+        final KStreamTransformValues.KStreamTransformValuesProcessor<Integer, Integer, Integer> processor = new KStreamTransformValues.KStreamTransformValuesProcessor<>(valueTransformer);\n+        processor.init(context);\n+        EasyMock.reset(context, valueTransformer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e835f4787a4591bdcab28521b0ba9a83aeee3706"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2ODIzMw==", "bodyText": "req: Could you please put new KStreamTransformValues... in the next line?", "url": "https://github.com/apache/kafka/pull/8108#discussion_r380868233", "createdAt": "2020-02-18T18:54:02Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamTransformValuesTest.java", "diffHunk": "@@ -138,6 +140,24 @@ public void close() { }\n         assertArrayEquals(expected, supplier.theCapturedProcessor().processed.toArray());\n     }\n \n+    @Test\n+    public void shouldEmitNoRecordIfTransformReturnsNull() {\n+        final ProcessorContext context = mock(ProcessorContext.class);\n+        final ValueTransformerWithKey<Integer, Integer, Integer> valueTransformer = mock(ValueTransformerWithKey.class);\n+        final KStreamTransformValues.KStreamTransformValuesProcessor<Integer, Integer, Integer> processor = new KStreamTransformValues.KStreamTransformValuesProcessor<>(valueTransformer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e835f4787a4591bdcab28521b0ba9a83aeee3706"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2ODUyNA==", "bodyText": "req: Could you please replace .andReturn() with .andStubReturn()? This avoids the verification of the call to valueTransformer.transform(inputKey, inputValue) which I consider setup and not validation.", "url": "https://github.com/apache/kafka/pull/8108#discussion_r380868524", "createdAt": "2020-02-18T18:54:36Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamTransformValuesTest.java", "diffHunk": "@@ -138,6 +140,24 @@ public void close() { }\n         assertArrayEquals(expected, supplier.theCapturedProcessor().processed.toArray());\n     }\n \n+    @Test\n+    public void shouldEmitNoRecordIfTransformReturnsNull() {\n+        final ProcessorContext context = mock(ProcessorContext.class);\n+        final ValueTransformerWithKey<Integer, Integer, Integer> valueTransformer = mock(ValueTransformerWithKey.class);\n+        final KStreamTransformValues.KStreamTransformValuesProcessor<Integer, Integer, Integer> processor = new KStreamTransformValues.KStreamTransformValuesProcessor<>(valueTransformer);\n+        processor.init(context);\n+        EasyMock.reset(context, valueTransformer);\n+\n+        final Integer inputKey = 1;\n+        final Integer inputValue = 10;\n+        EasyMock.expect(valueTransformer.transform(inputKey, inputValue)).andReturn(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e835f4787a4591bdcab28521b0ba9a83aeee3706"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2OTc5Nw==", "bodyText": "req: Since we do not need to validate valueTransformer, could you please remove it from the verify().", "url": "https://github.com/apache/kafka/pull/8108#discussion_r380869797", "createdAt": "2020-02-18T18:56:54Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamTransformValuesTest.java", "diffHunk": "@@ -138,6 +140,24 @@ public void close() { }\n         assertArrayEquals(expected, supplier.theCapturedProcessor().processed.toArray());\n     }\n \n+    @Test\n+    public void shouldEmitNoRecordIfTransformReturnsNull() {\n+        final ProcessorContext context = mock(ProcessorContext.class);\n+        final ValueTransformerWithKey<Integer, Integer, Integer> valueTransformer = mock(ValueTransformerWithKey.class);\n+        final KStreamTransformValues.KStreamTransformValuesProcessor<Integer, Integer, Integer> processor = new KStreamTransformValues.KStreamTransformValuesProcessor<>(valueTransformer);\n+        processor.init(context);\n+        EasyMock.reset(context, valueTransformer);\n+\n+        final Integer inputKey = 1;\n+        final Integer inputValue = 10;\n+        EasyMock.expect(valueTransformer.transform(inputKey, inputValue)).andReturn(null);\n+        EasyMock.replay(context, valueTransformer);\n+\n+        processor.process(inputKey, inputValue);\n+\n+        EasyMock.verify(context, valueTransformer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e835f4787a4591bdcab28521b0ba9a83aeee3706"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61de6083b3fbbcf93b70e22bdbb233b88eb411c0", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/61de6083b3fbbcf93b70e22bdbb233b88eb411c0", "committedDate": "2020-02-18T20:33:53Z", "message": "fix usage of mocks in KStreamTransformValuesTest#shouldEmitNoRecordIfTransformReturnsNull"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwOTc4Mzg2", "url": "https://github.com/apache/kafka/pull/8108#pullrequestreview-360978386", "createdAt": "2020-02-19T09:59:56Z", "commit": {"oid": "61de6083b3fbbcf93b70e22bdbb233b88eb411c0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33aadd7036fa04a97df54031c33b1df61fd86b53", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/33aadd7036fa04a97df54031c33b1df61fd86b53", "committedDate": "2020-02-19T17:11:38Z", "message": "remove uneeded Easymock#reset"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1879, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}