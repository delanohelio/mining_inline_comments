{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNjY2MDMy", "number": 9317, "title": "KAFKA-10509: Added throttle connection accept rate metric (KIP-612)", "bodyText": "This PR adds metric to track throttle time of connection accept rate (when hitting connection attempt rate quota), which is a part of KIP-612:\n\nkafka.network:type=socket-server-metrics,name=connection-accept-throttle-time,listener={listenerName}\nType: SampledStat.Avg\nDescription: Average throttle time due to violating per-listener or broker-wide connection acceptance rate quota on a given listener.\n\nThis PR also does 2 fixes:\n\nEnsures that per-listener connection quotas are configured on broker startup (from static broker config, if one is set).\nReduces quota values used in testDynamicListenerConnectionCreationRateQuota test, and the duration of verifyConnectionRate (that creates connections and verifies rate). We observed once that this test exhausted ephemeral port count. I reduced quotas used in this test by half, since this does not change the correctness of the test, while it also reduces the number of connections made by this test.\n\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-09-22T03:18:42Z", "url": "https://github.com/apache/kafka/pull/9317", "merged": true, "mergeCommit": {"oid": "ae2304f27c5a099b52cc9dd707fc237576deada0"}, "closed": true, "closedAt": "2020-09-28T19:30:26Z", "author": {"login": "apovzner"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLUIBeAFqTQ5MzI0NTg5NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNYuzxAFqTQ5NzgzMDkwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMjQ1ODk0", "url": "https://github.com/apache/kafka/pull/9317#pullrequestreview-493245894", "createdAt": "2020-09-22T08:45:53Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo0NTo1M1rOHVwGPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo1Mzo0NVrOHVwZPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3MDE3NQ==", "bodyText": "It is a bit annoying that we have to lookup the ListenerConnectionQuota twice. Once in recordConnectionAndGetThrottleTimeMs and once here. I wonder if we could look it up once to record the rate and to record the throttle time.\nI am thinking about the following to be more concrete. We could add two methods in ListenerConnectionQuota: 1) record and 2) recordThrottleTime. They would encapsulate the logic to respectively record the rate (for the listener and the broker like we do now) and the throttle time. So here we could look up the ListenerConnectionQuota record and get the throttle time, and record the throttle time if > 0.\nThat could improve the readability a bit. I am not sure that it would make a difference from a performance point of view. WDYT?", "url": "https://github.com/apache/kafka/pull/9317#discussion_r492570175", "createdAt": "2020-09-22T08:45:53Z", "author": {"login": "dajac"}, "path": "core/src/main/scala/kafka/network/SocketServer.scala", "diffHunk": "@@ -1292,6 +1292,12 @@ class ConnectionQuotas(config: KafkaConfig, time: Time, metrics: Metrics) extend\n     counts.synchronized {\n       val startThrottleTimeMs = time.milliseconds\n       val throttleTimeMs = math.max(recordConnectionAndGetThrottleTimeMs(listenerName, startThrottleTimeMs), 0)\n+      if (throttleTimeMs > 0) {\n+        // record throttle time due to hitting connection rate limit\n+        // connection could be throttled longer if the limit of the number of active connections is reached as well\n+        maxConnectionsPerListener.get(listenerName)\n+          .foreach(_.connectionRateThrottleSensor.record(throttleTimeMs.toDouble, startThrottleTimeMs))", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3MDY1Mw==", "bodyText": "nit: Do we really need to provide the type here? It seems that we usually don't provide it in that file.", "url": "https://github.com/apache/kafka/pull/9317#discussion_r492570653", "createdAt": "2020-09-22T08:46:38Z", "author": {"login": "dajac"}, "path": "core/src/main/scala/kafka/network/SocketServer.scala", "diffHunk": "@@ -1414,7 +1420,8 @@ class ConnectionQuotas(config: KafkaConfig, time: Time, metrics: Metrics) extend\n \n   class ListenerConnectionQuota(lock: Object, listener: ListenerName) extends ListenerReconfigurable {\n     @volatile private var _maxConnections = Int.MaxValue\n-    val connectionRateSensor = createConnectionRateQuotaSensor(Int.MaxValue, Some(listener.value))\n+    val connectionRateSensor: Sensor = createConnectionRateQuotaSensor(Int.MaxValue, Some(listener.value))\n+    val connectionRateThrottleSensor: Sensor = createConnectionRateThrottleSensor()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NTAzNg==", "bodyText": "nit: What about naming this close? It feels a bit more natural to call close when we don't need the object anymore and it would be more aligned with the close methods that we already have in this file. For instance, ConnectionQuotas#close which also cleanup the metrics.\nBTW, not related to this PR but it seems that we don't close the ListenerConnectionQuota when the ConnectionQuotas is closed. I suppose that we leave metrics around. Is it the case?", "url": "https://github.com/apache/kafka/pull/9317#discussion_r492575036", "createdAt": "2020-09-22T08:53:45Z", "author": {"login": "dajac"}, "path": "core/src/main/scala/kafka/network/SocketServer.scala", "diffHunk": "@@ -1447,13 +1454,33 @@ class ConnectionQuotas(config: KafkaConfig, time: Time, metrics: Metrics) extend\n       }\n     }\n \n+    def removeSensors(): Unit = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MjA4MzA2", "url": "https://github.com/apache/kafka/pull/9317#pullrequestreview-496208306", "createdAt": "2020-09-25T08:19:40Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03a5bdf5badf7b6725a41fce32bee32232d60a60", "author": {"user": {"login": "apovzner", "name": "Anna Povzner"}}, "url": "https://github.com/apache/kafka/commit/03a5bdf5badf7b6725a41fce32bee32232d60a60", "committedDate": "2020-09-28T03:54:45Z", "message": "KAFKA-10509: Added throttle connection accept rate metric (KIP-612)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65ce4200640eb86f70a7c23038b37a979eec9d91", "author": {"user": {"login": "apovzner", "name": "Anna Povzner"}}, "url": "https://github.com/apache/kafka/commit/65ce4200640eb86f70a7c23038b37a979eec9d91", "committedDate": "2020-09-28T03:54:45Z", "message": "also reduced the duration of verifyConnectionRate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9655e32a55b5069cba73f2410539fac9ca36a8f", "author": {"user": {"login": "apovzner", "name": "Anna Povzner"}}, "url": "https://github.com/apache/kafka/commit/e9655e32a55b5069cba73f2410539fac9ca36a8f", "committedDate": "2020-09-28T03:54:45Z", "message": "addressed review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51b7d7345afb1f52f72cf334109072deacdd1f0f", "author": {"user": {"login": "apovzner", "name": "Anna Povzner"}}, "url": "https://github.com/apache/kafka/commit/51b7d7345afb1f52f72cf334109072deacdd1f0f", "committedDate": "2020-09-28T03:54:45Z", "message": "Configure per-listener connection quotas on broker startup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "51b7d7345afb1f52f72cf334109072deacdd1f0f", "author": {"user": {"login": "apovzner", "name": "Anna Povzner"}}, "url": "https://github.com/apache/kafka/commit/51b7d7345afb1f52f72cf334109072deacdd1f0f", "committedDate": "2020-09-28T03:54:45Z", "message": "Configure per-listener connection quotas on broker startup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3ODMwOTA1", "url": "https://github.com/apache/kafka/pull/9317#pullrequestreview-497830905", "createdAt": "2020-09-28T19:27:06Z", "commit": {"oid": "51b7d7345afb1f52f72cf334109072deacdd1f0f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 664, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}