{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMjU2NzYy", "number": 8453, "title": "KAFKA-9841: Revoke duplicate connectors and tasks when zombie workers return with an outdated assignment", "bodyText": "With Incremental Cooperative Rebalancing, if a worker returns after it's been out of the group for sometime (essentially as a zombie worker) and hasn't voluntarily revoked its own connectors and tasks in the meantime, there's the possibility that these assignments have been distributed to other workers and redundant connectors and tasks might be running now in the Connect cluster.\nThis PR complements previous fixes such as KAFKA-9184, KAFKA-9849 and KAFKA-9851 providing a last line of defense against zombie tasks: if at any rebalance round the leader worker detects that there are duplicate assignments in the group, it revokes them completely and resolves duplication with a correct assignment in the rebalancing round that will follow task revocation.", "createdAt": "2020-04-09T07:28:22Z", "url": "https://github.com/apache/kafka/pull/8453", "merged": true, "mergeCommit": {"oid": "6abb913c6449113141582921340994c0d5e50839"}, "closed": true, "closedAt": "2020-06-11T00:59:33Z", "author": {"login": "Lucent-Wong"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpo2FJgFqTQyNzQwMjk5OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqDVm0gFqTQyODUxOTUyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDAyOTk5", "url": "https://github.com/apache/kafka/pull/8453#pullrequestreview-427402999", "createdAt": "2020-06-09T17:50:37Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNzo1MDozN1rOGhVuHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNzo1MDozN1rOGhVuHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYxMjA2Mw==", "bodyText": "The comment is a bit unclear. This code is not causing the duplicated assignment. Is resolving it by revoking redundant tasks. Can we rephrase?", "url": "https://github.com/apache/kafka/pull/8453#discussion_r437612063", "createdAt": "2020-06-09T17:50:37Z", "author": {"login": "kkonstantine"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/IncrementalCooperativeAssignor.java", "diffHunk": "@@ -229,6 +229,10 @@ private Long ensureLeaderConfig(long maxOffset, WorkerCoordinator coordinator) {\n         Map<String, ConnectorsAndTasks> toRevoke = computeDeleted(deleted, connectorAssignments, taskAssignments);\n         log.debug(\"Connector and task to delete assignments: {}\", toRevoke);\n \n+        // It may cause some duplicated assignment, when a worker with old generation assignment re-join the group", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00bacb7d72ba49debf3f1fec979bd3b99ce479d8", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/00bacb7d72ba49debf3f1fec979bd3b99ce479d8", "committedDate": "2020-06-10T12:22:25Z", "message": "KAFKA-9841: Connector and Task duplicated when a worker join with old generation assignment\nDetect duplicated connectors/tasks in IncrementalCooperativeAssignor then revoke all of them to trigger next round reassignment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76bd2ce316a19da027b632ee80d8856f413ae8a1", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/76bd2ce316a19da027b632ee80d8856f413ae8a1", "committedDate": "2020-06-10T12:22:25Z", "message": "KAFKA-9841: Connector and Task duplicated when a worker join with old generation assignment\nfix checkstyle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "76bd2ce316a19da027b632ee80d8856f413ae8a1", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/76bd2ce316a19da027b632ee80d8856f413ae8a1", "committedDate": "2020-06-10T12:22:25Z", "message": "KAFKA-9841: Connector and Task duplicated when a worker join with old generation assignment\nfix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1621e8337e157b2c0243b827ecac803171dc43c8", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/1621e8337e157b2c0243b827ecac803171dc43c8", "committedDate": "2020-06-10T12:29:29Z", "message": "KAFKA-9841: Rephase the comment and fix the unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTE5NTI1", "url": "https://github.com/apache/kafka/pull/8453#pullrequestreview-428519525", "createdAt": "2020-06-11T00:44:13Z", "commit": {"oid": "1621e8337e157b2c0243b827ecac803171dc43c8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1437, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}