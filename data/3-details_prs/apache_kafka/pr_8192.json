{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNTkzODUy", "number": 8192, "title": "MINOR: add wait_for_assigned_partitions to console-consumer", "bodyText": "what/why\nthe throttling_test was broken by this PR (#7785) since it depends on the consumer having partitions-assigned before starting the producer\nthis PR provides the ability to wait for partitions to be assigned in the console consumer before considering it started.\ncaveat\nthis does not support starting up the JmxTool inside the console-consumer for custom metrics while using this wait_until_partitions_assigned flag since the code assumes one JmxTool running per node.\nI think a proper fix for this would be to make JmxTool its own standalone single-node service\nalternatives\nwe could use the EndToEnd test suite which uses the verifiable producer/consumer under the hood but I found that there were more changes necessary to get this working unfortunately (specifically doesn't seem like this test suite plays nicely with the ProducerPerformanceService)\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-02-28T21:03:05Z", "url": "https://github.com/apache/kafka/pull/8192", "merged": true, "mergeCommit": {"oid": "72a5aa8b0758f23b42c6e4453d6dc6c4861aa1ad"}, "closed": true, "closedAt": "2020-03-01T00:43:52Z", "author": {"login": "brianbushree"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcI2tIrgH2gAyMzgxNTkzODUyOjhkNWU5ZTJmYzUzZmU1Y2U0MGNkNGRmMDVjNDcxM2YzYWExNTVhYTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcI5juOgH2gAyMzgxNTkzODUyOjc4YjAzZWI1YjlmYjRmYzRmMTlhNThkZDE2M2NmMzE1ODVkNmVlOTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8d5e9e2fc53fe5ce40cd4df05c4713f3aa155aa9", "author": {"user": {"login": "brianbushree", "name": "Brian Bushree"}}, "url": "https://github.com/apache/kafka/commit/8d5e9e2fc53fe5ce40cd4df05c4713f3aa155aa9", "committedDate": "2020-02-28T21:21:39Z", "message": "add wait_for_assigned_partitions in console consumer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26588bf878e99d1a79afa9433e23103407385e2f", "author": {"user": {"login": "brianbushree", "name": "Brian Bushree"}}, "url": "https://github.com/apache/kafka/commit/26588bf878e99d1a79afa9433e23103407385e2f", "committedDate": "2020-02-28T21:23:17Z", "message": "revert timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "26588bf878e99d1a79afa9433e23103407385e2f", "author": {"user": {"login": "brianbushree", "name": "Brian Bushree"}}, "url": "https://github.com/apache/kafka/commit/26588bf878e99d1a79afa9433e23103407385e2f", "committedDate": "2020-02-28T21:23:17Z", "message": "revert timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NzAxODYz", "url": "https://github.com/apache/kafka/pull/8192#pullrequestreview-366701863", "createdAt": "2020-02-28T21:40:08Z", "commit": {"oid": "26588bf878e99d1a79afa9433e23103407385e2f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMTo0MDowOFrOFwDmgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMTo0MDowOFrOFwDmgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkzNDk3Ng==", "bodyText": "this is not ideal but requires more refactoring to be able support multiple JmxTools running at once", "url": "https://github.com/apache/kafka/pull/8192#discussion_r385934976", "createdAt": "2020-02-28T21:40:08Z", "author": {"login": "brianbushree"}, "path": "tests/kafkatest/services/console_consumer.py", "diffHunk": "@@ -273,8 +276,25 @@ def _worker(self, idx, node):\n         with self.lock:\n             self.read_jmx_output(idx, node)\n \n+    def _wait_until_partitions_assigned(self, node, timeout_sec=60):\n+        if self.jmx_object_names is not None:\n+            raise Exception(\"'wait_until_partitions_assigned' is not supported while using 'jmx_object_names'/'jmx_attributes'\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26588bf878e99d1a79afa9433e23103407385e2f"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NzA5NTk1", "url": "https://github.com/apache/kafka/pull/8192#pullrequestreview-366709595", "createdAt": "2020-02-28T21:56:42Z", "commit": {"oid": "26588bf878e99d1a79afa9433e23103407385e2f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMTo1Njo0MlrOFwD-hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMTo1Njo0MlrOFwD-hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk0MTEyNQ==", "bodyText": "Just to be safe would it make sense to keep this at 60? I'm not insisting, just asking it's fine to leave as is if you are comfortable with it.", "url": "https://github.com/apache/kafka/pull/8192#discussion_r385941125", "createdAt": "2020-02-28T21:56:42Z", "author": {"login": "bbejeck"}, "path": "tests/kafkatest/tests/core/throttling_test.py", "diffHunk": "@@ -53,7 +53,7 @@ def __init__(self, test_context):\n         # ensure that the consumer is fully started before the producer starts\n         # so that we don't miss any messages. This timeout ensures the sufficient\n         # condition.\n-        self.consumer_init_timeout_sec =  60\n+        self.consumer_init_timeout_sec =  20", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26588bf878e99d1a79afa9433e23103407385e2f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NzM3ODM4", "url": "https://github.com/apache/kafka/pull/8192#pullrequestreview-366737838", "createdAt": "2020-02-28T23:12:19Z", "commit": {"oid": "26588bf878e99d1a79afa9433e23103407385e2f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NzQxNzQ0", "url": "https://github.com/apache/kafka/pull/8192#pullrequestreview-366741744", "createdAt": "2020-02-28T23:25:54Z", "commit": {"oid": "26588bf878e99d1a79afa9433e23103407385e2f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMzoyNTo1NFrOFwFklw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMzoyNTo1NFrOFwFklw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk2NzI1NQ==", "bodyText": "we should be re-running read_jmx_output before checking this condition", "url": "https://github.com/apache/kafka/pull/8192#discussion_r385967255", "createdAt": "2020-02-28T23:25:54Z", "author": {"login": "brianbushree"}, "path": "tests/kafkatest/services/console_consumer.py", "diffHunk": "@@ -273,8 +276,25 @@ def _worker(self, idx, node):\n         with self.lock:\n             self.read_jmx_output(idx, node)\n \n+    def _wait_until_partitions_assigned(self, node, timeout_sec=60):\n+        if self.jmx_object_names is not None:\n+            raise Exception(\"'wait_until_partitions_assigned' is not supported while using 'jmx_object_names'/'jmx_attributes'\")\n+        jmx_tool = JmxTool(self.context, jmx_poll_ms=100)\n+        jmx_tool.jmx_object_names = [\"kafka.consumer:type=consumer-coordinator-metrics,client-id=%s\" % self.client_id]\n+        jmx_tool.jmx_attributes = [\"assigned-partitions\"]\n+        jmx_tool.assigned_partitions_jmx_attr = \"kafka.consumer:type=consumer-coordinator-metrics,client-id=%s:assigned-partitions\" % self.client_id\n+        jmx_tool.start_jmx_tool(self.idx(node), node)\n+        jmx_tool.read_jmx_output(self.idx(node), node)\n+        assigned_partitions_jmx_attr = \"kafka.consumer:type=consumer-coordinator-metrics,client-id=%s:assigned-partitions\" % self.client_id\n+        wait_until(lambda: assigned_partitions_jmx_attr in jmx_tool.maximum_jmx_value,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26588bf878e99d1a79afa9433e23103407385e2f"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b35b94d56a498a968fee200aa068e493eac00bd", "author": {"user": {"login": "brianbushree", "name": "Brian Bushree"}}, "url": "https://github.com/apache/kafka/commit/7b35b94d56a498a968fee200aa068e493eac00bd", "committedDate": "2020-02-28T23:37:53Z", "message": "read jmx values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78b03eb5b9fb4fc4f19a58dd163cf31585d6ee97", "author": {"user": {"login": "brianbushree", "name": "Brian Bushree"}}, "url": "https://github.com/apache/kafka/commit/78b03eb5b9fb4fc4f19a58dd163cf31585d6ee97", "committedDate": "2020-02-29T00:41:05Z", "message": "revert timeout change"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1626, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}