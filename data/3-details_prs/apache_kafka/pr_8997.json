{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NTY0Mzcz", "number": 8997, "title": "MINOR: Improve log4j for per-consumer assignment", "bodyText": "Add log4j entry summarizing the assignment (prev owned and assigned) at the consumer level.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-07-09T01:27:29Z", "url": "https://github.com/apache/kafka/pull/8997", "merged": true, "mergeCommit": {"oid": "715df0d27122e0799c68daa78ab5f9ce0ab6b594"}, "closed": true, "closedAt": "2020-07-17T19:02:38Z", "author": {"login": "guozhangwang"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczERUAgH2gAyNDQ2NTY0MzczOjc2M2FhNTJhNDY1ODg0OGU2OTM0NWUzZTU3MDhkMzZjY2IyNDM5YzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc14b6BAFqTQ1MDg4NDM5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "763aa52a4658848e69345e3e5708d36ccb2439c4", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/763aa52a4658848e69345e3e5708d36ccb2439c4", "committedDate": "2020-07-09T00:54:45Z", "message": "improve log4j for per-consumer assignment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ae2df4f211dc247e3f71587ab9ec8dec3599e61", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/3ae2df4f211dc247e3f71587ab9ec8dec3599e61", "committedDate": "2020-07-09T01:26:55Z", "message": "add log4j for revoking active too"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MjMwODgx", "url": "https://github.com/apache/kafka/pull/8997#pullrequestreview-445230881", "createdAt": "2020-07-09T01:28:24Z", "commit": {"oid": "3ae2df4f211dc247e3f71587ab9ec8dec3599e61"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwMToyODoyNFrOGu-iag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwMToyOToxMVrOGu-jGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkxMjI5OA==", "bodyText": "This is not used anywhere.", "url": "https://github.com/apache/kafka/pull/8997#discussion_r451912298", "createdAt": "2020-07-09T01:28:24Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/assignment/ClientState.java", "diffHunk": "@@ -66,32 +72,17 @@ public ClientState() {\n         prevActiveTasks = new TreeSet<>();\n         prevStandbyTasks = new TreeSet<>();\n         consumerToPreviousStatefulTaskIds = new TreeMap<>();\n+        consumerToPreviousActiveTaskIds = new TreeMap<>();\n+        consumerToAssignedActiveTaskIds = new TreeMap<>();\n+        consumerToAssignedStandbyTaskIds = new TreeMap<>();\n+        consumerToRevokingActiveTaskIds = new TreeMap<>();\n         ownedPartitions = new TreeMap<>(TOPIC_PARTITION_COMPARATOR);\n         taskOffsetSums = new TreeMap<>();\n         taskLagTotals = new TreeMap<>();\n         this.capacity = capacity;\n     }\n \n-    private ClientState(final Set<TaskId> activeTasks,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ae2df4f211dc247e3f71587ab9ec8dec3599e61"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkxMjQ3Mg==", "bodyText": "This is unnecessarily verbose, plus part of it is replaced by line 960 below, so I trimmed a bit here.", "url": "https://github.com/apache/kafka/pull/8997#discussion_r451912472", "createdAt": "2020-07-09T01:29:11Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignor.java", "diffHunk": "@@ -725,8 +725,10 @@ private boolean assignTasksToClients(final Set<String> allSourceTopics,\n                                                                    statefulTasks,\n                                                                    assignmentConfigs);\n \n-        log.info(\"Assigned tasks to clients as {}{}.\",\n-            Utils.NL, clientStates.entrySet().stream().map(Map.Entry::toString).collect(Collectors.joining(Utils.NL)));\n+        log.info(\"Assigned tasks to clients as: {}{}.\", Utils.NL,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ae2df4f211dc247e3f71587ab9ec8dec3599e61"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MjM0NjEw", "url": "https://github.com/apache/kafka/pull/8997#pullrequestreview-445234610", "createdAt": "2020-07-09T01:40:43Z", "commit": {"oid": "3ae2df4f211dc247e3f71587ab9ec8dec3599e61"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwMTo0MDo0NFrOGu-vTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwMTo0MTozMVrOGu-wKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkxNTU5OA==", "bodyText": "Thanks, this one has always made my head spin when reading the logs", "url": "https://github.com/apache/kafka/pull/8997#discussion_r451915598", "createdAt": "2020-07-09T01:40:44Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignor.java", "diffHunk": "@@ -725,8 +725,10 @@ private boolean assignTasksToClients(final Set<String> allSourceTopics,\n                                                                    statefulTasks,\n                                                                    assignmentConfigs);\n \n-        log.info(\"Assigned tasks to clients as {}{}.\",\n-            Utils.NL, clientStates.entrySet().stream().map(Map.Entry::toString).collect(Collectors.joining(Utils.NL)));\n+        log.info(\"Assigned tasks to clients as: {}{}.\", Utils.NL,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkxMjQ3Mg=="}, "originalCommit": {"oid": "3ae2df4f211dc247e3f71587ab9ec8dec3599e61"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkxNTgxOQ==", "bodyText": "super nit: processor --> process (or bet yet, 'client')", "url": "https://github.com/apache/kafka/pull/8997#discussion_r451915819", "createdAt": "2020-07-09T01:41:31Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignor.java", "diffHunk": "@@ -931,7 +933,9 @@ private void populatePartitionsByHostMaps(final Map<HostInfo, Set<TopicPartition\n                 state\n             );\n \n-            // Arbitrarily choose the leader's client to be responsible for triggering the probing rebalance\n+            // Arbitrarily choose the leader's client to be responsible for triggering the probing rebalance,\n+            // note once we pick the first consumer of the processor to trigger probing rebalance, other threads", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ae2df4f211dc247e3f71587ab9ec8dec3599e61"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NzMwMTA4", "url": "https://github.com/apache/kafka/pull/8997#pullrequestreview-445730108", "createdAt": "2020-07-09T15:29:43Z", "commit": {"oid": "3ae2df4f211dc247e3f71587ab9ec8dec3599e61"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37c57d567427b9cf9effd1ef44ea7ac99606bb94", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/37c57d567427b9cf9effd1ef44ea7ac99606bb94", "committedDate": "2020-07-10T17:38:44Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KMinor-improve-assignor-log4j"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be0d18c701ffaca095e4404565aaa309b3200525", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/be0d18c701ffaca095e4404565aaa309b3200525", "committedDate": "2020-07-10T17:46:22Z", "message": "github comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzcxMTYz", "url": "https://github.com/apache/kafka/pull/8997#pullrequestreview-446771163", "createdAt": "2020-07-11T02:36:11Z", "commit": {"oid": "be0d18c701ffaca095e4404565aaa309b3200525"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwMjozNjoxMVrOGwJwew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwMjozNjo1OVrOGwJwtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE0NDY5OQ==", "bodyText": "Is this a logic change?", "url": "https://github.com/apache/kafka/pull/8997#discussion_r453144699", "createdAt": "2020-07-11T02:36:11Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignor.java", "diffHunk": "@@ -1078,6 +1098,8 @@ private boolean addClientAssignments(final Map<String, Assignment> assignment,\n                     );\n                     removedActiveTasks.add(taskId);\n \n+                    clientState.revokeActiveFromConsumer(taskId, consumer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be0d18c701ffaca095e4404565aaa309b3200525"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE0NDc1Ng==", "bodyText": "Similar here, if we have logical change, probably we need to add more tests.", "url": "https://github.com/apache/kafka/pull/8997#discussion_r453144756", "createdAt": "2020-07-11T02:36:59Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignor.java", "diffHunk": "@@ -1113,6 +1135,7 @@ private boolean addClientAssignments(final Map<String, Assignment> assignment,\n                                                                  final ClientState clientState) {\n         final Map<TaskId, Set<TopicPartition>> standbyTaskMap = new HashMap<>();\n         for (final TaskId task : standbys) {\n+            clientState.assignStandbyToConsumer(task, consumer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be0d18c701ffaca095e4404565aaa309b3200525"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3e5746c7e464f8f0f537bae421196c631e117b7", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/a3e5746c7e464f8f0f537bae421196c631e117b7", "committedDate": "2020-07-12T19:16:03Z", "message": "rebase from trunk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c4885e1289253d8c104b13925900d67296ee4f8", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/3c4885e1289253d8c104b13925900d67296ee4f8", "committedDate": "2020-07-12T23:34:52Z", "message": "add unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTAzMTY2", "url": "https://github.com/apache/kafka/pull/8997#pullrequestreview-446903166", "createdAt": "2020-07-12T19:17:27Z", "commit": {"oid": "a3e5746c7e464f8f0f537bae421196c631e117b7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxOToxNzoyN1rOGwWeeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxOToxNzoyN1rOGwWeeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1MzA4MA==", "bodyText": "No, the added functions are only for logging purposes.", "url": "https://github.com/apache/kafka/pull/8997#discussion_r453353080", "createdAt": "2020-07-12T19:17:27Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignor.java", "diffHunk": "@@ -1078,6 +1098,8 @@ private boolean addClientAssignments(final Map<String, Assignment> assignment,\n                     );\n                     removedActiveTasks.add(taskId);\n \n+                    clientState.revokeActiveFromConsumer(taskId, consumer);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE0NDY5OQ=="}, "originalCommit": {"oid": "be0d18c701ffaca095e4404565aaa309b3200525"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7e54ddb17ec093f619ed5f89d97a23cdfb36b3e", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/d7e54ddb17ec093f619ed5f89d97a23cdfb36b3e", "committedDate": "2020-07-14T21:26:09Z", "message": "checkstyle unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTgxMjE5", "url": "https://github.com/apache/kafka/pull/8997#pullrequestreview-448581219", "createdAt": "2020-07-15T02:08:42Z", "commit": {"oid": "d7e54ddb17ec093f619ed5f89d97a23cdfb36b3e"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMjowODo0MlrOGxrkkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMjoxNDo1MlrOGxrq_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc0NzI4MA==", "bodyText": "This alignment looks weird.", "url": "https://github.com/apache/kafka/pull/8997#discussion_r454747280", "createdAt": "2020-07-15T02:08:42Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignor.java", "diffHunk": "@@ -963,6 +967,18 @@ private void populatePartitionsByHostMaps(final Map<HostInfo, Set<TopicPartition\n                 rebalanceRequired = true;\n                 log.debug(\"Requested client {} to schedule a followup rebalance\", clientId);\n             }\n+\n+            log.info(\"Client {} per-consumer assignment:\\n\" +\n+                            \"\\tprev owned active {}\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7e54ddb17ec093f619ed5f89d97a23cdfb36b3e"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc0NzYyMQ==", "bodyText": "nit: we could initialize on the parameter definition.", "url": "https://github.com/apache/kafka/pull/8997#discussion_r454747621", "createdAt": "2020-07-15T02:09:53Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/assignment/ClientState.java", "diffHunk": "@@ -66,32 +72,17 @@ public ClientState() {\n         prevActiveTasks = new TreeSet<>();\n         prevStandbyTasks = new TreeSet<>();\n         consumerToPreviousStatefulTaskIds = new TreeMap<>();\n+        consumerToPreviousActiveTaskIds = new TreeMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7e54ddb17ec093f619ed5f89d97a23cdfb36b3e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc0ODI2OQ==", "bodyText": "We should add an empty line here to avoid mixing with the other maps with production use cases.", "url": "https://github.com/apache/kafka/pull/8997#discussion_r454748269", "createdAt": "2020-07-15T02:12:25Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/assignment/ClientState.java", "diffHunk": "@@ -50,10 +49,17 @@\n     private final Set<TaskId> prevStandbyTasks;\n \n     private final Map<String, Set<TaskId>> consumerToPreviousStatefulTaskIds;\n+    // the following four maps are used only for logging purposes;\n+    // TODO: we could consider merging them with other book-keeping maps\n+    private final Map<String, Set<TaskId>> consumerToPreviousActiveTaskIds;\n+    private final Map<String, Set<TaskId>> consumerToAssignedActiveTaskIds;\n+    private final Map<String, Set<TaskId>> consumerToAssignedStandbyTaskIds;\n+    private final Map<String, Set<TaskId>> consumerToRevokingActiveTaskIds;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7e54ddb17ec093f619ed5f89d97a23cdfb36b3e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc0ODkyNg==", "bodyText": "Could we add a follow-up ticket instead? Someone in the community could pick it up.", "url": "https://github.com/apache/kafka/pull/8997#discussion_r454748926", "createdAt": "2020-07-15T02:14:52Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/assignment/ClientState.java", "diffHunk": "@@ -50,10 +49,17 @@\n     private final Set<TaskId> prevStandbyTasks;\n \n     private final Map<String, Set<TaskId>> consumerToPreviousStatefulTaskIds;\n+    // the following four maps are used only for logging purposes;\n+    // TODO: we could consider merging them with other book-keeping maps", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7e54ddb17ec093f619ed5f89d97a23cdfb36b3e"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a0c09ebd82fbbf69f575083f3ee8afef01174b2", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/2a0c09ebd82fbbf69f575083f3ee8afef01174b2", "committedDate": "2020-07-17T01:09:07Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KMinor-improve-assigt nor-log4j"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "581980bfe301fa6f09a6fa8f7375d78955a09bbf", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/581980bfe301fa6f09a6fa8f7375d78955a09bbf", "committedDate": "2020-07-17T01:29:01Z", "message": "github comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODg0Mzk3", "url": "https://github.com/apache/kafka/pull/8997#pullrequestreview-450884397", "createdAt": "2020-07-17T18:49:14Z", "commit": {"oid": "581980bfe301fa6f09a6fa8f7375d78955a09bbf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1219, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}