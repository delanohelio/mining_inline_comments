{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzNDAyMjU1", "number": 9129, "title": "MINOR: Update jmh to 1.27 for async profiler support", "bodyText": "Also updated the jmh readme to make it easier for new people to know\nwhat's possible and best practices.\nThere were some changes in the generated benchmarking code that\nrequired adjusting spotbugs-exclude.xml and for a javac warning\nto be suppressed for the benchmarking module. I took the chance\nto make the spotbugs exclusion mode maintainable via a regex\npattern.\nTested the commands on Linux and macOS with zsh.\nJMH highlights:\n\nasync-profiler integration. Can be used with -prof async,\npass -prof async:help to look for the accepted options.\nperf c2c [2] integration. Can be used with -prof perfc2c,\nif available.\nJFR profiler integration. Can be used with -prof jfr, pass\n-prof jfr:help to look for the accepted options.\n\nFull details:\n\n1.24: https://mail.openjdk.java.net/pipermail/jmh-dev/2020-August/002982.html\n1.25: https://mail.openjdk.java.net/pipermail/jmh-dev/2020-August/002987.html\n1.26: https://mail.openjdk.java.net/pipermail/jmh-dev/2020-October/003024.html\n1.27: https://mail.openjdk.java.net/pipermail/jmh-dev/2020-December/003096.html\n\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-08-05T13:57:55Z", "url": "https://github.com/apache/kafka/pull/9129", "merged": true, "mergeCommit": {"oid": "8cabd57612189d633ca2aed40b63f20e1f668fa4"}, "closed": true, "closedAt": "2020-12-11T01:56:53Z", "author": {"login": "ijuma"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc773zhABqjM2MjQ4NzMzNjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdk-Ae4gH2gAyNDYzNDAyMjU1OjBmNWNkNGQ5MmE4MmYzNTA0NTQzNjBmZDIyYWQzYjFkNTg1ODgyNmY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "7ec327b4ecc7d13019e88cd4e20fe58335cbcbdb", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/7ec327b4ecc7d13019e88cd4e20fe58335cbcbdb", "committedDate": "2020-08-05T14:12:44Z", "message": "MINOR: Update jmh to 1.24 for async profiler support\n\nHighlights:\n\n* async-profiler integration. Can be used with -prof async,\npass -prof async:help to look for the accepted options.\n* perf c2c [2] integration. Can be used with -prof perfc2c,\nif available.\n\nFull details:\nhttps://mail.openjdk.java.net/pipermail/jmh-dev/2020-August/002982.html"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "debff2513346486163477008efbf5e895f5d25f8", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/debff2513346486163477008efbf5e895f5d25f8", "committedDate": "2020-08-11T09:18:38Z", "message": "Improve jmh benchmarking docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MTE1MTg4", "url": "https://github.com/apache/kafka/pull/9129#pullrequestreview-465115188", "createdAt": "2020-08-11T14:19:38Z", "commit": {"oid": "debff2513346486163477008efbf5e895f5d25f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MTY3MjYz", "url": "https://github.com/apache/kafka/pull/9129#pullrequestreview-465167263", "createdAt": "2020-08-11T15:13:07Z", "commit": {"oid": "debff2513346486163477008efbf5e895f5d25f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNToxMzowN1rOG-8oiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNToxMzowN1rOG-8oiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY1ODMxMw==", "bodyText": "Rather than \"in order to verify that they are valid\", how about \"in order to verify that they are measuring what you think they are. For example, if you use mocks they may use reflection that can easily dominate the benchmark's run time.\".", "url": "https://github.com/apache/kafka/pull/9129#discussion_r468658313", "createdAt": "2020-08-11T15:13:07Z", "author": {"login": "lbradstreet"}, "path": "README.md", "diffHunk": "@@ -199,6 +199,27 @@ You can run spotbugs using:\n The spotbugs warnings will be found in `reports/spotbugs/main.html` and `reports/spotbugs/test.html` files in the subproject build\n directories.  Use -PxmlSpotBugsReport=true to generate an XML report instead of an HTML one.\n \n+### JMH microbenchmarks ###\n+We use [JMH](https://openjdk.java.net/projects/code-tools/jmh/) to write microbenchmarks that produce reliable results in the JVM.\n+You can run all the benchmarks using:\n+\n+    ./jmh-benchmarks/jmh.sh\n+    \n+Pass a pattern or name after the command to select the benchmarks, for example:\n+\n+    ./jmh-benchmarks/jmh.sh LRUCacheBenchmark\n+\n+It's good practice to check profiler output for microbenchmarks in order to verify that they are valid.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "debff2513346486163477008efbf5e895f5d25f8"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MTcxMTY2", "url": "https://github.com/apache/kafka/pull/9129#pullrequestreview-465171166", "createdAt": "2020-08-11T15:17:20Z", "commit": {"oid": "debff2513346486163477008efbf5e895f5d25f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNToxNzoyMFrOG-80oA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNToxNzoyMFrOG-80oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY2MTQwOA==", "bodyText": "While we're at it we can also mention -prof gc and how you should look for the norm allocation rate (since we care about garbage generated per operation rather than per second).", "url": "https://github.com/apache/kafka/pull/9129#discussion_r468661408", "createdAt": "2020-08-11T15:17:20Z", "author": {"login": "lbradstreet"}, "path": "README.md", "diffHunk": "@@ -199,6 +199,27 @@ You can run spotbugs using:\n The spotbugs warnings will be found in `reports/spotbugs/main.html` and `reports/spotbugs/test.html` files in the subproject build\n directories.  Use -PxmlSpotBugsReport=true to generate an XML report instead of an HTML one.\n \n+### JMH microbenchmarks ###", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "debff2513346486163477008efbf5e895f5d25f8"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "ad5b568aa3f35804b7191d35f4be3bb778fc8e33", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/ad5b568aa3f35804b7191d35f4be3bb778fc8e33", "committedDate": "2020-08-22T23:09:12Z", "message": "JMH 1.25"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MDAxNTE4", "url": "https://github.com/apache/kafka/pull/9129#pullrequestreview-477001518", "createdAt": "2020-08-27T19:03:34Z", "commit": {"oid": "ad5b568aa3f35804b7191d35f4be3bb778fc8e33"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MDA0NzY5", "url": "https://github.com/apache/kafka/pull/9129#pullrequestreview-477004769", "createdAt": "2020-08-27T19:08:30Z", "commit": {"oid": "ad5b568aa3f35804b7191d35f4be3bb778fc8e33"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxOTowODozMFrOHIdm-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxOTowODozMFrOHIdm-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYzNTc3MA==", "bodyText": "Suggested addition:\nUsing JMH GC profiler\nIt's good practice to run your benchmark with -prof gc to measure the allocation rate for your code:\n  ./jmh-benchmarks/jmh.sh -prof gc\n\nOf particular importance is the \"norm\" alloc rates, which measure the allocations per operation rather than allocations per second which can increase when you have made your code faster.", "url": "https://github.com/apache/kafka/pull/9129#discussion_r478635770", "createdAt": "2020-08-27T19:08:30Z", "author": {"login": "lbradstreet"}, "path": "jmh-benchmarks/README.md", "diffHunk": "@@ -34,7 +34,18 @@ the jmh.sh script from the jmh-benchmarks module.\n * By default all JMH output goes to stdout.  To run a benchmark and capture the results in a file:\n `./jmh.sh -f 2 -o benchmarkResults.txt LRUCacheBenchmark`\n NOTE: For now this script needs to be run from the jmh-benchmarks directory.\n+\n+### Using JMH with async-profiler\n+\n+It's good practice to check profiler output for microbenchmarks in order to verify that they are valid.\n+JMH includes [async-profiler](https://github.com/jvm-profiling-tools/async-profiler) integration that makes this easy:\n  \n+    LD_LIBRARY_PATH=/path/to/async-profiler ./jmh-benchmarks/jmh.sh -prof async\n+    \n+A number of arguments can be passed to async-profiler, run the following for a description: \n+\n+    ./jmh-benchmarks/jmh.sh -prof async:help\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad5b568aa3f35804b7191d35f4be3bb778fc8e33"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MDA1OTU5", "url": "https://github.com/apache/kafka/pull/9129#pullrequestreview-477005959", "createdAt": "2020-08-27T19:10:18Z", "commit": {"oid": "ad5b568aa3f35804b7191d35f4be3bb778fc8e33"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxOToxMDoxOFrOHIdqrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxOToxMDoxOFrOHIdqrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYzNjcxOQ==", "bodyText": "We should document this variant instead so linux and mac os users are covered.\n -prof async:libPath=/Users/lucas/Downloads/async-profiler-1.8-macos-x64/build/libasyncProfiler.so", "url": "https://github.com/apache/kafka/pull/9129#discussion_r478636719", "createdAt": "2020-08-27T19:10:18Z", "author": {"login": "lbradstreet"}, "path": "jmh-benchmarks/README.md", "diffHunk": "@@ -34,7 +34,18 @@ the jmh.sh script from the jmh-benchmarks module.\n * By default all JMH output goes to stdout.  To run a benchmark and capture the results in a file:\n `./jmh.sh -f 2 -o benchmarkResults.txt LRUCacheBenchmark`\n NOTE: For now this script needs to be run from the jmh-benchmarks directory.\n+\n+### Using JMH with async-profiler\n+\n+It's good practice to check profiler output for microbenchmarks in order to verify that they are valid.\n+JMH includes [async-profiler](https://github.com/jvm-profiling-tools/async-profiler) integration that makes this easy:\n  \n+    LD_LIBRARY_PATH=/path/to/async-profiler ./jmh-benchmarks/jmh.sh -prof async", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad5b568aa3f35804b7191d35f4be3bb778fc8e33"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MzQ2NjY4", "url": "https://github.com/apache/kafka/pull/9129#pullrequestreview-516346668", "createdAt": "2020-10-25T10:58:35Z", "commit": {"oid": "ad5b568aa3f35804b7191d35f4be3bb778fc8e33"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "005aa5276930644624e86158047c42abe15380f2", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/005aa5276930644624e86158047c42abe15380f2", "committedDate": "2020-12-09T15:05:06Z", "message": "WIP"}, "afterCommit": {"oid": "f735d9e88f3f49884fd988aa825571fb0e23362e", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/f735d9e88f3f49884fd988aa825571fb0e23362e", "committedDate": "2020-12-09T20:37:11Z", "message": "JMH 1.27 and README improvements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4ODkzMzQx", "url": "https://github.com/apache/kafka/pull/9129#pullrequestreview-548893341", "createdAt": "2020-12-10T06:42:46Z", "commit": {"oid": "cfd375eb595950c325c0d1f2ae02869ad704760a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNjo0Mjo0NlrOIC481g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNjo0Mjo0NlrOIC481g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkwMTE0Mg==", "bodyText": "The file name of async-profiler is libasyncProfiler.so. Should we follow the naming in this example?", "url": "https://github.com/apache/kafka/pull/9129#discussion_r539901142", "createdAt": "2020-12-10T06:42:46Z", "author": {"login": "chia7712"}, "path": "jmh-benchmarks/README.md", "diffHunk": "@@ -1,10 +1,69 @@\n-### JMH-Benchmark module\n+### JMH-Benchmarks module\n \n This module contains benchmarks written using [JMH](https://openjdk.java.net/projects/code-tools/jmh/) from OpenJDK.\n Writing correct micro-benchmarks in Java (or another JVM language) is difficult and there are many non-obvious pitfalls (many\n due to compiler optimizations). JMH is a framework for running and analyzing benchmarks (micro or macro) written in Java (or\n another JVM language).\n \n+### Running benchmarks\n+\n+If you want to set specific JMH flags or only run certain benchmarks, passing arguments via\n+gradle tasks is cumbersome. These are simplified by the provided `jmh.sh` script.\n+\n+The default behavior is to run all benchmarks:\n+\n+    ./jmh-benchmarks/jmh.sh\n+    \n+Pass a pattern or name after the command to select the benchmarks:\n+\n+    ./jmh-benchmarks/jmh.sh LRUCacheBenchmark\n+\n+Check which benchmarks that match the provided pattern:\n+\n+    ./jmh-benchmarks/jmh.sh -l LRUCacheBenchmark\n+\n+Run a specific test and override the number of forks, iterations and warm-up iteration to `2`:\n+\n+    ./jmh-benchmarks/jmh.sh -f 2 -i 2 -wi 2 LRUCacheBenchmark\n+\n+Run a specific test with async and GC profilers on Linux and flame graph output:\n+\n+    ./jmh-benchmarks/jmh.sh -prof gc -prof 'async:libPath=/path/to/async-profiler.so;output=flamegraph' LRUCacheBenchmark\n+\n+The following sections cover async profiler and GC profilers in more detail.\n+\n+### Using JMH with async profiler\n+\n+It's good practice to check profiler output for microbenchmarks in order to verify that they are valid.\n+JMH includes [async-profiler](https://github.com/jvm-profiling-tools/async-profiler) integration that makes this easy:\n+\n+    ./jmh-benchmarks/jmh.sh -prof async:libPath=/path/to/async-profiler.so", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd375eb595950c325c0d1f2ae02869ad704760a"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45d097210326d2e9284c55150143de98c66309d6", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/45d097210326d2e9284c55150143de98c66309d6", "committedDate": "2020-12-10T13:40:55Z", "message": "MINOR: Update jmh to 1.24 for async profiler support\n\nHighlights:\n\n* async-profiler integration. Can be used with -prof async,\npass -prof async:help to look for the accepted options.\n* perf c2c [2] integration. Can be used with -prof perfc2c,\nif available.\n\nFull details:\nhttps://mail.openjdk.java.net/pipermail/jmh-dev/2020-August/002982.html"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35ec135a4e2398ed75b39278270d774d85cfe5c5", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/35ec135a4e2398ed75b39278270d774d85cfe5c5", "committedDate": "2020-12-10T13:40:55Z", "message": "Exclude jopt from jmh project"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c00f2f5674355ee8f3761620231e786a2f142cf6", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/c00f2f5674355ee8f3761620231e786a2f142cf6", "committedDate": "2020-12-10T13:40:55Z", "message": "Improve jmh benchmarking docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f24e61a05aa450828960866c0103b8df192e6421", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/f24e61a05aa450828960866c0103b8df192e6421", "committedDate": "2020-12-10T13:40:55Z", "message": "JMH 1.25"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5ad3a9da5d60c1ec25aa54b8554ddfb07675a09", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/a5ad3a9da5d60c1ec25aa54b8554ddfb07675a09", "committedDate": "2020-12-10T13:40:55Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbdbc76810ad8a2771d476f64f35d106a6bfa3f8", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/bbdbc76810ad8a2771d476f64f35d106a6bfa3f8", "committedDate": "2020-12-10T13:40:55Z", "message": "JMH 1.27 and README improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4993b7c7e4b7cdbe93322c83d3fd9a18346f2081", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/4993b7c7e4b7cdbe93322c83d3fd9a18346f2081", "committedDate": "2020-12-10T13:40:55Z", "message": "Fix compiler error with latest jmh and doc improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97db7556399f633f1f1c0ca187f1a106daecffba", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/97db7556399f633f1f1c0ca187f1a106daecffba", "committedDate": "2020-12-10T13:40:55Z", "message": "Readme fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b64b1f1eff6684873df88b1d411fd3be3b750e5e", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/b64b1f1eff6684873df88b1d411fd3be3b750e5e", "committedDate": "2020-12-10T13:40:55Z", "message": "Fix missing single quotes in readme"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67458a3b106abc2fbe4754b3f8618d6e936d79c5", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/67458a3b106abc2fbe4754b3f8618d6e936d79c5", "committedDate": "2020-12-10T13:40:55Z", "message": "Readme tweaks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e52198d80925a06a9532f4c9d04d781de70c079", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/8e52198d80925a06a9532f4c9d04d781de70c079", "committedDate": "2020-12-10T13:40:55Z", "message": "Adjust spotbugs exclusion to account for differences in the generated code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f425972651ed23392386e931be561e6632fd55ca", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/f425972651ed23392386e931be561e6632fd55ca", "committedDate": "2020-12-10T13:37:06Z", "message": "Adjust spotbugs exclusion to account for differences in the generated code"}, "afterCommit": {"oid": "8e52198d80925a06a9532f4c9d04d781de70c079", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/8e52198d80925a06a9532f4c9d04d781de70c079", "committedDate": "2020-12-10T13:40:55Z", "message": "Adjust spotbugs exclusion to account for differences in the generated code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MjEyMzQ5", "url": "https://github.com/apache/kafka/pull/9129#pullrequestreview-549212349", "createdAt": "2020-12-10T13:49:12Z", "commit": {"oid": "8e52198d80925a06a9532f4c9d04d781de70c079"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMzo0OToxM1rOIDKHhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMzo0OToxM1rOIDKHhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE4MjQwNw==", "bodyText": "jmh now uses jmh_generated instead of generated.", "url": "https://github.com/apache/kafka/pull/9129#discussion_r540182407", "createdAt": "2020-12-10T13:49:13Z", "author": {"login": "ijuma"}, "path": "gradle/spotbugs-exclude.xml", "diffHunk": "@@ -237,19 +237,8 @@ For a detailed description of spotbugs bug categories, see https://spotbugs.read\n     </Match>\n \n     <Match>\n-        <!-- Suppress some minor warnings about machine-generated code for\n-             benchmarking. -->\n-        <Or>\n-            <Package name=\"org.apache.kafka.jmh.cache.generated\"/>\n-            <Package name=\"org.apache.kafka.jmh.common.generated\"/>\n-            <Package name=\"org.apache.kafka.jmh.record.generated\"/>\n-            <Package name=\"org.apache.kafka.jmh.partition.generated\"/>\n-            <Package name=\"org.apache.kafka.jmh.producer.generated\"/>\n-            <Package name=\"org.apache.kafka.jmh.fetchsession.generated\"/>\n-            <Package name=\"org.apache.kafka.jmh.fetcher.generated\"/>\n-            <Package name=\"org.apache.kafka.jmh.server.generated\"/>\n-            <Package name=\"org.apache.kafka.jmh.consumer.generated\"/>\n-        </Or>\n+        <!-- Suppress some minor warnings about machine-generated code for benchmarking. -->\n+        <Package name=\"~org\\.apache\\.kafka\\.jmh\\..*\\.jmh_generated\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e52198d80925a06a9532f4c9d04d781de70c079"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MjkzNTY1", "url": "https://github.com/apache/kafka/pull/9129#pullrequestreview-549293565", "createdAt": "2020-12-10T15:09:48Z", "commit": {"oid": "8e52198d80925a06a9532f4c9d04d781de70c079"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NDM3OTAw", "url": "https://github.com/apache/kafka/pull/9129#pullrequestreview-549437900", "createdAt": "2020-12-10T17:31:09Z", "commit": {"oid": "8e52198d80925a06a9532f4c9d04d781de70c079"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNzozMToxMFrOIDU--Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNzozMToxMFrOIDU--Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM2MDQ0MQ==", "bodyText": "How about:\n\"It's good practice to check profiler output for microbenchmarks in order to verify that they represent application behavior and measure what you expect to measure. Some example pitfalls include the use of expensive mocks or accidental inclusion of test setup code in the benchmarked code.\"", "url": "https://github.com/apache/kafka/pull/9129#discussion_r540360441", "createdAt": "2020-12-10T17:31:10Z", "author": {"login": "lbradstreet"}, "path": "jmh-benchmarks/README.md", "diffHunk": "@@ -1,10 +1,69 @@\n-### JMH-Benchmark module\n+### JMH-Benchmarks module\n \n This module contains benchmarks written using [JMH](https://openjdk.java.net/projects/code-tools/jmh/) from OpenJDK.\n Writing correct micro-benchmarks in Java (or another JVM language) is difficult and there are many non-obvious pitfalls (many\n due to compiler optimizations). JMH is a framework for running and analyzing benchmarks (micro or macro) written in Java (or\n another JVM language).\n \n+### Running benchmarks\n+\n+If you want to set specific JMH flags or only run certain benchmarks, passing arguments via\n+gradle tasks is cumbersome. These are simplified by the provided `jmh.sh` script.\n+\n+The default behavior is to run all benchmarks:\n+\n+    ./jmh-benchmarks/jmh.sh\n+    \n+Pass a pattern or name after the command to select the benchmarks:\n+\n+    ./jmh-benchmarks/jmh.sh LRUCacheBenchmark\n+\n+Check which benchmarks that match the provided pattern:\n+\n+    ./jmh-benchmarks/jmh.sh -l LRUCacheBenchmark\n+\n+Run a specific test and override the number of forks, iterations and warm-up iteration to `2`:\n+\n+    ./jmh-benchmarks/jmh.sh -f 2 -i 2 -wi 2 LRUCacheBenchmark\n+\n+Run a specific test with async and GC profilers on Linux and flame graph output:\n+\n+    ./jmh-benchmarks/jmh.sh -prof gc -prof async:libPath=/path/to/libasyncProfiler.so\\;output=flamegraph LRUCacheBenchmark\n+\n+The following sections cover async profiler and GC profilers in more detail.\n+\n+### Using JMH with async profiler\n+\n+It's good practice to check profiler output for microbenchmarks in order to verify that they are valid.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e52198d80925a06a9532f4c9d04d781de70c079"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NDM5ODE4", "url": "https://github.com/apache/kafka/pull/9129#pullrequestreview-549439818", "createdAt": "2020-12-10T17:32:58Z", "commit": {"oid": "8e52198d80925a06a9532f4c9d04d781de70c079"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNzozMjo1OFrOIDVD0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNzozMjo1OFrOIDVD0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM2MTY4Mw==", "bodyText": "Could we include a short section here about what should be put into a PR that has been benchmarked?\nI'm thinking:\n\nBenchmark comparisons for the code before and after the change.\n-prof gc results.\nAn example async profile from at least one run.", "url": "https://github.com/apache/kafka/pull/9129#discussion_r540361683", "createdAt": "2020-12-10T17:32:58Z", "author": {"login": "lbradstreet"}, "path": "jmh-benchmarks/README.md", "diffHunk": "@@ -1,10 +1,69 @@\n-### JMH-Benchmark module\n+### JMH-Benchmarks module\n \n This module contains benchmarks written using [JMH](https://openjdk.java.net/projects/code-tools/jmh/) from OpenJDK.\n Writing correct micro-benchmarks in Java (or another JVM language) is difficult and there are many non-obvious pitfalls (many\n due to compiler optimizations). JMH is a framework for running and analyzing benchmarks (micro or macro) written in Java (or\n another JVM language).\n \n+### Running benchmarks\n+\n+If you want to set specific JMH flags or only run certain benchmarks, passing arguments via\n+gradle tasks is cumbersome. These are simplified by the provided `jmh.sh` script.\n+\n+The default behavior is to run all benchmarks:\n+\n+    ./jmh-benchmarks/jmh.sh\n+    \n+Pass a pattern or name after the command to select the benchmarks:\n+\n+    ./jmh-benchmarks/jmh.sh LRUCacheBenchmark\n+\n+Check which benchmarks that match the provided pattern:\n+\n+    ./jmh-benchmarks/jmh.sh -l LRUCacheBenchmark\n+\n+Run a specific test and override the number of forks, iterations and warm-up iteration to `2`:\n+\n+    ./jmh-benchmarks/jmh.sh -f 2 -i 2 -wi 2 LRUCacheBenchmark\n+\n+Run a specific test with async and GC profilers on Linux and flame graph output:\n+\n+    ./jmh-benchmarks/jmh.sh -prof gc -prof async:libPath=/path/to/libasyncProfiler.so\\;output=flamegraph LRUCacheBenchmark\n+\n+The following sections cover async profiler and GC profilers in more detail.\n+\n+### Using JMH with async profiler\n+\n+It's good practice to check profiler output for microbenchmarks in order to verify that they are valid.\n+JMH includes [async-profiler](https://github.com/jvm-profiling-tools/async-profiler) integration that makes this easy:\n+\n+    ./jmh-benchmarks/jmh.sh -prof async:libPath=/path/to/libasyncProfiler.so\n+\n+With flame graph output (the semicolon is escaped to ensure it is not treated as a command separator):\n+\n+    ./jmh-benchmarks/jmh.sh -prof async:libPath=/path/to/libasyncProfiler.so\\;output=flamegraph\n+\n+A number of arguments can be passed to configure async profiler, run the following for a description:\n+\n+    ./jmh-benchmarks/jmh.sh -prof async:help\n+\n+### Using JMH GC profiler\n+\n+It's good practice to run your benchmark with `-prof gc` to measure its allocation rate:\n+\n+    ./jmh-benchmarks/jmh.sh -prof gc\n+\n+Of particular importance is the `norm` alloc rates, which measure the allocations per operation rather than allocations\n+per second which can increase when you have make your code faster.\n+\n+### Running JMH outside of gradle\n+\n+The JMH benchmarks can be run outside of gradle as you would with any executable jar file:\n+\n+    java -jar <kafka-repo-dir>/jmh-benchmarks/build/libs/kafka-jmh-benchmarks-all.jar -f2 LRUCacheBenchmark\n+\n+### Writing benchmarks", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e52198d80925a06a9532f4c9d04d781de70c079"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f5cd4d92a82f350454360fd22ad3b1d5858826f", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/0f5cd4d92a82f350454360fd22ad3b1d5858826f", "committedDate": "2020-12-11T01:53:09Z", "message": "Tweak \"profiler good practice\" text"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1055, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}