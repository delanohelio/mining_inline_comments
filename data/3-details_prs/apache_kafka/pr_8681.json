{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5MTUyMTY1", "number": 8681, "title": "KAFKA-10010: Should make state store registration idempotent", "bodyText": "Standby task could also at risk of getting into illegal state when not being closed during HandleLostAll\n\n\nThe standby task was initializing as CREATED state, and task corrupted exception was thrown from registerStateStores\n\n\nThe task corrupted exception was caught, and do a non-affected task commit\n\n\nThe task commit failed due to task migrated exception\n\n\nThe handleLostAll didn't close the standby task, leaving it as CREATED state\n\n\nNext rebalance complete, the same task was assigned back as standby task.\n\n\nIllegal Argument exception caught as state store already registered\n\n\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-05-17T18:20:21Z", "url": "https://github.com/apache/kafka/pull/8681", "merged": true, "mergeCommit": {"oid": "7c7d88339bf36a0a4c046f5dfd57e83a35a8e1e1"}, "closed": true, "closedAt": "2020-05-19T22:02:56Z", "author": {"login": "abbccdda"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchRWE8gH2gAyNDE5MTUyMTY1OmQyZjI2Njc3ZjE1MDk1MWQ5YTZhZTNkMDllZDZhMDU4YjkzNmMwNTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABci6byQgFqTQxNDc5NTIwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d2f26677f150951d9a6ae3d09ed6a058b936c050", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/d2f26677f150951d9a6ae3d09ed6a058b936c050", "committedDate": "2020-05-14T17:58:05Z", "message": "Handle task migrated inside corruption path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50bedd04f4c9ddab75ba4c64f6d2df95c07635e8", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/50bedd04f4c9ddab75ba4c64f6d2df95c07635e8", "committedDate": "2020-05-15T17:48:45Z", "message": "Merge remote-tracking branch 'upstream/trunk' into trunk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c22da33c8b4a4683702b0e1dd555dd9674dbbb8", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/2c22da33c8b4a4683702b0e1dd555dd9674dbbb8", "committedDate": "2020-05-17T06:29:36Z", "message": "Merge remote-tracking branch 'upstream/trunk' into trunk"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/eb661ea1ba9fad4520a39acbb00cb312f2baecb3", "committedDate": "2020-05-19T00:01:58Z", "message": "idempotent state store registration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/eb661ea1ba9fad4520a39acbb00cb312f2baecb3", "committedDate": "2020-05-19T00:01:58Z", "message": "idempotent state store registration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MDE3OTMw", "url": "https://github.com/apache/kafka/pull/8681#pullrequestreview-414017930", "createdAt": "2020-05-19T00:13:22Z", "commit": {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMDoxMzoyMlrOGXLgYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMDoxMzoyMlrOGXLgYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1ODk0Nw==", "bodyText": "I think we might want to skip the re-registration higher up the call stack. In StateManagerUtil#registerStateStores we call store.init on each store which ultimately results in this registerStore being called", "url": "https://github.com/apache/kafka/pull/8681#discussion_r426958947", "createdAt": "2020-05-19T00:13:22Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -266,7 +266,8 @@ public void registerStore(final StateStore store, final StateRestoreCallback sta\n         }\n \n         if (stores.containsKey(storeName)) {\n-            throw new IllegalArgumentException(format(\"%sStore %s has already been registered.\", logPrefix, storeName));\n+            log.warn(\"State Store {} has already been registered, which could be due to a half-way registration\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MDM2NzI4", "url": "https://github.com/apache/kafka/pull/8681#pullrequestreview-414036728", "createdAt": "2020-05-19T01:16:07Z", "commit": {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMToxNjowN1rOGXMgiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMToxODowMVrOGXMigA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3NTM2OQ==", "bodyText": "+1, we can rely on storeManager#getStore inside StateManagerUtil to check if the store is already registered.", "url": "https://github.com/apache/kafka/pull/8681#discussion_r426975369", "createdAt": "2020-05-19T01:16:07Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -266,7 +266,8 @@ public void registerStore(final StateStore store, final StateRestoreCallback sta\n         }\n \n         if (stores.containsKey(storeName)) {\n-            throw new IllegalArgumentException(format(\"%sStore %s has already been registered.\", logPrefix, storeName));\n+            log.warn(\"State Store {} has already been registered, which could be due to a half-way registration\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1ODk0Nw=="}, "originalCommit": {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3NTg3Mg==", "bodyText": "nit: we could make the warn log entry more clear that we did not override the registered the store, e.g. \"Skipped registering state store {} since it has already existed in the state manager, ...\"", "url": "https://github.com/apache/kafka/pull/8681#discussion_r426975872", "createdAt": "2020-05-19T01:18:01Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -266,7 +266,8 @@ public void registerStore(final StateStore store, final StateRestoreCallback sta\n         }\n \n         if (stores.containsKey(storeName)) {\n-            throw new IllegalArgumentException(format(\"%sStore %s has already been registered.\", logPrefix, storeName));\n+            log.warn(\"State Store {} has already been registered, which could be due to a half-way registration\" +\n+                \"in the previous round\", storeName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebf9ca4c78b51d1c0c07ae3c5866800238e310c6", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/ebf9ca4c78b51d1c0c07ae3c5866800238e310c6", "committedDate": "2020-05-19T19:59:12Z", "message": "change state manager util for idempotent registration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "ebf9ca4c78b51d1c0c07ae3c5866800238e310c6", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/ebf9ca4c78b51d1c0c07ae3c5866800238e310c6", "committedDate": "2020-05-19T19:59:12Z", "message": "change state manager util for idempotent registration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0Nzk1MjA4", "url": "https://github.com/apache/kafka/pull/8681#pullrequestreview-414795208", "createdAt": "2020-05-19T20:24:21Z", "commit": {"oid": "ebf9ca4c78b51d1c0c07ae3c5866800238e310c6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1064, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}