{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NzA5NDY5", "number": 8782, "title": "KAFKA-10080; Fix race condition on txn completion which can cause duplicate appends", "bodyText": "The method maybeWriteTxnCompletion is unsafe for concurrent calls. This can cause duplicate attempts to write the completion record to the log, which can ultimately lead to illegal state errors and possible to correctness violations if another transaction had been started before the duplicate was written. This patch fixes the problem by ensuring only one thread can successfully remove the pending completion from the map.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-06-02T16:54:28Z", "url": "https://github.com/apache/kafka/pull/8782", "merged": true, "mergeCommit": {"oid": "0ffbc6e75fffb39d0dc387db534a51ce613f52af"}, "closed": true, "closedAt": "2020-06-03T17:37:54Z", "author": {"login": "hachikuji"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnXtpMAH2gAyNDI2NzA5NDY5OjQ0ZDI4MTU1NWE0ZDdmNjI0ZmU5ZTdjNjU4NTU1MGJmZGI0Nzc3MDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnqLwdgFqTQyMzYwMDc5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "44d281555a4d7f624fe9e7c6585550bfdb477702", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/44d281555a4d7f624fe9e7c6585550bfdb477702", "committedDate": "2020-06-02T16:46:48Z", "message": "KAFKA-10080; Fix race condition on txn completion which can cause duplicate appends"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyODg3MTcx", "url": "https://github.com/apache/kafka/pull/8782#pullrequestreview-422887171", "createdAt": "2020-06-02T17:10:28Z", "commit": {"oid": "44d281555a4d7f624fe9e7c6585550bfdb477702"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzoxMDoyOFrOGd7mxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzoxMDoyOFrOGd7mxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAzODQ2OQ==", "bodyText": "How about renaming pendingCommitTxn to pendingCompleteTxn", "url": "https://github.com/apache/kafka/pull/8782#discussion_r434038469", "createdAt": "2020-06-02T17:10:28Z", "author": {"login": "chia7712"}, "path": "core/src/main/scala/kafka/coordinator/transaction/TransactionMarkerChannelManager.scala", "diffHunk": "@@ -215,8 +215,6 @@ class TransactionMarkerChannelManager(config: KafkaConfig,\n   }\n \n   private def writeTxnCompletion(pendingCommitTxn: PendingCompleteTxn): Unit = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44d281555a4d7f624fe9e7c6585550bfdb477702"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d1d5607db8d30bda2fb4c2c689f8d6b8d32c0e8", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/9d1d5607db8d30bda2fb4c2c689f8d6b8d32c0e8", "committedDate": "2020-06-02T18:32:57Z", "message": "Rename pendingCommitTxn to pendingCompleteTxn"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyOTU3OTcy", "url": "https://github.com/apache/kafka/pull/8782#pullrequestreview-422957972", "createdAt": "2020-06-02T18:39:41Z", "commit": {"oid": "9d1d5607db8d30bda2fb4c2c689f8d6b8d32c0e8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxODozOTo0MVrOGd_RcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxODozOTo0MVrOGd_RcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA5ODU0NQ==", "bodyText": "Multiple threads may see the transaction still as pending and attempt completion.", "url": "https://github.com/apache/kafka/pull/8782#discussion_r434098545", "createdAt": "2020-06-02T18:39:41Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/coordinator/transaction/TransactionMarkerChannelManager.scala", "diffHunk": "@@ -285,15 +280,16 @@ class TransactionMarkerChannelManager(config: KafkaConfig,\n     }\n   }\n \n-  private def maybeWriteTxnCompletion(transactionalId: String): Unit = {\n-    Option(transactionsWithPendingMarkers.get(transactionalId)).foreach { pendingCommitTxn =>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d1d5607db8d30bda2fb4c2c689f8d6b8d32c0e8"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f", "committedDate": "2020-06-02T19:57:11Z", "message": "Fix failing test due to nice mock change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMDI4NjY3", "url": "https://github.com/apache/kafka/pull/8782#pullrequestreview-423028667", "createdAt": "2020-06-02T20:21:48Z", "commit": {"oid": "c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMDoyMTo0OVrOGeCm-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMDoyMTo0OVrOGeCm-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE1MzIxMA==", "bodyText": "The change to use mock instead of niceMock led to a failure because of an unexpected append to the log. It seemed like this call was not necessary to test the behavior we were interested in here, so I removed it rather than adding the expected call to append.", "url": "https://github.com/apache/kafka/pull/8782#discussion_r434153210", "createdAt": "2020-06-02T20:21:49Z", "author": {"login": "hachikuji"}, "path": "core/src/test/scala/unit/kafka/coordinator/transaction/TransactionMarkerChannelManagerTest.scala", "diffHunk": "@@ -221,7 +221,6 @@ class TransactionMarkerChannelManagerTest {\n     EasyMock.replay(metadataCache)\n \n     channelManager.addTxnMarkersToSend(coordinatorEpoch, txnResult, txnMetadata1, txnMetadata1.prepareComplete(time.milliseconds()))\n-    channelManager.addTxnMarkersToSend(coordinatorEpoch, txnResult, txnMetadata2, txnMetadata2.prepareComplete(time.milliseconds()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMDU0NjY1", "url": "https://github.com/apache/kafka/pull/8782#pullrequestreview-423054665", "createdAt": "2020-06-02T21:01:35Z", "commit": {"oid": "c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMTowMTozNlrOGeD1cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMTowMjowM1rOGeD2TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MzI5Nw==", "bodyText": "Does this test cover concurrent calls to maybeWriteTxnCompletion?", "url": "https://github.com/apache/kafka/pull/8782#discussion_r434173297", "createdAt": "2020-06-02T21:01:36Z", "author": {"login": "guozhangwang"}, "path": "core/src/test/scala/unit/kafka/coordinator/transaction/TransactionMarkerChannelManagerTest.scala", "diffHunk": "@@ -86,6 +90,70 @@ class TransactionMarkerChannelManagerTest {\n       .anyTimes()\n   }\n \n+  @Test\n+  def shouldOnlyWriteTxnCompletionOnce(): Unit = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MzUxNw==", "bodyText": "Nice catch. Not sure why they did not fail before :)", "url": "https://github.com/apache/kafka/pull/8782#discussion_r434173517", "createdAt": "2020-06-02T21:02:03Z", "author": {"login": "guozhangwang"}, "path": "core/src/test/scala/unit/kafka/coordinator/transaction/TransactionMarkerChannelManagerTest.scala", "diffHunk": "@@ -291,7 +358,7 @@ class TransactionMarkerChannelManagerTest {\n \n     val response = new WriteTxnMarkersResponse(createPidErrorMap(Errors.NONE))\n     for (requestAndHandler <- requestAndHandlers) {\n-      requestAndHandler.handler.onComplete(new ClientResponse(new RequestHeader(ApiKeys.PRODUCE, 0, \"client\", 1),\n+      requestAndHandler.handler.onComplete(new ClientResponse(new RequestHeader(ApiKeys.WRITE_TXN_MARKERS, 0, \"client\", 1),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f"}, "originalPosition": 109}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNjAwNzk3", "url": "https://github.com/apache/kafka/pull/8782#pullrequestreview-423600797", "createdAt": "2020-06-03T14:17:59Z", "commit": {"oid": "c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 828, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}