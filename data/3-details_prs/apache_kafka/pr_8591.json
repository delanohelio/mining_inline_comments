{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExNTAwNDE1", "number": 8591, "title": "KAFKA-6342: Move workaround for JSON parsing of non-escaped strings", "bodyText": "PR #4303 introduced parsing for some invalid JSONs, such as escaped SSL names. This PR moves the parsing directly under AclEntry to localize this logic.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-04-30T13:33:18Z", "url": "https://github.com/apache/kafka/pull/8591", "merged": true, "mergeCommit": {"oid": "d70dacb54ad894d188e6ed97e0ce61d10110db20"}, "closed": true, "closedAt": "2020-05-06T19:39:34Z", "author": {"login": "viktorsomogyi"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcT-d3rgH2gAyNDExNTAwNDE1OmU3YzQzNDZkODI3MjVjNmZiNmY3MzJiZjBiYTA0MjkyNGZlNmNlZjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceru3VgFqTQwNjgxMDgwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e7c4346d82725c6fb6f732bf0ba042924fe6cef6", "author": {"user": {"login": "umesh9794", "name": "Umesh"}}, "url": "https://github.com/apache/kafka/commit/e7c4346d82725c6fb6f732bf0ba042924fe6cef6", "committedDate": "2020-04-03T10:37:23Z", "message": "Initial Commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b48c95f319f18e69dd1c741851695b5d483b9ef", "author": {"user": {"login": "umesh9794", "name": "Umesh"}}, "url": "https://github.com/apache/kafka/commit/5b48c95f319f18e69dd1c741851695b5d483b9ef", "committedDate": "2020-04-03T10:50:58Z", "message": "Fixed the applicability of new method based on trunk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "752d8315b44a38c6907c062e292871e23ebc432d", "author": {"user": {"login": "umesh9794", "name": "Umesh"}}, "url": "https://github.com/apache/kafka/commit/752d8315b44a38c6907c062e292871e23ebc432d", "committedDate": "2020-04-03T10:50:58Z", "message": "Merge branch 'trunk'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e941b9e801974b1201026bfeba4509342946cea", "author": {"user": {"login": "umesh9794", "name": "Umesh"}}, "url": "https://github.com/apache/kafka/commit/1e941b9e801974b1201026bfeba4509342946cea", "committedDate": "2020-04-03T10:54:52Z", "message": "Rebased and applied review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a14e6cb0dbeb736e1018ee141832153a34e47bc4", "author": {"user": {"login": "umesh9794", "name": "Umesh"}}, "url": "https://github.com/apache/kafka/commit/a14e6cb0dbeb736e1018ee141832153a34e47bc4", "committedDate": "2020-04-03T10:56:17Z", "message": "Rebased and applied review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae659d171d2378dd7932062344ef316695cd1d20", "author": {"user": {"login": "umesh9794", "name": "Umesh"}}, "url": "https://github.com/apache/kafka/commit/ae659d171d2378dd7932062344ef316695cd1d20", "committedDate": "2020-04-03T10:56:18Z", "message": "Changed the AclJson to have the incorrect format for principals"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c308a8a8fd9786699448bcec94c324730598283", "author": {"user": {"login": "umesh9794", "name": "Umesh"}}, "url": "https://github.com/apache/kafka/commit/1c308a8a8fd9786699448bcec94c324730598283", "committedDate": "2020-04-03T10:56:19Z", "message": "Applied the review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "438d010f53963bfb6a364466ac28e0e59a013895", "author": {"user": {"login": "viktorsomogyi", "name": "Viktor Somogyi-Vass"}}, "url": "https://github.com/apache/kafka/commit/438d010f53963bfb6a364466ac28e0e59a013895", "committedDate": "2020-04-30T13:26:46Z", "message": "Rebase changes + fixing test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNTUzMTIx", "url": "https://github.com/apache/kafka/pull/8591#pullrequestreview-403553121", "createdAt": "2020-04-30T14:04:54Z", "commit": {"oid": "438d010f53963bfb6a364466ac28e0e59a013895"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDowNDo1NFrOGOq3Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDowNDo1NFrOGOq3Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAzNTUzMA==", "bodyText": "Nit: e -> _.", "url": "https://github.com/apache/kafka/pull/8591#discussion_r418035530", "createdAt": "2020-04-30T14:04:54Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/security/authorizer/AclEntry.scala", "diffHunk": "@@ -92,6 +95,23 @@ object AclEntry {\n     }.getOrElse(Set.empty)\n   }\n \n+  /**\n+   * Parse a JSON string into a JsonValue if possible. `None` is returned if `input` is not valid JSON. This method is currently used\n+   * to read the already stored invalid ACLs JSON which was persisted using older versions of Kafka (prior to Kafka 1.1.0). KAFKA-6319\n+   */\n+  private def parseBytesWithAclFallback(input: Array[Byte]): Option[JsonValue] = {\n+    // Before 1.0.1, Json#encode did not escape backslash or any other special characters. SSL principals\n+    // stored in ACLs may contain backslash as an escape char, making the JSON generated in earlier versions invalid.\n+    // Escape backslash and retry to handle these strings which may have been persisted in ZK.\n+    // Note that this does not handle all special characters (e.g. non-escaped double quotes are not supported)\n+    Json.tryParseBytes(input) match {\n+      case Left(e) =>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "438d010f53963bfb6a364466ac28e0e59a013895"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fec67e0b523c6b7070b4083afb9ae29478afd36b", "author": {"user": {"login": "viktorsomogyi", "name": "Viktor Somogyi-Vass"}}, "url": "https://github.com/apache/kafka/commit/fec67e0b523c6b7070b4083afb9ae29478afd36b", "committedDate": "2020-04-30T15:14:21Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NDA0NzM5", "url": "https://github.com/apache/kafka/pull/8591#pullrequestreview-404404739", "createdAt": "2020-05-01T21:14:53Z", "commit": {"oid": "fec67e0b523c6b7070b4083afb9ae29478afd36b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQyMToxNDo1M1rOGPV7Dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQyMToyMTo1M1rOGPWE2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0MTAwNg==", "bodyText": "Need to revert this. It is causing the build to fail.", "url": "https://github.com/apache/kafka/pull/8591#discussion_r418741006", "createdAt": "2020-05-01T21:14:53Z", "author": {"login": "hachikuji"}, "path": "core/src/test/scala/unit/kafka/security/authorizer/AclEntryTest.scala", "diffHunk": "@@ -23,27 +23,28 @@ import org.apache.kafka.common.acl.AclOperation.READ\n import org.apache.kafka.common.acl.AclPermissionType.{ALLOW, DENY}\n import org.apache.kafka.common.security.auth.KafkaPrincipal\n import org.junit.{Assert, Test}\n-import org.scalatestplus.junit.JUnitSuite\n \n-import scala.jdk.CollectionConverters._\n+import scala.collection.JavaConverters._", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fec67e0b523c6b7070b4083afb9ae29478afd36b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0MzUxNQ==", "bodyText": "I'm probably missing something obvious, but I found the following callers of this function: DeleteRecordsCommand, LeaderElectionCommand, PreferredReplicaLeaderElectionCommand, and ReassignPartitionsCommand. As far as I can tell, none of these uses involve the parsing of ACLs. Did we lose this compatibility handling at some point or is there some magic invocation?", "url": "https://github.com/apache/kafka/pull/8591#discussion_r418743515", "createdAt": "2020-05-01T21:21:53Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/utils/Json.scala", "diffHunk": "@@ -35,16 +35,7 @@ object Json {\n    */\n   def parseFull(input: String): Option[JsonValue] =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fec67e0b523c6b7070b4083afb9ae29478afd36b"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "755634fc3db7e704fad6534a3a3e7705de29c4d3", "author": {"user": {"login": "viktorsomogyi", "name": "Viktor Somogyi-Vass"}}, "url": "https://github.com/apache/kafka/commit/755634fc3db7e704fad6534a3a3e7705de29c4d3", "committedDate": "2020-05-05T11:33:02Z", "message": "Use jdk.CollectionConverters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9c70ff061b5a7a3780001407864cb4e823fc002", "author": {"user": {"login": "viktorsomogyi", "name": "Viktor Somogyi-Vass"}}, "url": "https://github.com/apache/kafka/commit/b9c70ff061b5a7a3780001407864cb4e823fc002", "committedDate": "2020-05-06T13:38:02Z", "message": "Get rid of parseBytesWithAclFallback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdfa380fad992d4f6840344b28c57bb4a80bd5de", "author": {"user": {"login": "viktorsomogyi", "name": "Viktor Somogyi-Vass"}}, "url": "https://github.com/apache/kafka/commit/bdfa380fad992d4f6840344b28c57bb4a80bd5de", "committedDate": "2020-05-06T14:41:18Z", "message": "Optimize imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "802e255683ee1f33df9935f7914f5eda2a6c1d52", "author": {"user": {"login": "viktorsomogyi", "name": "Viktor Somogyi-Vass"}}, "url": "https://github.com/apache/kafka/commit/802e255683ee1f33df9935f7914f5eda2a6c1d52", "committedDate": "2020-05-06T15:24:11Z", "message": "Revert AclEntry import changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2ODA1NDg5", "url": "https://github.com/apache/kafka/pull/8591#pullrequestreview-406805489", "createdAt": "2020-05-06T16:54:29Z", "commit": {"oid": "802e255683ee1f33df9935f7914f5eda2a6c1d52"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2ODEwODAw", "url": "https://github.com/apache/kafka/pull/8591#pullrequestreview-406810800", "createdAt": "2020-05-06T17:00:55Z", "commit": {"oid": "802e255683ee1f33df9935f7914f5eda2a6c1d52"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1306, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}