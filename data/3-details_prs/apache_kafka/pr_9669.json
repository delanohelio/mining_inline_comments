{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNTM5ODM0", "number": 9669, "title": "KAFKA-10792: Prevent source task shutdown from blocking herder thread", "bodyText": "Jira\nThe functional changes are simple: change the WorkerSourceTask class to only call SourceTask::stop from one location, during task shutdown, and only if an attempt has been made to start the task (which will not be the case if it was created in the paused state and then shut down before being started). This is important in order to prevent SourceTask::stop from being indirectly invoked on the herder's thread, which can have adverse effects if the task is unable to shut down promptly.\nUnit tests are tweaked where necessary to account for this new logic, which covers some edge cases mentioned in #5020 that were unaddressed up until now.\nThe existing integration tests for blocking connectors are expanded to also include cases for blocking source and sink tasks. Full coverage of every source/sink task method is intentionally omitted from these expanded tests in order to avoid inflating test runtime (each one adds an extra 5 seconds at minimum) and because the tests that are added here were sufficient to reproduce the bug with source task shutdown.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-12-01T19:59:55Z", "url": "https://github.com/apache/kafka/pull/9669", "merged": true, "mergeCommit": {"oid": "4f2f08eb006cdf3dc848b34b4b17cf27a023e9da"}, "closed": true, "closedAt": "2020-12-04T17:48:24Z", "author": {"login": "C0urante"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh_eGdAH2gAyNTMwNTM5ODM0OjJiZTE4M2VmMzY2NDBkZWFlN2I5YTc1MTY2NjM5ZTcyZWUxZDc5Mjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi7Ya8AFqTU0NTE2NjI2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2be183ef36640deae7b9a75166639e72ee1d7929", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/2be183ef36640deae7b9a75166639e72ee1d7929", "committedDate": "2020-12-01T19:53:38Z", "message": "KAFKA-10792: Prevent source task shutdown from blocking herder thread"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzc5MjUw", "url": "https://github.com/apache/kafka/pull/9669#pullrequestreview-542379250", "createdAt": "2020-12-01T23:21:01Z", "commit": {"oid": "2be183ef36640deae7b9a75166639e72ee1d7929"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMzoyMTowMlrOH9D4XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMzoyMTowMlrOH9D4XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc4ODc2NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // can happy reliably if it's started in the PAUSED state), we don't have to invoke stop on it\n          \n          \n            \n                    // can happen reliably if it's started in the PAUSED state), we don't have to invoke stop on it", "url": "https://github.com/apache/kafka/pull/9669#discussion_r533788764", "createdAt": "2020-12-01T23:21:02Z", "author": {"login": "ncliang"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSourceTask.java", "diffHunk": "@@ -206,16 +203,13 @@ public void cancel() {\n     public void stop() {\n         super.stop();\n         stopRequestedLatch.countDown();\n-        synchronized (this) {\n-            if (finishedStart)\n-                tryStop();\n-            else\n-                startedShutdownBeforeStartCompleted = true;\n-        }\n     }\n \n-    private synchronized void tryStop() {\n-        if (!stopped) {\n+    // Note: This method is not thread-safe\n+    private void tryStop() {\n+        // If the task is scheduled for shutdown before we invoke initialize or start on it (which\n+        // can happy reliably if it's started in the PAUSED state), we don't have to invoke stop on it", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2be183ef36640deae7b9a75166639e72ee1d7929"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50b0792cd1300a3ff783bfa0411fed140fdfade6", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/50b0792cd1300a3ff783bfa0411fed140fdfade6", "committedDate": "2020-12-01T23:55:51Z", "message": "KAFKA-10792: Fix typo in comment\r\n\r\nhappy -> happen\n\nCo-authored-by: Nigel Liang <nigel@nigelliang.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNjkwMzM2", "url": "https://github.com/apache/kafka/pull/9669#pullrequestreview-542690336", "createdAt": "2020-12-02T10:21:27Z", "commit": {"oid": "50b0792cd1300a3ff783bfa0411fed140fdfade6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTU5OTE4", "url": "https://github.com/apache/kafka/pull/9669#pullrequestreview-543159918", "createdAt": "2020-12-02T19:17:26Z", "commit": {"oid": "50b0792cd1300a3ff783bfa0411fed140fdfade6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOToxNzoyNlrOH9qYxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTo1NTozMFrOH9rvow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxOTY1NQ==", "bodyText": "Maybe a nit, but this comment seems a bit misleading. It sounds as if the method need be called from a thread safe point, but otherwise there are no restrictions on how it's used.\nStrictly speaking, this method need not be thread safe because it should only be called from within close(), which is called from the task's own thread and therefore is thread safe. Perhaps this design assumption should be mentioned here.", "url": "https://github.com/apache/kafka/pull/9669#discussion_r534419655", "createdAt": "2020-12-02T19:17:26Z", "author": {"login": "rhauch"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSourceTask.java", "diffHunk": "@@ -206,16 +203,13 @@ public void cancel() {\n     public void stop() {\n         super.stop();\n         stopRequestedLatch.countDown();\n-        synchronized (this) {\n-            if (finishedStart)\n-                tryStop();\n-            else\n-                startedShutdownBeforeStartCompleted = true;\n-        }\n     }\n \n-    private synchronized void tryStop() {\n-        if (!stopped) {\n+    // Note: This method is not thread-safe", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50b0792cd1300a3ff783bfa0411fed140fdfade6"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQyNzUzOQ==", "bodyText": "Minor suggestions to improve wording and to be a bit more explicit about expectations for Task implementations:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // If we try to start the task at all (by invoking initialize and possibly start), we count this as\n          \n          \n            \n                        // \"started\" in order to properly clean up any resources allocated by those invocations when the task is\n          \n          \n            \n                        // shut down by calling stop. If the task throws an exception during startup, it should still be able to\n          \n          \n            \n                        // clean up any allocated resources when stop is called, and if it isn't able to or even throws another\n          \n          \n            \n                        // exception during stop, the worst thing that happens is another exception gets logged for an already-\n          \n          \n            \n                        // failed task\n          \n          \n            \n                        // If we try to start the task at all by invoking initialize, then count this as\n          \n          \n            \n                        // \"started\" and expect a subsequent call to the task's stop() method\n          \n          \n            \n                        // to properly clean up any resources allocated by its initialize() or \n          \n          \n            \n                        // start() methods. If the task throws an exception during stop(),\n          \n          \n            \n                        // the worst thing that happens is another exception gets logged for an already-\n          \n          \n            \n                        // failed task", "url": "https://github.com/apache/kafka/pull/9669#discussion_r534427539", "createdAt": "2020-12-02T19:30:46Z", "author": {"login": "rhauch"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSourceTask.java", "diffHunk": "@@ -228,17 +222,16 @@ private synchronized void tryStop() {\n     @Override\n     public void execute() {\n         try {\n+            // If we try to start the task at all (by invoking initialize and possibly start), we count this as\n+            // \"started\" in order to properly clean up any resources allocated by those invocations when the task is\n+            // shut down by calling stop. If the task throws an exception during startup, it should still be able to\n+            // clean up any allocated resources when stop is called, and if it isn't able to or even throws another\n+            // exception during stop, the worst thing that happens is another exception gets logged for an already-\n+            // failed task", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50b0792cd1300a3ff783bfa0411fed140fdfade6"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0MTg5MQ==", "bodyText": "How does this static field initialization work within a blocking connector that also has a blocking task instance? Aren't both constructors called, resulting in the task constructor re-initializing the static blockLatch instance? Does it work because the tests don't block both a connector method and a task method? If so, doesn't that make it somewhat brittle if people want to add more tests but don't infer that limitation?\nWould it be better to store a static list of all Block latches, have the constructor simply create a block latch and add it to that static list, and then have the resetBlockLatch() method remove each of the Block latches and call countDown() on them? (This still doesn't bode well for running the tests in parallel, but ATM that's not an issue.)", "url": "https://github.com/apache/kafka/pull/9669#discussion_r534441891", "createdAt": "2020-12-02T19:55:30Z", "author": {"login": "rhauch"}, "path": "connect/runtime/src/test/java/org/apache/kafka/connect/integration/BlockingConnectorTest.java", "diffHunk": "@@ -263,145 +332,153 @@ private void verifyNormalConnector() throws InterruptedException {\n         normalConnectorHandle.awaitCommits(RECORD_TRANSFER_DURATION_MS);\n     }\n \n-    public static class BlockingConnector extends SourceConnector {\n-\n+    private static class Block {\n         private static CountDownLatch blockLatch;\n \n-        private String block;\n+        private final String block;\n \n         public static final String BLOCK_CONFIG = \"block\";\n \n-        public static final String INITIALIZE = \"initialize\";\n-        public static final String INITIALIZE_WITH_TASK_CONFIGS = \"initializeWithTaskConfigs\";\n-        public static final String START = \"start\";\n-        public static final String RECONFIGURE = \"reconfigure\";\n-        public static final String TASK_CLASS = \"taskClass\";\n-        public static final String TASK_CONFIGS = \"taskConfigs\";\n-        public static final String STOP = \"stop\";\n-        public static final String VALIDATE = \"validate\";\n-        public static final String CONFIG = \"config\";\n-        public static final String VERSION = \"version\";\n-\n-        private static final ConfigDef CONFIG_DEF = new ConfigDef()\n-            .define(\n-                BLOCK_CONFIG,\n-                ConfigDef.Type.STRING,\n-                \"\",\n-                ConfigDef.Importance.MEDIUM,\n-                \"Where to block indefinitely, e.g., 'start', 'initialize', 'taskConfigs', 'version'\"\n-            );\n-\n-        // No-args constructor required by the framework\n-        public BlockingConnector() {\n-            this(null);\n-        }\n-\n-        protected BlockingConnector(String block) {\n-            this.block = block;\n-            synchronized (BlockingConnector.class) {\n-                if (blockLatch != null) {\n-                    blockLatch.countDown();\n-                }\n-                blockLatch = new CountDownLatch(1);\n-            }\n+        private static ConfigDef config() {\n+            return new ConfigDef()\n+                .define(\n+                    BLOCK_CONFIG,\n+                    ConfigDef.Type.STRING,\n+                    \"\",\n+                    ConfigDef.Importance.MEDIUM,\n+                    \"Where to block indefinitely, e.g., 'start', 'initialize', 'taskConfigs', 'version'\"\n+                );\n         }\n \n         public static void waitForBlock() throws InterruptedException {\n-            synchronized (BlockingConnector.class) {\n+            synchronized (Block.class) {\n                 if (blockLatch == null) {\n                     throw new IllegalArgumentException(\"No connector has been created yet\");\n                 }\n             }\n-            \n+\n             log.debug(\"Waiting for connector to block\");\n             blockLatch.await();\n             log.debug(\"Connector should now be blocked\");\n         }\n \n         public static void resetBlockLatch() {\n-            synchronized (BlockingConnector.class) {\n+            synchronized (Block.class) {\n                 if (blockLatch != null) {\n                     blockLatch.countDown();\n                     blockLatch = null;\n                 }\n             }\n         }\n \n+        public Block(Map<String, String> props) {\n+            this(new AbstractConfig(config(), props).getString(BLOCK_CONFIG));\n+        }\n+\n+        public Block(String block) {\n+            this.block = block;\n+            synchronized (Block.class) {\n+                if (blockLatch != null) {\n+                    blockLatch.countDown();\n+                }\n+                blockLatch = new CountDownLatch(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50b0792cd1300a3ff783bfa0411fed140fdfade6"}, "originalPosition": 367}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31942bdef370ac7e26f7150b761a097926d11e40", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/31942bdef370ac7e26f7150b761a097926d11e40", "committedDate": "2020-12-02T20:16:24Z", "message": "KAFKA-10792: Improve wording in comment\n\nCo-authored-by: Randall Hauch <rhauch@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a82bc441d62f7fb3ba1e489ad46b29da3c5c4e9", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/9a82bc441d62f7fb3ba1e489ad46b29da3c5c4e9", "committedDate": "2020-12-02T20:39:04Z", "message": "KAFKA-10792: Slight refactoring for readability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f349014317f0005564eef55ef83dde815d877e12", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/f349014317f0005564eef55ef83dde815d877e12", "committedDate": "2020-12-02T23:19:29Z", "message": "KAFKA-10792: Add comment on current limitations of blocking connector/task tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MTY2MjY5", "url": "https://github.com/apache/kafka/pull/9669#pullrequestreview-545166269", "createdAt": "2020-12-04T17:41:44Z", "commit": {"oid": "f349014317f0005564eef55ef83dde815d877e12"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2504, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}