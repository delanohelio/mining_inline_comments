{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5OTY2OTU4", "number": 9589, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQyMzozMDo1M1rOFTVF6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQwMjoyMTo1OVrOFUVLtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU1ODEyODQxOnYy", "diffSide": "RIGHT", "path": "connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorMakerConfig.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQyMzozMDo1M1rOIavW8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOFQwMjoxMzozNlrOIbkCAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDkwOTgxMQ==", "bodyText": "Question @twobeeb and @ryannedolan about this: is there a use case for which a cluster pair would be disabled yet its heartbeats enabled? I'm wondering because in the case someone disabled the cluster pair but didn't think to disable the heartbeats (since it defaults to true), these herders would still be created, but I'm not sure if it would be useful to have them created since there is no replication going on. Would it make more sense to just not create a herder if the cluster pair was disabled (instead of checking the heartbeats as well)? If not can we make sure to add documentation about this behavior?", "url": "https://github.com/apache/kafka/pull/9589#discussion_r564909811", "createdAt": "2021-01-26T23:30:53Z", "author": {"login": "skaundinya15"}, "path": "connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorMakerConfig.java", "diffHunk": "@@ -89,11 +89,25 @@ public MirrorMakerConfig(Map<?, ?> props) {\n     public List<SourceAndTarget> clusterPairs() {\n         List<SourceAndTarget> pairs = new ArrayList<>();\n         Set<String> clusters = clusters();\n+        Map<String, String> originalStrings = originalsStrings();\n+        boolean globalHeartbeatsEnabled = MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED_DEFAULT;\n+        if (originalStrings.containsKey(MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED)) {\n+            globalHeartbeatsEnabled = Boolean.valueOf(originalStrings.get(MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED));\n+        }\n+\n         for (String source : clusters) {\n             for (String target : clusters) {\n-                SourceAndTarget sourceAndTarget = new SourceAndTarget(source, target);\n                 if (!source.equals(target)) {\n-                    pairs.add(sourceAndTarget);\n+                    String clusterPairConfigPrefix = source + \"->\" + target + \".\";\n+                    boolean clusterPairEnabled = Boolean.valueOf(originalStrings.getOrDefault(clusterPairConfigPrefix + \"enabled\", \"false\"));\n+                    boolean clusterPairHeartbeatsEnabled = globalHeartbeatsEnabled;\n+                    if (originalStrings.containsKey(clusterPairConfigPrefix + MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED)) {\n+                        clusterPairHeartbeatsEnabled = Boolean.valueOf(originalStrings.get(clusterPairConfigPrefix + MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED));\n+                    }\n+\n+                    if (clusterPairEnabled || clusterPairHeartbeatsEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c35435f1120e3019a770c7807cef3112860786a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTEwOTIxOQ==", "bodyText": "That's actually the current behavior, all herders are created and the beats are emitted from the \"opposite\" herder\nIf you have a replication flow from A to B and you want heartbeats, you need 2 herders :\n\nA->B for the MirrorSourceConnector\nB->A for the MirrorHeartbeatConnector\n\nThe MirrorHeartbeatConnector on B->A emits beats into topic heartbeats on cluster A.\nThe MirrorSourceConnector on A->B then replicates whichever topic is configured as well as heartbeats.\nAll of this is fine with 2-3 clusters. It starts to make less sense when using 10+ clusters.\nBecause this is the current implementation, we decided to keep it as-is so as to not cause change in behavior, and add a new top-level property \"emit.heartbeats.enabled\" which defaults to \"true\".\nExisting users will not see any change and if they depend on these \"opposites\" herders for their monitoring, it will still work.\nNew users with more complex use case can change this property and fine tune their heartbeat generation.", "url": "https://github.com/apache/kafka/pull/9589#discussion_r565109219", "createdAt": "2021-01-27T08:22:07Z", "author": {"login": "twobeeb"}, "path": "connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorMakerConfig.java", "diffHunk": "@@ -89,11 +89,25 @@ public MirrorMakerConfig(Map<?, ?> props) {\n     public List<SourceAndTarget> clusterPairs() {\n         List<SourceAndTarget> pairs = new ArrayList<>();\n         Set<String> clusters = clusters();\n+        Map<String, String> originalStrings = originalsStrings();\n+        boolean globalHeartbeatsEnabled = MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED_DEFAULT;\n+        if (originalStrings.containsKey(MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED)) {\n+            globalHeartbeatsEnabled = Boolean.valueOf(originalStrings.get(MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED));\n+        }\n+\n         for (String source : clusters) {\n             for (String target : clusters) {\n-                SourceAndTarget sourceAndTarget = new SourceAndTarget(source, target);\n                 if (!source.equals(target)) {\n-                    pairs.add(sourceAndTarget);\n+                    String clusterPairConfigPrefix = source + \"->\" + target + \".\";\n+                    boolean clusterPairEnabled = Boolean.valueOf(originalStrings.getOrDefault(clusterPairConfigPrefix + \"enabled\", \"false\"));\n+                    boolean clusterPairHeartbeatsEnabled = globalHeartbeatsEnabled;\n+                    if (originalStrings.containsKey(clusterPairConfigPrefix + MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED)) {\n+                        clusterPairHeartbeatsEnabled = Boolean.valueOf(originalStrings.get(clusterPairConfigPrefix + MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED));\n+                    }\n+\n+                    if (clusterPairEnabled || clusterPairHeartbeatsEnabled) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDkwOTgxMQ=="}, "originalCommit": {"oid": "9c35435f1120e3019a770c7807cef3112860786a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY1NjEzMQ==", "bodyText": "Thanks for the explanation @twobeeb, this makes sense. It would be good to add some comments explaining this in the code as this isn't immediately obvious. Other than that it looks good to me overall.", "url": "https://github.com/apache/kafka/pull/9589#discussion_r565656131", "createdAt": "2021-01-27T21:45:32Z", "author": {"login": "skaundinya15"}, "path": "connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorMakerConfig.java", "diffHunk": "@@ -89,11 +89,25 @@ public MirrorMakerConfig(Map<?, ?> props) {\n     public List<SourceAndTarget> clusterPairs() {\n         List<SourceAndTarget> pairs = new ArrayList<>();\n         Set<String> clusters = clusters();\n+        Map<String, String> originalStrings = originalsStrings();\n+        boolean globalHeartbeatsEnabled = MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED_DEFAULT;\n+        if (originalStrings.containsKey(MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED)) {\n+            globalHeartbeatsEnabled = Boolean.valueOf(originalStrings.get(MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED));\n+        }\n+\n         for (String source : clusters) {\n             for (String target : clusters) {\n-                SourceAndTarget sourceAndTarget = new SourceAndTarget(source, target);\n                 if (!source.equals(target)) {\n-                    pairs.add(sourceAndTarget);\n+                    String clusterPairConfigPrefix = source + \"->\" + target + \".\";\n+                    boolean clusterPairEnabled = Boolean.valueOf(originalStrings.getOrDefault(clusterPairConfigPrefix + \"enabled\", \"false\"));\n+                    boolean clusterPairHeartbeatsEnabled = globalHeartbeatsEnabled;\n+                    if (originalStrings.containsKey(clusterPairConfigPrefix + MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED)) {\n+                        clusterPairHeartbeatsEnabled = Boolean.valueOf(originalStrings.get(clusterPairConfigPrefix + MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED));\n+                    }\n+\n+                    if (clusterPairEnabled || clusterPairHeartbeatsEnabled) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDkwOTgxMQ=="}, "originalCommit": {"oid": "9c35435f1120e3019a770c7807cef3112860786a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTcwNDIxOA==", "bodyText": "Thanks for your review @skaundinya15.\nI'm having a hard time phrasing this properly, suggestions would be welcome.\nIs this comment proposition aligned with what you had in mind ?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (clusterPairEnabled || clusterPairHeartbeatsEnabled) {\n          \n          \n            \n                                // By default, all source->target Herder combinations are created even if `x->y.enabled=false`\n          \n          \n            \n                                // Unless `emit.heartbeats.enabled=false` or `x->y.emit.heartbeats.enabled=false`\n          \n          \n            \n                                // Reason for this behavior: for a given replication flow A->B with heartbeats, 2 herders are required :\n          \n          \n            \n                                // B->A for the MirrorHeartbeatConnector (emits heartbeats into A)\n          \n          \n            \n                                // A->B for the MirrorSourceConnector (actual replication flow)\n          \n          \n            \n                                if (clusterPairEnabled || clusterPairHeartbeatsEnabled) {", "url": "https://github.com/apache/kafka/pull/9589#discussion_r565704218", "createdAt": "2021-01-27T23:16:26Z", "author": {"login": "twobeeb"}, "path": "connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorMakerConfig.java", "diffHunk": "@@ -89,11 +89,25 @@ public MirrorMakerConfig(Map<?, ?> props) {\n     public List<SourceAndTarget> clusterPairs() {\n         List<SourceAndTarget> pairs = new ArrayList<>();\n         Set<String> clusters = clusters();\n+        Map<String, String> originalStrings = originalsStrings();\n+        boolean globalHeartbeatsEnabled = MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED_DEFAULT;\n+        if (originalStrings.containsKey(MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED)) {\n+            globalHeartbeatsEnabled = Boolean.valueOf(originalStrings.get(MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED));\n+        }\n+\n         for (String source : clusters) {\n             for (String target : clusters) {\n-                SourceAndTarget sourceAndTarget = new SourceAndTarget(source, target);\n                 if (!source.equals(target)) {\n-                    pairs.add(sourceAndTarget);\n+                    String clusterPairConfigPrefix = source + \"->\" + target + \".\";\n+                    boolean clusterPairEnabled = Boolean.valueOf(originalStrings.getOrDefault(clusterPairConfigPrefix + \"enabled\", \"false\"));\n+                    boolean clusterPairHeartbeatsEnabled = globalHeartbeatsEnabled;\n+                    if (originalStrings.containsKey(clusterPairConfigPrefix + MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED)) {\n+                        clusterPairHeartbeatsEnabled = Boolean.valueOf(originalStrings.get(clusterPairConfigPrefix + MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED));\n+                    }\n+\n+                    if (clusterPairEnabled || clusterPairHeartbeatsEnabled) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDkwOTgxMQ=="}, "originalCommit": {"oid": "9c35435f1120e3019a770c7807cef3112860786a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTc3MjgwMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (clusterPairEnabled || clusterPairHeartbeatsEnabled) {\n          \n          \n            \n                                // By default, all source->target Herder combinations are created even if `x->y.enabled=false`\n          \n          \n            \n                                // Unless `emit.heartbeats.enabled=false` or `x->y.emit.heartbeats.enabled=false`\n          \n          \n            \n                                // Reason for this behavior: for a given replication flow A->B with heartbeats, 2 herders are required :\n          \n          \n            \n                                // B->A for the MirrorHeartbeatConnector (emits heartbeats into A for monitoring replication health)\n          \n          \n            \n                                // A->B for the MirrorSourceConnector (actual replication flow)\n          \n          \n            \n                                if (clusterPairEnabled || clusterPairHeartbeatsEnabled) {\n          \n      \n    \n    \n  \n\nLooks good to me, just had a small tweak for the B->A comment. Thanks!", "url": "https://github.com/apache/kafka/pull/9589#discussion_r565772802", "createdAt": "2021-01-28T02:13:36Z", "author": {"login": "skaundinya15"}, "path": "connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorMakerConfig.java", "diffHunk": "@@ -89,11 +89,25 @@ public MirrorMakerConfig(Map<?, ?> props) {\n     public List<SourceAndTarget> clusterPairs() {\n         List<SourceAndTarget> pairs = new ArrayList<>();\n         Set<String> clusters = clusters();\n+        Map<String, String> originalStrings = originalsStrings();\n+        boolean globalHeartbeatsEnabled = MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED_DEFAULT;\n+        if (originalStrings.containsKey(MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED)) {\n+            globalHeartbeatsEnabled = Boolean.valueOf(originalStrings.get(MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED));\n+        }\n+\n         for (String source : clusters) {\n             for (String target : clusters) {\n-                SourceAndTarget sourceAndTarget = new SourceAndTarget(source, target);\n                 if (!source.equals(target)) {\n-                    pairs.add(sourceAndTarget);\n+                    String clusterPairConfigPrefix = source + \"->\" + target + \".\";\n+                    boolean clusterPairEnabled = Boolean.valueOf(originalStrings.getOrDefault(clusterPairConfigPrefix + \"enabled\", \"false\"));\n+                    boolean clusterPairHeartbeatsEnabled = globalHeartbeatsEnabled;\n+                    if (originalStrings.containsKey(clusterPairConfigPrefix + MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED)) {\n+                        clusterPairHeartbeatsEnabled = Boolean.valueOf(originalStrings.get(clusterPairConfigPrefix + MirrorConnectorConfig.EMIT_HEARTBEATS_ENABLED));\n+                    }\n+\n+                    if (clusterPairEnabled || clusterPairHeartbeatsEnabled) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDkwOTgxMQ=="}, "originalCommit": {"oid": "9c35435f1120e3019a770c7807cef3112860786a"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU2ODYyOTAwOnYy", "diffSide": "RIGHT", "path": "connect/mirror/src/test/java/org/apache/kafka/connect/mirror/MirrorMakerConfigTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQwMjoyMTo1OVrOIcSqJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQwMjozNTowN1rOIcS6Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjUzNjc0MA==", "bodyText": "@twobeeb Could you migrate these to use the new JUnit 5 assertEquals API? Looks like the build actually failed here - https://github.com/apache/kafka/runs/1782294502", "url": "https://github.com/apache/kafka/pull/9589#discussion_r566536740", "createdAt": "2021-01-29T02:21:59Z", "author": {"login": "aloknnikhil"}, "path": "connect/mirror/src/test/java/org/apache/kafka/connect/mirror/MirrorMakerConfigTest.java", "diffHunk": "@@ -256,6 +257,80 @@ public void testWorkerConfigs() {\n             \"secret2\", bProps.get(\"producer.ssl.key.password\"));\n     }\n \n+    @Test\n+    public void testClusterPairsWithDefaultSettings() {\n+        MirrorMakerConfig mirrorConfig = new MirrorMakerConfig(makeProps(\n+                \"clusters\", \"a, b, c\"));\n+        // implicit configuration associated\n+        // a->b.enabled=false\n+        // a->b.emit.heartbeat.enabled=true\n+        // a->c.enabled=false\n+        // a->c.emit.heartbeat.enabled=true\n+        // b->a.enabled=false\n+        // b->a.emit.heartbeat.enabled=true\n+        // b->c.enabled=false\n+        // b->c.emit.heartbeat.enabled=true\n+        // c->a.enabled=false\n+        // c->a.emit.heartbeat.enabled=true\n+        // c->b.enabled=false\n+        // c->b.emit.heartbeat.enabled=true\n+        List<SourceAndTarget> clusterPairs = mirrorConfig.clusterPairs();\n+        assertEquals(\"clusterPairs count should match all combinations count\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14868a9cd0ed78c130c5460a1f770d3724d5e0e4"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjU0MDg4Ng==", "bodyText": "I fixed the build via bf4afae", "url": "https://github.com/apache/kafka/pull/9589#discussion_r566540886", "createdAt": "2021-01-29T02:35:07Z", "author": {"login": "ijuma"}, "path": "connect/mirror/src/test/java/org/apache/kafka/connect/mirror/MirrorMakerConfigTest.java", "diffHunk": "@@ -256,6 +257,80 @@ public void testWorkerConfigs() {\n             \"secret2\", bProps.get(\"producer.ssl.key.password\"));\n     }\n \n+    @Test\n+    public void testClusterPairsWithDefaultSettings() {\n+        MirrorMakerConfig mirrorConfig = new MirrorMakerConfig(makeProps(\n+                \"clusters\", \"a, b, c\"));\n+        // implicit configuration associated\n+        // a->b.enabled=false\n+        // a->b.emit.heartbeat.enabled=true\n+        // a->c.enabled=false\n+        // a->c.emit.heartbeat.enabled=true\n+        // b->a.enabled=false\n+        // b->a.emit.heartbeat.enabled=true\n+        // b->c.enabled=false\n+        // b->c.emit.heartbeat.enabled=true\n+        // c->a.enabled=false\n+        // c->a.emit.heartbeat.enabled=true\n+        // c->b.enabled=false\n+        // c->b.emit.heartbeat.enabled=true\n+        List<SourceAndTarget> clusterPairs = mirrorConfig.clusterPairs();\n+        assertEquals(\"clusterPairs count should match all combinations count\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjUzNjc0MA=="}, "originalCommit": {"oid": "14868a9cd0ed78c130c5460a1f770d3724d5e0e4"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3848, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}