{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNTIzNzM5", "number": 8177, "title": "KAFKA-9605: Do not attempt to abort batches when txn manager is in fatal error", "bodyText": "We detected a bug in soak where the producer batches shall be failed in sender loop before the produce response callback. This shall trigger an illegal state exception on the producer batch as it is already aborted.\nThe impact is not severe since sender is on its own thread but should be fixed to avoid unnecessary critical exception.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-02-26T21:47:32Z", "url": "https://github.com/apache/kafka/pull/8177", "merged": true, "mergeCommit": {"oid": "f19a79800833acda0379898fd08911c4d96d2c6c"}, "closed": true, "closedAt": "2020-03-11T22:24:00Z", "author": {"login": "abbccdda"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcINf9YgH2gAyMzgwNTIzNzM5OjBhOTk3YTQwYmYyZmNiYzI3NTMzOGNhZjA5NGEzOWJkYjM3MzA1MWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMrOeTAFqTM3MzAxMDAzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0a997a40bf2fcbc275338caf094a39bdb373051e", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/0a997a40bf2fcbc275338caf094a39bdb373051e", "committedDate": "2020-02-26T21:21:09Z", "message": "do not handle failed batch after producer fenced\n\nThis reverts commit db81ce6b7cd31f6b133c044cec6f3a9742573a4e."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dad1a5278db7738fb5470874e040544e51bd592", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/0dad1a5278db7738fb5470874e040544e51bd592", "committedDate": "2020-02-26T22:01:23Z", "message": "unit test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "0dad1a5278db7738fb5470874e040544e51bd592", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/0dad1a5278db7738fb5470874e040544e51bd592", "committedDate": "2020-02-26T22:01:23Z", "message": "unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NDAwMjAx", "url": "https://github.com/apache/kafka/pull/8177#pullrequestreview-367400201", "createdAt": "2020-03-02T17:50:20Z", "commit": {"oid": "0dad1a5278db7738fb5470874e040544e51bd592"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNzo1MDoyMFrOFwpF9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNzo1MDoyM1rOFwpGFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0OTIzOA==", "bodyText": "nit: we might want log different message if we're ignoring due to a fatal state instead of due to a bumped epoch or ID.", "url": "https://github.com/apache/kafka/pull/8177#discussion_r386549238", "createdAt": "2020-03-02T17:50:20Z", "author": {"login": "bob-barrett"}, "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java", "diffHunk": "@@ -706,9 +706,9 @@ synchronized void handleFailedBatch(ProducerBatch batch, RuntimeException except\n         maybeTransitionToErrorState(exception);\n         removeInFlightBatch(batch);\n \n-        if (!matchesProducerIdAndEpoch(batch)) {\n+        if (!matchesProducerIdAndEpoch(batch) || hasFatalError()) {\n             log.debug(\"Ignoring failed batch {} with producer id {}, epoch {}, and sequence number {} \" +\n-                            \"since the producerId has been reset internally\", batch, batch.producerId(),\n+                            \"since the batch has been reset internally\", batch, batch.producerId(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0dad1a5278db7738fb5470874e040544e51bd592"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0OTI3MA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/apache/kafka/pull/8177#discussion_r386549270", "createdAt": "2020-03-02T17:50:23Z", "author": {"login": "bob-barrett"}, "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/Sender.java", "diffHunk": "@@ -740,11 +740,7 @@ private void sendProduceRequest(long now, int destination, short acks, int timeo\n         }\n         ProduceRequest.Builder requestBuilder = ProduceRequest.Builder.forMagic(minUsedMagic, acks, timeout,\n                 produceRecordsByPartition, transactionalId);\n-        RequestCompletionHandler callback = new RequestCompletionHandler() {\n-            public void onComplete(ClientResponse response) {\n-                handleProduceResponse(response, recordsByPartition, time.milliseconds());\n-            }\n-        };\n+        RequestCompletionHandler callback = response -> handleProduceResponse(response, recordsByPartition, time.milliseconds());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0dad1a5278db7738fb5470874e040544e51bd592"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "5798cee17a381dcf4154cb665f2610fd4a56ce2c", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/5798cee17a381dcf4154cb665f2610fd4a56ce2c", "committedDate": "2020-03-02T23:12:14Z", "message": "amend log"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "5798cee17a381dcf4154cb665f2610fd4a56ce2c", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/5798cee17a381dcf4154cb665f2610fd4a56ce2c", "committedDate": "2020-03-02T23:12:14Z", "message": "amend log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMDEwMDM2", "url": "https://github.com/apache/kafka/pull/8177#pullrequestreview-373010036", "createdAt": "2020-03-11T18:14:54Z", "commit": {"oid": "5798cee17a381dcf4154cb665f2610fd4a56ce2c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1592, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}