{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MDc3OTM4", "number": 8285, "title": "KAFKA-9700:Fix negative estimatedCompressionRatio issue", "bodyText": "There are cases that currentEstimation is smaller than\nCOMPRESSION_RATIO_IMPROVING_STEP and it will get negative\nestimatedCompressionRatio,which leads to misjudgment\nabout if there is no room and MESSAGE_TOO_LARGE might occur.\nChange-Id: I0932a2a6ca669f673ab5d862d3fe7b2bb6d96ff6\nSigned-off-by: Jiamei Xie jiamei.xie@arm.com\nMore detailed description of your change,\nif necessary. The PR title and PR message become\nthe squashed commit message, so use a separate\ncomment to ping reviewers.\nSummary of testing strategy (including rationale)\nfor the feature or bug fix. Unit and/or integration\ntests are expected for any behaviour change and\nsystem tests should be considered for larger changes.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-03-12T07:12:08Z", "url": "https://github.com/apache/kafka/pull/8285", "merged": true, "mergeCommit": {"oid": "b5409b9c04d7aa102ab9ca0f8fdea46235da8554"}, "closed": true, "closedAt": "2020-03-25T03:48:51Z", "author": {"login": "jiameixie"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM2OxfgH2gAyMzg3MDc3OTM4OjYxYWUxMjY2YzY1NWI3ZTUxNmFhMThkNTRmNGMwYTk2ODMzMzJiNmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQz1l9AH2gAyMzg3MDc3OTM4OjUzN2M0MDJhNjI4Yjc2NzI5NWJhNWEwZGUxZmVkODU2MTVlMGFjZTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "61ae1266c655b7e516aa18d54f4c0a9683332b6a", "author": {"user": {"login": "jiameixie", "name": null}}, "url": "https://github.com/apache/kafka/commit/61ae1266c655b7e516aa18d54f4c0a9683332b6a", "committedDate": "2020-03-12T07:04:11Z", "message": "Fix negative estimatedCompressionRatio issue\n\nThere are cases that currentEstimation is smaller than\nCOMPRESSION_RATIO_IMPROVING_STEP and it will get negative\nestimatedCompressionRatio,which leads to misjudgment\nabout if there is no room and MESSAGE_TOO_LARGE might occur.\n\nChange-Id: I0932a2a6ca669f673ab5d862d3fe7b2bb6d96ff6\nSigned-off-by: Jiamei Xie <jiamei.xie@arm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMzQ5ODAz", "url": "https://github.com/apache/kafka/pull/8285#pullrequestreview-373349803", "createdAt": "2020-03-12T08:18:17Z", "commit": {"oid": "61ae1266c655b7e516aa18d54f4c0a9683332b6a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36d7cb7d7200ccff56fa7387b214a434fcb2beff", "author": {"user": {"login": "jiameixie", "name": null}}, "url": "https://github.com/apache/kafka/commit/36d7cb7d7200ccff56fa7387b214a434fcb2beff", "committedDate": "2020-03-13T09:42:49Z", "message": "Fix negative estimatedCompressionRatio issue\n\nThere are cases that currentEstimation is smaller than\nCOMPRESSION_RATIO_IMPROVING_STEP and it will get negative\nestimatedCompressionRatio,which leads to misjudgment\nabout if there is no room and MESSAGE_TOO_LARGE might occur.\n\nChange-Id: I0932a2a6ca669f673ab5d862d3fe7b2bb6d96ff6\nSigned-off-by: Jiamei Xie <jiamei.xie@arm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f998cdf26e0b1fbc464908207be5cdb72bbba921", "author": {"user": {"login": "jiameixie", "name": null}}, "url": "https://github.com/apache/kafka/commit/f998cdf26e0b1fbc464908207be5cdb72bbba921", "committedDate": "2020-03-13T09:47:56Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into negative"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0153dc7837dd95c456b4bf6048df19b0f86d7291", "author": {"user": {"login": "jiameixie", "name": null}}, "url": "https://github.com/apache/kafka/commit/0153dc7837dd95c456b4bf6048df19b0f86d7291", "committedDate": "2020-03-13T09:55:33Z", "message": "Merge remote-tracking branch 'origin/negative' into negative"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MjA1NDAx", "url": "https://github.com/apache/kafka/pull/8285#pullrequestreview-376205401", "createdAt": "2020-03-17T16:33:29Z", "commit": {"oid": "0153dc7837dd95c456b4bf6048df19b0f86d7291"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjozMzozMFrOF3kZeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjozNTowMVrOF3kdeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMjM0NQ==", "bodyText": "It seems like we are duplicating a lot of the logic of the code in this comment. This is likely to get stale over time. Can we make the comment more concise and refer to the non test code for more detail?", "url": "https://github.com/apache/kafka/pull/8285#discussion_r393812345", "createdAt": "2020-03-17T16:33:30Z", "author": {"login": "ijuma"}, "path": "clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.record;\n+\n+import org.junit.Test;\n+import static org.junit.Assert.assertTrue;\n+\n+public class CompressionRatioEstimatorTest {\n+    @Test\n+    public void testUpdateEstimation() {\n+        String topic = \"tp\";\n+        class EstimationsObservedRatios {\n+            float currentEstimation;\n+            float observedRatio;\n+            float expected;\n+            EstimationsObservedRatios(float currentEstimation, float observedRatio, float expected) {\n+                this.currentEstimation = currentEstimation;\n+                this.observedRatio = observedRatio;\n+                this.expected = expected;\n+            }\n+        }\n+\n+        // Method updateEstimation is to update compressionRatioForTopic according to observedRatio and currentEstimation.\n+        // If currentEstimation is smaller than observedRatio, update compressionRatioForTopic to\n+        // Math.max(currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP, observedRatio)\n+        // If currentEstimation is larger than observedRatio, update compressionRatioForTopic to\n+        // Math.max(currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP, observedRatio).\n+        // COMPRESSION_RATIO_DETERIORATE_STEP is 0.05f. COMPRESSION_RATIO_IMPROVING_STEP is 0.005f.\n+        // There are four cases:\n+        // 1. currentEstimation < observedRatio && (currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP) < observedRatio\n+        // 2. currentEstimation < observedRatio && (currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP) > observedRatio\n+        // 3. currentEstimation > observedRatio && (currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP) > observedRatio\n+        // 4. currentEstimation > observedRatio && (currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP) < observedRatio\n+        // In all cases, updatedCompressionRatio shouldn't smaller than observedRatio", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0153dc7837dd95c456b4bf6048df19b0f86d7291"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMjg4MQ==", "bodyText": "It seems that expected is always the same as observed? If so, why do we have 3 parameters instead of 2?", "url": "https://github.com/apache/kafka/pull/8285#discussion_r393812881", "createdAt": "2020-03-17T16:34:16Z", "author": {"login": "ijuma"}, "path": "clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.record;\n+\n+import org.junit.Test;\n+import static org.junit.Assert.assertTrue;\n+\n+public class CompressionRatioEstimatorTest {\n+    @Test\n+    public void testUpdateEstimation() {\n+        String topic = \"tp\";\n+        class EstimationsObservedRatios {\n+            float currentEstimation;\n+            float observedRatio;\n+            float expected;\n+            EstimationsObservedRatios(float currentEstimation, float observedRatio, float expected) {\n+                this.currentEstimation = currentEstimation;\n+                this.observedRatio = observedRatio;\n+                this.expected = expected;\n+            }\n+        }\n+\n+        // Method updateEstimation is to update compressionRatioForTopic according to observedRatio and currentEstimation.\n+        // If currentEstimation is smaller than observedRatio, update compressionRatioForTopic to\n+        // Math.max(currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP, observedRatio)\n+        // If currentEstimation is larger than observedRatio, update compressionRatioForTopic to\n+        // Math.max(currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP, observedRatio).\n+        // COMPRESSION_RATIO_DETERIORATE_STEP is 0.05f. COMPRESSION_RATIO_IMPROVING_STEP is 0.005f.\n+        // There are four cases:\n+        // 1. currentEstimation < observedRatio && (currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP) < observedRatio\n+        // 2. currentEstimation < observedRatio && (currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP) > observedRatio\n+        // 3. currentEstimation > observedRatio && (currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP) > observedRatio\n+        // 4. currentEstimation > observedRatio && (currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP) < observedRatio\n+        // In all cases, updatedCompressionRatio shouldn't smaller than observedRatio\n+        EstimationsObservedRatios[] currentEstimationsObservedRatios = new EstimationsObservedRatios[] {\n+            new EstimationsObservedRatios(0.8f, 0.84f, 0.84f),\n+            new EstimationsObservedRatios(0.6f, 0.7f, 0.7f),\n+            new EstimationsObservedRatios(0.6f, 0.4f, 0.4f),\n+            new EstimationsObservedRatios(0.004f, 0.001f, 0.001f)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0153dc7837dd95c456b4bf6048df19b0f86d7291"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMzM2OQ==", "bodyText": "If we use a List, we should be able to simplify the logic below by using an enhanced for loop.", "url": "https://github.com/apache/kafka/pull/8285#discussion_r393813369", "createdAt": "2020-03-17T16:35:01Z", "author": {"login": "ijuma"}, "path": "clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.record;\n+\n+import org.junit.Test;\n+import static org.junit.Assert.assertTrue;\n+\n+public class CompressionRatioEstimatorTest {\n+    @Test\n+    public void testUpdateEstimation() {\n+        String topic = \"tp\";\n+        class EstimationsObservedRatios {\n+            float currentEstimation;\n+            float observedRatio;\n+            float expected;\n+            EstimationsObservedRatios(float currentEstimation, float observedRatio, float expected) {\n+                this.currentEstimation = currentEstimation;\n+                this.observedRatio = observedRatio;\n+                this.expected = expected;\n+            }\n+        }\n+\n+        // Method updateEstimation is to update compressionRatioForTopic according to observedRatio and currentEstimation.\n+        // If currentEstimation is smaller than observedRatio, update compressionRatioForTopic to\n+        // Math.max(currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP, observedRatio)\n+        // If currentEstimation is larger than observedRatio, update compressionRatioForTopic to\n+        // Math.max(currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP, observedRatio).\n+        // COMPRESSION_RATIO_DETERIORATE_STEP is 0.05f. COMPRESSION_RATIO_IMPROVING_STEP is 0.005f.\n+        // There are four cases:\n+        // 1. currentEstimation < observedRatio && (currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP) < observedRatio\n+        // 2. currentEstimation < observedRatio && (currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP) > observedRatio\n+        // 3. currentEstimation > observedRatio && (currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP) > observedRatio\n+        // 4. currentEstimation > observedRatio && (currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP) < observedRatio\n+        // In all cases, updatedCompressionRatio shouldn't smaller than observedRatio\n+        EstimationsObservedRatios[] currentEstimationsObservedRatios = new EstimationsObservedRatios[] {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0153dc7837dd95c456b4bf6048df19b0f86d7291"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a34d39d5b76dbc3543853e71192a885801a81d2", "author": {"user": {"login": "jiameixie", "name": null}}, "url": "https://github.com/apache/kafka/commit/7a34d39d5b76dbc3543853e71192a885801a81d2", "committedDate": "2020-03-18T04:28:29Z", "message": "Add test for CompressionRatioEstimator\n\nSigned-off-by: Jiamei Xie <jiamei.xie@arm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3ODI3MDkw", "url": "https://github.com/apache/kafka/pull/8285#pullrequestreview-377827090", "createdAt": "2020-03-19T15:23:18Z", "commit": {"oid": "7a34d39d5b76dbc3543853e71192a885801a81d2"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNToyMzoxOVrOF4zmag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNToyNDoyOFrOF4zqFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEwOTk5NA==", "bodyText": "Nit: please add a line before @test.", "url": "https://github.com/apache/kafka/pull/8285#discussion_r395109994", "createdAt": "2020-03-19T15:23:19Z", "author": {"login": "ijuma"}, "path": "clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.record;\n+\n+import org.junit.Test;\n+import static org.junit.Assert.assertTrue;\n+import java.util.ArrayList;\n+\n+public class CompressionRatioEstimatorTest {\n+    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a34d39d5b76dbc3543853e71192a885801a81d2"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTExMDUzMg==", "bodyText": "Nit: this can be written more concisely by using Arrays.asList.", "url": "https://github.com/apache/kafka/pull/8285#discussion_r395110532", "createdAt": "2020-03-19T15:23:57Z", "author": {"login": "ijuma"}, "path": "clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.record;\n+\n+import org.junit.Test;\n+import static org.junit.Assert.assertTrue;\n+import java.util.ArrayList;\n+\n+public class CompressionRatioEstimatorTest {\n+    @Test\n+    public void testUpdateEstimation() {\n+        String topic = \"tp\";\n+        class EstimationsObservedRatios {\n+            float currentEstimation;\n+            float observedRatio;\n+            EstimationsObservedRatios(float currentEstimation, float observedRatio) {\n+                this.currentEstimation = currentEstimation;\n+                this.observedRatio = observedRatio;\n+            }\n+        }\n+\n+        // If currentEstimation is smaller than observedRatio, the updatedCompressionRatio is currentEstimation plus\n+        // COMPRESSION_RATIO_DETERIORATE_STEP 0.05, otherwise currentEstimation minus COMPRESSION_RATIO_IMPROVING_STEP\n+        // 0.005. There are four cases,and updatedCompressionRatio shouldn't smaller than observedRatio in all of cases.\n+        // Refer to non test code for more details.\n+        ArrayList<EstimationsObservedRatios> estimationsObservedRatios = new ArrayList<EstimationsObservedRatios>();\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.8f, 0.84f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.6f, 0.7f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.6f, 0.4f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.004f, 0.001f));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a34d39d5b76dbc3543853e71192a885801a81d2"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTExMDY5NA==", "bodyText": "Nit: this brace should be on the previous line.", "url": "https://github.com/apache/kafka/pull/8285#discussion_r395110694", "createdAt": "2020-03-19T15:24:10Z", "author": {"login": "ijuma"}, "path": "clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.record;\n+\n+import org.junit.Test;\n+import static org.junit.Assert.assertTrue;\n+import java.util.ArrayList;\n+\n+public class CompressionRatioEstimatorTest {\n+    @Test\n+    public void testUpdateEstimation() {\n+        String topic = \"tp\";\n+        class EstimationsObservedRatios {\n+            float currentEstimation;\n+            float observedRatio;\n+            EstimationsObservedRatios(float currentEstimation, float observedRatio) {\n+                this.currentEstimation = currentEstimation;\n+                this.observedRatio = observedRatio;\n+            }\n+        }\n+\n+        // If currentEstimation is smaller than observedRatio, the updatedCompressionRatio is currentEstimation plus\n+        // COMPRESSION_RATIO_DETERIORATE_STEP 0.05, otherwise currentEstimation minus COMPRESSION_RATIO_IMPROVING_STEP\n+        // 0.005. There are four cases,and updatedCompressionRatio shouldn't smaller than observedRatio in all of cases.\n+        // Refer to non test code for more details.\n+        ArrayList<EstimationsObservedRatios> estimationsObservedRatios = new ArrayList<EstimationsObservedRatios>();\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.8f, 0.84f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.6f, 0.7f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.6f, 0.4f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.004f, 0.001f));\n+        float updatedCompressionRatio;\n+        for(EstimationsObservedRatios estimationsObservedRatio:estimationsObservedRatios)\n+        {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a34d39d5b76dbc3543853e71192a885801a81d2"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTExMDkzNA==", "bodyText": "Nit: there should be a space before and after the colon.", "url": "https://github.com/apache/kafka/pull/8285#discussion_r395110934", "createdAt": "2020-03-19T15:24:28Z", "author": {"login": "ijuma"}, "path": "clients/src/test/java/org/apache/kafka/common/record/CompressionRatioEstimatorTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.record;\n+\n+import org.junit.Test;\n+import static org.junit.Assert.assertTrue;\n+import java.util.ArrayList;\n+\n+public class CompressionRatioEstimatorTest {\n+    @Test\n+    public void testUpdateEstimation() {\n+        String topic = \"tp\";\n+        class EstimationsObservedRatios {\n+            float currentEstimation;\n+            float observedRatio;\n+            EstimationsObservedRatios(float currentEstimation, float observedRatio) {\n+                this.currentEstimation = currentEstimation;\n+                this.observedRatio = observedRatio;\n+            }\n+        }\n+\n+        // If currentEstimation is smaller than observedRatio, the updatedCompressionRatio is currentEstimation plus\n+        // COMPRESSION_RATIO_DETERIORATE_STEP 0.05, otherwise currentEstimation minus COMPRESSION_RATIO_IMPROVING_STEP\n+        // 0.005. There are four cases,and updatedCompressionRatio shouldn't smaller than observedRatio in all of cases.\n+        // Refer to non test code for more details.\n+        ArrayList<EstimationsObservedRatios> estimationsObservedRatios = new ArrayList<EstimationsObservedRatios>();\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.8f, 0.84f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.6f, 0.7f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.6f, 0.4f));\n+        estimationsObservedRatios.add(new EstimationsObservedRatios(0.004f, 0.001f));\n+        float updatedCompressionRatio;\n+        for(EstimationsObservedRatios estimationsObservedRatio:estimationsObservedRatios)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a34d39d5b76dbc3543853e71192a885801a81d2"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e50dfdcc573035f90b73daeec19492827f356428", "author": {"user": {"login": "jiameixie", "name": null}}, "url": "https://github.com/apache/kafka/commit/e50dfdcc573035f90b73daeec19492827f356428", "committedDate": "2020-03-24T01:54:33Z", "message": "Modify CompressionRatioEstimatorTest.java\n\nSigned-off-by: Jiamei Xie <jiamei.xie@arm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "e50dfdcc573035f90b73daeec19492827f356428", "author": {"user": {"login": "jiameixie", "name": null}}, "url": "https://github.com/apache/kafka/commit/e50dfdcc573035f90b73daeec19492827f356428", "committedDate": "2020-03-24T01:54:33Z", "message": "Modify CompressionRatioEstimatorTest.java\n\nSigned-off-by: Jiamei Xie <jiamei.xie@arm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "537c402a628b767295ba5a0de1fed85615e0ace5", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/537c402a628b767295ba5a0de1fed85615e0ace5", "committedDate": "2020-03-24T14:32:34Z", "message": "Formatting fixes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 253, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}