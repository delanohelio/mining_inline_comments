{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1MDYwNjQ3", "number": 8380, "title": "MINOR: Refactor StreamsProducer", "bodyText": "To get better encapsulation, it seems to make sense to move the ownership (ie, creation and closing) of KafkaProducer inside of StreamsProducer instead of letting the ActiveTaskCreator handle it.\nThis will also simplify ActiveTaskCreator#reInitializeThreadProducer()  as introduced in #8331 (ie, there is a PR overlap and which ever PR is merged later, needs a rebase).\nCall for review @guozhangwang @abbccdda", "createdAt": "2020-03-28T07:39:42Z", "url": "https://github.com/apache/kafka/pull/8380", "merged": true, "mergeCommit": {"oid": "ab5e4f52ecb072df55c7f5cd8941122a135cdf79"}, "closed": true, "closedAt": "2020-04-04T02:17:58Z", "author": {"login": "mjsax"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcS2ZmIgFqTM4NDI3ODQwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcT3lo4AFqTM4NjkwMTMzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0Mjc4NDA0", "url": "https://github.com/apache/kafka/pull/8380#pullrequestreview-384278404", "createdAt": "2020-03-30T22:30:28Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMjozMDoyOFrOF9-ngA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMjozNjowOVrOF9-w2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUzMzM3Ng==", "bodyText": "We can get the processing mode from the first parameter config right?", "url": "https://github.com/apache/kafka/pull/8380#discussion_r400533376", "createdAt": "2020-03-30T22:30:28Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsProducer.java", "diffHunk": "@@ -52,31 +61,78 @@\n     private final Logger log;\n     private final String logPrefix;\n \n+    private final StreamThread.ProcessingMode processingMode;\n     private final Producer<byte[], byte[]> producer;\n-    private final boolean eosEnabled;\n \n     private boolean transactionInFlight = false;\n     private boolean transactionInitialized = false;\n \n-    public StreamsProducer(final Producer<byte[], byte[]> producer,\n-                           final boolean eosEnabled,\n+    public StreamsProducer(final StreamsConfig config,\n+                           final String threadId,\n+                           final KafkaClientSupplier clientSupplier,\n+                           final StreamThread.ProcessingMode processingMode,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUzNTc2OQ==", "bodyText": "This is a meta comment for this test class: I think there are a lot of opportunities to reduce the 500+ LOC here sine many are duplicated code. For example, we can have a single mock KafkaProducer and have ALO / EOS_ALPHA / EOS_BETA streams producer wrapping the client supplier which would return the mock producer. And then in each unit test we could save creating the mock producer, creating the streams producer etc which are almost in every test function.", "url": "https://github.com/apache/kafka/pull/8380#discussion_r400535769", "createdAt": "2020-03-30T22:36:09Z", "author": {"login": "guozhangwang"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsProducerTest.java", "diffHunk": "@@ -66,27 +72,57 @@\n         Collections.emptySet()\n     );\n \n-    private final ByteArraySerializer byteArraySerializer = new ByteArraySerializer();\n-    private final Map<TopicPartition, OffsetAndMetadata> offsetsAndMetadata = mkMap(\n-        mkEntry(new TopicPartition(topic, 0), new OffsetAndMetadata(0L, null))\n+    private final StreamsConfig config = new StreamsConfig(mkMap(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjE1MjA4", "url": "https://github.com/apache/kafka/pull/8380#pullrequestreview-385215208", "createdAt": "2020-04-01T01:47:05Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMTo0NzowNVrOF-uC6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMTo0NzowNVrOF-uC6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMxMDQ0Mw==", "bodyText": "+1", "url": "https://github.com/apache/kafka/pull/8380#discussion_r401310443", "createdAt": "2020-04-01T01:47:05Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsProducer.java", "diffHunk": "@@ -52,31 +61,78 @@\n     private final Logger log;\n     private final String logPrefix;\n \n+    private final StreamThread.ProcessingMode processingMode;\n     private final Producer<byte[], byte[]> producer;\n-    private final boolean eosEnabled;\n \n     private boolean transactionInFlight = false;\n     private boolean transactionInitialized = false;\n \n-    public StreamsProducer(final Producer<byte[], byte[]> producer,\n-                           final boolean eosEnabled,\n+    public StreamsProducer(final StreamsConfig config,\n+                           final String threadId,\n+                           final KafkaClientSupplier clientSupplier,\n+                           final StreamThread.ProcessingMode processingMode,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUzMzM3Ng=="}, "originalCommit": null, "originalPosition": 47}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1ODc4MTY0", "url": "https://github.com/apache/kafka/pull/8380#pullrequestreview-385878164", "createdAt": "2020-04-01T19:18:32Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cd2f65373a9369e01ad87a92bcf9e24a20985b5", "author": {"user": {"login": "mjsax", "name": "Matthias J. Sax"}}, "url": "https://github.com/apache/kafka/commit/0cd2f65373a9369e01ad87a92bcf9e24a20985b5", "committedDate": "2020-04-01T21:59:32Z", "message": "MINOR: Refactor StreamsProducer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "0cd2f65373a9369e01ad87a92bcf9e24a20985b5", "author": {"user": {"login": "mjsax", "name": "Matthias J. Sax"}}, "url": "https://github.com/apache/kafka/commit/0cd2f65373a9369e01ad87a92bcf9e24a20985b5", "committedDate": "2020-04-01T21:59:32Z", "message": "MINOR: Refactor StreamsProducer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2OTAxMzMy", "url": "https://github.com/apache/kafka/pull/8380#pullrequestreview-386901332", "createdAt": "2020-04-03T02:36:32Z", "commit": {"oid": "0cd2f65373a9369e01ad87a92bcf9e24a20985b5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1732, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}