{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0MzQ2MzIy", "number": 8628, "title": "KAFKA-9942: Fixes ConfigCommand client quotas w/ default users.", "bodyText": "Fixes ConfigCommand client quotas w/ default users when using --bootstrap-servers.\nTest is expanded to handle all valid (user, client-id) enumerations.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-05-06T21:35:11Z", "url": "https://github.com/apache/kafka/pull/8628", "merged": true, "mergeCommit": {"oid": "5583089df03ac6def37418e6b7c16f4e78ca010d"}, "closed": true, "closedAt": "2020-05-10T12:54:08Z", "author": {"login": "bdbyrne"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcevoVKAH2gAyNDE0MzQ2MzIyOjkyNzU4MDQ0MmNlZDYyNWJmMjk4OGE0NDBkNzg5MzQ2NjViM2MwNjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfVRqbAH2gAyNDE0MzQ2MzIyOjEyYTkxZjNjYTJjYjJjNmJjYzliMDhjZjVjNWI2ODY0MGIzYmRkNTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "927580442ced625bf2988a440d78934665b3c062", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/927580442ced625bf2988a440d78934665b3c062", "committedDate": "2020-05-06T21:33:24Z", "message": "KAFKA-9942: Fixes ConfigCommand client quotas w/ default users when using --bootstrap-servers."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3OTExNDcx", "url": "https://github.com/apache/kafka/pull/8628#pullrequestreview-407911471", "createdAt": "2020-05-07T23:52:15Z", "commit": {"oid": "927580442ced625bf2988a440d78934665b3c062"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMzo1MjoxNVrOGSUMcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMzo1MjoxNVrOGSUMcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1ODQxOA==", "bodyText": "It's not really that they're invalid, it's that we want to delete them and they're not present, right?  I realize this is an existing issue.", "url": "https://github.com/apache/kafka/pull/8628#discussion_r421858418", "createdAt": "2020-05-07T23:52:15Z", "author": {"login": "cmccabe"}, "path": "core/src/main/scala/kafka/admin/ConfigCommand.scala", "diffHunk": "@@ -362,21 +362,22 @@ object ConfigCommand extends Config {\n         ).asJavaCollection\n         adminClient.incrementalAlterConfigs(Map(configResource -> alterLogLevelEntries).asJava, alterOptions).all().get(60, TimeUnit.SECONDS)\n \n-      case ConfigType.User =>\n-      case ConfigType.Client =>\n-        val oldConfig: Map[String, java.lang.Double] = getClientQuotasConfig(adminClient, entityTypes, entityNames)\n+      case ConfigType.User | ConfigType.Client =>\n+        val oldConfig = getClientQuotasConfig(adminClient, entityTypes, entityNames)\n \n         val invalidConfigs = configsToBeDeleted.filterNot(oldConfig.contains)\n         if (invalidConfigs.nonEmpty)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "927580442ced625bf2988a440d78934665b3c062"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3OTE3NzE2", "url": "https://github.com/apache/kafka/pull/8628#pullrequestreview-407917716", "createdAt": "2020-05-08T00:11:20Z", "commit": {"oid": "927580442ced625bf2988a440d78934665b3c062"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwMDoxMToyMFrOGSUiww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwMDoxMToyMFrOGSUiww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg2NDEzMQ==", "bodyText": "Since this map potentially contains nulls (a bad practice) we need to be very careful about its type.  Many newer map types don't allow nulls and I don't trust Scala to always create a map that allows this.  I suggest manually building a Java HashMap.", "url": "https://github.com/apache/kafka/pull/8628#discussion_r421864131", "createdAt": "2020-05-08T00:11:20Z", "author": {"login": "cmccabe"}, "path": "core/src/main/scala/kafka/admin/ConfigCommand.scala", "diffHunk": "@@ -362,21 +362,22 @@ object ConfigCommand extends Config {\n         ).asJavaCollection\n         adminClient.incrementalAlterConfigs(Map(configResource -> alterLogLevelEntries).asJava, alterOptions).all().get(60, TimeUnit.SECONDS)\n \n-      case ConfigType.User =>\n-      case ConfigType.Client =>\n-        val oldConfig: Map[String, java.lang.Double] = getClientQuotasConfig(adminClient, entityTypes, entityNames)\n+      case ConfigType.User | ConfigType.Client =>\n+        val oldConfig = getClientQuotasConfig(adminClient, entityTypes, entityNames)\n \n         val invalidConfigs = configsToBeDeleted.filterNot(oldConfig.contains)\n         if (invalidConfigs.nonEmpty)\n           throw new InvalidConfigurationException(s\"Invalid config(s): ${invalidConfigs.mkString(\",\")}\")\n \n-        val entity = new ClientQuotaEntity(opts.entityTypes.map { entType =>\n+        val alterEntityTypes = entityTypes.map { entType =>\n           entType match {\n             case ConfigType.User => ClientQuotaEntity.USER\n             case ConfigType.Client => ClientQuotaEntity.CLIENT_ID\n             case _ => throw new IllegalArgumentException(s\"Unexpected entity type: ${entType}\")\n           }\n-        }.zip(opts.entityNames).toMap.asJava)\n+        }\n+        val alterEntityNames = entityNames.map(en => if (en.nonEmpty) en else null)\n+        val entity = new ClientQuotaEntity(alterEntityTypes.zip(alterEntityNames).toMap.asJava)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "927580442ced625bf2988a440d78934665b3c062"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3OTI0MDU5", "url": "https://github.com/apache/kafka/pull/8628#pullrequestreview-407924059", "createdAt": "2020-05-08T00:31:17Z", "commit": {"oid": "927580442ced625bf2988a440d78934665b3c062"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwMDozMToxOFrOGSU5QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwMDozMToxOFrOGSU5QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg2OTg4OQ==", "bodyText": "Same comment here.  We should use java's HashMap specifically since we know it supports null values and we don't know if other maps do or not.", "url": "https://github.com/apache/kafka/pull/8628#discussion_r421869889", "createdAt": "2020-05-08T00:31:18Z", "author": {"login": "cmccabe"}, "path": "core/src/test/scala/unit/kafka/admin/ConfigCommandTest.scala", "diffHunk": "@@ -398,16 +398,30 @@ class ConfigCommandTest extends ZooKeeperTestHarness with Logging {\n     ConfigCommand.alterConfigWithZk(null, createOpts, new TestAdminZkClient(zkClient))\n   }\n \n-  @Test\n-  def shouldAddClientConfig(): Unit = {\n+  def testShouldAddClientConfig(user: Option[String], clientId: Option[String]): Unit = {\n+    def toValues(entityName: Option[String], entityType: String, command: String):\n+        (Array[String], Option[String], Option[ClientQuotaFilterComponent]) = {\n+      entityName match {\n+        case Some(null) =>\n+          (Array(\"--entity-type\", command, \"--entity-default\"), Some(null),\n+            Some(ClientQuotaFilterComponent.ofDefaultEntity(entityType)))\n+        case Some(name) =>\n+          (Array(\"--entity-type\", command, \"--entity-name\", name), Some(name),\n+            Some(ClientQuotaFilterComponent.ofEntity(entityType, name)))\n+        case None => (Array.empty, None, None)\n+      }\n+    }\n+    val (userArgs, userEntity, userComponent) = toValues(user, ClientQuotaEntity.USER, \"users\")\n+    val (clientIdArgs, clientIdEntity, clientIdComponent) = toValues(clientId, ClientQuotaEntity.CLIENT_ID, \"clients\")\n+\n     val createOpts = new ConfigCommandOptions(Array(\"--bootstrap-server\", \"localhost:9092\",\n-      \"--entity-name\", \"my-client-id\",\n-      \"--entity-type\", \"clients\",\n       \"--alter\",\n       \"--add-config\", \"consumer_byte_rate=20000,producer_byte_rate=10000\",\n-      \"--delete-config\", \"request_percentage\"))\n+      \"--delete-config\", \"request_percentage\") ++ userArgs ++ clientIdArgs)\n \n-    val entity = new ClientQuotaEntity(Map((ClientQuotaEntity.CLIENT_ID -> \"my-client-id\")).asJava)\n+    val entity = new ClientQuotaEntity(Seq(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "927580442ced625bf2988a440d78934665b3c062"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12a91f3ca2cb2c6bcc9b08cf5c5b68640b3bdd50", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/12a91f3ca2cb2c6bcc9b08cf5c5b68640b3bdd50", "committedDate": "2020-05-08T17:25:02Z", "message": "Address comments."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1373, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}