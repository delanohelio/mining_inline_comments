{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3OTI2ODI3", "number": 8142, "title": "KAFKA-9577: SaslClientAuthenticator incorrectly negotiates SASL_HANDSHAKE version", "bodyText": "The SaslClientAuthenticator incorrectly negotiates supported SaslHandshakeRequest version and  uses the maximum version supported by the broker whether or not the client supports it.\nThis bug was exposed by a recent version bump in 0a2569e.\nThis PR rolls back the recent SaslHandshake[Request,Response] bump, fixes the version negotiation, and adds a test to prevent anyone from accidentally bumping the version without a workaround such as a new ApiKey. The existing key will be difficult to support for clients < 2.5 due to the incorrect negotiation.\nTests:\n\nPrevent SASL_HANDSHAKE schema version bump\nAdd test to return ApiVersions unsupported by client", "createdAt": "2020-02-20T19:13:23Z", "url": "https://github.com/apache/kafka/pull/8142", "merged": true, "mergeCommit": {"oid": "1a8dcffe4adb61f6073c8fb2514a7fdd49b50716"}, "closed": true, "closedAt": "2020-02-22T05:49:12Z", "author": {"login": "lbradstreet"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGP8hzgH2gAyMzc3OTI2ODI3OjhiM2E3MjAwYTg1N2EwOTM3NzA3OGZjMmZjZWFkYmI5YWZiMjFjNzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGm4JigFqTM2MjkzNjk1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8b3a7200a857a09377078fc2fceadbb9afb21c78", "author": {"user": {"login": "lbradstreet", "name": "Lucas Bradstreet"}}, "url": "https://github.com/apache/kafka/commit/8b3a7200a857a09377078fc2fceadbb9afb21c78", "committedDate": "2020-02-20T19:04:19Z", "message": "SaslClientAuthenticator incorrectly negotiates supported\nSaslHandshakeRequest versions and uses the max versions supported by the\nbroker whether or not the client supports it. This PR rolls back the\nSaslHandshake[Request,Response] bump, fixes the version negotiation, and\nadds a test to prevent anyone from accidentally bumping the version\nwithout a workaround (e.g. a new ApiKey)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMTY1NzI0", "url": "https://github.com/apache/kafka/pull/8142#pullrequestreview-362165724", "createdAt": "2020-02-20T19:17:47Z", "commit": {"oid": "8b3a7200a857a09377078fc2fceadbb9afb21c78"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOToxNzo0N1rOFsf7qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOToxNzo0N1rOFsf7qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwNDg0MA==", "bodyText": "Set the versions for both auth and handshake the same way.", "url": "https://github.com/apache/kafka/pull/8142#discussion_r382204840", "createdAt": "2020-02-20T19:17:47Z", "author": {"login": "lbradstreet"}, "path": "clients/src/main/java/org/apache/kafka/common/security/authenticator/SaslClientAuthenticator.java", "diffHunk": "@@ -213,13 +215,13 @@ public void authenticate() throws IOException {\n                 if (apiVersionsResponse == null)\n                     break;\n                 else {\n-                    saslAuthenticateVersion(apiVersionsResponse);\n+                    saslApiVersions(apiVersionsResponse);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3a7200a857a09377078fc2fceadbb9afb21c78"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMTY1ODk4", "url": "https://github.com/apache/kafka/pull/8142#pullrequestreview-362165898", "createdAt": "2020-02-20T19:18:04Z", "commit": {"oid": "8b3a7200a857a09377078fc2fceadbb9afb21c78"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOToxODowNFrOFsf8Ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOToxODowNFrOFsf8Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwNDk4Mg==", "bodyText": "Rollback version with comment", "url": "https://github.com/apache/kafka/pull/8142#discussion_r382204982", "createdAt": "2020-02-20T19:18:04Z", "author": {"login": "lbradstreet"}, "path": "clients/src/main/resources/common/message/SaslHandshakeRequest.json", "diffHunk": "@@ -18,9 +18,9 @@\n   \"type\": \"request\",\n   \"name\": \"SaslHandshakeRequest\",\n   // Version 1 supports SASL_AUTHENTICATE.\n-  // Version 2 adds flexible version support\n-  \"validVersions\": \"0-2\",\n-  \"flexibleVersions\": \"2+\",\n+  // NOTE: Version cannot be easily bumped due to incorrect", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3a7200a857a09377078fc2fceadbb9afb21c78"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMTY2MzM1", "url": "https://github.com/apache/kafka/pull/8142#pullrequestreview-362166335", "createdAt": "2020-02-20T19:18:45Z", "commit": {"oid": "8b3a7200a857a09377078fc2fceadbb9afb21c78"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOToxODo0NVrOFsf9yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOToxODo0NVrOFsf9yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwNTM4Ng==", "bodyText": "Rename as this only tested part of the version support.", "url": "https://github.com/apache/kafka/pull/8142#discussion_r382205386", "createdAt": "2020-02-20T19:18:45Z", "author": {"login": "lbradstreet"}, "path": "clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java", "diffHunk": "@@ -677,7 +677,7 @@ public void testUnauthenticatedApiVersionsRequestOverSslHandshakeVersion1() thro\n      * {@link SaslServerAuthenticator} of the server prior to client authentication.\n      */\n     @Test\n-    public void testApiVersionsRequestWithUnsupportedVersion() throws Exception {\n+    public void testApiVersionsRequestWithServerUnsupportedVersion() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3a7200a857a09377078fc2fceadbb9afb21c78"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMTY2NDY1", "url": "https://github.com/apache/kafka/pull/8142#pullrequestreview-362166465", "createdAt": "2020-02-20T19:18:56Z", "commit": {"oid": "8b3a7200a857a09377078fc2fceadbb9afb21c78"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOToxODo1NlrOFsf-Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOToxODo1NlrOFsf-Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwNTQ3OQ==", "bodyText": "Block anyone from bumping the schema without realizing.", "url": "https://github.com/apache/kafka/pull/8142#discussion_r382205479", "createdAt": "2020-02-20T19:18:56Z", "author": {"login": "lbradstreet"}, "path": "clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java", "diffHunk": "@@ -748,6 +767,16 @@ public void testInvalidApiVersionsRequest() throws Exception {\n         authenticateUsingSaslPlainAndCheckConnection(node, handshakeVersion > 0);\n     }\n \n+\n+    @Test\n+    public void testForBrokenSaslHandshakeVersionBump() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3a7200a857a09377078fc2fceadbb9afb21c78"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMTc5MDU3", "url": "https://github.com/apache/kafka/pull/8142#pullrequestreview-362179057", "createdAt": "2020-02-20T19:37:53Z", "commit": {"oid": "8b3a7200a857a09377078fc2fceadbb9afb21c78"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOTozNzo1M1rOFsgk6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOTo1OToxNVrOFshPag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIxNTQwMg==", "bodyText": "nit: saslAuthenticateAndHandshakeVersions() is more intuitive to me (100% subjective, of course; I mention it only in case it didn't occur to you)", "url": "https://github.com/apache/kafka/pull/8142#discussion_r382215402", "createdAt": "2020-02-20T19:37:53Z", "author": {"login": "rondagostino"}, "path": "clients/src/main/java/org/apache/kafka/common/security/authenticator/SaslClientAuthenticator.java", "diffHunk": "@@ -213,13 +215,13 @@ public void authenticate() throws IOException {\n                 if (apiVersionsResponse == null)\n                     break;\n                 else {\n-                    saslAuthenticateVersion(apiVersionsResponse);\n+                    saslApiVersions(apiVersionsResponse);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwNDg0MA=="}, "originalCommit": {"oid": "8b3a7200a857a09377078fc2fceadbb9afb21c78"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyNjI4Mg==", "bodyText": "It is not possible to easily bump SASL_HANDSHAKE schema without due to... (remove \"without\")", "url": "https://github.com/apache/kafka/pull/8142#discussion_r382226282", "createdAt": "2020-02-20T19:59:15Z", "author": {"login": "rondagostino"}, "path": "clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java", "diffHunk": "@@ -748,6 +767,16 @@ public void testInvalidApiVersionsRequest() throws Exception {\n         authenticateUsingSaslPlainAndCheckConnection(node, handshakeVersion > 0);\n     }\n \n+\n+    @Test\n+    public void testForBrokenSaslHandshakeVersionBump() {\n+        assertEquals(\"It is not possible to easily bump SASL_HANDSHAKE schema without \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3a7200a857a09377078fc2fceadbb9afb21c78"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de7274f5673650db5aba20ce600ebb10e82cb04a", "author": {"user": {"login": "lbradstreet", "name": "Lucas Bradstreet"}}, "url": "https://github.com/apache/kafka/commit/de7274f5673650db5aba20ce600ebb10e82cb04a", "committedDate": "2020-02-20T20:56:30Z", "message": "saslApiVersions -> setSaslAuthenticateAndHandshakeVersions. Improve test\nfailure message."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTE4Mzgx", "url": "https://github.com/apache/kafka/pull/8142#pullrequestreview-362918381", "createdAt": "2020-02-21T21:09:50Z", "commit": {"oid": "de7274f5673650db5aba20ce600ebb10e82cb04a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMTowOTo1MFrOFtErzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMTowOTo1MFrOFtErzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgwNjk5MA==", "bodyText": "Can you specify the client versions with the incorrect negotiation?  2.4 and earlier, right?", "url": "https://github.com/apache/kafka/pull/8142#discussion_r382806990", "createdAt": "2020-02-21T21:09:50Z", "author": {"login": "cmccabe"}, "path": "clients/src/main/resources/common/message/SaslHandshakeResponse.json", "diffHunk": "@@ -18,9 +18,9 @@\n   \"type\": \"response\",\n   \"name\": \"SaslHandshakeResponse\",\n   // Version 1 is the same as version 0.\n-  // Version 2 adds flexible version support\n-  \"validVersions\": \"0-2\",\n-  \"flexibleVersions\": \"2+\",\n+  // NOTE: Version cannot be easily bumped due to incorrect\n+  // client negotiation. See https://issues.apache.org/jira/browse/KAFKA-9577", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de7274f5673650db5aba20ce600ebb10e82cb04a"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb7ce3787a101b9243988c484c86238a8a61f97d", "author": {"user": {"login": "lbradstreet", "name": "Lucas Bradstreet"}}, "url": "https://github.com/apache/kafka/commit/fb7ce3787a101b9243988c484c86238a8a61f97d", "committedDate": "2020-02-21T21:11:56Z", "message": "Better document bad negotiation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTM2OTU2", "url": "https://github.com/apache/kafka/pull/8142#pullrequestreview-362936956", "createdAt": "2020-02-21T21:47:21Z", "commit": {"oid": "fb7ce3787a101b9243988c484c86238a8a61f97d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1502, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}