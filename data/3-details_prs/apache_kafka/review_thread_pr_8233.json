{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NTMxNTAy", "number": 8233, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo0NTo0MVrODlnVow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo0NTo0MVrODlnVow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzY4NDE5OnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetadataState.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo0NTo0MlrOFym66g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMzozODo1N1rOFyn_LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYxMDc5NA==", "bodyText": "Why move the reset into the condition? if the passed in values are empty we should still set it to empty because the previous map may be out-dated right?", "url": "https://github.com/apache/kafka/pull/8233#discussion_r388610794", "createdAt": "2020-03-05T22:45:42Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetadataState.java", "diffHunk": "@@ -316,10 +315,12 @@ private boolean hasPartitionsForAnyTopics(final List<String> topicNames, final S\n \n     private void rebuildMetadata(final Map<HostInfo, Set<TopicPartition>> activePartitionHostMap,\n                                  final Map<HostInfo, Set<TopicPartition>> standbyPartitionHostMap) {\n-        allMetadata.clear();\n         if (activePartitionHostMap.isEmpty() && standbyPartitionHostMap.isEmpty()) {\n+            allMetadata = Collections.emptyList();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51c76fedd9da8c27b667075d334dc8da9bed6489"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYyNjEwMA==", "bodyText": "Well, with this change you're always going to get either the old or new metadata from getAllMetadata.  Where as if I clear the list at the start of this method, then getAllMetadata can return empty.\nQuestion is: which is preferable?  I figured there's a strong possibility that at least some of the old metadata may still be correct - so why ditch it?", "url": "https://github.com/apache/kafka/pull/8233#discussion_r388626100", "createdAt": "2020-03-05T23:31:28Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetadataState.java", "diffHunk": "@@ -316,10 +315,12 @@ private boolean hasPartitionsForAnyTopics(final List<String> topicNames, final S\n \n     private void rebuildMetadata(final Map<HostInfo, Set<TopicPartition>> activePartitionHostMap,\n                                  final Map<HostInfo, Set<TopicPartition>> standbyPartitionHostMap) {\n-        allMetadata.clear();\n         if (activePartitionHostMap.isEmpty() && standbyPartitionHostMap.isEmpty()) {\n+            allMetadata = Collections.emptyList();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYxMDc5NA=="}, "originalCommit": {"oid": "51c76fedd9da8c27b667075d334dc8da9bed6489"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYyODI2OQ==", "bodyText": "By returning empty we're forcing callers to handle this case. But if we return stale data, then it's no different to if they had called getAllMetadata a few ns earlier.", "url": "https://github.com/apache/kafka/pull/8233#discussion_r388628269", "createdAt": "2020-03-05T23:38:57Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetadataState.java", "diffHunk": "@@ -316,10 +315,12 @@ private boolean hasPartitionsForAnyTopics(final List<String> topicNames, final S\n \n     private void rebuildMetadata(final Map<HostInfo, Set<TopicPartition>> activePartitionHostMap,\n                                  final Map<HostInfo, Set<TopicPartition>> standbyPartitionHostMap) {\n-        allMetadata.clear();\n         if (activePartitionHostMap.isEmpty() && standbyPartitionHostMap.isEmpty()) {\n+            allMetadata = Collections.emptyList();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYxMDc5NA=="}, "originalCommit": {"oid": "51c76fedd9da8c27b667075d334dc8da9bed6489"}, "originalPosition": 45}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3442, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}