{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0NDYzODkx", "number": 9627, "title": "KAFKA-10746: Change to Warn logs when necessary to notify users", "bodyText": "JIRA: https://issues.apache.org/jira/browse/KAFKA-10746\nThis improvement is the side effect of this PR: #6972, where we tried to fix flooding number of warning messages but never left group case. So we move the warn logs into the maybeLeaveGroup method, and log as INFO level. (https://github.com/apache/kafka/pull/6972/files#diff-15efe9b844f78b686393b6c2e2ad61306c3473225742caed05c7edab9a138832L1092)\nThe INFO log is good when the leaving group is expected, ex: unsubscribe from all topics, consumer close... However, there are some cases that are unexpected, ex: polling timeout, taking too long to read the log, and these cases should be logged as WARN because some Kafka users ignore INFO messages or have the log level set to WARN.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-11-20T06:22:01Z", "url": "https://github.com/apache/kafka/pull/9627", "merged": true, "mergeCommit": {"oid": "ea076a8d6289fa8e94e7e6876437b565f9a9f9c3"}, "closed": true, "closedAt": "2021-04-25T12:55:11Z", "author": {"login": "showuon"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeSpQXgBqjQwMTk2MjI2MTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABePyu6mgFqTY0Mjg5MTExMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4247e13798b3e56f0e2838ce1f9870de74c44cc", "author": {"user": {"login": "showuon", "name": "Luke Chen"}}, "url": "https://github.com/apache/kafka/commit/d4247e13798b3e56f0e2838ce1f9870de74c44cc", "committedDate": "2020-11-25T06:30:52Z", "message": "KAFKA-10746: change to Warn logs when necessary to notice users"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "d4247e13798b3e56f0e2838ce1f9870de74c44cc", "author": {"user": {"login": "showuon", "name": "Luke Chen"}}, "url": "https://github.com/apache/kafka/commit/d4247e13798b3e56f0e2838ce1f9870de74c44cc", "committedDate": "2020-11-25T06:30:52Z", "message": "KAFKA-10746: change to Warn logs when necessary to notice users"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjQxODIxNDYy", "url": "https://github.com/apache/kafka/pull/9627#pullrequestreview-641821462", "createdAt": "2021-04-22T06:33:39Z", "commit": {"oid": "d4247e13798b3e56f0e2838ce1f9870de74c44cc"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0yMlQwNjozMzozOVrOJNe28g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0yMlQwNjo1MDoyMFrOJNfYjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODExNjg1MA==", "bodyText": "It seems the shouldWarn is always true in production. Maybe we can remove the input argument from this method?", "url": "https://github.com/apache/kafka/pull/9627#discussion_r618116850", "createdAt": "2021-04-22T06:33:39Z", "author": {"login": "chia7712"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/WorkerGroupMember.java", "diffHunk": "@@ -203,8 +203,8 @@ public void requestRejoin() {\n         coordinator.requestRejoin();\n     }\n \n-    public void maybeLeaveGroup(String leaveReason) {\n-        coordinator.maybeLeaveGroup(leaveReason);\n+    public void maybeLeaveGroup(String leaveReason, boolean shouldWarn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4247e13798b3e56f0e2838ce1f9870de74c44cc"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODEyMTg0Nw==", "bodyText": "'final' is unnecessary here :)", "url": "https://github.com/apache/kafka/pull/9627#discussion_r618121847", "createdAt": "2021-04-22T06:43:38Z", "author": {"login": "chia7712"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -1013,8 +1018,13 @@ protected void close(Timer timer) {\n             state != MemberState.UNJOINED && generation.hasMemberId()) {\n             // this is a minimal effort attempt to leave the group. we do not\n             // attempt any resending if the request fails or times out.\n-            log.info(\"Member {} sending LeaveGroup request to coordinator {} due to {}\",\n+            final String logMessage = String.format(\"Member %s sending LeaveGroup request to coordinator %s due to %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4247e13798b3e56f0e2838ce1f9870de74c44cc"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODEyMzA2Mw==", "bodyText": "Did you revise the content? Or it is just about decoration?", "url": "https://github.com/apache/kafka/pull/9627#discussion_r618123063", "createdAt": "2021-04-22T06:45:54Z", "author": {"login": "chia7712"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -1353,12 +1363,13 @@ public void run() {\n                         } else if (heartbeat.pollTimeoutExpired(now)) {\n                             // the poll timeout has expired, which means that the foreground thread has stalled\n                             // in between calls to poll().\n-                            String leaveReason = \"consumer poll timeout has expired. This means the time between subsequent calls to poll() \" +\n-                                                    \"was longer than the configured max.poll.interval.ms, which typically implies that \" +\n+                            final String leaveReason = \"consumer poll timeout has expired. This means the time between \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4247e13798b3e56f0e2838ce1f9870de74c44cc"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODEyNTQ1NA==", "bodyText": "Most cases pass false so an override method  maybeLeaveGroup(String) can reduce the code changes. Also, maybeLeaveGroup(String, boolean) can be declared as a protected method. WDYT?", "url": "https://github.com/apache/kafka/pull/9627#discussion_r618125454", "createdAt": "2021-04-22T06:50:20Z", "author": {"login": "chia7712"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -1001,9 +1001,14 @@ protected void close(Timer timer) {\n     }\n \n     /**\n+     * Leave the group. This method also sends LeaveGroupRequest and log {@code leaveReason} if this is dynamic members\n+     * or unknown coordinator or state is not UNJOINED or this generation has a valid member id.\n+     *\n+     * @param leaveReason the reason to leave the group for logging\n+     * @param shouldWarn should log as WARN level or INFO\n      * @throws KafkaException if the rebalance callback throws exception\n      */\n-    public synchronized RequestFuture<Void> maybeLeaveGroup(String leaveReason) {\n+    public synchronized RequestFuture<Void> maybeLeaveGroup(String leaveReason, boolean shouldWarn) throws KafkaException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4247e13798b3e56f0e2838ce1f9870de74c44cc"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87e12238b1476d195ae14d011f85326d3587196d", "author": {"user": {"login": "showuon", "name": "Luke Chen"}}, "url": "https://github.com/apache/kafka/commit/87e12238b1476d195ae14d011f85326d3587196d", "committedDate": "2021-04-22T07:17:46Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KAFKA-10746"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d69cb98ff76f94f851e6a1ecd56bc927c27b4bda", "author": {"user": {"login": "showuon", "name": "Luke Chen"}}, "url": "https://github.com/apache/kafka/commit/d69cb98ff76f94f851e6a1ecd56bc927c27b4bda", "committedDate": "2021-04-22T07:40:23Z", "message": "KAFKA-10746: refactor codes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93c200e5ac947ca28ef0b87c892edb7bb3bcb030", "author": {"user": {"login": "showuon", "name": "Luke Chen"}}, "url": "https://github.com/apache/kafka/commit/93c200e5ac947ca28ef0b87c892edb7bb3bcb030", "committedDate": "2021-04-22T07:37:25Z", "message": "KAFKA-10746: refactor codes"}, "afterCommit": {"oid": "d69cb98ff76f94f851e6a1ecd56bc927c27b4bda", "author": {"user": {"login": "showuon", "name": "Luke Chen"}}, "url": "https://github.com/apache/kafka/commit/d69cb98ff76f94f851e6a1ecd56bc927c27b4bda", "committedDate": "2021-04-22T07:40:23Z", "message": "KAFKA-10746: refactor codes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjQyMzY3NTY5", "url": "https://github.com/apache/kafka/pull/9627#pullrequestreview-642367569", "createdAt": "2021-04-22T15:46:59Z", "commit": {"oid": "d69cb98ff76f94f851e6a1ecd56bc927c27b4bda"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0yMlQxNTo0Njo1OVrOJN3k4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0yMlQxNTo0OTowOVrOJN3sSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODUyMTgyNQ==", "bodyText": "KafkaException is a runtime exception and therefore should only be included in the javadoc. In the method signature we include checked exceptions.", "url": "https://github.com/apache/kafka/pull/9627#discussion_r618521825", "createdAt": "2021-04-22T15:46:59Z", "author": {"login": "kkonstantine"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -1023,9 +1023,14 @@ protected void close(Timer timer) {\n     }\n \n     /**\n+     * Leaving the group. This method also sends LeaveGroupRequest and log {@code leaveReason} if this is dynamic members\n+     * or unknown coordinator or state is not UNJOINED or this generation has a valid member id.\n+     *\n+     * @param leaveReason the reason to leave the group for logging\n+     * @param shouldWarn should log as WARN level or INFO\n      * @throws KafkaException if the rebalance callback throws exception\n      */\n-    public synchronized RequestFuture<Void> maybeLeaveGroup(String leaveReason) {\n+    public synchronized RequestFuture<Void> maybeLeaveGroup(String leaveReason, boolean shouldWarn) throws KafkaException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d69cb98ff76f94f851e6a1ecd56bc927c27b4bda"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODUyMzcyMA==", "bodyText": "same here", "url": "https://github.com/apache/kafka/pull/9627#discussion_r618523720", "createdAt": "2021-04-22T15:49:09Z", "author": {"login": "kkonstantine"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -1051,6 +1061,10 @@ protected void close(Timer timer) {\n         return future;\n     }\n \n+    public synchronized RequestFuture<Void> maybeLeaveGroup(String leaveReason) throws KafkaException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d69cb98ff76f94f851e6a1ecd56bc927c27b4bda"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjQyNzczNTI2", "url": "https://github.com/apache/kafka/pull/9627#pullrequestreview-642773526", "createdAt": "2021-04-22T23:35:01Z", "commit": {"oid": "d69cb98ff76f94f851e6a1ecd56bc927c27b4bda"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0yMlQyMzozNTowMVrOJOJqCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0yMlQyMzo0NDowOFrOJOJ11w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODgxODA1OQ==", "bodyText": "I think it may be more useful to describe the cases where it will not send a LeaveGroup and describe what this actually means (also it should have been 'and' not 'or' in the original):\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Leaving the group. This method also sends LeaveGroupRequest and log {@code leaveReason} if this is dynamic members\n          \n          \n            \n                 * or unknown coordinator or state is not UNJOINED or this generation has a valid member id.\n          \n          \n            \n                 * Sends LeaveGroupRequest and logs the {@code leaveReason}, unless this member is using \n          \n          \n            \n                 * static  membership or is already not part of the group (ie does not have a valid member id, \n          \n          \n            \n                 * is in the UNJOINED state, or the coordinator is unknown).", "url": "https://github.com/apache/kafka/pull/9627#discussion_r618818059", "createdAt": "2021-04-22T23:35:01Z", "author": {"login": "ableegoldman"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -1023,9 +1023,14 @@ protected void close(Timer timer) {\n     }\n \n     /**\n+     * Leaving the group. This method also sends LeaveGroupRequest and log {@code leaveReason} if this is dynamic members\n+     * or unknown coordinator or state is not UNJOINED or this generation has a valid member id.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d69cb98ff76f94f851e6a1ecd56bc927c27b4bda"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODgyMDQyNA==", "bodyText": "I think it would be simpler to just log the current leaveReason right here at the warn level, and then pass in a more brief description to maybeLeaveGroup rather than add a flag to that method just for this one case", "url": "https://github.com/apache/kafka/pull/9627#discussion_r618820424", "createdAt": "2021-04-22T23:42:06Z", "author": {"login": "ableegoldman"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -1386,7 +1400,7 @@ public void run() {\n                                                     \"the poll loop is spending too much time processing messages. \" +\n                                                     \"You can address this either by increasing max.poll.interval.ms or by reducing \" +\n                                                     \"the maximum size of batches returned in poll() with max.poll.records.\";\n-                            maybeLeaveGroup(leaveReason);\n+                            maybeLeaveGroup(leaveReason, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d69cb98ff76f94f851e6a1ecd56bc927c27b4bda"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODgyMTA3OQ==", "bodyText": "The only invocation of WorkerGroupMember#maybeLeaveGroup in fact already does log a warning as to why instead of relying on maybeLeaveGroup to do so. Imo we should do something similar for the \"consumer poll timeout has expired\" case", "url": "https://github.com/apache/kafka/pull/9627#discussion_r618821079", "createdAt": "2021-04-22T23:44:08Z", "author": {"login": "ableegoldman"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/WorkerGroupMember.java", "diffHunk": "@@ -202,7 +202,7 @@ public void requestRejoin() {\n     }\n \n     public void maybeLeaveGroup(String leaveReason) {\n-        coordinator.maybeLeaveGroup(leaveReason);\n+        coordinator.maybeLeaveGroup(leaveReason, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d69cb98ff76f94f851e6a1ecd56bc927c27b4bda"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff588293d1ec3af78912332205001432323e9819", "author": {"user": {"login": "showuon", "name": "Luke Chen"}}, "url": "https://github.com/apache/kafka/commit/ff588293d1ec3af78912332205001432323e9819", "committedDate": "2021-04-23T02:16:36Z", "message": "KAFKA-10746: address reviewer's comment to log warn before leaving group"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjQyODkxMTEx", "url": "https://github.com/apache/kafka/pull/9627#pullrequestreview-642891111", "createdAt": "2021-04-23T03:03:45Z", "commit": {"oid": "ff588293d1ec3af78912332205001432323e9819"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2423, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}