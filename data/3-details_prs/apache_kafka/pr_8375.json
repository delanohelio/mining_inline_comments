{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0OTQ5MDE5", "number": 8375, "title": "KAFKA-9776: Downgrade TxnCommit API v3 when broker doesn't support", "bodyText": "Revert the decision for the sendOffsetsToTransaction(groupMetadata) API to fail with old version of brokers for the sake of making the application easier to adapt between versions. This PR silently downgrade the TxnOffsetCommit API when the build version is small than 3.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-03-27T20:10:31Z", "url": "https://github.com/apache/kafka/pull/8375", "merged": true, "mergeCommit": {"oid": "7f640f13b4d486477035c3edb28466734f053beb"}, "closed": true, "closedAt": "2020-04-03T04:48:37Z", "author": {"login": "abbccdda"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcR2eQbgBqjMxNzM5MTgzNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTxOkJAFqTM4NjcxNzg1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTczMDM3", "url": "https://github.com/apache/kafka/pull/8375#pullrequestreview-383173037", "createdAt": "2020-03-27T20:18:04Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDoxODowNFrOF9AkKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDoxODowNFrOF9AkKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUxNjcxNQ==", "bodyText": "side cleanups", "url": "https://github.com/apache/kafka/pull/8375#discussion_r399516715", "createdAt": "2020-03-27T20:18:04Z", "author": {"login": "abbccdda"}, "path": "clients/src/test/java/org/apache/kafka/clients/producer/KafkaProducerTest.java", "diffHunk": "@@ -138,8 +142,8 @@ public void testOverwriteAcksAndRetriesForIdempotentProducers() {\n \n         ProducerConfig config = new ProducerConfig(props);\n         assertTrue(config.getBoolean(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG));\n-        assertTrue(Arrays.asList(\"-1\", \"all\").stream().anyMatch(each -> each.equalsIgnoreCase(config.getString(ProducerConfig.ACKS_CONFIG))));\n-        assertTrue(config.getInt(ProducerConfig.RETRIES_CONFIG) == Integer.MAX_VALUE);\n+        assertTrue(Stream.of(\"-1\", \"all\").anyMatch(each -> each.equalsIgnoreCase(config.getString(ProducerConfig.ACKS_CONFIG))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTcyOTA2", "url": "https://github.com/apache/kafka/pull/8375#pullrequestreview-383172906", "createdAt": "2020-03-27T20:17:49Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDoxNzo0OVrOF9AjwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDoxOTo1NFrOF9Anig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUxNjYwOA==", "bodyText": "which only sends with consumer group id -- seems obvious from the API. Should we remove this part?", "url": "https://github.com/apache/kafka/pull/8375#discussion_r399516608", "createdAt": "2020-03-27T20:17:49Z", "author": {"login": "mjsax"}, "path": "clients/src/main/java/org/apache/kafka/clients/producer/KafkaProducer.java", "diffHunk": "@@ -642,17 +642,19 @@ public void sendOffsetsToTransaction(Map<TopicPartition, OffsetAndMetadata> offs\n      * This method should be used when you need to batch consumed and produced messages\n      * together, typically in a consume-transform-produce pattern. Thus, the specified\n      * {@code groupMetadata} should be extracted from the used {@link KafkaConsumer consumer} via\n-     * {@link KafkaConsumer#groupMetadata()} to leverage consumer group metadata for proper fencing.\n+     * {@link KafkaConsumer#groupMetadata()} to leverage consumer group metadata for stronger fencing than\n+     * {@link #sendOffsetsToTransaction(Map, String)} which only sends with consumer group id.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUxNzU3OA==", "bodyText": "missing <p>", "url": "https://github.com/apache/kafka/pull/8375#discussion_r399517578", "createdAt": "2020-03-27T20:19:54Z", "author": {"login": "mjsax"}, "path": "clients/src/main/java/org/apache/kafka/clients/producer/KafkaProducer.java", "diffHunk": "@@ -642,17 +642,19 @@ public void sendOffsetsToTransaction(Map<TopicPartition, OffsetAndMetadata> offs\n      * This method should be used when you need to batch consumed and produced messages\n      * together, typically in a consume-transform-produce pattern. Thus, the specified\n      * {@code groupMetadata} should be extracted from the used {@link KafkaConsumer consumer} via\n-     * {@link KafkaConsumer#groupMetadata()} to leverage consumer group metadata for proper fencing.\n+     * {@link KafkaConsumer#groupMetadata()} to leverage consumer group metadata for stronger fencing than\n+     * {@link #sendOffsetsToTransaction(Map, String)} which only sends with consumer group id.\n+     * If broker doesn't support this new transactional API (i.e. if its version is lower than 2.5.0),\n+     * this call will silently downgrade to the equivalent of {@link #sendOffsetsToTransaction(Map, String)}.\n+     *", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjM4NTEw", "url": "https://github.com/apache/kafka/pull/8375#pullrequestreview-383238510", "createdAt": "2020-03-27T22:41:45Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "283d71aae14af024c663f9b7ffc96433953d8264", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/283d71aae14af024c663f9b7ffc96433953d8264", "committedDate": "2020-03-31T01:24:42Z", "message": "Fallback group metadata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f6e9a6d655461399f51a16947fc7f9197564874", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/3f6e9a6d655461399f51a16947fc7f9197564874", "committedDate": "2020-03-31T01:24:42Z", "message": "address comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d7673b03e9dd70749c849fcb26e74b60e7c2909", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/7d7673b03e9dd70749c849fcb26e74b60e7c2909", "committedDate": "2020-03-31T01:33:50Z", "message": "reenable system test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "315bd5489fb6e0118011decab3d97d26bc9b4a72", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/315bd5489fb6e0118011decab3d97d26bc9b4a72", "committedDate": "2020-03-31T03:44:02Z", "message": "add internal flag for txn commit downgrade"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad71a05bd31b3983977ea0cff174fd828996f8d4", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/ad71a05bd31b3983977ea0cff174fd828996f8d4", "committedDate": "2020-03-31T05:01:24Z", "message": "partially done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d62d08f05031d391b35d4a216b4751b4f8fe35e1", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/d62d08f05031d391b35d4a216b4751b4f8fe35e1", "committedDate": "2020-03-31T05:29:55Z", "message": "replacement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13311b522f4ef6a38f7f0e5bd327d81bbaac462d", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/13311b522f4ef6a38f7f0e5bd327d81bbaac462d", "committedDate": "2020-03-31T05:41:54Z", "message": "fix txn producer test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "13311b522f4ef6a38f7f0e5bd327d81bbaac462d", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/13311b522f4ef6a38f7f0e5bd327d81bbaac462d", "committedDate": "2020-03-31T05:41:54Z", "message": "fix txn producer test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a81cdc482bb8068dd2dd04cb70b2e54d32315d8e", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/a81cdc482bb8068dd2dd04cb70b2e54d32315d8e", "committedDate": "2020-03-31T05:49:37Z", "message": "comment revers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NDMwMTE0", "url": "https://github.com/apache/kafka/pull/8375#pullrequestreview-384430114", "createdAt": "2020-03-31T06:20:16Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNjoyMDoxNlrOF-G1gA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNjoyMDoxNlrOF-G1gA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY2ODAzMg==", "bodyText": "Extracting all the common parameters for easier test composition, and easier templating for the downgrade test, so that we don't need to carry these redundant messages around.", "url": "https://github.com/apache/kafka/pull/8375#discussion_r400668032", "createdAt": "2020-03-31T06:20:16Z", "author": {"login": "abbccdda"}, "path": "clients/src/test/java/org/apache/kafka/clients/producer/internals/TransactionManagerTest.java", "diffHunk": "@@ -112,12 +112,21 @@\n     private static final int MAX_BLOCK_TIMEOUT = 1000;\n     private static final int REQUEST_TIMEOUT = 1000;\n     private static final long DEFAULT_RETRY_BACKOFF_MS = 100L;\n+\n+\n     private final String transactionalId = \"foobar\";\n     private final int transactionTimeoutMs = 1121;\n \n     private final String topic = \"test\";\n     private final TopicPartition tp0 = new TopicPartition(topic, 0);\n     private final TopicPartition tp1 = new TopicPartition(topic, 1);\n+    private final long producerId = 13131L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NDMwNjI5", "url": "https://github.com/apache/kafka/pull/8375#pullrequestreview-384430629", "createdAt": "2020-03-31T06:21:31Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNjoyMTozMVrOF-G3Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNjoyMTozMVrOF-G3Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY2ODQ1MA==", "bodyText": "Refactor out the common prepareGroupMetadataCommit to simplify the test construction", "url": "https://github.com/apache/kafka/pull/8375#discussion_r400668450", "createdAt": "2020-03-31T06:21:31Z", "author": {"login": "abbccdda"}, "path": "clients/src/test/java/org/apache/kafka/clients/producer/internals/TransactionManagerTest.java", "diffHunk": "@@ -2151,59 +2004,98 @@ public void shouldFailAbortIfAddOffsetsFailsWithFatalError() {\n \n     @Test\n     public void testSendOffsetsWithGroupMetadata() {\n-        final long pid = 13131L;\n-        final short epoch = 1;\n+        Map<TopicPartition, Errors> txnOffsetCommitResponse = new HashMap<>();\n+        txnOffsetCommitResponse.put(tp0, Errors.NONE);\n+        txnOffsetCommitResponse.put(tp1, Errors.COORDINATOR_LOAD_IN_PROGRESS);\n \n-        doInitTransactions(pid, epoch);\n+        TransactionalRequestResult addOffsetsResult = prepareGroupMetadataCommit(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1480}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NDMyMTU3", "url": "https://github.com/apache/kafka/pull/8375#pullrequestreview-384432157", "createdAt": "2020-03-31T06:24:55Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNjoyNDo1NVrOF-G8MQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNjoyNDo1NVrOF-G8MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY2OTc0NQ==", "bodyText": "Only side cleanups in this class", "url": "https://github.com/apache/kafka/pull/8375#discussion_r400669745", "createdAt": "2020-03-31T06:24:55Z", "author": {"login": "abbccdda"}, "path": "core/src/test/scala/unit/kafka/server/RequestQuotaTest.scala", "diffHunk": "@@ -60,7 +60,7 @@ class RequestQuotaTest extends BaseRequestTest {\n   private val smallQuotaProducerClientId = \"small-quota-producer-client\"\n   private val smallQuotaConsumerClientId = \"small-quota-consumer-client\"\n   private val brokerId: Integer = 0\n-  private var leaderNode: KafkaServer = null\n+  private var leaderNode: KafkaServer = _", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NDM2MDA0", "url": "https://github.com/apache/kafka/pull/8375#pullrequestreview-384436004", "createdAt": "2020-03-31T06:33:22Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNjozMzoyM1rOF-HIow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNjozMzoyM1rOF-HIow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3MjkzMQ==", "bodyText": "Maybe I misunderstood this TODO here, but I suppose EOS-beta should only work with broker 2.5 or higher correct? This sentence is a bit weird @mjsax", "url": "https://github.com/apache/kafka/pull/8375#discussion_r400672931", "createdAt": "2020-03-31T06:33:23Z", "author": {"login": "abbccdda"}, "path": "tests/kafkatest/tests/streams/streams_broker_compatibility_test.py", "diffHunk": "@@ -29,7 +29,7 @@ class StreamsBrokerCompatibility(Test):\n     These tests validates that\n     - Streams works for older brokers 0.11 (or newer)\n     - Streams w/ EOS-alpha works for older brokers 0.11 (or newer)\n-    - (TODO) Streams w/ EOS-beta works for older brokers 2.5 (or newer)\n+    - Streams w/ EOS-beta works for older brokers 2.5 (or newer)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "098111e82755fa30e1a987a51805a760da011db3", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/098111e82755fa30e1a987a51805a760da011db3", "committedDate": "2020-03-31T15:33:32Z", "message": "fix tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "098111e82755fa30e1a987a51805a760da011db3", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/098111e82755fa30e1a987a51805a760da011db3", "committedDate": "2020-03-31T15:33:32Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MTg3MDYw", "url": "https://github.com/apache/kafka/pull/8375#pullrequestreview-385187060", "createdAt": "2020-04-01T00:10:08Z", "commit": {"oid": "098111e82755fa30e1a987a51805a760da011db3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMDoxMDowOFrOF-sgLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMDoxMTozOFrOF-shzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4NTE2Nw==", "bodyText": "nit: move logContext to its own line", "url": "https://github.com/apache/kafka/pull/8375#discussion_r401285167", "createdAt": "2020-04-01T00:10:08Z", "author": {"login": "mjsax"}, "path": "clients/src/main/java/org/apache/kafka/clients/producer/KafkaProducer.java", "diffHunk": "@@ -510,18 +510,24 @@ private TransactionManager configureTransactionState(ProducerConfig config,\n \n         TransactionManager transactionManager = null;\n \n-        boolean userConfiguredIdempotence = config.originals().containsKey(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG);\n-        boolean userConfiguredTransactions = config.originals().containsKey(ProducerConfig.TRANSACTIONAL_ID_CONFIG);\n+        final boolean userConfiguredIdempotence = config.originals().containsKey(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG);\n+        final boolean userConfiguredTransactions = config.originals().containsKey(ProducerConfig.TRANSACTIONAL_ID_CONFIG);\n         if (userConfiguredTransactions && !userConfiguredIdempotence)\n             log.info(\"Overriding the default {} to true since {} is specified.\", ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG,\n                     ProducerConfig.TRANSACTIONAL_ID_CONFIG);\n \n         if (config.idempotenceEnabled()) {\n-            String transactionalId = config.getString(ProducerConfig.TRANSACTIONAL_ID_CONFIG);\n-            int transactionTimeoutMs = config.getInt(ProducerConfig.TRANSACTION_TIMEOUT_CONFIG);\n-            long retryBackoffMs = config.getLong(ProducerConfig.RETRY_BACKOFF_MS_CONFIG);\n-            transactionManager = new TransactionManager(logContext, transactionalId, transactionTimeoutMs,\n-                    retryBackoffMs, apiVersions);\n+            final String transactionalId = config.getString(ProducerConfig.TRANSACTIONAL_ID_CONFIG);\n+            final int transactionTimeoutMs = config.getInt(ProducerConfig.TRANSACTION_TIMEOUT_CONFIG);\n+            final long retryBackoffMs = config.getLong(ProducerConfig.RETRY_BACKOFF_MS_CONFIG);\n+            final boolean autoDowngradeTxnCommit = config.getBoolean(ProducerConfig.AUTO_DOWNGRADE_TXN_COMMIT);\n+            transactionManager = new TransactionManager(logContext,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "098111e82755fa30e1a987a51805a760da011db3"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4NTU4Mg==", "bodyText": "is [not] supported", "url": "https://github.com/apache/kafka/pull/8375#discussion_r401285582", "createdAt": "2020-04-01T00:11:38Z", "author": {"login": "mjsax"}, "path": "clients/src/main/java/org/apache/kafka/clients/producer/ProducerConfig.java", "diffHunk": "@@ -258,6 +258,21 @@\n     public static final String SECURITY_PROVIDERS_CONFIG = SecurityConfig.SECURITY_PROVIDERS_CONFIG;\n     private static final String SECURITY_PROVIDERS_DOC = SecurityConfig.SECURITY_PROVIDERS_DOC;\n \n+    /**\n+     * <code>internal.auto.downgrade.txn.commit</code>\n+     * Whether or not the producer should automatically downgrade the transactional commit request when the new group metadata\n+     * feature is supported by the broker.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "098111e82755fa30e1a987a51805a760da011db3"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0a4a0a2bf7f08a6f1fb7c1221118246f9180a36", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/b0a4a0a2bf7f08a6f1fb7c1221118246f9180a36", "committedDate": "2020-04-01T01:44:49Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjYwNjkz", "url": "https://github.com/apache/kafka/pull/8375#pullrequestreview-385260693", "createdAt": "2020-04-01T04:39:11Z", "commit": {"oid": "b0a4a0a2bf7f08a6f1fb7c1221118246f9180a36"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NzE3ODUw", "url": "https://github.com/apache/kafka/pull/8375#pullrequestreview-386717850", "createdAt": "2020-04-02T19:08:21Z", "commit": {"oid": "098111e82755fa30e1a987a51805a760da011db3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxOTowODoyMVrOF_5k5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxOTowODoyMVrOF_5k5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0Nzk0MA==", "bodyText": "groupInstanceId field should never be null, I think we should check against Optional.empty().", "url": "https://github.com/apache/kafka/pull/8375#discussion_r402547940", "createdAt": "2020-04-02T19:08:21Z", "author": {"login": "guozhangwang"}, "path": "clients/src/main/java/org/apache/kafka/common/requests/TxnOffsetCommitRequest.java", "diffHunk": "@@ -78,13 +88,36 @@ public Builder(final String transactionalId,\n                             .setMemberId(memberId)\n                             .setGenerationId(generationId)\n                             .setGroupInstanceId(groupInstanceId.orElse(null));\n+            this.autoDowngrade = autoDowngrade;\n         }\n \n         @Override\n         public TxnOffsetCommitRequest build(short version) {\n+            if (version < 3 && groupMetadataSet()) {\n+                if (autoDowngrade) {\n+                    log.trace(\"Downgrade the request by resetting group metadata fields: \" +\n+                                  \"[member.id:{}, generation.id:{}, group.instance.id:{}], because broker \" +\n+                                  \"only supports TxnOffsetCommit version {}. Need \" +\n+                                  \"v3 or newer to enable this feature\",\n+                        data.memberId(), data.generationId(), data.groupInstanceId(), version);\n+\n+                    data.setGenerationId(JoinGroupRequest.UNKNOWN_GENERATION_ID)\n+                        .setMemberId(JoinGroupRequest.UNKNOWN_MEMBER_ID)\n+                        .setGroupInstanceId(null);\n+                } else {\n+                    throw new UnsupportedVersionException(\"Broker unexpectedly \" +\n+                        \"doesn't support group metadata commit API on version \" + version);\n+                }\n+            }\n             return new TxnOffsetCommitRequest(data, version);\n         }\n \n+        private boolean groupMetadataSet() {\n+            return !data.memberId().equals(JoinGroupRequest.UNKNOWN_MEMBER_ID) ||\n+                       data.generationId() != JoinGroupRequest.UNKNOWN_GENERATION_ID ||\n+                       data.groupInstanceId() != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "098111e82755fa30e1a987a51805a760da011db3"}, "originalPosition": 92}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1722, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}