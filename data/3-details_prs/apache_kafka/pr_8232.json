{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NDI3NjU0", "number": 8232, "title": "KAFKA-9658: Fix removing user quotas", "bodyText": "Adding (add-config) default user, user, or <user, client-id> quota and then removing it via delete-config does not update quota bound in ClientQuotaManager.Metrics for existing users or <user,client-id>. This causes brokers to continue to throttle with the previously set quotas until brokers restart (or <user,client> stops sending traffic for sometime and sensor expires). This happens only when removing the user or user,client-id where there are no more quotas  to fall back to. Common example where the issue happens: Initial no quota state --> add default user quota --> remove default user quota.\nThe cause of the issue was DefaultQuotaCallback.quotaLimit was returning null when no default user quota set, which caused ClientQuotaManager.updateQuotaMetricConfigs to skip updating the appropriate sensor, which left it unchanged with the previous quota. Since null is an acceptable return value for ClientQuotaCallback.quotaLimit, which is already treated as unlimited quota in other parts of the code, this PR ensures that ClientQuotaManager.updateQuotaMetricConfigs updates the quotas for which  ClientQuotaCallback.quotaLimit returns null to unlimited quota.\nAdded 3 unit tests that failed before the fix in the PR.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-03-05T18:15:01Z", "url": "https://github.com/apache/kafka/pull/8232", "merged": true, "mergeCommit": {"oid": "97fc6a52216a3da1c76771ddc37e25fed102551c"}, "closed": true, "closedAt": "2020-03-10T19:30:59Z", "author": {"login": "apovzner"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKmq8AgH2gAyMzg0NDI3NjU0OjJiZGEyMzI4N2U1MGMzYzNiNDc0NTIzNDg2NmViMGFhYWIxYWU1MWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLFmqKAFqTM3MDU4NTcxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2bda23287e50c3c3b4745234866eb0aaab1ae51b", "author": {"user": {"login": "apovzner", "name": "Anna Povzner"}}, "url": "https://github.com/apache/kafka/commit/2bda23287e50c3c3b4745234866eb0aaab1ae51b", "committedDate": "2020-03-05T07:48:37Z", "message": "KAFKA-9658: Fix removing user quotas"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODQzMzQ5", "url": "https://github.com/apache/kafka/pull/8232#pullrequestreview-369843349", "createdAt": "2020-03-05T19:16:55Z", "commit": {"oid": "2bda23287e50c3c3b4745234866eb0aaab1ae51b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOToxNjo1NVrOFygkmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOToxNjo1NVrOFygkmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUwNjc3OA==", "bodyText": "With this change, it seems like we don't need to let this function return null anymore. In all the branches, the final result will be ClientQuotaManagerConfig.UnlimitedQuota or staticConfigClientIdQuota if we could not find another quota. That would let us simplify some of the usages.", "url": "https://github.com/apache/kafka/pull/8232#discussion_r388506778", "createdAt": "2020-03-05T19:16:55Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/server/ClientQuotaManager.scala", "diffHunk": "@@ -562,13 +562,17 @@ class ClientQuotaManager(private val config: ClientQuotaManagerConfig,\n             // /config/users/<default>/clients/<default>\n             quota = overriddenQuotas.get(DefaultUserClientIdQuotaEntity)\n           }\n+          if (quota == null)\n+            quota = ClientQuotaManagerConfig.UnlimitedQuota", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bda23287e50c3c3b4745234866eb0aaab1ae51b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d80de11e94f26d37c19617a39993d67f75e82bb7", "author": {"user": {"login": "apovzner", "name": "Anna Povzner"}}, "url": "https://github.com/apache/kafka/commit/d80de11e94f26d37c19617a39993d67f75e82bb7", "committedDate": "2020-03-05T22:50:36Z", "message": "do not duplicate unlimited quota assignment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMjgwMTMz", "url": "https://github.com/apache/kafka/pull/8232#pullrequestreview-370280133", "createdAt": "2020-03-06T12:16:10Z", "commit": {"oid": "d80de11e94f26d37c19617a39993d67f75e82bb7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMjoxNjoxMFrOFy2yrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMjoxNjoxMFrOFy2yrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3MDgzMQ==", "bodyText": "Rather than change the default callback, I think it may be better to change the caller updateQuotaMetricConfigs to handle null case better. At the moment, updateQuotaMetricConfigs updates metrics only if quotaCallback.quotaLimit is non-null. This works in most cases because null indicates that those tags are no longer in use and hence we don't need to update them - those metrics will eventually expire.\nThe problem is once we enable any quotas, we always use quota metrics and the tags depend on what quotas were enabled. To be safe, we should update existing metrics regardless of whether the callback returns null. This PR addresses the issue for the default callback. But since this is a valid case for any callback implementation, using ClientQuotaCallback.quotaLimit(that returns a non-null value ) instead of quotaCallback.quotaLimit in updateQuotaMetricConfigs would ensure that we always update existing metrics with any callback.", "url": "https://github.com/apache/kafka/pull/8232#discussion_r388870831", "createdAt": "2020-03-06T12:16:10Z", "author": {"login": "rajinisivaram"}, "path": "core/src/main/scala/kafka/server/ClientQuotaManager.scala", "diffHunk": "@@ -579,6 +579,8 @@ class ClientQuotaManager(private val config: ClientQuotaManagerConfig,\n           if (quota == null)\n             quota = staticConfigClientIdQuota\n         }\n+        if (quota == null)\n+          quota = ClientQuotaManagerConfig.UnlimitedQuota", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d80de11e94f26d37c19617a39993d67f75e82bb7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4207ea8d2c2378d40e94ca1f302cef7dc6abdf3a", "author": {"user": {"login": "apovzner", "name": "Anna Povzner"}}, "url": "https://github.com/apache/kafka/commit/4207ea8d2c2378d40e94ca1f302cef7dc6abdf3a", "committedDate": "2020-03-06T19:18:40Z", "message": "update quotas in Metrics even when quotaCallback.quotaLimit returns null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNTg1NzE5", "url": "https://github.com/apache/kafka/pull/8232#pullrequestreview-370585719", "createdAt": "2020-03-06T19:51:00Z", "commit": {"oid": "4207ea8d2c2378d40e94ca1f302cef7dc6abdf3a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 409, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}