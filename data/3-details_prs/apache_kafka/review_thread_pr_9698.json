{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyODQ5ODM1", "number": 9698, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwNDo1NTo0OFrOFBmNsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwNTowMjo1OFrOFBmUIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MjE4OTk1OnYy", "diffSide": "RIGHT", "path": "connect/mirror/src/test/java/org/apache/kafka/connect/mirror/MirrorConnectorsIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwNDo1NTo0OFrOIAV-Gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNTozMToxOVrOIAsbWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIzMDg3NQ==", "bodyText": "It seems exitProcedure and haltProcedure can be local variable", "url": "https://github.com/apache/kafka/pull/9698#discussion_r537230875", "createdAt": "2020-12-07T04:55:48Z", "author": {"login": "chia7712"}, "path": "connect/mirror/src/test/java/org/apache/kafka/connect/mirror/MirrorConnectorsIntegrationTest.java", "diffHunk": "@@ -75,14 +74,45 @@\n     private static final int RECORD_CONSUME_DURATION_MS = 20_000;\n     private static final int OFFSET_SYNC_DURATION_MS = 30_000;\n \n-    private final AtomicBoolean exited = new AtomicBoolean(false);\n+    private volatile boolean shuttingDown;\n     private Map<String, String> mm2Props;\n     private MirrorMakerConfig mm2Config;\n     private EmbeddedConnectCluster primary;\n     private EmbeddedConnectCluster backup;\n \n+    private Exit.Procedure exitProcedure;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70a58cce688f94627d4d39d0e360955f3a35971"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5ODgxMA==", "bodyText": "Perhaps, but the log messages for each is different, so IMO it's better to keep them separate.", "url": "https://github.com/apache/kafka/pull/9698#discussion_r537598810", "createdAt": "2020-12-07T15:31:19Z", "author": {"login": "rhauch"}, "path": "connect/mirror/src/test/java/org/apache/kafka/connect/mirror/MirrorConnectorsIntegrationTest.java", "diffHunk": "@@ -75,14 +74,45 @@\n     private static final int RECORD_CONSUME_DURATION_MS = 20_000;\n     private static final int OFFSET_SYNC_DURATION_MS = 30_000;\n \n-    private final AtomicBoolean exited = new AtomicBoolean(false);\n+    private volatile boolean shuttingDown;\n     private Map<String, String> mm2Props;\n     private MirrorMakerConfig mm2Config;\n     private EmbeddedConnectCluster primary;\n     private EmbeddedConnectCluster backup;\n \n+    private Exit.Procedure exitProcedure;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIzMDg3NQ=="}, "originalCommit": {"oid": "c70a58cce688f94627d4d39d0e360955f3a35971"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MjIwNjQzOnYy", "diffSide": "RIGHT", "path": "connect/mirror/src/test/java/org/apache/kafka/connect/mirror/MirrorConnectorsIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwNTowMjo1OFrOIAWGgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNTozMjoyNFrOIAse2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIzMzAyNA==", "bodyText": "How about using Utils.closeQuietly to replace this nested try-block?", "url": "https://github.com/apache/kafka/pull/9698#discussion_r537233024", "createdAt": "2020-12-07T05:02:58Z", "author": {"login": "chia7712"}, "path": "connect/mirror/src/test/java/org/apache/kafka/connect/mirror/MirrorConnectorsIntegrationTest.java", "diffHunk": "@@ -194,20 +224,27 @@ private void waitUntilMirrorMakerIsRunning(EmbeddedConnectCluster connectCluster\n \n     @After\n     public void close() {\n-        for (String x : primary.connectors()) {\n-            primary.deleteConnector(x);\n-        }\n-        for (String x : backup.connectors()) {\n-            backup.deleteConnector(x);\n-        }\n-        deleteAllTopics(primary.kafka());\n-        deleteAllTopics(backup.kafka());\n-        primary.stop();\n-        backup.stop();\n         try {\n-            assertFalse(exited.get());\n+            for (String x : primary.connectors()) {\n+                primary.deleteConnector(x);\n+            }\n+            for (String x : backup.connectors()) {\n+                backup.deleteConnector(x);\n+            }\n+            deleteAllTopics(primary.kafka());\n+            deleteAllTopics(backup.kafka());\n         } finally {\n-            Exit.resetExitProcedure();\n+            shuttingDown = true;\n+            try {\n+                try {\n+                    primary.stop();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70a58cce688f94627d4d39d0e360955f3a35971"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5OTcwNA==", "bodyText": "EmbeddedConnectCluster is not AutoCloseable, which means we can't use that. Since this PR is to fix broken builds, I'd like to minimize the additional changes, so I'll issue a followup PR.", "url": "https://github.com/apache/kafka/pull/9698#discussion_r537599704", "createdAt": "2020-12-07T15:32:24Z", "author": {"login": "rhauch"}, "path": "connect/mirror/src/test/java/org/apache/kafka/connect/mirror/MirrorConnectorsIntegrationTest.java", "diffHunk": "@@ -194,20 +224,27 @@ private void waitUntilMirrorMakerIsRunning(EmbeddedConnectCluster connectCluster\n \n     @After\n     public void close() {\n-        for (String x : primary.connectors()) {\n-            primary.deleteConnector(x);\n-        }\n-        for (String x : backup.connectors()) {\n-            backup.deleteConnector(x);\n-        }\n-        deleteAllTopics(primary.kafka());\n-        deleteAllTopics(backup.kafka());\n-        primary.stop();\n-        backup.stop();\n         try {\n-            assertFalse(exited.get());\n+            for (String x : primary.connectors()) {\n+                primary.deleteConnector(x);\n+            }\n+            for (String x : backup.connectors()) {\n+                backup.deleteConnector(x);\n+            }\n+            deleteAllTopics(primary.kafka());\n+            deleteAllTopics(backup.kafka());\n         } finally {\n-            Exit.resetExitProcedure();\n+            shuttingDown = true;\n+            try {\n+                try {\n+                    primary.stop();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIzMzAyNA=="}, "originalCommit": {"oid": "c70a58cce688f94627d4d39d0e360955f3a35971"}, "originalPosition": 123}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3699, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}