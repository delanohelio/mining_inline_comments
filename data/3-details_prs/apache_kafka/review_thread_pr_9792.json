{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2MDEyMzE5", "number": 9792, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxNzozMjo0N1rOFKInfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNToyMjo1OFrOFKw_5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MTcxMjYzOnYy", "diffSide": "RIGHT", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxNzozMjo0N1rOIMx4eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwNjoyODozNlrOIM6QCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MTA5OA==", "bodyText": "I think the call to requestRejoin is not needed. We only reset the rejoinNeeded flag after the subsequent SyncGroup request. Or is there a case that this misses?", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550271098", "createdAt": "2020-12-30T17:32:47Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -658,6 +658,10 @@ public void handle(JoinGroupResponse joinResponse, RequestFuture<ByteBuffer> fut\n                     AbstractCoordinator.this.generation = new Generation(OffsetCommitRequest.DEFAULT_GENERATION_ID, memberId, null);\n                 }\n                 future.raise(error);\n+            } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n+                log.info(\"JoinGroup failed due to the group began another rebalance. Need to re-join the group.\");\n+                requestRejoin();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50db08798b3e485e9cda89881e30c5c1c7d5684a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwODIwMw==", "bodyText": "You're correct. Removed. Thanks.", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550408203", "createdAt": "2020-12-31T06:28:36Z", "author": {"login": "showuon"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -658,6 +658,10 @@ public void handle(JoinGroupResponse joinResponse, RequestFuture<ByteBuffer> fut\n                     AbstractCoordinator.this.generation = new Generation(OffsetCommitRequest.DEFAULT_GENERATION_ID, memberId, null);\n                 }\n                 future.raise(error);\n+            } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n+                log.info(\"JoinGroup failed due to the group began another rebalance. Need to re-join the group.\");\n+                requestRejoin();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MTA5OA=="}, "originalCommit": {"oid": "50db08798b3e485e9cda89881e30c5c1c7d5684a"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MTcyNjc1OnYy", "diffSide": "RIGHT", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxNzozOToyN1rOIMyANA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwNjoyODoyMFrOIM6P5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MzA3Ng==", "bodyText": "I guess it's kind of a confusing error to see. The case on the broker is when the write to the log failed because of a timeout. I wonder if it would be useful to suggest the cause in the message. For example:\n\nJoinGroup failed with a REBALANCE_IN_PROGRESS error, which could indicate a replication timeout on the broker. Will retry.", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550273076", "createdAt": "2020-12-30T17:39:27Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -658,6 +658,10 @@ public void handle(JoinGroupResponse joinResponse, RequestFuture<ByteBuffer> fut\n                     AbstractCoordinator.this.generation = new Generation(OffsetCommitRequest.DEFAULT_GENERATION_ID, memberId, null);\n                 }\n                 future.raise(error);\n+            } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n+                log.info(\"JoinGroup failed due to the group began another rebalance. Need to re-join the group.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50db08798b3e485e9cda89881e30c5c1c7d5684a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwODE2NQ==", "bodyText": "Agree. Thanks.", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550408165", "createdAt": "2020-12-31T06:28:20Z", "author": {"login": "showuon"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -658,6 +658,10 @@ public void handle(JoinGroupResponse joinResponse, RequestFuture<ByteBuffer> fut\n                     AbstractCoordinator.this.generation = new Generation(OffsetCommitRequest.DEFAULT_GENERATION_ID, memberId, null);\n                 }\n                 future.raise(error);\n+            } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n+                log.info(\"JoinGroup failed due to the group began another rebalance. Need to re-join the group.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MzA3Ng=="}, "originalCommit": {"oid": "50db08798b3e485e9cda89881e30c5c1c7d5684a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MTcyODI5OnYy", "diffSide": "RIGHT", "path": "clients/src/test/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinatorTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxNzo0MDoyMlrOIMyBJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwNjoyODo0NVrOIM6QLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MzMxNw==", "bodyText": "Can we verify that the JoinGroup gets retried on the next poll?", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550273317", "createdAt": "2020-12-30T17:40:22Z", "author": {"login": "hachikuji"}, "path": "clients/src/test/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinatorTest.java", "diffHunk": "@@ -823,6 +823,24 @@ public void testJoinGroupRequestWithGroupInstanceIdNotFound() {\n         assertTrue(coordinator.hasUnknownGeneration());\n     }\n \n+    @Test\n+    public void testJoinGroupRequestWithRebalanceInProgress() {\n+        setupCoordinator();\n+        mockClient.prepareResponse(groupCoordinatorResponse(node, Errors.NONE));\n+        coordinator.ensureCoordinatorReady(mockTime.timer(0));\n+\n+        mockClient.prepareResponse(\n+            joinGroupFollowerResponse(defaultGeneration, memberId, JoinGroupRequest.UNKNOWN_MEMBER_ID, Errors.REBALANCE_IN_PROGRESS));\n+\n+        RequestFuture<ByteBuffer> future = coordinator.sendJoinGroupRequest();\n+\n+        assertTrue(consumerClient.poll(future, mockTime.timer(REQUEST_TIMEOUT_MS)));\n+        assertTrue(future.exception().getClass().isInstance(Errors.REBALANCE_IN_PROGRESS.exception()));\n+        assertEquals(Errors.REBALANCE_IN_PROGRESS.message(), future.exception().getMessage());\n+        // should request rejoin\n+        assertTrue(coordinator.rejoinNeededOrPending());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50db08798b3e485e9cda89881e30c5c1c7d5684a"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwODIzOQ==", "bodyText": "Added. Thanks.", "url": "https://github.com/apache/kafka/pull/9792#discussion_r550408239", "createdAt": "2020-12-31T06:28:45Z", "author": {"login": "showuon"}, "path": "clients/src/test/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinatorTest.java", "diffHunk": "@@ -823,6 +823,24 @@ public void testJoinGroupRequestWithGroupInstanceIdNotFound() {\n         assertTrue(coordinator.hasUnknownGeneration());\n     }\n \n+    @Test\n+    public void testJoinGroupRequestWithRebalanceInProgress() {\n+        setupCoordinator();\n+        mockClient.prepareResponse(groupCoordinatorResponse(node, Errors.NONE));\n+        coordinator.ensureCoordinatorReady(mockTime.timer(0));\n+\n+        mockClient.prepareResponse(\n+            joinGroupFollowerResponse(defaultGeneration, memberId, JoinGroupRequest.UNKNOWN_MEMBER_ID, Errors.REBALANCE_IN_PROGRESS));\n+\n+        RequestFuture<ByteBuffer> future = coordinator.sendJoinGroupRequest();\n+\n+        assertTrue(consumerClient.poll(future, mockTime.timer(REQUEST_TIMEOUT_MS)));\n+        assertTrue(future.exception().getClass().isInstance(Errors.REBALANCE_IN_PROGRESS.exception()));\n+        assertEquals(Errors.REBALANCE_IN_PROGRESS.message(), future.exception().getMessage());\n+        // should request rejoin\n+        assertTrue(coordinator.rejoinNeededOrPending());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MzMxNw=="}, "originalCommit": {"oid": "50db08798b3e485e9cda89881e30c5c1c7d5684a"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODMyODY5OnYy", "diffSide": "RIGHT", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNToyMjo1OFrOINl4SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNTo1NDozN1rOINmQSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTEyMzAxNw==", "bodyText": "Could we mention in the log that the error is non-fatal, similar to MEMBER_ID_REQUIRED?", "url": "https://github.com/apache/kafka/pull/9792#discussion_r551123017", "createdAt": "2021-01-04T05:22:58Z", "author": {"login": "abbccdda"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -658,6 +658,10 @@ public void handle(JoinGroupResponse joinResponse, RequestFuture<ByteBuffer> fut\n                     AbstractCoordinator.this.generation = new Generation(OffsetCommitRequest.DEFAULT_GENERATION_ID, memberId, null);\n                 }\n                 future.raise(error);\n+            } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n+                log.info(\"JoinGroup failed with a REBALANCE_IN_PROGRESS error, which could indicate a replication timeout \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62c3c76ddb8b8d1163281b837c2b273824a9e1ec"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTEyOTE2MA==", "bodyText": "@abbccdda , thanks for your comment. Just updated. Thanks.", "url": "https://github.com/apache/kafka/pull/9792#discussion_r551129160", "createdAt": "2021-01-04T05:54:37Z", "author": {"login": "showuon"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -658,6 +658,10 @@ public void handle(JoinGroupResponse joinResponse, RequestFuture<ByteBuffer> fut\n                     AbstractCoordinator.this.generation = new Generation(OffsetCommitRequest.DEFAULT_GENERATION_ID, memberId, null);\n                 }\n                 future.raise(error);\n+            } else if (error == Errors.REBALANCE_IN_PROGRESS) {\n+                log.info(\"JoinGroup failed with a REBALANCE_IN_PROGRESS error, which could indicate a replication timeout \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTEyMzAxNw=="}, "originalCommit": {"oid": "62c3c76ddb8b8d1163281b837c2b273824a9e1ec"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3567, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}