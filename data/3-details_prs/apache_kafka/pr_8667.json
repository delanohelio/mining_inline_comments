{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MTUyNjIx", "number": 8667, "title": "KAFKA-9994: Handle task migrated inside corruption path", "bodyText": "The TaskMigratedException should always be non-fatal and caught within the run loop. Adding try-catch for corrupted path as well is necessary.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-05-14T17:44:39Z", "url": "https://github.com/apache/kafka/pull/8667", "merged": true, "mergeCommit": {"oid": "b558287c0b6cfb8ac11548048ae12ca6b5c63257"}, "closed": true, "closedAt": "2020-05-15T00:31:50Z", "author": {"login": "abbccdda"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchRWE8gH2gAyNDE4MTUyNjIxOmQyZjI2Njc3ZjE1MDk1MWQ5YTZhZTNkMDllZDZhMDU4YjkzNmMwNTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchR3oaAFqTQxMjA3ODgzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d2f26677f150951d9a6ae3d09ed6a058b936c050", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/d2f26677f150951d9a6ae3d09ed6a058b936c050", "committedDate": "2020-05-14T17:58:05Z", "message": "Handle task migrated inside corruption path"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "d2f26677f150951d9a6ae3d09ed6a058b936c050", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/d2f26677f150951d9a6ae3d09ed6a058b936c050", "committedDate": "2020-05-14T17:58:05Z", "message": "Handle task migrated inside corruption path"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMDc4ODM0", "url": "https://github.com/apache/kafka/pull/8667#pullrequestreview-412078834", "createdAt": "2020-05-14T18:31:30Z", "commit": {"oid": "d2f26677f150951d9a6ae3d09ed6a058b936c050"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODozMTozMFrOGVpMMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODozMTozMFrOGVpMMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0ODE0NQ==", "bodyText": "Should we also handle the corrupted tasks here (before this line), so that they can be already cleaned up before the next round? Or, alternatively, should we move taskManager.handleCorruption(e.corruptedTaskWithChangelogs()); to before the attempted commit (it looks like it could be outside the try block as well).", "url": "https://github.com/apache/kafka/pull/8667#discussion_r425348145", "createdAt": "2020-05-14T18:31:30Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -555,28 +555,35 @@ void runLoop() {\n             } catch (final TaskCorruptedException e) {\n                 log.warn(\"Detected the states of tasks \" + e.corruptedTaskWithChangelogs() + \" are corrupted. \" +\n                              \"Will close the task as dirty and re-create and bootstrap from scratch.\", e);\n-\n-                taskManager.commit(\n-                    taskManager.tasks()\n-                        .values()\n-                        .stream()\n-                        .filter(t -> t.state() == Task.State.RUNNING || t.state() == Task.State.RESTORING)\n-                        .filter(t -> !e.corruptedTaskWithChangelogs().containsKey(t.id()))\n-                        .collect(Collectors.toSet())\n-                );\n-                taskManager.handleCorruption(e.corruptedTaskWithChangelogs());\n+                try {\n+                    taskManager.commit(\n+                        taskManager.tasks()\n+                            .values()\n+                            .stream()\n+                            .filter(t -> t.state() == Task.State.RUNNING || t.state() == Task.State.RESTORING)\n+                            .filter(t -> !e.corruptedTaskWithChangelogs().containsKey(t.id()))\n+                            .collect(Collectors.toSet())\n+                    );\n+                    taskManager.handleCorruption(e.corruptedTaskWithChangelogs());\n+                } catch (final TaskMigratedException taskMigrated) {\n+                    handleTaskMigrated(taskMigrated);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f26677f150951d9a6ae3d09ed6a058b936c050"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 997, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}