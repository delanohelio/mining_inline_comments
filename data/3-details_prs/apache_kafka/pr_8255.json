{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1NTMyODMz", "number": 8255, "title": "KAFKA-9686 MockConsumer#endOffsets should be idempotent", "bodyText": "private Long getEndOffset(List<Long> offsets) {\n        if (offsets == null || offsets.isEmpty()) {\n            return null;\n        }\n        return offsets.size() > 1 ? offsets.remove(0) : offsets.get(0);\n    }\nThe above code has two issues.\n\nIt does not return the latest offset since the latest offset is at the end of offsets\nIt removes the element from offsets so MockConsumer#endOffsets gets non-idempotent\n\nhttps://issues.apache.org/jira/browse/KAFKA-9686\nThe following flaky is fixed by this PR\n\nKafkaBasedLogTest.testSendAndReadToEnd\n\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-03-09T11:36:28Z", "url": "https://github.com/apache/kafka/pull/8255", "merged": true, "mergeCommit": {"oid": "fc9d91a6323baf4b79177db14f7f9af50e3c87a3"}, "closed": true, "closedAt": "2020-03-10T15:43:00Z", "author": {"login": "chia7712"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMB0Y1AFqTM3MTQwNzkyMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMUTT3AFqTM3MjA2NjYwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDA3OTIx", "url": "https://github.com/apache/kafka/pull/8255#pullrequestreview-371407921", "createdAt": "2020-03-09T18:00:17Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODowMDoxOFrOFzzeoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODowMDoxOFrOFzzeoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NTEyMA==", "bodyText": "The code seems intentionally written to store a sequence of end offsets so that each call advances the end offset. If we do not need that capability, then perhaps we can change the type of endOffsets and simplify the usage.\ncc @bbejeck Looks like you added this logic. Do you know if we rely on it?", "url": "https://github.com/apache/kafka/pull/8255#discussion_r389865120", "createdAt": "2020-03-09T18:00:18Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/MockConsumer.java", "diffHunk": "@@ -520,10 +520,8 @@ private void resetOffsetPosition(TopicPartition tp) {\n     }\n \n     private Long getEndOffset(List<Long> offsets) {\n-        if (offsets == null || offsets.isEmpty()) {\n-            return null;\n-        }\n-        return offsets.size() > 1 ? offsets.remove(0) : offsets.get(0);\n+        if (offsets == null || offsets.isEmpty()) return null;\n+        else return offsets.get(offsets.size() - 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNjU1NDgx", "url": "https://github.com/apache/kafka/pull/8255#pullrequestreview-371655481", "createdAt": "2020-03-10T03:09:16Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMzowOToxNlrOF0AHwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMzowOToxNlrOF0AHwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3MjI1Ng==", "bodyText": "I agree with @hachikuji 's observation. This test broke when #8220 retired the innerUpdateEndOffsets and replaced the two public methods addEndOffsets and updateEndOffsets that were both using innerUpdateEndOffsets with a single updateEndOffsets. However the version that was kept was actually what the unused addEndOffsets was doing (appending to the end offsets) and not what updateEndOffsets described as an overwrite of the value in endOffsets.\nThus, probably the issue should be fixed in updateEndOffsets to keep meaning overwrite. Unless we find a usage for addEndOffsets, in which case we might need some more adjustments too. Of course, if we keep only updateEndOffsets that overwrites the value of the map, we might as well simplify getEndOffset. I haven't tracked when and why addEndOffsets was stopped being used.", "url": "https://github.com/apache/kafka/pull/8255#discussion_r390072256", "createdAt": "2020-03-10T03:09:16Z", "author": {"login": "kkonstantine"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/MockConsumer.java", "diffHunk": "@@ -520,10 +520,8 @@ private void resetOffsetPosition(TopicPartition tp) {\n     }\n \n     private Long getEndOffset(List<Long> offsets) {\n-        if (offsets == null || offsets.isEmpty()) {\n-            return null;\n-        }\n-        return offsets.size() > 1 ? offsets.remove(0) : offsets.get(0);\n+        if (offsets == null || offsets.isEmpty()) return null;\n+        else return offsets.get(offsets.size() - 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NTEyMA=="}, "originalCommit": null, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e74b24c59623255a8fa8cd566ca421294c046f9d", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/e74b24c59623255a8fa8cd566ca421294c046f9d", "committedDate": "2020-03-10T05:16:32Z", "message": "KAFKA-9686 MockConsumer#endOffsets should be idempotent"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "e74b24c59623255a8fa8cd566ca421294c046f9d", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/e74b24c59623255a8fa8cd566ca421294c046f9d", "committedDate": "2020-03-10T05:16:32Z", "message": "KAFKA-9686 MockConsumer#endOffsets should be idempotent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMDY2NjA0", "url": "https://github.com/apache/kafka/pull/8255#pullrequestreview-372066604", "createdAt": "2020-03-10T15:32:22Z", "commit": {"oid": "e74b24c59623255a8fa8cd566ca421294c046f9d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 174, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}