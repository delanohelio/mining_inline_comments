{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4ODE0MTY1", "number": 9384, "title": "MINOR: remove explicit passing of AdminClient into StreamsPartitionAssignor", "bodyText": "Currently, we pass multiple object reference (AdminClient,TaskManager, and Time) into StreamsPartitionAssignor. Furthermore, we (miss)use TaskManager#mainConsumer() to get access to the main consumer (we need to do this, to avoid a cyclic dependency).\nThis PR unifies how object references are passed into a single ReferenceContainer class to\n\nnot \"miss use\" the TaskManager as reference container\nunify how object references are passes\n\nNote: we need to use a reference container to avoid cyclic dependencies, instead of using a config for each passed reference individually.", "createdAt": "2020-10-06T20:23:11Z", "url": "https://github.com/apache/kafka/pull/9384", "merged": true, "mergeCommit": {"oid": "e8ad80ebe152a2ae55272b538282e407acab5cc4"}, "closed": true, "closedAt": "2020-10-15T23:10:28Z", "author": {"login": "mjsax"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP9pGYAH2gAyNDk4ODE0MTY1OjlmODFlNDgwMjFlMDk3OGU5MGFiY2NlZWU1NDAwYTFmZTgyNmNhNTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSlIG-gFqTUwODgyMTk1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9f81e48021e0978e90abcceee5400a1fe826ca58", "author": {"user": {"login": "mjsax", "name": "Matthias J. Sax"}}, "url": "https://github.com/apache/kafka/commit/9f81e48021e0978e90abcceee5400a1fe826ca58", "committedDate": "2020-10-06T19:35:12Z", "message": "MINOR: remove explicit passing of AdminClient into StreamsPartitionAssignoer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMzMwNDA1", "url": "https://github.com/apache/kafka/pull/9384#pullrequestreview-503330405", "createdAt": "2020-10-06T20:24:53Z", "commit": {"oid": "9f81e48021e0978e90abcceee5400a1fe826ca58"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDoyNDo1M1rOHdYnrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDoyNDo1M1rOHdYnrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3NDEyNw==", "bodyText": "Instead of passing the Admin as parameter, we could call taskManager#adminClient() in the next line, however, this requires to make the method public (it's package-private atm) thus I opted to for parameter-passing instead.", "url": "https://github.com/apache/kafka/pull/9384#discussion_r500574127", "createdAt": "2020-10-06T20:24:53Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/assignment/AssignorConfiguration.java", "diffHunk": "@@ -291,11 +271,7 @@ public String userEndPoint() {\n         }\n     }\n \n-    public Admin adminClient() {\n-        return adminClient;\n-    }\n-\n-    public InternalTopicManager internalTopicManager() {\n+    public InternalTopicManager internalTopicManager(final Admin adminClient) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f81e48021e0978e90abcceee5400a1fe826ca58"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMzMxMDcx", "url": "https://github.com/apache/kafka/pull/9384#pullrequestreview-503331071", "createdAt": "2020-10-06T20:25:54Z", "commit": {"oid": "9f81e48021e0978e90abcceee5400a1fe826ca58"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDoyNTo1NFrOHdYptQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDoyNTo1NFrOHdYptQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3NDY0NQ==", "bodyText": "We need to setup the mocks before calling partitionAssignor.configure() now, as we call taskManager#adminClient() in this method (similar elsewhere)", "url": "https://github.com/apache/kafka/pull/9384#discussion_r500574645", "createdAt": "2020-10-06T20:25:54Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/HighAvailabilityStreamsPartitionAssignorTest.java", "diffHunk": "@@ -131,12 +130,13 @@\n \n     // Make sure to complete setting up any mocks (such as TaskManager or AdminClient) before configuring the assignor\n     private void configurePartitionAssignorWith(final Map<String, Object> props) {\n+        EasyMock.replay(taskManager, adminClient);\n+\n         final Map<String, Object> configMap = configProps();\n         configMap.putAll(props);\n \n         streamsConfig = new StreamsConfig(configMap);\n         partitionAssignor.configure(configMap);\n-        EasyMock.replay(taskManager, adminClient);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f81e48021e0978e90abcceee5400a1fe826ca58"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMzMxNDIz", "url": "https://github.com/apache/kafka/pull/9384#pullrequestreview-503331423", "createdAt": "2020-10-06T20:26:21Z", "commit": {"oid": "9f81e48021e0978e90abcceee5400a1fe826ca58"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDoyNjoyMVrOHdYqrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDoyNjoyMVrOHdYqrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3NDg5NA==", "bodyText": "We need to setup the admin mock before the TM mock now (similar elsewhere)", "url": "https://github.com/apache/kafka/pull/9384#discussion_r500574894", "createdAt": "2020-10-06T20:26:21Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/HighAvailabilityStreamsPartitionAssignorTest.java", "diffHunk": "@@ -203,8 +204,8 @@ public void shouldReturnAllActiveTasksToPreviousOwnerRegardlessOfBalanceAndTrigg\n         builder.addStateStore(new MockKeyValueStoreBuilder(\"store1\", false), \"processor1\");\n         final Set<TaskId> allTasks = mkSet(TASK_0_0, TASK_0_1, TASK_0_2);\n \n-        createMockTaskManager(allTasks);\n         adminClient = EasyMock.createMock(AdminClient.class);\n+        createMockTaskManager(allTasks);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f81e48021e0978e90abcceee5400a1fe826ca58"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "077b8d59f058ae20f5ed5c044a1fe8cc782b504d", "author": {"user": {"login": "mjsax", "name": "Matthias J. Sax"}}, "url": "https://github.com/apache/kafka/commit/077b8d59f058ae20f5ed5c044a1fe8cc782b504d", "committedDate": "2020-10-09T21:40:28Z", "message": "Introduce `ReferenceContainter` to decouple TaskManager from StreamPartitionAssingnor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDA0NDg2", "url": "https://github.com/apache/kafka/pull/9384#pullrequestreview-506004486", "createdAt": "2020-10-09T21:42:32Z", "commit": {"oid": "077b8d59f058ae20f5ed5c044a1fe8cc782b504d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTo0MjozMlrOHfZXGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTo0MjozMlrOHfZXGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MzQxOA==", "bodyText": "Remove unused method", "url": "https://github.com/apache/kafka/pull/9384#discussion_r502683418", "createdAt": "2020-10-09T21:42:32Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -1091,8 +1096,4 @@ ConsumerRebalanceListener rebalanceListener() {\n     Admin adminClient() {\n         return adminClient;\n     }\n-\n-    InternalTopologyBuilder internalTopologyBuilder() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "077b8d59f058ae20f5ed5c044a1fe8cc782b504d"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDA0NzU1", "url": "https://github.com/apache/kafka/pull/9384#pullrequestreview-506004755", "createdAt": "2020-10-09T21:43:21Z", "commit": {"oid": "077b8d59f058ae20f5ed5c044a1fe8cc782b504d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTo0MzoyMVrOHfZX3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTo0MzoyMVrOHfZX3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MzYxNQ==", "bodyText": "we need to keep a reference as we cannot get the mainConsumer at this point, as it will be set after this method finished", "url": "https://github.com/apache/kafka/pull/9384#discussion_r502683615", "createdAt": "2020-10-09T21:43:21Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignor.java", "diffHunk": "@@ -192,12 +191,11 @@ public String toString() {\n      */\n     @Override\n     public void configure(final Map<String, ?> configs) {\n-        final AssignorConfiguration assignorConfiguration = new AssignorConfiguration(configs);\n+        assignorConfiguration = new AssignorConfiguration(configs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "077b8d59f058ae20f5ed5c044a1fe8cc782b504d"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDA0OTE5", "url": "https://github.com/apache/kafka/pull/9384#pullrequestreview-506004919", "createdAt": "2020-10-09T21:43:53Z", "commit": {"oid": "077b8d59f058ae20f5ed5c044a1fe8cc782b504d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTo0Mzo1M1rOHfZYZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTo0Mzo1M1rOHfZYZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4Mzc0OQ==", "bodyText": "Only used at a single place, just removing the variable.", "url": "https://github.com/apache/kafka/pull/9384#discussion_r502683749", "createdAt": "2020-10-09T21:43:53Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignor.java", "diffHunk": "@@ -206,7 +204,6 @@ public void configure(final Map<String, ?> configs) {\n         assignmentConfigs = assignorConfiguration.assignmentConfigs();\n         partitionGrouper = assignorConfiguration.partitionGrouper();\n         userEndPoint = assignorConfiguration.userEndPoint();\n-        adminClient = assignorConfiguration.adminClient();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "077b8d59f058ae20f5ed5c044a1fe8cc782b504d"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDA1MTE4", "url": "https://github.com/apache/kafka/pull/9384#pullrequestreview-506005118", "createdAt": "2020-10-09T21:44:35Z", "commit": {"oid": "077b8d59f058ae20f5ed5c044a1fe8cc782b504d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTo0NDozNVrOHfZY9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTo0NDozNVrOHfZY9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4Mzg5Mw==", "bodyText": "Decouple TM from StreamPartitionAssignor now and not \"miss-use\" it to get the consumer any longer.", "url": "https://github.com/apache/kafka/pull/9384#discussion_r502683893", "createdAt": "2020-10-09T21:44:35Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -120,10 +120,6 @@ void setMainConsumer(final Consumer<byte[], byte[]> mainConsumer) {\n         this.mainConsumer = mainConsumer;\n     }\n \n-    Consumer<byte[], byte[]> mainConsumer() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "077b8d59f058ae20f5ed5c044a1fe8cc782b504d"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a18b74975f5e45f6f446ff4f35c4e9fc2672f3da", "author": {"user": {"login": "mjsax", "name": "Matthias J. Sax"}}, "url": "https://github.com/apache/kafka/commit/a18b74975f5e45f6f446ff4f35c4e9fc2672f3da", "committedDate": "2020-10-09T21:51:54Z", "message": "Revert unnecessary changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3Njc3ODc5", "url": "https://github.com/apache/kafka/pull/9384#pullrequestreview-507677879", "createdAt": "2020-10-13T17:34:16Z", "commit": {"oid": "a18b74975f5e45f6f446ff4f35c4e9fc2672f3da"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNzozNDoxNlrOHgyEHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNzo0Mjo0NlrOHgyWJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzNjczNQ==", "bodyText": "Should these be in the reference container as well?", "url": "https://github.com/apache/kafka/pull/9384#discussion_r504136735", "createdAt": "2020-10-13T17:34:16Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/StreamsConfig.java", "diffHunk": "@@ -900,9 +900,7 @@\n \n         // These are not settable in the main Streams config; they are set by the StreamThread to pass internal\n         // state into the assignor.\n-        public static final String TASK_MANAGER_FOR_PARTITION_ASSIGNOR = \"__task.manager.instance__\";\n-        public static final String STREAMS_METADATA_STATE_FOR_PARTITION_ASSIGNOR = \"__streams.metadata.state.instance__\";\n-        public static final String STREAMS_ADMIN_CLIENT = \"__streams.admin.client.instance__\";\n+        public static final String REFERENCE_CONTAINER_PARTITION_ASSIGNOR = \"__reference.container.instance__\";\n         public static final String ASSIGNMENT_ERROR_CODE = \"__assignment.error.code__\";\n         public static final String NEXT_SCHEDULED_REBALANCE_MS = \"__next.probing.rebalance.ms__\";\n         public static final String TIME = \"__time__\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a18b74975f5e45f6f446ff4f35c4e9fc2672f3da"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzNzU1Mg==", "bodyText": "Thanks!", "url": "https://github.com/apache/kafka/pull/9384#discussion_r504137552", "createdAt": "2020-10-13T17:35:49Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -1091,8 +1096,4 @@ ConsumerRebalanceListener rebalanceListener() {\n     Admin adminClient() {\n         return adminClient;\n     }\n-\n-    InternalTopologyBuilder internalTopologyBuilder() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MzQxOA=="}, "originalCommit": {"oid": "077b8d59f058ae20f5ed5c044a1fe8cc782b504d"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzODM5OQ==", "bodyText": "Thanks!", "url": "https://github.com/apache/kafka/pull/9384#discussion_r504138399", "createdAt": "2020-10-13T17:37:19Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -120,10 +120,6 @@ void setMainConsumer(final Consumer<byte[], byte[]> mainConsumer) {\n         this.mainConsumer = mainConsumer;\n     }\n \n-    Consumer<byte[], byte[]> mainConsumer() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4Mzg5Mw=="}, "originalCommit": {"oid": "077b8d59f058ae20f5ed5c044a1fe8cc782b504d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0MTM1MA==", "bodyText": "Thanks. Should we instead make referenceContainer a field and access its members to get the references? The purpose of AssignorConfiguration is to parse the configs, not to be a general container for the configured values. Otherwise, we wouldn't need to assign any of the other fields here.", "url": "https://github.com/apache/kafka/pull/9384#discussion_r504141350", "createdAt": "2020-10-13T17:42:46Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignor.java", "diffHunk": "@@ -192,12 +191,11 @@ public String toString() {\n      */\n     @Override\n     public void configure(final Map<String, ?> configs) {\n-        final AssignorConfiguration assignorConfiguration = new AssignorConfiguration(configs);\n+        assignorConfiguration = new AssignorConfiguration(configs);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MzYxNQ=="}, "originalCommit": {"oid": "077b8d59f058ae20f5ed5c044a1fe8cc782b504d"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59a921654808daad6c0e458a6369d5c6ec094297", "author": {"user": {"login": "mjsax", "name": "Matthias J. Sax"}}, "url": "https://github.com/apache/kafka/commit/59a921654808daad6c0e458a6369d5c6ec094297", "committedDate": "2020-10-13T19:31:17Z", "message": "Github comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21630d29afeb8f9789b35be96c1f110dba4b01c5", "author": {"user": {"login": "mjsax", "name": "Matthias J. Sax"}}, "url": "https://github.com/apache/kafka/commit/21630d29afeb8f9789b35be96c1f110dba4b01c5", "committedDate": "2020-10-14T21:46:55Z", "message": "Github comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9b79e0b29ddbdb4d06f992eaf9036bd5756ff5a", "author": {"user": {"login": "mjsax", "name": "Matthias J. Sax"}}, "url": "https://github.com/apache/kafka/commit/b9b79e0b29ddbdb4d06f992eaf9036bd5756ff5a", "committedDate": "2020-10-14T22:41:48Z", "message": "More cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODIxOTU5", "url": "https://github.com/apache/kafka/pull/9384#pullrequestreview-508821959", "createdAt": "2020-10-14T22:43:13Z", "commit": {"oid": "b9b79e0b29ddbdb4d06f992eaf9036bd5756ff5a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 460, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}