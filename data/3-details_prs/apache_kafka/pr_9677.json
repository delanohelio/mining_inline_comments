{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMjQ2ODcz", "number": 9677, "title": "KAFKA-10799 AlterIsr utilizes ReplicaManager ISR metrics", "bodyText": "In #9100, we missed the inclusion of the high level ISR shrink/expand metrics that are managed by ReplicaManager. This PR adds a small abstraction that allows us to mark these metrics without bringing ReplicaManager in as a dependency of Partition.", "createdAt": "2020-12-02T19:40:28Z", "url": "https://github.com/apache/kafka/pull/9677", "merged": true, "mergeCommit": {"oid": "633f7cff190385a693486ddb88eaf5e84b3c13ed"}, "closed": true, "closedAt": "2020-12-03T21:11:08Z", "author": {"login": "mumrah"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiTYdDAH2gAyNTMxMjQ2ODczOjA0MzQxODcxZGY4YTFhMDUwZGVhMzQ0Njc2ZGI4YzY5NjI0OTEyOGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdinsvzAH2gAyNTMxMjQ2ODczOjdiNjg2YmRlOWRjOGVlNTZkNDc1OGFjYTU3OGU2NWFkZDk2ZGE4YjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "04341871df8a1a050dea344676db8c696249128c", "author": {"user": {"login": "mumrah", "name": "David Arthur"}}, "url": "https://github.com/apache/kafka/commit/04341871df8a1a050dea344676db8c696249128c", "committedDate": "2020-12-02T19:05:34Z", "message": "Create small abstraction for marking ISR changes.\n\nThis allows us to update the ISR metrics in ReplicaManager without introducing it\nas a dependency to Partition.\n\nAlso, this change includes updating these metrics for ISR changes done through\nAlterIsr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d5e37926af224dce7f41b922da39ea82de365c2", "author": {"user": {"login": "mumrah", "name": "David Arthur"}}, "url": "https://github.com/apache/kafka/commit/7d5e37926af224dce7f41b922da39ea82de365c2", "committedDate": "2020-12-02T19:30:01Z", "message": "Add supporting test code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0851036daa7782ee00c30885707798fa3a4ba2d", "author": {"user": {"login": "mumrah", "name": "David Arthur"}}, "url": "https://github.com/apache/kafka/commit/f0851036daa7782ee00c30885707798fa3a4ba2d", "committedDate": "2020-12-02T20:04:43Z", "message": "fix exhaustive match"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMjM2MTg0", "url": "https://github.com/apache/kafka/pull/9677#pullrequestreview-543236184", "createdAt": "2020-12-02T21:05:37Z", "commit": {"oid": "f0851036daa7782ee00c30885707798fa3a4ba2d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMTowNTozN1rOH9uHyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMTowNTo1M1rOH9uIYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ4MDg0Mg==", "bodyText": "Maybe we can move this out of ZkPartitionStateStore since we need the dependence on IsrChangeListener in Partition anyway.", "url": "https://github.com/apache/kafka/pull/9677#discussion_r534480842", "createdAt": "2020-12-02T21:05:37Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -53,7 +59,7 @@ trait PartitionStateStore {\n \n class ZkPartitionStateStore(topicPartition: TopicPartition,\n                             zkClient: KafkaZkClient,\n-                            replicaManager: ReplicaManager) extends PartitionStateStore {\n+                            isrChangeListener: IsrChangeListener) extends PartitionStateStore {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0851036daa7782ee00c30885707798fa3a4ba2d"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ4MDk5NA==", "bodyText": "Maybe IsrChangeMetrics?", "url": "https://github.com/apache/kafka/pull/9677#discussion_r534480994", "createdAt": "2020-12-02T21:05:53Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -45,6 +45,12 @@ import org.apache.kafka.common.{IsolationLevel, TopicPartition}\n import scala.collection.{Map, Seq}\n import scala.jdk.CollectionConverters._\n \n+trait IsrChangeListener {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0851036daa7782ee00c30885707798fa3a4ba2d"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdb23eb5d73b5928a5bbdc8fff7300ff27706199", "author": {"user": {"login": "mumrah", "name": "David Arthur"}}, "url": "https://github.com/apache/kafka/commit/fdb23eb5d73b5928a5bbdc8fff7300ff27706199", "committedDate": "2020-12-02T21:59:30Z", "message": "PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMjg0MjUz", "url": "https://github.com/apache/kafka/pull/9677#pullrequestreview-543284253", "createdAt": "2020-12-02T22:17:52Z", "commit": {"oid": "fdb23eb5d73b5928a5bbdc8fff7300ff27706199"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjoxNzo1M1rOH9weJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjoxNzo1M1rOH9weJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUxOTMzNQ==", "bodyText": "Hmm.. I had forgotten about this. The purpose of this call is so that we can propagate the ISR change to the controller, but we shouldn't need to do this down the AlterIsr path. This also makes your initial name IsrChangeListener a bit more accurate \ud83d\ude05 .", "url": "https://github.com/apache/kafka/pull/9677#discussion_r534519335", "createdAt": "2020-12-02T22:17:53Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -107,10 +106,24 @@ object Partition extends KafkaMetricsGroup {\n   def apply(topicPartition: TopicPartition,\n             time: Time,\n             replicaManager: ReplicaManager): Partition = {\n+\n+    val isrChangeMetrics = new IsrChangeMetrics {\n+      override def markExpand(): Unit = {\n+        replicaManager.recordIsrChange(topicPartition)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdb23eb5d73b5928a5bbdc8fff7300ff27706199"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "160f8e0e3035c48a94bbac3fd9a44094678aecf3", "author": {"user": {"login": "mumrah", "name": "David Arthur"}}, "url": "https://github.com/apache/kafka/commit/160f8e0e3035c48a94bbac3fd9a44094678aecf3", "committedDate": "2020-12-02T23:09:19Z", "message": "Don't update the isrChangeSet when using AlterIsr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f44ebed0116e8dae95c331a0475db129d4e4c60", "author": {"user": {"login": "mumrah", "name": "David Arthur"}}, "url": "https://github.com/apache/kafka/commit/8f44ebed0116e8dae95c331a0475db129d4e4c60", "committedDate": "2020-12-02T23:14:25Z", "message": "Revert renaming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzE3NzAx", "url": "https://github.com/apache/kafka/pull/9677#pullrequestreview-543317701", "createdAt": "2020-12-02T23:15:55Z", "commit": {"oid": "fdb23eb5d73b5928a5bbdc8fff7300ff27706199"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMzoxNTo1NVrOH9yLuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMzoxNTo1NVrOH9yLuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU0NzM4NQ==", "bodyText": "Note that I'm not including the markFailed call here. Think we should include it here? Or possibly introduce a new retry metric?", "url": "https://github.com/apache/kafka/pull/9677#discussion_r534547385", "createdAt": "2020-12-02T23:15:55Z", "author": {"login": "mumrah"}, "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -1406,10 +1429,13 @@ class Partition(val topicPartition: TopicPartition,\n         case Left(error: Errors) => error match {\n           case Errors.UNKNOWN_TOPIC_OR_PARTITION =>\n             debug(s\"Controller failed to update ISR to $proposedIsrState since it doesn't know about this topic or partition. Giving up.\")\n+            isrChangeMetrics.markFailed()\n           case Errors.FENCED_LEADER_EPOCH =>\n             debug(s\"Controller failed to update ISR to $proposedIsrState since we sent an old leader epoch. Giving up.\")\n+            isrChangeMetrics.markFailed()\n           case Errors.INVALID_UPDATE_VERSION =>\n             debug(s\"Controller failed to update ISR to $proposedIsrState due to invalid zk version. Giving up.\")\n+            isrChangeMetrics.markFailed()\n           case _ =>\n             warn(s\"Controller failed to update ISR to $proposedIsrState due to unexpected $error. Retrying.\")\n             sendAlterIsrRequest(proposedIsrState)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdb23eb5d73b5928a5bbdc8fff7300ff27706199"}, "originalPosition": 142}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzQ1MDYx", "url": "https://github.com/apache/kafka/pull/9677#pullrequestreview-543345061", "createdAt": "2020-12-03T00:20:18Z", "commit": {"oid": "8f44ebed0116e8dae95c331a0475db129d4e4c60"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48ca2bb4844778ce4fc464612397a543303370d5", "author": {"user": {"login": "mumrah", "name": "David Arthur"}}, "url": "https://github.com/apache/kafka/commit/48ca2bb4844778ce4fc464612397a543303370d5", "committedDate": "2020-12-03T13:04:14Z", "message": "Mark the ISR failure meter on retries as well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cca3cc2ce607fa5a2e6ebb27e1903fd208fbc2a", "author": {"user": {"login": "mumrah", "name": "David Arthur"}}, "url": "https://github.com/apache/kafka/commit/7cca3cc2ce607fa5a2e6ebb27e1903fd208fbc2a", "committedDate": "2020-12-03T15:53:49Z", "message": "Should be IV2, not IV1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07700bc5071a01490173c84f5fdc6f55a1c6e515", "author": {"user": {"login": "mumrah", "name": "David Arthur"}}, "url": "https://github.com/apache/kafka/commit/07700bc5071a01490173c84f5fdc6f55a1c6e515", "committedDate": "2020-12-03T17:06:58Z", "message": "unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MjIzODAx", "url": "https://github.com/apache/kafka/pull/9677#pullrequestreview-544223801", "createdAt": "2020-12-03T17:51:10Z", "commit": {"oid": "07700bc5071a01490173c84f5fdc6f55a1c6e515"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNzo1MToxMFrOH-paXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNzo1MToxMFrOH-paXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ1MjI1Mg==", "bodyText": "nit: now the block below is misaligned", "url": "https://github.com/apache/kafka/pull/9677#discussion_r535452252", "createdAt": "2020-12-03T17:51:10Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -1403,7 +1426,9 @@ class Partition(val topicPartition: TopicPartition,\n       }\n \n       result match {\n-        case Left(error: Errors) => error match {\n+        case Left(error: Errors) =>\n+          isrChangeListener.markFailed()\n+          error match {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07700bc5071a01490173c84f5fdc6f55a1c6e515"}, "originalPosition": 154}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MjI4MDkw", "url": "https://github.com/apache/kafka/pull/9677#pullrequestreview-544228090", "createdAt": "2020-12-03T17:56:09Z", "commit": {"oid": "07700bc5071a01490173c84f5fdc6f55a1c6e515"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1b14919f54e3848890b4421135659446e6e2bbb", "author": {"user": {"login": "mumrah", "name": "David Arthur"}}, "url": "https://github.com/apache/kafka/commit/a1b14919f54e3848890b4421135659446e6e2bbb", "committedDate": "2020-12-03T18:00:28Z", "message": "Fix indentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b686bde9dc8ee56d4758aca578e65add96da8b5", "author": {"user": {"login": "mumrah", "name": "David Arthur"}}, "url": "https://github.com/apache/kafka/commit/7b686bde9dc8ee56d4758aca578e65add96da8b5", "committedDate": "2020-12-03T18:45:50Z", "message": "Indent paren"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2521, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}