{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzMjk1OTky", "number": 8974, "title": "KAFKA-10225 Increase default zk session timeout for system tests", "bodyText": "I'm digging in the flaky system tests and then I noticed there are many flaky caused by following check.\n        with node.account.monitor_log(KafkaService.STDOUT_STDERR_CAPTURE) as monitor:\n            node.account.ssh(cmd)\n            # Kafka 1.0.0 and higher don't have a space between \"Kafka\" and \"Server\"\n            monitor.wait_until(\"Kafka\\s*Server.*started\", timeout_sec=timeout_sec, backoff_sec=.25,\n                               err_msg=\"Kafka server didn't finish startup in %d seconds\" % timeout_sec)\nAnd the error message in broker log is shown below.\nkafka.zookeeper.ZooKeeperClientTimeoutException: Timed out waiting for connection while in state: CONNECTING\n\tat kafka.zookeeper.ZooKeeperClient.waitUntilConnected(ZooKeeperClient.scala:262)\n\tat kafka.zookeeper.ZooKeeperClient.<init>(ZooKeeperClient.scala:119)\n\tat kafka.zk.KafkaZkClient$.apply(KafkaZkClient.scala:1880)\n\tat kafka.server.KafkaServer.createZkClient$1(KafkaServer.scala:430)\n\tat kafka.server.KafkaServer.initZkClient(KafkaServer.scala:455)\n\tat kafka.server.KafkaServer.startup(KafkaServer.scala:227)\n\tat kafka.server.KafkaServerStartable.startup(KafkaServerStartable.scala:44)\n\tat kafka.Kafka$.main(Kafka.scala:82)\n\tat kafka.Kafka.main(Kafka.scala)\n\nI'm surprised the default timeout of zk connection in system test is only 2 seconds as the default timeout in production is increased to 18s (see 4bde9bb)\nconfig_property.ZOOKEEPER_CONNECTION_TIMEOUT_MS: 2000\n\nissue: https://issues.apache.org/jira/browse/KAFKA-10225\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-07-02T06:06:22Z", "url": "https://github.com/apache/kafka/pull/8974", "merged": true, "mergeCommit": {"oid": "80cab851ee9626880516486ad60d661f9c82e6d2"}, "closed": true, "closedAt": "2020-07-08T20:19:41Z", "author": {"login": "chia7712"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcw4i5jgFqTQ0MTM3MzM3Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABczAUMygFqTQ0NTA5ODM0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMzczMzc3", "url": "https://github.com/apache/kafka/pull/8974#pullrequestreview-441373377", "createdAt": "2020-07-02T06:07:15Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNjowNzoxNVrOGr-oEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNjowNzoxNVrOGr-oEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc2ODAxOQ==", "bodyText": "make it equal to https://github.com/apache/kafka/blob/trunk/config/server.properties#L126", "url": "https://github.com/apache/kafka/pull/8974#discussion_r448768019", "createdAt": "2020-07-02T06:07:15Z", "author": {"login": "chia7712"}, "path": "tests/kafkatest/services/kafka/config.py", "diffHunk": "@@ -25,7 +25,7 @@ class KafkaConfig(dict):\n         config_property.PORT: 9092,\n         config_property.SOCKET_RECEIVE_BUFFER_BYTES: 65536,\n         config_property.LOG_DIRS: \"/mnt/kafka/kafka-data-logs-1,/mnt/kafka/kafka-data-logs-2\",\n-        config_property.ZOOKEEPER_CONNECTION_TIMEOUT_MS: 2000\n+        config_property.ZOOKEEPER_CONNECTION_TIMEOUT_MS: 18000", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjg1NTQw", "url": "https://github.com/apache/kafka/pull/8974#pullrequestreview-442685540", "createdAt": "2020-07-05T15:15:19Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxNToxNToxOVrOGtDBFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxNToxNToxOVrOGtDBFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg4ODUzMg==", "bodyText": "This is another bug that we don't honor the timeout parameters assigned to KafkaService", "url": "https://github.com/apache/kafka/pull/8974#discussion_r449888532", "createdAt": "2020-07-05T15:15:19Z", "author": {"login": "chia7712"}, "path": "tests/kafkatest/services/kafka/kafka.py", "diffHunk": "@@ -185,7 +185,11 @@ def __init__(self, context, num_nodes, zk, security_protocol=SecurityConfig.PLAI\n \n         for node in self.nodes:\n             node.version = version\n-            node.config = KafkaConfig(**{config_property.BROKER_ID: self.idx(node)})\n+            node.config = KafkaConfig(**{\n+                config_property.BROKER_ID: self.idx(node),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMzMxNjQ5", "url": "https://github.com/apache/kafka/pull/8974#pullrequestreview-443331649", "createdAt": "2020-07-06T18:56:35Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxODo1NjozNlrOGtja1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxODo1NzozOFrOGtjc0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQxOTQxNQ==", "bodyText": "The default ZK session timeout and ZK connection timeout are both 18 secs. So we can just change both to 18secs here.", "url": "https://github.com/apache/kafka/pull/8974#discussion_r450419415", "createdAt": "2020-07-06T18:56:36Z", "author": {"login": "junrao"}, "path": "tests/kafkatest/services/kafka/config.py", "diffHunk": "@@ -25,7 +25,8 @@ class KafkaConfig(dict):\n         config_property.PORT: 9092,\n         config_property.SOCKET_RECEIVE_BUFFER_BYTES: 65536,\n         config_property.LOG_DIRS: \"/mnt/kafka/kafka-data-logs-1,/mnt/kafka/kafka-data-logs-2\",\n-        config_property.ZOOKEEPER_CONNECTION_TIMEOUT_MS: 2000\n+        config_property.ZOOKEEPER_CONNECTION_TIMEOUT_MS: 5000,\n+        config_property.ZOOKEEPER_SESSION_TIMEOUT_MS: 6000", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQxOTkyMg==", "bodyText": "Could we change the default ZK session timeout and ZK connection timeout in line 101 to 18 secs too?", "url": "https://github.com/apache/kafka/pull/8974#discussion_r450419922", "createdAt": "2020-07-06T18:57:38Z", "author": {"login": "junrao"}, "path": "tests/kafkatest/services/kafka/kafka.py", "diffHunk": "@@ -185,7 +185,11 @@ def __init__(self, context, num_nodes, zk, security_protocol=SecurityConfig.PLAI\n \n         for node in self.nodes:\n             node.version = version\n-            node.config = KafkaConfig(**{config_property.BROKER_ID: self.idx(node)})\n+            node.config = KafkaConfig(**{\n+                config_property.BROKER_ID: self.idx(node),\n+                config_property.ZOOKEEPER_CONNECTION_TIMEOUT_MS: zk_connect_timeout,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c8b0caae620bb28ae423d9720bad006325b8d18", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/5c8b0caae620bb28ae423d9720bad006325b8d18", "committedDate": "2020-07-07T01:24:23Z", "message": "KAFKA-10225 Increase default zk session timeout for system tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca052ea3f97b28adc5aa03f5518417df100004ae", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/ca052ea3f97b28adc5aa03f5518417df100004ae", "committedDate": "2020-07-07T01:24:23Z", "message": "KAFKA-10225 honor the timeout assigned to KafkaService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da92657604e1e6c3145127ba41df348e435ca383", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/da92657604e1e6c3145127ba41df348e435ca383", "committedDate": "2020-07-07T01:25:50Z", "message": "KAFKA-10225 consistent timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "da92657604e1e6c3145127ba41df348e435ca383", "author": {"user": {"login": "chia7712", "name": "Chia-Ping Tsai"}}, "url": "https://github.com/apache/kafka/commit/da92657604e1e6c3145127ba41df348e435ca383", "committedDate": "2020-07-07T01:25:50Z", "message": "KAFKA-10225 consistent timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0Mjc3MTc2", "url": "https://github.com/apache/kafka/pull/8974#pullrequestreview-444277176", "createdAt": "2020-07-07T21:54:19Z", "commit": {"oid": "da92657604e1e6c3145127ba41df348e435ca383"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDk4MzQ4", "url": "https://github.com/apache/kafka/pull/8974#pullrequestreview-445098348", "createdAt": "2020-07-08T20:18:17Z", "commit": {"oid": "da92657604e1e6c3145127ba41df348e435ca383"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1140, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}