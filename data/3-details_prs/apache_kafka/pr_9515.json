{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExMjAwNDI0", "number": 9515, "title": "KAFKA-10651: read  offsets directly from checkpoint for uninitialized tasks", "bodyText": "Uninitialized tasks just return an empty collection in changelogOffsets() and are indistinguishable from genuinely stateless (or un-logged) tasks. We should just skip over these tasks and read directly from the checkpoint file when computing offset sums for a JoinGroup subscription", "createdAt": "2020-10-28T00:44:51Z", "url": "https://github.com/apache/kafka/pull/9515", "merged": true, "mergeCommit": {"oid": "c75fd668751e7852f151661976bfaaae807d1cfe"}, "closed": true, "closedAt": "2020-10-30T20:36:36Z", "author": {"login": "ableegoldman"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWysmKAFqTUxODI1MDE3Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXqOsEgFqTUyMDg4NjA3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MjUwMTcz", "url": "https://github.com/apache/kafka/pull/9515#pullrequestreview-518250173", "createdAt": "2020-10-28T00:47:31Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwMDo0NzozMVrOHpWDXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwMDo0NzozMVrOHpWDXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzExNDk3Mg==", "bodyText": "Nothing really changed here, but we use to just leave tasks in CREATED and call them \"restoring\" so I had to fix this up so they really were RESTORING", "url": "https://github.com/apache/kafka/pull/9515#discussion_r513114972", "createdAt": "2020-10-28T00:47:31Z", "author": {"login": "ableegoldman"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/TaskManagerTest.java", "diffHunk": "@@ -2479,7 +2502,7 @@ public void shouldTransmitProducerMetrics() {\n             allTasks.put(task.id(), (StateMachineTask) task);\n         }\n         for (final Task task : restoringTasks) {\n-            assertThat(task.state(), not(Task.State.RUNNING));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 83}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NDYxOTE2", "url": "https://github.com/apache/kafka/pull/9515#pullrequestreview-518461916", "createdAt": "2020-10-28T09:22:41Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOToyMjo0MVrOHpgytw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOToyMjo0MVrOHpgytw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5MDkzNQ==", "bodyText": "Are there also other task states, we need to consider here except CREATED? What about CLOSED or SUSPENDED?", "url": "https://github.com/apache/kafka/pull/9515#discussion_r513290935", "createdAt": "2020-10-28T09:22:41Z", "author": {"login": "cadonna"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -671,7 +672,7 @@ void handleLostAll() {\n         // just have an empty changelogOffsets map.\n         for (final TaskId id : union(HashSet::new, lockedTaskDirectories, tasks.keySet())) {\n             final Task task = tasks.get(id);\n-            if (task != null) {\n+            if (task != null && task.state() != State.CREATED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f21ab961475a4942033241808cad6702469dfe4", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/8f21ab961475a4942033241808cad6702469dfe4", "committedDate": "2020-10-30T02:43:13Z", "message": "read  offsets directly from checkpoint for uninitialized tasks, add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8921f1805f67f9cc345a750fac404ebbee1b370a", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/8921f1805f67f9cc345a750fac404ebbee1b370a", "committedDate": "2020-10-30T02:43:13Z", "message": "skip based on task state, refactor tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f98b1714e66d6cc6625538b0c529a68903be1a7", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/0f98b1714e66d6cc6625538b0c529a68903be1a7", "committedDate": "2020-10-30T02:43:13Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "863be2c009811812d212fd15c6ffd4d2fdc4fe95", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/863be2c009811812d212fd15c6ffd4d2fdc4fe95", "committedDate": "2020-10-30T02:43:13Z", "message": "read from checkpoint when CLOSED"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNzE3MDY0", "url": "https://github.com/apache/kafka/pull/9515#pullrequestreview-520717064", "createdAt": "2020-10-30T14:23:52Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNDoyMzo1MlrOHrRVsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNDoyMzo1MlrOHrRVsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzNDg5Ng==", "bodyText": "A unit test for the CLOSED case is missing.", "url": "https://github.com/apache/kafka/pull/9515#discussion_r515134896", "createdAt": "2020-10-30T14:23:52Z", "author": {"login": "cadonna"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -671,7 +672,8 @@ void handleLostAll() {\n         // just have an empty changelogOffsets map.\n         for (final TaskId id : union(HashSet::new, lockedTaskDirectories, tasks.keySet())) {\n             final Task task = tasks.get(id);\n-            if (task != null) {\n+            // Closed and uninitialized tasks don't have any offsets so we should read directly from the checkpoint\n+            if (task != null && task.state() != State.CREATED && task.state() != State.CLOSED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06f4430a6c3299c83fe043f3010273e6f20da78f", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/06f4430a6c3299c83fe043f3010273e6f20da78f", "committedDate": "2020-10-30T17:04:20Z", "message": "add unit test for CLOSED"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "06f4430a6c3299c83fe043f3010273e6f20da78f", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/06f4430a6c3299c83fe043f3010273e6f20da78f", "committedDate": "2020-10-30T17:04:20Z", "message": "add unit test for CLOSED"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwODg2MDc0", "url": "https://github.com/apache/kafka/pull/9515#pullrequestreview-520886074", "createdAt": "2020-10-30T17:29:33Z", "commit": {"oid": "06f4430a6c3299c83fe043f3010273e6f20da78f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2896, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}