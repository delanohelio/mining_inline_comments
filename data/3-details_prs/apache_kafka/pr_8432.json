{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5NjkzMTE0", "number": 8432, "title": "MINOR: Fix KafkaApis.filterAuthorized", "bodyText": "90bbeed introduced a regression resulting in passing an action per resource name to the Authorizer instead of passing one per unique resource name. This PR refactors the signatures of both filterAuthorized and authorize to make them easier to test and adds a test for each.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-04-06T14:38:29Z", "url": "https://github.com/apache/kafka/pull/8432", "merged": true, "mergeCommit": {"oid": "cd1e46c8bb46f1e5303c51f476c74e33b522fce8"}, "closed": true, "closedAt": "2020-04-07T13:26:19Z", "author": {"login": "dajac"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcU_7oNgFqTM4ODMyNDY5Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVBok3gFqTM4ODQzODE4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MzI0Njk2", "url": "https://github.com/apache/kafka/pull/8432#pullrequestreview-388324696", "createdAt": "2020-04-06T14:47:37Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDo0NzozN1rOGBbY5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDo0NzozN1rOGBbY5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE1MDUwMg==", "bodyText": "The ordering is relevant (see the zip call below) and we lose it with this change. Did the tests pass with this change? If so, maybe we need to add more tests as they should not.\nSeems like the easiest fix may be to call resourceNames.distinct before using it anywhere else.", "url": "https://github.com/apache/kafka/pull/8432#discussion_r404150502", "createdAt": "2020-04-06T14:47:37Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -2868,35 +2876,36 @@ class KafkaApis(val requestChannel: RequestChannel,\n     }\n   }\n \n-  private def authorize(request: RequestChannel.Request,\n-                        operation: AclOperation,\n-                        resourceType: ResourceType,\n-                        resourceName: String,\n-                        logIfAllowed: Boolean = true,\n-                        logIfDenied: Boolean = true,\n-                        refCount: Int = 1): Boolean = {\n+  // private package for testing\n+  private[server] def authorize(requestContext: RequestContext,\n+                                operation: AclOperation,\n+                                resourceType: ResourceType,\n+                                resourceName: String,\n+                                logIfAllowed: Boolean = true,\n+                                logIfDenied: Boolean = true,\n+                                refCount: Int = 1): Boolean = {\n     authorizer.forall { authZ =>\n       val resource = new ResourcePattern(resourceType, resourceName, PatternType.LITERAL)\n       val actions = Collections.singletonList(new Action(operation, resource, refCount, logIfAllowed, logIfDenied))\n-      authZ.authorize(request.context, actions).asScala.head == AuthorizationResult.ALLOWED\n+      authZ.authorize(requestContext, actions).asScala.head == AuthorizationResult.ALLOWED\n     }\n   }\n \n-  private def filterAuthorized(request: RequestChannel.Request,\n-                               operation: AclOperation,\n-                               resourceType: ResourceType,\n-                               resourceNames: Seq[String],\n-                               logIfAllowed: Boolean = true,\n-                               logIfDenied: Boolean = true): Set[String] = {\n+  // private package for testing\n+  private[server] def filterAuthorized(requestContext: RequestContext,\n+                                       operation: AclOperation,\n+                                       resourceType: ResourceType,\n+                                       resourceNames: Seq[String],\n+                                       logIfAllowed: Boolean = true,\n+                                       logIfDenied: Boolean = true): Set[String] = {\n     authorizer match {\n       case Some(authZ) =>\n         val groupedResourceNames = resourceNames.groupBy(identity)\n-        val actions = resourceNames.map { resourceName =>\n-          val count = groupedResourceNames(resourceName).size\n+        val actions = groupedResourceNames.map { case (resourceName, groupedNames) =>", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 493}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b16a898db41a015717079bec0aacc4dedb14df0", "author": {"user": {"login": "dajac", "name": "David Jacot"}}, "url": "https://github.com/apache/kafka/commit/8b16a898db41a015717079bec0aacc4dedb14df0", "committedDate": "2020-04-06T15:11:57Z", "message": "MINOR: Fix KafkaApis.filterAuthorized\n\nhttps://github.com/apache/kafka/commit/90bbeedf52f4b6a411e9630dd132583afa4cd428 introduced a regression resulting in passing an action per ressournce name to the Authorizer instead of passing one per unique resource name. This PR refactors the signatures of both `filterAuthorized` and `authorize` to make them easier to test and adds a test for each."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "8b16a898db41a015717079bec0aacc4dedb14df0", "author": {"user": {"login": "dajac", "name": "David Jacot"}}, "url": "https://github.com/apache/kafka/commit/8b16a898db41a015717079bec0aacc4dedb14df0", "committedDate": "2020-04-06T15:11:57Z", "message": "MINOR: Fix KafkaApis.filterAuthorized\n\nhttps://github.com/apache/kafka/commit/90bbeedf52f4b6a411e9630dd132583afa4cd428 introduced a regression resulting in passing an action per ressournce name to the Authorizer instead of passing one per unique resource name. This PR refactors the signatures of both `filterAuthorized` and `authorize` to make them easier to test and adds a test for each."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NDAyMTM2", "url": "https://github.com/apache/kafka/pull/8432#pullrequestreview-388402136", "createdAt": "2020-04-06T16:09:10Z", "commit": {"oid": "8b16a898db41a015717079bec0aacc4dedb14df0"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNjowOToxMVrOGBfLJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNjoxMjo1N1rOGBfVpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxMjUxOQ==", "bodyText": "Nit: I would move this to the next line, it's a bit hard to read with if/else misaligned.", "url": "https://github.com/apache/kafka/pull/8432#discussion_r404212519", "createdAt": "2020-04-06T16:09:11Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -1673,11 +1678,13 @@ class KafkaApis(val requestChannel: RequestChannel,\n       createTopicsRequest.data.topics.asScala.foreach { topic =>\n         results.add(new CreatableTopicResult().setName(topic.name))\n       }\n-      val hasClusterAuthorization = authorize(request, CREATE, CLUSTER, CLUSTER_NAME, logIfDenied = false)\n+      val hasClusterAuthorization = authorize(request.context, CREATE, CLUSTER, CLUSTER_NAME,\n+        logIfDenied = false)\n       val topics = createTopicsRequest.data.topics.asScala.map(_.name)\n-      val authorizedTopics = if (hasClusterAuthorization) topics.toSet else filterAuthorized(request, CREATE, TOPIC, topics.toSeq)\n-      val authorizedForDescribeConfigs = filterAuthorized(request, DESCRIBE_CONFIGS, TOPIC, topics.toSeq, logIfDenied = false)\n-        .map(name => name -> results.find(name)).toMap\n+      val authorizedTopics = if (hasClusterAuthorization) topics.toSet", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b16a898db41a015717079bec0aacc4dedb14df0"}, "originalPosition": 226}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNDM5MA==", "bodyText": "We can replace the next line by uniqueResourceNames.toSet? Doesn't change the behavior, but slightly better performance if there were indeed duplicates.", "url": "https://github.com/apache/kafka/pull/8432#discussion_r404214390", "createdAt": "2020-04-06T16:11:51Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -2868,36 +2876,39 @@ class KafkaApis(val requestChannel: RequestChannel,\n     }\n   }\n \n-  private def authorize(request: RequestChannel.Request,\n-                        operation: AclOperation,\n-                        resourceType: ResourceType,\n-                        resourceName: String,\n-                        logIfAllowed: Boolean = true,\n-                        logIfDenied: Boolean = true,\n-                        refCount: Int = 1): Boolean = {\n+  // private package for testing\n+  private[server] def authorize(requestContext: RequestContext,\n+                                operation: AclOperation,\n+                                resourceType: ResourceType,\n+                                resourceName: String,\n+                                logIfAllowed: Boolean = true,\n+                                logIfDenied: Boolean = true,\n+                                refCount: Int = 1): Boolean = {\n     authorizer.forall { authZ =>\n       val resource = new ResourcePattern(resourceType, resourceName, PatternType.LITERAL)\n       val actions = Collections.singletonList(new Action(operation, resource, refCount, logIfAllowed, logIfDenied))\n-      authZ.authorize(request.context, actions).asScala.head == AuthorizationResult.ALLOWED\n+      authZ.authorize(requestContext, actions).asScala.head == AuthorizationResult.ALLOWED\n     }\n   }\n \n-  private def filterAuthorized(request: RequestChannel.Request,\n-                               operation: AclOperation,\n-                               resourceType: ResourceType,\n-                               resourceNames: Seq[String],\n-                               logIfAllowed: Boolean = true,\n-                               logIfDenied: Boolean = true): Set[String] = {\n+  // private package for testing\n+  private[server] def filterAuthorized(requestContext: RequestContext,\n+                                       operation: AclOperation,\n+                                       resourceType: ResourceType,\n+                                       resourceNames: Seq[String],\n+                                       logIfAllowed: Boolean = true,\n+                                       logIfDenied: Boolean = true): Set[String] = {\n     authorizer match {\n       case Some(authZ) =>\n+        val uniqueResourceNames = resourceNames.distinct\n         val groupedResourceNames = resourceNames.groupBy(identity)\n-        val actions = resourceNames.map { resourceName =>\n+        val actions = uniqueResourceNames.map { resourceName =>\n           val count = groupedResourceNames(resourceName).size\n           val resource = new ResourcePattern(resourceType, resourceName, PatternType.LITERAL)\n           new Action(operation, resource, count, logIfAllowed, logIfDenied)\n         }\n-        authZ.authorize(request.context, actions.asJava).asScala\n-          .zip(resourceNames)\n+        authZ.authorize(requestContext, actions.asJava).asScala\n+          .zip(uniqueResourceNames)\n           .filter { case (authzResult, _) => authzResult == AuthorizationResult.ALLOWED }\n           .map { case (_, resourceName) => resourceName }.toSet\n       case None =>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b16a898db41a015717079bec0aacc4dedb14df0"}, "originalPosition": 504}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNTAyMw==", "bodyText": "Do we need to specify the val type here? Since we are passing it to niceMock, doesn't it figure it out by itself? Same question for the next test.", "url": "https://github.com/apache/kafka/pull/8432#discussion_r404215023", "createdAt": "2020-04-06T16:12:42Z", "author": {"login": "ijuma"}, "path": "core/src/test/scala/unit/kafka/server/KafkaApisTest.scala", "diffHunk": "@@ -126,6 +132,93 @@ class KafkaApisTest {\n     )\n   }\n \n+  @Test\n+  def testAuthorize(): Unit = {\n+    val authorizer: Authorizer = EasyMock.niceMock(classOf[Authorizer])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b16a898db41a015717079bec0aacc4dedb14df0"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNTIwNg==", "bodyText": "Nit: is the () needed here? Same question in the next test.", "url": "https://github.com/apache/kafka/pull/8432#discussion_r404215206", "createdAt": "2020-04-06T16:12:57Z", "author": {"login": "ijuma"}, "path": "core/src/test/scala/unit/kafka/server/KafkaApisTest.scala", "diffHunk": "@@ -126,6 +132,93 @@ class KafkaApisTest {\n     )\n   }\n \n+  @Test\n+  def testAuthorize(): Unit = {\n+    val authorizer: Authorizer = EasyMock.niceMock(classOf[Authorizer])\n+\n+    val operation = AclOperation.WRITE\n+    val resourceType = ResourceType.TOPIC\n+    val resourceName = \"topic-1\"\n+    val requestHeader = new RequestHeader(ApiKeys.PRODUCE, ApiKeys.PRODUCE.latestVersion(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b16a898db41a015717079bec0aacc4dedb14df0"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a46f012eddf8fda39071387eb802c6f50bb9de55", "author": {"user": {"login": "dajac", "name": "David Jacot"}}, "url": "https://github.com/apache/kafka/commit/a46f012eddf8fda39071387eb802c6f50bb9de55", "committedDate": "2020-04-06T16:46:39Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f71ff568868ce87a89590d7b903b9f30e280c3e", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/1f71ff568868ce87a89590d7b903b9f30e280c3e", "committedDate": "2020-04-06T16:52:12Z", "message": "Remove unnecessary braces in if/else"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NDM4MTg3", "url": "https://github.com/apache/kafka/pull/8432#pullrequestreview-388438187", "createdAt": "2020-04-06T16:52:43Z", "commit": {"oid": "1f71ff568868ce87a89590d7b903b9f30e280c3e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 105, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}