{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2ODkyNTQ5", "number": 9170, "title": "KAFKA-10391: Overwrite checkpoint in task corruption to remove corrupted partitions", "bodyText": "In order to do this, I also removed the optimization such that once enforced checkpoint is set to true, we always checkpoint unless the state stores are not initialized at all (i.e. the snapshot is null).\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-08-12T16:53:55Z", "url": "https://github.com/apache/kafka/pull/9170", "merged": true, "mergeCommit": {"oid": "d0800b3f7c135c97ec8632c247fc02946527c0a2"}, "closed": true, "closedAt": "2020-08-13T04:20:54Z", "author": {"login": "guozhangwang"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-EIS2AH2gAyNDY2ODkyNTQ5OjM5YTZhMGUzZTU4ODM2YmE4YjNlNjExYTIwMDU3NGJkNWMzYWUzZWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-TIwkgFqTQ2NjMxOTM3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "39a6a0e3e58836ba8b3e611a200574bd5c3ae3ec", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/39a6a0e3e58836ba8b3e611a200574bd5c3ae3ec", "committedDate": "2020-08-12T04:58:04Z", "message": "enforce post commit on task corruption"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/4288099ff38892fc9b02b9ea2eaa87a50adb64c1", "committedDate": "2020-08-12T16:51:58Z", "message": "update unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MTU5NTcy", "url": "https://github.com/apache/kafka/pull/9170#pullrequestreview-466159572", "createdAt": "2020-08-12T18:15:20Z", "commit": {"oid": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxODoxNToyMFrOG_s-aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxODoxNTo0NlrOG_s_ZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ1MDM0NQ==", "bodyText": "Why did this test change?", "url": "https://github.com/apache/kafka/pull/9170#discussion_r469450345", "createdAt": "2020-08-12T18:15:20Z", "author": {"login": "ableegoldman"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java", "diffHunk": "@@ -1609,12 +1609,11 @@ public void shouldReturnStateManagerChangelogOffsets() {\n     }\n \n     @Test\n-    public void shouldCheckpointWithCreatedStateOnClose() {\n+    public void shouldNotCheckpointOnCloseCreated() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ1MDU5Ng==", "bodyText": "Same with this one, why did it change? Or was the test just wrong to begin with..?", "url": "https://github.com/apache/kafka/pull/9170#discussion_r469450596", "createdAt": "2020-08-12T18:15:46Z", "author": {"login": "ableegoldman"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java", "diffHunk": "@@ -1629,16 +1628,18 @@ public void shouldCheckpointWithCreatedStateOnClose() {\n         assertFalse(source1.initialized);\n         assertFalse(source1.closed);\n \n+        EasyMock.verify(stateManager, recordCollector);\n+\n         final double expectedCloseTaskMetric = 1.0;\n         verifyCloseTaskMetric(expectedCloseTaskMetric, streamsMetrics, metricName);\n     }\n \n     @Test\n-    public void shouldNotCheckpointOnCloseRestoringIfNoProgress() {\n+    public void shouldCheckpointOnCloseRestoringIfNoProgress() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MjMwOTYw", "url": "https://github.com/apache/kafka/pull/9170#pullrequestreview-466230960", "createdAt": "2020-08-12T20:01:27Z", "commit": {"oid": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDowNjoxNVrOG_wmMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDoxMTowNlrOG_wvQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUwOTY4MA==", "bodyText": "partition group", "url": "https://github.com/apache/kafka/pull/9170#discussion_r469509680", "createdAt": "2020-08-12T20:06:15Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -193,13 +193,17 @@ private void closeAndRevive(final Map<Task, Collection<TopicPartition>> taskWith\n \n             try {\n                 task.suspend();\n+                // we need to enforce a checkpoint that removes the corrupted partitions\n+                task.postCommit(true);\n             } catch (final RuntimeException swallow) {\n                 log.error(\"Error suspending corrupted task {} \", task.id(), swallow);\n             }\n             task.closeDirty();\n+\n+            // For active tasks pause their input partitions so we won't poll any more records\n+            // for this task until it has been re-initialized;\n+            // Note, closeDirty already clears the partitiongroup for the task.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxMDQwMQ==", "bodyText": "I'm not sure this is 100% ensuring the snapshot gets done, as we have branching logic in postCommit. Do you think we should just get a helper to cleanup instead?", "url": "https://github.com/apache/kafka/pull/9170#discussion_r469510401", "createdAt": "2020-08-12T20:07:41Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -193,13 +193,17 @@ private void closeAndRevive(final Map<Task, Collection<TopicPartition>> taskWith\n \n             try {\n                 task.suspend();\n+                // we need to enforce a checkpoint that removes the corrupted partitions\n+                task.postCommit(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxMjAwMA==", "bodyText": "Could we move this logic to the StandbyTask only? It is the only case I have seen which could have null snapshot passed in, which could make this helper assume both snapshots are not null.\nif (oldOffsetSnapshot == null) {\n            return false;\t          \n}", "url": "https://github.com/apache/kafka/pull/9170#discussion_r469512000", "createdAt": "2020-08-12T20:11:06Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StateManagerUtil.java", "diffHunk": "@@ -58,6 +58,9 @@ static boolean checkpointNeeded(final boolean enforceCheckpoint,\n             return false;\n         }\n \n+        if (enforceCheckpoint)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2Mjg2MTIy", "url": "https://github.com/apache/kafka/pull/9170#pullrequestreview-466286122", "createdAt": "2020-08-12T21:21:03Z", "commit": {"oid": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MzE5Mzc3", "url": "https://github.com/apache/kafka/pull/9170#pullrequestreview-466319377", "createdAt": "2020-08-12T22:27:09Z", "commit": {"oid": "4288099ff38892fc9b02b9ea2eaa87a50adb64c1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 748, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}