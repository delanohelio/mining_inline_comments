{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5Mzc4MDUx", "number": 8164, "title": "KAFKA-9600: EndTxn should enforce strict epoch checking if from client", "bodyText": "This PR enhances the epoch checking logic for endTransaction call in TransactionCoordinator. Previously it relaxes the checking by allowing a producer epoch bump, which is error-prone since there is no reason to see a producer epoch bump from client.\nSince this is purely a server side bug which requires no client side change, we haven't added any integration test to verify this behavior yet.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-02-25T05:42:59Z", "url": "https://github.com/apache/kafka/pull/8164", "merged": true, "mergeCommit": {"oid": "88bc0fdf822aeadb10f875aecb55322b11854f5a"}, "closed": true, "closedAt": "2020-03-28T17:55:14Z", "author": {"login": "abbccdda"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHsJtlgBqjMwNjgxMzQwOTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQ8FuvAFqTM4MDc4MDk2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NzIyNzAx", "url": "https://github.com/apache/kafka/pull/8164#pullrequestreview-364722701", "createdAt": "2020-02-26T09:03:31Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NDE3MjEw", "url": "https://github.com/apache/kafka/pull/8164#pullrequestreview-376417210", "createdAt": "2020-03-17T21:25:59Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QyMToyNTo1OVrOF3uotQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QyMToyOTozOVrOF3uvmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk4MDA4NQ==", "bodyText": "I think reusing handleEndTransaction to handle coordinator aborts has always been a little confusing. As an alternative, we could move the logic here to an internal helper, maybe just named endTransaction. Then we can assume calls from handleEndTransaction are from the client.", "url": "https://github.com/apache/kafka/pull/8164#discussion_r393980085", "createdAt": "2020-03-17T21:25:59Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala", "diffHunk": "@@ -351,6 +352,7 @@ class TransactionCoordinator(brokerId: Int,\n                            producerId: Long,\n                            producerEpoch: Short,\n                            txnMarkerResult: TransactionResult,\n+                           fromClient: Boolean,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk4MTg0OA==", "bodyText": "At a quick glance, these tests look basically the same except for the epoch which is sent and the expected error. Is it possible to factor out a helper?", "url": "https://github.com/apache/kafka/pull/8164#discussion_r393981848", "createdAt": "2020-03-17T21:29:39Z", "author": {"login": "hachikuji"}, "path": "core/src/test/scala/unit/kafka/coordinator/transaction/TransactionCoordinatorTest.scala", "diffHunk": "@@ -495,10 +495,62 @@ class TransactionCoordinatorTest {\n \n     EasyMock.replay(transactionManager)\n \n-    coordinator.handleEndTransaction(transactionalId, 0, 0, TransactionResult.COMMIT, errorsCallback)\n+    coordinator.handleEndTransaction(transactionalId, 0, 0, TransactionResult.COMMIT, false, errorsCallback)\n     assertEquals(Errors.COORDINATOR_LOAD_IN_PROGRESS, error)\n   }\n \n+  @Test\n+  def shouldReturnInvalidEpochWhenEndTxnIsFromClientAndEpochIsLarger(): Unit = {\n+    val serverProducerEpoch = 1.toShort", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 135}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MDUwMDE3", "url": "https://github.com/apache/kafka/pull/8164#pullrequestreview-377050017", "createdAt": "2020-03-18T16:47:08Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNjo0NzowOVrOF4N6Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNjo0NzowOVrOF4N6Bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5MjQyMw==", "bodyText": "This is a little awkward. I think the isFromClient flag was easier to understand and avoided the need to duplicate the check in a couple places.", "url": "https://github.com/apache/kafka/pull/8164#discussion_r394492423", "createdAt": "2020-03-18T16:47:09Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala", "diffHunk": "@@ -352,6 +353,21 @@ class TransactionCoordinator(brokerId: Int,\n                            producerEpoch: Short,\n                            txnMarkerResult: TransactionResult,\n                            responseCallback: EndTxnCallback): Unit = {\n+    endTransaction(transactionalId,\n+      producerId,\n+      producerEpoch,\n+      txnMarkerResult,\n+      // Strict equality is enforced on the client side requests, as they shouldn't bump the producer epoch.\n+      (producerEpoch, txnMetadata) => producerEpoch != txnMetadata.producerEpoch,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MDY2NzIz", "url": "https://github.com/apache/kafka/pull/8164#pullrequestreview-378066723", "createdAt": "2020-03-19T20:24:39Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMDoyNDo0MFrOF4_HsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMDoyNDo0MFrOF4_HsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI5ODczNg==", "bodyText": "Tests which capture logging output tend to be brittle. Would it be more direct to call abortTimedOutTransactions directly?", "url": "https://github.com/apache/kafka/pull/8164#discussion_r395298736", "createdAt": "2020-03-19T20:24:40Z", "author": {"login": "hachikuji"}, "path": "core/src/test/scala/unit/kafka/coordinator/transaction/TransactionCoordinatorTest.scala", "diffHunk": "@@ -842,6 +897,43 @@ class TransactionCoordinatorTest {\n     EasyMock.verify(transactionManager)\n   }\n \n+  @Test\n+  def shouldNotAcceptSmallerEpochDuringTransactionExpiration(): Unit = {\n+    val now = time.milliseconds()\n+    val txnMetadata = new TransactionMetadata(transactionalId, producerId, producerId, producerEpoch,\n+      RecordBatch.NO_PRODUCER_EPOCH, txnTimeoutMs, Ongoing, partitions, now, now)\n+\n+    EasyMock.expect(transactionManager.timedOutTransactions())\n+      .andReturn(List(TransactionalIdAndProducerIdEpoch(transactionalId, producerId, producerEpoch)))\n+    EasyMock.expect(transactionManager.getTransactionState(EasyMock.eq(transactionalId)))\n+      .andReturn(Right(Some(CoordinatorEpochAndTxnMetadata(coordinatorEpoch, txnMetadata))))\n+\n+    val bumpedTxnMetadata = new TransactionMetadata(transactionalId, producerId, producerId, (producerEpoch + 2).toShort,\n+      RecordBatch.NO_PRODUCER_EPOCH, txnTimeoutMs, Ongoing, partitions, now, now)\n+    EasyMock.expect(transactionManager.getTransactionState(EasyMock.eq(transactionalId)))\n+      .andReturn(Right(Some(CoordinatorEpochAndTxnMetadata(coordinatorEpoch, bumpedTxnMetadata))))\n+\n+    val appender = LogCaptureAppender.createAndRegister()\n+    LogCaptureAppender.setClassLoggerLevel(coordinator.getClass, Level.DEBUG)\n+    try {\n+\n+      EasyMock.replay(transactionManager, transactionMarkerChannelManager)\n+\n+      coordinator.startup(false)\n+      time.sleep(TransactionStateManager.DefaultAbortTimedOutTransactionsIntervalMs)\n+      scheduler.tick()\n+      EasyMock.verify(transactionManager)\n+\n+      val event = appender.getMessages.find(e => e.getMessage.equals(\"Rollback of \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 142}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3d1f117232fcbc61ce55c0fc4a2fb4f06db2ba0", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/f3d1f117232fcbc61ce55c0fc4a2fb4f06db2ba0", "committedDate": "2020-03-24T02:00:58Z", "message": "fix end epoch strict checking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28fbdee541efd5a2a9225571da474291b1e3eb04", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/28fbdee541efd5a2a9225571da474291b1e3eb04", "committedDate": "2020-03-24T02:00:58Z", "message": "refactor endTransaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bb7aa7935f9f9aba80f1da6d2fa31edee8c1e64", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/1bb7aa7935f9f9aba80f1da6d2fa31edee8c1e64", "committedDate": "2020-03-24T02:00:58Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60d67a26bff196512b92a800021059f749ed031e", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/60d67a26bff196512b92a800021059f749ed031e", "committedDate": "2020-03-24T02:00:58Z", "message": "add more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f60051aa0d87a7ae6ce1547c1a3c7c6d3ee93193", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/f60051aa0d87a7ae6ce1547c1a3c7c6d3ee93193", "committedDate": "2020-03-24T02:00:58Z", "message": "fall back to client flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43dad623a744f3d3564a938af6ced0e3e103118c", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/43dad623a744f3d3564a938af6ced0e3e103118c", "committedDate": "2020-03-24T02:00:59Z", "message": "make function package private"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "43dad623a744f3d3564a938af6ced0e3e103118c", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/43dad623a744f3d3564a938af6ced0e3e103118c", "committedDate": "2020-03-24T02:00:59Z", "message": "make function package private"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzU0NjYz", "url": "https://github.com/apache/kafka/pull/8164#pullrequestreview-380754663", "createdAt": "2020-03-24T22:57:18Z", "commit": {"oid": "43dad623a744f3d3564a938af6ced0e3e103118c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjo1NzoxOFrOF7GLDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjo1NzoxOFrOF7GLDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxMTQzNg==", "bodyText": "Can this be private?", "url": "https://github.com/apache/kafka/pull/8164#discussion_r397511436", "createdAt": "2020-03-24T22:57:18Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala", "diffHunk": "@@ -500,24 +516,25 @@ class TransactionCoordinator(brokerId: Int,\n \n   def partitionFor(transactionalId: String): Int = txnManager.partitionFor(transactionalId)\n \n-  private def abortTimedOutTransactions(): Unit = {\n-    def onComplete(txnIdAndPidEpoch: TransactionalIdAndProducerIdEpoch)(error: Errors): Unit = {\n-      error match {\n-        case Errors.NONE =>\n-          info(\"Completed rollback of ongoing transaction for transactionalId \" +\n-            s\"${txnIdAndPidEpoch.transactionalId} due to timeout\")\n-\n-        case error@(Errors.INVALID_PRODUCER_ID_MAPPING |\n-                    Errors.INVALID_PRODUCER_EPOCH |\n-                    Errors.CONCURRENT_TRANSACTIONS) =>\n-          debug(s\"Rollback of ongoing transaction for transactionalId ${txnIdAndPidEpoch.transactionalId} \" +\n-            s\"has been cancelled due to error $error\")\n-\n-        case error =>\n-          warn(s\"Rollback of ongoing transaction for transactionalId ${txnIdAndPidEpoch.transactionalId} \" +\n-            s\"failed due to error $error\")\n-      }\n+  def onEndTransactionComplete(txnIdAndPidEpoch: TransactionalIdAndProducerIdEpoch)(error: Errors): Unit = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43dad623a744f3d3564a938af6ced0e3e103118c"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "029dcc6a69e33ef909bcbd0156c109b86e88f7d1", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/029dcc6a69e33ef909bcbd0156c109b86e88f7d1", "committedDate": "2020-03-24T23:38:19Z", "message": "address minor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzgwOTY5", "url": "https://github.com/apache/kafka/pull/8164#pullrequestreview-380780969", "createdAt": "2020-03-25T00:09:26Z", "commit": {"oid": "029dcc6a69e33ef909bcbd0156c109b86e88f7d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1566, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}