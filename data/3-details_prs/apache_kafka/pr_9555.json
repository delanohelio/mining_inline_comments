{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MTMwMDcy", "number": 9555, "title": "KAFKA-10673: Cache inter broker listener name used in connection quotas", "bodyText": "A profile from a moderately busy cluster shows that calls to protectedListener can make up more than 1% of the allocations on a broker.\nconfig.interBrokerListenerName is a relatively expensive call that both makes a copy of the KafkaConfig's backing map and performs string/regex parsing. Given that we call protectedListener() multiple times per call to ConnectionQuotas.inc(), we end up performing a lot of unnecessary allocations, particularly given that the inter broker listener is not reconfigurable. We can instead store the inter broker listener name and check against it rather than recompute from the config.\nAn additional, smaller optimization included is to check the size of listener counts instead of config.listeners, as config.listeners() does some additional string csv parsing to recompute the listeners each time.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-11-04T04:45:55Z", "url": "https://github.com/apache/kafka/pull/9555", "merged": true, "mergeCommit": {"oid": "c2cc8a6b4316338075d163f277fe0d6825172a36"}, "closed": true, "closedAt": "2020-11-06T08:28:32Z", "author": {"login": "splett2"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZmnYcgFqTUyNDU0NTg0Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZyknDgFqTUyNDkzNzU0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NTQ1ODQ2", "url": "https://github.com/apache/kafka/pull/9555#pullrequestreview-524545846", "createdAt": "2020-11-05T18:24:45Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODoyNDo0NVrOHuQpOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODoyNDo0NVrOHuQpOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2OTI0MA==", "bodyText": "Good point and definitely agree that config.interBrokerListenerName could be expensive as we call it several times per accepting a new connection.\nThe issue here is that interBrokerListenerName is a dynamic config. So, you will need to update the cached value on changes to that config; similar how we notify ConnectionQuotas about config changes from SocketServer.reconfigure().", "url": "https://github.com/apache/kafka/pull/9555#discussion_r518269240", "createdAt": "2020-11-05T18:24:45Z", "author": {"login": "apovzner"}, "path": "core/src/main/scala/kafka/network/SocketServer.scala", "diffHunk": "@@ -1189,6 +1189,7 @@ class ConnectionQuotas(config: KafkaConfig, time: Time, metrics: Metrics) extend\n   @volatile private var defaultMaxConnectionsPerIp: Int = config.maxConnectionsPerIp\n   @volatile private var maxConnectionsPerIpOverrides = config.maxConnectionsPerIpOverrides.map { case (host, count) => (InetAddress.getByName(host), count) }\n   @volatile private var brokerMaxConnections = config.maxConnections\n+  @volatile private var interBrokerListenerName = config.interBrokerListenerName", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "0379cb6470fb9b6494bd5839b88205663abb9fef", "author": {"user": {"login": "splett2", "name": "David Mao"}}, "url": "https://github.com/apache/kafka/commit/0379cb6470fb9b6494bd5839b88205663abb9fef", "committedDate": "2020-11-05T19:18:03Z", "message": "Cache interbroker listener name"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "0379cb6470fb9b6494bd5839b88205663abb9fef", "author": {"user": {"login": "splett2", "name": "David Mao"}}, "url": "https://github.com/apache/kafka/commit/0379cb6470fb9b6494bd5839b88205663abb9fef", "committedDate": "2020-11-05T19:18:03Z", "message": "Cache interbroker listener name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NjIyNDM2", "url": "https://github.com/apache/kafka/pull/9555#pullrequestreview-524622436", "createdAt": "2020-11-05T20:01:46Z", "commit": {"oid": "0379cb6470fb9b6494bd5839b88205663abb9fef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0OTM3NTQ4", "url": "https://github.com/apache/kafka/pull/9555#pullrequestreview-524937548", "createdAt": "2020-11-06T08:20:35Z", "commit": {"oid": "0379cb6470fb9b6494bd5839b88205663abb9fef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2688, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}