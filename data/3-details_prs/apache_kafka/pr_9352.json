{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1MDI1NDY2", "number": 9352, "title": "KAFKA-10533; KafkaRaftClient should flush log after appends", "bodyText": "This patch adds missing flush logic to KafkaRaftClient. The initial flushing behavior is simplistic. We guarantee that the leader will not replicate above the last flushed offset and we guarantee that the follower will not fetch data above its own flush point. More sophisticated flush behavior is proposed in KAFKA-10526.\nWe have also extended the simulation test so that it covers flush behavior. When a node is shutdown, all unflushed data is lost. We were able to confirm that the monotonic high watermark invariant fails without the added flush calls.\nThis patch also piggybacks a fix to the TestRaftServer implementation. The initial check-in contained a bug which caused RequestChannel to fail sending responses because the disabled APIs did not have metrics registered. As a result of this, it is impossible to elect leaders.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-09-29T18:40:19Z", "url": "https://github.com/apache/kafka/pull/9352", "merged": true, "mergeCommit": {"oid": "a72f0c1eac67d531a4725d3e48dcab4dce361b95"}, "closed": true, "closedAt": "2020-10-13T15:59:03Z", "author": {"login": "hachikuji"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP7n9ugH2gAyNDk1MDI1NDY2OjZiOWVlYzQ4NTBiYzU3Mzg2NDQ0ODY3YzZlNDkwMjVjMmFiYTM4ZDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR_PaUAFqTUwNzAyODc1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6b9eec4850bc57386444867c6e49025c2aba38d5", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/6b9eec4850bc57386444867c6e49025c2aba38d5", "committedDate": "2020-10-06T17:14:09Z", "message": "KAFKA-10533; RaftClient should flush log after appends"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a129ac7de29fcb57d4b94fc3f362b59c2c46bc3a", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/a129ac7de29fcb57d4b94fc3f362b59c2c46bc3a", "committedDate": "2020-10-06T17:14:10Z", "message": "Fix metric update for disabled APIs in test raft server"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33183d3285af9555ec98e96e6c1a372f8f3376dc", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/33183d3285af9555ec98e96e6c1a372f8f3376dc", "committedDate": "2020-10-06T17:14:10Z", "message": "Expose `lastFlushedOffset` from `ReplicatedLog` (plus some small cleanups)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "944673b8f7d8b8deb07c2632c789647cfa5c4548", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/944673b8f7d8b8deb07c2632c789647cfa5c4548", "committedDate": "2020-10-06T17:14:10Z", "message": "Only call flush after all writes have been appended"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "944673b8f7d8b8deb07c2632c789647cfa5c4548", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/944673b8f7d8b8deb07c2632c789647cfa5c4548", "committedDate": "2020-10-06T17:14:10Z", "message": "Only call flush after all writes have been appended"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTU2NzY5", "url": "https://github.com/apache/kafka/pull/9352#pullrequestreview-506956769", "createdAt": "2020-10-12T22:35:57Z", "commit": {"oid": "944673b8f7d8b8deb07c2632c789647cfa5c4548"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMjozNTo1N1rOHgPU6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMjo1MDo0M1rOHgPnrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU2NzU5Mw==", "bodyText": "Just to clarify this is not a correctness bugfix, but just to optimize away unnecessary purgatory access right?", "url": "https://github.com/apache/kafka/pull/9352#discussion_r503567593", "createdAt": "2020-10-12T22:35:57Z", "author": {"login": "guozhangwang"}, "path": "raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java", "diffHunk": "@@ -193,8 +193,9 @@ private void updateFollowerHighWatermark(\n     ) {\n         highWatermarkOpt.ifPresent(highWatermark -> {\n             long newHighWatermark = Math.min(endOffset().offset, highWatermark);\n-            state.updateHighWatermark(OptionalLong.of(newHighWatermark));\n-            updateHighWatermark(state, currentTimeMs);\n+            if (state.updateHighWatermark(OptionalLong.of(newHighWatermark))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "944673b8f7d8b8deb07c2632c789647cfa5c4548"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3MDA0NA==", "bodyText": "Good catch.", "url": "https://github.com/apache/kafka/pull/9352#discussion_r503570044", "createdAt": "2020-10-12T22:43:47Z", "author": {"login": "guozhangwang"}, "path": "raft/src/main/java/org/apache/kafka/raft/LeaderState.java", "diffHunk": "@@ -114,14 +113,6 @@ private boolean updateHighWatermark() {\n         return false;\n     }\n \n-    private OptionalLong quorumMajorityFetchTimestamp() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "944673b8f7d8b8deb07c2632c789647cfa5c4548"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3MDI2NA==", "bodyText": "Is this function going to be used for non-testing code in the future?", "url": "https://github.com/apache/kafka/pull/9352#discussion_r503570264", "createdAt": "2020-10-12T22:44:29Z", "author": {"login": "guozhangwang"}, "path": "raft/src/main/java/org/apache/kafka/raft/ReplicatedLog.java", "diffHunk": "@@ -103,6 +103,16 @@\n      */\n     void updateHighWatermark(LogOffsetMetadata offsetMetadata);\n \n+    /**\n+     * Flush the current log to disk.\n+     */\n+    void flush();\n+\n+    /**\n+     * Get the last offset which has been flushed to disk.\n+     */\n+    long lastFlushedOffset();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "944673b8f7d8b8deb07c2632c789647cfa5c4548"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3MjM5Ng==", "bodyText": "nit: maybe we can wrap the flushing and hwm updating logic in a flushFollowerLog as well.", "url": "https://github.com/apache/kafka/pull/9352#discussion_r503572396", "createdAt": "2020-10-12T22:50:43Z", "author": {"login": "guozhangwang"}, "path": "raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java", "diffHunk": "@@ -985,6 +986,8 @@ private boolean handleFetchResponse(\n                 Records records = (Records) partitionResponse.recordSet();\n                 if (records.sizeInBytes() > 0) {\n                     LogAppendInfo info = log.appendAsFollower(records);\n+                    log.flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "944673b8f7d8b8deb07c2632c789647cfa5c4548"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bceb07ff9233d969d13108c3d15fefbe665ed873", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/bceb07ff9233d969d13108c3d15fefbe665ed873", "committedDate": "2020-10-13T00:38:44Z", "message": "Add `appendAsFollower` to go along with `appendAsLeader`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MDI4NzU1", "url": "https://github.com/apache/kafka/pull/9352#pullrequestreview-507028755", "createdAt": "2020-10-13T02:34:48Z", "commit": {"oid": "bceb07ff9233d969d13108c3d15fefbe665ed873"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 711, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}