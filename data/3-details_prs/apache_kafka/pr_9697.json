{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyODIxNDA3", "number": 9697, "title": "KAFKA-10810: Replace stream threads", "bodyText": "StreamThreads can now be replaced in the streams uncaught exception handler\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-12-04T22:17:21Z", "url": "https://github.com/apache/kafka/pull/9697", "merged": true, "mergeCommit": {"oid": "d5dc7dfe00b3a9c9934ba6627b892c2c76732e1b"}, "closed": true, "closedAt": "2020-12-11T21:08:21Z", "author": {"login": "wcarlson5"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdi_YILAFqTU0NTMzNTg1NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlOHXcgFqTU1MDU2MjMwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MzM1ODU0", "url": "https://github.com/apache/kafka/pull/9697#pullrequestreview-545335854", "createdAt": "2020-12-04T22:18:29Z", "commit": {"oid": "608d87670e997a9c0a114615fb3e713a9a19f2d7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMjoxOToyMVrOH_kTvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMjoyMDo0MVrOH_kV2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxNzIxMg==", "bodyText": "We need to throw the error or the task gets lost and we drop records", "url": "https://github.com/apache/kafka/pull/9697#discussion_r536417212", "createdAt": "2020-12-04T22:19:21Z", "author": {"login": "wcarlson5"}, "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -444,6 +444,18 @@ private void handleStreamsUncaughtException(final Throwable throwable,\n                     \"The old handler will be ignored as long as a new handler is set.\");\n         }\n         switch (action) {\n+            case REPLACE_THREAD:\n+                StreamThread deadThread = (StreamThread) threads.stream().filter(n -> n.getName().equals(Thread.currentThread().getName())).toArray()[0];\n+                threads.remove(deadThread);\n+                addStreamThread();\n+                deadThread.shutdown();\n+                if (throwable instanceof RuntimeException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "608d87670e997a9c0a114615fb3e713a9a19f2d7"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxNzc1Mg==", "bodyText": "removing from the thread list does 2 things\n\nkeeps DEAD threads out of the list as kip-663 dictates\nensures the next thread has the same name", "url": "https://github.com/apache/kafka/pull/9697#discussion_r536417752", "createdAt": "2020-12-04T22:20:41Z", "author": {"login": "wcarlson5"}, "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -444,6 +444,18 @@ private void handleStreamsUncaughtException(final Throwable throwable,\n                     \"The old handler will be ignored as long as a new handler is set.\");\n         }\n         switch (action) {\n+            case REPLACE_THREAD:\n+                StreamThread deadThread = (StreamThread) threads.stream().filter(n -> n.getName().equals(Thread.currentThread().getName())).toArray()[0];\n+                threads.remove(deadThread);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "608d87670e997a9c0a114615fb3e713a9a19f2d7"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NjExMzA3", "url": "https://github.com/apache/kafka/pull/9697#pullrequestreview-546611307", "createdAt": "2020-12-07T23:02:56Z", "commit": {"oid": "7dc157ebc253d32831424a43f13b614f41a54d36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMzowMjo1N1rOIA-xdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMzowMjo1N1rOIA-xdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5OTM4Mw==", "bodyText": "nit: \"can not\" -> \"cannot\", same below", "url": "https://github.com/apache/kafka/pull/9697#discussion_r537899383", "createdAt": "2020-12-07T23:02:57Z", "author": {"login": "lct45"}, "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -444,6 +444,27 @@ private void handleStreamsUncaughtException(final Throwable throwable,\n                     \"The old handler will be ignored as long as a new handler is set.\");\n         }\n         switch (action) {\n+            case REPLACE_THREAD:\n+                log.warn(\"The global thread can not be replaced. Reverting to shutting down the client.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7dc157ebc253d32831424a43f13b614f41a54d36"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61cdbef2d04f624eb7d4d7b799272bd2ed5a0ff8", "author": {"user": {"login": "wcarlson5", "name": "Walker Carlson"}}, "url": "https://github.com/apache/kafka/commit/61cdbef2d04f624eb7d4d7b799272bd2ed5a0ff8", "committedDate": "2020-12-09T16:57:13Z", "message": "init commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79b743ad94a76abc0ede2444998cc9c3b44b70c0", "author": {"user": {"login": "wcarlson5", "name": "Walker Carlson"}}, "url": "https://github.com/apache/kafka/commit/79b743ad94a76abc0ede2444998cc9c3b44b70c0", "committedDate": "2020-12-09T16:57:14Z", "message": "global thread case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d05ef97a8cdecd3248e6e0206e8b662ba07056c0", "author": {"user": {"login": "wcarlson5", "name": "Walker Carlson"}}, "url": "https://github.com/apache/kafka/commit/d05ef97a8cdecd3248e6e0206e8b662ba07056c0", "committedDate": "2020-12-09T16:57:14Z", "message": "undo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bd4aaf4c026ddbb8fd538c9a5f9b5a808d5a496", "author": {"user": {"login": "wcarlson5", "name": "Walker Carlson"}}, "url": "https://github.com/apache/kafka/commit/0bd4aaf4c026ddbb8fd538c9a5f9b5a808d5a496", "committedDate": "2020-12-09T16:57:14Z", "message": "undo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "060a0a494a89fd97feb6f3c0ee0c9ccf23770707", "author": {"user": {"login": "wcarlson5", "name": "Walker Carlson"}}, "url": "https://github.com/apache/kafka/commit/060a0a494a89fd97feb6f3c0ee0c9ccf23770707", "committedDate": "2020-12-09T16:57:14Z", "message": "Leah's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NTMzNTc4", "url": "https://github.com/apache/kafka/pull/9697#pullrequestreview-548533578", "createdAt": "2020-12-09T19:25:55Z", "commit": {"oid": "060a0a494a89fd97feb6f3c0ee0c9ccf23770707"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxOToyNTo1NVrOIClkMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxOToyNTo1NVrOIClkMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU4MzUzOA==", "bodyText": "Is this equivalent to Thread.currentThead()?", "url": "https://github.com/apache/kafka/pull/9697#discussion_r539583538", "createdAt": "2020-12-09T19:25:55Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -444,6 +444,25 @@ private void handleStreamsUncaughtException(final Throwable throwable,\n                     \"The old handler will be ignored as long as a new handler is set.\");\n         }\n         switch (action) {\n+            case REPLACE_THREAD:\n+                if (globalStreamThread != null && Thread.currentThread().getName().equals(globalStreamThread.getName())) {\n+                    log.warn(\"The global thread cannot be replaced. Reverting to shutting down the client.\");\n+                    log.error(\"Encountered the following exception during processing \" +\n+                            \"and the registered exception handler opted to \" + action + \".\" +\n+                            \" The streams client is going to shut down now. \", throwable);\n+                    close(Duration.ZERO);\n+                }\n+                final StreamThread deadThread = (StreamThread) threads.stream().filter(n -> n.getName().equals(Thread.currentThread().getName())).toArray()[0];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "060a0a494a89fd97feb6f3c0ee0c9ccf23770707"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NTcxNTcz", "url": "https://github.com/apache/kafka/pull/9697#pullrequestreview-548571573", "createdAt": "2020-12-09T20:16:13Z", "commit": {"oid": "060a0a494a89fd97feb6f3c0ee0c9ccf23770707"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMDoxNjoxM1rOICnhvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMDoxNjoxM1rOICnhvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTYxNTY3OA==", "bodyText": "It's not obvious to me how this verifies that the thread actually got replaced. Maybe an explanatory comment is in order?", "url": "https://github.com/apache/kafka/pull/9697#discussion_r539615678", "createdAt": "2020-12-09T20:16:13Z", "author": {"login": "vvcephei"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -202,6 +213,28 @@ private void testShutdownApplication(final int numThreads) throws InterruptedExc\n             assertThat(processorValueCollector.size(), equalTo(1));\n         }\n     }\n+\n+    private void testReplaceThreads(final int numThreads) throws InterruptedException {\n+        properties.put(StreamsConfig.NUM_STREAM_THREADS_CONFIG, numThreads);\n+        try (final KafkaStreams kafkaStreams = new KafkaStreams(builder.build(), properties)) {\n+            kafkaStreams.setUncaughtExceptionHandler((t, e) -> fail(\"should not hit old handler\"));\n+\n+            final AtomicInteger count = new AtomicInteger();\n+            kafkaStreams.setUncaughtExceptionHandler(exception -> {\n+                count.getAndIncrement();\n+                if (count.get() > 2) {\n+                    return SHUTDOWN_CLIENT;\n+                }\n+                return REPLACE_THREAD;\n+            });\n+            StreamsTestUtils.startKafkaStreamsAndWaitForRunningState(kafkaStreams);\n+\n+            produceMessages(0L, inputTopic, \"A\");\n+            waitForApplicationState(Collections.singletonList(kafkaStreams), KafkaStreams.State.NOT_RUNNING, DEFAULT_DURATION);\n+\n+            assertThat(processorValueCollector.size(), equalTo(3));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "060a0a494a89fd97feb6f3c0ee0c9ccf23770707"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NTcxOTc1", "url": "https://github.com/apache/kafka/pull/9697#pullrequestreview-548571975", "createdAt": "2020-12-09T20:16:47Z", "commit": {"oid": "060a0a494a89fd97feb6f3c0ee0c9ccf23770707"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d211da9b3a4ec6983586e3d3d9323db24b88cc18", "author": {"user": {"login": "wcarlson5", "name": "Walker Carlson"}}, "url": "https://github.com/apache/kafka/commit/d211da9b3a4ec6983586e3d3d9323db24b88cc18", "committedDate": "2020-12-09T22:04:55Z", "message": "John's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5Mjk2OTc3", "url": "https://github.com/apache/kafka/pull/9697#pullrequestreview-549296977", "createdAt": "2020-12-10T15:12:51Z", "commit": {"oid": "d211da9b3a4ec6983586e3d3d9323db24b88cc18"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNToxMjo1MVrOIDOJGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNTo1Mzo1OFrOIDQO6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI0ODM0Nw==", "bodyText": "Do we need to shutdown the dead stream thread? completeShutDown() will be called anyways.", "url": "https://github.com/apache/kafka/pull/9697#discussion_r540248347", "createdAt": "2020-12-10T15:12:51Z", "author": {"login": "cadonna"}, "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -444,6 +444,25 @@ private void handleStreamsUncaughtException(final Throwable throwable,\n                     \"The old handler will be ignored as long as a new handler is set.\");\n         }\n         switch (action) {\n+            case REPLACE_THREAD:\n+                if (globalStreamThread != null && Thread.currentThread().getName().equals(globalStreamThread.getName())) {\n+                    log.warn(\"The global thread cannot be replaced. Reverting to shutting down the client.\");\n+                    log.error(\"Encountered the following exception during processing \" +\n+                            \"and the registered exception handler opted to \" + action + \".\" +\n+                            \" The streams client is going to shut down now. \", throwable);\n+                    close(Duration.ZERO);\n+                }\n+                final StreamThread deadThread = (StreamThread) Thread.currentThread();\n+                threads.remove(deadThread);\n+                addStreamThread();\n+                deadThread.shutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d211da9b3a4ec6983586e3d3d9323db24b88cc18"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI0OTQ2NQ==", "bodyText": "I think it would be cleaner to extract this code to a separate method.", "url": "https://github.com/apache/kafka/pull/9697#discussion_r540249465", "createdAt": "2020-12-10T15:14:15Z", "author": {"login": "cadonna"}, "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -444,6 +444,25 @@ private void handleStreamsUncaughtException(final Throwable throwable,\n                     \"The old handler will be ignored as long as a new handler is set.\");\n         }\n         switch (action) {\n+            case REPLACE_THREAD:\n+                if (globalStreamThread != null && Thread.currentThread().getName().equals(globalStreamThread.getName())) {\n+                    log.warn(\"The global thread cannot be replaced. Reverting to shutting down the client.\");\n+                    log.error(\"Encountered the following exception during processing \" +\n+                            \"and the registered exception handler opted to \" + action + \".\" +\n+                            \" The streams client is going to shut down now. \", throwable);\n+                    close(Duration.ZERO);\n+                }\n+                final StreamThread deadThread = (StreamThread) Thread.currentThread();\n+                threads.remove(deadThread);\n+                addStreamThread();\n+                deadThread.shutdown();\n+                if (throwable instanceof RuntimeException) {\n+                    throw (RuntimeException) throwable;\n+                } else if (throwable instanceof Error) {\n+                    throw (Error) throwable;\n+                } else {\n+                    throw new RuntimeException(\"Unexpected checked exception caught in the uncaught exception handler\", throwable);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d211da9b3a4ec6983586e3d3d9323db24b88cc18"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI3NjQ2MQ==", "bodyText": "Could you please be a bit clearer in the explanatory comment? BTW, we execute this test also once with just one stream thread so the 2 stream threads in the comment are not correct. Also, wouldn't it be better to explain the verification in the call to assertThat() instead of in a comment? You can pass a reason to the method.", "url": "https://github.com/apache/kafka/pull/9697#discussion_r540276461", "createdAt": "2020-12-10T15:46:26Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -202,6 +213,29 @@ private void testShutdownApplication(final int numThreads) throws InterruptedExc\n             assertThat(processorValueCollector.size(), equalTo(1));\n         }\n     }\n+\n+    private void testReplaceThreads(final int numThreads) throws InterruptedException {\n+        properties.put(StreamsConfig.NUM_STREAM_THREADS_CONFIG, numThreads);\n+        try (final KafkaStreams kafkaStreams = new KafkaStreams(builder.build(), properties)) {\n+            kafkaStreams.setUncaughtExceptionHandler((t, e) -> fail(\"should not hit old handler\"));\n+\n+            final AtomicInteger count = new AtomicInteger();\n+            kafkaStreams.setUncaughtExceptionHandler(exception -> {\n+                count.getAndIncrement();\n+                if (count.get() > 2) {\n+                    return SHUTDOWN_CLIENT;\n+                }\n+                return REPLACE_THREAD;\n+            });\n+            StreamsTestUtils.startKafkaStreamsAndWaitForRunningState(kafkaStreams);\n+\n+            produceMessages(0L, inputTopic, \"A\");\n+            waitForApplicationState(Collections.singletonList(kafkaStreams), KafkaStreams.State.NOT_RUNNING, DEFAULT_DURATION);\n+\n+            assertThat(processorValueCollector.size(), equalTo(3));\n+            //because we only have 2 threads at the start and each record kills a thread we must have replaced threads", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d211da9b3a4ec6983586e3d3d9323db24b88cc18"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI3NzgxOQ==", "bodyText": "A test is missing for a global stream thread that calls the uncaught exception handler.", "url": "https://github.com/apache/kafka/pull/9697#discussion_r540277819", "createdAt": "2020-12-10T15:48:03Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -202,6 +213,29 @@ private void testShutdownApplication(final int numThreads) throws InterruptedExc\n             assertThat(processorValueCollector.size(), equalTo(1));\n         }\n     }\n+\n+    private void testReplaceThreads(final int numThreads) throws InterruptedException {\n+        properties.put(StreamsConfig.NUM_STREAM_THREADS_CONFIG, numThreads);\n+        try (final KafkaStreams kafkaStreams = new KafkaStreams(builder.build(), properties)) {\n+            kafkaStreams.setUncaughtExceptionHandler((t, e) -> fail(\"should not hit old handler\"));\n+\n+            final AtomicInteger count = new AtomicInteger();\n+            kafkaStreams.setUncaughtExceptionHandler(exception -> {\n+                count.getAndIncrement();\n+                if (count.get() > 2) {\n+                    return SHUTDOWN_CLIENT;\n+                }\n+                return REPLACE_THREAD;\n+            });\n+            StreamsTestUtils.startKafkaStreamsAndWaitForRunningState(kafkaStreams);\n+\n+            produceMessages(0L, inputTopic, \"A\");\n+            waitForApplicationState(Collections.singletonList(kafkaStreams), KafkaStreams.State.NOT_RUNNING, DEFAULT_DURATION);\n+\n+            assertThat(processorValueCollector.size(), equalTo(3));\n+            //because we only have 2 threads at the start and each record kills a thread we must have replaced threads\n+        }\n+    }\n }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d211da9b3a4ec6983586e3d3d9323db24b88cc18"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4MjYwMA==", "bodyText": "I think it would be better to have a test that shows that a new thread that replaced a failed one, actually is able to process records. So, I would let the new thread process some records and then shutdown the client with a normal close.\nMaybe similar applies to the shutdown tests. First let the client/application process some records and then throw an exception that shuts down the client/application. I guess, this last paragraph is something for a separate PR.", "url": "https://github.com/apache/kafka/pull/9697#discussion_r540282600", "createdAt": "2020-12-10T15:53:58Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -202,6 +213,29 @@ private void testShutdownApplication(final int numThreads) throws InterruptedExc\n             assertThat(processorValueCollector.size(), equalTo(1));\n         }\n     }\n+\n+    private void testReplaceThreads(final int numThreads) throws InterruptedException {\n+        properties.put(StreamsConfig.NUM_STREAM_THREADS_CONFIG, numThreads);\n+        try (final KafkaStreams kafkaStreams = new KafkaStreams(builder.build(), properties)) {\n+            kafkaStreams.setUncaughtExceptionHandler((t, e) -> fail(\"should not hit old handler\"));\n+\n+            final AtomicInteger count = new AtomicInteger();\n+            kafkaStreams.setUncaughtExceptionHandler(exception -> {\n+                count.getAndIncrement();\n+                if (count.get() > 2) {\n+                    return SHUTDOWN_CLIENT;\n+                }\n+                return REPLACE_THREAD;\n+            });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d211da9b3a4ec6983586e3d3d9323db24b88cc18"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0708ca0c4f945c7d61c2e25daa55cf13cede8fc4", "author": {"user": {"login": "wcarlson5", "name": "Walker Carlson"}}, "url": "https://github.com/apache/kafka/commit/0708ca0c4f945c7d61c2e25daa55cf13cede8fc4", "committedDate": "2020-12-10T17:16:10Z", "message": "Bruno's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5Mzc0OTA5", "url": "https://github.com/apache/kafka/pull/9697#pullrequestreview-549374909", "createdAt": "2020-12-10T16:25:54Z", "commit": {"oid": "d211da9b3a4ec6983586e3d3d9323db24b88cc18"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNjoyNTo1NFrOIDR1EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNjo1MjowM1rOIDTOcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMwODc1Mg==", "bodyText": "I don't think it matters, it just set the thread state earlier, but we can delete it", "url": "https://github.com/apache/kafka/pull/9697#discussion_r540308752", "createdAt": "2020-12-10T16:25:54Z", "author": {"login": "wcarlson5"}, "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -444,6 +444,25 @@ private void handleStreamsUncaughtException(final Throwable throwable,\n                     \"The old handler will be ignored as long as a new handler is set.\");\n         }\n         switch (action) {\n+            case REPLACE_THREAD:\n+                if (globalStreamThread != null && Thread.currentThread().getName().equals(globalStreamThread.getName())) {\n+                    log.warn(\"The global thread cannot be replaced. Reverting to shutting down the client.\");\n+                    log.error(\"Encountered the following exception during processing \" +\n+                            \"and the registered exception handler opted to \" + action + \".\" +\n+                            \" The streams client is going to shut down now. \", throwable);\n+                    close(Duration.ZERO);\n+                }\n+                final StreamThread deadThread = (StreamThread) Thread.currentThread();\n+                threads.remove(deadThread);\n+                addStreamThread();\n+                deadThread.shutdown();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI0ODM0Nw=="}, "originalCommit": {"oid": "d211da9b3a4ec6983586e3d3d9323db24b88cc18"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMxMTQzNw==", "bodyText": "we can do that", "url": "https://github.com/apache/kafka/pull/9697#discussion_r540311437", "createdAt": "2020-12-10T16:28:26Z", "author": {"login": "wcarlson5"}, "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -444,6 +444,25 @@ private void handleStreamsUncaughtException(final Throwable throwable,\n                     \"The old handler will be ignored as long as a new handler is set.\");\n         }\n         switch (action) {\n+            case REPLACE_THREAD:\n+                if (globalStreamThread != null && Thread.currentThread().getName().equals(globalStreamThread.getName())) {\n+                    log.warn(\"The global thread cannot be replaced. Reverting to shutting down the client.\");\n+                    log.error(\"Encountered the following exception during processing \" +\n+                            \"and the registered exception handler opted to \" + action + \".\" +\n+                            \" The streams client is going to shut down now. \", throwable);\n+                    close(Duration.ZERO);\n+                }\n+                final StreamThread deadThread = (StreamThread) Thread.currentThread();\n+                threads.remove(deadThread);\n+                addStreamThread();\n+                deadThread.shutdown();\n+                if (throwable instanceof RuntimeException) {\n+                    throw (RuntimeException) throwable;\n+                } else if (throwable instanceof Error) {\n+                    throw (Error) throwable;\n+                } else {\n+                    throw new RuntimeException(\"Unexpected checked exception caught in the uncaught exception handler\", throwable);\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI0OTQ2NQ=="}, "originalCommit": {"oid": "d211da9b3a4ec6983586e3d3d9323db24b88cc18"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMxODc1NA==", "bodyText": "I edited the test to be based on the number of thread instead of hard coding. And gave a reason", "url": "https://github.com/apache/kafka/pull/9697#discussion_r540318754", "createdAt": "2020-12-10T16:37:00Z", "author": {"login": "wcarlson5"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -202,6 +213,29 @@ private void testShutdownApplication(final int numThreads) throws InterruptedExc\n             assertThat(processorValueCollector.size(), equalTo(1));\n         }\n     }\n+\n+    private void testReplaceThreads(final int numThreads) throws InterruptedException {\n+        properties.put(StreamsConfig.NUM_STREAM_THREADS_CONFIG, numThreads);\n+        try (final KafkaStreams kafkaStreams = new KafkaStreams(builder.build(), properties)) {\n+            kafkaStreams.setUncaughtExceptionHandler((t, e) -> fail(\"should not hit old handler\"));\n+\n+            final AtomicInteger count = new AtomicInteger();\n+            kafkaStreams.setUncaughtExceptionHandler(exception -> {\n+                count.getAndIncrement();\n+                if (count.get() > 2) {\n+                    return SHUTDOWN_CLIENT;\n+                }\n+                return REPLACE_THREAD;\n+            });\n+            StreamsTestUtils.startKafkaStreamsAndWaitForRunningState(kafkaStreams);\n+\n+            produceMessages(0L, inputTopic, \"A\");\n+            waitForApplicationState(Collections.singletonList(kafkaStreams), KafkaStreams.State.NOT_RUNNING, DEFAULT_DURATION);\n+\n+            assertThat(processorValueCollector.size(), equalTo(3));\n+            //because we only have 2 threads at the start and each record kills a thread we must have replaced threads", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI3NjQ2MQ=="}, "originalCommit": {"oid": "d211da9b3a4ec6983586e3d3d9323db24b88cc18"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMzMTYzMg==", "bodyText": "We can change the test so that we verify the replaced threads can process records.\nI am not sure that is necessary for the shutdown as testing if streams can process some records once started should be tested elsewhere, but in any case I think that the PR is not the place for this discussion", "url": "https://github.com/apache/kafka/pull/9697#discussion_r540331632", "createdAt": "2020-12-10T16:52:03Z", "author": {"login": "wcarlson5"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -202,6 +213,29 @@ private void testShutdownApplication(final int numThreads) throws InterruptedExc\n             assertThat(processorValueCollector.size(), equalTo(1));\n         }\n     }\n+\n+    private void testReplaceThreads(final int numThreads) throws InterruptedException {\n+        properties.put(StreamsConfig.NUM_STREAM_THREADS_CONFIG, numThreads);\n+        try (final KafkaStreams kafkaStreams = new KafkaStreams(builder.build(), properties)) {\n+            kafkaStreams.setUncaughtExceptionHandler((t, e) -> fail(\"should not hit old handler\"));\n+\n+            final AtomicInteger count = new AtomicInteger();\n+            kafkaStreams.setUncaughtExceptionHandler(exception -> {\n+                count.getAndIncrement();\n+                if (count.get() > 2) {\n+                    return SHUTDOWN_CLIENT;\n+                }\n+                return REPLACE_THREAD;\n+            });", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4MjYwMA=="}, "originalCommit": {"oid": "d211da9b3a4ec6983586e3d3d9323db24b88cc18"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29fa8c0c0f2750eb47a2b02310876ad69ea280a8", "author": {"user": {"login": "wcarlson5", "name": "Walker Carlson"}}, "url": "https://github.com/apache/kafka/commit/29fa8c0c0f2750eb47a2b02310876ad69ea280a8", "committedDate": "2020-12-10T18:49:58Z", "message": "Bruno's comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5b170ca0c3d7f06ffcda1483ce6fad3cb485de5", "author": {"user": {"login": "wcarlson5", "name": "Walker Carlson"}}, "url": "https://github.com/apache/kafka/commit/d5b170ca0c3d7f06ffcda1483ce6fad3cb485de5", "committedDate": "2020-12-11T03:21:15Z", "message": "add test for the global thread having an error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5OTk4OTEz", "url": "https://github.com/apache/kafka/pull/9697#pullrequestreview-549998913", "createdAt": "2020-12-11T10:59:40Z", "commit": {"oid": "d5b170ca0c3d7f06ffcda1483ce6fad3cb485de5"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMDo1OTo0MVrOIDzyEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMTowNjozOFrOID0B-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg2NTA0Mw==", "bodyText": "Please rename to replaceStreamThread().", "url": "https://github.com/apache/kafka/pull/9697#discussion_r540865043", "createdAt": "2020-12-11T10:59:41Z", "author": {"login": "cadonna"}, "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -436,6 +436,26 @@ private void defaultStreamsUncaughtExceptionHandler(final Throwable throwable) {\n         }\n     }\n \n+    private void replaceThreadHelper(final Throwable throwable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b170ca0c3d7f06ffcda1483ce6fad3cb485de5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg2NzMxNg==", "bodyText": "The point of this test should be that a global stream thread is not replaced but the client is shutdown instead. Hence, the uncaught exception handler should return REPLACE_THREAD, not SHUTDOWN_CLIENT.", "url": "https://github.com/apache/kafka/pull/9697#discussion_r540867316", "createdAt": "2020-12-11T11:03:38Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -155,16 +171,46 @@ public void shouldShutdownSingleThreadApplication() throws InterruptedException\n         testShutdownApplication(1);\n     }\n \n+    @Test\n+    public void testGlobalThreadException() throws InterruptedException {\n+        builder  = new StreamsBuilder();\n+        builder.addGlobalStore(\n+            new KeyValueStoreBuilder<>(\n+                Stores.persistentKeyValueStore(\"globalStore\"),\n+                Serdes.String(),\n+                Serdes.String(),\n+                CLUSTER.time\n+            ),\n+            inputTopic,\n+            Consumed.with(Serdes.String(), Serdes.String()),\n+            () -> new ShutdownProcessor(processorValueCollector)\n+        );\n+        properties.put(StreamsConfig.NUM_STREAM_THREADS_CONFIG, 0);\n+\n+        try (final KafkaStreams kafkaStreams = new KafkaStreams(builder.build(), properties)) {\n+            kafkaStreams.setUncaughtExceptionHandler((t, e) -> fail(\"should not hit old handler\"));\n+            kafkaStreams.setUncaughtExceptionHandler(exception -> SHUTDOWN_CLIENT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b170ca0c3d7f06ffcda1483ce6fad3cb485de5"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg2ODY2MA==", "bodyText": "Please rename to something like shouldShutDownClientIfGlobalStreamThreadWantsToReplaceThread().", "url": "https://github.com/apache/kafka/pull/9697#discussion_r540868660", "createdAt": "2020-12-11T11:05:53Z", "author": {"login": "cadonna"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -155,16 +171,46 @@ public void shouldShutdownSingleThreadApplication() throws InterruptedException\n         testShutdownApplication(1);\n     }\n \n+    @Test\n+    public void testGlobalThreadException() throws InterruptedException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b170ca0c3d7f06ffcda1483ce6fad3cb485de5"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg2OTExNQ==", "bodyText": "I would rename it to REPLACE_STREAM_THREAD.", "url": "https://github.com/apache/kafka/pull/9697#discussion_r540869115", "createdAt": "2020-12-11T11:06:38Z", "author": {"login": "cadonna"}, "path": "streams/src/main/java/org/apache/kafka/streams/errors/StreamsUncaughtExceptionHandler.java", "diffHunk": "@@ -27,6 +27,7 @@\n      * Enumeration that describes the response from the exception handler.\n      */\n     enum StreamThreadExceptionResponse {\n+        REPLACE_THREAD(0, \"REPLACE_STREAM_THREAD\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b170ca0c3d7f06ffcda1483ce6fad3cb485de5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e96114cf6a213ba4424958a049e846d44b14107", "author": {"user": {"login": "wcarlson5", "name": "Walker Carlson"}}, "url": "https://github.com/apache/kafka/commit/6e96114cf6a213ba4424958a049e846d44b14107", "committedDate": "2020-12-11T16:43:22Z", "message": "cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMzY1MzM3", "url": "https://github.com/apache/kafka/pull/9697#pullrequestreview-550365337", "createdAt": "2020-12-11T17:47:31Z", "commit": {"oid": "6e96114cf6a213ba4424958a049e846d44b14107"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTYyMzA1", "url": "https://github.com/apache/kafka/pull/9697#pullrequestreview-550562305", "createdAt": "2020-12-11T20:39:09Z", "commit": {"oid": "6e96114cf6a213ba4424958a049e846d44b14107"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2567, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}