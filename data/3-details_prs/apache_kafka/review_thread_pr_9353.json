{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1MTI0MTk5", "number": 9353, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwMDoxMDo0MFrOEs0gNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMDozMDowOVrOEtNntQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1NDMzMDE1OnYy", "diffSide": "RIGHT", "path": "core/src/main/scala/kafka/controller/KafkaController.scala", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwMDoxMDo0MFrOHgRLXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwMDoxMDo0MFrOHgRLXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5NzkxNw==", "bodyText": "This old logic in processPartitionReassignmentIsrChange() does an info logging before calling onPartitionReassignment(). Should we do the same thing here?", "url": "https://github.com/apache/kafka/pull/9353#discussion_r503597917", "createdAt": "2020-10-13T00:10:40Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/controller/KafkaController.scala", "diffHunk": "@@ -1907,6 +1915,20 @@ class KafkaController(val config: KafkaConfig,\n     }\n \n     callback.apply(response)\n+\n+    // After we have returned the result of the `AlterIsr` request, we should check whether\n+    // there are any reassignments which can be completed by a successful ISR expansion.\n+    response.left.foreach { alterIsrResponses =>\n+      alterIsrResponses.forKeyValue { (topicPartition, partitionResponse) =>\n+        if (controllerContext.partitionsBeingReassigned.contains(topicPartition)) {\n+          val isSuccessfulUpdate = partitionResponse.isRight\n+          if (isSuccessfulUpdate) {\n+            val assignment = controllerContext.partitionFullReplicaAssignment(topicPartition)\n+            onPartitionReassignment(topicPartition, assignment)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1ODQ0NTMzOnYy", "diffSide": "RIGHT", "path": "core/src/test/scala/integration/kafka/admin/ReassignPartitionsIntegrationTest.scala", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMDozMDowOVrOHg4W7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMDozMDowOVrOHg4W7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzOTg1Mw==", "bodyText": "typo \"some on\"", "url": "https://github.com/apache/kafka/pull/9353#discussion_r504239853", "createdAt": "2020-10-13T20:30:09Z", "author": {"login": "junrao"}, "path": "core/src/test/scala/integration/kafka/admin/ReassignPartitionsIntegrationTest.scala", "diffHunk": "@@ -60,13 +57,53 @@ class ReassignPartitionsIntegrationTest extends ZooKeeperTestHarness {\n       brokerId -> brokerLevelThrottles.map(throttle => (throttle, -1L)).toMap\n     }.toMap\n \n-  /**\n-   * Test running a quick reassignment.\n-   */\n+\n   @Test\n   def testReassignment(): Unit = {\n     cluster = new ReassignPartitionsTestCluster(zkConnect)\n     cluster.setup()\n+    executeAndVerifyReassignment()\n+  }\n+\n+  @Test\n+  def testReassignmentWithAlterIsrDisabled(): Unit = {\n+    // Test reassignment when the IBP is on an older version which does not use\n+    // the `AlterIsr` API. In this case, the controller will register individual\n+    // watches for each reassigning partition so that the reassignment can be\n+    // completed as soon as the ISR is expanded.\n+    val configOverrides = Map(KafkaConfig.InterBrokerProtocolVersionProp -> KAFKA_2_7_IV1.version)\n+    cluster = new ReassignPartitionsTestCluster(zkConnect, configOverrides = configOverrides)\n+    cluster.setup()\n+    executeAndVerifyReassignment()\n+  }\n+\n+  @Test\n+  def testReassignmentCompletionDuringPartialUpgrade(): Unit = {\n+    // Test reassignment during a partial upgrade when some brokers are relying on\n+    // `AlterIsr` and some on rely on the old notification logic through Zookeeper.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4a37c9fbb2182a6321668ea1aff3b3519fbfbe7"}, "originalPosition": 71}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1883, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}