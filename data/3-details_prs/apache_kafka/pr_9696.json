{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNzgwMzM3", "number": 9696, "title": "MINOR: Clean up streams metric sensors", "bodyText": "Follow-up from #9614, updates streams metrics sensor logic", "createdAt": "2020-12-04T20:50:08Z", "url": "https://github.com/apache/kafka/pull/9696", "merged": true, "mergeCommit": {"oid": "78a986bf597835df2eec3e875da299cd147fa62c"}, "closed": true, "closedAt": "2020-12-09T09:51:31Z", "author": {"login": "lct45"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkFrjEAFqTU0Njg0MzMzMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkQ-kgABqjQwODY4MjkzNTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2ODQzMzMy", "url": "https://github.com/apache/kafka/pull/9696#pullrequestreview-546843332", "createdAt": "2020-12-08T08:15:36Z", "commit": {"oid": "9e05a8746675dc88fb665413f7ef39779313a944"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwODoxNTozNlrOIBMkJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwODoxNTozNlrOIBMkJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODEyNTM1MQ==", "bodyText": "It seems the number of elements is always 1. Is new ArrayDeque<>(1) more suitable for this case?", "url": "https://github.com/apache/kafka/pull/9696#discussion_r538125351", "createdAt": "2020-12-08T08:15:36Z", "author": {"login": "chia7712"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java", "diffHunk": "@@ -235,11 +235,12 @@ public final Sensor threadLevelSensor(final String threadId,\n         final String key = threadSensorPrefix(threadId);\n         synchronized (threadLevelSensors) {\n             final String fullSensorName = key + SENSOR_NAME_DELIMITER + sensorName;\n-            return Optional.ofNullable(metrics.getSensor(fullSensorName))\n-                .orElseGet(() -> {\n-                    threadLevelSensors.computeIfAbsent(key, ignored -> new LinkedList<>()).push(fullSensorName);\n-                    return metrics.sensor(fullSensorName, recordingLevel, parents);\n-                });\n+            final Sensor sensor = metrics.getSensor(fullSensorName);\n+            if (sensor == null) {\n+                threadLevelSensors.computeIfAbsent(key, ignored -> new LinkedList<>()).push(fullSensorName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e05a8746675dc88fb665413f7ef39779313a944"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MzYyMDY3", "url": "https://github.com/apache/kafka/pull/9696#pullrequestreview-547362067", "createdAt": "2020-12-08T15:44:51Z", "commit": {"oid": "f983d6857f81bcfe5d149cf5c5a4aa9905616b41"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NTYxNzM2", "url": "https://github.com/apache/kafka/pull/9696#pullrequestreview-547561736", "createdAt": "2020-12-08T19:29:58Z", "commit": {"oid": "f983d6857f81bcfe5d149cf5c5a4aa9905616b41"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxOToyOTo1OVrOIByhMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxOToyOTo1OVrOIByhMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0NzE4NA==", "bodyText": "We can also make this method private and not final, can't we?", "url": "https://github.com/apache/kafka/pull/9696#discussion_r538747184", "createdAt": "2020-12-08T19:29:59Z", "author": {"login": "cadonna"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java", "diffHunk": "@@ -926,6 +905,19 @@ public static void maybeMeasureLatency(final Runnable actionToMeasure,\n         }\n     }\n \n+    public final Sensor getSensors(final Map<String, Deque<String>> sensors,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f983d6857f81bcfe5d149cf5c5a4aa9905616b41"}, "originalPosition": 103}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7033d1ba1d2bb2bb1b8ce3a8ca3a959930468523", "author": {"user": {"login": "lct45", "name": "leah"}}, "url": "https://github.com/apache/kafka/commit/7033d1ba1d2bb2bb1b8ce3a8ca3a959930468523", "committedDate": "2020-12-08T20:47:56Z", "message": "Updating adding sensors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7dac98024f0ce7bf52077277ffc02c08b2a1935", "author": {"user": {"login": "lct45", "name": "leah"}}, "url": "https://github.com/apache/kafka/commit/e7dac98024f0ce7bf52077277ffc02c08b2a1935", "committedDate": "2020-12-08T20:47:56Z", "message": "Removing duplicate code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f983d6857f81bcfe5d149cf5c5a4aa9905616b41", "author": {"user": {"login": "lct45", "name": "leah"}}, "url": "https://github.com/apache/kafka/commit/f983d6857f81bcfe5d149cf5c5a4aa9905616b41", "committedDate": "2020-12-08T15:42:07Z", "message": "Removing duplicate code"}, "afterCommit": {"oid": "af261ad0cfc8babb9d37531749ce4cc36d761e2f", "author": {"user": {"login": "lct45", "name": "leah"}}, "url": "https://github.com/apache/kafka/commit/af261ad0cfc8babb9d37531749ce4cc36d761e2f", "committedDate": "2020-12-08T20:58:56Z", "message": "minor cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjMxODg2", "url": "https://github.com/apache/kafka/pull/9696#pullrequestreview-547631886", "createdAt": "2020-12-08T21:06:24Z", "commit": {"oid": "af261ad0cfc8babb9d37531749ce4cc36d761e2f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMTowNjoyNFrOIB2MtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMTowODozMVrOIB2RWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwNzQ3Ng==", "bodyText": "nit: Could you fix the indentation?", "url": "https://github.com/apache/kafka/pull/9696#discussion_r538807476", "createdAt": "2020-12-08T21:06:24Z", "author": {"login": "cadonna"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java", "diffHunk": "@@ -926,6 +905,19 @@ public static void maybeMeasureLatency(final Runnable actionToMeasure,\n         }\n     }\n \n+    private Sensor getSensors(final Map<String, Deque<String>> sensors,\n+                                   final String fullSensorName,\n+                                   final String key,\n+                                   final RecordingLevel recordingLevel,\n+                                   final Sensor... parents) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af261ad0cfc8babb9d37531749ce4cc36d761e2f"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwODY2Ng==", "bodyText": "I think you can also drag this line into getSensor(). Sorry for not noticing it before.", "url": "https://github.com/apache/kafka/pull/9696#discussion_r538808666", "createdAt": "2020-12-08T21:08:31Z", "author": {"login": "cadonna"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java", "diffHunk": "@@ -235,11 +235,7 @@ public final Sensor threadLevelSensor(final String threadId,\n         final String key = threadSensorPrefix(threadId);\n         synchronized (threadLevelSensors) {\n             final String fullSensorName = key + SENSOR_NAME_DELIMITER + sensorName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af261ad0cfc8babb9d37531749ce4cc36d761e2f"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c7b912212018bf0fde8a1e0061c7ba7bc2bb4ac", "author": {"user": {"login": "lct45", "name": "leah"}}, "url": "https://github.com/apache/kafka/commit/8c7b912212018bf0fde8a1e0061c7ba7bc2bb4ac", "committedDate": "2020-12-08T21:24:55Z", "message": "minor cleanup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "af261ad0cfc8babb9d37531749ce4cc36d761e2f", "author": {"user": {"login": "lct45", "name": "leah"}}, "url": "https://github.com/apache/kafka/commit/af261ad0cfc8babb9d37531749ce4cc36d761e2f", "committedDate": "2020-12-08T20:58:56Z", "message": "minor cleanup"}, "afterCommit": {"oid": "8c7b912212018bf0fde8a1e0061c7ba7bc2bb4ac", "author": {"user": {"login": "lct45", "name": "leah"}}, "url": "https://github.com/apache/kafka/commit/8c7b912212018bf0fde8a1e0061c7ba7bc2bb4ac", "committedDate": "2020-12-08T21:24:55Z", "message": "minor cleanup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2563, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}