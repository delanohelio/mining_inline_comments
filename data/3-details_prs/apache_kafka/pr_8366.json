{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MzgzMzQy", "number": 8366, "title": "MINOR: optimize integration test shutdown", "bodyText": "delete topics before tearing down multi-node clusters to avoid leader elections during shutdown\ntear down all nodes concurrently instead of sequentially\n\nRight now on the current trunk, when I run ./gradlew clean :streams:test, I get something like:\nBUILD SUCCESSFUL in 12m 32s\n\nRunning the same command with this PR, I get:\nBUILD SUCCESSFUL in 11m 23s\n\nNot huge, but it helps. A side benefit is that we avoid filling the integration test logs with hundreds/thousands of lines of log messages during shutdown related to all the leader elections for all the topics.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-03-26T19:45:45Z", "url": "https://github.com/apache/kafka/pull/8366", "merged": true, "mergeCommit": {"oid": "3f5ad4640bd7cf373fddcbbfe5ac5596d95c82c0"}, "closed": true, "closedAt": "2020-03-27T15:50:44Z", "author": {"login": "vvcephei"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRfx_HgH2gAyMzk0MzgzMzQyOmUzMzk2YWIxMzY1YTI3MzdhM2VkMDAzOTA0MTU0YTk3NGNmZTQ5ODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRkUVJgFqTM4MjQ3ODcyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e3396ab1365a2737a3ed003904154a974cfe4981", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/e3396ab1365a2737a3ed003904154a974cfe4981", "committedDate": "2020-03-26T17:44:27Z", "message": "MINOR: optimize integration test shutdown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "545d87db930e34b912724e481c1a513598a99e15", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/545d87db930e34b912724e481c1a513598a99e15", "committedDate": "2020-03-26T18:37:20Z", "message": "remove unused method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMzk0NTMw", "url": "https://github.com/apache/kafka/pull/8366#pullrequestreview-382394530", "createdAt": "2020-03-26T20:32:48Z", "commit": {"oid": "545d87db930e34b912724e481c1a513598a99e15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMDozMjo0OFrOF8ZQkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMDozMjo0OFrOF8ZQkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODg3MjcyMg==", "bodyText": "Do we need to wait to avoid the leader election?", "url": "https://github.com/apache/kafka/pull/8366#discussion_r398872722", "createdAt": "2020-03-26T20:32:48Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/utils/EmbeddedKafkaCluster.java", "diffHunk": "@@ -118,8 +118,19 @@ private void putIfAbsent(final Properties props, final String propertyKey, final\n      * Stop the Kafka cluster.\n      */\n     private void stop() {\n+        if (brokers.length > 1) {\n+            // delete the topics first to avoid cascading leader elections while shutting down the brokers\n+            try {\n+                deleteAllTopicsAndWait(60_000L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "545d87db930e34b912724e481c1a513598a99e15"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMzk1MjU5", "url": "https://github.com/apache/kafka/pull/8366#pullrequestreview-382395259", "createdAt": "2020-03-26T20:33:55Z", "commit": {"oid": "545d87db930e34b912724e481c1a513598a99e15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMDozMzo1NVrOF8ZS3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMDozMzo1NVrOF8ZS3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODg3MzMwOQ==", "bodyText": "Nit (feel free to ignore): Should stopAsync be before awaitStoppedAndPurge ?", "url": "https://github.com/apache/kafka/pull/8366#discussion_r398873309", "createdAt": "2020-03-26T20:33:55Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/utils/KafkaEmbedded.java", "diffHunk": "@@ -143,6 +137,13 @@ public void stop() {\n             brokerList(), zookeeperConnect());\n     }\n \n+    @SuppressWarnings(\"WeakerAccess\")\n+    public void stopAsync() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "545d87db930e34b912724e481c1a513598a99e15"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNDIwMDMw", "url": "https://github.com/apache/kafka/pull/8366#pullrequestreview-382420030", "createdAt": "2020-03-26T21:05:43Z", "commit": {"oid": "545d87db930e34b912724e481c1a513598a99e15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMTowNTo0M1rOF8aeEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMTowNTo0M1rOF8aeEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODg5MjU2MQ==", "bodyText": "Should we actually capture AssertionError instead of InterruptedException? I think when it times out the former is thrown not the latter.", "url": "https://github.com/apache/kafka/pull/8366#discussion_r398892561", "createdAt": "2020-03-26T21:05:43Z", "author": {"login": "guozhangwang"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/utils/EmbeddedKafkaCluster.java", "diffHunk": "@@ -118,8 +118,19 @@ private void putIfAbsent(final Properties props, final String propertyKey, final\n      * Stop the Kafka cluster.\n      */\n     private void stop() {\n+        if (brokers.length > 1) {\n+            // delete the topics first to avoid cascading leader elections while shutting down the brokers\n+            try {\n+                deleteAllTopicsAndWait(60_000L);\n+            } catch (final InterruptedException e) {\n+                log.warn(\"Couldn't delete all topics before stopping brokers\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "545d87db930e34b912724e481c1a513598a99e15"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8c3d01b7cfe564491bde283fc84a1c3b2aac765", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/c8c3d01b7cfe564491bde283fc84a1c3b2aac765", "committedDate": "2020-03-26T21:36:16Z", "message": "cr feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNDYyMjI4", "url": "https://github.com/apache/kafka/pull/8366#pullrequestreview-382462228", "createdAt": "2020-03-26T22:22:04Z", "commit": {"oid": "c8c3d01b7cfe564491bde283fc84a1c3b2aac765"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMjoyMjowNFrOF8coVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMjoyMjowNFrOF8coVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkyNzk1Ng==", "bodyText": "We should use try-with-resource to make sure the AdminClient gets closed.", "url": "https://github.com/apache/kafka/pull/8366#discussion_r398927956", "createdAt": "2020-03-26T22:22:04Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/utils/EmbeddedKafkaCluster.java", "diffHunk": "@@ -118,8 +120,25 @@ private void putIfAbsent(final Properties props, final String propertyKey, final\n      * Stop the Kafka cluster.\n      */\n     private void stop() {\n+        if (brokers.length > 1) {\n+            // delete the topics first to avoid cascading leader elections while shutting down the brokers\n+            try {\n+                final Set<String> topics = JavaConverters.setAsJavaSetConverter(brokers[0].kafkaServer().zkClient().getAllTopicsInCluster(false)).asJava();\n+                final Admin adminClient = brokers[0].createAdminClient();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8c3d01b7cfe564491bde283fc84a1c3b2aac765"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "002e80db429cda99e23be5116391395adfe7e649", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/002e80db429cda99e23be5116391395adfe7e649", "committedDate": "2020-03-26T22:32:03Z", "message": "CR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNDY4MTE5", "url": "https://github.com/apache/kafka/pull/8366#pullrequestreview-382468119", "createdAt": "2020-03-26T22:35:38Z", "commit": {"oid": "002e80db429cda99e23be5116391395adfe7e649"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMjozNTozOVrOF8c8sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMjozNTozOVrOF8c8sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkzMzE3MA==", "bodyText": "I thought this could throw, too?", "url": "https://github.com/apache/kafka/pull/8366#discussion_r398933170", "createdAt": "2020-03-26T22:35:39Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/utils/EmbeddedKafkaCluster.java", "diffHunk": "@@ -118,8 +120,25 @@ private void putIfAbsent(final Properties props, final String propertyKey, final\n      * Stop the Kafka cluster.\n      */\n     private void stop() {\n+        if (brokers.length > 1) {\n+            // delete the topics first to avoid cascading leader elections while shutting down the brokers\n+            final Set<String> topics = getAllTopicsInCluster();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "002e80db429cda99e23be5116391395adfe7e649"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNDc4NzIw", "url": "https://github.com/apache/kafka/pull/8366#pullrequestreview-382478720", "createdAt": "2020-03-26T23:01:35Z", "commit": {"oid": "002e80db429cda99e23be5116391395adfe7e649"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1692, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}