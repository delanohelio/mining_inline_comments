{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5MTUyMTY1", "number": 8681, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMDoxMzoyMlrOD9l87Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMToxODowMVrOD9moVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1OTExNTMzOnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMDoxMzoyMlrOGXLgYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMzoxNzoyM1rOGXOZSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1ODk0Nw==", "bodyText": "I think we might want to skip the re-registration higher up the call stack. In StateManagerUtil#registerStateStores we call store.init on each store which ultimately results in this registerStore being called", "url": "https://github.com/apache/kafka/pull/8681#discussion_r426958947", "createdAt": "2020-05-19T00:13:22Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -266,7 +266,8 @@ public void registerStore(final StateStore store, final StateRestoreCallback sta\n         }\n \n         if (stores.containsKey(storeName)) {\n-            throw new IllegalArgumentException(format(\"%sStore %s has already been registered.\", logPrefix, storeName));\n+            log.warn(\"State Store {} has already been registered, which could be due to a half-way registration\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3NTM2OQ==", "bodyText": "+1, we can rely on storeManager#getStore inside StateManagerUtil to check if the store is already registered.", "url": "https://github.com/apache/kafka/pull/8681#discussion_r426975369", "createdAt": "2020-05-19T01:16:07Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -266,7 +266,8 @@ public void registerStore(final StateStore store, final StateRestoreCallback sta\n         }\n \n         if (stores.containsKey(storeName)) {\n-            throw new IllegalArgumentException(format(\"%sStore %s has already been registered.\", logPrefix, storeName));\n+            log.warn(\"State Store {} has already been registered, which could be due to a half-way registration\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1ODk0Nw=="}, "originalCommit": {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk5ODU0NQ==", "bodyText": "So are we still required to remove the illegal argument exception here? What I'm concerned is that the latest version of state store initialization might be different from previous iteration, so it's safer to just go through the entire procedure once more.", "url": "https://github.com/apache/kafka/pull/8681#discussion_r426998545", "createdAt": "2020-05-19T02:45:18Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -266,7 +266,8 @@ public void registerStore(final StateStore store, final StateRestoreCallback sta\n         }\n \n         if (stores.containsKey(storeName)) {\n-            throw new IllegalArgumentException(format(\"%sStore %s has already been registered.\", logPrefix, storeName));\n+            log.warn(\"State Store {} has already been registered, which could be due to a half-way registration\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1ODk0Nw=="}, "originalCommit": {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAwMzU2MA==", "bodyText": "Nah, I think we should actually keep this (although IllegalStateException seems to make more sense, can we change it?) -- we should just make sure we don't reach it", "url": "https://github.com/apache/kafka/pull/8681#discussion_r427003560", "createdAt": "2020-05-19T03:05:48Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -266,7 +266,8 @@ public void registerStore(final StateStore store, final StateRestoreCallback sta\n         }\n \n         if (stores.containsKey(storeName)) {\n-            throw new IllegalArgumentException(format(\"%sStore %s has already been registered.\", logPrefix, storeName));\n+            log.warn(\"State Store {} has already been registered, which could be due to a half-way registration\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1ODk0Nw=="}, "originalCommit": {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAwNjI4MA==", "bodyText": "Re: your concern, I don't think we can assume that a user's state store's init method is idempotent. AFAIK nothing should change that's relevant to the state store registration, but if something does (eg TaskCorrupted) we'd have to wipe out everything and start it all again anyways", "url": "https://github.com/apache/kafka/pull/8681#discussion_r427006280", "createdAt": "2020-05-19T03:17:23Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -266,7 +266,8 @@ public void registerStore(final StateStore store, final StateRestoreCallback sta\n         }\n \n         if (stores.containsKey(storeName)) {\n-            throw new IllegalArgumentException(format(\"%sStore %s has already been registered.\", logPrefix, storeName));\n+            log.warn(\"State Store {} has already been registered, which could be due to a half-way registration\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1ODk0Nw=="}, "originalCommit": {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1OTIyNjQ1OnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMToxODowMVrOGXMigA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMToxODowMVrOGXMigA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3NTg3Mg==", "bodyText": "nit: we could make the warn log entry more clear that we did not override the registered the store, e.g. \"Skipped registering state store {} since it has already existed in the state manager, ...\"", "url": "https://github.com/apache/kafka/pull/8681#discussion_r426975872", "createdAt": "2020-05-19T01:18:01Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -266,7 +266,8 @@ public void registerStore(final StateStore store, final StateRestoreCallback sta\n         }\n \n         if (stores.containsKey(storeName)) {\n-            throw new IllegalArgumentException(format(\"%sStore %s has already been registered.\", logPrefix, storeName));\n+            log.warn(\"State Store {} has already been registered, which could be due to a half-way registration\" +\n+                \"in the previous round\", storeName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2652, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}