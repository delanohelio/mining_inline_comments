{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNTI4MzEy", "number": 9668, "title": "MINOR: add test for repartition/source-topic/changelog optimization", "bodyText": "If topology optimization is enabled, KafkaStreams does not create store\nchangelog topics but re-uses source input topics if possible. However,\nthis optimization should not be applied to internal repartition topics,\nbecause those are actively purged.\nCall for review @ableegoldman", "createdAt": "2020-12-01T19:38:51Z", "url": "https://github.com/apache/kafka/pull/9668", "merged": true, "mergeCommit": {"oid": "a0e0028b16ae1b7b4a1dca1715b5b130187b334a"}, "closed": true, "closedAt": "2020-12-23T19:56:55Z", "author": {"login": "mjsax"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh_NzfAH2gAyNTMwNTI4MzEyOmI4NmU5MDc2MzBjZTMzMmU1NTc3ZjIwNTQ1Y2MwNmRlOGY0ZjQzYmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi7IBIgH2gAyNTMwNTI4MzEyOmYyOTYyMTM4NzliMGY1MzJiOGE0MDVmYzE4NzcwMzJkZjljOThjZjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b86e907630ce332e5577f20545cc06de8f4f43bf", "author": {"user": {"login": "mjsax", "name": "Matthias J. Sax"}}, "url": "https://github.com/apache/kafka/commit/b86e907630ce332e5577f20545cc06de8f4f43bf", "committedDate": "2020-12-01T19:35:50Z", "message": "MINOR: add test for repartition/source-topic/changelog optimization\n\nIf topology optimization is enabled, KafkaStreams does not create store\nchangelog topics but re-uses source input topics if possible. However,\nthis optimization should not be applied to internal repartition topics,\nbecause those are actively purged."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTQ5MjI3", "url": "https://github.com/apache/kafka/pull/9668#pullrequestreview-544549227", "createdAt": "2020-12-03T23:34:43Z", "commit": {"oid": "b86e907630ce332e5577f20545cc06de8f4f43bf"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzozNDo0M1rOH-6CcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzozNDo0M1rOH-6CcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyNDY1Ng==", "bodyText": "This should still be called shouldNotReuseSourceTopicAsChangelogsByDefault,  right?", "url": "https://github.com/apache/kafka/pull/9668#discussion_r535724656", "createdAt": "2020-12-03T23:34:43Z", "author": {"login": "ableegoldman"}, "path": "streams/src/test/java/org/apache/kafka/streams/StreamsBuilderTest.java", "diffHunk": "@@ -463,7 +463,36 @@ public void shouldReuseSourceTopicAsChangelogsWithOptimization20() {\n     }\n \n     @Test\n-    public void shouldNotReuseSourceTopicAsChangelogsByDefault() {\n+    public void shouldNotReuseRepartitionTopicAsChangelogs() {\n+        final String topic = \"topic\";\n+        builder.<Long, String>stream(topic).repartition().toTable(Materialized.as(\"store\"));\n+        final Properties props = StreamsTestUtils.getStreamsConfig(\"appId\");\n+        props.put(StreamsConfig.TOPOLOGY_OPTIMIZATION_CONFIG, StreamsConfig.OPTIMIZE);\n+        final Topology topology = builder.build(props);\n+\n+        final InternalTopologyBuilder internalTopologyBuilder = TopologyWrapper.getInternalTopologyBuilder(topology);\n+        internalTopologyBuilder.rewriteTopology(new StreamsConfig(props));\n+\n+        assertThat(\n+            internalTopologyBuilder.buildTopology().storeToChangelogTopic(),\n+            equalTo(Collections.singletonMap(\"store\", \"appId-store-changelog\"))\n+        );\n+        assertThat(\n+            internalTopologyBuilder.stateStores().keySet(),\n+            equalTo(Collections.singleton(\"store\"))\n+        );\n+        assertThat(\n+            internalTopologyBuilder.stateStores().get(\"store\").loggingEnabled(),\n+            equalTo(true)\n+        );\n+        assertThat(\n+            internalTopologyBuilder.topicGroups().get(1).stateChangelogTopics.keySet(),\n+            equalTo(Collections.singleton(\"appId-store-changelog\"))\n+        );\n+    }\n+\n+    @Test\n+    public void shouldNotReuseRepartitionTopicAsChangelogsByDefault() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b86e907630ce332e5577f20545cc06de8f4f43bf"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f296213879b0f532b8a405fc1877032df9c98cf7", "author": {"user": {"login": "mjsax", "name": "Matthias J. Sax"}}, "url": "https://github.com/apache/kafka/commit/f296213879b0f532b8a405fc1877032df9c98cf7", "committedDate": "2020-12-04T17:23:49Z", "message": "Github comments: update test name"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2500, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}