{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMTAzMjQw", "number": 8463, "title": "HOTFIX: need to cleanup any tasks closed in TaskManager", "bodyText": "We were hitting an IllegalStateException: There is already a changelog registered for ... in trunk-eos due to failing to call TaskManager#cleanup on unrevoekd tasks that we end up closing in handleAssignment after failing to batch commit", "createdAt": "2020-04-10T23:25:25Z", "url": "https://github.com/apache/kafka/pull/8463", "merged": true, "mergeCommit": {"oid": "37f20c6924bc2b2d861508cdb79b78152cc01b60"}, "closed": true, "closedAt": "2020-04-13T22:01:20Z", "author": {"login": "ableegoldman"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWJQ7TgH2gAyNDAyMTAzMjQwOmU1Mjk5NzdiYWI0YjY1YTdkM2RkMzcxOTQxNWUyYmRlMzRmNjZmODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcW_gZIgFqTM5MTg4NzgwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e529977bab4b65a7d3dd3719415e2bde34f66f88", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/e529977bab4b65a7d3dd3719415e2bde34f66f88", "committedDate": "2020-04-10T04:20:03Z", "message": "cleanup tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e50b021c4a0b43a53875aa81510d65f686957753", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/e50b021c4a0b43a53875aa81510d65f686957753", "committedDate": "2020-04-10T04:26:04Z", "message": "log level is too info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "504cc6354caead42848bbe4cb6337b007e07f184", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/504cc6354caead42848bbe4cb6337b007e07f184", "committedDate": "2020-04-10T22:03:08Z", "message": "revert excetion type change for now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60b09bf79beaaf9aa650e8456708afb738828ae3", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/60b09bf79beaaf9aa650e8456708afb738828ae3", "committedDate": "2020-04-10T22:35:03Z", "message": "need to call cleanupTask before calling closeClean or closeDirty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "239e20ebcc371fde3e7c218335bac655bcf08c4c", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/239e20ebcc371fde3e7c218335bac655bcf08c4c", "committedDate": "2020-04-10T22:55:17Z", "message": "add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3902dd37fdabf34929a38cddb16adcf3b162dd31", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/3902dd37fdabf34929a38cddb16adcf3b162dd31", "committedDate": "2020-04-10T23:22:16Z", "message": "add new test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzA2MTIy", "url": "https://github.com/apache/kafka/pull/8463#pullrequestreview-391706122", "createdAt": "2020-04-10T23:26:42Z", "commit": {"oid": "3902dd37fdabf34929a38cddb16adcf3b162dd31"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMzoyNjo0MlrOGEIMsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMzoyNjo0MlrOGEIMsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk4MTgwOA==", "bodyText": "These were absolutely spamming the logs, and don't seem like general-interest \"info\", so I demoted them to debug. But if they were set to info for a good reason I'm happy to revert", "url": "https://github.com/apache/kafka/pull/8463#discussion_r406981808", "createdAt": "2020-04-10T23:26:42Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -317,7 +317,7 @@ public void prepareCommit() {\n                 stateMgr.flush();\n                 recordCollector.flush();\n \n-                log.info(\"Prepared task for committing\");\n+                log.debug(\"Prepared task for committing\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3902dd37fdabf34929a38cddb16adcf3b162dd31"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzA2Nzgw", "url": "https://github.com/apache/kafka/pull/8463#pullrequestreview-391706780", "createdAt": "2020-04-10T23:29:57Z", "commit": {"oid": "3902dd37fdabf34929a38cddb16adcf3b162dd31"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMzoyOTo1N1rOGEIPdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMzoyOTo1N1rOGEIPdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk4MjUxOQ==", "bodyText": "This was the main bug, we try to batch commit active tasks above and deal with failure by adding to this dirtyTasks set. But we didn't actually do all of the required cleanup for a removed task in this loop here, specifically we did not ever call cleanupTask on tasks that were added to dirtyTasks from the additionalTasksForCommitting set on line 250", "url": "https://github.com/apache/kafka/pull/8463#discussion_r406982519", "createdAt": "2020-04-10T23:29:57Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -258,23 +256,24 @@ public void handleAssignment(final Map<TaskId, Set<TopicPartition>> activeTasks,\n \n         for (final Map.Entry<Task, Map<TopicPartition, Long>> taskAndCheckpoint : checkpointPerTask.entrySet()) {\n             final Task task = taskAndCheckpoint.getKey();\n+            final Map<TopicPartition, Long> checkpoint = taskAndCheckpoint.getValue();\n+\n             try {\n-                task.closeClean(checkpointPerTask.get(task));\n+                completeTaskCloseClean(task, checkpoint);\n+                cleanUpTaskProducer(task, taskCloseExceptions);\n+                tasks.remove(task.id());\n             } catch (final RuntimeException e) {\n                 final String uncleanMessage = String.format(\"Failed to close task %s cleanly. Attempting to close remaining tasks before re-throwing:\", task.id());\n                 log.error(uncleanMessage, e);\n                 taskCloseExceptions.put(task.id(), e);\n                 // We've already recorded the exception (which is the point of clean).\n                 // Now, we should go ahead and complete the close because a half-closed task is no good to anyone.\n-                task.closeDirty();\n-            } finally {\n-                cleanUpTaskProducer(task, taskCloseExceptions);\n-                tasks.remove(task.id());\n+                dirtyTasks.add(task);\n             }\n         }\n \n         for (final Task task : dirtyTasks) {\n-            task.closeDirty();\n+            closeTaskDirty(task);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3902dd37fdabf34929a38cddb16adcf3b162dd31"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzA3MTEw", "url": "https://github.com/apache/kafka/pull/8463#pullrequestreview-391707110", "createdAt": "2020-04-10T23:31:50Z", "commit": {"oid": "3902dd37fdabf34929a38cddb16adcf3b162dd31"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMzozMTo1MFrOGEIQtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMzozMTo1MFrOGEIQtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk4MjgzOA==", "bodyText": "Verified that this test does fail on verify(changelogReader) without this fix", "url": "https://github.com/apache/kafka/pull/8463#discussion_r406982838", "createdAt": "2020-04-10T23:31:50Z", "author": {"login": "ableegoldman"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/TaskManagerTest.java", "diffHunk": "@@ -885,6 +885,57 @@ public void shouldNotCommitOnHandleAssignmentIfOnlyStandbyTaskClosed() {\n         assertThat(task10.commitPrepared, is(false));\n     }\n \n+    @Test\n+    public void shouldCleanupAnyTasksClosedAsDirtyAfterCommitException() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3902dd37fdabf34929a38cddb16adcf3b162dd31"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f8b15773b7d1eb96e8804a90e29cb27d390f6b3", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/5f8b15773b7d1eb96e8804a90e29cb27d390f6b3", "committedDate": "2020-04-10T23:32:46Z", "message": "remove unnecessary test changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxODg3ODA4", "url": "https://github.com/apache/kafka/pull/8463#pullrequestreview-391887808", "createdAt": "2020-04-12T19:21:09Z", "commit": {"oid": "5f8b15773b7d1eb96e8804a90e29cb27d390f6b3"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQxOToyMTowOVrOGEYCig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQxOTozMDozMlrOGEYGpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI0MTM1NA==", "bodyText": "I think at TaskManager we already log at INFO level for time-based and user-based committing, so I'm fine with this.", "url": "https://github.com/apache/kafka/pull/8463#discussion_r407241354", "createdAt": "2020-04-12T19:21:09Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -317,7 +317,7 @@ public void prepareCommit() {\n                 stateMgr.flush();\n                 recordCollector.flush();\n \n-                log.info(\"Prepared task for committing\");\n+                log.debug(\"Prepared task for committing\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk4MTgwOA=="}, "originalCommit": {"oid": "3902dd37fdabf34929a38cddb16adcf3b162dd31"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI0MTkxOA==", "bodyText": "LGTM.", "url": "https://github.com/apache/kafka/pull/8463#discussion_r407241918", "createdAt": "2020-04-12T19:26:05Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -258,23 +256,24 @@ public void handleAssignment(final Map<TaskId, Set<TopicPartition>> activeTasks,\n \n         for (final Map.Entry<Task, Map<TopicPartition, Long>> taskAndCheckpoint : checkpointPerTask.entrySet()) {\n             final Task task = taskAndCheckpoint.getKey();\n+            final Map<TopicPartition, Long> checkpoint = taskAndCheckpoint.getValue();\n+\n             try {\n-                task.closeClean(checkpointPerTask.get(task));\n+                completeTaskCloseClean(task, checkpoint);\n+                cleanUpTaskProducer(task, taskCloseExceptions);\n+                tasks.remove(task.id());\n             } catch (final RuntimeException e) {\n                 final String uncleanMessage = String.format(\"Failed to close task %s cleanly. Attempting to close remaining tasks before re-throwing:\", task.id());\n                 log.error(uncleanMessage, e);\n                 taskCloseExceptions.put(task.id(), e);\n                 // We've already recorded the exception (which is the point of clean).\n                 // Now, we should go ahead and complete the close because a half-closed task is no good to anyone.\n-                task.closeDirty();\n-            } finally {\n-                cleanUpTaskProducer(task, taskCloseExceptions);\n-                tasks.remove(task.id());\n+                dirtyTasks.add(task);\n             }\n         }\n \n         for (final Task task : dirtyTasks) {\n-            task.closeDirty();\n+            closeTaskDirty(task);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk4MjUxOQ=="}, "originalCommit": {"oid": "3902dd37fdabf34929a38cddb16adcf3b162dd31"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI0MjA5OA==", "bodyText": "Could we move cleanUpTaskProducer into completeTaskCloseClean and closeTaskDirty respectively?", "url": "https://github.com/apache/kafka/pull/8463#discussion_r407242098", "createdAt": "2020-04-12T19:27:50Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -258,23 +256,24 @@ public void handleAssignment(final Map<TaskId, Set<TopicPartition>> activeTasks,\n \n         for (final Map.Entry<Task, Map<TopicPartition, Long>> taskAndCheckpoint : checkpointPerTask.entrySet()) {\n             final Task task = taskAndCheckpoint.getKey();\n+            final Map<TopicPartition, Long> checkpoint = taskAndCheckpoint.getValue();\n+\n             try {\n-                task.closeClean(checkpointPerTask.get(task));\n+                completeTaskCloseClean(task, checkpoint);\n+                cleanUpTaskProducer(task, taskCloseExceptions);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f8b15773b7d1eb96e8804a90e29cb27d390f6b3"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI0MjM0Nw==", "bodyText": "Should we also close producers for the lost tasks as well?", "url": "https://github.com/apache/kafka/pull/8463#discussion_r407242347", "createdAt": "2020-04-12T19:29:54Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -464,9 +463,7 @@ void handleLostAll() {\n             // Even though we've apparently dropped out of the group, we can continue safely to maintain our\n             // standby tasks while we rejoin.\n             if (task.isActive()) {\n-                cleanupTask(task);\n-                task.prepareCloseDirty();\n-                task.closeDirty();\n+                closeTaskDirty(task);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f8b15773b7d1eb96e8804a90e29cb27d390f6b3"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI0MjQwNQ==", "bodyText": "Ditto, should we close producers as well?", "url": "https://github.com/apache/kafka/pull/8463#discussion_r407242405", "createdAt": "2020-04-12T19:30:32Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -623,16 +630,13 @@ void shutdown(final boolean clean) {\n                     }\n                 } catch (final TaskMigratedException e) {\n                     // just ignore the exception as it doesn't matter during shutdown\n-                    task.prepareCloseDirty();\n-                    task.closeDirty();\n+                    closeTaskDirty(task);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f8b15773b7d1eb96e8804a90e29cb27d390f6b3"}, "originalPosition": 116}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1460, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}