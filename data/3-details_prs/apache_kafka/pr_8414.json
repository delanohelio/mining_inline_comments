{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3OTIyODM5", "number": 8414, "title": "KAFKA-8410: Part 1: processor context bounds", "bodyText": "Add type bounds to the ProcessorContext, which bounds the types that can be forwarded to child nodes.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-04-03T04:01:53Z", "url": "https://github.com/apache/kafka/pull/8414", "merged": true, "mergeCommit": {"oid": "29e08fd2c2d3349ba5cbd8fe5a9d35a0cea02b85"}, "closed": true, "closedAt": "2020-04-07T18:11:03Z", "author": {"login": "vvcephei"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcT5AG6gFqTM4NjkyMzI0NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVLb1ZgFqTM4ODc3MjI0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2OTIzMjQ1", "url": "https://github.com/apache/kafka/pull/8414#pullrequestreview-386923245", "createdAt": "2020-04-03T04:02:24Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNDowMjoyNVrOGAEXIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNDoxNTowMVrOGAEh2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcyNDY0Mw==", "bodyText": "In the KIP, I proposed to leave the existing Processor and Transformer init methods with a raw ProcessorContext argument. This will give all users a rawtypes warning with no recourse. Instead, in this PR, I'm adding <Object, Object> bounds instead. This at least allows users to also add the generics if they desire, while not changing the practical bounds at all. If this proves acceptable, I'll update the KIP.", "url": "https://github.com/apache/kafka/pull/8414#discussion_r402724643", "createdAt": "2020-04-03T04:02:25Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/Transformer.java", "diffHunk": "@@ -64,7 +64,7 @@\n      *\n      * @param context the context\n      */\n-    void init(final ProcessorContext context);\n+    void init(final ProcessorContext<Object, Object> context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcyNDczNw==", "bodyText": "As proposed, Void types indicate that you can't forward anything.", "url": "https://github.com/apache/kafka/pull/8414#discussion_r402724737", "createdAt": "2020-04-03T04:02:48Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/ValueTransformer.java", "diffHunk": "@@ -69,7 +69,7 @@\n      * @throws IllegalStateException If store gets registered after initialization is already finished\n      * @throws StreamsException if the store's change log does not contain the partition\n      */\n-    void init(final ProcessorContext context);\n+    void init(final ProcessorContext<Void, Void> context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcyNTExOA==", "bodyText": "Even in this first PR, we expose some bugs. In this case, ValueGetters and ValueTransformers shouldn't be able to forward anything, but nothing previously prevented them from doing it. Now, the new bounds force us to wire in a context that has Void bounds.", "url": "https://github.com/apache/kafka/pull/8414#discussion_r402725118", "createdAt": "2020-04-03T04:04:27Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KStreamKTableJoinProcessor.java", "diffHunk": "@@ -49,11 +50,11 @@\n     }\n \n     @Override\n-    public void init(final ProcessorContext context) {\n+    public void init(final ProcessorContext<Object, Object> context) {\n         super.init(context);\n         metrics = (StreamsMetricsImpl) context.metrics();\n         droppedRecordsSensor = droppedRecordsSensorOrSkippedRecordsSensor(Thread.currentThread().getName(), context.taskId().toString(), metrics);\n-        valueGetter.init(context);\n+        valueGetter.init(new ForwardingDisabledProcessorContext(context));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcyNjM3NQ==", "bodyText": "You'll notice that sometimes, I use wildcard (?) generic parameter bounds and other times, Object. The reason is a little subtle. It's because the InternalProcessorContext has a method that takes a ProcessorNode argument. We want to let (ourselves) pass in any ProcessorNode, not just an exactly <Object, Object> one. But for all the ProcessorContext references, we pass the context in, and we have to do it untyped anyway, so the type bound doesn't matter. It results in less mind-bending code for users to declare types using the Object,Object bounds, and it makes no difference to them, as far as the calls to forward, since the parameterized types are only upper bounds anyway.\nPunchline, it doesn't really matter, but there are considerations that led me to use ? in some cases and Object in others.", "url": "https://github.com/apache/kafka/pull/8414#discussion_r402726375", "createdAt": "2020-04-03T04:10:20Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/SessionCacheFlushListener.java", "diffHunk": "@@ -24,11 +24,11 @@\n import org.apache.kafka.streams.state.internals.CacheFlushListener;\n \n class SessionCacheFlushListener<K, V> implements CacheFlushListener<Windowed<K>, V> {\n-    private final InternalProcessorContext context;\n-    private final ProcessorNode myNode;\n+    private final InternalProcessorContext<Object, Object> context;\n+    private final ProcessorNode<?, ?> myNode;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcyNjk3Ng==", "bodyText": "Not part of the KIP, and no difference whatsoever to the public API, but (unlike the javadoc I added), declaring that a method throws an unchecked exception is a totally ineffective way to inform users that it might get thrown (since they'll only ever see the declaraction if they read the source of this file). At least, the javadoc will show up in their IDE.", "url": "https://github.com/apache/kafka/pull/8414#discussion_r402726976", "createdAt": "2020-04-03T04:13:20Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/ProcessorContext.java", "diffHunk": "@@ -158,11 +161,12 @@ Cancellable schedule(final long intervalMs,\n      * @param interval the time interval between punctuations (supported minimum is 1 millisecond)\n      * @param type one of: {@link PunctuationType#STREAM_TIME}, {@link PunctuationType#WALL_CLOCK_TIME}\n      * @param callback a function consuming timestamps representing the current stream or system time\n+     * @throws IllegalArgumentException if the interval is under 1 millisecond\n      * @return a handle allowing cancellation of the punctuation schedule established by this method\n      */\n     Cancellable schedule(final Duration interval,\n                          final PunctuationType type,\n-                         final Punctuator callback) throws IllegalArgumentException;\n+                         final Punctuator callback);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcyNzM4NA==", "bodyText": "This test doesn't even compile now, because the compiler checks all these constraints for us. There's no way to express the things we wanted to forbid.", "url": "https://github.com/apache/kafka/pull/8414#discussion_r402727384", "createdAt": "2020-04-03T04:15:01Z", "author": {"login": "vvcephei"}, "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/ForwardingDisabledProcessorContextTest.java", "diffHunk": "@@ -1,61 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements. See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- *\n- *    http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.kafka.streams.processor.internals;\n-\n-import org.apache.kafka.streams.errors.StreamsException;\n-import org.apache.kafka.streams.processor.ProcessorContext;\n-import org.apache.kafka.streams.processor.To;\n-import org.easymock.EasyMockRunner;\n-import org.easymock.Mock;\n-import org.easymock.MockType;\n-import org.junit.Before;\n-import org.junit.Test;\n-import org.junit.runner.RunWith;\n-\n-@RunWith(EasyMockRunner.class)\n-public class ForwardingDisabledProcessorContextTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bcfe92d341693812f8543fe5e7661ce4d9190cd", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/4bcfe92d341693812f8543fe5e7661ce4d9190cd", "committedDate": "2020-04-03T20:30:02Z", "message": "KAKFA-8410: Part 1: Add bounds to ProcessorContext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a680111fba7f3517afa248a9c718cb348e8c480", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/2a680111fba7f3517afa248a9c718cb348e8c480", "committedDate": "2020-04-03T20:30:02Z", "message": "fix scala build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NjU4NDY0", "url": "https://github.com/apache/kafka/pull/8414#pullrequestreview-387658464", "createdAt": "2020-04-04T02:30:04Z", "commit": {"oid": "2a680111fba7f3517afa248a9c718cb348e8c480"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQwMjozMDowNFrOGAuUMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQwMjozMDowNFrOGAuUMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQxMjAxNg==", "bodyText": "nit: fix indention (similar below)", "url": "https://github.com/apache/kafka/pull/8414#discussion_r403412016", "createdAt": "2020-04-04T02:30:04Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorContextImpl.java", "diffHunk": "@@ -126,15 +126,15 @@ public StateStore getStateStore(final String name) {\n     }\n \n     @Override\n-    public <K, V> void forward(final K key,\n-                               final V value) {\n+    public <K1 extends K, V1 extends V> void forward(final K1 key,\n+                               final V1 value) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a680111fba7f3517afa248a9c718cb348e8c480"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0eb647f05c2b3fa29fbd9ecb88b6fc72e274f9af", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/0eb647f05c2b3fa29fbd9ecb88b6fc72e274f9af", "committedDate": "2020-04-06T22:03:51Z", "message": "formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzcyMjQ2", "url": "https://github.com/apache/kafka/pull/8414#pullrequestreview-388772246", "createdAt": "2020-04-07T04:17:51Z", "commit": {"oid": "0eb647f05c2b3fa29fbd9ecb88b6fc72e274f9af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 70, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}