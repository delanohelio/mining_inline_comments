{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MDUyMTg1", "number": 8145, "title": "KAFKA-9581: Remove rebalance exception withholding", "bodyText": "The rebalance exception withholding is no longer necessary as we have better mechanism for catching and wrapping these exceptions. Throw them directly should be fine and simplify our current error handling.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-02-21T00:58:30Z", "url": "https://github.com/apache/kafka/pull/8145", "merged": true, "mergeCommit": {"oid": "1de9981fe38f3e46dcc98cd8b5d3378f7ce0f6a8"}, "closed": true, "closedAt": "2020-02-24T16:49:57Z", "author": {"login": "abbccdda"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGVXXEgBqjMwNTg5MzA2NTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcG9DK7ABqjMwNjMwNDg0NTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNzM5ODU5", "url": "https://github.com/apache/kafka/pull/8145#pullrequestreview-362739859", "createdAt": "2020-02-21T16:08:17Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNjowODoxOFrOFs8LbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNjoxMToxN1rOFs8R3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY2NzYyOQ==", "bodyText": "Do we still need this here? When we call unsubscribe later, it'll invoke:\n            if (generation() != Generation.NO_GENERATION) {\n                e = invokePartitionsRevoked(droppedPartitions);\n            } else {\n                e = invokePartitionsLost(droppedPartitions);\n            }\n\nIt seems like it might be better to just let the consumer manage the task lifecycle, since we may not have lost all the tasks.\nWDYT about removing this line and just setting the needRebalance flag?", "url": "https://github.com/apache/kafka/pull/8145#discussion_r382667629", "createdAt": "2020-02-21T16:08:18Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -761,7 +761,7 @@ private void runLoop() {\n                     \"Will close out all assigned tasks and rejoin the consumer group.\");\n \n                 taskManager.handleLostAll();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY2OTI3Ng==", "bodyText": "Side remark: It's really not great to catch Throwable and reinterpret it, since it encompasses both Error and Exception. I.e., We might catch an OutOfMemoryError and wrap it as a TaskMigratedException, which would obviously be bad.\nWhat do you think about changing these on the side to just catch RuntimeException or Exception?", "url": "https://github.com/apache/kafka/pull/8145#discussion_r382669276", "createdAt": "2020-02-21T16:11:17Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsRebalanceListener.java", "diffHunk": "@@ -71,12 +72,7 @@ public void onPartitionsRevoked(final Collection<TopicPartition> partitions) {\n             try {\n                 taskManager.handleRevocation(partitions);\n             } catch (final Throwable t) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODMwNzQ5", "url": "https://github.com/apache/kafka/pull/8145#pullrequestreview-362830749", "createdAt": "2020-02-21T18:31:58Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODozMTo1OFrOFtAhAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODozNjoyNFrOFtAojA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczODY5MQ==", "bodyText": "@vvcephei @abbccdda there happen to have a discussion that validates this :) https://github.com/apache/kafka/pull/8087/files#r382735615", "url": "https://github.com/apache/kafka/pull/8145#discussion_r382738691", "createdAt": "2020-02-21T18:31:58Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -761,7 +761,7 @@ private void runLoop() {\n                     \"Will close out all assigned tasks and rejoin the consumer group.\");\n \n                 taskManager.handleLostAll();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY2NzYyOQ=="}, "originalCommit": null, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczOTUzNQ==", "bodyText": "Actually I think we should not interpret everything as TaskMigrated --> if it is due to a recoverable fenced issue e.g. the thrown exception would already be a TaskMigratedException. So I think we should not capture any here instead.", "url": "https://github.com/apache/kafka/pull/8145#discussion_r382739535", "createdAt": "2020-02-21T18:33:55Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsRebalanceListener.java", "diffHunk": "@@ -71,12 +72,7 @@ public void onPartitionsRevoked(final Collection<TopicPartition> partitions) {\n             try {\n                 taskManager.handleRevocation(partitions);\n             } catch (final Throwable t) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY2OTI3Ng=="}, "originalCommit": null, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczOTg5NQ==", "bodyText": "Why not trigger rebalance immediately but defer it to the next iteration? Is it to make sure we capture any exceptions from the enforceRebalance? I thought this function should never throw any new exception since we already close all tasks as lost.", "url": "https://github.com/apache/kafka/pull/8145#discussion_r382739895", "createdAt": "2020-02-21T18:34:44Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -761,7 +761,7 @@ private void runLoop() {\n                     \"Will close out all assigned tasks and rejoin the consumer group.\");\n \n                 taskManager.handleLostAll();\n-                enforceRebalance();\n+                needRebalance = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc0MDYyMA==", "bodyText": "Also cc @ableegoldman who's working on the new consumer API to replace enforceRebalance.", "url": "https://github.com/apache/kafka/pull/8145#discussion_r382740620", "createdAt": "2020-02-21T18:36:24Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -761,7 +761,7 @@ private void runLoop() {\n                     \"Will close out all assigned tasks and rejoin the consumer group.\");\n \n                 taskManager.handleLostAll();\n-                enforceRebalance();\n+                needRebalance = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczOTg5NQ=="}, "originalCommit": null, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTc4NjYy", "url": "https://github.com/apache/kafka/pull/8145#pullrequestreview-362978662", "createdAt": "2020-02-21T23:41:16Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTk0MzAw", "url": "https://github.com/apache/kafka/pull/8145#pullrequestreview-362994300", "createdAt": "2020-02-22T00:59:45Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwMDo1OTo0NVrOFtIfJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwMDo1OTo0NVrOFtIfJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2OTI4Ng==", "bodyText": "Hmm.. do we want to capture all Exceptions as TaskMigratedException? I actually think it's okay to not capture anything here since only StreamsException or TaskMigratedException would be thrown here.", "url": "https://github.com/apache/kafka/pull/8145#discussion_r382869286", "createdAt": "2020-02-22T00:59:45Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsRebalanceListener.java", "diffHunk": "@@ -97,16 +91,10 @@ public void onPartitionsLost(final Collection<TopicPartition> partitions) {\n         try {\n             // close all active tasks as lost but don't try to commit offsets as we no longer own them\n             taskManager.handleLostAll();\n-        } catch (final Throwable t) {\n-            log.error(\n-                \"Error caught during partitions lost, \" +\n-                    \"will abort the current process and re-throw at the end of rebalance: \",\n-                t\n-            );\n-            streamThread.setRebalanceException(t);\n+        } catch (final Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1cb2999ddc13b30430e354aebfde7d869d125f9", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/f1cb2999ddc13b30430e354aebfde7d869d125f9", "committedDate": "2020-02-22T19:03:20Z", "message": "remove rebalance exception withholding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9981b04f2a1befb44bb938276eb06f91ef95da8a", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/9981b04f2a1befb44bb938276eb06f91ef95da8a", "committedDate": "2020-02-22T19:03:21Z", "message": "Wrap as task migrated exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef2b264e6a249750238e6494e4dcbcc9dc97fabe", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/ef2b264e6a249750238e6494e4dcbcc9dc97fabe", "committedDate": "2020-02-22T19:03:21Z", "message": "address John comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24b8945259d2b1dbd5badf8bea9721e8d2e85008", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/24b8945259d2b1dbd5badf8bea9721e8d2e85008", "committedDate": "2020-02-22T19:03:21Z", "message": "address Guozhang's comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "793bf7495e478eb8786b5c371aa576e18181c439", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/793bf7495e478eb8786b5c371aa576e18181c439", "committedDate": "2020-02-22T19:03:21Z", "message": "unit test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaf6f131b49adff9d8faa1c37f993dd13a03d50d", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/aaf6f131b49adff9d8faa1c37f993dd13a03d50d", "committedDate": "2020-02-22T23:37:06Z", "message": "no catch for partition lost"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "aaf6f131b49adff9d8faa1c37f993dd13a03d50d", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/aaf6f131b49adff9d8faa1c37f993dd13a03d50d", "committedDate": "2020-02-22T23:37:06Z", "message": "no catch for partition lost"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1512, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}