{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNTc3NTI1", "number": 8047, "title": "MINOR: Add timer for update limit offsets", "bodyText": "Instead of always try to update committed offset limits as long as there are buffered records for standby tasks, we leverage on the commit interval to reduce our consumer.committed frequency.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-02-05T20:46:56Z", "url": "https://github.com/apache/kafka/pull/8047", "merged": true, "mergeCommit": {"oid": "5380938f8bb0cc2dcaab187e381f369361dcbf79"}, "closed": true, "closedAt": "2020-02-06T23:28:19Z", "author": {"login": "guozhangwang"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBcYeggH2gAyMzcxNTc3NTI1OjNiZmQ4N2MzNzAzMmIxYTZiZGQzNDNlMmVlMTM1ZDBiM2JmMzNiNmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBzUODgH2gAyMzcxNTc3NTI1OjI2ZDg2OGE0NDBhNmQ4MzM3MjE5NWE2N2M4YTRlNjhlZjViNGVjZTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f", "committedDate": "2020-02-05T20:44:05Z", "message": "add timer for update limit offsets"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MDI4ODk2", "url": "https://github.com/apache/kafka/pull/8047#pullrequestreview-354028896", "createdAt": "2020-02-05T20:47:15Z", "commit": {"oid": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMDo0NzoxNVrOFmGoRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMDo1MToxNlrOFmGvkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ5ODgyMA==", "bodyText": "This function is only triggered internally and can be removed from interface.", "url": "https://github.com/apache/kafka/pull/8047#discussion_r375498820", "createdAt": "2020-02-05T20:47:15Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ChangelogReader.java", "diffHunk": "@@ -30,11 +30,6 @@\n      */\n     void restore();\n \n-    /**\n-     * Update offset limit of a given changelog partition\n-     */\n-    void updateLimitOffsets();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ5OTQwNw==", "bodyText": "Following the suggestion from KAFKA-9113 PR, by @ableegoldman we consolidate the limit-offset with end-offset.", "url": "https://github.com/apache/kafka/pull/8047#discussion_r375499407", "createdAt": "2020-02-05T20:48:32Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -99,11 +100,18 @@\n \n         // only for active restoring tasks (for standby changelog it is null)\n         // NOTE we do not book keep the current offset since we leverage state manager as its source of truth\n-        private Long restoreEndOffset;\n \n-        // only for standby tasks that use source topics as changelogs (for active it is null);\n-        // if it is not on source topics it is also null\n-        private Long restoreLimitOffset;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ5OTY1OA==", "bodyText": "If user set this value to infinity we should still have a non-inf value to take care of the manual commit.", "url": "https://github.com/apache/kafka/pull/8047#discussion_r375499658", "createdAt": "2020-02-05T20:49:06Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -208,10 +215,12 @@ public StoreChangelogReader(final StreamsConfig config,\n         // NOTE for restoring active and updating standby we may prefer different poll time\n         // in order to make sure we call the main consumer#poll in time.\n         // TODO: once both of these are moved to a separate thread this may no longer be a concern\n-        this.pollTime = Duration.ofMillis(config.getLong(StreamsConfig.POLL_MS_CONFIG));\n+        this.pollTimeMs = Duration.ofMillis(config.getLong(StreamsConfig.POLL_MS_CONFIG));\n+        this.updateOffsetIntervalMs = config.getLong(StreamsConfig.COMMIT_INTERVAL_MS_CONFIG) == Long.MAX_VALUE ?\n+            DEFAULT_OFFSET_UPDATE_MS : config.getLong(StreamsConfig.COMMIT_INTERVAL_MS_CONFIG);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUwMDY4OQ==", "bodyText": "If there's nothing to be updated or timed out, we do not update the timer.", "url": "https://github.com/apache/kafka/pull/8047#discussion_r375500689", "createdAt": "2020-02-05T20:51:16Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -517,16 +520,21 @@ private void restoreChangelog(final ChangelogMetadata changelogMetadata) {\n         if (partitions.isEmpty())\n             return Collections.emptyMap();\n \n+        final Map<TopicPartition, Long> committedOffsets;\n         try {\n             // those do not have a committed offset would default to 0\n-            return mainConsumer.committed(partitions).entrySet().stream()\n+            committedOffsets =  mainConsumer.committed(partitions).entrySet().stream()\n                 .collect(Collectors.toMap(Map.Entry::getKey, e -> e.getValue() == null ? 0L : e.getValue().offset()));\n         } catch (final TimeoutException e) {\n             // if it timed out we just retry next time.\n             return Collections.emptyMap();\n         } catch (final KafkaException e) {\n             throw new StreamsException(String.format(\"Failed to retrieve end offsets for %s\", partitions), e);\n         }\n+\n+        lastUpdateOffsetTime = time.milliseconds();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f"}, "originalPosition": 216}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MTk4MTAw", "url": "https://github.com/apache/kafka/pull/8047#pullrequestreview-354198100", "createdAt": "2020-02-06T04:45:45Z", "commit": {"oid": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNDo0NTo0NVrOFmPJ4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNDo0NTo0NVrOFmPJ4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYzODQ5Ng==", "bodyText": "the type of pollTimeMs is Duration. It seems to me that the \"ms\" is a bit redundant.", "url": "https://github.com/apache/kafka/pull/8047#discussion_r375638496", "createdAt": "2020-02-06T04:45:45Z", "author": {"login": "chia7712"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -208,10 +215,12 @@ public StoreChangelogReader(final StreamsConfig config,\n         // NOTE for restoring active and updating standby we may prefer different poll time\n         // in order to make sure we call the main consumer#poll in time.\n         // TODO: once both of these are moved to a separate thread this may no longer be a concern\n-        this.pollTime = Duration.ofMillis(config.getLong(StreamsConfig.POLL_MS_CONFIG));\n+        this.pollTimeMs = Duration.ofMillis(config.getLong(StreamsConfig.POLL_MS_CONFIG));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f"}, "originalPosition": 111}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7493782dc28e02a132823b236ea275b066f058ac", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/7493782dc28e02a132823b236ea275b066f058ac", "committedDate": "2020-02-06T19:54:05Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KMinor-changelog-reader-limit-offset-update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26d868a440a6d83372195a67c8a4e68ef5b4ece8", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/26d868a440a6d83372195a67c8a4e68ef5b4ece8", "committedDate": "2020-02-06T23:27:15Z", "message": "address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1749, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}