{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4ODI1NDIw", "number": 7887, "title": "KAFKA-9360: Fix heartbeat and checkpoint emission can not turn off", "bodyText": "emit.heartbeats.enabled and emit.checkpoints.enabled are supposed to\nbe the knobs to control if the heartbeat message or checkpoint message\nwill be sent or not to the topics respectively. In our experiments,\nsetting them to false will not suspend the activity in their SourceTasks,\ne.g. MirrorHeartbeatTask, MirrorCheckpointTask.\nThe observations are, when setting those knobs to false, huge volume of\nSourceRecord are being sent without interval, causing significantly high\nCPU usage of MirrorMaker 2 instance, GC time and congesting the single partition of\nthe heartbeat topic and checkpoint topic.\n\n\nThe proposed fix in the following PR is to (1) explicitly check if interval\nis set to negative (e.g. -1), when the emit.heartbeats.enabled or\nemit.checkpoints.enabled is off. (2) if interval is indeed set to negative,\nput the thread in sleep mode for a while (e.g. 5 seconds) and return null, in order\nto prevent it from (1) hogging the cpu, (2) sending heartbeat or checkpoint messages\nto Kafka topics\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-01-02T23:13:53Z", "url": "https://github.com/apache/kafka/pull/7887", "merged": true, "mergeCommit": {"oid": "f217752bed75a79d9bfdf9195721d0b05cebbf79"}, "closed": true, "closedAt": "2020-01-30T10:43:34Z", "author": {"login": "ning2008wisc"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3yVHigFqTMzODg4MTM5Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_YGpCAFqTM1MDcyNTA4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4ODgxMzk3", "url": "https://github.com/apache/kafka/pull/7887#pullrequestreview-338881397", "createdAt": "2020-01-06T20:39:05Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyOTQyNTI2", "url": "https://github.com/apache/kafka/pull/7887#pullrequestreview-342942526", "createdAt": "2020-01-15T01:26:16Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4Nzc5NzMw", "url": "https://github.com/apache/kafka/pull/7887#pullrequestreview-348779730", "createdAt": "2020-01-27T16:04:15Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjowNDoxNVrOFiIJ5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjoxMjowN1rOFiIc7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyOTUwOQ==", "bodyText": "Should we check for !config.enabled() here too?", "url": "https://github.com/apache/kafka/pull/7887#discussion_r371329509", "createdAt": "2020-01-27T16:04:15Z", "author": {"login": "mimaison"}, "path": "connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorHeartbeatConnector.java", "diffHunk": "@@ -50,6 +50,10 @@ public void stop() {\n \n     @Override\n     public List<Map<String, String>> taskConfigs(int maxTasks) {\n+        // if emitting heartbeat is disabled\n+        if (config.emitHeartbeatsInterval().isNegative()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMzNDM4MA==", "bodyText": "It feels like allowing intervals to be negative interval to disable connectors is not a great pattern. Instead preventing the interval to be negative and relying solely on enabled() would have been a better alternative.", "url": "https://github.com/apache/kafka/pull/7887#discussion_r371334380", "createdAt": "2020-01-27T16:12:07Z", "author": {"login": "mimaison"}, "path": "connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorCheckpointConnector.java", "diffHunk": "@@ -88,7 +88,8 @@ public void stop() {\n     // divide consumer groups among tasks\n     @Override\n     public List<Map<String, String>> taskConfigs(int maxTasks) {\n-        if (!config.enabled() || knownConsumerGroups.isEmpty()) {\n+        if (!config.enabled() || knownConsumerGroups.isEmpty()\n+                || config.emitCheckpointsInterval().isNegative()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MDMyOTEw", "url": "https://github.com/apache/kafka/pull/7887#pullrequestreview-349032910", "createdAt": "2020-01-27T22:54:28Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MjcwMTcw", "url": "https://github.com/apache/kafka/pull/7887#pullrequestreview-349270170", "createdAt": "2020-01-28T10:30:51Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e2420881f688624315748f54499806950056861", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/3e2420881f688624315748f54499806950056861", "committedDate": "2020-01-29T22:17:34Z", "message": "Fix heartbeat and checkpoint emission can not turn off\n\n`emit.heartbeats.enabled` and `emit.checkpoints.enabled` are supposed to\nbe the knobs to control if the heartbeat message or checkpoint message\nwill be sent or not to the topics respectively. In our experiments,\nsetting them to false will not suspend the activity in their SourceTasks,\ne.g. MirrorHeartbeatTask, MirrorCheckpointTask.\n\nThe observations are, when setting those knobs to false, huge volume of\n`SourceRecord` are being sent without interval, causing significantly high\nCPU usage and GC time  of MirrorMaker 2 instance and congesting the single\npartition of the heartbeat topic and checkpoint topic.\n\nThe proposed fix in the following PR is to (1) explicitly check if `interval`\nis set to negative (e.g. -1), when the `emit.heartbeats.enabled` or\n`emit.checkpoints.enabled` is off. (2) if `interval` is indeed set to negative,\nno task is created."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNzI1MDgx", "url": "https://github.com/apache/kafka/pull/7887#pullrequestreview-350725081", "createdAt": "2020-01-30T10:37:08Z", "commit": {"oid": "3e2420881f688624315748f54499806950056861"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2163, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}