{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3NTIxNzIx", "number": 8290, "title": "KAFKA-9677: Fix consumer fetch with small consume bandwidth quotas", "bodyText": "When we changed quota communication with KIP-219, fetch requests get throttled by returning empty response with the delay in throttle_time_ms and Kafka consumer retries again after the delay. With default configs, the maximum fetch size could be as big as 50MB (or 10MB per partition). The default broker config (1-second window, 10 full windows of tracked bandwidth/thread utilization usage) means that < 5MB/s consumer quota (per broker) may block consumers from being able to fetch any data.\nThis PR ensures that consumers cannot get blocked by quota by capping fetchMaxBytes in KafkaApis.handleFetchRequest() to quota window * consume bandwidth quota. In the example of default configs (10-second quota window) and 1MB/s consumer bandwidth quota, fetchMaxBytes would be capped to 10MB.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-03-12T23:36:13Z", "url": "https://github.com/apache/kafka/pull/8290", "merged": true, "mergeCommit": {"oid": "78554e73f66e0cdf7d289e64b4f8b13b68c48acf"}, "closed": true, "closedAt": "2020-03-14T20:45:50Z", "author": {"login": "apovzner"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNEWkRAH2gAyMzg3NTIxNzIxOjU3YWMzMmI1NjAyZDJhODQ3Yjc3MDVhYzNkYzcwODQ5NzNjNjIwY2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNrKd_gFqTM3NDc1Mjg3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "57ac32b5602d2a847b7705ac3dc7084973c620ce", "author": {"user": {"login": "apovzner", "name": "Anna Povzner"}}, "url": "https://github.com/apache/kafka/commit/57ac32b5602d2a847b7705ac3dc7084973c620ce", "committedDate": "2020-03-12T23:31:22Z", "message": "KAFKA-9677: Fix consumer fetch with small consume bandwidth quotas"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49a7fc93aeacd5a16dc825295c2ad65ba33edc9c", "author": {"user": {"login": "apovzner", "name": "Anna Povzner"}}, "url": "https://github.com/apache/kafka/commit/49a7fc93aeacd5a16dc825295c2ad65ba33edc9c", "committedDate": "2020-03-13T02:26:26Z", "message": "make sure we only cap request from consumer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MzM2NzYw", "url": "https://github.com/apache/kafka/pull/8290#pullrequestreview-374336760", "createdAt": "2020-03-13T14:19:24Z", "commit": {"oid": "49a7fc93aeacd5a16dc825295c2ad65ba33edc9c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNDoxOToyNVrOF2FanA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNDoxOToyNVrOF2FanA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI1NjE1Ng==", "bodyText": "Does this really need 10 minutes? One minute itself seems like a long time for the tests. Should we send larger messages to get the test to complete faster?", "url": "https://github.com/apache/kafka/pull/8290#discussion_r392256156", "createdAt": "2020-03-13T14:19:25Z", "author": {"login": "rajinisivaram"}, "path": "core/src/test/scala/integration/kafka/api/BaseQuotaTest.scala", "diffHunk": "@@ -194,19 +212,24 @@ abstract class QuotaTestClients(topic: String,\n   }\n \n   def consumeUntilThrottled(maxRecords: Int, waitForRequestCompletion: Boolean = true): Int = {\n+    val longTimeoutMs = TimeUnit.MINUTES.toMillis(10)\n+    val shortTimeoutMs = TimeUnit.MINUTES.toMillis(1)\n+\n     consumer.subscribe(Collections.singleton(topic))\n     var numConsumed = 0\n     var throttled = false\n+    val startMs = System.currentTimeMillis\n     do {\n       numConsumed += consumer.poll(Duration.ofMillis(100L)).count\n       val metric = throttleMetric(QuotaType.Fetch, consumerClientId)\n       throttled = metric != null && metricValue(metric) > 0\n-    }  while (numConsumed < maxRecords && !throttled)\n+    }  while (numConsumed < maxRecords && !throttled && System.currentTimeMillis < startMs + longTimeoutMs)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49a7fc93aeacd5a16dc825295c2ad65ba33edc9c"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3594c411cd86e8faab44bfbd6a55fde411abe5d7", "author": {"user": {"login": "apovzner", "name": "Anna Povzner"}}, "url": "https://github.com/apache/kafka/commit/3594c411cd86e8faab44bfbd6a55fde411abe5d7", "committedDate": "2020-03-14T00:52:22Z", "message": "reduced timeout in test and fixed CustomQuotaCallbackTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NzUyODcx", "url": "https://github.com/apache/kafka/pull/8290#pullrequestreview-374752871", "createdAt": "2020-03-14T20:44:27Z", "commit": {"oid": "3594c411cd86e8faab44bfbd6a55fde411abe5d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 265, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}