{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0NDQ2NjU5", "number": 7982, "title": "MINOR: Improve producer test BufferPoolTest#testCloseNotifyWaiters.", "bodyText": "Makes the main thread wait for workers to be ready to test the\ndesired functionality before proceeding.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-01-18T17:24:25Z", "url": "https://github.com/apache/kafka/pull/7982", "merged": true, "mergeCommit": {"oid": "2eb0ccfa46d1cca248c3b5e1c653d097b2c4a58d"}, "closed": true, "closedAt": "2020-04-28T00:16:42Z", "author": {"login": "bdbyrne"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7nLvdgFqTM0NDk1NDc5MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcb08hAABqjMyNzczOTgyODQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTU0Nzkx", "url": "https://github.com/apache/kafka/pull/7982#pullrequestreview-344954791", "createdAt": "2020-01-18T17:55:34Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQxNzo1NTozNVrOFfLj9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQxNzo1NTozNVrOFfLj9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIzOTYwNA==", "bodyText": "Do you know why the sleep is needed ?\nFrom my experiment, 1 millis sleep suffices.\nThe timeout for completed.await() below can be shortened as well since the allocate() call would return immediately.", "url": "https://github.com/apache/kafka/pull/7982#discussion_r368239604", "createdAt": "2020-01-18T17:55:35Z", "author": {"login": "tedyu"}, "path": "clients/src/test/java/org/apache/kafka/clients/producer/internals/BufferPoolTest.java", "diffHunk": "@@ -416,6 +418,10 @@ public Void call() throws Exception {\n             executor.submit(work);\n         }\n \n+        // Wait for the workers to be blocked in their buffer allocations.\n+        ready.await(15, TimeUnit.SECONDS);\n+        Thread.sleep(100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTU1Nzk1", "url": "https://github.com/apache/kafka/pull/7982#pullrequestreview-344955795", "createdAt": "2020-01-18T18:19:18Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQxODoxOToxOVrOFfLodg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQxODoxOToxOVrOFfLodg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI0MDc1OA==", "bodyText": "As you mentioned, without sleep(), the pool.close() would be called immediately - reverting to the behavior prior to this change.\nI think the following formation would achieve what you want to test without the need to choose a proper sleep period.\n        ready.await(15, TimeUnit.SECONDS);\n\n        assertEquals(\"Allocation shouldn't have happened yet, waiting on memory\", numWorkers, completed.getCount());\n        Thread.yield();\n\nVerified via additional logging:\nallocating\nallocating\nclosing\nallocated\nallocated", "url": "https://github.com/apache/kafka/pull/7982#discussion_r368240758", "createdAt": "2020-01-18T18:19:19Z", "author": {"login": "tedyu"}, "path": "clients/src/test/java/org/apache/kafka/clients/producer/internals/BufferPoolTest.java", "diffHunk": "@@ -416,6 +418,10 @@ public Void call() throws Exception {\n             executor.submit(work);\n         }\n \n+        // Wait for the workers to be blocked in their buffer allocations.\n+        ready.await(15, TimeUnit.SECONDS);\n+        Thread.sleep(10);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d657a6f9397e794bb894561426cbb7b31a054071", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/d657a6f9397e794bb894561426cbb7b31a054071", "committedDate": "2020-04-27T19:34:02Z", "message": "MINOR: Improve producer test BufferPoolTest#testCloseNotifyWaiters.\n\nMakes the main thread wait for workers to be ready to test the\ndesired functionality before proceeding."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc46cfdf04bef3108438249c93161d757ce2105d", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/cc46cfdf04bef3108438249c93161d757ce2105d", "committedDate": "2020-04-27T19:34:02Z", "message": "Reduce sleep timeout."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72b1fd930c1053feb16ca83a5012d8672f444c6f", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/72b1fd930c1053feb16ca83a5012d8672f444c6f", "committedDate": "2020-04-27T20:02:11Z", "message": "Address review comment."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "72b1fd930c1053feb16ca83a5012d8672f444c6f", "author": {"user": null}, "url": "https://github.com/apache/kafka/commit/72b1fd930c1053feb16ca83a5012d8672f444c6f", "committedDate": "2020-04-27T20:02:11Z", "message": "Address review comment."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2052, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}