{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwOTEwOTk0", "number": 7917, "title": "KAFKA-9379; Fix flaky test TopicCommandWithAdminClientTest.testCreateAlterTopicWithRackAware", "bodyText": "Test creates a topic, waits for adminClient.listTopics to return the topic and then performs alterTopic(), which also uses adminClient.listTopics to verify that the topic exists. This may fail if the topic hadn't yet been propagated to the broker to which the second listTopics is sent. This PR updates the test to wait for topic to be in the metadata cache of all brokers before calling alterTopic().\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-01-09T11:27:07Z", "url": "https://github.com/apache/kafka/pull/7917", "merged": true, "mergeCommit": {"oid": "e9734f5486ac3f9a62ade6a06689d6194ae55b51"}, "closed": true, "closedAt": "2020-01-09T14:17:42Z", "author": {"login": "rajinisivaram"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4nza4gH2gAyMzYwOTEwOTk0OjY5NzIyNTU3ODc4M2NjOTgwMDk2ZjExNjFiOTA4YzEyYzU2ZmZjMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4oyMdgFqTM0MDQ3NDMwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "697225578783cc980096f1161b908c12c56ffc11", "author": {"user": {"login": "rajinisivaram", "name": "Rajini Sivaram"}}, "url": "https://github.com/apache/kafka/commit/697225578783cc980096f1161b908c12c56ffc11", "committedDate": "2020-01-09T10:57:09Z", "message": "KAFKA-9379; Fix flaky test TopicCommandWithAdminClientTest.testCreateAlterTopicWithRackAware"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNDYzNjE3", "url": "https://github.com/apache/kafka/pull/7917#pullrequestreview-340463617", "createdAt": "2020-01-09T11:44:07Z", "commit": {"oid": "697225578783cc980096f1161b908c12c56ffc11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMTo0NDowN1rOFbzRrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMTo0NDowN1rOFbzRrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY5NTk4MA==", "bodyText": "Can we not use TestUtils.waitUntilMetadataIsPropagated?", "url": "https://github.com/apache/kafka/pull/7917#discussion_r364695980", "createdAt": "2020-01-09T11:44:07Z", "author": {"login": "ijuma"}, "path": "core/src/test/scala/unit/kafka/admin/TopicCommandWithAdminClientTest.scala", "diffHunk": "@@ -91,14 +91,11 @@ class TopicCommandWithAdminClientTest extends KafkaServerTestHarness with Loggin\n   }\n \n   def waitForTopicCreated(topicName: String, timeout: Int = 10000): Unit = {\n-    val finishTime = System.currentTimeMillis() + timeout\n-    var result = false\n-    while (System.currentTimeMillis() < finishTime && !result) {\n-      val topics = adminClient.listTopics(new ListTopicsOptions().listInternal(true)).names().get()\n-      result = topics.contains(topicName)\n-      Thread.sleep(100)\n-    }\n-    assertTrue(s\"Topic $topicName has not been created within the given $timeout time\", result)\n+    // Wait until metadata is propagated to all brokers so that adminClient.listTopics returns the topic from any broker\n+    TestUtils.waitUntilTrue(() => servers.forall { server => server.metadataCache.contains(topicName) },\n+      s\"Topic not created and propagated within $timeout ms\", timeout)\n+    val topics = adminClient.listTopics(new ListTopicsOptions().listInternal(true)).names().get()\n+    assertTrue(s\"Topic $topicName not returned by adminClient\", topics.contains(topicName))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "697225578783cc980096f1161b908c12c56ffc11"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73e69603dbc783ceaeb9fc3d0c0c5f83e247f54e", "author": {"user": {"login": "rajinisivaram", "name": "Rajini Sivaram"}}, "url": "https://github.com/apache/kafka/commit/73e69603dbc783ceaeb9fc3d0c0c5f83e247f54e", "committedDate": "2020-01-09T11:55:46Z", "message": "Address review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNDc0MzA4", "url": "https://github.com/apache/kafka/pull/7917#pullrequestreview-340474308", "createdAt": "2020-01-09T12:05:43Z", "commit": {"oid": "73e69603dbc783ceaeb9fc3d0c0c5f83e247f54e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1909, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}