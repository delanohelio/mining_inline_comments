{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNzk5NzMw", "number": 8849, "title": "KAFKA-10144: clean up corrupted standby tasks before attempting a commit", "bodyText": "We need to make sure that corrupted standby tasks are actually cleaned up upon a TaskCorruptedException. However due to the commit prior to invoking handleCorruption, it's possible to throw a TaskMigratedException before actually cleaning up any of the corrupted tasks.\nThis is fine for active tasks since handleLostAll will finish up the job, but it does nothing with standby tasks. We should make sure that standby tasks are handled before attempting to commit (which we can do, since we don't need to commit anything for the corrupted standbys)\nMust be cherry-picked to 2.6", "createdAt": "2020-06-11T02:24:51Z", "url": "https://github.com/apache/kafka/pull/8849", "merged": true, "mergeCommit": {"oid": "03ed08d0d17a10ca4f96c8cc0a8694834ae01e6d"}, "closed": true, "closedAt": "2020-06-12T23:21:58Z", "author": {"login": "ableegoldman"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqFMHyAFqTQyODU1ODIzNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqqdqlgFqTQzMDA2NTMzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTU4MjM0", "url": "https://github.com/apache/kafka/pull/8849#pullrequestreview-428558234", "createdAt": "2020-06-11T02:53:39Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMjo1Mzo0MFrOGiMyBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMjo1Mzo0MFrOGiMyBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxNDE4MQ==", "bodyText": "nit: just simplify to throws Exception", "url": "https://github.com/apache/kafka/pull/8849#discussion_r438514181", "createdAt": "2020-06-11T02:53:40Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/StandbyTaskEOSIntegrationTest.java", "diffHunk": "@@ -92,7 +92,7 @@ public void createTopics() throws Exception {\n     }\n \n     @Test\n-    public void surviveWithOneTaskAsStandby() throws ExecutionException, InterruptedException, IOException {\n+    public void surviveWithOneTaskAsStandby() throws InterruptedException, IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTcwOTU0", "url": "https://github.com/apache/kafka/pull/8849#pullrequestreview-428570954", "createdAt": "2020-06-11T03:38:42Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMzozODo0MlrOGiNbfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMzozODo0MlrOGiNbfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUyNDc5OA==", "bodyText": "Just tried to consolidate the log messages between active/standby tasks (and demoted these to debug)", "url": "https://github.com/apache/kafka/pull/8849#discussion_r438524798", "createdAt": "2020-06-11T03:38:42Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StandbyTask.java", "diffHunk": "@@ -137,7 +137,7 @@ public void resume() {\n     public Map<TopicPartition, OffsetAndMetadata> prepareCommit() {\n         if (state() == State.RUNNING || state() == State.SUSPENDED) {\n             stateMgr.flush();\n-            log.info(\"Task ready for committing\");\n+            log.debug(\"Prepared task for committing\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "95dd8fe548980077bb11ed958aef7015aa3d2ad5", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/95dd8fe548980077bb11ed958aef7015aa3d2ad5", "committedDate": "2020-06-12T00:43:23Z", "message": "clean up standbys"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d93b48995dc740648689d0d90e939c9ddc018d2", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/9d93b48995dc740648689d0d90e939c9ddc018d2", "committedDate": "2020-06-12T00:46:45Z", "message": "add new tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "9d93b48995dc740648689d0d90e939c9ddc018d2", "author": {"user": {"login": "ableegoldman", "name": "A. Sophie Blee-Goldman"}}, "url": "https://github.com/apache/kafka/commit/9d93b48995dc740648689d0d90e939c9ddc018d2", "committedDate": "2020-06-12T00:46:45Z", "message": "add new tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMDY1MzM1", "url": "https://github.com/apache/kafka/pull/8849#pullrequestreview-430065335", "createdAt": "2020-06-12T22:19:19Z", "commit": {"oid": "9d93b48995dc740648689d0d90e939c9ddc018d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 586, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}