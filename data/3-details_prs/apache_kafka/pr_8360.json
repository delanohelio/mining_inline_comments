{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzOTA0Nzkw", "number": 8360, "title": "KAFKA-9768: Fix handling of rest.advertised.listener config", "bodyText": "Jira\nThe rest.advertised.listener config is currently broken as setting it to http when listeners are configured for both https and http will cause the framework to choose whichever of the two listeners is listed first. The changes here attempt to fix this by checking not only that ServerConnector::getName begins with the specified protocol, but also that that protocol is immediately followed by an underscore, which the framework uses as a delimiter between the protocol and the remainder of the connector name.\nAn existing unit test for the RestServer::advertisedUrl method has been expanded to include a case that fails with the framework in its current state and passes with the changes in this PR.\nSee \n  \n    \n      kafka/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/rest/RestServer.java\n    \n    \n         Line 181\n      in\n      ee0ef09\n    \n    \n    \n    \n\n        \n          \n           connector.setName(String.format(\"%s_%s%d\", PROTOCOL_HTTPS, hostname, port)); \n        \n    \n  \n\n and \n  \n    \n      kafka/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/rest/RestServer.java\n    \n    \n         Line 186\n      in\n      ee0ef09\n    \n    \n    \n    \n\n        \n          \n           connector.setName(String.format(\"%s_%s%d\", PROTOCOL_HTTP, hostname, port)); \n        \n    \n  \n\n for how the framework sets the name for the ServerConnector instances it creates.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-03-26T01:18:41Z", "url": "https://github.com/apache/kafka/pull/8360", "merged": true, "mergeCommit": {"oid": "29dd1148c831ff0007ef3f1df54eee6298da99de"}, "closed": true, "closedAt": "2020-05-07T01:09:47Z", "author": {"login": "C0urante"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRRmqwgH2gAyMzkzOTA0NzkwOjA4YTAzOTEyZDIwMTk4MjU1NmRhZDMzMjcyMzllZjJmMmRiZDNjMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcT3lypAFqTM4NjkwMTM5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "08a03912d201982556dad3327239ef2f2dbd3c19", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/08a03912d201982556dad3327239ef2f2dbd3c19", "committedDate": "2020-03-26T01:13:25Z", "message": "KAFKA-9768: Fix handling of rest.advertised.listener config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNzA2OTQy", "url": "https://github.com/apache/kafka/pull/8360#pullrequestreview-381706942", "createdAt": "2020-03-26T05:13:37Z", "commit": {"oid": "08a03912d201982556dad3327239ef2f2dbd3c19"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMzA3NjU3", "url": "https://github.com/apache/kafka/pull/8360#pullrequestreview-382307657", "createdAt": "2020-03-26T18:43:31Z", "commit": {"oid": "08a03912d201982556dad3327239ef2f2dbd3c19"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxODo0MzozMlrOF8VWPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxODo0MzozMlrOF8VWPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgwODYzNg==", "bodyText": "I see how the names are by-convention of the form {protocol}_{host}{port} and that this technically works. Seems like at a minimum we need a comment (or better yet JavaDoc) that describes why this works and the assumptions it makes.", "url": "https://github.com/apache/kafka/pull/8360#discussion_r398808636", "createdAt": "2020-03-26T18:43:32Z", "author": {"login": "rhauch"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/rest/RestServer.java", "diffHunk": "@@ -419,7 +419,7 @@ else if (listeners.contains(String.format(\"%s://\", PROTOCOL_HTTPS)))\n     ServerConnector findConnector(String protocol) {\n         for (Connector connector : jettyServer.getConnectors()) {\n             String connectorName = connector.getName();\n-            if (connectorName.startsWith(protocol) && !ADMIN_SERVER_CONNECTOR_NAME.equals(connectorName))\n+            if (connectorName.startsWith(protocol + \"_\") && !ADMIN_SERVER_CONNECTOR_NAME.equals(connectorName))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08a03912d201982556dad3327239ef2f2dbd3c19"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35dd4d2836db7a4c078f78b22fad20ba1480a3f0", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/35dd4d2836db7a4c078f78b22fad20ba1480a3f0", "committedDate": "2020-03-26T19:25:02Z", "message": "KAFKA-9768: Add comments on server connector names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NzEyNjkw", "url": "https://github.com/apache/kafka/pull/8360#pullrequestreview-385712690", "createdAt": "2020-04-01T15:43:20Z", "commit": {"oid": "35dd4d2836db7a4c078f78b22fad20ba1480a3f0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNTo0MzoyMFrOF_GySQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNTo0MzoyMFrOF_GySQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcxNTc4NQ==", "bodyText": "Nit: perhaps mention that the order of the listeners config is important:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // correct listener is chosen when http and https are configured and advertised listener is http\n          \n          \n            \n                    // correct listener is chosen when https listener is configured before http listener and advertised listener is http", "url": "https://github.com/apache/kafka/pull/8360#discussion_r401715785", "createdAt": "2020-04-01T15:43:20Z", "author": {"login": "rhauch"}, "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/rest/RestServerTest.java", "diffHunk": "@@ -174,6 +174,14 @@ public void testAdvertisedUri() {\n         config = new DistributedConfig(configMap);\n         server = new RestServer(config);\n         Assert.assertEquals(\"http://my-hostname:8080/\", server.advertisedUrl().toString());\n+\n+        // correct listener is chosen when http and https are configured and advertised listener is http", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35dd4d2836db7a4c078f78b22fad20ba1480a3f0"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be4496b213ffa775c8e4693c023485fa2e96f6a8", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/be4496b213ffa775c8e4693c023485fa2e96f6a8", "committedDate": "2020-04-01T16:35:37Z", "message": "KAFKA-9768: Update RestServerTest comment\n\nCo-Authored-By: Randall Hauch <rhauch@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MDIyMzgz", "url": "https://github.com/apache/kafka/pull/8360#pullrequestreview-386022383", "createdAt": "2020-04-01T23:43:18Z", "commit": {"oid": "be4496b213ffa775c8e4693c023485fa2e96f6a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2OTAxMzk2", "url": "https://github.com/apache/kafka/pull/8360#pullrequestreview-386901396", "createdAt": "2020-04-03T02:36:42Z", "commit": {"oid": "be4496b213ffa775c8e4693c023485fa2e96f6a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1684, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}