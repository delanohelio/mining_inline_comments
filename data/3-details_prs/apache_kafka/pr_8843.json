{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMTY4MDI5", "number": 8843, "title": "KAFKA-9991: Fix flaky unit tests", "bodyText": "The latest commit #8254 on this test deleted all topics after each test, but the topic was actually shared among tests before. And after that we are relying on the less-reliable auto-topic generation to get the topic which makes the test flaky.\nI'm now using different topics for different tests, also setting the app.id for tests differently.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-06-10T02:50:53Z", "url": "https://github.com/apache/kafka/pull/8843", "merged": true, "mergeCommit": {"oid": "ff8a757b9c4fcadda5a8aa165b4c3e8e8dd2d8fd"}, "closed": true, "closedAt": "2020-06-10T21:07:19Z", "author": {"login": "guozhangwang"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpwbnXgH2gAyNDMyMTY4MDI5OjcxMWU1ZjY3ZWY2YmRiZTk4YjI5Nzk3NGFlNTM5ODdiMmY5NzUwODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqAN8gAH2gAyNDMyMTY4MDI5OjA4NmMxMjI2NzUyOTA1Nzg4YjA4ODZjNWMwNzEwMjM4ZWMyN2RmNWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "711e5f67ef6bdbe98b297974ae53987b2f975086", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/711e5f67ef6bdbe98b297974ae53987b2f975086", "committedDate": "2020-06-10T02:42:35Z", "message": "fix flakiness"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8423700dcb5ef51def1d13414591f668abf9e32a", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/8423700dcb5ef51def1d13414591f668abf9e32a", "committedDate": "2020-06-10T02:50:47Z", "message": "remove unnecessary topic deletion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NzA5MTI5", "url": "https://github.com/apache/kafka/pull/8843#pullrequestreview-427709129", "createdAt": "2020-06-10T04:52:29Z", "commit": {"oid": "8423700dcb5ef51def1d13414591f668abf9e32a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwNDo1MjoyOVrOGhkyjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwNDo1Mzo0N1rOGhkzzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg1ODk1Ng==", "bodyText": "Does the deletion logic affect the success of each test? If not, I would prefer to keep it to simplify the broker side log for each subsequent tests, such that we don't have a lot of unused topics.", "url": "https://github.com/apache/kafka/pull/8843#discussion_r437858956", "createdAt": "2020-06-10T04:52:29Z", "author": {"login": "abbccdda"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/KTableSourceTopicRestartIntegrationTest.java", "diffHunk": "@@ -107,7 +109,6 @@ public void before() {\n     @After\n     public void after() throws Exception {\n         IntegrationTestUtils.purgeLocalStreamsState(STREAMS_CONFIG);\n-        CLUSTER.deleteAllTopicsAndWait(60000L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8423700dcb5ef51def1d13414591f668abf9e32a"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg1OTI3Ng==", "bodyText": "The original logic seems unnecessary?", "url": "https://github.com/apache/kafka/pull/8843#discussion_r437859276", "createdAt": "2020-06-10T04:53:47Z", "author": {"login": "abbccdda"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/KTableSourceTopicRestartIntegrationTest.java", "diffHunk": "@@ -236,11 +237,7 @@ public void onRestoreStart(final TopicPartition topicPartition,\n                                    final String storeName,\n                                    final long startingOffset,\n                                    final long endingOffset) {\n-            try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8423700dcb5ef51def1d13414591f668abf9e32a"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MjUxOTI4", "url": "https://github.com/apache/kafka/pull/8843#pullrequestreview-428251928", "createdAt": "2020-06-10T16:54:52Z", "commit": {"oid": "8423700dcb5ef51def1d13414591f668abf9e32a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjo1NDo1MlrOGh-BVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjo1NjoyNFrOGh-E0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3MjM0Mw==", "bodyText": "super nit: can we rename to streams1 to be consistent with other tests?", "url": "https://github.com/apache/kafka/pull/8843#discussion_r438272343", "createdAt": "2020-06-10T16:54:52Z", "author": {"login": "ableegoldman"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/KTableSourceTopicRestartIntegrationTest.java", "diffHunk": "@@ -52,30 +51,28 @@\n import java.util.Map;\n import java.util.Properties;\n import java.util.concurrent.ConcurrentHashMap;\n-import java.util.concurrent.ExecutionException;\n \n @Category({IntegrationTest.class})\n public class KTableSourceTopicRestartIntegrationTest {\n     private static final int NUM_BROKERS = 3;\n     private static final String SOURCE_TOPIC = \"source-topic\";\n+    private static final Properties PRODUCER_CONFIG = new Properties();\n+    private static final Properties STREAMS_CONFIG = new Properties();\n \n     @ClassRule\n     public static final EmbeddedKafkaCluster CLUSTER = new EmbeddedKafkaCluster(NUM_BROKERS);\n+\n     private final Time time = CLUSTER.time;\n-    private KafkaStreams streamsOne;\n     private final StreamsBuilder streamsBuilder = new StreamsBuilder();\n     private final Map<String, String> readKeyValues = new ConcurrentHashMap<>();\n \n-    private static final Properties PRODUCER_CONFIG = new Properties();\n-    private static final Properties STREAMS_CONFIG = new Properties();\n+    private String sourceTopic;\n+    private KafkaStreams streamsOne;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8423700dcb5ef51def1d13414591f668abf9e32a"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3MzIzNA==", "bodyText": "nit: use IntegrationTestUtils#safeUniqueTestName for the name", "url": "https://github.com/apache/kafka/pull/8843#discussion_r438273234", "createdAt": "2020-06-10T16:56:24Z", "author": {"login": "ableegoldman"}, "path": "streams/src/test/java/org/apache/kafka/streams/integration/KTableSourceTopicRestartIntegrationTest.java", "diffHunk": "@@ -96,8 +93,13 @@ public static void setUpBeforeAllTests() throws Exception {\n     public TestName testName = new TestName();\n \n     @Before\n-    public void before() {\n-        final KTable<String, String> kTable = streamsBuilder.table(SOURCE_TOPIC, Materialized.as(\"store\"));\n+    public void before() throws Exception {\n+        sourceTopic = SOURCE_TOPIC + \"-\" + testName.getMethodName();\n+        CLUSTER.createTopic(sourceTopic);\n+\n+        STREAMS_CONFIG.put(StreamsConfig.APPLICATION_ID_CONFIG, \"ktable-restore-from-source-\" + testName.getMethodName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8423700dcb5ef51def1d13414591f668abf9e32a"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NDAyMDUw", "url": "https://github.com/apache/kafka/pull/8843#pullrequestreview-428402050", "createdAt": "2020-06-10T20:26:37Z", "commit": {"oid": "8423700dcb5ef51def1d13414591f668abf9e32a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "447107848f5ec93dbbe24982bf69e82a78344751", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/447107848f5ec93dbbe24982bf69e82a78344751", "committedDate": "2020-06-10T20:53:33Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into K9991-flaky-test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "086c1226752905788b0886c5c0710238ec27df5d", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/086c1226752905788b0886c5c0710238ec27df5d", "committedDate": "2020-06-10T21:06:08Z", "message": "github comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 563, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}