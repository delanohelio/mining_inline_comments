{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMjY5Njcz", "number": 8468, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToxMToyMFrODw__NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjo0MzoyMlrODxdT-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNzA2NjEyOnYy", "diffSide": "RIGHT", "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToxMToyMFrOGERPxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToxMToyMFrOGERPxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMDA1Mg==", "bodyText": "I need a way to do this more cleanly. Is it OK to put an isTraceEnabled call into the logger rather than access the underlying directly?", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407130052", "createdAt": "2020-04-12T01:11:20Z", "author": {"login": "lbradstreet"}, "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "diffHunk": "@@ -785,7 +785,7 @@ class ReplicaManager(val config: KafkaConfig,\n                                origin: AppendOrigin,\n                                entriesPerPartition: Map[TopicPartition, MemoryRecords],\n                                requiredAcks: Short): Map[TopicPartition, LogAppendResult] = {\n-\n+    val isTraceEnabled = logger.underlying.isTraceEnabled", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNzA2NjUyOnYy", "diffSide": "RIGHT", "path": "core/src/main/scala/kafka/server/ReplicaFetcherThread.scala", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToxMTo1OFrOGERP8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToxMTo1OFrOGERP8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMDA5OQ==", "bodyText": "Saves 3 getEffectiveLevel checks.", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407130099", "createdAt": "2020-04-12T01:11:58Z", "author": {"login": "lbradstreet"}, "path": "core/src/main/scala/kafka/server/ReplicaFetcherThread.scala", "diffHunk": "@@ -149,6 +149,7 @@ class ReplicaFetcherThread(name: String,\n   override def processPartitionData(topicPartition: TopicPartition,\n                                     fetchOffset: Long,\n                                     partitionData: FetchData): Option[LogAppendInfo] = {\n+    val logTrace = isTraceEnabled", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNzA2ODQwOnYy", "diffSide": "RIGHT", "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToxNDoyOVrOGERQwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToxNDoyOVrOGERQwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMDMwNQ==", "bodyText": "Looking up the trace level outside of the map allows us to save a isTraceEnabled lookup for every partition being produced to.", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407130305", "createdAt": "2020-04-12T01:14:29Z", "author": {"login": "lbradstreet"}, "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "diffHunk": "@@ -820,8 +822,10 @@ class ReplicaManager(val config: KafkaConfig,\n           brokerTopicStats.topicStats(topicPartition.topic).messagesInRate.mark(numAppendedMessages)\n           brokerTopicStats.allTopicsStats.messagesInRate.mark(numAppendedMessages)\n \n-          trace(s\"${records.sizeInBytes} written to log $topicPartition beginning at offset \" +\n-            s\"${info.firstOffset.getOrElse(-1)} and ending at offset ${info.lastOffset}\")\n+          if (isTraceEnabled)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNzA3NzE2OnYy", "diffSide": "RIGHT", "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToyODo0NlrOGERUvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMToyODo0NlrOGERUvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMTMyNQ==", "bodyText": "Looking up the trace level above means we only need to get the effective level once even though read() may be called once for each partition.", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407131325", "createdAt": "2020-04-12T01:28:46Z", "author": {"login": "lbradstreet"}, "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "diffHunk": "@@ -978,9 +983,10 @@ class ReplicaManager(val config: KafkaConfig,\n \n       val adjustedMaxBytes = math.min(fetchInfo.maxBytes, limitBytes)\n       try {\n-        trace(s\"Fetching log segment for partition $tp, offset $offset, partition fetch size $partitionFetchSize, \" +\n-          s\"remaining response limit $limitBytes\" +\n-          (if (minOneMessage) s\", ignoring response/partition size limits\" else \"\"))\n+        if (isTraceEnabled)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMTg3MDQwOnYy", "diffSide": "LEFT", "path": "core/src/main/scala/kafka/cluster/Replica.scala", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjo0MzoxMVrOGE8IGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjo0MzoxMVrOGE8IGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMjYwMg==", "bodyText": "I don't think this trace call is worthwhile given the cost. It would be hard to turn it on without being deluged with logs.", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407832602", "createdAt": "2020-04-14T02:43:11Z", "author": {"login": "lbradstreet"}, "path": "core/src/main/scala/kafka/cluster/Replica.scala", "diffHunk": "@@ -83,7 +83,6 @@ class Replica(val brokerId: Int, val topicPartition: TopicPartition) extends Log\n     lastFetchLeaderLogEndOffset = leaderEndOffset\n     lastFetchTimeMs = followerFetchTimeMs\n     updateLastSentHighWatermark(lastSentHighwatermark)\n-    trace(s\"Updated state of replica to $this\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c206dd906d6e5cd0893cdf86bbd1535f42aecb69"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMTg3MDY3OnYy", "diffSide": "LEFT", "path": "core/src/main/scala/kafka/cluster/Replica.scala", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjo0MzoyMlrOGE8IQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNzoyOToxNlrOGHW10w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMjY0Mg==", "bodyText": "I don't think this trace call is worthwhile given the cost. It would be hard to turn it on without being deluged with logs..", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407832642", "createdAt": "2020-04-14T02:43:22Z", "author": {"login": "lbradstreet"}, "path": "core/src/main/scala/kafka/cluster/Replica.scala", "diffHunk": "@@ -96,7 +95,6 @@ class Replica(val brokerId: Int, val topicPartition: TopicPartition) extends Log\n     */\n   private def updateLastSentHighWatermark(highWatermark: Long): Unit = {\n     _lastSentHighWatermark = highWatermark\n-    trace(s\"Updated HW of replica to $highWatermark\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c206dd906d6e5cd0893cdf86bbd1535f42aecb69"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTUzODg1Mw==", "bodyText": "@junrao Thoughts? Can we remove these calls?", "url": "https://github.com/apache/kafka/pull/8468#discussion_r409538853", "createdAt": "2020-04-16T13:04:46Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/cluster/Replica.scala", "diffHunk": "@@ -96,7 +95,6 @@ class Replica(val brokerId: Int, val topicPartition: TopicPartition) extends Log\n     */\n   private def updateLastSentHighWatermark(highWatermark: Long): Unit = {\n     _lastSentHighWatermark = highWatermark\n-    trace(s\"Updated HW of replica to $highWatermark\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMjY0Mg=="}, "originalCommit": {"oid": "c206dd906d6e5cd0893cdf86bbd1535f42aecb69"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkxNjAyOQ==", "bodyText": "At minimum I think we could keep the trace I deleted here: #8468 (comment) which should end up logging the lastSentWatermark anyway?", "url": "https://github.com/apache/kafka/pull/8468#discussion_r409916029", "createdAt": "2020-04-16T23:59:52Z", "author": {"login": "lbradstreet"}, "path": "core/src/main/scala/kafka/cluster/Replica.scala", "diffHunk": "@@ -96,7 +95,6 @@ class Replica(val brokerId: Int, val topicPartition: TopicPartition) extends Log\n     */\n   private def updateLastSentHighWatermark(highWatermark: Long): Unit = {\n     _lastSentHighWatermark = highWatermark\n-    trace(s\"Updated HW of replica to $highWatermark\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMjY0Mg=="}, "originalCommit": {"oid": "c206dd906d6e5cd0893cdf86bbd1535f42aecb69"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM2NzQ0Mw==", "bodyText": "Yes, I agree this may not be that useful. We have other logging like the following in Partition.updateFollowerFetchState() that provides similar traceability.\n        debug(s\"Recorded replica $followerId log end offset (LEO) position \" +\n          s\"${followerFetchOffsetMetadata.messageOffset} and log start offset $followerStartOffset.\")", "url": "https://github.com/apache/kafka/pull/8468#discussion_r410367443", "createdAt": "2020-04-17T17:29:16Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/cluster/Replica.scala", "diffHunk": "@@ -96,7 +95,6 @@ class Replica(val brokerId: Int, val topicPartition: TopicPartition) extends Log\n     */\n   private def updateLastSentHighWatermark(highWatermark: Long): Unit = {\n     _lastSentHighWatermark = highWatermark\n-    trace(s\"Updated HW of replica to $highWatermark\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMjY0Mg=="}, "originalCommit": {"oid": "c206dd906d6e5cd0893cdf86bbd1535f42aecb69"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2971, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}