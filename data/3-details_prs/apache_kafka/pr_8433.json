{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5NzY5NDg0", "number": 8433, "title": "MINOR: Should cleanup the tasks after dirty close", "bodyText": "Some tasks get closed inside HandleAssignment and did not remove from the task manager bookkeep list. The next time they would be re-closed which is illegal state.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-04-06T16:43:40Z", "url": "https://github.com/apache/kafka/pull/8433", "merged": true, "mergeCommit": {"oid": "f1850162de9174faab68c6674548dc40fb6a352f"}, "closed": true, "closedAt": "2020-04-07T03:44:15Z", "author": {"login": "abbccdda"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVBdDkAH2gAyMzk5NzY5NDg0OjU3MTk4YTk5YmQyOWFiMDk1NWI1OWVlMDQ1N2QyNGMxM2ZjMTJhMGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVI9oZgFqTM4ODcyNTM4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "57198a99bd29ab0955b59ee0457d24c13fc12a0c", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/57198a99bd29ab0955b59ee0457d24c13fc12a0c", "committedDate": "2020-04-06T16:40:08Z", "message": "cleanup after task close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e3ab130c795ff49e85fc7b2f6810766ae67e9a3", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/5e3ab130c795ff49e85fc7b2f6810766ae67e9a3", "committedDate": "2020-04-06T16:41:00Z", "message": "test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTkzNjA3", "url": "https://github.com/apache/kafka/pull/8433#pullrequestreview-388593607", "createdAt": "2020-04-06T20:30:39Z", "commit": {"oid": "5e3ab130c795ff49e85fc7b2f6810766ae67e9a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDozMDozOVrOGBouOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDozMDozOVrOGBouOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2ODk1Mg==", "bodyText": "It seems like this would have initially appeared unnecessary because we already removed it on L230 when we first put it into the dirtyTasks map. But what appears to have happened is that we actually got an exception during commit, and added some more tasks in L252-L253, which were not removed from the task map.\nWhat is the overall algorithm here? Offhand, it seems like we should only remove the task after we know it is closed, which means we should delete the iterator.remove(); on L230 and keep the line you've added here, along with adding a similar line between L264-265 (after closeClean). I'm also wondering if we should really do closeDirty on L271, or just add it to dirtyTasks. If we keep it there, then we also need to remove it from the task map at that location.", "url": "https://github.com/apache/kafka/pull/8433#discussion_r404368952", "createdAt": "2020-04-06T20:30:39Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -277,6 +277,7 @@ public void handleAssignment(final Map<TaskId, Set<TopicPartition>> activeTasks,\n         for (final Task task : dirtyTasks) {\n             task.closeDirty();\n             cleanUpTaskProducer(task, taskCloseExceptions);\n+            tasks.remove(task.id());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e3ab130c795ff49e85fc7b2f6810766ae67e9a3"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce24e16051e2dcf5301064192c1cc78a72ccb5bd", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/ce24e16051e2dcf5301064192c1cc78a72ccb5bd", "committedDate": "2020-04-06T20:49:44Z", "message": "make the removal logic closer to the dirtyTask struct change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5c7843c39c57f235009c1098e088f854ace13cf", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/b5c7843c39c57f235009c1098e088f854ace13cf", "committedDate": "2020-04-06T22:24:30Z", "message": "apply remove task only after close"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzI1Mzg2", "url": "https://github.com/apache/kafka/pull/8433#pullrequestreview-388725386", "createdAt": "2020-04-07T01:25:03Z", "commit": {"oid": "b5c7843c39c57f235009c1098e088f854ace13cf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 109, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}