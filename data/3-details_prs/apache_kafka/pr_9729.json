{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2MzM4Mjc0", "number": 9729, "title": "KAFKA-10839: improve consumer group coordinator unavailable message", "bodyText": "When a consumer encounters an issue that triggers marking it to mark coordinator as unknown, the error message it prints does not give much context about the error that triggered it. This change includes the response error that triggered the transition or any other cause if not triggered by an error code in a response.", "createdAt": "2020-12-10T23:32:43Z", "url": "https://github.com/apache/kafka/pull/9729", "merged": true, "mergeCommit": {"oid": "ea8ae976504e7a3f5c6f4a7efa5069d03316b093"}, "closed": true, "closedAt": "2020-12-15T22:38:19Z", "author": {"login": "lbradstreet"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdk7zZlgH2gAyNTM2MzM4Mjc0OjFjYmY2ZmNjYTVjY2I0NDgyNjExYjE4N2FiMTdmOTBlN2Q2YmYxZWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmiNbmAFqTU1MzAxMTEzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee", "author": {"user": {"login": "lbradstreet", "name": "Lucas Bradstreet"}}, "url": "https://github.com/apache/kafka/commit/1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee", "committedDate": "2020-12-10T23:19:03Z", "message": "KAFKA-10839: improve consumer group coordinator unavailable message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5Njk1Mjkz", "url": "https://github.com/apache/kafka/pull/9729#pullrequestreview-549695293", "createdAt": "2020-12-10T23:33:06Z", "commit": {"oid": "1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzozMzowNlrOIDiSzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzozMzowNlrOIDiSzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3ODUxMA==", "bodyText": "These messages feel a bit smelly", "url": "https://github.com/apache/kafka/pull/9729#discussion_r540578510", "createdAt": "2020-12-10T23:33:06Z", "author": {"login": "lbradstreet"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -1355,7 +1362,7 @@ public void run() {\n                         } else if (heartbeat.sessionTimeoutExpired(now)) {\n                             // the session timeout has expired without seeing a successful heartbeat, so we should\n                             // probably make sure the coordinator is still healthy.\n-                            markCoordinatorUnknown();\n+                            markCoordinatorUnknown(\"session timed out without heartbeat\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5Njk1NDIy", "url": "https://github.com/apache/kafka/pull/9729#pullrequestreview-549695422", "createdAt": "2020-12-10T23:33:23Z", "commit": {"oid": "1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzozMzoyM1rOIDiTJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzozMzoyM1rOIDiTJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3ODU5OA==", "bodyText": "Should this be extracted into a constant?", "url": "https://github.com/apache/kafka/pull/9729#discussion_r540578598", "createdAt": "2020-12-10T23:33:23Z", "author": {"login": "lbradstreet"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -257,7 +257,7 @@ protected synchronized boolean ensureCoordinatorReady(final Timer timer) {\n             } else if (coordinator != null && client.isUnavailable(coordinator)) {\n                 // we found the coordinator, but the connection has failed, so mark\n                 // it dead and backoff before retrying discovery\n-                markCoordinatorUnknown();\n+                markCoordinatorUnknown(\"coordinator unavailable\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTMxMjc3", "url": "https://github.com/apache/kafka/pull/9729#pullrequestreview-550531277", "createdAt": "2020-12-11T19:50:09Z", "commit": {"oid": "1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxOTo1MDowOVrOIEJQeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxOTo1MToyMVrOIEJU6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIxNjg4OA==", "bodyText": "Wonder if we can use the name of the error. Some of the messages will read awkwardly in the log message", "url": "https://github.com/apache/kafka/pull/9729#discussion_r541216888", "createdAt": "2020-12-11T19:50:09Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -890,13 +890,20 @@ private synchronized Node coordinator() {\n         return this.coordinator;\n     }\n \n-    protected synchronized void markCoordinatorUnknown() {\n-        markCoordinatorUnknown(false);\n+\n+    protected synchronized void markCoordinatorUnknown(Errors error) {\n+        markCoordinatorUnknown(false, \"error response {}\" + error.message());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIxNzQwMQ==", "bodyText": "nit: \"Rediscovery will be attempted\"", "url": "https://github.com/apache/kafka/pull/9729#discussion_r541217401", "createdAt": "2020-12-11T19:50:44Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -890,13 +890,20 @@ private synchronized Node coordinator() {\n         return this.coordinator;\n     }\n \n-    protected synchronized void markCoordinatorUnknown() {\n-        markCoordinatorUnknown(false);\n+\n+    protected synchronized void markCoordinatorUnknown(Errors error) {\n+        markCoordinatorUnknown(false, \"error response {}\" + error.message());\n+    }\n+\n+    protected synchronized void markCoordinatorUnknown(String cause) {\n+        markCoordinatorUnknown(false, cause);\n     }\n \n-    protected synchronized void markCoordinatorUnknown(boolean isDisconnected) {\n+    protected synchronized void markCoordinatorUnknown(boolean isDisconnected, String cause) {\n         if (this.coordinator != null) {\n-            log.info(\"Group coordinator {} is unavailable or invalid, will attempt rediscovery\", this.coordinator);\n+            log.info(\"Group coordinator {} is unavailable or invalid due to cause: {}.\"\n+                    + \"isDisconnected: {}. Rediscovery will attempted.\", this.coordinator,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIxODAyNA==", "bodyText": "Seems ok. Maybe \"without receiving a successful heartbeat response\"?", "url": "https://github.com/apache/kafka/pull/9729#discussion_r541218024", "createdAt": "2020-12-11T19:51:21Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -1355,7 +1362,7 @@ public void run() {\n                         } else if (heartbeat.sessionTimeoutExpired(now)) {\n                             // the session timeout has expired without seeing a successful heartbeat, so we should\n                             // probably make sure the coordinator is still healthy.\n-                            markCoordinatorUnknown();\n+                            markCoordinatorUnknown(\"session timed out without heartbeat\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3ODUxMA=="}, "originalCommit": {"oid": "1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a828d54bc1fde597e353afdf28a5b05985e1033", "author": {"user": {"login": "lbradstreet", "name": "Lucas Bradstreet"}}, "url": "https://github.com/apache/kafka/commit/2a828d54bc1fde597e353afdf28a5b05985e1033", "committedDate": "2020-12-11T23:43:13Z", "message": "Address feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjQ5Mzcy", "url": "https://github.com/apache/kafka/pull/9729#pullrequestreview-550649372", "createdAt": "2020-12-11T23:48:26Z", "commit": {"oid": "2a828d54bc1fde597e353afdf28a5b05985e1033"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMzo0ODoyNlrOIEV-wA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMzo0ODoyNlrOIEV-wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQyNTM0NA==", "bodyText": "Needs fixing", "url": "https://github.com/apache/kafka/pull/9729#discussion_r541425344", "createdAt": "2020-12-11T23:48:26Z", "author": {"login": "lbradstreet"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java", "diffHunk": "@@ -1311,7 +1311,7 @@ public void handle(OffsetFetchResponse response, RequestFuture<Map<TopicPartitio\n                     future.raise(error);\n                 } else if (error == Errors.NOT_COORDINATOR) {\n                     // re-discover the coordinator and retry\n-                    markCoordinatorUnknown();\n+                    markCoordinatorUnknown(error.message());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a828d54bc1fde597e353afdf28a5b05985e1033"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e06e0f5464a6eac918f4aa2693e7a797f2dfd75", "author": {"user": {"login": "lbradstreet", "name": "Lucas Bradstreet"}}, "url": "https://github.com/apache/kafka/commit/7e06e0f5464a6eac918f4aa2693e7a797f2dfd75", "committedDate": "2020-12-11T23:49:52Z", "message": "Pass errors correctly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMDExMTM0", "url": "https://github.com/apache/kafka/pull/9729#pullrequestreview-553011134", "createdAt": "2020-12-15T22:37:48Z", "commit": {"oid": "7e06e0f5464a6eac918f4aa2693e7a797f2dfd75"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2231, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}