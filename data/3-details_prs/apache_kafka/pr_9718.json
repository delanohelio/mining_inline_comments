{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0OTQyNzE0", "number": 9718, "title": "KAFKA-10832: Fix Log to use the correct ProducerStateManager instance when updating producers", "bodyText": "I have fixed what looked like a potential bug to me.\nBug:\nThe bug is that from within Log.updateProducers(\u2026), the code operates on the producerStateManager attribute of the Log instance instead of operating on an input parameter. Please see this LOC where it calls producerStateManager.prepareUpdate thus accessing the attribute from the Log object (see this). This looks unusual particularly for Log.loadProducersFromLog(...) path. Here I believe we should be using the instance passed to the method, rather than the attribute from the Log instance. I have fixed the same in this PR.\nI'm not sure (yet) if this bug has any drastic consequences (probably not), but it is still worthwhile making things consistent.\nFix:\nThe fix is to explicitly pass the ProducerStateManager into Log.updateProducers and move the following methods: Log.loadProducersFromLog and Log.updateProducers into the Log companion object.\nTests:\nRely on existing tests.", "createdAt": "2020-12-09T06:32:56Z", "url": "https://github.com/apache/kafka/pull/9718", "merged": true, "mergeCommit": {"oid": "cdf725828bc247078458de403b17190a9da07496"}, "closed": true, "closedAt": "2020-12-12T00:34:47Z", "author": {"login": "kowshik"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkYvZYAH2gAyNTM0OTQyNzE0OmYwNDY2YjI0MjBkYzUwMDExMmI0ODM5Njc4NTY0OTk2YzA2NzdkMmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlReTTgFqTU1MDY2MjUyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f0466b2420dc500112b4839678564996c0677d2e", "author": {"user": {"login": "kowshik", "name": "Kowshik Prakasam"}}, "url": "https://github.com/apache/kafka/commit/f0466b2420dc500112b4839678564996c0677d2e", "committedDate": "2020-12-09T06:28:00Z", "message": "MINOR: Use the correct ProducerStateManager when updating producers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d348bcc12f9e8b2ddf0552c089945b4eda67538", "author": {"user": {"login": "kowshik", "name": "Kowshik Prakasam"}}, "url": "https://github.com/apache/kafka/commit/6d348bcc12f9e8b2ddf0552c089945b4eda67538", "committedDate": "2020-12-10T21:11:32Z", "message": "Address comments from @ijuma"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5Njg3ODcz", "url": "https://github.com/apache/kafka/pull/9718#pullrequestreview-549687873", "createdAt": "2020-12-10T23:16:23Z", "commit": {"oid": "6d348bcc12f9e8b2ddf0552c089945b4eda67538"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzoxNjoyNFrOIDh2bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzoxNjoyNFrOIDh2bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3MTI0NA==", "bodyText": "This seems too large as a companion method. I am also not sure that we should pass along Log to this method since it exposes all internal states in Log, which make it harder to track usage.", "url": "https://github.com/apache/kafka/pull/9718#discussion_r540571244", "createdAt": "2020-12-10T23:16:24Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/log/Log.scala", "diffHunk": "@@ -2670,6 +2573,112 @@ object Log {\n   private def isLogFile(file: File): Boolean =\n     file.getPath.endsWith(LogFileSuffix)\n \n+  // Rebuild producer state until lastOffset. This method may be called from the recovery code path, and thus must be\n+  // free of all side-effects, i.e. it must not update any log-specific state.\n+  private def rebuildProducerState(log: Log,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d348bcc12f9e8b2ddf0552c089945b4eda67538"}, "originalPosition": 140}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb9a4496de7f42ae8f3e89d6b2118e71eeefbaf2", "author": {"user": {"login": "kowshik", "name": "Kowshik Prakasam"}}, "url": "https://github.com/apache/kafka/commit/eb9a4496de7f42ae8f3e89d6b2118e71eeefbaf2", "committedDate": "2020-12-11T02:13:59Z", "message": "Address comments from @junrao"}, "afterCommit": {"oid": "31f95a01c6ba66cc81fd5e8533213947b5946478", "author": {"user": {"login": "kowshik", "name": "Kowshik Prakasam"}}, "url": "https://github.com/apache/kafka/commit/31f95a01c6ba66cc81fd5e8533213947b5946478", "committedDate": "2020-12-11T02:21:52Z", "message": "Address comments from @junrao"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d798b7d884bd11e43884318ae3fc8d12e635c40", "author": {"user": {"login": "kowshik", "name": "Kowshik Prakasam"}}, "url": "https://github.com/apache/kafka/commit/5d798b7d884bd11e43884318ae3fc8d12e635c40", "committedDate": "2020-12-11T02:22:31Z", "message": "Address comments from @junrao"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31f95a01c6ba66cc81fd5e8533213947b5946478", "author": {"user": {"login": "kowshik", "name": "Kowshik Prakasam"}}, "url": "https://github.com/apache/kafka/commit/31f95a01c6ba66cc81fd5e8533213947b5946478", "committedDate": "2020-12-11T02:21:52Z", "message": "Address comments from @junrao"}, "afterCommit": {"oid": "5d798b7d884bd11e43884318ae3fc8d12e635c40", "author": {"user": {"login": "kowshik", "name": "Kowshik Prakasam"}}, "url": "https://github.com/apache/kafka/commit/5d798b7d884bd11e43884318ae3fc8d12e635c40", "committedDate": "2020-12-11T02:22:31Z", "message": "Address comments from @junrao"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTcxOTc1", "url": "https://github.com/apache/kafka/pull/9718#pullrequestreview-550571975", "createdAt": "2020-12-11T20:56:10Z", "commit": {"oid": "5d798b7d884bd11e43884318ae3fc8d12e635c40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDo1NjoxMFrOIENJ7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDo1NjoxMFrOIENJ7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI4MDc1MA==", "bodyText": "Perhaps this could be name loadProducersFromRecords?", "url": "https://github.com/apache/kafka/pull/9718#discussion_r541280750", "createdAt": "2020-12-11T20:56:10Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/log/Log.scala", "diffHunk": "@@ -2670,6 +2645,34 @@ object Log {\n   private def isLogFile(file: File): Boolean =\n     file.getPath.endsWith(LogFileSuffix)\n \n+  private def loadProducersFromLog(producerStateManager: ProducerStateManager, records: Records): Unit = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d798b7d884bd11e43884318ae3fc8d12e635c40"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec00e9f2226b976e618b402fd54b11b8405b5502", "author": {"user": {"login": "kowshik", "name": "Kowshik Prakasam"}}, "url": "https://github.com/apache/kafka/commit/ec00e9f2226b976e618b402fd54b11b8405b5502", "committedDate": "2020-12-11T21:03:47Z", "message": "Address comments from @junrao"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjYyNTIx", "url": "https://github.com/apache/kafka/pull/9718#pullrequestreview-550662521", "createdAt": "2020-12-12T00:33:55Z", "commit": {"oid": "ec00e9f2226b976e618b402fd54b11b8405b5502"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2614, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}