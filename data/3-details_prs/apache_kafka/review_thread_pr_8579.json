{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNDQzMTYz", "number": 8579, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwMzoxNjo0NFrOD3dckQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMjozMDo1MVrOEI-9Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5NDgwNzIxOnYy", "diffSide": "RIGHT", "path": "core/src/main/scala/kafka/server/AbstractFetcherThread.scala", "isResolved": false, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwMzoxNjo0NFrOGNuZkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQyMDo1NzoyOFrOGpLigA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA0NDg4Mg==", "bodyText": "Should it be info if we think this is expected? That would still show in the logs.", "url": "https://github.com/apache/kafka/pull/8579#discussion_r417044882", "createdAt": "2020-04-29T03:16:44Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/server/AbstractFetcherThread.scala", "diffHunk": "@@ -382,6 +382,11 @@ abstract class AbstractFetcherThread(name: String,\n                     \"that the partition is being moved\")\n                   partitionsWithError += topicPartition\n \n+                case Errors.UNKNOWN_TOPIC_OR_PARTITION =>\n+                  warn(s\"Remote broker does not host the partition $topicPartition, which could indicate \" +\n+                    \"that the partition is being created or deleted.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fec8239c562fe176ec83a776aff36b5122e14f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ2MDY4Mw==", "bodyText": "@ijuma I feel that info has an implicit implication that everything is \"fine\"; hence, I am concerned that it might be overlooked when investigating an issue.\nThe current broadcast-based approach in Kafka is just one way -- which arguably, has room for improvement -- of implementing state propagation for topic creation/deletion, and this error is a side-effect of it. Extended occurrence of this error can hamper the read/write availability as well as state consistency. Thus, even if UNKNOWN_TOPIC_OR_PARTITION is expected under the current design/implementation, it is definitely not desired.\nWhat are your thoughts?", "url": "https://github.com/apache/kafka/pull/8579#discussion_r417460683", "createdAt": "2020-04-29T16:46:53Z", "author": {"login": "efeg"}, "path": "core/src/main/scala/kafka/server/AbstractFetcherThread.scala", "diffHunk": "@@ -382,6 +382,11 @@ abstract class AbstractFetcherThread(name: String,\n                     \"that the partition is being moved\")\n                   partitionsWithError += topicPartition\n \n+                case Errors.UNKNOWN_TOPIC_OR_PARTITION =>\n+                  warn(s\"Remote broker does not host the partition $topicPartition, which could indicate \" +\n+                    \"that the partition is being created or deleted.\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA0NDg4Mg=="}, "originalCommit": {"oid": "4fec8239c562fe176ec83a776aff36b5122e14f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAzODEzNg==", "bodyText": "I think that relying on warnings in logs to detect propagation issues is difficult. We have metrics to indicate issues with failed replica fetches and such. Are those enough for these cases?", "url": "https://github.com/apache/kafka/pull/8579#discussion_r419038136", "createdAt": "2020-05-03T02:55:02Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/server/AbstractFetcherThread.scala", "diffHunk": "@@ -382,6 +382,11 @@ abstract class AbstractFetcherThread(name: String,\n                     \"that the partition is being moved\")\n                   partitionsWithError += topicPartition\n \n+                case Errors.UNKNOWN_TOPIC_OR_PARTITION =>\n+                  warn(s\"Remote broker does not host the partition $topicPartition, which could indicate \" +\n+                    \"that the partition is being created or deleted.\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA0NDg4Mg=="}, "originalCommit": {"oid": "4fec8239c562fe176ec83a776aff36b5122e14f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgzMzM0NA==", "bodyText": "@ijuma Thanks for your reply!\nWe both agree that relying on warnings in logs to detect propagation issues is not practical -- metrics indeed should be used in \"detection\" of such issues.\nI believe the focus of this discussion is the investigation of detected issues.\nMetrics typically fail to provide the level of details to examine the interaction of various events in a distributed environment. Hence, in case we need to look at the logs for figuring out such cases, I claim that being able to grep warns and see undesired events is useful -- as opposed to trying to browse info logs for bad/undesirable events.\nNote that in trunk, such UNKNOWN_TOPIC_OR_PARTITION events are already printed in a stronger level (i.e. error).", "url": "https://github.com/apache/kafka/pull/8579#discussion_r419833344", "createdAt": "2020-05-05T02:32:23Z", "author": {"login": "efeg"}, "path": "core/src/main/scala/kafka/server/AbstractFetcherThread.scala", "diffHunk": "@@ -382,6 +382,11 @@ abstract class AbstractFetcherThread(name: String,\n                     \"that the partition is being moved\")\n                   partitionsWithError += topicPartition\n \n+                case Errors.UNKNOWN_TOPIC_OR_PARTITION =>\n+                  warn(s\"Remote broker does not host the partition $topicPartition, which could indicate \" +\n+                    \"that the partition is being created or deleted.\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA0NDg4Mg=="}, "originalCommit": {"oid": "4fec8239c562fe176ec83a776aff36b5122e14f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA3MzUxOA==", "bodyText": "I still think that info would be a better log level for this. But let's get a second opinion from @junrao or @hachikuji.", "url": "https://github.com/apache/kafka/pull/8579#discussion_r432073518", "createdAt": "2020-05-28T19:36:34Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/server/AbstractFetcherThread.scala", "diffHunk": "@@ -382,6 +382,11 @@ abstract class AbstractFetcherThread(name: String,\n                     \"that the partition is being moved\")\n                   partitionsWithError += topicPartition\n \n+                case Errors.UNKNOWN_TOPIC_OR_PARTITION =>\n+                  warn(s\"Remote broker does not host the partition $topicPartition, which could indicate \" +\n+                    \"that the partition is being created or deleted.\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA0NDg4Mg=="}, "originalCommit": {"oid": "4fec8239c562fe176ec83a776aff36b5122e14f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQwNjc2MA==", "bodyText": "I don't have a strong opinion on this one. I guess we would most likely see this in startup cases where the remote broker has just started and may not have gotten the full metadata yet. If we fixed that common case, then I think there would be a stronger case to change this to warn. Otherwise, we'd just learn to ignore them in spite of the higher level.", "url": "https://github.com/apache/kafka/pull/8579#discussion_r436406760", "createdAt": "2020-06-07T22:13:51Z", "author": {"login": "hachikuji"}, "path": "core/src/main/scala/kafka/server/AbstractFetcherThread.scala", "diffHunk": "@@ -382,6 +382,11 @@ abstract class AbstractFetcherThread(name: String,\n                     \"that the partition is being moved\")\n                   partitionsWithError += topicPartition\n \n+                case Errors.UNKNOWN_TOPIC_OR_PARTITION =>\n+                  warn(s\"Remote broker does not host the partition $topicPartition, which could indicate \" +\n+                    \"that the partition is being created or deleted.\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA0NDg4Mg=="}, "originalCommit": {"oid": "4fec8239c562fe176ec83a776aff36b5122e14f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc1MTg5Nw==", "bodyText": "If a broker is restarted, it typically doesn't have any leader replicas and won't receive follower requests. So, this is mostly related to topic creation/deletion. When there is topic creation/deletion, receiving transient UNKNOWN_TOPIC_OR_PARTITION is expected. But sustained UNKNOWN_TOPIC_OR_PARTITION is unexpected. So, perhaps we could keep the logging at WARN, but tweak the message a bit to sth like \"Receiving UNKNOWN_TOPIC_OR_PARTITION from the leader for partition XXXX. This can happen transiently if the partition is being created or deleted. However, this is unexpected if it sustains.\"", "url": "https://github.com/apache/kafka/pull/8579#discussion_r445751897", "createdAt": "2020-06-25T18:22:26Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/server/AbstractFetcherThread.scala", "diffHunk": "@@ -382,6 +382,11 @@ abstract class AbstractFetcherThread(name: String,\n                     \"that the partition is being moved\")\n                   partitionsWithError += topicPartition\n \n+                case Errors.UNKNOWN_TOPIC_OR_PARTITION =>\n+                  warn(s\"Remote broker does not host the partition $topicPartition, which could indicate \" +\n+                    \"that the partition is being created or deleted.\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA0NDg4Mg=="}, "originalCommit": {"oid": "4fec8239c562fe176ec83a776aff36b5122e14f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgzMzg1Ng==", "bodyText": "@junrao @hachikuji @ijuma Thanks for the review!\nI updated the message as per Jun's recommendation -- please let me know if further changes needed.", "url": "https://github.com/apache/kafka/pull/8579#discussion_r445833856", "createdAt": "2020-06-25T20:57:28Z", "author": {"login": "efeg"}, "path": "core/src/main/scala/kafka/server/AbstractFetcherThread.scala", "diffHunk": "@@ -382,6 +382,11 @@ abstract class AbstractFetcherThread(name: String,\n                     \"that the partition is being moved\")\n                   partitionsWithError += topicPartition\n \n+                case Errors.UNKNOWN_TOPIC_OR_PARTITION =>\n+                  warn(s\"Remote broker does not host the partition $topicPartition, which could indicate \" +\n+                    \"that the partition is being created or deleted.\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA0NDg4Mg=="}, "originalCommit": {"oid": "4fec8239c562fe176ec83a776aff36b5122e14f2"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3ODU1NTE4OnYy", "diffSide": "RIGHT", "path": "core/src/main/scala/kafka/server/AbstractFetcherThread.scala", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMjozMDo1MVrOGpRzpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzo1Mjo1NVrOGppskA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzNjU0OQ==", "bodyText": "Thanks for the update. I think the following reads a bit better and is a bit more consistent with the other messages:\ns\"Received ${Errors.UNKNOWN_TOPIC_OR_PARTITION} from the leader for partition $topicPartition. \" +\n\"This error may be returned transiently when the partition is being created or deleted, but it is not \" +\n\"expected to persist.\")", "url": "https://github.com/apache/kafka/pull/8579#discussion_r445936549", "createdAt": "2020-06-26T02:30:51Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/server/AbstractFetcherThread.scala", "diffHunk": "@@ -382,6 +382,12 @@ abstract class AbstractFetcherThread(name: String,\n                     \"that the partition is being moved\")\n                   partitionsWithError += topicPartition\n \n+                case Errors.UNKNOWN_TOPIC_OR_PARTITION =>\n+                  warn(s\"Receiving ${Errors.UNKNOWN_TOPIC_OR_PARTITION} from the leader for partition $topicPartition. \" +\n+                       s\"This can happen transiently if the partition is being created or deleted. \" +\n+                       s\"However, this is unexpected if it sustains.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9e16f693de60b62da59175da8c61fd419c9a463"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyNzk1Mg==", "bodyText": "@ijuma thanks for the update -- let me know if further changes needed.", "url": "https://github.com/apache/kafka/pull/8579#discussion_r446327952", "createdAt": "2020-06-26T17:52:55Z", "author": {"login": "efeg"}, "path": "core/src/main/scala/kafka/server/AbstractFetcherThread.scala", "diffHunk": "@@ -382,6 +382,12 @@ abstract class AbstractFetcherThread(name: String,\n                     \"that the partition is being moved\")\n                   partitionsWithError += topicPartition\n \n+                case Errors.UNKNOWN_TOPIC_OR_PARTITION =>\n+                  warn(s\"Receiving ${Errors.UNKNOWN_TOPIC_OR_PARTITION} from the leader for partition $topicPartition. \" +\n+                       s\"This can happen transiently if the partition is being created or deleted. \" +\n+                       s\"However, this is unexpected if it sustains.\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzNjU0OQ=="}, "originalCommit": {"oid": "a9e16f693de60b62da59175da8c61fd419c9a463"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2825, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}