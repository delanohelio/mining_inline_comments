{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNjI2MzQx", "number": 8444, "title": "KAFKA-8869: Remove task configs for deleted connectors from config snapshot", "bodyText": "Jira\nCurrently, if a connector is deleted, its task configurations will remain in the config snapshot tracked by the KafkaConfigBackingStore. This causes issues with incremental cooperative rebalancing, which utilizes that config snapshot to determine which connectors and tasks need to be assigned across the cluster. Specifically, it first checks to see which connectors are present in the config snapshot, and then, for each of those connectors, queries the snapshot for that connector's task configs.\nThe lifecycle of a connector is for its configuration to be written to the config topic, that write to be picked up by the workers in the cluster and trigger a rebalance, the connector to be assigned to and started by a worker, task configs to be generated by the connector and then written to the config topic, that write to be picked up by the workers in the cluster and trigger a second rebalance, and finally, the tasks to be assigned to and started by workers across the cluster.\nThere is a brief period in between the first time the connector is started and when the second rebalance has completed during which those stale task configs from a previously-deleted version of the connector will be used by the framework to start tasks for that connector.\nThis fix aims to eliminate that window by preemptively clearing the task configs from the config snapshot for a connector whenever it has been deleted.\nAn existing unit test is modified to verify this behavior, and should provide sufficient guarantees that the bug has been fixed, since the cause of the behavior has been narrowed down to incorrect values in the taskConfigs field for the ClusterConfigState provided by the KafkaConfigBackingStore.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-04-08T04:48:16Z", "url": "https://github.com/apache/kafka/pull/8444", "merged": true, "mergeCommit": {"oid": "82f5efabc9249e0accf530a6a82afc2f32e65ec6"}, "closed": true, "closedAt": "2020-05-21T03:15:44Z", "author": {"login": "C0urante"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVgTChgH2gAyNDAwNjI2MzQxOjk5MGQ2M2IyNTc0ZGUwZGQzZGE1ZTc1MzkzZjJhZjFkMDkzZjdhMTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjU2CCgFqTQxNTg1MDQyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "990d63b2574de0dd3da5e75393f2af1d093f7a12", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/990d63b2574de0dd3da5e75393f2af1d093f7a12", "committedDate": "2020-04-08T04:36:15Z", "message": "KAFKA-8869: Remove task configs for deleted connectors from config snapshot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NzUxMjE2", "url": "https://github.com/apache/kafka/pull/8444#pullrequestreview-389751216", "createdAt": "2020-04-08T08:19:53Z", "commit": {"oid": "990d63b2574de0dd3da5e75393f2af1d093f7a12"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODoxOTo1M1rOGCkJaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODoxOTo1M1rOGCkJaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0MjU3MQ==", "bodyText": "Do you think it is worth also updating connectorTaskCounts to keep these in sync?", "url": "https://github.com/apache/kafka/pull/8444#discussion_r405342571", "createdAt": "2020-04-08T08:19:53Z", "author": {"login": "ncliang"}, "path": "connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaConfigBackingStore.java", "diffHunk": "@@ -548,6 +548,7 @@ public void onCompletion(Throwable error, ConsumerRecord<String, byte[]> record)\n                         // Connector deletion will be written as a null value\n                         log.info(\"Successfully processed removal of connector '{}'\", connectorName);\n                         connectorConfigs.remove(connectorName);\n+                        taskConfigs.keySet().removeIf(taskId -> taskId.connector().equals(connectorName));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "990d63b2574de0dd3da5e75393f2af1d093f7a12"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8225b29541689adfd465c92649228786831d655d", "author": {"user": {"login": "C0urante", "name": "Chris Egerton"}}, "url": "https://github.com/apache/kafka/commit/8225b29541689adfd465c92649228786831d655d", "committedDate": "2020-04-08T20:59:03Z", "message": "KAFKA-8869: Remove task count for deleted connectors from config snapshot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzY5MDI5", "url": "https://github.com/apache/kafka/pull/8444#pullrequestreview-390369029", "createdAt": "2020-04-08T22:14:44Z", "commit": {"oid": "8225b29541689adfd465c92649228786831d655d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1ODUwNDIx", "url": "https://github.com/apache/kafka/pull/8444#pullrequestreview-415850421", "createdAt": "2020-05-21T03:10:33Z", "commit": {"oid": "8225b29541689adfd465c92649228786831d655d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1412, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}