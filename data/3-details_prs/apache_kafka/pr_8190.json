{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMTU4MDkw", "number": 8190, "title": "KAFKA-9623: Keep polling until the task manager is no longer rebalancing in progress", "bodyText": "This bug is found via the flaky SmokeTestDriverIntegrationTest. Without this PR the test fails every 3-4 times, after this issue is fixed we've run the test 20+ locally without error.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-02-28T01:32:39Z", "url": "https://github.com/apache/kafka/pull/8190", "merged": true, "mergeCommit": {"oid": "e0551acce434985acbbf28e441aa2d4af033b1b5"}, "closed": true, "closedAt": "2020-02-28T22:15:56Z", "author": {"login": "guozhangwang"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIlorsAH2gAyMzgxMTU4MDkwOmZlNGNhMDcwNTEyMWJhYmZiZTIzY2EwZTc1OGNkYzlkZmVkZmQ3Y2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcI2idFgFqTM2NjY4NjkxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fe4ca0705121babfbe23ca0e758cdc9dfedfd7cc", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/fe4ca0705121babfbe23ca0e758cdc9dfedfd7cc", "committedDate": "2020-02-28T01:28:24Z", "message": "add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84791c9a2da624b9d0c9dcffef2d0a4eb5e6d560", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/84791c9a2da624b9d0c9dcffef2d0a4eb5e6d560", "committedDate": "2020-02-28T01:33:51Z", "message": "revert changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MTEyMjU0", "url": "https://github.com/apache/kafka/pull/8190#pullrequestreview-366112254", "createdAt": "2020-02-28T01:32:51Z", "commit": {"oid": "fe4ca0705121babfbe23ca0e758cdc9dfedfd7cc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMTozMjo1MVrOFvm7Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMTozMzoxOVrOFvm77Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ2NTE2Ng==", "bodyText": "This is the actual fix.", "url": "https://github.com/apache/kafka/pull/8190#discussion_r385465166", "createdAt": "2020-02-28T01:32:51Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -744,7 +744,9 @@ public void run() {\n     private void runLoop() {\n         subscribeConsumer();\n \n-        while (isRunning()) {\n+        // if the thread is still in the middle of a rebalance, we should keep polling\n+        // until the rebalance is completed before we close and commit the tasks\n+        while (isRunning() || taskManager.isRebalanceInProgress()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe4ca0705121babfbe23ca0e758cdc9dfedfd7cc"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ2NTMyNQ==", "bodyText": "We need to put this out of the loop since if we get an error code, we should still set the flag so that thread can complete shutdown.", "url": "https://github.com/apache/kafka/pull/8190#discussion_r385465325", "createdAt": "2020-02-28T01:33:19Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsRebalanceListener.java", "diffHunk": "@@ -50,10 +50,10 @@ public void onPartitionsAssigned(final Collection<TopicPartition> partitions) {\n             log.error(\"Received error code {} - shutdown\", streamThread.getAssignmentErrorCode());\n             streamThread.shutdown();\n         } else {\n-            taskManager.handleRebalanceComplete();\n-\n             streamThread.setState(State.PARTITIONS_ASSIGNED);\n         }\n+\n+        taskManager.handleRebalanceComplete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe4ca0705121babfbe23ca0e758cdc9dfedfd7cc"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MTcyODE0", "url": "https://github.com/apache/kafka/pull/8190#pullrequestreview-366172814", "createdAt": "2020-02-28T05:50:45Z", "commit": {"oid": "84791c9a2da624b9d0c9dcffef2d0a4eb5e6d560"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjM3MDI2", "url": "https://github.com/apache/kafka/pull/8190#pullrequestreview-366637026", "createdAt": "2020-02-28T19:35:44Z", "commit": {"oid": "84791c9a2da624b9d0c9dcffef2d0a4eb5e6d560"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2Njg2OTE1", "url": "https://github.com/apache/kafka/pull/8190#pullrequestreview-366686915", "createdAt": "2020-02-28T21:09:59Z", "commit": {"oid": "84791c9a2da624b9d0c9dcffef2d0a4eb5e6d560"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1623, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}