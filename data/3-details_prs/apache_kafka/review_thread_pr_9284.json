{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2NjQ4MTE0", "number": 9284, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNzo1NDowOVrOEkqLFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMzoxOTozOVrOEoSuXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2ODc1MTU4OnYy", "diffSide": "RIGHT", "path": "core/src/main/scala/kafka/server/DynamicBrokerConfig.scala", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNzo1NDowOVrOHTusGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNzo1NDowOVrOHTusGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ0OTk0Nw==", "bodyText": "Right, this line does not work correctly as of present.", "url": "https://github.com/apache/kafka/pull/9284#discussion_r490449947", "createdAt": "2020-09-17T17:54:09Z", "author": {"login": "dongjinleekr"}, "path": "core/src/main/scala/kafka/server/DynamicBrokerConfig.scala", "diffHunk": "@@ -910,6 +903,11 @@ class DynamicListenerConfig(server: KafkaServer) extends BrokerReconfigurable wi\n     if (!newListeners.keySet.subsetOf(newConfig.listenerSecurityProtocolMap.keySet))\n       throw new ConfigException(s\"Listeners '$newListeners' must be subset of listener map '${newConfig.listenerSecurityProtocolMap}'\")\n     newListeners.keySet.intersect(oldListeners.keySet).foreach { listenerName =>\n+      def immutableListenerConfigs(kafkaConfig: KafkaConfig, prefix: String): Map[String, AnyRef] = {\n+        kafkaConfig.originals.asScala.filter { case (key, _) =>\n+          key.startsWith(prefix) && !DynamicSecurityConfigs.contains(key)\n+        }\n+      }\n       val prefix = listenerName.configPrefix\n       val newListenerProps = immutableListenerConfigs(newConfig, prefix)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNDg0MTg2OnYy", "diffSide": "RIGHT", "path": "docs/upgrade.html", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNDoxNjoxOFrOHY_0Pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNTowMjo1OFrOHZCPUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3MzQzOA==", "bodyText": "Does it really break compatibility? It seems like the previous behavior wasn't working as intended anyway.", "url": "https://github.com/apache/kafka/pull/9284#discussion_r495973438", "createdAt": "2020-09-28T14:16:18Z", "author": {"login": "ijuma"}, "path": "docs/upgrade.html", "diffHunk": "@@ -27,6 +27,14 @@ <h5><a id=\"upgrade_270_notable\" href=\"#upgrade_270_notable\">Notable changes in 2\n         <code>default.api.timeout.ms</code>, and Kafka Streams' new <code>task.timeout.ms</code> parameters instead.\n         Note that parameter <code>retry.backoff.ms</code> is not impacted by this change.\n     </li>\n+    <li>Altering non-reconfigurable configs of existent listeners causes <code>InvalidRequestException</code>.\n+        By contrast, the previous behavior would have caused the updated configuration to be persisted, but it wouldn't\n+        take effect until the broker was restarted. This change breaks behavior compatibility but the old behavior is not\n+        worth keeping since that behavior is unintended. see\n+        <a href=\"https://github.com/apache/kafka/pull/9284\">KAFKA-10479</a> for more discussion.\n+        see <code>DynamicBrokerConfig.DynamicSecurityConfigs</code> and <code>SocketServer.ListenerReconfigurableConfigs</code>\n+        for reconfigurable configs of existent listeners.\n+    </li>", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk4MzI4Mw==", "bodyText": "Does it really break compatibility? It seems like the previous behavior wasn't working as intended anyway.\n\nIt seems to me the APIs behavior is changed so the compatibility is broken.\nFor example, the code which is used to change non-reconfigurable configs gets exception now so users have to write something to handle \"new\" exception. Of course, that case should be very rare so mentioning this in docs/upgrade.html is enough to this incompatible change.", "url": "https://github.com/apache/kafka/pull/9284#discussion_r495983283", "createdAt": "2020-09-28T14:29:48Z", "author": {"login": "chia7712"}, "path": "docs/upgrade.html", "diffHunk": "@@ -27,6 +27,14 @@ <h5><a id=\"upgrade_270_notable\" href=\"#upgrade_270_notable\">Notable changes in 2\n         <code>default.api.timeout.ms</code>, and Kafka Streams' new <code>task.timeout.ms</code> parameters instead.\n         Note that parameter <code>retry.backoff.ms</code> is not impacted by this change.\n     </li>\n+    <li>Altering non-reconfigurable configs of existent listeners causes <code>InvalidRequestException</code>.\n+        By contrast, the previous behavior would have caused the updated configuration to be persisted, but it wouldn't\n+        take effect until the broker was restarted. This change breaks behavior compatibility but the old behavior is not\n+        worth keeping since that behavior is unintended. see\n+        <a href=\"https://github.com/apache/kafka/pull/9284\">KAFKA-10479</a> for more discussion.\n+        see <code>DynamicBrokerConfig.DynamicSecurityConfigs</code> and <code>SocketServer.ListenerReconfigurableConfigs</code>\n+        for reconfigurable configs of existent listeners.\n+    </li>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3MzQzOA=="}, "originalCommit": null, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk4ODE1Mw==", "bodyText": "I know what you're saying, but this change aligns the implementation with the specified behavior. The previous behavior was a bug as it failed to report an error even though it did not change the config dynamically.", "url": "https://github.com/apache/kafka/pull/9284#discussion_r495988153", "createdAt": "2020-09-28T14:36:17Z", "author": {"login": "ijuma"}, "path": "docs/upgrade.html", "diffHunk": "@@ -27,6 +27,14 @@ <h5><a id=\"upgrade_270_notable\" href=\"#upgrade_270_notable\">Notable changes in 2\n         <code>default.api.timeout.ms</code>, and Kafka Streams' new <code>task.timeout.ms</code> parameters instead.\n         Note that parameter <code>retry.backoff.ms</code> is not impacted by this change.\n     </li>\n+    <li>Altering non-reconfigurable configs of existent listeners causes <code>InvalidRequestException</code>.\n+        By contrast, the previous behavior would have caused the updated configuration to be persisted, but it wouldn't\n+        take effect until the broker was restarted. This change breaks behavior compatibility but the old behavior is not\n+        worth keeping since that behavior is unintended. see\n+        <a href=\"https://github.com/apache/kafka/pull/9284\">KAFKA-10479</a> for more discussion.\n+        see <code>DynamicBrokerConfig.DynamicSecurityConfigs</code> and <code>SocketServer.ListenerReconfigurableConfigs</code>\n+        for reconfigurable configs of existent listeners.\n+    </li>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3MzQzOA=="}, "originalCommit": null, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk5MjE2OQ==", "bodyText": "The previous behavior was a bug as it failed to report an error even though it did not change the config dynamically.\n\nok. it makes sense. I will remove this comment from docs/upgrade.html", "url": "https://github.com/apache/kafka/pull/9284#discussion_r495992169", "createdAt": "2020-09-28T14:41:58Z", "author": {"login": "chia7712"}, "path": "docs/upgrade.html", "diffHunk": "@@ -27,6 +27,14 @@ <h5><a id=\"upgrade_270_notable\" href=\"#upgrade_270_notable\">Notable changes in 2\n         <code>default.api.timeout.ms</code>, and Kafka Streams' new <code>task.timeout.ms</code> parameters instead.\n         Note that parameter <code>retry.backoff.ms</code> is not impacted by this change.\n     </li>\n+    <li>Altering non-reconfigurable configs of existent listeners causes <code>InvalidRequestException</code>.\n+        By contrast, the previous behavior would have caused the updated configuration to be persisted, but it wouldn't\n+        take effect until the broker was restarted. This change breaks behavior compatibility but the old behavior is not\n+        worth keeping since that behavior is unintended. see\n+        <a href=\"https://github.com/apache/kafka/pull/9284\">KAFKA-10479</a> for more discussion.\n+        see <code>DynamicBrokerConfig.DynamicSecurityConfigs</code> and <code>SocketServer.ListenerReconfigurableConfigs</code>\n+        for reconfigurable configs of existent listeners.\n+    </li>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3MzQzOA=="}, "originalCommit": null, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAxMTczNA==", "bodyText": "I think we should keep the comment, I was suggesting we tweak the description.", "url": "https://github.com/apache/kafka/pull/9284#discussion_r496011734", "createdAt": "2020-09-28T15:01:40Z", "author": {"login": "ijuma"}, "path": "docs/upgrade.html", "diffHunk": "@@ -27,6 +27,14 @@ <h5><a id=\"upgrade_270_notable\" href=\"#upgrade_270_notable\">Notable changes in 2\n         <code>default.api.timeout.ms</code>, and Kafka Streams' new <code>task.timeout.ms</code> parameters instead.\n         Note that parameter <code>retry.backoff.ms</code> is not impacted by this change.\n     </li>\n+    <li>Altering non-reconfigurable configs of existent listeners causes <code>InvalidRequestException</code>.\n+        By contrast, the previous behavior would have caused the updated configuration to be persisted, but it wouldn't\n+        take effect until the broker was restarted. This change breaks behavior compatibility but the old behavior is not\n+        worth keeping since that behavior is unintended. see\n+        <a href=\"https://github.com/apache/kafka/pull/9284\">KAFKA-10479</a> for more discussion.\n+        see <code>DynamicBrokerConfig.DynamicSecurityConfigs</code> and <code>SocketServer.ListenerReconfigurableConfigs</code>\n+        for reconfigurable configs of existent listeners.\n+    </li>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3MzQzOA=="}, "originalCommit": null, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAxMzEzNw==", "bodyText": "I think we should keep the comment, I was suggesting we tweak the description.\n\ngot it.", "url": "https://github.com/apache/kafka/pull/9284#discussion_r496013137", "createdAt": "2020-09-28T15:02:58Z", "author": {"login": "chia7712"}, "path": "docs/upgrade.html", "diffHunk": "@@ -27,6 +27,14 @@ <h5><a id=\"upgrade_270_notable\" href=\"#upgrade_270_notable\">Notable changes in 2\n         <code>default.api.timeout.ms</code>, and Kafka Streams' new <code>task.timeout.ms</code> parameters instead.\n         Note that parameter <code>retry.backoff.ms</code> is not impacted by this change.\n     </li>\n+    <li>Altering non-reconfigurable configs of existent listeners causes <code>InvalidRequestException</code>.\n+        By contrast, the previous behavior would have caused the updated configuration to be persisted, but it wouldn't\n+        take effect until the broker was restarted. This change breaks behavior compatibility but the old behavior is not\n+        worth keeping since that behavior is unintended. see\n+        <a href=\"https://github.com/apache/kafka/pull/9284\">KAFKA-10479</a> for more discussion.\n+        see <code>DynamicBrokerConfig.DynamicSecurityConfigs</code> and <code>SocketServer.ListenerReconfigurableConfigs</code>\n+        for reconfigurable configs of existent listeners.\n+    </li>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3MzQzOA=="}, "originalCommit": null, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNDg0NTgzOnYy", "diffSide": "RIGHT", "path": "core/src/test/scala/unit/kafka/server/DynamicBrokerConfigTest.scala", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNDoxNzoxOFrOHY_20g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNDozMDoyNVrOHZAcmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3NDA5OA==", "bodyText": "It is possible to update configs of existing listeners if they are dynamic, right?", "url": "https://github.com/apache/kafka/pull/9284#discussion_r495974098", "createdAt": "2020-09-28T14:17:18Z", "author": {"login": "ijuma"}, "path": "core/src/test/scala/unit/kafka/server/DynamicBrokerConfigTest.scala", "diffHunk": "@@ -327,10 +327,12 @@ class DynamicBrokerConfigTest {\n     EasyMock.replay(kafkaServer)\n \n     props.put(KafkaConfig.ListenersProp, \"PLAINTEXT://hostname:9092,SASL_PLAINTEXT://hostname:9093\")\n-    val newConfig = KafkaConfig(props)\n+    new DynamicListenerConfig(kafkaServer).validateReconfiguration(KafkaConfig(props))\n \n+    // it is illegal to update configs of existent listeners\n+    props.put(\"listener.name.plaintext.you.should.not.pass\", \"failure\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk4Mzc2OA==", "bodyText": "you are right. I will revise the comment.", "url": "https://github.com/apache/kafka/pull/9284#discussion_r495983768", "createdAt": "2020-09-28T14:30:25Z", "author": {"login": "chia7712"}, "path": "core/src/test/scala/unit/kafka/server/DynamicBrokerConfigTest.scala", "diffHunk": "@@ -327,10 +327,12 @@ class DynamicBrokerConfigTest {\n     EasyMock.replay(kafkaServer)\n \n     props.put(KafkaConfig.ListenersProp, \"PLAINTEXT://hostname:9092,SASL_PLAINTEXT://hostname:9093\")\n-    val newConfig = KafkaConfig(props)\n+    new DynamicListenerConfig(kafkaServer).validateReconfiguration(KafkaConfig(props))\n \n+    // it is illegal to update configs of existent listeners\n+    props.put(\"listener.name.plaintext.you.should.not.pass\", \"failure\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3NDA5OA=="}, "originalCommit": null, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNjg1Mjc3OnYy", "diffSide": "RIGHT", "path": "docs/upgrade.html", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMzoxOTozOVrOHZS-Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQwMjoyNDozOFrOHZWOmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4NzI3NA==", "bodyText": "nit: can we take out the sentence about behavior compatibility. I think it is enough to say that the previous behavior was unintended.", "url": "https://github.com/apache/kafka/pull/9284#discussion_r496287274", "createdAt": "2020-09-28T23:19:39Z", "author": {"login": "hachikuji"}, "path": "docs/upgrade.html", "diffHunk": "@@ -27,6 +27,14 @@ <h5><a id=\"upgrade_270_notable\" href=\"#upgrade_270_notable\">Notable changes in 2\n         <code>default.api.timeout.ms</code>, and Kafka Streams' new <code>task.timeout.ms</code> parameters instead.\n         Note that parameter <code>retry.backoff.ms</code> is not impacted by this change.\n     </li>\n+    <li>Altering non-reconfigurable configs of existent listeners causes <code>InvalidRequestException</code>.\n+        By contrast, the previous behavior would have caused the updated configuration to be persisted, but it wouldn't\n+        take effect until the broker was restarted. This change breaks behavior compatibility but the old behavior is not", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "877cbe5b3eb6dfc671c4bb7c13b445afb1e666de"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM0MDYzMg==", "bodyText": "I had deleted the sentence about behavior compatibility :)", "url": "https://github.com/apache/kafka/pull/9284#discussion_r496340632", "createdAt": "2020-09-29T02:24:38Z", "author": {"login": "chia7712"}, "path": "docs/upgrade.html", "diffHunk": "@@ -27,6 +27,14 @@ <h5><a id=\"upgrade_270_notable\" href=\"#upgrade_270_notable\">Notable changes in 2\n         <code>default.api.timeout.ms</code>, and Kafka Streams' new <code>task.timeout.ms</code> parameters instead.\n         Note that parameter <code>retry.backoff.ms</code> is not impacted by this change.\n     </li>\n+    <li>Altering non-reconfigurable configs of existent listeners causes <code>InvalidRequestException</code>.\n+        By contrast, the previous behavior would have caused the updated configuration to be persisted, but it wouldn't\n+        take effect until the broker was restarted. This change breaks behavior compatibility but the old behavior is not", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4NzI3NA=="}, "originalCommit": {"oid": "877cbe5b3eb6dfc671c4bb7c13b445afb1e666de"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1830, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}