{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMTgxNzMz", "number": 8058, "title": "KAFKA-9481: Graceful handling TaskMigrated and TaskCorrupted", "bodyText": "Removed task field from TaskMigrated; the only caller that encodes a task id from StreamTask actually do not throw so we only log it. To handle it on StreamThread we just always enforce rebalance (and we would call onPartitionsLost to remove all tasks as dirty).\n\n\nAdded TaskCorruptedException with a set of task-ids. The first scenario of this is the restoreConsumer.poll which throws InvalidOffset indicating that the logs are truncated / compacted. To handle it on StreamThread we first close the corresponding tasks as dirty (if EOS is enabled we would also wipe out the state stores), and then revive them into the CREATED state.\n\n\nAlso fixed a bug while investigating KAFKA-9572: when suspending / closing a restoring task we should not commit the new offsets but only updating the checkpoint file.\n\n\nRe-enabled the unit test.\n\n\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-02-07T00:44:06Z", "url": "https://github.com/apache/kafka/pull/8058", "merged": true, "mergeCommit": {"oid": "3b6573c150527efb3e90b2b3d1a059ac5c2db80b"}, "closed": true, "closedAt": "2020-02-21T00:14:46Z", "author": {"login": "guozhangwang"}, "timelineItems": {"totalCount": 36, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBcYeggH2gAyMzcyMTgxNzMzOjNiZmQ4N2MzNzAzMmIxYTZiZGQzNDNlMmVlMTM1ZDBiM2JmMzNiNmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGT3NwAFqTM2MjMxMjc4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f", "committedDate": "2020-02-05T20:44:05Z", "message": "add timer for update limit offsets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7493782dc28e02a132823b236ea275b066f058ac", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/7493782dc28e02a132823b236ea275b066f058ac", "committedDate": "2020-02-06T19:54:05Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KMinor-changelog-reader-limit-offset-update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33af581d8cb942c5123e4dfc019514aa99129ba8", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/33af581d8cb942c5123e4dfc019514aa99129ba8", "committedDate": "2020-02-06T21:09:55Z", "message": "consumer.position invalid offset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4419900a7f26906a60c0658f4290cd7a2e2d07c6", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/4419900a7f26906a60c0658f4290cd7a2e2d07c6", "committedDate": "2020-02-06T23:14:09Z", "message": "add task corrupted logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23cd292d4497e5c9d64c6c2efea69e570b72791a", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/23cd292d4497e5c9d64c6c2efea69e570b72791a", "committedDate": "2020-02-07T00:31:57Z", "message": "re-enable the unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/112d9c6c4cc2113333561d2c4581131491fe217a", "committedDate": "2020-02-07T00:45:48Z", "message": "rebased"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODcxNzQx", "url": "https://github.com/apache/kafka/pull/8058#pullrequestreview-354871741", "createdAt": "2020-02-07T00:49:08Z", "commit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDo0OTowOVrOFmvJtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDo1ODoxOFrOFmvTtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE2Mjc0MQ==", "bodyText": "We need to clear the stores map now since we may re-initialize the state stores upon reviving a task.", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376162741", "createdAt": "2020-02-07T00:49:09Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -415,6 +415,8 @@ public void close() throws ProcessorStateException {\n                     log.error(\"Failed to close state store {}: \", store.name(), exception);\n                 }\n             }\n+\n+            stores.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE2MjkxNw==", "bodyText": "This case 1) would be done in another PR, I just added the java-doc here to complete the scope.", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376162917", "createdAt": "2020-02-07T00:49:48Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/errors/TaskCorruptedException.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.streams.errors;\n+\n+import org.apache.kafka.streams.processor.TaskId;\n+\n+import java.util.Set;\n+\n+/**\n+ * Indicates a specific task is corrupted and need to be re-initialized. It can be thrown when\n+ *\n+ * 1) Under EOS, if the checkpoint file does not contain offsets for corresponding store's changelogs, meaning", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE2MzA4MQ==", "bodyText": "Here I made the remove call idempotent.", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376163081", "createdAt": "2020-02-07T00:50:24Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -690,18 +704,18 @@ private void pauseChangelogsFromRestoreConsumer(final Collection<TopicPartition>\n                 \"does not contain some of the partitions \" + partitions + \" for pausing.\");\n         }\n         restoreConsumer.pause(partitions);\n+\n+        log.debug(\"Paused partitions {} from the restore consumer\", partitions);\n     }\n \n     private void removeChangelogsFromRestoreConsumer(final Collection<TopicPartition> partitions) {\n         final Set<TopicPartition> assignment = new HashSet<>(restoreConsumer.assignment());\n \n-        // the current assignment should contain the all partitions to remove\n-        if (!assignment.containsAll(partitions)) {\n-            throw new IllegalStateException(\"The current assignment \" + assignment + \" \" +\n-                \"does not contain some of the partitions \" + partitions + \" for removing.\");\n+        if (assignment.removeAll(partitions)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE2NDEyOQ==", "bodyText": "Okay this might be a bit controversial: I tried to make the re-initialization logic as cheap as possible since otherwise we may be kicked out of the group for not calling consumer.poll in time. After looking at the source code I found the only part is the closure of the task-level sensors which I moved out of the task.close functions. So from CLOSED -> CREATED there's nothing necessary.", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376164129", "createdAt": "2020-02-07T00:54:07Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/Task.java", "diffHunk": "@@ -154,6 +154,11 @@ public boolean isValidTransition(final State newState) {\n      */\n     void closeDirty();\n \n+    /**\n+     * Revive a closed task to a created one; should never throw an exception\n+     */\n+    void revive();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE2NDYwMA==", "bodyText": "We have to call changelog.remove() before task.closeDirty since now we clear the stores map in closeDirty, and after that task.changelogPartitions() would return nothing.", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376164600", "createdAt": "2020-02-07T00:55:47Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -117,6 +120,19 @@ void handleRebalanceComplete() {\n         rebalanceInProgress = false;\n     }\n \n+    void handleCorruption(final Set<TaskId> taskIds) {\n+        for (final TaskId taskId : taskIds) {\n+            final Task task = tasks.get(taskId);\n+\n+            // this call is idempotent so even if the task is only CREATED we can still call it\n+            changelogReader.remove(task.changelogPartitions());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE2NDg0Mw==", "bodyText": "Consolidated a couple of the same pattern into this private function.", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376164843", "createdAt": "2020-02-07T00:56:39Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -147,20 +163,18 @@ public void handleAssignment(final Map<TaskId, Set<TopicPartition>> activeTasks,\n                 task.resume();\n                 standbyTasksToCreate.remove(task.id());\n             } else /* we previously owned this task, and we don't have it anymore, or it has changed active/standby state */ {\n-                final Set<TopicPartition> inputPartitions = task.inputPartitions();\n+                cleanupTask(task);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE2NTE4MA==", "bodyText": "Not sure why we do not remove the input partitions previously.. is that intentional @vvcephei ? If not I'd move the removal into the block (I already did just to clarify :P)", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376165180", "createdAt": "2020-02-07T00:58:00Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -285,18 +299,13 @@ void handleLostAll() {\n         final Iterator<Task> iterator = tasks.values().iterator();\n         while (iterator.hasNext()) {\n             final Task task = iterator.next();\n-            final Set<TopicPartition> inputPartitions = task.inputPartitions();\n             // Even though we've apparently dropped out of the group, we can continue safely to maintain our\n             // standby tasks while we rejoin.\n             if (task.isActive()) {\n+                cleanupTask(task);\n                 task.closeDirty();\n-                changelogReader.remove(task.changelogPartitions());\n-            }\n-\n-            for (final TopicPartition inputPartition : inputPartitions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE2NTMwMw==", "bodyText": "The order here cannot be changed so I left this comment.", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376165303", "createdAt": "2020-02-07T00:58:18Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -331,12 +340,27 @@ void handleLostAll() {\n         return locallyStoredTasks;\n     }\n \n+    private void cleanupTask(final Task task) {\n+        // 1. remove the changelog partitions from changelog reader;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "originalPosition": 154}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODgwMDYx", "url": "https://github.com/apache/kafka/pull/8058#pullrequestreview-354880061", "createdAt": "2020-02-07T01:17:04Z", "commit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMToxNzowNFrOFmvmTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMTo0NTozMFrOFmwAug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3MDA2MA==", "bodyText": "Remove \"standby\" from error message (unless this only applies to standbys?)", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376170060", "createdAt": "2020-02-07T01:17:04Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/AbstractTask.java", "diffHunk": "@@ -70,6 +71,15 @@ public boolean isClosed() {\n         return state;\n     }\n \n+    @Override\n+    public void revive() {\n+        if (state == CLOSED) {\n+            transitionTo(CREATED);\n+        } else {\n+            throw new IllegalStateException(\"Illegal state \" + state() + \" while committing standby task \" + id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3MjYzNg==", "bodyText": "Do we also need to clear storeToChangelogTopic, etc?", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376172636", "createdAt": "2020-02-07T01:27:42Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -415,6 +415,8 @@ public void close() throws ProcessorStateException {\n                     log.error(\"Failed to close state store {}: \", store.name(), exception);\n                 }\n             }\n+\n+            stores.clear();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE2Mjc0MQ=="}, "originalCommit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3MzM3NQ==", "bodyText": "Just wondering, why is it ok to get InvalidOffsetException during restore/poll but not here? When might this get thrown from #position? ditto for in prepareChangelogs down below", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376173375", "createdAt": "2020-02-07T01:30:57Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -258,6 +260,8 @@ private boolean hasRestoredToEnd(final ChangelogMetadata metadata) {\n                 // if we cannot get the position of the consumer within timeout, just return false\n                 return false;\n             } catch (final KafkaException e) {\n+                // this also includes InvalidOffsetException, which should not happen under normal", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3NjQ5OQ==", "bodyText": "Hm. I think we should actually be concerned if we ever get to here -- I'm not sure the TaskMigratedException made sense either. Trying to add records to a closed task would imply that we closed the task due to shutting down or because we no longer own it, both cases which should also involves trimming its topic(s) from the consumer's assignment, but were still returned records for said topic(s).\nUnless, the consumer may still return already-fetched records from partitions no longer in its assignment during poll? I thought we would trim those records out and only return from the actual assignment", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376176499", "createdAt": "2020-02-07T01:43:58Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -692,9 +688,10 @@ private void closeRecordCollector(final boolean clean) {\n     @Override\n     public void addRecords(final TopicPartition partition, final Iterable<ConsumerRecord<byte[], byte[]>> records) {\n         if (state() == State.CLOSED || state() == State.CLOSING) {\n-            log.info(\"Stream task {} is already closed, probably because it got unexpectedly migrated to another thread already. \" +\n-                         \"Notifying the thread to trigger a new rebalance immediately.\", id());\n-            throw new TaskMigratedException(id());\n+            // a task is only closing / closed when 1) task manager is closing, 2) a rebalance is undergoing;\n+            // in either case we can just log it and move on without notifying the thread since the consumer\n+            // would soon be updated to not return any records for this task anymore.\n+            log.info(\"Stream task {} is already in {} state, skip adding records to it.\", id(), state());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3NjgyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                \"Will migrate out all assigned tasks and rejoin the consumer group.\");\n          \n          \n            \n                                \"Will close out all assigned tasks and rejoin the consumer group.\");", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376176826", "createdAt": "2020-02-07T01:45:30Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -745,14 +752,20 @@ private void runLoop() {\n             try {\n                 runOnce();\n                 if (assignmentErrorCode.get() == AssignorError.VERSION_PROBING.code()) {\n-                    log.info(\"Version probing detected. Triggering new rebalance.\");\n+                    log.info(\"Version probing detected. Rejoin the consumer group to trigger a new rebalance.\");\n+\n                     assignmentErrorCode.set(AssignorError.NONE.code());\n                     enforceRebalance();\n                 }\n-            } catch (final TaskMigratedException ignoreAndRejoinGroup) {\n-                log.warn(\"Detected task {} that got migrated to another thread. \" +\n-                             \"This implies that this thread missed a rebalance and dropped out of the consumer group. \" +\n-                             \"Will try to rejoin the consumer group.\", ignoreAndRejoinGroup.migratedTaskId());\n+            } catch (final TaskCorruptedException e) {\n+                log.warn(\"Detected the states of tasks {} are corrupted. \" +\n+                    \"Will close the task as dirty and re-create and bootstrap from scratch.\", e.corruptedTaskIds());\n+\n+                taskManager.handleCorruption(e.corruptedTaskIds());\n+            } catch (final TaskMigratedException e) {\n+                log.warn(\"Detected that the thread is being fenced. \" +\n+                    \"This implies that this thread missed a rebalance and dropped out of the consumer group. \" +\n+                    \"Will migrate out all assigned tasks and rejoin the consumer group.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4af5a53069376147dcc2326cd2b6465dc1f0adb", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/a4af5a53069376147dcc2326cd2b6465dc1f0adb", "committedDate": "2020-02-07T16:56:15Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KMinor-invalid-offset-changelog-reader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64dad101c5c2d8282210c0e7b431fe1f4d5f036b", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/64dad101c5c2d8282210c0e7b431fe1f4d5f036b", "committedDate": "2020-02-07T17:15:54Z", "message": "PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47f3e0929ce262cbd2bfec8b122255ab6677907f", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/47f3e0929ce262cbd2bfec8b122255ab6677907f", "committedDate": "2020-02-07T21:29:12Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KMinor-invalid-offset-changelog-reader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "134dda3187ff41addddcb7c022ff34cbea0154b3", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/134dda3187ff41addddcb7c022ff34cbea0154b3", "committedDate": "2020-02-07T21:30:16Z", "message": "remove FixedOrderMapTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTI0OTg3", "url": "https://github.com/apache/kafka/pull/8058#pullrequestreview-355524987", "createdAt": "2020-02-08T02:47:33Z", "commit": {"oid": "134dda3187ff41addddcb7c022ff34cbea0154b3"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwNDoyMDowOFrOFnPFxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwNDozNToyNVrOFnPIZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY4NjAyMw==", "bodyText": "Just now having this thought... Supposing this happens, is it guaranteed to apply to all the stores in the task? I.e., do we really need to re-bootstrap all the stores, or just the one(s) for which our offset is out of range?", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376686023", "createdAt": "2020-02-08T04:20:08Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/errors/TaskCorruptedException.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.streams.errors;\n+\n+import org.apache.kafka.streams.processor.TaskId;\n+\n+import java.util.Set;\n+\n+/**\n+ * Indicates a specific task is corrupted and need to be re-initialized. It can be thrown when\n+ *\n+ * 1) Under EOS, if the checkpoint file does not contain offsets for corresponding store's changelogs, meaning\n+ *    previously it was not close cleanly;\n+ * 2) Out-of-range exception thrown during restoration, meaning that the changelog has been modified and we re-bootstrap", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "134dda3187ff41addddcb7c022ff34cbea0154b3"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY4NjMzMA==", "bodyText": "I guess it wouldn't hurt to explain what the exception means (our position is too old and has been deleted or compacted by the broker) and what we hope to accomplish by marking the task as corrupted (to re-bootstrap the stores from the changelog and return to normal processing).", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376686330", "createdAt": "2020-02-08T04:26:41Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -409,6 +413,15 @@ public void restore() {\n             } catch (final FencedInstanceIdException e) {\n                 // when the consumer gets fenced, all its tasks should be migrated\n                 throw new TaskMigratedException(\"Restore consumer get fenced by instance-id polling records.\", e);\n+            } catch (final InvalidOffsetException e) {\n+                log.warn(\"Encountered {} fetching records from restore consumer for partitions {}, \" +\n+                    \"marking the corresponding tasks as corrupted.\", e.getClass().getName(), e.partitions());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "134dda3187ff41addddcb7c022ff34cbea0154b3"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY4NjY5NA==", "bodyText": "The intent was to remove the input partitions from the map any time we remove a task from tasks. It looks like your code maintains this (in a clearer and cleaner way).", "url": "https://github.com/apache/kafka/pull/8058#discussion_r376686694", "createdAt": "2020-02-08T04:35:25Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -285,18 +299,13 @@ void handleLostAll() {\n         final Iterator<Task> iterator = tasks.values().iterator();\n         while (iterator.hasNext()) {\n             final Task task = iterator.next();\n-            final Set<TopicPartition> inputPartitions = task.inputPartitions();\n             // Even though we've apparently dropped out of the group, we can continue safely to maintain our\n             // standby tasks while we rejoin.\n             if (task.isActive()) {\n+                cleanupTask(task);\n                 task.closeDirty();\n-                changelogReader.remove(task.changelogPartitions());\n-            }\n-\n-            for (final TopicPartition inputPartition : inputPartitions) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE2NTE4MA=="}, "originalCommit": {"oid": "112d9c6c4cc2113333561d2c4581131491fe217a"}, "originalPosition": 132}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29545718e2aaa6fb7fbc367a18846abaf95fc01f", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/29545718e2aaa6fb7fbc367a18846abaf95fc01f", "committedDate": "2020-02-08T07:02:12Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KMinor-invalid-offset-changelog-reader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e037be08e111b3d5cda3e7180d58d797dbd34dfd", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/e037be08e111b3d5cda3e7180d58d797dbd34dfd", "committedDate": "2020-02-08T18:23:19Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KMinor-invalid-offset-changelog-reader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8d81c0dbb67c1da50e23bec0f49421c6f491a49", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/a8d81c0dbb67c1da50e23bec0f49421c6f491a49", "committedDate": "2020-02-08T18:28:39Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbd19bc104d8ad962edfde4b72eb1c1f211f2f05", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/bbd19bc104d8ad962edfde4b72eb1c1f211f2f05", "committedDate": "2020-02-08T18:29:17Z", "message": "minor fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae9457b5e59164a08085184e4d0c50910483b2a6", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/ae9457b5e59164a08085184e4d0c50910483b2a6", "committedDate": "2020-02-10T21:12:44Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KMinor-invalid-offset-changelog-reader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b6c391334df1d1461f0587ac269d605ccb2c908", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/6b6c391334df1d1461f0587ac269d605ccb2c908", "committedDate": "2020-02-10T22:29:11Z", "message": "github comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzE1MzA4", "url": "https://github.com/apache/kafka/pull/8058#pullrequestreview-356315308", "createdAt": "2020-02-10T22:34:32Z", "commit": {"oid": "6b6c391334df1d1461f0587ac269d605ccb2c908"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMjozNDozM1rOFn4GSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMjozNDozM1rOFn4GSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM1Nzg5Ng==", "bodyText": "We can checkpoint (excluding the corrupted partitions) for 1) standby tasks and 2) non-eos active tasks, for eos active tasks we should not write the checkpoint since for eos we HAVE TO reboot every store from scratch to maintain consistency.", "url": "https://github.com/apache/kafka/pull/8058#discussion_r377357896", "createdAt": "2020-02-10T22:34:33Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -436,6 +436,15 @@ private void close(final boolean clean) {\n         transitionTo(State.CLOSED);\n     }\n \n+    @Override\n+    public void markChangelogAsCorrupted(final Set<TopicPartition> partitions) {\n+        stateMgr.markChangelogAsCorrupted(partitions);\n+\n+        // only write a new checkpoint (excluding the corrupted partitions) if eos is disabled", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b6c391334df1d1461f0587ac269d605ccb2c908"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fd2eae63c36c86798e5d6e331869602edb63aac", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/2fd2eae63c36c86798e5d6e331869602edb63aac", "committedDate": "2020-02-10T23:38:35Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5ce3dbdf6b734aa8b8c0bb2d368adaae809ee68", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/f5ce3dbdf6b734aa8b8c0bb2d368adaae809ee68", "committedDate": "2020-02-12T01:41:10Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KMinor-invalid-offset-changelog-reader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d444d84a5f3bbcc9930c65db152bb5aeb73d3686", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/d444d84a5f3bbcc9930c65db152bb5aeb73d3686", "committedDate": "2020-02-12T22:02:45Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KMinor-invalid-offset-changelog-reader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40731e90c7123dc0ff88b2438ebd9c8d2d66ae5b", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/40731e90c7123dc0ff88b2438ebd9c8d2d66ae5b", "committedDate": "2020-02-12T23:56:51Z", "message": "comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8738cf58085da5d0a6c41439117de4a05d5b14b2", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/8738cf58085da5d0a6c41439117de4a05d5b14b2", "committedDate": "2020-02-14T19:37:43Z", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KMinor-invalid-offset-changelog-reader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9831638e2af3d59c85253bd809d3a6114c4ec98d", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/9831638e2af3d59c85253bd809d3a6114c4ec98d", "committedDate": "2020-02-14T20:57:17Z", "message": "move javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNzM3MzI5", "url": "https://github.com/apache/kafka/pull/8058#pullrequestreview-360737329", "createdAt": "2020-02-18T23:02:10Z", "commit": {"oid": "9831638e2af3d59c85253bd809d3a6114c4ec98d"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMzowMjoxMVrOFrVphA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMzowOTo0MlrOFrV0Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4Nzc4MA==", "bodyText": "Is this what you meant?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.info(\"Stream task {} is already in {} state, skip adding records to it.\", id(), state());\n          \n          \n            \n                        log.info(\"Stream task {} is already in {} state, skip processing it.\", id(), state());", "url": "https://github.com/apache/kafka/pull/8058#discussion_r380987780", "createdAt": "2020-02-18T23:02:11Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -460,6 +460,15 @@ private void close(final boolean clean) {\n      * source topic partitions, or if it is enforced to be processable\n      */\n     public boolean isProcessable(final long wallClockTime) {\n+        if (state() == State.CLOSED || state() == State.CLOSING) {\n+            // a task is only closing / closed when 1) task manager is closing, 2) a rebalance is undergoing;\n+            // in either case we can just log it and move on without notifying the thread since the consumer\n+            // would soon be updated to not return any records for this task anymore.\n+            log.info(\"Stream task {} is already in {} state, skip adding records to it.\", id(), state());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9831638e2af3d59c85253bd809d3a6114c4ec98d"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4ODg2MA==", "bodyText": "Should we still skip adding records? It looks like that was the intent, but I think what actually would happen is that we'd still add the records, but skip processing them.", "url": "https://github.com/apache/kafka/pull/8058#discussion_r380988860", "createdAt": "2020-02-18T23:05:10Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -706,12 +715,6 @@ private void closeRecordCollector(final boolean clean) {\n      */\n     @Override\n     public void addRecords(final TopicPartition partition, final Iterable<ConsumerRecord<byte[], byte[]>> records) {\n-        if (state() == State.CLOSED || state() == State.CLOSING) {\n-            log.info(\"Stream task {} is already closed, probably because it got unexpectedly migrated to another thread already. \" +\n-                         \"Notifying the thread to trigger a new rebalance immediately.\", id());\n-            throw new TaskMigratedException(id());\n-        }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9831638e2af3d59c85253bd809d3a6114c4ec98d"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4OTIxNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"and the thread is going to shutdown: \", e);\n          \n          \n            \n                            \"and the thread is going to shut down: \", e);\n          \n      \n    \n    \n  \n\nI'm a nerd, I know... \"shutdown\" is a noun, \"shut down\" is a verb phrase (\"down\" modifies the verb \"shut\").", "url": "https://github.com/apache/kafka/pull/8058#discussion_r380989216", "createdAt": "2020-02-18T23:06:06Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -718,14 +719,11 @@ public void run() {\n         try {\n             runLoop();\n             cleanRun = true;\n-        } catch (final KafkaException e) {\n-            log.error(\"Encountered the following unexpected Kafka exception during processing, \" +\n-                          \"this usually indicate Streams internal errors:\", e);\n-            throw e;\n         } catch (final Exception e) {\n             // we have caught all Kafka related exceptions, and other runtime exceptions\n             // should be due to user application errors\n-            log.error(\"Encountered the following error during processing:\", e);\n+            log.error(\"Encountered the following exception during processing \" +\n+                \"and the thread is going to shutdown: \", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9831638e2af3d59c85253bd809d3a6114c4ec98d"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5MDUwNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                log.info(\"Version probing detected. Rejoin the consumer group to trigger a new rebalance.\");\n          \n          \n            \n                                log.info(\"Version probing detected. Rejoining the consumer group to trigger a new rebalance.\");\n          \n      \n    \n    \n  \n\nIt sounded like you were telling the operator to do something, but you're just telling them that something is going to happen.", "url": "https://github.com/apache/kafka/pull/8058#discussion_r380990506", "createdAt": "2020-02-18T23:09:42Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -745,15 +743,22 @@ private void runLoop() {\n             try {\n                 runOnce();\n                 if (assignmentErrorCode.get() == AssignorError.VERSION_PROBING.code()) {\n-                    log.info(\"Version probing detected. Triggering new rebalance.\");\n+                    log.info(\"Version probing detected. Rejoin the consumer group to trigger a new rebalance.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9831638e2af3d59c85253bd809d3a6114c4ec98d"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "946a944c52361e7998bc38f6664c6ad59dbb5874", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/946a944c52361e7998bc38f6664c6ad59dbb5874", "committedDate": "2020-02-19T00:00:42Z", "message": "further fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7719c215917908b91d287e371c8ab64b4e93282", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/c7719c215917908b91d287e371c8ab64b4e93282", "committedDate": "2020-02-20T22:36:39Z", "message": "Update streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java\n\nCo-Authored-By: John Roesler <vvcephei@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9210ceb07077ca44b1cdac3588a79c0e5867e851", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/9210ceb07077ca44b1cdac3588a79c0e5867e851", "committedDate": "2020-02-20T22:36:52Z", "message": "Update streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\n\nCo-Authored-By: John Roesler <vvcephei@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f3628829892c4a96a51cfa95aba026e808a6510", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/5f3628829892c4a96a51cfa95aba026e808a6510", "committedDate": "2020-02-20T22:37:05Z", "message": "Update streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java\n\nCo-Authored-By: John Roesler <vvcephei@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bbc2f61e46516f5a8332373530bea18aca4e628", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/6bbc2f61e46516f5a8332373530bea18aca4e628", "committedDate": "2020-02-20T22:38:13Z", "message": "rebase from trunk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4049d00c74220400cc34103fdf9effcbaa43bf8", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/f4049d00c74220400cc34103fdf9effcbaa43bf8", "committedDate": "2020-02-20T22:38:16Z", "message": "Merge branch 'KMinor-invalid-offset-changelog-reader' of https://github.com/guozhangwang/kafka into KMinor-invalid-offset-changelog-reader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03f4778cba8697bad6e5c5d7ce40df6e59214c02", "author": {"user": {"login": "guozhangwang", "name": "Guozhang Wang"}}, "url": "https://github.com/apache/kafka/commit/03f4778cba8697bad6e5c5d7ce40df6e59214c02", "committedDate": "2020-02-20T23:03:53Z", "message": "add unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjkxNzI0", "url": "https://github.com/apache/kafka/pull/8058#pullrequestreview-362291724", "createdAt": "2020-02-20T22:50:45Z", "commit": {"oid": "f4049d00c74220400cc34103fdf9effcbaa43bf8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjo1MDo0NVrOFsl7mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjo1MTozMFrOFsl8qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMwMzEyOQ==", "bodyText": "Here is the attempted fix of https://issues.apache.org/jira/browse/KAFKA-9572: if we are closing / suspending a restoring task, we should only update the checkpoint file but should NOT commit offsets, since the committed offsets indicate the  \"restore end\" and should not be updated, cc @cadonna who filed the JIRA.", "url": "https://github.com/apache/kafka/pull/8058#discussion_r382303129", "createdAt": "2020-02-20T22:50:45Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -239,25 +236,32 @@ public void suspend() {\n         if (state() == State.CREATED || state() == State.CLOSING || state() == State.SUSPENDED) {\n             // do nothing\n             log.trace(\"Skip suspending since state is {}\", state());\n+        } else if (state() == State.RUNNING) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4049d00c74220400cc34103fdf9effcbaa43bf8"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMwMzQwMw==", "bodyText": "This is part of the fix as well: only flushing / checkpointing, but not committing.", "url": "https://github.com/apache/kafka/pull/8058#discussion_r382303403", "createdAt": "2020-02-20T22:51:30Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -413,26 +417,23 @@ private void close(final boolean clean) {\n         } else {\n             if (state() == State.RUNNING) {\n                 closeTopology(clean);\n-            }\n \n-            if (state() == State.RUNNING || state() == State.RESTORING) {\n                 if (clean) {\n                     commitState();\n                     // whenever we have successfully committed state, it is safe to checkpoint\n                     // the state as well no matter if EOS is enabled or not\n                     stateMgr.checkpoint(checkpointableOffsets());\n-                } else if (eosDisabled) {\n-                    // if from unclean close, then only need to flush state to make sure that when later\n-                    // closing the states, there's no records triggering any processing anymore; also swallow all caught exceptions\n-                    // However, for a _clean_ shutdown, we try to commit and checkpoint. If there are any exceptions, they become\n-                    // fatal for the \"closeClean()\" call, and the caller can try again with closeDirty() to complete the shutdown.\n-                    try {\n-                        stateMgr.flush();\n-                    } catch (final RuntimeException error) {\n-                        log.debug(\"Ignoring flush error in unclean close.\", error);\n-                    }\n+                } else {\n+                    executeAndMaybeSwallow(false, stateMgr::flush, \"state manager flush\");\n                 }\n \n+                transitionTo(State.CLOSING);\n+            } else if (state() == State.RESTORING) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4049d00c74220400cc34103fdf9effcbaa43bf8"}, "originalPosition": 127}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzEyNzgz", "url": "https://github.com/apache/kafka/pull/8058#pullrequestreview-362312783", "createdAt": "2020-02-20T23:38:08Z", "commit": {"oid": "03f4778cba8697bad6e5c5d7ce40df6e59214c02"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1789, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}