{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MTUyNjIx", "number": 8667, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODozMTozMFrOD8meyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODozMTozMFrOD8meyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODcxNjI2OnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODozMTozMFrOGVpMMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOTo0MjowMFrOGVrhOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0ODE0NQ==", "bodyText": "Should we also handle the corrupted tasks here (before this line), so that they can be already cleaned up before the next round? Or, alternatively, should we move taskManager.handleCorruption(e.corruptedTaskWithChangelogs()); to before the attempted commit (it looks like it could be outside the try block as well).", "url": "https://github.com/apache/kafka/pull/8667#discussion_r425348145", "createdAt": "2020-05-14T18:31:30Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -555,28 +555,35 @@ void runLoop() {\n             } catch (final TaskCorruptedException e) {\n                 log.warn(\"Detected the states of tasks \" + e.corruptedTaskWithChangelogs() + \" are corrupted. \" +\n                              \"Will close the task as dirty and re-create and bootstrap from scratch.\", e);\n-\n-                taskManager.commit(\n-                    taskManager.tasks()\n-                        .values()\n-                        .stream()\n-                        .filter(t -> t.state() == Task.State.RUNNING || t.state() == Task.State.RESTORING)\n-                        .filter(t -> !e.corruptedTaskWithChangelogs().containsKey(t.id()))\n-                        .collect(Collectors.toSet())\n-                );\n-                taskManager.handleCorruption(e.corruptedTaskWithChangelogs());\n+                try {\n+                    taskManager.commit(\n+                        taskManager.tasks()\n+                            .values()\n+                            .stream()\n+                            .filter(t -> t.state() == Task.State.RUNNING || t.state() == Task.State.RESTORING)\n+                            .filter(t -> !e.corruptedTaskWithChangelogs().containsKey(t.id()))\n+                            .collect(Collectors.toSet())\n+                    );\n+                    taskManager.handleCorruption(e.corruptedTaskWithChangelogs());\n+                } catch (final TaskMigratedException taskMigrated) {\n+                    handleTaskMigrated(taskMigrated);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f26677f150951d9a6ae3d09ed6a058b936c050"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM2NjE1MA==", "bodyText": "Good point, I was also thinking whether we should do the corruption logic no matter what. But if we hit a TaskMigrated, the taskManager.handleLostAll will wipe out all the task states dirty, which seems like a super-set of jobs for handleCorruption. If we failed the commit, maybe we should just skip the corruption logic?", "url": "https://github.com/apache/kafka/pull/8667#discussion_r425366150", "createdAt": "2020-05-14T19:03:05Z", "author": {"login": "abbccdda"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -555,28 +555,35 @@ void runLoop() {\n             } catch (final TaskCorruptedException e) {\n                 log.warn(\"Detected the states of tasks \" + e.corruptedTaskWithChangelogs() + \" are corrupted. \" +\n                              \"Will close the task as dirty and re-create and bootstrap from scratch.\", e);\n-\n-                taskManager.commit(\n-                    taskManager.tasks()\n-                        .values()\n-                        .stream()\n-                        .filter(t -> t.state() == Task.State.RUNNING || t.state() == Task.State.RESTORING)\n-                        .filter(t -> !e.corruptedTaskWithChangelogs().containsKey(t.id()))\n-                        .collect(Collectors.toSet())\n-                );\n-                taskManager.handleCorruption(e.corruptedTaskWithChangelogs());\n+                try {\n+                    taskManager.commit(\n+                        taskManager.tasks()\n+                            .values()\n+                            .stream()\n+                            .filter(t -> t.state() == Task.State.RUNNING || t.state() == Task.State.RESTORING)\n+                            .filter(t -> !e.corruptedTaskWithChangelogs().containsKey(t.id()))\n+                            .collect(Collectors.toSet())\n+                    );\n+                    taskManager.handleCorruption(e.corruptedTaskWithChangelogs());\n+                } catch (final TaskMigratedException taskMigrated) {\n+                    handleTaskMigrated(taskMigrated);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0ODE0NQ=="}, "originalCommit": {"oid": "d2f26677f150951d9a6ae3d09ed6a058b936c050"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM4NjI5Ng==", "bodyText": "Sounds legit. Thanks.", "url": "https://github.com/apache/kafka/pull/8667#discussion_r425386296", "createdAt": "2020-05-14T19:42:00Z", "author": {"login": "vvcephei"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -555,28 +555,35 @@ void runLoop() {\n             } catch (final TaskCorruptedException e) {\n                 log.warn(\"Detected the states of tasks \" + e.corruptedTaskWithChangelogs() + \" are corrupted. \" +\n                              \"Will close the task as dirty and re-create and bootstrap from scratch.\", e);\n-\n-                taskManager.commit(\n-                    taskManager.tasks()\n-                        .values()\n-                        .stream()\n-                        .filter(t -> t.state() == Task.State.RUNNING || t.state() == Task.State.RESTORING)\n-                        .filter(t -> !e.corruptedTaskWithChangelogs().containsKey(t.id()))\n-                        .collect(Collectors.toSet())\n-                );\n-                taskManager.handleCorruption(e.corruptedTaskWithChangelogs());\n+                try {\n+                    taskManager.commit(\n+                        taskManager.tasks()\n+                            .values()\n+                            .stream()\n+                            .filter(t -> t.state() == Task.State.RUNNING || t.state() == Task.State.RESTORING)\n+                            .filter(t -> !e.corruptedTaskWithChangelogs().containsKey(t.id()))\n+                            .collect(Collectors.toSet())\n+                    );\n+                    taskManager.handleCorruption(e.corruptedTaskWithChangelogs());\n+                } catch (final TaskMigratedException taskMigrated) {\n+                    handleTaskMigrated(taskMigrated);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0ODE0NQ=="}, "originalCommit": {"oid": "d2f26677f150951d9a6ae3d09ed6a058b936c050"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2607, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}