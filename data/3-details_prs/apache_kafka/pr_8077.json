{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyOTQ3NjIz", "number": 8077, "title": "KAFKA-9583: use topic-partitions grouped by node to send OffsetsForLeaderEpoch requests", "bodyText": "In validateOffsetsAsync, we group the requests by leader node for efficiency. The list of topic-partitions are grouped from partitionsToValidate (all partitions) to node => fetchPostitions (partitions by node). However, when actually sending the request with OffsetsForLeaderEpochClient, we use partitionsToValidate, which is the list of all topic-partitions passed into validateOffsetsAsync. This results in extra partitions being included in the request sent to brokers that are potentially not the leader for those partitions.\nThis PR fixes the issue by using fetchPositions, which is the proper list of partitions that we should send in the request. Additionally, a small typo of API name in OffsetsForLeaderEpochClient is corrected (it originally referenced LisfOffsets as the API name).\nTests\nTested with the following configuration:\ntopic-partitions:\n\u276f kafkacat -b localhost:8080 -L\nMetadata for all topics (from broker -1: localhost:8080/bootstrap):\n 3 brokers:\n  broker 1 at localhost:9092 (controller)\n  broker 2 at localhost:9093\n  broker 3 at localhost:9094\n 2 topics:\n  topic \"broker-a.only\" with 1 partitions:\n    partition 0, leader 1, replicas: 1, isrs: 1\n  topic \"broker-b.only\" with 5 partitions:\n    partition 0, leader 2, replicas: 2, isrs: 2\n    partition 1, leader 2, replicas: 2, isrs: 2\n    partition 2, leader 2, replicas: 2, isrs: 2\n    partition 3, leader 2, replicas: 2, isrs: 2\n    partition 4, leader 2, replicas: 2, isrs: 2\n\nbefore the change: broker-a.only-1 was sent to broker 2, which is not the leader for this partition.\nafter the change: broker-a.only-1 was not sent to broker 2.\nClient tests are run with ./gradlew :clients:test. Ideas for additional tests are welcome!\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-02-10T05:30:31Z", "url": "https://github.com/apache/kafka/pull/8077", "merged": true, "mergeCommit": {"oid": "0fad944ca777e788e21ff577a1f1ab3b5a7f1266"}, "closed": true, "closedAt": "2020-04-09T06:46:46Z", "author": {"login": "andyfangdz"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcC2KMGAH2gAyMzcyOTQ3NjIzOmMzY2M4ZTgyODcyZjZmYmI4YzQ5NWQyM2JkMTc4Mzc2ZTA1OTE3MDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcV0PBnAFqTM5MDQ3MzQ2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c3cc8e82872f6fbb8c495d23bd178376e0591706", "author": {"user": {"login": "andyfangdz", "name": "Dezhi \u201cAndy\u201d Fang"}}, "url": "https://github.com/apache/kafka/commit/c3cc8e82872f6fbb8c495d23bd178376e0591706", "committedDate": "2020-02-10T05:19:56Z", "message": "use topic-partitions grouped by node to send ListOffset requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a89c06804cc7232988615d385b22ebd80899c39c", "author": {"user": {"login": "andyfangdz", "name": "Dezhi \u201cAndy\u201d Fang"}}, "url": "https://github.com/apache/kafka/commit/a89c06804cc7232988615d385b22ebd80899c39c", "committedDate": "2020-02-10T06:18:51Z", "message": "use the correct type of request for error message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MjA4NjM2", "url": "https://github.com/apache/kafka/pull/8077#pullrequestreview-365208636", "createdAt": "2020-02-26T20:12:44Z", "commit": {"oid": "a89c06804cc7232988615d385b22ebd80899c39c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NDgzOTg3", "url": "https://github.com/apache/kafka/pull/8077#pullrequestreview-375483987", "createdAt": "2020-03-16T18:32:32Z", "commit": {"oid": "a89c06804cc7232988615d385b22ebd80899c39c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxODozMjozMlrOF3BBjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxODozMjozMlrOF3BBjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzMjc4MA==", "bodyText": "Good catch! This was missed during the initial implementation", "url": "https://github.com/apache/kafka/pull/8077#discussion_r393232780", "createdAt": "2020-03-16T18:32:32Z", "author": {"login": "mumrah"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java", "diffHunk": "@@ -800,7 +800,7 @@ private void validateOffsetsAsync(Map<TopicPartition, SubscriptionState.FetchPos\n \n             subscriptions.setNextAllowedRetry(fetchPostitions.keySet(), time.milliseconds() + requestTimeoutMs);\n \n-            RequestFuture<OffsetsForLeaderEpochClient.OffsetForEpochResult> future = offsetsForLeaderEpochClient.sendAsyncRequest(node, partitionsToValidate);\n+            RequestFuture<OffsetsForLeaderEpochClient.OffsetForEpochResult> future = offsetsForLeaderEpochClient.sendAsyncRequest(node, fetchPostitions);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a89c06804cc7232988615d385b22ebd80899c39c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDczNDY3", "url": "https://github.com/apache/kafka/pull/8077#pullrequestreview-390473467", "createdAt": "2020-04-09T03:49:58Z", "commit": {"oid": "a89c06804cc7232988615d385b22ebd80899c39c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1823, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}