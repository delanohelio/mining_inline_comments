{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxNTk5NDAz", "number": 8709, "title": "KAFKA-9952; Remove immediate fetch completion logic on high watermark updates", "bodyText": "For KIP-392, we added logic to make sure that high watermark changes are propagated to followers without delay in order to improve end to end latency when fetching from followers. The downside of this change is that it increases the rate of fetch requests from followers which can have a noticeable impact on performance (see KAFKA-9731).\nTo fix that problem, we have already modified the code so that we only propagate high watermark changes immediately when a replica selector is used (which is not the default). However, leaving this logic around means that it is risky to enable follower fetching since it changes the follower request rate, which can have a big impact on overall broker performance.\nThis patch disables immediate propagation of the high watermark more generally. Instead, users can use the max wait time in order to control the worst-case latency. Note that this is typically only a problem anyway for low-throughput clusters since otherwise we will always have a steady rate of high watermark updates.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-05-21T21:31:00Z", "url": "https://github.com/apache/kafka/pull/8709", "merged": true, "mergeCommit": {"oid": "2cbf6be54a364bfc95db00594775941d1fb45041"}, "closed": true, "closedAt": "2020-05-27T21:41:50Z", "author": {"login": "hachikuji"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjkiE1AH2gAyNDIxNTk5NDAzOmNlM2Q5NjU3NTM0NTM1OGNjZjRhOTYwZTI3ODg2ZTBjN2Y3ZjkyMjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcle4OtgFqTQxOTU2NTAxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ce3d96575345358ccf4a960e27886e0c7f7f9220", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/ce3d96575345358ccf4a960e27886e0c7f7f9220", "committedDate": "2020-05-21T21:27:14Z", "message": "KAFKA-9952; Remove immediate fetch completion logic on high watermark updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52b62fdac7e2feaa2fa8af911005bdd021047fd2", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/52b62fdac7e2feaa2fa8af911005bdd021047fd2", "committedDate": "2020-05-22T15:46:32Z", "message": "Minor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd0858dcdc648a1615b7299b370d0d93f0e400d5", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/bd0858dcdc648a1615b7299b370d0d93f0e400d5", "committedDate": "2020-05-22T20:38:21Z", "message": "Fix update follower benchmark"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MzczNTIy", "url": "https://github.com/apache/kafka/pull/8709#pullrequestreview-417373522", "createdAt": "2020-05-24T16:38:49Z", "commit": {"oid": "bd0858dcdc648a1615b7299b370d0d93f0e400d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQxNjozODo0OVrOGZv_ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQxNjozODo0OVrOGZv_ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY1Mzk0Ng==", "bodyText": "Interesting. This could cause an early return for the leader case too, right?", "url": "https://github.com/apache/kafka/pull/8709#discussion_r429653946", "createdAt": "2020-05-24T16:38:49Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/server/DelayedFetch.scala", "diffHunk": "@@ -120,14 +119,6 @@ class DelayedFetch(delayMs: Long,\n                   accumulatedSize += bytesAvailable\n               }\n             }\n-\n-            if (fetchMetadata.isFromFollower) {\n-              // Case H check if the follower has the latest HW from the leader\n-              if (partition.getReplica(fetchMetadata.replicaId)\n-                .exists(r => offsetSnapshot.highWatermark.messageOffset > r.lastSentHighWatermark)) {\n-                return forceComplete()\n-              }\n-            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0858dcdc648a1615b7299b370d0d93f0e400d5"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f75e4a521aa990c17b9c9d9d58d0ca9f2b14eef6", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/f75e4a521aa990c17b9c9d9d58d0ca9f2b14eef6", "committedDate": "2020-05-26T15:55:44Z", "message": "Cleanup LogReadResult and remove unused field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1dd8a335f3ce082601b0609ac16d1ada0706d96", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/b1dd8a335f3ce082601b0609ac16d1ada0706d96", "committedDate": "2020-05-26T16:14:55Z", "message": "Fix comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4Njc5MDg0", "url": "https://github.com/apache/kafka/pull/8709#pullrequestreview-418679084", "createdAt": "2020-05-26T21:06:16Z", "commit": {"oid": "b1dd8a335f3ce082601b0609ac16d1ada0706d96"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMTowNjoxNlrOGawUKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMTowNzozOVrOGawW0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcwNzc1Mw==", "bodyText": "Could we use the toString from the case class?", "url": "https://github.com/apache/kafka/pull/8709#discussion_r430707753", "createdAt": "2020-05-26T21:06:16Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "diffHunk": "@@ -109,9 +109,19 @@ case class LogReadResult(info: FetchDataInfo,\n   def withEmptyFetchInfo: LogReadResult =\n     copy(info = FetchDataInfo(LogOffsetMetadata.UnknownOffsetMetadata, MemoryRecords.EMPTY))\n \n-  override def toString =\n-    s\"Fetch Data: [$info], HW: [$highWatermark], leaderLogStartOffset: [$leaderLogStartOffset], leaderLogEndOffset: [$leaderLogEndOffset], \" +\n-    s\"followerLogStartOffset: [$followerLogStartOffset], fetchTimeMs: [$fetchTimeMs], readSize: [$readSize], lastStableOffset: [$lastStableOffset], error: [$error]\"\n+  override def toString = {\n+    \"LogReadResult(\" +\n+      s\"info=$info, \" +\n+      s\"highWatermark=$highWatermark, \" +\n+      s\"leaderLogStartOffset=$leaderLogStartOffset, \" +\n+      s\"leaderLogEndOffset=$leaderLogEndOffset, \" +\n+      s\"followerLogStartOffset=$followerLogStartOffset, \" +\n+      s\"fetchTimeMs=$fetchTimeMs, \" +\n+      s\"preferredReadReplica=$preferredReadReplica, \" +\n+      s\"lastStableOffset=$lastStableOffset, \" +\n+      s\"error=$error\" +\n+      \")\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1dd8a335f3ce082601b0609ac16d1ada0706d96"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcwODQzMw==", "bodyText": "Do we still need to compute adjustedMaxBytes? Also, do you know why we don't need readSize anymore? What change made it unnecessary?", "url": "https://github.com/apache/kafka/pull/8709#discussion_r430708433", "createdAt": "2020-05-26T21:07:39Z", "author": {"login": "ijuma"}, "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "diffHunk": "@@ -1100,10 +1100,8 @@ class ReplicaManager(val config: KafkaConfig,\n             leaderLogEndOffset = readInfo.logEndOffset,\n             followerLogStartOffset = followerLogStartOffset,\n             fetchTimeMs = fetchTimeMs,\n-            readSize = adjustedMaxBytes,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1dd8a335f3ce082601b0609ac16d1ada0706d96"}, "originalPosition": 105}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NDMwNzY2", "url": "https://github.com/apache/kafka/pull/8709#pullrequestreview-419430766", "createdAt": "2020-05-27T16:59:48Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "b1dd8a335f3ce082601b0609ac16d1ada0706d96", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/b1dd8a335f3ce082601b0609ac16d1ada0706d96", "committedDate": "2020-05-26T16:14:55Z", "message": "Fix comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NTY1MDE4", "url": "https://github.com/apache/kafka/pull/8709#pullrequestreview-419565018", "createdAt": "2020-05-27T19:59:51Z", "commit": {"oid": "b1dd8a335f3ce082601b0609ac16d1ada0706d96"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1134, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}