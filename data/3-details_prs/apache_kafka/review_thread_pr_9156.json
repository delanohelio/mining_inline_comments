{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NjQzMDY1", "number": 9156, "reviewThreads": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwMToxMjoyN1rOEawdrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOTo0MTo1NVrOEh1C-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2NDkyNDYwOnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwMToxMjoyN1rOHEYPYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwOToyNDo1OFrOHKtwQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1MzUwNA==", "bodyText": "Don't we need to call this.enableSendingOldValues() as \"this\" is the upstream KTable the filter is applied to? Why do we need to enable sending old values on the result of the filter() ?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r474353504", "createdAt": "2020-08-21T01:12:27Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "diffHunk": "@@ -203,6 +203,10 @@ public String queryableStoreName() {\n             processorSupplier,\n             tableNode,\n             builder);\n+\n+        kTable.enableSendingOldValues();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b90718719a3bc294f758303f8797ca74294f4651"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk5NzQ0Mw==", "bodyText": "Switching to enabling via the filter.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r480997443", "createdAt": "2020-09-01T09:24:58Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "diffHunk": "@@ -203,6 +203,10 @@ public String queryableStoreName() {\n             processorSupplier,\n             tableNode,\n             builder);\n+\n+        kTable.enableSendingOldValues();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1MzUwNA=="}, "originalCommit": {"oid": "b90718719a3bc294f758303f8797ca74294f4651"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2NDkyNzA5OnYy", "diffSide": "RIGHT", "path": "streams/src/test/java/org/apache/kafka/streams/StreamsBuilderTest.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwMToxMzo1OFrOHEYQ4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwOToyNjo0OVrOHKt0cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1Mzg5MA==", "bodyText": "This is surprising to me -- need to dig into the code I guess, but I though enabling to send old values would not trigger any upstream materialization but only take effect if the store is materializes already (but would be ignored otherwise). Seems my assumption is wrong though.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r474353890", "createdAt": "2020-08-21T01:13:58Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/StreamsBuilderTest.java", "diffHunk": "@@ -123,7 +123,7 @@ public void shouldAllowJoinMaterializedFilteredKTable() {\n \n         assertThat(\n             topology.stateStores().size(),\n-            equalTo(1));\n+            equalTo(2));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b90718719a3bc294f758303f8797ca74294f4651"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM2MTU4Ng==", "bodyText": "The issue seems to be this line: https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableSource.java#L67\nIn a source-KTable, if we enable sending old values we force an materialization. I guess, we should have this materialization optional?\nI would recommend to rename enableSendingOldValues() to maybeEnableSendingOldValues(final boolean forceMaterialization) or similar?\n\\cc @guozhangwang WDYT?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r474361586", "createdAt": "2020-08-21T01:43:29Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/StreamsBuilderTest.java", "diffHunk": "@@ -123,7 +123,7 @@ public void shouldAllowJoinMaterializedFilteredKTable() {\n \n         assertThat(\n             topology.stateStores().size(),\n-            equalTo(1));\n+            equalTo(2));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1Mzg5MA=="}, "originalCommit": {"oid": "b90718719a3bc294f758303f8797ca74294f4651"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc5MjY3MQ==", "bodyText": "enableSendingOldValues is indicated for sending a pair of <new, old> values, and if it is not set the old value would always be null. If we want to enableSendingOldValues then we'd have to materialize the source node still?\nMaybe I'm not fully understanding the context here. Could you bring me up to date?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r475792671", "createdAt": "2020-08-24T17:53:17Z", "author": {"login": "guozhangwang"}, "path": "streams/src/test/java/org/apache/kafka/streams/StreamsBuilderTest.java", "diffHunk": "@@ -123,7 +123,7 @@ public void shouldAllowJoinMaterializedFilteredKTable() {\n \n         assertThat(\n             topology.stateStores().size(),\n-            equalTo(1));\n+            equalTo(2));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1Mzg5MA=="}, "originalCommit": {"oid": "b90718719a3bc294f758303f8797ca74294f4651"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYyMjQ3Ng==", "bodyText": "@guozhangwang Atm, when enableSendingOldValues is set and the upstream store is not materialized already we enforce a materialization. Thus, enabling enableSendingOldValues in KTable#filter() would be a breaking change as we would start to materialize state that did not exist before if one upgrades a topology.\nInstead, we want to say, iff the upstream store exist, please send me the old value, but if the upstream store does not exist, it's ok to just send old=null but don't force a materialization.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r477622476", "createdAt": "2020-08-26T22:23:34Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/StreamsBuilderTest.java", "diffHunk": "@@ -123,7 +123,7 @@ public void shouldAllowJoinMaterializedFilteredKTable() {\n \n         assertThat(\n             topology.stateStores().size(),\n-            equalTo(1));\n+            equalTo(2));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1Mzg5MA=="}, "originalCommit": {"oid": "b90718719a3bc294f758303f8797ca74294f4651"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYwNTgzNQ==", "bodyText": "Ah I see.. what about changing the function as enableSendingOldValues(boolean enforced) in that case? And then only ktable aggregations which would definitely need this would set it to true.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r478605835", "createdAt": "2020-08-27T18:12:20Z", "author": {"login": "guozhangwang"}, "path": "streams/src/test/java/org/apache/kafka/streams/StreamsBuilderTest.java", "diffHunk": "@@ -123,7 +123,7 @@ public void shouldAllowJoinMaterializedFilteredKTable() {\n \n         assertThat(\n             topology.stateStores().size(),\n-            equalTo(1));\n+            equalTo(2));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1Mzg5MA=="}, "originalCommit": {"oid": "b90718719a3bc294f758303f8797ca74294f4651"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk5ODUxNA==", "bodyText": "Sounds good.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r480998514", "createdAt": "2020-09-01T09:26:49Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/test/java/org/apache/kafka/streams/StreamsBuilderTest.java", "diffHunk": "@@ -123,7 +123,7 @@ public void shouldAllowJoinMaterializedFilteredKTable() {\n \n         assertThat(\n             topology.stateStores().size(),\n-            equalTo(1));\n+            equalTo(2));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1Mzg5MA=="}, "originalCommit": {"oid": "b90718719a3bc294f758303f8797ca74294f4651"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODkxOTI4OnYy", "diffSide": "RIGHT", "path": "clients/src/main/java/org/apache/kafka/server/authorizer/AuthorizableRequestContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOTowNDoyM1rOHPVu0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzozNjoyNlrOHQfI4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg0NjczNg==", "bodyText": "Unrelated change: can we revert this?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485846736", "createdAt": "2020-09-09T19:04:23Z", "author": {"login": "mjsax"}, "path": "clients/src/main/java/org/apache/kafka/server/authorizer/AuthorizableRequestContext.java", "diffHunk": "@@ -17,11 +17,12 @@\n \n package org.apache.kafka.server.authorizer;\n \n-import java.net.InetAddress;\n import org.apache.kafka.common.annotation.InterfaceStability;\n import org.apache.kafka.common.security.auth.KafkaPrincipal;\n import org.apache.kafka.common.security.auth.SecurityProtocol;\n \n+import java.net.InetAddress;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA0OTQ0Mw==", "bodyText": "Done. (Must sort out Kafka code style settings at some point)", "url": "https://github.com/apache/kafka/pull/9156#discussion_r487049443", "createdAt": "2020-09-11T13:36:26Z", "author": {"login": "big-andy-coates"}, "path": "clients/src/main/java/org/apache/kafka/server/authorizer/AuthorizableRequestContext.java", "diffHunk": "@@ -17,11 +17,12 @@\n \n package org.apache.kafka.server.authorizer;\n \n-import java.net.InetAddress;\n import org.apache.kafka.common.annotation.InterfaceStability;\n import org.apache.kafka.common.security.auth.KafkaPrincipal;\n import org.apache.kafka.common.security.auth.SecurityProtocol;\n \n+import java.net.InetAddress;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg0NjczNg=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODk1MzczOnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableAggregate.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOToxMzozOFrOHPWDNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMDo0NTo0MFrOHTcOvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MTk1Ng==", "bodyText": "Can we flip the logic of the boolean flag ? -- It makes a knob in my mind to say, onlyIfMaterailized=false implies that we need to (ie, enforce to) materialize...  I would prefer the suggest from Guozhang to use a flag like enforceMaterialization (or maybe better materializeIfNeeded).\nAlso, the method may or may not enable sending old values and thus, we might want to rename it to maybeEnableSendOldValues (or enableSendOldValuesIfPossible or similar).", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485851956", "createdAt": "2020-09-09T19:13:38Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableAggregate.java", "diffHunk": "@@ -47,8 +47,10 @@\n     }\n \n     @Override\n-    public void enableSendingOldValues() {\n+    public boolean enableSendingOldValues(final boolean onlyIfMaterialized) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1NzE4Ng==", "bodyText": "I did initially go with this. However, it seems really unintuitive.\nGiven a param such as forceMaterialization then it's clear that enableSendingOldValues(true) will force materialization, but what does enabledSendingOldValues(false) mean? OK, we're not forcing materialization, but actually the method won't enable sending old values if the param is false and its not already materialized.\nEven if we go with maybeEnableSendingOldValues(enforceMaterialization) I still would argue the semantics are not intuitive from the names alone.  (Though of course JavaDocs would help).\nHowever, given enableSendingOldValues(onlyIfMaterialized) is, IMHO, very intuitive. enableSendingOldValues(true) will only enable sending old values if already materialized, whereas enableSendingOldValues(false) will always enable sending old values, materializing as necessary, must like the previous enableSendingOldValues() method did.\nLikewise, if we stick with enableSendingOldValues(onlyIfMaterialized) then I don't think we need to include a maybe or IfPossible in the name as this is implied already by the onlyIf.\nThat said, this is not code I have to look at every day. If there's a consensus we should flip, then happy enough to do it.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r487057186", "createdAt": "2020-09-11T13:48:30Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableAggregate.java", "diffHunk": "@@ -47,8 +47,10 @@\n     }\n \n     @Override\n-    public void enableSendingOldValues() {\n+    public boolean enableSendingOldValues(final boolean onlyIfMaterialized) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MTk1Ng=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2NjE2NA==", "bodyText": "I guess it's subjective. Personally, I would prefer to flip it.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r487166164", "createdAt": "2020-09-11T16:47:23Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableAggregate.java", "diffHunk": "@@ -47,8 +47,10 @@\n     }\n \n     @Override\n-    public void enableSendingOldValues() {\n+    public boolean enableSendingOldValues(final boolean onlyIfMaterialized) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MTk1Ng=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE0NzUxNw==", "bodyText": "OK, will flip.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r490147517", "createdAt": "2020-09-17T10:45:40Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableAggregate.java", "diffHunk": "@@ -47,8 +47,10 @@\n     }\n \n     @Override\n-    public void enableSendingOldValues() {\n+    public boolean enableSendingOldValues(final boolean onlyIfMaterialized) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MTk1Ng=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODk1NzA0OnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOToxNDozM1rOHPWFOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMDo1NToyNlrOHTchRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MjQ3NA==", "bodyText": "Why does the filter need to send old values? I though the filter needs to receive old values, and thus we should call this. enableSendingOldValues(true) to enable sending old values on the filter's input?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485852474", "createdAt": "2020-09-09T19:14:33Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "diffHunk": "@@ -182,6 +182,8 @@ public String queryableStoreName() {\n         final KTableProcessorSupplier<K, V, V> processorSupplier =\n             new KTableFilter<>(this, predicate, filterNot, queryableStoreName);\n \n+        processorSupplier.enableSendingOldValues(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1NzgwNQ==", "bodyText": "KTableFilter has a boolean flag internally that also needs to be set if it is to correctly handle old values, (existing code).  So if we don't call enableSendingOldValues on it, it won't swallow the output when things haven't changed.\nto put it another way, the sendOldValues field of KTableFilter is used to both signify that the upstream is sending old values, and to control if the filter should forward old values. I'll split these into two variables.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r487057805", "createdAt": "2020-09-11T13:49:31Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "diffHunk": "@@ -182,6 +182,8 @@ public String queryableStoreName() {\n         final KTableProcessorSupplier<K, V, V> processorSupplier =\n             new KTableFilter<>(this, predicate, filterNot, queryableStoreName);\n \n+        processorSupplier.enableSendingOldValues(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MjQ3NA=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2Nzc4OQ==", "bodyText": "SGTM.\nIMHO, sendOldValues in KTableFilter should have only one meaning: do send old values downstream. If the filter result is materialized, we don't care if he upstream is sending old values or not. However, if the filter is stateless, as a side effect, we also need to tell upstream to send old values.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r487167789", "createdAt": "2020-09-11T16:50:30Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "diffHunk": "@@ -182,6 +182,8 @@ public String queryableStoreName() {\n         final KTableProcessorSupplier<K, V, V> processorSupplier =\n             new KTableFilter<>(this, predicate, filterNot, queryableStoreName);\n \n+        processorSupplier.enableSendingOldValues(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MjQ3NA=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzODE5NQ==", "bodyText": "If the filter result is materialized, we don't care if he upstream is sending old values or not. However, if the filter is stateless, as a side effect, we also need to tell upstream to send old values.\n\nThat's not how the code was working. It always asked the parent to send old values:\n    @Override\n    public void enableSendingOldValues() {\n        parent.enableSendingOldValues();\n        sendOldValues = true;\n    }\nDo we want to change this as part of this PR to only call parent.enableSendingOldValues is the filter is not materialized?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r489538195", "createdAt": "2020-09-16T15:41:48Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "diffHunk": "@@ -182,6 +182,8 @@ public String queryableStoreName() {\n         final KTableProcessorSupplier<K, V, V> processorSupplier =\n             new KTableFilter<>(this, predicate, filterNot, queryableStoreName);\n \n+        processorSupplier.enableSendingOldValues(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MjQ3NA=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE1MjI2Mw==", "bodyText": "As discussed offline - change the behaviour of enableSendingOldValues such that a node that is already materialized will not ask upstream nodes to also send old values, is deemed out of scope of this PR.\n@mjsax has requested a ticket to track this work: https://issues.apache.org/jira/browse/KAFKA-10494", "url": "https://github.com/apache/kafka/pull/9156#discussion_r490152263", "createdAt": "2020-09-17T10:55:26Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "diffHunk": "@@ -182,6 +182,8 @@ public String queryableStoreName() {\n         final KTableProcessorSupplier<K, V, V> processorSupplier =\n             new KTableFilter<>(this, predicate, filterNot, queryableStoreName);\n \n+        processorSupplier.enableSendingOldValues(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MjQ3NA=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODk2MjE3OnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOToxNjoxNFrOHPWIag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNjo1ODo1N1rOHQmpMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MzI5MA==", "bodyText": "Seems the boolean input parameter is missing?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485853290", "createdAt": "2020-09-09T19:16:14Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "diffHunk": "@@ -832,18 +834,25 @@ public String queryableStoreName() {\n     }\n \n     @SuppressWarnings(\"unchecked\")\n-    public void enableSendingOldValues() {\n+    public boolean enableSendingOldValues(final boolean onlyIfMaterialized) {\n         if (!sendOldValues) {\n             if (processorSupplier instanceof KTableSource) {\n                 final KTableSource<K, ?> source = (KTableSource<K, V>) processorSupplier;\n+                if (onlyIfMaterialized && !source.materialized()) {\n+                    return false;\n+                }\n                 source.enableSendingOldValues();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1ODU0OA==", "bodyText": "Nope.  The if above is handling the boolean, there is no need for the source to be aware of this.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r487058548", "createdAt": "2020-09-11T13:50:39Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "diffHunk": "@@ -832,18 +834,25 @@ public String queryableStoreName() {\n     }\n \n     @SuppressWarnings(\"unchecked\")\n-    public void enableSendingOldValues() {\n+    public boolean enableSendingOldValues(final boolean onlyIfMaterialized) {\n         if (!sendOldValues) {\n             if (processorSupplier instanceof KTableSource) {\n                 final KTableSource<K, ?> source = (KTableSource<K, V>) processorSupplier;\n+                if (onlyIfMaterialized && !source.materialized()) {\n+                    return false;\n+                }\n                 source.enableSendingOldValues();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MzI5MA=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE3MjQwMg==", "bodyText": "Ah. I though you changes ProcessorSuppler#enableSendOldValues but that was incorrect. You change KTableProcessorSuppler#enableSendOldValues.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r487172402", "createdAt": "2020-09-11T16:58:57Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "diffHunk": "@@ -832,18 +834,25 @@ public String queryableStoreName() {\n     }\n \n     @SuppressWarnings(\"unchecked\")\n-    public void enableSendingOldValues() {\n+    public boolean enableSendingOldValues(final boolean onlyIfMaterialized) {\n         if (!sendOldValues) {\n             if (processorSupplier instanceof KTableSource) {\n                 final KTableSource<K, ?> source = (KTableSource<K, V>) processorSupplier;\n+                if (onlyIfMaterialized && !source.materialized()) {\n+                    return false;\n+                }\n                 source.enableSendingOldValues();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MzI5MA=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODk3MzU2OnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableAbstractJoin.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOToxOTo0MlrOHPWPOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMDo1OTozMFrOHTcpZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1NTAzMw==", "bodyText": "Instead of the check, should we pass in false to enforce a materialization if necessary?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485855033", "createdAt": "2020-09-09T19:19:42Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableAbstractJoin.java", "diffHunk": "@@ -39,9 +39,15 @@\n     }\n \n     @Override\n-    public final void enableSendingOldValues() {\n-        table1.enableSendingOldValues();\n-        table2.enableSendingOldValues();\n+    public final boolean enableSendingOldValues(final boolean onlyIfMaterialized) {\n+        if (!table1.enableSendingOldValues(onlyIfMaterialized)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1OTE1NA==", "bodyText": "My view, as outlined above, is to stick with the pattern that's here.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r487059154", "createdAt": "2020-09-11T13:51:34Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableAbstractJoin.java", "diffHunk": "@@ -39,9 +39,15 @@\n     }\n \n     @Override\n-    public final void enableSendingOldValues() {\n-        table1.enableSendingOldValues();\n-        table2.enableSendingOldValues();\n+    public final boolean enableSendingOldValues(final boolean onlyIfMaterialized) {\n+        if (!table1.enableSendingOldValues(onlyIfMaterialized)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1NTAzMw=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2OTMyMA==", "bodyText": "My comment was about your pattern... (if we flip the logic, we would need to pass in true to force a materialization). My point is, shouldn't we pass in a constant? For KTableKTableAbstractJoin we always want that the upstream is sending us old values.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r487169320", "createdAt": "2020-09-11T16:53:15Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableAbstractJoin.java", "diffHunk": "@@ -39,9 +39,15 @@\n     }\n \n     @Override\n-    public final void enableSendingOldValues() {\n-        table1.enableSendingOldValues();\n-        table2.enableSendingOldValues();\n+    public final boolean enableSendingOldValues(final boolean onlyIfMaterialized) {\n+        if (!table1.enableSendingOldValues(onlyIfMaterialized)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1NTAzMw=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzOTkwNA==", "bodyText": "Feels a little off to me to ignore what the caller is asking.  If they pass true for onlyIfMaterialized, then we shouldn't silently ignore them IMHO.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r489539904", "createdAt": "2020-09-16T15:44:15Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableAbstractJoin.java", "diffHunk": "@@ -39,9 +39,15 @@\n     }\n \n     @Override\n-    public final void enableSendingOldValues() {\n-        table1.enableSendingOldValues();\n-        table2.enableSendingOldValues();\n+    public final boolean enableSendingOldValues(final boolean onlyIfMaterialized) {\n+        if (!table1.enableSendingOldValues(onlyIfMaterialized)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1NTAzMw=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE1NDM0MQ==", "bodyText": "Anyway, done...", "url": "https://github.com/apache/kafka/pull/9156#discussion_r490154341", "createdAt": "2020-09-17T10:59:30Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableAbstractJoin.java", "diffHunk": "@@ -39,9 +39,15 @@\n     }\n \n     @Override\n-    public final void enableSendingOldValues() {\n-        table1.enableSendingOldValues();\n-        table2.enableSendingOldValues();\n+    public final boolean enableSendingOldValues(final boolean onlyIfMaterialized) {\n+        if (!table1.enableSendingOldValues(onlyIfMaterialized)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1NTAzMw=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODk3Mzg4OnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableAbstractJoin.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOToxOTo0OFrOHPWPaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzo1Mjo1OFrOHQfybg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1NTA4Mw==", "bodyText": "as above.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485855083", "createdAt": "2020-09-09T19:19:48Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableAbstractJoin.java", "diffHunk": "@@ -39,9 +39,15 @@\n     }\n \n     @Override\n-    public final void enableSendingOldValues() {\n-        table1.enableSendingOldValues();\n-        table2.enableSendingOldValues();\n+    public final boolean enableSendingOldValues(final boolean onlyIfMaterialized) {\n+        if (!table1.enableSendingOldValues(onlyIfMaterialized)) {\n+            throw new IllegalStateException(\"Table-table joins should always be materialized\");\n+        }\n+\n+        if (!table2.enableSendingOldValues(onlyIfMaterialized)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MDA3OA==", "bodyText": "as above :)", "url": "https://github.com/apache/kafka/pull/9156#discussion_r487060078", "createdAt": "2020-09-11T13:52:58Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableAbstractJoin.java", "diffHunk": "@@ -39,9 +39,15 @@\n     }\n \n     @Override\n-    public final void enableSendingOldValues() {\n-        table1.enableSendingOldValues();\n-        table2.enableSendingOldValues();\n+    public final boolean enableSendingOldValues(final boolean onlyIfMaterialized) {\n+        if (!table1.enableSendingOldValues(onlyIfMaterialized)) {\n+            throw new IllegalStateException(\"Table-table joins should always be materialized\");\n+        }\n+\n+        if (!table2.enableSendingOldValues(onlyIfMaterialized)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1NTA4Mw=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODk3NDg5OnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableJoinMerger.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOToyMDowMVrOHPWP9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzo1MzowOFrOHQfyyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1NTIyMw==", "bodyText": "as above", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485855223", "createdAt": "2020-09-09T19:20:01Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableJoinMerger.java", "diffHunk": "@@ -77,10 +77,16 @@ public String getQueryableName() {\n     }\n \n     @Override\n-    public void enableSendingOldValues() {\n-        parent1.enableSendingOldValues();\n-        parent2.enableSendingOldValues();\n+    public boolean enableSendingOldValues(final boolean onlyIfMaterialized) {\n+        if (!parent1.enableSendingOldValues(onlyIfMaterialized)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MDE3MQ==", "bodyText": "as above :)", "url": "https://github.com/apache/kafka/pull/9156#discussion_r487060171", "createdAt": "2020-09-11T13:53:08Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableJoinMerger.java", "diffHunk": "@@ -77,10 +77,16 @@ public String getQueryableName() {\n     }\n \n     @Override\n-    public void enableSendingOldValues() {\n-        parent1.enableSendingOldValues();\n-        parent2.enableSendingOldValues();\n+    public boolean enableSendingOldValues(final boolean onlyIfMaterialized) {\n+        if (!parent1.enableSendingOldValues(onlyIfMaterialized)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1NTIyMw=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODk3NTI3OnYy", "diffSide": "RIGHT", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableJoinMerger.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOToyMDowNlrOHPWQKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzo1MzoxNFrOHQfzEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1NTI3NQ==", "bodyText": "as above?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485855275", "createdAt": "2020-09-09T19:20:06Z", "author": {"login": "mjsax"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableJoinMerger.java", "diffHunk": "@@ -77,10 +77,16 @@ public String getQueryableName() {\n     }\n \n     @Override\n-    public void enableSendingOldValues() {\n-        parent1.enableSendingOldValues();\n-        parent2.enableSendingOldValues();\n+    public boolean enableSendingOldValues(final boolean onlyIfMaterialized) {\n+        if (!parent1.enableSendingOldValues(onlyIfMaterialized)) {\n+            throw new IllegalStateException(\"Table-table joins should always be materialized\");\n+        }\n+\n+        if (!parent2.enableSendingOldValues(onlyIfMaterialized)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MDI0MA==", "bodyText": "as above. :p", "url": "https://github.com/apache/kafka/pull/9156#discussion_r487060240", "createdAt": "2020-09-11T13:53:14Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableKTableJoinMerger.java", "diffHunk": "@@ -77,10 +77,16 @@ public String getQueryableName() {\n     }\n \n     @Override\n-    public void enableSendingOldValues() {\n-        parent1.enableSendingOldValues();\n-        parent2.enableSendingOldValues();\n+    public boolean enableSendingOldValues(final boolean onlyIfMaterialized) {\n+        if (!parent1.enableSendingOldValues(onlyIfMaterialized)) {\n+            throw new IllegalStateException(\"Table-table joins should always be materialized\");\n+        }\n+\n+        if (!parent2.enableSendingOldValues(onlyIfMaterialized)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1NTI3NQ=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODk5NTk4OnYy", "diffSide": "RIGHT", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableFilterTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOToyNToyOVrOHPWclQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzo1Mzo0MlrOHQf0LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1ODQ1Mw==", "bodyText": "Why do we need to call this (ie, why do we want the result of the filter to send old values)?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485858453", "createdAt": "2020-09-09T19:25:29Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableFilterTest.java", "diffHunk": "@@ -295,12 +295,39 @@ public void shouldNotSendOldValuesOnMaterialization() {\n         doTestNotSendingOldValue(builder, table1, table2, topic1);\n     }\n \n+    @Test\n+    public void shouldNotSendOldValuesWithoutMaterializationIfOptionallyRequested() {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+        final String topic1 = \"topic1\";\n+\n+        final KTableImpl<String, Integer, Integer> table1 =\n+            (KTableImpl<String, Integer, Integer>) builder.table(topic1, consumed);\n+        final KTableImpl<String, Integer, Integer> table2 = (KTableImpl<String, Integer, Integer>) table1.filter(predicate);\n+\n+        table2.enableSendingOldValues(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MDUyNA==", "bodyText": "See my comment above", "url": "https://github.com/apache/kafka/pull/9156#discussion_r487060524", "createdAt": "2020-09-11T13:53:42Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableFilterTest.java", "diffHunk": "@@ -295,12 +295,39 @@ public void shouldNotSendOldValuesOnMaterialization() {\n         doTestNotSendingOldValue(builder, table1, table2, topic1);\n     }\n \n+    @Test\n+    public void shouldNotSendOldValuesWithoutMaterializationIfOptionallyRequested() {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+        final String topic1 = \"topic1\";\n+\n+        final KTableImpl<String, Integer, Integer> table1 =\n+            (KTableImpl<String, Integer, Integer>) builder.table(topic1, consumed);\n+        final KTableImpl<String, Integer, Integer> table2 = (KTableImpl<String, Integer, Integer>) table1.filter(predicate);\n+\n+        table2.enableSendingOldValues(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1ODQ1Mw=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODk5ODkyOnYy", "diffSide": "RIGHT", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableFilterTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOToyNjowOVrOHPWeaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOToyNjowOVrOHPWeaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1ODkyMw==", "bodyText": "As we enable this on the result KTable, and we enforce a materialization of the result, I would expect that we actually do get old-values sent?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485858923", "createdAt": "2020-09-09T19:26:09Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableFilterTest.java", "diffHunk": "@@ -295,12 +295,39 @@ public void shouldNotSendOldValuesOnMaterialization() {\n         doTestNotSendingOldValue(builder, table1, table2, topic1);\n     }\n \n+    @Test\n+    public void shouldNotSendOldValuesWithoutMaterializationIfOptionallyRequested() {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+        final String topic1 = \"topic1\";\n+\n+        final KTableImpl<String, Integer, Integer> table1 =\n+            (KTableImpl<String, Integer, Integer>) builder.table(topic1, consumed);\n+        final KTableImpl<String, Integer, Integer> table2 = (KTableImpl<String, Integer, Integer>) table1.filter(predicate);\n+\n+        table2.enableSendingOldValues(true);\n+\n+        doTestNotSendingOldValue(builder, table1, table2, topic1);\n+    }\n+\n+    @Test\n+    public void shouldNotSendOldValuesOnMaterializationIfOptionallyRequested() {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+        final String topic1 = \"topic1\";\n+\n+        final KTableImpl<String, Integer, Integer> table1 =\n+            (KTableImpl<String, Integer, Integer>) builder.table(topic1, consumed);\n+        final KTableImpl<String, Integer, Integer> table2 =\n+            (KTableImpl<String, Integer, Integer>) table1.filter(predicate, Materialized.as(\"store2\"));\n+\n+        table2.enableSendingOldValues(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTAwODkwOnYy", "diffSide": "LEFT", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableFilterTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOToyODoyMFrOHPWkZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOToyODoyMFrOHPWkZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg2MDQ1Mg==", "bodyText": "Should we actually keep this call within this method and pass in the boolean flag as parameter to doTestSendingOldValue ?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485860452", "createdAt": "2020-09-09T19:28:20Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableFilterTest.java", "diffHunk": "@@ -295,12 +295,39 @@ public void shouldNotSendOldValuesOnMaterialization() {\n         doTestNotSendingOldValue(builder, table1, table2, topic1);\n     }\n \n+    @Test\n+    public void shouldNotSendOldValuesWithoutMaterializationIfOptionallyRequested() {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+        final String topic1 = \"topic1\";\n+\n+        final KTableImpl<String, Integer, Integer> table1 =\n+            (KTableImpl<String, Integer, Integer>) builder.table(topic1, consumed);\n+        final KTableImpl<String, Integer, Integer> table2 = (KTableImpl<String, Integer, Integer>) table1.filter(predicate);\n+\n+        table2.enableSendingOldValues(true);\n+\n+        doTestNotSendingOldValue(builder, table1, table2, topic1);\n+    }\n+\n+    @Test\n+    public void shouldNotSendOldValuesOnMaterializationIfOptionallyRequested() {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+        final String topic1 = \"topic1\";\n+\n+        final KTableImpl<String, Integer, Integer> table1 =\n+            (KTableImpl<String, Integer, Integer>) builder.table(topic1, consumed);\n+        final KTableImpl<String, Integer, Integer> table2 =\n+            (KTableImpl<String, Integer, Integer>) table1.filter(predicate, Materialized.as(\"store2\"));\n+\n+        table2.enableSendingOldValues(true);\n+\n+        doTestNotSendingOldValue(builder, table1, table2, topic1);\n+    }\n+\n     private void doTestSendingOldValue(final StreamsBuilder builder,\n                                        final KTableImpl<String, Integer, Integer> table1,\n                                        final KTableImpl<String, Integer, Integer> table2,\n                                        final String topic1) {\n-        table2.enableSendingOldValues();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTA1MDEyOnYy", "diffSide": "RIGHT", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableImplTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOTozNzoxM1rOHPW-ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNTo0NzoxMlrOHS3Rhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg2NzE5NA==", "bodyText": "shouldNotSetSendingOldValuesIfNotMaterialized", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485867194", "createdAt": "2020-09-09T19:37:13Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableImplTest.java", "diffHunk": "@@ -304,6 +363,30 @@ public void testStateStore() {\n         }\n     }\n \n+    @Test\n+    public void testSendingOldValuesNotSetIfNotMaterialized() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU0MjAyMg==", "bodyText": "I prefer should too, but a lot of the code users test.  Happy to switch. Can I use should everywhere?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r489542022", "createdAt": "2020-09-16T15:47:12Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableImplTest.java", "diffHunk": "@@ -304,6 +363,30 @@ public void testStateStore() {\n         }\n     }\n \n+    @Test\n+    public void testSendingOldValuesNotSetIfNotMaterialized() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg2NzE5NA=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 146}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTA1MzgzOnYy", "diffSide": "RIGHT", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableImplTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOTozNzo1NFrOHPXBDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOTozNzo1NFrOHPXBDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg2Nzc5MA==", "bodyText": "shouldSetSendingOldValuesIfMaterializationForced", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485867790", "createdAt": "2020-09-09T19:37:54Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableImplTest.java", "diffHunk": "@@ -304,6 +363,30 @@ public void testStateStore() {\n         }\n     }\n \n+    @Test\n+    public void testSendingOldValuesNotSetIfNotMaterialized() {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+\n+        final KTableImpl<String, String, String> table =\n+            (KTableImpl<String, String, String>) builder.table(\"topic1\", consumed);\n+\n+        table.enableSendingOldValues(true);\n+\n+        assertThat(table.sendingOldValueEnabled(), is(false));\n+    }\n+\n+    @Test\n+    public void testSendingOldValuesSetIfMaterializedForced() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 158}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTA1ODI0OnYy", "diffSide": "RIGHT", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableImplTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOTozODozOFrOHPXDpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNzowMTo0N1rOHS6H4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg2ODQ1Mw==", "bodyText": "Seems the Matererialized.as(\"fred\") parameter is missing?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485868453", "createdAt": "2020-09-09T19:38:38Z", "author": {"login": "mjsax"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableImplTest.java", "diffHunk": "@@ -304,6 +363,30 @@ public void testStateStore() {\n         }\n     }\n \n+    @Test\n+    public void testSendingOldValuesNotSetIfNotMaterialized() {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+\n+        final KTableImpl<String, String, String> table =\n+            (KTableImpl<String, String, String>) builder.table(\"topic1\", consumed);\n+\n+        table.enableSendingOldValues(true);\n+\n+        assertThat(table.sendingOldValueEnabled(), is(false));\n+    }\n+\n+    @Test\n+    public void testSendingOldValuesSetIfMaterializedForced() {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+\n+        final KTableImpl<String, String, String> table =\n+            (KTableImpl<String, String, String>) builder.table(\"topic1\", consumed);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 162}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU0MzQ3Mg==", "bodyText": "Why? This test is about forced materialization. If we pass that parameter, then it would work even if not forced, right?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r489543472", "createdAt": "2020-09-16T15:49:22Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableImplTest.java", "diffHunk": "@@ -304,6 +363,30 @@ public void testStateStore() {\n         }\n     }\n \n+    @Test\n+    public void testSendingOldValuesNotSetIfNotMaterialized() {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+\n+        final KTableImpl<String, String, String> table =\n+            (KTableImpl<String, String, String>) builder.table(\"topic1\", consumed);\n+\n+        table.enableSendingOldValues(true);\n+\n+        assertThat(table.sendingOldValueEnabled(), is(false));\n+    }\n+\n+    @Test\n+    public void testSendingOldValuesSetIfMaterializedForced() {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+\n+        final KTableImpl<String, String, String> table =\n+            (KTableImpl<String, String, String>) builder.table(\"topic1\", consumed);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg2ODQ1Mw=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 162}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU4ODcwNQ==", "bodyText": "Rename test to make it clear its force materialized due to sending old values,\nshouldSetSendingOldValuesIfMaterializationForcedInternally", "url": "https://github.com/apache/kafka/pull/9156#discussion_r489588705", "createdAt": "2020-09-16T17:01:47Z", "author": {"login": "big-andy-coates"}, "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableImplTest.java", "diffHunk": "@@ -304,6 +363,30 @@ public void testStateStore() {\n         }\n     }\n \n+    @Test\n+    public void testSendingOldValuesNotSetIfNotMaterialized() {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+\n+        final KTableImpl<String, String, String> table =\n+            (KTableImpl<String, String, String>) builder.table(\"topic1\", consumed);\n+\n+        table.enableSendingOldValues(true);\n+\n+        assertThat(table.sendingOldValueEnabled(), is(false));\n+    }\n+\n+    @Test\n+    public void testSendingOldValuesSetIfMaterializedForced() {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+\n+        final KTableImpl<String, String, String> table =\n+            (KTableImpl<String, String, String>) builder.table(\"topic1\", consumed);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg2ODQ1Mw=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 162}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTA3NTc5OnYy", "diffSide": "RIGHT", "path": "streams/streams-scala/src/test/scala/org/apache/kafka/streams/scala/kstream/KTableTest.scala", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOTo0MTo1NVrOHPXO2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNTo1MDowNlrOHS3ZTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3MTMyMA==", "bodyText": "Why do we need to change the filter condition?", "url": "https://github.com/apache/kafka/pull/9156#discussion_r485871320", "createdAt": "2020-09-09T19:41:55Z", "author": {"login": "mjsax"}, "path": "streams/streams-scala/src/test/scala/org/apache/kafka/streams/scala/kstream/KTableTest.scala", "diffHunk": "@@ -39,29 +39,27 @@ class KTableTest extends FlatSpec with Matchers with TestDriver {\n     val sinkTopic = \"sink\"\n \n     val table = builder.stream[String, String](sourceTopic).groupBy((key, _) => key).count()\n-    table.filter((_, value) => value > 1).toStream.to(sinkTopic)\n+    table.filter((key, value) => key.equals(\"a\") && value == 1).toStream.to(sinkTopic)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU0NDAxNA==", "bodyText": "So that we can test an existing row being removed.", "url": "https://github.com/apache/kafka/pull/9156#discussion_r489544014", "createdAt": "2020-09-16T15:50:06Z", "author": {"login": "big-andy-coates"}, "path": "streams/streams-scala/src/test/scala/org/apache/kafka/streams/scala/kstream/KTableTest.scala", "diffHunk": "@@ -39,29 +39,27 @@ class KTableTest extends FlatSpec with Matchers with TestDriver {\n     val sinkTopic = \"sink\"\n \n     val table = builder.stream[String, String](sourceTopic).groupBy((key, _) => key).count()\n-    table.filter((_, value) => value > 1).toStream.to(sinkTopic)\n+    table.filter((key, value) => key.equals(\"a\") && value == 1).toStream.to(sinkTopic)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3MTMyMA=="}, "originalCommit": {"oid": "417e2ab7b27185bd6035a3e8422536a38e712b7b"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2147, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}