{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MTM2NTUz", "number": 8011, "title": "KAFKA-8503; Add default api timeout to AdminClient (KIP-533)", "bodyText": "This PR implements default.api.timeout.ms as documented by KIP-533. This is a rebased version of #6913 with some additional test cases and small cleanups.\nCo-authored-by: huxi huxi_2b@hotmail.com\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-01-28T17:24:01Z", "url": "https://github.com/apache/kafka/pull/8011", "merged": true, "mergeCommit": {"oid": "4317325fbcb29d1f5ab828821b8e0714e10ed981"}, "closed": true, "closedAt": "2020-01-31T06:48:51Z", "author": {"login": "hachikuji"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-0Rs_AH2gAyMzY4MTM2NTUzOjYzNTUxM2M2MWNiYjViMGQ4YTQwMjA4MWM3OTQ0NTE3ODYwNGNkMDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_e-YlgFqTM1MTA1MDYzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "635513c61cbb5b0d8a402081c79445178604cd07", "author": {"user": {"login": "huxihx", "name": "huxi"}}, "url": "https://github.com/apache/kafka/commit/635513c61cbb5b0d8a402081c79445178604cd07", "committedDate": "2020-01-28T16:52:38Z", "message": "KAFKA-8503: Ignore retries config if a custom timeout is provided\n\nhttps://issues.apache.org/jira/browse/KAFKA-8503\n\nThe KIP-533 implementation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edc0711cdb10fa4aea8c4bf67fbb8bca82ed22e4", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/edc0711cdb10fa4aea8c4bf67fbb8bca82ed22e4", "committedDate": "2020-01-28T17:23:21Z", "message": "Add test cases and minor cleanups"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMzI5OTMz", "url": "https://github.com/apache/kafka/pull/8011#pullrequestreview-350329933", "createdAt": "2020-01-29T18:30:10Z", "commit": {"oid": "edc0711cdb10fa4aea8c4bf67fbb8bca82ed22e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxODozMDoxMVrOFjTAFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxODozMDoxMVrOFjTAFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1NTc5Ng==", "bodyText": "Just to clarify my understanding, we will now retry \"forever\" with a lower request timeout (30s), but the total time spent attempting to satisfy a request will be bound by the new default.api.timeout.ms config or the explicit timeout given in the request options (if set)", "url": "https://github.com/apache/kafka/pull/8011#discussion_r372555796", "createdAt": "2020-01-29T18:30:11Z", "author": {"login": "mumrah"}, "path": "clients/src/main/java/org/apache/kafka/clients/admin/AdminClientConfig.java", "diffHunk": "@@ -154,10 +156,16 @@\n                                         CONNECTIONS_MAX_IDLE_MS_DOC)\n                                 .define(RETRIES_CONFIG,\n                                         Type.INT,\n-                                        5,\n-                                        atLeast(0),\n+                                        Integer.MAX_VALUE,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edc0711cdb10fa4aea8c4bf67fbb8bca82ed22e4"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMzM1NDQ2", "url": "https://github.com/apache/kafka/pull/8011#pullrequestreview-350335446", "createdAt": "2020-01-29T18:38:56Z", "commit": {"oid": "edc0711cdb10fa4aea8c4bf67fbb8bca82ed22e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxODozODo1N1rOFjTRAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxODozODo1N1rOFjTRAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MDEyOQ==", "bodyText": "Could we move this extra initialization logic to the factories and let the constructor accept the two new values? That we also allow us to make them final.", "url": "https://github.com/apache/kafka/pull/8011#discussion_r372560129", "createdAt": "2020-01-29T18:38:57Z", "author": {"login": "mumrah"}, "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -500,9 +506,9 @@ private KafkaAdminClient(AdminClientConfig config,\n                              KafkaClient client,\n                              TimeoutProcessorFactory timeoutProcessorFactory,\n                              LogContext logContext) {\n-        this.defaultTimeoutMs = config.getInt(AdminClientConfig.REQUEST_TIMEOUT_MS_CONFIG);\n         this.clientId = clientId;\n         this.log = logContext.logger(KafkaAdminClient.class);\n+        configureDefaultApiTimeoutMsAndRequestTimeoutMs(config);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edc0711cdb10fa4aea8c4bf67fbb8bca82ed22e4"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMzM3Mjc2", "url": "https://github.com/apache/kafka/pull/8011#pullrequestreview-350337276", "createdAt": "2020-01-29T18:41:56Z", "commit": {"oid": "edc0711cdb10fa4aea8c4bf67fbb8bca82ed22e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxODo0MTo1NlrOFjTWvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxODo0MTo1NlrOFjTWvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MTU5OQ==", "bodyText": "There are a few other calls to calcTimeoutMsRemainingAsInt, do we need to consider the overall request timeout there as well?", "url": "https://github.com/apache/kafka/pull/8011#discussion_r372561599", "createdAt": "2020-01-29T18:41:56Z", "author": {"login": "mumrah"}, "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -993,16 +1019,18 @@ private long sendEligibleCalls(long now) {\n                     continue;\n                 }\n                 Call call = calls.remove(0);\n-                int timeoutMs = calcTimeoutMsRemainingAsInt(now, call.deadlineMs);\n+                int requestTimeoutMs = Math.min(KafkaAdminClient.this.requestTimeoutMs,\n+                        calcTimeoutMsRemainingAsInt(now, call.deadlineMs));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edc0711cdb10fa4aea8c4bf67fbb8bca82ed22e4"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ad7c907b5e4b226d3f5cf27181c1251a8a5067f", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/4ad7c907b5e4b226d3f5cf27181c1251a8a5067f", "committedDate": "2020-01-30T00:30:44Z", "message": "Make request timeout and default api timeout final fields"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwOTMxNzg2", "url": "https://github.com/apache/kafka/pull/8011#pullrequestreview-350931786", "createdAt": "2020-01-30T15:51:41Z", "commit": {"oid": "4ad7c907b5e4b226d3f5cf27181c1251a8a5067f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNTo1MTo0MVrOFjwEGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNTo1MTo0MVrOFjwEGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAzMTk2MQ==", "bodyText": "Should this say\n\nclient operations that do not explicitly accept a timeout\n\nor\n\nclient operations that do not specify a timeout", "url": "https://github.com/apache/kafka/pull/8011#discussion_r373031961", "createdAt": "2020-01-30T15:51:41Z", "author": {"login": "mumrah"}, "path": "clients/src/main/java/org/apache/kafka/clients/CommonClientConfigs.java", "diffHunk": "@@ -141,6 +141,10 @@\n                                                            + \"The value must be set lower than <code>session.timeout.ms</code>, but typically should be set no higher \"\n                                                            + \"than 1/3 of that value. It can be adjusted even lower to control the expected time for normal rebalances.\";\n \n+    public static final String DEFAULT_API_TIMEOUT_MS_CONFIG = \"default.api.timeout.ms\";\n+    public static final String DEFAULT_API_TIMEOUT_MS_DOC = \"Specifies the timeout (in milliseconds) for client APIs. \" +\n+            \"This configuration is used as the default timeout for all client operations that do not explicitly accept a <code>timeout</code> parameter.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ad7c907b5e4b226d3f5cf27181c1251a8a5067f"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwOTM0NDgy", "url": "https://github.com/apache/kafka/pull/8011#pullrequestreview-350934482", "createdAt": "2020-01-30T15:54:48Z", "commit": {"oid": "4ad7c907b5e4b226d3f5cf27181c1251a8a5067f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNTo1NDo0OFrOFjwL0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNTo1NDo0OFrOFjwL0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAzMzkzOA==", "bodyText": "This could even be static now, yes?", "url": "https://github.com/apache/kafka/pull/8011#discussion_r373033938", "createdAt": "2020-01-30T15:54:48Z", "author": {"login": "mumrah"}, "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -520,8 +527,29 @@ private KafkaAdminClient(AdminClientConfig config,\n         thread.start();\n     }\n \n-    Time time() {\n-        return time;\n+    /**\n+     * If a default.api.timeout.ms has been explicitly specified, raise an error if it conflicts with request.timeout.ms.\n+     * If no default.api.timeout.ms has been configured, then set its value as the max of the default and request.timeout.ms. Also we should probably log a warning.\n+     * Otherwise, use the provided values for both configurations.\n+     *\n+     * @param config The configuration\n+     */\n+    private int configureDefaultApiTimeoutMs(AdminClientConfig config) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ad7c907b5e4b226d3f5cf27181c1251a8a5067f"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c83cf9d4c951cbf57ece9e9903338e34007c7473", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/c83cf9d4c951cbf57ece9e9903338e34007c7473", "committedDate": "2020-01-30T16:50:52Z", "message": "Fix description of config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMDUwNjMx", "url": "https://github.com/apache/kafka/pull/8011#pullrequestreview-351050631", "createdAt": "2020-01-30T18:37:27Z", "commit": {"oid": "c83cf9d4c951cbf57ece9e9903338e34007c7473"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2128, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}