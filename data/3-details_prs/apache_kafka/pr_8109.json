{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1MDE0ODg3", "number": 8109, "title": "KAFKA-9545: Fix subscription bugs from Stream refactoring", "bodyText": "This PR fixes two bugs related to stream refactoring:\n\nThe subscribed topics are not updated correctly when topic gets removed from broker.\nThe remainingPartitions computation doesn't account the case when one task has a pattern subscription of multiple topics. Then the input partition change will not be assumed as containsAll\n\nThe bugs are exposed from integration test testRegexMatchesTopicsAWhenDeleted and could be used to verify the fix works.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-02-13T18:10:29Z", "url": "https://github.com/apache/kafka/pull/8109", "merged": true, "mergeCommit": {"oid": "97c5dc1c134def07360a7f65405c3b0587f2d44d"}, "closed": true, "closedAt": "2020-02-16T23:55:00Z", "author": {"login": "abbccdda"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcD03DVgH2gAyMzc1MDE0ODg3OjZjNTBmNjNjMTA4NDhiNjRkZGJkMzBmYjEzNDAxMDkyZDI3Mjg5ZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEZ4zZgFqTM1OTI5Mzg2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6c50f63c10848b64ddbd30fb13401092d27289eb", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/6c50f63c10848b64ddbd30fb13401092d27289eb", "committedDate": "2020-02-13T06:23:03Z", "message": "resolve error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1121770ca210b7e64864675465bb25b4b37cf6d", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/c1121770ca210b7e64864675465bb25b4b37cf6d", "committedDate": "2020-02-13T16:21:39Z", "message": "final"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f61f649507250b7474655d4a6ee548481c1c040", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/5f61f649507250b7474655d4a6ee548481c1c040", "committedDate": "2020-02-13T18:01:02Z", "message": "debug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "781f14cafd2390722efa10ab3b9a683661b2d721", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/781f14cafd2390722efa10ab3b9a683661b2d721", "committedDate": "2020-02-13T18:04:06Z", "message": "second fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NDY3MTA2", "url": "https://github.com/apache/kafka/pull/8109#pullrequestreview-358467106", "createdAt": "2020-02-13T18:52:31Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff59b3a0aa289b06b90398ab3f2807a206ab67a4", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/ff59b3a0aa289b06b90398ab3f2807a206ab67a4", "committedDate": "2020-02-13T18:57:42Z", "message": "revert debug logs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "ff59b3a0aa289b06b90398ab3f2807a206ab67a4", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/ff59b3a0aa289b06b90398ab3f2807a206ab67a4", "committedDate": "2020-02-13T18:57:42Z", "message": "revert debug logs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjQwNjY1", "url": "https://github.com/apache/kafka/pull/8109#pullrequestreview-358640665", "createdAt": "2020-02-14T00:13:40Z", "commit": {"oid": "ff59b3a0aa289b06b90398ab3f2807a206ab67a4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMDoxMzo0MFrOFpn71A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMDoxMzo0MFrOFpn71A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MDIyOA==", "bodyText": "Can you elaborate a bit on this fix? Do you mean one task is subscribed to a pattern that matches multiple topics, or to two different patterns? I'm not sure I understand why either case would cause containsAll to fail.", "url": "https://github.com/apache/kafka/pull/8109#discussion_r379190228", "createdAt": "2020-02-14T00:13:40Z", "author": {"login": "ableegoldman"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -257,9 +257,11 @@ void handleRevocation(final Collection<TopicPartition> revokedPartitions) {\n         final Set<TopicPartition> remainingPartitions = new HashSet<>(revokedPartitions);\n \n         for (final Task task : tasks.values()) {\n-            if (remainingPartitions.containsAll(task.inputPartitions())) {\n-                revokedTasks.add(task.id());\n-                remainingPartitions.removeAll(task.inputPartitions());\n+            for (final TopicPartition topicPartition : task.inputPartitions()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff59b3a0aa289b06b90398ab3f2807a206ab67a4"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "ff59b3a0aa289b06b90398ab3f2807a206ab67a4", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/ff59b3a0aa289b06b90398ab3f2807a206ab67a4", "committedDate": "2020-02-13T18:57:42Z", "message": "revert debug logs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MDc1Mzk0", "url": "https://github.com/apache/kafka/pull/8109#pullrequestreview-359075394", "createdAt": "2020-02-14T16:44:44Z", "commit": {"oid": "ff59b3a0aa289b06b90398ab3f2807a206ab67a4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjo0NDo0NVrOFp86gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjo0NjoxOFrOFp89XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUzMzk1NQ==", "bodyText": "This function is called by two callers: xxxFromMetadata and xxxFromAssignment. For the former we do not maintain the old topics but just replace with the passed in value, for the latter we still maintain the  old topics -- this it to take care if the leader did not assign all tasks / partitions due to assignment error. We should still keep that logic here.", "url": "https://github.com/apache/kafka/pull/8109#discussion_r379533955", "createdAt": "2020-02-14T16:44:45Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilder.java", "diffHunk": "@@ -1887,8 +1887,6 @@ private void updateSubscribedTopics(final Set<String> topics, final String logPr\n         final Collection<String> existingTopics = subscriptionUpdates();\n \n         if  (!existingTopics.equals(topics)) {\n-            topics.addAll(existingTopics);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff59b3a0aa289b06b90398ab3f2807a206ab67a4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUzNDY4NQ==", "bodyText": "Hmm.. why it's possible that only part of the partitions of a task is revoked? We do assignment at the granularity of tasks so this check is to verify specifically that all partitions should be included if a task is going to be removed right?", "url": "https://github.com/apache/kafka/pull/8109#discussion_r379534685", "createdAt": "2020-02-14T16:46:18Z", "author": {"login": "guozhangwang"}, "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -257,9 +257,11 @@ void handleRevocation(final Collection<TopicPartition> revokedPartitions) {\n         final Set<TopicPartition> remainingPartitions = new HashSet<>(revokedPartitions);\n \n         for (final Task task : tasks.values()) {\n-            if (remainingPartitions.containsAll(task.inputPartitions())) {\n-                revokedTasks.add(task.id());\n-                remainingPartitions.removeAll(task.inputPartitions());\n+            for (final TopicPartition topicPartition : task.inputPartitions()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MDIyOA=="}, "originalCommit": {"oid": "ff59b3a0aa289b06b90398ab3f2807a206ab67a4"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84743ffcfa73595b8bd31a837f29a597fd1a4ba6", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/84743ffcfa73595b8bd31a837f29a597fd1a4ba6", "committedDate": "2020-02-15T00:11:04Z", "message": "retain old topics for assign"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "aadad10aa96836619aa86a3212a9c98f16d76e3b", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/aadad10aa96836619aa86a3212a9c98f16d76e3b", "committedDate": "2020-02-15T01:04:05Z", "message": "no revoke unless full"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "aadad10aa96836619aa86a3212a9c98f16d76e3b", "author": {"user": {"login": "abbccdda", "name": "Boyang Chen"}}, "url": "https://github.com/apache/kafka/commit/aadad10aa96836619aa86a3212a9c98f16d76e3b", "committedDate": "2020-02-15T01:04:05Z", "message": "no revoke unless full"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MjkzODYz", "url": "https://github.com/apache/kafka/pull/8109#pullrequestreview-359293863", "createdAt": "2020-02-15T01:31:27Z", "commit": {"oid": "aadad10aa96836619aa86a3212a9c98f16d76e3b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1883, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}