{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyODQ1ODY1", "number": 9272, "title": "KAFKA-10458; Updating controller quota does not work since Token Bucket", "bodyText": "This PR fixes two issues that have been introduced by #9114.\n\n\nWhen I switched the metric from Rate to TokenBucket in the ControllerMutationQuotaManager, I have mixed up the metrics. That broke the quota update path.\n\n\nWhen a quota is updated, the ClientQuotaManager updates the MetricConfig of the KafkaMetric. That update was not reflected into the Sensor so the Sensor was still using the MetricConfig that it has been created with.\n\n\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-09-09T13:29:23Z", "url": "https://github.com/apache/kafka/pull/9272", "merged": true, "mergeCommit": {"oid": "94e61c3979dbdd4884772bd41a0acca7dd5b1712"}, "closed": true, "closedAt": "2020-09-14T18:48:48Z", "author": {"login": "dajac"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHLAS5gH2gAyNDgyODQ1ODY1OjA0ZTU3ODAwY2ExMTU1MmVkZTMwNjNmODliMDI5OWZmZTYxNTNmZTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdI0UIggH2gAyNDgyODQ1ODY1OmE0ZWNlZTNmNDZjOTlhZTM1NWUyNjRmZjExY2IxZGZkMzE3ZmY2ODU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "04e57800ca11552ede3063f89b0299ffe6153fe5", "author": {"user": {"login": "dajac", "name": "David Jacot"}}, "url": "https://github.com/apache/kafka/commit/04e57800ca11552ede3063f89b0299ffe6153fe5", "committedDate": "2020-09-09T12:03:59Z", "message": "Update the correct metric in the ControllerQuotaManager when the quota is updated."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73faac4c32bab026cf1cf574f03160dc83a27372", "author": {"user": {"login": "dajac", "name": "David Jacot"}}, "url": "https://github.com/apache/kafka/commit/73faac4c32bab026cf1cf574f03160dc83a27372", "committedDate": "2020-09-09T13:26:24Z", "message": "Wire up the MetricConfig differently in the Sensor to ensure that updating the MetricConfig of the KafkaMetric is reflected in the Sensor."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MzUxMjIy", "url": "https://github.com/apache/kafka/pull/9272#pullrequestreview-487351222", "createdAt": "2020-09-13T23:43:56Z", "commit": {"oid": "73faac4c32bab026cf1cf574f03160dc83a27372"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QyMzo0Mzo1NlrOHRAUqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QyMzo0Mzo1NlrOHRAUqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU5MzEyOQ==", "bodyText": "nit: this is not really needed, since it's not ambiguous here as in constructor,", "url": "https://github.com/apache/kafka/pull/9272#discussion_r487593129", "createdAt": "2020-09-13T23:43:56Z", "author": {"login": "apovzner"}, "path": "clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java", "diffHunk": "@@ -53,12 +54,20 @@\n     private final Object metricLock;\n \n     private static class StatAndConfig {\n-        public final Stat stat;\n-        public final MetricConfig config;\n+        private final Stat stat;\n+        private final Supplier<MetricConfig> configSupplier;\n \n-        StatAndConfig(Stat stat, MetricConfig config) {\n+        StatAndConfig(Stat stat, Supplier<MetricConfig> configSupplier) {\n             this.stat = stat;\n-            this.config = config;\n+            this.configSupplier = configSupplier;\n+        }\n+\n+        public Stat stat() {\n+            return this.stat;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73faac4c32bab026cf1cf574f03160dc83a27372"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MzUxNDE3", "url": "https://github.com/apache/kafka/pull/9272#pullrequestreview-487351417", "createdAt": "2020-09-13T23:45:55Z", "commit": {"oid": "73faac4c32bab026cf1cf574f03160dc83a27372"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NzU4MjU5", "url": "https://github.com/apache/kafka/pull/9272#pullrequestreview-487758259", "createdAt": "2020-09-14T13:25:36Z", "commit": {"oid": "73faac4c32bab026cf1cf574f03160dc83a27372"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMzoyNTozNlrOHRTpsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMzoyNTozNlrOHRTptw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkwOTgwOQ==", "bodyText": "I guess if you are removing this. above, you could remove it here as well for consistency.", "url": "https://github.com/apache/kafka/pull/9272#discussion_r487909809", "createdAt": "2020-09-14T13:25:36Z", "author": {"login": "rajinisivaram"}, "path": "clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java", "diffHunk": "@@ -53,12 +54,20 @@\n     private final Object metricLock;\n \n     private static class StatAndConfig {\n-        public final Stat stat;\n-        public final MetricConfig config;\n+        private final Stat stat;\n+        private final Supplier<MetricConfig> configSupplier;\n \n-        StatAndConfig(Stat stat, MetricConfig config) {\n+        StatAndConfig(Stat stat, Supplier<MetricConfig> configSupplier) {\n             this.stat = stat;\n-            this.config = config;\n+            this.configSupplier = configSupplier;\n+        }\n+\n+        public Stat stat() {\n+            return this.stat;\n+        }\n+\n+        public MetricConfig config() {\n+            return this.configSupplier.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73faac4c32bab026cf1cf574f03160dc83a27372"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkwOTgxNQ==", "bodyText": "I guess if you are removing this. above, you could remove it here as well for consistency.", "url": "https://github.com/apache/kafka/pull/9272#discussion_r487909815", "createdAt": "2020-09-14T13:25:36Z", "author": {"login": "rajinisivaram"}, "path": "clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java", "diffHunk": "@@ -53,12 +54,20 @@\n     private final Object metricLock;\n \n     private static class StatAndConfig {\n-        public final Stat stat;\n-        public final MetricConfig config;\n+        private final Stat stat;\n+        private final Supplier<MetricConfig> configSupplier;\n \n-        StatAndConfig(Stat stat, MetricConfig config) {\n+        StatAndConfig(Stat stat, Supplier<MetricConfig> configSupplier) {\n             this.stat = stat;\n-            this.config = config;\n+            this.configSupplier = configSupplier;\n+        }\n+\n+        public Stat stat() {\n+            return this.stat;\n+        }\n+\n+        public MetricConfig config() {\n+            return this.configSupplier.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73faac4c32bab026cf1cf574f03160dc83a27372"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4ecee3f46c99ae355e264ff11cb1dfd317ff685", "author": {"user": {"login": "dajac", "name": "David Jacot"}}, "url": "https://github.com/apache/kafka/commit/a4ecee3f46c99ae355e264ff11cb1dfd317ff685", "committedDate": "2020-09-14T14:45:41Z", "message": "address feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 586, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}