{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5Nzk5OTc3", "number": 8567, "title": "KAFKA-9652: Fix throttle metric in RequestChannel and request log due to KIP-219", "bodyText": "After KIP-219, responses are sent immediately and we rely on a combination\nof clients and muting of the channel to throttle. The result of this is that\nwe need to track apiThrottleTimeMs as an explicit value instead of\ninferring it. On the other hand,  we no longer need\napiRemoteCompleteTimeNanos.\nExtend BaseQuotaTest to verify that throttle time in the request channel\nmetrics are being set. Given the nature of the throttling numbers, the test\nis not particularly precise.\nI included a few clean-ups:\n\nPass KafkaMetric to QuotaViolationException so that the caller doesn't\nhave to retrieve it from the metrics registry.\nInline Supplier in SocketServer (use SAM).\nReduce redundant time.milliseconds and time.nanosecondscalls.\nUse monotonic clock in ThrottledChannel and simplify compareTo method.\nSimplify TimerTaskList.compareTo.\nConsolidate the number of places where we update apiLocalCompleteTimeNanos\nand responseCompleteTimeNanos.\nAdded toString to ByteBufferSendandMultiRecordsSend`.\nRestrict access to methods in QuotaTestClients to expose only what we need\nto.\n\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-04-27T23:28:41Z", "url": "https://github.com/apache/kafka/pull/8567", "merged": true, "mergeCommit": {"oid": "322b10964ce71eac81da9e574be7dec59c0fc93d"}, "closed": true, "closedAt": "2020-04-30T03:09:17Z", "author": {"login": "ijuma"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcb3kaHgH2gAyNDA5Nzk5OTc3OjdmMmRlOTVhMzdhNzc1NzQxYTU2MTc1MjJmYjViMmVkMzIwYmQ0OTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcchTRqgBqjMyODY5Mjg0Mzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7f2de95a37a775741a5617522fb5b2ed320bd491", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/7f2de95a37a775741a5617522fb5b2ed320bd491", "committedDate": "2020-04-27T23:06:35Z", "message": "Pass KafkaMetric to QuotaViolationException to simplify caller"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fd91c6d0a400bc0e4c0d86c8aa85dc9359f5892", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/9fd91c6d0a400bc0e4c0d86c8aa85dc9359f5892", "committedDate": "2020-04-27T23:06:35Z", "message": "Inline Supplier in SocketServer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff901fa444a3d3004a04a682f723ca4755eee1be", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/ff901fa444a3d3004a04a682f723ca4755eee1be", "committedDate": "2020-04-27T23:06:35Z", "message": "Fix request log and request metrics throttle time tracking\n\nAlso remove reduce redundant `time.milliseconds` and `time.nanoseconds`\ncalls."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90509856cb6cea75ff49354e34b54ba4941dd24e", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/90509856cb6cea75ff49354e34b54ba4941dd24e", "committedDate": "2020-04-27T23:06:35Z", "message": "Clean up ThrottledChannel and TimerTaskList\n\nUse monotonic clock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "399a267dd7afcb51bd1272f0b53e261525884cb4", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/399a267dd7afcb51bd1272f0b53e261525884cb4", "committedDate": "2020-04-27T23:06:35Z", "message": "Verify request channel throttle time metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2fa655b854b733a8ce9ee02c8649b51ef2bddd2", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/d2fa655b854b733a8ce9ee02c8649b51ef2bddd2", "committedDate": "2020-04-27T23:33:02Z", "message": "Clarify comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7386fd253601fe9d39cbaa6a8fee959b915b5f3f", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/7386fd253601fe9d39cbaa6a8fee959b915b5f3f", "committedDate": "2020-04-28T15:30:03Z", "message": "Record throttle time for non produce/fetch requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b986e605b6e2cf995319270231d58a954315e7b3", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/b986e605b6e2cf995319270231d58a954315e7b3", "committedDate": "2020-04-28T15:34:22Z", "message": "Test fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a78e099b4fa8f47fb0839738c6930d65e25d38ec", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/a78e099b4fa8f47fb0839738c6930d65e25d38ec", "committedDate": "2020-04-28T15:34:35Z", "message": "Implement toString for ByteBufferSend and MultiRecordsSend"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMDgyNDQ4", "url": "https://github.com/apache/kafka/pull/8567#pullrequestreview-403082448", "createdAt": "2020-04-29T22:23:27Z", "commit": {"oid": "a78e099b4fa8f47fb0839738c6930d65e25d38ec"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMjoyMzoyOFrOGOTM4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMzoxMjo0MlrOGOURzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY0Nzg0MQ==", "bodyText": "I guess this is not intended?", "url": "https://github.com/apache/kafka/pull/8567#discussion_r417647841", "createdAt": "2020-04-29T22:23:28Z", "author": {"login": "junrao"}, "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -3012,17 +3010,24 @@ class KafkaApis(val requestChannel: RequestChannel,\n   private def sendResponseMaybeThrottle(request: RequestChannel.Request,\n                                         createResponse: Int => AbstractResponse,\n                                         onComplete: Option[Send => Unit] = None): Unit = {\n-    val throttleTimeMs = quotas.request.maybeRecordAndGetThrottleTimeMs(request)\n-    quotas.request.throttle(request, throttleTimeMs, sendResponse)\n+    val throttleTimeMs = maybeRecordAndGetThrottleTimeMs(request)\n+    quotas.request.throttle(request, throttleTimeMs, requestChannel.sendResponse)\n     sendResponse(request, Some(createResponse(throttleTimeMs)), onComplete)\n   }\n \n   private def sendErrorResponseMaybeThrottle(request: RequestChannel.Request, error: Throwable): Unit = {\n-    val throttleTimeMs = quotas.request.maybeRecordAndGetThrottleTimeMs(request)\n-    quotas.request.throttle(request, throttleTimeMs, sendResponse)\n+    val throttleTimeMs = maybeRecordAndGetThrottleTimeMs(request)\n+    quotas.request.throttle(request, throttleTimeMs, requestChannel.sendResponse)\n     sendErrorOrCloseConnection(request, error, throttleTimeMs)\n   }\n \n+  private def maybeRecordAndGetThrottleTimeMs(request: RequestChannel.Request): Int = {\n+    val throttleTimeMs = quotas.request.maybeRecordAndGetThrottleTimeMs(request, time.milliseconds())\n+    println(s\"api throttle ms $throttleTimeMs ${request.header} ${request.header.clientId}\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78e099b4fa8f47fb0839738c6930d65e25d38ec"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY2NTQ4NQ==", "bodyText": "Could this be private?", "url": "https://github.com/apache/kafka/pull/8567#discussion_r417665485", "createdAt": "2020-04-29T23:12:42Z", "author": {"login": "junrao"}, "path": "core/src/test/scala/integration/kafka/api/BaseQuotaTest.scala", "diffHunk": "@@ -235,14 +240,29 @@ abstract class QuotaTestClients(topic: String,\n     numConsumed\n   }\n \n-  def verifyProduceThrottle(expectThrottle: Boolean, verifyClientMetric: Boolean = true): Unit = {\n+  def verifyThrottleTimeRequestChannelMetric(apiKey: ApiKeys, metricNameSuffix: String,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78e099b4fa8f47fb0839738c6930d65e25d38ec"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0962513ea29e4d4c553fcab7aea67925689404bc", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/0962513ea29e4d4c553fcab7aea67925689404bc", "committedDate": "2020-04-29T23:33:34Z", "message": "Remove stray println"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a73ee746aea25adacfa12336c4566cda9fbb856b", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/a73ee746aea25adacfa12336c4566cda9fbb856b", "committedDate": "2020-04-29T23:43:40Z", "message": "Restrict access to various methods in `QuotaTestClients`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "a73ee746aea25adacfa12336c4566cda9fbb856b", "author": {"user": {"login": "ijuma", "name": "Ismael Juma"}}, "url": "https://github.com/apache/kafka/commit/a73ee746aea25adacfa12336c4566cda9fbb856b", "committedDate": "2020-04-29T23:43:40Z", "message": "Restrict access to various methods in `QuotaTestClients`"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1251, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}