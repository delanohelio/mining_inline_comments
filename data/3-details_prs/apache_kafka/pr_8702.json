{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMDkxNjI1", "number": 8702, "title": "MINOR: Fix join group request timeout lower bound", "bodyText": "If the request timeout is larger than the rebalance timeout, we should use the former as the JoinGroup request timeout.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-05-21T00:56:02Z", "url": "https://github.com/apache/kafka/pull/8702", "merged": true, "mergeCommit": {"oid": "713f305172b64e8cb9e2d5e3047b53a018e0c195"}, "closed": true, "closedAt": "2020-05-22T18:53:00Z", "author": {"login": "hachikuji"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjS6MQgH2gAyNDIxMDkxNjI1OjZkYjBlYzkxNzA2Mjg2ZjUyYjAxNTlkNjYxMjJjNWRmNDY1MjRkODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcj0Xo_gFqTQxNzAxNzk4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6db0ec91706286f52b0159d66122c5df46524d89", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/6db0ec91706286f52b0159d66122c5df46524d89", "committedDate": "2020-05-21T00:55:17Z", "message": "MINOR: Fix join group request timeout lower bound"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1ODEyOTc1", "url": "https://github.com/apache/kafka/pull/8702#pullrequestreview-415812975", "createdAt": "2020-05-21T01:01:30Z", "commit": {"oid": "6db0ec91706286f52b0159d66122c5df46524d89"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwMTowMTozMFrOGYi2KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwMTowMTozMFrOGYi2KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4OTkyOQ==", "bodyText": "The previous max check was wrong, but an alternative here is to use rebalanceTimeout + 5s in all cases regardless of the request timeout.", "url": "https://github.com/apache/kafka/pull/8702#discussion_r428389929", "createdAt": "2020-05-21T01:01:30Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -565,8 +566,8 @@ private void recordRebalanceFailure() {\n \n         // Note that we override the request timeout using the rebalance timeout since that is the\n         // maximum time that it may block on the coordinator. We add an extra 5 seconds for small delays.\n-\n-        int joinGroupTimeoutMs = Math.max(rebalanceConfig.rebalanceTimeoutMs, rebalanceConfig.rebalanceTimeoutMs + 5000);\n+        int joinGroupTimeoutMs = Math.max(client.defaultRequestTimeoutMs(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6db0ec91706286f52b0159d66122c5df46524d89"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92f5fab9e8c4e482a7a8164d5116256f0638c22a", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/92f5fab9e8c4e482a7a8164d5116256f0638c22a", "committedDate": "2020-05-21T01:17:10Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NTEyMjUy", "url": "https://github.com/apache/kafka/pull/8702#pullrequestreview-416512252", "createdAt": "2020-05-21T21:39:12Z", "commit": {"oid": "92f5fab9e8c4e482a7a8164d5116256f0638c22a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NTgwNDE3", "url": "https://github.com/apache/kafka/pull/8702#pullrequestreview-416580417", "createdAt": "2020-05-22T00:42:04Z", "commit": {"oid": "92f5fab9e8c4e482a7a8164d5116256f0638c22a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwMDo0MjowNFrOGZHRcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwMDo0NTowMFrOGZHUNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4NjczOQ==", "bodyText": "Could we log a debug info here for the timeout we used?", "url": "https://github.com/apache/kafka/pull/8702#discussion_r428986739", "createdAt": "2020-05-22T00:42:04Z", "author": {"login": "abbccdda"}, "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -565,8 +566,8 @@ private void recordRebalanceFailure() {\n \n         // Note that we override the request timeout using the rebalance timeout since that is the\n         // maximum time that it may block on the coordinator. We add an extra 5 seconds for small delays.\n-\n-        int joinGroupTimeoutMs = Math.max(rebalanceConfig.rebalanceTimeoutMs, rebalanceConfig.rebalanceTimeoutMs + 5000);\n+        int joinGroupTimeoutMs = Math.max(client.defaultRequestTimeoutMs(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4OTkyOQ=="}, "originalCommit": {"oid": "6db0ec91706286f52b0159d66122c5df46524d89"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4NzQ0NA==", "bodyText": "We could just test mockTime.sleep(REQUEST_TIMEOUT_MS + 1) for this case and get rid of expectedRequestDeadline", "url": "https://github.com/apache/kafka/pull/8702#discussion_r428987444", "createdAt": "2020-05-22T00:45:00Z", "author": {"login": "abbccdda"}, "path": "clients/src/test/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinatorTest.java", "diffHunk": "@@ -312,8 +313,27 @@ public void testJoinGroupRequestTimeout() {\n         mockTime.sleep(REQUEST_TIMEOUT_MS + 1);\n         assertFalse(consumerClient.poll(future, mockTime.timer(0)));\n \n-        mockTime.sleep(REBALANCE_TIMEOUT_MS - REQUEST_TIMEOUT_MS + 5000);\n+        mockTime.sleep(REBALANCE_TIMEOUT_MS - REQUEST_TIMEOUT_MS + AbstractCoordinator.JOIN_GROUP_TIMEOUT_LAPSE);\n         assertTrue(consumerClient.poll(future, mockTime.timer(0)));\n+        assertTrue(future.exception() instanceof DisconnectException);\n+    }\n+\n+    @Test\n+    public void testJoinGroupRequestTimeoutLowerBoundedByDefaultRequestTimeout() {\n+        int rebalanceTimeoutMs = REQUEST_TIMEOUT_MS - 10000;\n+        setupCoordinator(RETRY_BACKOFF_MS, rebalanceTimeoutMs, Optional.empty());\n+        mockClient.prepareResponse(groupCoordinatorResponse(node, Errors.NONE));\n+        coordinator.ensureCoordinatorReady(mockTime.timer(0));\n+\n+        RequestFuture<ByteBuffer> future = coordinator.sendJoinGroupRequest();\n+\n+        long expectedRequestDeadline = mockTime.milliseconds() + REQUEST_TIMEOUT_MS;\n+        mockTime.sleep(rebalanceTimeoutMs + AbstractCoordinator.JOIN_GROUP_TIMEOUT_LAPSE + 1);\n+        assertFalse(consumerClient.poll(future, mockTime.timer(0)));\n+\n+        mockTime.sleep(expectedRequestDeadline - mockTime.milliseconds() + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92f5fab9e8c4e482a7a8164d5116256f0638c22a"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "023302f48c3e2b1da07af111f8077d2f84cb466f", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/023302f48c3e2b1da07af111f8077d2f84cb466f", "committedDate": "2020-05-22T15:48:46Z", "message": "Consistent request/response logging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDE3MzQy", "url": "https://github.com/apache/kafka/pull/8702#pullrequestreview-417017342", "createdAt": "2020-05-22T15:53:21Z", "commit": {"oid": "023302f48c3e2b1da07af111f8077d2f84cb466f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNTo1MzoyMVrOGZcEUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNTo1MzoyMVrOGZcEUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMyNzQ0Mw==", "bodyText": "Given that we have to work with all client versions, it's just as common for the client not to match the broker version, so it's not really useful for the behavior to be different when they do match.", "url": "https://github.com/apache/kafka/pull/8702#discussion_r429327443", "createdAt": "2020-05-22T15:53:21Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/NetworkClient.java", "diffHunk": "@@ -502,14 +502,8 @@ private void doSend(ClientRequest clientRequest, boolean isInternalRequest, long\n         String destination = clientRequest.destination();\n         RequestHeader header = clientRequest.makeHeader(request.version());\n         if (log.isDebugEnabled()) {\n-            int latestClientVersion = clientRequest.apiKey().latestVersion();\n-            if (header.apiVersion() == latestClientVersion) {\n-                log.trace(\"Sending {} {} with correlation id {} to node {}\", clientRequest.apiKey(), request,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "023302f48c3e2b1da07af111f8077d2f84cb466f"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDE3OTg5", "url": "https://github.com/apache/kafka/pull/8702#pullrequestreview-417017989", "createdAt": "2020-05-22T15:54:18Z", "commit": {"oid": "023302f48c3e2b1da07af111f8077d2f84cb466f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNTo1NDoxOVrOGZcGSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNTo1NDoxOVrOGZcGSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMyNzk0Ng==", "bodyText": "Letting some requests be debug level, but making the responses be trace often means we are left with only half of the picture.", "url": "https://github.com/apache/kafka/pull/8702#discussion_r429327946", "createdAt": "2020-05-22T15:54:19Z", "author": {"login": "hachikuji"}, "path": "clients/src/main/java/org/apache/kafka/clients/NetworkClient.java", "diffHunk": "@@ -839,20 +833,22 @@ private void handleCompletedReceives(List<ClientResponse> responses, long now) {\n             InFlightRequest req = inFlightRequests.completeNext(source);\n             Struct responseStruct = parseStructMaybeUpdateThrottleTimeMetrics(receive.payload(), req.header,\n                 throttleTimeSensor, now);\n-            if (log.isTraceEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "023302f48c3e2b1da07af111f8077d2f84cb466f"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1122, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}