{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4ODQzMjgx", "number": 8549, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODo0MDoxN1rOD21sWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNToyMToyN1rOEXDs2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4ODI5NDAxOnYy", "diffSide": "RIGHT", "path": "core/src/test/scala/unit/kafka/server/KafkaApisTest.scala", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODo0MDoxN1rOGMyJcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODo0MDoxN1rOGMyJcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA1NzcxMg==", "bodyText": "Side improvement for shouldReplaceCoordinatorNotAvailableWithLoadInProcessInTxnOffsetCommitWithOlderClient", "url": "https://github.com/apache/kafka/pull/8549#discussion_r416057712", "createdAt": "2020-04-27T18:40:17Z", "author": {"login": "abbccdda"}, "path": "core/src/test/scala/unit/kafka/server/KafkaApisTest.scala", "diffHunk": "@@ -297,46 +298,271 @@ class KafkaApisTest {\n     val topic = \"topic\"\n     setupBasicMetadataCache(topic, numPartitions = 2)\n \n-    EasyMock.reset(replicaManager, clientRequestQuotaManager, requestChannel, groupCoordinator)\n+    for (version <- ApiKeys.TXN_OFFSET_COMMIT.oldestVersion to ApiKeys.TXN_OFFSET_COMMIT.latestVersion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODUzNjMzOnYy", "diffSide": "RIGHT", "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxODowMDo1MlrOGaHQGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxODowMDo1MlrOGaHQGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAzNDk3MQ==", "bodyText": "nit: For older versions.. -> we could still receive INVALID_PRODUCER_EPOCH from old versioned transaction coordinator...", "url": "https://github.com/apache/kafka/pull/8549#discussion_r430034971", "createdAt": "2020-05-25T18:00:52Z", "author": {"login": "guozhangwang"}, "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java", "diffHunk": "@@ -1415,8 +1419,10 @@ public void handleResponse(AbstractResponse response) {\n                 } else if (error == Errors.COORDINATOR_LOAD_IN_PROGRESS || error == Errors.UNKNOWN_TOPIC_OR_PARTITION) {\n                     reenqueue();\n                     return;\n-                } else if (error == Errors.INVALID_PRODUCER_EPOCH) {\n-                    fatalError(error.exception());\n+                } else if (error == Errors.INVALID_PRODUCER_EPOCH || error == Errors.PRODUCER_FENCED) {\n+                    // For older versions, we could still receive INVALID_PRODUCER_EPOCH from transaction coordinator.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bd99a6ae054a21e186ad452edb4842950783be1"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODUzODM4OnYy", "diffSide": "RIGHT", "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxODowMjoyMVrOGaHRZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxODowMjoyMVrOGaHRZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAzNTMwMQ==", "bodyText": "nit: ditto here, We could still receive INVALID_PRODUCER_EPOCH from old versioned transaction coordinator.", "url": "https://github.com/apache/kafka/pull/8549#discussion_r430035301", "createdAt": "2020-05-25T18:02:21Z", "author": {"login": "guozhangwang"}, "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java", "diffHunk": "@@ -1364,6 +1364,10 @@ public void handleResponse(AbstractResponse response) {\n             } else if (error == Errors.TRANSACTIONAL_ID_AUTHORIZATION_FAILED ||\n                     error == Errors.CLUSTER_AUTHORIZATION_FAILED) {\n                 fatalError(error.exception());\n+            } else if (error == Errors.INVALID_PRODUCER_EPOCH || error == Errors.PRODUCER_FENCED) {\n+                // For older versions, we could still receive INVALID_PRODUCER_EPOCH from transaction coordinator.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bd99a6ae054a21e186ad452edb4842950783be1"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODUzOTMzOnYy", "diffSide": "RIGHT", "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxODowMjo1NFrOGaHR7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxODowMjo1NFrOGaHR7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAzNTQzNg==", "bodyText": "Ditto here.", "url": "https://github.com/apache/kafka/pull/8549#discussion_r430035436", "createdAt": "2020-05-25T18:02:54Z", "author": {"login": "guozhangwang"}, "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java", "diffHunk": "@@ -1573,8 +1579,10 @@ public void handleResponse(AbstractResponse response) {\n                 reenqueue();\n             } else if (error == Errors.COORDINATOR_LOAD_IN_PROGRESS || error == Errors.CONCURRENT_TRANSACTIONS) {\n                 reenqueue();\n-            } else if (error == Errors.INVALID_PRODUCER_EPOCH) {\n-                fatalError(error.exception());\n+            } else if (error == Errors.INVALID_PRODUCER_EPOCH || error == Errors.PRODUCER_FENCED) {\n+                // For older versions, we could still receive INVALID_PRODUCER_EPOCH from transaction coordinator.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bd99a6ae054a21e186ad452edb4842950783be1"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODUzOTQyOnYy", "diffSide": "RIGHT", "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxODowMjo1OFrOGaHR-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxODowMjo1OFrOGaHR-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAzNTQ1MA==", "bodyText": "Ditto here.", "url": "https://github.com/apache/kafka/pull/8549#discussion_r430035450", "createdAt": "2020-05-25T18:02:58Z", "author": {"login": "guozhangwang"}, "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java", "diffHunk": "@@ -1630,8 +1638,10 @@ public void handleResponse(AbstractResponse response) {\n                 reenqueue();\n             } else if (error == Errors.UNKNOWN_PRODUCER_ID || error == Errors.INVALID_PRODUCER_ID_MAPPING) {\n                 abortableErrorIfPossible(error.exception());\n-            } else if (error == Errors.INVALID_PRODUCER_EPOCH) {\n-                fatalError(error.exception());\n+            } else if (error == Errors.INVALID_PRODUCER_EPOCH || error == Errors.PRODUCER_FENCED) {\n+                // For older versions, we could still receive INVALID_PRODUCER_EPOCH from transaction coordinator.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bd99a6ae054a21e186ad452edb4842950783be1"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODU0NTk1OnYy", "diffSide": "RIGHT", "path": "clients/src/main/java/org/apache/kafka/common/errors/InvalidProducerEpochException.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxODowNTozOFrOGaHVxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwMzoyMzo1NVrOGaNf1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAzNjQyMw==", "bodyText": "If my understanding is correct this exception would never be thrown out to the caller? If that's the case do we need to put it as a public class, or could we put it as part of o.a.k.clients.internals?", "url": "https://github.com/apache/kafka/pull/8549#discussion_r430036423", "createdAt": "2020-05-25T18:05:38Z", "author": {"login": "guozhangwang"}, "path": "clients/src/main/java/org/apache/kafka/common/errors/InvalidProducerEpochException.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.errors;\n+\n+/**\n+ * This exception indicates that the produce request sent to the partition leader\n+ * contains a non-matching producer epoch. When encountering this exception, the ongoing transaction\n+ * will be aborted and can be retried.\n+ */\n+public class InvalidProducerEpochException extends RetriableException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bd99a6ae054a21e186ad452edb4842950783be1"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEzNzMwMQ==", "bodyText": "Sg, let me have a try.", "url": "https://github.com/apache/kafka/pull/8549#discussion_r430137301", "createdAt": "2020-05-26T03:23:55Z", "author": {"login": "abbccdda"}, "path": "clients/src/main/java/org/apache/kafka/common/errors/InvalidProducerEpochException.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.errors;\n+\n+/**\n+ * This exception indicates that the produce request sent to the partition leader\n+ * contains a non-matching producer epoch. When encountering this exception, the ongoing transaction\n+ * will be aborted and can be retried.\n+ */\n+public class InvalidProducerEpochException extends RetriableException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAzNjQyMw=="}, "originalCommit": {"oid": "9bd99a6ae054a21e186ad452edb4842950783be1"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODU1NDQ4OnYy", "diffSide": "RIGHT", "path": "clients/src/test/java/org/apache/kafka/clients/producer/internals/TransactionManagerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxODoxMToyNVrOGaHa3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNToxNDoyNlrOG-oo4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAzNzcyNQ==", "bodyText": "Could we also verify that the producer did retry by sending initPid to the txn coordinator?", "url": "https://github.com/apache/kafka/pull/8549#discussion_r430037725", "createdAt": "2020-05-25T18:11:25Z", "author": {"login": "guozhangwang"}, "path": "clients/src/test/java/org/apache/kafka/clients/producer/internals/TransactionManagerTest.java", "diffHunk": "@@ -1571,6 +1637,54 @@ public void testProducerFencedException() throws InterruptedException {\n             Collections.emptyMap(), new ConsumerGroupMetadata(\"dummyId\")));\n     }\n \n+    @Test\n+    public void testInvalidProducerEpochConvertToProducerFencedInEndTxn() throws InterruptedException {\n+        doInitTransactions();\n+\n+        transactionManager.beginTransaction();\n+        transactionManager.failIfNotReadyForSend();\n+        transactionManager.maybeAddPartitionToTransaction(tp0);\n+        TransactionalRequestResult commitResult = transactionManager.beginCommit();\n+\n+        Future<RecordMetadata> responseFuture = appendToAccumulator(tp0);\n+\n+        assertFalse(responseFuture.isDone());\n+        prepareAddPartitionsToTxnResponse(Errors.NONE, tp0, epoch, producerId);\n+        prepareProduceResponse(Errors.NONE, producerId, epoch);\n+        prepareEndTxnResponse(Errors.INVALID_PRODUCER_EPOCH, TransactionResult.COMMIT, producerId, epoch);\n+\n+        runUntil(commitResult::isCompleted);\n+        runUntil(responseFuture::isDone);\n+\n+        // make sure the exception was thrown directly from the follow-up calls.\n+        assertThrows(KafkaException.class, () -> transactionManager.beginTransaction());\n+        assertThrows(KafkaException.class, () -> transactionManager.beginCommit());\n+        assertThrows(KafkaException.class, () -> transactionManager.beginAbort());\n+        assertThrows(KafkaException.class, () -> transactionManager.sendOffsetsToTransaction(\n+            Collections.emptyMap(), new ConsumerGroupMetadata(\"dummyId\")));\n+    }\n+\n+    @Test\n+    public void testInvalidProducerEpochFromProduce() throws InterruptedException {\n+        doInitTransactions();\n+\n+        transactionManager.beginTransaction();\n+        transactionManager.failIfNotReadyForSend();\n+        transactionManager.maybeAddPartitionToTransaction(tp0);\n+\n+        Future<RecordMetadata> responseFuture = appendToAccumulator(tp0);\n+\n+        assertFalse(responseFuture.isDone());\n+        prepareAddPartitionsToTxnResponse(Errors.NONE, tp0, epoch, producerId);\n+        prepareProduceResponse(Errors.INVALID_PRODUCER_EPOCH, producerId, epoch);\n+        prepareProduceResponse(Errors.NONE, producerId, epoch);\n+\n+        sender.runOnce();\n+\n+        runUntil(responseFuture::isDone);\n+        assertFalse(transactionManager.hasError());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bd99a6ae054a21e186ad452edb4842950783be1"}, "originalPosition": 165}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMzMDcyMg==", "bodyText": "Thanks for adding the coverage!", "url": "https://github.com/apache/kafka/pull/8549#discussion_r468330722", "createdAt": "2020-08-11T05:14:26Z", "author": {"login": "guozhangwang"}, "path": "clients/src/test/java/org/apache/kafka/clients/producer/internals/TransactionManagerTest.java", "diffHunk": "@@ -1571,6 +1637,54 @@ public void testProducerFencedException() throws InterruptedException {\n             Collections.emptyMap(), new ConsumerGroupMetadata(\"dummyId\")));\n     }\n \n+    @Test\n+    public void testInvalidProducerEpochConvertToProducerFencedInEndTxn() throws InterruptedException {\n+        doInitTransactions();\n+\n+        transactionManager.beginTransaction();\n+        transactionManager.failIfNotReadyForSend();\n+        transactionManager.maybeAddPartitionToTransaction(tp0);\n+        TransactionalRequestResult commitResult = transactionManager.beginCommit();\n+\n+        Future<RecordMetadata> responseFuture = appendToAccumulator(tp0);\n+\n+        assertFalse(responseFuture.isDone());\n+        prepareAddPartitionsToTxnResponse(Errors.NONE, tp0, epoch, producerId);\n+        prepareProduceResponse(Errors.NONE, producerId, epoch);\n+        prepareEndTxnResponse(Errors.INVALID_PRODUCER_EPOCH, TransactionResult.COMMIT, producerId, epoch);\n+\n+        runUntil(commitResult::isCompleted);\n+        runUntil(responseFuture::isDone);\n+\n+        // make sure the exception was thrown directly from the follow-up calls.\n+        assertThrows(KafkaException.class, () -> transactionManager.beginTransaction());\n+        assertThrows(KafkaException.class, () -> transactionManager.beginCommit());\n+        assertThrows(KafkaException.class, () -> transactionManager.beginAbort());\n+        assertThrows(KafkaException.class, () -> transactionManager.sendOffsetsToTransaction(\n+            Collections.emptyMap(), new ConsumerGroupMetadata(\"dummyId\")));\n+    }\n+\n+    @Test\n+    public void testInvalidProducerEpochFromProduce() throws InterruptedException {\n+        doInitTransactions();\n+\n+        transactionManager.beginTransaction();\n+        transactionManager.failIfNotReadyForSend();\n+        transactionManager.maybeAddPartitionToTransaction(tp0);\n+\n+        Future<RecordMetadata> responseFuture = appendToAccumulator(tp0);\n+\n+        assertFalse(responseFuture.isDone());\n+        prepareAddPartitionsToTxnResponse(Errors.NONE, tp0, epoch, producerId);\n+        prepareProduceResponse(Errors.INVALID_PRODUCER_EPOCH, producerId, epoch);\n+        prepareProduceResponse(Errors.NONE, producerId, epoch);\n+\n+        sender.runOnce();\n+\n+        runUntil(responseFuture::isDone);\n+        assertFalse(transactionManager.hasError());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAzNzcyNQ=="}, "originalCommit": {"oid": "9bd99a6ae054a21e186ad452edb4842950783be1"}, "originalPosition": 165}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNjEwMTU2OnYy", "diffSide": "RIGHT", "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNTowMzoxOVrOG-od8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNTowMzoxOVrOG-od8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyNzkyMA==", "bodyText": "Good catch.", "url": "https://github.com/apache/kafka/pull/8549#discussion_r468327920", "createdAt": "2020-08-11T05:03:19Z", "author": {"login": "guozhangwang"}, "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java", "diffHunk": "@@ -1366,6 +1366,10 @@ public void handleResponse(AbstractResponse response) {\n             } else if (error == Errors.TRANSACTIONAL_ID_AUTHORIZATION_FAILED ||\n                     error == Errors.CLUSTER_AUTHORIZATION_FAILED) {\n                 fatalError(error.exception());\n+            } else if (error == Errors.INVALID_PRODUCER_EPOCH || error == Errors.PRODUCER_FENCED) {\n+                // We could still receive INVALID_PRODUCER_EPOCH from transaction coordinator,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f64d4df4d4998cb2f5a53ce07952f0b8571d46"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNjEwNTU5OnYy", "diffSide": "RIGHT", "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNTowNToyN1rOG-ogHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNTowNToyN1rOG-ogHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyODQ3OQ==", "bodyText": "nit: \".. old versioned transaction coordinator\", ditto below.", "url": "https://github.com/apache/kafka/pull/8549#discussion_r468328479", "createdAt": "2020-08-11T05:05:27Z", "author": {"login": "guozhangwang"}, "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java", "diffHunk": "@@ -1417,8 +1421,10 @@ public void handleResponse(AbstractResponse response) {\n                 } else if (error == Errors.COORDINATOR_LOAD_IN_PROGRESS || error == Errors.UNKNOWN_TOPIC_OR_PARTITION) {\n                     reenqueue();\n                     return;\n-                } else if (error == Errors.INVALID_PRODUCER_EPOCH) {\n-                    fatalError(error.exception());\n+                } else if (error == Errors.INVALID_PRODUCER_EPOCH || error == Errors.PRODUCER_FENCED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f64d4df4d4998cb2f5a53ce07952f0b8571d46"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNjExNzMzOnYy", "diffSide": "RIGHT", "path": "clients/src/main/java/org/apache/kafka/common/internals/InvalidProducerEpochException.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNToxMjoxMFrOG-omyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNjowMjoyOFrOG--wLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMzMDE4NQ==", "bodyText": "Why not put this internal exception in org.apache.kafka.clients.producer.internals?", "url": "https://github.com/apache/kafka/pull/8549#discussion_r468330185", "createdAt": "2020-08-11T05:12:10Z", "author": {"login": "guozhangwang"}, "path": "clients/src/main/java/org/apache/kafka/common/internals/InvalidProducerEpochException.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f64d4df4d4998cb2f5a53ce07952f0b8571d46"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY5MzAzNg==", "bodyText": "sg", "url": "https://github.com/apache/kafka/pull/8549#discussion_r468693036", "createdAt": "2020-08-11T16:02:28Z", "author": {"login": "abbccdda"}, "path": "clients/src/main/java/org/apache/kafka/common/internals/InvalidProducerEpochException.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMzMDE4NQ=="}, "originalCommit": {"oid": "f5f64d4df4d4998cb2f5a53ce07952f0b8571d46"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNjEzMzM2OnYy", "diffSide": "LEFT", "path": "core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNToyMToyN1rOG-owDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMjoyOTozNVrOG_LaIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMzMjU1OQ==", "bodyText": "In the new broker version, when do we still return INVALID_PRODUCER_EPOCH then? Or would we never return it any more?", "url": "https://github.com/apache/kafka/pull/8549#discussion_r468332559", "createdAt": "2020-08-11T05:21:27Z", "author": {"login": "guozhangwang"}, "path": "core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala", "diffHunk": "@@ -539,7 +539,7 @@ class TransactionCoordinator(brokerId: Int,\n           s\"${txnIdAndPidEpoch.transactionalId} due to timeout\")\n \n       case error@(Errors.INVALID_PRODUCER_ID_MAPPING |\n-                  Errors.INVALID_PRODUCER_EPOCH |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f64d4df4d4998cb2f5a53ce07952f0b8571d46"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY5NDA4OQ==", "bodyText": "We do return INVALID_PRODUCER_EPOCH when the client is in old version, as they don't recognize the new error code. See KafkaApis", "url": "https://github.com/apache/kafka/pull/8549#discussion_r468694089", "createdAt": "2020-08-11T16:04:15Z", "author": {"login": "abbccdda"}, "path": "core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala", "diffHunk": "@@ -539,7 +539,7 @@ class TransactionCoordinator(brokerId: Int,\n           s\"${txnIdAndPidEpoch.transactionalId} due to timeout\")\n \n       case error@(Errors.INVALID_PRODUCER_ID_MAPPING |\n-                  Errors.INVALID_PRODUCER_EPOCH |", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMzMjU1OQ=="}, "originalCommit": {"oid": "f5f64d4df4d4998cb2f5a53ce07952f0b8571d46"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkwMDM4Ng==", "bodyText": "My confusion was that for new broker <-> new client communication, could we still return INVALID_PRODUCER_EPOCH as the error code? From KIP-588 my understanding is that, txn-coordinator -> producer would not return INVALID_PRODUCER_EPOCH anymore for all txn-related requests, and only broker -> producer ProduceResponse would return INVALID_PRODUCER_EPOCH. Now I get that you are maintaining the javadoc / handling for compatibility. So we are good :)", "url": "https://github.com/apache/kafka/pull/8549#discussion_r468900386", "createdAt": "2020-08-11T22:29:35Z", "author": {"login": "guozhangwang"}, "path": "core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala", "diffHunk": "@@ -539,7 +539,7 @@ class TransactionCoordinator(brokerId: Int,\n           s\"${txnIdAndPidEpoch.transactionalId} due to timeout\")\n \n       case error@(Errors.INVALID_PRODUCER_ID_MAPPING |\n-                  Errors.INVALID_PRODUCER_EPOCH |", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMzMjU1OQ=="}, "originalCommit": {"oid": "f5f64d4df4d4998cb2f5a53ce07952f0b8571d46"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2782, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}