{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0NDEyMTAx", "number": 9781, "title": "MINOR: Use top-level error in `UpdateFeaturesRequest.getErrorResponse`", "bodyText": "The current getErrorResponse sets all of the feature errors, but does not set a top-level error. It seems like the whole point of having the top-level error is so that it could be used in cases like this.\nCommitter Checklist (excluded from commit message)\n\n Verify design and implementation\n Verify test coverage and CI build status\n Verify documentation (including upgrade notes)", "createdAt": "2020-12-22T22:55:45Z", "url": "https://github.com/apache/kafka/pull/9781", "merged": true, "mergeCommit": {"oid": "3ebd32b2a563440645de45ecb578d8a8dccbee95"}, "closed": true, "closedAt": "2020-12-29T21:41:57Z", "author": {"login": "hachikuji"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdoypAdgH2gAyNTQ0NDEyMTAxOjYwOTM4ZGNlODI5NTcyNWI4ZGQxMzc1MGNiMzNmM2I2ZjllN2M5ZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdq_GILAFqTU1OTY1Mjg5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "60938dce8295725b8dd13750cb33f3b6f9e7c9f3", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/60938dce8295725b8dd13750cb33f3b6f9e7c9f3", "committedDate": "2020-12-22T22:54:15Z", "message": "MINOR: Use top-level error in `UpdateFeaturesRequest.getErrorResponse`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3NDI2MTY4", "url": "https://github.com/apache/kafka/pull/9781#pullrequestreview-557426168", "createdAt": "2020-12-22T23:34:48Z", "commit": {"oid": "60938dce8295725b8dd13750cb33f3b6f9e7c9f3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQyMzozNDo0OVrOIKMQTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQyMzozNDo0OVrOIKMQTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU1NzQ1Mg==", "bodyText": "You could inline ApiError.fromThrowable(e) here, and eliminate the apiError local variable.", "url": "https://github.com/apache/kafka/pull/9781#discussion_r547557452", "createdAt": "2020-12-22T23:34:49Z", "author": {"login": "kowshik"}, "path": "clients/src/main/java/org/apache/kafka/common/requests/UpdateFeaturesRequest.java", "diffHunk": "@@ -57,18 +55,11 @@ public UpdateFeaturesRequest(UpdateFeaturesRequestData data, short version) {\n     @Override\n     public AbstractResponse getErrorResponse(int throttleTimeMs, Throwable e) {\n         final ApiError apiError = ApiError.fromThrowable(e);\n-        final UpdatableFeatureResultCollection results = new UpdatableFeatureResultCollection();\n-        for (FeatureUpdateKey update : this.data.featureUpdates().valuesSet()) {\n-            final UpdatableFeatureResult result = new UpdatableFeatureResult()\n-                .setFeature(update.feature())\n-                .setErrorCode(apiError.error().code())\n-                .setErrorMessage(apiError.message());\n-            results.add(result);\n-        }\n-        final UpdateFeaturesResponseData responseData = new UpdateFeaturesResponseData()\n-            .setThrottleTimeMs(throttleTimeMs)\n-            .setResults(results);\n-        return new UpdateFeaturesResponse(responseData);\n+        return UpdateFeaturesResponse.createWithErrors(\n+            apiError,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60938dce8295725b8dd13750cb33f3b6f9e7c9f3"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fea71bff1da68894cbcd743788888b925b83d75a", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/fea71bff1da68894cbcd743788888b925b83d75a", "committedDate": "2020-12-23T00:55:34Z", "message": "Remove unneeded local variable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3NDczOTg5", "url": "https://github.com/apache/kafka/pull/9781#pullrequestreview-557473989", "createdAt": "2020-12-23T02:29:05Z", "commit": {"oid": "fea71bff1da68894cbcd743788888b925b83d75a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwMjoyOTowNVrOIKPK1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwMjoyOTowNVrOIKPK1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYwNTIwNw==", "bodyText": "If we want set only top-level error, we have to make UpdateFeaturesResponse#errors use top-level error as well. Otherwise, the top-level error can't be propagated correctly.\nsee https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/requests/UpdateFeaturesResponse.java#L48", "url": "https://github.com/apache/kafka/pull/9781#discussion_r547605207", "createdAt": "2020-12-23T02:29:05Z", "author": {"login": "chia7712"}, "path": "clients/src/main/java/org/apache/kafka/common/requests/UpdateFeaturesRequest.java", "diffHunk": "@@ -56,19 +54,11 @@ public UpdateFeaturesRequest(UpdateFeaturesRequestData data, short version) {\n \n     @Override\n     public AbstractResponse getErrorResponse(int throttleTimeMs, Throwable e) {\n-        final ApiError apiError = ApiError.fromThrowable(e);\n-        final UpdatableFeatureResultCollection results = new UpdatableFeatureResultCollection();\n-        for (FeatureUpdateKey update : this.data.featureUpdates().valuesSet()) {\n-            final UpdatableFeatureResult result = new UpdatableFeatureResult()\n-                .setFeature(update.feature())\n-                .setErrorCode(apiError.error().code())\n-                .setErrorMessage(apiError.message());\n-            results.add(result);\n-        }\n-        final UpdateFeaturesResponseData responseData = new UpdateFeaturesResponseData()\n-            .setThrottleTimeMs(throttleTimeMs)\n-            .setResults(results);\n-        return new UpdateFeaturesResponse(responseData);\n+        return UpdateFeaturesResponse.createWithErrors(\n+            ApiError.fromThrowable(e),\n+            Collections.emptyMap(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fea71bff1da68894cbcd743788888b925b83d75a"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc3677dd91e66a1dfa63316cf9203a63e7565679", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/fc3677dd91e66a1dfa63316cf9203a63e7565679", "committedDate": "2020-12-28T17:35:07Z", "message": "Response error counts should include top level error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcb75d73407a5099c2314baf0ec0f006b79a7e7e", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/fcb75d73407a5099c2314baf0ec0f006b79a7e7e", "committedDate": "2020-12-28T17:41:49Z", "message": "Remove unused `errors` method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7626f3275d899e2290b1a9353ac7a2d2811d17a7", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/7626f3275d899e2290b1a9353ac7a2d2811d17a7", "committedDate": "2020-12-28T17:43:58Z", "message": "Add newlines at end of tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MzkwMjY0", "url": "https://github.com/apache/kafka/pull/9781#pullrequestreview-559390264", "createdAt": "2020-12-29T06:12:44Z", "commit": {"oid": "7626f3275d899e2290b1a9353ac7a2d2811d17a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwNjoxMjo0NFrOIMHwuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwNjoxMjo0NFrOIMHwuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU4MDk4Nw==", "bodyText": "Is valuesSet necessary?", "url": "https://github.com/apache/kafka/pull/9781#discussion_r549580987", "createdAt": "2020-12-29T06:12:44Z", "author": {"login": "chia7712"}, "path": "clients/src/main/java/org/apache/kafka/common/requests/UpdateFeaturesResponse.java", "diffHunk": "@@ -45,16 +44,18 @@ public UpdateFeaturesResponse(UpdateFeaturesResponseData data) {\n         this.data = data;\n     }\n \n-    public Map<String, ApiError> errors() {\n-        return data.results().valuesSet().stream().collect(\n-            Collectors.toMap(\n-                result -> result.feature(),\n-                result -> new ApiError(Errors.forCode(result.errorCode()), result.errorMessage())));\n+    public ApiError topLevelError() {\n+        return new ApiError(Errors.forCode(data.errorCode()), data.errorMessage());\n     }\n \n     @Override\n     public Map<Errors, Integer> errorCounts() {\n-        return apiErrorCounts(errors());\n+        Map<Errors, Integer> errorCounts = new HashMap<>();\n+        updateErrorCounts(errorCounts, Errors.forCode(data.errorCode()));\n+        for (UpdatableFeatureResult result : data.results().valuesSet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7626f3275d899e2290b1a9353ac7a2d2811d17a7"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fe23e26408a4d83324b037562186ef97b868750", "author": {"user": {"login": "hachikuji", "name": "Jason Gustafson"}}, "url": "https://github.com/apache/kafka/commit/2fe23e26408a4d83324b037562186ef97b868750", "committedDate": "2020-12-29T18:28:47Z", "message": "Remove unnecessary `valueSet` in loop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NjUyODk4", "url": "https://github.com/apache/kafka/pull/9781#pullrequestreview-559652898", "createdAt": "2020-12-29T18:32:46Z", "commit": {"oid": "2fe23e26408a4d83324b037562186ef97b868750"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2383, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}