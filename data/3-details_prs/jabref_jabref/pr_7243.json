{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1NjEyMzc0", "number": 7243, "title": "Fix Normalize pages formatter not replacing dashes", "bodyText": "Fixes #7239\n\n\n\n Change in CHANGELOG.md described (if applicable)\n Tests created for changes (if applicable)\n Manually tested changed features in running JabRef (always required)\n Screenshots added in PR description (for UI changes)\n Checked documentation: Is the information available and up to date? If not created an issue at https://github.com/JabRef/user-documentation/issues or, even better, submitted a pull request to the documentation repository.", "createdAt": "2020-12-25T16:43:20Z", "url": "https://github.com/JabRef/jabref/pull/7243", "merged": true, "mergeCommit": {"oid": "eca13ddb173ba8f49f6324935c90d0db1ccc0001"}, "closed": true, "closedAt": "2021-01-04T16:37:24Z", "author": {"login": "Siedlerchr"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdprIOfAH2gAyNTQ1NjEyMzc0OmFmYzBmZjlmZDdiMmUzYjY2MzI2ODA0MTk1NDcxODdkN2M3NDA2MGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABds5BnBgFqTU2MTE2OTM1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "afc0ff9fd7b2e3b6632680419547187d7c74060d", "author": {"user": {"login": "Siedlerchr", "name": "Christoph"}}, "url": "https://github.com/JabRef/jabref/commit/afc0ff9fd7b2e3b6632680419547187d7c74060d", "committedDate": "2020-12-25T16:43:02Z", "message": "Fix Normalize pages fornatter not replacing dashes\n\nFixes #7239"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODMxMzE4", "url": "https://github.com/JabRef/jabref/pull/7243#pullrequestreview-558831318", "createdAt": "2020-12-25T18:05:18Z", "commit": {"oid": "afc0ff9fd7b2e3b6632680419547187d7c74060d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQxODowNToxOFrOILeFow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQxODowNTo0NlrOILeF2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5ODIxMQ==", "bodyText": "I think this may result in unwanted changes. The formatter should only format pages if they are \"kind of\" in the right format. Now something like 40&50 is changed to 4050.", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r548898211", "createdAt": "2020-12-25T18:05:18Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/logic/formatter/bibtexfields/NormalizePagesFormatter.java", "diffHunk": "@@ -63,7 +64,8 @@ public String format(String value) {\n         // Remove pages prefix\n         String cleanValue = value.replace(\"pp.\", \"\").replace(\"p.\", \"\");\n         // remove unwanted literals including en dash, em dash, and whitespace\n-        cleanValue = cleanValue.replaceAll(\"\\u2013|\\u2014\", \"-\").replaceAll(REJECT_LITERALS, \"\");\n+        cleanValue = EM_EN_DASH_PATTERN.matcher(cleanValue).replaceAll(\"-\");\n+        cleanValue = REJECT_LITERALS_PATTERN.matcher(cleanValue).replaceAll(\"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afc0ff9fd7b2e3b6632680419547187d7c74060d"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5ODI2NQ==", "bodyText": "I would put this into the PAGES_DETECT_PATTERN.", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r548898265", "createdAt": "2020-12-25T18:05:46Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/logic/formatter/bibtexfields/NormalizePagesFormatter.java", "diffHunk": "@@ -63,7 +64,8 @@ public String format(String value) {\n         // Remove pages prefix\n         String cleanValue = value.replace(\"pp.\", \"\").replace(\"p.\", \"\");\n         // remove unwanted literals including en dash, em dash, and whitespace\n-        cleanValue = cleanValue.replaceAll(\"\\u2013|\\u2014\", \"-\").replaceAll(REJECT_LITERALS, \"\");\n+        cleanValue = EM_EN_DASH_PATTERN.matcher(cleanValue).replaceAll(\"-\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afc0ff9fd7b2e3b6632680419547187d7c74060d"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a127881702ca3446826eea189cf17ded91b9d6e5", "author": {"user": {"login": "Siedlerchr", "name": "Christoph"}}, "url": "https://github.com/JabRef/jabref/commit/a127881702ca3446826eea189cf17ded91b9d6e5", "committedDate": "2020-12-26T13:51:03Z", "message": "add to existing regexes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55be2f89d8120671467f36d887f1251db4f5696b", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/55be2f89d8120671467f36d887f1251db4f5696b", "committedDate": "2020-12-28T17:00:19Z", "message": "Simplify NormalizePagesFormatter and add UnprotectTermsFormatter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edd430c6ef6896eae7c79f7b739a4ac846023340", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/edd430c6ef6896eae7c79f7b739a4ac846023340", "committedDate": "2020-12-28T17:03:36Z", "message": "Merge branch 'master' into fixNormalizePagesFormatter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed1f74cc0920907d5480569dfe0ac7fe2264db07", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/ed1f74cc0920907d5480569dfe0ac7fe2264db07", "committedDate": "2020-12-28T17:36:37Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ac8c19d62278edb2920a80699c5312c186e1f10", "author": {"user": {"login": "Siedlerchr", "name": "Christoph"}}, "url": "https://github.com/JabRef/jabref/commit/0ac8c19d62278edb2920a80699c5312c186e1f10", "committedDate": "2020-12-29T12:01:43Z", "message": "fix failing test and checkstlye"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d334303320b974d7803b0f4ec50b69bc202ae4d", "author": {"user": {"login": "Siedlerchr", "name": "Christoph"}}, "url": "https://github.com/JabRef/jabref/commit/3d334303320b974d7803b0f4ec50b69bc202ae4d", "committedDate": "2020-12-29T12:36:39Z", "message": "try to fix l10n"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "428aea1055d479c773fee9f65d28e33dde65b6f0", "author": {"user": {"login": "Siedlerchr", "name": "Christoph"}}, "url": "https://github.com/JabRef/jabref/commit/428aea1055d479c773fee9f65d28e33dde65b6f0", "committedDate": "2020-12-29T12:41:56Z", "message": "fix l10n again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "361cb5dfd2a4dbdacf1315eb8a871a9c2d982fe5", "author": {"user": {"login": "Siedlerchr", "name": "Christoph"}}, "url": "https://github.com/JabRef/jabref/commit/361cb5dfd2a4dbdacf1315eb8a871a9c2d982fe5", "committedDate": "2020-12-29T12:48:03Z", "message": "hopefully last l10n fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NjA0NDUy", "url": "https://github.com/JabRef/jabref/pull/7243#pullrequestreview-559604452", "createdAt": "2020-12-29T16:20:49Z", "commit": {"oid": "361cb5dfd2a4dbdacf1315eb8a871a9c2d982fe5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNjoyMDo0OVrOIMS-vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNjozNDoxNlrOIMTQZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc2NDc5OQ==", "bodyText": "input -> expected order makes more sense", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r549764799", "createdAt": "2020-12-29T16:20:49Z", "author": {"login": "tobiasdiez"}, "path": "src/test/java/org/jabref/logic/formatter/bibtexfields/NormalizePagesFormatterTest.java", "diffHunk": "@@ -10,102 +13,76 @@\n  */\n public class NormalizePagesFormatterTest {\n \n-    private NormalizePagesFormatter formatter;\n+    private final NormalizePagesFormatter formatter = new NormalizePagesFormatter();\n \n-    @BeforeEach\n-    public void setUp() {\n-        formatter = new NormalizePagesFormatter();\n-    }\n+    private static Stream<Arguments> tests() {\n+        return Stream.of(\n+                // formatSinglePageResultsInNoChange\n+                Arguments.of(\"1\", \"1\"),\n \n-    @Test\n-    public void formatSinglePageResultsInNoChange() {\n-        assertEquals(\"1\", formatter.format(\"1\"));\n-    }\n+                // formatPageNumbers\n+                Arguments.of(\"1--2\", \"1-2\"),\n \n-    @Test\n-    public void formatPageNumbers() {\n-        assertEquals(\"1--2\", formatter.format(\"1-2\"));\n-    }\n+                // formatPageNumbersCommaSeparated\n+                Arguments.of(\"1,2,3\", \"1,2,3\"),\n \n-    @Test\n-    public void formatPageNumbersCommaSeparated() {\n-        assertEquals(\"1,2,3\", formatter.format(\"1,2,3\"));\n-    }\n+                // formatPageNumbersPlusRange\n+                Arguments.of(\"43+\", \"43+\"),\n \n-    @Test\n-    public void formatPageNumbersPlusRange() {\n-        assertEquals(\"43+\", formatter.format(\"43+\"));\n-    }\n+                // ignoreWhitespaceInPageNumbers\n+                Arguments.of(\"1--2\", \"   1  - 2 \"),\n \n-    @Test\n-    public void ignoreWhitespaceInPageNumbers() {\n-        assertEquals(\"1--2\", formatter.format(\"   1  - 2 \"));\n-    }\n+                // removeWhitespaceSinglePage\n+                Arguments.of(\"1\", \"   1  \"),\n \n-    @Test\n-    public void removeWhitespaceSinglePage() {\n-        assertEquals(\"1\", formatter.format(\"   1  \"));\n-    }\n+                // removeWhitespacePageRange\n+                Arguments.of(\"1--2\", \"   1 -- 2  \"),\n \n-    @Test\n-    public void removeWhitespacePageRange() {\n-        assertEquals(\"1--2\", formatter.format(\"   1 -- 2  \"));\n-    }\n+                // ignoreWhitespaceInPageNumbersWithDoubleDash\n+                Arguments.of(\"43--103\", \"43 -- 103\"),\n \n-    @Test\n-    public void ignoreWhitespaceInPageNumbersWithDoubleDash() {\n-        assertEquals(\"43--103\", formatter.format(\"43 -- 103\"));\n-    }\n+                // keepCorrectlyFormattedPageNumbers\n+                Arguments.of(\"1--2\", \"1--2\"),\n \n-    @Test\n-    public void keepCorrectlyFormattedPageNumbers() {\n-        assertEquals(\"1--2\", formatter.format(\"1--2\"));\n-    }\n+                // formatPageNumbersRemoveUnexpectedLiterals\n+                Arguments.of(\"1--2\", \"{1}-{2}\"),\n \n-    @Test\n-    public void formatPageNumbersRemoveUnexpectedLiterals() {\n-        assertEquals(\"1--2\", formatter.format(\"{1}-{2}\"));\n-    }\n+                // formatPageNumbersRegexNotMatching\n+                Arguments.of(\"12\", \"12\"),\n \n-    @Test\n-    public void formatPageNumbersRegexNotMatching() {\n-        assertEquals(\"12\", formatter.format(\"12\"));\n-    }\n+                // doNotRemoveLetters\n+                Arguments.of(\"R1--R50\", \"R1-R50\"),\n \n-    @Test\n-    public void doNotRemoveLetters() {\n-        assertEquals(\"R1-R50\", formatter.format(\"R1-R50\"));\n-    }\n+                // replaceLongDashWithDoubleDash\n+                Arguments.of(\"1--50\", \"1 \\u2014 50\"),\n \n-    @Test\n-    public void replaceLongDashWithDoubleDash() {\n-        assertEquals(\"1--50\", formatter.format(\"1 \\u2014 50\"));\n-    }\n+                // removePagePrefix\n+                Arguments.of(\"50\", \"p.50\"),\n \n-    @Test\n-    public void removePagePrefix() {\n-        assertEquals(\"50\", formatter.format(\"p.50\"));\n-    }\n+                // removePagesPrefix\n+                Arguments.of(\"50\", \"pp.50\"),\n \n-    @Test\n-    public void removePagesPrefix() {\n-        assertEquals(\"50\", formatter.format(\"pp.50\"));\n-    }\n+                // keep &\n+                Arguments.of(\"40&50\", \"40&50\"),\n \n-    @Test\n-    public void formatACMPages() {\n-        // This appears in https://doi.org/10.1145/1658373.1658375\n-        assertEquals(\"2:1--2:33\", formatter.format(\"2:1-2:33\"));\n-    }\n+                // formatACMPages\n+                // This appears in https://doi.org/10.1145/1658373.1658375\n+                Arguments.of(\"2:1--2:33\", \"2:1-2:33\"),\n+\n+                // keepFormattedACMPages\n+                // This appears in https://doi.org/10.1145/1658373.1658375\n+                Arguments.of(\"2:1--2:33\", \"2:1--2:33\"),\n+\n+                // formatExample\n+                Arguments.of(\"1--2\", new NormalizePagesFormatter().getExampleInput()),\n \n-    @Test\n-    public void keepFormattedACMPages() {\n-        // This appears in https://doi.org/10.1145/1658373.1658375\n-        assertEquals(\"2:1--2:33\", formatter.format(\"2:1--2:33\"));\n+                // replaceDashWithMinus\n+                Arguments.of(\"R404--R405\", \"R404\u2013R405\"));\n     }\n \n-    @Test\n-    public void formatExample() {\n-        assertEquals(\"1--2\", formatter.format(formatter.getExampleInput()));\n+    @ParameterizedTest\n+    @MethodSource(\"tests\")\n+    public void test(String expected, String toFormat) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "361cb5dfd2a4dbdacf1315eb8a871a9c2d982fe5"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc2NzI2OQ==", "bodyText": "add \"balanced\" ?", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r549767269", "createdAt": "2020-12-29T16:28:00Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/logic/formatter/casechanger/UnprotectTermsFormatter.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package org.jabref.logic.formatter.casechanger;\n+\n+import java.util.Objects;\n+\n+import org.jabref.logic.cleanup.Formatter;\n+import org.jabref.logic.l10n.Localization;\n+\n+/**\n+ * Remove {} brackets around words\n+ *\n+ * Related formatter: {@link ProtectTermsFormatter}\n+ */\n+public class UnprotectTermsFormatter extends Formatter {\n+\n+    @Override\n+    public String format(String text) {\n+        // similar implementation at {@link org.jabref.logic.formatter.bibtexfields.RemoveBracesFormatter.hasNegativeBraceCount}\n+        Objects.requireNonNull(text);\n+        if (text.isEmpty()) {\n+            return text;\n+        }\n+        StringBuilder result = new StringBuilder();\n+        int level = 0;\n+        int index = 0;\n+        do {\n+            char charAtIndex = text.charAt(index);\n+            if (charAtIndex == '{') {\n+                level++;\n+            } else if (charAtIndex == '}') {\n+                level--;\n+            } else {\n+                result.append(charAtIndex);\n+            }\n+            index++;\n+        } while (index < text.length() && level >= 0);\n+        if (level != 0) {\n+            // in case of unbalanced braces, the original text is returned unmodified\n+            return text;\n+        }\n+        return result.toString();\n+    }\n+\n+    @Override\n+    public String getDescription() {\n+        return Localization.lang(\n+                \"Removes all {} brackets around words.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "361cb5dfd2a4dbdacf1315eb8a871a9c2d982fe5"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc2OTMxOA==", "bodyText": "I'm also not sure if I-X is correct or I--X for roman page numbers.", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r549769318", "createdAt": "2020-12-29T16:34:16Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/logic/formatter/bibtexfields/NormalizePagesFormatter.java", "diffHunk": "@@ -63,19 +65,9 @@ public String format(String value) {\n         // Remove pages prefix\n         String cleanValue = value.replace(\"pp.\", \"\").replace(\"p.\", \"\");\n         // remove unwanted literals including en dash, em dash, and whitespace\n-        cleanValue = cleanValue.replaceAll(\"\\u2013|\\u2014\", \"-\").replaceAll(REJECT_LITERALS, \"\");\n-        // try to find pages pattern\n-        Matcher matcher = PAGES_DETECT_PATTERN.matcher(cleanValue);\n-        if (matcher.matches()) {\n-            // replace\n-            if (Strings.isNullOrEmpty(matcher.group(\"endpage\"))) {\n-                return matcher.replaceFirst(SINGLE_PAGE_REPLACE_PATTERN);\n-            } else {\n-                return matcher.replaceFirst(PAGES_REPLACE_PATTERN);\n-            }\n-        }\n-        // no replacement\n-        return value;\n+        value = EM_EN_DASH_PATTERN.matcher(cleanValue).replaceAll(\"-\")\n+                                  .replaceAll(\"[ ]*[-]+[ ]*\", \"--\");\n+        return unprotectTermsFormatter.format(value.trim());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "361cb5dfd2a4dbdacf1315eb8a871a9c2d982fe5"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b7c1509183544d940e78b54cdf1840f631117b6", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/1b7c1509183544d940e78b54cdf1840f631117b6", "committedDate": "2020-12-29T19:03:31Z", "message": "Add new test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76329c0d73af2f98751801f31d8107c7bb9e3afb", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/76329c0d73af2f98751801f31d8107c7bb9e3afb", "committedDate": "2020-12-29T19:03:42Z", "message": "Adapt localization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37e4d0cfbcca4a942760d90859efa71fdc71e24b", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/37e4d0cfbcca4a942760d90859efa71fdc71e24b", "committedDate": "2020-12-29T19:03:57Z", "message": "Merge branch 'fixNormalizePagesFormatter' of github.com:JabRef/jabref into fixNormalizePagesFormatter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c536b38ca88109b60cb384581790e5213af1d3ec", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/c536b38ca88109b60cb384581790e5213af1d3ec", "committedDate": "2020-12-29T19:05:20Z", "message": "Remove obsolete translation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61567f84d2f6be158840317422ebb45bde0db20f", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/61567f84d2f6be158840317422ebb45bde0db20f", "committedDate": "2020-12-29T22:30:49Z", "message": "Handle more special cases (and also add examples to tests)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93d7028a4f2a51a44136c4d3adad971f4cfaef8f", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/93d7028a4f2a51a44136c4d3adad971f4cfaef8f", "committedDate": "2020-12-29T22:46:55Z", "message": "Add missing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05c01ed4232fe12cf52592f2b4b40268191e48f7", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/05c01ed4232fe12cf52592f2b4b40268191e48f7", "committedDate": "2021-01-04T16:30:40Z", "message": "Merge branch 'master' into fixNormalizePagesFormatter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMTY4MTIw", "url": "https://github.com/JabRef/jabref/pull/7243#pullrequestreview-561168120", "createdAt": "2021-01-04T16:34:31Z", "commit": {"oid": "05c01ed4232fe12cf52592f2b4b40268191e48f7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMTY5MzU0", "url": "https://github.com/JabRef/jabref/pull/7243#pullrequestreview-561169354", "createdAt": "2021-01-04T16:36:15Z", "commit": {"oid": "05c01ed4232fe12cf52592f2b4b40268191e48f7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4848, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}