{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxOTAxMTEz", "number": 6151, "title": "ActionHelper to test for present file", "bodyText": "This PR fixes koppor#430\nIt took a little bit more refactoring than expected, for it does not only check, if StandardField.FILE has text inside, but if the file is also really present in the file system. There are some design decisions i'm unsure of:\nThere is no alert about that no file is really present. The menu entry is just disabled, although there is a file symbol in the main table (since StandardField.FILE is not empty).\nFeedback could be implemented in the files editor in the entry editor as validation.\nThe other thing is that in theory at last, the table does not yet automatically update, if a file is added or removed (so no file is attached). This would require  probably an array of observables to be used as an invalidation alert. I'm unsure where to start with that. However, only in theory. Pracitcally the entry is unselected automatically if I change something about the attached files in the entry editor. So nobody would notice, if this would not be implemented.\n\n Change in CHANGELOG.md described (if applicable)\n Tests created for changes (if applicable)\n Manually tested changed features in running JabRef (always required)\n Screenshots added in PR description (for bigger UI changes)\n Checked documentation: Is the information available and up to date? If not: Issue created at https://github.com/JabRef/user-documentation/issues.", "createdAt": "2020-03-21T19:30:04Z", "url": "https://github.com/JabRef/jabref/pull/6151", "merged": true, "mergeCommit": {"oid": "07cb5b8921a41dd6436f32e305117377f109e829"}, "closed": true, "closedAt": "2020-04-17T16:06:30Z", "author": {"login": "calixtus"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcO6w49gH2gAyMzkxOTAxMTEzOmM2ZDA4MTJiN2JjM2Q0ZjgyNWRmYzcwMGQ0ZTdiNWJhZDdhYWYxYWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYjj6VAFqTM5NTU4NDI5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c6d0812b7bc3d4f825dfc700d4e7b5bad7aaf1af", "author": {"user": {"login": "calixtus", "name": "Carl Christian Snethlage"}}, "url": "https://github.com/JabRef/jabref/commit/c6d0812b7bc3d4f825dfc700d4e7b5bad7aaf1af", "committedDate": "2020-03-18T17:28:55Z", "message": "Added ActionHelper to test for present file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0ffa0d61c0eb8f547d21dcc0a9e7d9b7f24706b", "author": {"user": {"login": "calixtus", "name": "Carl Christian Snethlage"}}, "url": "https://github.com/JabRef/jabref/commit/b0ffa0d61c0eb8f547d21dcc0a9e7d9b7f24706b", "committedDate": "2020-03-24T12:01:53Z", "message": "Merge remote-tracking branch 'upstream/master' into fix_koppor_430"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d16ded3b7142f8c33d5fdc105c338602b9349928", "author": {"user": {"login": "calixtus", "name": "Carl Christian Snethlage"}}, "url": "https://github.com/JabRef/jabref/commit/d16ded3b7142f8c33d5fdc105c338602b9349928", "committedDate": "2020-03-24T16:31:58Z", "message": "Added Validation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMzE5NzA1", "url": "https://github.com/JabRef/jabref/pull/6151#pullrequestreview-383319705", "createdAt": "2020-03-28T14:57:11Z", "commit": {"oid": "d16ded3b7142f8c33d5fdc105c338602b9349928"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQxNDo1NzoxMVrOF9KABA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQxNTowNToyNVrOF9KDmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY3MTMwMA==", "bodyText": "I think the current code runs into similar problems that we had recently in a PR by @stefan-kolb: if the currently selected entry changes, then the binding is not updated.\nHere, this should be relatively easy to fix:\nEasyBind.flatMap(stateManager.getSelectedEntries().getValueAt(0), entry -> entry.getFiles())\n         .map(files -> to boolean)\n\nHere the getFiles methods needs to be changed to return an observable list. This can be done using the current code and a EasyBind.map(getFieldBinding(FILE), ... parse).", "url": "https://github.com/JabRef/jabref/pull/6151#discussion_r399671300", "createdAt": "2020-03-28T14:57:11Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/actions/ActionHelper.java", "diffHunk": "@@ -36,4 +40,18 @@ public static BooleanExpression isAnyFieldSetForSelectedEntry(List<Field> fields\n                 entry.getFieldsObservable(),\n                 stateManager.getSelectedEntries());\n     }\n+\n+    public static BooleanExpression isFilePresentForSelectedEntry(StateManager stateManager, PreferencesService preferencesService) {\n+        List<LinkedFile> files = stateManager.getSelectedEntries().get(0).getFiles();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d16ded3b7142f8c33d5fdc105c338602b9349928"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY3MTcwNA==", "bodyText": "The old code also opens websites, which leads to problems with this new code. I think a isLink check at the appropiate place suffices.", "url": "https://github.com/JabRef/jabref/pull/6151#discussion_r399671704", "createdAt": "2020-03-28T15:00:43Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/fieldeditors/LinkedFileViewModel.java", "diffHunk": "@@ -161,8 +176,18 @@ public void acceptAsLinked() {\n \n     public void open() {\n         try {\n+            Optional<Path> resolvedPath = FileHelper.expandFilename(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d16ded3b7142f8c33d5fdc105c338602b9349928"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY3MTg0MA==", "bodyText": "What happens if a website url is linked?", "url": "https://github.com/JabRef/jabref/pull/6151#discussion_r399671840", "createdAt": "2020-03-28T15:02:14Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/fieldeditors/LinkedFileViewModel.java", "diffHunk": "@@ -87,6 +94,14 @@ public LinkedFileViewModel(LinkedFile linkedFile,\n         this.externalFileTypes = externalFileTypes;\n         this.xmpPreferences = xmpPreferences;\n \n+        fileExistsValidator = new FunctionBasedValidator<>(\n+                linkedFile.linkProperty(),\n+                link -> {\n+                    Optional<Path> path = FileHelper.expandFilename(databaseContext, link, filePreferences);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d16ded3b7142f8c33d5fdc105c338602b9349928"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY3MjEzMA==", "bodyText": "I think adding a pseudo-class invalid instead of the style is more flexible in the long term (as it is a clearer separation between ui and ui-logic)", "url": "https://github.com/JabRef/jabref/pull/6151#discussion_r399672130", "createdAt": "2020-03-28T15:04:31Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/util/ViewModelListCellFactory.java", "diffHunk": "@@ -203,6 +215,9 @@ protected void updateItem(T item, boolean empty) {\n                         Subscription subscription = BindingsHelper.includePseudoClassWhen(this, pseudoClassWithCondition.getKey(), condition);\n                         subscriptions.add(subscription);\n                     }\n+                    if ((validationStatusProperty != null) && validationStatusProperty.call(viewModel).getHighestMessage().isPresent()) {\n+                        setStyle(\"-fx-background-color: -jr-warn\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d16ded3b7142f8c33d5fdc105c338602b9349928"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY3MjIxNg==", "bodyText": "The validation message should also be displayed if toTooltip is null, right?", "url": "https://github.com/JabRef/jabref/pull/6151#discussion_r399672216", "createdAt": "2020-03-28T15:05:25Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/util/ViewModelListCellFactory.java", "diffHunk": "@@ -178,7 +185,12 @@ protected void updateItem(T item, boolean empty) {\n                         getStyleClass().setAll(toStyleClass.call(viewModel));\n                     }\n                     if (toTooltip != null) {\n-                        setTooltip(toTooltip.call(viewModel));\n+                        Tooltip tooltip = toTooltip.call(viewModel);\n+                        if (validationStatusProperty != null) {\n+                            validationStatusProperty.call(viewModel).getHighestMessage().ifPresent(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d16ded3b7142f8c33d5fdc105c338602b9349928"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc21be743828d18408bf3e6c3f211e63d694ef5d", "author": {"user": {"login": "calixtus", "name": "Carl Christian Snethlage"}}, "url": "https://github.com/JabRef/jabref/commit/bc21be743828d18408bf3e6c3f211e63d694ef5d", "committedDate": "2020-03-28T16:28:25Z", "message": "Refactored Validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c2c4c723be3bbb6c330a59ff5b6026b29e36a8a", "author": {"user": {"login": "calixtus", "name": "Carl Christian Snethlage"}}, "url": "https://github.com/JabRef/jabref/commit/0c2c4c723be3bbb6c330a59ff5b6026b29e36a8a", "committedDate": "2020-03-28T21:52:45Z", "message": "Refactored unsuccessfully ActionHelper"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMzI4OTkz", "url": "https://github.com/JabRef/jabref/pull/6151#pullrequestreview-383328993", "createdAt": "2020-03-28T16:47:48Z", "commit": {"oid": "d16ded3b7142f8c33d5fdc105c338602b9349928"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQxNjo0Nzo0OFrOF9KuxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQyMToxMzoyOFrOF9MYCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY4MzI2OQ==", "bodyText": "If a website url is linked in StandardField.FILE, it simply displays an error dialog.\nBut I'm not entierly sure about the intended behaviour of this.\nCan there be an external file be linked in the file field or only in the StandardField.URL?\nIf you click on addFromUrl a dialog is opened asking for an url, if fetchFulltext is clicked, JabRef will try to find a PDF by DOI and other linked identifiers.", "url": "https://github.com/JabRef/jabref/pull/6151#discussion_r399683269", "createdAt": "2020-03-28T16:47:48Z", "author": {"login": "calixtus"}, "path": "src/main/java/org/jabref/gui/fieldeditors/LinkedFileViewModel.java", "diffHunk": "@@ -87,6 +94,14 @@ public LinkedFileViewModel(LinkedFile linkedFile,\n         this.externalFileTypes = externalFileTypes;\n         this.xmpPreferences = xmpPreferences;\n \n+        fileExistsValidator = new FunctionBasedValidator<>(\n+                linkedFile.linkProperty(),\n+                link -> {\n+                    Optional<Path> path = FileHelper.expandFilename(databaseContext, link, filePreferences);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY3MTg0MA=="}, "originalCommit": {"oid": "d16ded3b7142f8c33d5fdc105c338602b9349928"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcwOTg0OQ==", "bodyText": "I played a bit around with it. I was able to make getFiles return an ObservableList (by BindingsHelper::map, I had no luck with EasyBind), but EasyBind.flatMap does not exist, so i worked with map. But now the ActionHelper never works. I really don't know how to proceed, what am I doing wrong?", "url": "https://github.com/JabRef/jabref/pull/6151#discussion_r399709849", "createdAt": "2020-03-28T21:09:11Z", "author": {"login": "calixtus"}, "path": "src/main/java/org/jabref/gui/actions/ActionHelper.java", "diffHunk": "@@ -36,4 +40,18 @@ public static BooleanExpression isAnyFieldSetForSelectedEntry(List<Field> fields\n                 entry.getFieldsObservable(),\n                 stateManager.getSelectedEntries());\n     }\n+\n+    public static BooleanExpression isFilePresentForSelectedEntry(StateManager stateManager, PreferencesService preferencesService) {\n+        List<LinkedFile> files = stateManager.getSelectedEntries().get(0).getFiles();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY3MTMwMA=="}, "originalCommit": {"oid": "d16ded3b7142f8c33d5fdc105c338602b9349928"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcxMDIxOQ==", "bodyText": "see below", "url": "https://github.com/JabRef/jabref/pull/6151#discussion_r399710219", "createdAt": "2020-03-28T21:13:28Z", "author": {"login": "calixtus"}, "path": "src/main/java/org/jabref/gui/fieldeditors/LinkedFileViewModel.java", "diffHunk": "@@ -161,8 +176,18 @@ public void acceptAsLinked() {\n \n     public void open() {\n         try {\n+            Optional<Path> resolvedPath = FileHelper.expandFilename(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY3MTcwNA=="}, "originalCommit": {"oid": "d16ded3b7142f8c33d5fdc105c338602b9349928"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c4a6dd21bc043dd965cdceb7be95232fcbba5cd", "author": {"user": {"login": "calixtus", "name": "Carl Christian Snethlage"}}, "url": "https://github.com/JabRef/jabref/commit/4c4a6dd21bc043dd965cdceb7be95232fcbba5cd", "committedDate": "2020-04-06T06:37:12Z", "message": "Merge remote-tracking branch 'upstream/master' into fix_koppor_430"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "feb89987cf965952cfea3213672b3756b5548602", "author": {"user": {"login": "calixtus", "name": "Carl Christian Snethlage"}}, "url": "https://github.com/JabRef/jabref/commit/feb89987cf965952cfea3213672b3756b5548602", "committedDate": "2020-04-06T07:29:08Z", "message": "Fixed issues about opening an online link and applied some suggestions of IntelliJ"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ad24f675d0354c7379468c2364b9dce2408ee0c", "author": {"user": {"login": "calixtus", "name": "Carl Christian Snethlage"}}, "url": "https://github.com/JabRef/jabref/commit/0ad24f675d0354c7379468c2364b9dce2408ee0c", "committedDate": "2020-04-13T16:29:50Z", "message": "Fixed recalculation of selected entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cee5bee4b45e45d7dd03a91b5310286da3ca1a2f", "author": {"user": {"login": "calixtus", "name": "Carl Christian Snethlage"}}, "url": "https://github.com/JabRef/jabref/commit/cee5bee4b45e45d7dd03a91b5310286da3ca1a2f", "committedDate": "2020-04-13T16:32:53Z", "message": "Merge remote-tracking branch 'upstream/master' into fix_koppor_430"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45ae2e6dd35722517c7947e7bb3e4622daad1b92", "author": {"user": {"login": "calixtus", "name": "Carl Christian Snethlage"}}, "url": "https://github.com/JabRef/jabref/commit/45ae2e6dd35722517c7947e7bb3e4622daad1b92", "committedDate": "2020-04-14T12:03:32Z", "message": "Merge remote-tracking branch 'upstream/master' into fix_koppor_430\n\n# Conflicts:\n#\tsrc/main/java/org/jabref/model/entry/BibEntry.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTg0Mjkx", "url": "https://github.com/JabRef/jabref/pull/6151#pullrequestreview-395584291", "createdAt": "2020-04-17T16:06:10Z", "commit": {"oid": "45ae2e6dd35722517c7947e7bb3e4622daad1b92"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 432, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}