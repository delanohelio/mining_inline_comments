{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1NDczNzky", "number": 7026, "title": "Improve error handling on GROBID server connection issues", "bodyText": "Hi,\nThis PR relates to issues #6517 and #6891.\nIt's more improvement than an actual fix because the root cause is: the server is not available (which I can't fix).\nMotivation:\nWhen I read #6517 and #6891, I realized, that these were reported by 'power users',\nmeans people who e.g. understand how to activate debug logging.\nWhen I tried to reproduce the issues, I realized, that for the end-users the issue is not transparent.\nAdditionally, on my OSX, the Java 14 runtime has an infinite connect timeout set, so I never got a visual response on my action (refers to \"New entry from plain text\" button)\nWhat I changed:\n\nadd a property connectTimeout to URLDownloader\n\nthis avoids the situation, where e.g. on similar setups than mine (Java 14.0.2 on OSX), there's an infinite default connectTimeout and I never saw any error in UI nor log.\nset the default connectTimeout to 30 seconds. Which is e.g. the same order of magnitude as in many other tools and thus should have no side effects to other usages of this class\nset the connectTimeout for GROBID server to 5 seconds, because this should be sufficient as I expect this is a cloud-based service - please comment, if this assumption is wrong.\n\n\nrefactored the GrobidServce so that IOExceptions are percolating higher in the call-stack and then can be handled in the UI\nin case of error, I add a notification to the user, with an explicit message, so users have a chance to know, what's going on.. IMHO, that's more correct and easier to understand for users, over the current behavior, where just a message \"0 entries parsed\" occurs. (screenshot below in the comments)\nadded EN and DE translation for the new message.\n\nI hope, with this new behavior, users will better understand, why this feature does not work as expected.\n\n Change in CHANGELOG.md described (if applicable)\n Tests created for changes (if applicable)\n Manually tested changed features in running JabRef (always required)\n Screenshots added in PR description (for UI changes)\n Checked documentation: Is the information available and up to date? If not created an issue at https://github.com/JabRef/user-documentation/issues or, even better, submitted a pull request to the documentation repository.\n\nAny feedback welcome.", "createdAt": "2020-10-18T13:37:17Z", "url": "https://github.com/JabRef/jabref/pull/7026", "merged": true, "mergeCommit": {"oid": "4213a8d1e0a8832acb4c346fa0d16f5750b21986"}, "closed": true, "closedAt": "2020-10-18T16:47:53Z", "author": {"login": "nitram509"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTvPtzAH2gAyNTA1NDczNzkyOjA3ZjM5ZGU2Y2RhNmExMTIzZTY4MDY5NTdmOWMzM2ViNmU4NzQ0ODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTybe0AFqTUxMTE2MTQ3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "07f39de6cda6a1123e6806957f9c33eb6e874485", "author": {"user": {"login": "nitram509", "name": "Martin W. Kirst"}}, "url": "https://github.com/JabRef/jabref/commit/07f39de6cda6a1123e6806957f9c33eb6e874485", "committedDate": "2020-10-18T13:04:30Z", "message": "add explicit configuration for connectTimeout in URLDownload\nadd information on GROBID server connection issue for user\nrelates to #6517 and #6891"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07b6f5ac862a97bde032d919f0ab35025ce16dbd", "author": {"user": {"login": "nitram509", "name": "Martin W. Kirst"}}, "url": "https://github.com/JabRef/jabref/commit/07b6f5ac862a97bde032d919f0ab35025ce16dbd", "committedDate": "2020-10-18T13:41:34Z", "message": "add CHANGELOG entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9abce44e3218295ef4accd7574ec33286c77ef56", "author": {"user": {"login": "nitram509", "name": "Martin W. Kirst"}}, "url": "https://github.com/JabRef/jabref/commit/9abce44e3218295ef4accd7574ec33286c77ef56", "committedDate": "2020-10-18T13:56:23Z", "message": "fix style issues detected by checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMTQ4Mzc0", "url": "https://github.com/JabRef/jabref/pull/7026#pullrequestreview-511148374", "createdAt": "2020-10-18T14:09:37Z", "commit": {"oid": "9abce44e3218295ef4accd7574ec33286c77ef56"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOFQxNDowOTozN1rOHjq1YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOFQxNDoxNDoxNVrOHjq7MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzE2NDAwMQ==", "bodyText": "I think it's not so important for the user which exact url failed (especially since the popup disappears to quickly to type it in the url of a webbrower to check). So I suggest the following wording: \"Could not connect to JabRef server (Connection timed out).\"", "url": "https://github.com/JabRef/jabref/pull/7026#discussion_r507164001", "createdAt": "2020-10-18T14:09:37Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/bibtexextractor/BibtexExtractorViewModel.java", "diffHunk": "@@ -58,6 +64,16 @@ public StringProperty inputTextProperty() {\n     public void startParsing() {\n         BackgroundTask.wrap(() -> currentCitationfetcher.performSearch(inputTextProperty.getValue()))\n                       .onRunning(() -> dialogService.notify(Localization.lang(\"Your text is being parsed...\")))\n+                      .onFailure((e) -> {\n+                          if (e instanceof UncheckedIOException) {\n+                              String msg = Localization.lang(\"There are connection issues with the %0 server. Detailed information: %1.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9abce44e3218295ef4accd7574ec33286c77ef56"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzE2NDQ4NA==", "bodyText": "Please use ParserException instead of the uncheckedioex.", "url": "https://github.com/JabRef/jabref/pull/7026#discussion_r507164484", "createdAt": "2020-10-18T14:10:56Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/logic/importer/fetcher/GrobidCitationFetcher.java", "diffHunk": "@@ -39,8 +40,7 @@ public GrobidCitationFetcher(ImportFormatPreferences importFormatPreferences) {\n         try {\n             return Optional.of(grobidService.processCitation(plainText, GrobidService.ConsolidateCitations.WITH_METADATA));\n         } catch (IOException e) {\n-            LOGGER.debug(\"Could not process citation\", e);\n-            return Optional.empty();\n+            throw new UncheckedIOException(\"Could not process citation. \" + e.getMessage(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9abce44e3218295ef4accd7574ec33286c77ef56"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzE2NDg5Nw==", "bodyText": "what about connectionTimeout.toMillis()?", "url": "https://github.com/JabRef/jabref/pull/7026#discussion_r507164897", "createdAt": "2020-10-18T14:12:18Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/logic/net/URLDownload.java", "diffHunk": "@@ -316,6 +319,7 @@ private void copy(InputStream in, Writer out, Charset encoding) throws IOExcepti\n \n     private URLConnection openConnection() throws IOException {\n         URLConnection connection = this.source.openConnection();\n+        connection.setConnectTimeout((int) connectTimeout.getSeconds() * 1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9abce44e3218295ef4accd7574ec33286c77ef56"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzE2NTQ4OQ==", "bodyText": "Very good that you added a test as well. Small suggestion for improvement: use Assertions.assertThrows to ensure that the exception is indeed thrown.", "url": "https://github.com/JabRef/jabref/pull/7026#discussion_r507165489", "createdAt": "2020-10-18T14:14:15Z", "author": {"login": "tobiasdiez"}, "path": "src/test/java/org/jabref/logic/importer/fetcher/GrobidCitationFetcherTest.java", "diffHunk": "@@ -100,4 +107,17 @@ public void grobidPerformSearchWithInvalidDataTest(String invalidInput) {\n         assertEquals(Collections.emptyList(), entries);\n     }\n \n+    @Test\n+    public void performSearchThrowsExceptionInCaseOfConnectionIssues() throws IOException {\n+        GrobidService grobidServiceMock = mock(GrobidService.class);\n+        when(grobidServiceMock.processCitation(anyString(), any())).thenThrow(new IOException(\"Any IO Exception\"));\n+        grobidCitationFetcher = new GrobidCitationFetcher(importFormatPreferences, grobidServiceMock);\n+\n+        try {\n+            grobidCitationFetcher.performSearch(\"any text\");\n+            fail(\"performSearch should throw an UncheckedIOException, when there are underlying IOException.\");\n+        } catch (UncheckedIOException expected) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9abce44e3218295ef4accd7574ec33286c77ef56"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98712e7fa96f643fc78101f77f17fa09971cac1c", "author": {"user": {"login": "nitram509", "name": "Martin W. Kirst"}}, "url": "https://github.com/JabRef/jabref/commit/98712e7fa96f643fc78101f77f17fa09971cac1c", "committedDate": "2020-10-18T14:25:37Z", "message": "use .toMilliseconds() is more convenient\nuse assertThrow is more convenient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "add6e3e47b6464bf43e2fc3b492d8a4a1743d1de", "author": {"user": {"login": "nitram509", "name": "Martin W. Kirst"}}, "url": "https://github.com/JabRef/jabref/commit/add6e3e47b6464bf43e2fc3b492d8a4a1743d1de", "committedDate": "2020-10-18T15:53:56Z", "message": "incorporate feedback from review\nreduce detail level from user message\nrework to use FetcherException instead of UncheckedIOException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ae5b57dec6525d6a5a87f0a64ac0391a0e10154", "author": {"user": {"login": "nitram509", "name": "Martin W. Kirst"}}, "url": "https://github.com/JabRef/jabref/commit/7ae5b57dec6525d6a5a87f0a64ac0391a0e10154", "committedDate": "2020-10-18T15:58:10Z", "message": "switch to debug level in order to reduce verboseness in the log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMTYwNDMy", "url": "https://github.com/JabRef/jabref/pull/7026#pullrequestreview-511160432", "createdAt": "2020-10-18T16:34:40Z", "commit": {"oid": "7ae5b57dec6525d6a5a87f0a64ac0391a0e10154"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMTYxNDc3", "url": "https://github.com/JabRef/jabref/pull/7026#pullrequestreview-511161477", "createdAt": "2020-10-18T16:47:04Z", "commit": {"oid": "7ae5b57dec6525d6a5a87f0a64ac0391a0e10154"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 62, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}