{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1ODMwMTg1", "number": 7119, "title": "Improve library loading UX", "bodyText": "When JabRef opens a library, it opens a file, runs the database parser, and after everything is done, creates a new tab in the frame with the contents of the open database.\nAn improvement would be to first create a tab in the frame, display a loading animation, and after the parser has finished, display all entries (or display every entry as soon as it is parsed).\nthere is a bug that I couldn't fix, even after data is loaded the group pane will keep showing 0 entry, you need to navigate away from the tab and back to get the real number of entries\nabout applying the improvement on startup, I think having a splash screen will look better something like a blocking dialog that displays a ProgressIndicator\nCloses #6417\n\n\n\n\n\n Change in CHANGELOG.md described (if applicable)\n Tests created for changes (if applicable)\n Manually tested changed features in running JabRef (always required)\n Screenshots added in PR description (for UI changes)\n Checked documentation: Is the information available and up to date? If not created an issue at https://github.com/JabRef/user-documentation/issues or, even better, submitted a pull request to the documentation repository.", "createdAt": "2020-11-23T15:57:54Z", "url": "https://github.com/JabRef/jabref/pull/7119", "merged": true, "mergeCommit": {"oid": "33b931539a360a95e049944eda96d432258ff834"}, "closed": true, "closedAt": "2020-12-06T17:48:15Z", "author": {"login": "HoussemNasri"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfWlcjAH2gAyNTI1ODMwMTg1OjVlYzQwMjdmMjliMDBkOTlhMmExYWQ1OWUzMGMzYTNmYzkwYzA0OWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdjkq8CAFqTU0NTczMTgxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5ec4027f29b00d99a2a1ad59e30c3a3fc90c049f", "author": {"user": {"login": "HoussemNasri", "name": "Houssem Nasri"}}, "url": "https://github.com/JabRef/jabref/commit/5ec4027f29b00d99a2a1ad59e30c3a3fc90c049f", "committedDate": "2020-11-23T15:07:42Z", "message": "refactoring LibraryTab to be able to create an empty tab and feed it data when it's available"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1af860e4c6f4d346955fe8851a0957dbc87f8b9", "author": {"user": {"login": "HoussemNasri", "name": "Houssem Nasri"}}, "url": "https://github.com/JabRef/jabref/commit/e1af860e4c6f4d346955fe8851a0957dbc87f8b9", "committedDate": "2020-11-23T15:27:42Z", "message": "applying the improvement when opening database using action"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f2d7ea06c9e37d961dd10a9bb9414f4773486fa", "author": {"user": {"login": "HoussemNasri", "name": "Houssem Nasri"}}, "url": "https://github.com/JabRef/jabref/commit/5f2d7ea06c9e37d961dd10a9bb9414f4773486fa", "committedDate": "2020-11-23T16:39:23Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NzU0Mjgw", "url": "https://github.com/JabRef/jabref/pull/7119#pullrequestreview-536754280", "createdAt": "2020-11-23T18:48:35Z", "commit": {"oid": "5f2d7ea06c9e37d961dd10a9bb9414f4773486fa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxODo0ODozNlrOH4a3Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxODo0ODozNlrOH4a3Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkyMjQ2Mw==", "bodyText": "It would be cook if you could pass the exception as paramter to the error dialog as well, it's just one addtional paramter", "url": "https://github.com/JabRef/jabref/pull/7119#discussion_r528922463", "createdAt": "2020-11-23T18:48:36Z", "author": {"login": "Siedlerchr"}, "path": "src/main/java/org/jabref/gui/importer/actions/OpenDatabaseAction.java", "diffHunk": "@@ -210,4 +216,33 @@ private LibraryTab addNewDatabase(ParserResult result, final Path file, boolean\n         frame.addTab(libraryTab, raisePanel);\n         return libraryTab;\n     }\n+\n+    /* The layout to display in the tab when it's loading*/\n+    public Node createLoadingLayout() {\n+        ProgressIndicator progressIndicator = new ProgressIndicator(ProgressIndicator.INDETERMINATE_PROGRESS);\n+        BorderPane pane = new BorderPane();\n+        pane.setCenter(progressIndicator);\n+\n+        return pane;\n+    }\n+\n+    public void onDatabaseLoadingStarted(LibraryTab libraryTab, BackgroundTask<?> backgroundTask) {\n+        Node loadingLayout = createLoadingLayout();\n+        libraryTab.setContent(loadingLayout);\n+        libraryTab.setOnCloseRequest(e -> backgroundTask.cancel());\n+\n+        frame.addTab(libraryTab, true);\n+    }\n+\n+    public void onDatabaseLoadingSucceed(LibraryTab libraryTab, ParserResult result) {\n+        BibDatabaseContext context = result.getDatabaseContext();\n+        libraryTab.feedData(context);\n+\n+        OpenDatabaseAction.performPostOpenActions(libraryTab, result);\n+    }\n+\n+    public void onDatabaseLoadingFailed(LibraryTab libraryTab, Exception ex) {\n+        dialogService.showErrorDialogAndWait(Localization.lang(\"Connection error\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f2d7ea06c9e37d961dd10a9bb9414f4773486fa"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1ee47404496f82c2cfa194686e39ebf7f0bbd29", "author": {"user": {"login": "HoussemNasri", "name": "Houssem Nasri"}}, "url": "https://github.com/JabRef/jabref/commit/a1ee47404496f82c2cfa194686e39ebf7f0bbd29", "committedDate": "2020-11-23T19:28:46Z", "message": "add exception parameter to error dialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ca86161e986b2196902081a368fe9cb87cd7cd6", "author": {"user": {"login": "HoussemNasri", "name": "Houssem Nasri"}}, "url": "https://github.com/JabRef/jabref/commit/1ca86161e986b2196902081a368fe9cb87cd7cd6", "committedDate": "2020-11-24T10:30:59Z", "message": "Adding DataLoadingTask to LibraryTab"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c0fd835d9245420f92508f53face49d506fafeb", "author": {"user": {"login": "HoussemNasri", "name": "Houssem Nasri"}}, "url": "https://github.com/JabRef/jabref/commit/8c0fd835d9245420f92508f53face49d506fafeb", "committedDate": "2020-11-24T10:39:10Z", "message": "Add getter for dataLoadingTask"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f43c2ff9d3dd99384f8dff9b545853fafbc2333a", "author": {"user": {"login": "HoussemNasri", "name": "Houssem Nasri"}}, "url": "https://github.com/JabRef/jabref/commit/f43c2ff9d3dd99384f8dff9b545853fafbc2333a", "committedDate": "2020-11-24T10:48:25Z", "message": "Fixing memory leak by canceling dataLoadingTask when tab is closed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2ODI5NzA2", "url": "https://github.com/JabRef/jabref/pull/7119#pullrequestreview-536829706", "createdAt": "2020-11-23T20:42:20Z", "commit": {"oid": "a1ee47404496f82c2cfa194686e39ebf7f0bbd29"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMDo0MjoyMFrOH4elmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMDo0NzoyMlrOH4ev_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk4MzQ0OA==", "bodyText": "I would let the LibraryTab handle the progress indicator. This could be done for example by setting the placeholder to the progress indicator. https://docs.oracle.com/javase/8/javafx/api/javafx/scene/control/TableView.html#placeholderProperty", "url": "https://github.com/JabRef/jabref/pull/7119#discussion_r528983448", "createdAt": "2020-11-23T20:42:20Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/importer/actions/OpenDatabaseAction.java", "diffHunk": "@@ -210,4 +216,35 @@ private LibraryTab addNewDatabase(ParserResult result, final Path file, boolean\n         frame.addTab(libraryTab, raisePanel);\n         return libraryTab;\n     }\n+\n+    /* The layout to display in the tab when it's loading*/\n+    public Node createLoadingLayout() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1ee47404496f82c2cfa194686e39ebf7f0bbd29"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk4NDcxNg==", "bodyText": "I would put this before the feedData call. Some of the post actions change a lot of entries, which would result in unnecessary updates of the ui.", "url": "https://github.com/JabRef/jabref/pull/7119#discussion_r528984716", "createdAt": "2020-11-23T20:44:52Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/importer/actions/OpenDatabaseAction.java", "diffHunk": "@@ -210,4 +216,35 @@ private LibraryTab addNewDatabase(ParserResult result, final Path file, boolean\n         frame.addTab(libraryTab, raisePanel);\n         return libraryTab;\n     }\n+\n+    /* The layout to display in the tab when it's loading*/\n+    public Node createLoadingLayout() {\n+        ProgressIndicator progressIndicator = new ProgressIndicator(ProgressIndicator.INDETERMINATE_PROGRESS);\n+        BorderPane pane = new BorderPane();\n+        pane.setCenter(progressIndicator);\n+\n+        return pane;\n+    }\n+\n+    public void onDatabaseLoadingStarted(LibraryTab libraryTab, BackgroundTask<?> backgroundTask) {\n+        Node loadingLayout = createLoadingLayout();\n+        libraryTab.setContent(loadingLayout);\n+        libraryTab.setOnCloseRequest(e -> backgroundTask.cancel());\n+\n+        frame.addTab(libraryTab, true);\n+    }\n+\n+    public void onDatabaseLoadingSucceed(LibraryTab libraryTab, ParserResult result) {\n+        BibDatabaseContext context = result.getDatabaseContext();\n+        libraryTab.feedData(context);\n+\n+        OpenDatabaseAction.performPostOpenActions(libraryTab, result);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1ee47404496f82c2cfa194686e39ebf7f0bbd29"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk4NjExMA==", "bodyText": "I think this should be in the opendatabaseaction class (as it's not really connected to the library tab)", "url": "https://github.com/JabRef/jabref/pull/7119#discussion_r528986110", "createdAt": "2020-11-23T20:47:22Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/LibraryTab.java", "diffHunk": "@@ -140,15 +147,81 @@ public LibraryTab(JabRefFrame frame,\n         });\n     }\n \n+    public static LibraryTab createNewEmptyLibraryTab(JabRefFrame frame, Path file) {\n+        BibDatabaseContext context = new BibDatabaseContext();\n+        context.setDatabasePath(file);\n+\n+        return new LibraryTab(frame, frame.prefs(), context, ExternalFileTypes.getInstance());\n+    }\n+\n+    public void feedData(BibDatabaseContext bibDatabaseContext) {\n+        cleanUp();\n+\n+        this.bibDatabaseContext = Objects.requireNonNull(bibDatabaseContext);\n+\n+        bibDatabaseContext.getDatabase().registerListener(this);\n+        bibDatabaseContext.getMetaData().registerListener(this);\n+\n+        this.tableModel = new MainTableDataModel(getBibDatabaseContext(), preferencesService, Globals.stateManager);\n+        citationStyleCache = new CitationStyleCache(bibDatabaseContext);\n+        annotationCache = new FileAnnotationCache(bibDatabaseContext, preferencesService.getFilePreferences());\n+\n+        setupMainPanel();\n+        setupAutoCompletion();\n+\n+        this.getDatabase().registerListener(new SearchListener());\n+        this.getDatabase().registerListener(new EntriesRemovedListener());\n+\n+        // ensure that at each addition of a new entry, the entry is added to the groups interface\n+        this.bibDatabaseContext.getDatabase().registerListener(new GroupTreeListener());\n+        // ensure that all entry changes mark the panel as changed\n+        this.bibDatabaseContext.getDatabase().registerListener(this);\n+\n+        this.getDatabase().registerListener(new UpdateTimestampListener(preferencesService));\n+\n+        this.entryEditor = new EntryEditor(this, externalFileTypes);\n+\n+        Platform.runLater(() -> {\n+            EasyBind.subscribe(changedProperty, this::updateTabTitle);\n+            Globals.stateManager.getOpenDatabases().addListener((ListChangeListener<BibDatabaseContext>) c ->\n+                    updateTabTitle(changedProperty.getValue()));\n+        });\n+\n+        if (isDatabaseReadyForAutoSave(bibDatabaseContext)) {\n+            AutosaveManager autoSaver = AutosaveManager.start(bibDatabaseContext);\n+            autoSaver.registerListener(new AutosaveUiManager(this));\n+        }\n+\n+        BackupManager.start(this.bibDatabaseContext, Globals.entryTypesManager, Globals.prefs);\n+\n+        trackOpenNewDatabase(this);\n+\n+    }\n+\n+    private boolean isDatabaseReadyForAutoSave(BibDatabaseContext context) {\n+        return ((context.getLocation() == DatabaseLocation.SHARED) ||\n+                ((context.getLocation() == DatabaseLocation.LOCAL) && Globals.prefs.getBoolean(JabRefPreferences.LOCAL_AUTO_SAVE)))\n+                &&\n+                context.getDatabasePath().isPresent();\n+    }\n+\n+    private void trackOpenNewDatabase(LibraryTab libraryTab) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1ee47404496f82c2cfa194686e39ebf7f0bbd29"}, "originalPosition": 132}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef088af6ca35eb4ac3707ffebecffd45fbca86ea", "author": {"user": {"login": "HoussemNasri", "name": "Houssem Nasri"}}, "url": "https://github.com/JabRef/jabref/commit/ef088af6ca35eb4ac3707ffebecffd45fbca86ea", "committedDate": "2020-11-24T13:41:21Z", "message": "Relocate LibraryTab method trackOpenNewDatabase() to OpenDatabaseAction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77061c80a8e9c7e6dce2f028e425e899987e41b6", "author": {"user": {"login": "HoussemNasri", "name": "Houssem Nasri"}}, "url": "https://github.com/JabRef/jabref/commit/77061c80a8e9c7e6dce2f028e425e899987e41b6", "committedDate": "2020-11-24T13:41:22Z", "message": "Refactor LibraryTab to handle dataLoadingTask callbacks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7ca2d379021300818bb1ee5a50532f3f2d36203", "author": {"user": {"login": "HoussemNasri", "name": "Houssem Nasri"}}, "url": "https://github.com/JabRef/jabref/commit/b7ca2d379021300818bb1ee5a50532f3f2d36203", "committedDate": "2020-11-24T18:00:53Z", "message": "Put performPostOpenActions() before feedData() for performance reasons"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e71e7a3c5297cbe34844e21d7b016b958c5702b", "author": {"user": {"login": "HoussemNasri", "name": "Houssem Nasri"}}, "url": "https://github.com/JabRef/jabref/commit/2e71e7a3c5297cbe34844e21d7b016b958c5702b", "committedDate": "2020-11-24T22:46:30Z", "message": "Fix groups pane not updating bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5ODAzODU4", "url": "https://github.com/JabRef/jabref/pull/7119#pullrequestreview-539803858", "createdAt": "2020-11-27T08:56:16Z", "commit": {"oid": "2e71e7a3c5297cbe34844e21d7b016b958c5702b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwODo1NjoxNlrOH615SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwODo1NjoxNlrOH615SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ2MjQ3Mg==", "bodyText": "This condition/if is uncessary as you either return null or the dataLoadingTask.", "url": "https://github.com/JabRef/jabref/pull/7119#discussion_r531462472", "createdAt": "2020-11-27T08:56:16Z", "author": {"login": "Siedlerchr"}, "path": "src/main/java/org/jabref/gui/LibraryTab.java", "diffHunk": "@@ -140,15 +152,107 @@ public LibraryTab(JabRefFrame frame,\n         });\n     }\n \n+    public void setDataLoadingTask(BackgroundTask<ParserResult> dataLoadingTask) {\n+        this.dataLoadingTask = dataLoadingTask;\n+    }\n+\n+    public BackgroundTask<?> getDataLoadingTask() {\n+        if (dataLoadingTask == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e71e7a3c5297cbe34844e21d7b016b958c5702b"}, "originalPosition": 92}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5ODA1MDIy", "url": "https://github.com/JabRef/jabref/pull/7119#pullrequestreview-539805022", "createdAt": "2020-11-27T08:57:56Z", "commit": {"oid": "2e71e7a3c5297cbe34844e21d7b016b958c5702b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5783b3078297d39019f7149496bb1b3dfe5d4a54", "author": {"user": {"login": "HoussemNasri", "name": "Houssem Nasri"}}, "url": "https://github.com/JabRef/jabref/commit/5783b3078297d39019f7149496bb1b3dfe5d4a54", "committedDate": "2020-11-27T22:07:34Z", "message": "Cleanup code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTg4NTQw", "url": "https://github.com/JabRef/jabref/pull/7119#pullrequestreview-541188540", "createdAt": "2020-11-30T18:39:26Z", "commit": {"oid": "5783b3078297d39019f7149496bb1b3dfe5d4a54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MDU4OTU0", "url": "https://github.com/JabRef/jabref/pull/7119#pullrequestreview-544058954", "createdAt": "2020-12-03T15:16:39Z", "commit": {"oid": "5783b3078297d39019f7149496bb1b3dfe5d4a54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be3c2bff257fe4eedcc80c68e78c677e4ca841ff", "author": {"user": {"login": "calixtus", "name": "Carl Christian Snethlage"}}, "url": "https://github.com/JabRef/jabref/commit/be3c2bff257fe4eedcc80c68e78c677e4ca841ff", "committedDate": "2020-12-05T18:41:52Z", "message": "Merge branch 'master' into improve-database-loading-ux"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c3149ce7ee0996c77aa7fbc7be1334d8dbf323a", "author": {"user": {"login": "calixtus", "name": "Carl Christian Snethlage"}}, "url": "https://github.com/JabRef/jabref/commit/6c3149ce7ee0996c77aa7fbc7be1334d8dbf323a", "committedDate": "2020-12-05T19:24:36Z", "message": "Extracted JabRefPreferences, fixed imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b32c0953afc19d22abed054e4ac7d03d7d63b7d", "author": {"user": {"login": "calixtus", "name": "Carl Christian Snethlage"}}, "url": "https://github.com/JabRef/jabref/commit/8b32c0953afc19d22abed054e4ac7d03d7d63b7d", "committedDate": "2020-12-05T19:33:01Z", "message": "Extracted JabRefPreferences, fixed imports, removed dead code, shortened method name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NzMxODE0", "url": "https://github.com/JabRef/jabref/pull/7119#pullrequestreview-545731814", "createdAt": "2020-12-06T17:48:04Z", "commit": {"oid": "8b32c0953afc19d22abed054e4ac7d03d7d63b7d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4856, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}