{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2NTkwNzgx", "number": 6469, "title": "Fix bracket collisions", "bodyText": "Brackets in regular expressions were interpreted as brackets for fields. This change allows users to define regular expressions that contain brackets. This led to an exception before.\n\n\n Change in CHANGELOG.md described (if applicable)\n Tests created for changes (if applicable)\n Manually tested changed features in running JabRef (always required)\n Screenshots added in PR description (for UI changes)\n Checked documentation: Is the information available and up to date? If not created an issue at https://github.com/JabRef/user-documentation/issues or, even better, submitted a pull request to the documentation repository.", "createdAt": "2020-05-12T09:07:53Z", "url": "https://github.com/JabRef/jabref/pull/6469", "merged": true, "mergeCommit": {"oid": "ce49261950dfedc1ecb5ef7d5691357105469430"}, "closed": true, "closedAt": "2020-05-12T12:28:08Z", "author": {"login": "btut"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcggiHWgH2gAyNDE2NTkwNzgxOjY1ZDA1ZWQ0ZDJmMzEwOTJkMTAzNGFhNzI1OTkyZjAwNGNhM2M2NTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgjbFPgFqTQwOTk4ODU2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "65d05ed4d2f31092d1034aa725992f004ca3c658", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/65d05ed4d2f31092d1034aa725992f004ca3c658", "committedDate": "2020-05-12T09:05:53Z", "message": "Fixed brackets in regular expressions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d4c7ce7cd525bea20a0cfd148fad87d9a7586e1", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/0d4c7ce7cd525bea20a0cfd148fad87d9a7586e1", "committedDate": "2020-05-12T09:06:22Z", "message": "Added a test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5861685e11ba8e1539c35e6c40be9ed6ecf80fc7", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/5861685e11ba8e1539c35e6c40be9ed6ecf80fc7", "committedDate": "2020-05-12T09:08:19Z", "message": "Changelog update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5OTM2NTMz", "url": "https://github.com/JabRef/jabref/pull/6469#pullrequestreview-409936533", "createdAt": "2020-05-12T11:11:52Z", "commit": {"oid": "5861685e11ba8e1539c35e6c40be9ed6ecf80fc7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMToxMTo1MlrOGUBp7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMToxMTo1MlrOGUBp7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY1MTgyMw==", "bodyText": "Question: you fetch the next token above in line 131, and then here the subtoken. So this moves the stream forward twice, right? What happens if the user adds an empty brace, i.e []. Is the closing bracket still found? Can you please add a test for this case as well. Thanks!", "url": "https://github.com/JabRef/jabref/pull/6469#discussion_r423651823", "createdAt": "2020-05-12T11:11:52Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/logic/bibtexkeypattern/BracketedPattern.java", "diffHunk": "@@ -106,40 +106,68 @@ public static String expandBrackets(String pattern, Character keywordDelimiter,\n         Objects.requireNonNull(pattern);\n         Objects.requireNonNull(entry);\n         StringBuilder sb = new StringBuilder();\n-        StringTokenizer st = new StringTokenizer(pattern, \"\\\\[]\", true);\n+        StringTokenizer st = new StringTokenizer(pattern, \"\\\\[]\\\"\", true);\n \n         while (st.hasMoreTokens()) {\n             String token = st.nextToken();\n-            if (\"\\\\\".equals(token)) {\n-                if (st.hasMoreTokens()) {\n-                    sb.append(st.nextToken());\n-                }\n-                // FIXME: else -> raise exception or log? (S.G.)\n-            } else {\n-                if (\"[\".equals(token)) {\n-                    // Fetch the next token after the '[':\n+            if (\"\\\"\".equals(token)) {\n+                sb.append(token);\n+                while (st.hasMoreTokens()) {\n                     token = st.nextToken();\n-                    List<String> fieldParts = parseFieldMarker(token);\n-                    // check whether there is a modifier on the end such as\n-                    // \":lower\":\n-                    if (fieldParts.size() <= 1) {\n-                        sb.append(getFieldValue(entry, token, keywordDelimiter, database));\n-                    } else {\n-                        // apply modifiers:\n-                        String fieldValue = getFieldValue(entry, fieldParts.get(0), keywordDelimiter, database);\n-                        sb.append(applyModifiers(fieldValue, fieldParts, 1));\n+                    sb.append(token);\n+                    if (\"\\\"\".equals(token)) {\n+                        break;\n                     }\n-                    // Fetch and discard the closing ']'\n+                }\n+            } else {\n+                if (\"\\\\\".equals(token)) {\n                     if (st.hasMoreTokens()) {\n+                        sb.append(st.nextToken());\n+                    }\n+                    // FIXME: else -> raise exception or log? (S.G.)\n+                } else {\n+                    if (\"[\".equals(token)) {\n+                        // Fetch the next token after the '[':\n                         token = st.nextToken();\n+                        Boolean foundClosingBracket = false;\n+                        // make sure to read until the next ']'\n+                        while (st.hasMoreTokens()) {\n+                            String subtoken = st.nextToken();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5861685e11ba8e1539c35e6c40be9ed6ecf80fc7"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "230fef2a16cd09ec3bd50647b7499ae943608e80", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/230fef2a16cd09ec3bd50647b7499ae943608e80", "committedDate": "2020-05-12T11:43:04Z", "message": "Consider empty brackets"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5OTg2NDI2", "url": "https://github.com/JabRef/jabref/pull/6469#pullrequestreview-409986426", "createdAt": "2020-05-12T12:25:04Z", "commit": {"oid": "230fef2a16cd09ec3bd50647b7499ae943608e80"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5OTg4NTY2", "url": "https://github.com/JabRef/jabref/pull/6469#pullrequestreview-409988566", "createdAt": "2020-05-12T12:27:55Z", "commit": {"oid": "230fef2a16cd09ec3bd50647b7499ae943608e80"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 263, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}