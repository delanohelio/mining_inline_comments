{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1NTY4NDU1", "number": 7073, "title": "Fixes exception in preview using regexp search and regexp search without specified field", "bodyText": "Fixes #6777 . The issue originates in how the JavaScript regexp is created in PreviewViewer#highlightSearchPattern.\n\nFixes the use of regexp while searching for one term (e.g., Liu.*)\nFixes exception in the preview when forward slash is used in the regexp\n\n\n\n Change in CHANGELOG.md described (if applicable)\n Tests created for changes (if applicable)\n Manually tested changed features in running JabRef (always required)\n Screenshots added in PR description (for UI changes)\n Checked documentation: Is the information available and up to date? If not created an issue at https://github.com/JabRef/user-documentation/issues or, even better, submitted a pull request to the documentation repository.", "createdAt": "2020-11-04T18:34:58Z", "url": "https://github.com/JabRef/jabref/pull/7073", "merged": true, "mergeCommit": {"oid": "6f35c3682b73ecb44ce9263b11946644f3908551"}, "closed": true, "closedAt": "2020-11-21T17:42:33Z", "author": {"login": "k3KAW8Pnf7mkmdSMPHz27"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZSGFqgH2gAyNTE1NTY4NDU1OmI3ZTc1NTIxMWM0ODk4ZjdlNmRlMmI4ZmIyODI0Y2IzODEwNmVjYmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdevlmLAFqTUzNTk4MjY1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b7e755211c4898f7e6de2b8fb2824cb38106ecbe", "author": {"user": {"login": "k3KAW8Pnf7mkmdSMPHz27", "name": "Jonatan Asketorp"}}, "url": "https://github.com/JabRef/jabref/commit/b7e755211c4898f7e6de2b8fb2824cb38106ecbe", "committedDate": "2020-11-04T18:30:17Z", "message": "Fix JavaScript regexp creation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b32d381899dfb096735ece25bf933cc2fa7c82e2", "author": {"user": {"login": "k3KAW8Pnf7mkmdSMPHz27", "name": "Jonatan Asketorp"}}, "url": "https://github.com/JabRef/jabref/commit/b32d381899dfb096735ece25bf933cc2fa7c82e2", "committedDate": "2020-11-06T20:44:27Z", "message": "Fix GrammarBasedSearchRule with regexp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "128b41fd3d19986be66dc4772293df712f10ef08", "author": {"user": {"login": "k3KAW8Pnf7mkmdSMPHz27", "name": "Jonatan Asketorp"}}, "url": "https://github.com/JabRef/jabref/commit/128b41fd3d19986be66dc4772293df712f10ef08", "committedDate": "2020-11-06T21:05:02Z", "message": "Fix JavaScript regex creation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4429ea1ae9f9ed6059a88e4362cb2e9ee96f9fea", "author": {"user": {"login": "k3KAW8Pnf7mkmdSMPHz27", "name": "Jonatan Asketorp"}}, "url": "https://github.com/JabRef/jabref/commit/4429ea1ae9f9ed6059a88e4362cb2e9ee96f9fea", "committedDate": "2020-11-06T21:18:12Z", "message": "Readability improvement?"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7abe68296b2ab88dcd9d8702c495ac936ea10835", "author": {"user": {"login": "k3KAW8Pnf7mkmdSMPHz27", "name": "Jonatan Asketorp"}}, "url": "https://github.com/JabRef/jabref/commit/7abe68296b2ab88dcd9d8702c495ac936ea10835", "committedDate": "2020-11-06T21:31:56Z", "message": "Add missed negation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "979fa6e40b55e5c2d01bb55a8f13d71b7e85b9da", "author": {"user": {"login": "k3KAW8Pnf7mkmdSMPHz27", "name": "Jonatan Asketorp"}}, "url": "https://github.com/JabRef/jabref/commit/979fa6e40b55e5c2d01bb55a8f13d71b7e85b9da", "committedDate": "2020-11-06T21:45:37Z", "message": "Fix JavaScript regex pattern"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NTIyNzIz", "url": "https://github.com/JabRef/jabref/pull/7073#pullrequestreview-525522723", "createdAt": "2020-11-06T22:02:23Z", "commit": {"oid": "979fa6e40b55e5c2d01bb55a8f13d71b7e85b9da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMjowMjoyNFrOHu-8Dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMjowMjoyNFrOHu-8Dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTAyNzcyNg==", "bodyText": "Since / terminates the JavaScript regexp, it should be escaped. The issue with using new RegExp is that you will have to escape the string terminator instead, so it is more code without any benefit that I am aware of.", "url": "https://github.com/JabRef/jabref/pull/7073#discussion_r519027726", "createdAt": "2020-11-06T22:02:24Z", "author": {"login": "k3KAW8Pnf7mkmdSMPHz27"}, "path": "src/main/java/org/jabref/gui/preview/PreviewViewer.java", "diffHunk": "@@ -144,7 +144,7 @@ private void highlightSearchPattern() {\n                     \"var markInstance = new Mark(document.getElementById(\\\"content\\\"));\" +\n                             \"markInstance.unmark({\" +\n                             \"  done: function(){\" +\n-                            \"    markInstance.markRegExp(/\" + pattern + \"/gmi);\" +\n+                            \"    markInstance.markRegExp(/\" + pattern.replaceAll(\"/\", \"\\\\\\\\/\") + \"/gmi);\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979fa6e40b55e5c2d01bb55a8f13d71b7e85b9da"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NTIzMjUw", "url": "https://github.com/JabRef/jabref/pull/7073#pullrequestreview-525523250", "createdAt": "2020-11-06T22:03:37Z", "commit": {"oid": "979fa6e40b55e5c2d01bb55a8f13d71b7e85b9da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMjowMzozOFrOHu-9jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMjowMzozOFrOHu-9jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTAyODExMQ==", "bodyText": "@Siedlerchr perhaps the if solution is better here? This might be too frivolous application of the DRY principle.", "url": "https://github.com/JabRef/jabref/pull/7073#discussion_r519028111", "createdAt": "2020-11-06T22:03:38Z", "author": {"login": "k3KAW8Pnf7mkmdSMPHz27"}, "path": "src/main/java/org/jabref/model/search/rules/GrammarBasedSearchRule.java", "diffHunk": "@@ -232,7 +232,7 @@ public Boolean visitComparison(SearchParser.ComparisonContext context) {\n             if (fieldDescriptor.isPresent()) {\n                 return comparison(fieldDescriptor.get().getText(), ComparisonOperator.build(context.operator.getText()), right);\n             } else {\n-                return new ContainBasedSearchRule(caseSensitive).applyRule(right, entry);\n+                return SearchRules.getSearchRule(caseSensitive, regex).applyRule(right, entry);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979fa6e40b55e5c2d01bb55a8f13d71b7e85b9da"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b77fcaafa0216fef42212be775c99b603d860856", "author": {"user": {"login": "k3KAW8Pnf7mkmdSMPHz27", "name": "Jonatan Asketorp"}}, "url": "https://github.com/JabRef/jabref/commit/b77fcaafa0216fef42212be775c99b603d860856", "committedDate": "2020-11-08T21:54:01Z", "message": "Fix only replacing unescaped forward slashes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1ODUwMTQ3", "url": "https://github.com/JabRef/jabref/pull/7073#pullrequestreview-525850147", "createdAt": "2020-11-08T22:10:10Z", "commit": {"oid": "b77fcaafa0216fef42212be775c99b603d860856"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2OTM3ODIz", "url": "https://github.com/JabRef/jabref/pull/7073#pullrequestreview-526937823", "createdAt": "2020-11-10T07:58:02Z", "commit": {"oid": "b77fcaafa0216fef42212be775c99b603d860856"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwNzo1ODowMlrOHwQG3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwNzo1ODowMlrOHwQG3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM1NzU5OA==", "bodyText": "Would it be possible to extract this as constant (and thus documenting why this replacement is done)?", "url": "https://github.com/JabRef/jabref/pull/7073#discussion_r520357598", "createdAt": "2020-11-10T07:58:02Z", "author": {"login": "koppor"}, "path": "src/main/java/org/jabref/gui/preview/PreviewViewer.java", "diffHunk": "@@ -144,7 +144,7 @@ private void highlightSearchPattern() {\n                     \"var markInstance = new Mark(document.getElementById(\\\"content\\\"));\" +\n                             \"markInstance.unmark({\" +\n                             \"  done: function(){\" +\n-                            \"    markInstance.markRegExp(/\" + pattern + \"/gmi);\" +\n+                            \"    markInstance.markRegExp(/\" + pattern.replaceAll(\"(?<!\\\\\\\\)/\", \"\\\\\\\\/\") + \"/gmi);\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b77fcaafa0216fef42212be775c99b603d860856"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07bd8cc3e534be23c22d336ad8aa85f3a767762b", "author": {"user": {"login": "k3KAW8Pnf7mkmdSMPHz27", "name": "Jonatan Asketorp"}}, "url": "https://github.com/JabRef/jabref/commit/07bd8cc3e534be23c22d336ad8aa85f3a767762b", "committedDate": "2020-11-10T16:20:14Z", "message": "Extract String constants"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MzgwOTc4", "url": "https://github.com/JabRef/jabref/pull/7073#pullrequestreview-527380978", "createdAt": "2020-11-10T16:26:41Z", "commit": {"oid": "07bd8cc3e534be23c22d336ad8aa85f3a767762b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjoyNjo0MVrOHwkzVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjoyNjo0MVrOHwkzVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY5NjY2MA==", "bodyText": "@koppor\n\nWould it be possible to extract this as constant (and thus documenting why this replacement is done)?\n\nI noticed that I misunderstood you. I have extracted the String constants (as well) and hopefully improved readability. I don't think I should be more explicit regarding the forward slash replacement, unless I also link to how to use a JavaScript regex literal (https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions). Perhaps I should add this link?", "url": "https://github.com/JabRef/jabref/pull/7073#discussion_r520696660", "createdAt": "2020-11-10T16:26:41Z", "author": {"login": "k3KAW8Pnf7mkmdSMPHz27"}, "path": "src/main/java/org/jabref/gui/preview/PreviewViewer.java", "diffHunk": "@@ -137,23 +145,26 @@ public void setTheme(Theme theme) {\n     }\n \n     private void highlightSearchPattern() {\n+        String callbackForUnmark = \"\";\n         if (searchHighlightPattern.isPresent()) {\n-            String pattern = searchHighlightPattern.get().pattern();\n-\n-            previewView.getEngine().executeScript(\n-                    \"var markInstance = new Mark(document.getElementById(\\\"content\\\"));\" +\n-                            \"markInstance.unmark({\" +\n-                            \"  done: function(){\" +\n-                            \"    markInstance.markRegExp(/\" + pattern.replaceAll(\"(?<!\\\\\\\\)/\", \"\\\\\\\\/\") + \"/gmi);\" +\n-                            \"    }\" +\n-                            \"  });\"\n-            );\n-        } else {\n-            previewView.getEngine().executeScript(\n-                    \"var markInstance = new Mark(document.getElementById(\\\"content\\\"));\" +\n-                            \"markInstance.unmark()\"\n-            );\n+            String javaScriptRegex = createJavaScriptRegex(searchHighlightPattern.get());\n+            callbackForUnmark = String.format(JS_MARK_REG_EXP_CALLBACK, javaScriptRegex);\n         }\n+        String unmarkInstance = String.format(JS_UNMARK_WITH_CALLBACK, callbackForUnmark);\n+        previewView.getEngine().executeScript(unmarkInstance);\n+    }\n+\n+    /**\n+     * Returns the String representation of a JavaScript regex object. The method does not take into account differences between the regex implementations in Java and JavaScript.\n+     *\n+     * @param regex Java regex to print as a JavaScript regex\n+     * @return JavaScript regex object\n+     */\n+    private static String createJavaScriptRegex(Pattern regex) {\n+        String pattern = regex.pattern();\n+        // Create a JavaScript regex using the forward slash pattern\n+        pattern = UNESCAPED_FORWARD_SLASH.matcher(pattern).replaceAll(\"\\\\\\\\/\");\n+        return \"/\" + pattern + \"/gmi\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bd8cc3e534be23c22d336ad8aa85f3a767762b"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e33328d23e5c53ba6c2d0be97953192f836be5e8", "author": {"user": {"login": "k3KAW8Pnf7mkmdSMPHz27", "name": "Jonatan Asketorp"}}, "url": "https://github.com/JabRef/jabref/commit/e33328d23e5c53ba6c2d0be97953192f836be5e8", "committedDate": "2020-11-10T19:02:24Z", "message": "Fix codestyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba1964bfc73eb186adbac3ae53eeff09d37a32f7", "author": {"user": {"login": "k3KAW8Pnf7mkmdSMPHz27", "name": "Jonatan Asketorp"}}, "url": "https://github.com/JabRef/jabref/commit/ba1964bfc73eb186adbac3ae53eeff09d37a32f7", "committedDate": "2020-11-10T23:31:42Z", "message": "Remove unused local variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "474c26c8c7da6c93a3635a45d3734122acce7084", "author": {"user": {"login": "k3KAW8Pnf7mkmdSMPHz27", "name": "Jonatan Asketorp"}}, "url": "https://github.com/JabRef/jabref/commit/474c26c8c7da6c93a3635a45d3734122acce7084", "committedDate": "2020-11-10T23:44:15Z", "message": "Add comments to the regular expression literal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9abbed2e953261edbc2307f736d6b5b17ab0931e", "author": {"user": {"login": "k3KAW8Pnf7mkmdSMPHz27", "name": "Jonatan Asketorp"}}, "url": "https://github.com/JabRef/jabref/commit/9abbed2e953261edbc2307f736d6b5b17ab0931e", "committedDate": "2020-11-13T13:01:57Z", "message": "Add test for GrammarBasedSearchRule"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1OTgyNjU4", "url": "https://github.com/JabRef/jabref/pull/7073#pullrequestreview-535982658", "createdAt": "2020-11-21T17:41:34Z", "commit": {"oid": "9abbed2e953261edbc2307f736d6b5b17ab0931e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4954, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}