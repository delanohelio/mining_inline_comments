{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4MDQwMzYx", "number": 6116, "title": "Fix: Only if `.sav` file has changes a recovery dialog is shown", "bodyText": "When JabRef is forced-closed and restarted, it should not nag about a .sav file.\nThe issue described at #6109 seems to be a larger one. We will that investigate later.", "createdAt": "2020-03-13T22:43:40Z", "url": "https://github.com/JabRef/jabref/pull/6116", "merged": true, "mergeCommit": {"oid": "a38d7bd22059d3b6ebe2d50707c275dd75f7e2bc"}, "closed": true, "closedAt": "2020-03-22T09:27:08Z", "author": {"login": "koppor"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNYReBAH2gAyMzg4MDQwMzYxOjczYjdjYjljM2FjNzMwN2VhNWE1MDY0ZTgzMTA0MTgzYzNjNjllNDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOh3O0gFqTM3NTk4Njg5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "73b7cb9c3ac7307ea5a5064e83104183c3c69e46", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/73b7cb9c3ac7307ea5a5064e83104183c3c69e46", "committedDate": "2020-03-13T22:43:54Z", "message": "When JabRef finds a `.sav` file without changes, there is no dialog asking for acceptance of changes anymore.\n\nCo-authored-by: Stefan Kolb <stefan-kolb@web.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16874d672ab08b586d1497c8ddb3dc34267e83eb", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/16874d672ab08b586d1497c8ddb3dc34267e83eb", "committedDate": "2020-03-13T22:43:23Z", "message": "When JabRef finds a `.sav` file without changes, there is no dialog asking for acceptance of changes anymore.\n\nCo-authored-by: Stefan Kolb <stefan-kolb@web.de>"}, "afterCommit": {"oid": "73b7cb9c3ac7307ea5a5064e83104183c3c69e46", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/73b7cb9c3ac7307ea5a5064e83104183c3c69e46", "committedDate": "2020-03-13T22:43:54Z", "message": "When JabRef finds a `.sav` file without changes, there is no dialog asking for acceptance of changes anymore.\n\nCo-authored-by: Stefan Kolb <stefan-kolb@web.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NzA5MDAw", "url": "https://github.com/JabRef/jabref/pull/6116#pullrequestreview-374709000", "createdAt": "2020-03-14T09:03:23Z", "commit": {"oid": "73b7cb9c3ac7307ea5a5064e83104183c3c69e46"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwOTowMzoyNFrOF2YkOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwOTowNTo0N1rOF2Yk3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU2OTkxMw==", "bodyText": "Files.mismatch should do the job\nhttps://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/nio/file/Files.html#mismatch(java.nio.file.Path,java.nio.file.Path)", "url": "https://github.com/JabRef/jabref/pull/6116#discussion_r392569913", "createdAt": "2020-03-14T09:03:24Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/logic/autosaveandbackup/BackupManager.java", "diffHunk": "@@ -86,13 +87,27 @@ public static void shutdown(BibDatabaseContext bibDatabaseContext) {\n     }\n \n     /**\n-     * Checks whether a backup file exists for the given database file.\n+     * Checks whether a backup file exists for the given database file. If it exists, it is checked whether it is\n+     * different from the original.\n      *\n-     * @param originalPath Path to the file a backup should be checked for.\n+     * @param originalPath Path to the file a backup should be checked for. Example: jabref.bib.\n+     * @return <code>true</code> if backup file exists AND differs from originalPath. <code>false</code> is the\n+     * \"default\" return value in the good case. In the case of an exception <code>true</code> is returned to ensure that\n+     * the user checks the output.\n      */\n-    public static boolean checkForBackupFile(Path originalPath) {\n+    public static boolean backupFileDiffers(Path originalPath) {\n         Path backupPath = getBackupPath(originalPath);\n-        return Files.exists(backupPath) && !Files.isDirectory(backupPath);\n+        if (!Files.exists(backupPath) || Files.isDirectory(backupPath)) {\n+            return false;\n+        }\n+\n+        try {\n+            return !com.google.common.io.Files.equal(originalPath.toFile(), backupPath.toFile());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73b7cb9c3ac7307ea5a5064e83104183c3c69e46"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU3MDA3OQ==", "bodyText": "How do these tests work? I cannot see a .sav file in the folder?!", "url": "https://github.com/JabRef/jabref/pull/6116#discussion_r392570079", "createdAt": "2020-03-14T09:05:47Z", "author": {"login": "tobiasdiez"}, "path": "src/test/java/org/jabref/logic/autosaveandbackup/BackupManagerTest.java", "diffHunk": "@@ -15,4 +17,22 @@ public void backupFileNameIsCorrectlyGeneratedWithinTmpDirectory() {\n         Path savPath = BackupManager.getBackupPath(bibPath);\n         assertEquals(Paths.get(\"tmp\", \"test.bib.sav\"), savPath);\n     }\n+\n+    @Test\n+    public void backupFileIsEqualForNonExistingBackup() throws Exception {\n+        Path originalFile = Path.of(BackupManagerTest.class.getResource(\"no-backup.bib\").toURI());\n+        assertFalse(BackupManager.backupFileDiffers(originalFile));\n+    }\n+\n+    @Test\n+    public void backupFileIsEqual() throws Exception {\n+        Path originalFile = Path.of(BackupManagerTest.class.getResource(\"no-changes.bib\").toURI());\n+        assertFalse(BackupManager.backupFileDiffers(originalFile));\n+    }\n+\n+    @Test\n+    public void backupFileDiffers() throws Exception {\n+        Path originalFile = Path.of(BackupManagerTest.class.getResource(\"changes.bib\").toURI());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73b7cb9c3ac7307ea5a5064e83104183c3c69e46"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee472cf55d351d22ea328eb897bf30e37f5a2811", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/ee472cf55d351d22ea328eb897bf30e37f5a2811", "committedDate": "2020-03-15T20:22:46Z", "message": "Make test names and filenames more speaking and add missing files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db8e8b30a2c1e4ec38e8b4e7f5c6003e170c02b3", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/db8e8b30a2c1e4ec38e8b4e7f5c6003e170c02b3", "committedDate": "2020-03-15T20:44:15Z", "message": "Use JDK12 instead of Google Guava"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5a39568ba5c4e41e17b87f0de5979762c3024bd", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/b5a39568ba5c4e41e17b87f0de5979762c3024bd", "committedDate": "2020-03-17T05:24:46Z", "message": "Merge branch 'master' into fix-bak"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1OTg2ODkx", "url": "https://github.com/JabRef/jabref/pull/6116#pullrequestreview-375986891", "createdAt": "2020-03-17T12:28:13Z", "commit": {"oid": "b5a39568ba5c4e41e17b87f0de5979762c3024bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 405, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}