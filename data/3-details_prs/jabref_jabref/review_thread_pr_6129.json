{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4ODYzNTE1", "number": 6129, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDoxODowMVrODoWilg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDoyNjozM1rODoW4wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjM4OTM0OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/jabref/gui/BasePanel.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDoxODowMlrOF22PNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOFQxNzo0MDozMFrOHjsfbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA1NjA1NA==", "bodyText": "Can you please investigate if this method is still really necessary. In principle, it should be enough to add listeners to the state manager to be notified about db changes. This would also fix the strange flow of information (from the base panel to the main frame).", "url": "https://github.com/JabRef/jabref/pull/6129#discussion_r393056054", "createdAt": "2020-03-16T14:18:02Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/BasePanel.java", "diffHunk": "@@ -539,11 +507,12 @@ public void updateEntryEditorIfShowing() {\n         }\n     }\n \n+    /**\n+     * Put an asterisk behind the filename to indicate the database has changed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffad7e825aead8e8900d674ec28ba9541c79fefa"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzE5MTE1MQ==", "bodyText": "I intensivly investigated this issue. I believe this method or something like it is still necessary until we can bind some property to an undomanager, which can provide a dirty flag for each library file.", "url": "https://github.com/JabRef/jabref/pull/6129#discussion_r507191151", "createdAt": "2020-10-18T17:40:30Z", "author": {"login": "calixtus"}, "path": "src/main/java/org/jabref/gui/BasePanel.java", "diffHunk": "@@ -539,11 +507,12 @@ public void updateEntryEditorIfShowing() {\n         }\n     }\n \n+    /**\n+     * Put an asterisk behind the filename to indicate the database has changed.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA1NjA1NA=="}, "originalCommit": {"oid": "ffad7e825aead8e8900d674ec28ba9541c79fefa"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjM5Nzk0OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/jabref/gui/JabRefFrame.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDoxOToyNVrOF22Uqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDoxOToyNVrOF22Uqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA1NzQ1MA==", "bodyText": "The most important part is that the open program is JabRef. So I would put this first. The database mode is not important enough to be displayed in the window title in my opinion.", "url": "https://github.com/JabRef/jabref/pull/6129#discussion_r393057450", "createdAt": "2020-03-16T14:19:25Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/JabRefFrame.java", "diffHunk": "@@ -279,41 +277,127 @@ private Void showTrackingNotification() {\n         return null;\n     }\n \n-    public void refreshTitleAndTabs() {\n+    /**\n+     * Determines the titles of all tabs - and the window title.\n+     *\n+     * We aim for following in a tab:\n+     *\n+     *   filename (datbase-mode) \u2013 path-fragment \u2013 JabRef", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffad7e825aead8e8900d674ec28ba9541c79fefa"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjQwMTM5OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/jabref/gui/JabRefFrame.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDoyMDowMlrOF22XBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDoyMDowMlrOF22XBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA1ODA1NA==", "bodyText": "Can you please rewrite the code mainly using the statemanager.", "url": "https://github.com/JabRef/jabref/pull/6129#discussion_r393058054", "createdAt": "2020-03-16T14:20:02Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/JabRefFrame.java", "diffHunk": "@@ -279,41 +277,127 @@ private Void showTrackingNotification() {\n         return null;\n     }\n \n-    public void refreshTitleAndTabs() {\n+    /**\n+     * Determines the titles of all tabs - and the window title.\n+     *\n+     * We aim for following in a tab:\n+     *\n+     *   filename (datbase-mode) \u2013 path-fragment \u2013 JabRef\n+     *\n+     * path-fragment is only shown if filename is not (globally) unique\n+     *\n+     * Example:\n+     *\n+     *   jabref-authors.bib (BibLaTeX) \u2013 testbib \u2013 JabRef\n+     *\n+     * For the JabRef window, it should be\n+     *\n+     *   full-path (database-mode) \u2013 JabRef\n+     *\n+     * Example:\n+     *\n+     *   C:\\git-repositories\\jabref\\src\\test\\resources\\testbib\\jabref-authors.bib (BibLaTeX) \u2013 JabRef\n+     */\n+    public void refreshWindowAndTabTitles() {\n         DefaultTaskExecutor.runInJavaFXThread(() -> {\n+            int selectedTabIndex = tabbedPane.getSelectionModel().getSelectedIndex();\n+\n+            List<String> uniquePathParts = getUniquePathParts();\n+            for (int i = 0; i < getBasePanelCount(); i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffad7e825aead8e8900d674ec28ba9541c79fefa"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjQzODkzOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/jabref/gui/JabRefFrame.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDoyNTozN1rOF22vBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDoyNTozN1rOF22vBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA2NDE5Ng==", "bodyText": "I would always mark it with a star as JabRef will ask what to do with the new database when it's closed.", "url": "https://github.com/JabRef/jabref/pull/6129#discussion_r393064196", "createdAt": "2020-03-16T14:25:37Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/JabRefFrame.java", "diffHunk": "@@ -279,41 +277,127 @@ private Void showTrackingNotification() {\n         return null;\n     }\n \n-    public void refreshTitleAndTabs() {\n+    /**\n+     * Determines the titles of all tabs - and the window title.\n+     *\n+     * We aim for following in a tab:\n+     *\n+     *   filename (datbase-mode) \u2013 path-fragment \u2013 JabRef\n+     *\n+     * path-fragment is only shown if filename is not (globally) unique\n+     *\n+     * Example:\n+     *\n+     *   jabref-authors.bib (BibLaTeX) \u2013 testbib \u2013 JabRef\n+     *\n+     * For the JabRef window, it should be\n+     *\n+     *   full-path (database-mode) \u2013 JabRef\n+     *\n+     * Example:\n+     *\n+     *   C:\\git-repositories\\jabref\\src\\test\\resources\\testbib\\jabref-authors.bib (BibLaTeX) \u2013 JabRef\n+     */\n+    public void refreshWindowAndTabTitles() {\n         DefaultTaskExecutor.runInJavaFXThread(() -> {\n+            int selectedTabIndex = tabbedPane.getSelectionModel().getSelectedIndex();\n+\n+            List<String> uniquePathParts = getUniquePathParts();\n+            for (int i = 0; i < getBasePanelCount(); i++) {\n+                BasePanel panel = getBasePanelAt(i);\n+                BibDatabaseContext bibDatabaseContext = panel.getBibDatabaseContext();\n+                DatabaseLocation databaseLocation = bibDatabaseContext.getLocation();\n+                Optional<Path> file = bibDatabaseContext.getDatabasePath();\n+                boolean isAutosaveEnabled = Globals.prefs.getBoolean(JabRefPreferences.LOCAL_AUTO_SAVE);\n+\n+                StringBuilder tabTitle = new StringBuilder();\n+                StringBuilder toolTipText = new StringBuilder();\n+                StringBuilder windowTitle = new StringBuilder();\n+\n+                if (file.isPresent()) {\n+                    Path databasePath = file.get();\n+                    String fileName = databasePath.getFileName().toString();\n+                    tabTitle.append(fileName);\n+                    windowTitle.append(fileName);\n+                    toolTipText.append(databasePath.toAbsolutePath().toString());\n+                    if (panel.isModified() && !isAutosaveEnabled) {\n+                        tabTitle.append('*');\n+                        windowTitle.append('*');\n+                    }\n+\n+                    if (databaseLocation == DatabaseLocation.SHARED) {\n+                        tabTitle.append(\" \\u2013 \");\n+                        addSharedDbInformation(tabTitle, bibDatabaseContext);\n+                        toolTipText.append(' ');\n+                        addSharedDbInformation(toolTipText, bibDatabaseContext);\n+                        windowTitle.append(\" \\u2013 \");\n+                        addSharedDbInformation(windowTitle, bibDatabaseContext);\n+                    }\n+\n+                    addModeInfo(toolTipText, bibDatabaseContext);\n+                    addModeInfo(windowTitle, bibDatabaseContext);\n+\n+                    if (panel.isModified() && !isAutosaveEnabled) {\n+                        addChangedInformation(toolTipText, fileName);\n+                    }\n \n-            setWindowTitle();\n-            updateAllTabTitles();\n+                    String uniquePath = uniquePathParts.get(i);\n+                    if (!uniquePath.equals(fileName) && uniquePath.contains(File.separator)) {\n+                        // remove filename\n+                        uniquePath = uniquePath.substring(0, uniquePath.lastIndexOf(File.separator));\n+                        tabTitle.append(\" \\u2013 \").append(uniquePath);\n+                        windowTitle.append(\" \\u2013 \").append(uniquePath);\n+                    }\n+                } else {\n+                    if (databaseLocation == DatabaseLocation.LOCAL) {\n+                        tabTitle.append(Localization.lang(\"untitled\"));\n+                        windowTitle.append(Localization.lang(\"untitled\"));\n+                        if (bibDatabaseContext.getDatabase().hasEntries()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffad7e825aead8e8900d674ec28ba9541c79fefa"}, "originalPosition": 114}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjQ0NjEwOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/jabref/gui/JabRefFrame.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDoyNjozM1rOF22zNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDoyNjozM1rOF22zNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA2NTI3MQ==", "bodyText": "As this is displayed only in the tooltip, it's always clear to which database it is referring.", "url": "https://github.com/JabRef/jabref/pull/6129#discussion_r393065271", "createdAt": "2020-03-16T14:26:33Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/JabRefFrame.java", "diffHunk": "@@ -279,41 +277,127 @@ private Void showTrackingNotification() {\n         return null;\n     }\n \n-    public void refreshTitleAndTabs() {\n+    /**\n+     * Determines the titles of all tabs - and the window title.\n+     *\n+     * We aim for following in a tab:\n+     *\n+     *   filename (datbase-mode) \u2013 path-fragment \u2013 JabRef\n+     *\n+     * path-fragment is only shown if filename is not (globally) unique\n+     *\n+     * Example:\n+     *\n+     *   jabref-authors.bib (BibLaTeX) \u2013 testbib \u2013 JabRef\n+     *\n+     * For the JabRef window, it should be\n+     *\n+     *   full-path (database-mode) \u2013 JabRef\n+     *\n+     * Example:\n+     *\n+     *   C:\\git-repositories\\jabref\\src\\test\\resources\\testbib\\jabref-authors.bib (BibLaTeX) \u2013 JabRef\n+     */\n+    public void refreshWindowAndTabTitles() {\n         DefaultTaskExecutor.runInJavaFXThread(() -> {\n+            int selectedTabIndex = tabbedPane.getSelectionModel().getSelectedIndex();\n+\n+            List<String> uniquePathParts = getUniquePathParts();\n+            for (int i = 0; i < getBasePanelCount(); i++) {\n+                BasePanel panel = getBasePanelAt(i);\n+                BibDatabaseContext bibDatabaseContext = panel.getBibDatabaseContext();\n+                DatabaseLocation databaseLocation = bibDatabaseContext.getLocation();\n+                Optional<Path> file = bibDatabaseContext.getDatabasePath();\n+                boolean isAutosaveEnabled = Globals.prefs.getBoolean(JabRefPreferences.LOCAL_AUTO_SAVE);\n+\n+                StringBuilder tabTitle = new StringBuilder();\n+                StringBuilder toolTipText = new StringBuilder();\n+                StringBuilder windowTitle = new StringBuilder();\n+\n+                if (file.isPresent()) {\n+                    Path databasePath = file.get();\n+                    String fileName = databasePath.getFileName().toString();\n+                    tabTitle.append(fileName);\n+                    windowTitle.append(fileName);\n+                    toolTipText.append(databasePath.toAbsolutePath().toString());\n+                    if (panel.isModified() && !isAutosaveEnabled) {\n+                        tabTitle.append('*');\n+                        windowTitle.append('*');\n+                    }\n+\n+                    if (databaseLocation == DatabaseLocation.SHARED) {\n+                        tabTitle.append(\" \\u2013 \");\n+                        addSharedDbInformation(tabTitle, bibDatabaseContext);\n+                        toolTipText.append(' ');\n+                        addSharedDbInformation(toolTipText, bibDatabaseContext);\n+                        windowTitle.append(\" \\u2013 \");\n+                        addSharedDbInformation(windowTitle, bibDatabaseContext);\n+                    }\n+\n+                    addModeInfo(toolTipText, bibDatabaseContext);\n+                    addModeInfo(windowTitle, bibDatabaseContext);\n+\n+                    if (panel.isModified() && !isAutosaveEnabled) {\n+                        addChangedInformation(toolTipText, fileName);\n+                    }\n \n-            setWindowTitle();\n-            updateAllTabTitles();\n+                    String uniquePath = uniquePathParts.get(i);\n+                    if (!uniquePath.equals(fileName) && uniquePath.contains(File.separator)) {\n+                        // remove filename\n+                        uniquePath = uniquePath.substring(0, uniquePath.lastIndexOf(File.separator));\n+                        tabTitle.append(\" \\u2013 \").append(uniquePath);\n+                        windowTitle.append(\" \\u2013 \").append(uniquePath);\n+                    }\n+                } else {\n+                    if (databaseLocation == DatabaseLocation.LOCAL) {\n+                        tabTitle.append(Localization.lang(\"untitled\"));\n+                        windowTitle.append(Localization.lang(\"untitled\"));\n+                        if (bibDatabaseContext.getDatabase().hasEntries()) {\n+                            // if the database is not empty and no file is assigned,\n+                            // the database came from an import and has to be treated somehow\n+                            // -> mark as changed\n+                            tabTitle.append('*');\n+                            windowTitle.append('*');\n+                        }\n+                    } else {\n+                        addSharedDbInformation(tabTitle, bibDatabaseContext);\n+                        addSharedDbInformation(toolTipText, bibDatabaseContext);\n+                    }\n+                    addModeInfo(toolTipText, bibDatabaseContext);\n+                    addModeInfo(windowTitle, bibDatabaseContext);\n+                    if (databaseLocation == DatabaseLocation.LOCAL && bibDatabaseContext.getDatabase().hasEntries()) {\n+                        addChangedInformation(toolTipText, Localization.lang(\"untitled\"));\n+                    }\n+                }\n+\n+                tabbedPane.getTabs().get(i).setText(tabTitle.toString());\n+                tabbedPane.getTabs().get(i).setTooltip(new Tooltip(toolTipText.toString()));\n+\n+                if (i == selectedTabIndex) {\n+                    windowTitle.append(\" \\u2013 \");\n+                    windowTitle.append(FRAME_TITLE);\n+                    mainStage.setTitle(windowTitle.toString());\n+                }\n+            }\n         });\n     }\n \n-    /**\n-     * Sets the title of the main window.\n-     */\n-    public void setWindowTitle() {\n-        BasePanel panel = getCurrentBasePanel();\n-\n-        // no database open\n-        if (panel == null) {\n-            //setTitle(FRAME_TITLE);\n-            return;\n-        }\n+    private void addChangedInformation(StringBuilder text, String fileName) {\n+        text.append(\". \");\n+        text.append(Localization.lang(\"Library '%0' has changed.\", fileName));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffad7e825aead8e8900d674ec28ba9541c79fefa"}, "originalPosition": 157}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2005, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}