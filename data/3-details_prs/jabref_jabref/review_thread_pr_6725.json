{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5NjI5NTMx", "number": 6725, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDoyMjozMlrOEXyD9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNTo1Mjo1NVrOEYWHAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMzcyOTE5OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/jabref/gui/preferences/AppearanceTabViewModel.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDoyMjozMlrOG_xE2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDowMjoyMFrOHAbnoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxNzUzMQ==", "bodyText": "I'm not sure if this makes things clearer, but just wanted to throw the idea in: What about having an enum for the different kinds of themes (light / dark / custom), and then an additional Path getPathToCustomTheme in case the \"custom\" enum option is chosen. Right now it feels like getPathToTheme is mixing these two aspects.", "url": "https://github.com/JabRef/jabref/pull/6725#discussion_r469517531", "createdAt": "2020-08-12T20:22:32Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/preferences/AppearanceTabViewModel.java", "diffHunk": "@@ -53,55 +63,95 @@ public AppearanceTabViewModel(DialogService dialogService, JabRefPreferences pre\n                         Localization.lang(\"Appearance\"),\n                         Localization.lang(\"Font settings\"),\n                         Localization.lang(\"You must enter an integer value higher than 8.\"))));\n+\n+        customPathToThemeValidator = new FunctionBasedValidator<>(\n+                customPathToThemeProperty,\n+                input -> !StringUtil.isNullOrEmpty(input),\n+                ValidationMessage.error(String.format(\"%s > %s %n %n %s\",\n+                        Localization.lang(\"Appearance\"),\n+                        Localization.lang(\"Visual theme\"),\n+                        Localization.lang(\"Please specify a css theme file.\"))));\n     }\n \n     @Override\n     public void setValues() {\n-        fontOverrideProperty.setValue(preferences.getBoolean(JabRefPreferences.OVERRIDE_DEFAULT_FONT_SIZE));\n-        fontSizeProperty.setValue(String.valueOf(preferences.getInt(JabRefPreferences.MAIN_FONT_SIZE)));\n-\n-        switch (preferences.get(JabRefPreferences.FX_THEME)) {\n-            case ThemeLoader.DARK_CSS:\n-                themeLightProperty.setValue(false);\n-                themeDarkProperty.setValue(true);\n-                break;\n-            case ThemeLoader.MAIN_CSS:\n-            default:\n-                themeLightProperty.setValue(true);\n-                themeDarkProperty.setValue(false);\n+        fontOverrideProperty.setValue(initialAppearancePreferences.shouldOverrideDefaultFontSize());\n+        fontSizeProperty.setValue(String.valueOf(initialAppearancePreferences.getMainFontSize()));\n+\n+        String currentTheme = initialAppearancePreferences.getPathToTheme();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "487e24c6cefd45ca1df496cd326459b526e108dd"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIxNDU2MA==", "bodyText": "Yeah, possible, but It escalated a bit. Again. \ud83d\ude48", "url": "https://github.com/JabRef/jabref/pull/6725#discussion_r470214560", "createdAt": "2020-08-13T20:02:20Z", "author": {"login": "calixtus"}, "path": "src/main/java/org/jabref/gui/preferences/AppearanceTabViewModel.java", "diffHunk": "@@ -53,55 +63,95 @@ public AppearanceTabViewModel(DialogService dialogService, JabRefPreferences pre\n                         Localization.lang(\"Appearance\"),\n                         Localization.lang(\"Font settings\"),\n                         Localization.lang(\"You must enter an integer value higher than 8.\"))));\n+\n+        customPathToThemeValidator = new FunctionBasedValidator<>(\n+                customPathToThemeProperty,\n+                input -> !StringUtil.isNullOrEmpty(input),\n+                ValidationMessage.error(String.format(\"%s > %s %n %n %s\",\n+                        Localization.lang(\"Appearance\"),\n+                        Localization.lang(\"Visual theme\"),\n+                        Localization.lang(\"Please specify a css theme file.\"))));\n     }\n \n     @Override\n     public void setValues() {\n-        fontOverrideProperty.setValue(preferences.getBoolean(JabRefPreferences.OVERRIDE_DEFAULT_FONT_SIZE));\n-        fontSizeProperty.setValue(String.valueOf(preferences.getInt(JabRefPreferences.MAIN_FONT_SIZE)));\n-\n-        switch (preferences.get(JabRefPreferences.FX_THEME)) {\n-            case ThemeLoader.DARK_CSS:\n-                themeLightProperty.setValue(false);\n-                themeDarkProperty.setValue(true);\n-                break;\n-            case ThemeLoader.MAIN_CSS:\n-            default:\n-                themeLightProperty.setValue(true);\n-                themeDarkProperty.setValue(false);\n+        fontOverrideProperty.setValue(initialAppearancePreferences.shouldOverrideDefaultFontSize());\n+        fontSizeProperty.setValue(String.valueOf(initialAppearancePreferences.getMainFontSize()));\n+\n+        String currentTheme = initialAppearancePreferences.getPathToTheme();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxNzUzMQ=="}, "originalCommit": {"oid": "487e24c6cefd45ca1df496cd326459b526e108dd"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMzczNDU4OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/jabref/gui/util/ThemeLoader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDoyNDoyMFrOG_xIQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDoyNDoyMFrOG_xIQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxODQwMQ==", "bodyText": "Use Path instead of File here", "url": "https://github.com/JabRef/jabref/pull/6725#discussion_r469518401", "createdAt": "2020-08-12T20:24:20Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/util/ThemeLoader.java", "diffHunk": "@@ -59,13 +61,23 @@ public ThemeLoader(FileUpdateMonitor fileUpdateMonitor, JabRefPreferences jabRef\n             additionalCssToLoad = Optional.ofNullable(cssVmUrl);\n         } else if (StringUtil.isNotBlank(cssPreferences) && !MAIN_CSS.equalsIgnoreCase(cssPreferences)) {\n             // Otherwise load css from preference\n-            URL cssResource = JabRefFrame.class.getResource(cssPreferences);\n-            if (cssResource != null) {\n-                LOGGER.debug(\"Using css \" + cssResource);\n-                additionalCssToLoad = Optional.of(cssResource);\n+            Optional<URL> cssResource = Optional.empty();\n+            if (DARK_CSS.equals(cssPreferences)) {\n+                cssResource = Optional.ofNullable(JabRefFrame.class.getResource(cssPreferences));\n+            } else {\n+                try {\n+                    cssResource = Optional.of(new File(cssPreferences).toURI().toURL());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "487e24c6cefd45ca1df496cd326459b526e108dd"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMzc0MjI2OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/jabref/gui/util/ThemeLoader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDoyNjozMFrOG_xM9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDoyNjozMFrOG_xM9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxOTYwNg==", "bodyText": "Do you think we still need the VM option? It was meant to ease development, but it should be easy enough now to switch themes / load custom css.", "url": "https://github.com/JabRef/jabref/pull/6725#discussion_r469519606", "createdAt": "2020-08-12T20:26:30Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/util/ThemeLoader.java", "diffHunk": "@@ -47,9 +48,10 @@ public ThemeLoader(FileUpdateMonitor fileUpdateMonitor, JabRefPreferences jabRef\n \n         String cssVmArgument = System.getProperty(\"jabref.theme.css\");\n         String cssPreferences = jabRefPreferences.get(JabRefPreferences.FX_THEME);\n+\n         if (StringUtil.isNotBlank(cssVmArgument)) {\n             // First priority: VM argument\n-            LOGGER.info(\"Using css from VM option: \" + cssVmArgument);\n+            LOGGER.info(\"Using css from VM option: {}\", cssVmArgument);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "487e24c6cefd45ca1df496cd326459b526e108dd"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMzc0NTAwOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/jabref/gui/util/ThemeLoader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDoyNzoyM1rOG_xOtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDoyNzoyM1rOG_xOtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUyMDA1Mw==", "bodyText": "reuse preferences.getTheme() ?", "url": "https://github.com/JabRef/jabref/pull/6725#discussion_r469520053", "createdAt": "2020-08-12T20:27:23Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/util/ThemeLoader.java", "diffHunk": "@@ -47,9 +48,10 @@ public ThemeLoader(FileUpdateMonitor fileUpdateMonitor, JabRefPreferences jabRef\n \n         String cssVmArgument = System.getProperty(\"jabref.theme.css\");\n         String cssPreferences = jabRefPreferences.get(JabRefPreferences.FX_THEME);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "487e24c6cefd45ca1df496cd326459b526e108dd"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMzc0NjA0OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/jabref/preferences/PreferencesService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDoyNzo0NlrOG_xPaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxOTo1OTozOVrOHAbhgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUyMDIzMg==", "bodyText": "Is this still needed?", "url": "https://github.com/JabRef/jabref/pull/6725#discussion_r469520232", "createdAt": "2020-08-12T20:27:46Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/preferences/PreferencesService.java", "diffHunk": "@@ -70,6 +70,8 @@\n \n     void setWorkingDir(Path dir);\n \n+    String setLastPreferencesExportPath();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "487e24c6cefd45ca1df496cd326459b526e108dd"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIxMjk5Mw==", "bodyText": "Partly. I would like to postpone refactor of this until later when I'm working on FilePreferences.", "url": "https://github.com/JabRef/jabref/pull/6725#discussion_r470212993", "createdAt": "2020-08-13T19:59:39Z", "author": {"login": "calixtus"}, "path": "src/main/java/org/jabref/preferences/PreferencesService.java", "diffHunk": "@@ -70,6 +70,8 @@\n \n     void setWorkingDir(Path dir);\n \n+    String setLastPreferencesExportPath();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUyMDIzMg=="}, "originalCommit": {"oid": "487e24c6cefd45ca1df496cd326459b526e108dd"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzOTYzNTIzOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/jabref/gui/util/Theme.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNTo1Mjo1NVrOHAoZyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQxMzoxNzoyM1rOHBKJoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQyNDAwOA==", "bodyText": "To be honest, I'm not a big fan of these static methods. Static methods should only be used when there is no internal state to manage. So for example its ok that the methods in StringUtil are static, as they mostly follow the pattern that they take an input, process it and return something.\nHowever, here, there is a state that is managed: the fileUpdateMonitor and the additionalCssToLoad private fields. This leads to the hidden convention, that it's only allowed to call the installCss method after initalize is called. It's better to make this requirement explicit by making initalize a constructor of a normal class. This also has the advantage that you can mock/replace the themeloader in tests or for whatever reason. (I agree that it's somewhat academic in this particular case for the themeloader, as its not widely used. But it's good to follow the practice that dependencies are explicitly stated and not hidden in untestable static classes).", "url": "https://github.com/JabRef/jabref/pull/6725#discussion_r470424008", "createdAt": "2020-08-14T05:52:55Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/util/Theme.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package org.jabref.gui.util;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.file.Path;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import javafx.scene.Scene;\n+\n+import org.jabref.gui.JabRefFrame;\n+import org.jabref.model.util.FileUpdateMonitor;\n+import org.jabref.preferences.AppearancePreferences;\n+import org.jabref.preferences.PreferencesService;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Installs the style file and provides live reloading.\n+ * JabRef provides two inbuilt themes and a user customizable one: Light, Dark and Custom. The Light theme is basically\n+ * the base.css theme. Every other theme is loaded as an addition to base.css.\n+ */\n+public enum Theme {\n+    LIGHT(\"Light\", \"\"),\n+    DARK(\"Dark\", \"Dark.css\"),\n+    CUSTOM(\"Custom\", \"\");\n+\n+    public static final String BASE_CSS = \"Base.css\";\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Theme.class);\n+\n+    private static Optional<URL> additionalCssToLoad = Optional.empty(); // default: Light theme\n+    private static FileUpdateMonitor fileUpdateMonitor;\n+\n+    private String name;\n+    private Path additionalCssPath;\n+\n+    Theme(String name, String path) {\n+        this.name = name;\n+        this.additionalCssPath = Path.of(path);\n+    }\n+\n+    public static void initialize(FileUpdateMonitor fileUpdateMonitor, PreferencesService preferences) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89ef86fe380882dd32aa5df725fc238e692d82a3"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk3NjkyOA==", "bodyText": "Ok, I have reworked the class, the static objects are now part of the theme object. Should feel now somewhat like a cell factory with 'fluent' api (getTheme().installCss(scene)). The fileUpdateMonitor dependency is still bound to the Globals object, but I did not have the time nor the energy to refactor everything now, so I would like to stop here and to leave the refactor of the Globals object for sometime later, as I really would like to finish the preferences refactor project first.", "url": "https://github.com/JabRef/jabref/pull/6725#discussion_r470976928", "createdAt": "2020-08-15T13:17:23Z", "author": {"login": "calixtus"}, "path": "src/main/java/org/jabref/gui/util/Theme.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package org.jabref.gui.util;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.file.Path;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import javafx.scene.Scene;\n+\n+import org.jabref.gui.JabRefFrame;\n+import org.jabref.model.util.FileUpdateMonitor;\n+import org.jabref.preferences.AppearancePreferences;\n+import org.jabref.preferences.PreferencesService;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Installs the style file and provides live reloading.\n+ * JabRef provides two inbuilt themes and a user customizable one: Light, Dark and Custom. The Light theme is basically\n+ * the base.css theme. Every other theme is loaded as an addition to base.css.\n+ */\n+public enum Theme {\n+    LIGHT(\"Light\", \"\"),\n+    DARK(\"Dark\", \"Dark.css\"),\n+    CUSTOM(\"Custom\", \"\");\n+\n+    public static final String BASE_CSS = \"Base.css\";\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Theme.class);\n+\n+    private static Optional<URL> additionalCssToLoad = Optional.empty(); // default: Light theme\n+    private static FileUpdateMonitor fileUpdateMonitor;\n+\n+    private String name;\n+    private Path additionalCssPath;\n+\n+    Theme(String name, String path) {\n+        this.name = name;\n+        this.additionalCssPath = Path.of(path);\n+    }\n+\n+    public static void initialize(FileUpdateMonitor fileUpdateMonitor, PreferencesService preferences) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQyNDAwOA=="}, "originalCommit": {"oid": "89ef86fe380882dd32aa5df725fc238e692d82a3"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1648, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}