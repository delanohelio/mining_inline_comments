{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzMDU1NTIw", "number": 7162, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQxOTo0Mzo1M1rOFBTu5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQxOTo0Mzo1M1rOFBTu5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2OTE2MTk2OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/jabref/gui/externalfiles/DownloadFullTextAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQxOTo0Mzo1M1rOIAAk_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQxNzo1NDozN1rOIANZkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg4MDM4MA==", "bodyText": "I think with this change, downloading a pdf doesn't show any progress any more since the onlineFile is not added to the entry until the download succeeds.", "url": "https://github.com/JabRef/jabref/pull/7162#discussion_r536880380", "createdAt": "2020-12-05T19:43:53Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/externalfiles/DownloadFullTextAction.java", "diffHunk": "@@ -154,26 +150,7 @@ private void addLinkedFileFromURL(BibDatabaseContext databaseContext, URL url, B\n                     preferences.getFilePreferences(),\n                     ExternalFileTypes.getInstance());\n \n-            try {\n-                URLDownload urlDownload = new URLDownload(newLinkedFile.getLink());\n-                BackgroundTask<Path> downloadTask = onlineFile.prepareDownloadTask(targetDirectory, urlDownload);\n-                downloadTask.onSuccess(destination -> {\n-                    LinkedFile downloadedFile = LinkedFilesEditorViewModel.fromFile(\n-                            destination,\n-                            databaseContext.getFileDirectories(preferences.getFilePreferences()),\n-                            ExternalFileTypes.getInstance());\n-                    entry.addFile(downloadedFile);\n-                    dialogService.notify(Localization.lang(\"Finished downloading full text document for entry %0.\",\n-                            entry.getCitationKey().orElse(Localization.lang(\"undefined\"))));\n-                });\n-                downloadTask.titleProperty().set(Localization.lang(\"Downloading\"));\n-                downloadTask.messageProperty().set(\n-                        Localization.lang(\"Fulltext for\") + \": \" + entry.getCitationKey().orElse(Localization.lang(\"New entry\")));\n-                downloadTask.showToUser(true);\n-                Globals.TASK_EXECUTOR.execute(downloadTask);\n-            } catch (MalformedURLException exception) {\n-                dialogService.showErrorDialogAndWait(Localization.lang(\"Invalid URL\"), exception);\n-            }\n+            onlineFile.download();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "420c087256bd3da846d5312c3061ab96f33195dd"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA5MDQ1MQ==", "bodyText": "Not exactly sure, at this point we add the online fie link and then call the download method which also shows the progress\n\n  \n    \n      jabref/src/main/java/org/jabref/gui/fieldeditors/LinkedFileViewModel.java\n    \n    \n        Lines 415 to 454\n      in\n      c8f7be8\n    \n    \n    \n    \n\n        \n          \n           public void download() { \n        \n\n        \n          \n               if (!linkedFile.isOnlineLink()) { \n        \n\n        \n          \n                   throw new UnsupportedOperationException(\"In order to download the file it has to be an online link\"); \n        \n\n        \n          \n               } \n        \n\n        \n          \n               try { \n        \n\n        \n          \n                   Optional<Path> targetDirectory = databaseContext.getFirstExistingFileDir(filePreferences); \n        \n\n        \n          \n                   if (targetDirectory.isEmpty()) { \n        \n\n        \n          \n                       dialogService.showErrorDialogAndWait(Localization.lang(\"Download file\"), Localization.lang(\"File directory is not set or does not exist!\")); \n        \n\n        \n          \n                       return; \n        \n\n        \n          \n                   } \n        \n\n        \n          \n            \n        \n\n        \n          \n                   URLDownload urlDownload = new URLDownload(linkedFile.getLink()); \n        \n\n        \n          \n                   BackgroundTask<Path> downloadTask = prepareDownloadTask(targetDirectory.get(), urlDownload); \n        \n\n        \n          \n                   downloadTask.onSuccess(destination -> { \n        \n\n        \n          \n                       LinkedFile newLinkedFile = LinkedFilesEditorViewModel.fromFile(destination, databaseContext.getFileDirectories(filePreferences), externalFileTypes); \n        \n\n        \n          \n            \n        \n\n        \n          \n                       List<LinkedFile> linkedFiles = entry.getFiles(); \n        \n\n        \n          \n                       int oldFileIndex = -1; \n        \n\n        \n          \n                       int i = 0; \n        \n\n        \n          \n                       while (i < linkedFiles.size() && oldFileIndex == -1) { \n        \n\n        \n          \n                           LinkedFile file = linkedFiles.get(i); \n        \n\n        \n          \n                           // The file type changes as part of download process (see prepareDownloadTask), thus we only compare by link \n        \n\n        \n          \n                           if (file.getLink().equalsIgnoreCase(linkedFile.getLink())) { \n        \n\n        \n          \n                               oldFileIndex = i; \n        \n\n        \n          \n                           } \n        \n\n        \n          \n                           i++; \n        \n\n        \n          \n                       } \n        \n\n        \n          \n                       if (oldFileIndex == -1) { \n        \n\n        \n          \n                           linkedFiles.add(0, newLinkedFile); \n        \n\n        \n          \n                       } else { \n        \n\n        \n          \n                           linkedFiles.set(oldFileIndex, newLinkedFile); \n        \n\n        \n          \n                       } \n        \n\n        \n          \n                       entry.setFiles(linkedFiles); \n        \n\n        \n          \n                   }); \n        \n\n        \n          \n                   downloadProgress.bind(downloadTask.workDonePercentageProperty()); \n        \n\n        \n          \n                   downloadTask.titleProperty().set(Localization.lang(\"Downloading\")); \n        \n\n        \n          \n                   downloadTask.messageProperty().set( \n        \n\n        \n          \n                           Localization.lang(\"Fulltext for\") + \": \" + entry.getCitationKey().orElse(Localization.lang(\"New entry\"))); \n        \n\n        \n          \n                   downloadTask.showToUser(true); \n        \n\n        \n          \n                   taskExecutor.execute(downloadTask);", "url": "https://github.com/JabRef/jabref/pull/7162#discussion_r537090451", "createdAt": "2020-12-06T17:54:37Z", "author": {"login": "Siedlerchr"}, "path": "src/main/java/org/jabref/gui/externalfiles/DownloadFullTextAction.java", "diffHunk": "@@ -154,26 +150,7 @@ private void addLinkedFileFromURL(BibDatabaseContext databaseContext, URL url, B\n                     preferences.getFilePreferences(),\n                     ExternalFileTypes.getInstance());\n \n-            try {\n-                URLDownload urlDownload = new URLDownload(newLinkedFile.getLink());\n-                BackgroundTask<Path> downloadTask = onlineFile.prepareDownloadTask(targetDirectory, urlDownload);\n-                downloadTask.onSuccess(destination -> {\n-                    LinkedFile downloadedFile = LinkedFilesEditorViewModel.fromFile(\n-                            destination,\n-                            databaseContext.getFileDirectories(preferences.getFilePreferences()),\n-                            ExternalFileTypes.getInstance());\n-                    entry.addFile(downloadedFile);\n-                    dialogService.notify(Localization.lang(\"Finished downloading full text document for entry %0.\",\n-                            entry.getCitationKey().orElse(Localization.lang(\"undefined\"))));\n-                });\n-                downloadTask.titleProperty().set(Localization.lang(\"Downloading\"));\n-                downloadTask.messageProperty().set(\n-                        Localization.lang(\"Fulltext for\") + \": \" + entry.getCitationKey().orElse(Localization.lang(\"New entry\")));\n-                downloadTask.showToUser(true);\n-                Globals.TASK_EXECUTOR.execute(downloadTask);\n-            } catch (MalformedURLException exception) {\n-                dialogService.showErrorDialogAndWait(Localization.lang(\"Invalid URL\"), exception);\n-            }\n+            onlineFile.download();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg4MDM4MA=="}, "originalCommit": {"oid": "420c087256bd3da846d5312c3061ab96f33195dd"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2126, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}