{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4MDkwMTI5", "number": 6118, "title": "Interrupt all running tasks during shutdown", "bodyText": "(and don't allow new tasks to be executed)\nThis fixes #6109.\nWe invesitgated the shutdown procedure. We think that a thread creating a .sav file is still hanging around AFTER the throttler was shut down. And the .sav file was deleted afterwards. The .sav file was recreated after the deletion...", "createdAt": "2020-03-14T01:00:04Z", "url": "https://github.com/JabRef/jabref/pull/6118", "merged": true, "mergeCommit": {"oid": "d1f6c388be289a39be4f499549e34e59b1bc5d5c"}, "closed": true, "closedAt": "2020-09-01T12:17:20Z", "author": {"login": "koppor"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNaNJDgH2gAyMzg4MDkwMTI5OjcwZjUzMGYzMWMxY2YyZGEzZTYxMWYwMWEwZWE3YzViODJiNjA5OWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEmZXjAH2gAyMzg4MDkwMTI5OjNlZGYyNGM4NjUxNWYxN2I4M2IxNTczNWM1ZWRiNjI4YzMyZjQ4N2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "70f530f31c1cf2da3e611f01a0ea7c5b82b6099e", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/70f530f31c1cf2da3e611f01a0ea7c5b82b6099e", "committedDate": "2020-03-14T00:58:59Z", "message": "Interrupt all running tasks during shutdown (and don't allow new tasks to be executed)\n\nCo-authored-by: Stefan Kolb <stefan-kolb@web.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NzA5NzIz", "url": "https://github.com/JabRef/jabref/pull/6118#pullrequestreview-374709723", "createdAt": "2020-03-14T09:18:56Z", "commit": {"oid": "70f530f31c1cf2da3e611f01a0ea7c5b82b6099e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6988b490bab88d29ecb31aa126dd953967b27fe1", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/6988b490bab88d29ecb31aa126dd953967b27fe1", "committedDate": "2020-03-30T20:22:25Z", "message": "Merge remote-tracking branch 'origin/master' into fix-delay-task-throttler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ee3598792590c437d115c53435c9eb94e42f1b9", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/3ee3598792590c437d115c53435c9eb94e42f1b9", "committedDate": "2020-03-31T18:48:14Z", "message": "Merge branch 'master' into fix-delay-task-throttler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79c164e05207272c7b4da5cb86b1041ef7086604", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/79c164e05207272c7b4da5cb86b1041ef7086604", "committedDate": "2020-08-31T23:01:56Z", "message": "Merge remote-tracking branch 'origin/master' into fix-delay-task-throttler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f836dbe6bf4db3cd8334fc7cdd98dcd5bd9ad403", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/f836dbe6bf4db3cd8334fc7cdd98dcd5bd9ad403", "committedDate": "2020-08-31T23:03:57Z", "message": "Fix position of CHANGELOG.md entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3e9a2232dee0e3bfd7fc9639f646520c168e04a", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/c3e9a2232dee0e3bfd7fc9639f646520c168e04a", "committedDate": "2020-08-31T23:44:56Z", "message": "Extend to JabRefExecutorService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9df012a7f1a9b764f87fbd3412eda2be6318e263", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/9df012a7f1a9b764f87fbd3412eda2be6318e263", "committedDate": "2020-08-31T23:46:37Z", "message": "Merge remote-tracking branch 'origin/master' into fix-delay-task-throttler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NTc1NDYz", "url": "https://github.com/JabRef/jabref/pull/6118#pullrequestreview-479575463", "createdAt": "2020-09-01T09:48:57Z", "commit": {"oid": "9df012a7f1a9b764f87fbd3412eda2be6318e263"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwOTo0ODo1N1rOHKuopg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwOTo1NDoyNFrOHKu1pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxMTg3OA==", "bodyText": "Upon termination, this method returns.\n??", "url": "https://github.com/JabRef/jabref/pull/6118#discussion_r481011878", "createdAt": "2020-09-01T09:48:57Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/JabRefExecutorService.java", "diffHunk": "@@ -132,13 +132,47 @@ public void submit(TimerTask timerTask, long millisecondsDelay) {\n         timer.schedule(timerTask, millisecondsDelay);\n     }\n \n+    /**\n+     * Shuts everything down. Upon termination, this method returns.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9df012a7f1a9b764f87fbd3412eda2be6318e263"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxMzAzMg==", "bodyText": "indent", "url": "https://github.com/JabRef/jabref/pull/6118#discussion_r481013032", "createdAt": "2020-09-01T09:50:44Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/JabRefExecutorService.java", "diffHunk": "@@ -132,13 +132,47 @@ public void submit(TimerTask timerTask, long millisecondsDelay) {\n         timer.schedule(timerTask, millisecondsDelay);\n     }\n \n+    /**\n+     * Shuts everything down. Upon termination, this method returns.\n+     */\n     public void shutdownEverything() {\n-        // those threads will be allowed to finish\n-        this.executorService.shutdown();\n-        // those threads will be interrupted in their current task\n-        this.lowPriorityExecutorService.shutdownNow();\n         // kill the remote thread\n         stopRemoteThread();\n+\n+        try {\n+            // those threads will be allowed to finish\n+            this.executorService.shutdown();\n+            if (!executorService.awaitTermination(60, TimeUnit.SECONDS)) {\n+                LOGGER.debug(\"One minute passed, saving still not completed. Trying forced shutdown.\");\n+                executorService.shutdownNow();\n+                if (executorService.awaitTermination(60, TimeUnit.SECONDS)) {\n+                    LOGGER.debug(\"One minute passed again - forced shutdown worked.\");\n+                } else {\n+                    LOGGER.error(\"DelayedTaskThrottler did not terminate\");\n+                }\n+            }\n+        } catch (InterruptedException ie) {\n+                executorService.shutdownNow();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9df012a7f1a9b764f87fbd3412eda2be6318e263"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxNDIxMA==", "bodyText": "add to interface", "url": "https://github.com/JabRef/jabref/pull/6118#discussion_r481014210", "createdAt": "2020-09-01T09:52:40Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/util/DefaultTaskExecutor.java", "diffHunk": "@@ -122,6 +122,9 @@ public static void runInJavaFXThread(Runnable runnable) {\n         return scheduledExecutor.schedule(getJavaFXTask(task), delay, unit);\n     }\n \n+    /**\n+     * Shuts everything down. Upon termination, this method returns.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9df012a7f1a9b764f87fbd3412eda2be6318e263"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxNDU1OA==", "bodyText": "extract try block to method and call it for executorService and lowPriorityExecutorService", "url": "https://github.com/JabRef/jabref/pull/6118#discussion_r481014558", "createdAt": "2020-09-01T09:53:17Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/JabRefExecutorService.java", "diffHunk": "@@ -132,13 +132,47 @@ public void submit(TimerTask timerTask, long millisecondsDelay) {\n         timer.schedule(timerTask, millisecondsDelay);\n     }\n \n+    /**\n+     * Shuts everything down. Upon termination, this method returns.\n+     */\n     public void shutdownEverything() {\n-        // those threads will be allowed to finish\n-        this.executorService.shutdown();\n-        // those threads will be interrupted in their current task\n-        this.lowPriorityExecutorService.shutdownNow();\n         // kill the remote thread\n         stopRemoteThread();\n+\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9df012a7f1a9b764f87fbd3412eda2be6318e263"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxNDk4Mg==", "bodyText": "thats not the delayed task throttler", "url": "https://github.com/JabRef/jabref/pull/6118#discussion_r481014982", "createdAt": "2020-09-01T09:54:00Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/JabRefExecutorService.java", "diffHunk": "@@ -132,13 +132,47 @@ public void submit(TimerTask timerTask, long millisecondsDelay) {\n         timer.schedule(timerTask, millisecondsDelay);\n     }\n \n+    /**\n+     * Shuts everything down. Upon termination, this method returns.\n+     */\n     public void shutdownEverything() {\n-        // those threads will be allowed to finish\n-        this.executorService.shutdown();\n-        // those threads will be interrupted in their current task\n-        this.lowPriorityExecutorService.shutdownNow();\n         // kill the remote thread\n         stopRemoteThread();\n+\n+        try {\n+            // those threads will be allowed to finish\n+            this.executorService.shutdown();\n+            if (!executorService.awaitTermination(60, TimeUnit.SECONDS)) {\n+                LOGGER.debug(\"One minute passed, saving still not completed. Trying forced shutdown.\");\n+                executorService.shutdownNow();\n+                if (executorService.awaitTermination(60, TimeUnit.SECONDS)) {\n+                    LOGGER.debug(\"One minute passed again - forced shutdown worked.\");\n+                } else {\n+                    LOGGER.error(\"DelayedTaskThrottler did not terminate\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9df012a7f1a9b764f87fbd3412eda2be6318e263"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxNTIwNg==", "bodyText": "call above helper method", "url": "https://github.com/JabRef/jabref/pull/6118#discussion_r481015206", "createdAt": "2020-09-01T09:54:24Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/logic/util/DelayTaskThrottler.java", "diffHunk": "@@ -45,7 +46,25 @@ public void schedule(Runnable command) {\n         }\n     }\n \n+    /**\n+     * Shuts everything down. Upon termination, this method returns.\n+     */\n     public void shutdown() {\n+        // this is non-blocking. See https://stackoverflow.com/a/57383461/873282.\n         executor.shutdown();\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9df012a7f1a9b764f87fbd3412eda2be6318e263"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a15394264a84cba50d6630588b7da9b7d256c51", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/8a15394264a84cba50d6630588b7da9b7d256c51", "committedDate": "2020-09-01T10:14:28Z", "message": "No more code clones"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb0b55be7a11b9cad5c6e21812e204341069cf5e", "author": {"user": {"login": "koppor", "name": "Oliver Kopp"}}, "url": "https://github.com/JabRef/jabref/commit/eb0b55be7a11b9cad5c6e21812e204341069cf5e", "committedDate": "2020-09-01T10:18:29Z", "message": "Adress comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3edf24c86515f17b83b15735c5edb628c32f487f", "author": {"user": {"login": "tobiasdiez", "name": "Tobias Diez"}}, "url": "https://github.com/JabRef/jabref/commit/3edf24c86515f17b83b15735c5edb628c32f487f", "committedDate": "2020-09-01T12:17:02Z", "message": "Merge branch 'master' into fix-delay-task-throttler"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 410, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}