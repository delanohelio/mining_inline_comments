{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0ODk0NzA2", "number": 6443, "title": "Implement task progress indicator (and dialog) in the toolbar", "bodyText": "Implements a background-task progress indicator in JabRefs toolbar as first discussed in #6381 (comment).\n\nThe indicator is located at the right-most position in the toolbar. Clicking it opens a pop-over that lists the background tasks with an icon, title, message and progress.\nIn order not to overwhelm the user with background tasks, only interesting ones are shown. To make a background task show, it needs to have the showToUser property set. For it to have a meaningful entry, one should set the title and message to appropriate values. If progress can be tracked, that should be done as well. If not, an indeterminate indicator / progress bar is shown.\nTo set the icon of the task, add a mapping from the task-title to an icon to the iconMap in BackgroundTask.java\n\n\n Change in CHANGELOG.md described (if applicable)\n Tests created for changes (if applicable)\n Manually tested changed features in running JabRef (always required)\n Screenshots added in PR description (for UI changes)\n Checked documentation: Is the information available and up to date? If not created an issue at https://github.com/JabRef/user-documentation/issues or, even better, submitted a pull request to the documentation repository.", "createdAt": "2020-05-07T20:09:32Z", "url": "https://github.com/JabRef/jabref/pull/6443", "merged": true, "mergeCommit": {"oid": "4423d27999393da42a12b68d4a45009272599b7f"}, "closed": true, "closedAt": "2020-05-12T12:23:06Z", "author": {"login": "btut"}, "timelineItems": {"totalCount": 51, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABce-SxtAH2gAyNDE0ODk0NzA2OmZkZmUwNzQxZGM1ODg0YTU2YWI5OGIxZjU0NWI1ZDM3YThmNDlkZmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgjCGnAFqTQwOTk2ODc5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fdfe0741dc5884a56ab98b1f545b5d37a8f49dfa", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/fdfe0741dc5884a56ab98b1f545b5d37a8f49dfa", "committedDate": "2020-05-07T14:38:26Z", "message": "First draft of a task progress dialog\n\nImplemented a task progress dialog using a TaskProgressView.\nTasks show up, but without info. Neither the progress nor title and\nmessage are shown."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fd181130c8d6d4e7f848cb2aebddb4c41e9baf5", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/6fd181130c8d6d4e7f848cb2aebddb4c41e9baf5", "committedDate": "2020-05-07T20:03:34Z", "message": "Added progress indicator in JabRefFrame\n\nThere now i a progress indicator at the rightmost postition of JabRefs\ntoolbar. It shows the average progress of all running background tasks.\nClicking it will show a TaskProgressDialog.\n\nstill looks ugly and the binding to the average progress does not seem\nto be working."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MDQ4MDkz", "url": "https://github.com/JabRef/jabref/pull/6443#pullrequestreview-408048093", "createdAt": "2020-05-08T07:17:42Z", "commit": {"oid": "6fd181130c8d6d4e7f848cb2aebddb4c41e9baf5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwNzoxNzo0MlrOGSb6ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwNzoxNzo0MlrOGSb6ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk4NDkwNg==", "bodyText": "For the bindings to update, you need to add the list as a dependency (second argument of the createXBinding method). In the case of lists, however, its easier to use EasyBind.combine: https://github.com/TomasMikula/EasyBind#combine-list", "url": "https://github.com/JabRef/jabref/pull/6443#discussion_r421984906", "createdAt": "2020-05-08T07:17:42Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/StateManager.java", "diffHunk": "@@ -112,4 +118,20 @@ public void setSearchQuery(SearchQuery searchQuery) {\n     public OptionalObjectProperty<Node> focusOwnerProperty() { return focusOwner; }\n \n     public Optional<Node> getFocusOwner() { return focusOwner.get(); }\n+\n+    public UiThreadObservableList<Task> getBackgroundTasks() {\n+        return backgroundTasks;\n+    }\n+\n+    public void addBackgroundTask(Task backgroundTask) {\n+        this.backgroundTasks.add(backgroundTask);\n+    }\n+\n+    public BooleanBinding anyTaskRunningBinding = Bindings.createBooleanBinding(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fd181130c8d6d4e7f848cb2aebddb4c41e9baf5"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8834914e5e735abaa7a710216888abe6bf54277", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/b8834914e5e735abaa7a710216888abe6bf54277", "committedDate": "2020-05-08T07:17:50Z", "message": "Beautified progressindicator and added localization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MDUwMjE5", "url": "https://github.com/JabRef/jabref/pull/6443#pullrequestreview-408050219", "createdAt": "2020-05-08T07:22:00Z", "commit": {"oid": "6fd181130c8d6d4e7f848cb2aebddb4c41e9baf5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwNzoyMjowMFrOGScB-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwNzoyMjowMFrOGScB-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk4NjgwOA==", "bodyText": "Instead of using a real dialog, what about using a collapse overlay similar to how it's done in firefox?\nhttps://github.com/controlsfx/controlsfx/wiki/ControlsFX-Features#popover", "url": "https://github.com/JabRef/jabref/pull/6443#discussion_r421986808", "createdAt": "2020-05-08T07:22:00Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/JabRefFrame.java", "diffHunk": "@@ -921,6 +930,24 @@ private MenuBar createMenu() {\n         return menu;\n     }\n \n+    private ProgressIndicator createTaskIndicator() {\n+        ProgressIndicator indicator = new ProgressIndicator(1);\n+        indicator.progressProperty().bind(stateManager.tasksProgressBinding);\n+\n+        indicator.setOnMouseClicked(new EventHandler<MouseEvent>() {\n+            @Override\n+            public void handle(MouseEvent event) {\n+                TaskProgressDialog taskProgressDialog = new TaskProgressDialog();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fd181130c8d6d4e7f848cb2aebddb4c41e9baf5"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "255a6e491c7ad7da26c5fa761395e9f448aa671b", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/255a6e491c7ad7da26c5fa761395e9f448aa671b", "committedDate": "2020-05-08T09:17:37Z", "message": "Changed to Task<?> in the Tasklist.\n\nThis makes the view work with download tasks for example. Most other\ntasks are still shown without title, message (because none are set) and\nprogress.\nAlso, there are a lot of tasks somehow.\n\nThe progress indicator in the main view still does not work as I can't\nget the bindings to work."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38dd89dce28b72d195de18b848b011532ef1f868", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/38dd89dce28b72d195de18b848b011532ef1f868", "committedDate": "2020-05-08T11:14:42Z", "message": "Resolved typing issues for bindings\n\nThe progress indicator is now successfully bound to the list of tasks.\nHowever, tasks do not show up in the dialogue any more."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b2aaa6cbe51571c83bc5b65e5a9c99047b03ba5", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/1b2aaa6cbe51571c83bc5b65e5a9c99047b03ba5", "committedDate": "2020-05-08T11:33:42Z", "message": "Converted list of Properties to tasks for listbind\n\nWhen using ObjectProperties in the list of tasks, we can use EasyBind to\nconvert the list into a list of tasks which in turn can be bound to the\nlist of tasks in the view.\n\nWith this, the basic functionality works. There is a progress indicator\nin the toolbar that shows the average progress of all running background\ntasks. It is indeterminate if any task has indeterminate progress and\nshows 100% if no tasks are running.\n\nClicking it opens an overview of all running tasks and their progress.\n\nCurrently, there are many tasks running all the time. The only tasks\nthat were adapted for this to be pretty are the download tasks, and they\nare also still missing an icon."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "baf9bd0e7d55de96a74d1dbc12df604a4ef5c997", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/baf9bd0e7d55de96a74d1dbc12df604a4ef5c997", "committedDate": "2020-05-08T11:45:47Z", "message": "New Tasks are first in the list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40a8febeeff1e5f8aa760144ac7ec514dabe16f2", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/40a8febeeff1e5f8aa760144ac7ec514dabe16f2", "committedDate": "2020-05-08T13:15:07Z", "message": "Use a PopOver instead of a dialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cac989b24af0df0e18f35063d9866a94fbe47623", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/cac989b24af0df0e18f35063d9866a94fbe47623", "committedDate": "2020-05-08T14:08:14Z", "message": "Only show download tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f525b8a2956070f1cb92ed2848df6ea776db342", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/8f525b8a2956070f1cb92ed2848df6ea776db342", "committedDate": "2020-05-08T14:13:04Z", "message": "Better messages for download tasks\n\nThese are shorter and therefore the task progress view does not need a\nhorizontal scroll bar."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c877431d429a2436316912568ef154e10dad65cb", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/c877431d429a2436316912568ef154e10dad65cb", "committedDate": "2020-05-08T14:36:34Z", "message": "Type Witnesses are not needed any more."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjY2NDc1", "url": "https://github.com/JabRef/jabref/pull/6443#pullrequestreview-408666475", "createdAt": "2020-05-09T16:52:27Z", "commit": {"oid": "8f525b8a2956070f1cb92ed2848df6ea776db342"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxNjo1MjoyN1rOGS8h3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxNjo1MjoyN1rOGS8h3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUxOTI2Mg==", "bodyText": "What's the reason to wrap the tasks around in a ObjectProperty? It should also work without this wrapper. If there were problems with the updates, you might need to add an \"extractor\" to the observableArrayList which specifies that the list should update if the underlying data changes (in this case probably the progress of the task).", "url": "https://github.com/JabRef/jabref/pull/6443#discussion_r422519262", "createdAt": "2020-05-09T16:52:27Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/StateManager.java", "diffHunk": "@@ -41,6 +48,7 @@\n     private final OptionalObjectProperty<SearchQuery> activeSearchQuery = OptionalObjectProperty.empty();\n     private final ObservableMap<BibDatabaseContext, IntegerProperty> searchResultMap = FXCollections.observableHashMap();\n     private final OptionalObjectProperty<Node> focusOwner = OptionalObjectProperty.empty();\n+    private final UiThreadObservableList<ObjectProperty<Task<?>>> backgroundTasks = new UiThreadObservableList(FXCollections.observableArrayList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f525b8a2956070f1cb92ed2848df6ea776db342"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ad95986b8e081369939e920e1a219eb1d76627b", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/1ad95986b8e081369939e920e1a219eb1d76627b", "committedDate": "2020-05-09T17:42:16Z", "message": "Added extractor to task list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd4e38e8b41e90960cac721da22a18b4ce942c3a", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/cd4e38e8b41e90960cac721da22a18b4ce942c3a", "committedDate": "2020-05-09T18:10:20Z", "message": "Made anyTaskRunningBinding public\n\nFor consistency with other variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23f8cf053f8203a9785b8beecde015d51c6b98aa", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/23f8cf053f8203a9785b8beecde015d51c6b98aa", "committedDate": "2020-05-09T19:06:16Z", "message": "Removed ObjectProperty wrapping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4628c3dcb0b234025046ecfad6acd3d4aceddd2b", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/4628c3dcb0b234025046ecfad6acd3d4aceddd2b", "committedDate": "2020-05-09T19:10:33Z", "message": "NOT WORKING: quit dialogue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90ff19e47b4a7182e7a159471f097d4fc19d0350", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/90ff19e47b4a7182e7a159471f097d4fc19d0350", "committedDate": "2020-05-09T19:11:57Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62d7c142724573bdc5e65b1187c72f37ee401d7d", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/62d7c142724573bdc5e65b1187c72f37ee401d7d", "committedDate": "2020-05-09T19:16:38Z", "message": "Fix in dialog service\n\nMake showProgressDialogAndWait actually not only show but also wait."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4Njg3MTI1", "url": "https://github.com/JabRef/jabref/pull/6443#pullrequestreview-408687125", "createdAt": "2020-05-09T21:55:54Z", "commit": {"oid": "62d7c142724573bdc5e65b1187c72f37ee401d7d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQyMTo1NTo1NFrOGS-d6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQyMTo1Njo0MFrOGS-eMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1MTAxOQ==", "bodyText": "Just a wild guess, could it be that actually all tasks are finished, because the TaskExectutor is already shutdown?", "url": "https://github.com/JabRef/jabref/pull/6443#discussion_r422551019", "createdAt": "2020-05-09T21:55:54Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/WaitForBackgroundtasksFinishedDialog.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package org.jabref.gui;\n+\n+import javafx.concurrent.Task;\n+import org.jabref.logic.l10n.Localization;\n+\n+import java.util.List;\n+\n+/**\n+ * Dialog shown when closing of application needs to wait for some background tasks.\n+ */\n+public class WaitForBackgroundtasksFinishedDialog {\n+\n+    private final DialogService dialogService;\n+\n+    public WaitForBackgroundtasksFinishedDialog(DialogService dialogService) {\n+        this.dialogService = dialogService;\n+    }\n+\n+    public void showAndWait(StateManager stateManager) {\n+        if (stateManager.anyTaskRunningBinding.getValue()) {\n+            Task<Void> waitForBackgroundtasksFinished = new Task<Void>() {\n+                @Override\n+                protected Void call() throws Exception {\n+                    System.out.println(\"THREAD STARTED\");\n+                    while (stateManager.anyTaskRunningBinding.getValue()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d7c142724573bdc5e65b1187c72f37ee401d7d"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1MTA4OQ==", "bodyText": "Add a log statement here as well to make sure that the progress dialog does indeed wait?", "url": "https://github.com/JabRef/jabref/pull/6443#discussion_r422551089", "createdAt": "2020-05-09T21:56:40Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/WaitForBackgroundtasksFinishedDialog.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package org.jabref.gui;\n+\n+import javafx.concurrent.Task;\n+import org.jabref.logic.l10n.Localization;\n+\n+import java.util.List;\n+\n+/**\n+ * Dialog shown when closing of application needs to wait for some background tasks.\n+ */\n+public class WaitForBackgroundtasksFinishedDialog {\n+\n+    private final DialogService dialogService;\n+\n+    public WaitForBackgroundtasksFinishedDialog(DialogService dialogService) {\n+        this.dialogService = dialogService;\n+    }\n+\n+    public void showAndWait(StateManager stateManager) {\n+        if (stateManager.anyTaskRunningBinding.getValue()) {\n+            Task<Void> waitForBackgroundtasksFinished = new Task<Void>() {\n+                @Override\n+                protected Void call() throws Exception {\n+                    System.out.println(\"THREAD STARTED\");\n+                    while (stateManager.anyTaskRunningBinding.getValue()) {\n+                        System.out.println(\"updated value to \" + stateManager.tasksProgressBinding.getValue());\n+                        updateProgress(stateManager.tasksProgressBinding.getValue(), 1);\n+                        if (isCancelled()) {\n+                            return null;\n+                        } else {\n+                            Thread.sleep(100);\n+                        }\n+                    }\n+                    return null;\n+                }\n+            };\n+\n+            Thread th = new Thread(waitForBackgroundtasksFinished);\n+            th.setDaemon(true);\n+            th.start();\n+\n+            dialogService.showProgressDialogAndWait(\n+                    Localization.lang(\"Please wait...\"),\n+                    Localization.lang(\"Waiting for background tasks to finish\") + \"...\",\n+                    waitForBackgroundtasksFinished\n+            );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d7c142724573bdc5e65b1187c72f37ee401d7d"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "008d55e652d04a4d73b40df19098d66abfebd4b5", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/008d55e652d04a4d73b40df19098d66abfebd4b5", "committedDate": "2020-05-10T11:08:52Z", "message": "Add extractor for isRunning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9f4493ac5ff446be297570667ed88f18b0562b0", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/a9f4493ac5ff446be297570667ed88f18b0562b0", "committedDate": "2020-05-10T11:31:36Z", "message": "More informative (and working) quit dialog\n\nThe dialog that is shown when the user quits JabRef during ongoing\nbackground tasks now shows which background tasks are still running.\n\nWhen all of them complete or the user chooses to quit anyway, JabRef\nquits.\n\nThe user can also cancel the dialog. In that case, the dialog closes and\nJobRef remains running."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66ac31675dc099ba793ec7450f7d6dc85b25068d", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/66ac31675dc099ba793ec7450f7d6dc85b25068d", "committedDate": "2020-05-10T12:08:06Z", "message": "Added graphics callback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9a717693827c6ceb8c9d2ad9f30cfdf8d107c44", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/e9a717693827c6ceb8c9d2ad9f30cfdf8d107c44", "committedDate": "2020-05-10T13:44:52Z", "message": "Fixed some style issues\n\nThere are still some ImportOrder errors though where I can see no issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7442cc2247772b6e54bcb68cea947a5a2a604bc", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/d7442cc2247772b6e54bcb68cea947a5a2a604bc", "committedDate": "2020-05-10T14:10:04Z", "message": "Registered the save task as background task\n\nThis makes the dialog that pops up if background tasks are running wait\nfor pending saves."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5defe3e467f83c2ce86407fd998c093f78a7a519", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/5defe3e467f83c2ce86407fd998c093f78a7a519", "committedDate": "2020-05-10T14:42:18Z", "message": "Revert \"Registered the save task as background task\"\n\nThis reverts commit d7442cc2247772b6e54bcb68cea947a5a2a604bc."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fba9c70bec3813d8684e79ae21c29b770625a734", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/fba9c70bec3813d8684e79ae21c29b770625a734", "committedDate": "2020-05-10T14:46:30Z", "message": "Added note on dialog-order upon close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a62e6fea391b2845943b976152c634f3cbc5750", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/6a62e6fea391b2845943b976152c634f3cbc5750", "committedDate": "2020-05-10T14:55:17Z", "message": "Updated changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a97af13c93b3cd32fef6242af5622332765a8727", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/a97af13c93b3cd32fef6242af5622332765a8727", "committedDate": "2020-05-10T15:54:13Z", "message": "Fixed style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ee457171da21a039a29756f37f66c480a132f3c", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/3ee457171da21a039a29756f37f66c480a132f3c", "committedDate": "2020-05-10T15:55:59Z", "message": "Merge branch 'master' of https://github.com/JabRef/jabref into feature/backgroundProgress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44d9ca8f0fe2c322d30352a98676851b83649857", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/44d9ca8f0fe2c322d30352a98676851b83649857", "committedDate": "2020-05-11T07:48:06Z", "message": "Quickfix for resizing indicator when indeterminate\n\nSet the pref-width when the indicator is determinate to keep the\nindeterminate state from making the indicator wider."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd2eefd21e6e83b168d324635179b2cca4f18405", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/bd2eefd21e6e83b168d324635179b2cca4f18405", "committedDate": "2020-05-11T07:56:53Z", "message": "Styled dialog waiting for background tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41efc047ee0cb7bb8bdd3389ff384f5d53ca6c8f", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/41efc047ee0cb7bb8bdd3389ff384f5d53ca6c8f", "committedDate": "2020-05-11T08:37:01Z", "message": "Minor style fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MDg0NTYy", "url": "https://github.com/JabRef/jabref/pull/6443#pullrequestreview-409084562", "createdAt": "2020-05-11T11:24:23Z", "commit": {"oid": "41efc047ee0cb7bb8bdd3389ff384f5d53ca6c8f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMToyNDoyM1rOGTYHPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMTo0NDo1N1rOGTYvIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk3MTE5OA==", "bodyText": "The progress indicator is also used at other places. Since this definition here is global, it changes also the style of these other indicators, is this desired? I would guess some of the changes are ok globally (e.g the color) but others like the padding or no percentage are probably specific to the toolbar, right?", "url": "https://github.com/JabRef/jabref/pull/6443#discussion_r422971198", "createdAt": "2020-05-11T11:24:23Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/Base.css", "diffHunk": "@@ -387,6 +387,21 @@\n     -fx-padding: -0.1em 0.5em 0.5em 0.5em;\n }\n \n+.progress-indicator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41efc047ee0cb7bb8bdd3389ff384f5d53ca6c8f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk3MzM1Ng==", "bodyText": "Also add Background Tasks as tooltip (if supported)?", "url": "https://github.com/JabRef/jabref/pull/6443#discussion_r422973356", "createdAt": "2020-05-11T11:28:41Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/JabRefFrame.java", "diffHunk": "@@ -921,6 +940,45 @@ private MenuBar createMenu() {\n         return menu;\n     }\n \n+    private Group createTaskIndicator() {\n+        ProgressIndicator indicator = new ProgressIndicator();\n+        indicator.getStyleClass().setAll(\"progress-indicator\");\n+        indicator.progressProperty().bind(stateManager.tasksProgressBinding);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41efc047ee0cb7bb8bdd3389ff384f5d53ca6c8f"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk3NTEwNA==", "bodyText": "Please make this fields private and add a public getter method (otherwise code from the outside can change these bindings, which is not what we want). (Maybe also remove the suffix \"Binding\" from the name, but that's a matter of taste).", "url": "https://github.com/JabRef/jabref/pull/6443#discussion_r422975104", "createdAt": "2020-05-11T11:32:06Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/StateManager.java", "diffHunk": "@@ -41,6 +45,17 @@\n     private final OptionalObjectProperty<SearchQuery> activeSearchQuery = OptionalObjectProperty.empty();\n     private final ObservableMap<BibDatabaseContext, IntegerProperty> searchResultMap = FXCollections.observableHashMap();\n     private final OptionalObjectProperty<Node> focusOwner = OptionalObjectProperty.empty();\n+    private final ObservableList<Task<?>> backgroundTasks = FXCollections.observableArrayList(taskProperty -> {\n+        return new Observable[] {taskProperty.progressProperty(), taskProperty.runningProperty()};\n+    });\n+\n+    public BooleanBinding anyTaskRunningBinding = Bindings.createBooleanBinding(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41efc047ee0cb7bb8bdd3389ff384f5d53ca6c8f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk3NzMzNg==", "bodyText": "https://github.com/JabRef/jabref/blob/master/src/main/java/org/jabref/gui/DialogService.java#L179 (or the other overload) cannot be used here? I think it would be slightly cleaner to make WaitForBackgroundtasksFinishedDialog a \"real\" dialog (i.e. inherit from Dialog) or even convert it to a proper fxml-based dialog similar to most dialogs.", "url": "https://github.com/JabRef/jabref/pull/6443#discussion_r422977336", "createdAt": "2020-05-11T11:36:43Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/WaitForBackgroundtasksFinishedDialog.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package org.jabref.gui;\n+\n+import java.util.Optional;\n+\n+import javafx.scene.control.Alert;\n+import javafx.scene.control.ButtonType;\n+import javafx.scene.control.DialogPane;\n+import javafx.scene.control.Label;\n+import javafx.scene.layout.Region;\n+import javafx.scene.layout.VBox;\n+\n+import org.jabref.gui.util.BackgroundTask;\n+import org.jabref.gui.util.ThemeLoader;\n+import org.jabref.logic.l10n.Localization;\n+import org.jabref.preferences.JabRefPreferences;\n+\n+import org.controlsfx.control.TaskProgressView;\n+import org.fxmisc.easybind.EasyBind;\n+\n+/**\n+ * Dialog shown when closing of application needs to wait for some background tasks.\n+ */\n+public class WaitForBackgroundtasksFinishedDialog {\n+\n+    private final DialogService dialogService;\n+\n+    public WaitForBackgroundtasksFinishedDialog(DialogService dialogService) {\n+        this.dialogService = dialogService;\n+    }\n+\n+    public boolean showAndWait(StateManager stateManager, ThemeLoader themeLoader, JabRefPreferences preferences) {\n+        TaskProgressView taskProgressView = new TaskProgressView();\n+        EasyBind.listBind(taskProgressView.getTasks(), stateManager.getBackgroundTasks());\n+        taskProgressView.setRetainTasks(false);\n+        taskProgressView.setGraphicFactory(BackgroundTask.iconCallback);\n+\n+        Label message = new Label(Localization.lang(\"Waiting for background tasks to finish. Quit anyway?\"));\n+\n+        VBox box = new VBox(taskProgressView, message);\n+\n+        DialogPane contentPane = new DialogPane();\n+        contentPane.setContent(box);\n+\n+        FXDialog alert = new FXDialog(Alert.AlertType.NONE, Localization.lang(\"Please wait...\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41efc047ee0cb7bb8bdd3389ff384f5d53ca6c8f"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MDQ2OA==", "bodyText": "Why do you prefer a map here instead of adding a new property icon to the BackgroundTask class (so that downloadTask.setIcon(IconTheme.JabRefIcons.DOWNLOAD) works)?", "url": "https://github.com/JabRef/jabref/pull/6443#discussion_r422980468", "createdAt": "2020-05-11T11:42:57Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/util/BackgroundTask.java", "diffHunk": "@@ -27,14 +33,29 @@\n  * @param <V> type of the return value of the task\n  */\n public abstract class BackgroundTask<V> {\n+\n+    public static ImmutableMap<String, Node> iconMap = ImmutableMap.of(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41efc047ee0cb7bb8bdd3389ff384f5d53ca6c8f"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4MTQxMA==", "bodyText": "We try to remove the Globals class. Is it possible to insert the stateManager via a constructor parameter?", "url": "https://github.com/JabRef/jabref/pull/6443#discussion_r422981410", "createdAt": "2020-05-11T11:44:57Z", "author": {"login": "tobiasdiez"}, "path": "src/main/java/org/jabref/gui/util/DefaultTaskExecutor.java", "diffHunk": "@@ -96,7 +97,11 @@ public static void runInJavaFXThread(Runnable runnable) {\n \n     @Override\n     public <V> Future<V> execute(BackgroundTask<V> task) {\n-        return execute(getJavaFXTask(task));\n+        Task<V> javafxTask = getJavaFXTask(task);\n+        if (task.showToUser()) {\n+            Globals.stateManager.addBackgroundTask(javafxTask);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41efc047ee0cb7bb8bdd3389ff384f5d53ca6c8f"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c9ccea66fef2bcc6e68d0fadfdf407b1a0b6262", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/2c9ccea66fef2bcc6e68d0fadfdf407b1a0b6262", "committedDate": "2020-05-11T12:15:20Z", "message": "Removed Globals from DefaultTaskExecutor\n\nAddresses https://github.com/JabRef/jabref/pull/6443#discussion_r422981410"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff9ce0068d6b80e131826a9138aab3b1f981b00e", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/ff9ce0068d6b80e131826a9138aab3b1f981b00e", "committedDate": "2020-05-11T13:21:55Z", "message": "Removed WaitForBackgroundtasksFinishedDialog\n\nMore in line with the other JabRef dialogs\nAddresses https://github.com/JabRef/jabref/pull/6443#discussion_r422977336"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d56138bbb629dcd5ffdad9d29d9c7b87d80ba7c2", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/d56138bbb629dcd5ffdad9d29d9c7b87d80ba7c2", "committedDate": "2020-05-11T13:24:57Z", "message": "Made Bindings in StateManager private\n\nAddresses https://github.com/JabRef/jabref/pull/6443#discussion_r422975104"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf10859542c790e170866698f57a6fc8a704f7df", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/cf10859542c790e170866698f57a6fc8a704f7df", "committedDate": "2020-05-11T13:32:26Z", "message": "Added tooltip to progress indicator\n\nAddresses https://github.com/JabRef/jabref/pull/6443#discussion_r422973356"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcb1d0cc0ec3af744485b4d9321e3a3215c532f1", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/fcb1d0cc0ec3af744485b4d9321e3a3215c532f1", "committedDate": "2020-05-11T13:51:13Z", "message": "Not working: own styleclass for toolbar progress indicator\n\nTries to address https://github.com/JabRef/jabref/pull/6443#discussion_r422971198"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "396411a68cf3a2583cbe367b716d6195f0773cf2", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/396411a68cf3a2583cbe367b716d6195f0773cf2", "committedDate": "2020-05-11T13:59:53Z", "message": "Changed callback to method in BackgroundTask\n\nAddresses https://github.com/JabRef/jabref/pull/6443#discussion_r422980468"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e24c1418564a9304b9c5172573e9edc9d1036a54", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/e24c1418564a9304b9c5172573e9edc9d1036a54", "committedDate": "2020-05-12T06:17:26Z", "message": "Fixed progress-indicator styling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "478ee059e5606251361d663b939284f19bc834e4", "author": {"user": {"login": "tobiasdiez", "name": "Tobias Diez"}}, "url": "https://github.com/JabRef/jabref/commit/478ee059e5606251361d663b939284f19bc834e4", "committedDate": "2020-05-12T07:38:03Z", "message": "Improve getIcon method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5Nzc2MDkw", "url": "https://github.com/JabRef/jabref/pull/6443#pullrequestreview-409776090", "createdAt": "2020-05-12T07:39:03Z", "commit": {"oid": "478ee059e5606251361d663b939284f19bc834e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0557c678a657e6315dcb2c2c1c98d90b45a76e08", "author": {"user": {"login": "tobiasdiez", "name": "Tobias Diez"}}, "url": "https://github.com/JabRef/jabref/commit/0557c678a657e6315dcb2c2c1c98d90b45a76e08", "committedDate": "2020-05-12T07:41:04Z", "message": "Well, I said hopefully ;-)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23b7e6947549c1e44488e72c6a55429f55d63032", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/23b7e6947549c1e44488e72c6a55429f55d63032", "committedDate": "2020-05-12T08:03:21Z", "message": "Revert \"Well, I said hopefully ;-)\"\n\nThis reverts commit 0557c678a657e6315dcb2c2c1c98d90b45a76e08."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3ae7963d447e5fad4dc5af0b27384e63d2b82d1", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/e3ae7963d447e5fad4dc5af0b27384e63d2b82d1", "committedDate": "2020-05-12T08:03:37Z", "message": "Revert \"Improve getIcon method\"\n\nThis reverts commit 478ee059e5606251361d663b939284f19bc834e4."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5OTMzMTMy", "url": "https://github.com/JabRef/jabref/pull/6443#pullrequestreview-409933132", "createdAt": "2020-05-12T11:06:40Z", "commit": {"oid": "e3ae7963d447e5fad4dc5af0b27384e63d2b82d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMTowNjo0MFrOGUBffA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMTowNjo0MFrOGUBffA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY0OTE0OA==", "bodyText": "This looks odd to me", "url": "https://github.com/JabRef/jabref/pull/6443#discussion_r423649148", "createdAt": "2020-05-12T11:06:40Z", "author": {"login": "Siedlerchr"}, "path": "src/main/java/org/jabref/gui/JabRefFrame.java", "diffHunk": "@@ -397,7 +402,22 @@ private void tearDownJabRef(List<String> filenames) {\n      * @return true if the user chose to quit; false otherwise\n      */\n     public boolean quit() {\n-        // First ask if the user really wants to close, if the library has not been saved since last save.\n+        // First ask if the user really wants to close, if there are still background tasks running\n+        /*\n+        It is important to wait for unfinished background tasks before checking if a save-operation is needed, because\n+        the background tasks may make changes themselves that need saving.\n+         */\n+        if (stateManager.getAnyTaskRunning().getValue()) {\n+            if (!(dialogService.showBackgroundProgressDialogAndWait(\n+                    Localization.lang(\"Please wait...\"),\n+                    Localization.lang(\"Waiting for background tasks to finish. Quit anyway?\"),\n+                    stateManager\n+            ).orElse(ButtonType.CANCEL) == ButtonType.YES)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3ae7963d447e5fad4dc5af0b27384e63d2b82d1"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5OTMzOTkw", "url": "https://github.com/JabRef/jabref/pull/6443#pullrequestreview-409933990", "createdAt": "2020-05-12T11:07:58Z", "commit": {"oid": "e3ae7963d447e5fad4dc5af0b27384e63d2b82d1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3db399741b0ce098cd930005870bc745cd719c70", "author": {"user": null}, "url": "https://github.com/JabRef/jabref/commit/3db399741b0ce098cd930005870bc745cd719c70", "committedDate": "2020-05-12T11:24:25Z", "message": "Improved readability in JabRefFrame"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5OTY4Nzkx", "url": "https://github.com/JabRef/jabref/pull/6443#pullrequestreview-409968791", "createdAt": "2020-05-12T12:00:38Z", "commit": {"oid": "3db399741b0ce098cd930005870bc745cd719c70"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 256, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}