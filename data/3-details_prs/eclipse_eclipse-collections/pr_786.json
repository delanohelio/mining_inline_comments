{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNzkxNDU1", "number": 786, "title": "Fix Bug #677 - Optimize removeIf() for UnifiedMap.", "bodyText": "Signed-off-by: Digant Bhavsar digantbhavsar@gmail.com", "createdAt": "2020-01-12T03:50:08Z", "url": "https://github.com/eclipse/eclipse-collections/pull/786", "merged": true, "mergeCommit": {"oid": "7ce7a19722e5471a71a2799737c3c2a0ed5510ff"}, "closed": true, "closedAt": "2020-01-15T14:26:34Z", "author": {"login": "digsb"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5fpHrgFqTM0MTU1MjgzMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb53qw3ABqjI5NDIxNjU2MTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNTUyODMx", "url": "https://github.com/eclipse/eclipse-collections/pull/786#pullrequestreview-341552831", "createdAt": "2020-01-12T04:00:04Z", "commit": {"oid": "68cfb6df25b5627b13b5ac8d2c67abf6c1c140dd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMlQwNDowMDowNFrOFcnyIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMlQwNDowMDowNFrOFcnyIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU1NjI1Ng==", "bodyText": "there is a subtle bug here. It would be good to have a test for it. The bug is this: chIndex is incremented unconditionally, even if the predicate matches. So if we have 3 elements, a, b, and c, if a matches, the chain look likes c, b, but c is no longer put through the predicate because the index will move on.", "url": "https://github.com/eclipse/eclipse-collections/pull/786#discussion_r365556256", "createdAt": "2020-01-12T04:00:04Z", "author": {"login": "mohrezaei"}, "path": "eclipse-collections/src/main/java/org/eclipse/collections/impl/map/mutable/UnifiedMap.java", "diffHunk": "@@ -1038,17 +1038,40 @@ public V removeKey(K key)\n     @Override\n     public boolean removeIf(Predicate2<? super K, ? super V> predicate)\n     {\n-        int previousSize = this.size();\n-        Iterator<Entry<K, V>> iterator = this.entrySet().iterator();\n-        while (iterator.hasNext())\n+        int previousOccupied = this.occupied;\n+        for (int index = 0; index < this.table.length; index += 2)\n         {\n-            Entry<K, V> entry = iterator.next();\n-            if (predicate.accept(entry.getKey(), entry.getValue()))\n+            Object cur = this.table[index];\n+            if (cur == null)\n+            {\n+                continue;\n+            }\n+            if (cur == CHAINED_KEY)\n             {\n-                iterator.remove();\n+                Object[] chain = (Object[]) this.table[index + 1];\n+                for (int chIndex = 0; chIndex < chain.length; chIndex += 2)\n+                {\n+                    K key = this.nonSentinel(chain[chIndex]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68cfb6df25b5627b13b5ac8d2c67abf6c1c140dd"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNTUzMjMx", "url": "https://github.com/eclipse/eclipse-collections/pull/786#pullrequestreview-341553231", "createdAt": "2020-01-12T04:19:23Z", "commit": {"oid": "68cfb6df25b5627b13b5ac8d2c67abf6c1c140dd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMlQwNDoxOToyM1rOFcn0MQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMlQwNDoxOToyM1rOFcn0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU1Njc4NQ==", "bodyText": "also, if chain[chIndex] == null, break the loop immediately.", "url": "https://github.com/eclipse/eclipse-collections/pull/786#discussion_r365556785", "createdAt": "2020-01-12T04:19:23Z", "author": {"login": "mohrezaei"}, "path": "eclipse-collections/src/main/java/org/eclipse/collections/impl/map/mutable/UnifiedMap.java", "diffHunk": "@@ -1038,17 +1038,40 @@ public V removeKey(K key)\n     @Override\n     public boolean removeIf(Predicate2<? super K, ? super V> predicate)\n     {\n-        int previousSize = this.size();\n-        Iterator<Entry<K, V>> iterator = this.entrySet().iterator();\n-        while (iterator.hasNext())\n+        int previousOccupied = this.occupied;\n+        for (int index = 0; index < this.table.length; index += 2)\n         {\n-            Entry<K, V> entry = iterator.next();\n-            if (predicate.accept(entry.getKey(), entry.getValue()))\n+            Object cur = this.table[index];\n+            if (cur == null)\n+            {\n+                continue;\n+            }\n+            if (cur == CHAINED_KEY)\n             {\n-                iterator.remove();\n+                Object[] chain = (Object[]) this.table[index + 1];\n+                for (int chIndex = 0; chIndex < chain.length; chIndex += 2)\n+                {\n+                    K key = this.nonSentinel(chain[chIndex]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68cfb6df25b5627b13b5ac8d2c67abf6c1c140dd"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNTg0ODgx", "url": "https://github.com/eclipse/eclipse-collections/pull/786#pullrequestreview-341584881", "createdAt": "2020-01-12T16:19:23Z", "commit": {"oid": "8a2804b8dcbb7ee496cb6880dd65048d273d8dc2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNTg1MjU0", "url": "https://github.com/eclipse/eclipse-collections/pull/786#pullrequestreview-341585254", "createdAt": "2020-01-12T16:26:26Z", "commit": {"oid": "8a2804b8dcbb7ee496cb6880dd65048d273d8dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMlQxNjoyNjoyNlrOFcqHfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMlQxNjoyNjoyNlrOFcqHfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU5NDQ5Mw==", "bodyText": "I'm curious about occupied vs size(). Is there an advantage to one over the other?", "url": "https://github.com/eclipse/eclipse-collections/pull/786#discussion_r365594493", "createdAt": "2020-01-12T16:26:26Z", "author": {"login": "motlin"}, "path": "eclipse-collections/src/main/java/org/eclipse/collections/impl/map/mutable/UnifiedMap.java", "diffHunk": "@@ -1038,17 +1038,48 @@ public V removeKey(K key)\n     @Override\n     public boolean removeIf(Predicate2<? super K, ? super V> predicate)\n     {\n-        int previousSize = this.size();\n-        Iterator<Entry<K, V>> iterator = this.entrySet().iterator();\n-        while (iterator.hasNext())\n+        int previousOccupied = this.occupied;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a2804b8dcbb7ee496cb6880dd65048d273d8dc2"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1596cfef0f66556cd3740f61722a2fc8c1a57cb8", "author": {"user": {"login": "digsb", "name": null}}, "url": "https://github.com/eclipse/eclipse-collections/commit/1596cfef0f66556cd3740f61722a2fc8c1a57cb8", "committedDate": "2020-01-13T07:59:23Z", "message": "Fix Bug #677 - Optimize removeIf() for UnifiedMap.\n\nSigned-off-by: Digant Bhavsar <digantbhavsar@gmail.com>\n\nFix Bug #677 - Optimize removeIf() for UnifiedMap.\n\nSigned-off-by: Digant Bhavsar <digantbhavsar@gmail.com>\n\nFix Bug #677 - Optimize removeIf() for UnifiedMap.\n\nSigned-off-by: Digant Bhavsar <digantbhavsar@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a2804b8dcbb7ee496cb6880dd65048d273d8dc2", "author": {"user": {"login": "digsb", "name": null}}, "url": "https://github.com/eclipse/eclipse-collections/commit/8a2804b8dcbb7ee496cb6880dd65048d273d8dc2", "committedDate": "2020-01-12T14:40:02Z", "message": "Fix Bug #677 - Optimize removeIf() for UnifiedMap.\n\nSigned-off-by: Digant Bhavsar <digantbhavsar@gmail.com>"}, "afterCommit": {"oid": "1596cfef0f66556cd3740f61722a2fc8c1a57cb8", "author": {"user": {"login": "digsb", "name": null}}, "url": "https://github.com/eclipse/eclipse-collections/commit/1596cfef0f66556cd3740f61722a2fc8c1a57cb8", "committedDate": "2020-01-13T07:59:23Z", "message": "Fix Bug #677 - Optimize removeIf() for UnifiedMap.\n\nSigned-off-by: Digant Bhavsar <digantbhavsar@gmail.com>\n\nFix Bug #677 - Optimize removeIf() for UnifiedMap.\n\nSigned-off-by: Digant Bhavsar <digantbhavsar@gmail.com>\n\nFix Bug #677 - Optimize removeIf() for UnifiedMap.\n\nSigned-off-by: Digant Bhavsar <digantbhavsar@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 759, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}