{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1ODExNTY4", "number": 4551, "title": "Update Rubix version to 0.3.16", "bodyText": "Supersedes #4445\nNew version is a bugfix release. Among other it includes fix for\n#3580", "createdAt": "2020-07-23T16:01:04Z", "url": "https://github.com/trinodb/trino/pull/4551", "merged": true, "mergeCommit": {"oid": "9bc01164ad67510e363fe2d5fec273ca828d2fe0"}, "closed": true, "closedAt": "2020-08-14T13:57:31Z", "author": {"login": "losipiuk"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc376s5AFqTQ1NDYyMDczNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-0QR_ABqjM2NTYxNDQ0MjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NjIwNzM0", "url": "https://github.com/trinodb/trino/pull/4551#pullrequestreview-454620734", "createdAt": "2020-07-24T03:47:02Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzo0NzowMlrOG2iW6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzo1OTo1MlrOG2ifkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgzOTIxMQ==", "bodyText": "Test was looking at request counts earlier, \"Cached_rrc_requests\" would give those here. \"MB_read_from_cache\" might be zero if tests read very small data", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r459839211", "createdAt": "2020-07-24T03:47:02Z", "author": {"login": "shubhamtagra"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -564,7 +564,7 @@ private long getRemoteReadsCount()\n     private long getCachedReadsCount()\n     {\n         try {\n-            return (long) BEAN_SERVER.getAttribute(new ObjectName(\"rubix:name=stats,catalog=catalog\"), \"CachedReads\");\n+            return (long) BEAN_SERVER.getAttribute(new ObjectName(\"rubix:name=stats,catalog=catalog\"), \"MB_read_from_cache\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg0MDgzNw==", "bodyText": "we should use \"Remote_rrc_requests\" + \"Direct_rrc_requests\" instead of dataSize\nAlso, \"MB_read_from_source\" includes data read from source for async mode (via direct-reads size)", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r459840837", "createdAt": "2020-07-24T03:56:19Z", "author": {"login": "shubhamtagra"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -554,7 +552,9 @@ private Path getStoragePath(String path)\n     private long getRemoteReadsCount()\n     {\n         try {\n-            return (long) BEAN_SERVER.getAttribute(new ObjectName(\"rubix:name=stats,catalog=catalog\"), \"RemoteReads\");\n+            long remoteReadsReadThrough = (long) BEAN_SERVER.getAttribute(new ObjectName(\"rubix:name=stats,catalog=catalog\"), \"MB_read_from_source\"); // updated in READ-THROUGH mode", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg0MTIyMg==", "bodyText": "this is fine but existing one would have continued to work", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r459841222", "createdAt": "2020-07-24T03:58:40Z", "author": {"login": "shubhamtagra"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -578,7 +578,7 @@ private long getAsyncDownloadedMb(ReadMode readMode)\n         }\n \n         try {\n-            return (long) BEAN_SERVER.getAttribute(new ObjectName(\"metrics:name=rubix.bookkeeper.count.async_downloaded_mb\"), \"Count\");\n+            return (long) BEAN_SERVER.getAttribute(new ObjectName(\"rubix:name=stats,type=detailed,catalog=catalog\"), \"BKS_data_downloaded_in_parallel_warmup\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg0MTQyNQ==", "bodyText": "here too requestCounts are now replaced by dataSizes", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r459841425", "createdAt": "2020-07-24T03:59:52Z", "author": {"login": "shubhamtagra"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCaching.java", "diffHunk": "@@ -121,8 +136,11 @@ private void testReadFromTable(String tableNameSuffix)\n \n     private QueryResult getCacheStats()\n     {\n-        return query(\"SELECT sum(cachedreads) as cachedreads, sum(remotereads) as remotereads, sum(nonlocalreads) as nonlocalreads FROM \" +\n-                \"jmx.current.\\\"rubix:catalog=hive,name=stats\\\"\");\n+        return query(\"SELECT \" +\n+                \"  sum(mb_read_from_cache) as cachedreads, \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 43}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NzA3NDc5", "url": "https://github.com/trinodb/trino/pull/4551#pullrequestreview-454707479", "createdAt": "2020-07-24T08:15:37Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwODoxNTozN1rOG2m36Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwODoxNTozN1rOG2m36Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkxMzE5Mw==", "bodyText": "I think we would get empty QueryResult for stats when FS is not yet initialised. We could handle that case and return 0 from getRemoteReads and other methods to avoid running queries to warmup.", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r459913193", "createdAt": "2020-07-24T08:15:37Z", "author": {"login": "shubhamtagra"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCaching.java", "diffHunk": "@@ -95,6 +98,18 @@ private void testReadFromTable(String tableNameSuffix)\n         query(\"DROP TABLE \" + nonCachedTableName);\n     }\n \n+    private void initializeRubixStats()\n+    {\n+        // TODO this is needed for now because Rubix JMX statistis are only registered lazily", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NjIxMDI3", "url": "https://github.com/trinodb/trino/pull/4551#pullrequestreview-455621027", "createdAt": "2020-07-27T09:29:12Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwOToyOToxMlrOG3ayLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwOToyOToxMlrOG3ayLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc2MzY5NQ==", "bodyText": "This can lead to imx query failures as DummyBookKeeper is used when hive.cache.start-server-on-coordinator=false which is the default value. Better return an empty map here.", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r460763695", "createdAt": "2020-07-27T09:29:12Z", "author": {"login": "shubhamtagra"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/DummyBookKeeper.java", "diffHunk": "@@ -44,7 +45,14 @@ public void setAllCached(String remotePath, long fileLength, long lastModified,\n     }\n \n     @Override\n-    public boolean readData(String remotePath, long offset, int length, long fileSize, long lastModified, int clusterType)\n+    public Map<String, Long> getReadRequestChainStats()\n+            throws TException\n+    {\n+        throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTk2NzI5", "url": "https://github.com/trinodb/trino/pull/4551#pullrequestreview-467196729", "createdAt": "2020-08-13T23:32:42Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3Mjg4MzM1", "url": "https://github.com/trinodb/trino/pull/4551#pullrequestreview-467288335", "createdAt": "2020-08-14T03:43:56Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "8365af12cd59b9d4f7c6d227ef27a657f4ad0678", "author": {"user": {"login": "losipiuk", "name": "\u0141ukasz Osipiuk"}}, "url": "https://github.com/trinodb/trino/commit/8365af12cd59b9d4f7c6d227ef27a657f4ad0678", "committedDate": "2020-08-14T13:02:04Z", "message": "Update Rubix version to 0.3.16\n\nNew version is a bugfix release. Among other it includes fix for\nhttps://github.com/prestosql/presto/issues/3580"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "8365af12cd59b9d4f7c6d227ef27a657f4ad0678", "author": {"user": {"login": "losipiuk", "name": "\u0141ukasz Osipiuk"}}, "url": "https://github.com/trinodb/trino/commit/8365af12cd59b9d4f7c6d227ef27a657f4ad0678", "committedDate": "2020-08-14T13:02:04Z", "message": "Update Rubix version to 0.3.16\n\nNew version is a bugfix release. Among other it includes fix for\nhttps://github.com/prestosql/presto/issues/3580"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4848, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}