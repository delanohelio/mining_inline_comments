{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0OTc1NTc0", "number": 2560, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwOTo1ODoxNFrODZbuRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQyMToxNDoyMVrODePMoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTk1MjA0OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/PushAggregationThroughOuterJoin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwOTo1ODoxNFrOFf0MIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwOTo1ODoxNFrOFf0MIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkwNTI0OA==", "bodyText": "is using symbols name is confusing. It seems that if any symbol from source is being used, this method should return true. Please use different name, e.g\nisAggregationOnSymbols", "url": "https://github.com/trinodb/trino/pull/2560#discussion_r368905248", "createdAt": "2020-01-21T09:58:14Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/PushAggregationThroughOuterJoin.java", "diffHunk": "@@ -328,15 +321,14 @@ private static boolean groupsOnAllColumns(AggregationNode node, List<Symbol> col\n                 Optional.empty(),\n                 Optional.empty());\n \n-        return Optional.of(new MappedAggregationInfo(aggregationOverNullRow, aggregationsSymbolMapping));\n+        return new MappedAggregationInfo(aggregationOverNullRow, aggregationsSymbolMapping);\n     }\n \n-    private static boolean isUsingSymbols(AggregationNode.Aggregation aggregation, Set<Symbol> sourceSymbols)\n+    private static boolean isUsingSymbols(AggregationNode aggregationNode, PlanNode source)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTk1NjI4OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/PushAggregationThroughOuterJoin.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwOTo1OTozM1rOFf0OrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMTowMTowOVrOFf2FLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkwNTkwMQ==", "bodyText": "We want all aggregations to be from outer side exclusively, no?\nShouldn't this be:\n!isUsingSymbols(aggregation, getOuterTable(join))\n\n?\nAlso, didn't previous code deal with mixed aggregations?", "url": "https://github.com/trinodb/trino/pull/2560#discussion_r368905901", "createdAt": "2020-01-21T09:59:33Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/PushAggregationThroughOuterJoin.java", "diffHunk": "@@ -120,7 +122,8 @@ public Result apply(AggregationNode aggregation, Captures captures, Context cont\n         if (join.getFilter().isPresent()\n                 || !(join.getType() == JoinNode.Type.LEFT || join.getType() == JoinNode.Type.RIGHT)\n                 || !groupsOnAllColumns(aggregation, getOuterTable(join).getOutputSymbols())\n-                || !isDistinct(context.getLookup().resolve(getOuterTable(join)), context.getLookup()::resolve)) {\n+                || !isDistinct(context.getLookup().resolve(getOuterTable(join)), context.getLookup()::resolve)\n+                || !isUsingSymbols(aggregation, getInnerTable(join))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkzNDY1NQ==", "bodyText": "We want all aggregations to be from outer side exclusively, no?\n\nI'm not sure if the naming here is correct. I just followed the convention. It says \"inner table\" when referring to the right table of LEFT join.\nWe want to push the AggregationNode into the right source of LEFT join or into the left source of RIGHT join.\n\nAlso, didn't previous code deal with mixed aggregations?\n\nIt seemed so, because it only required that some of the Aggregation symbols matched the source. But it failed on mixed aggregations (vide the test cases I added).\nThis PR is just a fix. Further we could extend the rule to remap Aggregations by equi-clauses before pushdown.", "url": "https://github.com/trinodb/trino/pull/2560#discussion_r368934655", "createdAt": "2020-01-21T10:57:44Z", "author": {"login": "kasiafi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/PushAggregationThroughOuterJoin.java", "diffHunk": "@@ -120,7 +122,8 @@ public Result apply(AggregationNode aggregation, Captures captures, Context cont\n         if (join.getFilter().isPresent()\n                 || !(join.getType() == JoinNode.Type.LEFT || join.getType() == JoinNode.Type.RIGHT)\n                 || !groupsOnAllColumns(aggregation, getOuterTable(join).getOutputSymbols())\n-                || !isDistinct(context.getLookup().resolve(getOuterTable(join)), context.getLookup()::resolve)) {\n+                || !isDistinct(context.getLookup().resolve(getOuterTable(join)), context.getLookup()::resolve)\n+                || !isUsingSymbols(aggregation, getInnerTable(join))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkwNTkwMQ=="}, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkzNjIzNg==", "bodyText": "I'm not sure if the naming here is correct. I just followed the convention. It says \"inner table\" when referring to the right table of LEFT join.\n\nRight, I confused the names. Thanks", "url": "https://github.com/trinodb/trino/pull/2560#discussion_r368936236", "createdAt": "2020-01-21T11:01:09Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/PushAggregationThroughOuterJoin.java", "diffHunk": "@@ -120,7 +122,8 @@ public Result apply(AggregationNode aggregation, Captures captures, Context cont\n         if (join.getFilter().isPresent()\n                 || !(join.getType() == JoinNode.Type.LEFT || join.getType() == JoinNode.Type.RIGHT)\n                 || !groupsOnAllColumns(aggregation, getOuterTable(join).getOutputSymbols())\n-                || !isDistinct(context.getLookup().resolve(getOuterTable(join)), context.getLookup()::resolve)) {\n+                || !isDistinct(context.getLookup().resolve(getOuterTable(join)), context.getLookup()::resolve)\n+                || !isUsingSymbols(aggregation, getInnerTable(join))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkwNTkwMQ=="}, "originalCommit": null, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMDMyNTUyOnYy", "diffSide": "RIGHT", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestAggregations.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQyMTowNjo0M1rOFnSC-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQyMTowNjo0M1rOFnSC-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjczNDQ1Nw==", "bodyText": "this query passes before the change\nnit: stuttered space", "url": "https://github.com/trinodb/trino/pull/2560#discussion_r376734457", "createdAt": "2020-02-08T21:06:43Z", "author": {"login": "findepi"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestAggregations.java", "diffHunk": "@@ -89,6 +89,32 @@ public void testAggregationPushdownThroughOuterJoinNotFiringInCorrelatedAggregat\n                 \"VALUES 1\");\n     }\n \n+    /**\n+     * This case tests that Aggregation isn't incorrectly pushed down into inner source of JoinNode\n+     * in the case when it uses symbols from the outer source of JoinNode.\n+     */\n+    @Test\n+    public void testAggregationUsingOuterTableSymbols()\n+    {\n+        assertQuery(\n+                \"SELECT max(r.regionkey * n.nationkey) FROM (SELECT DISTINCT regionkey FROM region) r LEFT JOIN nation n ON n.regionkey = r.regionkey  GROUP BY r.regionkey\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMDMyNjExOnYy", "diffSide": "RIGHT", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestAggregations.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQyMTowODozNlrOFnSDTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQyMTowODozNlrOFnSDTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjczNDU0MQ==", "bodyText": "This test creates necessary circumstances for the count(*) to be pushed down, but doesn't test it's being pushed. I think some explanation is useful, so do not remove. Reword.", "url": "https://github.com/trinodb/trino/pull/2560#discussion_r376734541", "createdAt": "2020-02-08T21:08:36Z", "author": {"login": "findepi"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestAggregations.java", "diffHunk": "@@ -89,6 +89,32 @@ public void testAggregationPushdownThroughOuterJoinNotFiringInCorrelatedAggregat\n                 \"VALUES 1\");\n     }\n \n+    /**\n+     * This case tests that Aggregation isn't incorrectly pushed down into inner source of JoinNode\n+     * in the case when it uses symbols from the outer source of JoinNode.\n+     */\n+    @Test\n+    public void testAggregationUsingOuterTableSymbols()\n+    {\n+        assertQuery(\n+                \"SELECT max(r.regionkey * n.nationkey) FROM (SELECT DISTINCT regionkey FROM region) r LEFT JOIN nation n ON n.regionkey = r.regionkey  GROUP BY r.regionkey\",\n+                \"VALUES 0, 24, 42, 69, 80\");\n+    }\n+\n+    /**\n+     * This case tests that Aggregation count(*) can be successfully pushed down into inner source of JoinNode.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMDMyODY1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/PushAggregationThroughOuterJoin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQyMToxNDoyMVrOFnSEkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQyMToxNDoyMVrOFnSEkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjczNDg2NQ==", "bodyText": "If the aggregation has a hash symbol, it probably comes from the join's outer table (since aggregation is on outer table's outputs). But then, it's an additional output symbol and not grouping key of the aggregation, so the groupsOnAllColumns cannot be satisfied.\nI think this rule doesn't have -- and doesn't have to have -- ambitions to handle hash symbols.\nIt's enough if it detects this situation and bails out.", "url": "https://github.com/trinodb/trino/pull/2560#discussion_r376734865", "createdAt": "2020-02-08T21:14:21Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/PushAggregationThroughOuterJoin.java", "diffHunk": "@@ -140,6 +140,11 @@ public Result apply(AggregationNode aggregation, Captures captures, Context cont\n                 aggregation.getHashSymbol(),\n                 aggregation.getGroupIdSymbol());\n \n+        ImmutableList.Builder<Symbol> outputSymbols = ImmutableList.<Symbol>builder()\n+                .addAll(getOuterTable(join).getOutputSymbols());\n+        aggregation.getHashSymbol().ifPresent(outputSymbols::add);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1055, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}