{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzODkwMjk4", "number": 6016, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMjoyOToxN1rOE7BmWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNDo1Nzo0MlrOE7GAeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMzI3NjQyOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/ApplyTableScanRedirection.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMjoyOToxN1rOH2bi4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNDo1Mzo1MVrOH2iZrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzNjQ1MQ==", "bodyText": "Would here be a need in the future to support coercions? the type sets supported by connectors are not the same", "url": "https://github.com/trinodb/trino/pull/6016#discussion_r526836451", "createdAt": "2020-11-19T12:29:17Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/ApplyTableScanRedirection.java", "diffHunk": "@@ -97,6 +98,16 @@ public Result apply(TableScanNode scanNode, Captures captures, Context context)\n                     if (destinationColumnHandle == null) {\n                         throw new PrestoException(COLUMN_NOT_FOUND, format(\"Did not find handle for column %s in destination table %s\", destinationColumn, destinationTable));\n                     }\n+\n+                    // validate that redirected types match source types\n+                    Type sourceType = context.getSymbolAllocator().getTypes().get(entry.getKey());\n+                    Type redirectedType = metadata.getColumnMetadata(context.getSession(), destinationTableHandle.get(), destinationColumnHandle).getType();\n+                    if (!sourceType.equals(redirectedType)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkyNjg2Mg==", "bodyText": "If your target catalog is Hive, then I don't think coercions would be needed as Hive supports most (all?) of Presto types with ORC format. For other targets, some coercion might be needed.", "url": "https://github.com/trinodb/trino/pull/6016#discussion_r526926862", "createdAt": "2020-11-19T14:25:36Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/ApplyTableScanRedirection.java", "diffHunk": "@@ -97,6 +98,16 @@ public Result apply(TableScanNode scanNode, Captures captures, Context context)\n                     if (destinationColumnHandle == null) {\n                         throw new PrestoException(COLUMN_NOT_FOUND, format(\"Did not find handle for column %s in destination table %s\", destinationColumn, destinationTable));\n                     }\n+\n+                    // validate that redirected types match source types\n+                    Type sourceType = context.getSymbolAllocator().getTypes().get(entry.getKey());\n+                    Type redirectedType = metadata.getColumnMetadata(context.getSession(), destinationTableHandle.get(), destinationColumnHandle).getType();\n+                    if (!sourceType.equals(redirectedType)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzNjQ1MQ=="}, "originalCommit": null, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk0ODc4MA==", "bodyText": "Hive supports most (all?) of Presto types with ORC format\n\neg timestamp with time zone or json are not supported", "url": "https://github.com/trinodb/trino/pull/6016#discussion_r526948780", "createdAt": "2020-11-19T14:53:51Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/ApplyTableScanRedirection.java", "diffHunk": "@@ -97,6 +98,16 @@ public Result apply(TableScanNode scanNode, Captures captures, Context context)\n                     if (destinationColumnHandle == null) {\n                         throw new PrestoException(COLUMN_NOT_FOUND, format(\"Did not find handle for column %s in destination table %s\", destinationColumn, destinationTable));\n                     }\n+\n+                    // validate that redirected types match source types\n+                    Type sourceType = context.getSymbolAllocator().getTypes().get(entry.getKey());\n+                    Type redirectedType = metadata.getColumnMetadata(context.getSession(), destinationTableHandle.get(), destinationColumnHandle).getType();\n+                    if (!sourceType.equals(redirectedType)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzNjQ1MQ=="}, "originalCommit": null, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMzI3NzM1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/ApplyTableScanRedirection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMjoyOToyOVrOH2bjbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNDo1ODoyMlrOH2iojw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzNjU4OQ==", "bodyText": "incluide source column handle as well?", "url": "https://github.com/trinodb/trino/pull/6016#discussion_r526836589", "createdAt": "2020-11-19T12:29:29Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/ApplyTableScanRedirection.java", "diffHunk": "@@ -97,6 +98,16 @@ public Result apply(TableScanNode scanNode, Captures captures, Context context)\n                     if (destinationColumnHandle == null) {\n                         throw new PrestoException(COLUMN_NOT_FOUND, format(\"Did not find handle for column %s in destination table %s\", destinationColumn, destinationTable));\n                     }\n+\n+                    // validate that redirected types match source types\n+                    Type sourceType = context.getSymbolAllocator().getTypes().get(entry.getKey());\n+                    Type redirectedType = metadata.getColumnMetadata(context.getSession(), destinationTableHandle.get(), destinationColumnHandle).getType();\n+                    if (!sourceType.equals(redirectedType)) {\n+                        throw new PrestoException(\n+                                TYPE_MISMATCH,\n+                                format(\"Redirected type (%s) for column %s does not match source type (%s)\", redirectedType, destinationColumn, sourceType));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk1MjU5MQ==", "bodyText": "Please also mention source and target table. If a query uses multiple tables, knowing which one caused problems may be helpful.", "url": "https://github.com/trinodb/trino/pull/6016#discussion_r526952591", "createdAt": "2020-11-19T14:58:22Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/ApplyTableScanRedirection.java", "diffHunk": "@@ -97,6 +98,16 @@ public Result apply(TableScanNode scanNode, Captures captures, Context context)\n                     if (destinationColumnHandle == null) {\n                         throw new PrestoException(COLUMN_NOT_FOUND, format(\"Did not find handle for column %s in destination table %s\", destinationColumn, destinationTable));\n                     }\n+\n+                    // validate that redirected types match source types\n+                    Type sourceType = context.getSymbolAllocator().getTypes().get(entry.getKey());\n+                    Type redirectedType = metadata.getColumnMetadata(context.getSession(), destinationTableHandle.get(), destinationColumnHandle).getType();\n+                    if (!sourceType.equals(redirectedType)) {\n+                        throw new PrestoException(\n+                                TYPE_MISMATCH,\n+                                format(\"Redirected type (%s) for column %s does not match source type (%s)\", redirectedType, destinationColumn, sourceType));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzNjU4OQ=="}, "originalCommit": null, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMzk5ODY0OnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/sql/planner/iterative/rule/TestApplyTableScanRedirection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNDo1Nzo0MlrOH2imSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNDo1Nzo0MlrOH2imSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk1MjAxMA==", "bodyText": "Rule tested is not really leveraged much here, because we're not testing the rule application, but rather a failure internally.\nMaybe it would make sense to add .fails(Consumer<Exception> exceptionAssertion) method to Rule tester, next to matches()?\nAltenratively, maybe you do not need rule tester at all, you can just run a query on the query runner after all.", "url": "https://github.com/trinodb/trino/pull/6016#discussion_r526952010", "createdAt": "2020-11-19T14:57:42Z", "author": {"login": "findepi"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/iterative/rule/TestApplyTableScanRedirection.java", "diffHunk": "@@ -116,6 +119,29 @@ public void doesNotFireIfNoTableScan()\n         }\n     }\n \n+    @Test(expectedExceptions = PrestoException.class, expectedExceptionsMessageRegExp = \"Redirected type \\\\(bigint\\\\) for column destination_col_c does not match source type \\\\(varchar\\\\)\")\n+    public void testMismatchedTypes()\n+    {\n+        try (RuleTester ruleTester = defaultRuleTester()) {\n+            // make the mock connector return a table scan on different table\n+            ApplyTableScanRedirect applyTableScanRedirect = getMockApplyRedirect(\n+                    ImmutableMap.of(sourceColumnHandleA, destinationColumnNameC));\n+            MockConnectorFactory mockFactory = createMockFactory(Optional.of(applyTableScanRedirect));\n+\n+            ruleTester.getQueryRunner().createCatalog(MOCK_CATALOG, mockFactory, ImmutableMap.of());\n+\n+            ruleTester.assertThat(new ApplyTableScanRedirection(ruleTester.getMetadata()))\n+                    .on(p -> {\n+                        Symbol column = p.symbol(sourceColumnNameA, VARCHAR);\n+                        return p.tableScan(TEST_TABLE_HANDLE,\n+                                ImmutableList.of(column),\n+                                ImmutableMap.of(column, sourceColumnHandleA));\n+                    })\n+                    .withSession(MOCK_SESSION)\n+                    .matches(anyTree());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 74}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4830, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}