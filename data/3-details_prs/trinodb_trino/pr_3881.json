{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1MTg4MDM5", "number": 3881, "title": "Aggregation pushdown in PostgreSQL, base-jdbc", "bodyText": "", "createdAt": "2020-05-29T15:57:46Z", "url": "https://github.com/trinodb/trino/pull/3881", "merged": true, "mergeCommit": {"oid": "b52bcd71d4a3fc17fcb74eb3aa1bd291b4111128"}, "closed": true, "closedAt": "2020-06-21T19:45:17Z", "author": {"login": "findepi"}, "timelineItems": {"totalCount": 37, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcmJJajABqjMzODg4NTc3OTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABctN7dRgBqjM0NjQ5OTE5Njg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMTQ5MDMw", "url": "https://github.com/trinodb/trino/pull/3881#pullrequestreview-432149030", "createdAt": "2020-06-17T07:56:08Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNzo1NjowOFrOGk6EwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwODoxNzowOFrOGk62PA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1MzQwOA==", "bodyText": "out of scope: Surely, we need a builder for JdbcTableHandle", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r441353408", "createdAt": "2020-06-17T07:56:08Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -142,9 +142,9 @@ public JdbcTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n                         handle.getCatalogName(),\n                         handle.getSchemaName(),\n                         handle.getTableName(),\n-                        Optional.of(newColumns),\n                         handle.getConstraint(),\n-                        handle.getLimit()),\n+                        handle.getLimit(),\n+                        Optional.of(newColumns)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1NDEwMQ==", "bodyText": "copyright", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r441354101", "createdAt": "2020-06-17T07:57:07Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestingH2JdbcClient.java", "diffHunk": "@@ -0,0 +1,10 @@\n+package io.prestosql.plugin.jdbc;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1NDc0Mg==", "bodyText": "I suggest to you to extract all other commits as separate pull request so we could merge them faster.", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r441354742", "createdAt": "2020-06-17T07:58:16Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/pom.xml", "diffHunk": "@@ -22,6 +22,11 @@\n             <artifactId>presto-plugin-toolkit</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1NTEyMQ==", "bodyText": "\u2764\ufe0f", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r441355121", "createdAt": "2020-06-17T07:58:55Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/pom.xml", "diffHunk": "@@ -22,6 +22,11 @@\n             <artifactId>presto-plugin-toolkit</artifactId>\n         </dependency>\n \n+        <dependency>\n+            <groupId>io.prestosql</groupId>\n+            <artifactId>presto-matching</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1NTc4MQ==", "bodyText": "nit: Why you placed it as first? To me it should be second.", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r441355781", "createdAt": "2020-06-17T07:59:57Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcColumnHandle.java", "diffHunk": "@@ -56,19 +58,27 @@ public JdbcColumnHandle(String columnName, JdbcTypeHandle jdbcTypeHandle, Type c\n     @Deprecated\n     @JsonCreator\n     public JdbcColumnHandle(\n+            @JsonProperty(\"expression\") Optional<String> expression,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1NjQwNQ==", "bodyText": "remove", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r441356405", "createdAt": "2020-06-17T08:00:57Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcExpression.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.jdbc;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static java.util.Objects.requireNonNull;\n+\n+public final class JdbcExpression\n+{\n+    private final String expression;\n+    private final JdbcTypeHandle jdbcTypeHandle;\n+//    private final Type prestoType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1NzQwNg==", "bodyText": "Just JdbcSessionProperties?", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r441357406", "createdAt": "2020-06-17T08:02:40Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadataSessionProperties.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.jdbc;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.session.PropertyMetadata;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+\n+import static io.prestosql.spi.session.PropertyMetadata.booleanProperty;\n+\n+public class JdbcMetadataSessionProperties", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2MTMxNQ==", "bodyText": "This could be handled differently in different sql engines", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r441361315", "createdAt": "2020-06-17T08:09:38Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/QueryBuilder.java", "diffHunk": "@@ -285,6 +282,33 @@ private String toPredicate(String columnName, String operator, Object value, Jdb\n         return quote(columnName) + \" \" + operator + \" ?\";\n     }\n \n+    private String getGroupBy(Optional<List<List<JdbcColumnHandle>>> groupingSets)\n+    {\n+        if (groupingSets.isEmpty()) {\n+            return \"\";\n+        }\n+\n+        verify(!groupingSets.get().isEmpty());\n+        if (groupingSets.get().size() == 1) {\n+            List<JdbcColumnHandle> groupingSet = getOnlyElement(groupingSets.get());\n+            if (groupingSet.isEmpty()) {\n+                // global aggregation\n+                return \"\";\n+            }\n+            return \" GROUP BY \" + groupingSet.stream()\n+                    .map(JdbcColumnHandle::getColumnName)\n+                    .map(this::quote)\n+                    .collect(joining(\", \"));\n+        }\n+        return \" GROUP BY GROUPING SETS \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2MTgxNg==", "bodyText": "it would be nice to have unit tests for this class that would test SQL string generation.", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r441361816", "createdAt": "2020-06-17T08:10:24Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/QueryBuilder.java", "diffHunk": "@@ -285,6 +282,33 @@ private String toPredicate(String columnName, String operator, Object value, Jdb\n         return quote(columnName) + \" \" + operator + \" ?\";\n     }\n \n+    private String getGroupBy(Optional<List<List<JdbcColumnHandle>>> groupingSets)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2MzExNQ==", "bodyText": "AvgFloatingPointAggregateFunctionRule?", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r441363115", "createdAt": "2020-06-17T08:12:07Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/expression/ImplementAvgFloatingPoint.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.jdbc.expression;\n+\n+import io.prestosql.matching.Capture;\n+import io.prestosql.matching.Captures;\n+import io.prestosql.matching.Pattern;\n+import io.prestosql.plugin.jdbc.JdbcColumnHandle;\n+import io.prestosql.plugin.jdbc.JdbcExpression;\n+import io.prestosql.spi.connector.AggregateFunction;\n+import io.prestosql.spi.expression.Variable;\n+\n+import java.util.Optional;\n+\n+import static com.google.common.base.Verify.verify;\n+import static com.google.common.base.Verify.verifyNotNull;\n+import static io.prestosql.matching.Capture.newCapture;\n+import static io.prestosql.plugin.jdbc.expression.AggregateFunctionPatterns.basicAggregation;\n+import static io.prestosql.plugin.jdbc.expression.AggregateFunctionPatterns.expressionType;\n+import static io.prestosql.plugin.jdbc.expression.AggregateFunctionPatterns.functionName;\n+import static io.prestosql.plugin.jdbc.expression.AggregateFunctionPatterns.singleInput;\n+import static io.prestosql.plugin.jdbc.expression.AggregateFunctionPatterns.variable;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.RealType.REAL;\n+import static java.lang.String.format;\n+\n+/**\n+ * Implements {@code avg(float)}\n+ */\n+public class ImplementAvgFloatingPoint", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2MzkxMw==", "bodyText": "shoudn't this be a default behaviour?", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r441363913", "createdAt": "2020-06-17T08:13:27Z", "author": {"login": "kokosing"}, "path": "presto-phoenix/src/main/java/io/prestosql/plugin/phoenix/PhoenixMetadata.java", "diffHunk": "@@ -391,4 +393,16 @@ private JdbcOutputTableHandle createTable(ConnectorSession session, ConnectorTab\n             throw new PrestoException(PHOENIX_METADATA_ERROR, \"Error creating Phoenix table\", e);\n         }\n     }\n+\n+    @Override\n+    public Optional<AggregationApplicationResult<ConnectorTableHandle>> applyAggregation(\n+            ConnectorSession session,\n+            ConnectorTableHandle table,\n+            List<AggregateFunction> aggregates,\n+            Map<String, ColumnHandle> assignments,\n+            List<List<ColumnHandle>> groupBy)\n+    {\n+        // TODO support aggregation pushdown\n+        return Optional.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2NDk0OQ==", "bodyText": "Also we need some smoke tests for aggregation push down added to base jdbc smoke test that could be reused by other connectors. Such test should handle aggregration rewrites that are implemented in base-jdbc module.", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r441364949", "createdAt": "2020-06-17T08:15:12Z", "author": {"login": "kokosing"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlIntegrationSmokeTest.java", "diffHunk": "@@ -288,6 +288,34 @@ public void testInsertIntoNotNullColumn()\n         assertUpdate(\"DROP TABLE test_insert_not_null\");\n     }\n \n+    @Test\n+    public void testAggregationPushdown()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2NTIyNw==", "bodyText": "put table name to separate line", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r441365227", "createdAt": "2020-06-17T08:15:39Z", "author": {"login": "kokosing"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlIntegrationSmokeTest.java", "diffHunk": "@@ -288,6 +288,34 @@ public void testInsertIntoNotNullColumn()\n         assertUpdate(\"DROP TABLE test_insert_not_null\");\n     }\n \n+    @Test\n+    public void testAggregationPushdown()\n+            throws Exception\n+    {\n+        // TODO support aggregation pushdown with GROUPING SETS\n+        // TODO support aggregation over expressions\n+\n+        assertPushedDown(\"SELECT count(*) FROM nation\");\n+        assertPushedDown(\"SELECT count(nationkey) FROM nation\");\n+        assertPushedDown(\"SELECT regionkey, min(nationkey) FROM nation GROUP BY regionkey\");\n+        assertPushedDown(\"SELECT regionkey, max(nationkey) FROM nation GROUP BY regionkey\");\n+        assertPushedDown(\"SELECT regionkey, sum(nationkey) FROM nation GROUP BY regionkey\");\n+        assertPushedDown(\n+                \"SELECT regionkey, avg(nationkey) FROM nation GROUP BY regionkey\",\n+                \"SELECT regionkey, avg(CAST(nationkey AS double)) FROM nation GROUP BY regionkey\");\n+\n+        try (AutoCloseable ignoreTable = withTable(\"tpch.test_aggregation_pushdown\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2NjA3Ng==", "bodyText": "don't you need to assert here what was pushed down?", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r441366076", "createdAt": "2020-06-17T08:17:08Z", "author": {"login": "kokosing"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestIntegrationSmokeTest.java", "diffHunk": "@@ -372,4 +412,27 @@ public void testSelectInformationSchemaColumns()\n         assertQuerySucceeds(\"SELECT * FROM information_schema.columns WHERE table_catalog = '\" + catalog + \"' AND table_name LIKE '%'\");\n         assertQuery(\"SELECT column_name FROM information_schema.columns WHERE table_catalog = 'something_else'\", \"SELECT '' WHERE false\");\n     }\n+\n+    protected void assertPushedDown(String sql)\n+    {\n+        assertPushedDown(sql, sql);\n+    }\n+\n+    protected void assertPushedDown(String actual, String expectedOnH2)\n+    {\n+        assertQuery(actual, expectedOnH2);\n+\n+        transaction(getQueryRunner().getTransactionManager(), getQueryRunner().getAccessControl())\n+                .execute(getSession(), session -> {\n+                    Plan plan = getQueryRunner().createPlan(session, actual, WarningCollector.NOOP);\n+                    assertPlan(\n+                            session,\n+                            getQueryRunner().getMetadata(),\n+                            (node, sourceStats, lookup, ignore, types) -> PlanNodeStatsEstimate.unknown(),\n+                            plan,\n+                            PlanMatchPattern.output(\n+                                    PlanMatchPattern.exchange(\n+                                            PlanMatchPattern.node(TableScanNode.class))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 116}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMDk5Njk3", "url": "https://github.com/trinodb/trino/pull/3881#pullrequestreview-433099697", "createdAt": "2020-06-18T09:22:47Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwOToyMjo0N1rOGlnE_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwOToyODo0NFrOGlnTTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5MDc0OQ==", "bodyText": "remove?", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r442090749", "createdAt": "2020-06-18T09:22:47Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -154,6 +169,97 @@ public JdbcTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n                         .collect(toImmutableList())));\n     }\n \n+    @Override\n+    public Optional<AggregationApplicationResult<ConnectorTableHandle>> applyAggregation(\n+            ConnectorSession session,\n+            ConnectorTableHandle table,\n+            List<AggregateFunction> aggregates,\n+            Map<String, ColumnHandle> assignments,\n+            List<List<ColumnHandle>> groupBy) // TODO rename groupingSets? https://github.com/prestosql/presto/pull/3697#discussion_r429874769\n+    {\n+        if (!isAllowAggregationPushdown(session)) {\n+            return Optional.empty();\n+        }\n+\n+        JdbcTableHandle handle = (JdbcTableHandle) table;\n+\n+        if (handle.getLimit().isPresent()) {\n+            // handle's limit is applied after aggregations, so we cannot apply aggregations if limit is already set\n+            return Optional.empty();\n+        }\n+\n+        if (handle.getGroupingSets().isPresent()) {\n+            // table handle cannot express aggregation on top of aggregation\n+            return Optional.empty();\n+        }\n+\n+        if (groupBy.isEmpty()) {\n+            // TODO illicit, https://github.com/prestosql/presto/pull/3697#discussion_r429866335\n+            groupBy = List.of(List.of());\n+        }\n+\n+        if (groupBy.size() > 1 && !jdbcClient.supportsGroupingSets()) {\n+            return Optional.empty();\n+        }\n+\n+        List<JdbcColumnHandle> columns = jdbcClient.getColumns(session, handle);\n+        Map<String, JdbcColumnHandle> columnByName = columns.stream()\n+                .collect(toImmutableMap(JdbcColumnHandle::getColumnName, identity()));\n+\n+        int syntheticNextIdentifier = 1;\n+\n+        ImmutableList.Builder<JdbcColumnHandle> newColumns = ImmutableList.builder();\n+        ImmutableList.Builder<ConnectorExpression> projections = ImmutableList.builder();\n+        ImmutableList.Builder<Assignment> resultAssignments = ImmutableList.builder();\n+        for (AggregateFunction aggregate : aggregates) {\n+            Optional<JdbcExpression> expression = jdbcClient.implementAggregation(aggregate, assignments);\n+            if (expression.isEmpty()) {\n+                return Optional.empty();\n+            }\n+\n+            while (columnByName.containsKey(SYNTHETIC_COLUMN_NAME_PREFIX + syntheticNextIdentifier)) {\n+                syntheticNextIdentifier++;\n+            }\n+\n+            JdbcColumnHandle newColumn = JdbcColumnHandle.builder()\n+                    .setExpression(Optional.of(expression.get().getExpression()))\n+                    .setColumnName(SYNTHETIC_COLUMN_NAME_PREFIX + syntheticNextIdentifier)\n+                    .setJdbcTypeHandle(expression.get().getJdbcTypeHandle())\n+                    .setColumnType(aggregate.getOutputType())\n+                    .setComment(Optional.of(\"synthetic\"))\n+                    .build();\n+            syntheticNextIdentifier++;\n+\n+            newColumns.add(newColumn);\n+            projections.add(new Variable(newColumn.getColumnName(), aggregate.getOutputType()));\n+            resultAssignments.add(new Assignment(newColumn.getColumnName(), newColumn, aggregate.getOutputType()));\n+        }\n+\n+        // TODO should connector return group by columns afresh?\n+//        groupBy.stream()\n+//                .flatMap(Collection::stream)\n+//                .map(columnHandle -> ((JdbcColumnHandle) columnHandle).getColumnName())\n+//                .distinct()\n+//                .map(groupByColumn -> requireNonNull(columnByName.get(groupByColumn), () -> \"Column not found: \" + groupByColumn))\n+//                .forEach(newColumns::add);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NDQxMg==", "bodyText": "Implement is an empty word here, does not add any new value.\nThere is a convention of naming implementations in a <flavour><type> way. That way it is easy to understand what it is. We follow this with optimizer rules. Changing this here is unintuitive.", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r442094412", "createdAt": "2020-06-18T09:28:44Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/expression/ImplementAvgFloatingPoint.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.jdbc.expression;\n+\n+import io.prestosql.matching.Capture;\n+import io.prestosql.matching.Captures;\n+import io.prestosql.matching.Pattern;\n+import io.prestosql.plugin.jdbc.JdbcColumnHandle;\n+import io.prestosql.plugin.jdbc.JdbcExpression;\n+import io.prestosql.spi.connector.AggregateFunction;\n+import io.prestosql.spi.expression.Variable;\n+\n+import java.util.Optional;\n+\n+import static com.google.common.base.Verify.verify;\n+import static com.google.common.base.Verify.verifyNotNull;\n+import static io.prestosql.matching.Capture.newCapture;\n+import static io.prestosql.plugin.jdbc.expression.AggregateFunctionPatterns.basicAggregation;\n+import static io.prestosql.plugin.jdbc.expression.AggregateFunctionPatterns.expressionType;\n+import static io.prestosql.plugin.jdbc.expression.AggregateFunctionPatterns.functionName;\n+import static io.prestosql.plugin.jdbc.expression.AggregateFunctionPatterns.singleInput;\n+import static io.prestosql.plugin.jdbc.expression.AggregateFunctionPatterns.variable;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.spi.type.RealType.REAL;\n+import static java.lang.String.format;\n+\n+/**\n+ * Implements {@code avg(float)}\n+ */\n+public class ImplementAvgFloatingPoint", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2MzExNQ=="}, "originalCommit": null, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MTc3MTM1", "url": "https://github.com/trinodb/trino/pull/3881#pullrequestreview-434177135", "createdAt": "2020-06-19T15:45:26Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTo0NToyNlrOGmZWcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNjoyNzo1OVrOGmauzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxNDQxNw==", "bodyText": "Builders can be used full to simulate named arguments. When a methods has too many arguments or arguments with similar types, that can be error prone (e.g, if there are multiple boolean arguments).\nYou can avoid missing callsites by making the builder validate that all required values have been set. This will catch any errors when the tests run (so, obviously, it relies on having good coverage). It's not as good as a compile-time failure, but without named argument support in Java there's not much else we can do.", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r442914417", "createdAt": "2020-06-19T15:45:26Z", "author": {"login": "martint"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -142,9 +142,9 @@ public JdbcTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n                         handle.getCatalogName(),\n                         handle.getSchemaName(),\n                         handle.getTableName(),\n-                        Optional.of(newColumns),\n                         handle.getConstraint(),\n-                        handle.getLimit()),\n+                        handle.getLimit(),\n+                        Optional.of(newColumns)),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM1MzQwOA=="}, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkxOTQyMw==", "bodyText": "This should be a TODO. There's no reason why it shouldn't be possible to apply filters after a aggregations (i.e., a HAVING clause, or a WHERE clause in an enclosing query)", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r442919423", "createdAt": "2020-06-19T15:54:46Z", "author": {"login": "martint"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -101,6 +109,11 @@ public JdbcTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n     {\n         JdbcTableHandle handle = (JdbcTableHandle) table;\n \n+        if (handle.getGroupingSets().isPresent()) {\n+            // handle's aggregations are applied after constraint, so we cannot apply filter if aggregates is already set", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkzNzAzOQ==", "bodyText": "Why did this switch from StringBuilder to string concatenation?", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r442937039", "createdAt": "2020-06-19T16:27:59Z", "author": {"login": "martint"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/QueryBuilder.java", "diffHunk": "@@ -92,35 +94,32 @@ public PreparedStatement buildSql(\n             String catalog,\n             String schema,\n             String table,\n+            Optional<List<List<JdbcColumnHandle>>> groupingSets,\n             List<JdbcColumnHandle> columns,\n             TupleDomain<ColumnHandle> tupleDomain,\n             Optional<String> additionalPredicate,\n             Function<String, String> sqlFunction)\n             throws SQLException\n     {\n-        StringBuilder sql = new StringBuilder();\n-\n-        sql.append(\"SELECT \");\n-        sql.append(getProjection(columns));\n-\n-        sql.append(\" FROM \");\n-        sql.append(getRelation(catalog, schema, table));\n+        String sql = \"SELECT \" + getProjection(columns);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDI5OTI1", "url": "https://github.com/trinodb/trino/pull/3881#pullrequestreview-434429925", "createdAt": "2020-06-20T13:53:50Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQxMzo1Mzo1MFrOGmmq6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQxMzo1Mzo1MFrOGmmq6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzMjY0OQ==", "bodyText": "#4112", "url": "https://github.com/trinodb/trino/pull/3881#discussion_r443132649", "createdAt": "2020-06-20T13:53:50Z", "author": {"login": "findepi"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -111,6 +111,7 @@ public JdbcTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n \n         if (handle.getGroupingSets().isPresent()) {\n             // handle's aggregations are applied after constraint, so we cannot apply filter if aggregates is already set\n+            // TODO (https://github.com/prestosql/presto/issues/4112) allow filter pushdown after aggregation pushdown", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fd9b92a0efd6d5804b1d561b936d477dba686b6", "author": {"user": {"login": "findepi", "name": "Piotr Findeisen"}}, "url": "https://github.com/trinodb/trino/commit/1fd9b92a0efd6d5804b1d561b936d477dba686b6", "committedDate": "2020-06-20T20:36:40Z", "message": "Introduce TestingH2JdbcClient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "994a385cfb056534b83df82bd5cf4e8cae4d370b", "author": {"user": {"login": "findepi", "name": "Piotr Findeisen"}}, "url": "https://github.com/trinodb/trino/commit/994a385cfb056534b83df82bd5cf4e8cae4d370b", "committedDate": "2020-06-20T20:36:40Z", "message": "Distinguish table and relation handles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "068ea373ac4a313c809ba7d7d08a1e70c9c87a87", "author": {"user": {"login": "findepi", "name": "Piotr Findeisen"}}, "url": "https://github.com/trinodb/trino/commit/068ea373ac4a313c809ba7d7d08a1e70c9c87a87", "committedDate": "2020-06-20T20:36:40Z", "message": "Distinguish real and synthetic columns"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2120a10462dfbd67d63f7a9a312412866f7d0f1f", "author": {"user": {"login": "findepi", "name": "Piotr Findeisen"}}, "url": "https://github.com/trinodb/trino/commit/2120a10462dfbd67d63f7a9a312412866f7d0f1f", "committedDate": "2020-06-20T20:36:40Z", "message": "Make columns last in JdbcTableHandle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb41603a4e08a8a249a55a3e008b56cccb282b21", "author": {"user": {"login": "findepi", "name": "Piotr Findeisen"}}, "url": "https://github.com/trinodb/trino/commit/fb41603a4e08a8a249a55a3e008b56cccb282b21", "committedDate": "2020-06-20T20:36:40Z", "message": "Mark deprecated methods with @Deprecated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "a76bbf1e24f2ddeea778c1798ba156ce3a34338d", "author": {"user": {"login": "findepi", "name": "Piotr Findeisen"}}, "url": "https://github.com/trinodb/trino/commit/a76bbf1e24f2ddeea778c1798ba156ce3a34338d", "committedDate": "2020-06-20T20:46:06Z", "message": "Implement Aggregation pushdown in PostgreSQL"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "a76bbf1e24f2ddeea778c1798ba156ce3a34338d", "author": {"user": {"login": "findepi", "name": "Piotr Findeisen"}}, "url": "https://github.com/trinodb/trino/commit/a76bbf1e24f2ddeea778c1798ba156ce3a34338d", "committedDate": "2020-06-20T20:46:06Z", "message": "Implement Aggregation pushdown in PostgreSQL"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 529, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}