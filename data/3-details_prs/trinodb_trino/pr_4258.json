{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMTk2NDgw", "number": 4258, "title": "Replace HiveQlTranslation with a non-regex-based parser", "bodyText": "The new parser does the same thing the regular expression was supposed to do; it just replaces the quotation marks and makes sure that any contained quotation marks are properly escaped. No other escape sequences are handled (which will cause unexpected behavior if there's an escape sequence in a Hive view).\nAlso, the error thrown when parsing fails needs to be replaced, but I'm not sure what fits, besides adding a new error to HiveErrorCode. Maybe HIVE_PARSE_ERROR?\nThis addresses #3266.", "createdAt": "2020-06-29T05:03:00Z", "url": "https://github.com/trinodb/trino/pull/4258", "merged": true, "mergeCommit": {"oid": "7a243d06ca00f002416dd65e73e581d4743d66c7"}, "closed": true, "closedAt": "2020-07-07T15:33:33Z", "author": {"login": "jirassimok"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwATZZABqjM0OTI0Nzc5NTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwy1UGABqjM1MDQ2MTE2MTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MDc5NDQ4", "url": "https://github.com/trinodb/trino/pull/4258#pullrequestreview-439079448", "createdAt": "2020-06-29T12:13:41Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMjoxMzo0MVrOGqOBOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMjozNzoyN1rOGqO4oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkyMzA2Nw==", "bodyText": "Please move public static methods at the top before constructor", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r446923067", "createdAt": "2020-06-29T12:13:41Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Lists;\n+import io.prestosql.spi.PrestoException;\n+\n+import java.util.Iterator;\n+import java.util.ListIterator;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_INVALID_VIEW_DATA;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    private final String source;\n+    // Translation methods consume data from the iterator\n+    private final ListIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        source = hiveQl;\n+        input = Lists.charactersOf(hiveQl).listIterator();\n+    }\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is included.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveQuotesToPresto(String hiveStatement)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkyNDYyMw==", "bodyText": "such utility could be moved to the very bottom", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r446924623", "createdAt": "2020-06-29T12:16:22Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Lists;\n+import io.prestosql.spi.PrestoException;\n+\n+import java.util.Iterator;\n+import java.util.ListIterator;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_INVALID_VIEW_DATA;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    private final String source;\n+    // Translation methods consume data from the iterator\n+    private final ListIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        source = hiveQl;\n+        input = Lists.charactersOf(hiveQl).listIterator();\n+    }\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is included.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveQuotesToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator =\n+                new HiveQlToPrestoTranslator(hiveStatement);\n+        return translator.translateQuotedLiterals();\n+    }\n+\n+    private static PrestoException hiveParseError(String message)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkyNDg1Mg==", "bodyText": "This is not much actionable TODO. What is wrong, how can we fix it?", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r446924852", "createdAt": "2020-06-29T12:16:49Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Lists;\n+import io.prestosql.spi.PrestoException;\n+\n+import java.util.Iterator;\n+import java.util.ListIterator;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_INVALID_VIEW_DATA;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    private final String source;\n+    // Translation methods consume data from the iterator\n+    private final ListIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        source = hiveQl;\n+        input = Lists.charactersOf(hiveQl).listIterator();\n+    }\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is included.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveQuotesToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator =\n+                new HiveQlToPrestoTranslator(hiveStatement);\n+        return translator.translateQuotedLiterals();\n+    }\n+\n+    private static PrestoException hiveParseError(String message)\n+    {\n+        // TODO: This error is wrong.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkyNTI2OA==", "bodyText": "move this one method above, so methods are defined in the same order as they are used in translateQuotedLiterals", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r446925268", "createdAt": "2020-06-29T12:17:36Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Lists;\n+import io.prestosql.spi.PrestoException;\n+\n+import java.util.Iterator;\n+import java.util.ListIterator;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_INVALID_VIEW_DATA;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    private final String source;\n+    // Translation methods consume data from the iterator\n+    private final ListIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        source = hiveQl;\n+        input = Lists.charactersOf(hiveQl).listIterator();\n+    }\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is included.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveQuotesToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator =\n+                new HiveQlToPrestoTranslator(hiveStatement);\n+        return translator.translateQuotedLiterals();\n+    }\n+\n+    private static PrestoException hiveParseError(String message)\n+    {\n+        // TODO: This error is wrong.\n+        return new PrestoException(HIVE_INVALID_VIEW_DATA,\n+                format(\"Error translating Hive QL to Presto SQL: %s\",\n+                        message));\n+    }\n+\n+    private String translateQuotedLiterals()\n+    {\n+        // Consume input, passing control to other translation methods when\n+        // their delimiters are encountered.\n+        while (input.hasNext()) {\n+            char c = input.next();\n+            switch (c) {\n+                case '\"':\n+                case '\\'':\n+                    translateString(c);\n+                    break;\n+                case '`':\n+                    translateQuotedIdentifier();\n+                    break;\n+                default:\n+                    output.append(c);\n+                    break;\n+            }\n+        }\n+\n+        return output.toString();\n+    }\n+\n+    /**\n+     * Start with input just after the opening backquote, consume to the\n+     * closing backquote.\n+     */\n+    private void translateQuotedIdentifier()\n+    {\n+        output.append('\"');\n+        while (input.hasNext()) {\n+            char c = input.next();\n+\n+            // The possible outcomes in an identifier are:\n+            // - replace \" with \"\"\n+            // - leave most characters as-is\n+            // - replace `` with `\n+            // - replace ` with \" and end the identifier\n+            if (c == '\"') {\n+                output.append(\"\\\"\\\"\");\n+            }\n+            else if (c != '`') {\n+                output.append(c);\n+            }\n+            else if (input.hasNext() && peek() == '`') {\n+                output.append('`');\n+                input.next();\n+            }\n+            else { // end of identifier\n+                output.append('\"');\n+                return;\n+            }\n+        }\n+\n+        throw hiveParseError(\"unexpected end of input in identifier\");\n+    }\n+\n+    /**\n+     * Call with input just after the opening delimiter (the parameter), end\n+     * with input after closing delimiter.\n+     */\n+    private void translateString(char delimiter)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkyNjE5Mg==", "bodyText": "drop the comment", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r446926192", "createdAt": "2020-06-29T12:19:12Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Lists;\n+import io.prestosql.spi.PrestoException;\n+\n+import java.util.Iterator;\n+import java.util.ListIterator;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_INVALID_VIEW_DATA;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    private final String source;\n+    // Translation methods consume data from the iterator\n+    private final ListIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        source = hiveQl;\n+        input = Lists.charactersOf(hiveQl).listIterator();\n+    }\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is included.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveQuotesToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator =\n+                new HiveQlToPrestoTranslator(hiveStatement);\n+        return translator.translateQuotedLiterals();\n+    }\n+\n+    private static PrestoException hiveParseError(String message)\n+    {\n+        // TODO: This error is wrong.\n+        return new PrestoException(HIVE_INVALID_VIEW_DATA,\n+                format(\"Error translating Hive QL to Presto SQL: %s\",\n+                        message));\n+    }\n+\n+    private String translateQuotedLiterals()\n+    {\n+        // Consume input, passing control to other translation methods when\n+        // their delimiters are encountered.\n+        while (input.hasNext()) {\n+            char c = input.next();\n+            switch (c) {\n+                case '\"':\n+                case '\\'':\n+                    translateString(c);\n+                    break;\n+                case '`':\n+                    translateQuotedIdentifier();\n+                    break;\n+                default:\n+                    output.append(c);\n+                    break;\n+            }\n+        }\n+\n+        return output.toString();\n+    }\n+\n+    /**\n+     * Start with input just after the opening backquote, consume to the\n+     * closing backquote.\n+     */\n+    private void translateQuotedIdentifier()\n+    {\n+        output.append('\"');\n+        while (input.hasNext()) {\n+            char c = input.next();\n+\n+            // The possible outcomes in an identifier are:\n+            // - replace \" with \"\"\n+            // - leave most characters as-is\n+            // - replace `` with `\n+            // - replace ` with \" and end the identifier\n+            if (c == '\"') {\n+                output.append(\"\\\"\\\"\");\n+            }\n+            else if (c != '`') {\n+                output.append(c);\n+            }\n+            else if (input.hasNext() && peek() == '`') {\n+                output.append('`');\n+                input.next();\n+            }\n+            else { // end of identifier\n+                output.append('\"');\n+                return;\n+            }\n+        }\n+\n+        throw hiveParseError(\"unexpected end of input in identifier\");\n+    }\n+\n+    /**\n+     * Call with input just after the opening delimiter (the parameter), end\n+     * with input after closing delimiter.\n+     */\n+    private void translateString(char delimiter)\n+    {\n+        output.append(\"'\");\n+        while (input.hasNext()) {\n+            char c = input.next();\n+\n+            // The possible outcomes in a string are (assuming \"-quoting):\n+            // - find delimiter and end the string\n+            // - find backslash and treat following character as non-delimiter\n+            // - replace ' with ''\n+            // - leave any other character as-is\n+            if (c == delimiter) {\n+                output.append(\"'\");\n+                return;\n+            }\n+            else if (c == '\\\\') {\n+                if (!input.hasNext()) {\n+                    break; // skip to end-of-input error\n+                }\n+                // Don't handle escape sequences, just drop the backslash.\n+                // (If we want to handle them, make this block a function.)\n+                c = input.next();\n+            }\n+\n+            if (c == '\\'') {\n+                output.append(\"''\");\n+            }\n+            else {\n+                output.append(c);\n+            }\n+        }\n+        throw hiveParseError(\"unexpected end of input in string\");\n+    }\n+\n+    /** Get the next character in the input without consuming it. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 164}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkyNjczNw==", "bodyText": "I like this much more than regexp based", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r446926737", "createdAt": "2020-06-29T12:20:10Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Lists;\n+import io.prestosql.spi.PrestoException;\n+\n+import java.util.Iterator;\n+import java.util.ListIterator;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_INVALID_VIEW_DATA;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkyNzg3MA==", "bodyText": "I don't think you need to split lines here", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r446927870", "createdAt": "2020-06-29T12:22:04Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Lists;\n+import io.prestosql.spi.PrestoException;\n+\n+import java.util.Iterator;\n+import java.util.ListIterator;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_INVALID_VIEW_DATA;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    private final String source;\n+    // Translation methods consume data from the iterator\n+    private final ListIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        source = hiveQl;\n+        input = Lists.charactersOf(hiveQl).listIterator();\n+    }\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is included.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveQuotesToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator =\n+                new HiveQlToPrestoTranslator(hiveStatement);\n+        return translator.translateQuotedLiterals();\n+    }\n+\n+    private static PrestoException hiveParseError(String message)\n+    {\n+        // TODO: This error is wrong.\n+        return new PrestoException(HIVE_INVALID_VIEW_DATA,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkzNTI1OQ==", "bodyText": "I would drop such comments", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r446935259", "createdAt": "2020-06-29T12:34:15Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Lists;\n+import io.prestosql.spi.PrestoException;\n+\n+import java.util.Iterator;\n+import java.util.ListIterator;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_INVALID_VIEW_DATA;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    private final String source;\n+    // Translation methods consume data from the iterator\n+    private final ListIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        source = hiveQl;\n+        input = Lists.charactersOf(hiveQl).listIterator();\n+    }\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is included.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveQuotesToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator =\n+                new HiveQlToPrestoTranslator(hiveStatement);\n+        return translator.translateQuotedLiterals();\n+    }\n+\n+    private static PrestoException hiveParseError(String message)\n+    {\n+        // TODO: This error is wrong.\n+        return new PrestoException(HIVE_INVALID_VIEW_DATA,\n+                format(\"Error translating Hive QL to Presto SQL: %s\",\n+                        message));\n+    }\n+\n+    private String translateQuotedLiterals()\n+    {\n+        // Consume input, passing control to other translation methods when\n+        // their delimiters are encountered.\n+        while (input.hasNext()) {\n+            char c = input.next();\n+            switch (c) {\n+                case '\"':\n+                case '\\'':\n+                    translateString(c);\n+                    break;\n+                case '`':\n+                    translateQuotedIdentifier();\n+                    break;\n+                default:\n+                    output.append(c);\n+                    break;\n+            }\n+        }\n+\n+        return output.toString();\n+    }\n+\n+    /**\n+     * Start with input just after the opening backquote, consume to the\n+     * closing backquote.\n+     */\n+    private void translateQuotedIdentifier()\n+    {\n+        output.append('\"');\n+        while (input.hasNext()) {\n+            char c = input.next();\n+\n+            // The possible outcomes in an identifier are:\n+            // - replace \" with \"\"\n+            // - leave most characters as-is\n+            // - replace `` with `\n+            // - replace ` with \" and end the identifier\n+            if (c == '\"') {\n+                output.append(\"\\\"\\\"\");\n+            }\n+            else if (c != '`') {\n+                output.append(c);\n+            }\n+            else if (input.hasNext() && peek() == '`') {\n+                output.append('`');\n+                input.next();\n+            }\n+            else { // end of identifier\n+                output.append('\"');\n+                return;\n+            }\n+        }\n+\n+        throw hiveParseError(\"unexpected end of input in identifier\");\n+    }\n+\n+    /**\n+     * Call with input just after the opening delimiter (the parameter), end\n+     * with input after closing delimiter.\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkzNzAyOQ==", "bodyText": "please use @DataProvider", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r446937029", "createdAt": "2020-06-29T12:37:08Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveQlToPrestoTranslator.java", "diffHunk": "@@ -103,9 +108,88 @@ public void testPredicates()\n                 \"SELECT '''' = '''' OR false\");\n     }\n \n+    /**\n+     * Declare a lot of column name translations, then test combinations of them.\n+     */\n+    @Test\n+    public void testQuotedLiteralCombinations()\n+    {\n+        // Each element of the column lists is {hive, presto}\n+\n+        List<String[]> columns = new ArrayList<>(Arrays.asList(new String[][] {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkzNzI0OA==", "bodyText": "extract this as separate test and please use @DataProvider", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r446937248", "createdAt": "2020-06-29T12:37:27Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveQlToPrestoTranslator.java", "diffHunk": "@@ -103,9 +108,88 @@ public void testPredicates()\n                 \"SELECT '''' = '''' OR false\");\n     }\n \n+    /**\n+     * Declare a lot of column name translations, then test combinations of them.\n+     */\n+    @Test\n+    public void testQuotedLiteralCombinations()\n+    {\n+        // Each element of the column lists is {hive, presto}\n+\n+        List<String[]> columns = new ArrayList<>(Arrays.asList(new String[][] {\n+                // simple literals\n+                {\"unquoted\", \"unquoted\"},\n+                {\"`backquoted`\", \"\\\"backquoted\\\"\"},\n+                {\"`sometable`.`backquoted`\", \"\\\"sometable\\\".\\\"backquoted\\\"\"},\n+                {\"'single quoted'\", \"'single quoted'\"},\n+                {\"\\\"double quoted\\\"\", \"'double quoted'\"},\n+                // empty strings\n+                {\"''\", \"''\"},\n+                {\"\\\"\\\"\", \"''\"},\n+        }));\n+\n+        // For just the simple-looking columns, test three at a time\n+        for (String[] col1 : columns) {\n+            for (String[] col2 : columns) {\n+                for (String[] col3 : columns) {\n+                    String fmt = \"SELECT %s, %s, %s FROM x\";\n+                    assertTranslation(\n+                            format(fmt, col1[0], col2[0], col3[0]),\n+                            format(fmt, col1[1], col2[1], col3[1]));\n+                }\n+            }\n+        }\n+\n+        columns.addAll(Arrays.asList(new String[][] {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MjIyNzA3", "url": "https://github.com/trinodb/trino/pull/4258#pullrequestreview-439222707", "createdAt": "2020-06-29T14:50:18Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNDo1MDoxOVrOGqUlqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToxODo1M1rOGqV3jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzMDY5OQ==", "bodyText": "Personally I'd find this more readable if you flipped the condition so that the final else condition was this un-interesting case and your if conditions specified the more interesting ` and `` cases", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r447030699", "createdAt": "2020-06-29T14:50:19Z", "author": {"login": "alexjo2144"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Lists;\n+import io.prestosql.spi.PrestoException;\n+\n+import java.util.ListIterator;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_INVALID_VIEW_DATA;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    private final String source;\n+    // Translation methods consume data from the iterator\n+    private final ListIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        source = hiveQl;\n+        input = Lists.charactersOf(hiveQl).listIterator();\n+    }\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is included.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveQuotesToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator =\n+                new HiveQlToPrestoTranslator(hiveStatement);\n+        return translator.translateQuotedLiterals();\n+    }\n+\n+    private static PrestoException hiveParseError(String message)\n+    {\n+        // TODO: This error is wrong.\n+        return new PrestoException(HIVE_INVALID_VIEW_DATA,\n+                format(\"Error translating Hive QL to Presto SQL: %s\",\n+                        message));\n+    }\n+\n+    private String translateQuotedLiterals()\n+    {\n+        // Consume input, passing control to other translation methods when\n+        // their delimiters are encountered.\n+        while (input.hasNext()) {\n+            char c = input.next();\n+            switch (c) {\n+                case '\"':\n+                case '\\'':\n+                    translateString(c);\n+                    break;\n+                case '`':\n+                    translateQuotedIdentifier();\n+                    break;\n+                default:\n+                    output.append(c);\n+                    break;\n+            }\n+        }\n+\n+        return output.toString();\n+    }\n+\n+    /**\n+     * Start with input just after the opening backquote, consume to the\n+     * closing backquote.\n+     */\n+    private void translateQuotedIdentifier()\n+    {\n+        output.append('\"');\n+        while (input.hasNext()) {\n+            char c = input.next();\n+\n+            // The possible outcomes in an identifier are:\n+            // - replace \" with \"\"\n+            // - leave most characters as-is\n+            // - replace `` with `\n+            // - replace ` with \" and end the identifier\n+            if (c == '\"') {\n+                output.append(\"\\\"\\\"\");\n+            }\n+            else if (c != '`') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1MTY2MA==", "bodyText": "Use PeekingIterator instead? Then you don't have to store source", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r447051660", "createdAt": "2020-06-29T15:18:53Z", "author": {"login": "alexjo2144"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Lists;\n+import io.prestosql.spi.PrestoException;\n+\n+import java.util.ListIterator;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_INVALID_VIEW_DATA;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    private final String source;\n+    // Translation methods consume data from the iterator\n+    private final ListIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        source = hiveQl;\n+        input = Lists.charactersOf(hiveQl).listIterator();\n+    }\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is included.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveQuotesToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator =\n+                new HiveQlToPrestoTranslator(hiveStatement);\n+        return translator.translateQuotedLiterals();\n+    }\n+\n+    private static PrestoException hiveParseError(String message)\n+    {\n+        // TODO: This error is wrong.\n+        return new PrestoException(HIVE_INVALID_VIEW_DATA,\n+                format(\"Error translating Hive QL to Presto SQL: %s\",\n+                        message));\n+    }\n+\n+    private String translateQuotedLiterals()\n+    {\n+        // Consume input, passing control to other translation methods when\n+        // their delimiters are encountered.\n+        while (input.hasNext()) {\n+            char c = input.next();\n+            switch (c) {\n+                case '\"':\n+                case '\\'':\n+                    translateString(c);\n+                    break;\n+                case '`':\n+                    translateQuotedIdentifier();\n+                    break;\n+                default:\n+                    output.append(c);\n+                    break;\n+            }\n+        }\n+\n+        return output.toString();\n+    }\n+\n+    /**\n+     * Start with input just after the opening backquote, consume to the\n+     * closing backquote.\n+     */\n+    private void translateQuotedIdentifier()\n+    {\n+        output.append('\"');\n+        while (input.hasNext()) {\n+            char c = input.next();\n+\n+            // The possible outcomes in an identifier are:\n+            // - replace \" with \"\"\n+            // - leave most characters as-is\n+            // - replace `` with `\n+            // - replace ` with \" and end the identifier\n+            if (c == '\"') {\n+                output.append(\"\\\"\\\"\");\n+            }\n+            else if (c != '`') {\n+                output.append(c);\n+            }\n+            else if (input.hasNext() && peek() == '`') {\n+                output.append('`');\n+                input.next();\n+            }\n+            else { // end of identifier\n+                output.append('\"');\n+                return;\n+            }\n+        }\n+\n+        throw hiveParseError(\"unexpected end of input in identifier\");\n+    }\n+\n+    /**\n+     * Call with input just after the opening delimiter (the parameter), end\n+     * with input after closing delimiter.\n+     */\n+    private void translateString(char delimiter)\n+    {\n+        output.append(\"'\");\n+        while (input.hasNext()) {\n+            char c = input.next();\n+\n+            // The possible outcomes in a string are (assuming \"-quoting):\n+            // - find delimiter and end the string\n+            // - find backslash and treat following character as non-delimiter\n+            // - replace ' with ''\n+            // - leave any other character as-is\n+            if (c == delimiter) {\n+                output.append(\"'\");\n+                return;\n+            }\n+            else if (c == '\\\\') {\n+                if (!input.hasNext()) {\n+                    break; // skip to end-of-input error\n+                }\n+                // Don't handle escape sequences, just drop the backslash.\n+                // (If we want to handle them, make this block a function.)\n+                c = input.next();\n+            }\n+\n+            if (c == '\\'') {\n+                output.append(\"''\");\n+            }\n+            else {\n+                output.append(c);\n+            }\n+        }\n+        throw hiveParseError(\"unexpected end of input in string\");\n+    }\n+\n+    /** Get the next character in the input without consuming it. */\n+    private char peek()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 164}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MjkwODEx", "url": "https://github.com/trinodb/trino/pull/4258#pullrequestreview-439290811", "createdAt": "2020-06-29T16:02:49Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNjowMjo0OVrOGqXw0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNjowMjo0OVrOGqXw0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA4MjcwNA==", "bodyText": "You could make all these methods static, passing input and output through to each. I'm not sure what's cleaner style-wise, just a thought.", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r447082704", "createdAt": "2020-06-29T16:02:49Z", "author": {"login": "alexjo2144"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Iterators;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.PeekingIterator;\n+import io.prestosql.spi.PrestoException;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_INVALID_VIEW_DATA;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    // Translation methods consume data from the iterator\n+    private final PeekingIterator<Character> input;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MzgyNDk2", "url": "https://github.com/trinodb/trino/pull/4258#pullrequestreview-439382496", "createdAt": "2020-06-29T18:07:03Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxODowNzowM1rOGqcTAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxODoyMDowMVrOGqcuJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE1Njk5Mw==", "bodyText": "Don't rename the class. This is preventing Git from showing a proper diff for things like testStringLiterals which did not change.", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r447156993", "createdAt": "2020-06-29T18:07:03Z", "author": {"login": "electrum"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,242 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Iterators;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Sets;\n+import com.google.common.collect.Streams;\n+import io.prestosql.sql.parser.ParsingOptions;\n+import io.prestosql.sql.parser.SqlParser;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import static io.prestosql.plugin.hive.HiveQlToPrestoTranslator.translateHiveQuotesToPresto;\n+import static io.prestosql.testing.assertions.Assert.assertEquals;\n+import static java.lang.String.format;\n+import static java.util.Collections.nCopies;\n+\n+public class TestHiveQlToPrestoTranslator", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE1NzY4Ng==", "bodyText": "Revert", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r447157686", "createdAt": "2020-06-29T18:08:18Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveErrorCode.java", "diffHunk": "@@ -60,11 +60,12 @@\n     HIVE_PARTITION_NOT_READABLE(33, USER_ERROR),\n     HIVE_TABLE_NOT_READABLE(34, USER_ERROR),\n     HIVE_TABLE_DROPPED_DURING_QUERY(35, EXTERNAL),\n-    // HIVE_TOO_MANY_BUCKET_SORT_FILES(36) is deprecated\n+    // HIVE_TOO_MANY_BUCKET_SORT_FILES(36) is deprecatedS", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE1ODExMQ==", "bodyText": "Let's name this HIVE_VIEW_TRANSLATION_ERROR", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r447158111", "createdAt": "2020-06-29T18:09:06Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveErrorCode.java", "diffHunk": "@@ -60,11 +60,12 @@\n     HIVE_PARTITION_NOT_READABLE(33, USER_ERROR),\n     HIVE_TABLE_NOT_READABLE(34, USER_ERROR),\n     HIVE_TABLE_DROPPED_DURING_QUERY(35, EXTERNAL),\n-    // HIVE_TOO_MANY_BUCKET_SORT_FILES(36) is deprecated\n+    // HIVE_TOO_MANY_BUCKET_SORT_FILES(36) is deprecatedS\n     HIVE_CORRUPTED_COLUMN_STATISTICS(37, EXTERNAL),\n     HIVE_EXCEEDED_SPLIT_BUFFERING_LIMIT(38, USER_ERROR),\n     HIVE_UNKNOWN_COLUMN_STATISTIC_TYPE(39, INTERNAL_ERROR),\n-    HIVE_TABLE_LOCK_NOT_ACQUIRED(40, EXTERNAL)\n+    HIVE_TABLE_LOCK_NOT_ACQUIRED(40, EXTERNAL),\n+    HIVE_TRANSLATION_ERROR(41, EXTERNAL),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE1OTQ3Ng==", "bodyText": "No need to wrap here", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r447159476", "createdAt": "2020-06-29T18:11:34Z", "author": {"login": "electrum"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,242 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Iterators;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Sets;\n+import com.google.common.collect.Streams;\n+import io.prestosql.sql.parser.ParsingOptions;\n+import io.prestosql.sql.parser.SqlParser;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import static io.prestosql.plugin.hive.HiveQlToPrestoTranslator.translateHiveQuotesToPresto;\n+import static io.prestosql.testing.assertions.Assert.assertEquals;\n+import static java.lang.String.format;\n+import static java.util.Collections.nCopies;\n+\n+public class TestHiveQlToPrestoTranslator\n+{\n+    private final SqlParser parser = new SqlParser();\n+\n+    // Map Hive names to Presto names\n+    private static Map<String, String> simpleColumnNames =\n+            ImmutableMap.<String, String>builder()\n+                    // simple literals\n+                    .put(\n+                            \"unquoted\",\n+                            \"unquoted\")\n+                    .put(\n+                            \"`backquoted`\",\n+                            \"\\\"backquoted\\\"\")\n+                    .put(\n+                            \"`sometable`.`backquoted`\",\n+                            \"\\\"sometable\\\".\\\"backquoted\\\"\")\n+                    .put(\n+                            \"'single quoted'\",\n+                            \"'single quoted'\")\n+                    .put(\n+                            \"\\\"double quoted\\\"\",\n+                            \"'double quoted'\")\n+                    // empty strings\n+                    .put(\"''\", \"''\")\n+                    .put(\"\\\"\\\"\", \"''\")\n+                    // just quotes\n+                    .put(\"'\\\\''\", \"''''\")\n+                    .put(\"\\\"\\\\\\\"\\\"\", \"'\\\"'\")\n+                    .build();\n+\n+    private static Map<String, String> extendedColumnNames =\n+            ImmutableMap.<String, String>builder()\n+                    .putAll(simpleColumnNames)\n+                    .put(\n+                            \"`id: ``back`\",\n+                            \"\\\"id: `back\\\"\")\n+                    .put(\n+                            \"`id: \\\"double`\",\n+                            \"\\\"id: \\\"\\\"double\\\"\")\n+                    .put(\n+                            \"`id: \\\"\\\"two double`\",\n+                            \"\\\"id: \\\"\\\"\\\"\\\"two double\\\"\")\n+                    .put(\n+                            \"`id: two back`````\",\n+                            \"\\\"id: two back``\\\"\")\n+                    .put(\n+                            \"'single: \\\"double'\",\n+                            \"'single: \\\"double'\")\n+                    .put(\n+                            \"'single: \\\\'single'\",\n+                            \"'single: ''single'\")\n+                    .put(\n+                            \"'single: \\\\'\\\\'two singles'\",\n+                            \"'single: ''''two singles'\")\n+                    .put(\n+                            \"\\\"double: double\\\\\\\"\\\"\",\n+                            \"'double: double\\\"'\")\n+                    .put(\n+                            \"\\\"double: single'\\\"\",\n+                            \"'double: single'''\")\n+                    .put(\n+                            \"\\\"double: two singles''\\\"\",\n+                            \"'double: two singles'''''\")\n+                    .build();\n+\n+    /** Prepare all combinations of {@code n} of the given columns. */\n+    private static Iterator<Object[]> getNColumns(int n, Map<String, String> columns)\n+    {\n+        Stream<String> hiveNames =\n+                Sets.cartesianProduct(nCopies(n, columns.keySet()))\n+                        .stream()\n+                        .map(names -> String.join(\", \", names));\n+\n+        Stream<String> prestoNames =\n+                Lists.cartesianProduct(nCopies(n, List.copyOf(columns.values())))\n+                        .stream()\n+                        .map(names -> String.join(\", \", names));\n+\n+        return Streams.zip(hiveNames, prestoNames, (h, p) -> new Object[]{h, p})\n+                .iterator();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE1OTUyNg==", "bodyText": "Static import", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r447159526", "createdAt": "2020-06-29T18:11:39Z", "author": {"login": "electrum"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,242 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Iterators;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Sets;\n+import com.google.common.collect.Streams;\n+import io.prestosql.sql.parser.ParsingOptions;\n+import io.prestosql.sql.parser.SqlParser;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import static io.prestosql.plugin.hive.HiveQlToPrestoTranslator.translateHiveQuotesToPresto;\n+import static io.prestosql.testing.assertions.Assert.assertEquals;\n+import static java.lang.String.format;\n+import static java.util.Collections.nCopies;\n+\n+public class TestHiveQlToPrestoTranslator\n+{\n+    private final SqlParser parser = new SqlParser();\n+\n+    // Map Hive names to Presto names\n+    private static Map<String, String> simpleColumnNames =\n+            ImmutableMap.<String, String>builder()\n+                    // simple literals\n+                    .put(\n+                            \"unquoted\",\n+                            \"unquoted\")\n+                    .put(\n+                            \"`backquoted`\",\n+                            \"\\\"backquoted\\\"\")\n+                    .put(\n+                            \"`sometable`.`backquoted`\",\n+                            \"\\\"sometable\\\".\\\"backquoted\\\"\")\n+                    .put(\n+                            \"'single quoted'\",\n+                            \"'single quoted'\")\n+                    .put(\n+                            \"\\\"double quoted\\\"\",\n+                            \"'double quoted'\")\n+                    // empty strings\n+                    .put(\"''\", \"''\")\n+                    .put(\"\\\"\\\"\", \"''\")\n+                    // just quotes\n+                    .put(\"'\\\\''\", \"''''\")\n+                    .put(\"\\\"\\\\\\\"\\\"\", \"'\\\"'\")\n+                    .build();\n+\n+    private static Map<String, String> extendedColumnNames =\n+            ImmutableMap.<String, String>builder()\n+                    .putAll(simpleColumnNames)\n+                    .put(\n+                            \"`id: ``back`\",\n+                            \"\\\"id: `back\\\"\")\n+                    .put(\n+                            \"`id: \\\"double`\",\n+                            \"\\\"id: \\\"\\\"double\\\"\")\n+                    .put(\n+                            \"`id: \\\"\\\"two double`\",\n+                            \"\\\"id: \\\"\\\"\\\"\\\"two double\\\"\")\n+                    .put(\n+                            \"`id: two back`````\",\n+                            \"\\\"id: two back``\\\"\")\n+                    .put(\n+                            \"'single: \\\"double'\",\n+                            \"'single: \\\"double'\")\n+                    .put(\n+                            \"'single: \\\\'single'\",\n+                            \"'single: ''single'\")\n+                    .put(\n+                            \"'single: \\\\'\\\\'two singles'\",\n+                            \"'single: ''''two singles'\")\n+                    .put(\n+                            \"\\\"double: double\\\\\\\"\\\"\",\n+                            \"'double: double\\\"'\")\n+                    .put(\n+                            \"\\\"double: single'\\\"\",\n+                            \"'double: single'''\")\n+                    .put(\n+                            \"\\\"double: two singles''\\\"\",\n+                            \"'double: two singles'''''\")\n+                    .build();\n+\n+    /** Prepare all combinations of {@code n} of the given columns. */\n+    private static Iterator<Object[]> getNColumns(int n, Map<String, String> columns)\n+    {\n+        Stream<String> hiveNames =\n+                Sets.cartesianProduct(nCopies(n, columns.keySet()))\n+                        .stream()\n+                        .map(names -> String.join(\", \", names));\n+\n+        Stream<String> prestoNames =\n+                Lists.cartesianProduct(nCopies(n, List.copyOf(columns.values())))", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE1OTY1MA==", "bodyText": "stream() normally go on the same line", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r447159650", "createdAt": "2020-06-29T18:11:51Z", "author": {"login": "electrum"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,242 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Iterators;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Sets;\n+import com.google.common.collect.Streams;\n+import io.prestosql.sql.parser.ParsingOptions;\n+import io.prestosql.sql.parser.SqlParser;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import static io.prestosql.plugin.hive.HiveQlToPrestoTranslator.translateHiveQuotesToPresto;\n+import static io.prestosql.testing.assertions.Assert.assertEquals;\n+import static java.lang.String.format;\n+import static java.util.Collections.nCopies;\n+\n+public class TestHiveQlToPrestoTranslator\n+{\n+    private final SqlParser parser = new SqlParser();\n+\n+    // Map Hive names to Presto names\n+    private static Map<String, String> simpleColumnNames =\n+            ImmutableMap.<String, String>builder()\n+                    // simple literals\n+                    .put(\n+                            \"unquoted\",\n+                            \"unquoted\")\n+                    .put(\n+                            \"`backquoted`\",\n+                            \"\\\"backquoted\\\"\")\n+                    .put(\n+                            \"`sometable`.`backquoted`\",\n+                            \"\\\"sometable\\\".\\\"backquoted\\\"\")\n+                    .put(\n+                            \"'single quoted'\",\n+                            \"'single quoted'\")\n+                    .put(\n+                            \"\\\"double quoted\\\"\",\n+                            \"'double quoted'\")\n+                    // empty strings\n+                    .put(\"''\", \"''\")\n+                    .put(\"\\\"\\\"\", \"''\")\n+                    // just quotes\n+                    .put(\"'\\\\''\", \"''''\")\n+                    .put(\"\\\"\\\\\\\"\\\"\", \"'\\\"'\")\n+                    .build();\n+\n+    private static Map<String, String> extendedColumnNames =\n+            ImmutableMap.<String, String>builder()\n+                    .putAll(simpleColumnNames)\n+                    .put(\n+                            \"`id: ``back`\",\n+                            \"\\\"id: `back\\\"\")\n+                    .put(\n+                            \"`id: \\\"double`\",\n+                            \"\\\"id: \\\"\\\"double\\\"\")\n+                    .put(\n+                            \"`id: \\\"\\\"two double`\",\n+                            \"\\\"id: \\\"\\\"\\\"\\\"two double\\\"\")\n+                    .put(\n+                            \"`id: two back`````\",\n+                            \"\\\"id: two back``\\\"\")\n+                    .put(\n+                            \"'single: \\\"double'\",\n+                            \"'single: \\\"double'\")\n+                    .put(\n+                            \"'single: \\\\'single'\",\n+                            \"'single: ''single'\")\n+                    .put(\n+                            \"'single: \\\\'\\\\'two singles'\",\n+                            \"'single: ''''two singles'\")\n+                    .put(\n+                            \"\\\"double: double\\\\\\\"\\\"\",\n+                            \"'double: double\\\"'\")\n+                    .put(\n+                            \"\\\"double: single'\\\"\",\n+                            \"'double: single'''\")\n+                    .put(\n+                            \"\\\"double: two singles''\\\"\",\n+                            \"'double: two singles'''''\")\n+                    .build();\n+\n+    /** Prepare all combinations of {@code n} of the given columns. */\n+    private static Iterator<Object[]> getNColumns(int n, Map<String, String> columns)\n+    {\n+        Stream<String> hiveNames =\n+                Sets.cartesianProduct(nCopies(n, columns.keySet()))\n+                        .stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE1OTk3NQ==", "bodyText": "No need to wrap here", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r447159975", "createdAt": "2020-06-29T18:12:29Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Iterators;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.PeekingIterator;\n+import io.prestosql.spi.PrestoException;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_TRANSLATION_ERROR;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    // Translation methods consume data from the iterator\n+    private final PeekingIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is included.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveQuotesToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator =\n+                new HiveQlToPrestoTranslator(hiveStatement);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MDE3OQ==", "bodyText": "Static import", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r447160179", "createdAt": "2020-06-29T18:12:51Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Iterators;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.PeekingIterator;\n+import io.prestosql.spi.PrestoException;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_TRANSLATION_ERROR;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    // Translation methods consume data from the iterator\n+    private final PeekingIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is included.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveQuotesToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator =\n+                new HiveQlToPrestoTranslator(hiveStatement);\n+        return translator.translateQuotedLiterals();\n+    }\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        input = Iterators.peekingIterator(Lists.charactersOf(hiveQl).iterator());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MDY2Ng==", "bodyText": "\"else\" is redundant here since the above \"if\" returns", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r447160666", "createdAt": "2020-06-29T18:13:49Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Iterators;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.PeekingIterator;\n+import io.prestosql.spi.PrestoException;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_TRANSLATION_ERROR;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    // Translation methods consume data from the iterator\n+    private final PeekingIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is included.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveQuotesToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator =\n+                new HiveQlToPrestoTranslator(hiveStatement);\n+        return translator.translateQuotedLiterals();\n+    }\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        input = Iterators.peekingIterator(Lists.charactersOf(hiveQl).iterator());\n+    }\n+\n+    private String translateQuotedLiterals()\n+    {\n+        // Consume input, passing control to other translation methods when\n+        // their delimiters are encountered.\n+        while (input.hasNext()) {\n+            char c = input.next();\n+            switch (c) {\n+                case '\"':\n+                case '\\'':\n+                    translateString(c);\n+                    break;\n+                case '`':\n+                    translateQuotedIdentifier();\n+                    break;\n+                default:\n+                    output.append(c);\n+                    break;\n+            }\n+        }\n+\n+        return output.toString();\n+    }\n+\n+    private void translateString(char delimiter)\n+    {\n+        output.append(\"'\");\n+        while (input.hasNext()) {\n+            char c = input.next();\n+\n+            // The possible outcomes in a string are (assuming \"-quoting):\n+            // - find delimiter and end the string\n+            // - find backslash and treat following character as non-delimiter\n+            // - replace ' with ''\n+            // - leave any other character as-is\n+            if (c == delimiter) {\n+                output.append(\"'\");\n+                return;\n+            }\n+            else if (c == '\\\\') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2Mzk0MA==", "bodyText": "This seems wrong. We should fail if there are escape sequences if we're not going to handle them. Otherwise, we are returning a known invalid result.", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r447163940", "createdAt": "2020-06-29T18:20:01Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Iterators;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.PeekingIterator;\n+import io.prestosql.spi.PrestoException;\n+\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_TRANSLATION_ERROR;\n+import static java.lang.String.format;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    // Translation methods consume data from the iterator\n+    private final PeekingIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is included.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveQuotesToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator =\n+                new HiveQlToPrestoTranslator(hiveStatement);\n+        return translator.translateQuotedLiterals();\n+    }\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        input = Iterators.peekingIterator(Lists.charactersOf(hiveQl).iterator());\n+    }\n+\n+    private String translateQuotedLiterals()\n+    {\n+        // Consume input, passing control to other translation methods when\n+        // their delimiters are encountered.\n+        while (input.hasNext()) {\n+            char c = input.next();\n+            switch (c) {\n+                case '\"':\n+                case '\\'':\n+                    translateString(c);\n+                    break;\n+                case '`':\n+                    translateQuotedIdentifier();\n+                    break;\n+                default:\n+                    output.append(c);\n+                    break;\n+            }\n+        }\n+\n+        return output.toString();\n+    }\n+\n+    private void translateString(char delimiter)\n+    {\n+        output.append(\"'\");\n+        while (input.hasNext()) {\n+            char c = input.next();\n+\n+            // The possible outcomes in a string are (assuming \"-quoting):\n+            // - find delimiter and end the string\n+            // - find backslash and treat following character as non-delimiter\n+            // - replace ' with ''\n+            // - leave any other character as-is\n+            if (c == delimiter) {\n+                output.append(\"'\");\n+                return;\n+            }\n+            else if (c == '\\\\') {\n+                if (!input.hasNext()) {\n+                    break; // skip to end-of-input error\n+                }\n+                // Don't handle escape sequences, just drop the backslash.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 100}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDcxMDcz", "url": "https://github.com/trinodb/trino/pull/4258#pullrequestreview-441071073", "createdAt": "2020-07-01T17:36:44Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNzozNjo0NVrOGrvUCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNzo0MzoyNVrOGrvhog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUxNzEyOQ==", "bodyText": "Move this to be with the other output append, so that it's easy to see the quotes are matching.", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r448517129", "createdAt": "2020-07-01T17:36:45Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.PeekingIterator;\n+import io.prestosql.spi.PrestoException;\n+\n+import static com.google.common.collect.Iterators.peekingIterator;\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_VIEW_TRANSLATION_ERROR;\n+import static java.lang.String.format;\n+import static org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.unescapeSQLString;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    // Translation methods consume data from the iterator\n+    private final PeekingIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is performed.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveViewToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator = new HiveQlToPrestoTranslator(hiveStatement);\n+        return translator.translateQuotedLiterals();\n+    }\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        input = peekingIterator(Lists.charactersOf(hiveQl).iterator());\n+    }\n+\n+    private String translateQuotedLiterals()\n+    {\n+        // Consume input, passing control to other translation methods when\n+        // their delimiters are encountered.\n+        while (input.hasNext()) {\n+            char c = input.next();\n+            switch (c) {\n+                case '\"':\n+                case '\\'':\n+                    translateString(c);\n+                    break;\n+                case '`':\n+                    translateQuotedIdentifier();\n+                    break;\n+                default:\n+                    output.append(c);\n+                    break;\n+            }\n+        }\n+\n+        return output.toString();\n+    }\n+\n+    private void translateString(char delimiter)\n+    {\n+        output.append(\"'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUxODI3MQ==", "bodyText": "No need for format for a simple concatenation\nreturn new PrestoException(HIVE_VIEW_TRANSLATION_ERROR, \"Error translating Hive view to Presto: \" + message);", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r448518271", "createdAt": "2020-07-01T17:38:56Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.PeekingIterator;\n+import io.prestosql.spi.PrestoException;\n+\n+import static com.google.common.collect.Iterators.peekingIterator;\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_VIEW_TRANSLATION_ERROR;\n+import static java.lang.String.format;\n+import static org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.unescapeSQLString;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    // Translation methods consume data from the iterator\n+    private final PeekingIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is performed.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveViewToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator = new HiveQlToPrestoTranslator(hiveStatement);\n+        return translator.translateQuotedLiterals();\n+    }\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        input = peekingIterator(Lists.charactersOf(hiveQl).iterator());\n+    }\n+\n+    private String translateQuotedLiterals()\n+    {\n+        // Consume input, passing control to other translation methods when\n+        // their delimiters are encountered.\n+        while (input.hasNext()) {\n+            char c = input.next();\n+            switch (c) {\n+                case '\"':\n+                case '\\'':\n+                    translateString(c);\n+                    break;\n+                case '`':\n+                    translateQuotedIdentifier();\n+                    break;\n+                default:\n+                    output.append(c);\n+                    break;\n+            }\n+        }\n+\n+        return output.toString();\n+    }\n+\n+    private void translateString(char delimiter)\n+    {\n+        output.append(\"'\");\n+        // Build a copy of the string to pass to Hive's string unescaper\n+        StringBuilder string = new StringBuilder(String.valueOf(delimiter));\n+        while (input.hasNext()) {\n+            char c = input.next();\n+\n+            if (c == delimiter) {\n+                string.append(delimiter);\n+                String unescaped = unescapeSQLString(string.toString());\n+                output.append(unescaped.replace(\"'\", \"''\"));\n+                output.append(\"'\");\n+                return;\n+            }\n+\n+            string.append(c);\n+\n+            if (c == '\\\\') {\n+                if (!input.hasNext()) {\n+                    break; // skip to end-of-input error\n+                }\n+                string.append(input.next());\n+            }\n+        }\n+        throw hiveViewParseError(\"unexpected end of input in string\");\n+    }\n+\n+    private void translateQuotedIdentifier()\n+    {\n+        output.append('\"');\n+        while (input.hasNext()) {\n+            char c = input.next();\n+\n+            // The possible outcomes in an identifier are:\n+            // - replace \" with \"\"\n+            // - leave most characters as-is\n+            // - replace `` with `\n+            // - replace ` with \" and end the identifier\n+            if (c == '\"') {\n+                output.append(\"\\\"\\\"\");\n+            }\n+            else if (c == '`' && input.hasNext() && input.peek() == '`') {\n+                output.append('`');\n+                input.next();\n+            }\n+            else if (c == '`') { // end of identifier\n+                output.append('\"');\n+                return;\n+            }\n+            else {\n+                output.append(c);\n+            }\n+        }\n+\n+        throw hiveViewParseError(\"unexpected end of input in identifier\");\n+    }\n+\n+    private static PrestoException hiveViewParseError(String message)\n+    {\n+        return new PrestoException(HIVE_VIEW_TRANSLATION_ERROR,\n+                format(\"Error translating Hive view to Presto: %s\", message));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMDYxMA==", "bodyText": "Move these comments inline\nif (c == '\"') {\n    // replace \" with \"\"\n}\nelse if (...) {\n    // replace `` with `\n}\nelse if (...) {\n    // end of identifier: replace ` with \" \n}", "url": "https://github.com/trinodb/trino/pull/4258#discussion_r448520610", "createdAt": "2020-07-01T17:43:25Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveQlToPrestoTranslator.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.PeekingIterator;\n+import io.prestosql.spi.PrestoException;\n+\n+import static com.google.common.collect.Iterators.peekingIterator;\n+import static io.prestosql.plugin.hive.HiveErrorCode.HIVE_VIEW_TRANSLATION_ERROR;\n+import static java.lang.String.format;\n+import static org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.unescapeSQLString;\n+\n+/**\n+ * Translate statements in Hive QL to Presto SQL.\n+ *\n+ * Only translation of quoted literals is currently included.\n+ */\n+public final class HiveQlToPrestoTranslator\n+{\n+    // Translation methods consume data from the iterator\n+    private final PeekingIterator<Character> input;\n+    private final StringBuilder output = new StringBuilder();\n+\n+    /**\n+     * Translate a HiveQL statement to Presto SQL by fixing quoted identifiers\n+     * and string literals. No other translation is performed.\n+     *\n+     * <p>Backquotes are replaced with double quotes, including SQL-style\n+     * escapes (`` becomes ` and \" becomes \"\").\n+     *\n+     * <p>Single and double quotes are replaced with single quotes, with\n+     * minimal processing of escape sequences to ensure that the strings end in\n+     * the right place.\n+     */\n+    public static String translateHiveViewToPresto(String hiveStatement)\n+    {\n+        HiveQlToPrestoTranslator translator = new HiveQlToPrestoTranslator(hiveStatement);\n+        return translator.translateQuotedLiterals();\n+    }\n+\n+    private HiveQlToPrestoTranslator(String hiveQl)\n+    {\n+        input = peekingIterator(Lists.charactersOf(hiveQl).iterator());\n+    }\n+\n+    private String translateQuotedLiterals()\n+    {\n+        // Consume input, passing control to other translation methods when\n+        // their delimiters are encountered.\n+        while (input.hasNext()) {\n+            char c = input.next();\n+            switch (c) {\n+                case '\"':\n+                case '\\'':\n+                    translateString(c);\n+                    break;\n+                case '`':\n+                    translateQuotedIdentifier();\n+                    break;\n+                default:\n+                    output.append(c);\n+                    break;\n+            }\n+        }\n+\n+        return output.toString();\n+    }\n+\n+    private void translateString(char delimiter)\n+    {\n+        output.append(\"'\");\n+        // Build a copy of the string to pass to Hive's string unescaper\n+        StringBuilder string = new StringBuilder(String.valueOf(delimiter));\n+        while (input.hasNext()) {\n+            char c = input.next();\n+\n+            if (c == delimiter) {\n+                string.append(delimiter);\n+                String unescaped = unescapeSQLString(string.toString());\n+                output.append(unescaped.replace(\"'\", \"''\"));\n+                output.append(\"'\");\n+                return;\n+            }\n+\n+            string.append(c);\n+\n+            if (c == '\\\\') {\n+                if (!input.hasNext()) {\n+                    break; // skip to end-of-input error\n+                }\n+                string.append(input.next());\n+            }\n+        }\n+        throw hiveViewParseError(\"unexpected end of input in string\");\n+    }\n+\n+    private void translateQuotedIdentifier()\n+    {\n+        output.append('\"');\n+        while (input.hasNext()) {\n+            char c = input.next();\n+\n+            // The possible outcomes in an identifier are:", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 115}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cb7387b129082dafd5b68ded32ed6a7a4c9bef8", "author": {"user": {"login": "jirassimok", "name": "Jacob Ilias Komissar"}}, "url": "https://github.com/trinodb/trino/commit/4cb7387b129082dafd5b68ded32ed6a7a4c9bef8", "committedDate": "2020-07-01T23:26:37Z", "message": "Replace HiveQlTranslation with a non-regex-based parser\n\nSquashed:\n- Use Hive's string unescaping to translate escape sequences in strings"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "4cb7387b129082dafd5b68ded32ed6a7a4c9bef8", "author": {"user": {"login": "jirassimok", "name": "Jacob Ilias Komissar"}}, "url": "https://github.com/trinodb/trino/commit/4cb7387b129082dafd5b68ded32ed6a7a4c9bef8", "committedDate": "2020-07-01T23:26:37Z", "message": "Replace HiveQlTranslation with a non-regex-based parser\n\nSquashed:\n- Use Hive's string unescaping to translate escape sequences in strings"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 248, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}