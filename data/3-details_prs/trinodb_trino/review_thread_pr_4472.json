{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwMDQ5Nzc3", "number": 4472, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1MDowOVrOEPDnvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOTozMDo1OFrOEUiPhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MjIzNDIxOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "isResolved": false, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1MDowOVrOGyjlDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzoxODo0MVrOG4MHjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NDkxMA==", "bodyText": "checkCanShowColumns is dedicated for SHOW COLUMNS statement. Notice that raising error: Cannot show columns of table %s for CREATE TABLE could be a bit misleading.\nInstead I would use io.prestosql.security.AccessControl#filterColumns, then in case all columns were filtered you might need to raise some custom AccessDeniedException", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r455664910", "createdAt": "2020-07-16T09:50:09Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -161,6 +162,10 @@ else if (element instanceof LikeClause) {\n \n                 TableMetadata likeTableMetadata = metadata.getTableMetadata(session, likeTable);\n \n+                accessControl.checkCanShowColumns(\n+                        session.toSecurityContext(),\n+                        new CatalogSchemaTableName(likeTableName.getCatalogName(), likeTableName.asSchemaTableName()));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY5ODE4Mg==", "bodyText": "If we model after DESCRIBE then it should work like that:\n1.checkCanShowColumns\n2.filterColumns and use only those that are visible\nWDYT?", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r455698182", "createdAt": "2020-07-16T10:50:35Z", "author": {"login": "skrzypo987"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -161,6 +162,10 @@ else if (element instanceof LikeClause) {\n \n                 TableMetadata likeTableMetadata = metadata.getTableMetadata(session, likeTable);\n \n+                accessControl.checkCanShowColumns(\n+                        session.toSecurityContext(),\n+                        new CatalogSchemaTableName(likeTableName.getCatalogName(), likeTableName.asSchemaTableName()));\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NDkxMA=="}, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTczMzg1Mw==", "bodyText": "Do you io.prestosql.sql.rewrite.ShowQueriesRewrite.Visitor#visitShowColumns and filterColumns in io.prestosql.metadata.MetadataListing#listTableColumns?\nThat sounds good to me, but I think we might need to have some generic AccessControl::checkCanReferenceTable instead of using visitShowColumns here.\n@electrum, @martint WDYT?", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r455733853", "createdAt": "2020-07-16T12:01:19Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -161,6 +162,10 @@ else if (element instanceof LikeClause) {\n \n                 TableMetadata likeTableMetadata = metadata.getTableMetadata(session, likeTable);\n \n+                accessControl.checkCanShowColumns(\n+                        session.toSecurityContext(),\n+                        new CatalogSchemaTableName(likeTableName.getCatalogName(), likeTableName.asSchemaTableName()));\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NDkxMA=="}, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyMDcyMw==", "bodyText": "What would be the semantics of checkCanReferenceTable? That seems to overlap with checking for SELECT permissions, so it'd be error prone if the implementations of both methods are inconsistent with each other.", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r461220723", "createdAt": "2020-07-27T23:07:19Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -161,6 +162,10 @@ else if (element instanceof LikeClause) {\n \n                 TableMetadata likeTableMetadata = metadata.getTableMetadata(session, likeTable);\n \n+                accessControl.checkCanShowColumns(\n+                        session.toSecurityContext(),\n+                        new CatalogSchemaTableName(likeTableName.getCatalogName(), likeTableName.asSchemaTableName()));\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NDkxMA=="}, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUwMjU3Mg==", "bodyText": "What would be the semantics of checkCanReferenceTable?\n\nIMO it should allow to reference table anytime it is not filtered by filterTables. So if user has any privilege to a table or any its columns.\nAs I understand user does not have to have SELECT access to do CREATE TABLE LIKE. For example INSERT could also be good enough here.", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r461502572", "createdAt": "2020-07-28T11:13:47Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -161,6 +162,10 @@ else if (element instanceof LikeClause) {\n \n                 TableMetadata likeTableMetadata = metadata.getTableMetadata(session, likeTable);\n \n+                accessControl.checkCanShowColumns(\n+                        session.toSecurityContext(),\n+                        new CatalogSchemaTableName(likeTableName.getCatalogName(), likeTableName.asSchemaTableName()));\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NDkxMA=="}, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUxNTAzMw==", "bodyText": "One more though. Since we are requiring admin-like privileges for SHOW CREATE TABLE as that could reveal sensitive data (table properties) then maybe we need admin-like privileges here as well. Because here we also could access sensitive data. It is a bit unitive to me, but it is coherent and secure. That way we could simply call checkCanShowCreateTable here and overwrite the error message that table cannot be used in CREATE TABLE LIKE.\n@skrzypo987 @martint What do you think? Then this pull request could become very simple. No need to do filterColumns etc.", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r461515033", "createdAt": "2020-07-28T11:39:31Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -161,6 +162,10 @@ else if (element instanceof LikeClause) {\n \n                 TableMetadata likeTableMetadata = metadata.getTableMetadata(session, likeTable);\n \n+                accessControl.checkCanShowColumns(\n+                        session.toSecurityContext(),\n+                        new CatalogSchemaTableName(likeTableName.getCatalogName(), likeTableName.asSchemaTableName()));\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NDkxMA=="}, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU0NDY5NQ==", "bodyText": "This seems reasonable If and only if the LIKE statement can retrieve data that DESCRIBE cannot.", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r461544695", "createdAt": "2020-07-28T12:35:48Z", "author": {"login": "skrzypo987"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -161,6 +162,10 @@ else if (element instanceof LikeClause) {\n \n                 TableMetadata likeTableMetadata = metadata.getTableMetadata(session, likeTable);\n \n+                accessControl.checkCanShowColumns(\n+                        session.toSecurityContext(),\n+                        new CatalogSchemaTableName(likeTableName.getCatalogName(), likeTableName.asSchemaTableName()));\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NDkxMA=="}, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU3MTk4MA==", "bodyText": "This seems reasonable If and only if the LIKE statement can retrieve data that DESCRIBE cannot.\n\nSo this is the case when we are copying table properties. If we are just copying columns then maybe describe is enough, but what about column filtering, it seems needed then.", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r461571980", "createdAt": "2020-07-28T13:18:41Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -161,6 +162,10 @@ else if (element instanceof LikeClause) {\n \n                 TableMetadata likeTableMetadata = metadata.getTableMetadata(session, likeTable);\n \n+                accessControl.checkCanShowColumns(\n+                        session.toSecurityContext(),\n+                        new CatalogSchemaTableName(likeTableName.getCatalogName(), likeTableName.asSchemaTableName()));\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NDkxMA=="}, "originalCommit": null, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MjIzNTE2OnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/execution/TestCreateTableTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1MDoyM1rOGyjlnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1MDoyM1rOGyjlnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NTA1NQ==", "bodyText": "final", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r455665055", "createdAt": "2020-07-16T09:50:23Z", "author": {"login": "kokosing"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestCreateTableTask.java", "diffHunk": "@@ -77,14 +93,20 @@\n public class TestCreateTableTask\n {\n     private static final String CATALOG_NAME = \"catalog\";\n+    private static ConnectorTableMetadata PARENT_TABLE = new ConnectorTableMetadata(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MjI0NjUzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/execution/TestCreateTableTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1MzoxNFrOGyjsmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1MzoxNFrOGyjsmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2Njg0MA==", "bodyText": "reference PARENT_TABLE here", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r455666840", "createdAt": "2020-07-16T09:53:14Z", "author": {"login": "kokosing"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestCreateTableTask.java", "diffHunk": "@@ -186,6 +208,62 @@ public void testCreateWithUnsupportedConnectorThrowsWhenNotNull()\n                 .hasMessage(\"Catalog 'catalog' does not support non-null column for column name 'b'\");\n     }\n \n+    @Test\n+    public void testCreateLike()\n+    {\n+        CreateTable statement = new CreateTable(\n+                QualifiedName.of(\"test_table\"),\n+                List.of(new LikeClause(QualifiedName.of(\"parent_table\"), Optional.empty())),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MjI0ODgyOnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/execution/TestCreateTableTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1Mzo0N1rOGyjt9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1Mzo0N1rOGyjt9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NzE5MQ==", "bodyText": "reference PARENT_TABLE here", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r455667191", "createdAt": "2020-07-16T09:53:47Z", "author": {"login": "kokosing"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestCreateTableTask.java", "diffHunk": "@@ -186,6 +208,62 @@ public void testCreateWithUnsupportedConnectorThrowsWhenNotNull()\n                 .hasMessage(\"Catalog 'catalog' does not support non-null column for column name 'b'\");\n     }\n \n+    @Test\n+    public void testCreateLike()\n+    {\n+        CreateTable statement = new CreateTable(\n+                QualifiedName.of(\"test_table\"),\n+                List.of(new LikeClause(QualifiedName.of(\"parent_table\"), Optional.empty())),\n+                true,\n+                ImmutableList.of(),\n+                Optional.empty());\n+\n+        new CreateTableTask().internalExecute(statement, metadata, new AllowAllAccessControl(), testSession, List.of());\n+        assertEquals(metadata.getCreateTableCallCount(), 1);\n+\n+        assertThat(metadata.getReceivedTableMetadata().get(0).getColumns())\n+                .isEqualTo(PARENT_TABLE.getColumns());\n+        assertThat(metadata.getReceivedTableMetadata().get(0).getProperties())\n+                .isNotEqualTo(PARENT_TABLE.getProperties());\n+    }\n+\n+    @Test\n+    public void testCreateLikeWithProperties()\n+    {\n+        CreateTable statement = new CreateTable(\n+                QualifiedName.of(\"test_table\"),\n+                List.of(new LikeClause(QualifiedName.of(\"parent_table\"), Optional.of(INCLUDING))),\n+                true,\n+                ImmutableList.of(),\n+                Optional.empty());\n+\n+        new CreateTableTask().internalExecute(statement, metadata, new AllowAllAccessControl(), testSession, List.of());\n+        assertEquals(metadata.getCreateTableCallCount(), 1);\n+\n+        assertThat(metadata.getReceivedTableMetadata().get(0).getColumns())\n+                .isEqualTo(PARENT_TABLE.getColumns());\n+        assertThat(metadata.getReceivedTableMetadata().get(0).getProperties())\n+                .isEqualTo(PARENT_TABLE.getProperties());\n+    }\n+\n+    @Test\n+    public void testCreateLikeDenyPermission()\n+    {\n+        CreateTable statement = new CreateTable(\n+                QualifiedName.of(\"test_table\"),\n+                List.of(new LikeClause(QualifiedName.of(\"parent_table\"), Optional.empty())),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 136}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MjI0OTM0OnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/execution/TestCreateTableTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1Mzo1NlrOGyjuSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1Mzo1NlrOGyjuSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NzI3NA==", "bodyText": "reference PARENT_TABLE here", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r455667274", "createdAt": "2020-07-16T09:53:56Z", "author": {"login": "kokosing"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestCreateTableTask.java", "diffHunk": "@@ -186,6 +208,62 @@ public void testCreateWithUnsupportedConnectorThrowsWhenNotNull()\n                 .hasMessage(\"Catalog 'catalog' does not support non-null column for column name 'b'\");\n     }\n \n+    @Test\n+    public void testCreateLike()\n+    {\n+        CreateTable statement = new CreateTable(\n+                QualifiedName.of(\"test_table\"),\n+                List.of(new LikeClause(QualifiedName.of(\"parent_table\"), Optional.empty())),\n+                true,\n+                ImmutableList.of(),\n+                Optional.empty());\n+\n+        new CreateTableTask().internalExecute(statement, metadata, new AllowAllAccessControl(), testSession, List.of());\n+        assertEquals(metadata.getCreateTableCallCount(), 1);\n+\n+        assertThat(metadata.getReceivedTableMetadata().get(0).getColumns())\n+                .isEqualTo(PARENT_TABLE.getColumns());\n+        assertThat(metadata.getReceivedTableMetadata().get(0).getProperties())\n+                .isNotEqualTo(PARENT_TABLE.getProperties());\n+    }\n+\n+    @Test\n+    public void testCreateLikeWithProperties()\n+    {\n+        CreateTable statement = new CreateTable(\n+                QualifiedName.of(\"test_table\"),\n+                List.of(new LikeClause(QualifiedName.of(\"parent_table\"), Optional.of(INCLUDING))),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 117}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MjI1MTM5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/execution/TestCreateTableTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1NDozNFrOGyjvqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1NDozNFrOGyjvqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NzYyNg==", "bodyText": "can you assert that there are no properties?", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r455667626", "createdAt": "2020-07-16T09:54:34Z", "author": {"login": "kokosing"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestCreateTableTask.java", "diffHunk": "@@ -186,6 +208,62 @@ public void testCreateWithUnsupportedConnectorThrowsWhenNotNull()\n                 .hasMessage(\"Catalog 'catalog' does not support non-null column for column name 'b'\");\n     }\n \n+    @Test\n+    public void testCreateLike()\n+    {\n+        CreateTable statement = new CreateTable(\n+                QualifiedName.of(\"test_table\"),\n+                List.of(new LikeClause(QualifiedName.of(\"parent_table\"), Optional.empty())),\n+                true,\n+                ImmutableList.of(),\n+                Optional.empty());\n+\n+        new CreateTableTask().internalExecute(statement, metadata, new AllowAllAccessControl(), testSession, List.of());\n+        assertEquals(metadata.getCreateTableCallCount(), 1);\n+\n+        assertThat(metadata.getReceivedTableMetadata().get(0).getColumns())\n+                .isEqualTo(PARENT_TABLE.getColumns());\n+        assertThat(metadata.getReceivedTableMetadata().get(0).getProperties())\n+                .isNotEqualTo(PARENT_TABLE.getProperties());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MjI1NTIxOnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/execution/TestCreateTableTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1NTozNFrOGyjyAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTo1NTozNFrOGyjyAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2ODIyNA==", "bodyText": "verify that tableHandle references PARENT_TABLE", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r455668224", "createdAt": "2020-07-16T09:55:34Z", "author": {"login": "kokosing"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestCreateTableTask.java", "diffHunk": "@@ -260,9 +338,23 @@ public Type fromSqlType(String sqlType)\n         @Override\n         public Optional<TableHandle> getTableHandle(Session session, QualifiedObjectName tableName)\n         {\n+            if (tableName.asSchemaTableName().equals(PARENT_TABLE.getTable())) {\n+                return Optional.of(\n+                        new TableHandle(\n+                                new CatalogName(CATALOG_NAME),\n+                                new TestingTableHandle(tableName.asSchemaTableName()),\n+                                TestingConnectorTransactionHandle.INSTANCE,\n+                                Optional.empty()));\n+            }\n             return Optional.empty();\n         }\n \n+        @Override\n+        public TableMetadata getTableMetadata(Session session, TableHandle tableHandle)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 168}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NzM2NTc2OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNzozMTo0NVrOG0ro1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwOToyMDozM1rOG0vgqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5NDEwMg==", "bodyText": "toImmutableList() let's be consistent with the current convention. Consider changing the convention in the separate pull request.", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r457894102", "createdAt": "2020-07-21T07:31:45Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -170,8 +182,12 @@ else if (element instanceof LikeClause) {\n                     inheritedProperties = likeTableMetadata.getMetadata().getProperties();\n                 }\n \n-                likeTableMetadata.getColumns().stream()\n-                        .filter(column -> !column.isHidden())\n+                accessControl.filterColumns(\n+                        session.toSecurityContext(),\n+                        tableName.asCatalogSchemaTableName(),\n+                        likeTableMetadata.getColumns().stream()\n+                                .filter(column -> !column.isHidden())\n+                                .collect(toUnmodifiableList()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk1NzU0NQ==", "bodyText": "Wow. I haven't even noticed. I guess this is the default idea behaviour now.", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r457957545", "createdAt": "2020-07-21T09:20:33Z", "author": {"login": "skrzypo987"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -170,8 +182,12 @@ else if (element instanceof LikeClause) {\n                     inheritedProperties = likeTableMetadata.getMetadata().getProperties();\n                 }\n \n-                likeTableMetadata.getColumns().stream()\n-                        .filter(column -> !column.isHidden())\n+                accessControl.filterColumns(\n+                        session.toSecurityContext(),\n+                        tableName.asCatalogSchemaTableName(),\n+                        likeTableMetadata.getColumns().stream()\n+                                .filter(column -> !column.isHidden())\n+                                .collect(toUnmodifiableList()))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5NDEwMg=="}, "originalCommit": null, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NzM2NzkwOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNzozMjoyNVrOG0rqIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxODowMTo1MVrOG7DcvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5NDQzNQ==", "bodyText": "What is happening when all columns are filtered? Do you have test for that?", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r457894435", "createdAt": "2020-07-21T07:32:25Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -170,8 +182,12 @@ else if (element instanceof LikeClause) {\n                     inheritedProperties = likeTableMetadata.getMetadata().getProperties();\n                 }\n \n-                likeTableMetadata.getColumns().stream()\n-                        .filter(column -> !column.isHidden())\n+                accessControl.filterColumns(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk1NzgwNw==", "bodyText": "No columns are added then. Is that not a desired outcome?", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r457957807", "createdAt": "2020-07-21T09:20:59Z", "author": {"login": "skrzypo987"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -170,8 +182,12 @@ else if (element instanceof LikeClause) {\n                     inheritedProperties = likeTableMetadata.getMetadata().getProperties();\n                 }\n \n-                likeTableMetadata.getColumns().stream()\n-                        .filter(column -> !column.isHidden())\n+                accessControl.filterColumns(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5NDQzNQ=="}, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAzMDE4Nw==", "bodyText": "That is the question. I think it is not a desired behavior. Notice wants to access some columns but he has no access to any, so result could be unexpected.\nAlso the more I think about it I think we should consider changing the approach. LIKE existing_table_name is like SELECT * so user wants to access all columns and in case we filter any of them we might need to raise an error.\n@martint What are your thoughts about it? Is CREATE TABLE table_name (LIKE existing_table_name) a ANSI SQL defined behaviour?", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r458030187", "createdAt": "2020-07-21T11:36:33Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -170,8 +182,12 @@ else if (element instanceof LikeClause) {\n                     inheritedProperties = likeTableMetadata.getMetadata().getProperties();\n                 }\n \n-                likeTableMetadata.getColumns().stream()\n-                        .filter(column -> !column.isHidden())\n+                accessControl.filterColumns(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5NDQzNQ=="}, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwMjI0Nw==", "bodyText": "Yes, that is ANSI SQL behavior. This is what the spec says regarding permissions:\n2) If a <like clause> is contained in a <table definition>, then the applicable privileges for A shall include SELECT privilege on the table identified in the <like clause>.", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r461702247", "createdAt": "2020-07-28T16:10:50Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -170,8 +182,12 @@ else if (element instanceof LikeClause) {\n                     inheritedProperties = likeTableMetadata.getMetadata().getProperties();\n                 }\n \n-                likeTableMetadata.getColumns().stream()\n-                        .filter(column -> !column.isHidden())\n+                accessControl.filterColumns(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5NDQzNQ=="}, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE2MDU0MQ==", "bodyText": "A shall include SELECT privilege on the table identified\n\nThat translates to having SELECT privilege on all columns.\nSo my suggestion here is to verify two things here:\n\ncheck if user have SELECT privilege on all columns on the table identified in the <like clause>\nif properties are included, then we also need to check if user checkCanShowCreateTable on the table identified in the <like clause> to prevent leakage of sensitive information like storage location\n\n@martint do you agree?", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r462160541", "createdAt": "2020-07-29T09:20:50Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -170,8 +182,12 @@ else if (element instanceof LikeClause) {\n                     inheritedProperties = likeTableMetadata.getMetadata().getProperties();\n                 }\n \n-                likeTableMetadata.getColumns().stream()\n-                        .filter(column -> !column.isHidden())\n+                accessControl.filterColumns(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5NDQzNQ=="}, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3NTY3Nw==", "bodyText": "Yes, that makes sense.", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r464575677", "createdAt": "2020-08-03T18:01:51Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -170,8 +182,12 @@ else if (element instanceof LikeClause) {\n                     inheritedProperties = likeTableMetadata.getMetadata().getProperties();\n                 }\n \n-                likeTableMetadata.getColumns().stream()\n-                        .filter(column -> !column.isHidden())\n+                accessControl.filterColumns(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5NDQzNQ=="}, "originalCommit": null, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5OTY2Njg2OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOToyNzoxOVrOG6yiJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOToyNzoxOVrOG6yiJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI5ODUzNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    throw new AccessDeniedException(\"Cannot reference properties of table \" + likeTableName);\n          \n          \n            \n                                    throw new AccessDeniedException(\"Cannot reference <span class=\"x x-first x-last\">columns and </span>properties of table \" + likeTableName);", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r464298535", "createdAt": "2020-08-03T09:27:19Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -170,6 +174,26 @@ else if (element instanceof LikeClause) {\n                     inheritedProperties = likeTableMetadata.getMetadata().getProperties();\n                 }\n \n+                if (propertiesOption.orElse(EXCLUDING) == INCLUDING) {\n+                    try {\n+                        accessControl.checkCanShowCreateTable(session.toSecurityContext(), likeTableName);\n+                    }\n+                    catch (AccessDeniedException e) {\n+                        throw new AccessDeniedException(\"Cannot reference properties of table \" + likeTableName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5OTY2ODAwOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOToyNzo0M1rOG6yi4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOToyNzo0M1rOG6yi4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI5ODcyMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            likeTableMetadata.getColumns().stream()<span class=\"x x-first x-last\">.map(ColumnMetadata::getName).collect(toImmutableSet()));</span>\n          \n          \n            \n                                            likeTableMetadata.getColumns().stream()\n          \n          \n            \n                                                  .map(ColumnMetadata::getName)\n          \n          \n            \n                                                  .collect(toImmutableSet()));", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r464298723", "createdAt": "2020-08-03T09:27:43Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -170,6 +174,26 @@ else if (element instanceof LikeClause) {\n                     inheritedProperties = likeTableMetadata.getMetadata().getProperties();\n                 }\n \n+                if (propertiesOption.orElse(EXCLUDING) == INCLUDING) {\n+                    try {\n+                        accessControl.checkCanShowCreateTable(session.toSecurityContext(), likeTableName);\n+                    }\n+                    catch (AccessDeniedException e) {\n+                        throw new AccessDeniedException(\"Cannot reference properties of table \" + likeTableName);\n+                    }\n+                }\n+                else {\n+                    try {\n+                        accessControl.checkCanSelectFromColumns(\n+                                session.toSecurityContext(),\n+                                likeTableName,\n+                                likeTableMetadata.getColumns().stream().map(ColumnMetadata::getName).collect(toImmutableSet()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5OTY4MDA1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOTozMDo1OFrOG6yp1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOTozMDo1OFrOG6yp1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMwMDUwMw==", "bodyText": "I think we should check this unconditionally (always). Successful checkCanShowCreateTable does not imply successful checkCanSelectFromColumns.", "url": "https://github.com/trinodb/trino/pull/4472#discussion_r464300503", "createdAt": "2020-08-03T09:30:58Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateTableTask.java", "diffHunk": "@@ -170,6 +174,26 @@ else if (element instanceof LikeClause) {\n                     inheritedProperties = likeTableMetadata.getMetadata().getProperties();\n                 }\n \n+                if (propertiesOption.orElse(EXCLUDING) == INCLUDING) {\n+                    try {\n+                        accessControl.checkCanShowCreateTable(session.toSecurityContext(), likeTableName);\n+                    }\n+                    catch (AccessDeniedException e) {\n+                        throw new AccessDeniedException(\"Cannot reference properties of table \" + likeTableName);\n+                    }\n+                }\n+                else {\n+                    try {\n+                        accessControl.checkCanSelectFromColumns(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3660, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}