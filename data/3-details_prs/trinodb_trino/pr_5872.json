{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3Mzc3Nzcx", "number": 5872, "title": "Add scan physical size stats to query completed event", "bodyText": "", "createdAt": "2020-11-08T22:02:42Z", "url": "https://github.com/trinodb/trino/pull/5872", "merged": true, "mergeCommit": {"oid": "65167a5ebd06dde3d3f18061f0e8a51c6867209b"}, "closed": true, "closedAt": "2020-11-19T18:58:41Z", "author": {"login": "dain"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdauP1uAFqTUyNTg1MTM3NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdd-JD5gFqTUzNDE2MjYxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1ODUxMzc1", "url": "https://github.com/trinodb/trino/pull/5872#pullrequestreview-525851375", "createdAt": "2020-11-08T22:23:37Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMjoyMzozN1rOHva4Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwNTo0MjowMFrOHvfppw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ4NTU0Mg==", "bodyText": "nit: grammar typo, remove that in ... parent node that with stats?", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r519485542", "createdAt": "2020-11-08T22:23:37Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -339,6 +371,58 @@ private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n         return new QueryIOMetadata(inputs.build(), output);\n     }\n \n+    private static Multimap<QualifiedObjectName, OperatorStats> extractTableScanOperatorStats(QueryInfo queryInfo)\n+    {\n+        // Note: A plan may scan a table multiple times.\n+        ImmutableMultimap.Builder<QualifiedObjectName, OperatorStats> tableScanOperatorStats = ImmutableMultimap.builder();\n+        getAllStages(queryInfo.getOutputStage())\n+                .forEach(stageInfo -> extractTableScanOperatorStats(stageInfo, tableScanOperatorStats));\n+        return tableScanOperatorStats.build();\n+    }\n+\n+    private static void extractTableScanOperatorStats(StageInfo stageInfo, ImmutableMultimap.Builder<QualifiedObjectName, OperatorStats> tableScanOperatorStats)\n+    {\n+        if (stageInfo.getPlan() == null) {\n+            return;\n+        }\n+\n+        // Note: a plan node may be mapped to multiple operators.  For this code it doesn't matter\n+        // since only the table scan operator has physical stats, but be careful for any other use.\n+        Map<PlanNodeId, Collection<OperatorStats>> allOperatorStats = Multimaps.index(stageInfo.getStageStats().getOperatorSummaries(), OperatorStats::getPlanNodeId).asMap();\n+\n+        // Find the operator stats for each table scanned.  Sometimes a table scan is merged with\n+        // other operators, and in that case, use the stats of the nearest parent node that with stats.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1OTAzNw==", "bodyText": "optional suggestion: the name may sound like the method is trying to get stats for TableScanOperator, which might not be true. May be switching the order can help e.g. extractStatsForTableScan?", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r519559037", "createdAt": "2020-11-09T05:23:31Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -339,6 +371,58 @@ private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n         return new QueryIOMetadata(inputs.build(), output);\n     }\n \n+    private static Multimap<QualifiedObjectName, OperatorStats> extractTableScanOperatorStats(QueryInfo queryInfo)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU2MzMyMQ==", "bodyText": "If two inputs for the same table are added with different columns, then this logic will add the same aggregate value for both the inputs right? Should we add a plan node id to Inputinstead and map the stats here appropriately?", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r519563321", "createdAt": "2020-11-09T05:40:30Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -309,15 +322,34 @@ private QueryContext createQueryContext(SessionRepresentation session, Optional<\n \n     private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n     {\n+        Multimap<QualifiedObjectName, OperatorStats> tableOperatorStats = extractTableScanOperatorStats(queryInfo);\n+\n         ImmutableList.Builder<QueryInputMetadata> inputs = ImmutableList.builder();\n         for (Input input : queryInfo.getInputs()) {\n+            // Note: input table may be scanned multiple times", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU2MzY4Nw==", "bodyText": "should we also add the same logic for IndexSourceScanNode like in InputExtractor?", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r519563687", "createdAt": "2020-11-09T05:42:00Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -339,6 +371,58 @@ private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n         return new QueryIOMetadata(inputs.build(), output);\n     }\n \n+    private static Multimap<QualifiedObjectName, OperatorStats> extractTableScanOperatorStats(QueryInfo queryInfo)\n+    {\n+        // Note: A plan may scan a table multiple times.\n+        ImmutableMultimap.Builder<QualifiedObjectName, OperatorStats> tableScanOperatorStats = ImmutableMultimap.builder();\n+        getAllStages(queryInfo.getOutputStage())\n+                .forEach(stageInfo -> extractTableScanOperatorStats(stageInfo, tableScanOperatorStats));\n+        return tableScanOperatorStats.build();\n+    }\n+\n+    private static void extractTableScanOperatorStats(StageInfo stageInfo, ImmutableMultimap.Builder<QualifiedObjectName, OperatorStats> tableScanOperatorStats)\n+    {\n+        if (stageInfo.getPlan() == null) {\n+            return;\n+        }\n+\n+        // Note: a plan node may be mapped to multiple operators.  For this code it doesn't matter\n+        // since only the table scan operator has physical stats, but be careful for any other use.\n+        Map<PlanNodeId, Collection<OperatorStats>> allOperatorStats = Multimaps.index(stageInfo.getStageStats().getOperatorSummaries(), OperatorStats::getPlanNodeId).asMap();\n+\n+        // Find the operator stats for each table scanned.  Sometimes a table scan is merged with\n+        // other operators, and in that case, use the stats of the nearest parent node that with stats.\n+        stageInfo.getPlan().getRoot().accept(\n+                new PlanVisitor<Void, Collection<OperatorStats>>()\n+                {\n+                    @Override\n+                    protected Void visitPlan(PlanNode node, Collection<OperatorStats> parentStats)\n+                    {\n+                        for (PlanNode child : node.getSources()) {\n+                            child.accept(this, allOperatorStats.getOrDefault(node.getId(), parentStats));\n+                        }\n+                        return null;\n+                    }\n+\n+                    @Override\n+                    public Void visitTableScan(TableScanNode node, Collection<OperatorStats> parentStats)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 129}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxOTQxNTk5", "url": "https://github.com/trinodb/trino/pull/5872#pullrequestreview-531941599", "createdAt": "2020-11-17T00:54:26Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMDo1NDoyNlrOH0gHmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjoyMzo0NFrOH0h3jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxNDIzMg==", "bodyText": "nit: rename context parameter", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r524814232", "createdAt": "2020-11-17T00:54:26Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/InputExtractor.java", "diffHunk": "@@ -75,37 +79,31 @@ private Input createInput(Session session, TableHandle table, Set<Column> column\n         }\n \n         @Override\n-        public Void visitTableScan(TableScanNode node, Void context)\n+        public Void visitTableScan(TableScanNode node, PlanFragmentId fragmentId)\n         {\n-            TableHandle tableHandle = node.getTable();\n-\n-            Set<Column> columns = new HashSet<>();\n-            for (ColumnHandle columnHandle : node.getAssignments().values()) {\n-                columns.add(createColumn(metadata.getColumnMetadata(session, tableHandle, columnHandle)));\n-            }\n-\n-            inputs.add(createInput(session, tableHandle, columns));\n-\n+            processScan(fragmentId, node.getId(), node.getTable(), node.getAssignments());\n             return null;\n         }\n \n         @Override\n-        public Void visitIndexSource(IndexSourceNode node, Void context)\n+        public Void visitIndexSource(IndexSourceNode node, PlanFragmentId fragmentId)\n         {\n-            TableHandle tableHandle = node.getTableHandle();\n+            processScan(fragmentId, node.getId(), node.getTableHandle(), node.getAssignments());\n+            return null;\n+        }\n \n+        private void processScan(PlanFragmentId fragmentId, PlanNodeId planNodeId, TableHandle tableHandle, Map<Symbol, ColumnHandle> assignments)\n+        {\n             Set<Column> columns = new HashSet<>();\n-            for (ColumnHandle columnHandle : node.getAssignments().values()) {\n+            for (ColumnHandle columnHandle : assignments.values()) {\n                 columns.add(createColumn(metadata.getColumnMetadata(session, tableHandle, columnHandle)));\n             }\n \n-            inputs.add(createInput(session, tableHandle, columns));\n-\n-            return null;\n+            inputs.add(createInput(session, tableHandle, columns, fragmentId, planNodeId));\n         }\n \n         @Override\n-        protected Void visitPlan(PlanNode node, Void context)\n+        protected Void visitPlan(PlanNode node, PlanFragmentId context)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgyMTY3NA==", "bodyText": "nit: typo with with?", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r524821674", "createdAt": "2020-11-17T01:16:53Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -339,6 +374,71 @@ private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n         return new QueryIOMetadata(inputs.build(), output);\n     }\n \n+    private static Multimap<FragmentNode, OperatorStats> extractStatsForTableScan(QueryInfo queryInfo)\n+    {\n+        // Note: A plan may scan a table multiple times.\n+        ImmutableMultimap.Builder<FragmentNode, OperatorStats> tableScanOperatorStats = ImmutableMultimap.builder();\n+        getAllStages(queryInfo.getOutputStage())\n+                .forEach(stageInfo -> extractStatsForTableScan(stageInfo, tableScanOperatorStats));\n+        return tableScanOperatorStats.build();\n+    }\n+\n+    private static void extractStatsForTableScan(StageInfo stageInfo, ImmutableMultimap.Builder<FragmentNode, OperatorStats> tableScanOperatorStats)\n+    {\n+        final PlanFragment fragment = stageInfo.getPlan();\n+        if (fragment == null) {\n+            return;\n+        }\n+\n+        // Note: a plan node may be mapped to multiple operators.  For this code it doesn't matter\n+        // since only the table scan operator has physical stats, but be careful for any other use.\n+        Map<PlanNodeId, Collection<OperatorStats>> allOperatorStats = Multimaps.index(stageInfo.getStageStats().getOperatorSummaries(), OperatorStats::getPlanNodeId).asMap();\n+\n+        // Find the operator stats for each table scanned.  Sometimes a table scan is merged with\n+        // other operators, and in that case, use the stats of the nearest parent node with with stats.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgzMzQwNQ==", "bodyText": "since the reason behind the usage of Multimap below is that the a plannode can correspond to multiple operators, so the comment might be a bit misleading", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r524833405", "createdAt": "2020-11-17T01:51:50Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -339,6 +374,71 @@ private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n         return new QueryIOMetadata(inputs.build(), output);\n     }\n \n+    private static Multimap<FragmentNode, OperatorStats> extractStatsForTableScan(QueryInfo queryInfo)\n+    {\n+        // Note: A plan may scan a table multiple times.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgzODkyNQ==", "bodyText": "since we're now keying on FragmentNode, we could exclude the \"table scan\" logic here, and just invoke an extractStats method that treats all nodes equally. I think that may be easier to reason about.\nThe visitor can just have\n                    protected Void visitPlan(PlanNode node, Collection<OperatorStats> parentStats)\n                    {\n                        if (parentStats != null) {\n                            tableScanOperatorStats.putAll(new FragmentNode(fragment.getId(), node.getId()), allOperatorStats.getOrDefault(node.getId(), parentStats));\n                        }\n\n                        for (PlanNode child : node.getSources()) {\n                            child.accept(this, allOperatorStats.getOrDefault(node.getId(), parentStats));\n                        }\n                        return null;\n                    }\n\nBut if you'd like to make this method stand-out specifically for table scan stats usecase (and save some bytes), the current implementation seems fine too.", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r524838925", "createdAt": "2020-11-17T02:10:17Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -309,15 +325,34 @@ private QueryContext createQueryContext(SessionRepresentation session, Optional<\n \n     private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n     {\n+        Multimap<FragmentNode, OperatorStats> tableOperatorStats = extractStatsForTableScan(queryInfo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0MDM2NA==", "bodyText": "same comment about the comment here: the reason seems to be a plan node corresponding to multiple operators", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r524840364", "createdAt": "2020-11-17T02:15:21Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -309,15 +325,34 @@ private QueryContext createQueryContext(SessionRepresentation session, Optional<\n \n     private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n     {\n+        Multimap<FragmentNode, OperatorStats> tableOperatorStats = extractStatsForTableScan(queryInfo);\n+\n         ImmutableList.Builder<QueryInputMetadata> inputs = ImmutableList.builder();\n         for (Input input : queryInfo.getInputs()) {\n+            // Note: input table may be scanned multiple times\n+            Collection<OperatorStats> inputTableOperatorStats = tableOperatorStats.get(new FragmentNode(input.getFragmentId(), input.getPlanNodeId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0Mjg5Mg==", "bodyText": "The logic here seems to be kind of non-trivial to me, I was wondering if it'd be worth adding a unit test (for this or  the caller method). Not sure if there's a straightforward way currently.", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r524842892", "createdAt": "2020-11-17T02:23:44Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -339,6 +374,71 @@ private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n         return new QueryIOMetadata(inputs.build(), output);\n     }\n \n+    private static Multimap<FragmentNode, OperatorStats> extractStatsForTableScan(QueryInfo queryInfo)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 95}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a2b48ab3bc1467032f14cfcffc4897b71ef433f", "author": {"user": {"login": "dain", "name": "Dain Sundstrom"}}, "url": "https://github.com/trinodb/trino/commit/1a2b48ab3bc1467032f14cfcffc4897b71ef433f", "committedDate": "2020-11-18T23:19:21Z", "message": "Add scan physical size stats to query completed event"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "1a2b48ab3bc1467032f14cfcffc4897b71ef433f", "author": {"user": {"login": "dain", "name": "Dain Sundstrom"}}, "url": "https://github.com/trinodb/trino/commit/1a2b48ab3bc1467032f14cfcffc4897b71ef433f", "committedDate": "2020-11-18T23:19:21Z", "message": "Add scan physical size stats to query completed event"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MTYyNjEz", "url": "https://github.com/trinodb/trino/pull/5872#pullrequestreview-534162613", "createdAt": "2020-11-19T08:05:03Z", "commit": {"oid": "1a2b48ab3bc1467032f14cfcffc4897b71ef433f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2921, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}