{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1Mzg3ODg5", "number": 3470, "title": "Fire PushPredicateIntoTableScan rule with change in TableHandle", "bodyText": "If there's a constraint in the filter node that the connector can \"enforce\", PushPredicateIntoTableScan modifies the plan to incorporate the new scan and residue filter.\nIn case of non-partition pushdown for hive, this is not true. The \"compactEffectivePredicate\" added to the table handle may or may not be satisfied by the HivePageSource (eg. ORC vs Avro). So we cannot get rid of those predicates from the FilterNode. But even though HiveMetadata::applyFilter returns a ConstraintApplicationResult, PushPredicateIntoTableScan throws it away, since arePlansSame doesn't consider change in table handles, if the enforced constraint hasn't changed. eg. Test added in TestConnectorPushdownRulesWithHive fails without this change.\nPredicates on top level columns still get pushed down to ORC/Parquet without this change, because AddExchanges::visitFilter adds the predicates, but I think the predicates should get pushed down in PushPredicateIntoTableScan.\nI added connector table handle comparison in arePlansSame. (That failed some tests initially due to the fact that BucketFilter equality was object reference based, now they pass). But I'm not sure if comparing connector table handles is okay, or we need a better approach to tell that there was \"some level\" of predicate pushdown, even if it's not guaranteed to be enforced.\nThis change is also required for #1720 and #2672 to work together to pushdown predicates on nested columns.", "createdAt": "2020-04-18T00:00:21Z", "url": "https://github.com/trinodb/trino/pull/3470", "merged": true, "mergeCommit": {"oid": "13d6b297620af3fd37e4047e60080e9ae97113ad"}, "closed": true, "closedAt": "2020-04-23T01:38:47Z", "author": {"login": "phd3"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcY87UxABqjMyNDg0MTg1Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaPva0gBqjMyNjI2MzI0OTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2OTUxNTA3", "url": "https://github.com/trinodb/trino/pull/3470#pullrequestreview-396951507", "createdAt": "2020-04-21T02:50:46Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMjo1MDo0NlrOGIwFFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMjo1MDo0NlrOGIwFFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgyOTUyNQ==", "bodyText": "This should compare the table handles directly. This layer of the code (i.e., the optimizer) shouldn't be concerned about ConnectorTableHandle.", "url": "https://github.com/trinodb/trino/pull/3470#discussion_r411829525", "createdAt": "2020-04-21T02:50:46Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/rule/PushPredicateIntoTableScan.java", "diffHunk": "@@ -131,7 +131,8 @@ private boolean arePlansSame(FilterNode filter, TableScanNode tableScan, PlanNod\n \n         TableScanNode rewrittenTableScan = (TableScanNode) rewrittenFilter.getSource();\n \n-        return Objects.equals(tableScan.getEnforcedConstraint(), rewrittenTableScan.getEnforcedConstraint());\n+        return Objects.equals(tableScan.getEnforcedConstraint(), rewrittenTableScan.getEnforcedConstraint()) &&\n+                Objects.equals(tableScan.getTable().getConnectorHandle(), rewrittenTableScan.getTable().getConnectorHandle());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NTQzMzgx", "url": "https://github.com/trinodb/trino/pull/3470#pullrequestreview-398543381", "createdAt": "2020-04-22T20:06:00Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f3755ae8a136b165cb2b7b900489802b09b985f", "author": {"user": {"login": "phd3", "name": "Pratham"}}, "url": "https://github.com/trinodb/trino/commit/1f3755ae8a136b165cb2b7b900489802b09b985f", "committedDate": "2020-04-22T22:04:32Z", "message": "Fix table handle comparison\n\nCompare table handles representing the same logical dataset as equal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23f8fbe482bc982ce7aa8619a4be4c208fadbb6d", "author": {"user": {"login": "phd3", "name": "Pratham"}}, "url": "https://github.com/trinodb/trino/commit/23f8fbe482bc982ce7aa8619a4be4c208fadbb6d", "committedDate": "2020-04-22T22:04:32Z", "message": "Remove unused RaptorTableLayoutHandle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35de34e811af45e663b3b03f26f1fca94beaf8fd", "author": {"user": {"login": "phd3", "name": "Pratham"}}, "url": "https://github.com/trinodb/trino/commit/35de34e811af45e663b3b03f26f1fca94beaf8fd", "committedDate": "2020-04-22T22:04:32Z", "message": "Compare table handles while matching plans in PushPredicateIntoTableScan"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd8a4744216d2009c126058ccae8ca3731d538bc", "author": {"user": {"login": "phd3", "name": "Pratham"}}, "url": "https://github.com/trinodb/trino/commit/cd8a4744216d2009c126058ccae8ca3731d538bc", "committedDate": "2020-04-22T22:04:32Z", "message": "Add a test for predicate pushdown in hive connector"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df816743e0eb399c4ce1962174aae7633868fb59", "author": {"user": {"login": "phd3", "name": "Pratham"}}, "url": "https://github.com/trinodb/trino/commit/df816743e0eb399c4ce1962174aae7633868fb59", "committedDate": "2020-04-22T22:04:32Z", "message": "Fix bug in PhoenixTableLayoutHandle::equals"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "df816743e0eb399c4ce1962174aae7633868fb59", "author": {"user": {"login": "phd3", "name": "Pratham"}}, "url": "https://github.com/trinodb/trino/commit/df816743e0eb399c4ce1962174aae7633868fb59", "committedDate": "2020-04-22T22:04:32Z", "message": "Fix bug in PhoenixTableLayoutHandle::equals"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1567, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}