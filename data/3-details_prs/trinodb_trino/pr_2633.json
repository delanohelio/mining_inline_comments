{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3MjkyMjMw", "number": 2633, "title": "Disable socket factory for pre JDK11", "bodyText": "Purpose\nAs discussed in #1169, the socket channel is the cause of the slowdown with JDK 11. As JDK-8131133 is fixed from JDK 9, the workaround is not necessary anymore. We can safely disable the socket factory usage if the runtime is JDK 11 or later. Confirmed the communication between server and client works well even with HTTP 2.\nOverview\n\nAdd JavaVersion class from presto-server module to parse Java version string. Although we expected to use Runtime.getVersion, it does not exist in pre-JDK 9.\nCheck runtime version and disable socket factory if JDK 11 or later.", "createdAt": "2020-01-27T02:31:46Z", "url": "https://github.com/trinodb/trino/pull/2633", "merged": true, "mergeCommit": {"oid": "81b2daba173a9ed28a53b0bc6c7c44329aaae945"}, "closed": true, "closedAt": "2020-02-05T19:57:35Z", "author": {"login": "Lewuathe"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-cYd5ABqjI5ODE2OTY3NDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBaG5IAFqTM1MzkyNzIyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwOTYyNjUz", "url": "https://github.com/trinodb/trino/pull/2633#pullrequestreview-350962653", "createdAt": "2020-01-30T16:29:05Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNjoyOTowNVrOFjxeLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNjozMDoxOFrOFjxhKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA1NTAyMw==", "bodyText": "There's JavaVersion.current(). As far as I know, \"java.version\" should never be null, so you should be able to use that one instead.", "url": "https://github.com/trinodb/trino/pull/2633#discussion_r373055023", "createdAt": "2020-01-30T16:29:05Z", "author": {"login": "martint"}, "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/PrestoDriver.java", "diffHunk": "@@ -138,4 +137,22 @@ public Logger getParentLogger()\n         // TODO: support java.util.Logging\n         throw new SQLFeatureNotSupportedException();\n     }\n+\n+    private OkHttpClient newHttpClient()\n+    {\n+        OkHttpClient.Builder builder = new OkHttpClient.Builder()\n+                .addInterceptor(userAgent(DRIVER_NAME + \"/\" + DRIVER_VERSION));\n+\n+        String javaVersion = StandardSystemProperty.JAVA_VERSION.value();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA1NTc4Ng==", "bodyText": "Same comment as below.", "url": "https://github.com/trinodb/trino/pull/2633#discussion_r373055786", "createdAt": "2020-01-30T16:30:18Z", "author": {"login": "martint"}, "path": "presto-cli/src/main/java/io/prestosql/cli/QueryRunner.java", "diffHunk": "@@ -183,4 +184,19 @@ private static void setupNetworkLogging(OkHttpClient.Builder clientBuilder)\n             log.debug(\"Sending %s request to %s\", request.method(), request.url().uri());\n         }));\n     }\n+\n+    private static void setupChannelSocket(OkHttpClient.Builder clientBuilder)\n+    {\n+        String javaVersion = StandardSystemProperty.JAVA_VERSION.value();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNDgyMjAz", "url": "https://github.com/trinodb/trino/pull/2633#pullrequestreview-351482203", "createdAt": "2020-01-31T12:47:26Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNTE2MDY1", "url": "https://github.com/trinodb/trino/pull/2633#pullrequestreview-351516065", "createdAt": "2020-01-31T13:51:10Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxMzo1MToxMFrOFkL5aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxMzo1MToxMFrOFkL5aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4Nzk3OQ==", "bodyText": "I\u2019m concerned about having this complex code (which has had bugs in the past) as part of the JDBC driver, which runs in various environments. We also plan to keep the driver on Java 8 for the foreseeable future, so this code won\u2019t be removed anytime soon.\nSome alternatives:\n\n\nJust split on a period and take the first item, since that works for all versions.\n\n\nUse reflection to check for and call the Runtime.Version API. We can check for and use the feature method which is in JDK 10+.\n\n\nUse reflection to look for the existence of a \u201cmarker\u201d class like java.net.http.HttpClient which was added in JDK 11.", "url": "https://github.com/trinodb/trino/pull/2633#discussion_r373487979", "createdAt": "2020-01-31T13:51:10Z", "author": {"login": "electrum"}, "path": "presto-client/src/main/java/io/prestosql/client/JavaVersion.java", "diffHunk": "@@ -0,0 +1,138 @@\n+\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.client;\n+\n+import com.google.common.base.StandardSystemProperty;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.OptionalInt;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static java.lang.String.format;\n+\n+// TODO: remove this when we upgrade to Java 9 (replace with java.lang.Runtime.getVersion())\n+//       It's copied from io.prestosql.server module.\n+public class JavaVersion", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxODk3NjMx", "url": "https://github.com/trinodb/trino/pull/2633#pullrequestreview-351897631", "createdAt": "2020-02-01T18:30:55Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQxODozMDo1NVrOFkenTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQxODozMDo1NVrOFkenTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NDYzNg==", "bodyText": "Move these to OkHttpUtil, then we don't need two copies", "url": "https://github.com/trinodb/trino/pull/2633#discussion_r373794636", "createdAt": "2020-02-01T18:30:55Z", "author": {"login": "electrum"}, "path": "presto-cli/src/main/java/io/prestosql/cli/QueryRunner.java", "diffHunk": "@@ -183,4 +184,23 @@ private static void setupNetworkLogging(OkHttpClient.Builder clientBuilder)\n             log.debug(\"Sending %s request to %s\", request.method(), request.url().uri());\n         }));\n     }\n+\n+    private static void setupChannelSocket(OkHttpClient.Builder clientBuilder)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "99278366d479d5415af670b705c962ce230d1ea1", "author": {"user": {"login": "Lewuathe", "name": "Kai Sasaki"}}, "url": "https://github.com/trinodb/trino/commit/99278366d479d5415af670b705c962ce230d1ea1", "committedDate": "2020-02-02T04:04:43Z", "message": "Disable socket factory for pre JDK11"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "99278366d479d5415af670b705c962ce230d1ea1", "author": {"user": {"login": "Lewuathe", "name": "Kai Sasaki"}}, "url": "https://github.com/trinodb/trino/commit/99278366d479d5415af670b705c962ce230d1ea1", "committedDate": "2020-02-02T04:04:43Z", "message": "Disable socket factory for pre JDK11"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzOTI3MjI3", "url": "https://github.com/trinodb/trino/pull/2633#pullrequestreview-353927227", "createdAt": "2020-02-05T18:05:04Z", "commit": {"oid": "99278366d479d5415af670b705c962ce230d1ea1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1698, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}