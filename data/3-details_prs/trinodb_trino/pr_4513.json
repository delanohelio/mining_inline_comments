{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0NDE4MTYz", "number": 4513, "title": "Make skip.header.line.count=1 files splittable", "bodyText": "Cross contribution of prestodb/presto#14866\nIn general, files with arbitrarily many header lines are not currently considered splittable because the hive record reading logic does not work when rows might span over multiple splits. However, the relatively common case of having a single header row to skip is actually safe and can be considered splittable.\nObserve:\n\nwhen skip.header.line.count = 1, the hive split boundary handling works even if the header line extends into the subsequent split because the reader of the next split will only process rows that start within the boundary of the split, not rows that extend into the split from the previous one. No additional logic required.\nwhen skip.header.line.count > 1 and the header rows extend past the first split end boundary, it becomes impossible for a reader to know which rows should be skipped without reading from the beginning. This is still considered unsplittable.\n\nAlso includes a separate commit to port a unit test added in prestodb/presto#14855 after #4485 had already merged.", "createdAt": "2020-07-21T11:37:31Z", "url": "https://github.com/trinodb/trino/pull/4513", "merged": true, "mergeCommit": {"oid": "5fda8099d6102494d2a0adaf1aef351fde9781b3"}, "closed": true, "closedAt": "2020-07-21T20:52:52Z", "author": {"login": "pettyjamesm"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3FGrOAFqTQ1MjM4NjAxNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3Fn0UAFqTQ1MjQxNTg2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMzg2MDE2", "url": "https://github.com/trinodb/trino/pull/4513#pullrequestreview-452386016", "createdAt": "2020-07-21T12:03:15Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMjowMzoxNVrOG00yRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMjowODozOVrOG009Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA0Mzk3NQ==", "bodyText": "Move the comment below, or restructure like this:\nboolean splittable = true;\nif (s3SelectPushdownEnabled) {\n    // S3 Select pushdown works at the granularity of individual S3 objects\n    splittable = false;\n}\nif (getFooterCount(schema) != 0 || (getHeaderCount(schema) != 0 && getHeaderCount(schema) != 1)) {\n    // Files with skip.header.line.count/skip.foter.line.count are not splittable, except for skip.header.line.count = 1\n    // In that case, second split will not try to process header line as data anyway.\n    splittable = false;\n}", "url": "https://github.com/trinodb/trino/pull/4513#discussion_r458043975", "createdAt": "2020-07-21T12:03:15Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -490,7 +490,7 @@ private void invokeNoMoreSplitsIfNecessary()\n \n         // S3 Select pushdown works at the granularity of individual S3 objects,\n         // therefore we must not split files when it is enabled.\n-        boolean splittable = getHeaderCount(schema) == 0 && getFooterCount(schema) == 0 && !s3SelectPushdownEnabled;\n+        boolean splittable = !s3SelectPushdownEnabled && getFooterCount(schema) == 0 && getHeaderCount(schema) <= 1; // single header line files are still splittable", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA0NDQzMA==", "bodyText": "When headerCount > 1 then verify(start == 0 would be appropriate.", "url": "https://github.com/trinodb/trino/pull/4513#discussion_r458044430", "createdAt": "2020-07-21T12:04:16Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveUtil.java", "diffHunk": "@@ -256,7 +256,8 @@ private HiveUtil()\n             RecordReader<WritableComparable, Writable> recordReader = (RecordReader<WritableComparable, Writable>) inputFormat.getRecordReader(fileSplit, jobConf, Reporter.NULL);\n \n             int headerCount = getHeaderCount(schema);\n-            if (headerCount > 0) {\n+            //  Files with only a single header row are considered splittable and should only skip the first record on the first split\n+            if ((start == 0 && headerCount == 1) || headerCount > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA0NTAwNA==", "bodyText": "Update io.prestosql.plugin.hive.TestBackgroundHiveSplitLoader#testCsv", "url": "https://github.com/trinodb/trino/pull/4513#discussion_r458045004", "createdAt": "2020-07-21T12:05:22Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -490,7 +490,7 @@ private void invokeNoMoreSplitsIfNecessary()\n \n         // S3 Select pushdown works at the granularity of individual S3 objects,\n         // therefore we must not split files when it is enabled.\n-        boolean splittable = getHeaderCount(schema) == 0 && getFooterCount(schema) == 0 && !s3SelectPushdownEnabled;\n+        boolean splittable = !s3SelectPushdownEnabled && getFooterCount(schema) == 0 && getHeaderCount(schema) <= 1; // single header line files are still splittable", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA0Mzk3NQ=="}, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA0Njc3NA==", "bodyText": "I guess you can avoid adding an overload, if you define 100 bytes as the const\nand use that in test code. This way test code is slightly more complicated (bad),\nbut common code remains simpler.", "url": "https://github.com/trinodb/trino/pull/4513#discussion_r458046774", "createdAt": "2020-07-21T12:08:39Z", "author": {"login": "findepi"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveSplitSource.java", "diffHunk": "@@ -286,17 +315,22 @@ private TestSplit(int id)\n         }\n \n         private TestSplit(int id, OptionalInt bucketNumber)\n+        {\n+            this(id, bucketNumber, DataSize.ofBytes(100));\n+        }\n+\n+        private TestSplit(int id, OptionalInt bucketNumber, DataSize fileSize)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ea0dff17022018a3944ce5e1e427bac671abdd9", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/8ea0dff17022018a3944ce5e1e427bac671abdd9", "committedDate": "2020-07-21T12:27:58Z", "message": "Make skip.header.line.count=1 files splittable\n\nIn general, files with arbitrarily many header lines are not\ncurrently considered splittable because the hive record reading\nlogic does not work when rows might span over multiple splits.\nHowever, the relatively common case of having a single header\nrow to skip is actually safe and can be considered splittable.\nObserve:\n- when skip.header.line.count = 1, the hive split boundary handling\n  works even if the header line extends into the subsequent split\n  because the reader of the next split will only process rows that\n  start within the boundary of the split, not rows that extend\n  into the split from the previous one. No additional logic required.\n- when skip.header.line.count > 1 and the header rows extend past\n  the first split end boundary, it becomes for a reader to know which\n  rows should be skipped without reading from the beginning. This\n  is still considered unsplittable."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28d64d45da18f56439ee9590ba6b89a5d11e810e", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/28d64d45da18f56439ee9590ba6b89a5d11e810e", "committedDate": "2020-07-21T12:27:58Z", "message": "Add unit test for split boundary logic"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "28d64d45da18f56439ee9590ba6b89a5d11e810e", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/28d64d45da18f56439ee9590ba6b89a5d11e810e", "committedDate": "2020-07-21T12:27:58Z", "message": "Add unit test for split boundary logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNDE1ODY2", "url": "https://github.com/trinodb/trino/pull/4513#pullrequestreview-452415866", "createdAt": "2020-07-21T12:44:56Z", "commit": {"oid": "28d64d45da18f56439ee9590ba6b89a5d11e810e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4783, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}