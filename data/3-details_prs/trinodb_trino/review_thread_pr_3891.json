{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1NTUwMzQ2", "number": 3891, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNTowMToyOVrOEEVgXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjowOToyM1rOEGNNWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyOTgyMTEwOnYy", "diffSide": "RIGHT", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestCsv.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNTowMToyOVrOGh5Jew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNTowMToyOVrOGh5Jew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE5MjUwNw==", "bodyText": "Note that there is no test for partitioned CTAS since Hive versions < 3.2 don't support it. See https://cwiki.apache.org/confluence/display/hive/LanguageManual+DDL#LanguageManualDDL-CreateTableAsSelect(CTAS).\n\nStarting with Hive 3.2.0, CTAS statements can define a partitioning specification for the target table (HIVE-20241).", "url": "https://github.com/trinodb/trino/pull/3891#discussion_r438192507", "createdAt": "2020-06-10T15:01:29Z", "author": {"login": "hashhar"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestCsv.java", "diffHunk": "@@ -174,4 +175,89 @@ private static void assertSelect(String query, String tableName)\n                 .hasColumns(expected.getColumnTypes())\n                 .containsOnly(expectedRows);\n     }\n+\n+    @Test(groups = STORAGE_FORMATS)\n+    public void testInsertIntoCsvTableWithCustomMultiCharProperties()\n+    {\n+        String tableName = \"storage_formats_test_insert_into_csv_with_custom_multi_char_properties\";\n+        query(format(\"DROP TABLE IF EXISTS %s\", tableName));\n+        onHive().executeQuery(format(\n+                \"CREATE TABLE %s(\" +\n+                        \"   a  string,\" +\n+                        \"   b  string,\" +\n+                        \"   c  string\" +\n+                        \") ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.OpenCSVSerde' \" +\n+                        \"WITH SERDEPROPERTIES ('escapeChar'='ee','separatorChar'='ss','quoteChar'='qq') \" +\n+                        \"STORED AS \" +\n+                        \"INPUTFORMAT 'org.apache.hadoop.mapred.TextInputFormat' \" +\n+                        \"OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'\",\n+                tableName));\n+\n+        query(format(\n+                \"INSERT INTO %s(a, b, c) VALUES \" +\n+                        \"('1', 'a', 'A'), \" +\n+                        \"('2', 'b', 'B'), \" +\n+                        \"('3', 'c', 'C')\",\n+                tableName));\n+        assertThat(query(format(\"SELECT * FROM %s\", tableName)))\n+                .containsOnly(\n+                        row(\"1\", \"a\", \"A\"),\n+                        row(\"2\", \"b\", \"B\"),\n+                        row(\"3\", \"c\", \"C\"));\n+        query(format(\"DROP TABLE %s\", tableName));\n+    }\n+\n+    @Test(groups = STORAGE_FORMATS)\n+    public void testCreateCsvTableAsWithCustomMultiCharProperties()\n+    {\n+        String tableName = \"test_csv_table_multi_char_properties\";\n+        query(format(\"DROP TABLE IF EXISTS %s\", tableName));\n+        onHive().executeQuery(format(\n+                \"CREATE TABLE %s \" +\n+                        \"ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.OpenCSVSerde' \" +\n+                        \"WITH SERDEPROPERTIES ('escapeChar'='ee','separatorChar'='ss','quoteChar'='qq') \" +\n+                        \"STORED AS \" +\n+                        \"INPUTFORMAT 'org.apache.hadoop.mapred.TextInputFormat' \" +\n+                        \"OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat' \" +\n+                        \"AS \" +\n+                        \"SELECT \" +\n+                        \"'1' AS a, 'a' AS b, 'A' AS c\",\n+                tableName));\n+\n+        assertThat(query(format(\"SELECT * FROM %s\", tableName)))\n+                .containsOnly(row(\"1\", \"a\", \"A\"));\n+        query(format(\"DROP TABLE %s\", tableName));\n+    }\n+\n+    @Test(groups = STORAGE_FORMATS)\n+    public void testInsertIntoPartitionedCsvTableWithCustomMultiCharProperties()\n+    {\n+        String tableName = \"test_partitioned_csv_table_with_custom_multi_char_parameters\";\n+        query(format(\"DROP TABLE IF EXISTS %s\", tableName));\n+        onHive().executeQuery(format(\n+                \"CREATE TABLE %s(\" +\n+                        \"   a  string,\" +\n+                        \"   b  string,\" +\n+                        \"   c  string\" +\n+                        \") PARTITIONED BY (d bigint) \" +\n+                        \"ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.OpenCSVSerde' \" +\n+                        \"WITH SERDEPROPERTIES ('escapeChar'='ee','separatorChar'='ss','quoteChar'='qq') \" +\n+                        \"STORED AS \" +\n+                        \"INPUTFORMAT 'org.apache.hadoop.mapred.TextInputFormat' \" +\n+                        \"OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'\",\n+                tableName));\n+\n+        query(format(\n+                \"INSERT INTO %s(a, b, c, d) VALUES \" +\n+                        \"('1', 'a', 'A', 1), \" +\n+                        \"('2', 'b', 'B', 2), \" +\n+                        \"('3', 'c', 'C', 3)\",\n+                tableName));\n+        assertThat(query(format(\"SELECT * FROM %s\", tableName)))\n+                .containsOnly(\n+                        row(\"1\", \"a\", \"A\", 1L),\n+                        row(\"2\", \"b\", \"B\", 2L),\n+                        row(\"3\", \"c\", \"C\", 3L));\n+        query(format(\"DROP TABLE %s\", tableName));\n+    }\n }", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0ODM0MzQzOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveMetadata.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMDo0NToyOFrOGkshLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMToyNzowM1rOGktynw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzMTMxMA==", "bodyText": "csvSerdeProperty.substring(0, 1)\n(also, can these properties be set to empty string? will we fail here?)", "url": "https://github.com/trinodb/trino/pull/3891#discussion_r441131310", "createdAt": "2020-06-16T20:45:28Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveMetadata.java", "diffHunk": "@@ -624,12 +624,7 @@ private ConnectorTableMetadata doGetTableMetadata(ConnectorSession session, Sche\n \n     private static Optional<String> getCsvSerdeProperty(Table table, String key)\n     {\n-        return getSerdeProperty(table, key).map(csvSerdeProperty -> {\n-            if (csvSerdeProperty.length() > 1) {\n-                throw new PrestoException(HIVE_INVALID_METADATA, \"Only single character can be set for property: \" + key);\n-            }\n-            return csvSerdeProperty;\n-        });\n+        return getSerdeProperty(table, key).map(csvSerdeProperty -> String.valueOf(csvSerdeProperty.charAt(0)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE1MjE1OQ==", "bodyText": "Hive doesn't allow empty strings for any of the 3 properties. Checked in 3.1 and 1.1.\nPresto also doesn't allow creating and fails with:\npresto:default> create table test(a varchar) with (format='CSV',csv_quote='');\nQuery 20200616_212543_00651_k26cy failed: csv_quote must be a single character string, but was: ''\nio.prestosql.spi.PrestoException: csv_quote must be a single character string, but was: ''\n\tat io.prestosql.plugin.hive.HiveTableProperties.getSingleCharacterProperty(HiveTableProperties.java:264)\n\tat io.prestosql.plugin.hive.HiveMetadata.getEmptyTableProperties(HiveMetadata.java:939)\n\tat io.prestosql.plugin.hive.HiveMetadata.createTable(HiveMetadata.java:819)\n\tat io.prestosql.plugin.base.classloader.ClassLoaderSafeConnectorMetadata.createTable(ClassLoaderSafeConnectorMetadata.java:318)\n\tat io.prestosql.metadata.MetadataManager.createTable(MetadataManager.java:635)\n\tat io.prestosql.execution.CreateTableTask.internalExecute(CreateTableTask.java:203)\n\tat io.prestosql.execution.CreateTableTask.execute(CreateTableTask.java:87)\n\tat io.prestosql.execution.CreateTableTask.execute(CreateTableTask.java:69)\n\tat io.prestosql.execution.DataDefinitionExecution.start(DataDefinitionExecution.java:167)\n\tat io.prestosql.execution.SqlQueryManager.createQuery(SqlQueryManager.java:237)\n\tat io.prestosql.dispatcher.LocalDispatchQuery.lambda$startExecution$7(LocalDispatchQuery.java:132)\n\tat io.prestosql.$gen.Presto_333____20200615_192640_2.run(Unknown Source)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\n\tat java.base/java.lang.Thread.run(Thread.java:834)", "url": "https://github.com/trinodb/trino/pull/3891#discussion_r441152159", "createdAt": "2020-06-16T21:27:03Z", "author": {"login": "hashhar"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveMetadata.java", "diffHunk": "@@ -624,12 +624,7 @@ private ConnectorTableMetadata doGetTableMetadata(ConnectorSession session, Sche\n \n     private static Optional<String> getCsvSerdeProperty(Table table, String key)\n     {\n-        return getSerdeProperty(table, key).map(csvSerdeProperty -> {\n-            if (csvSerdeProperty.length() > 1) {\n-                throw new PrestoException(HIVE_INVALID_METADATA, \"Only single character can be set for property: \" + key);\n-            }\n-            return csvSerdeProperty;\n-        });\n+        return getSerdeProperty(table, key).map(csvSerdeProperty -> String.valueOf(csvSerdeProperty.charAt(0)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzMTMxMA=="}, "originalCommit": null, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0OTQzMzIxOnYy", "diffSide": "RIGHT", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestCsv.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjowOToyM1rOGk26lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwOToyNTowOVrOGk9cdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMwMTY1NQ==", "bodyText": "move below testReadCsvTableWithMultiCharProperties, as a person reasing this class should see testReadCsvTableWithMultiCharProperties first, we logically depend on results of that test", "url": "https://github.com/trinodb/trino/pull/3891#discussion_r441301655", "createdAt": "2020-06-17T06:09:23Z", "author": {"login": "findepi"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestCsv.java", "diffHunk": "@@ -174,4 +175,67 @@ private static void assertSelect(String query, String tableName)\n                 .hasColumns(expected.getColumnTypes())\n                 .containsOnly(expectedRows);\n     }\n+\n+    @Test(groups = STORAGE_FORMATS)\n+    public void testWriteCsvTableWithMultiCharProperties()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwODYzMQ==", "bodyText": "Makes sense.", "url": "https://github.com/trinodb/trino/pull/3891#discussion_r441408631", "createdAt": "2020-06-17T09:25:09Z", "author": {"login": "hashhar"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestCsv.java", "diffHunk": "@@ -174,4 +175,67 @@ private static void assertSelect(String query, String tableName)\n                 .hasColumns(expected.getColumnTypes())\n                 .containsOnly(expectedRows);\n     }\n+\n+    @Test(groups = STORAGE_FORMATS)\n+    public void testWriteCsvTableWithMultiCharProperties()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMwMTY1NQ=="}, "originalCommit": null, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4205, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}