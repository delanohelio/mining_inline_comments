{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3NTQyNTM0", "number": 6097, "title": "Reduce output buffer lock contention", "bodyText": "Changes extracted from prestodb/presto#15477\nTwo commits attempting to reduce lock contention related to output buffers:\n\nRefactors LazyOutputBuffer to attempt to read the delegate OutputBuffer reference before synchronizing\nRefactor SerializedPageReference and usages to perform dereferencing in batches to avoid a per-page synchronization on memory manager locks", "createdAt": "2020-11-25T15:54:47Z", "url": "https://github.com/trinodb/trino/pull/6097", "merged": true, "mergeCommit": {"oid": "0eeca902c7908166558755690146e6e965d4ffba"}, "closed": true, "closedAt": "2020-12-08T17:21:35Z", "author": {"login": "pettyjamesm"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgBsJMABqjQwMzkxMzczNjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkJoBRABqjQwODQ2MjEzOTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NjI1OTgy", "url": "https://github.com/trinodb/trino/pull/6097#pullrequestreview-546625982", "createdAt": "2020-12-07T23:26:22Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMzoyNjoyMlrOIA_lgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMDoxMToxOFrOIBAwAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkxMjcwNg==", "bodyText": "I think this needs more explanation.  This is a write once field, so an unsynchronized volatile read that returns a non-null value is safe, but it returns null, you have to do a synchronized read. At least, I think that is how all of the code is written", "url": "https://github.com/trinodb/trino/pull/6097#discussion_r537912706", "createdAt": "2020-12-07T23:26:22Z", "author": {"login": "dain"}, "path": "presto-main/src/main/java/io/prestosql/execution/buffer/LazyOutputBuffer.java", "diffHunk": "@@ -54,8 +55,9 @@\n     private final Executor executor;\n     private final Runnable notifyStatusChanged;\n \n+    // Note: this field is safe to read without synchronizing but must only be written to from a synchronized block", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkzMTc3Nw==", "bodyText": "why manually count pages when you can just use pages.size()?", "url": "https://github.com/trinodb/trino/pull/6097#discussion_r537931777", "createdAt": "2020-12-08T00:11:18Z", "author": {"login": "dain"}, "path": "presto-main/src/main/java/io/prestosql/execution/buffer/ClientBuffer.java", "diffHunk": "@@ -151,14 +155,18 @@ public void enqueuePages(Collection<SerializedPageReference> pages)\n \n     private synchronized void addPages(Collection<SerializedPageReference> pages)\n     {\n-        pages.forEach(SerializedPageReference::addReference);\n+        long rowCount = 0;\n+        long bytesAdded = 0;\n+        int pageCount = 0;\n+        for (SerializedPageReference page : pages) {\n+            page.addReference();\n+            pageCount++;\n+            rowCount += page.getPositionCount();\n+            bytesAdded += page.getRetainedSizeInBytes();\n+        }\n         this.pages.addAll(pages);\n-\n-        long rowCount = pages.stream().mapToLong(SerializedPageReference::getPositionCount).sum();\n         rowsAdded.addAndGet(rowCount);\n-        pagesAdded.addAndGet(pages.size());\n-\n-        long bytesAdded = pages.stream().mapToLong(SerializedPageReference::getRetainedSizeInBytes).sum();\n+        pagesAdded.addAndGet(pageCount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "020b8d084e8374c9d980ffe52ffee47cc1519a1d", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/020b8d084e8374c9d980ffe52ffee47cc1519a1d", "committedDate": "2020-12-08T12:50:44Z", "message": "Avoid unnecessary synchronization in LazyOutputBuffer\n\nAdds an initial dereference attempt against the delegate output\nbuffer before synchronizing so that the common case of having already\nset the delegate output buffer might avoid unnecessarily synchronizing\non the LazyOutputBuffer itself."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa1ca36474bf9622924213a0e6cbd711c2b1c0d8", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/aa1ca36474bf9622924213a0e6cbd711c2b1c0d8", "committedDate": "2020-12-08T12:50:44Z", "message": "Dereference SerializedPageReferences in batches\n\nRefactors SerializedPageReference and usage sites to perform dereferencing\nwork in batches which means only a single call into the synchronized memory\ntracker update logic will occur. Incidentally, this reduces a per page lambda\ncreation since the callback to invoke when the reference count hits 0 is\nnow created on a per output buffer basis."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "aa1ca36474bf9622924213a0e6cbd711c2b1c0d8", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/aa1ca36474bf9622924213a0e6cbd711c2b1c0d8", "committedDate": "2020-12-08T12:50:44Z", "message": "Dereference SerializedPageReferences in batches\n\nRefactors SerializedPageReference and usage sites to perform dereferencing\nwork in batches which means only a single call into the synchronized memory\ntracker update logic will occur. Incidentally, this reduces a per page lambda\ncreation since the callback to invoke when the reference count hits 0 is\nnow created on a per output buffer basis."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2360, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}