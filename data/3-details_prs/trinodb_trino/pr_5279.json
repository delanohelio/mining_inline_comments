{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxOTIzNzQz", "number": 5279, "title": "Fix listing of tables when schema is not provided for Sheets connector", "bodyText": "Fixes #5271", "createdAt": "2020-09-23T17:13:22Z", "url": "https://github.com/trinodb/trino/pull/5279", "merged": true, "mergeCommit": {"oid": "9c912a8263412bd7d27b6d1b6f0c817e54e82bd8"}, "closed": true, "closedAt": "2020-10-26T05:45:35Z", "author": {"login": "Praveen2112"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMCZFSAFqTQ5NTY1NzY2MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUsvXogBqjM5MDM2NTE0NjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjU3NjYx", "url": "https://github.com/trinodb/trino/pull/5279#pullrequestreview-495657661", "createdAt": "2020-09-24T14:51:31Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDo1MTozMlrOHXeyZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDo1MTozMlrOHXeyZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM4MzcxNg==", "bodyText": "would we be able to run io.prestosql.testing.AbstractTestIntegrationSmokeTest#testSelectInformationSchemaTables and testSelectInformationSchemaColumns for Google Sheets?", "url": "https://github.com/trinodb/trino/pull/5279#discussion_r494383716", "createdAt": "2020-09-24T14:51:32Z", "author": {"login": "findepi"}, "path": "presto-google-sheets/src/test/java/io/prestosql/plugin/google/sheets/TestGoogleSheets.java", "diffHunk": "@@ -62,6 +62,8 @@ public void testListTable()\n     {\n         assertQuery(\"show tables\", \"SELECT * FROM (VALUES 'metadata_table', 'number_text', 'table_with_duplicate_and_missing_column_names')\");\n         assertQueryReturnsEmptyResult(\"SHOW TABLES IN gsheets.information_schema LIKE 'number_text'\");\n+        assertQuery(\"select table_name from gsheets.information_schema.tables WHERE table_schema <> 'information_schema'\", \"SELECT * FROM (VALUES 'metadata_table', 'number_text', 'table_with_duplicate_and_missing_column_names')\");\n+        assertQuery(\"select table_name from gsheets.information_schema.tables WHERE table_schema <> 'information_schema' LIMIT 1000\", \"SELECT * FROM (VALUES 'metadata_table', 'number_text', 'table_with_duplicate_and_missing_column_names')\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MjE5OTgy", "url": "https://github.com/trinodb/trino/pull/5279#pullrequestreview-506219982", "createdAt": "2020-10-11T21:55:11Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQyMTo1NToxMVrOHfq5dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwMzowNDozM1rOHftoLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk3MDc0Mw==", "bodyText": "should we change code for SHEETS_TABLE_LOAD_ERROR to 3 to keep it sequential? (or do we need to maintain backwards compatibility for clients potentially using that code?)", "url": "https://github.com/trinodb/trino/pull/5279#discussion_r502970743", "createdAt": "2020-10-11T21:55:11Z", "author": {"login": "phd3"}, "path": "presto-google-sheets/src/main/java/io/prestosql/plugin/google/sheets/SheetsErrorCode.java", "diffHunk": "@@ -27,7 +27,6 @@\n     SHEETS_BAD_CREDENTIALS_ERROR(0, EXTERNAL),\n     SHEETS_METASTORE_ERROR(1, EXTERNAL),\n     SHEETS_UNKNOWN_TABLE_ERROR(2, USER_ERROR),\n-    SHEETS_UNKNOWN_SCHEMA_ERROR(3, USER_ERROR),\n     SHEETS_TABLE_LOAD_ERROR(4, INTERNAL_ERROR);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAxNTQ2OQ==", "bodyText": "my understanding is that currently the only \"default\" schema is supported (apart from information schema). The \"sheetsClient\" doesn't seem to understand the concept of a \"schema\", but it is being repeatedly invoked in a loop iterating over schema objects. So there's kind of an assumption that SCHEMAS has size=1.\nI feel we could make the logic more explicit by:\n\neither making sheetsClient#getTableNames aware of schema names\nor having SheetsMetadata#listTables method explicitly check that \"default\" is the desired schema, before invoking sheetsClient#getTableNames().\n\nThoughts?", "url": "https://github.com/trinodb/trino/pull/5279#discussion_r503015469", "createdAt": "2020-10-12T03:04:33Z", "author": {"login": "phd3"}, "path": "presto-google-sheets/src/main/java/io/prestosql/plugin/google/sheets/SheetsMetadata.java", "diffHunk": "@@ -136,16 +133,15 @@ public ConnectorTableMetadata getTableMetadata(ConnectorSession session, Connect\n     @Override\n     public List<SchemaTableName> listTables(ConnectorSession session, Optional<String> schemaName)\n     {\n-        if (schemaName.isEmpty()) {\n-            throw new PrestoException(SHEETS_UNKNOWN_SCHEMA_ERROR, \"Schema not present - \" + schemaName);\n-        }\n-        if (schemaName.get().equalsIgnoreCase(\"information_schema\")) {\n-            return ImmutableList.of();\n+        ImmutableList.Builder<SchemaTableName> builder = ImmutableList.builder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMDMzNDgx", "url": "https://github.com/trinodb/trino/pull/5279#pullrequestreview-513033481", "createdAt": "2020-10-20T18:46:02Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo0NjowM1rOHlMSWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODo0NjowM1rOHlMSWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc2MDY2Nw==", "bodyText": "Minor suggestion: using  one of the SCHEMAS or listSchemaNames() uniformly in the two lines might be easier to read.", "url": "https://github.com/trinodb/trino/pull/5279#discussion_r508760667", "createdAt": "2020-10-20T18:46:03Z", "author": {"login": "phd3"}, "path": "presto-google-sheets/src/main/java/io/prestosql/plugin/google/sheets/SheetsMetadata.java", "diffHunk": "@@ -136,16 +135,15 @@ public ConnectorTableMetadata getTableMetadata(ConnectorSession session, Connect\n     @Override\n     public List<SchemaTableName> listTables(ConnectorSession session, Optional<String> schemaName)\n     {\n-        if (schemaName.isEmpty()) {\n-            throw new PrestoException(SHEETS_UNKNOWN_SCHEMA_ERROR, \"Schema not present - \" + schemaName);\n-        }\n-        if (schemaName.get().equalsIgnoreCase(\"information_schema\")) {\n+        String schema = schemaName.orElse(getOnlyElement(SCHEMAS));\n+\n+        if (schema.equalsIgnoreCase(\"information_schema\") || !listSchemaNames().contains(schema)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96e549a0bc7558b5e0fb023bbb367534a0af23c9", "author": {"user": {"login": "Praveen2112", "name": "Praveen Krishna"}}, "url": "https://github.com/trinodb/trino/commit/96e549a0bc7558b5e0fb023bbb367534a0af23c9", "committedDate": "2020-10-21T12:43:06Z", "message": "Fix listing of tables when schema is not provided"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "96e549a0bc7558b5e0fb023bbb367534a0af23c9", "author": {"user": {"login": "Praveen2112", "name": "Praveen Krishna"}}, "url": "https://github.com/trinodb/trino/commit/96e549a0bc7558b5e0fb023bbb367534a0af23c9", "committedDate": "2020-10-21T12:43:06Z", "message": "Fix listing of tables when schema is not provided"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3749, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}