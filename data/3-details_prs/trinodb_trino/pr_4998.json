{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0NjYyNTgx", "number": 4998, "title": "Test current JDBC driver against old Presto releases", "bodyText": "", "createdAt": "2020-08-27T12:20:18Z", "url": "https://github.com/trinodb/trino/pull/4998", "merged": true, "mergeCommit": {"oid": "7896b5274d5c348c4c98bae8606abcf42425129a"}, "closed": true, "closedAt": "2020-09-14T12:25:43Z", "author": {"login": "losipiuk"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDCEObABqjM3MDAxODUxOTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdIxYHTgBqjM3NjI4MDY1Nzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2ODg3NjQ4", "url": "https://github.com/trinodb/trino/pull/4998#pullrequestreview-476887648", "createdAt": "2020-08-27T16:26:08Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxNjoyNjowOFrOHIYChw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxNjoyNjowOFrOHIYChw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU0NDUxOQ==", "bodyText": "I don't think we should run the tests in old versions of the project. The \"source of truth\" for tests should be what's in trunk right now. The problems with running old test code are:\n\nIf there are bug in the old tests, there's no way to \"fix\" them -- we can't go back in time and patch an old presto test jar\nIt relies on treating the structure of the tests as an API (it's not!). If we refactor the test code in master, the old tests may stop running at all.\n\nIf we want more test coverage, or tests targeted to a specific version, we should augment the current test library and enable tests conditionally based on the version being targeted.\n(I'm assuming this is what this does based on similar structure for the other jdbc driver tests, which I think we should change)", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r478544519", "createdAt": "2020-08-27T16:26:08Z", "author": {"login": "martint"}, "path": "presto-test-jdbc-compatibility-old-server/pom.xml", "diffHunk": "@@ -0,0 +1,109 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <parent>\n+        <groupId>io.prestosql</groupId>\n+        <artifactId>presto-root</artifactId>\n+        <version>341-SNAPSHOT</version>\n+    </parent>\n+\n+    <artifactId>presto-test-jdbc-compatibility-old-server</artifactId>\n+    <description>Presto - Tests whether current Presto JDBC clients are compatible with old Presto servers</description>\n+\n+    <properties>\n+        <air.main.basedir>${project.parent.basedir}</air.main.basedir>\n+        <dep.presto-jdbc-under-test>341-SNAPSHOT</dep.presto-jdbc-under-test>\n+    </properties>\n+\n+    <dependencies>\n+        <dependency>\n+            <groupId>io.prestosql</groupId>\n+            <artifactId>presto-jdbc</artifactId>\n+            <scope>test</scope>\n+        </dependency>\n+\n+        <dependency>\n+            <groupId>io.prestosql</groupId>\n+            <artifactId>presto-jdbc</artifactId>\n+            <scope>test</scope>\n+            <version>${project.version}</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2OTM2Njg0", "url": "https://github.com/trinodb/trino/pull/4998#pullrequestreview-476936684", "createdAt": "2020-08-27T17:30:40Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxNzozMDo0MFrOHIaWPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxNzozMDo0MFrOHIaWPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU4MjMzNA==", "bodyText": "What's the purpose of this? :)", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r478582334", "createdAt": "2020-08-27T17:30:40Z", "author": {"login": "wendigo"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestBlah.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql;\n+\n+import org.testng.annotations.Test;\n+\n+public class TestBlah", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNTI2Mjc3", "url": "https://github.com/trinodb/trino/pull/4998#pullrequestreview-483526277", "createdAt": "2020-09-07T12:42:31Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMjo0MjozMVrOHN9_Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMzozNjo0MVrOHN_pmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQwOTE5MA==", "bodyText": "Is it respected when o base class?", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484409190", "createdAt": "2020-09-07T12:42:31Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -0,0 +1,544 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.jdbc;\n+\n+import com.google.common.collect.ImmutableMap;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Test;\n+\n+import java.math.BigDecimal;\n+import java.sql.Connection;\n+import java.sql.Date;\n+import java.sql.ResultSet;\n+import java.sql.ResultSetMetaData;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.sql.Time;\n+import java.sql.Timestamp;\n+import java.sql.Types;\n+import java.time.LocalDate;\n+import java.time.LocalDateTime;\n+import java.time.LocalTime;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static java.util.concurrent.TimeUnit.HOURS;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertNotNull;\n+import static org.testng.Assert.assertThrows;\n+import static org.testng.Assert.assertTrue;\n+\n+@Test(singleThreaded = true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQwOTkwNA==", "bodyText": "io.airlift.testing.Closeables#closeAll(statement, connection);\nstatement = null;\nconnection = null;", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484409904", "createdAt": "2020-09-07T12:43:59Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -63,8 +63,14 @@ public void setup()\n     public void teardown()\n             throws Exception\n     {\n-        statement.close();\n-        connection.close();\n+        if (statement != null) {\n+            statement.close();\n+            statement = null;\n+        }\n+        if (connection != null) {\n+            connection.close();\n+            connection = null;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQxMzI3OQ==", "bodyText": "prestoVersion -> prestoServerVersion\n(this could mean driver version as well in the context of TestJdbcResultSetCompatibility)\nversion should be represented as a String", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484413279", "createdAt": "2020-09-07T12:50:23Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -45,8 +47,12 @@\n @Test(singleThreaded = true)\n public abstract class BaseTestJdbcResultSet\n {\n+    private static final Logger log = Logger.get(BaseTestJdbcResultSet.class);\n+    private static final int RECENT_SERVER_VERSION = 10000;\n+\n     private Connection connection;\n     private Statement statement;\n+    private OptionalInt prestoVersion = OptionalInt.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQxMzkwOA==", "bodyText": "private Supplier<...> prestoVersion = Suppliers.memoize( ... \n\nnicer to write (except you need explicit handling of SQLException, i know)\nyou no longer have null-disguised-as-optional", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484413908", "createdAt": "2020-09-07T12:51:33Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -57,6 +63,27 @@ public void setup()\n     {\n         connection = createConnection();\n         statement = connection.createStatement();\n+        synchronized (this) {\n+            determinePrestoVersion();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQxNDM4NA==", "bodyText": "IMO conditionality should be done outside of determinePrestoVersion", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484414384", "createdAt": "2020-09-07T12:52:29Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -57,6 +63,27 @@ public void setup()\n     {\n         connection = createConnection();\n         statement = connection.createStatement();\n+        synchronized (this) {\n+            determinePrestoVersion();\n+        }\n+    }\n+\n+    private void determinePrestoVersion()\n+            throws SQLException\n+    {\n+        if (!prestoVersion.isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQxNTA4OA==", "bodyText": "If you change to String you will have to change this.\nIf you do not, I still would use MAX_VALUE or a dedicated special value", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484415088", "createdAt": "2020-09-07T12:53:58Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -45,8 +47,12 @@\n @Test(singleThreaded = true)\n public abstract class BaseTestJdbcResultSet\n {\n+    private static final Logger log = Logger.get(BaseTestJdbcResultSet.class);\n+    private static final int RECENT_SERVER_VERSION = 10000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQxNjY1OA==", "bodyText": "because it's on the abstract class?\nthis is wrong -- when testng gave us 2 threads for exec, we should use those threads\nif we cannot, we should ask for one thread only\n\nyou can add verification in the base class it's used single threaded (atomic integer counting \"current tests\" would be enough\nannotate singleThreaded=true the subclass(es)", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484416658", "createdAt": "2020-09-07T12:56:55Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -54,13 +55,17 @@\n     private Statement statement;\n     private OptionalInt prestoVersion = OptionalInt.empty();\n \n+    // TODO for some reason TestNG does not respect \"singleThreaded = true\"; simulating using mutex\n+    private final Semaphore mutex = new Semaphore(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQxNzM2MA==", "bodyText": "You do not need to exclude presto-test-jdbc-compatibility-old-server here.\n(the reason presto-test-jdbc-compatibility-old-driver is excluded is because it changes JDBC version via pom property overrides)", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484417360", "createdAt": "2020-09-07T12:58:17Z", "author": {"login": "findepi"}, "path": ".github/workflows/ci.yml", "diffHunk": "@@ -74,15 +74,19 @@ jobs:\n     runs-on: ubuntu-latest\n     steps:\n       - uses: actions/checkout@v2\n+        with:\n+          fetch-depth: 0 # checkout tags so version in Manifest is set properly\n       - uses: actions/setup-java@v1\n         with:\n           java-version: 11\n       - name: Maven Install\n         run: |\n           export MAVEN_OPTS=\"${MAVEN_INSTALL_OPTS}\"\n-          ./bin/retry ./mvnw install ${MAVEN_FAST_INSTALL} -pl '!presto-test-jdbc-compatibility-old-driver,!presto-docs,!presto-server,!presto-server-rpm'\n-      - name: Test JDBC clients\n+          ./bin/retry ./mvnw install ${MAVEN_FAST_INSTALL} -pl '!presto-test-jdbc-compatibility-old-driver,!presto-test-jdbc-compatibility-old-server,!presto-docs,!presto-server,!presto-server-rpm'", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQyNjg0MA==", "bodyText": "We now have 2 TestJdbcResultSetCompatibility classes:\nBaseTestJdbcResultSet (io.prestosql.jdbc)\n- TestJdbcResultSetCompatibility (io.prestosql)\n- TestJdbcResultSet (io.prestosql.jdbc)\n   - TestJdbcResultSetCompatibility (io.prestosql)\n\n\nwhy is the inheritance hierarchy uneven? Maybe it could be flat now? (disregard if it cannot)\n2.\u00a0the TestJdbcResultSetCompatibility classes could be renamed to better indicate their specifics, without need to lookup module name (which is long and easy to be stripped out of view)", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484426840", "createdAt": "2020-09-07T13:17:46Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestJdbcResultSetCompatibility.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql;\n+\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.log.Logging;\n+import io.prestosql.jdbc.BaseTestJdbcResultSet;\n+import io.prestosql.jdbc.PrestoDriver;\n+import org.testcontainers.containers.PrestoContainer;\n+import org.testng.SkipException;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+\n+import java.io.PrintWriter;\n+import java.io.StringWriter;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.util.Optional;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+@Test(singleThreaded = true)\n+public class TestJdbcResultSetCompatibility", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQyNzM4NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final Optional<String> testedPrestoVersion;\n          \n          \n            \n                /**\n          \n          \n            \n                 * Test version. Empty means current (unreleased) version\n          \n          \n            \n                 */\n          \n          \n            \n                private final Optional<String> testedPrestoVersion;", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484427384", "createdAt": "2020-09-07T13:18:55Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestJdbcResultSetCompatibility.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql;\n+\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.log.Logging;\n+import io.prestosql.jdbc.BaseTestJdbcResultSet;\n+import io.prestosql.jdbc.PrestoDriver;\n+import org.testcontainers.containers.PrestoContainer;\n+import org.testng.SkipException;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+\n+import java.io.PrintWriter;\n+import java.io.StringWriter;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.util.Optional;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+@Test(singleThreaded = true)\n+public class TestJdbcResultSetCompatibility\n+        extends BaseTestJdbcResultSet\n+{\n+    private static final int NUMBER_OF_TESTED_VERSIONS = 5;\n+    private static final int TESTED_VERSIONS_GRANULARITY = 3;\n+\n+    private final Optional<String> testedPrestoVersion;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQyNzYzMQ==", "bodyText": "Current version is tested by io.prestosql.jdbc.TestJdbcResultSet.\nI understand you need this to run the test from intellij (to test the test),\nso please add an appropriate comment. Otherwise it looks like \"this test\npast versions... or it doesn't\"\nAlso, how do we actually verify the test works?\nWould it work if we allowed currentVersionString == null only when some\nadditional sys property is set? You would set it manually when running from IDE\nand CI or when running from maven would use the JDBC jar and fall into\ncurrentVersionString != null category.\nAlso, maybe we can simplify this by baking in the current version via resources?\nLike here\nhttps://github.com/prestosql/presto/blob/cd061b3410c752253d64f096176bf226a3dea11a/presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/Launcher.java#L170-L172", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484427631", "createdAt": "2020-09-07T13:19:27Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestJdbcResultSetCompatibility.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql;\n+\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.log.Logging;\n+import io.prestosql.jdbc.BaseTestJdbcResultSet;\n+import io.prestosql.jdbc.PrestoDriver;\n+import org.testcontainers.containers.PrestoContainer;\n+import org.testng.SkipException;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+\n+import java.io.PrintWriter;\n+import java.io.StringWriter;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.util.Optional;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+@Test(singleThreaded = true)\n+public class TestJdbcResultSetCompatibility\n+        extends BaseTestJdbcResultSet\n+{\n+    private static final int NUMBER_OF_TESTED_VERSIONS = 5;\n+    private static final int TESTED_VERSIONS_GRANULARITY = 3;\n+\n+    private final Optional<String> testedPrestoVersion;\n+    private PrestoContainer<?> prestoContainer;\n+\n+    @Factory(dataProvider = \"testedPrestoVersions\")\n+    public TestJdbcResultSetCompatibility(Optional<String> testedPrestoVersion)\n+    {\n+        this.testedPrestoVersion = requireNonNull(testedPrestoVersion, \"testedPrestoVersion is null\");\n+    }\n+\n+    @DataProvider\n+    public static Object[][] testedPrestoVersions()\n+    {\n+        try {\n+            String currentVersionString = PrestoDriver.class.getPackage().getImplementationVersion();\n+            if (currentVersionString == null) {\n+                return new Object[][] {\n+                        {Optional.empty()}", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzMjMwNw==", "bodyText": "Let's be explicit\nmatcher = Pattern.compile(\"\\\\d+(-SNAPSHOT)?\").matcher(currentVersionString);\ncheckState(matcher.matches());", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484432307", "createdAt": "2020-09-07T13:28:48Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestJdbcResultSetCompatibility.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql;\n+\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.log.Logging;\n+import io.prestosql.jdbc.BaseTestJdbcResultSet;\n+import io.prestosql.jdbc.PrestoDriver;\n+import org.testcontainers.containers.PrestoContainer;\n+import org.testng.SkipException;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+\n+import java.io.PrintWriter;\n+import java.io.StringWriter;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.util.Optional;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+@Test(singleThreaded = true)\n+public class TestJdbcResultSetCompatibility\n+        extends BaseTestJdbcResultSet\n+{\n+    private static final int NUMBER_OF_TESTED_VERSIONS = 5;\n+    private static final int TESTED_VERSIONS_GRANULARITY = 3;\n+\n+    private final Optional<String> testedPrestoVersion;\n+    private PrestoContainer<?> prestoContainer;\n+\n+    @Factory(dataProvider = \"testedPrestoVersions\")\n+    public TestJdbcResultSetCompatibility(Optional<String> testedPrestoVersion)\n+    {\n+        this.testedPrestoVersion = requireNonNull(testedPrestoVersion, \"testedPrestoVersion is null\");\n+    }\n+\n+    @DataProvider\n+    public static Object[][] testedPrestoVersions()\n+    {\n+        try {\n+            String currentVersionString = PrestoDriver.class.getPackage().getImplementationVersion();\n+            if (currentVersionString == null) {\n+                return new Object[][] {\n+                        {Optional.empty()}\n+                };\n+            }\n+\n+            int currentVersion = Integer.parseInt(Splitter.on(\"-\").omitEmptyStrings().trimResults().splitToList(currentVersionString).get(0));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzMzA4Nw==", "bodyText": "Simplify flow\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        int testedVersion = currentVersion - 1;\n          \n          \n            \n                        for (int i = 0; i < NUMBER_OF_TESTED_VERSIONS; i++) {\n          \n          \n            \n                            testedPrestoVersions.add(String.valueOf(testedVersion));\n          \n          \n            \n                            testedVersion -= TESTED_VERSIONS_GRANULARITY;\n          \n          \n            \n                        }\n          \n          \n            \n                        int lastReleasedVersion = currentVersion - 1;\n          \n          \n            \n                        for (int i = 0; i < NUMBER_OF_TESTED_VERSIONS; i++) {\n          \n          \n            \n                            testedPrestoVersions.add(String.valueOf(lastReleasedVersion - i * TESTED_VERSIONS_GRANULARITY));\n          \n          \n            \n                        }", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484433087", "createdAt": "2020-09-07T13:30:06Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestJdbcResultSetCompatibility.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql;\n+\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.log.Logging;\n+import io.prestosql.jdbc.BaseTestJdbcResultSet;\n+import io.prestosql.jdbc.PrestoDriver;\n+import org.testcontainers.containers.PrestoContainer;\n+import org.testng.SkipException;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+\n+import java.io.PrintWriter;\n+import java.io.StringWriter;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.util.Optional;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+@Test(singleThreaded = true)\n+public class TestJdbcResultSetCompatibility\n+        extends BaseTestJdbcResultSet\n+{\n+    private static final int NUMBER_OF_TESTED_VERSIONS = 5;\n+    private static final int TESTED_VERSIONS_GRANULARITY = 3;\n+\n+    private final Optional<String> testedPrestoVersion;\n+    private PrestoContainer<?> prestoContainer;\n+\n+    @Factory(dataProvider = \"testedPrestoVersions\")\n+    public TestJdbcResultSetCompatibility(Optional<String> testedPrestoVersion)\n+    {\n+        this.testedPrestoVersion = requireNonNull(testedPrestoVersion, \"testedPrestoVersion is null\");\n+    }\n+\n+    @DataProvider\n+    public static Object[][] testedPrestoVersions()\n+    {\n+        try {\n+            String currentVersionString = PrestoDriver.class.getPackage().getImplementationVersion();\n+            if (currentVersionString == null) {\n+                return new Object[][] {\n+                        {Optional.empty()}\n+                };\n+            }\n+\n+            int currentVersion = Integer.parseInt(Splitter.on(\"-\").omitEmptyStrings().trimResults().splitToList(currentVersionString).get(0));\n+            ImmutableList.Builder<String> testedPrestoVersions = ImmutableList.builder();\n+            int testedVersion = currentVersion - 1;\n+            for (int i = 0; i < NUMBER_OF_TESTED_VERSIONS; i++) {\n+                testedPrestoVersions.add(String.valueOf(testedVersion));\n+                testedVersion -= TESTED_VERSIONS_GRANULARITY;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzMzYyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                .map(version -> new Object[] {Optional.of(version)})\n          \n          \n            \n                                .toArray(Object[][]::new);\n          \n          \n            \n                                .collect(io.prestosql.testing.TestngUtils#toDataProvider)", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484433622", "createdAt": "2020-09-07T13:31:14Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestJdbcResultSetCompatibility.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql;\n+\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.log.Logging;\n+import io.prestosql.jdbc.BaseTestJdbcResultSet;\n+import io.prestosql.jdbc.PrestoDriver;\n+import org.testcontainers.containers.PrestoContainer;\n+import org.testng.SkipException;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+\n+import java.io.PrintWriter;\n+import java.io.StringWriter;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.util.Optional;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+@Test(singleThreaded = true)\n+public class TestJdbcResultSetCompatibility\n+        extends BaseTestJdbcResultSet\n+{\n+    private static final int NUMBER_OF_TESTED_VERSIONS = 5;\n+    private static final int TESTED_VERSIONS_GRANULARITY = 3;\n+\n+    private final Optional<String> testedPrestoVersion;\n+    private PrestoContainer<?> prestoContainer;\n+\n+    @Factory(dataProvider = \"testedPrestoVersions\")\n+    public TestJdbcResultSetCompatibility(Optional<String> testedPrestoVersion)\n+    {\n+        this.testedPrestoVersion = requireNonNull(testedPrestoVersion, \"testedPrestoVersion is null\");\n+    }\n+\n+    @DataProvider\n+    public static Object[][] testedPrestoVersions()\n+    {\n+        try {\n+            String currentVersionString = PrestoDriver.class.getPackage().getImplementationVersion();\n+            if (currentVersionString == null) {\n+                return new Object[][] {\n+                        {Optional.empty()}\n+                };\n+            }\n+\n+            int currentVersion = Integer.parseInt(Splitter.on(\"-\").omitEmptyStrings().trimResults().splitToList(currentVersionString).get(0));\n+            ImmutableList.Builder<String> testedPrestoVersions = ImmutableList.builder();\n+            int testedVersion = currentVersion - 1;\n+            for (int i = 0; i < NUMBER_OF_TESTED_VERSIONS; i++) {\n+                testedPrestoVersions.add(String.valueOf(testedVersion));\n+                testedVersion -= TESTED_VERSIONS_GRANULARITY;\n+            }\n+\n+            return testedPrestoVersions.build().stream()\n+                    .map(version -> new Object[] {Optional.of(version)})\n+                    .toArray(Object[][]::new);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzMzc1OA==", "bodyText": "Let it fly!", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484433758", "createdAt": "2020-09-07T13:31:31Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestJdbcResultSetCompatibility.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql;\n+\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.log.Logging;\n+import io.prestosql.jdbc.BaseTestJdbcResultSet;\n+import io.prestosql.jdbc.PrestoDriver;\n+import org.testcontainers.containers.PrestoContainer;\n+import org.testng.SkipException;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+\n+import java.io.PrintWriter;\n+import java.io.StringWriter;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.util.Optional;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+@Test(singleThreaded = true)\n+public class TestJdbcResultSetCompatibility\n+        extends BaseTestJdbcResultSet\n+{\n+    private static final int NUMBER_OF_TESTED_VERSIONS = 5;\n+    private static final int TESTED_VERSIONS_GRANULARITY = 3;\n+\n+    private final Optional<String> testedPrestoVersion;\n+    private PrestoContainer<?> prestoContainer;\n+\n+    @Factory(dataProvider = \"testedPrestoVersions\")\n+    public TestJdbcResultSetCompatibility(Optional<String> testedPrestoVersion)\n+    {\n+        this.testedPrestoVersion = requireNonNull(testedPrestoVersion, \"testedPrestoVersion is null\");\n+    }\n+\n+    @DataProvider\n+    public static Object[][] testedPrestoVersions()\n+    {\n+        try {\n+            String currentVersionString = PrestoDriver.class.getPackage().getImplementationVersion();\n+            if (currentVersionString == null) {\n+                return new Object[][] {\n+                        {Optional.empty()}\n+                };\n+            }\n+\n+            int currentVersion = Integer.parseInt(Splitter.on(\"-\").omitEmptyStrings().trimResults().splitToList(currentVersionString).get(0));\n+            ImmutableList.Builder<String> testedPrestoVersions = ImmutableList.builder();\n+            int testedVersion = currentVersion - 1;\n+            for (int i = 0; i < NUMBER_OF_TESTED_VERSIONS; i++) {\n+                testedPrestoVersions.add(String.valueOf(testedVersion));\n+                testedVersion -= TESTED_VERSIONS_GRANULARITY;\n+            }\n+\n+            return testedPrestoVersions.build().stream()\n+                    .map(version -> new Object[] {Optional.of(version)})\n+                    .toArray(Object[][]::new);\n+        }\n+        catch (Throwable e) {\n+            System.err.println(\"Could not determine Presto versions to test; \" + e.getMessage() + \"\\n\" + getStackTrace(e));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzNDI0OA==", "bodyText": "e.printStackTrace(System.err)\n\nor\ncom.google.common.base.Throwables#getStackTraceAsString", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484434248", "createdAt": "2020-09-07T13:32:29Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestJdbcResultSetCompatibility.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql;\n+\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.log.Logging;\n+import io.prestosql.jdbc.BaseTestJdbcResultSet;\n+import io.prestosql.jdbc.PrestoDriver;\n+import org.testcontainers.containers.PrestoContainer;\n+import org.testng.SkipException;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+\n+import java.io.PrintWriter;\n+import java.io.StringWriter;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.util.Optional;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+@Test(singleThreaded = true)\n+public class TestJdbcResultSetCompatibility\n+        extends BaseTestJdbcResultSet\n+{\n+    private static final int NUMBER_OF_TESTED_VERSIONS = 5;\n+    private static final int TESTED_VERSIONS_GRANULARITY = 3;\n+\n+    private final Optional<String> testedPrestoVersion;\n+    private PrestoContainer<?> prestoContainer;\n+\n+    @Factory(dataProvider = \"testedPrestoVersions\")\n+    public TestJdbcResultSetCompatibility(Optional<String> testedPrestoVersion)\n+    {\n+        this.testedPrestoVersion = requireNonNull(testedPrestoVersion, \"testedPrestoVersion is null\");\n+    }\n+\n+    @DataProvider\n+    public static Object[][] testedPrestoVersions()\n+    {\n+        try {\n+            String currentVersionString = PrestoDriver.class.getPackage().getImplementationVersion();\n+            if (currentVersionString == null) {\n+                return new Object[][] {\n+                        {Optional.empty()}\n+                };\n+            }\n+\n+            int currentVersion = Integer.parseInt(Splitter.on(\"-\").omitEmptyStrings().trimResults().splitToList(currentVersionString).get(0));\n+            ImmutableList.Builder<String> testedPrestoVersions = ImmutableList.builder();\n+            int testedVersion = currentVersion - 1;\n+            for (int i = 0; i < NUMBER_OF_TESTED_VERSIONS; i++) {\n+                testedPrestoVersions.add(String.valueOf(testedVersion));\n+                testedVersion -= TESTED_VERSIONS_GRANULARITY;\n+            }\n+\n+            return testedPrestoVersions.build().stream()\n+                    .map(version -> new Object[] {Optional.of(version)})\n+                    .toArray(Object[][]::new);\n+        }\n+        catch (Throwable e) {\n+            System.err.println(\"Could not determine Presto versions to test; \" + e.getMessage() + \"\\n\" + getStackTrace(e));\n+            return new Object[][] {\n+                    {Optional.empty()}\n+            };\n+        }\n+    }\n+\n+    private static String getStackTrace(Throwable e)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzNDUzOA==", "bodyText": "Why?", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484434538", "createdAt": "2020-09-07T13:33:04Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestJdbcResultSetCompatibility.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql;\n+\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.log.Logging;\n+import io.prestosql.jdbc.BaseTestJdbcResultSet;\n+import io.prestosql.jdbc.PrestoDriver;\n+import org.testcontainers.containers.PrestoContainer;\n+import org.testng.SkipException;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+\n+import java.io.PrintWriter;\n+import java.io.StringWriter;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.util.Optional;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+@Test(singleThreaded = true)\n+public class TestJdbcResultSetCompatibility\n+        extends BaseTestJdbcResultSet\n+{\n+    private static final int NUMBER_OF_TESTED_VERSIONS = 5;\n+    private static final int TESTED_VERSIONS_GRANULARITY = 3;\n+\n+    private final Optional<String> testedPrestoVersion;\n+    private PrestoContainer<?> prestoContainer;\n+\n+    @Factory(dataProvider = \"testedPrestoVersions\")\n+    public TestJdbcResultSetCompatibility(Optional<String> testedPrestoVersion)\n+    {\n+        this.testedPrestoVersion = requireNonNull(testedPrestoVersion, \"testedPrestoVersion is null\");\n+    }\n+\n+    @DataProvider\n+    public static Object[][] testedPrestoVersions()\n+    {\n+        try {\n+            String currentVersionString = PrestoDriver.class.getPackage().getImplementationVersion();\n+            if (currentVersionString == null) {\n+                return new Object[][] {\n+                        {Optional.empty()}\n+                };\n+            }\n+\n+            int currentVersion = Integer.parseInt(Splitter.on(\"-\").omitEmptyStrings().trimResults().splitToList(currentVersionString).get(0));\n+            ImmutableList.Builder<String> testedPrestoVersions = ImmutableList.builder();\n+            int testedVersion = currentVersion - 1;\n+            for (int i = 0; i < NUMBER_OF_TESTED_VERSIONS; i++) {\n+                testedPrestoVersions.add(String.valueOf(testedVersion));\n+                testedVersion -= TESTED_VERSIONS_GRANULARITY;\n+            }\n+\n+            return testedPrestoVersions.build().stream()\n+                    .map(version -> new Object[] {Optional.of(version)})\n+                    .toArray(Object[][]::new);\n+        }\n+        catch (Throwable e) {\n+            System.err.println(\"Could not determine Presto versions to test; \" + e.getMessage() + \"\\n\" + getStackTrace(e));\n+            return new Object[][] {\n+                    {Optional.empty()}\n+            };\n+        }\n+    }\n+\n+    private static String getStackTrace(Throwable e)\n+    {\n+        StringWriter stringWriter = new StringWriter();\n+        PrintWriter printWriter = new PrintWriter(stringWriter);\n+        e.printStackTrace(printWriter);\n+        return stringWriter.toString();\n+    }\n+\n+    @BeforeClass\n+    public void setupPrestoContainer()\n+    {\n+        if (testedPrestoVersion.isEmpty()) {\n+            throw new AssertionError(\"Could not determine current Presto version\");\n+        }\n+        Logging.initialize();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzNDk0Nw==", "bodyText": "Is it used by Testng? how?\n(please add a comment; we do not use @Factory tests elsewhere so it's not a common knowledge currently)", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484434947", "createdAt": "2020-09-07T13:33:56Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestJdbcResultSetCompatibility.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql;\n+\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+import io.airlift.log.Logging;\n+import io.prestosql.jdbc.BaseTestJdbcResultSet;\n+import io.prestosql.jdbc.PrestoDriver;\n+import org.testcontainers.containers.PrestoContainer;\n+import org.testng.SkipException;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+\n+import java.io.PrintWriter;\n+import java.io.StringWriter;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.util.Optional;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+@Test(singleThreaded = true)\n+public class TestJdbcResultSetCompatibility\n+        extends BaseTestJdbcResultSet\n+{\n+    private static final int NUMBER_OF_TESTED_VERSIONS = 5;\n+    private static final int TESTED_VERSIONS_GRANULARITY = 3;\n+\n+    private final Optional<String> testedPrestoVersion;\n+    private PrestoContainer<?> prestoContainer;\n+\n+    @Factory(dataProvider = \"testedPrestoVersions\")\n+    public TestJdbcResultSetCompatibility(Optional<String> testedPrestoVersion)\n+    {\n+        this.testedPrestoVersion = requireNonNull(testedPrestoVersion, \"testedPrestoVersion is null\");\n+    }\n+\n+    @DataProvider\n+    public static Object[][] testedPrestoVersions()\n+    {\n+        try {\n+            String currentVersionString = PrestoDriver.class.getPackage().getImplementationVersion();\n+            if (currentVersionString == null) {\n+                return new Object[][] {\n+                        {Optional.empty()}\n+                };\n+            }\n+\n+            int currentVersion = Integer.parseInt(Splitter.on(\"-\").omitEmptyStrings().trimResults().splitToList(currentVersionString).get(0));\n+            ImmutableList.Builder<String> testedPrestoVersions = ImmutableList.builder();\n+            int testedVersion = currentVersion - 1;\n+            for (int i = 0; i < NUMBER_OF_TESTED_VERSIONS; i++) {\n+                testedPrestoVersions.add(String.valueOf(testedVersion));\n+                testedVersion -= TESTED_VERSIONS_GRANULARITY;\n+            }\n+\n+            return testedPrestoVersions.build().stream()\n+                    .map(version -> new Object[] {Optional.of(version)})\n+                    .toArray(Object[][]::new);\n+        }\n+        catch (Throwable e) {\n+            System.err.println(\"Could not determine Presto versions to test; \" + e.getMessage() + \"\\n\" + getStackTrace(e));\n+            return new Object[][] {\n+                    {Optional.empty()}\n+            };\n+        }\n+    }\n+\n+    private static String getStackTrace(Throwable e)\n+    {\n+        StringWriter stringWriter = new StringWriter();\n+        PrintWriter printWriter = new PrintWriter(stringWriter);\n+        e.printStackTrace(printWriter);\n+        return stringWriter.toString();\n+    }\n+\n+    @BeforeClass\n+    public void setupPrestoContainer()\n+    {\n+        if (testedPrestoVersion.isEmpty()) {\n+            throw new AssertionError(\"Could not determine current Presto version\");\n+        }\n+        Logging.initialize();\n+\n+        prestoContainer = new PrestoContainer<>(\"prestosql/presto:\" + testedPrestoVersion.get());\n+        prestoContainer.start();\n+    }\n+\n+    @AfterClass(alwaysRun = true)\n+    public void tearDownPrestoContainer()\n+    {\n+        if (prestoContainer != null) {\n+            prestoContainer.stop();\n+            prestoContainer = null;\n+        }\n+    }\n+\n+    @Override\n+    protected Connection createConnection()\n+            throws Exception\n+    {\n+        return DriverManager.getConnection(prestoContainer.getJdbcUrl(), \"test\", null);\n+    }\n+\n+    @Override\n+    public String toString()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzNTQ1MA==", "bodyText": "I remember you told me it  is needed but\n\ni dont remember why, this needs to be doc'd\ni still would try to remove it (i can try if you want me to)", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484435450", "createdAt": "2020-09-07T13:34:54Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/testng.xml", "diffHunk": "@@ -0,0 +1,22 @@\n+<!DOCTYPE suite SYSTEM \"http://testng.org/testng-1.0.dtd\" >\n+<!--\n+  ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n+  ~ you may not use this file except in compliance with the License.\n+  ~ You may obtain a copy of the License at\n+  ~\n+  ~     http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  -->\n+\n+<suite name=\"JdbcCompatibilytOldServer\" verbose=\"1\" >\n+    <test name=\"all\" group-by-instances=\"true\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzNjIxMQ==", "bodyText": "Since this is a \"normally testable module\", it doesn't need to be included here (a special case).\nYou can add this to test job (regular module tests).", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484436211", "createdAt": "2020-09-07T13:36:19Z", "author": {"login": "findepi"}, "path": ".github/workflows/ci.yml", "diffHunk": "@@ -74,15 +74,19 @@ jobs:\n     runs-on: ubuntu-latest\n     steps:\n       - uses: actions/checkout@v2\n+        with:\n+          fetch-depth: 0 # checkout tags so version in Manifest is set properly\n       - uses: actions/setup-java@v1\n         with:\n           java-version: 11\n       - name: Maven Install\n         run: |\n           export MAVEN_OPTS=\"${MAVEN_INSTALL_OPTS}\"\n-          ./bin/retry ./mvnw install ${MAVEN_FAST_INSTALL} -pl '!presto-test-jdbc-compatibility-old-driver,!presto-docs,!presto-server,!presto-server-rpm'\n-      - name: Test JDBC clients\n+          ./bin/retry ./mvnw install ${MAVEN_FAST_INSTALL} -pl '!presto-test-jdbc-compatibility-old-driver,!presto-test-jdbc-compatibility-old-server,!presto-docs,!presto-server,!presto-server-rpm'\n+      - name: Test old JDBC vs current server\n         run: presto-test-jdbc-compatibility-old-driver/bin/run_tests.sh\n+      - name: Test current JDBC vs old server\n+        run: ./mvnw test -B -Dair.check.skip-all -pl presto-test-jdbc-compatibility-old-server", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzNjM3Nw==", "bodyText": "move this to appropriate place if you move the new module to test job", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484436377", "createdAt": "2020-09-07T13:36:41Z", "author": {"login": "findepi"}, "path": ".github/workflows/ci.yml", "diffHunk": "@@ -191,7 +195,8 @@ jobs:\n             !presto-oracle,\n             !presto-kudu,\n             !presto-phoenix,!presto-iceberg,!presto-druid,\n-            !presto-docs,!presto-server,!presto-server-rpm'\n+            !presto-docs,!presto-server,!presto-server-rpm,\n+            !presto-test-jdbc-compatibility-old-server'", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzOTgxNDE4", "url": "https://github.com/trinodb/trino/pull/4998#pullrequestreview-483981418", "createdAt": "2020-09-08T09:59:54Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwOTo1OTo1NFrOHOVzhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDowMjo1MlrOHOV5-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc5OTM2NQ==", "bodyText": "Add comment why we do not throw here.\n(i think i'd still prefer to throw to keep the code simpler, unless testng or surefire swallows this)", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484799365", "createdAt": "2020-09-08T09:59:54Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestJdbcResultSetCompatibilityOldServer.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.jdbc.BaseTestJdbcResultSet;\n+import io.prestosql.jdbc.PrestoDriver;\n+import io.prestosql.testing.TestngUtils;\n+import org.testcontainers.containers.PrestoContainer;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.base.Throwables.getStackTraceAsString;\n+import static java.util.Objects.requireNonNull;\n+\n+@Test(singleThreaded = true)\n+public class TestJdbcResultSetCompatibilityOldServer\n+        extends BaseTestJdbcResultSet\n+{\n+    private static final int NUMBER_OF_TESTED_VERSIONS = 5;\n+    private static final int TESTED_VERSIONS_GRANULARITY = 3;\n+\n+    /**\n+     * Empty means that we could not obtain current Presto version and tests defined here will be marked as failed.\n+     */\n+    private final Optional<String> testedPrestoVersion;\n+    private PrestoContainer<?> prestoContainer;\n+\n+    @Factory(dataProvider = \"testedPrestoVersions\")\n+    public TestJdbcResultSetCompatibilityOldServer(Optional<String> testedPrestoVersion)\n+    {\n+        this.testedPrestoVersion = requireNonNull(testedPrestoVersion, \"testedPrestoVersion is null\");\n+    }\n+\n+    @DataProvider\n+    public static Object[][] testedPrestoVersions()\n+    {\n+        try {\n+            String currentVersionString = requireNonNull(PrestoDriver.class.getPackage().getImplementationVersion());\n+            // this should match git-describe output which is used as version stored in metadata\n+            Matcher matcher = Pattern.compile(\"(\\\\d+)(?:-\\\\d+-[a-z0-9]+)?\").matcher(currentVersionString);\n+            checkState(matcher.matches());\n+            int currentVersion = Integer.parseInt(matcher.group(1));\n+            ImmutableList.Builder<String> testedPrestoVersions = ImmutableList.builder();\n+            int lastReleasedVersion = currentVersion - 1;\n+            for (int i = 0; i < NUMBER_OF_TESTED_VERSIONS; i++) {\n+                testedPrestoVersions.add(String.valueOf(lastReleasedVersion - TESTED_VERSIONS_GRANULARITY * i));\n+            }\n+\n+            return testedPrestoVersions.build().stream()\n+                    .map(Optional::of)\n+                    .collect(TestngUtils.toDataProvider());\n+        }\n+        catch (Throwable e) {\n+            System.err.println(\"Could not determine Presto versions to test; \" + e.getMessage() + \"\\n\" + getStackTraceAsString(e));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgwMTAxNg==", "bodyText": "obviously, this means\n\nwhen current is 341-SNAPSHOT, we test aginst 340, 337, ...\nwhen we do the 341 release, we will be testing against 341, 338\n\nNow, what if 338 does not pass the test for some reason?\nThe release procedure may result in the master branch turning red.\nhm... maybe TESTED_VERSIONS_GRANULARITY is not so good an idea after all?\nor maybe the above is actually OK?", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r484801016", "createdAt": "2020-09-08T10:02:52Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestJdbcResultSetCompatibilityOldServer.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.jdbc.BaseTestJdbcResultSet;\n+import io.prestosql.jdbc.PrestoDriver;\n+import io.prestosql.testing.TestngUtils;\n+import org.testcontainers.containers.PrestoContainer;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.base.Throwables.getStackTraceAsString;\n+import static java.util.Objects.requireNonNull;\n+\n+@Test(singleThreaded = true)\n+public class TestJdbcResultSetCompatibilityOldServer\n+        extends BaseTestJdbcResultSet\n+{\n+    private static final int NUMBER_OF_TESTED_VERSIONS = 5;\n+    private static final int TESTED_VERSIONS_GRANULARITY = 3;\n+\n+    /**\n+     * Empty means that we could not obtain current Presto version and tests defined here will be marked as failed.\n+     */\n+    private final Optional<String> testedPrestoVersion;\n+    private PrestoContainer<?> prestoContainer;\n+\n+    @Factory(dataProvider = \"testedPrestoVersions\")\n+    public TestJdbcResultSetCompatibilityOldServer(Optional<String> testedPrestoVersion)\n+    {\n+        this.testedPrestoVersion = requireNonNull(testedPrestoVersion, \"testedPrestoVersion is null\");\n+    }\n+\n+    @DataProvider\n+    public static Object[][] testedPrestoVersions()\n+    {\n+        try {\n+            String currentVersionString = requireNonNull(PrestoDriver.class.getPackage().getImplementationVersion());\n+            // this should match git-describe output which is used as version stored in metadata\n+            Matcher matcher = Pattern.compile(\"(\\\\d+)(?:-\\\\d+-[a-z0-9]+)?\").matcher(currentVersionString);\n+            checkState(matcher.matches());\n+            int currentVersion = Integer.parseInt(matcher.group(1));\n+            ImmutableList.Builder<String> testedPrestoVersions = ImmutableList.builder();\n+            int lastReleasedVersion = currentVersion - 1;\n+            for (int i = 0; i < NUMBER_OF_TESTED_VERSIONS; i++) {\n+                testedPrestoVersions.add(String.valueOf(lastReleasedVersion - TESTED_VERSIONS_GRANULARITY * i));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 68}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "1af9110400c02a13613ab1938f2efcd890f97ee8", "author": {"user": {"login": "losipiuk", "name": "\u0141ukasz Osipiuk"}}, "url": "https://github.com/trinodb/trino/commit/1af9110400c02a13613ab1938f2efcd890f97ee8", "committedDate": "2020-09-11T18:06:26Z", "message": "Rename presto-test-jdbc-compatibility to presto-test-jdbc-compatibility-old-driver"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDkyMDAz", "url": "https://github.com/trinodb/trino/pull/4998#pullrequestreview-487092003", "createdAt": "2020-09-11T20:06:25Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQyMDowNjoyNVrOHQsTcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQyMDoyNDozMFrOHQsxfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NTEzNw==", "bodyText": "Looks like sentence cut off", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r487265137", "createdAt": "2020-09-11T20:06:25Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -0,0 +1,548 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.jdbc;\n+\n+import com.google.common.collect.ImmutableMap;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Test;\n+\n+import java.math.BigDecimal;\n+import java.sql.Connection;\n+import java.sql.Date;\n+import java.sql.ResultSet;\n+import java.sql.ResultSetMetaData;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.sql.Time;\n+import java.sql.Timestamp;\n+import java.sql.Types;\n+import java.time.LocalDate;\n+import java.time.LocalDateTime;\n+import java.time.LocalTime;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static java.util.concurrent.TimeUnit.HOURS;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertNotNull;\n+import static org.testng.Assert.assertThrows;\n+import static org.testng.Assert.assertTrue;\n+\n+@Test(singleThreaded = true)\n+public abstract class BaseTestJdbcResultSet\n+{\n+    private Connection connection;\n+    private Statement statement;\n+\n+    protected abstract Connection createConnection() throws Exception;\n+\n+    @SuppressWarnings(\"JDBCResourceOpenedButNotSafelyClosed\")\n+    @BeforeMethod\n+    public void setup()\n+            throws Exception\n+    {\n+        connection = createConnection();\n+        statement = connection.createStatement();\n+    }\n+\n+    @AfterMethod(alwaysRun = true)\n+    public void teardown()\n+            throws Exception\n+    {\n+        statement.close();\n+        connection.close();\n+    }\n+\n+    @Test\n+    public void testDuplicateColumnLabels()\n+            throws Exception\n+    {\n+        try (ResultSet rs = statement.executeQuery(\"SELECT 123 x, 456 x\")) {\n+            ResultSetMetaData metadata = rs.getMetaData();\n+            assertEquals(metadata.getColumnCount(), 2);\n+            assertEquals(metadata.getColumnName(1), \"x\");\n+            assertEquals(metadata.getColumnName(2), \"x\");\n+\n+            assertTrue(rs.next());\n+            assertEquals(rs.getLong(1), 123L);\n+            assertEquals(rs.getLong(2), 456L);\n+            assertEquals(rs.getLong(\"x\"), 123L);\n+        }\n+    }\n+\n+    @Test\n+    public void testPrimitiveTypes()\n+            throws Exception\n+    {\n+        checkRepresentation(\"123\", Types.INTEGER, 123);\n+        checkRepresentation(\"12300000000\", Types.BIGINT, 12300000000L);\n+        checkRepresentation(\"REAL '123.45'\", Types.REAL, 123.45f);\n+        checkRepresentation(\"1e-1\", Types.DOUBLE, 0.1);\n+        checkRepresentation(\"1.0E0 / 0.0E0\", Types.DOUBLE, Double.POSITIVE_INFINITY);\n+        checkRepresentation(\"0.0E0 / 0.0E0\", Types.DOUBLE, Double.NaN);\n+        checkRepresentation(\"true\", Types.BOOLEAN, true);\n+        checkRepresentation(\"'hello'\", Types.VARCHAR, \"hello\");\n+        checkRepresentation(\"cast('foo' as char(5))\", Types.CHAR, \"foo  \");\n+    }\n+\n+    @Test\n+    public void testDecimal()\n+            throws Exception\n+    {\n+        checkRepresentation(\"0.1\", Types.DECIMAL, new BigDecimal(\"0.1\"));\n+        checkRepresentation(\"DECIMAL '0.1'\", Types.DECIMAL, new BigDecimal(\"0.1\"));\n+    }\n+\n+    @Test\n+    public void testDate()\n+            throws Exception\n+    {\n+        checkRepresentation(\"DATE '2018-02-13'\", Types.DATE, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Date.valueOf(LocalDate.of(2018, 2, 13)));\n+            assertEquals(rs.getObject(column, Date.class), Date.valueOf(LocalDate.of(2018, 2, 13)));\n+            assertEquals(rs.getDate(column), Date.valueOf(LocalDate.of(2018, 2, 13)));\n+            assertThrows(IllegalArgumentException.class, () -> rs.getTime(column));\n+            assertThrows(IllegalArgumentException.class, () -> rs.getTimestamp(column));\n+        });\n+\n+        // distant past, but apparently not an uncommon value in practice\n+        checkRepresentation(\"DATE '0001-01-01'\", Types.DATE, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Date.valueOf(LocalDate.of(1, 1, 1)));\n+            assertEquals(rs.getDate(column), Date.valueOf(LocalDate.of(1, 1, 1)));\n+            assertThrows(IllegalArgumentException.class, () -> rs.getTime(column));\n+            assertThrows(IllegalArgumentException.class, () -> rs.getTimestamp(column));\n+        });\n+\n+        // the Julian-Gregorian calendar \"default cut-over\"\n+        checkRepresentation(\"DATE '1582-10-04'\", Types.DATE, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Date.valueOf(LocalDate.of(1582, 10, 4)));\n+            assertEquals(rs.getDate(column), Date.valueOf(LocalDate.of(1582, 10, 4)));\n+            assertThrows(IllegalArgumentException.class, () -> rs.getTime(column));\n+            assertThrows(IllegalArgumentException.class, () -> rs.getTimestamp(column));\n+        });\n+\n+        // after the Julian-Gregorian calendar \"default cut-over\", but before the Gregorian calendar start\n+        checkRepresentation(\"DATE '1582-10-10'\", Types.DATE, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Date.valueOf(LocalDate.of(1582, 10, 10)));\n+            assertEquals(rs.getDate(column), Date.valueOf(LocalDate.of(1582, 10, 10)));\n+            assertThrows(IllegalArgumentException.class, () -> rs.getTime(column));\n+            assertThrows(IllegalArgumentException.class, () -> rs.getTimestamp(column));\n+        });\n+\n+        // the Gregorian calendar start\n+        checkRepresentation(\"DATE '1582-10-15'\", Types.DATE, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Date.valueOf(LocalDate.of(1582, 10, 15)));\n+            assertEquals(rs.getDate(column), Date.valueOf(LocalDate.of(1582, 10, 15)));\n+            assertThrows(IllegalArgumentException.class, () -> rs.getTime(column));\n+            assertThrows(IllegalArgumentException.class, () -> rs.getTimestamp(column));\n+        });\n+    }\n+\n+    @Test\n+    public void testTime()\n+            throws Exception\n+    {\n+        checkRepresentation(\"TIME '09:39:05.000'\", Types.TIME, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Time.valueOf(LocalTime.of(9, 39, 5)));\n+            assertEquals(rs.getObject(column, Time.class), Time.valueOf(LocalTime.of(9, 39, 5)));\n+            assertThrows(() -> rs.getDate(column));\n+            assertEquals(rs.getTime(column), Time.valueOf(LocalTime.of(9, 39, 5)));\n+            assertThrows(() -> rs.getTimestamp(column));\n+        });\n+\n+        // TODO https://github.com/prestosql/presto/issues/37\n+        // TODO line 1:8: '00:39:05' is not a valid time literal\n+//        checkRepresentation(\"TIME '00:39:05'\", Types.TIME, (rs, column) -> {\n+//            ...\n+//        });\n+\n+        checkRepresentation(\"TIME '09:39:07 +01:00'\", Types.TIME /* TODO TIME_WITH_TIMEZONE */, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Time.valueOf(LocalTime.of(1, 39, 7))); // TODO this should represent TIME '09:39:07 +01:00'\n+            assertThrows(() -> rs.getDate(column));\n+            assertEquals(rs.getTime(column), Time.valueOf(LocalTime.of(1, 39, 7))); // TODO this should fail, or represent TIME '09:39:07'\n+            assertThrows(() -> rs.getTimestamp(column));\n+        });\n+\n+        checkRepresentation(\"TIME '01:39:07 +01:00'\", Types.TIME /* TODO TIME_WITH_TIMEZONE */, (rs, column) -> {\n+            Time someBogusValue = new Time(\n+                    Time.valueOf(\n+                            LocalTime.of(16, 39, 7)).getTime() /* 16:39:07 = 01:39:07 - +01:00 shift + Bahia_Banderas's shift (-8) (modulo 24h which we \"un-modulo\" below) */\n+                            - DAYS.toMillis(1) /* because we use currently 'shifted' representation, not possible to create just using LocalTime */\n+                            + HOURS.toMillis(1) /* because there was offset shift on 1970-01-01 in America/Bahia_Banderas */);\n+            assertEquals(rs.getObject(column), someBogusValue); // TODO this should represent TIME '01:39:07 +01:00'\n+            assertThrows(() -> rs.getDate(column));\n+            assertEquals(rs.getTime(column), someBogusValue); // TODO this should fail, or represent TIME '01:39:07'\n+            assertThrows(() -> rs.getTimestamp(column));\n+        });\n+\n+        checkRepresentation(\"TIME '00:39:07 +01:00'\", Types.TIME /* TODO TIME_WITH_TIMEZONE */, (rs, column) -> {\n+            Time someBogusValue = new Time(\n+                    Time.valueOf(\n+                            LocalTime.of(15, 39, 7)).getTime() /* 15:39:07 = 00:39:07 - +01:00 shift + Bahia_Banderas's shift (-8) (modulo 24h which we \"un-modulo\" below) */\n+                            - DAYS.toMillis(1) /* because we use currently 'shifted' representation, not possible to create just using LocalTime */\n+                            + HOURS.toMillis(1) /* because there was offset shift on 1970-01-01 in America/Bahia_Banderas */);\n+            assertEquals(rs.getObject(column), someBogusValue); // TODO this should represent TIME '00:39:07 +01:00'\n+            assertThrows(() -> rs.getDate(column));\n+            assertEquals(rs.getTime(column), someBogusValue); // TODO this should fail, as there no java.sql.Time representation for TIME '00:39:07' in America/Bahia_Banderas\n+            assertThrows(() -> rs.getTimestamp(column));\n+        });\n+    }\n+\n+    @Test\n+    public void testTimestamp()\n+            throws Exception\n+    {\n+        checkRepresentation(\"TIMESTAMP '2018-02-13 13:14:15.123'\", Types.TIMESTAMP, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(2018, 2, 13, 13, 14, 15, 123_000_000)));\n+            assertEquals(rs.getObject(column, Timestamp.class), Timestamp.valueOf(LocalDateTime.of(2018, 2, 13, 13, 14, 15, 123_000_000)));\n+            assertThrows(() -> rs.getDate(column));\n+            assertThrows(() -> rs.getTime(column));\n+            assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(2018, 2, 13, 13, 14, 15, 123_000_000)));\n+        });\n+\n+        checkRepresentation(\"TIMESTAMP '2018-02-13 13:14:15.111111111111'\", Types.TIMESTAMP, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(2018, 2, 13, 13, 14, 15, 111_111_111)));\n+            assertThrows(() -> rs.getDate(column));\n+            assertThrows(() -> rs.getTime(column));\n+            assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(2018, 2, 13, 13, 14, 15, 111_111_111)));\n+        });\n+\n+        checkRepresentation(\"TIMESTAMP '2018-02-13 13:14:15.555555555555'\", Types.TIMESTAMP, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(2018, 2, 13, 13, 14, 15, 555_555_556)));\n+            assertThrows(() -> rs.getDate(column));\n+            assertThrows(() -> rs.getTime(column));\n+            assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(2018, 2, 13, 13, 14, 15, 555_555_556)));\n+        });\n+\n+        // distant past, but apparently not an uncommon value in practice\n+        checkRepresentation(\"TIMESTAMP '0001-01-01 00:00:00'\", Types.TIMESTAMP, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(1, 1, 1, 0, 0, 0)));\n+            assertThrows(() -> rs.getDate(column));\n+            assertThrows(() -> rs.getTime(column));\n+            assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(1, 1, 1, 0, 0, 0)));\n+        });\n+\n+        // the Julian-Gregorian calendar \"default cut-over\"\n+        checkRepresentation(\"TIMESTAMP '1582-10-04 00:00:00'\", Types.TIMESTAMP, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(1582, 10, 4, 0, 0, 0)));\n+            assertThrows(() -> rs.getDate(column));\n+            assertThrows(() -> rs.getTime(column));\n+            assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(1582, 10, 4, 0, 0, 0)));\n+        });\n+\n+        // after the Julian-Gregorian calendar \"default cut-over\", but before the Gregorian calendar start\n+        checkRepresentation(\"TIMESTAMP '1582-10-10 00:00:00'\", Types.TIMESTAMP, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(1582, 10, 10, 0, 0, 0)));\n+            assertThrows(() -> rs.getDate(column));\n+            assertThrows(() -> rs.getTime(column));\n+            assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(1582, 10, 10, 0, 0, 0)));\n+        });\n+\n+        // the Gregorian calendar start\n+        checkRepresentation(\"TIMESTAMP '1582-10-15 00:00:00'\", Types.TIMESTAMP, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(1582, 10, 15, 0, 0, 0)));\n+            assertThrows(() -> rs.getDate(column));\n+            assertThrows(() -> rs.getTime(column));\n+            assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(1582, 10, 15, 0, 0, 0)));\n+        });\n+\n+        checkRepresentation(\"TIMESTAMP '1583-01-01 00:00:00'\", Types.TIMESTAMP, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(1583, 1, 1, 0, 0, 0)));\n+            assertThrows(() -> rs.getDate(column));\n+            assertThrows(() -> rs.getTime(column));\n+            assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(1583, 1, 1, 0, 0, 0)));\n+        });\n+\n+        // TODO https://github.com/prestosql/presto/issues/37\n+        // TODO line 1:8: '1970-01-01 00:14:15.123' is not a valid timestamp literal; the expected values will pro\n+//        checkRepresentation(\"TIMESTAMP '1970-01-01 00:14:15.123'\", Types.TIMESTAMP, (rs, column) -> {\n+//            ...\n+//        });\n+\n+        // TODO https://github.com/prestosql/presto/issues/4363\n+//        checkRepresentation(\"TIMESTAMP '-123456-01-23 01:23:45.123456789'\", Types.TIMESTAMP, (rs, column) -> {\n+//            ...\n+//        });\n+\n+        checkRepresentation(\"TIMESTAMP '123456-01-23 01:23:45.123456789'\", Types.TIMESTAMP, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(123456, 1, 23, 1, 23, 45, 123_456_789)));\n+            assertThrows(() -> rs.getDate(column));\n+            assertThrows(() -> rs.getTime(column));\n+            assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(123456, 1, 23, 1, 23, 45, 123_456_789)));\n+        });\n+\n+        checkRepresentation(\"TIMESTAMP '2018-02-13 13:14:15.227 Europe/Warsaw'\", Types.TIMESTAMP /* TODO TIMESTAMP_WITH_TIMEZONE */, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(2018, 2, 13, 6, 14, 15, 227_000_000))); // TODO this should represent TIMESTAMP '2018-02-13 13:14:15.227 Europe/Warsaw'\n+            assertThrows(() -> rs.getDate(column));\n+            assertThrows(() -> rs.getTime(column));\n+            assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(2018, 2, 13, 6, 14, 15, 227_000_000))); // TODO this should fail, or represent TIMESTAMP '2018-02-13 13:14:15.227'\n+        });\n+\n+        checkRepresentation(\"TIMESTAMP '1970-01-01 09:14:15.227 Europe/Warsaw'\", Types.TIMESTAMP /* TODO TIMESTAMP_WITH_TIMEZONE */, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(1970, 1, 1, 1, 14, 15, 227_000_000))); // TODO this should represent TIMESTAMP '1970-01-01 09:14:15.227 Europe/Warsaw'\n+            assertThrows(() -> rs.getDate(column));\n+            assertThrows(() -> rs.getTime(column));\n+            assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(1970, 1, 1, 1, 14, 15, 227_000_000))); // TODO this should fail, or represent TIMESTAMP '1970-01-01 09:14:15.227'\n+        });\n+\n+        checkRepresentation(\"TIMESTAMP '1970-01-01 00:14:15.227 Europe/Warsaw'\", Types.TIMESTAMP /* TODO TIMESTAMP_WITH_TIMEZONE */, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(1969, 12, 31, 15, 14, 15, 227_000_000))); // TODO this should represent TIMESTAMP '1970-01-01 00:14:15.227 Europe/Warsaw'\n+            assertThrows(() -> rs.getDate(column));\n+            assertThrows(() -> rs.getTime(column));\n+            // TODO this should fail, as there no java.sql.Timestamp representation for TIMESTAMP '1970-01-01 00:14:15.227\u00f3' in America/Bahia_Banderas\n+            assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(1969, 12, 31, 15, 14, 15, 227_000_000)));\n+        });\n+\n+        // TODO https://github.com/prestosql/presto/issues/4363\n+//        checkRepresentation(\"TIMESTAMP '-12345-01-23 01:23:45.123456789 Europe/Warsaw'\", Types.TIMESTAMP /* TODO TIMESTAMP_WITH_TIMEZONE */, (rs, column) -> {\n+//            ...\n+//        });\n+\n+        checkRepresentation(\"TIMESTAMP '12345-01-23 01:23:45.123456789 Europe/Warsaw'\", Types.TIMESTAMP /* TODO TIMESTAMP_WITH_TIMEZONE */, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(12345, 1, 22, 18, 23, 45, 123_456_789))); // TODO this should contain the zone\n+            assertThrows(() -> rs.getDate(column));\n+            assertThrows(() -> rs.getTime(column));\n+            assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(12345, 1, 22, 18, 23, 45, 123_456_789)));\n+        });\n+    }\n+\n+    @Test\n+    public void testIpAddress()\n+            throws Exception\n+    {\n+        checkRepresentation(\"IPADDRESS '1.2.3.4'\", Types.JAVA_OBJECT, \"1.2.3.4\");\n+    }\n+\n+    @Test\n+    public void testUuid()\n+            throws Exception\n+    {\n+        checkRepresentation(\"UUID '0397e63b-2b78-4b7b-9c87-e085fa225dd8'\", Types.JAVA_OBJECT, \"0397e63b-2b78-4b7b-9c87-e085fa225dd8\");\n+    }\n+\n+    @Test\n+    public void testArray()\n+            throws Exception\n+    {\n+        checkRepresentation(\"ARRAY[1, 2]\", Types.ARRAY, (rs, column) -> assertEquals(rs.getArray(column).getArray(), new int[] {1, 2}));\n+    }\n+\n+    @Test\n+    public void testMap()\n+            throws Exception\n+    {\n+        checkRepresentation(\"map(ARRAY['k1', 'k2'], ARRAY[BIGINT '42', -117])\", Types.JAVA_OBJECT, (rs, column) -> {\n+            assertEquals(rs.getObject(column), ImmutableMap.of(\"k1\", 42L, \"k2\", -117L));\n+            assertEquals(rs.getObject(column, Map.class), ImmutableMap.of(\"k1\", 42L, \"k2\", -117L));\n+        });\n+\n+        // NULL value\n+        checkRepresentation(\"map(ARRAY['k1', 'k2'], ARRAY[42, NULL])\", Types.JAVA_OBJECT, (rs, column) -> {\n+            Map<String, Integer> expected = new HashMap<>();\n+            expected.put(\"k1\", 42);\n+            expected.put(\"k2\", null);\n+            assertEquals(rs.getObject(column), expected);\n+            assertEquals(rs.getObject(column, Map.class), expected);\n+        });\n+    }\n+\n+    @Test\n+    public void testRow()\n+            throws Exception\n+    {\n+        // named row\n+        checkRepresentation(\"CAST(ROW(42, 'Presto') AS ROW(a_bigint bigint, a_varchar varchar(17)))\", Types.JAVA_OBJECT, (rs, column) -> {\n+            assertEquals(rs.getObject(column), ImmutableMap.of(\"a_bigint\", 42L, \"a_varchar\", \"Presto\"));\n+            assertEquals(rs.getObject(column, Map.class), ImmutableMap.of(\"a_bigint\", 42L, \"a_varchar\", \"Presto\"));\n+        });\n+\n+        // partially named row\n+        checkRepresentation(\"CAST(ROW(42, 'Presto') AS ROW(a_bigint bigint, varchar(17)))\", Types.JAVA_OBJECT, (rs, column) -> {\n+            assertEquals(rs.getObject(column), ImmutableMap.of(\"a_bigint\", 42L, \"field1\", \"Presto\"));\n+            assertEquals(rs.getObject(column, Map.class), ImmutableMap.of(\"a_bigint\", 42L, \"field1\", \"Presto\"));\n+        });\n+\n+        // anonymous row\n+        checkRepresentation(\"ROW(42, 'Presto')\", Types.JAVA_OBJECT, (rs, column) -> {\n+            assertEquals(rs.getObject(column), ImmutableMap.of(\"field0\", 42, \"field1\", \"Presto\"));\n+            assertEquals(rs.getObject(column, Map.class), ImmutableMap.of(\"field0\", 42, \"field1\", \"Presto\"));\n+        });\n+\n+        // name collision\n+        checkRepresentation(\"CAST(ROW(42, 'Presto') AS ROW(field1 integer, varchar(17)))\", Types.JAVA_OBJECT, (rs, column) -> {\n+            // TODO (https://github.com/prestosql/presto/issues/4594) both fields should be visible or exception thrown\n+            assertEquals(rs.getObject(column), ImmutableMap.of(\"field1\", \"Presto\"));\n+            assertEquals(rs.getObject(column, Map.class), ImmutableMap.of(\"field1\", \"Presto\"));\n+        });\n+    }\n+\n+    private void checkRepresentation(String expression, int expectedSqlType, Object expectedRepresentation)\n+            throws Exception\n+    {\n+        checkRepresentation(expression, expectedSqlType, (rs, column) -> {\n+            assertEquals(rs.getObject(column), expectedRepresentation);\n+            assertEquals(rs.getObject(column, expectedRepresentation.getClass()), expectedRepresentation);\n+        });\n+    }\n+\n+    private void checkRepresentation(String expression, int expectedSqlType, ResultAssertion assertion)\n+            throws Exception\n+    {\n+        try (ResultSet rs = statement.executeQuery(\"SELECT \" + expression)) {\n+            ResultSetMetaData metadata = rs.getMetaData();\n+            assertEquals(metadata.getColumnCount(), 1);\n+            assertEquals(metadata.getColumnType(1), expectedSqlType);\n+            assertTrue(rs.next());\n+            assertion.accept(rs, 1);\n+            assertFalse(rs.next());\n+        }\n+    }\n+\n+    @Test\n+    public void testStatsExtraction()\n+            throws Exception\n+    {\n+        try (PrestoResultSet rs = (PrestoResultSet) statement.executeQuery(\"SELECT 123 x, 456 x\")) {\n+            assertNotNull(rs.getStats());\n+            assertTrue(rs.next());\n+            assertNotNull(rs.getStats());\n+            assertFalse(rs.next());\n+            assertNotNull(rs.getStats());\n+        }\n+    }\n+\n+    @Test\n+    public void testMaxRowsUnset()\n+            throws SQLException\n+    {\n+        assertMaxRowsLimit(0);\n+        assertMaxRowsResult(7);\n+    }\n+\n+    @Test\n+    public void testMaxRowsUnlimited()\n+            throws SQLException\n+    {\n+        assertMaxRowsLimit(0);\n+        statement.setMaxRows(0);\n+        assertMaxRowsLimit(0);\n+        assertMaxRowsResult(7);\n+    }\n+\n+    @Test\n+    public void testMaxRowsLimited()\n+            throws SQLException\n+    {\n+        assertMaxRowsLimit(0);\n+        statement.setMaxRows(4);\n+        assertMaxRowsLimit(4);\n+        assertMaxRowsResult(4);\n+    }\n+\n+    @Test\n+    public void testMaxRowsLimitLargerThanResult()\n+            throws SQLException\n+    {\n+        assertMaxRowsLimit(0);\n+        statement.setMaxRows(10);\n+        assertMaxRowsLimit(10);\n+        assertMaxRowsResult(7);\n+    }\n+\n+    @Test\n+    public void testLargeMaxRowsUnlimited()\n+            throws SQLException\n+    {\n+        assertMaxRowsLimit(0);\n+        statement.setLargeMaxRows(0);\n+        assertMaxRowsLimit(0);\n+        assertMaxRowsResult(7);\n+    }\n+\n+    @Test\n+    public void testLargeMaxRowsLimited()\n+            throws SQLException\n+    {\n+        assertMaxRowsLimit(0);\n+        statement.setLargeMaxRows(4);\n+        assertMaxRowsLimit(4);\n+        assertMaxRowsResult(4);\n+    }\n+\n+    @Test\n+    public void testLargeMaxRowsLimitLargerThanResult()\n+            throws SQLException\n+    {\n+        long limit = Integer.MAX_VALUE * 10L;\n+        statement.setLargeMaxRows(limit);\n+        assertEquals(statement.getLargeMaxRows(), limit);\n+        assertMaxRowsResult(7);\n+    }\n+\n+    private void assertMaxRowsLimit(int expectedLimit)\n+            throws SQLException\n+    {\n+        assertEquals(statement.getMaxRows(), expectedLimit);\n+        assertEquals(statement.getLargeMaxRows(), expectedLimit);\n+    }\n+\n+    private void assertMaxRowsResult(long expectedCount)\n+            throws SQLException\n+    {\n+        try (ResultSet rs = statement.executeQuery(\"SELECT * FROM (VALUES (1), (2), (3), (4), (5), (6), (7)) AS x (a)\")) {\n+            assertEquals(countRows(rs), expectedCount);\n+        }\n+    }\n+\n+    @Test(expectedExceptions = SQLException.class, expectedExceptionsMessageRegExp = \"Max rows exceeds limit of 2147483647\")\n+    public void testMaxRowsExceedsLimit()\n+            throws SQLException\n+    {\n+        statement.setLargeMaxRows(Integer.MAX_VALUE * 10L);\n+        statement.getMaxRows();\n+    }\n+\n+    @Test\n+    public void testGetStatement()\n+            throws SQLException\n+    {\n+        try (ResultSet rs = statement.executeQuery(\"SELECT * FROM (VALUES (1), (2), (3))\")) {\n+            assertEquals(rs.getStatement(), statement);\n+        }\n+    }\n+\n+    private static long countRows(ResultSet rs)\n+            throws SQLException\n+    {\n+        long count = 0;\n+        while (rs.next()) {\n+            count++;\n+        }\n+        return count;\n+    }\n+\n+    @FunctionalInterface\n+    private interface ResultAssertion\n+    {\n+        void accept(ResultSet rs, int column)\n+                throws Exception;\n+    }\n+\n+    // Required with", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 545}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NjA2Ng==", "bodyText": "introduce a method:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try (StatementWrapper statementWrapper = new StatementWrapper()) {\n          \n          \n            \n                    try (StatementWrapper statementWrapper = newStatement) {\n          \n      \n    \n    \n  \n\nAlso, the StatementWrapper doesn't capture the intent (it's holder for Statement and Connection)\nMaybe ConnectedStatement would at least hint at something more than \"Statement inside\u2122\"", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r487266066", "createdAt": "2020-09-11T20:08:44Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -42,365 +40,366 @@\n import static org.testng.Assert.assertThrows;\n import static org.testng.Assert.assertTrue;\n \n-@Test(singleThreaded = true)\n public abstract class BaseTestJdbcResultSet\n {\n-    private Connection connection;\n-    private Statement statement;\n-\n-    protected abstract Connection createConnection() throws Exception;\n-\n-    @SuppressWarnings(\"JDBCResourceOpenedButNotSafelyClosed\")\n-    @BeforeMethod\n-    public void setup()\n-            throws Exception\n-    {\n-        connection = createConnection();\n-        statement = connection.createStatement();\n-    }\n-\n-    @AfterMethod(alwaysRun = true)\n-    public void teardown()\n-            throws Exception\n-    {\n-        statement.close();\n-        connection.close();\n-    }\n+    protected abstract Connection createConnection() throws SQLException;\n \n     @Test\n     public void testDuplicateColumnLabels()\n-            throws Exception\n+            throws SQLException\n     {\n-        try (ResultSet rs = statement.executeQuery(\"SELECT 123 x, 456 x\")) {\n-            ResultSetMetaData metadata = rs.getMetaData();\n-            assertEquals(metadata.getColumnCount(), 2);\n-            assertEquals(metadata.getColumnName(1), \"x\");\n-            assertEquals(metadata.getColumnName(2), \"x\");\n-\n-            assertTrue(rs.next());\n-            assertEquals(rs.getLong(1), 123L);\n-            assertEquals(rs.getLong(2), 456L);\n-            assertEquals(rs.getLong(\"x\"), 123L);\n+        try (StatementWrapper statementWrapper = new StatementWrapper()) {\n+            try (ResultSet rs = statementWrapper.getStatement().executeQuery(\"SELECT 123 x, 456 x\")) {\n+                ResultSetMetaData metadata = rs.getMetaData();\n+                assertEquals(metadata.getColumnCount(), 2);\n+                assertEquals(metadata.getColumnName(1), \"x\");\n+                assertEquals(metadata.getColumnName(2), \"x\");\n+\n+                assertTrue(rs.next());\n+                assertEquals(rs.getLong(1), 123L);\n+                assertEquals(rs.getLong(2), 456L);\n+                assertEquals(rs.getLong(\"x\"), 123L);\n+            }\n         }\n     }\n \n     @Test\n     public void testPrimitiveTypes()\n-            throws Exception\n+            throws SQLException\n     {\n-        checkRepresentation(\"123\", Types.INTEGER, 123);\n-        checkRepresentation(\"12300000000\", Types.BIGINT, 12300000000L);\n-        checkRepresentation(\"REAL '123.45'\", Types.REAL, 123.45f);\n-        checkRepresentation(\"1e-1\", Types.DOUBLE, 0.1);\n-        checkRepresentation(\"1.0E0 / 0.0E0\", Types.DOUBLE, Double.POSITIVE_INFINITY);\n-        checkRepresentation(\"0.0E0 / 0.0E0\", Types.DOUBLE, Double.NaN);\n-        checkRepresentation(\"true\", Types.BOOLEAN, true);\n-        checkRepresentation(\"'hello'\", Types.VARCHAR, \"hello\");\n-        checkRepresentation(\"cast('foo' as char(5))\", Types.CHAR, \"foo  \");\n+        try (StatementWrapper statementWrapper = new StatementWrapper()) {\n+            checkRepresentation(statementWrapper.getStatement(), \"123\", Types.INTEGER, 123);\n+            checkRepresentation(statementWrapper.getStatement(), \"12300000000\", Types.BIGINT, 12300000000L);\n+            checkRepresentation(statementWrapper.getStatement(), \"REAL '123.45'\", Types.REAL, 123.45f);\n+            checkRepresentation(statementWrapper.getStatement(), \"1e-1\", Types.DOUBLE, 0.1);\n+            checkRepresentation(statementWrapper.getStatement(), \"1.0E0 / 0.0E0\", Types.DOUBLE, Double.POSITIVE_INFINITY);\n+            checkRepresentation(statementWrapper.getStatement(), \"0.0E0 / 0.0E0\", Types.DOUBLE, Double.NaN);\n+            checkRepresentation(statementWrapper.getStatement(), \"true\", Types.BOOLEAN, true);\n+            checkRepresentation(statementWrapper.getStatement(), \"'hello'\", Types.VARCHAR, \"hello\");\n+            checkRepresentation(statementWrapper.getStatement(), \"cast('foo' as char(5))\", Types.CHAR, \"foo  \");\n+        }\n     }\n \n     @Test\n     public void testDecimal()\n-            throws Exception\n+            throws SQLException\n     {\n-        checkRepresentation(\"0.1\", Types.DECIMAL, new BigDecimal(\"0.1\"));\n-        checkRepresentation(\"DECIMAL '0.1'\", Types.DECIMAL, new BigDecimal(\"0.1\"));\n+        try (StatementWrapper statementWrapper = new StatementWrapper()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NjM4Ng==", "bodyText": "i prefer to have test throws Exception so that i do not need to update this line ever again\n(of course, applies when method throws at least 1 checked ex)", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r487266386", "createdAt": "2020-09-11T20:09:33Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -42,365 +40,366 @@\n import static org.testng.Assert.assertThrows;\n import static org.testng.Assert.assertTrue;\n \n-@Test(singleThreaded = true)\n public abstract class BaseTestJdbcResultSet\n {\n-    private Connection connection;\n-    private Statement statement;\n-\n-    protected abstract Connection createConnection() throws Exception;\n-\n-    @SuppressWarnings(\"JDBCResourceOpenedButNotSafelyClosed\")\n-    @BeforeMethod\n-    public void setup()\n-            throws Exception\n-    {\n-        connection = createConnection();\n-        statement = connection.createStatement();\n-    }\n-\n-    @AfterMethod(alwaysRun = true)\n-    public void teardown()\n-            throws Exception\n-    {\n-        statement.close();\n-        connection.close();\n-    }\n+    protected abstract Connection createConnection() throws SQLException;\n \n     @Test\n     public void testDuplicateColumnLabels()\n-            throws Exception\n+            throws SQLException\n     {\n-        try (ResultSet rs = statement.executeQuery(\"SELECT 123 x, 456 x\")) {\n-            ResultSetMetaData metadata = rs.getMetaData();\n-            assertEquals(metadata.getColumnCount(), 2);\n-            assertEquals(metadata.getColumnName(1), \"x\");\n-            assertEquals(metadata.getColumnName(2), \"x\");\n-\n-            assertTrue(rs.next());\n-            assertEquals(rs.getLong(1), 123L);\n-            assertEquals(rs.getLong(2), 456L);\n-            assertEquals(rs.getLong(\"x\"), 123L);\n+        try (StatementWrapper statementWrapper = new StatementWrapper()) {\n+            try (ResultSet rs = statementWrapper.getStatement().executeQuery(\"SELECT 123 x, 456 x\")) {\n+                ResultSetMetaData metadata = rs.getMetaData();\n+                assertEquals(metadata.getColumnCount(), 2);\n+                assertEquals(metadata.getColumnName(1), \"x\");\n+                assertEquals(metadata.getColumnName(2), \"x\");\n+\n+                assertTrue(rs.next());\n+                assertEquals(rs.getLong(1), 123L);\n+                assertEquals(rs.getLong(2), 456L);\n+                assertEquals(rs.getLong(\"x\"), 123L);\n+            }\n         }\n     }\n \n     @Test\n     public void testPrimitiveTypes()\n-            throws Exception\n+            throws SQLException\n     {\n-        checkRepresentation(\"123\", Types.INTEGER, 123);\n-        checkRepresentation(\"12300000000\", Types.BIGINT, 12300000000L);\n-        checkRepresentation(\"REAL '123.45'\", Types.REAL, 123.45f);\n-        checkRepresentation(\"1e-1\", Types.DOUBLE, 0.1);\n-        checkRepresentation(\"1.0E0 / 0.0E0\", Types.DOUBLE, Double.POSITIVE_INFINITY);\n-        checkRepresentation(\"0.0E0 / 0.0E0\", Types.DOUBLE, Double.NaN);\n-        checkRepresentation(\"true\", Types.BOOLEAN, true);\n-        checkRepresentation(\"'hello'\", Types.VARCHAR, \"hello\");\n-        checkRepresentation(\"cast('foo' as char(5))\", Types.CHAR, \"foo  \");\n+        try (StatementWrapper statementWrapper = new StatementWrapper()) {\n+            checkRepresentation(statementWrapper.getStatement(), \"123\", Types.INTEGER, 123);\n+            checkRepresentation(statementWrapper.getStatement(), \"12300000000\", Types.BIGINT, 12300000000L);\n+            checkRepresentation(statementWrapper.getStatement(), \"REAL '123.45'\", Types.REAL, 123.45f);\n+            checkRepresentation(statementWrapper.getStatement(), \"1e-1\", Types.DOUBLE, 0.1);\n+            checkRepresentation(statementWrapper.getStatement(), \"1.0E0 / 0.0E0\", Types.DOUBLE, Double.POSITIVE_INFINITY);\n+            checkRepresentation(statementWrapper.getStatement(), \"0.0E0 / 0.0E0\", Types.DOUBLE, Double.NaN);\n+            checkRepresentation(statementWrapper.getStatement(), \"true\", Types.BOOLEAN, true);\n+            checkRepresentation(statementWrapper.getStatement(), \"'hello'\", Types.VARCHAR, \"hello\");\n+            checkRepresentation(statementWrapper.getStatement(), \"cast('foo' as char(5))\", Types.CHAR, \"foo  \");\n+        }\n     }\n \n     @Test\n     public void testDecimal()\n-            throws Exception\n+            throws SQLException\n     {\n-        checkRepresentation(\"0.1\", Types.DECIMAL, new BigDecimal(\"0.1\"));\n-        checkRepresentation(\"DECIMAL '0.1'\", Types.DECIMAL, new BigDecimal(\"0.1\"));\n+        try (StatementWrapper statementWrapper = new StatementWrapper()) {\n+            checkRepresentation(statementWrapper.getStatement(), \"0.1\", Types.DECIMAL, new BigDecimal(\"0.1\"));\n+            checkRepresentation(statementWrapper.getStatement(), \"DECIMAL '0.1'\", Types.DECIMAL, new BigDecimal(\"0.1\"));\n+        }\n     }\n \n     @Test\n     public void testDate()\n-            throws Exception\n+            throws SQLException", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2Njg0NQ==", "bodyText": "either remove forceTestNgToRespectSingleThreaded or add the (now deleted) comment on it.\notherwise that method triggers obvious question \"how does it help\" without providing the answer.", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r487266845", "createdAt": "2020-09-11T20:10:37Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-driver/src/test/java/io/prestosql/TestJdbcResultSetCompatibilityOldDriver.java", "diffHunk": "@@ -32,6 +32,8 @@\n import static io.prestosql.TestingServerUtils.setTestingServer;\n import static org.assertj.core.api.Assertions.assertThat;\n \n+// We need to keep @Test(singleThreaded = true) even though current version of superclass does not require it.\n+// This class is compiled against older versions of TestJdbcResultSet which require single threaded execution of tests.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NzIyMA==", "bodyText": "why?", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r487267220", "createdAt": "2020-09-11T20:11:29Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -42,8 +46,33 @@\n \n public abstract class BaseTestJdbcResultSet\n {\n+    private static final Logger log = Logger.get(BaseTestJdbcResultSet.class);\n+\n+    private final Supplier<String> prestoServerVersion = Suppliers.memoize(this::determinePrestoVersion);\n+\n     protected abstract Connection createConnection() throws SQLException;\n \n+    @SuppressWarnings(\"JDBCResourceOpenedButNotSafelyClosed\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NzU1MQ==", "bodyText": "is this setup method left over?\nyou use memoized supplier now.", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r487267551", "createdAt": "2020-09-11T20:12:12Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -42,8 +46,33 @@\n \n public abstract class BaseTestJdbcResultSet\n {\n+    private static final Logger log = Logger.get(BaseTestJdbcResultSet.class);\n+\n+    private final Supplier<String> prestoServerVersion = Suppliers.memoize(this::determinePrestoVersion);\n+\n     protected abstract Connection createConnection() throws SQLException;\n \n+    @SuppressWarnings(\"JDBCResourceOpenedButNotSafelyClosed\")\n+    @BeforeMethod\n+    public void setup()\n+    {\n+        synchronized (this) {\n+            determinePrestoVersion();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2Nzc3Nw==", "bodyText": "rs should be try-with-resources", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r487267777", "createdAt": "2020-09-11T20:12:42Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -42,8 +46,33 @@\n \n public abstract class BaseTestJdbcResultSet\n {\n+    private static final Logger log = Logger.get(BaseTestJdbcResultSet.class);\n+\n+    private final Supplier<String> prestoServerVersion = Suppliers.memoize(this::determinePrestoVersion);\n+\n     protected abstract Connection createConnection() throws SQLException;\n \n+    @SuppressWarnings(\"JDBCResourceOpenedButNotSafelyClosed\")\n+    @BeforeMethod\n+    public void setup()\n+    {\n+        synchronized (this) {\n+            determinePrestoVersion();\n+        }\n+    }\n+\n+    private String determinePrestoVersion()\n+    {\n+        try (StatementWrapper statementWrapper = new StatementWrapper()) {\n+            ResultSet rs = statementWrapper.getStatement().executeQuery(\"SELECT node_version FROM system.runtime.nodes\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2ODExNw==", "bodyText": "node_version -> DISTINCT node_version\nplus assertFalse(rs.next()); at the end (exactly 1 row)", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r487268117", "createdAt": "2020-09-11T20:13:27Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -42,8 +46,33 @@\n \n public abstract class BaseTestJdbcResultSet\n {\n+    private static final Logger log = Logger.get(BaseTestJdbcResultSet.class);\n+\n+    private final Supplier<String> prestoServerVersion = Suppliers.memoize(this::determinePrestoVersion);\n+\n     protected abstract Connection createConnection() throws SQLException;\n \n+    @SuppressWarnings(\"JDBCResourceOpenedButNotSafelyClosed\")\n+    @BeforeMethod\n+    public void setup()\n+    {\n+        synchronized (this) {\n+            determinePrestoVersion();\n+        }\n+    }\n+\n+    private String determinePrestoVersion()\n+    {\n+        try (StatementWrapper statementWrapper = new StatementWrapper()) {\n+            ResultSet rs = statementWrapper.getStatement().executeQuery(\"SELECT node_version FROM system.runtime.nodes\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2OTE2MA==", "bodyText": "The comment sounds as if author did not know why it is the case, and I am pretty sure you know that:\nwhen running from IDE, classes are loaded from */target/classes and there is no manifest there (it's jar's thing).\nWe could make it work by using resource filtering, but I do not see a need for this.\nI'd advice improving comment wording here though", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r487269160", "createdAt": "2020-09-11T20:15:53Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -591,4 +622,26 @@ public Statement getStatement()\n             return statement;\n         }\n     }\n+\n+    private boolean serverSupportsVariablePrecisionTimestamp()\n+    {\n+        return getNumericPrestoServerVersion() >= 335;\n+    }\n+\n+    private boolean serverSupportsVariablePrecisionTimestampWithTimeZone()\n+    {\n+        return getNumericPrestoServerVersion() >= 337;\n+    }\n+\n+    private int getNumericPrestoServerVersion()\n+    {\n+        try {\n+            return Integer.parseInt(prestoServerVersion.get());\n+        }\n+        catch (NumberFormatException e) {\n+            log.info(\"Could not parse Presto version '%s' obtained from server; assuming server is recent\");\n+            // TODO it would be better to get version encoded in Manifest but it does not seem to be available for tests run via surefire/intellij", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2OTIwMQ==", "bodyText": "recent -> latest\n(it's the latest, aka the current version, not \"some relatively recent\")", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r487269201", "createdAt": "2020-09-11T20:15:57Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -591,4 +622,26 @@ public Statement getStatement()\n             return statement;\n         }\n     }\n+\n+    private boolean serverSupportsVariablePrecisionTimestamp()\n+    {\n+        return getNumericPrestoServerVersion() >= 335;\n+    }\n+\n+    private boolean serverSupportsVariablePrecisionTimestampWithTimeZone()\n+    {\n+        return getNumericPrestoServerVersion() >= 337;\n+    }\n+\n+    private int getNumericPrestoServerVersion()\n+    {\n+        try {\n+            return Integer.parseInt(prestoServerVersion.get());\n+        }\n+        catch (NumberFormatException e) {\n+            log.info(\"Could not parse Presto version '%s' obtained from server; assuming server is recent\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 158}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI3MDE2Ng==", "bodyText": "i think it would be nice to validate our assumption that the version string matches\n\\d+(-SNAPSHOT)?\n\nThen use max int for SNPASHOT case and\nuse parseInt for the other case.\nThis way we would catch when the version is sth else than we assume", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r487270166", "createdAt": "2020-09-11T20:18:15Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/BaseTestJdbcResultSet.java", "diffHunk": "@@ -591,4 +622,26 @@ public Statement getStatement()\n             return statement;\n         }\n     }\n+\n+    private boolean serverSupportsVariablePrecisionTimestamp()\n+    {\n+        return getNumericPrestoServerVersion() >= 335;\n+    }\n+\n+    private boolean serverSupportsVariablePrecisionTimestampWithTimeZone()\n+    {\n+        return getNumericPrestoServerVersion() >= 337;\n+    }\n+\n+    private int getNumericPrestoServerVersion()\n+    {\n+        try {\n+            return Integer.parseInt(prestoServerVersion.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI3MDc3Nw==", "bodyText": "Do you make use of this actually?", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r487270777", "createdAt": "2020-09-11T20:19:41Z", "author": {"login": "findepi"}, "path": ".github/workflows/ci.yml", "diffHunk": "@@ -74,15 +74,20 @@ jobs:\n     runs-on: ubuntu-latest\n     steps:\n       - uses: actions/checkout@v2\n+        with:\n+          fetch-depth: 0 # checkout tags so version in Manifest is set properly", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI3MTc0NQ==", "bodyText": "This doesn't work in IDE, does it?\nMaybe add a TODO", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r487271745", "createdAt": "2020-09-11T20:21:55Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestJdbcResultSetCompatibilityOldServer.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.jdbc.BaseTestJdbcResultSet;\n+import io.prestosql.jdbc.PrestoDriver;\n+import io.prestosql.testing.TestngUtils;\n+import org.testcontainers.containers.PrestoContainer;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Factory;\n+\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.base.Throwables.getStackTraceAsString;\n+import static java.util.Objects.requireNonNull;\n+\n+public class TestJdbcResultSetCompatibilityOldServer\n+        extends BaseTestJdbcResultSet\n+{\n+    private static final int NUMBER_OF_TESTED_VERSIONS = 5;\n+    private static final int TESTED_VERSIONS_GRANULARITY = 3;\n+\n+    /**\n+     * Empty means that we could not obtain current Presto version and tests defined here will be marked as failed.\n+     */\n+    private final Optional<String> testedPrestoVersion;\n+    private PrestoContainer<?> prestoContainer;\n+\n+    @Factory(dataProvider = \"testedPrestoVersions\")\n+    public TestJdbcResultSetCompatibilityOldServer(Optional<String> testedPrestoVersion)\n+    {\n+        this.testedPrestoVersion = requireNonNull(testedPrestoVersion, \"testedPrestoVersion is null\");\n+    }\n+\n+    @DataProvider\n+    public static Object[][] testedPrestoVersions()\n+    {\n+        try {\n+            String currentVersionString = requireNonNull(PrestoDriver.class.getPackage().getImplementationVersion());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI3MjgyOQ==", "bodyText": "// This is currently needed so that the test is runnable from IDE\n// TODO use filtered resource to provide current version instead.", "url": "https://github.com/trinodb/trino/pull/4998#discussion_r487272829", "createdAt": "2020-09-11T20:24:30Z", "author": {"login": "findepi"}, "path": "presto-test-jdbc-compatibility-old-server/src/test/java/io/prestosql/TestJdbcResultSetCompatibilityOldServer.java", "diffHunk": "@@ -56,6 +58,12 @@ public TestJdbcResultSetCompatibilityOldServer(Optional<String> testedPrestoVers\n     public static Object[][] testedPrestoVersions()\n     {\n         try {\n+            if (System.getenv(TESTED_VERSIONS_ENV_KEY) != null) {\n+                return Splitter.on(\",\").trimResults().splitToList(System.getenv(TESTED_VERSIONS_ENV_KEY)).stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7911d5ce0083576cfea45876bb10571b38cfe524", "author": {"user": {"login": "losipiuk", "name": "\u0141ukasz Osipiuk"}}, "url": "https://github.com/trinodb/trino/commit/7911d5ce0083576cfea45876bb10571b38cfe524", "committedDate": "2020-09-14T06:55:42Z", "message": "Extract BaseTestJdbcResultSet"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cf3d9bc7c7c5b55215fa55340b3b56df2d0338b", "author": {"user": {"login": "losipiuk", "name": "\u0141ukasz Osipiuk"}}, "url": "https://github.com/trinodb/trino/commit/2cf3d9bc7c7c5b55215fa55340b3b56df2d0338b", "committedDate": "2020-09-14T11:20:08Z", "message": "Make TestJdbcResultSet multi threaded"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f634151d4b712f1cdfe952583b4a6cc7af74ac6", "author": {"user": {"login": "losipiuk", "name": "\u0141ukasz Osipiuk"}}, "url": "https://github.com/trinodb/trino/commit/9f634151d4b712f1cdfe952583b4a6cc7af74ac6", "committedDate": "2020-09-14T11:20:10Z", "message": "Guard JDBC tests against Presto server version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d0a0a2794244be2dcf170ffa5e7ce4fa1c3d602", "author": {"user": {"login": "losipiuk", "name": "\u0141ukasz Osipiuk"}}, "url": "https://github.com/trinodb/trino/commit/8d0a0a2794244be2dcf170ffa5e7ce4fa1c3d602", "committedDate": "2020-09-14T11:20:10Z", "message": "Test current JDBC driver against old Presto releases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b7fb63d33b8366d00bdbd7cf6c698783aeb762e", "author": {"user": {"login": "losipiuk", "name": "\u0141ukasz Osipiuk"}}, "url": "https://github.com/trinodb/trino/commit/7b7fb63d33b8366d00bdbd7cf6c698783aeb762e", "committedDate": "2020-09-14T11:20:10Z", "message": "Allow specifying Presto server version to be tested via env"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "7b7fb63d33b8366d00bdbd7cf6c698783aeb762e", "author": {"user": {"login": "losipiuk", "name": "\u0141ukasz Osipiuk"}}, "url": "https://github.com/trinodb/trino/commit/7b7fb63d33b8366d00bdbd7cf6c698783aeb762e", "committedDate": "2020-09-14T11:20:10Z", "message": "Allow specifying Presto server version to be tested via env"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4225, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}