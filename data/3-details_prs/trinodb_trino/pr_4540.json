{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1Mjg2MzI2", "number": 4540, "title": "Avoid checking isSplittable for files smaller than the split max size", "bodyText": "Cross contribution of prestodb/presto#14877\nFor some input formats, the isSplittable check is non-trivial and can add a significant amount of time to split generation. This change allows files smaller than the max split size to avoid that check and simply calls them unsplittable since they're within the split target range already.", "createdAt": "2020-07-22T18:35:43Z", "url": "https://github.com/trinodb/trino/pull/4540", "merged": true, "mergeCommit": {"oid": "2cf1ca3a4b2c074530738a457ff2a02dc37f3bbb"}, "closed": true, "closedAt": "2020-07-27T16:30:01Z", "author": {"login": "pettyjamesm"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3faYDgFqTQ1MzU5MTQ2MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5EcIpgFqTQ1NTk0NDc5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTkxNDYw", "url": "https://github.com/trinodb/trino/pull/4540#pullrequestreview-453591460", "createdAt": "2020-07-22T18:47:46Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo0Nzo0NlrOG1vq8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo0Nzo0NlrOG1vq8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODc1Mg==", "bodyText": "Wrap here for readability\nsplittable = splittable &&\n        status.getLen() >= minimumSplittableSizeInBytes &&\n        isSplittable(inputFormat, fileSystem, status.getPath());", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459008752", "createdAt": "2020-07-22T18:47:46Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/InternalHiveSplitFactory.java", "diffHunk": "@@ -98,7 +103,7 @@ public String getPartitionName()\n \n     public Optional<InternalHiveSplit> createInternalHiveSplit(LocatedFileStatus status, OptionalInt bucketNumber, boolean splittable, Optional<AcidInfo> acidInfo)\n     {\n-        splittable = splittable && isSplittable(inputFormat, fileSystem, status.getPath());\n+        splittable = splittable && status.getLen() >= minimumSplittableSizeInBytes && isSplittable(inputFormat, fileSystem, status.getPath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTkxNjQ1", "url": "https://github.com/trinodb/trino/pull/4540#pullrequestreview-453591645", "createdAt": "2020-07-22T18:48:00Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo0ODowMFrOG1vrgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo0ODowMFrOG1vrgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODg5Nw==", "bodyText": "These should be getMaxInitialSplitSize(), otherwise we won't split files that are between the initial size and max size (default in the 32MB to 64MB range).", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459008897", "createdAt": "2020-07-22T18:48:00Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -375,6 +376,7 @@ private void invokeNoMoreSplitsIfNecessary()\n                         partitionMatchSupplier,\n                         partition.getTableToPartitionMapping(),\n                         Optional.empty(),\n+                        getMaxSplitSize(session),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad12e6116a3ae0b161c8d9c5a8bfdff86f3e7ae5", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/ad12e6116a3ae0b161c8d9c5a8bfdff86f3e7ae5", "committedDate": "2020-07-22T20:14:09Z", "message": "Avoid checking isSplittable for files smaller than initial split size\n\nFor some input formats, the isSplittable check is non-trivial and can\nadd a significant amount of time to split generation when handling a\nlarge number of very small files. This change allows files smaller\nthan the max initial split size to avoid that check and considers them\nunsplittable instead."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "ad12e6116a3ae0b161c8d9c5a8bfdff86f3e7ae5", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/ad12e6116a3ae0b161c8d9c5a8bfdff86f3e7ae5", "committedDate": "2020-07-22T20:14:09Z", "message": "Avoid checking isSplittable for files smaller than initial split size\n\nFor some input formats, the isSplittable check is non-trivial and can\nadd a significant amount of time to split generation when handling a\nlarge number of very small files. This change allows files smaller\nthan the max initial split size to avoid that check and considers them\nunsplittable instead."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTQ0Nzk4", "url": "https://github.com/trinodb/trino/pull/4540#pullrequestreview-455944798", "createdAt": "2020-07-27T16:30:07Z", "commit": {"oid": "ad12e6116a3ae0b161c8d9c5a8bfdff86f3e7ae5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4837, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}