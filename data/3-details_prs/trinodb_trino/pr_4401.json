{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NzY1Mjgx", "number": 4401, "title": "Add memsql integration smoke tests", "bodyText": "These tests require https://hub.docker.com/r/memsql/cluster-in-a-box, which requires memsql license. A free license is available at https://portal.memsql.com/licenses/. I'm not sure however, what does the agreement says about using this license in integration tests.", "createdAt": "2020-07-09T10:19:55Z", "url": "https://github.com/trinodb/trino/pull/4401", "merged": true, "mergeCommit": {"oid": "6f824d2dcb04bb5047465e9e4795e911eed6431f"}, "closed": true, "closedAt": "2020-08-21T10:58:47Z", "author": {"login": "sopel39"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczMcStgBqjM1MjkwNDUwMDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBB58IgBqjM2Nzg5MjAwOTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NTM3MTk0", "url": "https://github.com/trinodb/trino/pull/4401#pullrequestreview-445537194", "createdAt": "2020-07-09T11:43:26Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMTo0MzoyNlrOGvNdKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMTo0NzoyOVrOGvNk4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1NjcxNQ==", "bodyText": "What exactly are we testing here?", "url": "https://github.com/trinodb/trino/pull/4401#discussion_r452156715", "createdAt": "2020-07-09T11:43:26Z", "author": {"login": "losipiuk"}, "path": "presto-memsql/src/test/java/io/prestosql/plugin/memsql/TestMemSqlIntegrationSmokeTest.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.memsql;\n+\n+import io.prestosql.testing.AbstractTestIntegrationSmokeTest;\n+import io.prestosql.testing.MaterializedResult;\n+import io.prestosql.testing.MaterializedRow;\n+import io.prestosql.testing.QueryRunner;\n+import org.intellij.lang.annotations.Language;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import static com.google.common.collect.Iterables.getOnlyElement;\n+import static io.prestosql.plugin.memsql.MemSqlQueryRunner.createMemSqlQueryRunner;\n+import static io.prestosql.spi.type.VarcharType.VARCHAR;\n+import static io.prestosql.testing.MaterializedResult.resultBuilder;\n+import static io.prestosql.testing.assertions.Assert.assertEquals;\n+import static io.prestosql.tpch.TpchTable.CUSTOMER;\n+import static io.prestosql.tpch.TpchTable.NATION;\n+import static io.prestosql.tpch.TpchTable.ORDERS;\n+import static io.prestosql.tpch.TpchTable.REGION;\n+import static java.lang.String.format;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestMemSqlIntegrationSmokeTest\n+        extends AbstractTestIntegrationSmokeTest\n+{\n+    protected TestingMemSqlServer memSqlServer;\n+\n+    @Override\n+    protected QueryRunner createQueryRunner()\n+            throws Exception\n+    {\n+        memSqlServer = new TestingMemSqlServer();\n+        return createMemSqlQueryRunner(memSqlServer, CUSTOMER, NATION, ORDERS, REGION);\n+    }\n+\n+    @AfterClass(alwaysRun = true)\n+    public final void destroy()\n+    {\n+        memSqlServer.close();\n+    }\n+\n+    @Test\n+    public void testDropTable()\n+    {\n+        assertUpdate(\"CREATE TABLE test_drop AS SELECT 123 x\", 1);\n+        assertTrue(getQueryRunner().tableExists(getSession(), \"test_drop\"));\n+\n+        assertUpdate(\"DROP TABLE test_drop\");\n+        assertFalse(getQueryRunner().tableExists(getSession(), \"test_drop\"));\n+    }\n+\n+    @Test\n+    public void testViews()\n+    {\n+        execute(\"CREATE VIEW tpch.test_view AS SELECT * FROM tpch.orders\");\n+        assertQuery(\"SELECT orderkey FROM test_view\", \"SELECT orderkey FROM orders\");\n+        execute(\"DROP VIEW IF EXISTS tpch.test_view\");\n+    }\n+\n+    @Test\n+    public void testInsert()\n+    {\n+        execute(\"CREATE TABLE tpch.test_insert (x bigint, y varchar(100))\");\n+        assertUpdate(\"INSERT INTO test_insert VALUES (123, 'test')\", 1);\n+        assertQuery(\"SELECT * FROM test_insert\", \"SELECT 123 x, 'test' y\");\n+        assertUpdate(\"DROP TABLE test_insert\");\n+    }\n+\n+    @Test\n+    public void testInsertInPresenceOfNotSupportedColumn()\n+    {\n+        execute(\"CREATE TABLE tpch.test_insert_not_supported_column_present(x bigint, y decimal(50,0), z varchar(10))\");\n+        // Check that column y is not supported.\n+        assertQuery(\"SELECT column_name FROM information_schema.columns WHERE table_name = 'test_insert_not_supported_column_present'\", \"VALUES 'x', 'z'\");\n+        assertUpdate(\"INSERT INTO test_insert_not_supported_column_present (x, z) VALUES (123, 'test')\", 1);\n+        assertQuery(\"SELECT x, z FROM test_insert_not_supported_column_present\", \"SELECT 123, 'test'\");\n+        assertUpdate(\"DROP TABLE test_insert_not_supported_column_present\");\n+    }\n+\n+    @Test\n+    public void testNameEscaping()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1ODY5MQ==", "bodyText": "just tag. Or inline in the IMAGE as memsql/cluster-in-a-box:centos..... We cannot override just tag anyway.", "url": "https://github.com/trinodb/trino/pull/4401#discussion_r452158691", "createdAt": "2020-07-09T11:47:29Z", "author": {"login": "losipiuk"}, "path": "presto-memsql/src/test/java/io/prestosql/plugin/memsql/TestingMemSqlServer.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.memsql;\n+\n+import com.google.common.collect.ImmutableSet;\n+import org.testcontainers.containers.JdbcDatabaseContainer;\n+\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.Set;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class TestingMemSqlServer\n+        extends JdbcDatabaseContainer<TestingMemSqlServer>\n+{\n+    private static final String MEM_SQL_LICENSE = requireNonNull(System.getProperty(\"memsql.license\"), \"memsql.license is not set\");\n+\n+    public static final String IMAGE = \"memsql/cluster-in-a-box\";\n+    public static final String DEFAULT_TAG = \"centos-7.1.4-516dfe4088-1.9.6-1.6.1\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1ODQ3NTIz", "url": "https://github.com/trinodb/trino/pull/4401#pullrequestreview-445847523", "createdAt": "2020-07-09T18:01:14Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxODowMToxNFrOGvcBbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxODowMToxNFrOGvcBbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5NTM3Mg==", "bodyText": "Move this to be after phoenix. This list should be in the same order as the one below.", "url": "https://github.com/trinodb/trino/pull/4401#discussion_r452395372", "createdAt": "2020-07-09T18:01:14Z", "author": {"login": "electrum"}, "path": ".github/workflows/ci.yml", "diffHunk": "@@ -135,7 +135,7 @@ jobs:\n             !presto-hive,!presto-orc,!presto-parquet,\n             !presto-mongodb,!presto-kafka,!presto-elasticsearch,\n             !presto-redis,\n-            !presto-sqlserver,!presto-postgresql,!presto-mysql,\n+            !presto-sqlserver,!presto-postgresql,!presto-mysql,!presto-memsql,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1ODQ4MDg5", "url": "https://github.com/trinodb/trino/pull/4401#pullrequestreview-445848089", "createdAt": "2020-07-09T18:02:00Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxODowMjowMFrOGvcDNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxODowMjowMFrOGvcDNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5NTgzMA==", "bodyText": "This needs to be conditional, otherwise the tests will fail for PRs or forks when the secret is not available.", "url": "https://github.com/trinodb/trino/pull/4401#discussion_r452395830", "createdAt": "2020-07-09T18:02:00Z", "author": {"login": "electrum"}, "path": ".github/workflows/ci.yml", "diffHunk": "@@ -161,6 +161,7 @@ jobs:\n           - \"presto-oracle\"\n           - \"presto-kudu\"\n           - \"presto-phoenix,presto-iceberg,presto-druid\"\n+          - \"presto-memsql -Dmemsql.license=${{ secrets.MemSqlLicense }}", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "b56213f31c787523c78d6dea8dabffda4b5b3273", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/b56213f31c787523c78d6dea8dabffda4b5b3273", "committedDate": "2020-07-10T12:15:59Z", "message": "Add memsql integration smoke tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NTY0OTAy", "url": "https://github.com/trinodb/trino/pull/4401#pullrequestreview-446564902", "createdAt": "2020-07-10T17:12:47Z", "commit": {"oid": "b56213f31c787523c78d6dea8dabffda4b5b3273"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzoxMjo0N1rOGv_Ekg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzoxMjo0N1rOGv_Ekg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2OTYxOA==", "bodyText": "This last one is special and should stay last", "url": "https://github.com/trinodb/trino/pull/4401#discussion_r452969618", "createdAt": "2020-07-10T17:12:47Z", "author": {"login": "electrum"}, "path": ".github/workflows/ci.yml", "diffHunk": "@@ -139,7 +139,8 @@ jobs:\n             !presto-oracle,\n             !presto-kudu,\n             !presto-phoenix,!presto-iceberg,!presto-druid,\n-            !presto-docs,!presto-server,!presto-server-rpm'\n+            !presto-docs,!presto-server,!presto-server-rpm',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b56213f31c787523c78d6dea8dabffda4b5b3273"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NTY1MDUy", "url": "https://github.com/trinodb/trino/pull/4401#pullrequestreview-446565052", "createdAt": "2020-07-10T17:13:03Z", "commit": {"oid": "b56213f31c787523c78d6dea8dabffda4b5b3273"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzoxMzowM1rOGv_FBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzoxMzowM1rOGv_FBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2OTczMw==", "bodyText": "This should just be -pl presto-memsql", "url": "https://github.com/trinodb/trino/pull/4401#discussion_r452969733", "createdAt": "2020-07-10T17:13:03Z", "author": {"login": "electrum"}, "path": ".github/workflows/ci.yml", "diffHunk": "@@ -173,6 +174,27 @@ jobs:\n       - name: Maven Tests\n         run: ./mvnw test -B -fae -Dair.check.skip-all -pl ${{ matrix.modules }}\n \n+  test-memsql:\n+    runs-on: ubuntu-latest\n+    strategy:\n+      fail-fast: false\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: actions/setup-java@v1\n+        with:\n+          java-version: 11\n+      - name: Maven Install\n+        run: |\n+          export MAVEN_OPTS=\"${MAVEN_INSTALL_OPTS}\"\n+          ./bin/retry ./mvnw install ${MAVEN_FAST_INSTALL} -am -pl $(echo '${{ matrix.modules }}' | cut -d' ' -f1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b56213f31c787523c78d6dea8dabffda4b5b3273"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b56213f31c787523c78d6dea8dabffda4b5b3273", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/b56213f31c787523c78d6dea8dabffda4b5b3273", "committedDate": "2020-07-10T12:15:59Z", "message": "Add memsql integration smoke tests"}, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "a3c2221df27604bca0a72881b0a90a3680ce12cb", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/a3c2221df27604bca0a72881b0a90a3680ce12cb", "committedDate": "2020-07-10T19:54:55Z", "message": "Add memsql integration smoke tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3c2221df27604bca0a72881b0a90a3680ce12cb", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/a3c2221df27604bca0a72881b0a90a3680ce12cb", "committedDate": "2020-07-10T19:54:55Z", "message": "Add memsql integration smoke tests"}, "afterCommit": {"oid": "c5f7819187fb0df21cff702c57fd322472891edf", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/c5f7819187fb0df21cff702c57fd322472891edf", "committedDate": "2020-08-20T12:36:17Z", "message": "Add memsql integration smoke tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTk1NTAw", "url": "https://github.com/trinodb/trino/pull/4401#pullrequestreview-471995500", "createdAt": "2020-08-20T21:22:35Z", "commit": {"oid": "c5f7819187fb0df21cff702c57fd322472891edf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0606095f811effef3c4e8b0c39c4da7fccba16e", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/d0606095f811effef3c4e8b0c39c4da7fccba16e", "committedDate": "2020-08-21T10:03:46Z", "message": "Add memsql integration smoke tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c5f7819187fb0df21cff702c57fd322472891edf", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/c5f7819187fb0df21cff702c57fd322472891edf", "committedDate": "2020-08-20T12:36:17Z", "message": "Add memsql integration smoke tests"}, "afterCommit": {"oid": "d0606095f811effef3c4e8b0c39c4da7fccba16e", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/d0606095f811effef3c4e8b0c39c4da7fccba16e", "committedDate": "2020-08-21T10:03:46Z", "message": "Add memsql integration smoke tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 40, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}