{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNTY5NzQ1", "number": 5557, "title": "Improve AesSpillCipher performance and reduce internal allocations", "bodyText": "The JDK Cipher implementation for AES leveraged by the AesSpillCipher behaves differently when doFinal is called than it does inside of the update method. Notably, a single doFinal compared to an update + doFinal will:\n\nTake much longer for the AES hardware accelerated intrinsics to be used since the 10,000 invocation threshold for C2 compilation will require 10,000 SpillCipher calls\nAllocate a buffer larger than the output length in a attempt to strip out the padding, ultimately doubling the memory usage\n\nPerformance benchmarks run with the BenchmarkPagesSerde from #5545 shows a massive allocation rate decrease (even compared to that PR which reduces the rate significantly itself) and a ~40% improvement in deserialization throughput.\nBenchmark Comparison to prestosql#5545", "createdAt": "2020-10-14T18:45:40Z", "url": "https://github.com/trinodb/trino/pull/5557", "merged": true, "mergeCommit": {"oid": "616d1880ea247ebd720cca6ad8eb10ac1c822f40"}, "closed": true, "closedAt": "2020-10-15T17:33:11Z", "author": {"login": "pettyjamesm"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdStxe_gFqTUwOTE1NDI1MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSxYNmABqjM4ODE0MTk3MTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MTU0MjUx", "url": "https://github.com/trinodb/trino/pull/5557#pullrequestreview-509154251", "createdAt": "2020-10-15T08:47:39Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwODo0NzozOVrOHh8mzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwODo0NzozOVrOHh8mzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM1ODAzMQ==", "bodyText": "The gist of the information from the commit message should be also captured as a code comment.\notherwise it's too easy for someone to roll this back into single doFinal in a remove \"redundant update call\" cleanup commit.", "url": "https://github.com/trinodb/trino/pull/5557#discussion_r505358031", "createdAt": "2020-10-15T08:47:39Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/spiller/AesSpillCipher.java", "diffHunk": "@@ -69,7 +69,8 @@ public int encrypt(byte[] data, int inputOffset, int length, byte[] destination,\n         Cipher cipher = createEncryptCipher(key);\n         System.arraycopy(cipher.getIV(), 0, destination, destinationOffset, ivBytes);\n         try {\n-            return ivBytes + cipher.doFinal(data, inputOffset, length, destination, destinationOffset + ivBytes);\n+            int n = cipher.update(data, inputOffset, length, destination, destinationOffset + ivBytes);\n+            return ivBytes + n + cipher.doFinal(destination, destinationOffset + ivBytes + n);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caf4a438860cce5fa3f539df8e2e01b86333669d", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/caf4a438860cce5fa3f539df8e2e01b86333669d", "committedDate": "2020-10-15T12:59:25Z", "message": "Improve AesSpillCipher performance and reduce internal allocations\n\nThe JDK Cipher implementation for AES leveraged by the AesSpillCipher\nbehaves differently when doFinal is called than it does inside of the\nupdate method. Notably, a single doFinal compared to an update + doFinal\nwill:\n- Take much longer for the AES hardware accelerated intrinsics to be used\nsince the 10,000 invocation threshold for C2 compilation will require 10,000\nSpillCipher calls\n- Allocate a buffer larger than the output length in a attempt to strip out\nthe padding, ultimately doubling the memory usage"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "caf4a438860cce5fa3f539df8e2e01b86333669d", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/caf4a438860cce5fa3f539df8e2e01b86333669d", "committedDate": "2020-10-15T12:59:25Z", "message": "Improve AesSpillCipher performance and reduce internal allocations\n\nThe JDK Cipher implementation for AES leveraged by the AesSpillCipher\nbehaves differently when doFinal is called than it does inside of the\nupdate method. Notably, a single doFinal compared to an update + doFinal\nwill:\n- Take much longer for the AES hardware accelerated intrinsics to be used\nsince the 10,000 invocation threshold for C2 compilation will require 10,000\nSpillCipher calls\n- Allocate a buffer larger than the output length in a attempt to strip out\nthe padding, ultimately doubling the memory usage"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3462, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}