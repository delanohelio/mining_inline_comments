{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2NTM0MzA1", "number": 4080, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzozMTo0OVrOEG2PLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMjoxMjozNlrOEIJu8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NjE1NTMzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/StringFunctions.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzozMTo0OVrOGl5Y8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzo0MjowNlrOGl5uaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MDc2OA==", "bodyText": "This could use checkCondition from Failures. We can also rephrase the error message a bit:\ncheckCondition(originalsCodePoints.length == translationsLength, INVALID_FUNCTION_ARGUMENT, \"Translate originals and translations must be the same length\");", "url": "https://github.com/trinodb/trino/pull/4080#discussion_r442390768", "createdAt": "2020-06-18T17:31:49Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/operator/scalar/StringFunctions.java", "diffHunk": "@@ -911,4 +913,42 @@ public static boolean startsWith(@SqlType(\"varchar(x)\") Slice source, @SqlType(\"\n         }\n         return source.compareTo(0, prefix.length(), prefix, 0, prefix.length()) == 0;\n     }\n+\n+    @Description(\"Translate characters from the source string based on original and translations strings\")\n+    @ScalarFunction\n+    @LiteralParameters({\"x\", \"y\", \"z\"})\n+    @SqlType(StandardTypes.VARCHAR)\n+    public static Slice translate(@SqlType(\"varchar(x)\") Slice source, @SqlType(\"varchar(y)\") Slice originals, @SqlType(\"varchar(z)\") Slice translations)\n+    {\n+        int[] translationsCodePoints = castToCodePoints(translations);\n+        int translationsLength = translationsCodePoints.length;\n+        int[] originalsCodePoints = castToCodePoints(originals);\n+        if (originalsCodePoints.length != translationsLength) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NjI2NA==", "bodyText": "You mentioned that previously but I spaced - - thanks; added.", "url": "https://github.com/trinodb/trino/pull/4080#discussion_r442396264", "createdAt": "2020-06-18T17:42:06Z", "author": {"login": "djsstarburst"}, "path": "presto-main/src/main/java/io/prestosql/operator/scalar/StringFunctions.java", "diffHunk": "@@ -911,4 +913,42 @@ public static boolean startsWith(@SqlType(\"varchar(x)\") Slice source, @SqlType(\"\n         }\n         return source.compareTo(0, prefix.length(), prefix, 0, prefix.length()) == 0;\n     }\n+\n+    @Description(\"Translate characters from the source string based on original and translations strings\")\n+    @ScalarFunction\n+    @LiteralParameters({\"x\", \"y\", \"z\"})\n+    @SqlType(StandardTypes.VARCHAR)\n+    public static Slice translate(@SqlType(\"varchar(x)\") Slice source, @SqlType(\"varchar(y)\") Slice originals, @SqlType(\"varchar(z)\") Slice translations)\n+    {\n+        int[] translationsCodePoints = castToCodePoints(translations);\n+        int translationsLength = translationsCodePoints.length;\n+        int[] originalsCodePoints = castToCodePoints(originals);\n+        if (originalsCodePoints.length != translationsLength) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MDc2OA=="}, "originalCommit": null, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NjE1NzczOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/StringFunctions.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzozMjozN1rOGl5aiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzo0MTo0MVrOGl5tkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MTE3Ng==", "bodyText": "I think this can simplify to\nint translatedCodePoint = map.getOrDefault(codePoint, codePoint);", "url": "https://github.com/trinodb/trino/pull/4080#discussion_r442391176", "createdAt": "2020-06-18T17:32:37Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/operator/scalar/StringFunctions.java", "diffHunk": "@@ -911,4 +913,42 @@ public static boolean startsWith(@SqlType(\"varchar(x)\") Slice source, @SqlType(\"\n         }\n         return source.compareTo(0, prefix.length(), prefix, 0, prefix.length()) == 0;\n     }\n+\n+    @Description(\"Translate characters from the source string based on original and translations strings\")\n+    @ScalarFunction\n+    @LiteralParameters({\"x\", \"y\", \"z\"})\n+    @SqlType(StandardTypes.VARCHAR)\n+    public static Slice translate(@SqlType(\"varchar(x)\") Slice source, @SqlType(\"varchar(y)\") Slice originals, @SqlType(\"varchar(z)\") Slice translations)\n+    {\n+        int[] translationsCodePoints = castToCodePoints(translations);\n+        int translationsLength = translationsCodePoints.length;\n+        int[] originalsCodePoints = castToCodePoints(originals);\n+        if (originalsCodePoints.length != translationsLength) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"The length of the translate originals is not equal to the length of the translations\");\n+        }\n+\n+        Int2IntOpenHashMap map = new Int2IntOpenHashMap(translationsLength);\n+        for (int index = 0; index < translationsLength; index++) {\n+            map.put(originalsCodePoints[index], translationsCodePoints[index]);\n+        }\n+        int[] sourceCodePoints = castToCodePoints(source);\n+        int sourceLength = sourceCodePoints.length;\n+        int[] targetCodePoints = new int[sourceLength];\n+        int targetLength = 0;\n+        for (int index = 0; index < sourceLength; index++) {\n+            int codePoint = sourceCodePoints[index];\n+            int value = map.getOrDefault(codePoint, -1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NjA0OQ==", "bodyText": "Good point; thanks!", "url": "https://github.com/trinodb/trino/pull/4080#discussion_r442396049", "createdAt": "2020-06-18T17:41:41Z", "author": {"login": "djsstarburst"}, "path": "presto-main/src/main/java/io/prestosql/operator/scalar/StringFunctions.java", "diffHunk": "@@ -911,4 +913,42 @@ public static boolean startsWith(@SqlType(\"varchar(x)\") Slice source, @SqlType(\"\n         }\n         return source.compareTo(0, prefix.length(), prefix, 0, prefix.length()) == 0;\n     }\n+\n+    @Description(\"Translate characters from the source string based on original and translations strings\")\n+    @ScalarFunction\n+    @LiteralParameters({\"x\", \"y\", \"z\"})\n+    @SqlType(StandardTypes.VARCHAR)\n+    public static Slice translate(@SqlType(\"varchar(x)\") Slice source, @SqlType(\"varchar(y)\") Slice originals, @SqlType(\"varchar(z)\") Slice translations)\n+    {\n+        int[] translationsCodePoints = castToCodePoints(translations);\n+        int translationsLength = translationsCodePoints.length;\n+        int[] originalsCodePoints = castToCodePoints(originals);\n+        if (originalsCodePoints.length != translationsLength) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"The length of the translate originals is not equal to the length of the translations\");\n+        }\n+\n+        Int2IntOpenHashMap map = new Int2IntOpenHashMap(translationsLength);\n+        for (int index = 0; index < translationsLength; index++) {\n+            map.put(originalsCodePoints[index], translationsCodePoints[index]);\n+        }\n+        int[] sourceCodePoints = castToCodePoints(source);\n+        int sourceLength = sourceCodePoints.length;\n+        int[] targetCodePoints = new int[sourceLength];\n+        int targetLength = 0;\n+        for (int index = 0; index < sourceLength; index++) {\n+            int codePoint = sourceCodePoints[index];\n+            int value = map.getOrDefault(codePoint, -1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MTE3Ng=="}, "originalCommit": null, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NjE2MDk4OnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/operator/scalar/TestStringFunctions.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzozMzoyOVrOGl5clw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzo1MTozOVrOGl6DJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MTcwMw==", "bodyText": "Does this not work? This seems like a good test case to have, either working or as an explicitly disallowed input.", "url": "https://github.com/trinodb/trino/pull/4080#discussion_r442391703", "createdAt": "2020-06-18T17:33:29Z", "author": {"login": "electrum"}, "path": "presto-main/src/test/java/io/prestosql/operator/scalar/TestStringFunctions.java", "diffHunk": "@@ -1046,4 +1046,27 @@ public void testCharConcat()\n \n         assertFunction(\"concat(cast(null as char(1)), cast(' ' as char(1)))\", createCharType(2), null);\n     }\n+\n+    @Test\n+    public void testTranslate()\n+    {\n+        //assertFunction(\"translate('abcd', '', '')\", VARCHAR, \"abcd\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQwMTU3NQ==", "bodyText": "No, accidentally left commented out.  Fixed.", "url": "https://github.com/trinodb/trino/pull/4080#discussion_r442401575", "createdAt": "2020-06-18T17:51:39Z", "author": {"login": "djsstarburst"}, "path": "presto-main/src/test/java/io/prestosql/operator/scalar/TestStringFunctions.java", "diffHunk": "@@ -1046,4 +1046,27 @@ public void testCharConcat()\n \n         assertFunction(\"concat(cast(null as char(1)), cast(' ' as char(1)))\", createCharType(2), null);\n     }\n+\n+    @Test\n+    public void testTranslate()\n+    {\n+        //assertFunction(\"translate('abcd', '', '')\", VARCHAR, \"abcd\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MTcwMw=="}, "originalCommit": null, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTgwMzYzOnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/functions/string.rst", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMTo1ODo0NFrOGn8G0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMTo1ODo0NFrOGn8G0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUzMjQzMw==", "bodyText": "Please write these as full select queries that can be copy/pasted by the user:\nSELECT translate('abcd', '', ''); -- 'abcd'\nSo add SELECT and semicolon.", "url": "https://github.com/trinodb/trino/pull/4080#discussion_r444532433", "createdAt": "2020-06-23T21:58:44Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/functions/string.rst", "diffHunk": "@@ -168,6 +168,28 @@ String Functions\n     position ``start``. Positions start with ``1``. A negative starting\n     position is interpreted as being relative to the end of the string.\n \n+.. function:: translate(source, from, to) -> varchar\n+\n+   Returns the ``source`` string translated by replacing characters found in the\n+   ``from`` string with the corresponding characters in the ``to`` string.  If the ``from``\n+   string contains duplicates, only the first is used.  If the ``source`` character\n+   does not exist in the ``from`` string, the ``source`` character will be copied\n+   without translation.  If the index of the matching character in the ``from``\n+   string is beyond the length of the ``to`` string, the ``source`` character will\n+   be omitted from the resulting string.\n+\n+   Here are some examples illustrating the translate function::\n+\n+       translate('abcd', '', '') -- 'abcd'", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTgzNTM5OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/functions/string.rst", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMjoxMjozNlrOGn8bEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMjoxMjozNlrOGn8bEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUzNzYxNg==", "bodyText": "This \\u is actually a Java escape and not valid in SQL (it works in the test because it's translated by the Java compiler, so it's effectively a literal character in the SQL)\nWe can write this using the SQL U& syntax as documented here: https://prestosql.io/docs/current/language/types.html#string\nFor the output, we can paste the literal in directly.\nSELECT translate('abcd', 'b', U&'\\+01F600'); -- a\ud83d\ude00cd", "url": "https://github.com/trinodb/trino/pull/4080#discussion_r444537616", "createdAt": "2020-06-23T22:12:36Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/functions/string.rst", "diffHunk": "@@ -168,6 +168,28 @@ String Functions\n     position ``start``. Positions start with ``1``. A negative starting\n     position is interpreted as being relative to the end of the string.\n \n+.. function:: translate(source, from, to) -> varchar\n+\n+   Returns the ``source`` string translated by replacing characters found in the\n+   ``from`` string with the corresponding characters in the ``to`` string.  If the ``from``\n+   string contains duplicates, only the first is used.  If the ``source`` character\n+   does not exist in the ``from`` string, the ``source`` character will be copied\n+   without translation.  If the index of the matching character in the ``from``\n+   string is beyond the length of the ``to`` string, the ``source`` character will\n+   be omitted from the resulting string.\n+\n+   Here are some examples illustrating the translate function::\n+\n+       translate('abcd', '', '') -- 'abcd'\n+       translate('abcd', 'a', 'z') -- 'zbcd'\n+       translate('abcda', 'a', 'z') -- 'zbcdz'\n+       translate('Palho\u00e7a', '\u00e7','c') -- 'Palhoca'\n+       translate('abcd', 'b', '\\uD840\\uDC00') -- 'a\\uD840\\uDC00cd'", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4114, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}