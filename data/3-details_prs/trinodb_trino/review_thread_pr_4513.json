{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0NDE4MTYz", "number": 4513, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMjowMzoxNVrOEQl17A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMjowODozOVrOEQl82w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1ODMyNjg0OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMjowMzoxNVrOG00yRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMjoxNzo1NlrOG01QPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA0Mzk3NQ==", "bodyText": "Move the comment below, or restructure like this:\nboolean splittable = true;\nif (s3SelectPushdownEnabled) {\n    // S3 Select pushdown works at the granularity of individual S3 objects\n    splittable = false;\n}\nif (getFooterCount(schema) != 0 || (getHeaderCount(schema) != 0 && getHeaderCount(schema) != 1)) {\n    // Files with skip.header.line.count/skip.foter.line.count are not splittable, except for skip.header.line.count = 1\n    // In that case, second split will not try to process header line as data anyway.\n    splittable = false;\n}", "url": "https://github.com/trinodb/trino/pull/4513#discussion_r458043975", "createdAt": "2020-07-21T12:03:15Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -490,7 +490,7 @@ private void invokeNoMoreSplitsIfNecessary()\n \n         // S3 Select pushdown works at the granularity of individual S3 objects,\n         // therefore we must not split files when it is enabled.\n-        boolean splittable = getHeaderCount(schema) == 0 && getFooterCount(schema) == 0 && !s3SelectPushdownEnabled;\n+        boolean splittable = !s3SelectPushdownEnabled && getFooterCount(schema) == 0 && getHeaderCount(schema) <= 1; // single header line files are still splittable", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA0NTAwNA==", "bodyText": "Update io.prestosql.plugin.hive.TestBackgroundHiveSplitLoader#testCsv", "url": "https://github.com/trinodb/trino/pull/4513#discussion_r458045004", "createdAt": "2020-07-21T12:05:22Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -490,7 +490,7 @@ private void invokeNoMoreSplitsIfNecessary()\n \n         // S3 Select pushdown works at the granularity of individual S3 objects,\n         // therefore we must not split files when it is enabled.\n-        boolean splittable = getHeaderCount(schema) == 0 && getFooterCount(schema) == 0 && !s3SelectPushdownEnabled;\n+        boolean splittable = !s3SelectPushdownEnabled && getFooterCount(schema) == 0 && getHeaderCount(schema) <= 1; // single header line files are still splittable", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA0Mzk3NQ=="}, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA1MTY0Nw==", "bodyText": "Good catch, thanks.", "url": "https://github.com/trinodb/trino/pull/4513#discussion_r458051647", "createdAt": "2020-07-21T12:17:56Z", "author": {"login": "pettyjamesm"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -490,7 +490,7 @@ private void invokeNoMoreSplitsIfNecessary()\n \n         // S3 Select pushdown works at the granularity of individual S3 objects,\n         // therefore we must not split files when it is enabled.\n-        boolean splittable = getHeaderCount(schema) == 0 && getFooterCount(schema) == 0 && !s3SelectPushdownEnabled;\n+        boolean splittable = !s3SelectPushdownEnabled && getFooterCount(schema) == 0 && getHeaderCount(schema) <= 1; // single header line files are still splittable", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA0Mzk3NQ=="}, "originalCommit": null, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1ODMyOTYzOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveUtil.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMjowNDoxNlrOG000Dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMjo0Mzo0NFrOG02ItA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA0NDQzMA==", "bodyText": "When headerCount > 1 then verify(start == 0 would be appropriate.", "url": "https://github.com/trinodb/trino/pull/4513#discussion_r458044430", "createdAt": "2020-07-21T12:04:16Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveUtil.java", "diffHunk": "@@ -256,7 +256,8 @@ private HiveUtil()\n             RecordReader<WritableComparable, Writable> recordReader = (RecordReader<WritableComparable, Writable>) inputFormat.getRecordReader(fileSplit, jobConf, Reporter.NULL);\n \n             int headerCount = getHeaderCount(schema);\n-            if (headerCount > 0) {\n+            //  Files with only a single header row are considered splittable and should only skip the first record on the first split\n+            if ((start == 0 && headerCount == 1) || headerCount > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA1MTU2OA==", "bodyText": "Giving this some thought, I think maybe a better formulation is:\nif (start == 0 && headerCount > 0) {\n\nBasically decoupling the knowledge of the special case from the handling here and saying that only splits at the beginning of the file will be considered for header skipping and it's up to the split generator to know when it's safe or not safe to split the file. Thoughts?", "url": "https://github.com/trinodb/trino/pull/4513#discussion_r458051568", "createdAt": "2020-07-21T12:17:45Z", "author": {"login": "pettyjamesm"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveUtil.java", "diffHunk": "@@ -256,7 +256,8 @@ private HiveUtil()\n             RecordReader<WritableComparable, Writable> recordReader = (RecordReader<WritableComparable, Writable>) inputFormat.getRecordReader(fileSplit, jobConf, Reporter.NULL);\n \n             int headerCount = getHeaderCount(schema);\n-            if (headerCount > 0) {\n+            //  Files with only a single header row are considered splittable and should only skip the first record on the first split\n+            if ((start == 0 && headerCount == 1) || headerCount > 1) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA0NDQzMA=="}, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2NjEwMA==", "bodyText": "Sounds good to me.", "url": "https://github.com/trinodb/trino/pull/4513#discussion_r458066100", "createdAt": "2020-07-21T12:43:44Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveUtil.java", "diffHunk": "@@ -256,7 +256,8 @@ private HiveUtil()\n             RecordReader<WritableComparable, Writable> recordReader = (RecordReader<WritableComparable, Writable>) inputFormat.getRecordReader(fileSplit, jobConf, Reporter.NULL);\n \n             int headerCount = getHeaderCount(schema);\n-            if (headerCount > 0) {\n+            //  Files with only a single header row are considered splittable and should only skip the first record on the first split\n+            if ((start == 0 && headerCount == 1) || headerCount > 1) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA0NDQzMA=="}, "originalCommit": null, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1ODM0NDU5OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveSplitSource.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMjowODozOVrOG009Ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMjowODozOVrOG009Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA0Njc3NA==", "bodyText": "I guess you can avoid adding an overload, if you define 100 bytes as the const\nand use that in test code. This way test code is slightly more complicated (bad),\nbut common code remains simpler.", "url": "https://github.com/trinodb/trino/pull/4513#discussion_r458046774", "createdAt": "2020-07-21T12:08:39Z", "author": {"login": "findepi"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveSplitSource.java", "diffHunk": "@@ -286,17 +315,22 @@ private TestSplit(int id)\n         }\n \n         private TestSplit(int id, OptionalInt bucketNumber)\n+        {\n+            this(id, bucketNumber, DataSize.ofBytes(100));\n+        }\n+\n+        private TestSplit(int id, OptionalInt bucketNumber, DataSize fileSize)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3695, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}