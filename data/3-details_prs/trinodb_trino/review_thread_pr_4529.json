{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0NzM1OTg5", "number": 4529, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMjowNTowN1rOEQ3HSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMjoxMDowNVrOEQ3Kgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MTE1NjU4OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/StatementAnalyzer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMjowNTowN1rOG1QC3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMjowNTowN1rOG1QC3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5MDU5MQ==", "bodyText": "TYPE_MISMATCH is not an appropriate code for this error. Let's go with INVALID_ARGUMENTS", "url": "https://github.com/trinodb/trino/pull/4529#discussion_r458490591", "createdAt": "2020-07-22T02:05:07Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/StatementAnalyzer.java", "diffHunk": "@@ -2706,24 +2709,47 @@ private boolean analyzeLimit(FetchFirst node)\n             return node.isWithTies();\n         }\n \n-        private boolean analyzeLimit(Limit node)\n+        private boolean analyzeLimit(Limit node, Scope scope)\n         {\n-            if (node.getLimit().equalsIgnoreCase(\"all\")) {\n-                analysis.setLimit(node, OptionalLong.empty());\n+            OptionalLong rowCount;\n+            if (node.getRowCount() instanceof AllRows) {\n+                rowCount = OptionalLong.empty();\n+            }\n+            else if (node.getRowCount() instanceof LongLiteral) {\n+                rowCount = OptionalLong.of(((LongLiteral) node.getRowCount()).getValue());\n             }\n             else {\n-                long rowCount;\n-                try {\n-                    rowCount = Long.parseLong(node.getLimit());\n+                checkState(node.getRowCount() instanceof Parameter, \"unexpected LIMIT rowCount: \" + node.getRowCount().getClass().getSimpleName());\n+                if (analysis.isDescribe()) {\n+                    analyzeExpression(node.getRowCount(), scope);\n+                    analysis.addCoercion(node.getRowCount(), BIGINT, false);\n+                    rowCount = OptionalLong.empty();\n                 }\n-                catch (NumberFormatException e) {\n-                    throw semanticException(TYPE_MISMATCH, node, \"Invalid LIMIT row count: %s\", node.getLimit());\n-                }\n-                if (rowCount < 0) {\n-                    throw semanticException(NUMERIC_VALUE_OUT_OF_RANGE, node, \"LIMIT row count must be greater or equal to 0 (actual value: %s)\", rowCount);\n+                else {\n+                    // validate parameter index\n+                    analyzeExpression(node.getRowCount(), scope);\n+                    Expression providedValue = analysis.getParameters().get(NodeRef.of(node.getRowCount()));\n+                    try {\n+                        rowCount = OptionalLong.of((long) ExpressionInterpreter.evaluateConstantExpression(\n+                                providedValue,\n+                                BIGINT,\n+                                metadata,\n+                                session,\n+                                accessControl,\n+                                analysis.getParameters()));\n+                    }\n+                    catch (VerifyException e) {\n+                        throw semanticException(TYPE_MISMATCH, node, \"Non constant parameter value for LIMIT: %s\", providedValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MTE1NzM5OnYy", "diffSide": "LEFT", "path": "presto-main/src/test/java/io/prestosql/sql/analyzer/TestAnalyzer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMjowNTozMlrOG1QDUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNjo0Njo0MVrOG1U6jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5MDcwNQ==", "bodyText": "What happened to this case?", "url": "https://github.com/trinodb/trino/pull/4529#discussion_r458490705", "createdAt": "2020-07-22T02:05:32Z", "author": {"login": "martint"}, "path": "presto-main/src/test/java/io/prestosql/sql/analyzer/TestAnalyzer.java", "diffHunk": "@@ -513,13 +513,6 @@ public void testFetchFirstWithTiesMissingOrderBy()\n                 .hasErrorCode(MISSING_ORDER_BY);\n     }\n \n-    @Test\n-    public void testLimitInvalidRowCount()\n-    {\n-        assertFails(\"SELECT * FROM t1 LIMIT 987654321098765432109876543210\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU3MDM4MQ==", "bodyText": "It doesn't throw PrestoException any more.\nThe row count used to be fetched as text and analysed in the StatementAnalyzer. After this change, a LongLiteral is instantiated in AstBuilder, and ParsingException is thrown.\nSimilarly, negative values now fail in Parser.", "url": "https://github.com/trinodb/trino/pull/4529#discussion_r458570381", "createdAt": "2020-07-22T06:46:41Z", "author": {"login": "kasiafi"}, "path": "presto-main/src/test/java/io/prestosql/sql/analyzer/TestAnalyzer.java", "diffHunk": "@@ -513,13 +513,6 @@ public void testFetchFirstWithTiesMissingOrderBy()\n                 .hasErrorCode(MISSING_ORDER_BY);\n     }\n \n-    @Test\n-    public void testLimitInvalidRowCount()\n-    {\n-        assertFails(\"SELECT * FROM t1 LIMIT 987654321098765432109876543210\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5MDcwNQ=="}, "originalCommit": null, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MTE2NDgyOnYy", "diffSide": "RIGHT", "path": "presto-parser/src/main/antlr4/io/prestosql/sql/parser/SqlBase.g4", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMjoxMDowNVrOG1QH0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMjoxMDowNVrOG1QH0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5MTg1Nw==", "bodyText": "We should do the same for FETCH FIRST and OFFSET, but this can be addressed in a separate PR", "url": "https://github.com/trinodb/trino/pull/4529#discussion_r458491857", "createdAt": "2020-07-22T02:10:05Z", "author": {"login": "martint"}, "path": "presto-parser/src/main/antlr4/io/prestosql/sql/parser/SqlBase.g4", "diffHunk": "@@ -164,8 +164,14 @@ queryNoWith:\n       queryTerm\n       (ORDER BY sortItem (',' sortItem)*)?\n       (OFFSET offset=INTEGER_VALUE (ROW | ROWS)?)?\n-      ((LIMIT limit=(INTEGER_VALUE | ALL)) | (FETCH (FIRST | NEXT) (fetchFirst=INTEGER_VALUE)? (ROW | ROWS) (ONLY | WITH TIES)))?\n-    ;\n+      ((LIMIT limitRowCount) | (FETCH (FIRST | NEXT) (fetchFirst=INTEGER_VALUE)? (ROW | ROWS) (ONLY | WITH TIES)))?", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3701, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}