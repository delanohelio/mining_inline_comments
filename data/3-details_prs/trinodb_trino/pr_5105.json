{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyMjc3OTg3", "number": 5105, "title": "Add support for precision for TIMESTAMP W/TZ in Postgresql type mapping", "bodyText": "", "createdAt": "2020-09-08T20:27:17Z", "url": "https://github.com/trinodb/trino/pull/5105", "merged": true, "mergeCommit": {"oid": "5671a6ef7914cff788acce806c5858e67c3fd99e"}, "closed": true, "closedAt": "2020-09-09T18:23:38Z", "author": {"login": "losipiuk"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdG6QJtgH2gAyNDgyMjc3OTg3OjYxYzdiMzZhZmU3NzZiNjRkMGMzOTcyYjA5ZmIzNzg0YTY0YjRiNzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHMo3SABqjM3NDU5OTgwODg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "61c7b36afe776b64d0c3972b09fb3784a64b4b73", "author": {"user": {"login": "losipiuk", "name": "\u0141ukasz Osipiuk"}}, "url": "https://github.com/trinodb/trino/commit/61c7b36afe776b64d0c3972b09fb3784a64b4b73", "committedDate": "2020-09-08T16:32:55Z", "message": "Extract method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NzcxNjU1", "url": "https://github.com/trinodb/trino/pull/5105#pullrequestreview-484771655", "createdAt": "2020-09-09T08:22:24Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwODoyMjoyNFrOHO8LIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwODo1ODo1N1rOHO9q-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyODAwMw==", "bodyText": "Postgres currently supports p <=6 (according to docs), so we do not have behavioral regression here.\nWorth mentioning in the commit message that we are leveraging this fact.", "url": "https://github.com/trinodb/trino/pull/5105#discussion_r485428003", "createdAt": "2020-09-09T08:22:24Z", "author": {"login": "findepi"}, "path": "presto-postgresql/src/main/java/io/prestosql/plugin/postgresql/PostgreSqlClient.java", "diffHunk": "@@ -434,8 +442,15 @@ public WriteMapping toWriteMapping(ConnectorSession session, Type type)\n         if (TIMESTAMP_MILLIS.equals(type)) {\n             return WriteMapping.longMapping(\"timestamp\", timestampWriteFunction());\n         }\n-        if (TIMESTAMP_WITH_TIME_ZONE.equals(type)) {\n-            return WriteMapping.longMapping(\"timestamptz\", timestampWithTimeZoneWriteFunction());\n+        if (type instanceof TimestampWithTimeZoneType && ((TimestampWithTimeZoneType) type).getPrecision() <= 6) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyODUzNA==", "bodyText": "Add\n// PostgreSQL currently supports precision up to microseconds\n\nto argument that throwing is actually OK think to do", "url": "https://github.com/trinodb/trino/pull/5105#discussion_r485428534", "createdAt": "2020-09-09T08:23:13Z", "author": {"login": "findepi"}, "path": "presto-postgresql/src/main/java/io/prestosql/plugin/postgresql/PostgreSqlClient.java", "diffHunk": "@@ -489,15 +504,25 @@ private static LongWriteFunction timestampWriteFunction()\n         };\n     }\n \n-    private static ColumnMapping timestampWithTimeZoneColumnMapping()\n+    private static ColumnMapping timestampWithTimeZoneColumnMapping(int precision)\n     {\n-        return ColumnMapping.longMapping(\n-                TIMESTAMP_WITH_TIME_ZONE,\n-                timeStampWithTimeZoneReadFunction(),\n-                timestampWithTimeZoneWriteFunction());\n+        checkArgument(precision <= 6, \"unsupported precision value\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ0ODgxNw==", "bodyText": "MICROSECONDS_PER_MILLISECOND -> MILLISECONDS_PER_SECOND\n@martint is the % and / right here? or floorDiv instead?\ndo we have helper methods somewhere so that we do not have to ask the above question ever again?", "url": "https://github.com/trinodb/trino/pull/5105#discussion_r485448817", "createdAt": "2020-09-09T08:53:26Z", "author": {"login": "findepi"}, "path": "presto-postgresql/src/main/java/io/prestosql/plugin/postgresql/PostgreSqlClient.java", "diffHunk": "@@ -515,6 +540,32 @@ private static LongWriteFunction timestampWithTimeZoneWriteFunction()\n         };\n     }\n \n+    private static ObjectReadFunction longTimestampWithTimeZoneReadFunction()\n+    {\n+        return ObjectReadFunction.of(\n+                LongTimestampWithTimeZone.class,\n+                (resultSet, columnIndex) -> {\n+                    // PostgreSQL does not store zone information in \"timestamp with time zone\" data type\n+                    OffsetDateTime offsetDateTime = resultSet.getObject(columnIndex, OffsetDateTime.class);\n+                    return LongTimestampWithTimeZone.fromEpochSecondsAndFraction(\n+                            offsetDateTime.toEpochSecond(),\n+                            (long) offsetDateTime.getNano() * PICOSECONDS_PER_NANOSECOND,\n+                            UTC_KEY);\n+                });\n+    }\n+\n+    private static ObjectWriteFunction longTimestampWithTimeZoneWriteFunction()\n+    {\n+        return ObjectWriteFunction.of(\n+                LongTimestampWithTimeZone.class,\n+                (statement, index, value) -> {\n+                    // PostgreSQL does not store zone information in \"timestamp with time zone\" data type\n+                    long epochSeconds = value.getEpochMillis() / MILLISECONDS_PER_SECOND;\n+                    long nanosOfSecond = value.getEpochMillis() % MICROSECONDS_PER_MILLISECOND * NANOSECONDS_PER_MILLISECOND + value.getPicosOfMilli() / PICOSECONDS_PER_NANOSECOND;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ1MDc4NQ==", "bodyText": "MICROSECONDS_PER_MILLISECOND -> ..", "url": "https://github.com/trinodb/trino/pull/5105#discussion_r485450785", "createdAt": "2020-09-09T08:56:21Z", "author": {"login": "findepi"}, "path": "presto-postgresql/src/main/java/io/prestosql/plugin/postgresql/TypeUtils.java", "diffHunk": "@@ -180,10 +194,20 @@ private static Object prestoNativeToJdbcObject(ConnectorSession session, Type pr\n             return toPgTimestamp(fromPrestoTimestamp((long) prestoNative));\n         }\n \n-        if (TIMESTAMP_WITH_TIME_ZONE.equals(prestoType)) {\n-            long millisUtc = unpackMillisUtc((long) prestoNative);\n+        if (prestoType instanceof TimestampWithTimeZoneType) {\n             // PostgreSQL does not store zone, only the point in time\n-            return new Timestamp(millisUtc);\n+            int precision = ((TimestampWithTimeZoneType) prestoType).getPrecision();\n+            if (precision <= TimestampWithTimeZoneType.MAX_SHORT_PRECISION) {\n+                long millisUtc = unpackMillisUtc((long) prestoNative);\n+                return new Timestamp(millisUtc);\n+            }\n+            else {\n+                LongTimestampWithTimeZone value = (LongTimestampWithTimeZone) prestoNative;\n+                long epochSeconds = value.getEpochMillis() / MILLISECONDS_PER_SECOND;\n+                long nanosOfSecond = value.getEpochMillis() % MICROSECONDS_PER_MILLISECOND * NANOSECONDS_PER_MILLISECOND", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ1MTYxNw==", "bodyText": "Let's also add test what happens if we try create table with timestamp(7).", "url": "https://github.com/trinodb/trino/pull/5105#discussion_r485451617", "createdAt": "2020-09-09T08:57:35Z", "author": {"login": "findepi"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "diffHunk": "@@ -1141,16 +1141,16 @@ public void testTimestampWithTimeZone(boolean insertWithPresto)\n     }\n \n     @Test(dataProvider = \"testTimestampWithTimeZoneDataProvider\")\n-    public void testArrayTimestampWithTimeZone(boolean insertWithPresto)\n+    public void testArrayTimestampWithTimeZone(boolean insertWithPresto, int precision)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ1MjUzNw==", "bodyText": "Method is called \"round to precision\", but this truncates.", "url": "https://github.com/trinodb/trino/pull/5105#discussion_r485452537", "createdAt": "2020-09-09T08:58:57Z", "author": {"login": "findepi"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "diffHunk": "@@ -1376,26 +1386,35 @@ private void testUnsupportedDataTypeConvertedToVarchar(Session session, String d\n         }\n     }\n \n-    public static DataType<ZonedDateTime> prestoTimestampWithTimeZoneDataType()\n+    public static DataType<ZonedDateTime> prestoTimestampWithTimeZoneDataType(int precision)\n     {\n         return dataType(\n-                \"timestamp with time zone\",\n-                TIMESTAMP_WITH_TIME_ZONE,\n-                DateTimeFormatter.ofPattern(\"'TIMESTAMP '''yyyy-MM-dd HH:mm:ss.SSS VV''\")::format,\n+                format(\"timestamp(%d) with time zone\", precision),\n+                createTimestampWithTimeZoneType(precision),\n+                zonedDateTime -> DateTimeFormatter.ofPattern(\"'TIMESTAMP '''yyyy-MM-dd HH:mm:ss.SSSSSS VV''\").format(roundToPrecision(zonedDateTime, precision)),\n                 // PostgreSQL does not store zone, only the point in time\n-                zonedDateTime -> zonedDateTime.withZoneSameInstant(ZoneId.of(\"UTC\")));\n+                zonedDateTime -> roundToPrecision(zonedDateTime, precision).withZoneSameInstant(ZoneId.of(\"UTC\")));\n     }\n \n-    public static DataType<ZonedDateTime> postgreSqlTimestampWithTimeZoneDataType()\n+    public static DataType<ZonedDateTime> postgreSqlTimestampWithTimeZoneDataType(int precision)\n     {\n         return dataType(\n-                \"timestamp with time zone\",\n-                TIMESTAMP_WITH_TIME_ZONE,\n+                format(\"timestamp(%d) with time zone\", precision),\n+                createTimestampWithTimeZoneType(precision),\n                 // PostgreSQL never examines the content of a literal string before determining its type, so `TIMESTAMP '.... {zone}'` won't work.\n                 // PostgreSQL does not store zone, only the point in time\n-                zonedDateTime -> DateTimeFormatter.ofPattern(\"'TIMESTAMP WITH TIME ZONE '''yyyy-MM-dd HH:mm:ss.SSS VV''\").format(zonedDateTime.withZoneSameInstant(UTC)),\n-                DateTimeFormatter.ofPattern(\"'TIMESTAMP '''yyyy-MM-dd HH:mm:ss.SSS VV''\")::format,\n-                zonedDateTime -> zonedDateTime.withZoneSameInstant(ZoneId.of(\"UTC\")));\n+                zonedDateTime -> {\n+                    String pattern = format(\"'TIMESTAMP (%d) WITH TIME ZONE '''yyyy-MM-dd HH:mm:ss.SSSSSS VV''\", precision);\n+                    return DateTimeFormatter.ofPattern(pattern).format(roundToPrecision(zonedDateTime, precision).withZoneSameInstant(UTC));\n+                },\n+                zonedDateTime -> DateTimeFormatter.ofPattern(\"'TIMESTAMP '''yyyy-MM-dd HH:mm:ss.SSSSSS VV''\").format(roundToPrecision(zonedDateTime, precision)),\n+                zonedDateTime -> roundToPrecision(zonedDateTime, precision).withZoneSameInstant(ZoneId.of(\"UTC\")));\n+    }\n+\n+    private static ZonedDateTime roundToPrecision(ZonedDateTime zonedDateTime, int precision)\n+    {\n+        int divisor = (int) Math.pow(10, 9 - precision);\n+        return zonedDateTime.withNano(zonedDateTime.getNano() / divisor * divisor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 149}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "e12f1ba75c157f098b5e805bd2af6b208aa71daf", "author": {"user": {"login": "losipiuk", "name": "\u0141ukasz Osipiuk"}}, "url": "https://github.com/trinodb/trino/commit/e12f1ba75c157f098b5e805bd2af6b208aa71daf", "committedDate": "2020-09-09T13:58:03Z", "message": "Add support for precision for TIMESTAMP W/TZ in Postgresql type mapping\n\nAdd support for mapping TIMESTAMP WITH TIME ZONE from Presto to\nPostgreSQL (and vice versa) for precisions 1 to 6. It covers all\nprecisions currently supported by PostgreSQL."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "e12f1ba75c157f098b5e805bd2af6b208aa71daf", "author": {"user": {"login": "losipiuk", "name": "\u0141ukasz Osipiuk"}}, "url": "https://github.com/trinodb/trino/commit/e12f1ba75c157f098b5e805bd2af6b208aa71daf", "committedDate": "2020-09-09T13:58:03Z", "message": "Add support for precision for TIMESTAMP W/TZ in Postgresql type mapping\n\nAdd support for mapping TIMESTAMP WITH TIME ZONE from Presto to\nPostgreSQL (and vice versa) for precisions 1 to 6. It covers all\nprecisions currently supported by PostgreSQL."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3921, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}