{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMzIxNjI2", "number": 6185, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNTozMTowNlrOFAT4iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNTozNToxM1rOFAUFKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1ODcwMDkxOnYy", "diffSide": "RIGHT", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListenerBasic.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNTozMTowNlrOH-iJKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNTozMTowNlrOH-iJKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMzMzE2Mg==", "bodyText": "remember to remove", "url": "https://github.com/trinodb/trino/pull/6185#discussion_r535333162", "createdAt": "2020-12-03T15:31:06Z", "author": {"login": "findepi"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListenerBasic.java", "diffHunk": "@@ -259,7 +259,7 @@ public void testReferencedTablesAndRoutines()\n         assertEquals(routine.getAuthorization(), \"user\");\n     }\n \n-    @Test\n+    @Test(invocationCount = 100)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1ODcwMTYwOnYy", "diffSide": "RIGHT", "path": ".github/workflows/ci.yml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNTozMToxMVrOH-iJng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNTozMToxMVrOH-iJng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMzMzI3OA==", "bodyText": "reminder", "url": "https://github.com/trinodb/trino/pull/6185#discussion_r535333278", "createdAt": "2020-12-03T15:31:11Z", "author": {"login": "findepi"}, "path": ".github/workflows/ci.yml", "diffHunk": "@@ -239,7 +239,7 @@ jobs:\n           - \"presto-oracle\"\n           - \"presto-kudu\"\n           - \"presto-phoenix,presto-iceberg,presto-druid\"\n-    timeout-minutes: 60\n+    timeout-minutes: 180", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1ODcxMjI2OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQuery.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNTozMjoxOFrOH-iQMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNTozMjoxOFrOH-iQMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMzNDk2Mg==", "bodyText": "private final\n\n\nremove false, as its the default (\"code style\" i guess)", "url": "https://github.com/trinodb/trino/pull/6185#discussion_r535334962", "createdAt": "2020-12-03T15:32:18Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQuery.java", "diffHunk": "@@ -56,22 +56,27 @@\n     private final QueryStateMachine stateMachine;\n     private final ListenableFuture<QueryExecution> queryExecutionFuture;\n \n+    private final QueryMonitor queryMonitor;\n     private final ClusterSizeMonitor clusterSizeMonitor;\n \n     private final Executor queryExecutor;\n \n     private final Consumer<QueryExecution> querySubmitter;\n-    private final SettableFuture<DispatchStatus> submitted = SettableFuture.create();\n+    private final SettableFuture<?> submitted = SettableFuture.create();\n+\n+    AtomicBoolean notificationSentOrGuaranteed = new AtomicBoolean(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1ODcyMzgyOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQuery.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNTozMzo0N1rOH-iYFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNTo0MzozOVrOH-jBKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMzNjk4MA==", "bodyText": "Previously queryExecutionFuture.cancel(true); was done only for FAILED state. Let's maybe retain that behavior, as it seems not related", "url": "https://github.com/trinodb/trino/pull/6185#discussion_r535336980", "createdAt": "2020-12-03T15:33:47Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQuery.java", "diffHunk": "@@ -86,16 +91,16 @@ public LocalDispatchQuery(\n             }\n         });\n \n+        queryMonitor.queryCreatedEvent(stateMachine.getBasicQueryInfo(Optional.empty()));\n         stateMachine.addStateChangeListener(state -> {\n             if (state == QueryState.FAILED) {\n-                // if query is failed and dispatching was not finished yet, marking dispatching as failed\n-                submitted.set(FAILED);\n-                queryExecutionFuture.cancel(true);\n+                if (notificationSentOrGuaranteed.compareAndSet(false, true)) {\n+                    queryMonitor.queryImmediateFailureEvent(getBasicQueryInfo(), getFullQueryInfo().getFailureInfo());\n+                }\n             }\n-\n-            if (state.ordinal() > QueryState.DISPATCHING.ordinal()) {\n-                // we went past dispatching phase; warking submitted as successful\n-                submitted.set(DISPATCHED);\n+            if (state.isDone()) {\n+                submitted.set(null);\n+                queryExecutionFuture.cancel(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM0NzQ5Ng==", "bodyText": "Actually a bit before my changes (see screenshot) it was done for all finished states. Not entiryly sure why I changed that. But given fact that we are rolling back the protocol I introduced it feels natural to rollback this change too:", "url": "https://github.com/trinodb/trino/pull/6185#discussion_r535347496", "createdAt": "2020-12-03T15:43:39Z", "author": {"login": "losipiuk"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQuery.java", "diffHunk": "@@ -86,16 +91,16 @@ public LocalDispatchQuery(\n             }\n         });\n \n+        queryMonitor.queryCreatedEvent(stateMachine.getBasicQueryInfo(Optional.empty()));\n         stateMachine.addStateChangeListener(state -> {\n             if (state == QueryState.FAILED) {\n-                // if query is failed and dispatching was not finished yet, marking dispatching as failed\n-                submitted.set(FAILED);\n-                queryExecutionFuture.cancel(true);\n+                if (notificationSentOrGuaranteed.compareAndSet(false, true)) {\n+                    queryMonitor.queryImmediateFailureEvent(getBasicQueryInfo(), getFullQueryInfo().getFailureInfo());\n+                }\n             }\n-\n-            if (state.ordinal() > QueryState.DISPATCHING.ordinal()) {\n-                // we went past dispatching phase; warking submitted as successful\n-                submitted.set(DISPATCHED);\n+            if (state.isDone()) {\n+                submitted.set(null);\n+                queryExecutionFuture.cancel(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMzNjk4MA=="}, "originalCommit": null, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1ODcyODIzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQueryFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNTozNDoyOFrOH-ia9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNTozNDoyOFrOH-ia9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMzNzcxOQ==", "bodyText": "too many empty line\n(this is fixed in the TMP commit)", "url": "https://github.com/trinodb/trino/pull/6185#discussion_r535337719", "createdAt": "2020-12-03T15:34:28Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQueryFactory.java", "diffHunk": "@@ -110,7 +109,7 @@ public DispatchQuery createDispatchQuery(\n                 warningCollector,\n                 StatementUtils.getQueryType(preparedQuery.getStatement().getClass()));\n \n-        queryMonitor.queryCreatedEvent(stateMachine.getBasicQueryInfo(Optional.empty()));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1ODczMzIyOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/execution/SqlQueryManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNTozNToxM1rOH-ieMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNTozNToxM1rOH-ieMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMzODU0Nw==", "bodyText": "separate commit, or revert", "url": "https://github.com/trinodb/trino/pull/6185#discussion_r535338547", "createdAt": "2020-12-03T15:35:13Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/execution/SqlQueryManager.java", "diffHunk": "@@ -323,8 +315,8 @@ private void enforceScanLimits()\n             Optional<DataSize> limitOpt = getQueryMaxScanPhysicalBytes(query.getSession());\n             if (maxQueryScanPhysicalBytes.isPresent()) {\n                 limitOpt = limitOpt\n-                    .flatMap(sessionLimit -> maxQueryScanPhysicalBytes.map(serverLimit -> Ordering.natural().min(serverLimit, sessionLimit)))\n-                    .or(() -> maxQueryScanPhysicalBytes);\n+                        .flatMap(sessionLimit -> maxQueryScanPhysicalBytes.map(serverLimit -> Ordering.natural().min(serverLimit, sessionLimit)))\n+                        .or(() -> maxQueryScanPhysicalBytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4472, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}