{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMTU1OTEz", "number": 3617, "title": "Change Hive $file_modified_time column to timestamp with timezone type", "bodyText": "Taking a stab at #3611", "createdAt": "2020-05-04T20:02:30Z", "url": "https://github.com/trinodb/trino/pull/3617", "merged": true, "mergeCommit": {"oid": "1b457a1188b44828d5aba7eb7e58d9aa45e1df28"}, "closed": true, "closedAt": "2020-05-06T10:18:21Z", "author": {"login": "alexjo2144"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceFe-TABqjMzMDE1ODA5NjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceYQEagBqjMzMDU0NDY2MTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NTg5ODgx", "url": "https://github.com/trinodb/trino/pull/3617#pullrequestreview-405589881", "createdAt": "2020-05-05T08:34:24Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwODozNDoyNFrOGQfiog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwODozNzoxN1rOGQfo3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk0NzE3MA==", "bodyText": "I originally said UTC to answer \"but which zone?\" (timestamp with time zone requires some zone, but we have just point in time), but the zone doesn't really matter.\nWe could keep it simpler and leave this code piece intact.", "url": "https://github.com/trinodb/trino/pull/3617#discussion_r419947170", "createdAt": "2020-05-05T08:34:24Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HivePageSource.java", "diffHunk": "@@ -211,7 +213,11 @@ else if (type.equals(DATE)) {\n                     prefilledValue = datePartitionKey(columnValue, name);\n                 }\n                 else if (type.equals(TIMESTAMP) || type.equals(TIMESTAMP_WITH_TIME_ZONE)) {\n-                    prefilledValue = timestampPartitionKey(columnValue, hiveStorageTimeZone, name, type.equals(TIMESTAMP_WITH_TIME_ZONE));\n+                    DateTimeZone zone = hiveStorageTimeZone;\n+                    if (isFileModifiedTimeColumnHandle(column)) {\n+                        zone = UTC;\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk0ODU3Nw==", "bodyText": "Add\n// TODO introduce HiveType.HIVE_TIMESTAMP_WITH_TIME_ZONE\n\n-- we cannot add this type here before we upgrade to Hive 3.1, but we should eventually clean this up", "url": "https://github.com/trinodb/trino/pull/3617#discussion_r419948577", "createdAt": "2020-05-05T08:36:57Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveColumnHandle.java", "diffHunk": "@@ -58,8 +59,8 @@\n \n     public static final int FILE_MODIFIED_TIME_COLUMN_INDEX = -14;\n     public static final String FILE_MODIFIED_TIME_COLUMN_NAME = \"$file_modified_time\";\n-    public static final HiveType FILE_MODIFIED_TIME_TYPE = HIVE_LONG;\n-    public static final Type FILE_MODIFIED_TIME_TYPE_SIGNATURE = BIGINT;\n+    public static final HiveType FILE_MODIFIED_TIME_TYPE = HiveType.HIVE_TIMESTAMP;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk0ODc2Nw==", "bodyText": "ZonedDateTime -> Instant\n(file modification times are points in time, zoneless)", "url": "https://github.com/trinodb/trino/pull/3617#discussion_r419948767", "createdAt": "2020-05-05T08:37:17Z", "author": {"login": "findepi"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -3812,17 +3813,17 @@ public void testFileModifiedTimeHiddenColumn()\n         assertEquals(getPartitions(\"test_file_modified_time\").size(), 3);\n \n         MaterializedResult results = computeActual(format(\"SELECT *, \\\"%s\\\" FROM test_file_modified_time\", FILE_MODIFIED_TIME_COLUMN_NAME));\n-        Map<Integer, Long> fileModifiedTimeMap = new HashMap<>();\n+        Map<Integer, ZonedDateTime> fileModifiedTimeMap = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NTkzOTA4", "url": "https://github.com/trinodb/trino/pull/3617#pullrequestreview-405593908", "createdAt": "2020-05-05T08:40:26Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1OTU0MTU2", "url": "https://github.com/trinodb/trino/pull/3617#pullrequestreview-405954156", "createdAt": "2020-05-05T16:26:29Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNjoyNjozMFrOGQxd9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNjoyNjozMFrOGQxd9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI0MDg4NQ==", "bodyText": "@findepi, I removed the fixed zone in UTC time, but had add a change to pass the hive storage zone through to here. Otherwise the time was printed in UTC but was tagged with the hiveStorageTimeZone.", "url": "https://github.com/trinodb/trino/pull/3617#discussion_r420240885", "createdAt": "2020-05-05T16:26:30Z", "author": {"login": "alexjo2144"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/HiveUtil.java", "diffHunk": "@@ -988,7 +995,7 @@ public static String getPrefilledColumnValue(HiveColumnHandle columnHandle, Hive\n             return String.valueOf(fileSize);\n         }\n         if (isFileModifiedTimeColumnHandle(columnHandle)) {\n-            return String.valueOf(fileModifiedTime);\n+            return HIVE_TIMESTAMP_PARSER.withZone(hiveStorageTimeZone).print(fileModifiedTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68eb27c27e6ba5598c81d528e1280981a0efe457", "author": {"user": {"login": "alexjo2144", "name": "Alexander Jo"}}, "url": "https://github.com/trinodb/trino/commit/68eb27c27e6ba5598c81d528e1280981a0efe457", "committedDate": "2020-05-05T18:18:56Z", "message": "Change Hive $file_modified_time column to timestamp with timezone type"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "68eb27c27e6ba5598c81d528e1280981a0efe457", "author": {"user": {"login": "alexjo2144", "name": "Alexander Jo"}}, "url": "https://github.com/trinodb/trino/commit/68eb27c27e6ba5598c81d528e1280981a0efe457", "committedDate": "2020-05-05T18:18:56Z", "message": "Change Hive $file_modified_time column to timestamp with timezone type"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1375, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}