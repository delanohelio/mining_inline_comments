{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2MTA5MjY3", "number": 3896, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMToyOTo1MlrOEBhV-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNTowNTowOFrOEIzVZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMDMwMzMxOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/IterativeOptimizer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMToyOTo1MlrOGdaztA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjo1NTowOVrOGdcq7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUwMTEwOA==", "bodyText": "it does no longer be need to be legal for legacyRules to be empty when the test is true.\nif i just want to have disabling a rule, i should use Rule#isEnabled for that)", "url": "https://github.com/trinodb/trino/pull/3896#discussion_r433501108", "createdAt": "2020-06-01T21:29:52Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/IterativeOptimizer.java", "diffHunk": "@@ -80,7 +83,7 @@ public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculat\n     public PlanNode optimize(PlanNode plan, Session session, TypeProvider types, SymbolAllocator symbolAllocator, PlanNodeIdAllocator idAllocator, WarningCollector warningCollector)\n     {\n         // only disable new rules if we have legacy rules to fall back to\n-        if (!SystemSessionProperties.isNewOptimizerEnabled(session) && !legacyRules.isEmpty()) {\n+        if (legacyRulesEnabled.test(session) && !legacyRules.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzMTYzMQ==", "bodyText": "The goal is (and has always been) to be able to use this to migrate from legacy rules to new ones. When new rules are enabled, the legacy ones should be disabled (and vice-versa).", "url": "https://github.com/trinodb/trino/pull/3896#discussion_r433531631", "createdAt": "2020-06-01T22:55:09Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/IterativeOptimizer.java", "diffHunk": "@@ -80,7 +83,7 @@ public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculat\n     public PlanNode optimize(PlanNode plan, Session session, TypeProvider types, SymbolAllocator symbolAllocator, PlanNodeIdAllocator idAllocator, WarningCollector warningCollector)\n     {\n         // only disable new rules if we have legacy rules to fall back to\n-        if (!SystemSessionProperties.isNewOptimizerEnabled(session) && !legacyRules.isEmpty()) {\n+        if (legacyRulesEnabled.test(session) && !legacyRules.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUwMTEwOA=="}, "originalCommit": null, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxMjYxMTg2OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/IterativeOptimizer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxODo1OTo1NFrOGfT3jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQwODozNTowN1rOGgCpuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4NDU1OA==", "bodyText": "legacyRulesPreferred would better reflect the semantics.", "url": "https://github.com/trinodb/trino/pull/3896#discussion_r435484558", "createdAt": "2020-06-04T18:59:54Z", "author": {"login": "kasiafi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/IterativeOptimizer.java", "diffHunk": "@@ -57,17 +58,19 @@\n     private final CostCalculator costCalculator;\n     private final List<PlanOptimizer> legacyRules;\n     private final RuleIndex ruleIndex;\n+    private final Predicate<Session> legacyRulesEnabled;\n \n     public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, Set<Rule<?>> rules)\n     {\n-        this(stats, statsCalculator, costCalculator, ImmutableList.of(), rules);\n+        this(stats, statsCalculator, costCalculator, session -> false, ImmutableList.of(), rules);\n     }\n \n-    public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, List<PlanOptimizer> legacyRules, Set<Rule<?>> newRules)\n+    public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, Predicate<Session> legacyRulesEnabled, List<PlanOptimizer> legacyRules, Set<Rule<?>> newRules)\n     {\n         this.stats = requireNonNull(stats, \"stats is null\");\n         this.statsCalculator = requireNonNull(statsCalculator, \"statsCalculator is null\");\n         this.costCalculator = requireNonNull(costCalculator, \"costCalculator is null\");\n+        this.legacyRulesEnabled = requireNonNull(legacyRulesEnabled, \"legacyRulesEnabled is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyMDUwNQ==", "bodyText": "I'll change it to useLegacyRules. It's not really a preference. It's a binary choice.", "url": "https://github.com/trinodb/trino/pull/3896#discussion_r436220505", "createdAt": "2020-06-06T00:47:19Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/IterativeOptimizer.java", "diffHunk": "@@ -57,17 +58,19 @@\n     private final CostCalculator costCalculator;\n     private final List<PlanOptimizer> legacyRules;\n     private final RuleIndex ruleIndex;\n+    private final Predicate<Session> legacyRulesEnabled;\n \n     public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, Set<Rule<?>> rules)\n     {\n-        this(stats, statsCalculator, costCalculator, ImmutableList.of(), rules);\n+        this(stats, statsCalculator, costCalculator, session -> false, ImmutableList.of(), rules);\n     }\n \n-    public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, List<PlanOptimizer> legacyRules, Set<Rule<?>> newRules)\n+    public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, Predicate<Session> legacyRulesEnabled, List<PlanOptimizer> legacyRules, Set<Rule<?>> newRules)\n     {\n         this.stats = requireNonNull(stats, \"stats is null\");\n         this.statsCalculator = requireNonNull(statsCalculator, \"statsCalculator is null\");\n         this.costCalculator = requireNonNull(costCalculator, \"costCalculator is null\");\n+        this.legacyRulesEnabled = requireNonNull(legacyRulesEnabled, \"legacyRulesEnabled is null\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4NDU1OA=="}, "originalCommit": null, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI1MTA2Nw==", "bodyText": "Yes, from the perspective of the caller it is binary, as they provide legacy rules.\nFrom the perspective of implementation, it is a preference, because this toggle is ignored if legacy rules is empty.\nI meant the implementation perspective, but it is more important how it shows to the caller.", "url": "https://github.com/trinodb/trino/pull/3896#discussion_r436251067", "createdAt": "2020-06-06T08:35:07Z", "author": {"login": "kasiafi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/IterativeOptimizer.java", "diffHunk": "@@ -57,17 +58,19 @@\n     private final CostCalculator costCalculator;\n     private final List<PlanOptimizer> legacyRules;\n     private final RuleIndex ruleIndex;\n+    private final Predicate<Session> legacyRulesEnabled;\n \n     public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, Set<Rule<?>> rules)\n     {\n-        this(stats, statsCalculator, costCalculator, ImmutableList.of(), rules);\n+        this(stats, statsCalculator, costCalculator, session -> false, ImmutableList.of(), rules);\n     }\n \n-    public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, List<PlanOptimizer> legacyRules, Set<Rule<?>> newRules)\n+    public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, Predicate<Session> legacyRulesEnabled, List<PlanOptimizer> legacyRules, Set<Rule<?>> newRules)\n     {\n         this.stats = requireNonNull(stats, \"stats is null\");\n         this.statsCalculator = requireNonNull(statsCalculator, \"statsCalculator is null\");\n         this.costCalculator = requireNonNull(costCalculator, \"costCalculator is null\");\n+        this.legacyRulesEnabled = requireNonNull(legacyRulesEnabled, \"legacyRulesEnabled is null\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4NDU1OA=="}, "originalCommit": null, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxMjY0MjE4OnYy", "diffSide": "LEFT", "path": "presto-main/src/test/java/io/prestosql/sql/planner/optimizations/TestSetFlatteningOptimizer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxOTowOToxNlrOGfUK-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxOTowOToxNlrOGfUK-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4OTUyOA==", "bodyText": "Rename this class to TestSetFlatteningRules or so.", "url": "https://github.com/trinodb/trino/pull/3896#discussion_r435489528", "createdAt": "2020-06-04T19:09:16Z", "author": {"login": "kasiafi"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/optimizations/TestSetFlatteningOptimizer.java", "diffHunk": "@@ -134,8 +138,12 @@ protected void assertPlan(String sql, PlanMatchPattern pattern)\n                         new RuleStatsRecorder(),\n                         getQueryRunner().getStatsCalculator(),\n                         getQueryRunner().getEstimatedExchangesCostCalculator(),\n-                        ImmutableSet.of(new RemoveRedundantIdentityProjections())),\n-                new SetFlatteningOptimizer());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzQzMDM1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/IterativeOptimizer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQwODozNjoyMlrOGgCp-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQwODozNjoyMlrOGgCp-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI1MTEzMQ==", "bodyText": "adjust error message", "url": "https://github.com/trinodb/trino/pull/3896#discussion_r436251131", "createdAt": "2020-06-06T08:36:22Z", "author": {"login": "kasiafi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/IterativeOptimizer.java", "diffHunk": "@@ -57,17 +58,19 @@\n     private final CostCalculator costCalculator;\n     private final List<PlanOptimizer> legacyRules;\n     private final RuleIndex ruleIndex;\n+    private final Predicate<Session> useLegacyRules;\n \n     public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, Set<Rule<?>> rules)\n     {\n-        this(stats, statsCalculator, costCalculator, ImmutableList.of(), rules);\n+        this(stats, statsCalculator, costCalculator, session -> false, ImmutableList.of(), rules);\n     }\n \n-    public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, List<PlanOptimizer> legacyRules, Set<Rule<?>> newRules)\n+    public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, Predicate<Session> useLegacyRules, List<PlanOptimizer> legacyRules, Set<Rule<?>> newRules)\n     {\n         this.stats = requireNonNull(stats, \"stats is null\");\n         this.statsCalculator = requireNonNull(statsCalculator, \"statsCalculator is null\");\n         this.costCalculator = requireNonNull(costCalculator, \"costCalculator is null\");\n+        this.useLegacyRules = requireNonNull(useLegacyRules, \"legacyRulesEnabled is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d467e11104ee6ff0688771868fc5594729ee484"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3NjY1MTI0OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/IterativeOptimizer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNTowNTowOFrOGo_Bxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNjoyNDozOFrOGpCWPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyODg3MQ==", "bodyText": "Is there a way to set this useLegacy session rules and pass the legacy rule ?", "url": "https://github.com/trinodb/trino/pull/3896#discussion_r445628871", "createdAt": "2020-06-25T15:05:08Z", "author": {"login": "Praveen2112"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/IterativeOptimizer.java", "diffHunk": "@@ -57,17 +58,19 @@\n     private final CostCalculator costCalculator;\n     private final List<PlanOptimizer> legacyRules;\n     private final RuleIndex ruleIndex;\n+    private final Predicate<Session> useLegacyRules;\n \n     public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, Set<Rule<?>> rules)\n     {\n-        this(stats, statsCalculator, costCalculator, ImmutableList.of(), rules);\n+        this(stats, statsCalculator, costCalculator, session -> false, ImmutableList.of(), rules);\n     }\n \n-    public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, List<PlanOptimizer> legacyRules, Set<Rule<?>> newRules)\n+    public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, Predicate<Session> useLegacyRules, List<PlanOptimizer> legacyRules, Set<Rule<?>> newRules)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6e4cd68747aaaa4e5f9ddd44b170ce521945eeb"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY4MzI2MA==", "bodyText": "Not directly. This is callsite specific. For instance, you might create a new set of rules with a new session property to enable/disable the legacy rule just for that optimization, and in the instantiation of the IterativeOptimizer you'd pass a predicate that knows how to check whether that session is set.", "url": "https://github.com/trinodb/trino/pull/3896#discussion_r445683260", "createdAt": "2020-06-25T16:24:38Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/iterative/IterativeOptimizer.java", "diffHunk": "@@ -57,17 +58,19 @@\n     private final CostCalculator costCalculator;\n     private final List<PlanOptimizer> legacyRules;\n     private final RuleIndex ruleIndex;\n+    private final Predicate<Session> useLegacyRules;\n \n     public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, Set<Rule<?>> rules)\n     {\n-        this(stats, statsCalculator, costCalculator, ImmutableList.of(), rules);\n+        this(stats, statsCalculator, costCalculator, session -> false, ImmutableList.of(), rules);\n     }\n \n-    public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, List<PlanOptimizer> legacyRules, Set<Rule<?>> newRules)\n+    public IterativeOptimizer(RuleStatsRecorder stats, StatsCalculator statsCalculator, CostCalculator costCalculator, Predicate<Session> useLegacyRules, List<PlanOptimizer> legacyRules, Set<Rule<?>> newRules)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyODg3MQ=="}, "originalCommit": {"oid": "a6e4cd68747aaaa4e5f9ddd44b170ce521945eeb"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4210, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}