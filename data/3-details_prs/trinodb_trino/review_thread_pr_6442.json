{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1NzI4NTMy", "number": 6442, "reviewThreads": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwNTo0MTo0OVrOFJcOCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQxMzo0MToyNlrOFQZg7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1NDQzODQ4OnYy", "diffSide": "RIGHT", "path": "presto-kinesis/src/main/java/io/prestosql/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwNTo0MTo0OVrOILx3AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwODoxNTo0MVrOILz5aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTIyMjE0NQ==", "bodyText": "Does this support only GZIP or ?", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r549222145", "createdAt": "2020-12-28T05:41:49Z", "author": {"login": "Praveen2112"}, "path": "presto-kinesis/src/main/java/io/prestosql/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +293,23 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private byte[] uncompressIfNeeded(byte[] data)\n+        {\n+            if (data == null || data.length < 2) {\n+                return data;\n+            }\n+            int magic = data[0] & 0xff | ((data[1] << 8) & 0xff00);\n+            if (magic == GZIPInputStream.GZIP_MAGIC) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTIyMjQwMA==", "bodyText": "How about wrapping this logic in a RowDecoder which decompresses the row and passes it to the underlying decoder.", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r549222400", "createdAt": "2020-12-28T05:43:34Z", "author": {"login": "Praveen2112"}, "path": "presto-kinesis/src/main/java/io/prestosql/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +293,23 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private byte[] uncompressIfNeeded(byte[] data)\n+        {\n+            if (data == null || data.length < 2) {\n+                return data;\n+            }\n+            int magic = data[0] & 0xff | ((data[1] << 8) & 0xff00);\n+            if (magic == GZIPInputStream.GZIP_MAGIC) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTIyMjE0NQ=="}, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI1NTUyOQ==", "bodyText": "My idea was to limit it now to Kinesis, since other consumer libraries like Kafka and Redis might have an option to uncompress it.", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r549255529", "createdAt": "2020-12-28T08:15:41Z", "author": {"login": "guyco33"}, "path": "presto-kinesis/src/main/java/io/prestosql/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +293,23 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private byte[] uncompressIfNeeded(byte[] data)\n+        {\n+            if (data == null || data.length < 2) {\n+                return data;\n+            }\n+            int magic = data[0] & 0xff | ((data[1] << 8) & 0xff00);\n+            if (magic == GZIPInputStream.GZIP_MAGIC) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTIyMjE0NQ=="}, "originalCommit": null, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODUwMTAwOnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNzowODowOFrOINnUSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNzowODowOFrOINnUSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE0NjU2OA==", "bodyText": "nit : Can we capture these changes as a separate commit ?", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r551146568", "createdAt": "2021-01-04T07:08:08Z", "author": {"login": "Praveen2112"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -220,7 +232,7 @@ public boolean advanceNextPosition()\n         {\n             if (shardIterator == null && getRecordsRequest == null) {\n                 getIterator(); // first shard iterator\n-                log.debug(\"Starting read.  Retrieved first shard iterator from AWS Kinesis.\");\n+                log.debug(\"(%s:%s) Starting read.  Retrieved first shard iterator from AWS Kinesis.\", split.getStreamName(), split.getShardId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODUwMzU3OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNzowOToxNlrOINnVsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNzowOToxNlrOINnVsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE0NjkyOQ==", "bodyText": "How about using try-with-resources ?", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r551146929", "createdAt": "2021-01-04T07:09:16Z", "author": {"login": "Praveen2112"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -305,9 +317,24 @@ private boolean nextRow()\n             totalBytes += messageData.length;\n             totalMessages++;\n \n-            log.debug(\"Fetching %d bytes from current record. %d messages read so far\", messageData.length, totalMessages);\n+            log.debug(\"(%s:%s) Fetching %d bytes from current record. %d messages read so far\", split.getStreamName(), split.getShardId(), messageData.length, totalMessages);\n \n-            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue = messageDecoder.decodeRow(messageData);\n+            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue;\n+            if (isGZipped(messageData)) {\n+                try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODUwNTAyOnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNzoxMDowN1rOINnWjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNzoxMDowN1rOINnWjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE0NzE1MA==", "bodyText": "nit : can we move it below createJsonMessages", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r551147150", "createdAt": "2021-01-04T07:10:07Z", "author": {"login": "Praveen2112"}, "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "diffHunk": "@@ -97,7 +100,21 @@ private void createDummyMessages(String streamName, int count)\n         mockClient.putRecords(putRecordsRequest);\n     }\n \n-    private void createJsonMessages(String streamName, int count, int idStart)\n+    private byte[] compressMessage(byte[] data)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODUwOTI4OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNzoxMjoyMFrOINnY-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNzoxMjoyMFrOINnY-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE0Nzc2OA==", "bodyText": "static import ?", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r551147768", "createdAt": "2021-01-04T07:12:20Z", "author": {"login": "Praveen2112"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -171,6 +174,15 @@ public RecordCursor cursor()\n         return new KinesisRecordCursor();\n     }\n \n+    public static boolean isGZipped(byte[] data)\n+    {\n+        if (data == null || data.length < 2) {\n+            return false;\n+        }\n+        int magic = data[0] & 0xff | ((data[1] << 8) & 0xff00);\n+        return magic == GZIPInputStream.GZIP_MAGIC;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ4MTcwMDU5OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwODozODoxNlrOIPjb4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwODozODoxNlrOIPjb4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4MDEyOA==", "bodyText": "use try-with-resources for byteOS and gzipOS", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r553180128", "createdAt": "2021-01-07T08:38:16Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "diffHunk": "@@ -119,6 +127,20 @@ private void createJsonMessages(String streamName, int count, int idStart)\n         mockClient.putRecords(putRecordsRequest);\n     }\n \n+    private byte[] compressMessage(byte[] data)\n+    {\n+        try {\n+            ByteArrayOutputStream byteOS = new ByteArrayOutputStream();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ4MTcwMzUwOnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwODozOToxOVrOIPjdsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwODozOToxOVrOIPjdsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4MDU5NA==", "bodyText": "can we have utility methods below the usage (below test)? Please reorder methods in separate commit.", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r553180594", "createdAt": "2021-01-07T08:39:19Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "diffHunk": "@@ -97,7 +100,7 @@ private void createDummyMessages(String streamName, int count)\n         mockClient.putRecords(putRecordsRequest);\n     }\n \n-    private void createJsonMessages(String streamName, int count, int idStart)\n+    private void createJsonMessages(String streamName, int count, int idStart, boolean compress)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ4MTcwNTY4OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwODo0MDowMlrOIPje9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwODo0MDowMlrOIPje9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4MDkxNg==", "bodyText": "Let's make test parametric. You can use io.trino.testing.DataProviders#trueFalse.", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r553180916", "createdAt": "2021-01-07T08:40:02Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "diffHunk": "@@ -160,7 +182,8 @@ public void testStreamHasData()\n     public void testJsonStream()\n     {\n         // Simple case: add a few specific items, query object and internal fields:\n-        createJsonMessages(jsonStreamName, 4, 100);\n+        createJsonMessages(jsonStreamName, 2, 100, false);\n+        createJsonMessages(jsonStreamName, 2, 102, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ4MTcwNzYyOnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwODo0MDoyOFrOIPjf9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwODo0MDoyOFrOIPjf9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4MTE3Mw==", "bodyText": "use try-with-resources for streams.", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r553181173", "createdAt": "2021-01-07T08:40:28Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -307,7 +320,20 @@ private boolean nextRow()\n \n             log.debug(\"Fetching %d bytes from current record. %d messages read so far\", messageData.length, totalMessages);\n \n-            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue = messageDecoder.decodeRow(messageData);\n+            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue;\n+            if (isGZipped(messageData)) {\n+                try (\n+                        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(messageData);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ4MTcwODM2OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwODo0MDo0MlrOIPjgaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwODo0MDo0MlrOIPjgaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4MTI5MQ==", "bodyText": "PrestoException or better UncheckedIOException", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r553181291", "createdAt": "2021-01-07T08:40:42Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -307,7 +320,20 @@ private boolean nextRow()\n \n             log.debug(\"Fetching %d bytes from current record. %d messages read so far\", messageData.length, totalMessages);\n \n-            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue = messageDecoder.decodeRow(messageData);\n+            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue;\n+            if (isGZipped(messageData)) {\n+                try (\n+                        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(messageData);\n+                        GZIPInputStream gZIPInputStream = new GZIPInputStream(byteArrayInputStream)) {\n+                    decodedValue = messageDecoder.decodeRow(gZIPInputStream.readAllBytes());\n+                }\n+                catch (IOException e) {\n+                    throw new RuntimeException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ4MTcwODg4OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwODo0MDo1NVrOIPjgug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwODo0MDo1NVrOIPjgug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE4MTM3MA==", "bodyText": "Please extract a method", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r553181370", "createdAt": "2021-01-07T08:40:55Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -307,7 +320,20 @@ private boolean nextRow()\n \n             log.debug(\"Fetching %d bytes from current record. %d messages read so far\", messageData.length, totalMessages);\n \n-            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue = messageDecoder.decodeRow(messageData);\n+            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue;\n+            if (isGZipped(messageData)) {\n+                try (", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwNzk5MTg0OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQwODoyOTowMlrOITYLGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQwODoyOTowMlrOITYLGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzE4OTkxMw==", "bodyText": "please put each argument in separate line", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r557189913", "createdAt": "2021-01-14T08:29:02Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -434,8 +434,8 @@ private FieldValueProvider getFieldValueProvider(int field, Class<?> expectedTyp\n         @Override\n         public void close()\n         {\n-            log.info(\"Closing cursor - read complete.  Total read: %d batches %d messages, processed: %d messages and %d bytes.\",\n-                    batchesRead, messagesRead, totalMessages, totalBytes);\n+            log.info(\"(%s:%s) Closing cursor - read complete.  Total read: %d batches %d messages, processed: %d messages and %d bytes.\",\n+                    split.getStreamName(), split.getShardId(), batchesRead, messagesRead, totalMessages, totalBytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwNzk5OTg5OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisTableHandle.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQwODoyOTo1M1rOITYQeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQwODoyOTo1M1rOITYQeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzE5MTI5MA==", "bodyText": "Please enum.", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r557191290", "createdAt": "2021-01-14T08:29:53Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisTableHandle.java", "diffHunk": "@@ -47,17 +49,24 @@\n \n     private final String messageDataFormat;\n \n+    /**\n+     * Compression codec to use for decompressing message. Can be null.\n+     */\n+    private final String compressionCodec;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwODAwMTQ3OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisTableHandle.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQwODozMDowM1rOITYRlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQwODozMDowM1rOITYRlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzE5MTU3Mg==", "bodyText": "This is obvious, I would remove this comment.", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r557191572", "createdAt": "2021-01-14T08:30:03Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisTableHandle.java", "diffHunk": "@@ -47,17 +49,24 @@\n \n     private final String messageDataFormat;\n \n+    /**\n+     * Compression codec to use for decompressing message. Can be null.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwODAwMzgxOnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisTableHandle.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQwODozMDoyMFrOITYTCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQwODozMDoyMFrOITYTCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzE5MTk0NQ==", "bodyText": "Please return Optional", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r557191945", "createdAt": "2021-01-14T08:30:20Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisTableHandle.java", "diffHunk": "@@ -84,6 +93,13 @@ public String getMessageDataFormat()\n         return messageDataFormat;\n     }\n \n+    @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxOTQ3MjQ5OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisCompressionCodec.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNlQxOTo1NDozNFrOIVIN3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNlQxOTo1NDozNFrOIVIN3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyNTYyOQ==", "bodyText": "add a coma at the end GZIP,", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559025629", "createdAt": "2021-01-16T19:54:34Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisCompressionCodec.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.plugin.kinesis;\n+\n+public enum KinesisCompressionCodec\n+{\n+    GZIP", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxOTQ3NDE3OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNlQxOTo1NTozM1rOIVIPDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNlQxOTo1NTozM1rOIVIPDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyNTkzMw==", "bodyText": "make it private, and move below the usage", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559025933", "createdAt": "2021-01-16T19:55:33Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -171,6 +179,15 @@ public RecordCursor cursor()\n         return new KinesisRecordCursor();\n     }\n \n+    public static boolean isGZipped(byte[] data)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxOTQ3Njk5OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNlQxOTo1NjozN1rOIVIQ4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOFQxMDowMjo1N1rOIVh8MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyNjQwMw==", "bodyText": "getCompressionCodec() == GZIP then I guess we should fail if !isGZipped(messageData) as this is unexpected.\nMaybe we could have KinesisCompressionCodec.AUTOMATIC, wdyt?", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559026403", "createdAt": "2021-01-16T19:56:37Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +307,27 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)\n+        {\n+            if (!split.getCompressionCodec().isPresent()) {\n+                return messageDecoder.decodeRow(messageData);\n+            }\n+            if (split.getCompressionCodec().get().equals(KinesisCompressionCodec.GZIP)) {\n+                if (isGZipped(messageData)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTEwMDM2Mw==", "bodyText": "I guess we should fail if !isGZipped(messageData) as this is unexpected.\n\nIt's expected for cases that both compressed and uncompressed messages exist in stream at the same time.\nFor example: during a deployment rollout, for compression based on message size or for cases that some producers didn't implement the compression yet.\n\nMaybe we could have KinesisCompressionCodec.AUTOMATIC\n\nThat would be the ultimate option. I would expect it to decompress any codec, but it's not needed for now, so I would leave it for further implementation", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559100363", "createdAt": "2021-01-17T08:59:06Z", "author": {"login": "guyco33"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +307,27 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)\n+        {\n+            if (!split.getCompressionCodec().isPresent()) {\n+                return messageDecoder.decodeRow(messageData);\n+            }\n+            if (split.getCompressionCodec().get().equals(KinesisCompressionCodec.GZIP)) {\n+                if (isGZipped(messageData)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyNjQwMw=="}, "originalCommit": null, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ0NzA4OA==", "bodyText": "It's expected for cases that both compressed and uncompressed messages exist in stream at the same time.\n\nThis is the case I would like to be handled by KinesisCompressionCodec.AUTOMATIC", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559447088", "createdAt": "2021-01-18T10:02:57Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +307,27 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)\n+        {\n+            if (!split.getCompressionCodec().isPresent()) {\n+                return messageDecoder.decodeRow(messageData);\n+            }\n+            if (split.getCompressionCodec().get().equals(KinesisCompressionCodec.GZIP)) {\n+                if (isGZipped(messageData)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyNjQwMw=="}, "originalCommit": null, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxOTQ4NjM3OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNlQyMDowMDoyOFrOIVIWqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNlQyMDowMDoyOFrOIVIWqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyNzg4Mw==", "bodyText": "static", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559027883", "createdAt": "2021-01-16T20:00:28Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "diffHunk": "@@ -119,6 +127,20 @@ private void createJsonMessages(String streamName, int count, int idStart)\n         mockClient.putRecords(putRecordsRequest);\n     }\n \n+    private byte[] compressMessage(byte[] data)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxOTQ4NzEyOnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNlQyMDowMDo1OFrOIVIXJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNlQyMDowMDo1OFrOIVIXJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyODAwNg==", "bodyText": "I would not not wrap line here.\nUse:\ntry (ByteArrayOutputStream byteOS = new ByteArrayOutputStream()) {\n\nSame above.", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559028006", "createdAt": "2021-01-16T20:00:58Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "diffHunk": "@@ -119,6 +127,20 @@ private void createJsonMessages(String streamName, int count, int idStart)\n         mockClient.putRecords(putRecordsRequest);\n     }\n \n+    private byte[] compressMessage(byte[] data)\n+    {\n+        try (", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxOTQ4ODMxOnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNlQyMDowMTozNVrOIVIX9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNlQyMDowMTozNVrOIVIX9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTAyODIxNQ==", "bodyText": "add it to the try above.", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r559028215", "createdAt": "2021-01-16T20:01:35Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/test/java/io/trino/plugin/kinesis/TestRecordAccess.java", "diffHunk": "@@ -119,6 +127,20 @@ private void createJsonMessages(String streamName, int count, int idStart)\n         mockClient.putRecords(putRecordsRequest);\n     }\n \n+    private byte[] compressMessage(byte[] data)\n+    {\n+        try (\n+                ByteArrayOutputStream byteOS = new ByteArrayOutputStream()) {\n+            GZIPOutputStream gzipOS = new GZIPOutputStream(byteOS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUyNjM4ODEzOnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQwOToxNzo0N1rOIWFJ8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQxMDozNTo1NlrOIWIYTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDAyNDA0OA==", "bodyText": "Please invert the condition, so there will be less code nested, and corner case will be handled first.", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560024048", "createdAt": "2021-01-19T09:17:47Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +300,32 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)\n+        {\n+            if (!split.getCompressionCodec().isPresent()) {\n+                return messageDecoder.decodeRow(messageData);\n+            }\n+            if (split.getCompressionCodec().get() == GZIP || split.getCompressionCodec().get() == AUTOMATIC) {\n+                if (isGZipped(messageData)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDA3Njg3OQ==", "bodyText": "The idea was to skip testing the GZIP header if it's not required", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560076879", "createdAt": "2021-01-19T10:35:56Z", "author": {"login": "guyco33"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +300,32 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)\n+        {\n+            if (!split.getCompressionCodec().isPresent()) {\n+                return messageDecoder.decodeRow(messageData);\n+            }\n+            if (split.getCompressionCodec().get() == GZIP || split.getCompressionCodec().get() == AUTOMATIC) {\n+                if (isGZipped(messageData)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDAyNDA0OA=="}, "originalCommit": null, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUyNjM5OTM1OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQwOToyMDoxNlrOIWFQog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQwOToyMDoxNlrOIWFQog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDAyNTc2Mg==", "bodyText": "Extract variable for split.getCompressionCodec().get(). Or even introduce a method to enum canUseGzip() which would return true for AUTOMATIC and GZIP", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560025762", "createdAt": "2021-01-19T09:20:16Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +300,32 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)\n+        {\n+            if (!split.getCompressionCodec().isPresent()) {\n+                return messageDecoder.decodeRow(messageData);\n+            }\n+            if (split.getCompressionCodec().get() == GZIP || split.getCompressionCodec().get() == AUTOMATIC) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUyNjQxMTcwOnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQwOToyMzoxNlrOIWFYQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQwOToyMzoxNlrOIWFYQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDAyNzcxMw==", "bodyText": "We could add UNCOMPRESSED (default value) then we could merge this block with the one at top of this method.", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560027713", "createdAt": "2021-01-19T09:23:16Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +300,32 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)\n+        {\n+            if (!split.getCompressionCodec().isPresent()) {\n+                return messageDecoder.decodeRow(messageData);\n+            }\n+            if (split.getCompressionCodec().get() == GZIP || split.getCompressionCodec().get() == AUTOMATIC) {\n+                if (isGZipped(messageData)) {\n+                    try (\n+                            ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(messageData);\n+                            GZIPInputStream gZIPInputStream = new GZIPInputStream(byteArrayInputStream)) {\n+                        return messageDecoder.decodeRow(gZIPInputStream.readAllBytes());\n+                    }\n+                    catch (IOException e) {\n+                        throw new TrinoException(GENERIC_INTERNAL_ERROR, e);\n+                    }\n+                }\n+                if (split.getCompressionCodec().get() == GZIP) {\n+                    throw new TrinoException(GENERIC_INTERNAL_ERROR, format(\"Failed to decompress %s message\", split.getCompressionCodec().get()));\n+                }\n+            }\n+            if (split.getCompressionCodec().get() == AUTOMATIC) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUyNzM4NDI5OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQxMzozODozNlrOIWOtbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQxMzozODozNlrOIWOtbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDE4MDU5MA==", "bodyText": "please invert the condition", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560180590", "createdAt": "2021-01-19T13:38:36Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +300,28 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)\n+        {\n+            KinesisCompressionCodec kinesisCompressionCodec = split.getCompressionCodec();\n+            if (isGZipped(messageData)) {\n+                if (canUseGzip(kinesisCompressionCodec)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUyNzM4Nzk0OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisStreamFieldGroup.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQxMzozOTozMFrOIWOvrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQxNjozOTo0OFrOIWXJMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDE4MTE2NQ==", "bodyText": "I am not sure if this going to work. You would need to add round trip json serialization test to verify this. Maybe simply remove this annotation?", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560181165", "createdAt": "2021-01-19T13:39:30Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisStreamFieldGroup.java", "diffHunk": "@@ -42,6 +47,12 @@ public String getDataFormat()\n         return dataFormat;\n     }\n \n+    @JsonProperty", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDMxODc3MQ==", "bodyText": "I've just remove the annotation", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560318771", "createdAt": "2021-01-19T16:39:48Z", "author": {"login": "guyco33"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisStreamFieldGroup.java", "diffHunk": "@@ -42,6 +47,12 @@ public String getDataFormat()\n         return dataFormat;\n     }\n \n+    @JsonProperty", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDE4MTE2NQ=="}, "originalCommit": null, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUyNzM5NTY1OnYy", "diffSide": "RIGHT", "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQxMzo0MToyNlrOIWO0fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQxMzo0MToyNlrOIWO0fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDE4MjM5OQ==", "bodyText": "please move this method under the usage", "url": "https://github.com/trinodb/trino/pull/6442#discussion_r560182399", "createdAt": "2021-01-19T13:41:26Z", "author": {"login": "kokosing"}, "path": "plugin/trino-kinesis/src/main/java/io/trino/plugin/kinesis/KinesisRecordSet.java", "diffHunk": "@@ -290,6 +300,28 @@ private void getKinesisRecords()\n             messagesRead += kinesisRecords.size();\n         }\n \n+        private Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodeMessage(byte[] messageData)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 50}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4428, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}