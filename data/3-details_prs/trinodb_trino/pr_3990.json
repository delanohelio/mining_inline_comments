{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNTY0MDY2", "number": 3990, "title": "Reduce idle CPU consumption in the resource group manager.", "bodyText": "The InternalResourceGroupManager is waking up periodically to calculate CPU quotas and to unblock queries waiting to be run.\nThis change increases the period of this wake up from 1ms to 100ms.\nSome data...\nBefore this change\n\nPresto consumes about 5-10% of CPU when idle.\nThe main consumer of a CPU is the periodic task scheduled on the ResourceGroupManager. About 4s in a 5 minute interval\nThe CPU package does not reach deeper powerstates\n\nAfter this change:\n\nPresto consumes about 2-3% (so still some work to do)\nThe ResourceGroupManager threads consume about 200ms in a 5 minute interval\nThe CPU package reaches deeper c-states at least 50% of the time.\n\nSee discussion on #3966 .", "createdAt": "2020-06-10T16:17:17Z", "url": "https://github.com/trinodb/trino/pull/3990", "merged": true, "mergeCommit": {"oid": "790fed92104d4a88d51b734947b1e2f7d4bcf74e"}, "closed": true, "closedAt": "2020-06-18T21:30:20Z", "author": {"login": "lhofhansl"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp884ngFqTQyODI2OTYyOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcslWePgFqTQzMzY2MTEzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MjY5NjI4", "url": "https://github.com/trinodb/trino/pull/3990#pullrequestreview-428269628", "createdAt": "2020-06-10T17:17:47Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NDc3Mzcz", "url": "https://github.com/trinodb/trino/pull/3990#pullrequestreview-428477373", "createdAt": "2020-06-10T22:42:08Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MDY0NzAy", "url": "https://github.com/trinodb/trino/pull/3990#pullrequestreview-429064702", "createdAt": "2020-06-11T16:04:08Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MjA1ODAw", "url": "https://github.com/trinodb/trino/pull/3990#pullrequestreview-429205800", "createdAt": "2020-06-11T19:06:24Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMTIxOTYz", "url": "https://github.com/trinodb/trino/pull/3990#pullrequestreview-431121963", "createdAt": "2020-06-16T02:44:50Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMjo0NDo1MVrOGkJTrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMjo0NDo1MVrOGkJTrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU1NDQxNQ==", "bodyText": "Note that these are not needed. query1a.complete() will automatically trigger finding and running the next query.", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r440554415", "createdAt": "2020-06-16T02:44:51Z", "author": {"login": "lhofhansl"}, "path": "presto-main/src/test/java/io/prestosql/execution/resourcegroups/TestResourceGroups.java", "diffHunk": "@@ -113,29 +112,26 @@ public void testFairEligibility()\n         assertEquals(query3a.getState(), QUEUED);\n \n         query1a.complete();\n-        root.updateGroupsAndProcessQueuedQueries();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMTIyMjgx", "url": "https://github.com/trinodb/trino/pull/3990#pullrequestreview-431122281", "createdAt": "2020-06-16T02:45:42Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMjo0NTo0MlrOGkJUxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMjo0NTo0MlrOGkJUxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU1NDY5NA==", "bodyText": "No op to allow the test fine-grained control when to trigger the next query.", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r440554694", "createdAt": "2020-06-16T02:45:42Z", "author": {"login": "lhofhansl"}, "path": "presto-main/src/test/java/io/prestosql/execution/resourcegroups/TestResourceGroups.java", "diffHunk": "@@ -618,7 +609,13 @@ public void testRecursiveCpuUsageUpdate()\n     @Test(timeOut = 10_000)\n     public void testMemoryUpdateRecursively()\n     {\n-        RootInternalResourceGroup root = new RootInternalResourceGroup(\"root\", (group, export) -> {}, directExecutor());\n+        InternalResourceGroup root = new InternalResourceGroup(\"root\", (group, export) -> {}, directExecutor()) {\n+            @Override\n+            protected void triggerProcessQueuedQueries()\n+            {\n+                // NO OP", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 196}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNjU4MjU3", "url": "https://github.com/trinodb/trino/pull/3990#pullrequestreview-431658257", "createdAt": "2020-06-16T15:57:52Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNTo1Nzo1MlrOGkiTxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjowMjowMlrOGkifXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2NDAzNw==", "bodyText": "I think initial time here could still be small (1 seems fine). Might improve server time-to-first-query and has no cost.", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r440964037", "createdAt": "2020-06-16T15:57:52Z", "author": {"login": "raghavsethi"}, "path": "presto-main/src/main/java/io/prestosql/execution/resourcegroups/InternalResourceGroupManager.java", "diffHunk": "@@ -183,7 +182,7 @@ public void destroy()\n     public void start()\n     {\n         if (started.compareAndSet(false, true)) {\n-            refreshExecutor.scheduleWithFixedDelay(this::refreshAndStartQueries, 1, 1, TimeUnit.MILLISECONDS);\n+            refreshExecutor.scheduleWithFixedDelay(this::refreshAndStartQueries, 100, 100, TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2NDc1MA==", "bodyText": "This should be in a comment in the code, not just in the PR.", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r440964750", "createdAt": "2020-06-16T15:58:52Z", "author": {"login": "raghavsethi"}, "path": "presto-main/src/test/java/io/prestosql/execution/resourcegroups/TestResourceGroups.java", "diffHunk": "@@ -618,7 +609,13 @@ public void testRecursiveCpuUsageUpdate()\n     @Test(timeOut = 10_000)\n     public void testMemoryUpdateRecursively()\n     {\n-        RootInternalResourceGroup root = new RootInternalResourceGroup(\"root\", (group, export) -> {}, directExecutor());\n+        InternalResourceGroup root = new InternalResourceGroup(\"root\", (group, export) -> {}, directExecutor()) {\n+            @Override\n+            protected void triggerProcessQueuedQueries()\n+            {\n+                // NO OP", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU1NDY5NA=="}, "originalCommit": null, "originalPosition": 196}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2NDg3NQ==", "bodyText": "Same for the others.", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r440964875", "createdAt": "2020-06-16T15:59:04Z", "author": {"login": "raghavsethi"}, "path": "presto-main/src/test/java/io/prestosql/execution/resourcegroups/TestResourceGroups.java", "diffHunk": "@@ -756,7 +753,13 @@ public void testPriorityScheduling()\n     @Test(timeOut = 10_000)\n     public void testWeightedScheduling()\n     {\n-        RootInternalResourceGroup root = new RootInternalResourceGroup(\"root\", (group, export) -> {}, directExecutor());\n+        InternalResourceGroup root = new InternalResourceGroup(\"root\", (group, export) -> {}, directExecutor()) {\n+            @Override\n+            protected void triggerProcessQueuedQueries()\n+            {\n+                // NO OP", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 220}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2NjA2Mg==", "bodyText": "Is this only for testing? If so, consider making this public, marking @VisibleForTesting, and removing this comment.", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r440966062", "createdAt": "2020-06-16T16:00:38Z", "author": {"login": "raghavsethi"}, "path": "presto-main/src/main/java/io/prestosql/execution/resourcegroups/InternalResourceGroup.java", "diffHunk": "@@ -669,6 +674,32 @@ private void startInBackground(ManagedQueryExecution query)\n         }\n     }\n \n+    public void updateGroupsAndProcessQueuedQueries()\n+    {\n+        synchronized (root) {\n+            updateResourceUsageAndGetDelta();\n+\n+            while (internalStartNext()) {\n+                // start all the queries we can\n+            }\n+        }\n+    }\n+\n+    public void generateCpuQuota(long elapsedSeconds)\n+    {\n+        synchronized (root) {\n+            if (elapsedSeconds > 0) {\n+                internalGenerateCpuQuota(elapsedSeconds);\n+            }\n+        }\n+    }\n+\n+    // indirection for testing\n+    protected void triggerProcessQueuedQueries()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2NzAwNA==", "bodyText": "Minor nit:\n// start as many queries as possible\nwhile (internalStartNext());", "url": "https://github.com/trinodb/trino/pull/3990#discussion_r440967004", "createdAt": "2020-06-16T16:02:02Z", "author": {"login": "raghavsethi"}, "path": "presto-main/src/main/java/io/prestosql/execution/resourcegroups/InternalResourceGroup.java", "diffHunk": "@@ -669,6 +674,32 @@ private void startInBackground(ManagedQueryExecution query)\n         }\n     }\n \n+    public void updateGroupsAndProcessQueuedQueries()\n+    {\n+        synchronized (root) {\n+            updateResourceUsageAndGetDelta();\n+\n+            while (internalStartNext()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ac782ae6f5de508a261e038615f8cfb9f202072", "author": {"user": {"login": "lhofhansl", "name": null}}, "url": "https://github.com/trinodb/trino/commit/7ac782ae6f5de508a261e038615f8cfb9f202072", "committedDate": "2020-06-16T19:45:20Z", "message": "Change resource groups to start waiting queries on query completion.\n\nPreviously, InternalResourceGroupManager woke up periodically to calculate CPU\nquotas and to unblock queries waiting to be run. Now, waiting queries are\nstarted on query completion. This change also decreases the CPU calculation\nfrequency from 1ms to 100ms, reducing idle CPU consumption."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMjM0ODkx", "url": "https://github.com/trinodb/trino/pull/3990#pullrequestreview-433234891", "createdAt": "2020-06-18T12:33:12Z", "commit": {"oid": "7ac782ae6f5de508a261e038615f8cfb9f202072"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDU2ODU5", "url": "https://github.com/trinodb/trino/pull/3990#pullrequestreview-433456859", "createdAt": "2020-06-18T16:33:53Z", "commit": {"oid": "7ac782ae6f5de508a261e038615f8cfb9f202072"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNjYxMTMz", "url": "https://github.com/trinodb/trino/pull/3990#pullrequestreview-433661133", "createdAt": "2020-06-18T21:29:47Z", "commit": {"oid": "7ac782ae6f5de508a261e038615f8cfb9f202072"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 633, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}