{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMjU4MTkw", "number": 2734, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwOToxNzozM1rODdQnhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMjowMTo1NVrODexxhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMDA3NTU4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/DropStatsProcedure.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwOToxNzozM1rOFlwkTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwOToxNzozM1rOFlwkTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEzNzM1Ng==", "bodyText": "use HiveMetastoreClousure here", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r375137356", "createdAt": "2020-02-05T09:17:33Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/DropStatsProcedure.java", "diffHunk": "@@ -97,6 +99,8 @@ private void doDropStats(ConnectorSession session, String schema, String table,\n                 .filter(HiveColumnHandle::isPartitionKey)\n                 .map(HiveColumnHandle::getName)\n                 .collect(toImmutableList());\n+        Table tableMetadata = metastore.getTable(new HiveIdentity(session.getIdentity()), schema, table)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTk5NTU4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/thrift/MockThriftMetastoreClient.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMDoxMjozN1rOFngbtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMjowMzoxNFrOFoGd4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDE2NA==", "bodyText": "the methods here are either not implement (throw) or implemented.", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r376970164", "createdAt": "2020-02-10T10:12:37Z", "author": {"login": "findepi"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/thrift/MockThriftMetastoreClient.java", "diffHunk": "@@ -218,7 +218,8 @@ public void deleteTableColumnStatistics(String databaseName, String tableName, S\n     @Override\n     public void setPartitionColumnStatistics(String databaseName, String tableName, String partitionName, List<ColumnStatisticsObj> statistics)\n     {\n-        throw new UnsupportedOperationException();\n+        accessCount.incrementAndGet();\n+        // No-op", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3NDI2OA==", "bodyText": "@sopel39 @electrum what about replacing MockThriftMetastoreClient with InMemoryThriftMetastore (+ access counting wrapper) in TestCachingHiveMetastore?", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r376974268", "createdAt": "2020-02-10T10:20:47Z", "author": {"login": "findepi"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/thrift/MockThriftMetastoreClient.java", "diffHunk": "@@ -218,7 +218,8 @@ public void deleteTableColumnStatistics(String databaseName, String tableName, S\n     @Override\n     public void setPartitionColumnStatistics(String databaseName, String tableName, String partitionName, List<ColumnStatisticsObj> statistics)\n     {\n-        throw new UnsupportedOperationException();\n+        accessCount.incrementAndGet();\n+        // No-op", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDE2NA=="}, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3OTQ5Mg==", "bodyText": "Yes, I thought of doing that as well - but chose this instead since the alter/set-stats operation was not being used anywhere as of now. there are some no-ops around roles as well in MockThriftMetastoreClient", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r376979492", "createdAt": "2020-02-10T10:30:27Z", "author": {"login": "rohangarg"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/thrift/MockThriftMetastoreClient.java", "diffHunk": "@@ -218,7 +218,8 @@ public void deleteTableColumnStatistics(String databaseName, String tableName, S\n     @Override\n     public void setPartitionColumnStatistics(String databaseName, String tableName, String partitionName, List<ColumnStatisticsObj> statistics)\n     {\n-        throw new UnsupportedOperationException();\n+        accessCount.incrementAndGet();\n+        // No-op", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDE2NA=="}, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MzMxMw==", "bodyText": "@sopel39 @electrum what about replacing MockThriftMetastoreClient with InMemoryThriftMetastore (+ access counting wrapper) in TestCachingHiveMetastore?\n\nIt seems like a good idea. I don't think MockThriftMetastoreClient correctly mocks thrift metastore. I would say this could be a follow up PR though.", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r377593313", "createdAt": "2020-02-11T12:03:14Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/thrift/MockThriftMetastoreClient.java", "diffHunk": "@@ -218,7 +218,8 @@ public void deleteTableColumnStatistics(String databaseName, String tableName, S\n     @Override\n     public void setPartitionColumnStatistics(String databaseName, String tableName, String partitionName, List<ColumnStatisticsObj> statistics)\n     {\n-        throw new UnsupportedOperationException();\n+        accessCount.incrementAndGet();\n+        // No-op", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDE2NA=="}, "originalCommit": null, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTk5NTgzOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/thrift/MockThriftMetastoreClient.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMDoxMjo0MlrOFngb1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMDoxMjo0MlrOFngb1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDE5OQ==", "bodyText": "as above", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r376970199", "createdAt": "2020-02-10T10:12:42Z", "author": {"login": "findepi"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/thrift/MockThriftMetastoreClient.java", "diffHunk": "@@ -346,7 +347,8 @@ public boolean dropPartition(String databaseName, String tableName, List<String>\n     @Override\n     public void alterPartition(String databaseName, String tableName, Partition partition)\n     {\n-        throw new UnsupportedOperationException();\n+        accessCount.incrementAndGet();\n+        // No-op", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzNTk5MDg4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/DropStatsProcedure.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMjowMDo0OFrOFoGaJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMjowMDo0OFrOFoGaJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjM1OQ==", "bodyText": "just make metastore field a HiveMetastoreClosure", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r377592359", "createdAt": "2020-02-11T12:00:48Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/DropStatsProcedure.java", "diffHunk": "@@ -97,6 +97,7 @@ private void doDropStats(ConnectorSession session, String schema, String table,\n                 .filter(HiveColumnHandle::isPartitionKey)\n                 .map(HiveColumnHandle::getName)\n                 .collect(toImmutableList());\n+        HiveMetastoreClosure hiveMetastore = new HiveMetastoreClosure(metastore);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzNTk5MzY1OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastore.java", "isResolved": false, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMjowMTo1NlrOFoGb5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTo1MDo0NlrOFpQ88g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA==", "bodyText": "add a commit that adds this test as a first commit.\nThen you will be able to show improvement with Remove getTable ... commit", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r377592804", "createdAt": "2020-02-11T12:01:56Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastore.java", "diffHunk": "@@ -285,6 +286,18 @@ public void testGetPartitionStatistics()\n         assertEquals(mockClient.getAccessCount(), 3);\n     }\n \n+    @Test\n+    public void testUpdatePartitionStatistics()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg2NDA4NA==", "bodyText": "I ran the test without the removal of getTable call, it did 5 calls to the metastore. The new one does 4 calls. The test failed with the following error :\njava.lang.AssertionError: expected [5] but found [6] Expected :5 Actual   :6", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r377864084", "createdAt": "2020-02-11T19:55:05Z", "author": {"login": "rohangarg"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastore.java", "diffHunk": "@@ -285,6 +286,18 @@ public void testGetPartitionStatistics()\n         assertEquals(mockClient.getAccessCount(), 3);\n     }\n \n+    @Test\n+    public void testUpdatePartitionStatistics()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA=="}, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc1MTUyNg==", "bodyText": "Please make Test CachingHiveMetastore update partition statistics  commit to be before than Remove getTable call from updatePartitionStatistics commit", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r378751526", "createdAt": "2020-02-13T09:46:43Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastore.java", "diffHunk": "@@ -285,6 +286,18 @@ public void testGetPartitionStatistics()\n         assertEquals(mockClient.getAccessCount(), 3);\n     }\n \n+    @Test\n+    public void testUpdatePartitionStatistics()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA=="}, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc1MzEwMA==", "bodyText": "The test commit is before the removal commit in my git log. I think github shows commit in chronology of time + I did a rebase of test commit due to some conflicts. So, github is showing the test commit later. will rewrite the removal commit as well for consistency.", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r378753100", "createdAt": "2020-02-13T09:49:51Z", "author": {"login": "rohangarg"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastore.java", "diffHunk": "@@ -285,6 +286,18 @@ public void testGetPartitionStatistics()\n         assertEquals(mockClient.getAccessCount(), 3);\n     }\n \n+    @Test\n+    public void testUpdatePartitionStatistics()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA=="}, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc2NTIzNQ==", "bodyText": "So could you write the test in such way that it shows an improvement in removal commit? Maybe do two update calls?", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r378765235", "createdAt": "2020-02-13T10:12:21Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastore.java", "diffHunk": "@@ -285,6 +286,18 @@ public void testGetPartitionStatistics()\n         assertEquals(mockClient.getAccessCount(), 3);\n     }\n \n+    @Test\n+    public void testUpdatePartitionStatistics()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA=="}, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5MDUxNA==", "bodyText": "I have added the test commit first along with the expected number of calls in that to be 5 (without the removal change). In the removal commit, I've updated the test to expect 4 calls (changing the test) - so that it shows improvement over the earlier test. Does that suffice?", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r378790514", "createdAt": "2020-02-13T10:59:14Z", "author": {"login": "rohangarg"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastore.java", "diffHunk": "@@ -285,6 +286,18 @@ public void testGetPartitionStatistics()\n         assertEquals(mockClient.getAccessCount(), 3);\n     }\n \n+    @Test\n+    public void testUpdatePartitionStatistics()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA=="}, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxMTAzMQ==", "bodyText": "I would expect that 1c45b21 shows reduced access count in testUpdatePartitionStatistics", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r378811031", "createdAt": "2020-02-13T11:44:51Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastore.java", "diffHunk": "@@ -285,6 +286,18 @@ public void testGetPartitionStatistics()\n         assertEquals(mockClient.getAccessCount(), 3);\n     }\n \n+    @Test\n+    public void testUpdatePartitionStatistics()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA=="}, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgxMzY4Mg==", "bodyText": "test reduced count - shows the reduced access count in testUpdatePartitionStatistics in the 1c45b21 commit.", "url": "https://github.com/trinodb/trino/pull/2734#discussion_r378813682", "createdAt": "2020-02-13T11:50:46Z", "author": {"login": "rohangarg"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/metastore/cache/TestCachingHiveMetastore.java", "diffHunk": "@@ -285,6 +286,18 @@ public void testGetPartitionStatistics()\n         assertEquals(mockClient.getAccessCount(), 3);\n     }\n \n+    @Test\n+    public void testUpdatePartitionStatistics()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MjgwNA=="}, "originalCommit": null, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 865, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}