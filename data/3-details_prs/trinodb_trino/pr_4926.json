{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxODA0NTg1", "number": 4926, "title": "Support implementing interface in tests", "bodyText": "Support implementing interface in tests", "createdAt": "2020-08-21T18:53:45Z", "url": "https://github.com/trinodb/trino/pull/4926", "merged": true, "mergeCommit": {"oid": "50dc92aa9eaaa059c7607d2258378bfdd2920a0b"}, "closed": true, "closedAt": "2020-08-26T11:50:19Z", "author": {"login": "kokosing"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBJpVNgFqTQ3Mjc0NzI3NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCqReXgFqTQ3NTQwNDAwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNzQ3Mjc0", "url": "https://github.com/trinodb/trino/pull/4926#pullrequestreview-472747274", "createdAt": "2020-08-21T19:05:27Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyODM1MTAy", "url": "https://github.com/trinodb/trino/pull/4926#pullrequestreview-472835102", "createdAt": "2020-08-21T21:44:38Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQyMTo0NDozOFrOHE-qSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQyMTo0NDozOFrOHE-qSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk4Mjk4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (superclass == null) {\n          \n          \n            \n                    if (method.getDeclaringClass().isInterface()) {", "url": "https://github.com/trinodb/trino/pull/4926#discussion_r474982986", "createdAt": "2020-08-21T21:44:38Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -78,6 +78,10 @@ private static boolean isTestMethod(Method method)\n             return true;\n         }\n         Class<?> superclass = method.getDeclaringClass().getSuperclass();\n+        if (superclass == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjA4MTIw", "url": "https://github.com/trinodb/trino/pull/4926#pullrequestreview-473208120", "createdAt": "2020-08-24T08:08:20Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMzU3NTE5", "url": "https://github.com/trinodb/trino/pull/4926#pullrequestreview-473357519", "createdAt": "2020-08-24T10:54:38Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMDo1NDozOFrOHFfSkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMDo1NDozOFrOHFfSkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxNzU4NA==", "bodyText": "Please see #4951 for my take on this.", "url": "https://github.com/trinodb/trino/pull/4926#discussion_r475517584", "createdAt": "2020-08-24T10:54:38Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -129,4 +130,18 @@ public static boolean isTemptoClass(Class<?> aClass)\n     {\n         return aClass.getPackage().getName().startsWith(\"io.prestosql.tempto\");\n     }\n+\n+    private static void forceTestngFailure(Runnable runnable)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMzYwOTk4", "url": "https://github.com/trinodb/trino/pull/4926#pullrequestreview-473360998", "createdAt": "2020-08-24T11:00:21Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTowMDoyMVrOHFfc9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTowNDozMVrOHFfkeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyMDI0Ng==", "bodyText": "BTW Maybe we can deprecate & remove this interfaces?\nAlso, this should not match eg io.prestosql.temptomat -- you need to prefix match with a dot at the end.", "url": "https://github.com/trinodb/trino/pull/4926#discussion_r475520246", "createdAt": "2020-08-24T11:00:21Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -140,6 +140,6 @@ private static boolean overrides(Method first, Method second)\n \n     public static boolean isTemptoClass(Class<?> aClass)\n     {\n-        return \"io.prestosql.tempto\".equals(aClass.getPackage().getName());\n+        return aClass.getPackage().getName().startsWith(\"io.prestosql.tempto\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyMTA4MQ==", "bodyText": "you should not exit early if this is an interface, but not tempto related\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (method.getDeclaringClass().isInterface()) {\n          \n          \n            \n                        return isTemptoClass(method.getDeclaringClass());\n          \n          \n            \n                    if (method.getDeclaringClass().isInterface() && isTemptoClass(method.getDeclaringClass())) {\n          \n          \n            \n                        return true;", "url": "https://github.com/trinodb/trino/pull/4926#discussion_r475521081", "createdAt": "2020-08-24T11:02:09Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -77,17 +76,33 @@ private static boolean isTestMethod(Method method)\n         if (method.getDeclaringClass() == Object.class) {\n             return true;\n         }\n-        Class<?> superclass = method.getDeclaringClass().getSuperclass();\n-        Method overridden;\n+        if (method.getDeclaringClass().isInterface()) {\n+            return isTemptoClass(method.getDeclaringClass());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyMTU3MQ==", "bodyText": "Does this disable ReportUnannotatedMethods for any class that happens to implement a tempto interface?", "url": "https://github.com/trinodb/trino/pull/4926#discussion_r475521571", "createdAt": "2020-08-24T11:03:17Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -77,17 +76,33 @@ private static boolean isTestMethod(Method method)\n         if (method.getDeclaringClass() == Object.class) {\n             return true;\n         }\n-        Class<?> superclass = method.getDeclaringClass().getSuperclass();\n-        Method overridden;\n+        if (method.getDeclaringClass().isInterface()) {\n+            return isTemptoClass(method.getDeclaringClass());\n+        }\n+        for (Class<?> interfaceClass : method.getDeclaringClass().getInterfaces()) {\n+            if (isTemptoClass(interfaceClass)) {\n+                return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyMjE3MA==", "bodyText": "You apparently removed recursion from here.\neg what if A.test overrides B.test and B.test overrides C.test and C.test is @Test annotated?", "url": "https://github.com/trinodb/trino/pull/4926#discussion_r475522170", "createdAt": "2020-08-24T11:04:31Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -77,17 +76,33 @@ private static boolean isTestMethod(Method method)\n         if (method.getDeclaringClass() == Object.class) {\n             return true;\n         }\n-        Class<?> superclass = method.getDeclaringClass().getSuperclass();\n-        Method overridden;\n+        if (method.getDeclaringClass().isInterface()) {\n+            return isTemptoClass(method.getDeclaringClass());\n+        }\n+        for (Class<?> interfaceClass : method.getDeclaringClass().getInterfaces()) {\n+            if (isTemptoClass(interfaceClass)) {\n+                return true;\n+            }\n+            Optional<Method> overridden = getOverridden(method, interfaceClass);\n+            if (overridden.isPresent()) {\n+                return true;\n+            }\n+        }\n+\n+        return getOverridden(method, method.getDeclaringClass().getSuperclass())\n+                .map(ReportUnannotatedMethods::isAllowedPublicMethodInTest)\n+                .orElse(false);\n+    }\n+\n+    private static Optional<Method> getOverridden(Method method, Class<?> base)\n+    {\n         try {\n             // Simplistic override detection\n-            overridden = superclass.getMethod(method.getName(), method.getParameterTypes());\n+            return Optional.of(base.getMethod(method.getName(), method.getParameterTypes()));\n         }\n         catch (NoSuchMethodException ignored) {\n-            return false;\n+            return Optional.empty();\n         }\n-\n-        return isTestMethod(overridden);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 67}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMzg2NzU1", "url": "https://github.com/trinodb/trino/pull/4926#pullrequestreview-473386755", "createdAt": "2020-08-24T11:42:21Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTo0MjoyMVrOHFgrPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTo1MDoxMVrOHFg4eQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MDI4Ng==", "bodyText": "No it is moved, see\n                .map(ReportUnannotatedMethods::isAllowedPublicMethodInTest)\n\nI will add test for that.", "url": "https://github.com/trinodb/trino/pull/4926#discussion_r475540286", "createdAt": "2020-08-24T11:42:21Z", "author": {"login": "kokosing"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -77,17 +76,33 @@ private static boolean isTestMethod(Method method)\n         if (method.getDeclaringClass() == Object.class) {\n             return true;\n         }\n-        Class<?> superclass = method.getDeclaringClass().getSuperclass();\n-        Method overridden;\n+        if (method.getDeclaringClass().isInterface()) {\n+            return isTemptoClass(method.getDeclaringClass());\n+        }\n+        for (Class<?> interfaceClass : method.getDeclaringClass().getInterfaces()) {\n+            if (isTemptoClass(interfaceClass)) {\n+                return true;\n+            }\n+            Optional<Method> overridden = getOverridden(method, interfaceClass);\n+            if (overridden.isPresent()) {\n+                return true;\n+            }\n+        }\n+\n+        return getOverridden(method, method.getDeclaringClass().getSuperclass())\n+                .map(ReportUnannotatedMethods::isAllowedPublicMethodInTest)\n+                .orElse(false);\n+    }\n+\n+    private static Optional<Method> getOverridden(Method method, Class<?> base)\n+    {\n         try {\n             // Simplistic override detection\n-            overridden = superclass.getMethod(method.getName(), method.getParameterTypes());\n+            return Optional.of(base.getMethod(method.getName(), method.getParameterTypes()));\n         }\n         catch (NoSuchMethodException ignored) {\n-            return false;\n+            return Optional.empty();\n         }\n-\n-        return isTestMethod(overridden);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyMjE3MA=="}, "originalCommit": null, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MzY3Mw==", "bodyText": "Good catch", "url": "https://github.com/trinodb/trino/pull/4926#discussion_r475543673", "createdAt": "2020-08-24T11:50:11Z", "author": {"login": "kokosing"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -77,17 +76,33 @@ private static boolean isTestMethod(Method method)\n         if (method.getDeclaringClass() == Object.class) {\n             return true;\n         }\n-        Class<?> superclass = method.getDeclaringClass().getSuperclass();\n-        Method overridden;\n+        if (method.getDeclaringClass().isInterface()) {\n+            return isTemptoClass(method.getDeclaringClass());\n+        }\n+        for (Class<?> interfaceClass : method.getDeclaringClass().getInterfaces()) {\n+            if (isTemptoClass(interfaceClass)) {\n+                return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyMTU3MQ=="}, "originalCommit": null, "originalPosition": 42}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b31f9a65ddc126ec89bb49f7f8ba2669cdd6826", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/0b31f9a65ddc126ec89bb49f7f8ba2669cdd6826", "committedDate": "2020-08-25T18:49:12Z", "message": "Handle io.prestosql.tempto.testmarkers interfaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dd392cc7b963d0103021fa59ea1a01347aff407", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/5dd392cc7b963d0103021fa59ea1a01347aff407", "committedDate": "2020-08-25T18:49:12Z", "message": "Support implementing interface in tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "5dd392cc7b963d0103021fa59ea1a01347aff407", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/5dd392cc7b963d0103021fa59ea1a01347aff407", "committedDate": "2020-08-25T18:49:12Z", "message": "Support implementing interface in tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NDA0MDAy", "url": "https://github.com/trinodb/trino/pull/4926#pullrequestreview-475404002", "createdAt": "2020-08-26T11:40:11Z", "commit": {"oid": "5dd392cc7b963d0103021fa59ea1a01347aff407"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4063, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}