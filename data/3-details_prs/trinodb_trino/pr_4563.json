{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2MjE2MDE1", "number": 4563, "title": "Fix handling of dates and timestamps before the 20th century", "bodyText": "", "createdAt": "2020-07-24T10:43:18Z", "url": "https://github.com/trinodb/trino/pull/4563", "merged": true, "mergeCommit": {"oid": "4efe924e41edfd3b8e232d1de0b40c3a50305ce5"}, "closed": true, "closedAt": "2020-07-30T06:58:28Z", "author": {"login": "aalbu"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4CbDYAFqTQ1NDgxNzMxMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc516p4ABqjM2MDE2NDczMDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0ODE3MzEz", "url": "https://github.com/trinodb/trino/pull/4563#pullrequestreview-454817313", "createdAt": "2020-07-24T11:35:11Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxMTozNToxMlrOG2sJqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxMTozNToxMlrOG2sJqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk5OTY1OA==", "bodyText": "Can you please explain in comment why such logic is needed. It may be just me, but it is not obvious why original code does not work. What is the difference.", "url": "https://github.com/trinodb/trino/pull/4563#discussion_r459999658", "createdAt": "2020-07-24T11:35:12Z", "author": {"login": "losipiuk"}, "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -257,7 +259,11 @@ private Date getDate(int columnIndex, DateTimeZone localTimeZone)\n         }\n \n         try {\n-            return new Date(DATE_FORMATTER.withZone(localTimeZone).parseMillis(String.valueOf(value)));\n+            LocalDate localDate = DATE_FORMATTER.parseLocalDate(String.valueOf(value));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTMxODA0", "url": "https://github.com/trinodb/trino/pull/4563#pullrequestreview-455131804", "createdAt": "2020-07-24T19:23:44Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxOToyMzo0NVrOG27IWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxOToyMzo0NVrOG27IWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI0NTA4MQ==", "bodyText": "This seems fairly expensive. Can we only do this for dates in the affected range, and simply use LocalDate otherwise?", "url": "https://github.com/trinodb/trino/pull/4563#discussion_r460245081", "createdAt": "2020-07-24T19:23:45Z", "author": {"login": "electrum"}, "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -257,7 +259,11 @@ private Date getDate(int columnIndex, DateTimeZone localTimeZone)\n         }\n \n         try {\n-            return new Date(DATE_FORMATTER.withZone(localTimeZone).parseMillis(String.valueOf(value)));\n+            LocalDate localDate = DATE_FORMATTER.parseLocalDate(String.valueOf(value));\n+            GregorianCalendar calendar = new GregorianCalendar(localDate.getYear(), localDate.getMonthOfYear() - 1, localDate.getDayOfMonth());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NTQ4NTk4", "url": "https://github.com/trinodb/trino/pull/4563#pullrequestreview-455548598", "createdAt": "2020-07-27T07:46:58Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNzo0Njo1OFrOG3XPCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNzo1MDo0NVrOG3XW0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcwNTU0NQ==", "bodyText": "What do you mean by \"the default\" here?\nThe cutoff date defaults to 1582-10-15, but you are not using a constant.\nInstead youre asking for locale/env specific date. Maybe\n// The date when the Gregorian calendar was instituted, environment specific. Defaults to October 15, 1582.\n\n?", "url": "https://github.com/trinodb/trino/pull/4563#discussion_r460705545", "createdAt": "2020-07-27T07:46:58Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -116,6 +119,9 @@\n             .toFormatter()\n             .withOffsetParsed();\n \n+    // the default date when the Gregorian calendar was instituted (October 15, 1582)\n+    private static final long GREGORIAN_CALENDAR_INTRODUCTION = new GregorianCalendar().getGregorianChange().getTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcwNzA1Mw==", "bodyText": "it is \"appropriate\" in some way. I think it would be better to indicate the actual problem\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // the chronology used by default by Joda is not appropriate for dates preceding the introduction of the Gregorian calendar,\n          \n          \n            \n                        // The chronology used by Joda is not consistent with java.sql.Date\n          \n          \n            \n                         for dates preceding the introduction of the Gregorian calendar.\n          \n          \n            \n                        // Same millisecond value represents a different year/month/day.", "url": "https://github.com/trinodb/trino/pull/4563#discussion_r460707053", "createdAt": "2020-07-27T07:49:47Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -257,7 +263,18 @@ private Date getDate(int columnIndex, DateTimeZone localTimeZone)\n         }\n \n         try {\n-            return new Date(DATE_FORMATTER.withZone(localTimeZone).parseMillis(String.valueOf(value)));\n+            long millis = DATE_FORMATTER.withZone(localTimeZone).parseMillis(String.valueOf(value));\n+            if (millis >= GREGORIAN_CALENDAR_INTRODUCTION) {\n+                return new Date(millis);\n+            }\n+            // the chronology used by default by Joda is not appropriate for dates preceding the introduction of the Gregorian calendar,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcwNzUzOA==", "bodyText": "What are the end user visible symptoms of these differences? are they test covered?", "url": "https://github.com/trinodb/trino/pull/4563#discussion_r460707538", "createdAt": "2020-07-27T07:50:45Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -257,7 +263,18 @@ private Date getDate(int columnIndex, DateTimeZone localTimeZone)\n         }\n \n         try {\n-            return new Date(DATE_FORMATTER.withZone(localTimeZone).parseMillis(String.valueOf(value)));\n+            long millis = DATE_FORMATTER.withZone(localTimeZone).parseMillis(String.valueOf(value));\n+            if (millis >= GREGORIAN_CALENDAR_INTRODUCTION) {\n+                return new Date(millis);\n+            }\n+            // the chronology used by default by Joda is not appropriate for dates preceding the introduction of the Gregorian calendar,\n+            // so for such cases we are falling back to the more expensive GregorianCalendar; note that Joda also has a chronology that\n+            // works for older dates, but it uses a slightly different algorithm, so we are sticking with the standard library", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 42}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MzM1MDU4", "url": "https://github.com/trinodb/trino/pull/4563#pullrequestreview-456335058", "createdAt": "2020-07-28T06:26:42Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNjoyNjo0MlrOG3-W7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNjozMDoyNlrOG3-cuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM0NjU0MA==", "bodyText": "Let's keep the optimistic path as simple as possible.\nPreviously it was\nreturn new Date(DATE_FORMATTER.withZone(localTimeZone).parseMillis(String.valueOf(value)));\n\nnow it can be\nlong millis = DATE_FORMATTER.withZone(localTimeZone).parseMillis(String.valueOf(value));\nif (millis >= MODERN_YEAR_MILLIS) {\n    return new Date(millis);\n}", "url": "https://github.com/trinodb/trino/pull/4563#discussion_r461346540", "createdAt": "2020-07-28T06:26:42Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -257,7 +260,19 @@ private Date getDate(int columnIndex, DateTimeZone localTimeZone)\n         }\n \n         try {\n-            return new Date(DATE_FORMATTER.withZone(localTimeZone).parseMillis(String.valueOf(value)));\n+            LocalDate localDate = DATE_FORMATTER.parseLocalDate(String.valueOf(value));\n+            if (modernDate(localDate.getYear())) {\n+                long millis = localDate.toDateTimeAtStartOfDay(localTimeZone).getMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM0ODAyNA==", "bodyText": "Introduce constants\n// Before that year, Java Time and Joda Time are not consistent with java.sql.Date and java.util.Calendar\n// Since January 1, 1900 in one zone is still December 31, 1899 in some other zone, we are adding 1 year margin.\nMODERN_YEAR = 1901\n\nMODERN_YEAR_MILLIS_UTC = LocalDate.of(MODERN_YEAR,1,1)...........\n\nThen you can inline modernDate", "url": "https://github.com/trinodb/trino/pull/4563#discussion_r461348024", "createdAt": "2020-07-28T06:30:26Z", "author": {"login": "findepi"}, "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -1788,11 +1803,25 @@ private static Timestamp parseTimestamp(String value, Function<String, ZoneId> t\n                 .atZone(zoneId)\n                 .toEpochSecond();\n \n-        Timestamp timestamp = new Timestamp(epochSecond * 1000);\n+        Timestamp timestamp;\n+        if (modernDate(year)) {\n+            timestamp = new Timestamp(epochSecond * 1000);\n+        }\n+        else {\n+            GregorianCalendar calendar = new GregorianCalendar(year, month - 1, day, hour, minute, second);\n+            calendar.setTimeZone(TimeZone.getTimeZone(zoneId));\n+            timestamp = new Timestamp(calendar.getTimeInMillis());\n+        }\n         timestamp.setNanos((int) rescale(fractionValue, precision, 9));\n         return timestamp;\n     }\n \n+    private static boolean modernDate(int year)\n+    {\n+        // before this year, the chronology used by Joda is not consistent with java.sql.Date\n+        return year >= 1900;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 63}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTMyODg5", "url": "https://github.com/trinodb/trino/pull/4563#pullrequestreview-457132889", "createdAt": "2020-07-29T01:23:19Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMToyMzoyMFrOG4lOTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMToyMzoyMFrOG4lOTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk4MzMwOA==", "bodyText": "This is a bit long, which makes it hard to read. Since we have multiple lines of text, wrapping at ~100 would look better and be easier to read.", "url": "https://github.com/trinodb/trino/pull/4563#discussion_r461983308", "createdAt": "2020-07-29T01:23:20Z", "author": {"login": "electrum"}, "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -257,7 +266,20 @@ private Date getDate(int columnIndex, DateTimeZone localTimeZone)\n         }\n \n         try {\n-            return new Date(DATE_FORMATTER.withZone(localTimeZone).parseMillis(String.valueOf(value)));\n+            long millis = DATE_FORMATTER.withZone(localTimeZone).parseMillis(String.valueOf(value));\n+            if (millis >= START_OF_MODERN_ERA) {\n+                return new Date(millis);\n+            }\n+\n+            // The chronology used by default by Joda is not historically accurate for dates preceding the introduction of the Gregorian calendar", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTMzNDc2", "url": "https://github.com/trinodb/trino/pull/4563#pullrequestreview-457133476", "createdAt": "2020-07-29T01:25:18Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMToyNToxOVrOG4lQXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMToyNToxOVrOG4lQXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk4MzgzNg==", "bodyText": "No need for this constant, since it's only used in the constant below. It would actually be easier to read the below if it is simply said 1901, 1, 1 as then it's easy to compare with the comment above.", "url": "https://github.com/trinodb/trino/pull/4563#discussion_r461983836", "createdAt": "2020-07-29T01:25:19Z", "author": {"login": "electrum"}, "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -116,6 +120,11 @@\n             .toFormatter()\n             .withOffsetParsed();\n \n+    // Before 1900, Java Time and Joda Time are not consistent with java.sql.Date and java.util.Calendar\n+    // Since January 1, 1900 UTC is still December 31, 1899 in other zones, we are adding a 1 year margin.\n+    private static final int MODERN_ERA_YEAR = 1901;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTMzOTMy", "url": "https://github.com/trinodb/trino/pull/4563#pullrequestreview-457133932", "createdAt": "2020-07-29T01:26:47Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMToyNjo0N1rOG4lR8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMToyODoxNVrOG4lTew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk4NDI0MQ==", "bodyText": "This can be declared Calendar since we don't use any methods specific to GregorianCalendar.", "url": "https://github.com/trinodb/trino/pull/4563#discussion_r461984241", "createdAt": "2020-07-29T01:26:47Z", "author": {"login": "electrum"}, "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -257,7 +266,20 @@ private Date getDate(int columnIndex, DateTimeZone localTimeZone)\n         }\n \n         try {\n-            return new Date(DATE_FORMATTER.withZone(localTimeZone).parseMillis(String.valueOf(value)));\n+            long millis = DATE_FORMATTER.withZone(localTimeZone).parseMillis(String.valueOf(value));\n+            if (millis >= START_OF_MODERN_ERA) {\n+                return new Date(millis);\n+            }\n+\n+            // The chronology used by default by Joda is not historically accurate for dates preceding the introduction of the Gregorian calendar\n+            // and is not consistent with java.sql.Date (the same millisecond value represents a different year/month/day) before the 20th century.\n+            // For such dates we are falling back to using the more expensive GregorianCalendar; note that Joda also has a chronology that works for\n+            // older dates, but it uses a slightly different algorithm and still yields results that are not compatible with java.sql.Date.\n+            LocalDate localDate = DATE_FORMATTER.parseLocalDate(String.valueOf(value));\n+            GregorianCalendar calendar = new GregorianCalendar(localDate.getYear(), localDate.getMonthOfYear() - 1, localDate.getDayOfMonth());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk4NDYzNQ==", "bodyText": "Do this as\nlong epochMillis = SECONDS.toMillis(epochSecond);\nThen we avoid the constant and only do the calculation once.", "url": "https://github.com/trinodb/trino/pull/4563#discussion_r461984635", "createdAt": "2020-07-29T01:28:15Z", "author": {"login": "electrum"}, "path": "presto-jdbc/src/main/java/io/prestosql/jdbc/AbstractPrestoResultSet.java", "diffHunk": "@@ -1788,7 +1810,16 @@ private static Timestamp parseTimestamp(String value, Function<String, ZoneId> t\n                 .atZone(zoneId)\n                 .toEpochSecond();\n \n-        Timestamp timestamp = new Timestamp(epochSecond * 1000);\n+        Timestamp timestamp;\n+        if (epochSecond * 1000 >= START_OF_MODERN_ERA) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTM1NDE3", "url": "https://github.com/trinodb/trino/pull/4563#pullrequestreview-457135417", "createdAt": "2020-07-29T01:31:41Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMTozMTo0MVrOG4lXEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMTozMTo0MVrOG4lXEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk4NTU1NQ==", "bodyText": "I realize the others do this, but it'd be better to factor this out\nTimestamp expected = Timestamp.valueOf(LocalDateTime.of(1, 1, 1, 0, 0, 0);\nThat way it's clear to the reader that these are the same value.", "url": "https://github.com/trinodb/trino/pull/4563#discussion_r461985555", "createdAt": "2020-07-29T01:31:41Z", "author": {"login": "electrum"}, "path": "presto-jdbc/src/test/java/io/prestosql/jdbc/TestJdbcResultSet.java", "diffHunk": "@@ -193,6 +225,45 @@ public void testObjectTypes()\n             assertEquals(rs.getTimestamp(column), Timestamp.valueOf(LocalDateTime.of(2018, 2, 13, 13, 14, 15, 555_555_556)));\n         });\n \n+        // distant past, but apparently not an uncommon value in practice\n+        checkRepresentation(\"TIMESTAMP '0001-01-01 00:00:00'\", Types.TIMESTAMP, (rs, column) -> {\n+            assertEquals(rs.getObject(column), Timestamp.valueOf(LocalDateTime.of(1, 1, 1, 0, 0, 0)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 45}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "70c3998252beec5e39ba4bd91a30c3fc37fcbcc0", "author": {"user": {"login": "aalbu", "name": "Alex Albu"}}, "url": "https://github.com/trinodb/trino/commit/70c3998252beec5e39ba4bd91a30c3fc37fcbcc0", "committedDate": "2020-07-30T02:08:18Z", "message": "Fix handling of dates and timestamps before the 20th century"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "70c3998252beec5e39ba4bd91a30c3fc37fcbcc0", "author": {"user": {"login": "aalbu", "name": "Alex Albu"}}, "url": "https://github.com/trinodb/trino/commit/70c3998252beec5e39ba4bd91a30c3fc37fcbcc0", "committedDate": "2020-07-30T02:08:18Z", "message": "Fix handling of dates and timestamps before the 20th century"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4883, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}