{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNjU3MDQ2", "number": 5530, "title": "Support coercing varchar types in hive", "bodyText": "Fixes #5484.", "createdAt": "2020-10-12T15:38:23Z", "url": "https://github.com/trinodb/trino/pull/5530", "merged": true, "mergeCommit": {"oid": "e9be099acc53b8f08e11e3a47d9cd1c23b283326"}, "closed": true, "closedAt": "2020-10-26T17:06:13Z", "author": {"login": "phd3"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdR15QFgFqTUwNjcyOTY4OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWREsegFqTUxNjYwMzA5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NzI5Njg4", "url": "https://github.com/trinodb/trino/pull/5530#pullrequestreview-506729688", "createdAt": "2020-10-12T15:41:27Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNTo0MToyN1rOHgD5Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNTo0MToyN1rOHgD5Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM4MDIzNA==", "bodyText": "@findepi we could instead refactor createCoercer to return an Optional object, thoughts?", "url": "https://github.com/trinodb/trino/pull/5530#discussion_r503380234", "createdAt": "2020-10-12T15:41:27Z", "author": {"login": "phd3"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HivePageSource.java", "diffHunk": "@@ -162,7 +163,7 @@ public HivePageSource(\n                 HiveType fromType = columnMapping.getBaseTypeCoercionFrom().get().getHiveTypeForDereferences(dereferenceIndices).get();\n                 HiveType toType = columnMapping.getHiveColumnHandle().getHiveType();\n                 if (!fromType.equals(toType)) {\n-                    coercers.add(Optional.of(createCoercer(typeManager, fromType, toType)));\n+                    coercers.add(Optional.ofNullable(createCoercer(typeManager, fromType, toType)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMzQxMzg1", "url": "https://github.com/trinodb/trino/pull/5530#pullrequestreview-510341385", "createdAt": "2020-10-16T10:20:43Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMDoyMDo0M1rOHizyTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMDoyNjozMFrOHi0GPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI2MjA5Mw==", "bodyText": "Let's not add this to SPI. We should add it when it is commonly needed.\nThis can be just a helper method next to createCoercer", "url": "https://github.com/trinodb/trino/pull/5530#discussion_r506262093", "createdAt": "2020-10-16T10:20:43Z", "author": {"login": "findepi"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/VarcharType.java", "diffHunk": "@@ -261,4 +262,10 @@ private static long comparisonOperator(@BlockPosition Block leftBlock, @BlockInd\n         int rightLength = rightBlock.getSliceLength(rightPosition);\n         return leftBlock.compareTo(leftPosition, 0, leftLength, rightBlock, rightPosition, 0, rightLength);\n     }\n+\n+    public boolean narrowerThan(VarcharType other)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI2NTEyOQ==", "bodyText": "Return Functions.identity() instead for now.\nAs a followup, yes it makes sense to have createCoercer return Optional.\nThen the fromType.equals(toType) check should be moved inside the method.", "url": "https://github.com/trinodb/trino/pull/5530#discussion_r506265129", "createdAt": "2020-10-16T10:24:05Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HivePageSource.java", "diffHunk": "@@ -363,6 +364,17 @@ public ConnectorPageSource getPageSource()\n         if (fromType instanceof VarcharType && (toHiveType.equals(HIVE_BYTE) || toHiveType.equals(HIVE_SHORT) || toHiveType.equals(HIVE_INT) || toHiveType.equals(HIVE_LONG))) {\n             return new VarcharToIntegerNumberCoercer<>((VarcharType) fromType, toType);\n         }\n+        if (fromType instanceof VarcharType && toType instanceof VarcharType) {\n+            VarcharType toVarcharType = (VarcharType) toType;\n+            VarcharType fromVarcharType = (VarcharType) fromType;\n+\n+            if (toVarcharType.narrowerThan(fromVarcharType)) {\n+                return new VarcharCoercer(fromVarcharType, toVarcharType);\n+            }\n+\n+            // Coercion not worth the copying penalty when toType is wider\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI2NTM5Ng==", "bodyText": "revert (per comment above)", "url": "https://github.com/trinodb/trino/pull/5530#discussion_r506265396", "createdAt": "2020-10-16T10:24:23Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HivePageSource.java", "diffHunk": "@@ -496,7 +508,7 @@ public StructCoercer(TypeManager typeManager, HiveType fromHiveType, HiveType to\n                     coercers.add(Optional.empty());\n                 }\n                 else if (!fromFieldTypes.get(i).equals(toFieldTypes.get(i))) {\n-                    coercers.add(Optional.of(createCoercer(typeManager, fromFieldTypes.get(i), toFieldTypes.get(i))));\n+                    coercers.add(Optional.ofNullable(createCoercer(typeManager, fromFieldTypes.get(i), toFieldTypes.get(i))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI2NTkwMg==", "bodyText": "This should operate on Slice directly.", "url": "https://github.com/trinodb/trino/pull/5530#discussion_r506265902", "createdAt": "2020-10-16T10:25:01Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/coercions/VarcharCoercer.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.coercions;\n+\n+import io.prestosql.spi.block.Block;\n+import io.prestosql.spi.block.BlockBuilder;\n+import io.prestosql.spi.type.VarcharType;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static io.airlift.slice.Slices.utf8Slice;\n+\n+public class VarcharCoercer\n+        extends TypeCoercer<VarcharType, VarcharType>\n+{\n+    public VarcharCoercer(VarcharType fromType, VarcharType toType)\n+    {\n+        super(fromType, toType);\n+        checkArgument(toType.narrowerThan(fromType), \"Coercer to a wider varchar type should not be required\");\n+    }\n+\n+    @Override\n+    protected void applyCoercedValue(BlockBuilder blockBuilder, Block block, int position)\n+    {\n+        String value = fromType.getSlice(block, position).toStringUtf8();\n+        toType.writeSlice(blockBuilder, utf8Slice(value.substring(0, toType.getBoundedLength())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI2NzE5OA==", "bodyText": "Add a test case where eg \ud83d\udcb0\ud83d\udcb0\ud83d\udcb0 (varchar(3)) gets truncated to varchar(2) resulting in \ud83d\udcb0\ud83d\udcb0", "url": "https://github.com/trinodb/trino/pull/5530#discussion_r506267198", "createdAt": "2020-10-16T10:26:30Z", "author": {"login": "findepi"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCoercion.java", "diffHunk": "@@ -383,6 +391,8 @@ private void doTestHiveCoercion(HiveTableDefinition tableDefinition)\n                         //new BigDecimal(\"-12345.12345\"),\n                         -Float.parseFloat(decimalToFloatVal),\n                         -12345.12345,\n+                        \"abc\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 42}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NDc1OTg5", "url": "https://github.com/trinodb/trino/pull/5530#pullrequestreview-514475989", "createdAt": "2020-10-22T08:23:34Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwODoyMzozNFrOHmWNOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwODoyODoxN1rOHmWZbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk3MTc3MQ==", "bodyText": "\"not worth\" is not the right term. \"is type only\" would be more accurate, but i would actually remove the comment.", "url": "https://github.com/trinodb/trino/pull/5530#discussion_r509971771", "createdAt": "2020-10-22T08:23:34Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HivePageSource.java", "diffHunk": "@@ -363,6 +364,17 @@ public ConnectorPageSource getPageSource()\n         if (fromType instanceof VarcharType && (toHiveType.equals(HIVE_BYTE) || toHiveType.equals(HIVE_SHORT) || toHiveType.equals(HIVE_INT) || toHiveType.equals(HIVE_LONG))) {\n             return new VarcharToIntegerNumberCoercer<>((VarcharType) fromType, toType);\n         }\n+        if (fromType instanceof VarcharType && toType instanceof VarcharType) {\n+            VarcharType toVarcharType = (VarcharType) toType;\n+            VarcharType fromVarcharType = (VarcharType) fromType;\n+\n+            if (narrowerThan(toVarcharType, fromVarcharType)) {\n+                return new VarcharCoercer(fromVarcharType, toVarcharType);\n+            }\n+\n+            // Coercion not worth the copying penalty when toType is wider", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk3MTkyMw==", "bodyText": "add\n// TODO make the method return Optional", "url": "https://github.com/trinodb/trino/pull/5530#discussion_r509971923", "createdAt": "2020-10-22T08:23:47Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HivePageSource.java", "diffHunk": "@@ -363,6 +364,17 @@ public ConnectorPageSource getPageSource()\n         if (fromType instanceof VarcharType && (toHiveType.equals(HIVE_BYTE) || toHiveType.equals(HIVE_SHORT) || toHiveType.equals(HIVE_INT) || toHiveType.equals(HIVE_LONG))) {\n             return new VarcharToIntegerNumberCoercer<>((VarcharType) fromType, toType);\n         }\n+        if (fromType instanceof VarcharType && toType instanceof VarcharType) {\n+            VarcharType toVarcharType = (VarcharType) toType;\n+            VarcharType fromVarcharType = (VarcharType) fromType;\n+\n+            if (narrowerThan(toVarcharType, fromVarcharType)) {\n+                return new VarcharCoercer(fromVarcharType, toVarcharType);\n+            }\n+\n+            // Coercion not worth the copying penalty when toType is wider\n+            return Function.identity();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk3NDg5NA==", "bodyText": "UNBOUNDED_LENGTH is not really a length limit (otherwise, why would we discern this as a special case?)\nwould\nif (first.isUnbounded() || second.isUnbounded()) {\n    return !first.isUnbounded();\n}\nreturn first.getBoundedLength() < second.getBoundedLength();\n\nwork?", "url": "https://github.com/trinodb/trino/pull/5530#discussion_r509974894", "createdAt": "2020-10-22T08:28:17Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HivePageSource.java", "diffHunk": "@@ -406,6 +418,13 @@ public ConnectorPageSource getPageSource()\n         throw new PrestoException(NOT_SUPPORTED, format(\"Unsupported coercion from %s to %s\", fromHiveType, toHiveType));\n     }\n \n+    public static boolean narrowerThan(VarcharType first, VarcharType second)\n+    {\n+        requireNonNull(first, \"first is null\");\n+        requireNonNull(second, \"second is null\");\n+        return first.getLength().orElse(VarcharType.UNBOUNDED_LENGTH) < second.getLength().orElse(VarcharType.UNBOUNDED_LENGTH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0581133e9535a3e9767d50c0952d5ada69ec5ed1", "author": {"user": {"login": "phd3", "name": "Pratham"}}, "url": "https://github.com/trinodb/trino/commit/0581133e9535a3e9767d50c0952d5ada69ec5ed1", "committedDate": "2020-10-23T22:28:20Z", "message": "Declare applyCoercedValue method as abstract"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6083d85724850467d81a5423077d853ea7cdd76b", "author": {"user": {"login": "phd3", "name": "Pratham"}}, "url": "https://github.com/trinodb/trino/commit/6083d85724850467d81a5423077d853ea7cdd76b", "committedDate": "2020-10-23T22:28:49Z", "message": "Support coercing varchar types in hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "6083d85724850467d81a5423077d853ea7cdd76b", "author": {"user": {"login": "phd3", "name": "Pratham"}}, "url": "https://github.com/trinodb/trino/commit/6083d85724850467d81a5423077d853ea7cdd76b", "committedDate": "2020-10-23T22:28:49Z", "message": "Support coercing varchar types in hive connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NjAzMDkx", "url": "https://github.com/trinodb/trino/pull/5530#pullrequestreview-516603091", "createdAt": "2020-10-26T09:37:05Z", "commit": {"oid": "6083d85724850467d81a5423077d853ea7cdd76b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3428, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}