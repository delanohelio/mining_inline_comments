{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYxODQxNzky", "number": 4669, "title": "Apply DomainTranslator to STARTS_WITH function", "bodyText": "", "createdAt": "2020-08-02T18:19:48Z", "url": "https://github.com/trinodb/trino/pull/4669", "merged": true, "mergeCommit": {"oid": "c56f90a98903399adb072873df97dc6a3a28fb5c"}, "closed": true, "closedAt": "2020-08-04T09:40:30Z", "author": {"login": "takezoe"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7HY9sgBqjM2MTM4NTk2OTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7jXO2AFqTQ2MDY1NjQ2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NzY1NjE2", "url": "https://github.com/trinodb/trino/pull/4669#pullrequestreview-459765616", "createdAt": "2020-08-03T06:01:47Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5ODUyNzA4", "url": "https://github.com/trinodb/trino/pull/4669#pullrequestreview-459852708", "createdAt": "2020-08-03T08:46:43Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwODo0Njo0NFrOG6xL7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwODo0OToxNFrOG6xRMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI3NjQ2MA==", "bodyText": "please extarct args.get(0) and args.get(1) as separate variables", "url": "https://github.com/trinodb/trino/pull/4669#discussion_r464276460", "createdAt": "2020-08-03T08:46:44Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/DomainTranslator.java", "diffHunk": "@@ -928,7 +931,55 @@ protected ExtractionResult visitLikePredicate(LikePredicate node, Boolean comple\n             }\n \n             Slice constantPrefix = LikeFunctions.unescapeLiteralLikePattern(pattern.slice(0, patternConstantPrefixBytes), escape);\n+            return createRangeDomain(type, constantPrefix).map(domain -> new ExtractionResult(TupleDomain.withColumnDomains(ImmutableMap.of(symbol, domain)), node));\n+        }\n+\n+        @Override\n+        protected ExtractionResult visitFunctionCall(FunctionCall node, Boolean complement)\n+        {\n+            String name = ResolvedFunction.extractFunctionName(node.getName());\n+            if (name.equals(\"starts_with\")) {\n+                Optional<ExtractionResult> result = tryVisitStartsWithFunction(node, complement);\n+                if (result.isPresent()) {\n+                    return result.get();\n+                }\n+            }\n+            return visitExpression(node, complement);\n+        }\n+\n+        private Optional<ExtractionResult> tryVisitStartsWithFunction(FunctionCall node, Boolean complement)\n+        {\n+            List<Expression> args = node.getArguments();\n+            if (args.size() != 2) {\n+                return Optional.empty();\n+            }\n+            if (!(args.get(0) instanceof SymbolReference)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI3NzgxMQ==", "bodyText": "add some edge cases like:\n\nempty pattern.\npattern with trailing spaces\npattern with escaped .* or /", "url": "https://github.com/trinodb/trino/pull/4669#discussion_r464277811", "createdAt": "2020-08-03T08:49:14Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestDomainTranslator.java", "diffHunk": "@@ -1582,6 +1582,30 @@ public void testLikePredicate()\n         assertUnsupportedPredicate(not(like(C_VARCHAR, stringLiteral(\"abc\\\\_def\"))));\n     }\n \n+    @Test\n+    public void testStartsWithFunction()\n+    {\n+        Type varcharType = createUnboundedVarcharType();\n+\n+        // constant\n+        testSimpleComparison(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 10}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMTA3MDU4", "url": "https://github.com/trinodb/trino/pull/4669#pullrequestreview-460107058", "createdAt": "2020-08-03T15:08:31Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNTowODozMVrOG69Whg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNTowODo0OFrOG69XKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ3NTc4Mg==", "bodyText": "What do these cases test? Unlike LIKE predicate, STARTS_WITH function always treats the second argument as a constant string. It doesn't care whether characters are escaped or not.\n\nYou are right.", "url": "https://github.com/trinodb/trino/pull/4669#discussion_r464475782", "createdAt": "2020-08-03T15:08:31Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestDomainTranslator.java", "diffHunk": "@@ -1582,6 +1582,30 @@ public void testLikePredicate()\n         assertUnsupportedPredicate(not(like(C_VARCHAR, stringLiteral(\"abc\\\\_def\"))));\n     }\n \n+    @Test\n+    public void testStartsWithFunction()\n+    {\n+        Type varcharType = createUnboundedVarcharType();\n+\n+        // constant\n+        testSimpleComparison(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI3NzgxMQ=="}, "originalCommit": null, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ3NTk0Ng==", "bodyText": "Could you add test for complement case?", "url": "https://github.com/trinodb/trino/pull/4669#discussion_r464475946", "createdAt": "2020-08-03T15:08:48Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestDomainTranslator.java", "diffHunk": "@@ -1582,6 +1582,39 @@ public void testLikePredicate()\n         assertUnsupportedPredicate(not(like(C_VARCHAR, stringLiteral(\"abc\\\\_def\"))));\n     }\n \n+    @Test\n+    public void testStartsWithFunction()\n+    {\n+        Type varcharType = createUnboundedVarcharType();\n+\n+        // constant\n+        testSimpleComparison(\n+                startsWith(C_VARCHAR, stringLiteral(\"abc\")),\n+                C_VARCHAR,\n+                startsWith(C_VARCHAR, stringLiteral(\"abc\")),\n+                Domain.create(ValueSet.ofRanges(Range.range(varcharType, utf8Slice(\"abc\"), true, utf8Slice(\"abd\"), false)), false));\n+\n+        testSimpleComparison(\n+                startsWith(C_VARCHAR, stringLiteral(\"_abc\")),\n+                C_VARCHAR,\n+                startsWith(C_VARCHAR, stringLiteral(\"_abc\")),\n+                Domain.create(ValueSet.ofRanges(Range.range(varcharType, utf8Slice(\"_abc\"), true, utf8Slice(\"_abd\"), false)), false));\n+\n+        // empty\n+        assertUnsupportedPredicate(startsWith(C_VARCHAR, stringLiteral(\"\")));\n+\n+        // non-ASCII\n+        testSimpleComparison(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMTA5MDM4", "url": "https://github.com/trinodb/trino/pull/4669#pullrequestreview-460109038", "createdAt": "2020-08-03T15:11:02Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNToxMTowMlrOG69chg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNToxMTowMlrOG69chg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ3NzMxOA==", "bodyText": "Could you add a test for generic function call (that it's not supported)?", "url": "https://github.com/trinodb/trino/pull/4669#discussion_r464477318", "createdAt": "2020-08-03T15:11:02Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestDomainTranslator.java", "diffHunk": "@@ -1582,6 +1582,39 @@ public void testLikePredicate()\n         assertUnsupportedPredicate(not(like(C_VARCHAR, stringLiteral(\"abc\\\\_def\"))));\n     }\n \n+    @Test\n+    public void testStartsWithFunction()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "990129e242961fc0603e186a746c4f53070efe55", "author": {"user": {"login": "takezoe", "name": "Naoki Takezoe"}}, "url": "https://github.com/trinodb/trino/commit/990129e242961fc0603e186a746c4f53070efe55", "committedDate": "2020-08-03T17:05:29Z", "message": "Apply DomainTranslator to STARTS_WITH function"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "990129e242961fc0603e186a746c4f53070efe55", "author": {"user": {"login": "takezoe", "name": "Naoki Takezoe"}}, "url": "https://github.com/trinodb/trino/commit/990129e242961fc0603e186a746c4f53070efe55", "committedDate": "2020-08-03T17:05:29Z", "message": "Apply DomainTranslator to STARTS_WITH function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNjU2NDYx", "url": "https://github.com/trinodb/trino/pull/4669#pullrequestreview-460656461", "createdAt": "2020-08-04T09:39:40Z", "commit": {"oid": "990129e242961fc0603e186a746c4f53070efe55"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4597, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}