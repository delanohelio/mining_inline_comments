{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2NzA0NDAx", "number": 6472, "title": "Fix operators that should be using IS NOT DISTINCT FROM rather than EQUALS", "bodyText": "We have a few operators that should be using IS NOT DISTINCT FROM rather than EQUALS to provide the proper grouping semantics. This results in queries incorrectly grouping values that are NaN, as well as structural types that contain null elements.", "createdAt": "2020-12-30T02:49:20Z", "url": "https://github.com/trinodb/trino/pull/6472", "merged": true, "mergeCommit": {"oid": "d4a909b2d860c8930b6f9cf5eba759ffde580961"}, "closed": true, "closedAt": "2021-01-07T12:29:34Z", "author": {"login": "erichwang"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdrNdPagFqTU1OTk5NDU5MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtxuQbAFqTU2MzM4MjQwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5OTk0NTkx", "url": "https://github.com/trinodb/trino/pull/6472#pullrequestreview-559994591", "createdAt": "2020-12-30T10:38:12Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMDozODoxM1rOIMpLzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMToxNTozMlrOIMq26g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDEyODU4OA==", "bodyText": "move it above other positionNotDistinctFromRow", "url": "https://github.com/trinodb/trino/pull/6472#discussion_r550128588", "createdAt": "2020-12-30T10:38:13Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/operator/PagesHashStrategy.java", "diffHunk": "@@ -59,6 +66,15 @@\n      */\n     boolean positionEqualsRow(int leftBlockIndex, int leftPosition, int rightPosition, Page rightPage);\n \n+    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE1MzE5NQ==", "bodyText": "add some nulls and NaNs to channel?", "url": "https://github.com/trinodb/trino/pull/6472#discussion_r550153195", "createdAt": "2020-12-30T11:11:36Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/gen/TestJoinCompiler.java", "diffHunk": "@@ -109,11 +111,15 @@ public void testSingleChannel(boolean hashEnabled)\n                     Block rightBlock = channel.get(rightBlockIndex);\n                     for (int rightBlockPosition = 0; rightBlockPosition < rightBlock.getPositionCount(); rightBlockPosition++) {\n                         boolean expected = equalOperator.equalNullSafe(leftBlock, leftBlockPosition, rightBlock, rightBlockPosition);\n+                        boolean expectedNotDistinct = !distinctFromOperator.isDistinctFrom(leftBlock, leftBlockPosition, rightBlock, rightBlockPosition);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE1NDY3Nw==", "bodyText": "missing nulls", "url": "https://github.com/trinodb/trino/pull/6472#discussion_r550154677", "createdAt": "2020-12-30T11:13:42Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/operator/TestStreamingAggregationOperator.java", "diffHunk": "@@ -92,37 +93,51 @@ public void tearDown()\n     @Test\n     public void test()\n     {\n-        RowPagesBuilder rowPagesBuilder = RowPagesBuilder.rowPagesBuilder(BOOLEAN, VARCHAR, BIGINT);\n+        OperatorFactory operatorFactory = StreamingAggregationOperator.createOperatorFactory(\n+                0,\n+                new PlanNodeId(\"test\"),\n+                ImmutableList.of(BOOLEAN, DOUBLE, BIGINT),\n+                ImmutableList.of(DOUBLE),\n+                ImmutableList.of(1),\n+                AggregationNode.Step.SINGLE,\n+                ImmutableList.of(COUNT.bind(ImmutableList.of(0), Optional.empty()),\n+                        LONG_SUM.bind(ImmutableList.of(2), Optional.empty())),\n+                new JoinCompiler(new TypeOperators()));\n+\n+        RowPagesBuilder rowPagesBuilder = RowPagesBuilder.rowPagesBuilder(BOOLEAN, DOUBLE, BIGINT);\n         List<Page> input = rowPagesBuilder\n                 .addSequencePage(3, 0, 0, 1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE1NjAxMA==", "bodyText": "please pick up #6462 as a prefix commit", "url": "https://github.com/trinodb/trino/pull/6472#discussion_r550156010", "createdAt": "2020-12-30T11:15:32Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/operator/TestWindowOperator.java", "diffHunk": "@@ -727,6 +731,67 @@ public void testFindEndPosition()\n         assertFindEndPosition(\"000000000000001111111111\", 14);\n     }\n \n+    @Test(dataProvider = \"spillEnabled\")\n+    public void testDistinctPartitionAndPeers(boolean spillEnabled, boolean revokeMemoryWhenAddingPages, long memoryLimit)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwMTk4NTU3", "url": "https://github.com/trinodb/trino/pull/6472#pullrequestreview-560198557", "createdAt": "2020-12-30T20:58:21Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "1db06839ce314af33871caea68ab7b6055ed6834", "author": {"user": {"login": "erichwang", "name": "Eric Hwang"}}, "url": "https://github.com/trinodb/trino/commit/1db06839ce314af33871caea68ab7b6055ed6834", "committedDate": "2021-01-05T16:07:20Z", "message": "Add NOT DISTINCT operations to PagesHashStrategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "609d39f59f36cd4c42057a1a646910aae2136ab8", "author": {"user": {"login": "erichwang", "name": "Eric Hwang"}}, "url": "https://github.com/trinodb/trino/commit/609d39f59f36cd4c42057a1a646910aae2136ab8", "committedDate": "2021-01-05T16:07:20Z", "message": "Fix StreamingAggregationOperator with proper DISTINCT grouping semantics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28cf83d4c871010ba2673e9009bc1008a1d5e8c3", "author": {"user": {"login": "erichwang", "name": "Eric Hwang"}}, "url": "https://github.com/trinodb/trino/commit/28cf83d4c871010ba2673e9009bc1008a1d5e8c3", "committedDate": "2021-01-05T16:07:20Z", "message": "Fix WindowOperator with proper DISTINCT peer group semantics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f00b28d9e16f87bea8426430adadc3cb720cc99", "author": {"user": {"login": "erichwang", "name": "Eric Hwang"}}, "url": "https://github.com/trinodb/trino/commit/8f00b28d9e16f87bea8426430adadc3cb720cc99", "committedDate": "2021-01-05T16:08:28Z", "message": "Revert \"Force TopNRankingOperator compatibility with current Window behavior\"\n\nThis reverts commit ade8af11027ce287df976a95137349ff49240365."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "8f00b28d9e16f87bea8426430adadc3cb720cc99", "author": {"user": {"login": "erichwang", "name": "Eric Hwang"}}, "url": "https://github.com/trinodb/trino/commit/8f00b28d9e16f87bea8426430adadc3cb720cc99", "committedDate": "2021-01-05T16:08:28Z", "message": "Revert \"Force TopNRankingOperator compatibility with current Window behavior\"\n\nThis reverts commit ade8af11027ce287df976a95137349ff49240365."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMzgyNDA0", "url": "https://github.com/trinodb/trino/pull/6472#pullrequestreview-563382404", "createdAt": "2021-01-07T10:39:32Z", "commit": {"oid": "8f00b28d9e16f87bea8426430adadc3cb720cc99"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMDozOTozMlrOIPnhpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMDozOTozMlrOIPnhpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI0NzE0Mg==", "bodyText": "commit message is too long", "url": "https://github.com/trinodb/trino/pull/6472#discussion_r553247142", "createdAt": "2021-01-07T10:39:32Z", "author": {"login": "sopel39"}, "path": "core/trino-main/src/main/java/io/trino/operator/GroupedTopNRankAccumulator.java", "diffHunk": "@@ -577,11 +577,11 @@ private IntegrityStats verifyHeapIntegrity(long groupId, long heapNodeIndex)\n         verify(actualPeerGroupCount == peerGroupCount, \"Recorded peer group count does not match actual\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f00b28d9e16f87bea8426430adadc3cb720cc99"}, "originalPosition": 1}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1786, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}