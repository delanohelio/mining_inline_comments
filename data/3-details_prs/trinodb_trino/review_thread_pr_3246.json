{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MjYzMDM4", "number": 3246, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwODozMjozOFrODr98cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwODozMjozOFrODr98cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NDMwMjU4OnYy", "diffSide": "RIGHT", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwODozMjozOFrOF8naGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDo1MToxM1rOF9tlCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEwNDUzNw==", "bodyText": "Can you please also add a test for procedure?\nAlso we have two access checks: one for function and one for procedure. So we need to be able to recognize if the routine is a function or procedure.", "url": "https://github.com/trinodb/trino/pull/3246#discussion_r399104537", "createdAt": "2020-03-27T08:32:38Z", "author": {"login": "kokosing"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -276,6 +277,13 @@ public void testReferencedTables()\n         ColumnInfo column = table.getColumns().get(0);\n         assertEquals(column.getColumn(), \"linenumber\");\n         assertTrue(column.getMasks().isEmpty());\n+\n+        List<RoutineInfo> routines = event.getMetadata().getRoutines();\n+        assertEquals(tables.size(), 1);\n+\n+        RoutineInfo routine = routines.get(0);\n+        assertEquals(routine.getRoutine(), \"sum\");\n+        assertEquals(routine.getAuthorization(), \"user\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2NjU0Ng==", "bodyText": "Also we have two access checks: one for function and one for procedure. So we need to be able to recognize if the routine is a function or procedure.\n\nWhy does it matter?", "url": "https://github.com/trinodb/trino/pull/3246#discussion_r399566546", "createdAt": "2020-03-27T22:28:52Z", "author": {"login": "martint"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -276,6 +277,13 @@ public void testReferencedTables()\n         ColumnInfo column = table.getColumns().get(0);\n         assertEquals(column.getColumn(), \"linenumber\");\n         assertTrue(column.getMasks().isEmpty());\n+\n+        List<RoutineInfo> routines = event.getMetadata().getRoutines();\n+        assertEquals(tables.size(), 1);\n+\n+        RoutineInfo routine = routines.get(0);\n+        assertEquals(routine.getRoutine(), \"sum\");\n+        assertEquals(routine.getAuthorization(), \"user\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEwNDUzNw=="}, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgyMjk3Nw==", "bodyText": "Can you please also add a test for procedure?\n\nUnfortunately, we don't have any infrastructure to test events for non-SQL tasks or register procedures with the testing query runners.", "url": "https://github.com/trinodb/trino/pull/3246#discussion_r399822977", "createdAt": "2020-03-29T16:46:29Z", "author": {"login": "martint"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -276,6 +277,13 @@ public void testReferencedTables()\n         ColumnInfo column = table.getColumns().get(0);\n         assertEquals(column.getColumn(), \"linenumber\");\n         assertTrue(column.getMasks().isEmpty());\n+\n+        List<RoutineInfo> routines = event.getMetadata().getRoutines();\n+        assertEquals(tables.size(), 1);\n+\n+        RoutineInfo routine = routines.get(0);\n+        assertEquals(routine.getRoutine(), \"sum\");\n+        assertEquals(routine.getAuthorization(), \"user\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEwNDUzNw=="}, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxMjA3OA==", "bodyText": "Why does it matter?\n\nWe have two access control checks. Same for tables and views. However we have single table info entity to handle tables and views. So let's leave it as is for now.", "url": "https://github.com/trinodb/trino/pull/3246#discussion_r400012078", "createdAt": "2020-03-30T08:27:56Z", "author": {"login": "kokosing"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -276,6 +277,13 @@ public void testReferencedTables()\n         ColumnInfo column = table.getColumns().get(0);\n         assertEquals(column.getColumn(), \"linenumber\");\n         assertTrue(column.getMasks().isEmpty());\n+\n+        List<RoutineInfo> routines = event.getMetadata().getRoutines();\n+        assertEquals(tables.size(), 1);\n+\n+        RoutineInfo routine = routines.get(0);\n+        assertEquals(routine.getRoutine(), \"sum\");\n+        assertEquals(routine.getAuthorization(), \"user\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEwNDUzNw=="}, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI1NDIxNg==", "bodyText": "Right, but to clarify, the contents in the event are not about the mechanics \"control checks\", but about the shape of the query. I.e., which tables/views and routines are accessed by the query using what user's identity -- whether that's performed by one or more concrete access check methods is orthogonal and an implementation detail of how the checks are performed. If those mechanics change in the future, the information in the event will remain the same.", "url": "https://github.com/trinodb/trino/pull/3246#discussion_r400254216", "createdAt": "2020-03-30T14:51:13Z", "author": {"login": "martint"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -276,6 +277,13 @@ public void testReferencedTables()\n         ColumnInfo column = table.getColumns().get(0);\n         assertEquals(column.getColumn(), \"linenumber\");\n         assertTrue(column.getMasks().isEmpty());\n+\n+        List<RoutineInfo> routines = event.getMetadata().getRoutines();\n+        assertEquals(tables.size(), 1);\n+\n+        RoutineInfo routine = routines.get(0);\n+        assertEquals(routine.getRoutine(), \"sum\");\n+        assertEquals(routine.getAuthorization(), \"user\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEwNDUzNw=="}, "originalCommit": null, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 500, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}