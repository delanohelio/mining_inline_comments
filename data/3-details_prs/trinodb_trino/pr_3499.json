{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2NzM0OTM3", "number": 3499, "title": "Allow INSERT statement for Cassandra table having hidden id column", "bodyText": "", "createdAt": "2020-04-21T15:06:07Z", "url": "https://github.com/trinodb/trino/pull/3499", "merged": true, "mergeCommit": {"oid": "8c9b40584ec5edb7bdde3adf0c8c97678e45a7c6"}, "closed": true, "closedAt": "2020-05-04T15:36:47Z", "author": {"login": "ebyhr"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaEvl5gFqTM5Nzk5ODExMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcd_lDxgBqjMyOTk4OTkxMTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3OTk4MTEz", "url": "https://github.com/trinodb/trino/pull/3499#pullrequestreview-397998113", "createdAt": "2020-04-22T09:15:07Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwOToxNTowN1rOGJsJJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwOToxODo1N1rOGJsT8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgxMzYwNg==", "bodyText": "Can you please name this test in a way that captures what is the functionality tested here. IMO testInsertToTableWithHiddenId would be better name.", "url": "https://github.com/trinodb/trino/pull/3499#discussion_r412813606", "createdAt": "2020-04-22T09:15:07Z", "author": {"login": "losipiuk"}, "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/TestCassandraIntegrationSmokeTest.java", "diffHunk": "@@ -165,6 +165,16 @@ public void testSelect()\n         assertSelect(TABLE_ALL_TYPES_PARTITION_KEY, false);\n     }\n \n+    @Test\n+    public void testCreateTable()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgxNTE3NQ==", "bodyText": "\"id\" literal appears in couple of places already. Can you please extract constant for that.", "url": "https://github.com/trinodb/trino/pull/3499#discussion_r412815175", "createdAt": "2020-04-22T09:17:14Z", "author": {"login": "losipiuk"}, "path": "presto-cassandra/src/main/java/io/prestosql/plugin/cassandra/CassandraMetadata.java", "diffHunk": "@@ -335,19 +335,32 @@ public ConnectorInsertTableHandle beginInsert(ConnectorSession session, Connecto\n \n         SchemaTableName schemaTableName = new SchemaTableName(table.getSchemaName(), table.getTableName());\n         List<CassandraColumnHandle> columns = cassandraSession.getTable(schemaTableName).getColumns();\n-        List<String> columnNames = columns.stream().map(CassandraColumnHandle::getName).collect(Collectors.toList());\n-        List<Type> columnTypes = columns.stream().map(CassandraColumnHandle::getType).collect(Collectors.toList());\n+        List<String> columnNames = columns.stream()\n+                .filter(columnHandle -> !isHiddenIdColumn(columnHandle))\n+                .map(CassandraColumnHandle::getName)\n+                .collect(Collectors.toList());\n+        List<Type> columnTypes = columns.stream()\n+                .filter(columnHandle -> !isHiddenIdColumn(columnHandle))\n+                .map(CassandraColumnHandle::getType)\n+                .collect(Collectors.toList());\n+        boolean generateUuid = columns.stream().anyMatch(CassandraMetadata::isHiddenIdColumn);\n \n         return new CassandraInsertTableHandle(\n                 table.getSchemaName(),\n                 table.getTableName(),\n                 columnNames,\n-                columnTypes);\n+                columnTypes,\n+                generateUuid);\n     }\n \n     @Override\n     public Optional<ConnectorOutputMetadata> finishInsert(ConnectorSession session, ConnectorInsertTableHandle insertHandle, Collection<Slice> fragments, Collection<ComputedStatistics> computedStatistics)\n     {\n         return Optional.empty();\n     }\n+\n+    private static boolean isHiddenIdColumn(CassandraColumnHandle columnHandle)\n+    {\n+        return columnHandle.isHidden() && \"id\".equals(columnHandle.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgxNjM3MQ==", "bodyText": "Not sure what is proper casing according to code-style but CassandraPageSing uses generateUUID. Can you please unify?", "url": "https://github.com/trinodb/trino/pull/3499#discussion_r412816371", "createdAt": "2020-04-22T09:18:57Z", "author": {"login": "losipiuk"}, "path": "presto-cassandra/src/main/java/io/prestosql/plugin/cassandra/CassandraPageSinkProvider.java", "diffHunk": "@@ -67,6 +67,6 @@ public ConnectorPageSink createPageSink(ConnectorTransactionHandle transactionHa\n                 handle.getTableName(),\n                 handle.getColumnNames(),\n                 handle.getColumnTypes(),\n-                false);\n+                handle.isGenerateUuid());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d80a498b33c45b27a1c7a6ae36847d18aaba9073", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/d80a498b33c45b27a1c7a6ae36847d18aaba9073", "committedDate": "2020-04-22T13:49:32Z", "message": "Rename variable name and extract id column name in Cassandra"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NjUwMDc5", "url": "https://github.com/trinodb/trino/pull/3499#pullrequestreview-404650079", "createdAt": "2020-05-03T19:32:24Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxOTozMjoyNFrOGPuzRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxOTozMjoyNFrOGPuzRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE0ODYxNQ==", "bodyText": "Can there be more than one?", "url": "https://github.com/trinodb/trino/pull/3499#discussion_r419148615", "createdAt": "2020-05-03T19:32:24Z", "author": {"login": "findepi"}, "path": "presto-cassandra/src/main/java/io/prestosql/plugin/cassandra/CassandraMetadata.java", "diffHunk": "@@ -336,19 +336,32 @@ public ConnectorInsertTableHandle beginInsert(ConnectorSession session, Connecto\n \n         SchemaTableName schemaTableName = new SchemaTableName(table.getSchemaName(), table.getTableName());\n         List<CassandraColumnHandle> columns = cassandraSession.getTable(schemaTableName).getColumns();\n-        List<String> columnNames = columns.stream().map(CassandraColumnHandle::getName).collect(Collectors.toList());\n-        List<Type> columnTypes = columns.stream().map(CassandraColumnHandle::getType).collect(Collectors.toList());\n+        List<String> columnNames = columns.stream()\n+                .filter(columnHandle -> !isHiddenIdColumn(columnHandle))\n+                .map(CassandraColumnHandle::getName)\n+                .collect(Collectors.toList());\n+        List<Type> columnTypes = columns.stream()\n+                .filter(columnHandle -> !isHiddenIdColumn(columnHandle))\n+                .map(CassandraColumnHandle::getType)\n+                .collect(Collectors.toList());\n+        boolean generateUuid = columns.stream().anyMatch(CassandraMetadata::isHiddenIdColumn);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9664f48170539fd9b10de87397b921db07353491", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/9664f48170539fd9b10de87397b921db07353491", "committedDate": "2020-05-04T13:33:48Z", "message": "Allow INSERT statement for Cassandra table having hidden id column"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "9664f48170539fd9b10de87397b921db07353491", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/9664f48170539fd9b10de87397b921db07353491", "committedDate": "2020-05-04T13:33:48Z", "message": "Allow INSERT statement for Cassandra table having hidden id column"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1603, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}