{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5NTU4MzAx", "number": 4458, "title": "Expose CachingHiveMetastore metrics via JMX", "bodyText": "Fixes #4449\npresto.plugin.hive.metastore.cache:name=hive,type=cachinghivemetastore used to look like:\npresto> select * from jmx.current.\"presto.plugin.hive.metastore.cache:name=hive,type=cachinghivemetastore\" \\G;\n-[ RECORD 1 ]-------------------------+-----------------------------------------------------------------------\nnode                                  | ffffffff-ffff-ffff-ffff-ffffffffffff\nobject_name                           | presto.plugin.hive.metastore.cache:type=CachingHiveMetastore,name=hive\n\nAfter this change:\npresto> select * from jmx.current.\"presto.plugin.hive.metastore.cache:name=hive,type=cachinghivemetastore\" \\G;\n-[ RECORD 1 ]-------------------------+-----------------------------------------------------------------------\nconfigvaluesstats.hitrate             | 1.0\nconfigvaluesstats.missrate            | 0.0\nconfigvaluesstats.requestcount        | 0\ndatabasenamesstats.hitrate            | 1.0\ndatabasenamesstats.missrate           | 0.0\ndatabasenamesstats.requestcount       | 0\ndatabasestats.hitrate                 | 1.0\ndatabasestats.missrate                | 0.0\ndatabasestats.requestcount            | 0\ngrantedprincipalsstats.hitrate        | 1.0\ngrantedprincipalsstats.missrate       | 0.0\ngrantedprincipalsstats.requestcount   | 0\npartitionfilterstats.hitrate          | 0.0\npartitionfilterstats.missrate         | 1.0\npartitionfilterstats.requestcount     | 1\npartitionnamesstats.hitrate           | 1.0\npartitionnamesstats.missrate          | 0.0\npartitionnamesstats.requestcount      | 0\npartitionstatisticsstats.hitrate      | 1.0\npartitionstatisticsstats.missrate     | 0.0\npartitionstatisticsstats.requestcount | 0\npartitionstats.hitrate                | 0.0\npartitionstats.missrate               | 1.0\npartitionstats.requestcount           | 70\nrolegrantsstats.hitrate               | 1.0\nrolegrantsstats.missrate              | 0.0\nrolegrantsstats.requestcount          | 0\nrolesstats.hitrate                    | 1.0\nrolesstats.missrate                   | 0.0\nrolesstats.requestcount               | 0\ntablenamesstats.hitrate               | 1.0\ntablenamesstats.missrate              | 0.0\ntablenamesstats.requestcount          | 0\ntableprivilegesstats.hitrate          | 1.0\ntableprivilegesstats.missrate         | 0.0\ntableprivilegesstats.requestcount     | 0\ntablestatisticsstats.hitrate          | 1.0\ntablestatisticsstats.missrate         | 0.0\ntablestatisticsstats.requestcount     | 0\ntablestats.hitrate                    | 0.6\ntablestats.missrate                   | 0.4\ntablestats.requestcount               | 5\ntablewithparameterstats.hitrate       | 1.0\ntablewithparameterstats.missrate      | 0.0\ntablewithparameterstats.requestcount  | 0\nviewnamesstats.hitrate                | 1.0\nviewnamesstats.missrate               | 0.0\nviewnamesstats.requestcount           | 0\nnode                                  | ffffffff-ffff-ffff-ffff-ffffffffffff\nobject_name                           | presto.plugin.hive.metastore.cache:type=CachingHiveMetastore,name=hive\n\nThe change allows to look inside of the CachingHiveMetastore and tune https://prestosql.io/docs/current/connector/hive.html#hive-metastore-configuration-properties", "createdAt": "2020-07-15T15:28:20Z", "url": "https://github.com/trinodb/trino/pull/4458", "merged": true, "mergeCommit": {"oid": "f4f1ea47c9f034bfc07b52065a9f798ece2fc629"}, "closed": true, "closedAt": "2020-08-07T07:52:00Z", "author": {"login": "kosinsky"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1a7NEAFqTQ0OTYyODE4NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8Ul8WgBqjM2MzA0NDE0NzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NjI4MTg1", "url": "https://github.com/trinodb/trino/pull/4458#pullrequestreview-449628185", "createdAt": "2020-07-16T08:25:09Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODoyNToxMFrOGygZfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODoyNTo0NlrOGygbHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxMjc5OQ==", "bodyText": "please move it above to other compile scope airlift dependencies", "url": "https://github.com/trinodb/trino/pull/4458#discussion_r455612799", "createdAt": "2020-07-16T08:25:10Z", "author": {"login": "kokosing"}, "path": "presto-hive/pom.xml", "diffHunk": "@@ -351,6 +351,10 @@\n             <artifactId>jmh-generator-annprocess</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>io.airlift</groupId>\n+            <artifactId>jmx</artifactId>\n+        </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxMzA0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    cacheBuilder = cacheBuilder.maximumSize(maximumSize);\n          \n          \n            \n                    cacheBuilder.recordStats();\n          \n          \n            \n                    cacheBuilder = cacheBuilder.maximumSize(maximumSize)\n          \n          \n            \n                        .recordStats();", "url": "https://github.com/trinodb/trino/pull/4458#discussion_r455613041", "createdAt": "2020-07-16T08:25:30Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/CachingHiveMetastore.java", "diffHunk": "@@ -949,6 +951,7 @@ public boolean isImpersonationEnabled()\n             cacheBuilder = cacheBuilder.refreshAfterWrite(refreshMillis.getAsLong(), MILLISECONDS);\n         }\n         cacheBuilder = cacheBuilder.maximumSize(maximumSize);\n+        cacheBuilder.recordStats();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxMzIxMg==", "bodyText": "Does it have influence on performance?", "url": "https://github.com/trinodb/trino/pull/4458#discussion_r455613212", "createdAt": "2020-07-16T08:25:46Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/CachingHiveMetastore.java", "diffHunk": "@@ -949,6 +951,7 @@ public boolean isImpersonationEnabled()\n             cacheBuilder = cacheBuilder.refreshAfterWrite(refreshMillis.getAsLong(), MILLISECONDS);\n         }\n         cacheBuilder = cacheBuilder.maximumSize(maximumSize);\n+        cacheBuilder.recordStats();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxMzA0MQ=="}, "originalCommit": null, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxODcwMTk2", "url": "https://github.com/trinodb/trino/pull/4458#pullrequestreview-451870196", "createdAt": "2020-07-20T18:50:02Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxODo1MDowMlrOG0a8hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxODo1MDowMlrOG0a8hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYyMDYxNQ==", "bodyText": "please only records stats for caching metastore between transactions. Do not enable it for transactional caching metastore (the one which is created per each transaction).", "url": "https://github.com/trinodb/trino/pull/4458#discussion_r457620615", "createdAt": "2020-07-20T18:50:02Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/CachingHiveMetastore.java", "diffHunk": "@@ -948,7 +950,8 @@ public boolean isImpersonationEnabled()\n         if (refreshMillis.isPresent() && (expiresAfterWriteMillis.isEmpty() || expiresAfterWriteMillis.getAsLong() > refreshMillis.getAsLong())) {\n             cacheBuilder = cacheBuilder.refreshAfterWrite(refreshMillis.getAsLong(), MILLISECONDS);\n         }\n-        cacheBuilder = cacheBuilder.maximumSize(maximumSize);\n+        cacheBuilder = cacheBuilder.maximumSize(maximumSize)\n+            .recordStats();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMjgxOTg0", "url": "https://github.com/trinodb/trino/pull/4458#pullrequestreview-462281984", "createdAt": "2020-08-06T08:09:16Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwODowOToxNlrOG8oC1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwODowOToxNlrOG8oC1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjIyMzgyOA==", "bodyText": "Please define an enum. That way it will be much more readable when you pass STATS_RECORDING_ENABLED (or StatsRecording.ENABLED) instead of true.", "url": "https://github.com/trinodb/trino/pull/4458#discussion_r466223828", "createdAt": "2020-08-06T08:09:16Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/cache/CachingHiveMetastore.java", "diffHunk": "@@ -132,7 +134,8 @@ public static HiveMetastore cachingHiveMetastore(HiveMetastore delegate, Executo\n                         .map(Duration::toMillis)\n                         .map(OptionalLong::of)\n                         .orElseGet(OptionalLong::empty),\n-                maximumSize);\n+                maximumSize,\n+                true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e19cde4bc08bc62fea282f2e415a021ce2a56f7", "author": {"user": {"login": "kosinsky", "name": "Konstantin Kosinsky"}}, "url": "https://github.com/trinodb/trino/commit/8e19cde4bc08bc62fea282f2e415a021ce2a56f7", "committedDate": "2020-08-06T18:59:41Z", "message": "Expose CachingHiveMetastore metrics via JMX"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "8e19cde4bc08bc62fea282f2e415a021ce2a56f7", "author": {"user": {"login": "kosinsky", "name": "Konstantin Kosinsky"}}, "url": "https://github.com/trinodb/trino/commit/8e19cde4bc08bc62fea282f2e415a021ce2a56f7", "committedDate": "2020-08-06T18:59:41Z", "message": "Expose CachingHiveMetastore metrics via JMX"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4696, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}