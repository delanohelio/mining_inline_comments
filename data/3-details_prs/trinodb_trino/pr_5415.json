{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3ODE0MDQy", "number": 5415, "title": "Do not stop attached environment", "bodyText": "Do not stop attached environment\nEnvironment to which test run is attaching is controlled by separate\nprocess and so it should be stopped by that process.\nThanks to this environment can be reused multiple times.", "createdAt": "2020-10-05T12:21:49Z", "url": "https://github.com/trinodb/trino/pull/5415", "merged": true, "mergeCommit": {"oid": "ce97ec8ca51ba18f2d8d07f05049d2824282fc49"}, "closed": true, "closedAt": "2020-10-06T07:23:56Z", "author": {"login": "kokosing"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPjHXGgFqTUwMjAxMzMxNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPzF9ZAFqTUwMjY0NjMwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDEzMzE2", "url": "https://github.com/trinodb/trino/pull/5415#pullrequestreview-502013316", "createdAt": "2020-10-05T12:40:49Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMjo0MDo0OVrOHcbL8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMjo0MDo0OVrOHcbL8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU2NzYwMw==", "bodyText": "does it relly solve Could not attach tests to unhealthy environment xxxxxxx???\nnothing was stopped at my machine, containers were still working as expected, the problem was somewhere in allCOntainersHealthy probably", "url": "https://github.com/trinodb/trino/pull/5415#discussion_r499567603", "createdAt": "2020-10-05T12:40:49Z", "author": {"login": "iirekm"}, "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -150,6 +157,11 @@ private Environment tryStart()\n \n     public void stop()\n     {\n+        if (attached) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDk2MTEx", "url": "https://github.com/trinodb/trino/pull/5415#pullrequestreview-502096111", "createdAt": "2020-10-05T14:10:34Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMTIzNTY3", "url": "https://github.com/trinodb/trino/pull/5415#pullrequestreview-502123567", "createdAt": "2020-10-05T14:37:24Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDozNzoyNFrOHcgEYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDozOToxNlrOHcgJ0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0NzU4Nw==", "bodyText": "unrelated", "url": "https://github.com/trinodb/trino/pull/5415#discussion_r499647587", "createdAt": "2020-10-05T14:37:24Z", "author": {"login": "findepi"}, "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -383,10 +395,10 @@ private static void setContainerAutoRemove(CreateContainerCmd createContainerCmd\n         private static List<Ulimit> standardUlimits()\n         {\n             return ImmutableList.of(\n-                // Number of open file descriptors\n-                new Ulimit(\"nofile\", 65535L, 65535L),\n-                // Number of processes\n-                new Ulimit(\"nproc\", 8096L, 8096L));\n+                    // Number of open file descriptors\n+                    new Ulimit(\"nofile\", 65535L, 65535L),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0ODk3Ng==", "bodyText": "The fact that stop does not stop is not intuitive.\nperhaps, make it throw illegal state and update  test attach not to call stop, if there is nothing to stop.\nor, just change the test attach flow and then no changes needed in Env clas\nalso, can the test container leak in test attach mode?\n(i hope it's controller by ryuk and \"safe to leak\")", "url": "https://github.com/trinodb/trino/pull/5415#discussion_r499648976", "createdAt": "2020-10-05T14:39:16Z", "author": {"login": "findepi"}, "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -150,6 +157,11 @@ private Environment tryStart()\n \n     public void stop()\n     {\n+        if (attached) {\n+            // do not stop attached, externally controlled environment", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMzQ4OTcw", "url": "https://github.com/trinodb/trino/pull/5415#pullrequestreview-502348970", "createdAt": "2020-10-05T19:19:00Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxOToxOTowMVrOHcqcfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxOToxOTowMVrOHcqcfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgxNzU5OQ==", "bodyText": "can you add .setAttached() method to Builder instead?", "url": "https://github.com/trinodb/trino/pull/5415#discussion_r499817599", "createdAt": "2020-10-05T19:19:01Z", "author": {"login": "wendigo"}, "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/cli/EnvironmentUp.java", "diffHunk": "@@ -144,7 +144,7 @@ public Integer call()\n                 builder.configureContainers(Standard::enablePrestoJavaDebugger);\n             }\n \n-            Environment environment = builder.build(getStandardListeners(environmentLogPath));\n+            Environment environment = builder.build(getStandardListeners(environmentLogPath), false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMzY5MTk3", "url": "https://github.com/trinodb/trino/pull/5415#pullrequestreview-502369197", "createdAt": "2020-10-05T19:49:00Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98b371350a4a4a28ab4916f9b85389398b1fb624", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/98b371350a4a4a28ab4916f9b85389398b1fb624", "committedDate": "2020-10-05T20:27:40Z", "message": "Fix indentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62518aa56ccfb04e3cf627df0b1a9d9f2a7b81ea", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/62518aa56ccfb04e3cf627df0b1a9d9f2a7b81ea", "committedDate": "2020-10-05T20:27:41Z", "message": "Do not stop attached environment\n\nEnvironment to which `test run` is attaching is controlled by separate\nprocess and so it should be stopped by that process.\nThanks to this environment can be reused multiple times."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e36bf343fd321d24e572338b37e85611d1c8264e", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/e36bf343fd321d24e572338b37e85611d1c8264e", "committedDate": "2020-10-05T20:27:43Z", "message": "Do not check attached containers health\n\nHealth of these containers is checked by the origin process that\ncontrols them."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMzc5NDQ4", "url": "https://github.com/trinodb/trino/pull/5415#pullrequestreview-502379448", "createdAt": "2020-10-05T20:03:49Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMDowMzo0OVrOHcr2DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMDowMzo0OVrOHcr2DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg0MDUyNA==", "bodyText": "I tested it and it was cleared. I will test it more with interruptions.\n\nIt works as expected.", "url": "https://github.com/trinodb/trino/pull/5415#discussion_r499840524", "createdAt": "2020-10-05T20:03:49Z", "author": {"login": "kokosing"}, "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -150,6 +157,11 @@ private Environment tryStart()\n \n     public void stop()\n     {\n+        if (attached) {\n+            // do not stop attached, externally controlled environment", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0ODk3Ng=="}, "originalCommit": null, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "e36bf343fd321d24e572338b37e85611d1c8264e", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/e36bf343fd321d24e572338b37e85611d1c8264e", "committedDate": "2020-10-05T20:27:43Z", "message": "Do not check attached containers health\n\nHealth of these containers is checked by the origin process that\ncontrols them."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNjQ2MzAy", "url": "https://github.com/trinodb/trino/pull/5415#pullrequestreview-502646302", "createdAt": "2020-10-06T07:17:46Z", "commit": {"oid": "e36bf343fd321d24e572338b37e85611d1c8264e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3254, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}