{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MTQ1MjEx", "number": 3735, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMzoyMzo1MlrOD8rleQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMTo1MjoxMVrOD8tIRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0OTU1MjU3OnYy", "diffSide": "RIGHT", "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/ElasticsearchMetadata.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMzoyMzo1MlrOGVxcYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMzoyMzo1MlrOGVxcYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ4MzM2MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (handle.getType().equals(QUERY)) {\n          \n          \n            \n                    if (handle.getType() == QUERY) {\n          \n      \n    \n    \n  \n\nOr perhaps a helper method like isPassthroughQuery() would aid readability, since this test shows up in a few places.", "url": "https://github.com/trinodb/trino/pull/3735#discussion_r425483360", "createdAt": "2020-05-14T23:23:52Z", "author": {"login": "aalbu"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/ElasticsearchMetadata.java", "diffHunk": "@@ -115,37 +163,84 @@ public ElasticsearchTableHandle getTableHandle(ConnectorSession session, SchemaT\n     public ConnectorTableMetadata getTableMetadata(ConnectorSession session, ConnectorTableHandle table)\n     {\n         ElasticsearchTableHandle handle = (ElasticsearchTableHandle) table;\n+\n+        if (handle.getType().equals(QUERY)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0OTYxMzg1OnYy", "diffSide": "RIGHT", "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/client/ElasticsearchClient.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMzo1ODoyMFrOGVyClQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMjo1ODowMFrOGV01Ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ5MzE0MQ==", "bodyText": "Using pretty is going to make the response bigger.", "url": "https://github.com/trinodb/trino/pull/3735#discussion_r425493141", "createdAt": "2020-05-14T23:58:20Z", "author": {"login": "aalbu"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/client/ElasticsearchClient.java", "diffHunk": "@@ -530,6 +532,36 @@ private JsonNode nullSafeNode(JsonNode jsonNode, String name)\n         return jsonNode.get(name);\n     }\n \n+    public String executeQuery(String index, String query)\n+    {\n+        String path = format(\"/%s/_search?pretty\", index);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUyNDAzMw==", "bodyText": "Only one byte per line :)\nIt makes it much easier to debug issues, so all things considered, it's not a big deal.", "url": "https://github.com/trinodb/trino/pull/3735#discussion_r425524033", "createdAt": "2020-05-15T01:57:34Z", "author": {"login": "martint"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/client/ElasticsearchClient.java", "diffHunk": "@@ -530,6 +532,36 @@ private JsonNode nullSafeNode(JsonNode jsonNode, String name)\n         return jsonNode.get(name);\n     }\n \n+    public String executeQuery(String index, String query)\n+    {\n+        String path = format(\"/%s/_search?pretty\", index);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ5MzE0MQ=="}, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUzMzIzNQ==", "bodyText": "Don't forget the spaces added for indentation.  I think the size difference can be considerable (I've compared responses of some searches I was playing with and I saw a factor of 2x).", "url": "https://github.com/trinodb/trino/pull/3735#discussion_r425533235", "createdAt": "2020-05-15T02:35:03Z", "author": {"login": "aalbu"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/client/ElasticsearchClient.java", "diffHunk": "@@ -530,6 +532,36 @@ private JsonNode nullSafeNode(JsonNode jsonNode, String name)\n         return jsonNode.get(name);\n     }\n \n+    public String executeQuery(String index, String query)\n+    {\n+        String path = format(\"/%s/_search?pretty\", index);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ5MzE0MQ=="}, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUzODg3NQ==", "bodyText": "Tthat's a good point. I'll change it.", "url": "https://github.com/trinodb/trino/pull/3735#discussion_r425538875", "createdAt": "2020-05-15T02:58:00Z", "author": {"login": "martint"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/client/ElasticsearchClient.java", "diffHunk": "@@ -530,6 +532,36 @@ private JsonNode nullSafeNode(JsonNode jsonNode, String name)\n         return jsonNode.get(name);\n     }\n \n+    public String executeQuery(String index, String query)\n+    {\n+        String path = format(\"/%s/_search?pretty\", index);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ5MzE0MQ=="}, "originalCommit": null, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0OTY1ODQwOnYy", "diffSide": "RIGHT", "path": "presto-elasticsearch/src/test/java/io/prestosql/elasticsearch/BaseElasticsearchSmokeTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMDoyMzoxMVrOGVydVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMTo1ODo1MlrOGVz8dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ5OTk5MQ==", "bodyText": "It seems more expressive use the equivalent SQL query for expected: SELECT max(orderkey), sum(orderkey) FROM orders", "url": "https://github.com/trinodb/trino/pull/3735#discussion_r425499991", "createdAt": "2020-05-15T00:23:11Z", "author": {"login": "aalbu"}, "path": "presto-elasticsearch/src/test/java/io/prestosql/elasticsearch/BaseElasticsearchSmokeTest.java", "diffHunk": "@@ -747,6 +749,27 @@ public void testMultiIndexAlias()\n                 \"SELECT (SELECT count(*) FROM region) + (SELECT count(*) FROM nation)\");\n     }\n \n+    @Test\n+    public void testPassthroughQuery()\n+    {\n+        @Language(\"JSON\")\n+        String query = \"{\\n\" +\n+                \"    \\\"size\\\": 0,\\n\" +\n+                \"    \\\"aggs\\\" : {\\n\" +\n+                \"        \\\"max_orderkey\\\" : { \\\"max\\\" : { \\\"field\\\" : \\\"orderkey\\\" } },\\n\" +\n+                \"        \\\"sum_orderkey\\\" : { \\\"sum\\\" : { \\\"field\\\" : \\\"orderkey\\\" } }\\n\" +\n+                \"    }\\n\" +\n+                \"}\";\n+\n+        assertQuery(\n+                format(\"WITH data(r) AS (\" +\n+                        \"   SELECT CAST(result AS ROW(aggregations ROW(max_orderkey ROW(value BIGINT), sum_orderkey ROW(value BIGINT)))) \" +\n+                        \"   FROM \\\"orders$query:%s\\\") \" +\n+                        \"SELECT r.aggregations.max_orderkey.value, r.aggregations.sum_orderkey.value \" +\n+                        \"FROM data\", BaseEncoding.base32().encode(query.getBytes(UTF_8))),\n+                \"VALUES (60000, 449872500)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUyNDM0Mw==", "bodyText": "I know. The purpose of this is not to test that complex ES queries work, but that passthrough queries work. It doesn't matter what, as long as it does the full roundtrip.", "url": "https://github.com/trinodb/trino/pull/3735#discussion_r425524343", "createdAt": "2020-05-15T01:58:52Z", "author": {"login": "martint"}, "path": "presto-elasticsearch/src/test/java/io/prestosql/elasticsearch/BaseElasticsearchSmokeTest.java", "diffHunk": "@@ -747,6 +749,27 @@ public void testMultiIndexAlias()\n                 \"SELECT (SELECT count(*) FROM region) + (SELECT count(*) FROM nation)\");\n     }\n \n+    @Test\n+    public void testPassthroughQuery()\n+    {\n+        @Language(\"JSON\")\n+        String query = \"{\\n\" +\n+                \"    \\\"size\\\": 0,\\n\" +\n+                \"    \\\"aggs\\\" : {\\n\" +\n+                \"        \\\"max_orderkey\\\" : { \\\"max\\\" : { \\\"field\\\" : \\\"orderkey\\\" } },\\n\" +\n+                \"        \\\"sum_orderkey\\\" : { \\\"sum\\\" : { \\\"field\\\" : \\\"orderkey\\\" } }\\n\" +\n+                \"    }\\n\" +\n+                \"}\";\n+\n+        assertQuery(\n+                format(\"WITH data(r) AS (\" +\n+                        \"   SELECT CAST(result AS ROW(aggregations ROW(max_orderkey ROW(value BIGINT), sum_orderkey ROW(value BIGINT)))) \" +\n+                        \"   FROM \\\"orders$query:%s\\\") \" +\n+                        \"SELECT r.aggregations.max_orderkey.value, r.aggregations.sum_orderkey.value \" +\n+                        \"FROM data\", BaseEncoding.base32().encode(query.getBytes(UTF_8))),\n+                \"VALUES (60000, 449872500)\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ5OTk5MQ=="}, "originalCommit": null, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0OTc4NDQ2OnYy", "diffSide": "RIGHT", "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/ElasticsearchMetadata.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMTozOToyMVrOGVzpSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMjowMjo1M1rOGV0Aaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUxOTQzNA==", "bodyText": "I was thinking about the relative advantages of using JSON vs VARCHAR for the column type.  JSON is more expressive (one might even argue correctness), but without knowing how a client might use the result, VARCHAR might be more pragmatic.  I think it's conceivable one might want to parse and process the results of an aggregation client side, so they might end up serializing the result and reading the resulting string.  The responses can get pretty big and the cost of parsing a big JSON document might not be insignificant.  On the other hand, if a client wanted to join the aggregation result with some other table, they'd only need to call json_parse(result).", "url": "https://github.com/trinodb/trino/pull/3735#discussion_r425519434", "createdAt": "2020-05-15T01:39:21Z", "author": {"login": "aalbu"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/ElasticsearchMetadata.java", "diffHunk": "@@ -79,6 +95,16 @@ public ElasticsearchMetadata(TypeManager typeManager, ElasticsearchClient client\n         this.client = requireNonNull(client, \"client is null\");\n         requireNonNull(config, \"config is null\");\n         this.schemaName = config.getDefaultSchema();\n+\n+        Type jsonType = typeManager.getType(new TypeSignature(StandardTypes.JSON));\n+        queryResultColumnMetadata = ColumnMetadata.builder()\n+                .setName(\"result\")\n+                .setType(jsonType)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUyNTM1NQ==", "bodyText": "I started with VARCHAR and then ended up changing it to JSON. In practice, I expect almost all usages to try to do something with the result as a JSON object. Parsing the result client side is a very roundabout way of interacting with ES. You might as well talk to it directly.\nIf you need the text, just use json_format. It's actually free under the covers, as the internal representation of the JSON type is the json string.", "url": "https://github.com/trinodb/trino/pull/3735#discussion_r425525355", "createdAt": "2020-05-15T02:02:53Z", "author": {"login": "martint"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/ElasticsearchMetadata.java", "diffHunk": "@@ -79,6 +95,16 @@ public ElasticsearchMetadata(TypeManager typeManager, ElasticsearchClient client\n         this.client = requireNonNull(client, \"client is null\");\n         requireNonNull(config, \"config is null\");\n         this.schemaName = config.getDefaultSchema();\n+\n+        Type jsonType = typeManager.getType(new TypeSignature(StandardTypes.JSON));\n+        queryResultColumnMetadata = ColumnMetadata.builder()\n+                .setName(\"result\")\n+                .setType(jsonType)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUxOTQzNA=="}, "originalCommit": null, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0OTgwNTQ5OnYy", "diffSide": "RIGHT", "path": "presto-elasticsearch/src/test/java/io/prestosql/elasticsearch/BaseElasticsearchSmokeTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMTo1MjoxMVrOGVz1-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMTo1MjoxMVrOGVz1-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUyMjY4Mg==", "bodyText": "Perhaps a test for an invalid query?", "url": "https://github.com/trinodb/trino/pull/3735#discussion_r425522682", "createdAt": "2020-05-15T01:52:11Z", "author": {"login": "aalbu"}, "path": "presto-elasticsearch/src/test/java/io/prestosql/elasticsearch/BaseElasticsearchSmokeTest.java", "diffHunk": "@@ -747,6 +749,27 @@ public void testMultiIndexAlias()\n                 \"SELECT (SELECT count(*) FROM region) + (SELECT count(*) FROM nation)\");\n     }\n \n+    @Test\n+    public void testPassthroughQuery()\n+    {\n+        @Language(\"JSON\")\n+        String query = \"{\\n\" +\n+                \"    \\\"size\\\": 0,\\n\" +\n+                \"    \\\"aggs\\\" : {\\n\" +\n+                \"        \\\"max_orderkey\\\" : { \\\"max\\\" : { \\\"field\\\" : \\\"orderkey\\\" } },\\n\" +\n+                \"        \\\"sum_orderkey\\\" : { \\\"sum\\\" : { \\\"field\\\" : \\\"orderkey\\\" } }\\n\" +\n+                \"    }\\n\" +\n+                \"}\";\n+\n+        assertQuery(\n+                format(\"WITH data(r) AS (\" +\n+                        \"   SELECT CAST(result AS ROW(aggregations ROW(max_orderkey ROW(value BIGINT), sum_orderkey ROW(value BIGINT)))) \" +\n+                        \"   FROM \\\"orders$query:%s\\\") \" +\n+                        \"SELECT r.aggregations.max_orderkey.value, r.aggregations.sum_orderkey.value \" +\n+                        \"FROM data\", BaseEncoding.base32().encode(query.getBytes(UTF_8))),\n+                \"VALUES (60000, 449872500)\");\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4821, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}