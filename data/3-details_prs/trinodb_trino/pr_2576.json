{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1Nzc2MTIz", "number": 2576, "title": "Join minor cleanups", "bodyText": "", "createdAt": "2020-01-22T10:27:25Z", "url": "https://github.com/trinodb/trino/pull/2576", "merged": true, "mergeCommit": {"oid": "529402fe7b9ad75203f16d30713212d9fe13952f"}, "closed": true, "closedAt": "2020-02-05T11:53:15Z", "author": {"login": "sopel39"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8zAJLAH2gAyMzY1Nzc2MTIzOjY5YmU5YjA4MDg2ZDFiYzdhZDdmYWUzOTZmNjc2YTIyY2Y0Y2RiNTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBUkmUgFqTM1MzY1MDQ2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "69be9b08086d1bc7ad7fae396f676a22cf4cdb56", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/69be9b08086d1bc7ad7fae396f676a22cf4cdb56", "committedDate": "2020-01-22T10:15:42Z", "message": "Do at least one loop iteration before yielding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "986e0716fa8f98f0977e237fd2553acb63a2cbee", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/986e0716fa8f98f0977e237fd2553acb63a2cbee", "committedDate": "2020-01-22T10:16:22Z", "message": "Remove redundant assignment\n\nProbe positions starts from -1. Therefore\nfirst loop iteration on probe will setup\nrow state correctly."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NDg5NTM2", "url": "https://github.com/trinodb/trino/pull/2576#pullrequestreview-346489536", "createdAt": "2020-01-22T10:37:55Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMDozNzo1NVrOFgXijg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMDo0MzowOVrOFgXsKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ4NDQzMA==", "bodyText": "It means currentProbePositionProducedRow is no longer explicitly reset when we move to the next position.\nI think currentProbePositionProducedRow should be reset here or advanceProbePosition (equally non-ideal options), but rather not in the if above.\nAlso, i think the new code is not correct -- in case of spill if it affects current row, currentProbePositionProducedRow will remembered from last row being processed when we re-add the page.", "url": "https://github.com/trinodb/trino/pull/2576#discussion_r369484430", "createdAt": "2020-01-22T10:37:55Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/operator/LookupJoinOperator.java", "diffHunk": "@@ -550,13 +550,14 @@ private void processProbe(LookupSource lookupSource)\n                             break;\n                         }\n                     }\n+                    // reset row join state for next row\n+                    currentProbePositionProducedRow = false;\n+                    statisticsCounter.recordProbe(joinSourcePositions);\n+                    joinSourcePositions = 0;\n                 }\n-                currentProbePositionProducedRow = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ4Njg4OA==", "bodyText": "we should move recordProbe (as you did) & leave the others here.\nWhat we should do, however, is reset joinSourcePositions and currentProbePositionProducedRow in the same place (currently not the case). Maybe let's move them all to advanceProbePosition, after joinPosition = probe.getCurrentJoinPosition(lookupSource); line", "url": "https://github.com/trinodb/trino/pull/2576#discussion_r369486888", "createdAt": "2020-01-22T10:43:09Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/operator/LookupJoinOperator.java", "diffHunk": "@@ -550,13 +550,14 @@ private void processProbe(LookupSource lookupSource)\n                             break;\n                         }\n                     }\n+                    // reset row join state for next row\n+                    currentProbePositionProducedRow = false;\n+                    statisticsCounter.recordProbe(joinSourcePositions);\n+                    joinSourcePositions = 0;\n                 }\n-                currentProbePositionProducedRow = false;\n                 if (!advanceProbePosition(lookupSource)) {\n                     break;\n                 }\n-                statisticsCounter.recordProbe(joinSourcePositions);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "097e1e183f65b34780d68b746b664d3f4f9fdef6", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/097e1e183f65b34780d68b746b664d3f4f9fdef6", "committedDate": "2020-01-22T12:09:48Z", "message": "Reset row state in advanceProbePosition\n\nEntire row state in consistently\nreset in advanceProbePosition method.\n\nrecordProbe is only called for valid (non -1)\nprobe rows."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cffc7de6c40ffe1fcc970651c160a4029001641b", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/cffc7de6c40ffe1fcc970651c160a4029001641b", "committedDate": "2020-01-22T12:10:42Z", "message": "Remove redundant assignment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "cffc7de6c40ffe1fcc970651c160a4029001641b", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/cffc7de6c40ffe1fcc970651c160a4029001641b", "committedDate": "2020-01-22T12:10:42Z", "message": "Remove redundant assignment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NTQwODg4", "url": "https://github.com/trinodb/trino/pull/2576#pullrequestreview-346540888", "createdAt": "2020-01-22T12:11:07Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNjUwNDY3", "url": "https://github.com/trinodb/trino/pull/2576#pullrequestreview-353650467", "createdAt": "2020-02-05T11:38:05Z", "commit": {"oid": "cffc7de6c40ffe1fcc970651c160a4029001641b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 959, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}