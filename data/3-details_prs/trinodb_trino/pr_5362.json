{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1NTMzODA5", "number": 5362, "title": "Harden environment startup", "bodyText": "Sometimes environments fail to start because containers startup depend on each other", "createdAt": "2020-09-30T14:02:06Z", "url": "https://github.com/trinodb/trino/pull/5362", "merged": true, "mergeCommit": {"oid": "bca617121e0e8f1b5c09a28ebd4e95c579520be9"}, "closed": true, "closedAt": "2020-09-30T21:09:00Z", "author": {"login": "wendigo"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN9iN3AFqTQ5OTQ4Mjk0Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN_Dz9AFqTQ5OTU5MTQxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NDgyOTQy", "url": "https://github.com/trinodb/trino/pull/5362#pullrequestreview-499482942", "createdAt": "2020-09-30T14:19:49Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDoxOTo0OVrOHaf78w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDoxOTo0OVrOHaf78w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU0ODI3NQ==", "bodyText": "Add a comment why we want to do extra check here", "url": "https://github.com/trinodb/trino/pull/5362#discussion_r497548275", "createdAt": "2020-09-30T14:19:49Z", "author": {"login": "losipiuk"}, "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -131,6 +131,11 @@ private Environment tryStart()\n             }\n \n             Startables.deepStart(containers).get();\n+            if (!allContainersHealthy(containers)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NDg1NTM1", "url": "https://github.com/trinodb/trino/pull/5362#pullrequestreview-499485535", "createdAt": "2020-09-30T14:22:11Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDoyMjoxMVrOHagC4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDoyMjoxMVrOHagC4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1MDA1MA==", "bodyText": "parameter naming does not make it obvious which container depends on which.\nMaybe name container and dependencyContainer?", "url": "https://github.com/trinodb/trino/pull/5362#discussion_r497550050", "createdAt": "2020-09-30T14:22:11Z", "author": {"login": "losipiuk"}, "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -322,6 +322,15 @@ public String getEnvironmentName()\n             return name;\n         }\n \n+        public Builder containerDependsOn(String container, String otherContainer)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NDkwNDUx", "url": "https://github.com/trinodb/trino/pull/5362#pullrequestreview-499490451", "createdAt": "2020-09-30T14:26:32Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDoyNjozMlrOHagQdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDoyNjozMlrOHagQdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1MzUyNw==", "bodyText": "Also instead we could maybe add getContainer method to builder and go with:\n        builder.addContainers(createZookeeper(), createKafka())\n                .configureContainer(\"kafka\", kafkaContainer -> kafkaContainer.dependsOn(builder.getContainer(\"zookeeper\")));\nBut I think helper method is nice", "url": "https://github.com/trinodb/trino/pull/5362#discussion_r497553527", "createdAt": "2020-09-30T14:26:32Z", "author": {"login": "losipiuk"}, "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -322,6 +322,15 @@ public String getEnvironmentName()\n             return name;\n         }\n \n+        public Builder containerDependsOn(String container, String otherContainer)\n+        {\n+            checkState(containers.containsKey(container), \"Container with name %s is not registered\", name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NDkwOTU1", "url": "https://github.com/trinodb/trino/pull/5362#pullrequestreview-499490955", "createdAt": "2020-09-30T14:26:58Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4144e88968d96e35125f8dea2cf4c9c5b9104f1e", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/4144e88968d96e35125f8dea2cf4c9c5b9104f1e", "committedDate": "2020-09-30T15:44:06Z", "message": "Check environment health before waiting for test completion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e609d78773d2ef97ed3d508b1bc467f48f752559", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/e609d78773d2ef97ed3d508b1bc467f48f752559", "committedDate": "2020-09-30T15:50:39Z", "message": "Allow establishing docker container startup dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3cc11a5a2a9745887cb97912f0bb95e3050d032", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/a3cc11a5a2a9745887cb97912f0bb95e3050d032", "committedDate": "2020-09-30T15:50:39Z", "message": "Remove unused methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9bd045fa74477dfe08f22103d2c7865250a308c", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/e9bd045fa74477dfe08f22103d2c7865250a308c", "committedDate": "2020-09-30T15:50:39Z", "message": "Simplify container dependency"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NTg0ODA1", "url": "https://github.com/trinodb/trino/pull/5362#pullrequestreview-499584805", "createdAt": "2020-09-30T15:59:03Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNTo1OTowNFrOHaklFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNTo1OTowNFrOHaklFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyNDM0MA==", "bodyText": "make it simple for loop", "url": "https://github.com/trinodb/trino/pull/5362#discussion_r497624340", "createdAt": "2020-09-30T15:59:04Z", "author": {"login": "losipiuk"}, "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/DockerContainer.java", "diffHunk": "@@ -284,6 +286,14 @@ public void copyLogsToHostPath(Path hostPath)\n         return statistics.get();\n     }\n \n+    public DockerContainer waitingForAll(WaitStrategy... strategies)\n+    {\n+        WaitAllStrategy strategy = new WaitAllStrategy();\n+        Arrays.stream(strategies).forEach(strategy::withStrategy);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NTg2MTYz", "url": "https://github.com/trinodb/trino/pull/5362#pullrequestreview-499586163", "createdAt": "2020-09-30T16:00:31Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNjowMDozMVrOHakpaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNjowMDozMVrOHakpaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyNTQ1MQ==", "bodyText": "you are adding forHealthCheck() here. SHould be separate commit.", "url": "https://github.com/trinodb/trino/pull/5362#discussion_r497625451", "createdAt": "2020-09-30T16:00:31Z", "author": {"login": "losipiuk"}, "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/common/Hadoop.java", "diffHunk": "@@ -98,7 +99,7 @@ public static DockerContainer createHadoopContainer(DockerFiles dockerFiles, Str\n                 .withCommand(\"/usr/local/hadoop-run.sh\")\n                 .withExposedLogPaths(\"/var/log/hadoop-yarn\", \"/var/log/hadoop-hdfs\", \"/var/log/hive\", \"/var/log/container-health.log\")\n                 .withStartupCheckStrategy(new IsRunningStartupCheckStrategy())\n-                .waitingFor(new SelectedPortWaitStrategy(10000)) // HiveServer2\n+                .waitingForAll(forSelectedPorts(10000), forHealthcheck()) // HiveServer2", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NTg2Mzg1", "url": "https://github.com/trinodb/trino/pull/5362#pullrequestreview-499586385", "createdAt": "2020-09-30T16:00:46Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNjowMDo0NlrOHakqFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNjowMDo0NlrOHakqFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyNTYyMg==", "bodyText": "same here", "url": "https://github.com/trinodb/trino/pull/5362#discussion_r497625622", "createdAt": "2020-09-30T16:00:46Z", "author": {"login": "losipiuk"}, "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/common/Standard.java", "diffHunk": "@@ -125,7 +126,7 @@ public static DockerContainer createPrestoContainer(DockerFiles dockerFiles, Fil\n                 .withFileSystemBind(serverPackage.getPath(), \"/docker/presto-server.tar.gz\", READ_ONLY)\n                 .withCommand(\"/docker/presto-product-tests/run-presto.sh\")\n                 .withStartupCheckStrategy(new IsRunningStartupCheckStrategy())\n-                .waitingFor(Wait.forLogMessage(\".*======== SERVER STARTED ========.*\", 1))\n+                .waitingForAll(forLogMessage(\".*======== SERVER STARTED ========.*\", 1), forHealthcheck())", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NTg5NDQ3", "url": "https://github.com/trinodb/trino/pull/5362#pullrequestreview-499589447", "createdAt": "2020-09-30T16:04:10Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9ca5364cc8f6a32f9e2cc89ca68d95ba33eb955", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/c9ca5364cc8f6a32f9e2cc89ca68d95ba33eb955", "committedDate": "2020-09-30T16:04:48Z", "message": "Configure Kafka waitStrategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ebe6939229fc871d703b097ecc8b335adc9f5a9", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/1ebe6939229fc871d703b097ecc8b335adc9f5a9", "committedDate": "2020-09-30T16:04:48Z", "message": "Use static forLogMessage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f42dad246a0b1a8301901f7da22789a1652c6c37", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/f42dad246a0b1a8301901f7da22789a1652c6c37", "committedDate": "2020-09-30T16:04:48Z", "message": "Use forSelectedPorts utility method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc1498492a6eb6d4aa1c4f22eb222cb92b38f487", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/cc1498492a6eb6d4aa1c4f22eb222cb92b38f487", "committedDate": "2020-09-30T16:04:49Z", "message": "Wait for containers healthcheck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50b9f49af423ea199ea077ed2519dbb02b399452", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/50b9f49af423ea199ea077ed2519dbb02b399452", "committedDate": "2020-09-30T16:04:49Z", "message": "Reuse Hadoop container definition in two-mixed-hives environment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adce65329c7d5577c20db7e259a367650a357c25", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/adce65329c7d5577c20db7e259a367650a357c25", "committedDate": "2020-09-30T16:04:49Z", "message": "Move and clarify container reset"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "adce65329c7d5577c20db7e259a367650a357c25", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/adce65329c7d5577c20db7e259a367650a357c25", "committedDate": "2020-09-30T16:04:49Z", "message": "Move and clarify container reset"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NTkxNDE2", "url": "https://github.com/trinodb/trino/pull/5362#pullrequestreview-499591416", "createdAt": "2020-09-30T16:06:26Z", "commit": {"oid": "adce65329c7d5577c20db7e259a367650a357c25"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3533, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}