{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMDAwMTQ5", "number": 4886, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMDoxNDoxNlrOEZ6PZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzo1NzozMVrOEhQqLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NjA0MDY4OnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMDoxNDoxN1rOHDArLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMTo1MzoyNFrOHDD4uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjkxODgyOQ==", "bodyText": "It appears that bit shift is slightly better\n\nWhat do you mean better? faster?", "url": "https://github.com/trinodb/trino/pull/4886#discussion_r472918829", "createdAt": "2020-08-19T10:14:17Z", "author": {"login": "kokosing"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -724,27 +724,27 @@ public static void negate(Slice decimal)\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk3MTQ1MQ==", "bodyText": "faster obviously. good catch.", "url": "https://github.com/trinodb/trino/pull/4886#discussion_r472971451", "createdAt": "2020-08-19T11:53:24Z", "author": {"login": "skrzypo987"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -724,27 +724,27 @@ public static void negate(Slice decimal)\n ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjkxODgyOQ=="}, "originalCommit": null, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMjMyNjM5OnYy", "diffSide": "LEFT", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDozODozMlrOHOXE5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMjozMjo0MFrOHOarUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgyMDE5OA==", "bodyText": "is the SIGN_INT_MASK still needed?", "url": "https://github.com/trinodb/trino/pull/4886#discussion_r484820198", "createdAt": "2020-09-08T10:38:32Z", "author": {"login": "sopel39"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -724,27 +724,27 @@ public static void negate(Slice decimal)\n \n     public static boolean isStrictlyNegative(Slice decimal)\n     {\n-        return isNegative(decimal) && (getLong(decimal, 0) != 0 || getLong(decimal, 1) != 0);\n+        return isStrictlyNegative(getRawLong(decimal, 0), getRawLong(decimal, 1));\n     }\n \n     public static boolean isStrictlyNegative(long rawLow, long rawHigh)\n     {\n-        return isNegative(rawLow, rawHigh) && (rawLow != 0 || unpackUnsignedLong(rawHigh) != 0);\n+        return isNegative(rawHigh) && (rawLow != 0 || unpackUnsignedLong(rawHigh) != 0);\n     }\n \n     private static boolean isNegative(int lastRawHigh)\n     {\n-        return (lastRawHigh & SIGN_INT_MASK) != 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg3OTE4NQ==", "bodyText": "Used 7 times", "url": "https://github.com/trinodb/trino/pull/4886#discussion_r484879185", "createdAt": "2020-09-08T12:32:40Z", "author": {"login": "skrzypo987"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -724,27 +724,27 @@ public static void negate(Slice decimal)\n \n     public static boolean isStrictlyNegative(Slice decimal)\n     {\n-        return isNegative(decimal) && (getLong(decimal, 0) != 0 || getLong(decimal, 1) != 0);\n+        return isStrictlyNegative(getRawLong(decimal, 0), getRawLong(decimal, 1));\n     }\n \n     public static boolean isStrictlyNegative(long rawLow, long rawHigh)\n     {\n-        return isNegative(rawLow, rawHigh) && (rawLow != 0 || unpackUnsignedLong(rawHigh) != 0);\n+        return isNegative(rawHigh) && (rawLow != 0 || unpackUnsignedLong(rawHigh) != 0);\n     }\n \n     private static boolean isNegative(int lastRawHigh)\n     {\n-        return (lastRawHigh & SIGN_INT_MASK) != 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgyMDE5OA=="}, "originalCommit": null, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMjM3ODIwOnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDo1Mzo1NFrOHOXjog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMTo1OTozNlrOHOZj6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgyODA2Ng==", "bodyText": "Could you explain why it works? Why do we need to add MIN_VALUE to both sides? Please add a comment in code also.", "url": "https://github.com/trinodb/trino/pull/4886#discussion_r484828066", "createdAt": "2020-09-08T10:53:54Z", "author": {"login": "sopel39"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -353,77 +352,41 @@ else if (compare < 0) {\n      */\n     private static long addUnsignedReturnOverflow(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) + toUnsignedLong(r0);\n+        long intermediateResult = l0 + r0;\n+        long z0 = intermediateResult;\n+        // Unsigned compare\n+        int overflow = intermediateResult + Long.MIN_VALUE < l0 + Long.MIN_VALUE ? 1 : 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg2MDkwNw==", "bodyText": "This is Long.compareUnsigned() inlined.\nI added a comment", "url": "https://github.com/trinodb/trino/pull/4886#discussion_r484860907", "createdAt": "2020-09-08T11:59:36Z", "author": {"login": "skrzypo987"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -353,77 +352,41 @@ else if (compare < 0) {\n      */\n     private static long addUnsignedReturnOverflow(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) + toUnsignedLong(r0);\n+        long intermediateResult = l0 + r0;\n+        long z0 = intermediateResult;\n+        // Unsigned compare\n+        int overflow = intermediateResult + Long.MIN_VALUE < l0 + Long.MIN_VALUE ? 1 : 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgyODA2Ng=="}, "originalCommit": null, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMjM4MzUyOnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDo1NToxM1rOHOXmjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDo1NToxM1rOHOXmjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgyODgxNA==", "bodyText": "Could you explain why it works? Why do we need to add MIN_VALUE to both sides? Please add a comment in code also.", "url": "https://github.com/trinodb/trino/pull/4886#discussion_r484828814", "createdAt": "2020-09-08T10:55:13Z", "author": {"login": "sopel39"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -353,77 +352,41 @@ else if (compare < 0) {\n      */\n     private static long addUnsignedReturnOverflow(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) + toUnsignedLong(r0);\n+        long intermediateResult = l0 + r0;\n+        long z0 = intermediateResult;\n+        // Unsigned compare\n+        int overflow = intermediateResult + Long.MIN_VALUE < l0 + Long.MIN_VALUE ? 1 : 0;\n \n-        int z0 = (int) intermediateResult;\n+        intermediateResult = l1 + r1 + overflow;\n+        long z1 = intermediateResult & (~SIGN_LONG_MASK);\n+        pack(result, z0, z1, resultNegative);\n \n-        intermediateResult = toUnsignedLong(l1) + toUnsignedLong(r1) + (intermediateResult >>> 32);\n-\n-        int z1 = (int) intermediateResult;\n-\n-        intermediateResult = toUnsignedLong(l2) + toUnsignedLong(r2) + (intermediateResult >>> 32);\n-\n-        int z2 = (int) intermediateResult;\n-\n-        intermediateResult = toUnsignedLong(l3) + toUnsignedLong(r3) + (intermediateResult >>> 32);\n-\n-        int z3 = (int) intermediateResult & (~SIGN_INT_MASK);\n-\n-        pack(result, z0, z1, z2, z3, resultNegative);\n-\n-        return intermediateResult >> 31;\n+        return intermediateResult >>> 63;\n     }\n \n     /**\n      * This method ignores signs of the left and right and assumes that left is greater then right\n      */\n     private static void subtractUnsigned(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n-\n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) - toUnsignedLong(r0);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        int z0 = (int) intermediateResult;\n+        long z0 = l0 - r0;\n+        // Unsigned compare\n+        int overflow = z0 + Long.MIN_VALUE > l0 + Long.MIN_VALUE ? 1 : 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMjM4ODkyOnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDo1Njo0NVrOHOXptQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMjoxOToyMVrOHOaN2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgyOTYyMQ==", "bodyText": "intermediateResult is not need until this point", "url": "https://github.com/trinodb/trino/pull/4886#discussion_r484829621", "createdAt": "2020-09-08T10:56:45Z", "author": {"login": "sopel39"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -353,77 +352,41 @@ else if (compare < 0) {\n      */\n     private static long addUnsignedReturnOverflow(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) + toUnsignedLong(r0);\n+        long intermediateResult = l0 + r0;\n+        long z0 = intermediateResult;\n+        // Unsigned compare\n+        int overflow = intermediateResult + Long.MIN_VALUE < l0 + Long.MIN_VALUE ? 1 : 0;\n \n-        int z0 = (int) intermediateResult;\n+        intermediateResult = l1 + r1 + overflow;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg3MTY0MA==", "bodyText": "corrected", "url": "https://github.com/trinodb/trino/pull/4886#discussion_r484871640", "createdAt": "2020-09-08T12:19:21Z", "author": {"login": "skrzypo987"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -353,77 +352,41 @@ else if (compare < 0) {\n      */\n     private static long addUnsignedReturnOverflow(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) + toUnsignedLong(r0);\n+        long intermediateResult = l0 + r0;\n+        long z0 = intermediateResult;\n+        // Unsigned compare\n+        int overflow = intermediateResult + Long.MIN_VALUE < l0 + Long.MIN_VALUE ? 1 : 0;\n \n-        int z0 = (int) intermediateResult;\n+        intermediateResult = l1 + r1 + overflow;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgyOTYyMQ=="}, "originalCommit": null, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMjM5Mzg4OnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDo1ODoxNFrOHOXsuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMjozMjowMFrOHOapvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgzMDM5NQ==", "bodyText": "previously we added (intermediateResult >> 32), but now we remove overflow. Is this correct?", "url": "https://github.com/trinodb/trino/pull/4886#discussion_r484830395", "createdAt": "2020-09-08T10:58:14Z", "author": {"login": "sopel39"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -353,77 +352,41 @@ else if (compare < 0) {\n      */\n     private static long addUnsignedReturnOverflow(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) + toUnsignedLong(r0);\n+        long intermediateResult = l0 + r0;\n+        long z0 = intermediateResult;\n+        // Unsigned compare\n+        int overflow = intermediateResult + Long.MIN_VALUE < l0 + Long.MIN_VALUE ? 1 : 0;\n \n-        int z0 = (int) intermediateResult;\n+        intermediateResult = l1 + r1 + overflow;\n+        long z1 = intermediateResult & (~SIGN_LONG_MASK);\n+        pack(result, z0, z1, resultNegative);\n \n-        intermediateResult = toUnsignedLong(l1) + toUnsignedLong(r1) + (intermediateResult >>> 32);\n-\n-        int z1 = (int) intermediateResult;\n-\n-        intermediateResult = toUnsignedLong(l2) + toUnsignedLong(r2) + (intermediateResult >>> 32);\n-\n-        int z2 = (int) intermediateResult;\n-\n-        intermediateResult = toUnsignedLong(l3) + toUnsignedLong(r3) + (intermediateResult >>> 32);\n-\n-        int z3 = (int) intermediateResult & (~SIGN_INT_MASK);\n-\n-        pack(result, z0, z1, z2, z3, resultNegative);\n-\n-        return intermediateResult >> 31;\n+        return intermediateResult >>> 63;\n     }\n \n     /**\n      * This method ignores signs of the left and right and assumes that left is greater then right\n      */\n     private static void subtractUnsigned(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n-\n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) - toUnsignedLong(r0);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        int z0 = (int) intermediateResult;\n+        long z0 = l0 - r0;\n+        // Unsigned compare\n+        int overflow = z0 + Long.MIN_VALUE > l0 + Long.MIN_VALUE ? 1 : 0;\n+        long z1 = l1 - r1 - overflow;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg3ODc4MQ==", "bodyText": "The logic of subtraction is different than before\nThe previous one was just simple 4x subtraction on two 32-bit values within 64-bit placeholder. The intermediateResult >> 32 was the remainder, not the overflow.\nNow the overflow is just a flag indicating whether r0 > l0 so that we need to \"borrow\" 2^64 from l1.", "url": "https://github.com/trinodb/trino/pull/4886#discussion_r484878781", "createdAt": "2020-09-08T12:32:00Z", "author": {"login": "skrzypo987"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -353,77 +352,41 @@ else if (compare < 0) {\n      */\n     private static long addUnsignedReturnOverflow(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) + toUnsignedLong(r0);\n+        long intermediateResult = l0 + r0;\n+        long z0 = intermediateResult;\n+        // Unsigned compare\n+        int overflow = intermediateResult + Long.MIN_VALUE < l0 + Long.MIN_VALUE ? 1 : 0;\n \n-        int z0 = (int) intermediateResult;\n+        intermediateResult = l1 + r1 + overflow;\n+        long z1 = intermediateResult & (~SIGN_LONG_MASK);\n+        pack(result, z0, z1, resultNegative);\n \n-        intermediateResult = toUnsignedLong(l1) + toUnsignedLong(r1) + (intermediateResult >>> 32);\n-\n-        int z1 = (int) intermediateResult;\n-\n-        intermediateResult = toUnsignedLong(l2) + toUnsignedLong(r2) + (intermediateResult >>> 32);\n-\n-        int z2 = (int) intermediateResult;\n-\n-        intermediateResult = toUnsignedLong(l3) + toUnsignedLong(r3) + (intermediateResult >>> 32);\n-\n-        int z3 = (int) intermediateResult & (~SIGN_INT_MASK);\n-\n-        pack(result, z0, z1, z2, z3, resultNegative);\n-\n-        return intermediateResult >> 31;\n+        return intermediateResult >>> 63;\n     }\n \n     /**\n      * This method ignores signs of the left and right and assumes that left is greater then right\n      */\n     private static void subtractUnsigned(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n-\n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) - toUnsignedLong(r0);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        int z0 = (int) intermediateResult;\n+        long z0 = l0 - r0;\n+        // Unsigned compare\n+        int overflow = z0 + Long.MIN_VALUE > l0 + Long.MIN_VALUE ? 1 : 0;\n+        long z1 = l1 - r1 - overflow;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgzMDM5NQ=="}, "originalCommit": null, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMzA5MjMzOnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzo1MzowMlrOHOeRoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzo1MzowMlrOHOeRoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkzODE0NA==", "bodyText": "It's not inlined method as unsignedCompare can return -1, 0 or 1.\nCould you extract unsignedIsSmaller method and add a comment what it's based on?", "url": "https://github.com/trinodb/trino/pull/4886#discussion_r484938144", "createdAt": "2020-09-08T13:53:02Z", "author": {"login": "sopel39"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -353,77 +352,42 @@ else if (compare < 0) {\n      */\n     private static long addUnsignedReturnOverflow(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) + toUnsignedLong(r0);\n+        long z0 = l0 + r0;\n+        // Long.unsignedCompare() inlined", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMzEwNTY2OnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzo1NTo1MVrOHOeZxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzo1NTo1MVrOHOeZxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk0MDIyOQ==", "bodyText": "similar here, it's not unsignedCompare inlined. Please extract a separate method and add a comment what it's based on.", "url": "https://github.com/trinodb/trino/pull/4886#discussion_r484940229", "createdAt": "2020-09-08T13:55:51Z", "author": {"login": "sopel39"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -353,77 +352,42 @@ else if (compare < 0) {\n      */\n     private static long addUnsignedReturnOverflow(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) + toUnsignedLong(r0);\n+        long z0 = l0 + r0;\n+        // Long.unsignedCompare() inlined\n+        // (unsigned) z0 < (unsigned) l0\n+        int overflow = z0 + Long.MIN_VALUE < l0 + Long.MIN_VALUE ? 1 : 0;\n \n-        int z0 = (int) intermediateResult;\n+        long intermediateResult = l1 + r1 + overflow;\n+        long z1 = intermediateResult & (~SIGN_LONG_MASK);\n+        pack(result, z0, z1, resultNegative);\n \n-        intermediateResult = toUnsignedLong(l1) + toUnsignedLong(r1) + (intermediateResult >>> 32);\n-\n-        int z1 = (int) intermediateResult;\n-\n-        intermediateResult = toUnsignedLong(l2) + toUnsignedLong(r2) + (intermediateResult >>> 32);\n-\n-        int z2 = (int) intermediateResult;\n-\n-        intermediateResult = toUnsignedLong(l3) + toUnsignedLong(r3) + (intermediateResult >>> 32);\n-\n-        int z3 = (int) intermediateResult & (~SIGN_INT_MASK);\n-\n-        pack(result, z0, z1, z2, z3, resultNegative);\n-\n-        return intermediateResult >> 31;\n+        return intermediateResult >>> 63;\n     }\n \n     /**\n      * This method ignores signs of the left and right and assumes that left is greater then right\n      */\n     private static void subtractUnsigned(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n-\n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) - toUnsignedLong(r0);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        int z0 = (int) intermediateResult;\n+        long z0 = l0 - r0;\n+        // Long.unsignedCompare() inlined", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMzExNDA0OnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzo1NzozMVrOHOefDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzo1NzozMVrOHOefDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk0MTU4Mg==", "bodyText": "should this be called underflow?", "url": "https://github.com/trinodb/trino/pull/4886#discussion_r484941582", "createdAt": "2020-09-08T13:57:31Z", "author": {"login": "sopel39"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/UnscaledDecimal128Arithmetic.java", "diffHunk": "@@ -353,77 +352,42 @@ else if (compare < 0) {\n      */\n     private static long addUnsignedReturnOverflow(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) + toUnsignedLong(r0);\n+        long z0 = l0 + r0;\n+        // Long.unsignedCompare() inlined\n+        // (unsigned) z0 < (unsigned) l0\n+        int overflow = z0 + Long.MIN_VALUE < l0 + Long.MIN_VALUE ? 1 : 0;\n \n-        int z0 = (int) intermediateResult;\n+        long intermediateResult = l1 + r1 + overflow;\n+        long z1 = intermediateResult & (~SIGN_LONG_MASK);\n+        pack(result, z0, z1, resultNegative);\n \n-        intermediateResult = toUnsignedLong(l1) + toUnsignedLong(r1) + (intermediateResult >>> 32);\n-\n-        int z1 = (int) intermediateResult;\n-\n-        intermediateResult = toUnsignedLong(l2) + toUnsignedLong(r2) + (intermediateResult >>> 32);\n-\n-        int z2 = (int) intermediateResult;\n-\n-        intermediateResult = toUnsignedLong(l3) + toUnsignedLong(r3) + (intermediateResult >>> 32);\n-\n-        int z3 = (int) intermediateResult & (~SIGN_INT_MASK);\n-\n-        pack(result, z0, z1, z2, z3, resultNegative);\n-\n-        return intermediateResult >> 31;\n+        return intermediateResult >>> 63;\n     }\n \n     /**\n      * This method ignores signs of the left and right and assumes that left is greater then right\n      */\n     private static void subtractUnsigned(Slice left, Slice right, Slice result, boolean resultNegative)\n     {\n-        // TODO: consider two 7 bytes operations\n-        int l0 = getInt(left, 0);\n-        int l1 = getInt(left, 1);\n-        int l2 = getInt(left, 2);\n-        int l3 = getInt(left, 3);\n-\n-        int r0 = getInt(right, 0);\n-        int r1 = getInt(right, 1);\n-        int r2 = getInt(right, 2);\n-        int r3 = getInt(right, 3);\n+        long l0 = getLong(left, 0);\n+        long l1 = getLong(left, 1);\n \n-        long intermediateResult;\n-        intermediateResult = toUnsignedLong(l0) - toUnsignedLong(r0);\n+        long r0 = getLong(right, 0);\n+        long r1 = getLong(right, 1);\n \n-        int z0 = (int) intermediateResult;\n+        long z0 = l0 - r0;\n+        // Long.unsignedCompare() inlined\n+        // (unsigned) z0 > (unsigned) l0\n+        int overflow = z0 + Long.MIN_VALUE > l0 + Long.MIN_VALUE ? 1 : 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 84}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3505, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}