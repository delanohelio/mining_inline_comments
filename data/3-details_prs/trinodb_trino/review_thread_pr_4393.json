{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NTYxNzMx", "number": 4393, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwMjowNjowN1rOEMtyEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMjowNjoxNVrOENbbSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNzY4NDY2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwMjowNjowN1rOGu_KOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwMjowNjowN1rOGu_KOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkyMjQ4OQ==", "bodyText": "No need to do this. If any of the checks throw, the test will fail automatically.", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r451922489", "createdAt": "2020-07-09T02:06:07Z", "author": {"login": "electrum"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -566,6 +569,41 @@ public void testHive2VersionedFullAcidTableFails()\n         deleteRecursively(tablePath, ALLOW_INSECURE);\n     }\n \n+    @Test\n+    public void testValidateFileBuckets()\n+    {\n+        ListMultimap<Integer, LocatedFileStatus> bucketFiles = ArrayListMultimap.create();\n+        bucketFiles.put(1, null);\n+        bucketFiles.put(3, null);\n+        bucketFiles.put(4, null);\n+        bucketFiles.put(6, null);\n+        bucketFiles.put(9, null);\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 1, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (0) for partition: partitionName\");\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 5, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (4) for partition: partitionName\");\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 9, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (8) for partition: partitionName\");\n+\n+        boolean noErrors = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODc5NzY4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOTo0MzoxMlrOGvJuGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNzoxNjoyN1rOGvahPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA5NTUxMw==", "bodyText": "nit: each argument in newline", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r452095513", "createdAt": "2020-07-09T09:43:12Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,23 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        Integer highestBucketNumber = Collections.max(bucketFiles.keySet());\n+        // validate the bucket number detected from files, fail the query if the highest bucket number detected from file\n+        // exceeds the allowed highest number\n+        if (highestBucketNumber >= partitionBucketCount) {\n+            throw new PrestoException(HIVE_INVALID_BUCKET_FILES, format(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM3MDc1MQ==", "bodyText": "fixed", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r452370751", "createdAt": "2020-07-09T17:16:27Z", "author": {"login": "ArvinZheng"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,23 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        Integer highestBucketNumber = Collections.max(bucketFiles.keySet());\n+        // validate the bucket number detected from files, fail the query if the highest bucket number detected from file\n+        // exceeds the allowed highest number\n+        if (highestBucketNumber >= partitionBucketCount) {\n+            throw new PrestoException(HIVE_INVALID_BUCKET_FILES, format(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA5NTUxMw=="}, "originalCommit": null, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODgwMzk1OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOTo0NTowMFrOGvJyFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMjoyMjoxMFrOGwHO6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA5NjUzNQ==", "bodyText": "remove catch, throwing an exception will cause test to fail anyway", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r452096535", "createdAt": "2020-07-09T09:45:00Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -566,6 +569,41 @@ public void testHive2VersionedFullAcidTableFails()\n         deleteRecursively(tablePath, ALLOW_INSECURE);\n     }\n \n+    @Test\n+    public void testValidateFileBuckets()\n+    {\n+        ListMultimap<Integer, LocatedFileStatus> bucketFiles = ArrayListMultimap.create();\n+        bucketFiles.put(1, null);\n+        bucketFiles.put(3, null);\n+        bucketFiles.put(4, null);\n+        bucketFiles.put(6, null);\n+        bucketFiles.put(9, null);\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 1, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (0) for partition: partitionName\");\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 5, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (4) for partition: partitionName\");\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 9, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (8) for partition: partitionName\");\n+\n+        boolean noErrors = true;\n+        try {\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 10, \"tableName\", \"partitionName\");\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 20, \"tableName\", \"partitionName\");\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 30, \"tableName\", \"partitionName\");\n+        }\n+        catch (Throwable e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM3MjI1OQ==", "bodyText": "Hi @sopel39 , I understand throwing exceptions will break and fail the test, but having the try catch and assert will improve the readability of the test, i.e. show the intent clearly, what do you think?", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r452372259", "createdAt": "2020-07-09T17:19:06Z", "author": {"login": "ArvinZheng"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -566,6 +569,41 @@ public void testHive2VersionedFullAcidTableFails()\n         deleteRecursively(tablePath, ALLOW_INSECURE);\n     }\n \n+    @Test\n+    public void testValidateFileBuckets()\n+    {\n+        ListMultimap<Integer, LocatedFileStatus> bucketFiles = ArrayListMultimap.create();\n+        bucketFiles.put(1, null);\n+        bucketFiles.put(3, null);\n+        bucketFiles.put(4, null);\n+        bucketFiles.put(6, null);\n+        bucketFiles.put(9, null);\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 1, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (0) for partition: partitionName\");\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 5, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (4) for partition: partitionName\");\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 9, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (8) for partition: partitionName\");\n+\n+        boolean noErrors = true;\n+        try {\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 10, \"tableName\", \"partitionName\");\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 20, \"tableName\", \"partitionName\");\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 30, \"tableName\", \"partitionName\");\n+        }\n+        catch (Throwable e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA5NjUzNQ=="}, "originalCommit": null, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5OTI4NQ==", "bodyText": "These are expected to be positive test cases that don't throw. Having try/catch is strange, as any exception will cause a test failure. By this logic, we would need try/catch in every test, as we normally expect that a test will not throw.", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453099285", "createdAt": "2020-07-10T22:08:11Z", "author": {"login": "electrum"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -566,6 +569,41 @@ public void testHive2VersionedFullAcidTableFails()\n         deleteRecursively(tablePath, ALLOW_INSECURE);\n     }\n \n+    @Test\n+    public void testValidateFileBuckets()\n+    {\n+        ListMultimap<Integer, LocatedFileStatus> bucketFiles = ArrayListMultimap.create();\n+        bucketFiles.put(1, null);\n+        bucketFiles.put(3, null);\n+        bucketFiles.put(4, null);\n+        bucketFiles.put(6, null);\n+        bucketFiles.put(9, null);\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 1, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (0) for partition: partitionName\");\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 5, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (4) for partition: partitionName\");\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 9, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (8) for partition: partitionName\");\n+\n+        boolean noErrors = true;\n+        try {\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 10, \"tableName\", \"partitionName\");\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 20, \"tableName\", \"partitionName\");\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 30, \"tableName\", \"partitionName\");\n+        }\n+        catch (Throwable e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA5NjUzNQ=="}, "originalCommit": null, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwMzMzOA==", "bodyText": "got it, will remove it", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453103338", "createdAt": "2020-07-10T22:22:10Z", "author": {"login": "ArvinZheng"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -566,6 +569,41 @@ public void testHive2VersionedFullAcidTableFails()\n         deleteRecursively(tablePath, ALLOW_INSECURE);\n     }\n \n+    @Test\n+    public void testValidateFileBuckets()\n+    {\n+        ListMultimap<Integer, LocatedFileStatus> bucketFiles = ArrayListMultimap.create();\n+        bucketFiles.put(1, null);\n+        bucketFiles.put(3, null);\n+        bucketFiles.put(4, null);\n+        bucketFiles.put(6, null);\n+        bucketFiles.put(9, null);\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 1, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (0) for partition: partitionName\");\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 5, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (4) for partition: partitionName\");\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 9, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number declared (8) for partition: partitionName\");\n+\n+        boolean noErrors = true;\n+        try {\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 10, \"tableName\", \"partitionName\");\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 20, \"tableName\", \"partitionName\");\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 30, \"tableName\", \"partitionName\");\n+        }\n+        catch (Throwable e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA5NjUzNQ=="}, "originalCommit": null, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMjU0NzAwOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwNzo1Nzo0N1rOGvttLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzozNDoyOVrOGv_s1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY4NTEwMA==", "bodyText": "static import", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r452685100", "createdAt": "2020-07-10T07:57:47Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -566,6 +570,41 @@ public void testHive2VersionedFullAcidTableFails()\n         deleteRecursively(tablePath, ALLOW_INSECURE);\n     }\n \n+    @Test\n+    public void testValidateFileBuckets()\n+    {\n+        ListMultimap<Integer, LocatedFileStatus> bucketFiles = ArrayListMultimap.create();\n+        bucketFiles.put(1, null);\n+        bucketFiles.put(3, null);\n+        bucketFiles.put(4, null);\n+        bucketFiles.put(6, null);\n+        bucketFiles.put(9, null);\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 1, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number \" +\n+                        \"declared (0) for partition: partitionName\");\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 5, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number \" +\n+                        \"declared (4) for partition: partitionName\");\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 9, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number \" +\n+                        \"declared (8) for partition: partitionName\");\n+\n+        try {\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 10, \"tableName\", \"partitionName\");\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 20, \"tableName\", \"partitionName\");\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 30, \"tableName\", \"partitionName\");\n+        }\n+        catch (Throwable e) {\n+            Assert.shouldNeverReachHere();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk3OTkyNQ==", "bodyText": "fixed", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r452979925", "createdAt": "2020-07-10T17:34:29Z", "author": {"login": "ArvinZheng"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -566,6 +570,41 @@ public void testHive2VersionedFullAcidTableFails()\n         deleteRecursively(tablePath, ALLOW_INSECURE);\n     }\n \n+    @Test\n+    public void testValidateFileBuckets()\n+    {\n+        ListMultimap<Integer, LocatedFileStatus> bucketFiles = ArrayListMultimap.create();\n+        bucketFiles.put(1, null);\n+        bucketFiles.put(3, null);\n+        bucketFiles.put(4, null);\n+        bucketFiles.put(6, null);\n+        bucketFiles.put(9, null);\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 1, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number \" +\n+                        \"declared (0) for partition: partitionName\");\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 5, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number \" +\n+                        \"declared (4) for partition: partitionName\");\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 9, \"tableName\", \"partitionName\"))\n+                .isInstanceOfSatisfying(PrestoException.class, e -> assertEquals(HIVE_INVALID_BUCKET_FILES.toErrorCode(), e.getErrorCode()))\n+                .hasMessage(\"Hive table 'tableName' is corrupt. The highest bucket number in the directory (9) is greater than the highest bucket number \" +\n+                        \"declared (8) for partition: partitionName\");\n+\n+        try {\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 10, \"tableName\", \"partitionName\");\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 20, \"tableName\", \"partitionName\");\n+            BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 30, \"tableName\", \"partitionName\");\n+        }\n+        catch (Throwable e) {\n+            Assert.shouldNeverReachHere();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY4NTEwMA=="}, "originalCommit": null, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMjU0OTExOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwNzo1ODoyOVrOGvtubQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzozNDozNFrOGv_s-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY4NTQyMQ==", "bodyText": "static import max", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r452685421", "createdAt": "2020-07-10T07:58:29Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,28 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        if (bucketFiles.isEmpty()) {\n+            return;\n+        }\n+\n+        Integer highestBucketNumber = Collections.max(bucketFiles.keySet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk3OTk2MA==", "bodyText": "fixed", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r452979960", "createdAt": "2020-07-10T17:34:34Z", "author": {"login": "ArvinZheng"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,28 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        if (bucketFiles.isEmpty()) {\n+            return;\n+        }\n+\n+        Integer highestBucketNumber = Collections.max(bucketFiles.keySet());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY4NTQyMQ=="}, "originalCommit": null, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMjU1MTIxOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwNzo1OTowN1rOGvtvvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzozNDo1N1rOGv_tnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY4NTc1Ng==", "bodyText": "each arg in newline", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r452685756", "createdAt": "2020-07-10T07:59:07Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,28 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        if (bucketFiles.isEmpty()) {\n+            return;\n+        }\n+\n+        Integer highestBucketNumber = Collections.max(bucketFiles.keySet());\n+        // validate the bucket number detected from files, fail the query if the highest bucket number detected from file\n+        // exceeds the allowed highest number\n+        if (highestBucketNumber >= partitionBucketCount) {\n+            throw new PrestoException(\n+                    HIVE_INVALID_BUCKET_FILES,\n+                    format(\"Hive table '%s' is corrupt. The highest bucket number in the directory (%s) is greater than the highest bucket \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4MDEyNA==", "bodyText": "reformatted again", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r452980124", "createdAt": "2020-07-10T17:34:57Z", "author": {"login": "ArvinZheng"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,28 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        if (bucketFiles.isEmpty()) {\n+            return;\n+        }\n+\n+        Integer highestBucketNumber = Collections.max(bucketFiles.keySet());\n+        // validate the bucket number detected from files, fail the query if the highest bucket number detected from file\n+        // exceeds the allowed highest number\n+        if (highestBucketNumber >= partitionBucketCount) {\n+            throw new PrestoException(\n+                    HIVE_INVALID_BUCKET_FILES,\n+                    format(\"Hive table '%s' is corrupt. The highest bucket number in the directory (%s) is greater than the highest bucket \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY4NTc1Ng=="}, "originalCommit": null, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTE1NzkxOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMjowMzo1N1rOGwG6Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMjoyMTozN1rOGwHOWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5Nzk4Nw==", "bodyText": "This can be declared as int", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453097987", "createdAt": "2020-07-10T22:03:57Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,27 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        if (bucketFiles.isEmpty()) {\n+            return;\n+        }\n+\n+        Integer highestBucketNumber = max(bucketFiles.keySet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwMzE5Mg==", "bodyText": "good catch", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453103192", "createdAt": "2020-07-10T22:21:37Z", "author": {"login": "ArvinZheng"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,27 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        if (bucketFiles.isEmpty()) {\n+            return;\n+        }\n+\n+        Integer highestBucketNumber = max(bucketFiles.keySet());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5Nzk4Nw=="}, "originalCommit": null, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTE2MDI1OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "isResolved": false, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMjowNTowNFrOGwG7VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMjoxNzo1N1rOGw8Y4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5ODMyNQ==", "bodyText": "Remove - 1 after changing error message", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453098325", "createdAt": "2020-07-10T22:05:04Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,27 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        if (bucketFiles.isEmpty()) {\n+            return;\n+        }\n+\n+        Integer highestBucketNumber = max(bucketFiles.keySet());\n+        // validate the bucket number detected from files, fail the query if the highest bucket number detected from file\n+        // exceeds the allowed highest number\n+        if (highestBucketNumber >= partitionBucketCount) {\n+            throw new PrestoException(HIVE_INVALID_BUCKET_FILES, format(\n+                    \"Hive table '%s' is corrupt. The highest bucket number in the directory (%s) is greater than the highest bucket number \" +\n+                            \"declared (%s) for partition: %s\",\n+                    tableName,\n+                    highestBucketNumber,\n+                    partitionBucketCount - 1,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwNTkzNQ==", "bodyText": "I was thinking the same when I was trying to organize the error message, then I chose to make this trade off since I was not able to figure out a better one - how about Hive table '%s' is corrupt. The highest bucket number in the directory (%s) exceeds the bucket number range defined by the declared bucket count (%s) for partition: %s", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453105935", "createdAt": "2020-07-10T22:32:02Z", "author": {"login": "ArvinZheng"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,27 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        if (bucketFiles.isEmpty()) {\n+            return;\n+        }\n+\n+        Integer highestBucketNumber = max(bucketFiles.keySet());\n+        // validate the bucket number detected from files, fail the query if the highest bucket number detected from file\n+        // exceeds the allowed highest number\n+        if (highestBucketNumber >= partitionBucketCount) {\n+            throw new PrestoException(HIVE_INVALID_BUCKET_FILES, format(\n+                    \"Hive table '%s' is corrupt. The highest bucket number in the directory (%s) is greater than the highest bucket number \" +\n+                            \"declared (%s) for partition: %s\",\n+                    tableName,\n+                    highestBucketNumber,\n+                    partitionBucketCount - 1,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5ODMyNQ=="}, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwODcxNg==", "bodyText": "one error message example that may look a bit odd, feel free to suggest a better one\n\nHive table 'tableName' is corrupt. The highest bucket number in the directory (9) exceeds the bucket number range defined by the declared bucket count (9) for partition: partitionName", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453108716", "createdAt": "2020-07-10T22:43:10Z", "author": {"login": "ArvinZheng"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,27 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        if (bucketFiles.isEmpty()) {\n+            return;\n+        }\n+\n+        Integer highestBucketNumber = max(bucketFiles.keySet());\n+        // validate the bucket number detected from files, fail the query if the highest bucket number detected from file\n+        // exceeds the allowed highest number\n+        if (highestBucketNumber >= partitionBucketCount) {\n+            throw new PrestoException(HIVE_INVALID_BUCKET_FILES, format(\n+                    \"Hive table '%s' is corrupt. The highest bucket number in the directory (%s) is greater than the highest bucket number \" +\n+                            \"declared (%s) for partition: %s\",\n+                    tableName,\n+                    highestBucketNumber,\n+                    partitionBucketCount - 1,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5ODMyNQ=="}, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxMzY4MQ==", "bodyText": "I see what you mean. Maybe we could list the range explicitly?\n\nHive table 'tableName' is corrupt. The highest bucket number in the directory (9) exceeds the bucket number range (0..8) defined by the declared bucket count (9) for partition: partitionName", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453913681", "createdAt": "2020-07-13T20:30:26Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,27 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        if (bucketFiles.isEmpty()) {\n+            return;\n+        }\n+\n+        Integer highestBucketNumber = max(bucketFiles.keySet());\n+        // validate the bucket number detected from files, fail the query if the highest bucket number detected from file\n+        // exceeds the allowed highest number\n+        if (highestBucketNumber >= partitionBucketCount) {\n+            throw new PrestoException(HIVE_INVALID_BUCKET_FILES, format(\n+                    \"Hive table '%s' is corrupt. The highest bucket number in the directory (%s) is greater than the highest bucket number \" +\n+                            \"declared (%s) for partition: %s\",\n+                    tableName,\n+                    highestBucketNumber,\n+                    partitionBucketCount - 1,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5ODMyNQ=="}, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxNDY5NA==", "bodyText": "I merged the PR since this seems good enough for now. If you want to try adding the range or otherwise improving the error message, feel free to send a follow up PR.", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453914694", "createdAt": "2020-07-13T20:32:17Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,27 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        if (bucketFiles.isEmpty()) {\n+            return;\n+        }\n+\n+        Integer highestBucketNumber = max(bucketFiles.keySet());\n+        // validate the bucket number detected from files, fail the query if the highest bucket number detected from file\n+        // exceeds the allowed highest number\n+        if (highestBucketNumber >= partitionBucketCount) {\n+            throw new PrestoException(HIVE_INVALID_BUCKET_FILES, format(\n+                    \"Hive table '%s' is corrupt. The highest bucket number in the directory (%s) is greater than the highest bucket number \" +\n+                            \"declared (%s) for partition: %s\",\n+                    tableName,\n+                    highestBucketNumber,\n+                    partitionBucketCount - 1,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5ODMyNQ=="}, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkzODY0NQ==", "bodyText": "Yup, that's my concern. To show the bucket range I'll need to do calculation on the partitionBucketCount, maybe extra a method will have better readability for the code, what do you think?\nBTW, thanks for your time on reviewing the code.", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453938645", "createdAt": "2020-07-13T21:18:02Z", "author": {"login": "ArvinZheng"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,27 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        if (bucketFiles.isEmpty()) {\n+            return;\n+        }\n+\n+        Integer highestBucketNumber = max(bucketFiles.keySet());\n+        // validate the bucket number detected from files, fail the query if the highest bucket number detected from file\n+        // exceeds the allowed highest number\n+        if (highestBucketNumber >= partitionBucketCount) {\n+            throw new PrestoException(HIVE_INVALID_BUCKET_FILES, format(\n+                    \"Hive table '%s' is corrupt. The highest bucket number in the directory (%s) is greater than the highest bucket number \" +\n+                            \"declared (%s) for partition: %s\",\n+                    tableName,\n+                    highestBucketNumber,\n+                    partitionBucketCount - 1,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5ODMyNQ=="}, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk0NDg1NA==", "bodyText": "The only calculation is partitionBucketCount - 1 so I don't think we need a method (the range always starts at zero).", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453944854", "createdAt": "2020-07-13T21:30:17Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,27 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        if (bucketFiles.isEmpty()) {\n+            return;\n+        }\n+\n+        Integer highestBucketNumber = max(bucketFiles.keySet());\n+        // validate the bucket number detected from files, fail the query if the highest bucket number detected from file\n+        // exceeds the allowed highest number\n+        if (highestBucketNumber >= partitionBucketCount) {\n+            throw new PrestoException(HIVE_INVALID_BUCKET_FILES, format(\n+                    \"Hive table '%s' is corrupt. The highest bucket number in the directory (%s) is greater than the highest bucket number \" +\n+                            \"declared (%s) for partition: %s\",\n+                    tableName,\n+                    highestBucketNumber,\n+                    partitionBucketCount - 1,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5ODMyNQ=="}, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk3NDI0Mg==", "bodyText": "Yes, my concerns is whether subtracting 1 from partitionBucketCount is easy for people to understand, otherwise i am good to go with partitionBucketCount - 1 directly.", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453974242", "createdAt": "2020-07-13T22:17:57Z", "author": {"login": "ArvinZheng"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -636,6 +639,27 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n         return splitList;\n     }\n \n+    @VisibleForTesting\n+    static void validateFileBuckets(ListMultimap<Integer, LocatedFileStatus> bucketFiles, int partitionBucketCount, String tableName, String partitionName)\n+    {\n+        if (bucketFiles.isEmpty()) {\n+            return;\n+        }\n+\n+        Integer highestBucketNumber = max(bucketFiles.keySet());\n+        // validate the bucket number detected from files, fail the query if the highest bucket number detected from file\n+        // exceeds the allowed highest number\n+        if (highestBucketNumber >= partitionBucketCount) {\n+            throw new PrestoException(HIVE_INVALID_BUCKET_FILES, format(\n+                    \"Hive table '%s' is corrupt. The highest bucket number in the directory (%s) is greater than the highest bucket number \" +\n+                            \"declared (%s) for partition: %s\",\n+                    tableName,\n+                    highestBucketNumber,\n+                    partitionBucketCount - 1,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5ODMyNQ=="}, "originalCommit": null, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTE2Mjk2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMjowNjoxNVrOGwG81w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMjozMjoxM1rOGwHZTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5ODcxMQ==", "bodyText": "Static import validateFileBuckets for readability", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453098711", "createdAt": "2020-07-10T22:06:15Z", "author": {"login": "electrum"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -566,6 +571,41 @@ public void testHive2VersionedFullAcidTableFails()\n         deleteRecursively(tablePath, ALLOW_INSECURE);\n     }\n \n+    @Test\n+    public void testValidateFileBuckets()\n+    {\n+        ListMultimap<Integer, LocatedFileStatus> bucketFiles = ArrayListMultimap.create();\n+        bucketFiles.put(1, null);\n+        bucketFiles.put(3, null);\n+        bucketFiles.put(4, null);\n+        bucketFiles.put(6, null);\n+        bucketFiles.put(9, null);\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 1, \"tableName\", \"partitionName\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwMDg1NA==", "bodyText": "You can do this using\nassertPrestoExceptionThrownBy(() -> validateFileBuckets(bucketFiles, 1, \"tableName\", \"partitionName\"))\n        .hasErrorCode(HIVE_INVALID_BUCKET_FILES)\n        .hasMessage(...);", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453100854", "createdAt": "2020-07-10T22:13:47Z", "author": {"login": "electrum"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -566,6 +571,41 @@ public void testHive2VersionedFullAcidTableFails()\n         deleteRecursively(tablePath, ALLOW_INSECURE);\n     }\n \n+    @Test\n+    public void testValidateFileBuckets()\n+    {\n+        ListMultimap<Integer, LocatedFileStatus> bucketFiles = ArrayListMultimap.create();\n+        bucketFiles.put(1, null);\n+        bucketFiles.put(3, null);\n+        bucketFiles.put(4, null);\n+        bucketFiles.put(6, null);\n+        bucketFiles.put(9, null);\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 1, \"tableName\", \"partitionName\"))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5ODcxMQ=="}, "originalCommit": null, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwNTk5OA==", "bodyText": "got it", "url": "https://github.com/trinodb/trino/pull/4393#discussion_r453105998", "createdAt": "2020-07-10T22:32:13Z", "author": {"login": "ArvinZheng"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -566,6 +571,41 @@ public void testHive2VersionedFullAcidTableFails()\n         deleteRecursively(tablePath, ALLOW_INSECURE);\n     }\n \n+    @Test\n+    public void testValidateFileBuckets()\n+    {\n+        ListMultimap<Integer, LocatedFileStatus> bucketFiles = ArrayListMultimap.create();\n+        bucketFiles.put(1, null);\n+        bucketFiles.put(3, null);\n+        bucketFiles.put(4, null);\n+        bucketFiles.put(6, null);\n+        bucketFiles.put(9, null);\n+\n+        assertThatThrownBy(() -> BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 1, \"tableName\", \"partitionName\"))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5ODcxMQ=="}, "originalCommit": null, "originalPosition": 50}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3850, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}