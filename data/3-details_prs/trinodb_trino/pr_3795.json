{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwNzE3ODQ3", "number": 3795, "title": "Increase process numbers to 1000 from 500 in Oracle test", "bodyText": "Fixes #3798\n\nhttps://github.com/prestosql/presto/runs/692927473 \u2705\nhttps://github.com/prestosql/presto/runs/692984065 \u2705\nhttps://github.com/prestosql/presto/runs/693201407 \u2705\nhttps://github.com/prestosql/presto/runs/693383212 \u2705\nhttps://github.com/prestosql/presto/runs/694934677 \u2705\nhttps://github.com/prestosql/presto/runs/696759106 \u2705\nhttps://github.com/prestosql/presto/runs/696975339 \u2705", "createdAt": "2020-05-20T12:26:58Z", "url": "https://github.com/trinodb/trino/pull/3795", "merged": true, "mergeCommit": {"oid": "3e0574ca9e74471ea6d42c917d51ddca3337794d"}, "closed": true, "closedAt": "2020-05-23T01:43:59Z", "author": {"login": "ebyhr"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjIWZSABqjMzNTYyNTI2MTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjoo4KgBqjMzNjI5NzAzNDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTY1MTc1", "url": "https://github.com/trinodb/trino/pull/3795#pullrequestreview-415965175", "createdAt": "2020-05-21T08:23:23Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTkxMTAx", "url": "https://github.com/trinodb/trino/pull/3795#pullrequestreview-415991101", "createdAt": "2020-05-21T09:05:37Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwOTowNTozOFrOGYrrrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwOTowNjowNlrOGYrsog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDcwMg==", "bodyText": "otherwise the tests end up giving a ORA-12519\n\nthis could mention the message too\n\nbut this command needs a database restart and if we restart the docker the configuration is lost.\n\nthis could be solved with a custom entry point, or a command.\nhow much would it add to the startup time?", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428534702", "createdAt": "2020-05-21T09:05:38Z", "author": {"login": "findepi"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -40,7 +40,7 @@ public TestingOracleServer()\n         // to fix this we have to change the number of processes of SPFILE\n         // but this command needs a database restart and if we restart the docker the configuration is lost.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDk0Ng==", "bodyText": "if i would like to amend, or recreate the spfileXE.ora, how would i do that?", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428534946", "createdAt": "2020-05-21T09:06:06Z", "author": {"login": "findepi"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -40,7 +40,7 @@ public TestingOracleServer()\n         // to fix this we have to change the number of processes of SPFILE\n         // but this command needs a database restart and if we restart the docker the configuration is lost.\n         // configuration added:\n-        // ALTER SYSTEM SET processes=500 SCOPE=SPFILE\n+        // ALTER SYSTEM SET processes=1000 SCOPE=SPFILE\n         // ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\n         this.addFileSystemBind(\"src/test/resources/spfileXE.ora\",\n                 \"/u01/app/oracle/product/11.2.0/xe/dbs/spfileXE.ora\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NDk4NTAy", "url": "https://github.com/trinodb/trino/pull/3795#pullrequestreview-416498502", "createdAt": "2020-05-21T21:16:39Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMToxNjozOVrOGZDJvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMToxNzoxOFrOGZDKzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkxOTIzMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try (Connection connection = DriverManager.getConnection(getJdbcUrl(), super.getUsername(), super.getPassword());\n          \n          \n            \n                    try (Connection connection = DriverManager.getConnection(getJdbcUrl(), getUsername(), getPassword());\n          \n      \n    \n    \n  \n\n-- you didn't need super, did you?", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428919230", "createdAt": "2020-05-21T21:16:39Z", "author": {"login": "findepi"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -36,17 +36,28 @@ public TestingOracleServer()\n     {\n         super(\"wnameless/oracle-xe-11g-r2\");\n \n-        // this is added to allow more processes on database, otherwise the tests end up giving a ORA-12519\n-        // to fix this we have to change the number of processes of SPFILE\n-        // but this command needs a database restart and if we restart the docker the configuration is lost.\n-        // configuration added:\n-        // ALTER SYSTEM SET processes=500 SCOPE=SPFILE\n-        // ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\n-        this.addFileSystemBind(\"src/test/resources/spfileXE.ora\",\n-                \"/u01/app/oracle/product/11.2.0/xe/dbs/spfileXE.ora\",\n-                BindMode.READ_ONLY);\n-\n         start();\n+\n+        try (Connection connection = DriverManager.getConnection(getJdbcUrl(), super.getUsername(), super.getPassword());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkxOTUwMA==", "bodyText": "Does it wait for the db to be back opertional?", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428919500", "createdAt": "2020-05-21T21:17:18Z", "author": {"login": "findepi"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -36,17 +36,28 @@ public TestingOracleServer()\n     {\n         super(\"wnameless/oracle-xe-11g-r2\");\n \n-        // this is added to allow more processes on database, otherwise the tests end up giving a ORA-12519\n-        // to fix this we have to change the number of processes of SPFILE\n-        // but this command needs a database restart and if we restart the docker the configuration is lost.\n-        // configuration added:\n-        // ALTER SYSTEM SET processes=500 SCOPE=SPFILE\n-        // ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\n-        this.addFileSystemBind(\"src/test/resources/spfileXE.ora\",\n-                \"/u01/app/oracle/product/11.2.0/xe/dbs/spfileXE.ora\",\n-                BindMode.READ_ONLY);\n-\n         start();\n+\n+        try (Connection connection = DriverManager.getConnection(getJdbcUrl(), super.getUsername(), super.getPassword());\n+                Statement statement = connection.createStatement()) {\n+            // this is added to allow more processes on database, otherwise the tests end up giving\n+            // ORA-12519, TNS:no appropriate service handler found\n+            // ORA-12505, TNS:listener does not currently know of SID given in connect descriptor\n+            // to fix this we have to change the number of processes of SPFILE\n+            statement.execute(\"ALTER SYSTEM SET processes=1000 SCOPE=SPFILE\");\n+            statement.execute(\"ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\");\n+        }\n+        catch (SQLException e) {\n+            throw new RuntimeException(e);\n+        }\n+\n+        try {\n+            execInContainer(\"/bin/bash\", \"/etc/init.d/oracle-xe\", \"restart\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a460d9e3c62fca4f129cb68aabd0ba0be73fa22d", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/a460d9e3c62fca4f129cb68aabd0ba0be73fa22d", "committedDate": "2020-05-22T02:12:51Z", "message": "Increase process numbers to 1000 from 500 in Oracle test\n\nAdditionally\n- remove spfileXE.ora and set paramaters programmatically\n- remove redundant \"super.\" in TestingOracleServer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "a460d9e3c62fca4f129cb68aabd0ba0be73fa22d", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/a460d9e3c62fca4f129cb68aabd0ba0be73fa22d", "committedDate": "2020-05-22T02:12:51Z", "message": "Increase process numbers to 1000 from 500 in Oracle test\n\nAdditionally\n- remove spfileXE.ora and set paramaters programmatically\n- remove redundant \"super.\" in TestingOracleServer"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1200, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}