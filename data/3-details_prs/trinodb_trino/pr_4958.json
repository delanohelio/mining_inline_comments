{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyNTczODkz", "number": 4958, "title": "Improve performance of obtaining same current dynamic filter", "bodyText": "", "createdAt": "2020-08-24T14:48:36Z", "url": "https://github.com/trinodb/trino/pull/4958", "merged": true, "mergeCommit": {"oid": "e47b870bdea17214845757ae883739bc2a89e4fd"}, "closed": true, "closedAt": "2020-09-01T10:28:21Z", "author": {"login": "sopel39"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCIUzlgFqTQ3MzgxODcxNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEZ6JKAFqTQ3ODk3NjQ4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczODE4NzE1", "url": "https://github.com/trinodb/trino/pull/4958#pullrequestreview-473818715", "createdAt": "2020-08-24T20:07:03Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQyMDowNzowM1rOHF0ayA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQyMDowNzowM1rOHF0ayA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg2Mzc1Mg==", "bodyText": "A question about dynamicFilter.getDomains().get().size() >= completedDynamicFilters.size():\nMay it happen that a dynamic filter corresponds to more than one probe-side column?\nFor example, when the query is:\nSELECT * FROM left, right WHERE left.k1 = right.k AND left.k2 = right.k AND right.v = 0\nIn this case, is it OK to compare the size of TupleDomain<ColumnHandle> and Set<DynamicFilterId>?", "url": "https://github.com/trinodb/trino/pull/4958#discussion_r475863752", "createdAt": "2020-08-24T20:07:03Z", "author": {"login": "rzeyde-varada"}, "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -229,23 +229,22 @@ public boolean isComplete()\n             @Override\n             public TupleDomain<ColumnHandle> getCurrentPredicate()\n             {\n-                TupleDomain<ColumnHandle> dynamicFilter = completedDynamicFilter.get();\n-                if (dynamicFilter != null) {\n+                Set<DynamicFilterId> completedDynamicFilters = dynamicFilters.stream()\n+                        .filter(filter -> context.getDynamicFilterSummaries().containsKey(filter))\n+                        .collect(toImmutableSet());\n+\n+                TupleDomain<ColumnHandle> dynamicFilter = currentDynamicFilter.get();\n+                if (dynamicFilter.isNone() || dynamicFilter.getDomains().get().size() >= completedDynamicFilters.size()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c1995e9afdbea79185f4e6dcb4b8517c416d1dc", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/6c1995e9afdbea79185f4e6dcb4b8517c416d1dc", "committedDate": "2020-08-25T15:46:44Z", "message": "Simplify stream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "162e19a1375dcf469714235f8de013470dc4b7fd", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/162e19a1375dcf469714235f8de013470dc4b7fd", "committedDate": "2020-08-25T15:46:44Z", "message": "Fix access control of methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df5052382d213d27c1c62842f2e3dc9be9dab979", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/df5052382d213d27c1c62842f2e3dc9be9dab979", "committedDate": "2020-08-25T15:46:44Z", "message": "Fix support for mapping of dynamic filter to multiple columns"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NjAwNTYy", "url": "https://github.com/trinodb/trino/pull/4958#pullrequestreview-475600562", "createdAt": "2020-08-26T15:22:51Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNToyMjo1MVrOHHRWGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNToyMjo1MVrOHHRWGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM4NjI2NA==", "bodyText": "Asking because I am not sure if the current implementation is thread-safe:\nDo we assume that getCurrentPredicate is called from a single thread by the coordinator?", "url": "https://github.com/trinodb/trino/pull/4958#discussion_r477386264", "createdAt": "2020-08-26T15:22:51Z", "author": {"login": "rzeyde-varada"}, "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -229,22 +230,21 @@ public boolean isComplete()\n             @Override\n             public TupleDomain<ColumnHandle> getCurrentPredicate()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NzQ0NzU4", "url": "https://github.com/trinodb/trino/pull/4958#pullrequestreview-475744758", "createdAt": "2020-08-26T18:21:36Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxODoyMTozNlrOHHYNDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxODoyMTozNlrOHHYNDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5ODYzNw==", "bodyText": "private", "url": "https://github.com/trinodb/trino/pull/4958#discussion_r477498637", "createdAt": "2020-08-26T18:21:36Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -591,4 +590,26 @@ private boolean isCompleted()\n             return completed.get();\n         }\n     }\n+\n+    private static class CurrentDynamicFilter\n+    {\n+        final int completedDynamicFiltersCount;\n+        final TupleDomain<ColumnHandle> dynamicFilter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 51}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f87addd7cc8edbef6b3fed06675dfca61949cd7", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/6f87addd7cc8edbef6b3fed06675dfca61949cd7", "committedDate": "2020-08-26T18:57:06Z", "message": "Make fields private"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "958e53e7debcea40bd18d66c923ba1595afe87c9", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/958e53e7debcea40bd18d66c923ba1595afe87c9", "committedDate": "2020-08-26T18:57:23Z", "message": "Improve performance of obtaining same current dynamic filter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "958e53e7debcea40bd18d66c923ba1595afe87c9", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/958e53e7debcea40bd18d66c923ba1595afe87c9", "committedDate": "2020-08-26T18:57:23Z", "message": "Improve performance of obtaining same current dynamic filter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NDk3Mzk1", "url": "https://github.com/trinodb/trino/pull/4958#pullrequestreview-476497395", "createdAt": "2020-08-27T08:28:07Z", "commit": {"oid": "958e53e7debcea40bd18d66c923ba1595afe87c9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4OTc2NDg3", "url": "https://github.com/trinodb/trino/pull/4958#pullrequestreview-478976487", "createdAt": "2020-08-31T21:44:04Z", "commit": {"oid": "958e53e7debcea40bd18d66c923ba1595afe87c9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4146, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}