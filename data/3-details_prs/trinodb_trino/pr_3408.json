{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxODcyOTkx", "number": 3408, "title": "Fix NPE in pushdown to NULL expression", "bodyText": "toImmutableList does not accept nulls, so pushdown to a null expression fails:\nCaused by: java.lang.NullPointerException\nat com.google.common.base.Preconditions.checkNotNull(Preconditions.java:877)\nat com.google.common.collect.ImmutableList$Builder.add(ImmutableList.java:788)\nat java.base/java.util.stream.ReduceOps$3ReducingSink.accept(ReduceOps.java:169)\nat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)\nat java.base/java.util.Collections$2.tryAdvance(Collections.java:4747)\nat java.base/java.util.Collections$2.forEachRemaining(Collections.java:4755)\nat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484)\nat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:474)\nat java.base/java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:913)\nat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\nat java.base/java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:578)\nat io.prestosql.sql.planner.ExpressionInterpreter$Visitor.visitBindExpression(ExpressionInterpreter.java:974)\n....", "createdAt": "2020-04-10T11:30:05Z", "url": "https://github.com/trinodb/trino/pull/3408", "merged": true, "mergeCommit": {"oid": "ece91e5265894e9b2c29ff3419362989b8921021"}, "closed": true, "closedAt": "2020-04-10T21:05:37Z", "author": {"login": "alexey-fin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWSfgLgFqTM5MTQ5MTIxOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWW3xrgFqTM5MTYzNzM5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNDkxMjE4", "url": "https://github.com/trinodb/trino/pull/3408#pullrequestreview-391491218", "createdAt": "2020-04-10T15:05:07Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNDk0NjIz", "url": "https://github.com/trinodb/trino/pull/3408#pullrequestreview-391494623", "createdAt": "2020-04-10T15:11:37Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNToxMTozN1rOGD9LpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNToxMTozN1rOGD9LpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgwMTMxNw==", "bodyText": "static import + comment\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                .collect(Collectors.toList());\n          \n          \n            \n                                .collect(toList()); // values are nullable", "url": "https://github.com/trinodb/trino/pull/3408#discussion_r406801317", "createdAt": "2020-04-10T15:11:37Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/ExpressionInterpreter.java", "diffHunk": "@@ -971,7 +971,7 @@ protected Object visitBindExpression(BindExpression node, Object context)\n         {\n             List<Object> values = node.getValues().stream()\n                     .map(value -> process(value, context))\n-                    .collect(toImmutableList());\n+                    .collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTI0Mjgz", "url": "https://github.com/trinodb/trino/pull/3408#pullrequestreview-391524283", "createdAt": "2020-04-10T16:09:45Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNjowOTo0NVrOGD-u9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNjowOTo0NVrOGD-u9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgyNjc0MA==", "bodyText": "@martint\ni think the test should be in the planner,\nis it a good enough place?", "url": "https://github.com/trinodb/trino/pull/3408#discussion_r406826740", "createdAt": "2020-04-10T16:09:45Z", "author": {"login": "alexey-fin"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestPredicatePushdown.java", "diffHunk": "@@ -57,6 +57,17 @@\n         super(ImmutableMap.of(ENABLE_DYNAMIC_FILTERING, \"true\"));\n     }\n \n+    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTMxOTE0", "url": "https://github.com/trinodb/trino/pull/3408#pullrequestreview-391531914", "createdAt": "2020-04-10T16:24:56Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNjoyNDo1NlrOGD_IHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNjoyNDo1NlrOGD_IHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzMzE4Mw==", "bodyText": "This failure is unrelated to predicate pushdown. It's due to the null being inlined in the argument to the internal bind function that's used to model try when the InlineProjections optimizer rule executes. The query can be simplified to the following and still reproduce the issue:\nSELECT try(k)\nFROM (SELECT null) t(k)\n\nLet's add a test using the simplified query in io.prestosql.sql.query.TestExpressions instead. Also add a comment in the test linking to the github issue so that we can trace back the reason for the test in the future.", "url": "https://github.com/trinodb/trino/pull/3408#discussion_r406833183", "createdAt": "2020-04-10T16:24:56Z", "author": {"login": "martint"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestPredicatePushdown.java", "diffHunk": "@@ -57,6 +57,17 @@\n         super(ImmutableMap.of(ENABLE_DYNAMIC_FILTERING, \"true\"));\n     }\n \n+    @Test\n+    public void testPushdownBindToNull() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "96bd3bc7e25deca279dccd4b7344dad2c6a53da9", "author": {"user": {"login": "martint", "name": "Martin Traverso"}}, "url": "https://github.com/trinodb/trino/commit/96bd3bc7e25deca279dccd4b7344dad2c6a53da9", "committedDate": "2019-11-27T18:21:09Z", "message": "[maven-release-plugin] prepare release 326"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f853ea986030134c1dcc5cdf8bd8d40eaa94f58", "author": {"user": {"login": "alexey-fin", "name": null}}, "url": "https://github.com/trinodb/trino/commit/0f853ea986030134c1dcc5cdf8bd8d40eaa94f58", "committedDate": "2020-04-10T19:44:05Z", "message": "Fix NPE when inlining try() to NULL value"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNjM3Mzk2", "url": "https://github.com/trinodb/trino/pull/3408#pullrequestreview-391637396", "createdAt": "2020-04-10T20:11:15Z", "commit": {"oid": "0f853ea986030134c1dcc5cdf8bd8d40eaa94f58"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1895, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}