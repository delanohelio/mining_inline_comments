{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMjQyNDE3", "number": 3621, "title": "Prevent OutputBufferMemoryManager from becoming negative", "bodyText": "This should never occur, but if it does, we should prevent the object\nfrom entering an invalid state, as this breaks stats using DataSize.", "createdAt": "2020-05-04T23:47:21Z", "url": "https://github.com/trinodb/trino/pull/3621", "merged": true, "mergeCommit": {"oid": "dbd3cdf7209461c9b7888f0b500a2ad5a4138b05"}, "closed": true, "closedAt": "2020-05-16T23:16:09Z", "author": {"login": "electrum"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcePuaigFqTQwNTU4MjQxMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABch7AlMgBqjMzNDM4NDYwMTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NTgyNDEy", "url": "https://github.com/trinodb/trino/pull/3621#pullrequestreview-405582412", "createdAt": "2020-05-05T08:23:05Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwODoyMzowNVrOGQfKfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwODoyMzowNVrOGQfKfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk0MDk4OA==", "bodyText": "it's no longer atomic. Use accumulateAndGet instead, placing the check inside the method.\nlong currentBufferedBytes = bufferedBytes.accumulateAndGet(bytesAdded, OutputBufferMemoryManager::addNonNegative);", "url": "https://github.com/trinodb/trino/pull/3621#discussion_r419940988", "createdAt": "2020-05-05T08:23:05Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/execution/buffer/OutputBufferMemoryManager.java", "diffHunk": "@@ -81,7 +81,11 @@ public synchronized void updateMemoryUsage(long bytesAdded)\n             return;\n         }\n \n-        long currentBufferedBytes = bufferedBytes.addAndGet(bytesAdded);\n+        long localBufferedBytes = bufferedBytes.get();\n+        long currentBufferedBytes = localBufferedBytes + bytesAdded;\n+        checkArgument(currentBufferedBytes >= 0, \"bufferedBytes (%s) plus delta (%s) would be negative\", localBufferedBytes, bytesAdded);\n+        bufferedBytes.set(currentBufferedBytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NjA2NTgz", "url": "https://github.com/trinodb/trino/pull/3621#pullrequestreview-405606583", "createdAt": "2020-05-05T08:58:55Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "12bd779d3d749aefd090574ff3e37411b96558fb", "author": {"user": {"login": "electrum", "name": "David Phillips"}}, "url": "https://github.com/trinodb/trino/commit/12bd779d3d749aefd090574ff3e37411b96558fb", "committedDate": "2020-05-16T18:29:51Z", "message": "Prevent OutputBufferMemoryManager from becoming negative\n\nThis should never occur, but if it does, we should prevent the object\nfrom entering an invalid state, as this breaks stats using DataSize."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "12bd779d3d749aefd090574ff3e37411b96558fb", "author": {"user": {"login": "electrum", "name": "David Phillips"}}, "url": "https://github.com/trinodb/trino/commit/12bd779d3d749aefd090574ff3e37411b96558fb", "committedDate": "2020-05-16T18:29:51Z", "message": "Prevent OutputBufferMemoryManager from becoming negative\n\nThis should never occur, but if it does, we should prevent the object\nfrom entering an invalid state, as this breaks stats using DataSize."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1382, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}