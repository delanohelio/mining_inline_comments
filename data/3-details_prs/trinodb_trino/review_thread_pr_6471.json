{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2NzAxNTE0", "number": 6471, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwNzo1MzoxOVrOFJ-HgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxOToxMjo1MVrOFLA7DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1OTk5MjMzOnYy", "diffSide": "RIGHT", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwNzo1MzoxOVrOIMhjrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwNzo1MzoxOVrOIMhjrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAwMzYyOQ==", "bodyText": "Please move GROUP BY and HAVING to new lines.", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550003629", "createdAt": "2020-12-30T07:53:19Z", "author": {"login": "ssheikin"}, "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -428,9 +428,10 @@ public void setNull(PreparedStatement statement, int index)\n         return handle.createQuery(\"\" +\n                 \"SELECT data_compression_desc FROM sys.partitions p \" +\n                 \"INNER JOIN sys.tables t ON p.object_id = t.object_id \" +\n+                \"INNER JOIN sys.schemas s ON t.schema_id = s.schema_id \" +\n                 \"INNER JOIN sys.indexes i ON t.object_id = i.object_id \" +\n-                \"WHERE SCHEMA_NAME(t.schema_id) = :schema AND t.name = :table_name AND i.type IN (0,1) \" +\n-                \"AND i.data_space_id NOT IN (SELECT data_space_id FROM sys.partition_schemes)\")\n+                \"WHERE s.name = :schema AND t.name = :table_name AND p.index_id = 0 AND i.type = 0 \" +\n+                \"AND i.data_space_id NOT IN (SELECT data_space_id FROM sys.partition_schemes) GROUP BY data_compression_desc HAVING count(*) <= 1\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MDAxMTY5OnYy", "diffSide": "RIGHT", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwNzo1Nzo0OVrOIMhwMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwNzo1Nzo0OVrOIMhwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAwNjgzMw==", "bodyText": "This is not precise name as SHOW CREATE does not support indexes.\nYou test Data Compression here.\nCould you please rename this method similar to the commit message?", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550006833", "createdAt": "2020-12-30T07:57:49Z", "author": {"login": "ssheikin"}, "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -417,6 +417,30 @@ public void testShowCreateForPartitionedTablesWithDataCompression()\n                         \")\");\n     }\n \n+    @Test\n+    public void testShowCreateForIndexedNonPartitionedTablesWithDataCompression()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MDA0MTE2OnYy", "diffSide": "RIGHT", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwODowNDoxNFrOIMiC7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwODowNDoxNFrOIMiC7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAxMTYyOQ==", "bodyText": "It's harder to compare text with regexp.\nIt's easier to compare text with text.\nPlease consider\n.matches -> isEqualTo,\n\\\\w+\\\\.\\\\w+\\\\. -> getSession().getCatalog().orElseThrow() + \".\" + getSession().getSchema().orElseThrow() + \".\" + \nMay be extract common sql part.", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550011629", "createdAt": "2020-12-30T08:04:14Z", "author": {"login": "ssheikin"}, "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -417,6 +417,30 @@ public void testShowCreateForPartitionedTablesWithDataCompression()\n                         \")\");\n     }\n \n+    @Test\n+    public void testShowCreateForIndexedNonPartitionedTablesWithDataCompression()\n+    {\n+        sqlServer.execute(\"CREATE TABLE IndexedTable (\\n\" +\n+                \"   key1 BIGINT NOT NULL,\\n\" +\n+                \"   key2 BIGINT NOT NULL,\\n\" +\n+                \"   key3 BIGINT NOT NULL,\\n\" +\n+                \"   key4 BIGINT NOT NULL,\\n\" +\n+                \"   key5 BIGINT NOT NULL,\\n\" +\n+                \"   CONSTRAINT PK_IndexedTable PRIMARY KEY CLUSTERED (key1),\\n\" +\n+                \"   CONSTRAINT IX_IndexedTable UNIQUE (key2, key3),\\n\" +\n+                \"   INDEX IX_MyTable4 NONCLUSTERED (key4, key5))\\n\" +\n+                \"   WITH (DATA_COMPRESSION = PAGE)\");\n+\n+        assertThat((String) computeActual(\"SHOW CREATE TABLE IndexedTable\").getOnlyValue())\n+                .matches(\"CREATE TABLE \\\\w+\\\\.\\\\w+\\\\.indexedtable \\\\Q(\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MDA5MDQ4OnYy", "diffSide": "RIGHT", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "isResolved": false, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwODoxNToyMlrOIMijLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxNTo0MzozM1rOIMv03g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAxOTg4NA==", "bodyText": "p.index_id = 0 AND i.type = 0\n\nwhy do you need this check?\njust for the info:\n\nsys.partitions.index_id\nIndicates the ID of the index within the object to which this partition belongs.\n0 = heap\n1 = clustered index\n2 or greater = nonclustered index\nhttps://docs.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-partitions-transact-sql?view=sql-server-ver15\n\n\nsys.indexes.type\nType of index:\n0 = Heap\n1 = Clustered\n2 = Nonclustered\n3 = XML\n4 = Spatial\n5 = Clustered columnstore index.\u00a0Applies to: SQL Server 2014 (12.x) and later.\n6 = Nonclustered columnstore index.\u00a0Applies to: SQL Server 2012 (11.x) and later.\n7 = Nonclustered hash index.\u00a0Applies to: SQL Server 2014 (12.x) and later.\nhttps://docs.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-indexes-transact-sql?view=sql-server-ver15", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550019884", "createdAt": "2020-12-30T08:15:22Z", "author": {"login": "ssheikin"}, "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -428,9 +428,10 @@ public void setNull(PreparedStatement statement, int index)\n         return handle.createQuery(\"\" +\n                 \"SELECT data_compression_desc FROM sys.partitions p \" +\n                 \"INNER JOIN sys.tables t ON p.object_id = t.object_id \" +\n+                \"INNER JOIN sys.schemas s ON t.schema_id = s.schema_id \" +\n                 \"INNER JOIN sys.indexes i ON t.object_id = i.object_id \" +\n-                \"WHERE SCHEMA_NAME(t.schema_id) = :schema AND t.name = :table_name AND i.type IN (0,1) \" +\n-                \"AND i.data_space_id NOT IN (SELECT data_space_id FROM sys.partition_schemes)\")\n+                \"WHERE s.name = :schema AND t.name = :table_name AND p.index_id = 0 AND i.type = 0 \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAyMTg2MQ==", "bodyText": "Currently we have planned to support only for Heap tables. So we have restricted for other types of object", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550021861", "createdAt": "2020-12-30T08:17:51Z", "author": {"login": "Praveen2112"}, "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -428,9 +428,10 @@ public void setNull(PreparedStatement statement, int index)\n         return handle.createQuery(\"\" +\n                 \"SELECT data_compression_desc FROM sys.partitions p \" +\n                 \"INNER JOIN sys.tables t ON p.object_id = t.object_id \" +\n+                \"INNER JOIN sys.schemas s ON t.schema_id = s.schema_id \" +\n                 \"INNER JOIN sys.indexes i ON t.object_id = i.object_id \" +\n-                \"WHERE SCHEMA_NAME(t.schema_id) = :schema AND t.name = :table_name AND i.type IN (0,1) \" +\n-                \"AND i.data_space_id NOT IN (SELECT data_space_id FROM sys.partition_schemes)\")\n+                \"WHERE s.name = :schema AND t.name = :table_name AND p.index_id = 0 AND i.type = 0 \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAxOTg4NA=="}, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE4MDQ1OQ==", "bodyText": "could you please add two /* Heap */ comments near = 0", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550180459", "createdAt": "2020-12-30T12:36:47Z", "author": {"login": "ssheikin"}, "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -428,9 +428,10 @@ public void setNull(PreparedStatement statement, int index)\n         return handle.createQuery(\"\" +\n                 \"SELECT data_compression_desc FROM sys.partitions p \" +\n                 \"INNER JOIN sys.tables t ON p.object_id = t.object_id \" +\n+                \"INNER JOIN sys.schemas s ON t.schema_id = s.schema_id \" +\n                 \"INNER JOIN sys.indexes i ON t.object_id = i.object_id \" +\n-                \"WHERE SCHEMA_NAME(t.schema_id) = :schema AND t.name = :table_name AND i.type IN (0,1) \" +\n-                \"AND i.data_space_id NOT IN (SELECT data_space_id FROM sys.partition_schemes)\")\n+                \"WHERE s.name = :schema AND t.name = :table_name AND p.index_id = 0 AND i.type = 0 \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAxOTg4NA=="}, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIwMDAwNA==", "bodyText": "Good idea to add a comment:\n\"WHERE s.name = :schema AND t.name = :table_name \" +\n\"AND p.index_id = 0 \" + // ....\n\"AND i.type = 0 \" // 0 means Heap index type", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550200004", "createdAt": "2020-12-30T13:45:54Z", "author": {"login": "findepi"}, "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -428,9 +428,10 @@ public void setNull(PreparedStatement statement, int index)\n         return handle.createQuery(\"\" +\n                 \"SELECT data_compression_desc FROM sys.partitions p \" +\n                 \"INNER JOIN sys.tables t ON p.object_id = t.object_id \" +\n+                \"INNER JOIN sys.schemas s ON t.schema_id = s.schema_id \" +\n                 \"INNER JOIN sys.indexes i ON t.object_id = i.object_id \" +\n-                \"WHERE SCHEMA_NAME(t.schema_id) = :schema AND t.name = :table_name AND i.type IN (0,1) \" +\n-                \"AND i.data_space_id NOT IN (SELECT data_space_id FROM sys.partition_schemes)\")\n+                \"WHERE s.name = :schema AND t.name = :table_name AND p.index_id = 0 AND i.type = 0 \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAxOTg4NA=="}, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIxMjY4Ng==", "bodyText": "I think comments within sql fit better here.", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550212686", "createdAt": "2020-12-30T14:27:44Z", "author": {"login": "ssheikin"}, "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -428,9 +428,10 @@ public void setNull(PreparedStatement statement, int index)\n         return handle.createQuery(\"\" +\n                 \"SELECT data_compression_desc FROM sys.partitions p \" +\n                 \"INNER JOIN sys.tables t ON p.object_id = t.object_id \" +\n+                \"INNER JOIN sys.schemas s ON t.schema_id = s.schema_id \" +\n                 \"INNER JOIN sys.indexes i ON t.object_id = i.object_id \" +\n-                \"WHERE SCHEMA_NAME(t.schema_id) = :schema AND t.name = :table_name AND i.type IN (0,1) \" +\n-                \"AND i.data_space_id NOT IN (SELECT data_space_id FROM sys.partition_schemes)\")\n+                \"WHERE s.name = :schema AND t.name = :table_name AND p.index_id = 0 AND i.type = 0 \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAxOTg4NA=="}, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIzNjc0NQ==", "bodyText": "@ssheikin no need to send our comments to SQL Server, is there?", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550236745", "createdAt": "2020-12-30T15:41:26Z", "author": {"login": "findepi"}, "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -428,9 +428,10 @@ public void setNull(PreparedStatement statement, int index)\n         return handle.createQuery(\"\" +\n                 \"SELECT data_compression_desc FROM sys.partitions p \" +\n                 \"INNER JOIN sys.tables t ON p.object_id = t.object_id \" +\n+                \"INNER JOIN sys.schemas s ON t.schema_id = s.schema_id \" +\n                 \"INNER JOIN sys.indexes i ON t.object_id = i.object_id \" +\n-                \"WHERE SCHEMA_NAME(t.schema_id) = :schema AND t.name = :table_name AND i.type IN (0,1) \" +\n-                \"AND i.data_space_id NOT IN (SELECT data_space_id FROM sys.partition_schemes)\")\n+                \"WHERE s.name = :schema AND t.name = :table_name AND p.index_id = 0 AND i.type = 0 \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAxOTg4NA=="}, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIzNzE2MA==", "bodyText": "You are right. Is it expensive?", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550237160", "createdAt": "2020-12-30T15:42:50Z", "author": {"login": "ssheikin"}, "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -428,9 +428,10 @@ public void setNull(PreparedStatement statement, int index)\n         return handle.createQuery(\"\" +\n                 \"SELECT data_compression_desc FROM sys.partitions p \" +\n                 \"INNER JOIN sys.tables t ON p.object_id = t.object_id \" +\n+                \"INNER JOIN sys.schemas s ON t.schema_id = s.schema_id \" +\n                 \"INNER JOIN sys.indexes i ON t.object_id = i.object_id \" +\n-                \"WHERE SCHEMA_NAME(t.schema_id) = :schema AND t.name = :table_name AND i.type IN (0,1) \" +\n-                \"AND i.data_space_id NOT IN (SELECT data_space_id FROM sys.partition_schemes)\")\n+                \"WHERE s.name = :schema AND t.name = :table_name AND p.index_id = 0 AND i.type = 0 \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAxOTg4NA=="}, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIzNzQwNg==", "bodyText": "Not at all. Just redundant.", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550237406", "createdAt": "2020-12-30T15:43:33Z", "author": {"login": "findepi"}, "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -428,9 +428,10 @@ public void setNull(PreparedStatement statement, int index)\n         return handle.createQuery(\"\" +\n                 \"SELECT data_compression_desc FROM sys.partitions p \" +\n                 \"INNER JOIN sys.tables t ON p.object_id = t.object_id \" +\n+                \"INNER JOIN sys.schemas s ON t.schema_id = s.schema_id \" +\n                 \"INNER JOIN sys.indexes i ON t.object_id = i.object_id \" +\n-                \"WHERE SCHEMA_NAME(t.schema_id) = :schema AND t.name = :table_name AND i.type IN (0,1) \" +\n-                \"AND i.data_space_id NOT IN (SELECT data_space_id FROM sys.partition_schemes)\")\n+                \"WHERE s.name = :schema AND t.name = :table_name AND p.index_id = 0 AND i.type = 0 \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAxOTg4NA=="}, "originalCommit": null, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MTA3Mjc5OnYy", "diffSide": "RIGHT", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMjozMzo0M1rOIMsS4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMjozMzo0M1rOIMsS4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE3OTU1Mg==", "bodyText": "Maybe it worth to create separate test testShowCreateForIndexedTablesAreNotSupportedYet just to underline that current test fails not because of data compression once such support is implemented?", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550179552", "createdAt": "2020-12-30T12:33:43Z", "author": {"login": "ssheikin"}, "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -417,6 +417,30 @@ public void testShowCreateForPartitionedTablesWithDataCompression()\n                         \")\");\n     }\n \n+    @Test\n+    public void testShowCreateForIndexedNonPartitionedTablesWithDataCompression()\n+    {\n+        sqlServer.execute(\"CREATE TABLE IndexedTable (\\n\" +\n+                \"   key1 BIGINT NOT NULL,\\n\" +\n+                \"   key2 BIGINT NOT NULL,\\n\" +\n+                \"   key3 BIGINT NOT NULL,\\n\" +\n+                \"   key4 BIGINT NOT NULL,\\n\" +\n+                \"   key5 BIGINT NOT NULL,\\n\" +\n+                \"   CONSTRAINT PK_IndexedTable PRIMARY KEY CLUSTERED (key1),\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MTIxMjUxOnYy", "diffSide": "LEFT", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMzo0NDoxMVrOIMtgyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMzo0NDoxMVrOIMtgyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE5OTQ5OA==", "bodyText": "replacing SCHEMA_NAME with INNER JOIN sys.schemas looks like independent change.\nplease split this into 2 commits?", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550199498", "createdAt": "2020-12-30T13:44:11Z", "author": {"login": "findepi"}, "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -428,8 +428,9 @@ public void setNull(PreparedStatement statement, int index)\n         return handle.createQuery(\"\" +\n                 \"SELECT data_compression_desc FROM sys.partitions p \" +\n                 \"INNER JOIN sys.tables t ON p.object_id = t.object_id \" +\n+                \"INNER JOIN sys.schemas s ON t.schema_id = s.schema_id \" +\n                 \"INNER JOIN sys.indexes i ON t.object_id = i.object_id \" +\n-                \"WHERE SCHEMA_NAME(t.schema_id) = :schema AND t.name = :table_name AND i.type IN (0,1) \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MTIxNzk4OnYy", "diffSide": "RIGHT", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMzo0NjozOFrOIMtjtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMzo0NjozOFrOIMtjtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIwMDI0Ng==", "bodyText": "matches -> isEqualTo", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550200246", "createdAt": "2020-12-30T13:46:38Z", "author": {"login": "findepi"}, "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -417,6 +417,30 @@ public void testShowCreateForPartitionedTablesWithDataCompression()\n                         \")\");\n     }\n \n+    @Test\n+    public void testShowCreateForNonIndexedNonPartitionedTablesWithDataCompression()\n+    {\n+        sqlServer.execute(\"CREATE TABLE IndexedTable (\\n\" +\n+                \"   key1 BIGINT NOT NULL,\\n\" +\n+                \"   key2 BIGINT NOT NULL,\\n\" +\n+                \"   key3 BIGINT NOT NULL,\\n\" +\n+                \"   key4 BIGINT NOT NULL,\\n\" +\n+                \"   key5 BIGINT NOT NULL,\\n\" +\n+                \"   CONSTRAINT PK_IndexedTable PRIMARY KEY CLUSTERED (key1),\\n\" +\n+                \"   CONSTRAINT IX_IndexedTable UNIQUE (key2, key3),\\n\" +\n+                \"   INDEX IX_MyTable4 NONCLUSTERED (key4, key5))\\n\" +\n+                \"   WITH (DATA_COMPRESSION = PAGE)\");\n+\n+        assertThat((String) computeActual(\"SHOW CREATE TABLE IndexedTable\").getOnlyValue())\n+                .matches(\"CREATE TABLE sqlserver\\\\.dbo\\\\.indexedtable \\\\Q(\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MTIxOTY2OnYy", "diffSide": "RIGHT", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMzo0NzoxMFrOIMtkiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMzo0NzoxMFrOIMtkiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIwMDQ1Nw==", "bodyText": "IndexedTable -> test_show_indexed_table", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550200457", "createdAt": "2020-12-30T13:47:10Z", "author": {"login": "findepi"}, "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -417,6 +417,30 @@ public void testShowCreateForPartitionedTablesWithDataCompression()\n                         \")\");\n     }\n \n+    @Test\n+    public void testShowCreateForNonIndexedNonPartitionedTablesWithDataCompression()\n+    {\n+        sqlServer.execute(\"CREATE TABLE IndexedTable (\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MTIyNDQ5OnYy", "diffSide": "RIGHT", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMzo0OToyMlrOIMtnHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMzo0OToyMlrOIMtnHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIwMTExNw==", "bodyText": "NonIndexed\n\nthe test table is called indexed. is it indexed or non-indexed?\n\nNonPartitioned\n\nremove\n\nTablesWithDataCompression\n\nCompressedTable", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550201117", "createdAt": "2020-12-30T13:49:22Z", "author": {"login": "findepi"}, "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -417,6 +417,30 @@ public void testShowCreateForPartitionedTablesWithDataCompression()\n                         \")\");\n     }\n \n+    @Test\n+    public void testShowCreateForNonIndexedNonPartitionedTablesWithDataCompression()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MTQ0MTQzOnYy", "diffSide": "RIGHT", "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxNToyODowNVrOIMvhRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxNToyODowNVrOIMvhRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIzMjM5MA==", "bodyText": "Please add comment that SHOW CREATE TABLE does not support indices and table compression yet.", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550232390", "createdAt": "2020-12-30T15:28:05Z", "author": {"login": "ssheikin"}, "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -417,6 +417,30 @@ public void testShowCreateForPartitionedTablesWithDataCompression()\n                         \")\");\n     }\n \n+    @Test\n+    public void testShowCreateForIndexedAndCompressedTable()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MTQ0OTAxOnYy", "diffSide": "RIGHT", "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxNTozMTo0MFrOIMvluA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxNTozMTo0MFrOIMvluA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIzMzUyOA==", "bodyText": "nit: this comment belongs to java now. Once sql code is copied to sql editor this comment is lost. I still think that it has to be within sql.", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r550233528", "createdAt": "2020-12-30T15:31:40Z", "author": {"login": "ssheikin"}, "path": "presto-sqlserver/src/main/java/io/prestosql/plugin/sqlserver/SqlServerClient.java", "diffHunk": "@@ -428,8 +428,11 @@ public void setNull(PreparedStatement statement, int index)\n         return handle.createQuery(\"\" +\n                 \"SELECT data_compression_desc FROM sys.partitions p \" +\n                 \"INNER JOIN sys.tables t ON p.object_id = t.object_id \" +\n+                \"INNER JOIN sys.schemas s ON t.schema_id = s.schema_id \" +\n                 \"INNER JOIN sys.indexes i ON t.object_id = i.object_id \" +\n-                \"WHERE SCHEMA_NAME(t.schema_id) = :schema AND t.name = :table_name AND i.type IN (0,1) \" +\n+                \"WHERE s.name = :schema AND t.name = :table_name \" +\n+                \"AND p.index_id = 0 \" + // Heap", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3MDkzNzcyOnYy", "diffSide": "RIGHT", "path": "plugin/trino-sqlserver/src/test/java/io/trino/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxOToxMjo1MVrOIN9odQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxOToxMjo1MVrOIN9odQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUxMjE4MQ==", "bodyText": "don't you need to drop pfSales and psSales? The best would be to use io.trino.testing.sql.TestTable (modified somehow) for things like that.", "url": "https://github.com/trinodb/trino/pull/6471#discussion_r551512181", "createdAt": "2021-01-04T19:12:51Z", "author": {"login": "kokosing"}, "path": "plugin/trino-sqlserver/src/test/java/io/trino/plugin/sqlserver/TestSqlServerIntegrationSmokeTest.java", "diffHunk": "@@ -415,6 +415,8 @@ public void testShowCreateForPartitionedTablesWithDataCompression()\n                         \"   salesdate date,\\n\" +\n                         \"   quantity integer\\n\" +\n                         \")\");\n+\n+        assertUpdate(\"DROP TABLE partitionedSales\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4301, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}