{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxODUyNDM5", "number": 4931, "title": "Allow to use cluster default role in hive S3 Security Mapping", "bodyText": "@kokosing @electrum please review", "createdAt": "2020-08-21T20:58:28Z", "url": "https://github.com/trinodb/trino/pull/4931", "merged": true, "mergeCommit": {"oid": "46f8f1b4fc585988fbbd0741839583adbc8ab424"}, "closed": true, "closedAt": "2020-09-02T10:36:02Z", "author": {"login": "ssheikin"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdB-JMdgFqTQ3MzIxMTA3OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE2nxjgBqjM3MTgxOTQ4MDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjExMDc4", "url": "https://github.com/trinodb/trino/pull/4931#pullrequestreview-473211078", "createdAt": "2020-08-24T08:12:39Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwODoxMjozOVrOHFZIWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwODoxNDo1N1rOHFZNJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQxNjY2NA==", "bodyText": "no need to extract this function", "url": "https://github.com/trinodb/trino/pull/4931#discussion_r475416664", "createdAt": "2020-08-24T08:12:39Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/s3/S3SecurityMappingConfigurationProvider.java", "diffHunk": "@@ -90,7 +90,12 @@ public void updateConfiguration(Configuration configuration, HdfsContext context\n \n         S3SecurityMapping mapping = mappings.get().getMapping(context.getIdentity(), uri)\n                 .orElseThrow(() -> new AccessDeniedException(\"No matching S3 security mapping\"));\n+        if (mapping.isUseClusterDefault()) return;\n+        updateConfiguration(configuration, context, mapping);\n+    }\n \n+    private void updateConfiguration(Configuration configuration, HdfsContext context, S3SecurityMapping mapping)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQxNzAwNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (mapping.isUseClusterDefault()) return;\n          \n          \n            \n                    if (mapping.isUseClusterDefault()) {\n          \n          \n            \n                         return;\n          \n          \n            \n                     }\n          \n      \n    \n    \n  \n\nPlease always use curly brackets.", "url": "https://github.com/trinodb/trino/pull/4931#discussion_r475417006", "createdAt": "2020-08-24T08:13:18Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/s3/S3SecurityMappingConfigurationProvider.java", "diffHunk": "@@ -90,7 +90,12 @@ public void updateConfiguration(Configuration configuration, HdfsContext context\n \n         S3SecurityMapping mapping = mappings.get().getMapping(context.getIdentity(), uri)\n                 .orElseThrow(() -> new AccessDeniedException(\"No matching S3 security mapping\"));\n+        if (mapping.isUseClusterDefault()) return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQxNzc3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void mappingWithoutRoleCredentialsFallbackShouldFail()\n          \n          \n            \n                public void testMappingWithoutRoleCredentialsFallbackShouldFail()", "url": "https://github.com/trinodb/trino/pull/4931#discussion_r475417774", "createdAt": "2020-08-24T08:14:48Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/s3/TestS3SecurityMapping.java", "diffHunk": "@@ -195,6 +196,69 @@ public void testMapping()\n                 role(\"danny_hq_role\"));\n     }\n \n+    @Test\n+    public void testMappingWithFallbackToClusterDefault()\n+    {\n+        S3SecurityMappingConfig mappingConfig = new S3SecurityMappingConfig()\n+                .setConfigFile(new File(getResource(getClass(), \"security-mapping-with-fallback-to-cluster-default.json\").getPath()));\n+\n+        DynamicConfigurationProvider provider = new S3SecurityMappingConfigurationProvider(mappingConfig);\n+\n+        // matches prefix - returns role from the mapping\n+        assertMapping(\n+                provider,\n+                path(\"s3://bar/abc/data/test.csv\"),\n+                role(\"arn:aws:iam::123456789101:role/allow_path\"));\n+\n+        // doesn't match any rule except default rule at the end\n+        assertMapping(\n+                provider,\n+                empty(),\n+                clusterDefaultRole());\n+    }\n+\n+    @Test\n+    public void testMappingWithoutFallback()\n+    {\n+        S3SecurityMappingConfig mappingConfig = new S3SecurityMappingConfig()\n+                .setConfigFile(new File(getResource(getClass(), \"security-mapping-without-fallback.json\").getPath()));\n+\n+        DynamicConfigurationProvider provider = new S3SecurityMappingConfigurationProvider(mappingConfig);\n+\n+        // matches prefix - returns role from the mapping\n+        assertMapping(\n+                provider,\n+                path(\"s3://bar/abc/data/test.csv\"),\n+                role(\"arn:aws:iam::123456789101:role/allow_path\"));\n+\n+        // doesn't match any rule\n+        assertMappingFails(\n+                provider,\n+                empty(),\n+                \"No matching S3 security mapping\");\n+    }\n+\n+    @Test\n+    public void mappingWithoutRoleCredentialsFallbackShouldFail()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQxNzg5NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void mappingWithRoleAndFallbackShouldFail()\n          \n          \n            \n                public void testMappingWithRoleAndFallbackShouldFail()", "url": "https://github.com/trinodb/trino/pull/4931#discussion_r475417895", "createdAt": "2020-08-24T08:14:57Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/s3/TestS3SecurityMapping.java", "diffHunk": "@@ -195,6 +196,69 @@ public void testMapping()\n                 role(\"danny_hq_role\"));\n     }\n \n+    @Test\n+    public void testMappingWithFallbackToClusterDefault()\n+    {\n+        S3SecurityMappingConfig mappingConfig = new S3SecurityMappingConfig()\n+                .setConfigFile(new File(getResource(getClass(), \"security-mapping-with-fallback-to-cluster-default.json\").getPath()));\n+\n+        DynamicConfigurationProvider provider = new S3SecurityMappingConfigurationProvider(mappingConfig);\n+\n+        // matches prefix - returns role from the mapping\n+        assertMapping(\n+                provider,\n+                path(\"s3://bar/abc/data/test.csv\"),\n+                role(\"arn:aws:iam::123456789101:role/allow_path\"));\n+\n+        // doesn't match any rule except default rule at the end\n+        assertMapping(\n+                provider,\n+                empty(),\n+                clusterDefaultRole());\n+    }\n+\n+    @Test\n+    public void testMappingWithoutFallback()\n+    {\n+        S3SecurityMappingConfig mappingConfig = new S3SecurityMappingConfig()\n+                .setConfigFile(new File(getResource(getClass(), \"security-mapping-without-fallback.json\").getPath()));\n+\n+        DynamicConfigurationProvider provider = new S3SecurityMappingConfigurationProvider(mappingConfig);\n+\n+        // matches prefix - returns role from the mapping\n+        assertMapping(\n+                provider,\n+                path(\"s3://bar/abc/data/test.csv\"),\n+                role(\"arn:aws:iam::123456789101:role/allow_path\"));\n+\n+        // doesn't match any rule\n+        assertMappingFails(\n+                provider,\n+                empty(),\n+                \"No matching S3 security mapping\");\n+    }\n+\n+    @Test\n+    public void mappingWithoutRoleCredentialsFallbackShouldFail()\n+    {\n+        assertThatThrownBy(() ->\n+                new S3SecurityMapping(Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty()))\n+                .isInstanceOf(IllegalArgumentException.class)\n+                .hasMessage(\"must either allow useClusterDefault role or provide role and/or credentials\");\n+    }\n+\n+    @Test\n+    public void mappingWithRoleAndFallbackShouldFail()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 64}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MzgxOTUz", "url": "https://github.com/trinodb/trino/pull/4931#pullrequestreview-474381953", "createdAt": "2020-08-25T11:24:15Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMToyNDoxNVrOHGTfjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMToyNDoxNVrOHGTfjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3Mjg3Nw==", "bodyText": "this checkArgument seems to be covered by the below, and so could be removed", "url": "https://github.com/trinodb/trino/pull/4931#discussion_r476372877", "createdAt": "2020-08-25T11:24:15Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/s3/S3SecurityMapping.java", "diffHunk": "@@ -71,7 +73,11 @@ public S3SecurityMapping(\n         checkArgument(accessKey.isPresent() == secretKey.isPresent(), \"accessKey and secretKey must be provided together\");\n         this.credentials = accessKey.map(access -> new BasicAWSCredentials(access, secretKey.get()));\n \n-        checkArgument(!this.allowedIamRoles.isEmpty() || iamRole.isPresent() || credentials.isPresent(), \"must provide role and/or credentials\");\n+        this.useClusterDefault = requireNonNull(useClusterDefault, \"useClusterDefault is null\")\n+                .orElse(false);\n+        boolean roleOrCredentialsArePresent = !this.allowedIamRoles.isEmpty() || iamRole.isPresent() || credentials.isPresent();\n+        checkArgument(this.useClusterDefault || roleOrCredentialsArePresent, \"must either allow useClusterDefault role or provide role and/or credentials\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NDQ0Mzk5", "url": "https://github.com/trinodb/trino/pull/4931#pullrequestreview-478444399", "createdAt": "2020-08-31T09:09:05Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwOTowOTowNVrOHJwvZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwOTowOTowNVrOHJwvZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk5Nzc5OA==", "bodyText": "This is not true, default configuration could contain a dedicated role or credentials or it could contain useClusterDefault.\nPlease all mention when is going to happen where is no default configuration.", "url": "https://github.com/trinodb/trino/pull/4931#discussion_r479997798", "createdAt": "2020-08-31T09:09:05Z", "author": {"login": "kokosing"}, "path": "presto-docs/src/main/sphinx/connector/hive-s3.rst", "diffHunk": "@@ -158,6 +158,9 @@ For example, the mapping list might have URL prefix ``s3://abc/xyz/`` followed b\n ``s3://abc/`` to allow different configuration for a specific path within a bucket\n than for other paths within the bucket. You can set default configuration by not\n including any match criteria for the last entry in the list.\n+The default configuration could contain only one property", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5MDcxNjIw", "url": "https://github.com/trinodb/trino/pull/4931#pullrequestreview-479071620", "createdAt": "2020-08-31T23:45:11Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo0NToxMVrOHKN9BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo0NToxMVrOHKN9BA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NjQyMA==", "bodyText": "Start a new paragraph for this, so add empty line above. Also\nIn addition to the rules above, the default mapping can contain the ``userClusterDefault`` property set to ``true``. This causes the the default cluster role to be used as a fallback option. It can not be used with the  following configuration properties:\n\n- ``accessKey``\n...", "url": "https://github.com/trinodb/trino/pull/4931#discussion_r480476420", "createdAt": "2020-08-31T23:45:11Z", "author": {"login": "mosabua"}, "path": "presto-docs/src/main/sphinx/connector/hive-s3.rst", "diffHunk": "@@ -158,6 +158,15 @@ For example, the mapping list might have URL prefix ``s3://abc/xyz/`` followed b\n ``s3://abc/`` to allow different configuration for a specific path within a bucket\n than for other paths within the bucket. You can set default configuration by not\n including any match criteria for the last entry in the list.\n+In addition to rules above the default mapping could contain", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5MDc0MzY2", "url": "https://github.com/trinodb/trino/pull/4931#pullrequestreview-479074366", "createdAt": "2020-08-31T23:46:29Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo0NjozMFrOHKN-fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo0NjozMFrOHKN-fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3Njc5Nw==", "bodyText": "If no mapping entry matches and no default is configured, an error AccessDeniedException: Access Denied: No matching S3 security mapping occurs.", "url": "https://github.com/trinodb/trino/pull/4931#discussion_r480476797", "createdAt": "2020-08-31T23:46:30Z", "author": {"login": "mosabua"}, "path": "presto-docs/src/main/sphinx/connector/hive-s3.rst", "diffHunk": "@@ -158,6 +158,15 @@ For example, the mapping list might have URL prefix ``s3://abc/xyz/`` followed b\n ``s3://abc/`` to allow different configuration for a specific path within a bucket\n than for other paths within the bucket. You can set default configuration by not\n including any match criteria for the last entry in the list.\n+In addition to rules above the default mapping could contain\n+``\"useClusterDefault\": \"true\"`` configuration property\n+to use the default cluster role as a fallback option.\n+``useClusterDefault`` could not be used together with other configuration properties\n+(``accessKey``, ``secretKey``, ``iamRole``, ``allowedIamRoles``).\n+In case there is no any mapping entry that fits requirements and no default", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5ODczNTE1", "url": "https://github.com/trinodb/trino/pull/4931#pullrequestreview-479873515", "createdAt": "2020-09-01T15:40:16Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNTo0MDoxNlrOHK8gxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNTo0MToyNVrOHK8jtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzOTIzOA==", "bodyText": "It can be set to false as well. Did you mean 'property when set to'?", "url": "https://github.com/trinodb/trino/pull/4931#discussion_r481239238", "createdAt": "2020-09-01T15:40:16Z", "author": {"login": "kokosing"}, "path": "presto-docs/src/main/sphinx/connector/hive-s3.rst", "diffHunk": "@@ -159,6 +159,19 @@ For example, the mapping list might have URL prefix ``s3://abc/xyz/`` followed b\n than for other paths within the bucket. You can set default configuration by not\n including any match criteria for the last entry in the list.\n \n+In addition to the rules above, the default mapping can contain the\n+``userClusterDefault`` property set to ``true``. This causes the the default", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzOTk4OQ==", "bodyText": "I don't think we should document exact error message. It can easily make docs obsolete.", "url": "https://github.com/trinodb/trino/pull/4931#discussion_r481239989", "createdAt": "2020-09-01T15:41:25Z", "author": {"login": "kokosing"}, "path": "presto-docs/src/main/sphinx/connector/hive-s3.rst", "diffHunk": "@@ -159,6 +159,19 @@ For example, the mapping list might have URL prefix ``s3://abc/xyz/`` followed b\n than for other paths within the bucket. You can set default configuration by not\n including any match criteria for the last entry in the list.\n \n+In addition to the rules above, the default mapping can contain the\n+``userClusterDefault`` property set to ``true``. This causes the the default\n+cluster role to be used as a fallback option. It can not be used with the\n+following configuration properties:\n+\n+- ``accessKey``\n+- ``secretKey``\n+- ``iamRole``\n+- ``allowedIamRoles``\n+\n+If no mapping entry matches and no default is configured, an error\n+``AccessDeniedException: Access Denied: No matching S3 security mapping`` occurs.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b2507c4cb9a0bfb8196b50c276c1359254d2034", "author": {"user": {"login": "ssheikin", "name": "Sasha Sheikin"}}, "url": "https://github.com/trinodb/trino/commit/2b2507c4cb9a0bfb8196b50c276c1359254d2034", "committedDate": "2020-09-02T07:11:05Z", "message": "Allow to use cluster default role in hive S3 Security Mapping"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "2b2507c4cb9a0bfb8196b50c276c1359254d2034", "author": {"user": {"login": "ssheikin", "name": "Sasha Sheikin"}}, "url": "https://github.com/trinodb/trino/commit/2b2507c4cb9a0bfb8196b50c276c1359254d2034", "committedDate": "2020-09-02T07:11:05Z", "message": "Allow to use cluster default role in hive S3 Security Mapping"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4072, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}