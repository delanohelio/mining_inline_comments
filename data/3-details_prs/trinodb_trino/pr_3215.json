{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNDk5ODQ1", "number": 3215, "title": "Remove usage of String.format in HTTP client hot path", "bodyText": "Avoids the use of String.format from the trace token request filter to avoid unnecessary allocations and worse performance in the http client hot path. Allocation profiles showed this as representing one percent of all worker allocations (by number of allocations, not proportional to size) while queries were running. After this change, it represents ~0.2%.", "createdAt": "2020-03-23T16:41:55Z", "url": "https://github.com/trinodb/trino/pull/3215", "merged": true, "mergeCommit": {"oid": "94472a5c2153e031989b15f94c967518dbd48700"}, "closed": true, "closedAt": "2020-03-25T18:20:45Z", "author": {"login": "pettyjamesm"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQkrstgFqTM3OTgxMzM1OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQx9VqgBqjMxNTk0MDM5OTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5ODEzMzU5", "url": "https://github.com/trinodb/trino/pull/3215#pullrequestreview-379813359", "createdAt": "2020-03-23T20:53:11Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QyMDo1MzoxMVrOF6XqbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QyMDo1MzoxMVrOF6XqbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc0OTQyMA==", "bodyText": "Padding on the right is not as good as padding on the left, eg 2nd and 17th numbers: 0x1, 0x10 will result in same token, right?", "url": "https://github.com/trinodb/trino/pull/3215#discussion_r396749420", "createdAt": "2020-03-23T20:53:11Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/server/GenerateTraceTokenRequestFilter.java", "diffHunk": "@@ -29,22 +29,28 @@\n public class GenerateTraceTokenRequestFilter\n         implements HttpRequestFilter\n {\n+    private static final int SEQUENCE_NUMBER_HEX_LENGTH = 10;\n+\n     private final String prefix = randomUUID().toString().toLowerCase(ENGLISH).replace(\"-\", \"\");\n     private final AtomicLong sequence = new AtomicLong();\n \n     @Override\n     public Request filterRequest(Request request)\n     {\n         requireNonNull(request, \"request is null\");\n-        String newToken = createToken(sequence.getAndIncrement());\n         return fromRequest(request)\n-                .setHeader(TRACETOKEN_HEADER, newToken)\n+                .setHeader(TRACETOKEN_HEADER, createToken(sequence.getAndIncrement()))\n                 .build();\n     }\n \n     private String createToken(long value)\n     {\n-        return prefix + format(\"%010x\", value);\n+        StringBuilder builder = new StringBuilder(prefix.length() + SEQUENCE_NUMBER_HEX_LENGTH).append(prefix);\n+        String sequenceNumHex = Long.toHexString(value);\n+        for (int i = sequenceNumHex.length(); i < SEQUENCE_NUMBER_HEX_LENGTH; i++) {\n+            builder.append('0');", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5ODIzNjUw", "url": "https://github.com/trinodb/trino/pull/3215#pullrequestreview-379823650", "createdAt": "2020-03-23T21:08:26Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QyMTowODoyNlrOF6YLCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QyMTowODoyNlrOF6YLCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc1Nzc3MA==", "bodyText": "Maybe keep this as a comment\n// optimized version of this: prefix + format(\"%010x\", value)", "url": "https://github.com/trinodb/trino/pull/3215#discussion_r396757770", "createdAt": "2020-03-23T21:08:26Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/server/GenerateTraceTokenRequestFilter.java", "diffHunk": "@@ -29,22 +29,28 @@\n public class GenerateTraceTokenRequestFilter\n         implements HttpRequestFilter\n {\n+    private static final int SEQUENCE_NUMBER_HEX_LENGTH = 10;\n+\n     private final String prefix = randomUUID().toString().toLowerCase(ENGLISH).replace(\"-\", \"\");\n     private final AtomicLong sequence = new AtomicLong();\n \n     @Override\n     public Request filterRequest(Request request)\n     {\n         requireNonNull(request, \"request is null\");\n-        String newToken = createToken(sequence.getAndIncrement());\n         return fromRequest(request)\n-                .setHeader(TRACETOKEN_HEADER, newToken)\n+                .setHeader(TRACETOKEN_HEADER, createToken(sequence.getAndIncrement()))\n                 .build();\n     }\n \n     private String createToken(long value)\n     {\n-        return prefix + format(\"%010x\", value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5ODIzNjgy", "url": "https://github.com/trinodb/trino/pull/3215#pullrequestreview-379823682", "createdAt": "2020-03-23T21:08:30Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "92c6aa6684f367438a4b797a66455fbba52ba9c7", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/92c6aa6684f367438a4b797a66455fbba52ba9c7", "committedDate": "2020-03-24T12:21:03Z", "message": "Remove usage of String.format in HTTP client hot path\n\nAvoids the use of String.format from the trace token request filter\nto avoid unnecessary allocations and worse performance in the http\nclient hot path. Allocation profiles showed this as representing\none percent of all worker allocations (by number of allocations,\nnot proportional to size) while queries were running. After this\nchange, it represents ~0.2%."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "92c6aa6684f367438a4b797a66455fbba52ba9c7", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/92c6aa6684f367438a4b797a66455fbba52ba9c7", "committedDate": "2020-03-24T12:21:03Z", "message": "Remove usage of String.format in HTTP client hot path\n\nAvoids the use of String.format from the trace token request filter\nto avoid unnecessary allocations and worse performance in the http\nclient hot path. Allocation profiles showed this as representing\none percent of all worker allocations (by number of allocations,\nnot proportional to size) while queries were running. After this\nchange, it represents ~0.2%."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1998, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}