{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzNDU3MDgx", "number": 3434, "title": "Allow using temporary staging path for writing sorted files", "bodyText": "Fixes #471", "createdAt": "2020-04-14T23:09:26Z", "url": "https://github.com/trinodb/trino/pull/3434", "merged": true, "mergeCommit": {"oid": "8b5190cbb498c9f53583302bdf414818ae4ce27c"}, "closed": true, "closedAt": "2020-08-18T09:09:53Z", "author": {"login": "raunaqmorarka"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcX8yONABqjMyMzY4NDU5Mzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdADUIEAFqTQ2OTEzNjgxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NTYzMzE2", "url": "https://github.com/trinodb/trino/pull/3434#pullrequestreview-455563316", "createdAt": "2020-07-27T08:09:33Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwODowOTozNFrOG3X8uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwODowOTozNFrOG3X8uQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcxNzI0MQ==", "bodyText": "If we could generate a path based on this property then we can use it for both fileSystem and when creating SortedFileWriter ?\nsortedWritingTempPath.map(Path::new).orElse(path)", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r460717241", "createdAt": "2020-07-27T08:09:34Z", "author": {"login": "Praveen2112"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveWriterFactory.java", "diffHunk": "@@ -497,7 +500,12 @@ else if (insertExistingPartitionsBehavior == InsertExistingPartitionsBehavior.ER\n         if (!sortedBy.isEmpty()) {\n             FileSystem fileSystem;\n             try {\n-                fileSystem = hdfsEnvironment.getFileSystem(session.getUser(), path, conf);\n+                if (sortedWritingTempPath.isPresent()) {\n+                    fileSystem = hdfsEnvironment.getFileSystem(session.getUser(), new Path(sortedWritingTempPath.get()), conf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Mzg1MzE1", "url": "https://github.com/trinodb/trino/pull/3434#pullrequestreview-457385315", "createdAt": "2020-07-29T10:16:20Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNjY0NDE4", "url": "https://github.com/trinodb/trino/pull/3434#pullrequestreview-460664418", "createdAt": "2020-08-04T09:50:53Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTo1MDo1M1rOG7ZXvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTo1MDo1M1rOG7ZXvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkzNDg0NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            configuration.set(FS_DEFAULT_NAME_KEY, \"file:///\");\n          \n          \n            \n                            configuration.set(FS_DEFAULT_NAME_KEY, FS_DEFAULT_NAME_DEFAULT);", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r464934845", "createdAt": "2020-08-04T09:50:53Z", "author": {"login": "Praveen2112"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveWriterFactory.java", "diffHunk": "@@ -496,8 +500,14 @@ else if (insertExistingPartitionsBehavior == InsertExistingPartitionsBehavior.ER\n \n         if (!sortedBy.isEmpty()) {\n             FileSystem fileSystem;\n+            Path tempFilePath = sortedWritingTempPath\n+                    .map(tempPath -> new Path(tempPath, \".tmp-sort.\" + path.getParent().getName() + \".\" + path.getName()))\n+                    .orElse(new Path(path.getParent(), \".tmp-sort.\" + path.getName()));\n             try {\n-                fileSystem = hdfsEnvironment.getFileSystem(session.getUser(), path, conf);\n+                Configuration configuration = new Configuration(conf);\n+                // Explicitly set the default FS to local file system to avoid getting HDFS when sortedWritingTempPath specifies no scheme\n+                configuration.set(FS_DEFAULT_NAME_KEY, \"file:///\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 43}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMjQ5ODIz", "url": "https://github.com/trinodb/trino/pull/3434#pullrequestreview-462249823", "createdAt": "2020-08-06T07:23:04Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNzoyMzowNFrOG8mdLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNzoyMzo1OVrOG8mfYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5NzgwNQ==", "bodyText": "Commit tittle is too long. It wraps in github.", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r466197805", "createdAt": "2020-08-06T07:23:04Z", "author": {"login": "kokosing"}, "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -262,6 +262,14 @@ Property Name                                      Description\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5ODM3MQ==", "bodyText": "Why not to use hive.temporary-staging-directory-path?", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r466198371", "createdAt": "2020-08-06T07:23:59Z", "author": {"login": "kokosing"}, "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -262,6 +262,14 @@ Property Name                                      Description\n \n ``hive.file-status-cache-expire-time``             How long a cached directory listing should be considered     ``1m``\n                                                    valid.\n+\n+``hive.sorted-writing-temp-path``                  Directory used for temporary files while writing bucketed", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NjY1MzEy", "url": "https://github.com/trinodb/trino/pull/3434#pullrequestreview-465665312", "createdAt": "2020-08-12T07:41:33Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3Mzc4MTA3", "url": "https://github.com/trinodb/trino/pull/3434#pullrequestreview-467378107", "createdAt": "2020-08-14T07:57:33Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNzo1NzozM1rOHArMWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNzo1NzozM1rOHArMWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ2OTcyMA==", "bodyText": "Could you also add docs for hive.temporary-staging-directory-path and hive.temporary-staging-directory-enabled with session properties? It is a pity that you refer to something that does not exists. Possibly that should be done in separate commit.", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r470469720", "createdAt": "2020-08-14T07:57:33Z", "author": {"login": "kokosing"}, "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -262,6 +262,16 @@ Property Name                                      Description\n \n ``hive.file-status-cache-expire-time``             How long a cached directory listing should be considered     ``1m``\n                                                    valid.\n+\n+``hive.sorted-writing-temp-staging-path-enabled``  Use ``hive.temporary-staging-directory-path`` for temporary  false", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "df0c056eec3a4279665b27ce3b189bb46312cda6", "author": {"user": {"login": "raunaqmorarka", "name": "Raunaq Morarka"}}, "url": "https://github.com/trinodb/trino/commit/df0c056eec3a4279665b27ce3b189bb46312cda6", "committedDate": "2020-08-16T07:00:04Z", "message": "Allow using temporary staging path for writing sorted files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "414846c0bdae2c43b6f992ef72dd166f00efbd5a", "author": {"user": {"login": "raunaqmorarka", "name": "Raunaq Morarka"}}, "url": "https://github.com/trinodb/trino/commit/414846c0bdae2c43b6f992ef72dd166f00efbd5a", "committedDate": "2020-08-16T07:00:05Z", "message": "Document hive temporary staging directory configs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "414846c0bdae2c43b6f992ef72dd166f00efbd5a", "author": {"user": {"login": "raunaqmorarka", "name": "Raunaq Morarka"}}, "url": "https://github.com/trinodb/trino/commit/414846c0bdae2c43b6f992ef72dd166f00efbd5a", "committedDate": "2020-08-16T07:00:05Z", "message": "Document hive temporary staging directory configs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4Mzc4MDg1", "url": "https://github.com/trinodb/trino/pull/3434#pullrequestreview-468378085", "createdAt": "2020-08-17T11:21:58Z", "commit": {"oid": "df0c056eec3a4279665b27ce3b189bb46312cda6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMToyMTo1OFrOHBku_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMToyMTo1OFrOHBku_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQxMjQ3OA==", "bodyText": "don't you need to use io.prestosql.plugin.hive.util.HiveWriteUtils#createTemporaryPath?", "url": "https://github.com/trinodb/trino/pull/3434#discussion_r471412478", "createdAt": "2020-08-17T11:21:58Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/AbstractTestHive.java", "diffHunk": "@@ -2335,9 +2337,17 @@ private void doTestBucketSortedTables(SchemaTableName table)\n                 sink.appendPage(builder.build().toPage());\n             }\n \n-            // verify we have enough temporary files per bucket to require multiple passes\n-            Path stagingPathRoot = getStagingPathRoot(outputHandle);\n             HdfsContext context = new HdfsContext(session, table.getSchemaName(), table.getTableName());\n+            // verify we have enough temporary files per bucket to require multiple passes\n+            Path stagingPathRoot;\n+            if (isTemporaryStagingDirectoryEnabled(session)) {\n+                stagingPathRoot = new Path(getTemporaryStagingDirectoryPath(session)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df0c056eec3a4279665b27ce3b189bb46312cda6"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MTM2ODEx", "url": "https://github.com/trinodb/trino/pull/3434#pullrequestreview-469136811", "createdAt": "2020-08-18T09:08:56Z", "commit": {"oid": "414846c0bdae2c43b6f992ef72dd166f00efbd5a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1517, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}