{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MDY0NzQ5", "number": 6067, "title": "Propagate more information from ConnectorSession to ConnectionFactory", "bodyText": "Additional information from ConnectorSession is required\nto support audit in not public connectors\nto correlate query in Presto with query w RDBMS\nis based on #6110", "createdAt": "2020-11-23T23:50:42Z", "url": "https://github.com/trinodb/trino/pull/6067", "merged": true, "mergeCommit": {"oid": "ae830d65c76fdb9c0e253360d8b64b2c9c8601de"}, "closed": true, "closedAt": "2020-11-27T12:34:32Z", "author": {"login": "ssheikin"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfefu5ABqjQwMzAxOTcyNTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgmu8ogFqTUzOTk0NTA4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MjEwNjg4", "url": "https://github.com/trinodb/trino/pull/6067#pullrequestreview-537210688", "createdAt": "2020-11-24T08:28:43Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwODoyODo0M1rOH4xI1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwODoyODo0M1rOH4xI1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI4NzM4MQ==", "bodyText": "ConnectorSession is not a good candidate for the cache key and we avoided it so far", "url": "https://github.com/trinodb/trino/pull/6067#discussion_r529287381", "createdAt": "2020-11-24T08:28:43Z", "author": {"login": "findepi"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/CachingJdbcClient.java", "diffHunk": "@@ -55,7 +55,7 @@\n     private final JdbcClient delegate;\n     private final boolean cacheMissing;\n \n-    private final LoadingCache<JdbcIdentity, Set<String>> schemaNamesCache;\n+    private final LoadingCache<ConnectorSession, Set<String>> schemaNamesCache;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MjM1MzMx", "url": "https://github.com/trinodb/trino/pull/6067#pullrequestreview-537235331", "createdAt": "2020-11-24T08:41:20Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwODo0MToyMFrOH4xn-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMTozNToxN1rOH48yIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI5NTM1Mw==", "bodyText": "Do we still need JdbcIdentity? Where it is still used besides caching?", "url": "https://github.com/trinodb/trino/pull/6067#discussion_r529295353", "createdAt": "2020-11-24T08:41:20Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -259,7 +261,7 @@ protected boolean filterSchema(String schemaName)\n     @Override\n     public List<JdbcColumnHandle> getColumns(ConnectorSession session, JdbcTableHandle tableHandle)\n     {\n-        try (Connection connection = connectionFactory.openConnection(JdbcIdentity.from(session));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI5NzA0NQ==", "bodyText": "ConnectorSession has plenty runtime information. Even query id changes every single query.", "url": "https://github.com/trinodb/trino/pull/6067#discussion_r529297045", "createdAt": "2020-11-24T08:44:01Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/CachingJdbcClient.java", "diffHunk": "@@ -55,7 +55,7 @@\n     private final JdbcClient delegate;\n     private final boolean cacheMissing;\n \n-    private final LoadingCache<JdbcIdentity, Set<String>> schemaNamesCache;\n+    private final LoadingCache<ConnectorSession, Set<String>> schemaNamesCache;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI4NzM4MQ=="}, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ3NzYxNw==", "bodyText": "First of all we need to fix getColumns. Then we need to use same approach for other methods that are using cache here.\nSession contains properties that may influence the behavior of the method. We need to use them in the cache key. Please handle that in separate commit.", "url": "https://github.com/trinodb/trino/pull/6067#discussion_r529477617", "createdAt": "2020-11-24T11:34:24Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/CachingJdbcClient.java", "diffHunk": "@@ -107,7 +107,7 @@ public boolean schemaExists(JdbcIdentity identity, String schema)\n             return tableHandle.getColumns().get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ3ODE3OA==", "bodyText": "Do you think it make sense to divide this commit into two? One for jdbc client and other for connection factory?", "url": "https://github.com/trinodb/trino/pull/6067#discussion_r529478178", "createdAt": "2020-11-24T11:35:17Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/BaseJdbcClient.java", "diffHunk": "@@ -167,9 +167,9 @@ public BaseJdbcClient(\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b49f174a1dab886dbe3e17ccd9c833a22a74f27", "author": {"user": {"login": "ssheikin", "name": "Sasha Sheikin"}}, "url": "https://github.com/trinodb/trino/commit/0b49f174a1dab886dbe3e17ccd9c833a22a74f27", "committedDate": "2020-11-27T10:27:52Z", "message": "Propagate more information from ConnectorSession to ConnectionFactory\n\nAdditional information from ConnectorSession is required\nto support audit in not public connectors\nto correlate query in Presto with query w RDBMS"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "0b49f174a1dab886dbe3e17ccd9c833a22a74f27", "author": {"user": {"login": "ssheikin", "name": "Sasha Sheikin"}}, "url": "https://github.com/trinodb/trino/commit/0b49f174a1dab886dbe3e17ccd9c833a22a74f27", "committedDate": "2020-11-27T10:27:52Z", "message": "Propagate more information from ConnectorSession to ConnectionFactory\n\nAdditional information from ConnectorSession is required\nto support audit in not public connectors\nto correlate query in Presto with query w RDBMS"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5OTM4OTg5", "url": "https://github.com/trinodb/trino/pull/6067#pullrequestreview-539938989", "createdAt": "2020-11-27T12:20:15Z", "commit": {"oid": "0b49f174a1dab886dbe3e17ccd9c833a22a74f27"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5OTQ1MDgx", "url": "https://github.com/trinodb/trino/pull/6067#pullrequestreview-539945081", "createdAt": "2020-11-27T12:30:29Z", "commit": {"oid": "0b49f174a1dab886dbe3e17ccd9c833a22a74f27"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2280, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}