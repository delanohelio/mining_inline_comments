{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NTMyODQ2", "number": 5874, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwOToyMDo0NVrOE2rBMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyOTo1OVrOE7wTUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzYzMzc4OnYy", "diffSide": "RIGHT", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwOToyMDo0NVrOHvleVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQyMjo1MTozMVrOH3x_Tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY1OTA5Mw==", "bodyText": "There is no point in logging when you throw", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r519659093", "createdAt": "2020-11-09T09:20:45Z", "author": {"login": "kokosing"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "diffHunk": "@@ -143,7 +147,13 @@ private Principal authenticateWithUserBind(Credential credential)\n             String userDistinguishedName = createUserDistinguishedName(user);\n             if (groupAuthorizationSearchPattern.isPresent()) {\n                 // user password is also validated as user DN and password is used for querying LDAP\n-                checkGroupMembership(user, userDistinguishedName, credential.getPassword());\n+                String searchBase = userBaseDistinguishedName.orElseThrow();\n+                String groupSearch = replaceUser(groupAuthorizationSearchPattern.get(), user);\n+                if (!isGroupMember(searchBase, groupSearch, userDistinguishedName, credential.getPassword())) {\n+                    String message = format(\"User [%s] not a member of an authorized group\", user);\n+                    log.debug(message);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ2MDQ5Ng==", "bodyText": "I agree, but all of the code in this class logs and throws, so I copied the style of the existing code.", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r525460496", "createdAt": "2020-11-17T19:56:10Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "diffHunk": "@@ -143,7 +147,13 @@ private Principal authenticateWithUserBind(Credential credential)\n             String userDistinguishedName = createUserDistinguishedName(user);\n             if (groupAuthorizationSearchPattern.isPresent()) {\n                 // user password is also validated as user DN and password is used for querying LDAP\n-                checkGroupMembership(user, userDistinguishedName, credential.getPassword());\n+                String searchBase = userBaseDistinguishedName.orElseThrow();\n+                String groupSearch = replaceUser(groupAuthorizationSearchPattern.get(), user);\n+                if (!isGroupMember(searchBase, groupSearch, userDistinguishedName, credential.getPassword())) {\n+                    String message = format(\"User [%s] not a member of an authorized group\", user);\n+                    log.debug(message);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY1OTA5Mw=="}, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyODI3NA==", "bodyText": "The authentication code is kind of an exception, since the access denied causes an auth failure without any stack trace or logging. We might want to move the logging to the authentication system itself, but that's a separate project from this refactoring.", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r526528274", "createdAt": "2020-11-19T01:16:16Z", "author": {"login": "electrum"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "diffHunk": "@@ -143,7 +147,13 @@ private Principal authenticateWithUserBind(Credential credential)\n             String userDistinguishedName = createUserDistinguishedName(user);\n             if (groupAuthorizationSearchPattern.isPresent()) {\n                 // user password is also validated as user DN and password is used for querying LDAP\n-                checkGroupMembership(user, userDistinguishedName, credential.getPassword());\n+                String searchBase = userBaseDistinguishedName.orElseThrow();\n+                String groupSearch = replaceUser(groupAuthorizationSearchPattern.get(), user);\n+                if (!isGroupMember(searchBase, groupSearch, userDistinguishedName, credential.getPassword())) {\n+                    String message = format(\"User [%s] not a member of an authorized group\", user);\n+                    log.debug(message);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY1OTA5Mw=="}, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI1Mjc1MA==", "bodyText": "Talked to @electrum, we're going to leave this as is for now", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r528252750", "createdAt": "2020-11-21T22:51:31Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "diffHunk": "@@ -143,7 +147,13 @@ private Principal authenticateWithUserBind(Credential credential)\n             String userDistinguishedName = createUserDistinguishedName(user);\n             if (groupAuthorizationSearchPattern.isPresent()) {\n                 // user password is also validated as user DN and password is used for querying LDAP\n-                checkGroupMembership(user, userDistinguishedName, credential.getPassword());\n+                String searchBase = userBaseDistinguishedName.orElseThrow();\n+                String groupSearch = replaceUser(groupAuthorizationSearchPattern.get(), user);\n+                if (!isGroupMember(searchBase, groupSearch, userDistinguishedName, credential.getPassword())) {\n+                    String message = format(\"User [%s] not a member of an authorized group\", user);\n+                    log.debug(message);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY1OTA5Mw=="}, "originalCommit": null, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MjQ0ODUzOnYy", "diffSide": "RIGHT", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjoyNDoxNVrOH0ybLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjoyNDoxNVrOH0ybLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTExNDE1Nw==", "bodyText": "same", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r525114157", "createdAt": "2020-11-17T12:24:15Z", "author": {"login": "kokosing"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "diffHunk": "@@ -230,42 +224,53 @@ static boolean containsSpecialCharacters(String user)\n         return SPECIAL_CHARACTERS.matchesAnyOf(user);\n     }\n \n-    private String validateGroupMembership(String user, DirContext context)\n+    private String lookupUserDistinguishedName(String user)\n             throws NamingException\n     {\n-        NamingEnumeration<SearchResult> search = searchGroupMembership(user, context);\n-        try {\n-            if (!search.hasMore()) {\n-                String message = format(\"User [%s] not a member of an authorized group\", user);\n-                log.debug(message);\n-                throw new AccessDeniedException(message);\n-            }\n+        String searchBase = userBaseDistinguishedName.orElseThrow();\n+        String searchFilter = replaceUser(groupAuthorizationSearchPattern.orElseThrow(), user);\n+        Set<String> userDistinguishedNames = lookupUserDistinguishedName(searchBase, searchFilter, bindDistinguishedName.orElseThrow(), bindPassword.orElseThrow());\n+        if (userDistinguishedNames.isEmpty()) {\n+            String message = format(\"User [%s] not a member of an authorized group\", user);\n+            log.debug(message);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MjQ0ODczOnYy", "diffSide": "RIGHT", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjoyNDoxOVrOH0ybTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjoyNDoxOVrOH0ybTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTExNDE4OA==", "bodyText": "same", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r525114188", "createdAt": "2020-11-17T12:24:19Z", "author": {"login": "kokosing"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "diffHunk": "@@ -230,42 +224,53 @@ static boolean containsSpecialCharacters(String user)\n         return SPECIAL_CHARACTERS.matchesAnyOf(user);\n     }\n \n-    private String validateGroupMembership(String user, DirContext context)\n+    private String lookupUserDistinguishedName(String user)\n             throws NamingException\n     {\n-        NamingEnumeration<SearchResult> search = searchGroupMembership(user, context);\n-        try {\n-            if (!search.hasMore()) {\n-                String message = format(\"User [%s] not a member of an authorized group\", user);\n-                log.debug(message);\n-                throw new AccessDeniedException(message);\n-            }\n+        String searchBase = userBaseDistinguishedName.orElseThrow();\n+        String searchFilter = replaceUser(groupAuthorizationSearchPattern.orElseThrow(), user);\n+        Set<String> userDistinguishedNames = lookupUserDistinguishedName(searchBase, searchFilter, bindDistinguishedName.orElseThrow(), bindPassword.orElseThrow());\n+        if (userDistinguishedNames.isEmpty()) {\n+            String message = format(\"User [%s] not a member of an authorized group\", user);\n+            log.debug(message);\n+            throw new AccessDeniedException(message);\n+        }\n+        if (userDistinguishedNames.size() > 1) {\n+            String message = format(\"Multiple group membership results for user [%s]: %s\", user, userDistinguishedNames);\n+            log.debug(message);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MjQ1Nzg0OnYy", "diffSide": "RIGHT", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/JdkLdapAuthenticatorClient.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjoyNjozOVrOH0ygrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzoyNzoyOVrOH2GbOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTExNTU2Nw==", "bodyText": "try with resources?\nIf DirContext is not closeable then:\ntry (CloseableWrapper<DirContext> context = wrap(createUserDirContext(contextUserDistinguishedName, contextPassword)) {\n\n?", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r525115567", "createdAt": "2020-11-17T12:26:39Z", "author": {"login": "kokosing"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/JdkLdapAuthenticatorClient.java", "diffHunk": "@@ -0,0 +1,192 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.ldap;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSet.Builder;\n+import io.airlift.log.Logger;\n+import io.airlift.security.pem.PemReader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+\n+import javax.inject.Inject;\n+import javax.naming.AuthenticationException;\n+import javax.naming.NamingEnumeration;\n+import javax.naming.NamingException;\n+import javax.naming.directory.DirContext;\n+import javax.naming.directory.SearchControls;\n+import javax.naming.directory.SearchResult;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.TrustManagerFactory;\n+import javax.net.ssl.X509TrustManager;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.security.GeneralSecurityException;\n+import java.security.KeyStore;\n+import java.util.Arrays;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import static io.prestosql.plugin.password.jndi.JndiUtils.createDirContext;\n+import static java.util.Objects.requireNonNull;\n+import static javax.naming.Context.INITIAL_CONTEXT_FACTORY;\n+import static javax.naming.Context.PROVIDER_URL;\n+import static javax.naming.Context.REFERRAL;\n+import static javax.naming.Context.SECURITY_AUTHENTICATION;\n+import static javax.naming.Context.SECURITY_CREDENTIALS;\n+import static javax.naming.Context.SECURITY_PRINCIPAL;\n+\n+public class JdkLdapAuthenticatorClient\n+        implements LdapAuthenticatorClient\n+{\n+    private static final Logger log = Logger.get(JdkLdapAuthenticatorClient.class);\n+\n+    private final Map<String, String> basicEnvironment;\n+    private final Optional<SSLContext> sslContext;\n+\n+    @Inject\n+    public JdkLdapAuthenticatorClient(LdapConfig ldapConfig)\n+    {\n+        String ldapUrl = requireNonNull(ldapConfig.getLdapUrl(), \"ldapUrl is null\");\n+        if (ldapUrl.startsWith(\"ldap://\")) {\n+            log.warn(\"Passwords will be sent in the clear to the LDAP server. Please consider using SSL to connect.\");\n+        }\n+\n+        this.basicEnvironment = ImmutableMap.<String, String>builder()\n+                .put(INITIAL_CONTEXT_FACTORY, \"com.sun.jndi.ldap.LdapCtxFactory\")\n+                .put(PROVIDER_URL, ldapUrl)\n+                .put(REFERRAL, ldapConfig.isIgnoreReferrals() ? \"ignore\" : \"follow\")\n+                .build();\n+\n+        this.sslContext = Optional.ofNullable(ldapConfig.getTrustCertificate())\n+                .map(JdkLdapAuthenticatorClient::createSslContext);\n+    }\n+\n+    @Override\n+    public void validatePassword(String userDistinguishedName, String password)\n+            throws NamingException\n+    {\n+        createUserDirContext(userDistinguishedName, password).close();\n+    }\n+\n+    @Override\n+    public boolean isGroupMember(String searchBase, String groupSearch, String contextUserDistinguishedName, String contextPassword)\n+            throws NamingException\n+    {\n+        DirContext context = createUserDirContext(contextUserDistinguishedName, contextPassword);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ1ODc3MA==", "bodyText": "I didn't know about CloseableWrapper I'll give it a try", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r525458770", "createdAt": "2020-11-17T19:54:48Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/JdkLdapAuthenticatorClient.java", "diffHunk": "@@ -0,0 +1,192 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.ldap;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSet.Builder;\n+import io.airlift.log.Logger;\n+import io.airlift.security.pem.PemReader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+\n+import javax.inject.Inject;\n+import javax.naming.AuthenticationException;\n+import javax.naming.NamingEnumeration;\n+import javax.naming.NamingException;\n+import javax.naming.directory.DirContext;\n+import javax.naming.directory.SearchControls;\n+import javax.naming.directory.SearchResult;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.TrustManagerFactory;\n+import javax.net.ssl.X509TrustManager;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.security.GeneralSecurityException;\n+import java.security.KeyStore;\n+import java.util.Arrays;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import static io.prestosql.plugin.password.jndi.JndiUtils.createDirContext;\n+import static java.util.Objects.requireNonNull;\n+import static javax.naming.Context.INITIAL_CONTEXT_FACTORY;\n+import static javax.naming.Context.PROVIDER_URL;\n+import static javax.naming.Context.REFERRAL;\n+import static javax.naming.Context.SECURITY_AUTHENTICATION;\n+import static javax.naming.Context.SECURITY_CREDENTIALS;\n+import static javax.naming.Context.SECURITY_PRINCIPAL;\n+\n+public class JdkLdapAuthenticatorClient\n+        implements LdapAuthenticatorClient\n+{\n+    private static final Logger log = Logger.get(JdkLdapAuthenticatorClient.class);\n+\n+    private final Map<String, String> basicEnvironment;\n+    private final Optional<SSLContext> sslContext;\n+\n+    @Inject\n+    public JdkLdapAuthenticatorClient(LdapConfig ldapConfig)\n+    {\n+        String ldapUrl = requireNonNull(ldapConfig.getLdapUrl(), \"ldapUrl is null\");\n+        if (ldapUrl.startsWith(\"ldap://\")) {\n+            log.warn(\"Passwords will be sent in the clear to the LDAP server. Please consider using SSL to connect.\");\n+        }\n+\n+        this.basicEnvironment = ImmutableMap.<String, String>builder()\n+                .put(INITIAL_CONTEXT_FACTORY, \"com.sun.jndi.ldap.LdapCtxFactory\")\n+                .put(PROVIDER_URL, ldapUrl)\n+                .put(REFERRAL, ldapConfig.isIgnoreReferrals() ? \"ignore\" : \"follow\")\n+                .build();\n+\n+        this.sslContext = Optional.ofNullable(ldapConfig.getTrustCertificate())\n+                .map(JdkLdapAuthenticatorClient::createSslContext);\n+    }\n+\n+    @Override\n+    public void validatePassword(String userDistinguishedName, String password)\n+            throws NamingException\n+    {\n+        createUserDirContext(userDistinguishedName, password).close();\n+    }\n+\n+    @Override\n+    public boolean isGroupMember(String searchBase, String groupSearch, String contextUserDistinguishedName, String contextPassword)\n+            throws NamingException\n+    {\n+        DirContext context = createUserDirContext(contextUserDistinguishedName, contextPassword);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTExNTU2Nw=="}, "originalCommit": null, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ2MTE1NA==", "bodyText": "I just make up this name, you would need to write your own. My point was wrap non closeable object as closeable so you could use try-with-resources.", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r525461154", "createdAt": "2020-11-17T19:56:44Z", "author": {"login": "kokosing"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/JdkLdapAuthenticatorClient.java", "diffHunk": "@@ -0,0 +1,192 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.ldap;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSet.Builder;\n+import io.airlift.log.Logger;\n+import io.airlift.security.pem.PemReader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+\n+import javax.inject.Inject;\n+import javax.naming.AuthenticationException;\n+import javax.naming.NamingEnumeration;\n+import javax.naming.NamingException;\n+import javax.naming.directory.DirContext;\n+import javax.naming.directory.SearchControls;\n+import javax.naming.directory.SearchResult;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.TrustManagerFactory;\n+import javax.net.ssl.X509TrustManager;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.security.GeneralSecurityException;\n+import java.security.KeyStore;\n+import java.util.Arrays;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import static io.prestosql.plugin.password.jndi.JndiUtils.createDirContext;\n+import static java.util.Objects.requireNonNull;\n+import static javax.naming.Context.INITIAL_CONTEXT_FACTORY;\n+import static javax.naming.Context.PROVIDER_URL;\n+import static javax.naming.Context.REFERRAL;\n+import static javax.naming.Context.SECURITY_AUTHENTICATION;\n+import static javax.naming.Context.SECURITY_CREDENTIALS;\n+import static javax.naming.Context.SECURITY_PRINCIPAL;\n+\n+public class JdkLdapAuthenticatorClient\n+        implements LdapAuthenticatorClient\n+{\n+    private static final Logger log = Logger.get(JdkLdapAuthenticatorClient.class);\n+\n+    private final Map<String, String> basicEnvironment;\n+    private final Optional<SSLContext> sslContext;\n+\n+    @Inject\n+    public JdkLdapAuthenticatorClient(LdapConfig ldapConfig)\n+    {\n+        String ldapUrl = requireNonNull(ldapConfig.getLdapUrl(), \"ldapUrl is null\");\n+        if (ldapUrl.startsWith(\"ldap://\")) {\n+            log.warn(\"Passwords will be sent in the clear to the LDAP server. Please consider using SSL to connect.\");\n+        }\n+\n+        this.basicEnvironment = ImmutableMap.<String, String>builder()\n+                .put(INITIAL_CONTEXT_FACTORY, \"com.sun.jndi.ldap.LdapCtxFactory\")\n+                .put(PROVIDER_URL, ldapUrl)\n+                .put(REFERRAL, ldapConfig.isIgnoreReferrals() ? \"ignore\" : \"follow\")\n+                .build();\n+\n+        this.sslContext = Optional.ofNullable(ldapConfig.getTrustCertificate())\n+                .map(JdkLdapAuthenticatorClient::createSslContext);\n+    }\n+\n+    @Override\n+    public void validatePassword(String userDistinguishedName, String password)\n+            throws NamingException\n+    {\n+        createUserDirContext(userDistinguishedName, password).close();\n+    }\n+\n+    @Override\n+    public boolean isGroupMember(String searchBase, String groupSearch, String contextUserDistinguishedName, String contextPassword)\n+            throws NamingException\n+    {\n+        DirContext context = createUserDirContext(contextUserDistinguishedName, contextPassword);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTExNTU2Nw=="}, "originalCommit": null, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5MDQyNw==", "bodyText": "This entire code base is already using try/finally, so this follows the existing code.", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r526490427", "createdAt": "2020-11-18T23:27:29Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/JdkLdapAuthenticatorClient.java", "diffHunk": "@@ -0,0 +1,192 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.ldap;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSet.Builder;\n+import io.airlift.log.Logger;\n+import io.airlift.security.pem.PemReader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+\n+import javax.inject.Inject;\n+import javax.naming.AuthenticationException;\n+import javax.naming.NamingEnumeration;\n+import javax.naming.NamingException;\n+import javax.naming.directory.DirContext;\n+import javax.naming.directory.SearchControls;\n+import javax.naming.directory.SearchResult;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.TrustManagerFactory;\n+import javax.net.ssl.X509TrustManager;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.security.GeneralSecurityException;\n+import java.security.KeyStore;\n+import java.util.Arrays;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import static io.prestosql.plugin.password.jndi.JndiUtils.createDirContext;\n+import static java.util.Objects.requireNonNull;\n+import static javax.naming.Context.INITIAL_CONTEXT_FACTORY;\n+import static javax.naming.Context.PROVIDER_URL;\n+import static javax.naming.Context.REFERRAL;\n+import static javax.naming.Context.SECURITY_AUTHENTICATION;\n+import static javax.naming.Context.SECURITY_CREDENTIALS;\n+import static javax.naming.Context.SECURITY_PRINCIPAL;\n+\n+public class JdkLdapAuthenticatorClient\n+        implements LdapAuthenticatorClient\n+{\n+    private static final Logger log = Logger.get(JdkLdapAuthenticatorClient.class);\n+\n+    private final Map<String, String> basicEnvironment;\n+    private final Optional<SSLContext> sslContext;\n+\n+    @Inject\n+    public JdkLdapAuthenticatorClient(LdapConfig ldapConfig)\n+    {\n+        String ldapUrl = requireNonNull(ldapConfig.getLdapUrl(), \"ldapUrl is null\");\n+        if (ldapUrl.startsWith(\"ldap://\")) {\n+            log.warn(\"Passwords will be sent in the clear to the LDAP server. Please consider using SSL to connect.\");\n+        }\n+\n+        this.basicEnvironment = ImmutableMap.<String, String>builder()\n+                .put(INITIAL_CONTEXT_FACTORY, \"com.sun.jndi.ldap.LdapCtxFactory\")\n+                .put(PROVIDER_URL, ldapUrl)\n+                .put(REFERRAL, ldapConfig.isIgnoreReferrals() ? \"ignore\" : \"follow\")\n+                .build();\n+\n+        this.sslContext = Optional.ofNullable(ldapConfig.getTrustCertificate())\n+                .map(JdkLdapAuthenticatorClient::createSslContext);\n+    }\n+\n+    @Override\n+    public void validatePassword(String userDistinguishedName, String password)\n+            throws NamingException\n+    {\n+        createUserDirContext(userDistinguishedName, password).close();\n+    }\n+\n+    @Override\n+    public boolean isGroupMember(String searchBase, String groupSearch, String contextUserDistinguishedName, String contextPassword)\n+            throws NamingException\n+    {\n+        DirContext context = createUserDirContext(contextUserDistinguishedName, contextPassword);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTExNTU2Nw=="}, "originalCommit": null, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MjQ2OTQwOnYy", "diffSide": "RIGHT", "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/ldap/TestLdapAuthenticator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjoyOTo1NFrOH0ynlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo1NDoyOFrOH1HbeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTExNzMzMw==", "bodyText": "We also need real product tests with real ldap service. See io.prestosql.tests.jdbc.TestLdapPrestoJdbc", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r525117333", "createdAt": "2020-11-17T12:29:54Z", "author": {"login": "kokosing"}, "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/ldap/TestLdapAuthenticator.java", "diffHunk": "@@ -50,4 +144,67 @@ public void testContainsSpecialCharacters()\n                 .as(\"Angle brackets\")\n                 .isEqualTo(true);\n     }\n+\n+    private static class TestLdapAuthenticatorClient", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ1ODI5Ng==", "bodyText": "I don't think we need a real product test.  This code verifies that both paths are checked.  So for an integration, if one test works, multiple will work by extension.", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r525458296", "createdAt": "2020-11-17T19:54:28Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/ldap/TestLdapAuthenticator.java", "diffHunk": "@@ -50,4 +144,67 @@ public void testContainsSpecialCharacters()\n                 .as(\"Angle brackets\")\n                 .isEqualTo(true);\n     }\n+\n+    private static class TestLdapAuthenticatorClient", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTExNzMzMw=="}, "originalCommit": null, "originalPosition": 112}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxMDkyMDAyOnYy", "diffSide": "RIGHT", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyNDoxMVrOH3kzOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyNDoxMVrOH3kzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAzNjY2NA==", "bodyText": "Let's fix all these to do the formatting in the logger call", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r528036664", "createdAt": "2020-11-21T00:24:11Z", "author": {"login": "electrum"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "diffHunk": "@@ -143,7 +147,13 @@ private Principal authenticateWithUserBind(Credential credential)\n             String userDistinguishedName = createUserDistinguishedName(user);\n             if (groupAuthorizationSearchPattern.isPresent()) {\n                 // user password is also validated as user DN and password is used for querying LDAP\n-                checkGroupMembership(user, userDistinguishedName, credential.getPassword());\n+                String searchBase = userBaseDistinguishedName.orElseThrow();\n+                String groupSearch = replaceUser(groupAuthorizationSearchPattern.get(), user);\n+                if (!isGroupMember(searchBase, groupSearch, userDistinguishedName, credential.getPassword())) {\n+                    String message = format(\"User [%s] not a member of an authorized group\", user);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxMDkyMDk4OnYy", "diffSide": "RIGHT", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyNDo0MlrOH3kztg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyNDo0MlrOH3kztg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAzNjc5MA==", "bodyText": "Don't import Builder since it's ambiguous by itself", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r528036790", "createdAt": "2020-11-21T00:24:42Z", "author": {"login": "electrum"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "diffHunk": "@@ -19,6 +19,9 @@\n import com.google.common.cache.CacheLoader;\n import com.google.common.cache.LoadingCache;\n import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSet.Builder;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxMDkyMjQxOnYy", "diffSide": "RIGHT", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyNTozM1rOH3k0cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyNTozM1rOH3k0cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAzNjk3Nw==", "bodyText": "Static import", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r528036977", "createdAt": "2020-11-21T00:25:33Z", "author": {"login": "electrum"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "diffHunk": "@@ -230,42 +224,53 @@ static boolean containsSpecialCharacters(String user)\n         return SPECIAL_CHARACTERS.matchesAnyOf(user);\n     }\n \n-    private String validateGroupMembership(String user, DirContext context)\n+    private String lookupUserDistinguishedName(String user)\n             throws NamingException\n     {\n-        NamingEnumeration<SearchResult> search = searchGroupMembership(user, context);\n-        try {\n-            if (!search.hasMore()) {\n-                String message = format(\"User [%s] not a member of an authorized group\", user);\n-                log.debug(message);\n-                throw new AccessDeniedException(message);\n-            }\n+        String searchBase = userBaseDistinguishedName.orElseThrow();\n+        String searchFilter = replaceUser(groupAuthorizationSearchPattern.orElseThrow(), user);\n+        Set<String> userDistinguishedNames = lookupUserDistinguishedName(searchBase, searchFilter, bindDistinguishedName.orElseThrow(), bindPassword.orElseThrow());\n+        if (userDistinguishedNames.isEmpty()) {\n+            String message = format(\"User [%s] not a member of an authorized group\", user);\n+            log.debug(message);\n+            throw new AccessDeniedException(message);\n+        }\n+        if (userDistinguishedNames.size() > 1) {\n+            String message = format(\"Multiple group membership results for user [%s]: %s\", user, userDistinguishedNames);\n+            log.debug(message);\n+            throw new AccessDeniedException(message);\n+        }\n+        return Iterables.getOnlyElement(userDistinguishedNames);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxMDkyNDM1OnYy", "diffSide": "RIGHT", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticatorClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyNjo1OVrOH3k1ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyNjo1OVrOH3k1ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAzNzI1OA==", "bodyText": "This might not be the best checked exception to use for generic LDAP clients, but we can update that later if needed", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r528037258", "createdAt": "2020-11-21T00:26:59Z", "author": {"login": "electrum"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticatorClient.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.ldap;\n+\n+import javax.naming.NamingException;\n+\n+import java.util.Set;\n+\n+public interface LdapAuthenticatorClient\n+{\n+    void validatePassword(String userDistinguishedName, String password)\n+            throws NamingException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxMDkyNTY3OnYy", "diffSide": "RIGHT", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticatorClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyNzo1MFrOH3k2OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyNzo1MFrOH3k2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAzNzQzMg==", "bodyText": "Make method name plural lookupUserDistinguishedNames", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r528037432", "createdAt": "2020-11-21T00:27:50Z", "author": {"login": "electrum"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticatorClient.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.ldap;\n+\n+import javax.naming.NamingException;\n+\n+import java.util.Set;\n+\n+public interface LdapAuthenticatorClient\n+{\n+    void validatePassword(String userDistinguishedName, String password)\n+            throws NamingException;\n+\n+    boolean isGroupMember(String searchBase, String groupSearch, String contextUserDistinguishedName, String contextPassword)\n+            throws NamingException;\n+\n+    Set<String> lookupUserDistinguishedName(String searchBase, String searchFilter, String contextUserDistinguishedName, String contextPassword)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxMDkyODE5OnYy", "diffSide": "RIGHT", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyOTo1OVrOH3k3qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyOTo1OVrOH3k3qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAzNzgwMA==", "bodyText": "Use log formatting", "url": "https://github.com/trinodb/trino/pull/5874#discussion_r528037800", "createdAt": "2020-11-21T00:29:59Z", "author": {"login": "electrum"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "diffHunk": "@@ -112,28 +113,32 @@ private Principal authenticateWithUserBind(Credential credential)\n         if (containsSpecialCharacters(user)) {\n             throw new AccessDeniedException(\"Username contains a special LDAP character\");\n         }\n-        try {\n-            String userDistinguishedName = createUserDistinguishedName(user);\n-            if (groupAuthorizationSearchPattern.isPresent()) {\n-                // user password is also validated as user DN and password is used for querying LDAP\n-                String searchBase = userBaseDistinguishedName.orElseThrow();\n-                String groupSearch = replaceUser(groupAuthorizationSearchPattern.get(), user);\n-                if (!client.isGroupMember(searchBase, groupSearch, userDistinguishedName, credential.getPassword())) {\n-                    String message = format(\"User [%s] not a member of an authorized group\", user);\n-                    log.debug(message);\n-                    throw new AccessDeniedException(message);\n+        Exception lastException = new RuntimeException();\n+        for (String userBindSearchPattern : userBindSearchPatterns) {\n+            try {\n+                String userDistinguishedName = replaceUser(userBindSearchPattern, user);\n+                if (groupAuthorizationSearchPattern.isPresent()) {\n+                    // user password is also validated as user DN and password is used for querying LDAP\n+                    String searchBase = userBaseDistinguishedName.orElseThrow();\n+                    String groupSearch = replaceUser(groupAuthorizationSearchPattern.get(), user);\n+                    if (!client.isGroupMember(searchBase, groupSearch, userDistinguishedName, credential.getPassword())) {\n+                        String message = format(\"User [%s] not a member of an authorized group\", user);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 58}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4430, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}