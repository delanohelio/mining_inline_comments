{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwOTE1NTM0", "number": 5260, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMzowMzoyMlrOEmErOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo0ODozMVrOEoLIXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MzU3OTQ2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSplitManager.java", "isResolved": false, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMzowMzoyMlrOHV48Wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMjowNjoxMVrOHWpcOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcxNTA5OA==", "bodyText": "What if there are no partitions? Why +1?", "url": "https://github.com/trinodb/trino/pull/5260#discussion_r492715098", "createdAt": "2020-09-22T13:03:22Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSplitManager.java", "diffHunk": "@@ -229,7 +229,7 @@ public ConnectorSplitSource getSplits(\n                 namenodeStats,\n                 directoryLister,\n                 executor,\n-                splitLoaderConcurrency,\n+                min(splitLoaderConcurrency, partitions.size() + 1), // Avoid over-committing split loader concurrency", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcyNTA3MA==", "bodyText": "Unpartitioned tables still have a sentinel \"UNPARTITIONED\" entry here giving the list a size of 1. The +1 piece here is because I measured a slight improvement with it compared to just partition size, presumably because the hand-off between the file iterator and partition queues and the transition to \"no more splits\" benefits from the extra waiting thread.\nThat said, my testing was done a much older version of presto. Looking through the current BackgroundHiveSplitLoader implementation it appears that it's actually possible to have a greater concurrency than 1 per partition when multiple read paths are present, so that definitely brings the validity of this approach into question.", "url": "https://github.com/trinodb/trino/pull/5260#discussion_r492725070", "createdAt": "2020-09-22T13:17:41Z", "author": {"login": "pettyjamesm"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSplitManager.java", "diffHunk": "@@ -229,7 +229,7 @@ public ConnectorSplitSource getSplits(\n                 namenodeStats,\n                 directoryLister,\n                 executor,\n-                splitLoaderConcurrency,\n+                min(splitLoaderConcurrency, partitions.size() + 1), // Avoid over-committing split loader concurrency", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcxNTA5OA=="}, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc2MTc2Ng==", "bodyText": "Atleast in non-ACID flow, doesn't it suffice to have 1 thread per partition? the HiveFileIterator is created per partition path.", "url": "https://github.com/trinodb/trino/pull/5260#discussion_r492761766", "createdAt": "2020-09-22T14:05:07Z", "author": {"login": "rohangarg"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSplitManager.java", "diffHunk": "@@ -229,7 +229,7 @@ public ConnectorSplitSource getSplits(\n                 namenodeStats,\n                 directoryLister,\n                 executor,\n-                splitLoaderConcurrency,\n+                min(splitLoaderConcurrency, partitions.size() + 1), // Avoid over-committing split loader concurrency", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcxNTA5OA=="}, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc3ODA4Nw==", "bodyText": "@rohangarg looks like you're right- only transactional tables can potentially benefit from more than 1 thread per partition as implemented today. I've updated the PR to use one thread per partition for non-transactional tables.", "url": "https://github.com/trinodb/trino/pull/5260#discussion_r492778087", "createdAt": "2020-09-22T14:25:37Z", "author": {"login": "pettyjamesm"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSplitManager.java", "diffHunk": "@@ -229,7 +229,7 @@ public ConnectorSplitSource getSplits(\n                 namenodeStats,\n                 directoryLister,\n                 executor,\n-                splitLoaderConcurrency,\n+                min(splitLoaderConcurrency, partitions.size() + 1), // Avoid over-committing split loader concurrency", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcxNTA5OA=="}, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ4MDgxNg==", "bodyText": "Unpartitioned tables still have a sentinel \"UNPARTITIONED\" entry here giving the list a size of 1\n\nI'm pretty sure for unpartitioned tables we might want concurrency higher that 2. Imaging multi TB table with lots of partitions. Also bucketed tables are also unpartitioned, right?", "url": "https://github.com/trinodb/trino/pull/5260#discussion_r493480816", "createdAt": "2020-09-23T11:34:07Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSplitManager.java", "diffHunk": "@@ -229,7 +229,7 @@ public ConnectorSplitSource getSplits(\n                 namenodeStats,\n                 directoryLister,\n                 executor,\n-                splitLoaderConcurrency,\n+                min(splitLoaderConcurrency, partitions.size() + 1), // Avoid over-committing split loader concurrency", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcxNTA5OA=="}, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ4NDkyMg==", "bodyText": "Unpartitioned tables can only benefit from a single thread (as implemented today) because of the nature of the iterators they use. The same goes for buckets as far as I can tell although maybe I\u2019m missing something in this implementation. Today, submitting more than one task per partition just increases the number of threads contending for the lock and does not result in any increase in the rate of work being done.", "url": "https://github.com/trinodb/trino/pull/5260#discussion_r493484922", "createdAt": "2020-09-23T11:38:51Z", "author": {"login": "pettyjamesm"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSplitManager.java", "diffHunk": "@@ -229,7 +229,7 @@ public ConnectorSplitSource getSplits(\n                 namenodeStats,\n                 directoryLister,\n                 executor,\n-                splitLoaderConcurrency,\n+                min(splitLoaderConcurrency, partitions.size() + 1), // Avoid over-committing split loader concurrency", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcxNTA5OA=="}, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ5MjA3Nw==", "bodyText": "Today, submitting more than one task per partition just increases the number of threads contending for the lock\n\nIs the lock contention an issue when other threads do not have work to do? In practice only as many threads do processing as there is work and extra threads should not interfere too much, right?\nDo you observe some penalty when there are too many threads?", "url": "https://github.com/trinodb/trino/pull/5260#discussion_r493492077", "createdAt": "2020-09-23T11:47:12Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSplitManager.java", "diffHunk": "@@ -229,7 +229,7 @@ public ConnectorSplitSource getSplits(\n                 namenodeStats,\n                 directoryLister,\n                 executor,\n-                splitLoaderConcurrency,\n+                min(splitLoaderConcurrency, partitions.size() + 1), // Avoid over-committing split loader concurrency", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcxNTA5OA=="}, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzUwOTY4OQ==", "bodyText": "The extra threads that perform no work cause two problems:\n\nthey create extra lock contention and will typically fall through to the path that acquires the split loader write lock, locking out tasks that can do work from acquiring the read lock for as long as it takes for all other tasks to release their read lock\nthey take up threads in the cached threadpool executor which could have been used for other table scans or might never have needed to be created at all.\n\nThe second part is the largest general improvement since threads are a heavy resource to create when they\u2019re not needed, but there are worst case scenario\u2019s around the first problem that can stall split loading for long periods of time.", "url": "https://github.com/trinodb/trino/pull/5260#discussion_r493509689", "createdAt": "2020-09-23T12:06:11Z", "author": {"login": "pettyjamesm"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSplitManager.java", "diffHunk": "@@ -229,7 +229,7 @@ public ConnectorSplitSource getSplits(\n                 namenodeStats,\n                 directoryLister,\n                 executor,\n-                splitLoaderConcurrency,\n+                min(splitLoaderConcurrency, partitions.size() + 1), // Avoid over-committing split loader concurrency", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcxNTA5OA=="}, "originalCommit": null, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNTYwODYyOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSplitManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo0ODozMVrOHZHHGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzoxMDo1M1rOHZH_sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5Mjk1NA==", "bodyText": "You could static import isTransactionalTable", "url": "https://github.com/trinodb/trino/pull/5260#discussion_r496092954", "createdAt": "2020-09-28T16:48:31Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSplitManager.java", "diffHunk": "@@ -216,6 +217,8 @@ public ConnectorSplitSource getSplits(\n \n         Iterable<HivePartitionMetadata> hivePartitions = getPartitionMetadata(session, metastore, table, tableName, partitions, bucketHandle.map(HiveBucketHandle::toTableBucketProperty));\n \n+        // Only one thread per partition is usable when a table is not transactional\n+        int concurrency = AcidUtils.isTransactionalTable(table.getParameters()) ? splitLoaderConcurrency : min(splitLoaderConcurrency, partitions.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEwNzQ0MA==", "bodyText": "Done.", "url": "https://github.com/trinodb/trino/pull/5260#discussion_r496107440", "createdAt": "2020-09-28T17:10:53Z", "author": {"login": "pettyjamesm"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSplitManager.java", "diffHunk": "@@ -216,6 +217,8 @@ public ConnectorSplitSource getSplits(\n \n         Iterable<HivePartitionMetadata> hivePartitions = getPartitionMetadata(session, metastore, table, tableName, partitions, bucketHandle.map(HiveBucketHandle::toTableBucketProperty));\n \n+        // Only one thread per partition is usable when a table is not transactional\n+        int concurrency = AcidUtils.isTransactionalTable(table.getParameters()) ? splitLoaderConcurrency : min(splitLoaderConcurrency, partitions.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5Mjk1NA=="}, "originalCommit": null, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3038, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}