{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1ODExNTY4", "number": 4551, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzo0NzowMlrOERsANA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwOToyOToxMlrOESTxxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2OTgyMTk2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzo0NzowMlrOG2iW6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzo0NzowMlrOG2iW6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgzOTIxMQ==", "bodyText": "Test was looking at request counts earlier, \"Cached_rrc_requests\" would give those here. \"MB_read_from_cache\" might be zero if tests read very small data", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r459839211", "createdAt": "2020-07-24T03:47:02Z", "author": {"login": "shubhamtagra"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -564,7 +564,7 @@ private long getRemoteReadsCount()\n     private long getCachedReadsCount()\n     {\n         try {\n-            return (long) BEAN_SERVER.getAttribute(new ObjectName(\"rubix:name=stats,catalog=catalog\"), \"CachedReads\");\n+            return (long) BEAN_SERVER.getAttribute(new ObjectName(\"rubix:name=stats,catalog=catalog\"), \"MB_read_from_cache\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2OTgzMzQ0OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzo1NjoxOVrOG2idRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzo1NjoxOVrOG2idRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg0MDgzNw==", "bodyText": "we should use \"Remote_rrc_requests\" + \"Direct_rrc_requests\" instead of dataSize\nAlso, \"MB_read_from_source\" includes data read from source for async mode (via direct-reads size)", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r459840837", "createdAt": "2020-07-24T03:56:19Z", "author": {"login": "shubhamtagra"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -554,7 +552,9 @@ private Path getStoragePath(String path)\n     private long getRemoteReadsCount()\n     {\n         try {\n-            return (long) BEAN_SERVER.getAttribute(new ObjectName(\"rubix:name=stats,catalog=catalog\"), \"RemoteReads\");\n+            long remoteReadsReadThrough = (long) BEAN_SERVER.getAttribute(new ObjectName(\"rubix:name=stats,catalog=catalog\"), \"MB_read_from_source\"); // updated in READ-THROUGH mode", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2OTgzNjA2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzo1ODo0MFrOG2iexg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzo1ODo0MFrOG2iexg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg0MTIyMg==", "bodyText": "this is fine but existing one would have continued to work", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r459841222", "createdAt": "2020-07-24T03:58:40Z", "author": {"login": "shubhamtagra"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -578,7 +578,7 @@ private long getAsyncDownloadedMb(ReadMode readMode)\n         }\n \n         try {\n-            return (long) BEAN_SERVER.getAttribute(new ObjectName(\"metrics:name=rubix.bookkeeper.count.async_downloaded_mb\"), \"Count\");\n+            return (long) BEAN_SERVER.getAttribute(new ObjectName(\"rubix:name=stats,type=detailed,catalog=catalog\"), \"BKS_data_downloaded_in_parallel_warmup\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2OTgzNzQ0OnYy", "diffSide": "RIGHT", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCaching.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzo1OTo1MlrOG2ifkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzo1OTo1MlrOG2ifkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg0MTQyNQ==", "bodyText": "here too requestCounts are now replaced by dataSizes", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r459841425", "createdAt": "2020-07-24T03:59:52Z", "author": {"login": "shubhamtagra"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCaching.java", "diffHunk": "@@ -121,8 +136,11 @@ private void testReadFromTable(String tableNameSuffix)\n \n     private QueryResult getCacheStats()\n     {\n-        return query(\"SELECT sum(cachedreads) as cachedreads, sum(remotereads) as remotereads, sum(nonlocalreads) as nonlocalreads FROM \" +\n-                \"jmx.current.\\\"rubix:catalog=hive,name=stats\\\"\");\n+        return query(\"SELECT \" +\n+                \"  sum(mb_read_from_cache) as cachedreads, \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3MDMzNTgzOnYy", "diffSide": "RIGHT", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCaching.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwODoxNTozN1rOG2m36Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxMjowODowN1rOG2s8_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkxMzE5Mw==", "bodyText": "I think we would get empty QueryResult for stats when FS is not yet initialised. We could handle that case and return 0 from getRemoteReads and other methods to avoid running queries to warmup.", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r459913193", "createdAt": "2020-07-24T08:15:37Z", "author": {"login": "shubhamtagra"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCaching.java", "diffHunk": "@@ -95,6 +98,18 @@ private void testReadFromTable(String tableNameSuffix)\n         query(\"DROP TABLE \" + nonCachedTableName);\n     }\n \n+    private void initializeRubixStats()\n+    {\n+        // TODO this is needed for now because Rubix JMX statistis are only registered lazily", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkzMDE4Ng==", "bodyText": "Actually the queries fail as the table does not have expected columns yet. We can work around that in test, reacting for query failure. But I think proper fix would be on Rubix side. So all the jmx stats are registered as soon as Rubix is started up.", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r459930186", "createdAt": "2020-07-24T08:53:08Z", "author": {"login": "losipiuk"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCaching.java", "diffHunk": "@@ -95,6 +98,18 @@ private void testReadFromTable(String tableNameSuffix)\n         query(\"DROP TABLE \" + nonCachedTableName);\n     }\n \n+    private void initializeRubixStats()\n+    {\n+        // TODO this is needed for now because Rubix JMX statistis are only registered lazily", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkxMzE5Mw=="}, "originalCommit": null, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk4NDM1Mw==", "bodyText": "Lazy initialisation of stats in Rubix came out of a requirement. We now return stats from Rubix daemons too and needed Configuration object to talk to those daemons.\nFor embedded mode, one way could be Presto passes the Configuration object in setLocalBookKeeper call (change needed on Rubix side) and Rubix initialises stats using this.", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r459984353", "createdAt": "2020-07-24T10:56:07Z", "author": {"login": "shubhamtagra"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCaching.java", "diffHunk": "@@ -95,6 +98,18 @@ private void testReadFromTable(String tableNameSuffix)\n         query(\"DROP TABLE \" + nonCachedTableName);\n     }\n \n+    private void initializeRubixStats()\n+    {\n+        // TODO this is needed for now because Rubix JMX statistis are only registered lazily", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkxMzE5Mw=="}, "originalCommit": null, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAxMjc5OQ==", "bodyText": "PR idea qubole/rubix#434", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r460012799", "createdAt": "2020-07-24T12:08:07Z", "author": {"login": "losipiuk"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveCaching.java", "diffHunk": "@@ -95,6 +98,18 @@ private void testReadFromTable(String tableNameSuffix)\n         query(\"DROP TABLE \" + nonCachedTableName);\n     }\n \n+    private void initializeRubixStats()\n+    {\n+        // TODO this is needed for now because Rubix JMX statistis are only registered lazily", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkxMzE5Mw=="}, "originalCommit": null, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NjMzODYzOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/DummyBookKeeper.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwOToyOToxMlrOG3ayLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDoxOTozNFrOG5Ipfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc2MzY5NQ==", "bodyText": "This can lead to imx query failures as DummyBookKeeper is used when hive.cache.start-server-on-coordinator=false which is the default value. Better return an empty map here.", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r460763695", "createdAt": "2020-07-27T09:29:12Z", "author": {"login": "shubhamtagra"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/DummyBookKeeper.java", "diffHunk": "@@ -44,7 +45,14 @@ public void setAllCached(String remotePath, long fileLength, long lastModified,\n     }\n \n     @Override\n-    public boolean readData(String remotePath, long offset, int length, long fileSize, long lastModified, int clusterType)\n+    public Map<String, Long> getReadRequestChainStats()\n+            throws TException\n+    {\n+        throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2MzcxMQ==", "bodyText": "Interestingly, product tests seem to pass. I think com.qubole.rubix.core.ReadRequestChainStats#getBookKeeperStats is resilient for that case", "url": "https://github.com/trinodb/trino/pull/4551#discussion_r462563711", "createdAt": "2020-07-29T20:19:34Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/DummyBookKeeper.java", "diffHunk": "@@ -44,7 +45,14 @@ public void setAllCached(String remotePath, long fileLength, long lastModified,\n     }\n \n     @Override\n-    public boolean readData(String remotePath, long offset, int length, long fileSize, long lastModified, int clusterType)\n+    public Map<String, Long> getReadRequestChainStats()\n+            throws TException\n+    {\n+        throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc2MzY5NQ=="}, "originalCommit": null, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3743, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}