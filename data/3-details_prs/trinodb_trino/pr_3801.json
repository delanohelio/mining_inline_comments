{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwODI5OTg4", "number": 3801, "title": "Improved concurrency for Elasticsearch calls", "bodyText": "The default settings for the HTTP client used by Elasticsearch's RestHighLevelClient are limiting Presto's ability to make concurrent requests. Because it's invoking https://github.com/apache/httpasyncclient/blob/4.1.x/httpasyncclient/src/main/java/org/apache/http/impl/nio/client/HttpAsyncClientBuilder.java#L625, connection pooling is determined by system property http.maxConnections (see https://github.com/apache/httpasyncclient/blob/4.1.x/httpasyncclient/src/main/java/org/apache/http/impl/nio/client/HttpAsyncClientBuilder.java#L678-L685).\nAlso, the time queued requests could be waiting for a connection was set to 500 ms, which under high load caused them to time out.  This issue was fixed in later versions of the ES client (https://github.com/elastic/elasticsearch/pull/30384/files/e5977ab046564d3535691bfc6ecba5c1fb27f10b).", "createdAt": "2020-05-20T15:33:11Z", "url": "https://github.com/trinodb/trino/pull/3801", "merged": true, "mergeCommit": {"oid": "d31207788c269b8a1c03402f69b93700d209d381"}, "closed": true, "closedAt": "2020-05-21T04:52:42Z", "author": {"login": "aalbu"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjMQWWgFqTQxNTUxNzM0OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjTud9gFqTQxNTgyNzgzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NTE3MzQ5", "url": "https://github.com/trinodb/trino/pull/3801#pullrequestreview-415517349", "createdAt": "2020-05-20T16:33:38Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNjozMzozOFrOGYUNng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNzowOTowNlrOGYVqRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE1MDE3NA==", "bodyText": "I don't think it's worth it making this one configurable at this point. There's a timeout on the underlying connections already, so an extra level of timeouts when callers are waiting for connections will just make it harder to reason about the system.", "url": "https://github.com/trinodb/trino/pull/3801#discussion_r428150174", "createdAt": "2020-05-20T16:33:38Z", "author": {"login": "martint"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/ElasticsearchConfig.java", "diffHunk": "@@ -196,6 +199,48 @@ public ElasticsearchConfig setNodeRefreshInterval(Duration nodeRefreshInterval)\n         return this;\n     }\n \n+    @NotNull\n+    public Duration getRequestQueuedTimeout()\n+    {\n+        return requestQueuedTimeout;\n+    }\n+\n+    @Config(\"elasticsearch.request-queued-timeout\")\n+    @ConfigDescription(\"The maximum time a request can wait for a connection to become available\")\n+    public ElasticsearchConfig setRequestQueuedTimeout(Duration requestQueuedTimeout)\n+    {\n+        this.requestQueuedTimeout = requestQueuedTimeout;\n+        return this;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE3MDM0Ng==", "bodyText": "Move this up to where the client builder is created an format as:\nIOReactorConfig reactorConfig = IOReactorConfig.custom()\n        .setIoThreadCount(config.getHttpThreadCount())\n        .build();\n\n// the client builder passed to the call-back is configured to use system properties, which makes it\n// impossible to configure concurrency settings, so we need to build a new one from scratch\nHttpAsyncClientBuilder clientBuilder = HttpAsyncClientBuilder.create()\n        .setDefaultRequestConfig(requestConfig)\n        .setDefaultIOReactorConfig(reactorConfig)\n        .setMaxConnPerRoute(config.getMaxHttpConnections())\n        .setMaxConnTotal(config.getMaxHttpConnections());", "url": "https://github.com/trinodb/trino/pull/3801#discussion_r428170346", "createdAt": "2020-05-20T17:03:00Z", "author": {"login": "martint"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/client/ElasticsearchClient.java", "diffHunk": "@@ -195,27 +198,33 @@ private static RestHighLevelClient createClient(ElasticsearchConfig config, Opti\n     {\n         RestClientBuilder builder = RestClient.builder(\n                 new HttpHost(config.getHost(), config.getPort(), config.isTlsEnabled() ? \"https\" : \"http\"))\n-                .setRequestConfigCallback(\n-                        configBuilder -> configBuilder\n-                                .setConnectTimeout(toIntExact(config.getConnectTimeout().toMillis()))\n-                                .setSocketTimeout(toIntExact(config.getRequestTimeout().toMillis())))\n                 .setMaxRetryTimeoutMillis(toIntExact(config.getMaxRetryTime().toMillis()));\n \n         builder.setHttpClientConfigCallback(clientBuilder -> {\n+            RequestConfig requestConfig = RequestConfig.custom()\n+                    .setConnectionRequestTimeout(toIntExact(config.getRequestQueuedTimeout().toMillis()))\n+                    .setConnectTimeout(toIntExact(config.getConnectTimeout().toMillis()))\n+                    .setSocketTimeout(toIntExact(config.getRequestTimeout().toMillis()))\n+                    .build();\n+            // the client builder passed to the call-back is configured to use system properties, which makes it\n+            // impossible to configure concurrency settings, so we need to build a new one from scratch\n+            HttpAsyncClientBuilder httpClientBuilder = HttpAsyncClientBuilder.create().setDefaultRequestConfig(requestConfig);\n             if (config.isTlsEnabled()) {\n                 buildSslContext(config.getKeystorePath(), config.getKeystorePassword(), config.getTrustStorePath(), config.getTruststorePassword())\n-                        .ifPresent(clientBuilder::setSSLContext);\n+                        .ifPresent(httpClientBuilder::setSSLContext);\n \n                 if (config.isVerifyHostnames()) {\n-                    clientBuilder.setSSLHostnameVerifier(NoopHostnameVerifier.INSTANCE);\n+                    httpClientBuilder.setSSLHostnameVerifier(NoopHostnameVerifier.INSTANCE);\n                 }\n             }\n+            httpClientBuilder.setMaxConnPerRoute(config.getMaxHttpConnections()).setMaxConnTotal(config.getMaxHttpConnections());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE3Mzg5NQ==", "bodyText": "Rename clientBuilder to ignored and replace httpClientBuilder below with clientBuilder", "url": "https://github.com/trinodb/trino/pull/3801#discussion_r428173895", "createdAt": "2020-05-20T17:09:06Z", "author": {"login": "martint"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/client/ElasticsearchClient.java", "diffHunk": "@@ -195,27 +198,33 @@ private static RestHighLevelClient createClient(ElasticsearchConfig config, Opti\n     {\n         RestClientBuilder builder = RestClient.builder(\n                 new HttpHost(config.getHost(), config.getPort(), config.isTlsEnabled() ? \"https\" : \"http\"))\n-                .setRequestConfigCallback(\n-                        configBuilder -> configBuilder\n-                                .setConnectTimeout(toIntExact(config.getConnectTimeout().toMillis()))\n-                                .setSocketTimeout(toIntExact(config.getRequestTimeout().toMillis())))\n                 .setMaxRetryTimeoutMillis(toIntExact(config.getMaxRetryTime().toMillis()));\n \n         builder.setHttpClientConfigCallback(clientBuilder -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NTQ4MzAw", "url": "https://github.com/trinodb/trino/pull/3801#pullrequestreview-415548300", "createdAt": "2020-05-20T17:13:07Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNzoxMzowN1rOGYVzUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNzoxNToyMlrOGYV4mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE3NjIwOQ==", "bodyText": "I am a bit worried that we may lose some options already preset in clientBuilder passed as an argument to setHttpClientConfigCallback.\nDid what is the difference between provided clientBuilder and HttpAsyncClientBuilder.create().\nAre there any differences other than systemProperties set to true vs false?", "url": "https://github.com/trinodb/trino/pull/3801#discussion_r428176209", "createdAt": "2020-05-20T17:13:07Z", "author": {"login": "losipiuk"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/client/ElasticsearchClient.java", "diffHunk": "@@ -195,27 +198,33 @@ private static RestHighLevelClient createClient(ElasticsearchConfig config, Opti\n     {\n         RestClientBuilder builder = RestClient.builder(\n                 new HttpHost(config.getHost(), config.getPort(), config.isTlsEnabled() ? \"https\" : \"http\"))\n-                .setRequestConfigCallback(\n-                        configBuilder -> configBuilder\n-                                .setConnectTimeout(toIntExact(config.getConnectTimeout().toMillis()))\n-                                .setSocketTimeout(toIntExact(config.getRequestTimeout().toMillis())))\n                 .setMaxRetryTimeoutMillis(toIntExact(config.getMaxRetryTime().toMillis()));\n \n         builder.setHttpClientConfigCallback(clientBuilder -> {\n+            RequestConfig requestConfig = RequestConfig.custom()\n+                    .setConnectionRequestTimeout(toIntExact(config.getRequestQueuedTimeout().toMillis()))\n+                    .setConnectTimeout(toIntExact(config.getConnectTimeout().toMillis()))\n+                    .setSocketTimeout(toIntExact(config.getRequestTimeout().toMillis()))\n+                    .build();\n+            // the client builder passed to the call-back is configured to use system properties, which makes it\n+            // impossible to configure concurrency settings, so we need to build a new one from scratch\n+            HttpAsyncClientBuilder httpClientBuilder = HttpAsyncClientBuilder.create().setDefaultRequestConfig(requestConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE3NzU2Mg==", "bodyText": "I see the also call out to .setMaxConnPerRoute(DEFAULT_MAX_CONN_PER_ROUTE).setMaxConnTotal(DEFAULT_MAX_CONN_TOTAL).\nShould we replicate it here or it does not matter?", "url": "https://github.com/trinodb/trino/pull/3801#discussion_r428177562", "createdAt": "2020-05-20T17:15:22Z", "author": {"login": "losipiuk"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/client/ElasticsearchClient.java", "diffHunk": "@@ -195,27 +198,33 @@ private static RestHighLevelClient createClient(ElasticsearchConfig config, Opti\n     {\n         RestClientBuilder builder = RestClient.builder(\n                 new HttpHost(config.getHost(), config.getPort(), config.isTlsEnabled() ? \"https\" : \"http\"))\n-                .setRequestConfigCallback(\n-                        configBuilder -> configBuilder\n-                                .setConnectTimeout(toIntExact(config.getConnectTimeout().toMillis()))\n-                                .setSocketTimeout(toIntExact(config.getRequestTimeout().toMillis())))\n                 .setMaxRetryTimeoutMillis(toIntExact(config.getMaxRetryTime().toMillis()));\n \n         builder.setHttpClientConfigCallback(clientBuilder -> {\n+            RequestConfig requestConfig = RequestConfig.custom()\n+                    .setConnectionRequestTimeout(toIntExact(config.getRequestQueuedTimeout().toMillis()))\n+                    .setConnectTimeout(toIntExact(config.getConnectTimeout().toMillis()))\n+                    .setSocketTimeout(toIntExact(config.getRequestTimeout().toMillis()))\n+                    .build();\n+            // the client builder passed to the call-back is configured to use system properties, which makes it\n+            // impossible to configure concurrency settings, so we need to build a new one from scratch\n+            HttpAsyncClientBuilder httpClientBuilder = HttpAsyncClientBuilder.create().setDefaultRequestConfig(requestConfig);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE3NjIwOQ=="}, "originalCommit": null, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35dc924688d614aeb068b4649306ee49dcdaa977", "author": {"user": {"login": "aalbu", "name": "Alex Albu"}}, "url": "https://github.com/trinodb/trino/commit/35dc924688d614aeb068b4649306ee49dcdaa977", "committedDate": "2020-05-21T01:36:21Z", "message": "Improved concurrency for Elasticsearch calls"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "35dc924688d614aeb068b4649306ee49dcdaa977", "author": {"user": {"login": "aalbu", "name": "Alex Albu"}}, "url": "https://github.com/trinodb/trino/commit/35dc924688d614aeb068b4649306ee49dcdaa977", "committedDate": "2020-05-21T01:36:21Z", "message": "Improved concurrency for Elasticsearch calls"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1ODI3ODMx", "url": "https://github.com/trinodb/trino/pull/3801#pullrequestreview-415827831", "createdAt": "2020-05-21T01:52:23Z", "commit": {"oid": "35dc924688d614aeb068b4649306ee49dcdaa977"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1210, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}