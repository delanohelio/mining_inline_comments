{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3OTEyNzcw", "number": 4429, "title": "Fix flaky testParquetTimestampPredicatePushdown", "bodyText": "Query info contains zeroes if updates haven't been applied yet.\nFixed by retrying with increasing delay between query and getQueryInfo.\nThis fixes #4314", "createdAt": "2020-07-12T15:09:00Z", "url": "https://github.com/trinodb/trino/pull/4429", "merged": true, "mergeCommit": {"oid": "bd6f57c62d532b156423de3a8abbb83734a85cfd"}, "closed": true, "closedAt": "2020-07-14T12:38:44Z", "author": {"login": "MiguelWeezardo"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0dKWpAFqTQ0NzAzMzc5Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1LBC9AFqTQ0ODk3NjQ4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MDMzNzk3", "url": "https://github.com/trinodb/trino/pull/4429#pullrequestreview-447033797", "createdAt": "2020-07-13T08:28:38Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODoyODozOFrOGweNzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODoyODozOFrOGweNzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ3OTg4NQ==", "bodyText": "can't we just retry calling getQueryInfo once again in a while?\nWouldn't simple assertEventually work here?", "url": "https://github.com/trinodb/trino/pull/4429#discussion_r453479885", "createdAt": "2020-07-13T08:28:38Z", "author": {"login": "losipiuk"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -7056,4 +7060,60 @@ public TypeAndEstimate(Type type, EstimatedStatsAndCost estimate)\n             this.estimate = requireNonNull(estimate, \"estimate is null\");\n         }\n     }\n+\n+    private class GreaterThanZeroProcessedDataSizeCheck\n+    {\n+        private final DistributedQueryRunner queryRunner;\n+        private final String query;\n+\n+        private ResultWithQueryId<MaterializedResult> queryResult;\n+        private long processedInputBytes;\n+\n+        public GreaterThanZeroProcessedDataSizeCheck(DistributedQueryRunner queryRunner, @Language(\"SQL\") String query)\n+        {\n+            this.queryRunner = queryRunner;\n+            this.query = query;\n+            runQuery();\n+            getProcessedBytes();\n+        }\n+\n+        private void runQuery()\n+        {\n+            queryResult = queryRunner.executeWithQueryId(getSession(), query);\n+        }\n+\n+        private void getProcessedBytes()\n+        {\n+            processedInputBytes = getQueryInfo(queryRunner, queryResult).getQueryStats().getProcessedInputDataSize().toBytes();\n+        }\n+\n+        private long checkProcessedBytes()\n+                throws Exception\n+        {\n+            try {\n+                assertThat(processedInputBytes).isGreaterThan(0);\n+            }\n+            catch (AssertionError error) {\n+                // If query statistics haven't been updated at the time we issued getQueryInfo(), we will mistakenly see 0 processedInputBytes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 85}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "a152dd0ba726cb28c199f400ba3ce4ef8e18b492", "author": {"user": {"login": "MiguelWeezardo", "name": "Micha\u0142 \u015alizak"}}, "url": "https://github.com/trinodb/trino/commit/a152dd0ba726cb28c199f400ba3ce4ef8e18b492", "committedDate": "2020-07-14T00:01:16Z", "message": "Fix flaky testParquetTimestampPredicatePushdown\n\nQuery info contains zeroes if updates haven't been applied yet.\nFixed by retrying with increasing delay between query and getQueryInfo."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "a152dd0ba726cb28c199f400ba3ce4ef8e18b492", "author": {"user": {"login": "MiguelWeezardo", "name": "Micha\u0142 \u015alizak"}}, "url": "https://github.com/trinodb/trino/commit/a152dd0ba726cb28c199f400ba3ce4ef8e18b492", "committedDate": "2020-07-14T00:01:16Z", "message": "Fix flaky testParquetTimestampPredicatePushdown\n\nQuery info contains zeroes if updates haven't been applied yet.\nFixed by retrying with increasing delay between query and getQueryInfo."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODE5NTYw", "url": "https://github.com/trinodb/trino/pull/4429#pullrequestreview-447819560", "createdAt": "2020-07-14T06:24:04Z", "commit": {"oid": "a152dd0ba726cb28c199f400ba3ce4ef8e18b492"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4OTc2NDgz", "url": "https://github.com/trinodb/trino/pull/4429#pullrequestreview-448976483", "createdAt": "2020-07-15T13:54:02Z", "commit": {"oid": "a152dd0ba726cb28c199f400ba3ce4ef8e18b492"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMzo1NDowM1rOGx_PrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMzo1NDowN1rOGx_P4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA2OTYxMw==", "bodyText": "would assertEventually, or FailSafe do?", "url": "https://github.com/trinodb/trino/pull/4429#discussion_r455069613", "createdAt": "2020-07-15T13:54:03Z", "author": {"login": "findepi"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -7056,4 +7069,39 @@ public TypeAndEstimate(Type type, EstimatedStatsAndCost estimate)\n             this.estimate = requireNonNull(estimate, \"estimate is null\");\n         }\n     }\n+\n+    private static class ExponentialSleeper", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a152dd0ba726cb28c199f400ba3ce4ef8e18b492"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA2OTY2Ng==", "bodyText": "cc @dain", "url": "https://github.com/trinodb/trino/pull/4429#discussion_r455069666", "createdAt": "2020-07-15T13:54:07Z", "author": {"login": "findepi"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -4129,10 +4133,19 @@ public void testParquetTimestampPredicatePushdown()\n                 \"SELECT * FROM test_parquet_timestamp_predicate_pushdown WHERE t > TIMESTAMP '2012-10-31 01:00'\");\n         assertEquals(getQueryInfo(queryRunner, queryResult).getQueryStats().getProcessedInputDataSize().toBytes(), 0);\n \n-        queryResult = queryRunner.executeWithQueryId(\n-                getSession(),\n-                \"SELECT * FROM test_parquet_timestamp_predicate_pushdown WHERE t = TIMESTAMP '2012-10-31 01:00'\");\n-        assertThat(getQueryInfo(queryRunner, queryResult).getQueryStats().getProcessedInputDataSize().toBytes()).isGreaterThan(0);\n+        // TODO: replace this with a simple query stats check once we find a way to wait until all pending updates to query stats have been applied", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a152dd0ba726cb28c199f400ba3ce4ef8e18b492"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 96, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}