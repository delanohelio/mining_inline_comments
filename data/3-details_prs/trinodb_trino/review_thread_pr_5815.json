{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MzM5OTk4", "number": 5815, "reviewThreads": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowNzo1MVrOE1MjdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDo0NjoyMVrOE2HUBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjE1NjY5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchQuery.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowNzo1MVrOHtVWbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNzozMzoxOVrOHtilgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5Nzc3NQ==", "bodyText": "Use enum instead", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517297775", "createdAt": "2020-11-04T12:07:51Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchQuery.java", "diffHunk": "@@ -22,7 +22,7 @@\n {\n     void recordHeartbeat();\n \n-    ListenableFuture<?> getDispatchedFuture();\n+    ListenableFuture<Boolean> getDispatchedFuture();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNTI0Ng==", "bodyText": "i think boolean is ok, but don't feel strongly.", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517305246", "createdAt": "2020-11-04T12:22:46Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchQuery.java", "diffHunk": "@@ -22,7 +22,7 @@\n {\n     void recordHeartbeat();\n \n-    ListenableFuture<?> getDispatchedFuture();\n+    ListenableFuture<Boolean> getDispatchedFuture();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5Nzc3NQ=="}, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNTYyOA==", "bodyText": "Add a javadoc explaining what the future's  payload means", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517305628", "createdAt": "2020-11-04T12:23:33Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchQuery.java", "diffHunk": "@@ -22,7 +22,7 @@\n {\n     void recordHeartbeat();\n \n-    ListenableFuture<?> getDispatchedFuture();\n+    ListenableFuture<Boolean> getDispatchedFuture();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5Nzc3NQ=="}, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUxNDYyNQ==", "bodyText": "I changed to enum\n    enum DispatchStatus {\n        FAILED, DISPATCHED\n    }", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517514625", "createdAt": "2020-11-04T17:33:19Z", "author": {"login": "losipiuk"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchQuery.java", "diffHunk": "@@ -22,7 +22,7 @@\n {\n     void recordHeartbeat();\n \n-    ListenableFuture<?> getDispatchedFuture();\n+    ListenableFuture<Boolean> getDispatchedFuture();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5Nzc3NQ=="}, "originalCommit": null, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjE2MTk4OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowOToyNFrOHtVZgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMjoyNToyN1rOHuA8uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5ODU2Mg==", "bodyText": "Can you please add test to io.prestosql.connector.system.TestKillQuery. You can use MockConnector to block it on metadata calls so query will remain in waiting for resources state.", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517298562", "createdAt": "2020-11-04T12:09:24Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -16,6 +16,7 @@\n import com.google.common.util.concurrent.AbstractFuture;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxMjA4OA==", "bodyText": "@kokosing added.\nIt required some refactoring to TestEventListeners (separate commits)", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518012088", "createdAt": "2020-11-05T12:25:27Z", "author": {"login": "losipiuk"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -16,6 +16,7 @@\n import com.google.common.util.concurrent.AbstractFuture;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5ODU2Mg=="}, "originalCommit": null, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjIxMDE3OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQuery.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjoyNDoxN1rOHtV2xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNzoyMjowMVrOHtiKbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNjA1Mg==", "bodyText": "it's weird to declared \"success\" in the finally block, regardless of the above.\nI think it would be better to .set(true) after querySubmitter.accept( returns cleanly and .set(false) in the finally.", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517306052", "createdAt": "2020-11-04T12:24:17Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQuery.java", "diffHunk": "@@ -138,7 +138,7 @@ private void startExecution(QueryExecution queryExecution)\n                     throw t;\n                 }\n                 finally {\n-                    submitted.set(null);\n+                    submitted.set(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUwNzY5Mw==", "bodyText": "Makes sense", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517507693", "createdAt": "2020-11-04T17:22:01Z", "author": {"login": "losipiuk"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQuery.java", "diffHunk": "@@ -138,7 +138,7 @@ private void startExecution(QueryExecution queryExecution)\n                     throw t;\n                 }\n                 finally {\n-                    submitted.set(null);\n+                    submitted.set(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNjA1Mg=="}, "originalCommit": null, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjIxNTkwOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQueryFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjoyNTozMFrOHtV51w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNzoyMzoxOFrOHtiNcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNjgzOQ==", "bodyText": "Remove.\nInstead, please add a test that would fail if this code is reinserted here.", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517306839", "createdAt": "2020-11-04T12:25:30Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQueryFactory.java", "diffHunk": "@@ -124,7 +123,7 @@ public DispatchQuery createDispatchQuery(\n             }\n             catch (Throwable e) {\n                 stateMachine.transitionToFailed(e);\n-                queryMonitor.queryImmediateFailureEvent(stateMachine.getBasicQueryInfo(Optional.empty()), toFailure(e));\n+                // queryMonitor.queryImmediateFailureEvent will be called by state change listenere registered in DispatchManager.queryCreated", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUwODQ2NQ==", "bodyText": "I will try. May be hard", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517508465", "createdAt": "2020-11-04T17:23:18Z", "author": {"login": "losipiuk"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQueryFactory.java", "diffHunk": "@@ -124,7 +123,7 @@ public DispatchQuery createDispatchQuery(\n             }\n             catch (Throwable e) {\n                 stateMachine.transitionToFailed(e);\n-                queryMonitor.queryImmediateFailureEvent(stateMachine.getBasicQueryInfo(Optional.empty()), toFailure(e));\n+                // queryMonitor.queryImmediateFailureEvent will be called by state change listenere registered in DispatchManager.queryCreated", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNjgzOQ=="}, "originalCommit": null, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjIyMDE5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjoyNjo0MlrOHtV8VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNjoxNzoyMVrOHtfdOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNzQ3Nw==", "bodyText": "can it be ! done just yet?\nis here a race condition which may result in double notification?", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517307477", "createdAt": "2020-11-04T12:26:42Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.\n+        dispatchQuery.addStateChangeListener(newState -> {\n+            if (newState == FAILED) {\n+                if (!dispatchQuery.getDispatchedFuture().isDone() || !getUnchecked(dispatchQuery.getDispatchedFuture())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ2MzM1NA==", "bodyText": "I did not want to depend on listener execution order.\nSpecifically with:\nhttps://github.com/prestosql/presto/blob/bca1470858a7255e7e5e469e9bc019bea311f402/presto-main/src/main/java/io/prestosql/dispatcher/LocalDispatchQuery.java#L88-L93\nWhich actually change the state of dispatchQuery.getDispatchedFuture.\nTechnically maybe this listener I add here could be merged with one I reference ...", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517463354", "createdAt": "2020-11-04T16:17:21Z", "author": {"login": "losipiuk"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.\n+        dispatchQuery.addStateChangeListener(newState -> {\n+            if (newState == FAILED) {\n+                if (!dispatchQuery.getDispatchedFuture().isDone() || !getUnchecked(dispatchQuery.getDispatchedFuture())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNzQ3Nw=="}, "originalCommit": null, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjIyMjQxOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjoyNzoxNlrOHtV9iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjoyNzoxNlrOHtV9iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMwNzc4Nw==", "bodyText": "getUnchecked -> MoreFutures#getDone", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517307787", "createdAt": "2020-11-04T12:27:16Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.\n+        dispatchQuery.addStateChangeListener(newState -> {\n+            if (newState == FAILED) {\n+                if (!dispatchQuery.getDispatchedFuture().isDone() || !getUnchecked(dispatchQuery.getDispatchedFuture())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NjA5NTcyOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchQuery.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwOTozMzozNVrOHt6uyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwOTozMzozNVrOHt6uyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxMDIxNw==", "bodyText": "{ next line?", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517910217", "createdAt": "2020-11-05T09:33:35Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchQuery.java", "diffHunk": "@@ -20,9 +20,13 @@\n public interface DispatchQuery\n         extends TrackedQuery, ManagedQueryExecution\n {\n+    enum DispatchStatus {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NjIwMTk2OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwOTo1OTo0MFrOHt7wzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwOTo1OTo0MFrOHt7wzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyNzExNw==", "bodyText": "successfully", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517927117", "createdAt": "2020-11-05T09:59:40Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NjIwMzM5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMDowMDowMlrOHt7xtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMDowMDowMlrOHt7xtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyNzM1MQ==", "bodyText": "true -> ..", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517927351", "createdAt": "2020-11-05T10:00:02Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.\n+        dispatchQuery.addStateChangeListener(newState -> {\n+            if (newState == FAILED) {\n+                if (!dispatchQuery.getDispatchedFuture().isDone() || getDone(dispatchQuery.getDispatchedFuture()) == DispatchQuery.DispatchStatus.FAILED) {\n+                    queryMonitor.queryImmediateFailureEvent(dispatchQuery.getBasicQueryInfo(), dispatchQuery.getFullQueryInfo().getFailureInfo());\n+                }\n+                // if dispatchQuery.getDispatchedFuture() == true then query termination will be handled by listener registered in SqlQueryManager.createQuery", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NjIxMTMyOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMDowMTo0OFrOHt72Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMTowOTozOVrOHt-ZIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyODUzMA==", "bodyText": "i'm concerned about !dispatchQuery.getDispatchedFuture().isDone() part. This may result in double delivery of the event.\nWe could perhaps have the queryMonitor.queryImmediateFailureEvent run as a completion callback on the dispatchQuery.getDispatchedFuture() future?", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517928530", "createdAt": "2020-11-05T10:01:48Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.\n+        dispatchQuery.addStateChangeListener(newState -> {\n+            if (newState == FAILED) {\n+                if (!dispatchQuery.getDispatchedFuture().isDone() || getDone(dispatchQuery.getDispatchedFuture()) == DispatchQuery.DispatchStatus.FAILED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk1MzU0NQ==", "bodyText": "Let me see. I think it can be done.", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517953545", "createdAt": "2020-11-05T10:41:24Z", "author": {"login": "losipiuk"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.\n+        dispatchQuery.addStateChangeListener(newState -> {\n+            if (newState == FAILED) {\n+                if (!dispatchQuery.getDispatchedFuture().isDone() || getDone(dispatchQuery.getDispatchedFuture()) == DispatchQuery.DispatchStatus.FAILED) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyODUzMA=="}, "originalCommit": null, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2MjY1Ng==", "bodyText": "With code like this:\n        // capture failures which happen before query is successfully dispatched.\n        addSuccessCallback(dispatchQuery.getDispatchedFuture(),\n                dispatchStatus -> {\n                    if (dispatchStatus == DispatchQuery.DispatchStatus.FAILED) {\n                        queryMonitor.queryImmediateFailureEvent(dispatchQuery.getBasicQueryInfo(), dispatchQuery.getFullQueryInfo().getFailureInfo());\n                    }\n                });\nit seems to work fine.\nI will read code some more to see if I see some issues with it.", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517962656", "createdAt": "2020-11-05T10:56:40Z", "author": {"login": "losipiuk"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.\n+        dispatchQuery.addStateChangeListener(newState -> {\n+            if (newState == FAILED) {\n+                if (!dispatchQuery.getDispatchedFuture().isDone() || getDone(dispatchQuery.getDispatchedFuture()) == DispatchQuery.DispatchStatus.FAILED) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyODUzMA=="}, "originalCommit": null, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2NDU3MA==", "bodyText": "@findepi I guess we should not use the same-thread-executor here, right? So with this change I would need to provide extra executor do DispatchManager. Does it still make sense to you?", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517964570", "createdAt": "2020-11-05T10:59:51Z", "author": {"login": "losipiuk"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.\n+        dispatchQuery.addStateChangeListener(newState -> {\n+            if (newState == FAILED) {\n+                if (!dispatchQuery.getDispatchedFuture().isDone() || getDone(dispatchQuery.getDispatchedFuture()) == DispatchQuery.DispatchStatus.FAILED) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyODUzMA=="}, "originalCommit": null, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3MDIwOA==", "bodyText": "I can also leave original callback on state change, and change the if to:\nif (dispatchQuery.getDispatchedFuture().isDone() && getDone(dispatchQuery.getDispatchedFuture()) == DispatchQuery.DispatchStatus.FAILED) {\n\nThis captures  the intent more, but depends on the fact that listeners are called in registration order. That listner which finalizes disaptchedFuture would be called before this one.\nGiven fact that listeners are called asynchronously in separate threads I think this is not the thing we can assume.\nIt feels to me that you proposal with listener on getDispatchedFuture completion is most bullet proof.", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517970208", "createdAt": "2020-11-05T11:09:39Z", "author": {"login": "losipiuk"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -243,6 +249,16 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n             stats.trackQueryStats(dispatchQuery);\n         }\n \n+        // capture failures which happen before query is succesfully dispatched.\n+        dispatchQuery.addStateChangeListener(newState -> {\n+            if (newState == FAILED) {\n+                if (!dispatchQuery.getDispatchedFuture().isDone() || getDone(dispatchQuery.getDispatchedFuture()) == DispatchQuery.DispatchStatus.FAILED) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyODUzMA=="}, "originalCommit": null, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NjI3ODA4OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/FailedDispatchQuery.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMDoxODo0MVrOHt8fjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMDozNToxNlrOHt9IfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkzOTA4NQ==", "bodyText": "don't use static import for DispatchStatus. QueryState seems to be more commonly used.", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517939085", "createdAt": "2020-11-05T10:18:41Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/FailedDispatchQuery.java", "diffHunk": "@@ -104,9 +104,9 @@ public Session getSession()\n     }\n \n     @Override\n-    public ListenableFuture<?> getDispatchedFuture()\n+    public ListenableFuture<DispatchStatus> getDispatchedFuture()\n     {\n-        return immediateFuture(null);\n+        return immediateFuture(FAILED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk0OTU2NA==", "bodyText": "You can import both. But I can use fully qualified for DispatchStatus if you prefer", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517949564", "createdAt": "2020-11-05T10:35:16Z", "author": {"login": "losipiuk"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/FailedDispatchQuery.java", "diffHunk": "@@ -104,9 +104,9 @@ public Session getSession()\n     }\n \n     @Override\n-    public ListenableFuture<?> getDispatchedFuture()\n+    public ListenableFuture<DispatchStatus> getDispatchedFuture()\n     {\n-        return immediateFuture(null);\n+        return immediateFuture(FAILED);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkzOTA4NQ=="}, "originalCommit": null, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NjI5MjcyOnYy", "diffSide": "RIGHT", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMDoyMjoxMlrOHt8omg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMToxNzoyOVrOHt-p0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk0MTQwMg==", "bodyText": "nice", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517941402", "createdAt": "2020-11-05T10:22:12Z", "author": {"login": "kokosing"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -160,8 +160,35 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(session)\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3NDQ4MA==", "bodyText": "Thank you :) This was the second attempt. I first tried to do testing without QueryRunner, setting up everything manually. And I failed miserably :)", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r517974480", "createdAt": "2020-11-05T11:17:29Z", "author": {"login": "losipiuk"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -160,8 +160,35 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(session)\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk0MTQwMg=="}, "originalCommit": null, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MTcyOTE3OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDozMjo0NFrOHuwU5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDozMjo0NFrOHuwU5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc4ODMyNA==", "bodyText": "or dispatchExecutor?", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518788324", "createdAt": "2020-11-06T14:32:44Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -72,7 +72,7 @@\n \n     private final int maxQueryLength;\n \n-    private final Executor queryExecutor;\n+    private final Executor executor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MTczMzQ4OnYy", "diffSide": "RIGHT", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDozMzo1MVrOHuwXpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDozMzo1MVrOHuwXpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc4OTAyOQ==", "bodyText": "please update (DistributedQueryRunner) getQueryRunner() places to use the new method", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518789029", "createdAt": "2020-11-06T14:33:51Z", "author": {"login": "findepi"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -411,6 +411,13 @@ protected final QueryRunner getQueryRunner()\n         return queryRunner;\n     }\n \n+    protected final DistributedQueryRunner getDistributedQueryRunner()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MTc0ODkyOnYy", "diffSide": "RIGHT", "path": "presto-tests/src/test/java/io/prestosql/execution/EventsBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDozNzo0NVrOHuwhnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDozNzo0NVrOHuwhnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5MTU4MA==", "bodyText": "part of the setup (construction) is done in initialize and part is done now in ctor.\nlet's merge the two.\nlet's rename initialize to reset and let's call reset(0) in the ctor, so that newly created object is usable", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518791580", "createdAt": "2020-11-06T14:37:45Z", "author": {"login": "findepi"}, "path": "presto-tests/src/test/java/io/prestosql/execution/EventsBuilder.java", "diffHunk": "@@ -16,20 +16,36 @@\n import com.google.common.collect.ImmutableList;\n import io.prestosql.spi.eventlistener.QueryCompletedEvent;\n import io.prestosql.spi.eventlistener.QueryCreatedEvent;\n+import io.prestosql.spi.eventlistener.QueryMetadata;\n import io.prestosql.spi.eventlistener.SplitCompletedEvent;\n \n import java.util.List;\n import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.TimeUnit;\n+import java.util.function.Predicate;\n+\n+import static com.google.common.base.Predicates.alwaysTrue;\n+import static java.util.Objects.requireNonNull;\n \n class EventsBuilder\n {\n+    private final Predicate<QueryMetadata> queryFilter;\n     private ImmutableList.Builder<QueryCreatedEvent> queryCreatedEvents;\n     private ImmutableList.Builder<QueryCompletedEvent> queryCompletedEvents;\n     private ImmutableList.Builder<SplitCompletedEvent> splitCompletedEvents;\n \n     private CountDownLatch eventsLatch;\n \n+    public EventsBuilder()\n+    {\n+        this(alwaysTrue());\n+    }\n+\n+    public EventsBuilder(Predicate<QueryMetadata> queryFilter)\n+    {\n+        this.queryFilter = requireNonNull(queryFilter, \"filter is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MTc1MDg0OnYy", "diffSide": "RIGHT", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDozODoxN1rOHuwi2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjowMjoxMlrOHuz5tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5MTg5OA==", "bodyText": "should not be prt of \"Add query filtering logic to EventsBuilder\" commit", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518791898", "createdAt": "2020-11-06T14:38:17Z", "author": {"login": "findepi"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -58,6 +58,7 @@\n         extends AbstractTestQueryFramework\n {\n     private static final int SPLITS_PER_NODE = 3;\n+    private static final String IGNORE_EVENT_MARKER = \"-- ignore_generated_event\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg0NjkwMw==", "bodyText": "I put it in test for now. Only one tests uses it.\nIn EventBuilder you can provide any predicate which can assess metadata, not necessarily look for substring in query.", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518846903", "createdAt": "2020-11-06T16:02:12Z", "author": {"login": "losipiuk"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -58,6 +58,7 @@\n         extends AbstractTestQueryFramework\n {\n     private static final int SPLITS_PER_NODE = 3;\n+    private static final String IGNORE_EVENT_MARKER = \"-- ignore_generated_event\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5MTg5OA=="}, "originalCommit": null, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MTc2MTgxOnYy", "diffSide": "RIGHT", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDo0MTowMlrOHuwpxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjowNjoyMFrOHu0Dbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5MzY2OA==", "bodyText": "[UUID.] randomUUID().toString().replace(\"-\", \"\")", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518793668", "createdAt": "2020-11-06T14:41:02Z", "author": {"login": "findepi"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg0OTM5MA==", "bodyText": "I also updated same code in TestKillQuery", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518849390", "createdAt": "2020-11-06T16:06:20Z", "author": {"login": "losipiuk"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5MzY2OA=="}, "originalCommit": null, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MTc3Mjk2OnYy", "diffSide": "RIGHT", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDo0Mzo1MVrOHuww0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjowOToxM1rOHu0KNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NTQ3Mw==", "bodyText": "Assertion is in async code, so it becomes less obvious the test effectively asserts what's supposed to do (it does, today).\nI think it would be more readable to move query cancellation to async code,\nand have query submittion and assertion in the main test thread.", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518795473", "createdAt": "2020-11-06T14:43:51Z", "author": {"login": "findepi"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);\n+        ExecutorService executorService = Executors.newSingleThreadExecutor();\n+        try {\n+            Future<Object> testQueryFuture = executorService.submit(\n+                    () -> {\n+                        Session mySession = Session.builder(getSession())\n+                                .setSystemProperty(\"required_workers_count\", \"17\")\n+                                .setSystemProperty(\"required_workers_max_wait_time\", \"5m\")\n+                                .build();\n+                        String sql = format(\"SELECT nationkey as %s  FROM tpch.sf1.nation\", testQueryMarker);\n+                        assertFailedQuery(mySession, sql, \"Query killed. Message: because\");\n+                        return null;\n+                    });\n+\n+            Optional<String> queryIdValue = findQueryId(testQueryMarker);\n+            assertThat(queryIdValue).as(\"query id\").isPresent();\n+\n+            getQueryRunner().execute(format(\"CALL system.runtime.kill_query('%s', 'because') %s\", queryIdValue.get(), IGNORE_EVENT_MARKER));\n+            testQueryFuture.get(5, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg1MTEyNg==", "bodyText": "Sure. It makes it a bit harder to read though. As code does not match natural ordering.", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518851126", "createdAt": "2020-11-06T16:09:13Z", "author": {"login": "losipiuk"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);\n+        ExecutorService executorService = Executors.newSingleThreadExecutor();\n+        try {\n+            Future<Object> testQueryFuture = executorService.submit(\n+                    () -> {\n+                        Session mySession = Session.builder(getSession())\n+                                .setSystemProperty(\"required_workers_count\", \"17\")\n+                                .setSystemProperty(\"required_workers_max_wait_time\", \"5m\")\n+                                .build();\n+                        String sql = format(\"SELECT nationkey as %s  FROM tpch.sf1.nation\", testQueryMarker);\n+                        assertFailedQuery(mySession, sql, \"Query killed. Message: because\");\n+                        return null;\n+                    });\n+\n+            Optional<String> queryIdValue = findQueryId(testQueryMarker);\n+            assertThat(queryIdValue).as(\"query id\").isPresent();\n+\n+            getQueryRunner().execute(format(\"CALL system.runtime.kill_query('%s', 'because') %s\", queryIdValue.get(), IGNORE_EVENT_MARKER));\n+            testQueryFuture.get(5, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NTQ3Mw=="}, "originalCommit": null, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MTc3MzMyOnYy", "diffSide": "RIGHT", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDo0Mzo1NlrOHuwxBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDo0Mzo1NlrOHuwxBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NTUyNg==", "bodyText": "add a timeout", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518795526", "createdAt": "2020-11-06T14:43:56Z", "author": {"login": "findepi"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MTc3NDU0OnYy", "diffSide": "RIGHT", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDo0NDoxNlrOHuwxyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDo0NDoxNlrOHuwxyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NTcyMw==", "bodyText": "don't sleep at first, should the query be already there", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518795723", "createdAt": "2020-11-06T14:44:16Z", "author": {"login": "findepi"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);\n+        ExecutorService executorService = Executors.newSingleThreadExecutor();\n+        try {\n+            Future<Object> testQueryFuture = executorService.submit(\n+                    () -> {\n+                        Session mySession = Session.builder(getSession())\n+                                .setSystemProperty(\"required_workers_count\", \"17\")\n+                                .setSystemProperty(\"required_workers_max_wait_time\", \"5m\")\n+                                .build();\n+                        String sql = format(\"SELECT nationkey as %s  FROM tpch.sf1.nation\", testQueryMarker);\n+                        assertFailedQuery(mySession, sql, \"Query killed. Message: because\");\n+                        return null;\n+                    });\n+\n+            Optional<String> queryIdValue = findQueryId(testQueryMarker);\n+            assertThat(queryIdValue).as(\"query id\").isPresent();\n+\n+            getQueryRunner().execute(format(\"CALL system.runtime.kill_query('%s', 'because') %s\", queryIdValue.get(), IGNORE_EVENT_MARKER));\n+            testQueryFuture.get(5, TimeUnit.SECONDS);\n+        }\n+        finally {\n+            shutdownAndAwaitTermination(executorService, Duration.ZERO);\n+        }\n+    }\n+\n+    private Optional<String> findQueryId(String queryPattern)\n+            throws InterruptedException\n+    {\n+        Optional<String> queryIdValue = Optional.empty();\n+        while (queryIdValue.isEmpty()) {\n+            Thread.sleep(50);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MTc3OTEyOnYy", "diffSide": "RIGHT", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDo0NToxNVrOHuw0cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjoxODoxMVrOHu0fUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NjQwMQ==", "bodyText": "we should use PREPARE and EXECUTE instead of sql injection....\nignore now", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518796401", "createdAt": "2020-11-06T14:45:15Z", "author": {"login": "findepi"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);\n+        ExecutorService executorService = Executors.newSingleThreadExecutor();\n+        try {\n+            Future<Object> testQueryFuture = executorService.submit(\n+                    () -> {\n+                        Session mySession = Session.builder(getSession())\n+                                .setSystemProperty(\"required_workers_count\", \"17\")\n+                                .setSystemProperty(\"required_workers_max_wait_time\", \"5m\")\n+                                .build();\n+                        String sql = format(\"SELECT nationkey as %s  FROM tpch.sf1.nation\", testQueryMarker);\n+                        assertFailedQuery(mySession, sql, \"Query killed. Message: because\");\n+                        return null;\n+                    });\n+\n+            Optional<String> queryIdValue = findQueryId(testQueryMarker);\n+            assertThat(queryIdValue).as(\"query id\").isPresent();\n+\n+            getQueryRunner().execute(format(\"CALL system.runtime.kill_query('%s', 'because') %s\", queryIdValue.get(), IGNORE_EVENT_MARKER));\n+            testQueryFuture.get(5, TimeUnit.SECONDS);\n+        }\n+        finally {\n+            shutdownAndAwaitTermination(executorService, Duration.ZERO);\n+        }\n+    }\n+\n+    private Optional<String> findQueryId(String queryPattern)\n+            throws InterruptedException\n+    {\n+        Optional<String> queryIdValue = Optional.empty();\n+        while (queryIdValue.isEmpty()) {\n+            Thread.sleep(50);\n+            queryIdValue = computeActual(\n+                    format(\"SELECT query_id FROM system.runtime.queries WHERE query LIKE '%%%s%%' AND query NOT LIKE '%%system.runtime.queries%%' %s\",\n+                            queryPattern,\n+                            IGNORE_EVENT_MARKER))", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg1NjUyOA==", "bodyText": "ignoring. Happy to learn more.", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518856528", "createdAt": "2020-11-06T16:18:11Z", "author": {"login": "losipiuk"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);\n+        ExecutorService executorService = Executors.newSingleThreadExecutor();\n+        try {\n+            Future<Object> testQueryFuture = executorService.submit(\n+                    () -> {\n+                        Session mySession = Session.builder(getSession())\n+                                .setSystemProperty(\"required_workers_count\", \"17\")\n+                                .setSystemProperty(\"required_workers_max_wait_time\", \"5m\")\n+                                .build();\n+                        String sql = format(\"SELECT nationkey as %s  FROM tpch.sf1.nation\", testQueryMarker);\n+                        assertFailedQuery(mySession, sql, \"Query killed. Message: because\");\n+                        return null;\n+                    });\n+\n+            Optional<String> queryIdValue = findQueryId(testQueryMarker);\n+            assertThat(queryIdValue).as(\"query id\").isPresent();\n+\n+            getQueryRunner().execute(format(\"CALL system.runtime.kill_query('%s', 'because') %s\", queryIdValue.get(), IGNORE_EVENT_MARKER));\n+            testQueryFuture.get(5, TimeUnit.SECONDS);\n+        }\n+        finally {\n+            shutdownAndAwaitTermination(executorService, Duration.ZERO);\n+        }\n+    }\n+\n+    private Optional<String> findQueryId(String queryPattern)\n+            throws InterruptedException\n+    {\n+        Optional<String> queryIdValue = Optional.empty();\n+        while (queryIdValue.isEmpty()) {\n+            Thread.sleep(50);\n+            queryIdValue = computeActual(\n+                    format(\"SELECT query_id FROM system.runtime.queries WHERE query LIKE '%%%s%%' AND query NOT LIKE '%%system.runtime.queries%%' %s\",\n+                            queryPattern,\n+                            IGNORE_EVENT_MARKER))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NjQwMQ=="}, "originalCommit": null, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MTc4MDkzOnYy", "diffSide": "RIGHT", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDo0NTo0MVrOHuw1fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDo0NTo0MVrOHuw1fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NjY3MQ==", "bodyText": "i think abstaining from format would yield to more readable code, since % interfere", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518796671", "createdAt": "2020-11-06T14:45:41Z", "author": {"login": "findepi"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);\n+        ExecutorService executorService = Executors.newSingleThreadExecutor();\n+        try {\n+            Future<Object> testQueryFuture = executorService.submit(\n+                    () -> {\n+                        Session mySession = Session.builder(getSession())\n+                                .setSystemProperty(\"required_workers_count\", \"17\")\n+                                .setSystemProperty(\"required_workers_max_wait_time\", \"5m\")\n+                                .build();\n+                        String sql = format(\"SELECT nationkey as %s  FROM tpch.sf1.nation\", testQueryMarker);\n+                        assertFailedQuery(mySession, sql, \"Query killed. Message: because\");\n+                        return null;\n+                    });\n+\n+            Optional<String> queryIdValue = findQueryId(testQueryMarker);\n+            assertThat(queryIdValue).as(\"query id\").isPresent();\n+\n+            getQueryRunner().execute(format(\"CALL system.runtime.kill_query('%s', 'because') %s\", queryIdValue.get(), IGNORE_EVENT_MARKER));\n+            testQueryFuture.get(5, TimeUnit.SECONDS);\n+        }\n+        finally {\n+            shutdownAndAwaitTermination(executorService, Duration.ZERO);\n+        }\n+    }\n+\n+    private Optional<String> findQueryId(String queryPattern)\n+            throws InterruptedException\n+    {\n+        Optional<String> queryIdValue = Optional.empty();\n+        while (queryIdValue.isEmpty()) {\n+            Thread.sleep(50);\n+            queryIdValue = computeActual(\n+                    format(\"SELECT query_id FROM system.runtime.queries WHERE query LIKE '%%%s%%' AND query NOT LIKE '%%system.runtime.queries%%' %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MTc4Mzc0OnYy", "diffSide": "RIGHT", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDo0NjoyMVrOHuw3Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNDo0NjoyMVrOHuw3Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NzEwMw==", "bodyText": "move this above utility methoids (findQueryId)", "url": "https://github.com/trinodb/trino/pull/5815#discussion_r518797103", "createdAt": "2020-11-06T14:46:21Z", "author": {"login": "findepi"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -156,8 +166,81 @@ public void testPlanningFailure()\n         assertFailedQuery(\"SELECT * FROM mock.default.tests_table\", \"Throw from apply projection\");\n     }\n \n+    @Test\n+    public void testAbortedWhileWaitingForResources()\n+            throws Exception\n+    {\n+        Session mySession = Session.builder(getSession())\n+                .setSystemProperty(\"required_workers_count\", \"17\")\n+                .setSystemProperty(\"required_workers_max_wait_time\", \"10ms\")\n+                .build();\n+        assertFailedQuery(mySession, \"SELECT * FROM tpch.sf1.nation\", \"Insufficient active worker nodes. Waited 10.00ms for at least 17 workers, but only 1 workers are active\");\n+    }\n+\n+    @Test\n+    public void testKilledWhileWaitingForResources()\n+            throws Exception\n+    {\n+        String testQueryMarker = \"test_query_id_\" + ThreadLocalRandom.current().nextInt(100_000_000);\n+        ExecutorService executorService = Executors.newSingleThreadExecutor();\n+        try {\n+            Future<Object> testQueryFuture = executorService.submit(\n+                    () -> {\n+                        Session mySession = Session.builder(getSession())\n+                                .setSystemProperty(\"required_workers_count\", \"17\")\n+                                .setSystemProperty(\"required_workers_max_wait_time\", \"5m\")\n+                                .build();\n+                        String sql = format(\"SELECT nationkey as %s  FROM tpch.sf1.nation\", testQueryMarker);\n+                        assertFailedQuery(mySession, sql, \"Query killed. Message: because\");\n+                        return null;\n+                    });\n+\n+            Optional<String> queryIdValue = findQueryId(testQueryMarker);\n+            assertThat(queryIdValue).as(\"query id\").isPresent();\n+\n+            getQueryRunner().execute(format(\"CALL system.runtime.kill_query('%s', 'because') %s\", queryIdValue.get(), IGNORE_EVENT_MARKER));\n+            testQueryFuture.get(5, TimeUnit.SECONDS);\n+        }\n+        finally {\n+            shutdownAndAwaitTermination(executorService, Duration.ZERO);\n+        }\n+    }\n+\n+    private Optional<String> findQueryId(String queryPattern)\n+            throws InterruptedException\n+    {\n+        Optional<String> queryIdValue = Optional.empty();\n+        while (queryIdValue.isEmpty()) {\n+            Thread.sleep(50);\n+            queryIdValue = computeActual(\n+                    format(\"SELECT query_id FROM system.runtime.queries WHERE query LIKE '%%%s%%' AND query NOT LIKE '%%system.runtime.queries%%' %s\",\n+                            queryPattern,\n+                            IGNORE_EVENT_MARKER))\n+                    .getOnlyColumn()\n+                    .map(String.class::cast)\n+                    .collect(toOptional());\n+        }\n+        return queryIdValue;\n+    }\n+\n+    @Test\n+    public void testWithInvalidExecutionPolicy()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 96}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4937, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}