{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3ODkzNTAy", "number": 5186, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDo1MToxMVrOEj_90g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDo1MToxMVrOEj_90g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MTgzNjM0OnYy", "diffSide": "LEFT", "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTask.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDo1MToxMVrOHSrRAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMjo1NDo1MFrOHSvbnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0NTI4MQ==", "bodyText": "This was failing with\nAssertionError: expected [1] but found [0]\n\nhow possible is that we could transition to FINISHED without changing the version field?\nwhat's the mechanics here?", "url": "https://github.com/trinodb/trino/pull/5186#discussion_r489345281", "createdAt": "2020-09-16T10:51:11Z", "author": {"login": "findepi"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTask.java", "diffHunk": "@@ -139,7 +139,6 @@ public void testEmptyQuery()\n \n         taskInfo = sqlTask.getTaskInfo(STARTING_VERSION).get();\n         assertEquals(taskInfo.getTaskStatus().getState(), TaskState.FINISHED);\n-        assertEquals(taskInfo.getTaskStatus().getVersion(), STARTING_VERSION + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff814df88f08c7f47dc83c21762fb3e41498fede"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0ODk3OA==", "bodyText": "how possible is that we could transition to FINISHED without changing the version field?\nwhat's the mechanics here?\n\n\nfinal task status was set (thread 1)\ngetTaskInfo returned immediately, which is expected (test thread 2)\nassertion fails (test thread 2)\nversion was bumped (after final task status was set) and notification was sent (thread 1)\n\nDepending when getTaskInfo is called, version might be incremented or not. In both cases future completes, which is correct behavior.", "url": "https://github.com/trinodb/trino/pull/5186#discussion_r489348978", "createdAt": "2020-09-16T10:58:09Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTask.java", "diffHunk": "@@ -139,7 +139,6 @@ public void testEmptyQuery()\n \n         taskInfo = sqlTask.getTaskInfo(STARTING_VERSION).get();\n         assertEquals(taskInfo.getTaskStatus().getState(), TaskState.FINISHED);\n-        assertEquals(taskInfo.getTaskStatus().getVersion(), STARTING_VERSION + 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0NTI4MQ=="}, "originalCommit": {"oid": "ff814df88f08c7f47dc83c21762fb3e41498fede"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM1MTA3Ng==", "bodyText": "Should \"final task status was set\" and \"version was bumped\" be synchronized?", "url": "https://github.com/trinodb/trino/pull/5186#discussion_r489351076", "createdAt": "2020-09-16T11:02:12Z", "author": {"login": "findepi"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTask.java", "diffHunk": "@@ -139,7 +139,6 @@ public void testEmptyQuery()\n \n         taskInfo = sqlTask.getTaskInfo(STARTING_VERSION).get();\n         assertEquals(taskInfo.getTaskStatus().getState(), TaskState.FINISHED);\n-        assertEquals(taskInfo.getTaskStatus().getVersion(), STARTING_VERSION + 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0NTI4MQ=="}, "originalCommit": {"oid": "ff814df88f08c7f47dc83c21762fb3e41498fede"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM1Mjg3Mg==", "bodyText": "Should \"final task status was set\" and \"version was bumped\" be synchronized?\n\nThey don't need to be (and they shouldn't as action like \"getting final task status\" might be long). The only invariant is that status version is incremented eventually after action.", "url": "https://github.com/trinodb/trino/pull/5186#discussion_r489352872", "createdAt": "2020-09-16T11:05:58Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTask.java", "diffHunk": "@@ -139,7 +139,6 @@ public void testEmptyQuery()\n \n         taskInfo = sqlTask.getTaskInfo(STARTING_VERSION).get();\n         assertEquals(taskInfo.getTaskStatus().getState(), TaskState.FINISHED);\n-        assertEquals(taskInfo.getTaskStatus().getVersion(), STARTING_VERSION + 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0NTI4MQ=="}, "originalCommit": {"oid": "ff814df88f08c7f47dc83c21762fb3e41498fede"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM1ODgxOA==", "bodyText": "does bumping version involve more than incrementing a number?", "url": "https://github.com/trinodb/trino/pull/5186#discussion_r489358818", "createdAt": "2020-09-16T11:18:03Z", "author": {"login": "findepi"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTask.java", "diffHunk": "@@ -139,7 +139,6 @@ public void testEmptyQuery()\n \n         taskInfo = sqlTask.getTaskInfo(STARTING_VERSION).get();\n         assertEquals(taskInfo.getTaskStatus().getState(), TaskState.FINISHED);\n-        assertEquals(taskInfo.getTaskStatus().getVersion(), STARTING_VERSION + 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0NTI4MQ=="}, "originalCommit": {"oid": "ff814df88f08c7f47dc83c21762fb3e41498fede"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQxMzUzMg==", "bodyText": "There is io.prestosql.execution.SqlTask#notifyStatusChanged, which increments version and triggers current listeners.\nIt's synchronized so that current listeners list is obtained atomically with version increment.", "url": "https://github.com/trinodb/trino/pull/5186#discussion_r489413532", "createdAt": "2020-09-16T12:54:50Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTask.java", "diffHunk": "@@ -139,7 +139,6 @@ public void testEmptyQuery()\n \n         taskInfo = sqlTask.getTaskInfo(STARTING_VERSION).get();\n         assertEquals(taskInfo.getTaskStatus().getState(), TaskState.FINISHED);\n-        assertEquals(taskInfo.getTaskStatus().getVersion(), STARTING_VERSION + 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0NTI4MQ=="}, "originalCommit": {"oid": "ff814df88f08c7f47dc83c21762fb3e41498fede"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2980, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}