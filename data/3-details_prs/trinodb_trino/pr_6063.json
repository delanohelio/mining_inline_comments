{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1OTE0OTkw", "number": 6063, "title": "Added ability to have unique table location for each iceberg table", "bodyText": "#5632\nAdded new iceberg configuration property iceberg.unique-table-location\nBy default this property = false, so table directory will have the same name as table.\nIn case iceberg.unique-table-location = true unique UUID will be added to the  table directory name, so each table will have unique location", "createdAt": "2020-11-23T18:22:45Z", "url": "https://github.com/trinodb/trino/pull/6063", "merged": true, "mergeCommit": {"oid": "bea74d58a0b0430b322c828200edc9ba8339a441"}, "closed": true, "closedAt": "2021-08-03T13:33:25Z", "author": {"login": "sshkvar"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfuXS_AFqTUzNzgwNDA3OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABewvzM4gFqTcyMTEyNTAyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3ODA0MDc4", "url": "https://github.com/trinodb/trino/pull/6063#pullrequestreview-537804078", "createdAt": "2020-11-24T18:41:22Z", "commit": {"oid": "e039d5d9586b9204d0fac111279822be52d24fbd"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODo0MToyM1rOH5QWPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODo0OToxOVrOH5QnkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc5ODcxOQ==", "bodyText": "We don't need to say \"if true\" for boolean properties, as that's redundant. Let's phrase this as\n\nInclude UUID in the table location", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r529798719", "createdAt": "2020-11-24T18:41:23Z", "author": {"login": "electrum"}, "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergConfig.java", "diffHunk": "@@ -52,4 +54,18 @@ public IcebergConfig setCompressionCodec(HiveCompressionCodec compressionCodec)\n         this.compressionCodec = compressionCodec;\n         return this;\n     }\n+\n+    @NotNull\n+    public boolean isUniqueTableLocation()\n+    {\n+        return uniqueTableLocation;\n+    }\n+\n+    @Config(\"iceberg.unique-table-location\")\n+    @ConfigDescription(\"If true UUID will be added to the table location\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e039d5d9586b9204d0fac111279822be52d24fbd"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc5ODc4MA==", "bodyText": "Not needed since this returns a primitive", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r529798780", "createdAt": "2020-11-24T18:41:29Z", "author": {"login": "electrum"}, "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergConfig.java", "diffHunk": "@@ -52,4 +54,18 @@ public IcebergConfig setCompressionCodec(HiveCompressionCodec compressionCodec)\n         this.compressionCodec = compressionCodec;\n         return this;\n     }\n+\n+    @NotNull", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e039d5d9586b9204d0fac111279822be52d24fbd"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwMTMwOA==", "bodyText": "Should we remove the dashes? Compare\n\nmy_table-1ec297aa2e8511eb9dfe7bf8d2aea93a\nmy_table_1ec297aa-2e85-11eb-9dfe-7bf8d2aea93a", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r529801308", "createdAt": "2020-11-24T18:45:50Z", "author": {"login": "electrum"}, "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergMetadata.java", "diffHunk": "@@ -393,7 +397,8 @@ public ConnectorOutputTableHandle beginCreateTable(ConnectorSession session, Con\n         HiveIdentity identity = new HiveIdentity(session);\n         String targetPath = getTableLocation(tableMetadata.getProperties());\n         if (targetPath == null) {\n-            targetPath = getTableDefaultLocation(database, hdfsContext, hdfsEnvironment, schemaName, tableName).toString();\n+            String uniqueTableName = useUniqueTableLocation ? String.format(\"%s_%s\", tableName, UUID.randomUUID()) : tableName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e039d5d9586b9204d0fac111279822be52d24fbd"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwMzE1Mw==", "bodyText": "Wrap the argument, since all other arguments are wrapped", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r529803153", "createdAt": "2020-11-24T18:49:19Z", "author": {"login": "electrum"}, "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergMetadataFactory.java", "diffHunk": "@@ -37,23 +38,24 @@ public IcebergMetadataFactory(\n             TypeManager typeManager,\n             JsonCodec<CommitTaskData> commitTaskDataJsonCodec)\n     {\n-        this(metastore, hdfsEnvironment, typeManager, commitTaskDataJsonCodec);\n+        this(metastore, hdfsEnvironment, typeManager, commitTaskDataJsonCodec, config.isUniqueTableLocation());\n     }\n \n     public IcebergMetadataFactory(\n             HiveMetastore metastore,\n             HdfsEnvironment hdfsEnvironment,\n             TypeManager typeManager,\n-            JsonCodec<CommitTaskData> commitTaskCodec)\n+            JsonCodec<CommitTaskData> commitTaskCodec, boolean useUniqueTableLocation)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e039d5d9586b9204d0fac111279822be52d24fbd"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjYxNTk2NzA1", "url": "https://github.com/trinodb/trino/pull/6063#pullrequestreview-661596705", "createdAt": "2021-05-18T03:14:54Z", "commit": {"oid": "647298023da5fc86990dcb0d8c2dadc92a83c85a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0xOFQwMzoxNDo1NFrOJco2ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0xOFQwMzo0NjoyNlrOJcpX-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDAwOTE5NA==", "bodyText": "tableName + \"-\" + UUID.randomUUID().toString().replace(\"-\", \"\")", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r634009194", "createdAt": "2021-05-18T03:14:54Z", "author": {"login": "raunaqmorarka"}, "path": "plugin/trino-iceberg/src/main/java/io/trino/plugin/iceberg/IcebergMetadata.java", "diffHunk": "@@ -1074,6 +1078,11 @@ else if (strings.size() != 2) {\n         return viewToken;\n     }\n \n+    private String generateUniqueTableName(String tableName)\n+    {\n+        return String.format(\"%s-%s\", tableName, UUID.randomUUID().toString().replace(\"-\", \"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "647298023da5fc86990dcb0d8c2dadc92a83c85a"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDAxNzc4NA==", "bodyText": "Append  randomUUID to table location", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r634017784", "createdAt": "2021-05-18T03:46:26Z", "author": {"login": "raunaqmorarka"}, "path": "plugin/trino-iceberg/src/main/java/io/trino/plugin/iceberg/IcebergConfig.java", "diffHunk": "@@ -74,4 +76,17 @@ public IcebergConfig setUseFileSizeFromMetadata(boolean useFileSizeFromMetadata)\n         this.useFileSizeFromMetadata = useFileSizeFromMetadata;\n         return this;\n     }\n+\n+    public boolean isUniqueTableLocation()\n+    {\n+        return uniqueTableLocation;\n+    }\n+\n+    @Config(\"iceberg.unique-table-location\")\n+    @ConfigDescription(\"Include UUID in the table location\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "647298023da5fc86990dcb0d8c2dadc92a83c85a"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzE1NzYzMTQ0", "url": "https://github.com/trinodb/trino/pull/6063#pullrequestreview-715763144", "createdAt": "2021-07-27T10:47:31Z", "commit": {"oid": "647298023da5fc86990dcb0d8c2dadc92a83c85a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yN1QxMDo0NzozMVrOKF9LNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yN1QxMDo1MzoxN1rOKF9ZvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMzMzgxNQ==", "bodyText": "\"Use randomized, unique table locations\"", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r677333815", "createdAt": "2021-07-27T10:47:31Z", "author": {"login": "findepi"}, "path": "plugin/trino-iceberg/src/main/java/io/trino/plugin/iceberg/IcebergConfig.java", "diffHunk": "@@ -74,4 +76,17 @@ public IcebergConfig setUseFileSizeFromMetadata(boolean useFileSizeFromMetadata)\n         this.useFileSizeFromMetadata = useFileSizeFromMetadata;\n         return this;\n     }\n+\n+    public boolean isUniqueTableLocation()\n+    {\n+        return uniqueTableLocation;\n+    }\n+\n+    @Config(\"iceberg.unique-table-location\")\n+    @ConfigDescription(\"Include UUID in the table location\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDAxNzc4NA=="}, "originalCommit": {"oid": "647298023da5fc86990dcb0d8c2dadc92a83c85a"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMzNzUzMg==", "bodyText": "The uniqueTableName variable name suggests we're making the table name unique, while we're only changing table location.\nLet's call the variable tableNameForLocation\nSince same naming problem applies to generateUniqueTableName, let's inline that method.\nString tableNameForLocation = tableName;\nif (useUniqueTableLocation) {\n    tableNameForLocation += \"-\" + randomUUID().toString().replace(\"-\", \"\")\n}", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r677337532", "createdAt": "2021-07-27T10:53:17Z", "author": {"login": "findepi"}, "path": "plugin/trino-iceberg/src/main/java/io/trino/plugin/iceberg/IcebergMetadata.java", "diffHunk": "@@ -495,7 +498,8 @@ public ConnectorOutputTableHandle beginCreateTable(ConnectorSession session, Con\n         HiveIdentity identity = new HiveIdentity(session);\n         String targetPath = getTableLocation(tableMetadata.getProperties());\n         if (targetPath == null) {\n-            targetPath = getTableDefaultLocation(database, hdfsContext, hdfsEnvironment, schemaName, tableName).toString();\n+            String uniqueTableName = useUniqueTableLocation ? generateUniqueTableName(tableName) : tableName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "647298023da5fc86990dcb0d8c2dadc92a83c85a"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "647298023da5fc86990dcb0d8c2dadc92a83c85a", "author": {"user": {"login": "sshkvar", "name": null}}, "url": "https://github.com/trinodb/trino/commit/647298023da5fc86990dcb0d8c2dadc92a83c85a", "committedDate": "2021-01-26T15:11:45Z", "message": "Conflicts resolved after renaming to Trino"}, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzE3NzQ3OTE5", "url": "https://github.com/trinodb/trino/pull/6063#pullrequestreview-717747919", "createdAt": "2021-07-29T07:15:33Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yOVQwNzoxNTozM1rOKHcCcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yOVQwNzoxOTozMlrOKHcL_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODg4ODA0OQ==", "bodyText": "The test class cannot be executed in threads, because the table name is shared between tests.\nInstead of making it single-threaded, use different table name in each test method.", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r678888049", "createdAt": "2021-07-29T07:15:33Z", "author": {"login": "findepi"}, "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/TestIcebergTableWithCustomLocation.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.plugin.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import io.trino.Session;\n+import io.trino.plugin.hive.HdfsConfig;\n+import io.trino.plugin.hive.HdfsConfiguration;\n+import io.trino.plugin.hive.HdfsConfigurationInitializer;\n+import io.trino.plugin.hive.HdfsEnvironment;\n+import io.trino.plugin.hive.HiveHdfsConfiguration;\n+import io.trino.plugin.hive.NodeVersion;\n+import io.trino.plugin.hive.TestingHivePlugin;\n+import io.trino.plugin.hive.authentication.NoHdfsAuthentication;\n+import io.trino.plugin.hive.metastore.MetastoreConfig;\n+import io.trino.plugin.hive.metastore.Table;\n+import io.trino.plugin.hive.metastore.file.FileHiveMetastore;\n+import io.trino.plugin.hive.metastore.file.FileHiveMetastoreConfig;\n+import io.trino.spi.security.Identity;\n+import io.trino.spi.security.SelectedRole;\n+import io.trino.testing.AbstractTestQueryFramework;\n+import io.trino.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.util.Optional;\n+\n+import static io.trino.spi.security.SelectedRole.Type.ROLE;\n+import static io.trino.testing.TestingSession.testSessionBuilder;\n+import static java.lang.String.format;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertNotEquals;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestIcebergTableWithCustomLocation\n+        extends AbstractTestQueryFramework\n+{\n+    private FileHiveMetastore metastore;\n+\n+    private static final String CATALOG = \"iceberg\";\n+    private static final String SCHEMA = \"iceberg_schema\";\n+    private static final String TABLE = \"iceberg_table\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODg4ODY3OA==", "bodyText": "would it work to use io.trino.plugin.hive.HiveTestUtils.HDFS_ENVIRONMENT instead?", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r678888678", "createdAt": "2021-07-29T07:16:34Z", "author": {"login": "findepi"}, "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/TestIcebergTableWithCustomLocation.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.plugin.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import io.trino.Session;\n+import io.trino.plugin.hive.HdfsConfig;\n+import io.trino.plugin.hive.HdfsConfiguration;\n+import io.trino.plugin.hive.HdfsConfigurationInitializer;\n+import io.trino.plugin.hive.HdfsEnvironment;\n+import io.trino.plugin.hive.HiveHdfsConfiguration;\n+import io.trino.plugin.hive.NodeVersion;\n+import io.trino.plugin.hive.TestingHivePlugin;\n+import io.trino.plugin.hive.authentication.NoHdfsAuthentication;\n+import io.trino.plugin.hive.metastore.MetastoreConfig;\n+import io.trino.plugin.hive.metastore.Table;\n+import io.trino.plugin.hive.metastore.file.FileHiveMetastore;\n+import io.trino.plugin.hive.metastore.file.FileHiveMetastoreConfig;\n+import io.trino.spi.security.Identity;\n+import io.trino.spi.security.SelectedRole;\n+import io.trino.testing.AbstractTestQueryFramework;\n+import io.trino.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.util.Optional;\n+\n+import static io.trino.spi.security.SelectedRole.Type.ROLE;\n+import static io.trino.testing.TestingSession.testSessionBuilder;\n+import static java.lang.String.format;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertNotEquals;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestIcebergTableWithCustomLocation\n+        extends AbstractTestQueryFramework\n+{\n+    private FileHiveMetastore metastore;\n+\n+    private static final String CATALOG = \"iceberg\";\n+    private static final String SCHEMA = \"iceberg_schema\";\n+    private static final String TABLE = \"iceberg_table\";\n+    private static final String TABLE_RENAMED = \"iceberg_table_renamed\";\n+\n+    @Override\n+    protected DistributedQueryRunner createQueryRunner()\n+            throws Exception\n+    {\n+        Session session = testSessionBuilder()\n+                .setIdentity(Identity.forUser(\"hive\")\n+                        .withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\")))\n+                        .build())\n+                .build();\n+        DistributedQueryRunner queryRunner = DistributedQueryRunner.builder(session).build();\n+\n+        File baseDir = queryRunner.getCoordinator().getBaseDataDir().resolve(\"iceberg_data\").toFile();\n+\n+        HdfsConfig hdfsConfig = new HdfsConfig();\n+        HdfsConfiguration hdfsConfiguration = new HiveHdfsConfiguration(new HdfsConfigurationInitializer(hdfsConfig), ImmutableSet.of());\n+        HdfsEnvironment hdfsEnvironment = new HdfsEnvironment(hdfsConfiguration, hdfsConfig, new NoHdfsAuthentication());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODg4OTA0OQ==", "bodyText": "what is this for?", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r678889049", "createdAt": "2021-07-29T07:17:08Z", "author": {"login": "findepi"}, "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/TestIcebergTableWithCustomLocation.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.plugin.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import io.trino.Session;\n+import io.trino.plugin.hive.HdfsConfig;\n+import io.trino.plugin.hive.HdfsConfiguration;\n+import io.trino.plugin.hive.HdfsConfigurationInitializer;\n+import io.trino.plugin.hive.HdfsEnvironment;\n+import io.trino.plugin.hive.HiveHdfsConfiguration;\n+import io.trino.plugin.hive.NodeVersion;\n+import io.trino.plugin.hive.TestingHivePlugin;\n+import io.trino.plugin.hive.authentication.NoHdfsAuthentication;\n+import io.trino.plugin.hive.metastore.MetastoreConfig;\n+import io.trino.plugin.hive.metastore.Table;\n+import io.trino.plugin.hive.metastore.file.FileHiveMetastore;\n+import io.trino.plugin.hive.metastore.file.FileHiveMetastoreConfig;\n+import io.trino.spi.security.Identity;\n+import io.trino.spi.security.SelectedRole;\n+import io.trino.testing.AbstractTestQueryFramework;\n+import io.trino.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.util.Optional;\n+\n+import static io.trino.spi.security.SelectedRole.Type.ROLE;\n+import static io.trino.testing.TestingSession.testSessionBuilder;\n+import static java.lang.String.format;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertNotEquals;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestIcebergTableWithCustomLocation\n+        extends AbstractTestQueryFramework\n+{\n+    private FileHiveMetastore metastore;\n+\n+    private static final String CATALOG = \"iceberg\";\n+    private static final String SCHEMA = \"iceberg_schema\";\n+    private static final String TABLE = \"iceberg_table\";\n+    private static final String TABLE_RENAMED = \"iceberg_table_renamed\";\n+\n+    @Override\n+    protected DistributedQueryRunner createQueryRunner()\n+            throws Exception\n+    {\n+        Session session = testSessionBuilder()\n+                .setIdentity(Identity.forUser(\"hive\")\n+                        .withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\")))\n+                        .build())\n+                .build();\n+        DistributedQueryRunner queryRunner = DistributedQueryRunner.builder(session).build();\n+\n+        File baseDir = queryRunner.getCoordinator().getBaseDataDir().resolve(\"iceberg_data\").toFile();\n+\n+        HdfsConfig hdfsConfig = new HdfsConfig();\n+        HdfsConfiguration hdfsConfiguration = new HiveHdfsConfiguration(new HdfsConfigurationInitializer(hdfsConfig), ImmutableSet.of());\n+        HdfsEnvironment hdfsEnvironment = new HdfsEnvironment(hdfsConfiguration, hdfsConfig, new NoHdfsAuthentication());\n+\n+        metastore = new FileHiveMetastore(\n+                new NodeVersion(\"test_version\"),\n+                hdfsEnvironment,\n+                new MetastoreConfig(),\n+                new FileHiveMetastoreConfig()\n+                        .setCatalogDirectory(baseDir.toURI().toString())\n+                        .setMetastoreUser(\"test\"));\n+\n+        TestingIcebergPlugin icebergPlugin = new TestingIcebergPlugin(metastore, false);\n+\n+        queryRunner.installPlugin(icebergPlugin);\n+        queryRunner.createCatalog(CATALOG, \"iceberg\", ImmutableMap.of(\"iceberg.unique-table-location\", \"true\"));\n+        queryRunner.installPlugin(new TestingHivePlugin(metastore));\n+        queryRunner.createCatalog(\"hive\", \"hive\", ImmutableMap.of(\"hive.security\", \"sql-standard\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODg4OTk4Mw==", "bodyText": "We can use iceberg.default schema, so that we don't have to setup things.\nactually, the QueryRunner should have iceberg catalog, and the chosen schema set as session's default, so that you don't need to qualify tables in all the queries", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r678889983", "createdAt": "2021-07-29T07:18:42Z", "author": {"login": "findepi"}, "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/TestIcebergTableWithCustomLocation.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.plugin.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import io.trino.Session;\n+import io.trino.plugin.hive.HdfsConfig;\n+import io.trino.plugin.hive.HdfsConfiguration;\n+import io.trino.plugin.hive.HdfsConfigurationInitializer;\n+import io.trino.plugin.hive.HdfsEnvironment;\n+import io.trino.plugin.hive.HiveHdfsConfiguration;\n+import io.trino.plugin.hive.NodeVersion;\n+import io.trino.plugin.hive.TestingHivePlugin;\n+import io.trino.plugin.hive.authentication.NoHdfsAuthentication;\n+import io.trino.plugin.hive.metastore.MetastoreConfig;\n+import io.trino.plugin.hive.metastore.Table;\n+import io.trino.plugin.hive.metastore.file.FileHiveMetastore;\n+import io.trino.plugin.hive.metastore.file.FileHiveMetastoreConfig;\n+import io.trino.spi.security.Identity;\n+import io.trino.spi.security.SelectedRole;\n+import io.trino.testing.AbstractTestQueryFramework;\n+import io.trino.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.util.Optional;\n+\n+import static io.trino.spi.security.SelectedRole.Type.ROLE;\n+import static io.trino.testing.TestingSession.testSessionBuilder;\n+import static java.lang.String.format;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertNotEquals;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestIcebergTableWithCustomLocation\n+        extends AbstractTestQueryFramework\n+{\n+    private FileHiveMetastore metastore;\n+\n+    private static final String CATALOG = \"iceberg\";\n+    private static final String SCHEMA = \"iceberg_schema\";\n+    private static final String TABLE = \"iceberg_table\";\n+    private static final String TABLE_RENAMED = \"iceberg_table_renamed\";\n+\n+    @Override\n+    protected DistributedQueryRunner createQueryRunner()\n+            throws Exception\n+    {\n+        Session session = testSessionBuilder()\n+                .setIdentity(Identity.forUser(\"hive\")\n+                        .withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\")))\n+                        .build())\n+                .build();\n+        DistributedQueryRunner queryRunner = DistributedQueryRunner.builder(session).build();\n+\n+        File baseDir = queryRunner.getCoordinator().getBaseDataDir().resolve(\"iceberg_data\").toFile();\n+\n+        HdfsConfig hdfsConfig = new HdfsConfig();\n+        HdfsConfiguration hdfsConfiguration = new HiveHdfsConfiguration(new HdfsConfigurationInitializer(hdfsConfig), ImmutableSet.of());\n+        HdfsEnvironment hdfsEnvironment = new HdfsEnvironment(hdfsConfiguration, hdfsConfig, new NoHdfsAuthentication());\n+\n+        metastore = new FileHiveMetastore(\n+                new NodeVersion(\"test_version\"),\n+                hdfsEnvironment,\n+                new MetastoreConfig(),\n+                new FileHiveMetastoreConfig()\n+                        .setCatalogDirectory(baseDir.toURI().toString())\n+                        .setMetastoreUser(\"test\"));\n+\n+        TestingIcebergPlugin icebergPlugin = new TestingIcebergPlugin(metastore, false);\n+\n+        queryRunner.installPlugin(icebergPlugin);\n+        queryRunner.createCatalog(CATALOG, \"iceberg\", ImmutableMap.of(\"iceberg.unique-table-location\", \"true\"));\n+        queryRunner.installPlugin(new TestingHivePlugin(metastore));\n+        queryRunner.createCatalog(\"hive\", \"hive\", ImmutableMap.of(\"hive.security\", \"sql-standard\"));\n+        return queryRunner;\n+    }\n+\n+    @BeforeClass\n+    public void setUp()\n+    {\n+        assertQuerySucceeds(format(\"CREATE SCHEMA %s.%s\", CATALOG, SCHEMA));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODg5MDQ5NQ==", "bodyText": "Would io.trino.plugin.iceberg.IcebergQueryRunner#createIcebergQueryRunner work?", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r678890495", "createdAt": "2021-07-29T07:19:32Z", "author": {"login": "findepi"}, "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/TestIcebergTableWithCustomLocation.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.plugin.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import io.trino.Session;\n+import io.trino.plugin.hive.HdfsConfig;\n+import io.trino.plugin.hive.HdfsConfiguration;\n+import io.trino.plugin.hive.HdfsConfigurationInitializer;\n+import io.trino.plugin.hive.HdfsEnvironment;\n+import io.trino.plugin.hive.HiveHdfsConfiguration;\n+import io.trino.plugin.hive.NodeVersion;\n+import io.trino.plugin.hive.TestingHivePlugin;\n+import io.trino.plugin.hive.authentication.NoHdfsAuthentication;\n+import io.trino.plugin.hive.metastore.MetastoreConfig;\n+import io.trino.plugin.hive.metastore.Table;\n+import io.trino.plugin.hive.metastore.file.FileHiveMetastore;\n+import io.trino.plugin.hive.metastore.file.FileHiveMetastoreConfig;\n+import io.trino.spi.security.Identity;\n+import io.trino.spi.security.SelectedRole;\n+import io.trino.testing.AbstractTestQueryFramework;\n+import io.trino.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import java.io.File;\n+import java.util.Optional;\n+\n+import static io.trino.spi.security.SelectedRole.Type.ROLE;\n+import static io.trino.testing.TestingSession.testSessionBuilder;\n+import static java.lang.String.format;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertNotEquals;\n+import static org.testng.Assert.assertTrue;\n+\n+public class TestIcebergTableWithCustomLocation\n+        extends AbstractTestQueryFramework\n+{\n+    private FileHiveMetastore metastore;\n+\n+    private static final String CATALOG = \"iceberg\";\n+    private static final String SCHEMA = \"iceberg_schema\";\n+    private static final String TABLE = \"iceberg_table\";\n+    private static final String TABLE_RENAMED = \"iceberg_table_renamed\";\n+\n+    @Override\n+    protected DistributedQueryRunner createQueryRunner()\n+            throws Exception\n+    {\n+        Session session = testSessionBuilder()\n+                .setIdentity(Identity.forUser(\"hive\")\n+                        .withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\")))\n+                        .build())\n+                .build();\n+        DistributedQueryRunner queryRunner = DistributedQueryRunner.builder(session).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzE4MTI0NTA3", "url": "https://github.com/trinodb/trino/pull/6063#pullrequestreview-718124507", "createdAt": "2021-07-29T13:54:58Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yOVQxMzo1NDo1OFrOKHtfvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yOVQxNDowNDozMlrOKHuAmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTE3NDA3Ng==", "bodyText": "Please update formatting\n\nall parameters on one line OR each parameter on its own line (including the first one)\nfor indentation please refer to https://github.com/airlift/codestyle/", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r679174076", "createdAt": "2021-07-29T13:54:58Z", "author": {"login": "findepi"}, "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/IcebergQueryRunner.java", "diffHunk": "@@ -66,11 +67,21 @@ public static DistributedQueryRunner createIcebergQueryRunner(Map<String, String\n         return createIcebergQueryRunner(extraProperties, format, tables, Optional.empty());\n     }\n \n+    public static DistributedQueryRunner createIcebergQueryRunner(Map<String, String> extraProperties,\n+                                                                  FileFormat format,\n+                                                                  List<TpchTable<?>> tables,\n+                                                                  Optional<File> metastoreDirectory)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTE3NDc0MQ==", "bodyText": "We call it connectorProperties in other XxxQueryRunner classes.\nalso, no need for optional, since empty map has the same meaning\n           Map<String, String> connectorProperties)\n\nalso, please add it right after extraProperties (also seems usual)", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r679174741", "createdAt": "2021-07-29T13:55:34Z", "author": {"login": "findepi"}, "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/IcebergQueryRunner.java", "diffHunk": "@@ -66,11 +67,21 @@ public static DistributedQueryRunner createIcebergQueryRunner(Map<String, String\n         return createIcebergQueryRunner(extraProperties, format, tables, Optional.empty());\n     }\n \n+    public static DistributedQueryRunner createIcebergQueryRunner(Map<String, String> extraProperties,\n+                                                                  FileFormat format,\n+                                                                  List<TpchTable<?>> tables,\n+                                                                  Optional<File> metastoreDirectory)\n+            throws Exception\n+    {\n+        return createIcebergQueryRunner(extraProperties, format, tables, metastoreDirectory, Optional.empty());\n+    }\n+\n     public static DistributedQueryRunner createIcebergQueryRunner(\n             Map<String, String> extraProperties,\n             FileFormat format,\n             List<TpchTable<?>> tables,\n-            Optional<File> metastoreDirectory)\n+            Optional<File> metastoreDirectory,\n+            Optional<Map<String, String>> icebergPropertiesOverride)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTE3NzQyNw==", "bodyText": "Why two levels of nesting?\nWould it be fine to have just\nmetastoreDir = Files.createTempDirectory(\"....\");\n\n?", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r679177427", "createdAt": "2021-07-29T13:58:40Z", "author": {"login": "findepi"}, "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/TestIcebergTableWithCustomLocation.java", "diffHunk": "@@ -52,125 +43,91 @@\n         extends AbstractTestQueryFramework\n {\n     private FileHiveMetastore metastore;\n-\n-    private static final String CATALOG = \"iceberg\";\n-    private static final String SCHEMA = \"iceberg_schema\";\n-    private static final String TABLE = \"iceberg_table\";\n-    private static final String TABLE_RENAMED = \"iceberg_table_renamed\";\n+    private File metastoreDir;\n \n     @Override\n     protected DistributedQueryRunner createQueryRunner()\n             throws Exception\n     {\n-        Session session = testSessionBuilder()\n-                .setIdentity(Identity.forUser(\"hive\")\n-                        .withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\")))\n-                        .build())\n-                .build();\n-        DistributedQueryRunner queryRunner = DistributedQueryRunner.builder(session).build();\n-\n-        File baseDir = queryRunner.getCoordinator().getBaseDataDir().resolve(\"iceberg_data\").toFile();\n-\n-        HdfsConfig hdfsConfig = new HdfsConfig();\n-        HdfsConfiguration hdfsConfiguration = new HiveHdfsConfiguration(new HdfsConfigurationInitializer(hdfsConfig), ImmutableSet.of());\n-        HdfsEnvironment hdfsEnvironment = new HdfsEnvironment(hdfsConfiguration, hdfsConfig, new NoHdfsAuthentication());\n-\n-        metastore = new FileHiveMetastore(\n-                new NodeVersion(\"test_version\"),\n-                hdfsEnvironment,\n-                new MetastoreConfig(),\n-                new FileHiveMetastoreConfig()\n-                        .setCatalogDirectory(baseDir.toURI().toString())\n-                        .setMetastoreUser(\"test\"));\n-\n-        TestingIcebergPlugin icebergPlugin = new TestingIcebergPlugin(metastore, false);\n-\n-        queryRunner.installPlugin(icebergPlugin);\n-        queryRunner.createCatalog(CATALOG, \"iceberg\", ImmutableMap.of(\"iceberg.unique-table-location\", \"true\"));\n-        queryRunner.installPlugin(new TestingHivePlugin(metastore));\n-        queryRunner.createCatalog(\"hive\", \"hive\", ImmutableMap.of(\"hive.security\", \"sql-standard\"));\n-        return queryRunner;\n-    }\n-\n-    @BeforeClass\n-    public void setUp()\n-    {\n-        assertQuerySucceeds(format(\"CREATE SCHEMA %s.%s\", CATALOG, SCHEMA));\n-    }\n-\n-    @AfterMethod\n-    public void clean()\n-    {\n-        query(format(\"DROP TABLE IF EXISTS %s.%s.%s\", CATALOG, SCHEMA, TABLE));\n-        query(format(\"DROP TABLE IF EXISTS %s.%s.%s\", CATALOG, SCHEMA, TABLE_RENAMED));\n+        File tempDir = Files.createTempDirectory(\"test_iceberg_v2\").toFile();\n+        metastoreDir = new File(tempDir, \"iceberg_data\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTE3Nzc0Nw==", "bodyText": "use default\nnew IcebergConfig().getFileFormat()", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r679177747", "createdAt": "2021-07-29T13:59:04Z", "author": {"login": "findepi"}, "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/TestIcebergTableWithCustomLocation.java", "diffHunk": "@@ -52,125 +43,91 @@\n         extends AbstractTestQueryFramework\n {\n     private FileHiveMetastore metastore;\n-\n-    private static final String CATALOG = \"iceberg\";\n-    private static final String SCHEMA = \"iceberg_schema\";\n-    private static final String TABLE = \"iceberg_table\";\n-    private static final String TABLE_RENAMED = \"iceberg_table_renamed\";\n+    private File metastoreDir;\n \n     @Override\n     protected DistributedQueryRunner createQueryRunner()\n             throws Exception\n     {\n-        Session session = testSessionBuilder()\n-                .setIdentity(Identity.forUser(\"hive\")\n-                        .withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\")))\n-                        .build())\n-                .build();\n-        DistributedQueryRunner queryRunner = DistributedQueryRunner.builder(session).build();\n-\n-        File baseDir = queryRunner.getCoordinator().getBaseDataDir().resolve(\"iceberg_data\").toFile();\n-\n-        HdfsConfig hdfsConfig = new HdfsConfig();\n-        HdfsConfiguration hdfsConfiguration = new HiveHdfsConfiguration(new HdfsConfigurationInitializer(hdfsConfig), ImmutableSet.of());\n-        HdfsEnvironment hdfsEnvironment = new HdfsEnvironment(hdfsConfiguration, hdfsConfig, new NoHdfsAuthentication());\n-\n-        metastore = new FileHiveMetastore(\n-                new NodeVersion(\"test_version\"),\n-                hdfsEnvironment,\n-                new MetastoreConfig(),\n-                new FileHiveMetastoreConfig()\n-                        .setCatalogDirectory(baseDir.toURI().toString())\n-                        .setMetastoreUser(\"test\"));\n-\n-        TestingIcebergPlugin icebergPlugin = new TestingIcebergPlugin(metastore, false);\n-\n-        queryRunner.installPlugin(icebergPlugin);\n-        queryRunner.createCatalog(CATALOG, \"iceberg\", ImmutableMap.of(\"iceberg.unique-table-location\", \"true\"));\n-        queryRunner.installPlugin(new TestingHivePlugin(metastore));\n-        queryRunner.createCatalog(\"hive\", \"hive\", ImmutableMap.of(\"hive.security\", \"sql-standard\"));\n-        return queryRunner;\n-    }\n-\n-    @BeforeClass\n-    public void setUp()\n-    {\n-        assertQuerySucceeds(format(\"CREATE SCHEMA %s.%s\", CATALOG, SCHEMA));\n-    }\n-\n-    @AfterMethod\n-    public void clean()\n-    {\n-        query(format(\"DROP TABLE IF EXISTS %s.%s.%s\", CATALOG, SCHEMA, TABLE));\n-        query(format(\"DROP TABLE IF EXISTS %s.%s.%s\", CATALOG, SCHEMA, TABLE_RENAMED));\n+        File tempDir = Files.createTempDirectory(\"test_iceberg_v2\").toFile();\n+        metastoreDir = new File(tempDir, \"iceberg_data\");\n+        metastore = createTestingFileHiveMetastore(metastoreDir);\n+\n+        return createIcebergQueryRunner(\n+                ImmutableMap.of(),\n+                ORC,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTE3ODM3Ng==", "bodyText": "as a follow up we should remove format parameter and use the new connectorProperties instead", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r679178376", "createdAt": "2021-07-29T13:59:47Z", "author": {"login": "findepi"}, "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/TestIcebergTableWithCustomLocation.java", "diffHunk": "@@ -52,125 +43,91 @@\n         extends AbstractTestQueryFramework\n {\n     private FileHiveMetastore metastore;\n-\n-    private static final String CATALOG = \"iceberg\";\n-    private static final String SCHEMA = \"iceberg_schema\";\n-    private static final String TABLE = \"iceberg_table\";\n-    private static final String TABLE_RENAMED = \"iceberg_table_renamed\";\n+    private File metastoreDir;\n \n     @Override\n     protected DistributedQueryRunner createQueryRunner()\n             throws Exception\n     {\n-        Session session = testSessionBuilder()\n-                .setIdentity(Identity.forUser(\"hive\")\n-                        .withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\")))\n-                        .build())\n-                .build();\n-        DistributedQueryRunner queryRunner = DistributedQueryRunner.builder(session).build();\n-\n-        File baseDir = queryRunner.getCoordinator().getBaseDataDir().resolve(\"iceberg_data\").toFile();\n-\n-        HdfsConfig hdfsConfig = new HdfsConfig();\n-        HdfsConfiguration hdfsConfiguration = new HiveHdfsConfiguration(new HdfsConfigurationInitializer(hdfsConfig), ImmutableSet.of());\n-        HdfsEnvironment hdfsEnvironment = new HdfsEnvironment(hdfsConfiguration, hdfsConfig, new NoHdfsAuthentication());\n-\n-        metastore = new FileHiveMetastore(\n-                new NodeVersion(\"test_version\"),\n-                hdfsEnvironment,\n-                new MetastoreConfig(),\n-                new FileHiveMetastoreConfig()\n-                        .setCatalogDirectory(baseDir.toURI().toString())\n-                        .setMetastoreUser(\"test\"));\n-\n-        TestingIcebergPlugin icebergPlugin = new TestingIcebergPlugin(metastore, false);\n-\n-        queryRunner.installPlugin(icebergPlugin);\n-        queryRunner.createCatalog(CATALOG, \"iceberg\", ImmutableMap.of(\"iceberg.unique-table-location\", \"true\"));\n-        queryRunner.installPlugin(new TestingHivePlugin(metastore));\n-        queryRunner.createCatalog(\"hive\", \"hive\", ImmutableMap.of(\"hive.security\", \"sql-standard\"));\n-        return queryRunner;\n-    }\n-\n-    @BeforeClass\n-    public void setUp()\n-    {\n-        assertQuerySucceeds(format(\"CREATE SCHEMA %s.%s\", CATALOG, SCHEMA));\n-    }\n-\n-    @AfterMethod\n-    public void clean()\n-    {\n-        query(format(\"DROP TABLE IF EXISTS %s.%s.%s\", CATALOG, SCHEMA, TABLE));\n-        query(format(\"DROP TABLE IF EXISTS %s.%s.%s\", CATALOG, SCHEMA, TABLE_RENAMED));\n+        File tempDir = Files.createTempDirectory(\"test_iceberg_v2\").toFile();\n+        metastoreDir = new File(tempDir, \"iceberg_data\");\n+        metastore = createTestingFileHiveMetastore(metastoreDir);\n+\n+        return createIcebergQueryRunner(\n+                ImmutableMap.of(),\n+                ORC,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTE3Nzc0Nw=="}, "originalCommit": null, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTE3OTM3Mw==", "bodyText": "Do not use assertTrue with complex expressions. In case of failure, it produces unhelpful message.\nUse\n[org.assertj.core.api.Assertions.] assertThat(location).matches(....);\n\ninstead", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r679179373", "createdAt": "2021-07-29T14:00:57Z", "author": {"login": "findepi"}, "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/TestIcebergTableWithCustomLocation.java", "diffHunk": "@@ -52,125 +43,91 @@\n         extends AbstractTestQueryFramework\n {\n     private FileHiveMetastore metastore;\n-\n-    private static final String CATALOG = \"iceberg\";\n-    private static final String SCHEMA = \"iceberg_schema\";\n-    private static final String TABLE = \"iceberg_table\";\n-    private static final String TABLE_RENAMED = \"iceberg_table_renamed\";\n+    private File metastoreDir;\n \n     @Override\n     protected DistributedQueryRunner createQueryRunner()\n             throws Exception\n     {\n-        Session session = testSessionBuilder()\n-                .setIdentity(Identity.forUser(\"hive\")\n-                        .withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\")))\n-                        .build())\n-                .build();\n-        DistributedQueryRunner queryRunner = DistributedQueryRunner.builder(session).build();\n-\n-        File baseDir = queryRunner.getCoordinator().getBaseDataDir().resolve(\"iceberg_data\").toFile();\n-\n-        HdfsConfig hdfsConfig = new HdfsConfig();\n-        HdfsConfiguration hdfsConfiguration = new HiveHdfsConfiguration(new HdfsConfigurationInitializer(hdfsConfig), ImmutableSet.of());\n-        HdfsEnvironment hdfsEnvironment = new HdfsEnvironment(hdfsConfiguration, hdfsConfig, new NoHdfsAuthentication());\n-\n-        metastore = new FileHiveMetastore(\n-                new NodeVersion(\"test_version\"),\n-                hdfsEnvironment,\n-                new MetastoreConfig(),\n-                new FileHiveMetastoreConfig()\n-                        .setCatalogDirectory(baseDir.toURI().toString())\n-                        .setMetastoreUser(\"test\"));\n-\n-        TestingIcebergPlugin icebergPlugin = new TestingIcebergPlugin(metastore, false);\n-\n-        queryRunner.installPlugin(icebergPlugin);\n-        queryRunner.createCatalog(CATALOG, \"iceberg\", ImmutableMap.of(\"iceberg.unique-table-location\", \"true\"));\n-        queryRunner.installPlugin(new TestingHivePlugin(metastore));\n-        queryRunner.createCatalog(\"hive\", \"hive\", ImmutableMap.of(\"hive.security\", \"sql-standard\"));\n-        return queryRunner;\n-    }\n-\n-    @BeforeClass\n-    public void setUp()\n-    {\n-        assertQuerySucceeds(format(\"CREATE SCHEMA %s.%s\", CATALOG, SCHEMA));\n-    }\n-\n-    @AfterMethod\n-    public void clean()\n-    {\n-        query(format(\"DROP TABLE IF EXISTS %s.%s.%s\", CATALOG, SCHEMA, TABLE));\n-        query(format(\"DROP TABLE IF EXISTS %s.%s.%s\", CATALOG, SCHEMA, TABLE_RENAMED));\n+        File tempDir = Files.createTempDirectory(\"test_iceberg_v2\").toFile();\n+        metastoreDir = new File(tempDir, \"iceberg_data\");\n+        metastore = createTestingFileHiveMetastore(metastoreDir);\n+\n+        return createIcebergQueryRunner(\n+                ImmutableMap.of(),\n+                ORC,\n+                ImmutableList.of(NATION),\n+                Optional.of(metastoreDir),\n+                Optional.of(ImmutableMap.of(\"iceberg.unique-table-location\", \"true\")));\n     }\n \n     @AfterClass(alwaysRun = true)\n-    public void tearDown()\n+    public void tearDown() throws IOException\n     {\n-        query(format(\"DROP SCHEMA %s.%s\", CATALOG, SCHEMA));\n+        deleteRecursively(metastoreDir.getParentFile().toPath(), ALLOW_INSECURE);\n     }\n \n     @Test\n     public void testTableHasUuidSuffixInLocation()\n     {\n-        assertQuerySucceeds(format(\"CREATE TABLE %s.%s.%s as select 1 as val\", CATALOG, SCHEMA, TABLE));\n-        Optional<Table> table = metastore.getTable(null, SCHEMA, TABLE);\n+        assertQuerySucceeds(\"CREATE TABLE table_with_uuid as select 1 as val\");\n+        Optional<Table> table = metastore.getTable(null, \"tpch\", \"table_with_uuid\");\n         assertTrue(table.isPresent(), \"Table should exists\");\n         String location = table.get().getStorage().getLocation();\n-        assertTrue(location.matches(format(\".*%s-[0-9a-f]{32}\", TABLE)), \"Table location should have UUID suffix\");\n+        assertTrue(location.matches(format(\".*%s-[0-9a-f]{32}\", \"table_with_uuid\")), \"Table location should have UUID suffix\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTE4MjQ4OA==", "bodyText": "however, it seems the test doesn't need to know the metastoreDir, so instead of setting it up (and cleaning it later), it should be sufficient to pass Optional.empty() for the metastoreDir, right?", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r679182488", "createdAt": "2021-07-29T14:04:32Z", "author": {"login": "findepi"}, "path": "plugin/trino-iceberg/src/test/java/io/trino/plugin/iceberg/TestIcebergTableWithCustomLocation.java", "diffHunk": "@@ -52,125 +43,91 @@\n         extends AbstractTestQueryFramework\n {\n     private FileHiveMetastore metastore;\n-\n-    private static final String CATALOG = \"iceberg\";\n-    private static final String SCHEMA = \"iceberg_schema\";\n-    private static final String TABLE = \"iceberg_table\";\n-    private static final String TABLE_RENAMED = \"iceberg_table_renamed\";\n+    private File metastoreDir;\n \n     @Override\n     protected DistributedQueryRunner createQueryRunner()\n             throws Exception\n     {\n-        Session session = testSessionBuilder()\n-                .setIdentity(Identity.forUser(\"hive\")\n-                        .withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\")))\n-                        .build())\n-                .build();\n-        DistributedQueryRunner queryRunner = DistributedQueryRunner.builder(session).build();\n-\n-        File baseDir = queryRunner.getCoordinator().getBaseDataDir().resolve(\"iceberg_data\").toFile();\n-\n-        HdfsConfig hdfsConfig = new HdfsConfig();\n-        HdfsConfiguration hdfsConfiguration = new HiveHdfsConfiguration(new HdfsConfigurationInitializer(hdfsConfig), ImmutableSet.of());\n-        HdfsEnvironment hdfsEnvironment = new HdfsEnvironment(hdfsConfiguration, hdfsConfig, new NoHdfsAuthentication());\n-\n-        metastore = new FileHiveMetastore(\n-                new NodeVersion(\"test_version\"),\n-                hdfsEnvironment,\n-                new MetastoreConfig(),\n-                new FileHiveMetastoreConfig()\n-                        .setCatalogDirectory(baseDir.toURI().toString())\n-                        .setMetastoreUser(\"test\"));\n-\n-        TestingIcebergPlugin icebergPlugin = new TestingIcebergPlugin(metastore, false);\n-\n-        queryRunner.installPlugin(icebergPlugin);\n-        queryRunner.createCatalog(CATALOG, \"iceberg\", ImmutableMap.of(\"iceberg.unique-table-location\", \"true\"));\n-        queryRunner.installPlugin(new TestingHivePlugin(metastore));\n-        queryRunner.createCatalog(\"hive\", \"hive\", ImmutableMap.of(\"hive.security\", \"sql-standard\"));\n-        return queryRunner;\n-    }\n-\n-    @BeforeClass\n-    public void setUp()\n-    {\n-        assertQuerySucceeds(format(\"CREATE SCHEMA %s.%s\", CATALOG, SCHEMA));\n-    }\n-\n-    @AfterMethod\n-    public void clean()\n-    {\n-        query(format(\"DROP TABLE IF EXISTS %s.%s.%s\", CATALOG, SCHEMA, TABLE));\n-        query(format(\"DROP TABLE IF EXISTS %s.%s.%s\", CATALOG, SCHEMA, TABLE_RENAMED));\n+        File tempDir = Files.createTempDirectory(\"test_iceberg_v2\").toFile();\n+        metastoreDir = new File(tempDir, \"iceberg_data\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTE3NzQyNw=="}, "originalCommit": null, "originalPosition": 103}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a30f7939798f0263cf2594cfa9f39f238afb456", "author": {"user": {"login": "sshkvar", "name": null}}, "url": "https://github.com/trinodb/trino/commit/0a30f7939798f0263cf2594cfa9f39f238afb456", "committedDate": "2021-08-03T12:08:57Z", "message": "rebase: Added ability to have unique table location for each iceberg table"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "0a30f7939798f0263cf2594cfa9f39f238afb456", "author": {"user": {"login": "sshkvar", "name": null}}, "url": "https://github.com/trinodb/trino/commit/0a30f7939798f0263cf2594cfa9f39f238afb456", "committedDate": "2021-08-03T12:08:57Z", "message": "rebase: Added ability to have unique table location for each iceberg table"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzIxMTI1MDI3", "url": "https://github.com/trinodb/trino/pull/6063#pullrequestreview-721125027", "createdAt": "2021-08-03T12:18:13Z", "commit": {"oid": "0a30f7939798f0263cf2594cfa9f39f238afb456"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2266, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}