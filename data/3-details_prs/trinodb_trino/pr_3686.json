{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NjA3OTU5", "number": 3686, "title": "Add Remote exchange forcefully if aggregation has empty grouping set", "bodyText": "Fixes #3154, fixes #2716", "createdAt": "2020-05-09T17:47:53Z", "url": "https://github.com/trinodb/trino/pull/3686", "merged": true, "mergeCommit": {"oid": "71dad31ea9bc6693088b9f50d451ec382ee3fbbb"}, "closed": true, "closedAt": "2020-05-15T13:45:09Z", "author": {"login": "Praveen2112"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfuB3GAFqTQwODY4ODE2MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABchenD6ABqjMzNDAxMTI2NzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4Njg4MTYx", "url": "https://github.com/trinodb/trino/pull/3686#pullrequestreview-408688161", "createdAt": "2020-05-09T22:15:24Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4Njg4NzI3", "url": "https://github.com/trinodb/trino/pull/3686#pullrequestreview-408688727", "createdAt": "2020-05-09T22:25:50Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQyMjoyNTo1MVrOGS-pKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQyMjoyNTo1MVrOGS-pKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1Mzg5Nw==", "bodyText": "should this be applied when child.getProperties().isNodePartitionedOn(partitioningRequirement) && node.hasEmptyGroupingSet()?", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r422553897", "createdAt": "2020-05-09T22:25:51Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/optimizations/AddExchanges.java", "diffHunk": "@@ -227,7 +227,8 @@ public PlanWithProperties visitAggregation(AggregationNode node, PreferredProper\n                         gatheringExchange(idAllocator.getNextId(), REMOTE, child.getNode()),\n                         child.getProperties());\n             }\n-            else if (!child.getProperties().isStreamPartitionedOn(partitioningRequirement) && !child.getProperties().isNodePartitionedOn(partitioningRequirement)) {\n+            else if ((!child.getProperties().isStreamPartitionedOn(partitioningRequirement) && !child.getProperties().isNodePartitionedOn(partitioningRequirement)) ||\n+                    node.hasEmptyGroupingSet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MDI3MTM3", "url": "https://github.com/trinodb/trino/pull/3686#pullrequestreview-409027137", "createdAt": "2020-05-11T09:54:53Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExODEwMzAz", "url": "https://github.com/trinodb/trino/pull/3686#pullrequestreview-411810303", "createdAt": "2020-05-14T13:36:14Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMzozNjoxNFrOGVcl2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMzozNjoxNFrOGVcl2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE0MTcyMQ==", "bodyText": "each arg in newline", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r425141721", "createdAt": "2020-05-14T13:36:14Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestLogicalPlanner.java", "diffHunk": "@@ -1377,6 +1377,25 @@ public void testRemoveRedundantRightJoin()\n                         values(ImmutableList.of(\"regionkey\"))));\n     }\n \n+    @Test\n+    public void testGroupingSetsWithDefaultValue()\n+    {\n+        assertDistributedPlan(\"SELECT orderkey, COUNT(DISTINCT k) FROM (SELECT orderkey, 1 k FROM orders) GROUP BY GROUPING SETS ((), orderkey)\",\n+                output(\n+                        anyTree(\n+                                aggregation(\n+                                        ImmutableMap.of(\"final_count\", functionCall(\"count\", ImmutableList.of(\"partial_count\"))),\n+                                        FINAL,\n+                                        exchange(LOCAL, REPARTITION,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMjAzOTMy", "url": "https://github.com/trinodb/trino/pull/3686#pullrequestreview-412203932", "createdAt": "2020-05-14T21:38:01Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMTozODowMVrOGVvJ6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMTozODowMVrOGVvJ6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ0NTg2Nw==", "bodyText": "this should go to AbstractTestAggregations", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r425445867", "createdAt": "2020-05-14T21:38:01Z", "author": {"login": "sopel39"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueries.java", "diffHunk": "@@ -1924,4 +1924,12 @@ public void testSubqueriesWithDisjunction()\n                         \"LIMIT 2\",\n                 \"VALUES true, null\");\n     }\n+\n+    @Test\n+    public void testGroupingSetsWithDefaultValue() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "5436a047f012b287e38660164fbebffad60f7a5e", "author": {"user": {"login": "Praveen2112", "name": "Praveen Krishna"}}, "url": "https://github.com/trinodb/trino/commit/5436a047f012b287e38660164fbebffad60f7a5e", "committedDate": "2020-05-15T09:25:02Z", "message": "Add Remote exchange forcefully if aggregation has empty grouping set"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "5436a047f012b287e38660164fbebffad60f7a5e", "author": {"user": {"login": "Praveen2112", "name": "Praveen Krishna"}}, "url": "https://github.com/trinodb/trino/commit/5436a047f012b287e38660164fbebffad60f7a5e", "committedDate": "2020-05-15T09:25:02Z", "message": "Add Remote exchange forcefully if aggregation has empty grouping set"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1446, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}