{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MTkyMjg0", "number": 4158, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMTo0NjozMFrOEHvZuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMzo0OTowOVrOEIK8fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2NTUyMTIxOnYy", "diffSide": "RIGHT", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergPageSource.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMTo0NjozMFrOGnSHLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMzoyMToyOVrOGn90pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg0NDM5Ng==", "bodyText": "We should consider adding support for variable-precision timestamps (or, at least, expose this as timestamp(6), since we're dealing with microseconds)", "url": "https://github.com/trinodb/trino/pull/4158#discussion_r443844396", "createdAt": "2020-06-22T21:46:30Z", "author": {"login": "martint"}, "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergPageSource.java", "diffHunk": "@@ -215,7 +216,7 @@ private static Object deserializePartitionValue(Type type, String valueString, S\n                 return parseLong(valueString);\n             }\n             if (type.equals(TIMESTAMP)) {\n-                return parseLong(valueString);\n+                return MICROSECONDS.toMillis(parseLong(valueString));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b92a49514a5f450fe06369bb0ecca7c94a900f5"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg3NDAxOA==", "bodyText": "I'll consult with @electrum as to how to get this done.", "url": "https://github.com/trinodb/trino/pull/4158#discussion_r443874018", "createdAt": "2020-06-22T23:12:18Z", "author": {"login": "djsstarburst"}, "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergPageSource.java", "diffHunk": "@@ -215,7 +216,7 @@ private static Object deserializePartitionValue(Type type, String valueString, S\n                 return parseLong(valueString);\n             }\n             if (type.equals(TIMESTAMP)) {\n-                return parseLong(valueString);\n+                return MICROSECONDS.toMillis(parseLong(valueString));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg0NDM5Ng=="}, "originalCommit": {"oid": "6b92a49514a5f450fe06369bb0ecca7c94a900f5"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2MDU0OQ==", "bodyText": "Agreed. This should should simplify the various TupleDomain and value conversions, but will require support in the readers and writers for ORC and Parquet, so it's not a trivial project.", "url": "https://github.com/trinodb/trino/pull/4158#discussion_r444560549", "createdAt": "2020-06-23T23:21:29Z", "author": {"login": "electrum"}, "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergPageSource.java", "diffHunk": "@@ -215,7 +216,7 @@ private static Object deserializePartitionValue(Type type, String valueString, S\n                 return parseLong(valueString);\n             }\n             if (type.equals(TIMESTAMP)) {\n-                return parseLong(valueString);\n+                return MICROSECONDS.toMillis(parseLong(valueString));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg0NDM5Ng=="}, "originalCommit": {"oid": "6b92a49514a5f450fe06369bb0ecca7c94a900f5"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDAzMzkwOnYy", "diffSide": "LEFT", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/ExpressionConverter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMzo0OTowOVrOGn-TmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMTowODo1OVrOGn_kbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2ODQ3Mw==", "bodyText": "I just realized that this code is actually correct. The problem is that we aren't doing any conversion between millis and micros when reading and writing the data files. With the removal of this conversion code, we are now pushing a millis value into the Iceberg predicate code, which works because the files are written with a millis value.\nSo it works from a round trip perspective, but it's not valid from an Iceberg format perspective. This is where having integration tests against Spark, or read/write directly with the Iceberg library, would be helpful.", "url": "https://github.com/trinodb/trino/pull/4158#discussion_r444568473", "createdAt": "2020-06-23T23:49:09Z", "author": {"login": "electrum"}, "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/ExpressionConverter.java", "diffHunk": "@@ -168,14 +162,6 @@ else if (highBound == BELOW && high.getValueBlock().isPresent()) {\n \n     private static Object getValue(Type type, Marker marker, ConnectorSession session)\n     {\n-        if (type instanceof TimestampWithTimeZoneType || type instanceof TimeWithTimeZoneType) {\n-            return MILLISECONDS.toMicros(unpackMillisUtc((Long) marker.getValue()));\n-        }\n-\n-        if (type instanceof TimestampType || type instanceof TimeType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b92a49514a5f450fe06369bb0ecca7c94a900f5"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4OTE2NQ==", "bodyText": "Nevermind, as @lxynov pointed out, ORC supports timestamps natively, so we're reading and writing them correctly.", "url": "https://github.com/trinodb/trino/pull/4158#discussion_r444589165", "createdAt": "2020-06-24T01:08:59Z", "author": {"login": "electrum"}, "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/ExpressionConverter.java", "diffHunk": "@@ -168,14 +162,6 @@ else if (highBound == BELOW && high.getValueBlock().isPresent()) {\n \n     private static Object getValue(Type type, Marker marker, ConnectorSession session)\n     {\n-        if (type instanceof TimestampWithTimeZoneType || type instanceof TimeWithTimeZoneType) {\n-            return MILLISECONDS.toMicros(unpackMillisUtc((Long) marker.getValue()));\n-        }\n-\n-        if (type instanceof TimestampType || type instanceof TimeType) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2ODQ3Mw=="}, "originalCommit": {"oid": "6b92a49514a5f450fe06369bb0ecca7c94a900f5"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3902, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}