{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzNDUyMzIw", "number": 3433, "title": "Add fixed, cert, jwt and kerberos UI authentication", "bodyText": "", "createdAt": "2020-04-14T22:52:42Z", "url": "https://github.com/trinodb/trino/pull/3433", "merged": true, "mergeCommit": {"oid": "ae6efb89b52ba5d80f1bb9171a987dd665f72394"}, "closed": true, "closedAt": "2020-05-07T21:52:21Z", "author": {"login": "dain"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcX9jO7ABqjMyMzcwMjkxMjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfDEn7ABqjMzMTQ0ODcxNjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0Mzk1NjMx", "url": "https://github.com/trinodb/trino/pull/3433#pullrequestreview-404395631", "createdAt": "2020-05-01T20:54:02Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQyMDo1NDowM1rOGPVd-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQyMToxMTo1NVrOGPV27Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczMzU2MA==", "bodyText": "Consider making this non-static with delegation to isSecure, as that keeps the method invocations simpler.", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418733560", "createdAt": "2020-05-01T20:54:03Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/server/ui/FormWebUiAuthenticationManager.java", "diffHunk": "@@ -328,14 +336,9 @@ static String getRedirectLocation(HttpServletRequest request, String path, Strin\n         return builder.toString();\n     }\n \n-    private static boolean isHttps(HttpServletRequest request)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczNjI5Ng==", "bodyText": "Why take the first one? What if none of them match a web UI authenticator type?", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418736296", "createdAt": "2020-05-01T21:01:36Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/server/ui/WebUiAuthenticationModule.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.server.ui;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import io.airlift.configuration.AbstractConfigurationAwareModule;\n+import io.prestosql.server.security.SecurityConfig;\n+\n+import java.util.List;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.airlift.configuration.ConfigBinder.configBinder;\n+import static java.util.Locale.ENGLISH;\n+import static java.util.Objects.requireNonNull;\n+\n+public class WebUiAuthenticationModule\n+        extends AbstractConfigurationAwareModule\n+{\n+    @Override\n+    protected void setup(Binder binder)\n+    {\n+        configBinder(binder).bindConfig(WebUiAuthenticationConfig.class);\n+\n+        installWebUiAuthenticator(\"form\", new FormUiAuthenticatorModule());\n+    }\n+\n+    private void installWebUiAuthenticator(String type, Module module)\n+    {\n+        install(webUiAuthenticator(type, module));\n+    }\n+\n+    public static Module webUiAuthenticator(String type, Module module)\n+    {\n+        return new ConditionalWebUiAuthenticationModule(type, module);\n+    }\n+\n+    private static class ConditionalWebUiAuthenticationModule\n+            extends AbstractConfigurationAwareModule\n+    {\n+        private final String type;\n+        private final Module module;\n+\n+        public ConditionalWebUiAuthenticationModule(String type, Module module)\n+        {\n+            this.type = requireNonNull(type, \"type is null\");\n+            this.module = requireNonNull(module, \"module is null\");\n+        }\n+\n+        @Override\n+        protected void setup(Binder binder)\n+        {\n+            if (type.equals(getAuthenticationType())) {\n+                install(module);\n+            }\n+        }\n+\n+        private String getAuthenticationType()\n+        {\n+            String authentication = buildConfigObject(WebUiAuthenticationConfig.class).getAuthentication();\n+            if (authentication != null) {\n+                return authentication;\n+            }\n+\n+            List<String> authenticationTypes = buildConfigObject(SecurityConfig.class).getAuthenticationTypes().stream()\n+                    .map(type -> type.toLowerCase(ENGLISH))\n+                    .collect(toImmutableList());\n+            if (authenticationTypes.contains(\"password\")) {\n+                return \"form\";\n+            }\n+            return authenticationTypes.stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczNjkyNw==", "bodyText": "Nit: normally \"username\" is one word", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418736927", "createdAt": "2020-05-01T21:03:25Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/server/ui/FixedUserWebUIConfig.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.server.ui;\n+\n+import io.airlift.configuration.Config;\n+\n+import javax.validation.constraints.NotNull;\n+\n+public class FixedUserWebUIConfig\n+{\n+    private String userName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczNzIzMA==", "bodyText": "Fix case of Ui -> FixedUserWebUiConfig", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418737230", "createdAt": "2020-05-01T21:04:11Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/server/ui/FixedUserWebUIConfig.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.server.ui;\n+\n+import io.airlift.configuration.Config;\n+\n+import javax.validation.constraints.NotNull;\n+\n+public class FixedUserWebUIConfig", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczNzQyNw==", "bodyText": "Check for null", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418737427", "createdAt": "2020-05-01T21:04:41Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/server/ui/FixedUserWebUiAuthenticationManager.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.server.ui;\n+\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.Identity;\n+\n+import javax.inject.Inject;\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+import java.io.IOException;\n+\n+import static io.prestosql.server.ServletSecurityUtils.withAuthenticatedIdentity;\n+import static io.prestosql.server.ui.FormWebUiAuthenticationManager.redirectAllFormLoginToUi;\n+import static java.util.Objects.requireNonNull;\n+\n+public class FixedUserWebUiAuthenticationManager\n+        implements WebUiAuthenticationManager\n+{\n+    private final Identity webUiIdentity;\n+\n+    @Inject\n+    public FixedUserWebUiAuthenticationManager(FixedUserWebUIConfig config)\n+    {\n+        this(basicIdentity(requireNonNull(config, \"config is null\").getUserName()));\n+    }\n+\n+    public FixedUserWebUiAuthenticationManager(Identity webUiIdentity)\n+    {\n+        this.webUiIdentity = webUiIdentity;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczNzU5Ng==", "bodyText": "TestFixedUserWebUIConfig -> TestFixedUserWebUiConfig", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418737596", "createdAt": "2020-05-01T21:05:11Z", "author": {"login": "electrum"}, "path": "presto-main/src/test/java/io/prestosql/server/ui/TestFixedUserWebUIConfig.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.server.ui;\n+\n+import com.google.common.collect.ImmutableMap;\n+import org.testng.annotations.Test;\n+\n+import java.util.Map;\n+\n+import static io.airlift.configuration.testing.ConfigAssertions.assertFullMapping;\n+import static io.airlift.configuration.testing.ConfigAssertions.assertRecordedDefaults;\n+import static io.airlift.configuration.testing.ConfigAssertions.recordDefaults;\n+\n+public class TestFixedUserWebUIConfig", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczODUwMw==", "bodyText": "If you pass authenticator to this method, then you can call authenticator.get() above, inside the if (authenticator.isPresent()) guard.", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418738503", "createdAt": "2020-05-01T21:07:46Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/server/ui/FormWebUiAuthenticationManager.java", "diffHunk": "@@ -179,7 +192,48 @@ private static String encodeCurrentLocationForLoginRedirect(HttpServletRequest r\n         return path;\n     }\n \n-    private void handleLoginRequest(HttpServletRequest request, HttpServletResponse response)\n+    private void handleProtocolLoginRequest(HttpServletRequest request, HttpServletResponse response, FilterChain nextFilter)\n+            throws IOException, ServletException\n+    {\n+        Authenticator authenticator = this.authenticator.orElseThrow(() -> new IllegalStateException(\"Authenticator is not present\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczODc5NQ==", "bodyText": "String message = firstNonNull(e.getMessage(), \"Unauthorized\");", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418738795", "createdAt": "2020-05-01T21:08:40Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/server/ui/FormWebUiAuthenticationManager.java", "diffHunk": "@@ -179,7 +192,48 @@ private static String encodeCurrentLocationForLoginRedirect(HttpServletRequest r\n         return path;\n     }\n \n-    private void handleLoginRequest(HttpServletRequest request, HttpServletResponse response)\n+    private void handleProtocolLoginRequest(HttpServletRequest request, HttpServletResponse response, FilterChain nextFilter)\n+            throws IOException, ServletException\n+    {\n+        Authenticator authenticator = this.authenticator.orElseThrow(() -> new IllegalStateException(\"Authenticator is not present\"));\n+\n+        Identity authenticatedIdentity;\n+        try {\n+            authenticatedIdentity = authenticator.authenticate(request);\n+        }\n+        catch (AuthenticationException e) {\n+            // authentication failed\n+            ServletSecurityUtils.skipRequestBody(request);\n+\n+            e.getAuthenticateHeader().ifPresent(value -> response.addHeader(WWW_AUTHENTICATE, value));\n+\n+            String message = e.getMessage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczOTEyMQ==", "bodyText": "typo \"ot\" -> \"to\"", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418739121", "createdAt": "2020-05-01T21:09:32Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/server/ui/FormWebUiAuthenticationManager.java", "diffHunk": "@@ -179,7 +192,48 @@ private static String encodeCurrentLocationForLoginRedirect(HttpServletRequest r\n         return path;\n     }\n \n-    private void handleLoginRequest(HttpServletRequest request, HttpServletResponse response)\n+    private void handleProtocolLoginRequest(HttpServletRequest request, HttpServletResponse response, FilterChain nextFilter)\n+            throws IOException, ServletException\n+    {\n+        Authenticator authenticator = this.authenticator.orElseThrow(() -> new IllegalStateException(\"Authenticator is not present\"));\n+\n+        Identity authenticatedIdentity;\n+        try {\n+            authenticatedIdentity = authenticator.authenticate(request);\n+        }\n+        catch (AuthenticationException e) {\n+            // authentication failed\n+            ServletSecurityUtils.skipRequestBody(request);\n+\n+            e.getAuthenticateHeader().ifPresent(value -> response.addHeader(WWW_AUTHENTICATE, value));\n+\n+            String message = e.getMessage();\n+            if (message == null) {\n+                message = \"Unauthorized\";\n+            }\n+\n+            ServletSecurityUtils.sendErrorMessage(response, SC_UNAUTHORIZED, message);\n+            return;\n+        }\n+\n+        if (redirectFormLoginToUi(request, response)) {\n+            return;\n+        }\n+\n+        ServletSecurityUtils.withAuthenticatedIdentity(nextFilter, request, response, authenticatedIdentity);\n+    }\n+\n+    public static boolean redirectFormLoginToUi(HttpServletRequest request, HttpServletResponse response)\n+    {\n+        // these paths should never be used with a protocol login, but the user might have this cached or linked, so redirect back ot the main UI page.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczOTk0OQ==", "bodyText": "Why is the first one !isSecure()?", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418739949", "createdAt": "2020-05-01T21:11:55Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/server/ui/FormWebUiAuthenticationManager.java", "diffHunk": "@@ -338,7 +392,7 @@ static String getRedirectLocation(HttpServletRequest request, String path, Strin\n \n     private boolean isAuthenticationEnabled(HttpServletRequest request)\n     {\n-        return !isSecure(request, httpsForwardingEnabled) || passwordAuthenticatorManager.isLoaded();\n+        return !isSecure(request, httpsForwardingEnabled) || passwordAuthenticatorManager.isLoaded() || authenticator.isPresent();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NTY3Mjk2", "url": "https://github.com/trinodb/trino/pull/3433#pullrequestreview-405567296", "createdAt": "2020-05-05T07:59:16Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a03cb01ac93300b2977e12cc90040a030dcd1a0", "author": {"user": {"login": "dain", "name": "Dain Sundstrom"}}, "url": "https://github.com/trinodb/trino/commit/4a03cb01ac93300b2977e12cc90040a030dcd1a0", "committedDate": "2020-05-07T18:08:00Z", "message": "MoveWebUiModule to UI package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ed105f2645889c4b4d21925d299f476a4f5bf36", "author": {"user": {"login": "dain", "name": "Dain Sundstrom"}}, "url": "https://github.com/trinodb/trino/commit/5ed105f2645889c4b4d21925d299f476a4f5bf36", "committedDate": "2020-05-07T18:08:00Z", "message": "Add utility for servlet security handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ba0cfe3bc732014cbacbf5e215e997bf299b741", "author": {"user": {"login": "dain", "name": "Dain Sundstrom"}}, "url": "https://github.com/trinodb/trino/commit/5ba0cfe3bc732014cbacbf5e215e997bf299b741", "committedDate": "2020-05-07T18:08:00Z", "message": "Support forwarded https in web ui authentication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e98265d369af83f6bd5b1f2a9fe9412892abd3a4", "author": {"user": {"login": "dain", "name": "Dain Sundstrom"}}, "url": "https://github.com/trinodb/trino/commit/e98265d369af83f6bd5b1f2a9fe9412892abd3a4", "committedDate": "2020-05-07T20:00:56Z", "message": "Add extensible web ui authentication bindings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bed715e924244d886e5c522eece66f766f3067fe", "author": {"user": {"login": "dain", "name": "Dain Sundstrom"}}, "url": "https://github.com/trinodb/trino/commit/bed715e924244d886e5c522eece66f766f3067fe", "committedDate": "2020-05-07T20:00:57Z", "message": "Add fixed user web ui authenticator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5255c326f48ce0ea2457b98d18bbcfeaae5fffa", "author": {"user": {"login": "dain", "name": "Dain Sundstrom"}}, "url": "https://github.com/trinodb/trino/commit/c5255c326f48ce0ea2457b98d18bbcfeaae5fffa", "committedDate": "2020-05-07T20:07:29Z", "message": "Add HTTP protocol based authenticators to web ui\n\nAdd support for certificate, JWT and Kerberos authentication"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "c5255c326f48ce0ea2457b98d18bbcfeaae5fffa", "author": {"user": {"login": "dain", "name": "Dain Sundstrom"}}, "url": "https://github.com/trinodb/trino/commit/c5255c326f48ce0ea2457b98d18bbcfeaae5fffa", "committedDate": "2020-05-07T20:07:29Z", "message": "Add HTTP protocol based authenticators to web ui\n\nAdd support for certificate, JWT and Kerberos authentication"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1512, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}