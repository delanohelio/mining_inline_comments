{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0NDQ3NzI1", "number": 4995, "title": "Create temporary tables in mysql without key constraints", "bodyText": "Fixes #4979", "createdAt": "2020-08-27T05:01:13Z", "url": "https://github.com/trinodb/trino/pull/4995", "merged": true, "mergeCommit": {"oid": "24d59316a0eb3578889d4098862d920d5063939e"}, "closed": true, "closedAt": "2020-09-16T08:50:13Z", "author": {"login": "ssquan"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdC69vggFqTQ3NjQzODMzNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJYae0AFqTQ4OTQxMDI5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NDM4MzM1", "url": "https://github.com/trinodb/trino/pull/4995#pullrequestreview-476438335", "createdAt": "2020-08-27T07:02:56Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwNzowMjo1NlrOHIDC4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwNzowMjo1NlrOHIDC4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIwMDU0Nw==", "bodyText": "If we change to CTAS from the current implementation, it breaks the existing behavior when GTID mode is on. We need to look for other approach (e.g. Use CREATE TABLE LIKE only when GTID mode is on or just adding cofiguration).", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r478200547", "createdAt": "2020-08-27T07:02:56Z", "author": {"login": "ebyhr"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -307,8 +307,9 @@ public void renameColumn(JdbcIdentity identity, JdbcTableHandle handle, JdbcColu\n     @Override\n     protected void copyTableSchema(Connection connection, String catalogName, String schemaName, String tableName, String newTableName, List<String> columnNames)\n     {\n+        // Create a temporary table not only include columns to be inserted but all columns,  Need them for `NOT NULL` check.\n         String sql = format(\n-                \"CREATE TABLE %s LIKE %s\",\n+                \"CREATE TABLE %s AS SELECT * FROM %s WHERE 0 = 1\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NjEyNjM5", "url": "https://github.com/trinodb/trino/pull/4995#pullrequestreview-478612639", "createdAt": "2020-08-31T13:24:31Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMzoyNDozMVrOHJ4uIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMzo0MDowMVrOHJ5SPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEyODU0Ng==", "bodyText": "Move this method to after jsonColumnMapping method.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean isGTIDMode(Connection connection)\n          \n          \n            \n                private boolean isGtidMode(Connection connection)", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r480128546", "createdAt": "2020-08-31T13:24:31Z", "author": {"login": "ebyhr"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -268,6 +268,21 @@ else if (varcharType.getBoundedLength() <= 16777215) {\n         return super.toWriteMapping(session, type);\n     }\n \n+    private boolean isGTIDMode(Connection connection)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzMzIwNg==", "bodyText": "We can make this line try-with-resources and please upper case for keywords.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ResultSet resultSet = statement.executeQuery(\"show variables like 'gtid_mode'\");\n          \n          \n            \n                        ResultSet resultSet = statement.executeQuery(\"SHOW VARIABLES LIKE 'gtid_mode'\");", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r480133206", "createdAt": "2020-08-31T13:32:24Z", "author": {"login": "ebyhr"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -268,6 +268,21 @@ else if (varcharType.getBoundedLength() <= 16777215) {\n         return super.toWriteMapping(session, type);\n     }\n \n+    private boolean isGTIDMode(Connection connection)\n+    {\n+        try (java.sql.Statement statement = connection.createStatement()) {\n+            ResultSet resultSet = statement.executeQuery(\"show variables like 'gtid_mode'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzNzc5MA==", "bodyText": "ON_PERMISSIVE is also possible value.", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r480137790", "createdAt": "2020-08-31T13:40:01Z", "author": {"login": "ebyhr"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -268,6 +268,21 @@ else if (varcharType.getBoundedLength() <= 16777215) {\n         return super.toWriteMapping(session, type);\n     }\n \n+    private boolean isGTIDMode(Connection connection)\n+    {\n+        try (java.sql.Statement statement = connection.createStatement()) {\n+            ResultSet resultSet = statement.executeQuery(\"show variables like 'gtid_mode'\");\n+            if (resultSet.next()) {\n+                return resultSet.getString(\"Value\").equalsIgnoreCase(\"ON\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNDcyODcz", "url": "https://github.com/trinodb/trino/pull/4995#pullrequestreview-480472873", "createdAt": "2020-09-02T04:22:23Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwNDoyMjoyM1rOHLWCuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwNDoyMjoyM1rOHLWCuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTY1NzUzMQ==", "bodyText": "You don't need to split into 2 try.", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r481657531", "createdAt": "2020-09-02T04:22:23Z", "author": {"login": "ebyhr"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -344,6 +348,22 @@ private ColumnMapping jsonColumnMapping()\n                 DISABLE_PUSHDOWN);\n     }\n \n+    private boolean isGtidMode(Connection connection)\n+    {\n+        try (java.sql.Statement statement = connection.createStatement()) {\n+            try (ResultSet resultSet = statement.executeQuery(\"SHOW VARIABLES LIKE 'gtid_mode'\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MjAzODUw", "url": "https://github.com/trinodb/trino/pull/4995#pullrequestreview-487203850", "createdAt": "2020-09-12T05:00:15Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwNTowMDoxNVrOHQyn2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwNTowMDoxNVrOHQyn2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM2ODY2NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean isGtidMode(Connection connection)\n          \n          \n            \n                private static boolean isGtidMode(Connection connection)", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r487368664", "createdAt": "2020-09-12T05:00:15Z", "author": {"login": "ebyhr"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -344,6 +348,21 @@ private ColumnMapping jsonColumnMapping()\n                 DISABLE_PUSHDOWN);\n     }\n \n+    private boolean isGtidMode(Connection connection)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "c03d00528a3660768a421e81d99c23491a059a27", "author": {"user": {"login": "ssquan", "name": "Quan Shi"}}, "url": "https://github.com/trinodb/trino/commit/c03d00528a3660768a421e81d99c23491a059a27", "committedDate": "2020-09-14T07:20:40Z", "message": "Do not copy constraint for temporary table on non-GTID MySQL"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "c03d00528a3660768a421e81d99c23491a059a27", "author": {"user": {"login": "ssquan", "name": "Quan Shi"}}, "url": "https://github.com/trinodb/trino/commit/c03d00528a3660768a421e81d99c23491a059a27", "committedDate": "2020-09-14T07:20:40Z", "message": "Do not copy constraint for temporary table on non-GTID MySQL"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NDEwMjk1", "url": "https://github.com/trinodb/trino/pull/4995#pullrequestreview-489410295", "createdAt": "2020-09-16T08:49:12Z", "commit": {"oid": "c03d00528a3660768a421e81d99c23491a059a27"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4215, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}