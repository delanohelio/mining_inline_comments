{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNDE2Njc3", "number": 2788, "title": "Balance ArbitraryOutputBuffer distribution over clients", "bodyText": "Previously, the order that client buffers were polled was always started with the first ClientBuffer, which could lead to data skew when the master buffer drained before all clients could be polled since the client buffer traversal order was stable (but arbitrary).\nThis change stores the stop index of client buffer iteration to ensure that subsequent polling loops don't overload the first client buffer.\nThis is an alternative, simpler solution to the problem described in #2225 which does a much better job of documenting the existing issue. Shuffling the order is certainly preferable to skewing data, but the extra allocations and shuffling work shouldn't be necessary to produce a more fair output distribution.", "createdAt": "2020-02-11T00:10:32Z", "url": "https://github.com/trinodb/trino/pull/2788", "merged": true, "mergeCommit": {"oid": "60c0dc602dac02f4db01d0650a3a85f903803eaa"}, "closed": true, "closedAt": "2020-02-12T01:53:27Z", "author": {"login": "pettyjamesm"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDQdGJgFqTM1NjU5Nzc1MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDZSCZgBqjMwMjg0NDUzMDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NTk3NzUx", "url": "https://github.com/trinodb/trino/pull/2788#pullrequestreview-356597751", "createdAt": "2020-02-11T11:54:27Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMTo1NDoyN1rOFoGPqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMTo1NDoyN1rOFoGPqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU4OTY3Mw==", "bodyText": "use index = (index + 1) % buffers.size()", "url": "https://github.com/trinodb/trino/pull/2788#discussion_r377589673", "createdAt": "2020-02-11T11:54:27Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/buffer/ArbitraryOutputBuffer.java", "diffHunk": "@@ -228,11 +233,32 @@ public void enqueue(List<SerializedPage> pages)\n         masterBuffer.addPages(serializedPageReferences);\n \n         // process any pending reads from the client buffers\n-        for (ClientBuffer clientBuffer : safeGetBuffersSnapshot()) {\n+        clientBufferPollLoop();\n+    }\n+\n+    /**\n+     * Iterates client buffers, resuming where the previous cycle stopped if the master buffer was emptied before all clients were polled\n+     * and no new client buffers have been inserted.\n+     */\n+    private void clientBufferPollLoop()\n+    {\n+        List<ClientBuffer> buffers = safeGetBuffersSnapshot();\n+        if (buffers.isEmpty()) {\n+            return;\n+        }\n+        // handle potential for racy update of indexOffset and buffer list copy\n+        int index = nextClientBufferIndex.get() % buffers.size();\n+        for (int i = 0; i < buffers.size(); i++) {\n+            buffers.get(index).loadPagesIfNecessary(masterBuffer);\n+            index++;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2OTUyMDA5", "url": "https://github.com/trinodb/trino/pull/2788#pullrequestreview-356952009", "createdAt": "2020-02-11T19:57:55Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2OTcyOTkz", "url": "https://github.com/trinodb/trino/pull/2788#pullrequestreview-356972993", "createdAt": "2020-02-11T20:32:09Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMDozMjoxMFrOFoYD7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMDozNTowNVrOFoYJIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg4MTU4MA==", "bodyText": "I'd prefer to keep this inline instead of a separate method.", "url": "https://github.com/trinodb/trino/pull/2788#discussion_r377881580", "createdAt": "2020-02-11T20:32:10Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/execution/buffer/ArbitraryOutputBuffer.java", "diffHunk": "@@ -228,11 +233,29 @@ public void enqueue(List<SerializedPage> pages)\n         masterBuffer.addPages(serializedPageReferences);\n \n         // process any pending reads from the client buffers\n-        for (ClientBuffer clientBuffer : safeGetBuffersSnapshot()) {\n+        clientBufferPollLoop();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg4MjExNg==", "bodyText": "indexOffset seems incorrect here (maybe was renamed after the comment was written). Maybe just say \"next index\" rather than referring to the field.", "url": "https://github.com/trinodb/trino/pull/2788#discussion_r377882116", "createdAt": "2020-02-11T20:33:17Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/execution/buffer/ArbitraryOutputBuffer.java", "diffHunk": "@@ -228,11 +233,29 @@ public void enqueue(List<SerializedPage> pages)\n         masterBuffer.addPages(serializedPageReferences);\n \n         // process any pending reads from the client buffers\n-        for (ClientBuffer clientBuffer : safeGetBuffersSnapshot()) {\n+        clientBufferPollLoop();\n+    }\n+\n+    /**\n+     * Iterates client buffers, resuming where the previous cycle stopped if the master buffer was emptied before all clients were polled\n+     * and no new client buffers have been inserted.\n+     */\n+    private void clientBufferPollLoop()\n+    {\n+        List<ClientBuffer> buffers = safeGetBuffersSnapshot();\n+        if (buffers.isEmpty()) {\n+            return;\n+        }\n+        // handle potential for racy update of indexOffset and buffer list copy", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg4MjkxNQ==", "bodyText": "This can be\nassertThat(firstReads.values()).allMatch(Future::isDone);", "url": "https://github.com/trinodb/trino/pull/2788#discussion_r377882915", "createdAt": "2020-02-11T20:35:05Z", "author": {"login": "electrum"}, "path": "presto-main/src/test/java/io/prestosql/execution/buffer/TestArbitraryOutputBuffer.java", "diffHunk": "@@ -423,6 +426,56 @@ public void testGetBeforeCreate()\n         assertBufferResultEquals(TYPES, getFuture(future, NO_WAIT), bufferResult(0, createPage(33)));\n     }\n \n+    @Test\n+    public void testResumeFromPreviousPosition()\n+    {\n+        OutputBuffers outputBuffers = createInitialEmptyOutputBuffers(ARBITRARY);\n+        OutputBufferId[] ids = new OutputBufferId[5];\n+        for (int i = 0; i < ids.length; i++) {\n+            ids[i] = new OutputBufferId(i);\n+            outputBuffers = outputBuffers.withBuffer(ids[i], i);\n+        }\n+\n+        ArbitraryOutputBuffer buffer = createArbitraryBuffer(outputBuffers, sizeOfPages(5));\n+        assertFalse(buffer.isFinished());\n+\n+        Map<OutputBufferId, ListenableFuture<BufferResult>> firstReads = new HashMap<>();\n+        for (OutputBufferId id : ids) {\n+            firstReads.put(id, buffer.get(id, 0L, sizeOfPages(1)));\n+        }\n+        // All must be blocked initially\n+        firstReads.values().forEach(future -> assertFalse(future.isDone()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "afed5fbd7e9987736ef6a2d1db851c2d13d47de0", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/afed5fbd7e9987736ef6a2d1db851c2d13d47de0", "committedDate": "2020-02-11T22:15:04Z", "message": "Balance ArbitraryOutputBuffer distribution over clients\n\nPreviously, the order that client buffers were polled was always\nstarted with the first ClientBuffer, which could lead to data skew\nwhen the master buffer drained before all clients could be polled\nsince the client buffer traversal order was stable (but arbitrary).\n\nThis change stores the stop index of client buffer iteration to\nensure that subsequent polling loops don't overload the first client\nbuffer."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "afed5fbd7e9987736ef6a2d1db851c2d13d47de0", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/afed5fbd7e9987736ef6a2d1db851c2d13d47de0", "committedDate": "2020-02-11T22:15:04Z", "message": "Balance ArbitraryOutputBuffer distribution over clients\n\nPreviously, the order that client buffers were polled was always\nstarted with the first ClientBuffer, which could lead to data skew\nwhen the master buffer drained before all clients could be polled\nsince the client buffer traversal order was stable (but arbitrary).\n\nThis change stores the stop index of client buffer iteration to\nensure that subsequent polling loops don't overload the first client\nbuffer."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1664, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}