{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMjQ1ODA4", "number": 5239, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzowOToyN1rOEl80AA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo1NzozMlrOEl_P-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjI5MTIwOnYy", "diffSide": "LEFT", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlCaseInsensitiveMapping.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzowOToyN1rOHVszTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzowOToyN1rOHVszTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUxNjE3Mg==", "bodyText": "Regarding commit message:\nBefore this change query runner was closed before testing PSQL server.\nThat led to situation that there was a time where query runner was up\nand running but without a dependant service.\n\nI think you meant:\nBefore this change testing PSQL server was closed before query runner", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492516172", "createdAt": "2020-09-22T07:09:27Z", "author": {"login": "losipiuk"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlCaseInsensitiveMapping.java", "diffHunk": "@@ -17,7 +17,6 @@\n import com.google.common.collect.ImmutableSet;\n import io.prestosql.testing.AbstractTestQueryFramework;\n import io.prestosql.testing.QueryRunner;\n-import org.testng.annotations.AfterClass;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjI5Njg2OnYy", "diffSide": "RIGHT", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzoxMToxMlrOHVs2rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzoxMToxMlrOHVs2rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUxNzAzOQ==", "bodyText": "rename to registerForClosing", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492517039", "createdAt": "2020-09-22T07:11:12Z", "author": {"login": "losipiuk"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -459,4 +464,10 @@ protected OperatorStats searchScanFilterAndProjectOperatorStats(QueryId queryId,\n                 .filter(summary -> nodeId.equals(summary.getPlanNodeId()) && summary.getOperatorType().equals(\"ScanFilterAndProjectOperator\"))\n                 .collect(MoreCollectors.onlyElement());\n     }\n+\n+    @CanIgnoreReturnValue\n+    protected final <T extends Closeable> T registerResource(T resource)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjM0MDQwOnYy", "diffSide": "RIGHT", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlDistributedQueries.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzoyNTowMlrOHVtQkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzo0MTozOFrOHVtxnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyMzY2Nw==", "bodyText": "registerResource is misleading, as you're registering a callback\n(the declaration looks legit, but the call site like this looks weird)", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492523667", "createdAt": "2020-09-22T07:25:02Z", "author": {"login": "findepi"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlDistributedQueries.java", "diffHunk": "@@ -33,6 +32,10 @@ protected QueryRunner createQueryRunner()\n             throws Exception\n     {\n         postgreSqlServer = new TestingPostgreSqlServer();\n+        registerResource(() -> {\n+            postgreSqlServer.close();\n+            postgreSqlServer = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUzMjEyNA==", "bodyText": "I was thinking also about closeAfterClass? WDYT?", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492532124", "createdAt": "2020-09-22T07:41:38Z", "author": {"login": "kokosing"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlDistributedQueries.java", "diffHunk": "@@ -33,6 +32,10 @@ protected QueryRunner createQueryRunner()\n             throws Exception\n     {\n         postgreSqlServer = new TestingPostgreSqlServer();\n+        registerResource(() -> {\n+            postgreSqlServer.close();\n+            postgreSqlServer = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyMzY2Nw=="}, "originalCommit": null, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjM0NDU3OnYy", "diffSide": "LEFT", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlDistributedQueries.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzoyNjoxNVrOHVtTIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzo0MToxN1rOHVtw-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyNDMyMA==", "bodyText": "That led to situation that there was a time where query runner was up\nand running but without a dependant service.\n\nWas it a problem?", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492524320", "createdAt": "2020-09-22T07:26:15Z", "author": {"login": "findepi"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlDistributedQueries.java", "diffHunk": "@@ -44,12 +47,6 @@ protected QueryRunner createQueryRunner()\n                 TpchTable.getTables());\n     }\n \n-    @AfterClass(alwaysRun = true)\n-    public final void destroy()\n-    {\n-        postgreSqlServer.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUzMTk2MA==", "bodyText": "It is not a problem Postgres testing, it does not manifest itself anyhow. It is a generic problem with resources in ATQF, and Postgres tests are just example.", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492531960", "createdAt": "2020-09-22T07:41:17Z", "author": {"login": "kokosing"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlDistributedQueries.java", "diffHunk": "@@ -44,12 +47,6 @@ protected QueryRunner createQueryRunner()\n                 TpchTable.getTables());\n     }\n \n-    @AfterClass(alwaysRun = true)\n-    public final void destroy()\n-    {\n-        postgreSqlServer.close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyNDMyMA=="}, "originalCommit": null, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjY2NzMzOnYy", "diffSide": "RIGHT", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlCaseInsensitiveMapping.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo1MTo1N1rOHVwU-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOToxMjo0OVrOHVxHSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3Mzk0NA==", "bodyText": "when good order is now maintained,... = null is excessive, it doesn't help much (or even at all) now, but hurts readability a lot, postgreSqlServer = closeAfterClass(new ...) is enough", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492573944", "createdAt": "2020-09-22T08:51:57Z", "author": {"login": "iirekm"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlCaseInsensitiveMapping.java", "diffHunk": "@@ -41,20 +40,18 @@\n     protected QueryRunner createQueryRunner()\n             throws Exception\n     {\n-        this.postgreSqlServer = new TestingPostgreSqlServer();\n+        postgreSqlServer = new TestingPostgreSqlServer();\n+        closeAfterClass(() -> {\n+            postgreSqlServer.close();\n+            postgreSqlServer = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU4NjgyNQ==", "bodyText": "It hurts readability, but it is sanity check. So it is impossible to access postgreSqlServer in not usable state. Alternatively we could mantain state in TestingPostgreSqlServer to know that is CREATED or STARTED or CLOSED but this is even worse.", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492586825", "createdAt": "2020-09-22T09:12:49Z", "author": {"login": "kokosing"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlCaseInsensitiveMapping.java", "diffHunk": "@@ -41,20 +40,18 @@\n     protected QueryRunner createQueryRunner()\n             throws Exception\n     {\n-        this.postgreSqlServer = new TestingPostgreSqlServer();\n+        postgreSqlServer = new TestingPostgreSqlServer();\n+        closeAfterClass(() -> {\n+            postgreSqlServer.close();\n+            postgreSqlServer = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3Mzk0NA=="}, "originalCommit": {"oid": "e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjY3MjIwOnYy", "diffSide": "RIGHT", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo1MzoxMlrOHVwX9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOToxMzozMlrOHVxI9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NDcwOA==", "bodyText": "for better readabillity afterClassClose, or something alike, because we also have after-method 'close' in many tests", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492574708", "createdAt": "2020-09-22T08:53:12Z", "author": {"login": "iirekm"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -100,8 +104,9 @@ protected abstract QueryRunner createQueryRunner()\n \n     @AfterClass(alwaysRun = true)\n     public void close()\n+            throws IOException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU4NzI1Mw==", "bodyText": "Let me avoid doing refactors in this pull requests.", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492587253", "createdAt": "2020-09-22T09:13:32Z", "author": {"login": "kokosing"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -100,8 +104,9 @@ protected abstract QueryRunner createQueryRunner()\n \n     @AfterClass(alwaysRun = true)\n     public void close()\n+            throws IOException", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NDcwOA=="}, "originalCommit": {"oid": "e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjY4ODQ4OnYy", "diffSide": "RIGHT", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo1NzowN1rOHVwhqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOToxNTowNlrOHVxMew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NzE5Mw==", "bodyText": "nit: use Closer from starburst-presto", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492577193", "createdAt": "2020-09-22T08:57:07Z", "author": {"login": "iirekm"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -83,14 +86,15 @@\n     private QueryRunner queryRunner;\n     private H2QueryRunner h2QueryRunner;\n     private SqlParser sqlParser;\n+    private final Closer afterClassCloser = Closer.create();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU4ODE1NQ==", "bodyText": "Let me handle that in separate pr.", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492588155", "createdAt": "2020-09-22T09:15:06Z", "author": {"login": "kokosing"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -83,14 +86,15 @@\n     private QueryRunner queryRunner;\n     private H2QueryRunner h2QueryRunner;\n     private SqlParser sqlParser;\n+    private final Closer afterClassCloser = Closer.create();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NzE5Mw=="}, "originalCommit": {"oid": "e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjY5MDUxOnYy", "diffSide": "RIGHT", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo1NzozMlrOHVwivw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOToxMzozNlrOHVxJEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NzQ3MQ==", "bodyText": "beforeClass or something alike to not confuse z before-method initializations", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492577471", "createdAt": "2020-09-22T08:57:32Z", "author": {"login": "iirekm"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -83,14 +86,15 @@\n     private QueryRunner queryRunner;\n     private H2QueryRunner h2QueryRunner;\n     private SqlParser sqlParser;\n+    private final Closer afterClassCloser = Closer.create();\n     private io.prestosql.sql.query.QueryAssertions queryAssertions;\n \n     @BeforeClass\n     public void init()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU4NzI4Mw==", "bodyText": "Let me avoid doing refactors in this pull requests.", "url": "https://github.com/trinodb/trino/pull/5239#discussion_r492587283", "createdAt": "2020-09-22T09:13:36Z", "author": {"login": "kokosing"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueryFramework.java", "diffHunk": "@@ -83,14 +86,15 @@\n     private QueryRunner queryRunner;\n     private H2QueryRunner h2QueryRunner;\n     private SqlParser sqlParser;\n+    private final Closer afterClassCloser = Closer.create();\n     private io.prestosql.sql.query.QueryAssertions queryAssertions;\n \n     @BeforeClass\n     public void init()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NzQ3MQ=="}, "originalCommit": {"oid": "e2647b1b7d0193c54bbe7c4b8c4dcb3727e07d7f"}, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3019, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}