{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzNzQ3Nzkw", "number": 3242, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMDoxODoyMVrODsALXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwOTo1NTo0MlrODtCE7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NDY2ODQ0OnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/sql/planner/AbstractPredicatePushdownTest.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMDoxODoyMVrOF8q9cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNTo0NzowOVrOF83EvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE2MjczNw==", "bodyText": "make this test DF independent (or with DF disabled). No need to mix DF here", "url": "https://github.com/trinodb/trino/pull/3242#discussion_r399162737", "createdAt": "2020-03-27T10:18:21Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/AbstractPredicatePushdownTest.java", "diffHunk": "@@ -440,6 +443,36 @@ public void testNonDeterministicPredicateNotPushedDown()\n                                                                 ImmutableMap.of(\"CUST_KEY\", \"custkey\"))))))));\n     }\n \n+    @Test\n+    public void testNormalizeOuterJoinToInner()\n+    {\n+        Session disableJoinReordering = Session.builder(getQueryRunner().getDefaultSession())\n+                .setSystemProperty(JOIN_REORDERING_STRATEGY, \"NONE\")\n+                .build();\n+\n+        assertPlan(\n+                \"SELECT customer.name, lineitem.partkey \" +\n+                        \"FROM lineitem \" +\n+                        \"LEFT JOIN orders ON lineitem.orderkey = orders.orderkey \" +\n+                        \"INNER JOIN customer ON orders.custkey = customer.custkey \" +\n+                        \"WHERE customer.name IS NOT NULL\",\n+                disableJoinReordering,\n+                anyTree(\n+                        join(\n+                                INNER,\n+                                ImmutableList.of(equiJoinClause(\"o_custkey\", \"c_custkey\")),\n+                                anyTree(\n+                                        join(\n+                                                enableDynamicFiltering ? INNER : LEFT, // TODO (https://github.com/prestosql/presto/issues/2392) this should be INNER also when dynamic filtering is off", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIxMDk0Ng==", "bodyText": "This test is run with and without DF.\nAs you see, it is DF-dependent -- the actual results depend on whether DF is enabled.\nIn the future, eg when we do #2392, the assertion will be simplified to be always INNER, and this will look better.", "url": "https://github.com/trinodb/trino/pull/3242#discussion_r399210946", "createdAt": "2020-03-27T11:52:18Z", "author": {"login": "findepi"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/AbstractPredicatePushdownTest.java", "diffHunk": "@@ -440,6 +443,36 @@ public void testNonDeterministicPredicateNotPushedDown()\n                                                                 ImmutableMap.of(\"CUST_KEY\", \"custkey\"))))))));\n     }\n \n+    @Test\n+    public void testNormalizeOuterJoinToInner()\n+    {\n+        Session disableJoinReordering = Session.builder(getQueryRunner().getDefaultSession())\n+                .setSystemProperty(JOIN_REORDERING_STRATEGY, \"NONE\")\n+                .build();\n+\n+        assertPlan(\n+                \"SELECT customer.name, lineitem.partkey \" +\n+                        \"FROM lineitem \" +\n+                        \"LEFT JOIN orders ON lineitem.orderkey = orders.orderkey \" +\n+                        \"INNER JOIN customer ON orders.custkey = customer.custkey \" +\n+                        \"WHERE customer.name IS NOT NULL\",\n+                disableJoinReordering,\n+                anyTree(\n+                        join(\n+                                INNER,\n+                                ImmutableList.of(equiJoinClause(\"o_custkey\", \"c_custkey\")),\n+                                anyTree(\n+                                        join(\n+                                                enableDynamicFiltering ? INNER : LEFT, // TODO (https://github.com/prestosql/presto/issues/2392) this should be INNER also when dynamic filtering is off", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE2MjczNw=="}, "originalCommit": null, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIzNzMxNA==", "bodyText": "As you see, it is DF-dependent -- the actual results depend on whether DF is enabled.\n\nRight, but we don't need to run this test twice to make sure normalization works. Normalization part is completely independent of DFs", "url": "https://github.com/trinodb/trino/pull/3242#discussion_r399237314", "createdAt": "2020-03-27T12:44:30Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/AbstractPredicatePushdownTest.java", "diffHunk": "@@ -440,6 +443,36 @@ public void testNonDeterministicPredicateNotPushedDown()\n                                                                 ImmutableMap.of(\"CUST_KEY\", \"custkey\"))))))));\n     }\n \n+    @Test\n+    public void testNormalizeOuterJoinToInner()\n+    {\n+        Session disableJoinReordering = Session.builder(getQueryRunner().getDefaultSession())\n+                .setSystemProperty(JOIN_REORDERING_STRATEGY, \"NONE\")\n+                .build();\n+\n+        assertPlan(\n+                \"SELECT customer.name, lineitem.partkey \" +\n+                        \"FROM lineitem \" +\n+                        \"LEFT JOIN orders ON lineitem.orderkey = orders.orderkey \" +\n+                        \"INNER JOIN customer ON orders.custkey = customer.custkey \" +\n+                        \"WHERE customer.name IS NOT NULL\",\n+                disableJoinReordering,\n+                anyTree(\n+                        join(\n+                                INNER,\n+                                ImmutableList.of(equiJoinClause(\"o_custkey\", \"c_custkey\")),\n+                                anyTree(\n+                                        join(\n+                                                enableDynamicFiltering ? INNER : LEFT, // TODO (https://github.com/prestosql/presto/issues/2392) this should be INNER also when dynamic filtering is off", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE2MjczNw=="}, "originalCommit": null, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1ODAyNA==", "bodyText": "So this normalization works independently from DF:\nhttps://github.com/prestosql/presto/pull/3242/files#diff-3c91106969a4d5786ab8f7ef09d73b3bR462\nand this normalization depends on DF:\nhttps://github.com/prestosql/presto/pull/3242/files#diff-3c91106969a4d5786ab8f7ef09d73b3bR466", "url": "https://github.com/trinodb/trino/pull/3242#discussion_r399258024", "createdAt": "2020-03-27T13:20:23Z", "author": {"login": "findepi"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/AbstractPredicatePushdownTest.java", "diffHunk": "@@ -440,6 +443,36 @@ public void testNonDeterministicPredicateNotPushedDown()\n                                                                 ImmutableMap.of(\"CUST_KEY\", \"custkey\"))))))));\n     }\n \n+    @Test\n+    public void testNormalizeOuterJoinToInner()\n+    {\n+        Session disableJoinReordering = Session.builder(getQueryRunner().getDefaultSession())\n+                .setSystemProperty(JOIN_REORDERING_STRATEGY, \"NONE\")\n+                .build();\n+\n+        assertPlan(\n+                \"SELECT customer.name, lineitem.partkey \" +\n+                        \"FROM lineitem \" +\n+                        \"LEFT JOIN orders ON lineitem.orderkey = orders.orderkey \" +\n+                        \"INNER JOIN customer ON orders.custkey = customer.custkey \" +\n+                        \"WHERE customer.name IS NOT NULL\",\n+                disableJoinReordering,\n+                anyTree(\n+                        join(\n+                                INNER,\n+                                ImmutableList.of(equiJoinClause(\"o_custkey\", \"c_custkey\")),\n+                                anyTree(\n+                                        join(\n+                                                enableDynamicFiltering ? INNER : LEFT, // TODO (https://github.com/prestosql/presto/issues/2392) this should be INNER also when dynamic filtering is off", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE2MjczNw=="}, "originalCommit": null, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2OTc3MA==", "bodyText": "I think we want to test io.prestosql.sql.planner.optimizations.PredicatePushDown.Rewriter#tryNormalizeToOuterToInnerJoin. It doesn't dependent on DFs", "url": "https://github.com/trinodb/trino/pull/3242#discussion_r399269770", "createdAt": "2020-03-27T13:38:02Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/AbstractPredicatePushdownTest.java", "diffHunk": "@@ -440,6 +443,36 @@ public void testNonDeterministicPredicateNotPushedDown()\n                                                                 ImmutableMap.of(\"CUST_KEY\", \"custkey\"))))))));\n     }\n \n+    @Test\n+    public void testNormalizeOuterJoinToInner()\n+    {\n+        Session disableJoinReordering = Session.builder(getQueryRunner().getDefaultSession())\n+                .setSystemProperty(JOIN_REORDERING_STRATEGY, \"NONE\")\n+                .build();\n+\n+        assertPlan(\n+                \"SELECT customer.name, lineitem.partkey \" +\n+                        \"FROM lineitem \" +\n+                        \"LEFT JOIN orders ON lineitem.orderkey = orders.orderkey \" +\n+                        \"INNER JOIN customer ON orders.custkey = customer.custkey \" +\n+                        \"WHERE customer.name IS NOT NULL\",\n+                disableJoinReordering,\n+                anyTree(\n+                        join(\n+                                INNER,\n+                                ImmutableList.of(equiJoinClause(\"o_custkey\", \"c_custkey\")),\n+                                anyTree(\n+                                        join(\n+                                                enableDynamicFiltering ? INNER : LEFT, // TODO (https://github.com/prestosql/presto/issues/2392) this should be INNER also when dynamic filtering is off", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE2MjczNw=="}, "originalCommit": null, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxMjgwNg==", "bodyText": "Yes, the conversion LEFT -> INNER happens in tryNormalizeToOuterToInnerJoin. No, the conversion depends on DF, because DF adds filters which allow tryNormalizeToOuterToInnerJointo do its job. With DF disabled,tryNormalizeToOuterToInnerJoin` does not get any information it could act upon.\nThis will be alleviated once we figure out how to do #2392 without CPU hit.", "url": "https://github.com/trinodb/trino/pull/3242#discussion_r399312806", "createdAt": "2020-03-27T14:39:58Z", "author": {"login": "findepi"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/AbstractPredicatePushdownTest.java", "diffHunk": "@@ -440,6 +443,36 @@ public void testNonDeterministicPredicateNotPushedDown()\n                                                                 ImmutableMap.of(\"CUST_KEY\", \"custkey\"))))))));\n     }\n \n+    @Test\n+    public void testNormalizeOuterJoinToInner()\n+    {\n+        Session disableJoinReordering = Session.builder(getQueryRunner().getDefaultSession())\n+                .setSystemProperty(JOIN_REORDERING_STRATEGY, \"NONE\")\n+                .build();\n+\n+        assertPlan(\n+                \"SELECT customer.name, lineitem.partkey \" +\n+                        \"FROM lineitem \" +\n+                        \"LEFT JOIN orders ON lineitem.orderkey = orders.orderkey \" +\n+                        \"INNER JOIN customer ON orders.custkey = customer.custkey \" +\n+                        \"WHERE customer.name IS NOT NULL\",\n+                disableJoinReordering,\n+                anyTree(\n+                        join(\n+                                INNER,\n+                                ImmutableList.of(equiJoinClause(\"o_custkey\", \"c_custkey\")),\n+                                anyTree(\n+                                        join(\n+                                                enableDynamicFiltering ? INNER : LEFT, // TODO (https://github.com/prestosql/presto/issues/2392) this should be INNER also when dynamic filtering is off", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE2MjczNw=="}, "originalCommit": null, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MTIxMg==", "bodyText": "tryNormalizeToOuterToInnerJoin` does not get any information it could act upon.\n\ntryNormalizeToOuterToInnerJoin pre-dated DFs and worked without them too.", "url": "https://github.com/trinodb/trino/pull/3242#discussion_r399361212", "createdAt": "2020-03-27T15:47:09Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/AbstractPredicatePushdownTest.java", "diffHunk": "@@ -440,6 +443,36 @@ public void testNonDeterministicPredicateNotPushedDown()\n                                                                 ImmutableMap.of(\"CUST_KEY\", \"custkey\"))))))));\n     }\n \n+    @Test\n+    public void testNormalizeOuterJoinToInner()\n+    {\n+        Session disableJoinReordering = Session.builder(getQueryRunner().getDefaultSession())\n+                .setSystemProperty(JOIN_REORDERING_STRATEGY, \"NONE\")\n+                .build();\n+\n+        assertPlan(\n+                \"SELECT customer.name, lineitem.partkey \" +\n+                        \"FROM lineitem \" +\n+                        \"LEFT JOIN orders ON lineitem.orderkey = orders.orderkey \" +\n+                        \"INNER JOIN customer ON orders.custkey = customer.custkey \" +\n+                        \"WHERE customer.name IS NOT NULL\",\n+                disableJoinReordering,\n+                anyTree(\n+                        join(\n+                                INNER,\n+                                ImmutableList.of(equiJoinClause(\"o_custkey\", \"c_custkey\")),\n+                                anyTree(\n+                                        join(\n+                                                enableDynamicFiltering ? INNER : LEFT, // TODO (https://github.com/prestosql/presto/issues/2392) this should be INNER also when dynamic filtering is off", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE2MjczNw=="}, "originalCommit": null, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NTQ2NTQxOnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/sql/planner/AbstractPredicatePushdownTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwOTo1NTo0MlrOF-OEeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMTowNDowMVrOF-QcgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc4NjU1Mg==", "bodyText": "add comment how this test is different", "url": "https://github.com/trinodb/trino/pull/3242#discussion_r400786552", "createdAt": "2020-03-31T09:55:42Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/AbstractPredicatePushdownTest.java", "diffHunk": "@@ -439,6 +442,52 @@ public void testNonDeterministicPredicateNotPushedDown()\n                                                                 ImmutableMap.of(\"CUST_KEY\", \"custkey\"))))))));\n     }\n \n+    @Test\n+    public void testNormalizeOuterJoinToInner()\n+    {\n+        Session disableJoinReordering = Session.builder(getQueryRunner().getDefaultSession())\n+                .setSystemProperty(JOIN_REORDERING_STRATEGY, \"NONE\")\n+                .build();\n+\n+        assertPlan(\n+                \"SELECT customer.name, orders.orderdate \" +\n+                        \"FROM orders \" +\n+                        \"LEFT JOIN customer ON orders.custkey = customer.custkey \" +\n+                        \"WHERE customer.name IS NOT NULL\",\n+                disableJoinReordering,\n+                anyTree(\n+                        join(\n+                                INNER,\n+                                ImmutableList.of(equiJoinClause(\"o_custkey\", \"c_custkey\")),\n+                                anyTree(tableScan(\"orders\", ImmutableMap.of(\"o_orderdate\", \"orderdate\", \"o_custkey\", \"custkey\"))),\n+                                anyTree(\n+                                        filter(\n+                                                \"NOT (c_name IS NULL)\",\n+                                                tableScan(\"customer\", ImmutableMap.of(\"c_custkey\", \"custkey\", \"c_name\", \"name\")))))));\n+\n+        assertPlan(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyNTQ3Mw==", "bodyText": "added that this is nested join case", "url": "https://github.com/trinodb/trino/pull/3242#discussion_r400825473", "createdAt": "2020-03-31T11:04:01Z", "author": {"login": "findepi"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/AbstractPredicatePushdownTest.java", "diffHunk": "@@ -439,6 +442,52 @@ public void testNonDeterministicPredicateNotPushedDown()\n                                                                 ImmutableMap.of(\"CUST_KEY\", \"custkey\"))))))));\n     }\n \n+    @Test\n+    public void testNormalizeOuterJoinToInner()\n+    {\n+        Session disableJoinReordering = Session.builder(getQueryRunner().getDefaultSession())\n+                .setSystemProperty(JOIN_REORDERING_STRATEGY, \"NONE\")\n+                .build();\n+\n+        assertPlan(\n+                \"SELECT customer.name, orders.orderdate \" +\n+                        \"FROM orders \" +\n+                        \"LEFT JOIN customer ON orders.custkey = customer.custkey \" +\n+                        \"WHERE customer.name IS NOT NULL\",\n+                disableJoinReordering,\n+                anyTree(\n+                        join(\n+                                INNER,\n+                                ImmutableList.of(equiJoinClause(\"o_custkey\", \"c_custkey\")),\n+                                anyTree(tableScan(\"orders\", ImmutableMap.of(\"o_orderdate\", \"orderdate\", \"o_custkey\", \"custkey\"))),\n+                                anyTree(\n+                                        filter(\n+                                                \"NOT (c_name IS NULL)\",\n+                                                tableScan(\"customer\", ImmutableMap.of(\"c_custkey\", \"custkey\", \"c_name\", \"name\")))))));\n+\n+        assertPlan(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc4NjU1Mg=="}, "originalCommit": null, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 491, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}