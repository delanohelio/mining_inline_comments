{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwMTM2MTQy", "number": 4473, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxNTowMjo0M1rOEPLBjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwOTo0NTo1NlrOEPeGaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MzQ0NzE5OnYy", "diffSide": "RIGHT", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlIntegrationSmokeTest.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxNTowMjo0M1rOGyvObg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNTowMzo1MFrOG08YdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg1NTcyNg==", "bodyText": "Can you add one with an empty count too, count()?", "url": "https://github.com/trinodb/trino/pull/4473#discussion_r455855726", "createdAt": "2020-07-16T15:02:43Z", "author": {"login": "alexjo2144"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlIntegrationSmokeTest.java", "diffHunk": "@@ -296,6 +296,7 @@ public void testAggregationPushdown()\n         // TODO support aggregation over expressions\n \n         assertPushedDown(\"SELECT count(*) FROM nation\");\n+        assertPushedDown(\"SELECT count(1) FROM nation\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIzNjI3Nw==", "bodyText": "Adding empty count makes test failed. Presto supports empty count but PostgreSQL (or JDBC?) seems not.\nCaused by: org.h2.jdbc.JdbcSQLSyntaxErrorException: Syntax error in SQL statement \"SELECT COUNT()[*] FROM NATION\"; expected \"*, DISTINCT, ALL, NOT, EXISTS, INTERSECTS, UNIQUE\"; SQL statement:\nSELECT count() FROM nation [42001-200]\n\tat org.h2.message.DbException.getJdbcSQLException(DbException.java:453)\n\tat org.h2.message.DbException.getJdbcSQLException(DbException.java:429)\n\tat org.h2.message.DbException.getSyntaxError(DbException.java:243)\n\tat org.h2.command.Parser.getSyntaxError(Parser.java:1053)\n\tat org.h2.command.Parser.readTerm(Parser.java:4479)", "url": "https://github.com/trinodb/trino/pull/4473#discussion_r456236277", "createdAt": "2020-07-17T06:04:47Z", "author": {"login": "Lewuathe"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlIntegrationSmokeTest.java", "diffHunk": "@@ -296,6 +296,7 @@ public void testAggregationPushdown()\n         // TODO support aggregation over expressions\n \n         assertPushedDown(\"SELECT count(*) FROM nation\");\n+        assertPushedDown(\"SELECT count(1) FROM nation\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg1NTcyNg=="}, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIzNjk1OA==", "bodyText": "The error comes from H2, which is used as a reference\nFor now you can add a second param like this, to use a different query for H2:\nassertPushedDown(\"SELECT count() FROM nation\",  \"SELECT count(*) FROM nation\");\n\nThis won't be needed after #4466", "url": "https://github.com/trinodb/trino/pull/4473#discussion_r456236958", "createdAt": "2020-07-17T06:07:00Z", "author": {"login": "findepi"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlIntegrationSmokeTest.java", "diffHunk": "@@ -296,6 +296,7 @@ public void testAggregationPushdown()\n         // TODO support aggregation over expressions\n \n         assertPushedDown(\"SELECT count(*) FROM nation\");\n+        assertPushedDown(\"SELECT count(1) FROM nation\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg1NTcyNg=="}, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0MjE3MQ==", "bodyText": "@findepi Thanks a lot! It did work as we expected. I didn't know such usage of assertPushedDown.", "url": "https://github.com/trinodb/trino/pull/4473#discussion_r456242171", "createdAt": "2020-07-17T06:22:43Z", "author": {"login": "Lewuathe"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlIntegrationSmokeTest.java", "diffHunk": "@@ -296,6 +296,7 @@ public void testAggregationPushdown()\n         // TODO support aggregation over expressions\n \n         assertPushedDown(\"SELECT count(*) FROM nation\");\n+        assertPushedDown(\"SELECT count(1) FROM nation\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg1NTcyNg=="}, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE2ODQzNw==", "bodyText": "#4466 was merged so you may need a rebase", "url": "https://github.com/trinodb/trino/pull/4473#discussion_r458168437", "createdAt": "2020-07-21T15:03:50Z", "author": {"login": "alexjo2144"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlIntegrationSmokeTest.java", "diffHunk": "@@ -296,6 +296,7 @@ public void testAggregationPushdown()\n         // TODO support aggregation over expressions\n \n         assertPushedDown(\"SELECT count(*) FROM nation\");\n+        assertPushedDown(\"SELECT count(1) FROM nation\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg1NTcyNg=="}, "originalCommit": null, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NjU3MjU5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/planner/PlanOptimizers.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwOTo0NTo1NlrOGzMsLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMDoxMjo0MFrOGzNhFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMzODQ3OA==", "bodyText": "Instead of adding new IterativeOptimizer, maybe you could add this rule to existing one. Maybe here: https://github.com/prestosql/presto/pull/4473/files#diff-ac936e954fdd13abb49900e706ea17fcL391?", "url": "https://github.com/trinodb/trino/pull/4473#discussion_r456338478", "createdAt": "2020-07-17T09:45:56Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/PlanOptimizers.java", "diffHunk": "@@ -460,6 +466,7 @@ public PlanOptimizers(\n                                 new ImplementIntersectAsUnion(metadata),\n                                 new ImplementExceptAsUnion(metadata))),\n                 new LimitPushDown(), // Run the LimitPushDown after flattening set operators to make it easier to do the set flattening\n+                simplifyCountOverConstantOptimizer, // Run SimplifyCountOverConstant before column pruning to ensure the aggregation pushdown to connectors.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM0NDg2OQ==", "bodyText": "@kokosing  The link doesn't seem to work for me.", "url": "https://github.com/trinodb/trino/pull/4473#discussion_r456344869", "createdAt": "2020-07-17T09:58:22Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/PlanOptimizers.java", "diffHunk": "@@ -460,6 +466,7 @@ public PlanOptimizers(\n                                 new ImplementIntersectAsUnion(metadata),\n                                 new ImplementExceptAsUnion(metadata))),\n                 new LimitPushDown(), // Run the LimitPushDown after flattening set operators to make it easier to do the set flattening\n+                simplifyCountOverConstantOptimizer, // Run SimplifyCountOverConstant before column pruning to ensure the aggregation pushdown to connectors.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMzODQ3OA=="}, "originalCommit": null, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1MTcwOQ==", "bodyText": "It works, but you don't see it. It marks the line that is hidden.", "url": "https://github.com/trinodb/trino/pull/4473#discussion_r456351709", "createdAt": "2020-07-17T10:12:07Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/PlanOptimizers.java", "diffHunk": "@@ -460,6 +466,7 @@ public PlanOptimizers(\n                                 new ImplementIntersectAsUnion(metadata),\n                                 new ImplementExceptAsUnion(metadata))),\n                 new LimitPushDown(), // Run the LimitPushDown after flattening set operators to make it easier to do the set flattening\n+                simplifyCountOverConstantOptimizer, // Run SimplifyCountOverConstant before column pruning to ensure the aggregation pushdown to connectors.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMzODQ3OA=="}, "originalCommit": null, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1MjAyMw==", "bodyText": "Thanks for (not) noticing this and letting me know.", "url": "https://github.com/trinodb/trino/pull/4473#discussion_r456352023", "createdAt": "2020-07-17T10:12:40Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/PlanOptimizers.java", "diffHunk": "@@ -460,6 +466,7 @@ public PlanOptimizers(\n                                 new ImplementIntersectAsUnion(metadata),\n                                 new ImplementExceptAsUnion(metadata))),\n                 new LimitPushDown(), // Run the LimitPushDown after flattening set operators to make it easier to do the set flattening\n+                simplifyCountOverConstantOptimizer, // Run SimplifyCountOverConstant before column pruning to ensure the aggregation pushdown to connectors.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMzODQ3OA=="}, "originalCommit": null, "originalPosition": 17}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3663, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}