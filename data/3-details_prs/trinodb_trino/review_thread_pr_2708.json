{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwMDE1ODM3", "number": 2708, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxOTo1Mzo1NlrODdG5Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMDoxMjoxOFrODdHOUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODQ4MjE0OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/server/HttpRequestSessionContext.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxOTo1Mzo1N1rOFlhZgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxOTo1Mzo1N1rOFlhZgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg4ODgzMg==", "bodyText": "Use orElseGet", "url": "https://github.com/trinodb/trino/pull/2708#discussion_r374888832", "createdAt": "2020-02-04T19:53:57Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/server/HttpRequestSessionContext.java", "diffHunk": "@@ -186,6 +171,20 @@ else if (nameParts.size() == 2) {\n         transactionId = parseTransactionId(transactionIdHeader);\n     }\n \n+    private static Identity buildSessionIdentity(Optional<Identity> authenticatedIdentity, HttpServletRequest servletRequest)\n+    {\n+        String prestoUser = trimEmptyToNull(servletRequest.getHeader(PRESTO_USER));\n+        String user = prestoUser != null ? prestoUser : authenticatedIdentity.map(Identity::getUser).orElse(null);\n+        assertRequest(user != null, \"User must be set\");\n+        return authenticatedIdentity\n+                .map(Identity::from)\n+                .map(identity -> identity.withUser(user))\n+                .orElse(Identity.forUser(user))", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODQ5NjQwOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/server/HttpRequestSessionContext.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxOTo1ODozNVrOFlhiTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxOTo1ODozNVrOFlhiTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg5MTA4Ng==", "bodyText": "Maybe collapse these to\n.map(authenticated -> Identity.from(authenticated).withUser(user))\nSo that it's more clear what's happening compared to the \"or else\" case.", "url": "https://github.com/trinodb/trino/pull/2708#discussion_r374891086", "createdAt": "2020-02-04T19:58:35Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/server/HttpRequestSessionContext.java", "diffHunk": "@@ -186,6 +171,20 @@ else if (nameParts.size() == 2) {\n         transactionId = parseTransactionId(transactionIdHeader);\n     }\n \n+    private static Identity buildSessionIdentity(Optional<Identity> authenticatedIdentity, HttpServletRequest servletRequest)\n+    {\n+        String prestoUser = trimEmptyToNull(servletRequest.getHeader(PRESTO_USER));\n+        String user = prestoUser != null ? prestoUser : authenticatedIdentity.map(Identity::getUser).orElse(null);\n+        assertRequest(user != null, \"User must be set\");\n+        return authenticatedIdentity\n+                .map(Identity::from)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODUzNjUxOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/server/security/AuthenticationFilter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMDoxMjoxOFrOFlh6_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMDoxMjoxOFrOFlh6_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg5NzQwNA==", "bodyText": "This would be easier to read if extract a variable for the new identity", "url": "https://github.com/trinodb/trino/pull/2708#discussion_r374897404", "createdAt": "2020-02-04T20:12:18Z", "author": {"login": "electrum"}, "path": "presto-main/src/main/java/io/prestosql/server/security/AuthenticationFilter.java", "diffHunk": "@@ -87,7 +87,9 @@ public void doFilter(ServletRequest servletRequest, ServletResponse servletRespo\n                 response.setContentType(PLAIN_TEXT_UTF_8.toString());\n                 return;\n             }\n-            nextFilter.doFilter(withPrincipal(request, principal), response);\n+            withAuthenticatedIdentity(nextFilter, request, response, Identity.forUser(\"<internal>\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1002, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}