{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MzEzNzYy", "number": 5870, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwNjo1NDo0OVrOE3lBhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMjowMzo0NVrOE3rPhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2NzEzNzMzOnYy", "diffSide": "RIGHT", "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoMetadata.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwNjo1NDo0OVrOHxAlSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMjowMTo1OFrOHxKP0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE1MTgxNg==", "bodyText": "The documentation in https://docs.mongodb.com/manual/reference/method/cursor.limit/#cursor.limit mentions that\n\nA limit() value of 0 (i.e. .limit(0)) is equivalent to setting no limit.\n\nIs this true for the API iterable.limit(0) being used here as well?\nGenerally speaking the engine should optimize the LIMIT 0 clause, but the mongodb behavior seems counterintuitive to me. If that is indeed the case, then should we encode/document that special case here?", "url": "https://github.com/trinodb/trino/pull/5870#discussion_r521151816", "createdAt": "2020-11-11T06:54:49Z", "author": {"login": "phd3"}, "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoMetadata.java", "diffHunk": "@@ -250,6 +252,25 @@ public ConnectorTableProperties getTableProperties(ConnectorSession session, Con\n                 localProperties.build());\n     }\n \n+    @Override\n+    public Optional<LimitApplicationResult<ConnectorTableHandle>> applyLimit(ConnectorSession session, ConnectorTableHandle table, long limit)\n+    {\n+        MongoTableHandle handle = (MongoTableHandle) table;\n+\n+        // MongoDB doesn't support limit number greater than integer max\n+        if (limit > Integer.MAX_VALUE) {\n+            return Optional.empty();\n+        }\n+\n+        if (handle.getLimit().isPresent() && handle.getLimit().getAsLong() <= limit) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI5OTcwMw==", "bodyText": "That's true. Though the situation shouldn't be happen as you know, I added following logic and a test.\n        // MongoDB cursor.limit(0) is equivalent to setting no limit\n        if (limit == 0) {\n            return Optional.empty();\n        }", "url": "https://github.com/trinodb/trino/pull/5870#discussion_r521299703", "createdAt": "2020-11-11T11:41:18Z", "author": {"login": "ebyhr"}, "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoMetadata.java", "diffHunk": "@@ -250,6 +252,25 @@ public ConnectorTableProperties getTableProperties(ConnectorSession session, Con\n                 localProperties.build());\n     }\n \n+    @Override\n+    public Optional<LimitApplicationResult<ConnectorTableHandle>> applyLimit(ConnectorSession session, ConnectorTableHandle table, long limit)\n+    {\n+        MongoTableHandle handle = (MongoTableHandle) table;\n+\n+        // MongoDB doesn't support limit number greater than integer max\n+        if (limit > Integer.MAX_VALUE) {\n+            return Optional.empty();\n+        }\n+\n+        if (handle.getLimit().isPresent() && handle.getLimit().getAsLong() <= limit) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE1MTgxNg=="}, "originalCommit": null, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxMDE2Mg==", "bodyText": "Ideally Presto will replace if it encounters a limit node with count as 0. Anyway it is good to have this check", "url": "https://github.com/trinodb/trino/pull/5870#discussion_r521310162", "createdAt": "2020-11-11T12:01:58Z", "author": {"login": "Praveen2112"}, "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoMetadata.java", "diffHunk": "@@ -250,6 +252,25 @@ public ConnectorTableProperties getTableProperties(ConnectorSession session, Con\n                 localProperties.build());\n     }\n \n+    @Override\n+    public Optional<LimitApplicationResult<ConnectorTableHandle>> applyLimit(ConnectorSession session, ConnectorTableHandle table, long limit)\n+    {\n+        MongoTableHandle handle = (MongoTableHandle) table;\n+\n+        // MongoDB doesn't support limit number greater than integer max\n+        if (limit > Integer.MAX_VALUE) {\n+            return Optional.empty();\n+        }\n+\n+        if (handle.getLimit().isPresent() && handle.getLimit().getAsLong() <= limit) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE1MTgxNg=="}, "originalCommit": null, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2ODE1NjIwOnYy", "diffSide": "RIGHT", "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoTableHandle.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMjowMzo0NVrOHxKTLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMjozNDowMlrOHxLQww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxMTAyMw==", "bodyText": "Can we maintain it as OptionalInt as we won't pushdown  limit if is beyond Integer range.", "url": "https://github.com/trinodb/trino/pull/5870#discussion_r521311023", "createdAt": "2020-11-11T12:03:45Z", "author": {"login": "Praveen2112"}, "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoTableHandle.java", "diffHunk": "@@ -29,19 +30,22 @@\n {\n     private final SchemaTableName schemaTableName;\n     private final TupleDomain<ColumnHandle> constraint;\n+    private final OptionalLong limit;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMyNjc4Nw==", "bodyText": "Updated to OptionalInt from OptionalLong.", "url": "https://github.com/trinodb/trino/pull/5870#discussion_r521326787", "createdAt": "2020-11-11T12:34:02Z", "author": {"login": "ebyhr"}, "path": "presto-mongodb/src/main/java/io/prestosql/plugin/mongodb/MongoTableHandle.java", "diffHunk": "@@ -29,19 +30,22 @@\n {\n     private final SchemaTableName schemaTableName;\n     private final TupleDomain<ColumnHandle> constraint;\n+    private final OptionalLong limit;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxMTAyMw=="}, "originalCommit": null, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4425, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}