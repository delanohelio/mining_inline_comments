{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3OTA4MjAw", "number": 5885, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNzo1NzoyN1rOE24omA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMjozMDo1MlrOE35g-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1OTg2NDU2OnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/io/prestosql/spi/type/TypeSignature.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNzo1NzoyN1rOHv6yuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODoyODoxMlrOHv757A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAwODM3Nw==", "bodyText": "There's a data race here due to lack of synchronization between these two variables. It's possible for a thread to observe hashComputed == false and hashCode being set to 0.\nThe only safe way to do this is:\nint hash = hashCode;\nif (hash == 0) {\n    hash = Objects.hash(...);\n    hashCode = hash\n}\n\nreturn hash;\n\nNote that this relies on the atomicity semantics for unsynchronized access to int fields.", "url": "https://github.com/trinodb/trino/pull/5885#discussion_r520008377", "createdAt": "2020-11-09T17:57:27Z", "author": {"login": "martint"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/TypeSignature.java", "diffHunk": "@@ -160,7 +163,13 @@ public boolean equals(Object o)\n     @Override\n     public int hashCode()\n     {\n-        return Objects.hash(base.toLowerCase(Locale.ENGLISH), parameters);\n+        if (hashComputed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyNjYwNA==", "bodyText": "Also you need to hande Objects.hash returning zero\nint hash = hashCode;\nif (hash == 0) {\n    int tempHash = Objects.hash(...);\n    if (tempHash == 0) {\n        tempHash++;\n    }\n    hashCode = hash\n}\n\nreturn hash;", "url": "https://github.com/trinodb/trino/pull/5885#discussion_r520026604", "createdAt": "2020-11-09T18:28:12Z", "author": {"login": "dain"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/TypeSignature.java", "diffHunk": "@@ -160,7 +163,13 @@ public boolean equals(Object o)\n     @Override\n     public int hashCode()\n     {\n-        return Objects.hash(base.toLowerCase(Locale.ENGLISH), parameters);\n+        if (hashComputed) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAwODM3Nw=="}, "originalCommit": null, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDQ4NTAwOnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/io/prestosql/spi/type/TypeSignature.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMjoyNzo1MlrOHxgl-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMjoyNzo1MlrOHxgl-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY3NjI4Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            hash++;\n          \n          \n            \n                            hash = 1;", "url": "https://github.com/trinodb/trino/pull/5885#discussion_r521676282", "createdAt": "2020-11-11T22:27:52Z", "author": {"login": "findepi"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/TypeSignature.java", "diffHunk": "@@ -160,7 +162,16 @@ public boolean equals(Object o)\n     @Override\n     public int hashCode()\n     {\n-        return Objects.hash(base.toLowerCase(Locale.ENGLISH), parameters);\n+        int hash = hashCode;\n+        if (hash == 0) {\n+            hash = Objects.hash(base.toLowerCase(Locale.ENGLISH), parameters);\n+            if (hash == 0) {\n+                hash++;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDQ5NDY0OnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/io/prestosql/spi/type/TypeSignature.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMjozMDo1MlrOHxgrPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMDoxMzowNFrOHzDdOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY3NzYzMQ==", "bodyText": "// Cached hash code. The class remains effectively immutable, because inputs for hash calculations are immutable.", "url": "https://github.com/trinodb/trino/pull/5885#discussion_r521677631", "createdAt": "2020-11-11T22:30:52Z", "author": {"login": "findepi"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/TypeSignature.java", "diffHunk": "@@ -36,6 +36,8 @@\n     private final List<TypeSignatureParameter> parameters;\n     private final boolean calculated;\n \n+    private int hashCode;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY3OTA4Nw==", "bodyText": "#5930", "url": "https://github.com/trinodb/trino/pull/5885#discussion_r521679087", "createdAt": "2020-11-11T22:34:34Z", "author": {"login": "findepi"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/TypeSignature.java", "diffHunk": "@@ -36,6 +36,8 @@\n     private final List<TypeSignatureParameter> parameters;\n     private final boolean calculated;\n \n+    private int hashCode;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY3NzYzMQ=="}, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI1ODgxOA==", "bodyText": "This is not accurate. The class is very much not \"effectively immutable\". The value of hashCode does change after construction and publication (it goes from 0 to some deterministically computed hashcode). It is also theoretically possible that some thread may never observe a non-zero value.\nThe trick here works because:\n\nThe value computed value is deterministic and it's derived from state that is immutable and guaranteed to be published safely\nReads/writes to int variables are guaranteed to be atomic in the JVM (unlike double or long)\nThe hashCode() method is carefully implemented to read the value of the hashCode field once and perform all its logic based on that.", "url": "https://github.com/trinodb/trino/pull/5885#discussion_r522258818", "createdAt": "2020-11-12T16:53:15Z", "author": {"login": "martint"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/TypeSignature.java", "diffHunk": "@@ -36,6 +36,8 @@\n     private final List<TypeSignatureParameter> parameters;\n     private final boolean calculated;\n \n+    private int hashCode;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY3NzYzMQ=="}, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3NzI5Mw==", "bodyText": "@martint i know. I tried to capture the gist of it, or a hint at this, in a brief comment. I don't thing going into tiny details is needed in a code comment here, but i think it's worth having something. Can you suggest a different wording for this?", "url": "https://github.com/trinodb/trino/pull/5885#discussion_r522377293", "createdAt": "2020-11-12T19:46:19Z", "author": {"login": "findepi"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/TypeSignature.java", "diffHunk": "@@ -36,6 +36,8 @@\n     private final List<TypeSignatureParameter> parameters;\n     private final boolean calculated;\n \n+    private int hashCode;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY3NzYzMQ=="}, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM4Mjk1Mg==", "bodyText": "Just added the following comment.\n// Cached hash code", "url": "https://github.com/trinodb/trino/pull/5885#discussion_r522382952", "createdAt": "2020-11-12T19:56:01Z", "author": {"login": "phd3"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/TypeSignature.java", "diffHunk": "@@ -36,6 +36,8 @@\n     private final List<TypeSignatureParameter> parameters;\n     private final boolean calculated;\n \n+    private int hashCode;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY3NzYzMQ=="}, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI5NjA1OA==", "bodyText": "Discussed offline with @findepi, merging without a comment for now to avoid confusion.", "url": "https://github.com/trinodb/trino/pull/5885#discussion_r523296058", "createdAt": "2020-11-14T00:13:04Z", "author": {"login": "phd3"}, "path": "presto-spi/src/main/java/io/prestosql/spi/type/TypeSignature.java", "diffHunk": "@@ -36,6 +36,8 @@\n     private final List<TypeSignatureParameter> parameters;\n     private final boolean calculated;\n \n+    private int hashCode;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY3NzYzMQ=="}, "originalCommit": null, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4441, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}