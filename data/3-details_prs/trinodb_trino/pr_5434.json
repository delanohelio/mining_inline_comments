{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NjA4NDA5", "number": 5434, "title": "Add dynamic filter collection time stats", "bodyText": "", "createdAt": "2020-10-06T14:53:07Z", "url": "https://github.com/trinodb/trino/pull/5434", "merged": true, "mergeCommit": {"oid": "a195f06955bef73c3f03c5fdb41c69fc2ddaf55f"}, "closed": true, "closedAt": "2020-10-07T09:03:02Z", "author": {"login": "sopel39"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP57J3ABqjM4NDYwMjk3MjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQJKiqgBqjM4NDkzOTI4OTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjQ0ODM0", "url": "https://github.com/trinodb/trino/pull/5434#pullrequestreview-503244834", "createdAt": "2020-10-06T18:25:44Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODoyNTo0NVrOHdUmeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODoyNTo0NVrOHdUmeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUwODI4MQ==", "bodyText": "Use dynamicFilterCollectionTime.get(filterId) and perform null check on that to avoid lookup in map twice", "url": "https://github.com/trinodb/trino/pull/5434#discussion_r500508281", "createdAt": "2020-10-06T18:25:45Z", "author": {"login": "raunaqmorarka"}, "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -683,6 +727,15 @@ private void stageCannotScheduleMoreTasks(StageId stageId, int numberOfTasks)\n         {\n             return replicatedDynamicFilters;\n         }\n+\n+        private Optional<Duration> getDynamicFilterCollectionDuration(DynamicFilterId filterId)\n+        {\n+            if (queryStartTime.get() == null || !dynamicFilterCollectionTime.containsKey(filterId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 165}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNjMzMTcw", "url": "https://github.com/trinodb/trino/pull/5434#pullrequestreview-503633170", "createdAt": "2020-10-07T08:19:20Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwODoxOToyMFrOHdn5zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwODoyNjo0OFrOHdoMzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgyNDUyNw==", "bodyText": "does this belong to  registerQuery overload being called above?", "url": "https://github.com/trinodb/trino/pull/5434#discussion_r500824527", "createdAt": "2020-10-07T08:19:20Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -123,6 +127,12 @@ public void registerQuery(SqlQueryExecution sqlQueryExecution, SubPlan fragmente\n                     dynamicFilters,\n                     lazyDynamicFilters,\n                     replicatedDynamicFilters);\n+\n+            sqlQueryExecution.addStateChangeListener(state -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgyNjM0OA==", "bodyText": "The query will be STARTING very soon:\nhttps://github.com/prestosql/presto/blob/a29fc64a478818c52c0714e05d24241cc6ef4464/presto-main/src/main/java/io/prestosql/execution/SqlQueryExecution.java#L376-L379\nthe callback adds complexity & theoretical uncertainty whcih i would prefer to avoid, if possible.\nwould it be still OK to start the timer immediately here?", "url": "https://github.com/trinodb/trino/pull/5434#discussion_r500826348", "createdAt": "2020-10-07T08:22:06Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -123,6 +127,12 @@ public void registerQuery(SqlQueryExecution sqlQueryExecution, SubPlan fragmente\n                     dynamicFilters,\n                     lazyDynamicFilters,\n                     replicatedDynamicFilters);\n+\n+            sqlQueryExecution.addStateChangeListener(state -> {\n+                if (state == STARTING) {\n+                    queryIsStarting(sqlQueryExecution.getQueryId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgyNzAwNg==", "bodyText": "rnn", "url": "https://github.com/trinodb/trino/pull/5434#discussion_r500827006", "createdAt": "2020-10-07T08:23:05Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -521,18 +547,21 @@ public int hashCode()\n         private final String simplifiedDomain;\n         private final int rangeCount;\n         private final int discreteValuesCount;\n+        private final Optional<Duration> collectionDuration;\n \n         @JsonCreator\n         public DynamicFilterDomainStats(\n                 @JsonProperty(\"dynamicFilterId\") DynamicFilterId dynamicFilterId,\n                 @JsonProperty(\"simplifiedDomain\") String simplifiedDomain,\n                 @JsonProperty(\"rangeCount\") int rangeCount,\n-                @JsonProperty(\"discreteValuesCount\") int discreteValuesCount)\n+                @JsonProperty(\"discreteValuesCount\") int discreteValuesCount,\n+                @JsonProperty(\"collectionDuration\") Optional<Duration> collectionDuration)\n         {\n             this.dynamicFilterId = dynamicFilterId;\n             this.simplifiedDomain = simplifiedDomain;\n             this.rangeCount = rangeCount;\n             this.discreteValuesCount = discreteValuesCount;\n+            this.collectionDuration = collectionDuration;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgyODA1NA==", "bodyText": "This has would have nice added value that the code is properly guarded even if there are map .remove calls somewhere -- now, or in the future. (there aren't today)", "url": "https://github.com/trinodb/trino/pull/5434#discussion_r500828054", "createdAt": "2020-10-07T08:24:45Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -683,6 +727,15 @@ private void stageCannotScheduleMoreTasks(StageId stageId, int numberOfTasks)\n         {\n             return replicatedDynamicFilters;\n         }\n+\n+        private Optional<Duration> getDynamicFilterCollectionDuration(DynamicFilterId filterId)\n+        {\n+            if (queryStartTime.get() == null || !dynamicFilterCollectionTime.containsKey(filterId)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUwODI4MQ=="}, "originalCommit": null, "originalPosition": 165}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgyODU4MQ==", "bodyText": "under what circumstances can queryStartTime.get() == null?", "url": "https://github.com/trinodb/trino/pull/5434#discussion_r500828581", "createdAt": "2020-10-07T08:25:28Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -683,6 +727,15 @@ private void stageCannotScheduleMoreTasks(StageId stageId, int numberOfTasks)\n         {\n             return replicatedDynamicFilters;\n         }\n+\n+        private Optional<Duration> getDynamicFilterCollectionDuration(DynamicFilterId filterId)\n+        {\n+            if (queryStartTime.get() == null || !dynamicFilterCollectionTime.containsKey(filterId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 165}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgyODg2OA==", "bodyText": "fmt: all args to new DynamicFilterDomainStats should be on the new DynamicFilterDomainStats line, or each on separate line", "url": "https://github.com/trinodb/trino/pull/5434#discussion_r500828868", "createdAt": "2020-10-07T08:25:57Z", "author": {"login": "findepi"}, "path": "presto-main/src/test/java/io/prestosql/server/TestDynamicFilterService.java", "diffHunk": "@@ -127,7 +127,7 @@ public void testDynamicFilterSummaryCompletion()\n         assertEquals(\n                 stats.getDynamicFilterDomainStats(),\n                 ImmutableList.of(new DynamicFilterDomainStats(\n-                        filterId, getExpectedDomainString(1L, 3L), 3, 0)));\n+                        filterId, getExpectedDomainString(1L, 3L), 3, 0, Optional.empty())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgyOTA2Ng==", "bodyText": "fmt: all args to new DynamicFilterDomainStats should be on the new DynamicFilterDomainStats line, or each on separate line", "url": "https://github.com/trinodb/trino/pull/5434#discussion_r500829066", "createdAt": "2020-10-07T08:26:15Z", "author": {"login": "findepi"}, "path": "presto-main/src/test/java/io/prestosql/server/TestDynamicFilterService.java", "diffHunk": "@@ -292,11 +292,11 @@ public void testDynamicFilter()\n         assertEquals(stats.getReplicatedDynamicFilters(), 0);\n         assertEquals(ImmutableSet.copyOf(stats.getDynamicFilterDomainStats()), ImmutableSet.of(\n                 new DynamicFilterDomainStats(\n-                        filterId1, getExpectedDomainString(1L, 2L), 2, 0),\n+                        filterId1, getExpectedDomainString(1L, 2L), 2, 0, Optional.empty()),\n                 new DynamicFilterDomainStats(\n-                        filterId2, getExpectedDomainString(2L, 3L), 2, 0),\n+                        filterId2, getExpectedDomainString(2L, 3L), 2, 0, Optional.empty()),\n                 new DynamicFilterDomainStats(\n-                        filterId3, Domain.none(INTEGER).toString(session.toConnectorSession()), 0, 0)));\n+                        filterId3, Domain.none(INTEGER).toString(session.toConnectorSession()), 0, 0, Optional.empty())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgyOTM5MA==", "bodyText": "verify(queryStartTime.get() == 0, \"queryStartTime already set\");", "url": "https://github.com/trinodb/trino/pull/5434#discussion_r500829390", "createdAt": "2020-10-07T08:26:48Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -669,6 +708,11 @@ private void stageCannotScheduleMoreTasks(StageId stageId, int numberOfTasks)\n             stageNumberOfTasks.put(stageId, numberOfTasks);\n         }\n \n+        private void queryIsStarting()\n+        {\n+            queryStartTime.set(System.nanoTime());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 152}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a3cd2f03b3dee547eca43f2072fe96ff395654b", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/6a3cd2f03b3dee547eca43f2072fe96ff395654b", "committedDate": "2020-10-07T08:57:57Z", "message": "Add dynamic filter collection time stats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38573d2814314ea83856952107c0fc8cea7ce676", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/38573d2814314ea83856952107c0fc8cea7ce676", "committedDate": "2020-10-07T08:57:57Z", "message": "Use requireNonNull"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97312764d7946cd16aadcaf530502f033235299e", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/97312764d7946cd16aadcaf530502f033235299e", "committedDate": "2020-10-07T09:00:10Z", "message": "Fix formatting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "97312764d7946cd16aadcaf530502f033235299e", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/97312764d7946cd16aadcaf530502f033235299e", "committedDate": "2020-10-07T09:00:10Z", "message": "Fix formatting"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3289, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}