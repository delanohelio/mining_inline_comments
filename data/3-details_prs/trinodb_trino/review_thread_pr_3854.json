{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMTc5ODYx", "number": 3854, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzo0Njo0N1rOD_rlFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMzoyNToyOVrOEAgYew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MTAwODg2OnYy", "diffSide": "RIGHT", "path": "presto-testing/src/main/java/io/prestosql/testing/datatype/DataType.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzo0Njo0N1rOGafBmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzo0Njo0N1rOGafBmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQyNDQ3NA==", "bodyText": "It was intentionally private because of its implicit use of Object::toString.\nif someone wants this semantics, they should choose them explicitly, using the dataType(String insertType, Type prestoResultType, Function<T, String> toLiteral) overload.", "url": "https://github.com/trinodb/trino/pull/3854#discussion_r430424474", "createdAt": "2020-05-26T13:46:47Z", "author": {"login": "findepi"}, "path": "presto-testing/src/main/java/io/prestosql/testing/datatype/DataType.java", "diffHunk": "@@ -197,11 +215,16 @@ public static String binaryLiteral(byte[] value)\n         return \"X'\" + base16().encode(value) + \"'\";\n     }\n \n-    private static <T> DataType<T> dataType(String insertType, Type prestoResultType)\n+    public static <T> DataType<T> dataType(String insertType, Type prestoResultType)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MTAyMTYxOnYy", "diffSide": "RIGHT", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzo0OTozMFrOGafJeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzo0OTozMFrOGafJeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQyNjQ5MA==", "bodyText": "i would divide this across type boundaries instead\n    @Test\n    public void testDouble()\n    {\n        doublePrecisionFloatinPointTests(doubleDataType())\n                .execute(getQueryRunner(), prestoCreateAsSelect(\"presto_test_double\"));\n\n        doublePrecisionFloatinPointTests(postgreSqlDoubleDataType())\n                .execute(getQueryRunner(), postgresCreateAndInsert(\"presto_test_double\"));\n    }", "url": "https://github.com/trinodb/trino/pull/3854#discussion_r430426490", "createdAt": "2020-05-26T13:49:30Z", "author": {"login": "findepi"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "diffHunk": "@@ -1259,6 +1261,44 @@ public void testMoney()\n                 .execute(getQueryRunner(), postgresCreateAndInsert(\"tpch.presto_test_money\"));\n     }\n \n+    @Test\n+    public void testPrestoCreatedFloatingPoint()\n+    {\n+        singlePrecisionFloatingPointTests(realDataType())\n+                .execute(getQueryRunner(), prestoCreateAsSelect(\"presto_test_float\"));\n+        doublePrecisionFloatinPointTests(doubleDataType())\n+                .execute(getQueryRunner(), prestoCreateAsSelect(\"presto_test_double\"));\n+    }\n+\n+    @Test\n+    public void testPostgresCreatedFloatingPoint()\n+    {\n+        singlePrecisionFloatingPointTests(postgreSqlRealDataType())\n+                .execute(getQueryRunner(), postgresCreateAndInsert(\"tpch.postgresql_test_float\"));\n+        doublePrecisionFloatinPointTests(postgreSqlDoubleDataType())\n+                .execute(getQueryRunner(), postgresCreateAndInsert(\"tpch.postgresql_test_double\"));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MTAyOTY2OnYy", "diffSide": "RIGHT", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzo1MTowN1rOGafOgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMTo1NjoyOFrOGbF2aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQyNzc3Ng==", "bodyText": "You could reuse io.prestosql.testing.datatype.DataType#doubleDataType, if you avoid nan/infinity \"constants\":\nif (Double.isNaN(value)) {\n    return \"0 / 0\";\n}\nreturn format(\"%s1 / 0\", value > 0 ? \"+\" : \"-\");\n\n(up to you)", "url": "https://github.com/trinodb/trino/pull/3854#discussion_r430427776", "createdAt": "2020-05-26T13:51:07Z", "author": {"login": "findepi"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "diffHunk": "@@ -1491,4 +1531,32 @@ private static void checkIsDoubled(ZoneId zone, LocalDateTime dateTime)\n     {\n         verify(zone.getRules().getValidOffsets(dateTime).size() == 2, \"Expected %s to be doubled in %s\", dateTime, zone);\n     }\n+\n+    public static DataType<Float> postgreSqlRealDataType()\n+    {\n+        return dataType(\"real\", RealType.REAL,\n+                value -> {\n+                    if (Float.isFinite(value)) {\n+                        return value.toString();\n+                    }\n+                    if (Float.isNaN(value)) {\n+                        return \"'NaN'\";\n+                    }\n+                    return format(\"'%sInfinity'\", value > 0 ? \"+\" : \"-\");\n+                });\n+    }\n+\n+    public static DataType<Double> postgreSqlDoubleDataType()\n+    {\n+        return dataType(\"double precision\", DoubleType.DOUBLE,\n+                value -> {\n+                    if (Double.isFinite(value)) {\n+                        return value.toString();\n+                    }\n+                    if (Double.isNaN(value)) {\n+                        return \"'NaN'\";\n+                    }\n+                    return format(\"'%sInfinity'\", value > 0 ? \"+\" : \"-\");\n+                });", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA2MDU4Nw==", "bodyText": "Would work I guess. I like the constants though. More readable IMO.", "url": "https://github.com/trinodb/trino/pull/3854#discussion_r431060587", "createdAt": "2020-05-27T11:56:28Z", "author": {"login": "losipiuk"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "diffHunk": "@@ -1491,4 +1531,32 @@ private static void checkIsDoubled(ZoneId zone, LocalDateTime dateTime)\n     {\n         verify(zone.getRules().getValidOffsets(dateTime).size() == 2, \"Expected %s to be doubled in %s\", dateTime, zone);\n     }\n+\n+    public static DataType<Float> postgreSqlRealDataType()\n+    {\n+        return dataType(\"real\", RealType.REAL,\n+                value -> {\n+                    if (Float.isFinite(value)) {\n+                        return value.toString();\n+                    }\n+                    if (Float.isNaN(value)) {\n+                        return \"'NaN'\";\n+                    }\n+                    return format(\"'%sInfinity'\", value > 0 ? \"+\" : \"-\");\n+                });\n+    }\n+\n+    public static DataType<Double> postgreSqlDoubleDataType()\n+    {\n+        return dataType(\"double precision\", DoubleType.DOUBLE,\n+                value -> {\n+                    if (Double.isFinite(value)) {\n+                        return value.toString();\n+                    }\n+                    if (Double.isNaN(value)) {\n+                        return \"'NaN'\";\n+                    }\n+                    return format(\"'%sInfinity'\", value > 0 ? \"+\" : \"-\");\n+                });", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQyNzc3Ng=="}, "originalCommit": null, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MTAzNzI2OnYy", "diffSide": "RIGHT", "path": "presto-mysql/src/test/java/io/prestosql/plugin/mysql/TestMySqlTypeMapping.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzo1Mjo0M1rOGafTOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMjo0OToyN1rOGbHtHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQyODk4NQ==", "bodyText": "Wow... Does the user get reasonable exception message?", "url": "https://github.com/trinodb/trino/pull/3854#discussion_r430428985", "createdAt": "2020-05-26T13:52:43Z", "author": {"login": "findepi"}, "path": "presto-mysql/src/test/java/io/prestosql/plugin/mysql/TestMySqlTypeMapping.java", "diffHunk": "@@ -464,6 +466,40 @@ private DataTypeTest jsonTestCases(DataType<String> jsonDataType)\n                 .addRoundTrip(jsonDataType, \"[]\");\n     }\n \n+    @Test\n+    public void testPrestoCreatedFloatingPoint()\n+    {\n+        singlePrecisionFloatingPointTests(realDataType())\n+                .execute(getQueryRunner(), prestoCreateAsSelect(\"presto_test_float\"));\n+        doublePrecisionFloatinPointTests(doubleDataType())\n+                .execute(getQueryRunner(), prestoCreateAsSelect(\"presto_test_double\"));\n+    }\n+\n+    @Test\n+    public void testMysqlCreatedFloatingPoint()\n+    {\n+        singlePrecisionFloatingPointTests(mysqlFloatDataType())\n+                .execute(getQueryRunner(), mysqlCreateAndInsert(\"tpch.mysql_test_float\"));\n+        doublePrecisionFloatinPointTests(mysqlDoubleDataType())\n+                .execute(getQueryRunner(), mysqlCreateAndInsert(\"tpch.mysql_test_double\"));\n+    }\n+\n+    private static DataTypeTest singlePrecisionFloatingPointTests(DataType<Float> floatType)\n+    {\n+        // we are not testing Nan/-Infinity/+Infinity as those are not supported by MySQL", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA5MDk3Mw==", "bodyText": "I mysql CLI you get:\n\nIf you try to put NaN as a value via MySQL JDBC you get java.sql.SQLException: 'NaN' is not a valid numeric or approximate numeric value", "url": "https://github.com/trinodb/trino/pull/3854#discussion_r431090973", "createdAt": "2020-05-27T12:49:27Z", "author": {"login": "losipiuk"}, "path": "presto-mysql/src/test/java/io/prestosql/plugin/mysql/TestMySqlTypeMapping.java", "diffHunk": "@@ -464,6 +466,40 @@ private DataTypeTest jsonTestCases(DataType<String> jsonDataType)\n                 .addRoundTrip(jsonDataType, \"[]\");\n     }\n \n+    @Test\n+    public void testPrestoCreatedFloatingPoint()\n+    {\n+        singlePrecisionFloatingPointTests(realDataType())\n+                .execute(getQueryRunner(), prestoCreateAsSelect(\"presto_test_float\"));\n+        doublePrecisionFloatinPointTests(doubleDataType())\n+                .execute(getQueryRunner(), prestoCreateAsSelect(\"presto_test_double\"));\n+    }\n+\n+    @Test\n+    public void testMysqlCreatedFloatingPoint()\n+    {\n+        singlePrecisionFloatingPointTests(mysqlFloatDataType())\n+                .execute(getQueryRunner(), mysqlCreateAndInsert(\"tpch.mysql_test_float\"));\n+        doublePrecisionFloatinPointTests(mysqlDoubleDataType())\n+                .execute(getQueryRunner(), mysqlCreateAndInsert(\"tpch.mysql_test_double\"));\n+    }\n+\n+    private static DataTypeTest singlePrecisionFloatingPointTests(DataType<Float> floatType)\n+    {\n+        // we are not testing Nan/-Infinity/+Infinity as those are not supported by MySQL", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQyODk4NQ=="}, "originalCommit": null, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4OTY1MTQ5OnYy", "diffSide": "RIGHT", "path": "presto-testing/src/main/java/io/prestosql/testing/datatype/DataType.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMzoyMzoyNVrOGb02gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMTowMTo1N1rOGcYSdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgzMDY1OQ==", "bodyText": "Adding this overload may let you simplify call sites to the existing, 4-arg overload.", "url": "https://github.com/trinodb/trino/pull/3854#discussion_r431830659", "createdAt": "2020-05-28T13:23:25Z", "author": {"login": "findepi"}, "path": "presto-testing/src/main/java/io/prestosql/testing/datatype/DataType.java", "diffHunk": "@@ -202,6 +220,11 @@ public static String binaryLiteral(byte[] value)\n         return new DataType<>(insertType, prestoResultType, Object::toString, Function.identity());\n     }\n \n+    public static <T> DataType<T> dataType(String insertType, Type prestoResultType, Function<T, String> toLiteral)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQxMTI1Mg==", "bodyText": "for a followup", "url": "https://github.com/trinodb/trino/pull/3854#discussion_r432411252", "createdAt": "2020-05-29T11:01:57Z", "author": {"login": "losipiuk"}, "path": "presto-testing/src/main/java/io/prestosql/testing/datatype/DataType.java", "diffHunk": "@@ -202,6 +220,11 @@ public static String binaryLiteral(byte[] value)\n         return new DataType<>(insertType, prestoResultType, Object::toString, Function.identity());\n     }\n \n+    public static <T> DataType<T> dataType(String insertType, Type prestoResultType, Function<T, String> toLiteral)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgzMDY1OQ=="}, "originalCommit": null, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4OTY1Njc2OnYy", "diffSide": "RIGHT", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMzoyNDozOFrOGb05xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMzoyNDozOFrOGb05xA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgzMTQ5Mg==", "bodyText": "add a test exhausting precision of a float (~7 digits), to detect potential over-eager rounding", "url": "https://github.com/trinodb/trino/pull/3854#discussion_r431831492", "createdAt": "2020-05-28T13:24:38Z", "author": {"login": "findepi"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "diffHunk": "@@ -1259,6 +1261,46 @@ public void testMoney()\n                 .execute(getQueryRunner(), postgresCreateAndInsert(\"tpch.presto_test_money\"));\n     }\n \n+    @Test\n+    public void testReal()\n+    {\n+        singlePrecisionFloatingPointTests(realDataType())\n+                .execute(getQueryRunner(), prestoCreateAsSelect(\"presto_test_real\"));\n+\n+        singlePrecisionFloatingPointTests(postgreSqlRealDataType())\n+                .execute(getQueryRunner(), postgresCreateAndInsert(\"tpch.postgresql_test_real\"));\n+    }\n+\n+    @Test\n+    public void testDouble()\n+    {\n+        doublePrecisionFloatinPointTests(doubleDataType())\n+                .execute(getQueryRunner(), prestoCreateAsSelect(\"presto_test_double\"));\n+\n+        doublePrecisionFloatinPointTests(postgreSqlDoubleDataType())\n+                .execute(getQueryRunner(), postgresCreateAndInsert(\"tpch.postgresql_test_double\"));\n+    }\n+\n+    private static DataTypeTest singlePrecisionFloatingPointTests(DataType<Float> floatType)\n+    {\n+        return DataTypeTest.create()\n+                .addRoundTrip(floatType, 123.45f)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4OTY2MDExOnYy", "diffSide": "RIGHT", "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMzoyNToyOVrOGb078g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMzoyNToyOVrOGb078g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgzMjA1MA==", "bodyText": "a varchar?\nor \"'NaN'::double\"?", "url": "https://github.com/trinodb/trino/pull/3854#discussion_r431832050", "createdAt": "2020-05-28T13:25:29Z", "author": {"login": "findepi"}, "path": "presto-postgresql/src/test/java/io/prestosql/plugin/postgresql/TestPostgreSqlTypeMapping.java", "diffHunk": "@@ -1491,4 +1533,32 @@ private static void checkIsDoubled(ZoneId zone, LocalDateTime dateTime)\n     {\n         verify(zone.getRules().getValidOffsets(dateTime).size() == 2, \"Expected %s to be doubled in %s\", dateTime, zone);\n     }\n+\n+    private static DataType<Float> postgreSqlRealDataType()\n+    {\n+        return dataType(\"real\", RealType.REAL,\n+                value -> {\n+                    if (Float.isFinite(value)) {\n+                        return value.toString();\n+                    }\n+                    if (Float.isNaN(value)) {\n+                        return \"'NaN'\";\n+                    }\n+                    return format(\"'%sInfinity'\", value > 0 ? \"+\" : \"-\");\n+                });\n+    }\n+\n+    private static DataType<Double> postgreSqlDoubleDataType()\n+    {\n+        return dataType(\"double precision\", DoubleType.DOUBLE,\n+                value -> {\n+                    if (Double.isFinite(value)) {\n+                        return value.toString();\n+                    }\n+                    if (Double.isNaN(value)) {\n+                        return \"'NaN'\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 83}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4955, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}