{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2OTQ4MTk3", "number": 3302, "title": "Add updateType to query event ", "bodyText": "", "createdAt": "2020-04-01T11:56:47Z", "url": "https://github.com/trinodb/trino/pull/3302", "merged": true, "mergeCommit": {"oid": "f12c107d147307b0b6110fb64f579fcc7d55ee13"}, "closed": true, "closedAt": "2020-04-03T12:45:52Z", "author": {"login": "kokosing"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTWbvHgFqTM4NTUxNDc2Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcT_JimgBqjMxOTU5ODgxMzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NTE0NzYy", "url": "https://github.com/trinodb/trino/pull/3302#pullrequestreview-385514762", "createdAt": "2020-04-01T11:58:47Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMTo1ODo0N1rOF-9SoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMTo1ODo0N1rOF-9SoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU2MDIyNA==", "bodyText": "\"ADD COLUMN\" update type is also configured from io.prestosql.execution.DataDefinitionTask#getName also", "url": "https://github.com/trinodb/trino/pull/3302#discussion_r401560224", "createdAt": "2020-04-01T11:58:47Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/StatementAnalyzer.java", "diffHunk": "@@ -682,37 +683,43 @@ protected Scope visitResetSession(ResetSession node, Optional<Scope> scope)\n         @Override\n         protected Scope visitAddColumn(AddColumn node, Optional<Scope> scope)\n         {\n+            analysis.setUpdateType(\"ADD COLUMN\", createQualifiedObjectName(session, node, node.getName()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1ODI5Mzg4", "url": "https://github.com/trinodb/trino/pull/3302#pullrequestreview-385829388", "createdAt": "2020-04-01T18:09:46Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxODowOTo0NlrOF_MnVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxODoxMzoyMVrOF_MvAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgxMTI4NA==", "bodyText": "What's the purpose of this rename? I don't see the benefit in changing it.", "url": "https://github.com/trinodb/trino/pull/3302#discussion_r401811284", "createdAt": "2020-04-01T18:09:46Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/OutputTable.java", "diffHunk": "@@ -23,14 +23,14 @@\n import static java.util.Objects.requireNonNull;\n \n @Immutable\n-public final class Output\n+public final class OutputTable", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgxMjY2Mg==", "bodyText": "What's \"target\" table? That's supposed to be what \"output\" captures (in QueryOutputMetadata)", "url": "https://github.com/trinodb/trino/pull/3302#discussion_r401812662", "createdAt": "2020-04-01T18:12:20Z", "author": {"login": "martint"}, "path": "presto-spi/src/main/java/io/prestosql/spi/eventlistener/QueryMetadata.java", "diffHunk": "@@ -47,6 +50,7 @@ public QueryMetadata(\n             Optional<String> queryType,\n             Optional<String> preparedQuery,\n             String queryState,\n+            Optional<CatalogSchemaTableName> targetTable,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgxMzI0OQ==", "bodyText": "This is already captured in Output.", "url": "https://github.com/trinodb/trino/pull/3302#discussion_r401813249", "createdAt": "2020-04-01T18:13:21Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/execution/QueryInfo.java", "diffHunk": "@@ -108,6 +110,7 @@ public QueryInfo(\n             @JsonProperty(\"errorCode\") ErrorCode errorCode,\n             @JsonProperty(\"warnings\") List<PrestoWarning> warnings,\n             @JsonProperty(\"inputs\") Set<Input> inputs,\n+            @JsonProperty(\"outputSchema\") Optional<CatalogSchemaName> outputSchema,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MjU4MDYx", "url": "https://github.com/trinodb/trino/pull/3302#pullrequestreview-386258061", "createdAt": "2020-04-02T09:33:20Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwOTozMzoyMFrOF_jDkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwOTozODoyN1rOF_jPjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3ODk2MQ==", "bodyText": "msg mismatch (watch out when renaming)", "url": "https://github.com/trinodb/trino/pull/3302#discussion_r402178961", "createdAt": "2020-04-02T09:33:20Z", "author": {"login": "findepi"}, "path": "presto-spi/src/main/java/io/prestosql/spi/eventlistener/QueryMetadata.java", "diffHunk": "@@ -54,6 +56,7 @@ public QueryMetadata(\n         this.queryId = requireNonNull(queryId, \"queryId is null\");\n         this.transactionId = requireNonNull(transactionId, \"transactionId is null\");\n         this.query = requireNonNull(query, \"query is null\");\n+        this.queryType = requireNonNull(queryType, \"updateType is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4MjAzMA==", "bodyText": "-> updateType", "url": "https://github.com/trinodb/trino/pull/3302#discussion_r402182030", "createdAt": "2020-04-02T09:38:27Z", "author": {"login": "findepi"}, "path": "presto-spi/src/main/java/io/prestosql/spi/eventlistener/QueryMetadata.java", "diffHunk": "@@ -43,6 +44,7 @@ public QueryMetadata(\n             String queryId,\n             Optional<String> transactionId,\n             String query,\n+            Optional<String> queryType,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NjA0NzE1", "url": "https://github.com/trinodb/trino/pull/3302#pullrequestreview-386604715", "createdAt": "2020-04-02T16:40:37Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNjo0MDozN1rOF_z5Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNjo0Njo0NVrOF_0I0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ1NDc5MQ==", "bodyText": "Actually, the class should be private since it's an implementation detail of QueryStateMachine, and its methods should be public.", "url": "https://github.com/trinodb/trino/pull/3302#discussion_r402454791", "createdAt": "2020-04-02T16:40:37Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/execution/QueryStateMachine.java", "diffHunk": "@@ -1127,12 +1127,12 @@ private static QueryStats pruneQueryStats(QueryStats queryStats)\n         @GuardedBy(\"this\")\n         private boolean noMoreExchangeLocations;\n \n-        public QueryOutputManager(Executor executor)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ1ODQ4MA==", "bodyText": "Same as above. The class is private, but its methods are part of the public interface of the PlanRoot class, so they should remain public.\nThe litmus test for this is: what if you wanted to move the class one level up? Aside from changing the class visibility modifier, it should just work.", "url": "https://github.com/trinodb/trino/pull/3302#discussion_r402458480", "createdAt": "2020-04-02T16:46:11Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/execution/SqlQueryExecution.java", "diffHunk": "@@ -604,7 +604,7 @@ private boolean shouldWaitForMinWorkers(Statement statement)\n         private final SubPlan root;\n         private final boolean summarizeTaskInfos;\n \n-        public PlanRoot(SubPlan root, boolean summarizeTaskInfos)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ1ODgzMw==", "bodyText": "Same comment as above", "url": "https://github.com/trinodb/trino/pull/3302#discussion_r402458833", "createdAt": "2020-04-02T16:46:45Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/StatementAnalyzer.java", "diffHunk": "@@ -1766,7 +1766,7 @@ else if (column.getExpression() instanceof Identifier) {\n         {\n             private final Multimap<QualifiedName, Expression> assignments;\n \n-            public OrderByExpressionRewriter(Multimap<QualifiedName, Expression> assignments)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fe9daac0e339fca60de4c9da8b111b7fcba638b", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/5fe9daac0e339fca60de4c9da8b111b7fcba638b", "committedDate": "2020-04-03T10:38:06Z", "message": "Remove unused method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6e1630f7dba5d91cbdcabc99d12c07a7e2c08de", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/d6e1630f7dba5d91cbdcabc99d12c07a7e2c08de", "committedDate": "2020-04-03T10:38:06Z", "message": "Remove unused tableHandles field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72abec95585813a69e5167cfb9f3803a05e19ae4", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/72abec95585813a69e5167cfb9f3803a05e19ae4", "committedDate": "2020-04-03T10:38:06Z", "message": "Add updateType to query event\n\nThanks to that event listener will know if query was SELECT, DELETE\nor any other DDL statement."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "72abec95585813a69e5167cfb9f3803a05e19ae4", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/72abec95585813a69e5167cfb9f3803a05e19ae4", "committedDate": "2020-04-03T10:38:06Z", "message": "Add updateType to query event\n\nThanks to that event listener will know if query was SELECT, DELETE\nor any other DDL statement."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1698, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}