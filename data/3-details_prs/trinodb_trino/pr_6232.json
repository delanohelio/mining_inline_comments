{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzOTEyNTky", "number": 6232, "title": "Allow returning custom metrics from ConnectorPageSource", "bodyText": "We suggest the following simple mechanism for returning and aggregating custom per-query metrics from each page source:\nhttps://github.com/prestosql/presto/compare/master...rzeyde-varada:custom-metrics?expand=1#diff-1b3e5d066c2bad4b806846b761b9d68526c7abb942df89f1b6b92a8e76fe2948\nFor simplicity, each ConnectorPageSource returns a single mapping from strings to longs, and the engine aggregates them across all splits. This allows the connectors to expose various \"low-level\" counters without changing modifying the engine code (to return them via OperatorStats).\nI would be happy to hear your opinion about this feature - any comments/questions/suggestions are welcome :)", "createdAt": "2020-12-07T19:58:01Z", "url": "https://github.com/trinodb/trino/pull/6232", "merged": true, "mergeCommit": {"oid": "60f66d8f2c8cd440b0a301d1e988213254f7dc8d"}, "closed": true, "closedAt": "2021-07-02T04:17:31Z", "author": {"login": "rzeyde-varada"}, "timelineItems": {"totalCount": 35, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkdYo0AFqTU0ODEwMjk3Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABeuyntiAFqTcxNjgzNTc3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MTAyOTcz", "url": "https://github.com/trinodb/trino/pull/6232#pullrequestreview-548102973", "createdAt": "2020-12-09T11:47:44Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMTo0Nzo0NFrOICQmeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMTo1MTo1MFrOICQwtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI0MDA1OA==", "bodyText": "this object should be immutable", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r539240058", "createdAt": "2020-12-09T11:47:44Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/operator/CustomMetrics.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.operator;\n+\n+import com.google.common.collect.ImmutableMap;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class CustomMetrics", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI0MDE1NA==", "bodyText": "this should return new object", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r539240154", "createdAt": "2020-12-09T11:47:52Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/operator/CustomMetrics.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.operator;\n+\n+import com.google.common.collect.ImmutableMap;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class CustomMetrics\n+{\n+    private Map<String, Long> metrics;\n+\n+    public CustomMetrics()\n+    {\n+        metrics = new HashMap<>();\n+    }\n+\n+    public synchronized void set(Map<String, Long> metrics)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI0MjE5Mw==", "bodyText": "ImmutableMap.of()", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r539242193", "createdAt": "2020-12-09T11:51:07Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/operator/ScanFilterAndProjectOperator.java", "diffHunk": "@@ -76,6 +77,7 @@\n     private long physicalBytes;\n     private long readTimeNanos;\n     private long dynamicFilterSplitsProcessed;\n+    private Map<String, Long> customMetrics = Map.of();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI0MjY3OQ==", "bodyText": "use correct javadoc formatting", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r539242679", "createdAt": "2020-12-09T11:51:50Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/operator/OperatorContext.java", "diffHunk": "@@ -218,6 +220,14 @@ public void recordDynamicFilterSplitProcessed(long dynamicFilterSplits)\n         dynamicFilterSplitsProcessed.getAndAdd(dynamicFilterSplits);\n     }\n \n+    /** Overwrites the metrics with the latest one.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjUwNzAzOTI2", "url": "https://github.com/trinodb/trino/pull/6232#pullrequestreview-650703926", "createdAt": "2021-05-03T20:38:18Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0wM1QyMDozODoxOFrOJUYgBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0wM1QyMTozNTo1MFrOJUaXsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM1MjcxMQ==", "bodyText": "This seems unnecessary. There's a more flexible implementation in airlift that doesn't require knowing the buckets and boundaries in advance: https://github.com/airlift/airlift/blob/master/stats/src/main/java/io/airlift/stats/TDigest.java", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625352711", "createdAt": "2021-05-03T20:38:18Z", "author": {"login": "martint"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Histogram.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.Arrays;\n+\n+public class Histogram", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM1MzAxMw==", "bodyText": "This should just be called \"Count\"", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625353013", "createdAt": "2021-05-03T20:38:49Z", "author": {"login": "martint"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/LongSumValue.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class LongSumValue", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM1MzA3OQ==", "bodyText": "use primitive long", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625353079", "createdAt": "2021-05-03T20:38:57Z", "author": {"login": "martint"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/LongSumValue.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class LongSumValue\n+        implements Metric\n+{\n+    private final Long value;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM2MDcwMw==", "bodyText": "I would just call this Metrics, since it should evolve to tracking all metrics exposed by operators", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625360703", "createdAt": "2021-05-03T20:52:30Z", "author": {"login": "martint"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/CustomMetrics.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class CustomMetrics", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM2MjU0Nw==", "bodyText": "Use Map<String, Metric> for the variable declaration", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625362547", "createdAt": "2021-05-03T20:55:50Z", "author": {"login": "martint"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/CustomMetrics.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class CustomMetrics\n+{\n+    public static final CustomMetrics EMPTY = new CustomMetrics();\n+\n+    private final Map<String, Metric> map;\n+\n+    public CustomMetrics(Map<String, Metric>... maps)\n+    {\n+        this(Arrays.asList(maps));\n+    }\n+\n+    public CustomMetrics(Iterable<Map<String, Metric>> maps)\n+    {\n+        HashMap<String, Metric> aggregation = new HashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM2NDA4Mg==", "bodyText": "This should be called getConnectorMetrics(). In the future, we'll likely want to expose operator-specific metrics, which should be namespaced separately from those exposed by the connector.", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625364082", "createdAt": "2021-05-03T20:58:42Z", "author": {"login": "martint"}, "path": "core/trino-main/src/main/java/io/trino/operator/ScanFilterAndProjectOperator.java", "diffHunk": "@@ -157,6 +159,12 @@ public long getDynamicFilterSplitsProcessed()\n         return dynamicFilterSplitsProcessed;\n     }\n \n+    @Override\n+    public CustomMetrics getCustomMetrics()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM3MTI0Mw==", "bodyText": "Call this getMetrics().\nAlso, it needs to document the semantics of the returned metrics -- i.e., they are a new snapshot of the metrics, metrics need to be immutable, etc.", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625371243", "createdAt": "2021-05-03T21:12:09Z", "author": {"login": "martint"}, "path": "core/trino-spi/src/main/java/io/trino/spi/connector/ConnectorPageSource.java", "diffHunk": "@@ -70,4 +72,9 @@ void close()\n     {\n         return NOT_BLOCKED;\n     }\n+\n+    default Map<String, Metric> getCustomMetrics()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM3MjA4NQ==", "bodyText": "What's the use case for taking multiple maps?", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625372085", "createdAt": "2021-05-03T21:13:39Z", "author": {"login": "martint"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/CustomMetrics.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class CustomMetrics\n+{\n+    public static final CustomMetrics EMPTY = new CustomMetrics();\n+\n+    private final Map<String, Metric> map;\n+\n+    public CustomMetrics(Map<String, Metric>... maps)\n+    {\n+        this(Arrays.asList(maps));\n+    }\n+\n+    public CustomMetrics(Iterable<Map<String, Metric>> maps)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTM4MzM0NQ==", "bodyText": "Take a look at io.trino.util.Mergeable and implementations of that. We may want to do something similar. Or move Mergeable to the SPI for use in these.", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r625383345", "createdAt": "2021-05-03T21:35:50Z", "author": {"login": "martint"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/LongSumValue.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class LongSumValue\n+        implements Metric\n+{\n+    private final Long value;\n+\n+    @JsonCreator\n+    public LongSumValue(long value)\n+    {\n+        this.value = value;\n+    }\n+\n+    @JsonProperty(\"value\")\n+    public long getValue()\n+    {\n+        return value;\n+    }\n+\n+    @Override\n+    public Metric merge(Metric other)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "d39b4d0bb67dfeb52ae55e67f5ed2fc09c44231f", "author": {"user": {"login": "rzeyde-varada", "name": "Roman Z"}}, "url": "https://github.com/trinodb/trino/commit/d39b4d0bb67dfeb52ae55e67f5ed2fc09c44231f", "committedDate": "2021-05-06T11:24:22Z", "message": "Allow exposing custom metrics from the connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d39b4d0bb67dfeb52ae55e67f5ed2fc09c44231f", "author": {"user": {"login": "rzeyde-varada", "name": "Roman Z"}}, "url": "https://github.com/trinodb/trino/commit/d39b4d0bb67dfeb52ae55e67f5ed2fc09c44231f", "committedDate": "2021-05-06T11:24:22Z", "message": "Allow exposing custom metrics from the connector"}, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjYzMjkwNDEw", "url": "https://github.com/trinodb/trino/pull/6232#pullrequestreview-663290410", "createdAt": "2021-05-19T14:34:41Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0xOVQxNDozNDo0MVrOJd311A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0xOVQxNTo0MjoxNFrOJd7ptA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMwMzM4MA==", "bodyText": "I don't see equals overridden for Metrics, is this meant to be a ref comparison only ? Might be clearer to use != in that case", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635303380", "createdAt": "2021-05-19T14:34:41Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-main/src/main/java/io/trino/operator/WorkProcessorSourceOperatorAdapter.java", "diffHunk": "@@ -228,6 +232,11 @@ private void updateOperatorStats()\n             operatorContext.recordDynamicFilterSplitProcessed(currentDynamicFilterSplitsProcessed - previousDynamicFilterSplitsProcessed);\n             previousDynamicFilterSplitsProcessed = currentDynamicFilterSplitsProcessed;\n         }\n+\n+        if (!currentMetrics.equals(previousMetrics)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMwNjkwMw==", "bodyText": "new HashMap<>()", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635306903", "createdAt": "2021-05-19T14:38:20Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> map;\n+\n+    public Metrics(Map<String, Metric> map)\n+    {\n+        this.map = Map.copyOf(requireNonNull(map, \"map is null\"));\n+    }\n+\n+    public static Metrics merge(Iterable<Map<String, Metric>> maps)\n+    {\n+        Map<String, Metric> merged = new HashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMxMTkxOA==", "bodyText": "maps.forEach(map ->\n                map.forEach((key, value) ->\n                        merged.merge(key, value, Metrics::mergeInternal)));", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635311918", "createdAt": "2021-05-19T14:43:33Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> map;\n+\n+    public Metrics(Map<String, Metric> map)\n+    {\n+        this.map = Map.copyOf(requireNonNull(map, \"map is null\"));\n+    }\n+\n+    public static Metrics merge(Iterable<Map<String, Metric>> maps)\n+    {\n+        Map<String, Metric> merged = new HashMap();\n+        maps.forEach(map -> map\n+                .entrySet()\n+                .stream()\n+                .forEach(entry -> merged.merge(\n+                        entry.getKey(),\n+                        entry.getValue(),\n+                        (left, right) -> mergeInternal(left, right))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMxOTMzNg==", "bodyText": "Why do we have Metric interface ?\nIt seems it must implement Mergeable to be usable.\nCould we just use Mergeable or have Metric extend Mergeable ?", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635319336", "createdAt": "2021-05-19T14:51:15Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> map;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMxOTQ5OA==", "bodyText": "map -> metrics", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635319498", "createdAt": "2021-05-19T14:51:26Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> map;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTMzOTgzNg==", "bodyText": "requireNonNull", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635339836", "createdAt": "2021-05-19T15:13:15Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-main/src/main/java/io/trino/operator/OperatorStats.java", "diffHunk": "@@ -169,6 +176,7 @@ public OperatorStats(\n         this.outputPositions = outputPositions;\n \n         this.dynamicFilterSplitsProcessed = dynamicFilterSplitsProcessed;\n+        this.customMetrics = customMetrics;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM0NjY3MA==", "bodyText": "Can we make it\nMap<String, Metric> merge(Iterable<Map<String, Metric>> metrics)\nor\nMetrics merge(Iterable<Metrics> metrics) ?\nLooks inconsistent to use the wrapper class sometimes and the Map directly in other places", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635346670", "createdAt": "2021-05-19T15:20:54Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> map;\n+\n+    public Metrics(Map<String, Metric> map)\n+    {\n+        this.map = Map.copyOf(requireNonNull(map, \"map is null\"));\n+    }\n+\n+    public static Metrics merge(Iterable<Map<String, Metric>> maps)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM1MDM1Mg==", "bodyText": "null handling shouldn't be needed", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635350352", "createdAt": "2021-05-19T15:24:55Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-main/src/main/java/io/trino/operator/OperatorStats.java", "diffHunk": "@@ -332,6 +340,16 @@ public long getDynamicFilterSplitsProcessed()\n         return dynamicFilterSplitsProcessed;\n     }\n \n+    @JsonInclude(JsonInclude.Include.NON_EMPTY)\n+    @JsonProperty\n+    public Map<String, Metric> getCustomMetrics()\n+    {\n+        if (customMetrics == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM1MTk4MQ==", "bodyText": "Could we use Metrics instead of Map<String, Metric> ?\nOr if we just want to use maybe Map<String, Metric> directly, we can consider getting rid of Metrics wrapper and put the merge method in some utils class.", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635351981", "createdAt": "2021-05-19T15:26:56Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-main/src/main/java/io/trino/operator/OperatorStats.java", "diffHunk": "@@ -115,6 +121,7 @@ public OperatorStats(\n             @JsonProperty(\"outputPositions\") long outputPositions,\n \n             @JsonProperty(\"dynamicFilterSplitsProcessed\") long dynamicFilterSplitsProcessed,\n+            @JsonProperty(\"customMetrics\") Map<String, Metric> customMetrics,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM1OTA5Mw==", "bodyText": "new AtomicReference<>", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635359093", "createdAt": "2021-05-19T15:34:47Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-main/src/main/java/io/trino/operator/WorkProcessorPipelineSourceOperator.java", "diffHunk": "@@ -675,6 +681,7 @@ public void close()\n         final AtomicLong outputPositions = new AtomicLong();\n \n         final AtomicLong dynamicFilterSplitsProcessed = new AtomicLong();\n+        final AtomicReference<Metrics> customMetrics = new AtomicReference(Metrics.EMPTY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM1OTQwNQ==", "bodyText": "new AtomicReference<>", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635359405", "createdAt": "2021-05-19T15:35:10Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-main/src/main/java/io/trino/operator/OperatorContext.java", "diffHunk": "@@ -82,6 +83,7 @@\n     private final CounterStat outputPositions = new CounterStat();\n \n     private final AtomicLong dynamicFilterSplitsProcessed = new AtomicLong();\n+    private final AtomicReference<Metrics> customMetrics = new AtomicReference(Metrics.EMPTY);  // this is not incremental, but gets overwritten by the latest value.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTM2NTgxMg==", "bodyText": "Do we need a list ?\nCould we merge the maps one at a time like the other metrics here ?", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r635365812", "createdAt": "2021-05-19T15:42:14Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-main/src/main/java/io/trino/operator/OperatorStats.java", "diffHunk": "@@ -451,6 +469,8 @@ public OperatorStats add(Iterable<OperatorStats> operators)\n         long outputPositions = this.outputPositions;\n \n         long dynamicFilterSplitsProcessed = this.dynamicFilterSplitsProcessed;\n+        ImmutableList.Builder<Map<String, Metric>> metricsMaps = ImmutableList.builder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 67}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjY2MjQ3MjM3", "url": "https://github.com/trinodb/trino/pull/6232#pullrequestreview-666247237", "createdAt": "2021-05-23T09:25:21Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0yM1QwOToyNToyMVrOJf-54A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0yM1QxMDo0NToyNFrOJf_e1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUxNjI1Ng==", "bodyText": "We could make this cleaner by doing something like below\nassertThat(metrics.get(\"rows\")).isEqualTo(count(2000));        \nassertThat(metrics.get(\"opened\")).isEqualTo(metrics.get(\"closed\"));\nassertThat(metrics.get(\"closed\")).isGreaterThan(count(0));", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637516256", "createdAt": "2021-05-23T09:25:21Z", "author": {"login": "raunaqmorarka"}, "path": "plugin/trino-memory/src/test/java/io/trino/plugin/memory/TestMemorySmoke.java", "diffHunk": "@@ -99,6 +104,52 @@ public void testSelect()\n         assertQueryResult(\"SELECT count(*) FROM test_select\", 75L);\n     }\n \n+    @Test\n+    public void testCustomMetricsScanFilter()\n+    {\n+        Map<String, Metric> metrics = collectCustomMetrics(\"SELECT partkey FROM part WHERE partkey % 1000 > 0\");\n+        assertEquals(\n+                ((Count) metrics.get(\"rows\")).getValue(),\n+                2000);\n+        assertEquals(\n+                ((Count) metrics.get(\"opened\")).getValue(),\n+                ((Count) metrics.get(\"closed\")).getValue());\n+        assertGreaterThan(\n+                ((Count) metrics.get(\"closed\")).getValue(),\n+                0L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUxNjQxMA==", "bodyText": "Could we use method reference instead ?", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637516410", "createdAt": "2021-05-23T09:27:16Z", "author": {"login": "raunaqmorarka"}, "path": "plugin/trino-memory/src/test/java/io/trino/plugin/memory/TestMemorySmoke.java", "diffHunk": "@@ -99,6 +104,52 @@ public void testSelect()\n         assertQueryResult(\"SELECT count(*) FROM test_select\", 75L);\n     }\n \n+    @Test\n+    public void testCustomMetricsScanFilter()\n+    {\n+        Map<String, Metric> metrics = collectCustomMetrics(\"SELECT partkey FROM part WHERE partkey % 1000 > 0\");\n+        assertEquals(\n+                ((Count) metrics.get(\"rows\")).getValue(),\n+                2000);\n+        assertEquals(\n+                ((Count) metrics.get(\"opened\")).getValue(),\n+                ((Count) metrics.get(\"closed\")).getValue());\n+        assertGreaterThan(\n+                ((Count) metrics.get(\"closed\")).getValue(),\n+                0L);\n+    }\n+\n+    @Test\n+    public void testCustomMetricsScanOnly()\n+    {\n+        Map<String, Metric> metrics = collectCustomMetrics(\"SELECT partkey FROM part\");\n+        assertEquals(\n+                ((Count) metrics.get(\"rows\")).getValue(),\n+                2000);\n+        assertEquals(\n+                ((Count) metrics.get(\"opened\")).getValue(),\n+                ((Count) metrics.get(\"closed\")).getValue());\n+        assertGreaterThan(\n+                ((Count) metrics.get(\"closed\")).getValue(),\n+                0L);\n+    }\n+\n+    private Map<String, Metric> collectCustomMetrics(String sql)\n+    {\n+        DistributedQueryRunner runner = (DistributedQueryRunner) getQueryRunner();\n+        ResultWithQueryId<MaterializedResult> result = runner.executeWithQueryId(getSession(), sql);\n+        return runner\n+                .getCoordinator()\n+                .getQueryManager()\n+                .getFullQueryInfo(result.getQueryId())\n+                .getQueryStats()\n+                .getOperatorSummaries()\n+                .stream()\n+                .map(s -> s.getMetrics())", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUxODExMA==", "bodyText": "Using assertThat would be preferable", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637518110", "createdAt": "2021-05-23T09:41:03Z", "author": {"login": "raunaqmorarka"}, "path": "lib/trino-plugin-toolkit/src/test/java/io/trino/plugin/base/metrics/TestMetrics.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.trino.plugin.base.metrics;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.airlift.stats.TDigest;\n+import io.trino.spi.metrics.Metrics;\n+import org.testng.annotations.Test;\n+\n+import static org.testng.Assert.assertEquals;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUyMTM4Nw==", "bodyText": "Since we only give two metrics as input, it might be better to simplify this method to just take 2 metrics as input.\nOr you could even make this class implement Mergeable<Metrics> interface.", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637521387", "createdAt": "2021-05-23T10:08:50Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> metrics;\n+\n+    @JsonCreator\n+    public Metrics(Map<String, Metric> metrics)\n+    {\n+        this.metrics = Map.copyOf(requireNonNull(metrics, \"metrics is null\"));\n+    }\n+\n+    public static Metrics merge(Metrics... metrics)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUyNDk4Nw==", "bodyText": "I think one disadvantage of working with Metrics wrapper is that it would result in the underlying map getting copied many times here.\nIt might be more efficient to work directly with the underlying Map for merging here\nE.g.\nMap<> metricsAccumulator = this.getMetrics().getMetrics()\n...\nfor (OperatorStats operator : operators) {\n....\n    operator.getMetrics().forEach((key, value) -> metricsAccumulator.merge(key, value, (m1, m2) -> m1.mergeWith(m2))));\n....\n}\nMetrics merged = new Metrics(metricsAccumulator);", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637524987", "createdAt": "2021-05-23T10:38:58Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-main/src/main/java/io/trino/operator/OperatorStats.java", "diffHunk": "@@ -498,6 +509,7 @@ public OperatorStats add(Iterable<OperatorStats> operators)\n             outputPositions += operator.getOutputPositions();\n \n             dynamicFilterSplitsProcessed += operator.getDynamicFilterSplitsProcessed();\n+            metrics = Metrics.merge(metrics, operator.getMetrics());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzUyNTcxNw==", "bodyText": "Would it be better to collect sourceOperator.getConnectorMetrics() before sourceOperator.close() as sourceOperator could decide to clear its metrics to release resources on close ?", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r637525717", "createdAt": "2021-05-23T10:45:24Z", "author": {"login": "raunaqmorarka"}, "path": "core/trino-main/src/main/java/io/trino/operator/WorkProcessorSourceOperatorAdapter.java", "diffHunk": "@@ -175,6 +177,7 @@ public void close()\n             throws Exception\n     {\n         sourceOperator.close();\n+        operatorContext.setLatestMetrics(sourceOperator.getConnectorMetrics());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjY2Njg0NTAy", "url": "https://github.com/trinodb/trino/pull/6232#pullrequestreview-666684502", "createdAt": "2021-05-24T12:24:05Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Njc0NTc5NjY4", "url": "https://github.com/trinodb/trino/pull/6232#pullrequestreview-674579668", "createdAt": "2021-06-02T18:57:00Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0wMlQxODo1NzowMFrOJmZa-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0wMlQxOToxNDo1MFrOJmaFVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI0MjE2OA==", "bodyText": "Is this for connector metrics? If so, call it connectorMetrics. Otherwise, just call it metrics.", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r644242168", "createdAt": "2021-06-02T18:57:00Z", "author": {"login": "martint"}, "path": "core/trino-main/src/main/java/io/trino/operator/WorkProcessorPipelineSourceOperator.java", "diffHunk": "@@ -675,6 +681,7 @@ public void close()\n         final AtomicLong outputPositions = new AtomicLong();\n \n         final AtomicLong dynamicFilterSplitsProcessed = new AtomicLong();\n+        final AtomicReference<Metrics> customMetrics = new AtomicReference<>(Metrics.EMPTY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI0NTMyNg==", "bodyText": "This method seems unnecessary. It's used only once and it's fairly trivial. Just inline it where it's used.", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r644245326", "createdAt": "2021-06-02T19:02:07Z", "author": {"login": "martint"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+        implements Mergeable<Metrics>\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> metrics;\n+\n+    @JsonCreator\n+    public Metrics(Map<String, Metric> metrics)\n+    {\n+        this.metrics = requireNonNull(metrics, \"metrics is null\");\n+    }\n+\n+    @JsonProperty(\"metrics\")\n+    public Map<String, Metric> getMetrics()\n+    {\n+        return metrics;\n+    }\n+\n+    @Override\n+    public Metrics mergeWith(Metrics other)\n+    {\n+        return accumulator().add(this).add(other).get();\n+    }\n+\n+    public static Accumulator accumulator()\n+    {\n+        return new Accumulator();\n+    }\n+\n+    public static class Accumulator\n+    {\n+        private final Map<String, Metric> merged = new HashMap<>();\n+\n+        private Accumulator()\n+        {\n+        }\n+\n+        public Accumulator add(Metrics metrics)\n+        {\n+            metrics.getMetrics().forEach((key, value) ->\n+                    merged.merge(key, value, Accumulator::mergeInternal));\n+            return this;\n+        }\n+\n+        public Metrics get()\n+        {\n+            return new Metrics(merged);\n+        }\n+\n+        private static Metric mergeInternal(Metric left, Metric right)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI0NzQyOQ==", "bodyText": "This class is holding on to the map provided by the caller. That can cause potential problems down the road if the map is modified (especially in a non-thread-safe manner). Do Map.copyOf(...)", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r644247429", "createdAt": "2021-06-02T19:05:33Z", "author": {"login": "martint"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+        implements Mergeable<Metrics>\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> metrics;\n+\n+    @JsonCreator\n+    public Metrics(Map<String, Metric> metrics)\n+    {\n+        this.metrics = requireNonNull(metrics, \"metrics is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI1MTQ0Mw==", "bodyText": "Use @JsonValue so that it doesn't introduce an artificial nested JSON object.", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r644251443", "createdAt": "2021-06-02T19:12:22Z", "author": {"login": "martint"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Metrics.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.trino.spi.Mergeable;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class Metrics\n+        implements Mergeable<Metrics>\n+{\n+    public static final Metrics EMPTY = new Metrics(Map.of());\n+\n+    private final Map<String, Metric> metrics;\n+\n+    @JsonCreator\n+    public Metrics(Map<String, Metric> metrics)\n+    {\n+        this.metrics = requireNonNull(metrics, \"metrics is null\");\n+    }\n+\n+    @JsonProperty(\"metrics\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI1MzAxMw==", "bodyText": "TDigest is not json-serializable.", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r644253013", "createdAt": "2021-06-02T19:14:50Z", "author": {"login": "martint"}, "path": "lib/trino-plugin-toolkit/src/main/java/io/trino/plugin/base/metrics/Histogram.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.trino.plugin.base.metrics;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.airlift.stats.TDigest;\n+import io.trino.spi.metrics.Metric;\n+\n+public class Histogram\n+        implements Metric<Histogram>\n+{\n+    private final TDigest digest;\n+\n+    @JsonCreator\n+    public Histogram(TDigest digest)\n+    {\n+        this.digest = digest;\n+    }\n+\n+    @JsonProperty(\"digest\")\n+    public TDigest getDigest()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Njg3NjkxODc4", "url": "https://github.com/trinodb/trino/pull/6232#pullrequestreview-687691878", "createdAt": "2021-06-18T19:51:41Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0xOFQxOTo1MTo0MVrOJwUlJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0xOFQxOTo1ODoyOFrOJwUwHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY0ODYxNA==", "bodyText": "Why not set it unconditionally?", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r654648614", "createdAt": "2021-06-18T19:51:41Z", "author": {"login": "martint"}, "path": "core/trino-main/src/main/java/io/trino/operator/WorkProcessorSourceOperatorAdapter.java", "diffHunk": "@@ -228,6 +232,11 @@ private void updateOperatorStats()\n             operatorContext.recordDynamicFilterSplitProcessed(currentDynamicFilterSplitsProcessed - previousDynamicFilterSplitsProcessed);\n             previousDynamicFilterSplitsProcessed = currentDynamicFilterSplitsProcessed;\n         }\n+\n+        if (currentMetrics != previousMetrics) {\n+            operatorContext.setLatestMetrics(currentMetrics);\n+            previousMetrics = currentMetrics;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY1MDg4Mg==", "bodyText": "Why double?", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r654650882", "createdAt": "2021-06-18T19:57:09Z", "author": {"login": "martint"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Count.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+public interface Count\n+{\n+    double getTotal();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY1MTM1MA==", "bodyText": "Did you try making Count and Histogram extend from Metric?", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r654651350", "createdAt": "2021-06-18T19:58:17Z", "author": {"login": "martint"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Count.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+public interface Count", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDY1MTQyMw==", "bodyText": "Why double?", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r654651423", "createdAt": "2021-06-18T19:58:28Z", "author": {"login": "martint"}, "path": "core/trino-spi/src/main/java/io/trino/spi/metrics/Distribution.java", "diffHunk": "@@ -0,0 +1,21 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.trino.spi.metrics;\n+\n+public interface Distribution\n+{\n+    double getTotal();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6682337acfec795aa69b92c7b5df552e4329d85", "author": {"user": {"login": "rzeyde-varada", "name": "Roman Z"}}, "url": "https://github.com/trinodb/trino/commit/e6682337acfec795aa69b92c7b5df552e4329d85", "committedDate": "2021-06-27T11:26:49Z", "message": "Move Mergeable interface to SPI"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "568eed4bbf8327070d798a8dbef07161e02c1827", "author": {"user": {"login": "rzeyde-varada", "name": "Roman Z"}}, "url": "https://github.com/trinodb/trino/commit/568eed4bbf8327070d798a8dbef07161e02c1827", "committedDate": "2021-07-01T19:35:31Z", "message": "Allow exposing custom metrics from the connector"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c3a96cb9e7aec3101cce7ac67517b1a1e2f384f", "author": {"user": {"login": "rzeyde-varada", "name": "Roman Z"}}, "url": "https://github.com/trinodb/trino/commit/7c3a96cb9e7aec3101cce7ac67517b1a1e2f384f", "committedDate": "2021-07-01T19:35:31Z", "message": "Implement Count and Histogram metrics in trino-plugin-toolkit\n\nAlso, add an integration test to TestMemorySmoke"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "7c3a96cb9e7aec3101cce7ac67517b1a1e2f384f", "author": {"user": {"login": "rzeyde-varada", "name": "Roman Z"}}, "url": "https://github.com/trinodb/trino/commit/7c3a96cb9e7aec3101cce7ac67517b1a1e2f384f", "committedDate": "2021-07-01T19:35:31Z", "message": "Implement Count and Histogram metrics in trino-plugin-toolkit\n\nAlso, add an integration test to TestMemorySmoke"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzE2ODM1Nzc4", "url": "https://github.com/trinodb/trino/pull/6232#pullrequestreview-716835778", "createdAt": "2021-07-28T10:27:32Z", "commit": {"oid": "7c3a96cb9e7aec3101cce7ac67517b1a1e2f384f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yOFQxMDoyNzozMlrOKGwhNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yOFQxMDoyNzozMlrOKGwhNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODE3NTAzMQ==", "bodyText": "Would it be possible to avoid using raw types here?", "url": "https://github.com/trinodb/trino/pull/6232#discussion_r678175031", "createdAt": "2021-07-28T10:27:32Z", "author": {"login": "findepi"}, "path": "plugin/trino-memory/src/test/java/io/trino/plugin/memory/TestMemorySmoke.java", "diffHunk": "@@ -107,6 +113,40 @@ public void testSelect()\n         assertQueryResult(\"SELECT count(*) FROM test_select\", 75L);\n     }\n \n+    @Test\n+    public void testCustomMetricsScanFilter()\n+    {\n+        Map<String, Metric> metrics = collectCustomMetrics(\"SELECT partkey FROM part WHERE partkey % 1000 > 0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3a96cb9e7aec3101cce7ac67517b1a1e2f384f"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2080, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}