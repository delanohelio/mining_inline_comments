{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NTU5NzYw", "number": 3874, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNTozNTo1NlrOEAkGRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOToyOTo1OVrOECE0PA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDI2ODg3OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/PrestoClusterManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNTozNTo1NlrOGb7BWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNjoxNTo0NVrOGd5iUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzMTczNw==", "bodyText": "It should land in Rubix code eventually, right?", "url": "https://github.com/trinodb/trino/pull/3874#discussion_r431931737", "createdAt": "2020-05-28T15:35:56Z", "author": {"login": "losipiuk"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/PrestoClusterManager.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.rubix;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.qubole.rubix.spi.ClusterManager;\n+import com.qubole.rubix.spi.ClusterType;\n+import io.prestosql.spi.Node;\n+import io.prestosql.spi.NodeManager;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static com.qubole.rubix.spi.ClusterType.PRESTOSQL_CLUSTER_MANAGER;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PrestoClusterManager", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNDU2MQ==", "bodyText": "Yes.", "url": "https://github.com/trinodb/trino/pull/3874#discussion_r434004561", "createdAt": "2020-06-02T16:15:45Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/PrestoClusterManager.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.rubix;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.qubole.rubix.spi.ClusterManager;\n+import com.qubole.rubix.spi.ClusterType;\n+import io.prestosql.spi.Node;\n+import io.prestosql.spi.NodeManager;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static com.qubole.rubix.spi.ClusterType.PRESTOSQL_CLUSTER_MANAGER;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PrestoClusterManager", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzMTczNw=="}, "originalCommit": null, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDI4Mzc5OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/PrestoClusterManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNTozOToxM1rOGb7KxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNTozOToxM1rOGb7KxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzNDE0OQ==", "bodyText": "Make this thread safe. make setNodeManager synchronized and add synchronized getter.", "url": "https://github.com/trinodb/trino/pull/3874#discussion_r431934149", "createdAt": "2020-05-28T15:39:13Z", "author": {"login": "losipiuk"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/PrestoClusterManager.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.rubix;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.qubole.rubix.spi.ClusterManager;\n+import com.qubole.rubix.spi.ClusterType;\n+import io.prestosql.spi.Node;\n+import io.prestosql.spi.NodeManager;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static com.qubole.rubix.spi.ClusterType.PRESTOSQL_CLUSTER_MANAGER;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PrestoClusterManager\n+        extends ClusterManager\n+{\n+    private static NodeManager nodeManager;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDI4Njk4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/PrestoClusterManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNTo0MDowMVrOGb7M5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNTo0MDowMVrOGb7M5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzNDY5NA==", "bodyText": "explicitly check if nodeManager is not null.", "url": "https://github.com/trinodb/trino/pull/3874#discussion_r431934694", "createdAt": "2020-05-28T15:40:01Z", "author": {"login": "losipiuk"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/PrestoClusterManager.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.rubix;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.qubole.rubix.spi.ClusterManager;\n+import com.qubole.rubix.spi.ClusterType;\n+import io.prestosql.spi.Node;\n+import io.prestosql.spi.NodeManager;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static com.qubole.rubix.spi.ClusterType.PRESTOSQL_CLUSTER_MANAGER;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PrestoClusterManager\n+        extends ClusterManager\n+{\n+    private static NodeManager nodeManager;\n+\n+    static void setNodeManager(NodeManager nodeManager)\n+    {\n+        PrestoClusterManager.nodeManager = requireNonNull(nodeManager, \"nodeManager is null\");\n+    }\n+\n+    @Override\n+    public ClusterType getClusterType()\n+    {\n+        return PRESTOSQL_CLUSTER_MANAGER;\n+    }\n+\n+    @Override\n+    public boolean isMaster()\n+    {\n+        return nodeManager.getCurrentNode().isCoordinator();\n+    }\n+\n+    @Override\n+    public List<String> getNodes()\n+    {\n+        Set<Node> workers = nodeManager.getWorkerNodes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDMwMDAwOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/PrestoClusterManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNTo0MzowMlrOGb7VNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNjoyNDoyMVrOGd53xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzNjgyMQ==", "bodyText": "How frequently is that called? I guess constructing list on each call should not be a problem but please make sure it is not.", "url": "https://github.com/trinodb/trino/pull/3874#discussion_r431936821", "createdAt": "2020-05-28T15:43:02Z", "author": {"login": "losipiuk"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/PrestoClusterManager.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.rubix;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.qubole.rubix.spi.ClusterManager;\n+import com.qubole.rubix.spi.ClusterType;\n+import io.prestosql.spi.Node;\n+import io.prestosql.spi.NodeManager;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static com.qubole.rubix.spi.ClusterType.PRESTOSQL_CLUSTER_MANAGER;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PrestoClusterManager\n+        extends ClusterManager\n+{\n+    private static NodeManager nodeManager;\n+\n+    static void setNodeManager(NodeManager nodeManager)\n+    {\n+        PrestoClusterManager.nodeManager = requireNonNull(nodeManager, \"nodeManager is null\");\n+    }\n+\n+    @Override\n+    public ClusterType getClusterType()\n+    {\n+        return PRESTOSQL_CLUSTER_MANAGER;\n+    }\n+\n+    @Override\n+    public boolean isMaster()\n+    {\n+        return nodeManager.getCurrentNode().isCoordinator();\n+    }\n+\n+    @Override\n+    public List<String> getNodes()\n+    {\n+        Set<Node> workers = nodeManager.getWorkerNodes();\n+        if (workers.isEmpty()) {\n+            // Empty result set => server up and only master node running, return localhost has the only node\n+            // Do not need to consider failed nodes list as 1node cluster and server is up since it replied to allNodesRequest\n+            return ImmutableList.of(nodeManager.getCurrentNode().getHost());\n+        }\n+\n+        return nodeManager.getWorkerNodes().stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMDA1NQ==", "bodyText": "It's:\n\nonce per split (to get block locations)\nonce per com.qubole.rubix.core.CachingInputStream#read(long, byte[], int, int)\n\nAnyway, io.prestosql.metadata.DiscoveryNodeManager#activeNodesByCatalogName is immutable, so getting list of workers should be 0 time", "url": "https://github.com/trinodb/trino/pull/3874#discussion_r434010055", "createdAt": "2020-06-02T16:24:21Z", "author": {"login": "sopel39"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/PrestoClusterManager.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.rubix;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.qubole.rubix.spi.ClusterManager;\n+import com.qubole.rubix.spi.ClusterType;\n+import io.prestosql.spi.Node;\n+import io.prestosql.spi.NodeManager;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static com.qubole.rubix.spi.ClusterType.PRESTOSQL_CLUSTER_MANAGER;\n+import static java.util.Objects.requireNonNull;\n+\n+public class PrestoClusterManager\n+        extends ClusterManager\n+{\n+    private static NodeManager nodeManager;\n+\n+    static void setNodeManager(NodeManager nodeManager)\n+    {\n+        PrestoClusterManager.nodeManager = requireNonNull(nodeManager, \"nodeManager is null\");\n+    }\n+\n+    @Override\n+    public ClusterType getClusterType()\n+    {\n+        return PRESTOSQL_CLUSTER_MANAGER;\n+    }\n+\n+    @Override\n+    public boolean isMaster()\n+    {\n+        return nodeManager.getCurrentNode().isCoordinator();\n+    }\n+\n+    @Override\n+    public List<String> getNodes()\n+    {\n+        Set<Node> workers = nodeManager.getWorkerNodes();\n+        if (workers.isEmpty()) {\n+            // Empty result set => server up and only master node running, return localhost has the only node\n+            // Do not need to consider failed nodes list as 1node cluster and server is up since it replied to allNodesRequest\n+            return ImmutableList.of(nodeManager.getCurrentNode().getHost());\n+        }\n+\n+        return nodeManager.getWorkerNodes().stream()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzNjgyMQ=="}, "originalCommit": null, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDMxMzM1OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/RubixInitializer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNTo0NjoxMVrOGb7dzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNTo0NjoxMVrOGb7dzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzOTAyMg==", "bodyText": "tag with github issue", "url": "https://github.com/trinodb/trino/pull/3874#discussion_r431939022", "createdAt": "2020-05-28T15:46:11Z", "author": {"login": "losipiuk"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/RubixInitializer.java", "diffHunk": "@@ -290,8 +280,9 @@ void updateRubixConfiguration(Configuration config)\n \n         config.set(\"fs.hdfs.impl\", RUBIX_DISTRIBUTED_FS_CLASS_NAME);\n \n-        // TODO: remove after https://github.com/qubole/rubix/pull/385 is merged\n-        setPrestoClusterManager(config, \"com.qubole.rubix.prestosql.PrestoClusterManager\");\n+        // TODO: fix PrestoClusterManager in Rubix itself", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNjAxODQ5OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/PrestoClusterManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOTowMzozNlrOGeSyTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOTowMzozNlrOGeSyTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQxODI1NA==", "bodyText": "Please merge this with filtering on stream above.\n        List<Node> workers = nodeManager.getWorkerNodes().stream()\n                .filter(node -> !node.isCoordinator())\n                .map(Node::getHost)\n                .sorted()\n                .collect(toImmutableList());\n\n        if (workers.isEmpty()) {\n            // Empty result set => server up and only master node running, return localhost has the only node\n            // Do not need to consider failed nodes list as 1node cluster and server is up since it replied to allNodesRequest\n            return ImmutableList.of(nodeManager.getCurrentNode().getHost());\n        }\n       \n        return workers;", "url": "https://github.com/trinodb/trino/pull/3874#discussion_r434418254", "createdAt": "2020-06-03T09:03:36Z", "author": {"login": "losipiuk"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/PrestoClusterManager.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.rubix;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.qubole.rubix.spi.ClusterManager;\n+import com.qubole.rubix.spi.ClusterType;\n+import io.prestosql.spi.Node;\n+import io.prestosql.spi.NodeManager;\n+\n+import java.util.List;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static com.qubole.rubix.spi.ClusterType.PRESTOSQL_CLUSTER_MANAGER;\n+import static java.util.Objects.requireNonNull;\n+\n+// TODO: remove after https://github.com/prestosql/presto/issues/3907\n+public class PrestoClusterManager\n+        extends ClusterManager\n+{\n+    private static volatile NodeManager nodeManager;\n+\n+    static void setNodeManager(NodeManager nodeManager)\n+    {\n+        PrestoClusterManager.nodeManager = requireNonNull(nodeManager, \"nodeManager is null\");\n+    }\n+\n+    @Override\n+    public ClusterType getClusterType()\n+    {\n+        return PRESTOSQL_CLUSTER_MANAGER;\n+    }\n+\n+    @Override\n+    public boolean isMaster()\n+    {\n+        requireNonNull(nodeManager, \"nodeManager is null\");\n+        return nodeManager.getCurrentNode().isCoordinator();\n+    }\n+\n+    /*\n+     * This returns list of worker nodes when there are worker nodes in the cluster\n+     * If it is a single node cluster, it will return localhost information\n+     */\n+    @Override\n+    public List<String> getNodes()\n+    {\n+        requireNonNull(nodeManager, \"nodeManager is null\");\n+        List<Node> workers = nodeManager.getWorkerNodes().stream()\n+                .filter(node -> !node.isCoordinator())\n+                .collect(toImmutableList());\n+\n+        if (workers.isEmpty()) {\n+            // Empty result set => server up and only master node running, return localhost has the only node\n+            // Do not need to consider failed nodes list as 1node cluster and server is up since it replied to allNodesRequest\n+            return ImmutableList.of(nodeManager.getCurrentNode().getHost());\n+        }\n+\n+        return workers.stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNjExNTE2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/PrestoClusterManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOToyOTo1OVrOGeTwAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOToyOTo1OVrOGeTwAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQzNDA0OA==", "bodyText": "nit: not sure if async reloading is needed but it may stay.", "url": "https://github.com/trinodb/trino/pull/3874#discussion_r434434048", "createdAt": "2020-06-03T09:29:59Z", "author": {"login": "losipiuk"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/rubix/PrestoClusterManager.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive.rubix;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.collect.ImmutableList;\n+import com.qubole.rubix.spi.ClusterManager;\n+import com.qubole.rubix.spi.ClusterType;\n+import io.prestosql.spi.Node;\n+import io.prestosql.spi.NodeManager;\n+import org.apache.hadoop.conf.Configuration;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.List;\n+\n+import static com.google.common.cache.CacheLoader.asyncReloading;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static com.qubole.rubix.spi.ClusterType.PRESTOSQL_CLUSTER_MANAGER;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.Executors.newSingleThreadExecutor;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+\n+// TODO: remove after https://github.com/prestosql/presto/issues/3907\n+public class PrestoClusterManager\n+        extends ClusterManager\n+{\n+    private static final String NODES_LIST = \"nodesList\";\n+\n+    @Nullable\n+    private static volatile NodeManager nodeManager;\n+\n+    @Nullable\n+    private LoadingCache<String, List<String>> nodesCache;\n+\n+    static void setNodeManager(NodeManager nodeManager)\n+    {\n+        PrestoClusterManager.nodeManager = requireNonNull(nodeManager, \"nodeManager is null\");\n+    }\n+\n+    @Override\n+    public void initialize(Configuration conf)\n+    {\n+        nodesCache = CacheBuilder.newBuilder()\n+                .refreshAfterWrite(getNodeRefreshTime(), SECONDS)\n+                .build(asyncReloading(CacheLoader.from(this::getNodesInternal), newSingleThreadExecutor()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 59}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4194, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}