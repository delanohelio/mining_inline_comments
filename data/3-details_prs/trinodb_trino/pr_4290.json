{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNDgwOTU0", "number": 4290, "title": "Adding FLUSHING state to tasks and stages", "bodyText": "Adds a flushing state to tasks and stages.\nThis is useful in case of broadcast joins where if the build source stage is done processing and is just running to serving data from its output buffer to join tasks, its sub-stages can be shutdown by cancellation (since the new output produced by the sub stages will not be useful). The cancellation is helpful since the sub stages under build source can be complex and take significant memory (the output buffer size is configurable) and CPU (due to the processing) to get to a blocked state.\nFor tasks, flushing state signifies that there will be no new drivers, the existing drivers have finished and the output buffer of the task is at-least in a 'no-more-pages' state.\nFor stages, flushing state signifies that at-least one of its task is flushing and the non-flushing tasks are finished.\nFor both, once the state has started flushing it will never go back to 'RUNNING' state.", "createdAt": "2020-07-01T06:45:51Z", "url": "https://github.com/trinodb/trino/pull/4290", "merged": true, "mergeCommit": {"oid": "15ffd9cf825fdb8faf604b0957f93679cb561834"}, "closed": true, "closedAt": "2020-07-30T09:21:45Z", "author": {"login": "rohangarg"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcySVLRgFqTQ0MzEyMTQ2MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc58G1WAFqTQ1ODIzMTIzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMTIxNDYw", "url": "https://github.com/trinodb/trino/pull/4290#pullrequestreview-443121460", "createdAt": "2020-07-06T14:21:50Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDoyMTo1MFrOGtZayQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNDo0MjoxN1rOGtaT0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI1NTU2MQ==", "bodyText": "I would also add a sentence from a commit message:\n(at-least one of its tasks is flushing and the non-flushing tasks are finished).", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r450255561", "createdAt": "2020-07-06T14:21:50Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/StageState.java", "diffHunk": "@@ -43,6 +43,10 @@\n      * Stage is running.\n      */\n     RUNNING(false, false),\n+    /**\n+     * Stage has finished executing and output being consumed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI1NjU5Mw==", "bodyText": "Rename it to:\nisRunningOrFlushing", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r450256593", "createdAt": "2020-07-06T14:23:12Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/StageState.java", "diffHunk": "@@ -112,4 +116,9 @@ public boolean canScheduleMoreTasks()\n         }\n         return true;\n     }\n+\n+    public boolean isRunning()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI1ODM4OA==", "bodyText": "make it synchronized", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r450258388", "createdAt": "2020-07-06T14:25:41Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/SqlStageExecution.java", "diffHunk": "@@ -524,6 +536,12 @@ else if (taskState == TaskState.FINISHED) {\n         }\n     }\n \n+    private boolean isFlushing()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI2MjM2Nw==", "bodyText": "rename to isRunningOrFlushing", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r450262367", "createdAt": "2020-07-06T14:31:15Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/TaskState.java", "diffHunk": "@@ -64,4 +68,9 @@ public boolean isDone()\n     {\n         return doneState;\n     }\n+\n+    public boolean isRunning()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI2MjY1Ng==", "bodyText": "add a sentence from PR description:\nFlushing state signifies that there will be no new drivers,\nthe existing drivers have finished and the output buffer of\nthe task is at-least in a 'no-more-pages' state.", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r450262656", "createdAt": "2020-07-06T14:31:39Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/TaskState.java", "diffHunk": "@@ -30,6 +30,10 @@\n      * Task is running.\n      */\n     RUNNING(false),\n+    /**\n+     * Task has finished executing and output is left to be consumed", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI2NDcwMQ==", "bodyText": "We shouldn't request revoking from FLUSHING task as no drivers are running which could revoke memory", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r450264701", "createdAt": "2020-07-06T14:34:40Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/MemoryRevokingScheduler.java", "diffHunk": "@@ -245,7 +245,7 @@ private void requestRevoking(MemoryPool memoryPool, Collection<SqlTask> sqlTasks\n     {\n         AtomicLong remainingBytesToRevokeAtomic = new AtomicLong(remainingBytesToRevoke);\n         sqlTasks.stream()\n-                .filter(task -> task.getTaskStatus().getState() == TaskState.RUNNING)\n+                .filter(task -> task.getTaskStatus().getState().isRunning())", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI2NTI2Ng==", "bodyText": "We can keep == TaskState.RUNNING as FLUSHING tasks have no memory to revoke", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r450265266", "createdAt": "2020-07-06T14:35:17Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/MemoryRevokingScheduler.java", "diffHunk": "@@ -218,7 +218,7 @@ private boolean memoryRevokingNeeded(MemoryPool memoryPool)\n     private long getMemoryAlreadyBeingRevoked(Collection<SqlTask> sqlTasks, MemoryPool memoryPool)\n     {\n         return sqlTasks.stream()\n-                .filter(task -> task.getTaskStatus().getState() == TaskState.RUNNING)\n+                .filter(task -> task.getTaskStatus().getState().isRunning())", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI2NjkyNw==", "bodyText": "Maybe we should have StageState#isScheduled method instead.", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r450266927", "createdAt": "2020-07-06T14:37:46Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/StageStateMachine.java", "diffHunk": "@@ -253,7 +259,7 @@ public BasicStageStats getBasicStageStats(Supplier<Iterable<TaskInfo>> taskInfos\n         // information, the stage could finish, and the task states would\n         // never be visible.\n         StageState state = stageState.get();\n-        boolean isScheduled = (state == RUNNING) || state.isDone();\n+        boolean isScheduled = state.isRunning() || state.isDone();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI2ODQ0OQ==", "bodyText": "please test actual states (if possible) and don't use isRunning(). We need to have test where we validate FLUSHING state happens.", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r450268449", "createdAt": "2020-07-06T14:39:54Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTask.java", "diffHunk": "@@ -114,10 +114,10 @@ public void testEmptyQuery()\n                 createInitialEmptyOutputBuffers(PARTITIONED)\n                         .withNoMoreBufferIds(),\n                 OptionalInt.empty());\n-        assertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING);\n+        assertTrue(taskInfo.getTaskStatus().getState().isRunning());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI2OTA1Mg==", "bodyText": "please test actual states (if possible) and don't use isRunning(). We need to have test where we validate FLUSHING state happens", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r450269052", "createdAt": "2020-07-06T14:40:43Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTaskExecution.java", "diffHunk": "@@ -177,7 +178,7 @@ public void testSimple(PipelineExecutionStrategy executionStrategy)\n \n             //\n             // test body\n-            assertEquals(taskStateMachine.getState(), TaskState.RUNNING);\n+            assertTrue(taskStateMachine.getState().isRunning());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3MDE2MA==", "bodyText": "We should incorporate check for FLUSHING state into test scenario", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r450270160", "createdAt": "2020-07-06T14:42:17Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTaskExecution.java", "diffHunk": "@@ -279,6 +280,9 @@ public void testSimple(PipelineExecutionStrategy executionStrategy)\n \n             outputBufferConsumer.abort(); // complete the task by calling abort on it\n             TaskState taskState = taskStateMachine.getStateChange(TaskState.RUNNING).get(10, SECONDS);\n+            if (taskState == TaskState.FLUSHING) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNzUyNTM1", "url": "https://github.com/trinodb/trino/pull/4290#pullrequestreview-443752535", "createdAt": "2020-07-07T10:12:54Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMDoxMjo1NFrOGt4B3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMDoxMjo1NFrOGt4B3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc1NzA4Ng==", "bodyText": "Please add a test for this. The test could be:\n\nstaring SELECT * FROM large_table LIMIT 1\nNOT fetching results and waiting for SOURCE stage to be cancelled", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r450757086", "createdAt": "2020-07-07T10:12:54Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/scheduler/SqlQueryScheduler.java", "diffHunk": "@@ -419,7 +420,7 @@ else if (partitioningHandle.equals(SCALED_WRITER_DISTRIBUTION)) {\n         }\n         Set<SqlStageExecution> childStages = childStagesBuilder.build();\n         stage.addStateChangeListener(newState -> {\n-            if (newState.isDone()) {\n+            if (newState.isDone() || newState == FLUSHING) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NjQ4NzI5", "url": "https://github.com/trinodb/trino/pull/4290#pullrequestreview-447648729", "createdAt": "2020-07-13T22:17:15Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMjoxNzoxNVrOGw8Wlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMjoxOToxOVrOGw8cXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk3MzY1NQ==", "bodyText": "Add a comment explaining that to be flushing, there must be at least one flushing task, and all others must be flushing or finished.\nalso replace flushingTasks.size() > 0 with !flushingTasks.isEmpty()", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r453973655", "createdAt": "2020-07-13T22:17:15Z", "author": {"login": "dain"}, "path": "presto-main/src/main/java/io/prestosql/execution/SqlStageExecution.java", "diffHunk": "@@ -524,6 +536,12 @@ else if (taskState == TaskState.FINISHED) {\n         }\n     }\n \n+    private synchronized boolean isFlushing()\n+    {\n+        return flushingTasks.size() > 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk3NTEzMw==", "bodyText": "I'm not a fan of this method.  In all uses, it seem to be used in an || with some other clause on the state.  Instead, I would just inline this method.", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r453975133", "createdAt": "2020-07-13T22:19:19Z", "author": {"login": "dain"}, "path": "presto-main/src/main/java/io/prestosql/execution/TaskState.java", "diffHunk": "@@ -64,4 +70,9 @@ public boolean isDone()\n     {\n         return doneState;\n     }\n+\n+    public boolean isRunningOrFlushing()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NDkwNTY5", "url": "https://github.com/trinodb/trino/pull/4290#pullrequestreview-456490569", "createdAt": "2020-07-28T10:09:03Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMDowOTowM1rOG4F5cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMToyMzozM1rOG4ILYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ3MDA2NA==", "bodyText": "put it above if (finishedTasks.containsAll(allTasks)) { to align it with states order", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461470064", "createdAt": "2020-07-28T10:09:03Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/SqlStageExecution.java", "diffHunk": "@@ -228,6 +230,9 @@ public synchronized void schedulingComplete()\n         if (finishedTasks.containsAll(allTasks)) {\n             stateMachine.transitionToFinished();\n         }\n+        if (isFlushing()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ3MDMwOQ==", "bodyText": "put it above else if (taskState == TaskState.FINISHED) { to align with states order", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461470309", "createdAt": "2020-07-28T10:09:32Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/SqlStageExecution.java", "diffHunk": "@@ -507,15 +512,22 @@ else if (taskState == TaskState.ABORTED) {\n             }\n             else if (taskState == TaskState.FINISHED) {\n                 finishedTasks.add(taskStatus.getTaskId());\n+                flushingTasks.remove(taskStatus.getTaskId());\n+            }\n+            else if (taskState == TaskState.FLUSHING) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ3MTU1Nw==", "bodyText": "put it above if (finishedTasks.containsAll(allTasks)) { to align with states order", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461471557", "createdAt": "2020-07-28T10:11:30Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/SqlStageExecution.java", "diffHunk": "@@ -507,15 +512,22 @@ else if (taskState == TaskState.ABORTED) {\n             }\n             else if (taskState == TaskState.FINISHED) {\n                 finishedTasks.add(taskStatus.getTaskId());\n+                flushingTasks.remove(taskStatus.getTaskId());\n+            }\n+            else if (taskState == TaskState.FLUSHING) {\n+                flushingTasks.add(taskStatus.getTaskId());\n             }\n \n-            if (stageState == StageState.SCHEDULED || stageState == StageState.RUNNING) {\n+            if (stageState == StageState.SCHEDULED || stageState == StageState.RUNNING || stageState == StageState.FLUSHING) {\n                 if (taskState == TaskState.RUNNING) {\n                     stateMachine.transitionToRunning();\n                 }\n                 if (finishedTasks.containsAll(allTasks)) {\n                     stateMachine.transitionToFinished();\n                 }\n+                if (isFlushing()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ4OTUyMQ==", "bodyText": "Move\nassertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING);\n\ncheck above sqlTask.updateTask", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461489521", "createdAt": "2020-07-28T10:47:39Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTask.java", "diffHunk": "@@ -142,13 +142,12 @@ public void testSimpleQuery()\n                 ImmutableList.of(new TaskSource(TABLE_SCAN_NODE_ID, ImmutableSet.of(SPLIT), true)),\n                 createInitialEmptyOutputBuffers(PARTITIONED).withBuffer(OUT, 0).withNoMoreBufferIds(),\n                 OptionalInt.empty());\n-        assertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ5MTk1MA==", "bodyText": "nit: this will wait for 1s if taskInfo.getTaskStatus().getState() is already FLUSHING. You could use:\nsqlTask.getTaskInfo(RUNNING).get(1, SECONDS);\n\ninstead", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461491950", "createdAt": "2020-07-28T10:52:33Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTask.java", "diffHunk": "@@ -142,13 +142,12 @@ public void testSimpleQuery()\n                 ImmutableList.of(new TaskSource(TABLE_SCAN_NODE_ID, ImmutableSet.of(SPLIT), true)),\n                 createInitialEmptyOutputBuffers(PARTITIONED).withBuffer(OUT, 0).withNoMoreBufferIds(),\n                 OptionalInt.empty());\n-        assertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING);\n \n-        taskInfo = sqlTask.getTaskInfo();\n-        assertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING);\n+        taskInfo = sqlTask.getTaskInfo(taskInfo.getTaskStatus().getState()).get(1, SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ5MzM0MA==", "bodyText": "move assertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING); above TaskInfo taskInfo = sqlTask.updateTask(TEST_SESSION,", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461493340", "createdAt": "2020-07-28T10:55:25Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTask.java", "diffHunk": "@@ -207,10 +206,9 @@ public void testAbort()\n                 ImmutableList.of(new TaskSource(TABLE_SCAN_NODE_ID, ImmutableSet.of(SPLIT), true)),\n                 createInitialEmptyOutputBuffers(PARTITIONED).withBuffer(OUT, 0).withNoMoreBufferIds(),\n                 OptionalInt.empty());\n-        assertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ5MzYwMQ==", "bodyText": "this will wait for 1s if taskInfo.getTaskStatus().getState() is already FLUSHING. You could use:\nsqlTask.getTaskInfo(RUNNING).get(1, SECONDS);\n\ninstead", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461493601", "createdAt": "2020-07-28T10:56:02Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTask.java", "diffHunk": "@@ -207,10 +206,9 @@ public void testAbort()\n                 ImmutableList.of(new TaskSource(TABLE_SCAN_NODE_ID, ImmutableSet.of(SPLIT), true)),\n                 createInitialEmptyOutputBuffers(PARTITIONED).withBuffer(OUT, 0).withNoMoreBufferIds(),\n                 OptionalInt.empty());\n-        assertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING);\n \n-        taskInfo = sqlTask.getTaskInfo();\n-        assertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING);\n+        taskInfo = sqlTask.getTaskInfo(taskInfo.getTaskStatus().getState()).get(1, SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ5MzgzMQ==", "bodyText": "static import should be separate commit", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461493831", "createdAt": "2020-07-28T10:56:30Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTaskExecution.java", "diffHunk": "@@ -177,7 +180,7 @@ public void testSimple(PipelineExecutionStrategy executionStrategy)\n \n             //\n             // test body\n-            assertEquals(taskStateMachine.getState(), TaskState.RUNNING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ5NzM4OQ==", "bodyText": "I think we can simplify it by:\nTaskState taskState = taskStateMachine.getStateChange(taskStateMachine.getState()).get(10, SECONDS);\n\nnot that if getState returns FINISHED, future will complete immediately.", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461497389", "createdAt": "2020-07-28T11:03:47Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTaskExecution.java", "diffHunk": "@@ -278,7 +282,13 @@ public void testSimple(PipelineExecutionStrategy executionStrategy)\n             }\n \n             outputBufferConsumer.abort(); // complete the task by calling abort on it\n-            TaskState taskState = taskStateMachine.getStateChange(TaskState.RUNNING).get(10, SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ5ODI2Mg==", "bodyText": "why we cannot assert:\nassertEquals(taskStateMachine.getState(), RUNNING);\n\nas in testSimple?", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461498262", "createdAt": "2020-07-28T11:05:27Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTaskExecution.java", "diffHunk": "@@ -428,7 +438,7 @@ public void testComplex(PipelineExecutionStrategy executionStrategy)\n \n             //\n             // test body\n-            assertEquals(taskStateMachine.getState(), TaskState.RUNNING);\n+            assertTrue(taskStateMachine.getState() == RUNNING || taskStateMachine.getState() == FLUSHING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ5ODQ0Mw==", "bodyText": "this check doesn't make sense if we assert:\nassertTrue(taskStateMachine.getState() == RUNNING || taskStateMachine.getState() == FLUSHING);\n\nabove", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461498443", "createdAt": "2020-07-28T11:05:50Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTaskExecution.java", "diffHunk": "@@ -474,6 +484,7 @@ public void testComplex(PipelineExecutionStrategy executionStrategy)\n                     // assert that task result is produced\n                     outputBufferConsumer.consume(100 * 5 * 3, ASSERT_WAIT_TIMEOUT);\n                     outputBufferConsumer.assertBufferComplete(ASSERT_WAIT_TIMEOUT);\n+                    assertEquals(taskStateMachine.getStateChange(RUNNING).get(10, SECONDS), FLUSHING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ5ODYzMg==", "bodyText": "I think we can simplify it by:\nTaskState taskState = taskStateMachine.getStateChange(taskStateMachine.getState()).get(10, SECONDS);\n\nnot that if getState returns FINISHED, future will complete immediately.", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461498632", "createdAt": "2020-07-28T11:06:14Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTaskExecution.java", "diffHunk": "@@ -580,7 +591,13 @@ public void testComplex(PipelineExecutionStrategy executionStrategy)\n             }\n \n             outputBufferConsumer.abort(); // complete the task by calling abort on it\n-            TaskState taskState = taskStateMachine.getStateChange(TaskState.RUNNING).get(10, SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUwMjAzOQ==", "bodyText": "this will wait for 1s if taskInfo.getTaskStatus().getState() is already FLUSHING. You could use:\nsqlTaskManager.getTaskInfo(taskId, RUNNING).get(1, TimeUnit.SECONDS);\n\ninstead", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461502039", "createdAt": "2020-07-28T11:12:43Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTaskManager.java", "diffHunk": "@@ -111,20 +113,19 @@ public void testSimpleQuery()\n         try (SqlTaskManager sqlTaskManager = createSqlTaskManager(new TaskManagerConfig())) {\n             TaskId taskId = TASK_ID;\n             TaskInfo taskInfo = createTask(sqlTaskManager, taskId, ImmutableSet.of(SPLIT), createInitialEmptyOutputBuffers(PARTITIONED).withBuffer(OUT, 0).withNoMoreBufferIds());\n-            assertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING);\n \n-            taskInfo = sqlTaskManager.getTaskInfo(taskId);\n-            assertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING);\n+            taskInfo = sqlTaskManager.getTaskInfo(taskId, taskInfo.getTaskStatus().getState()).get(1, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUwMjg3Nw==", "bodyText": "ditto", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461502877", "createdAt": "2020-07-28T11:14:15Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTaskManager.java", "diffHunk": "@@ -191,10 +192,9 @@ public void testAbortResults()\n         try (SqlTaskManager sqlTaskManager = createSqlTaskManager(new TaskManagerConfig())) {\n             TaskId taskId = TASK_ID;\n             TaskInfo taskInfo = createTask(sqlTaskManager, taskId, ImmutableSet.of(SPLIT), createInitialEmptyOutputBuffers(PARTITIONED).withBuffer(OUT, 0).withNoMoreBufferIds());\n-            assertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING);\n \n-            taskInfo = sqlTaskManager.getTaskInfo(taskId);\n-            assertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING);\n+            taskInfo = sqlTaskManager.getTaskInfo(taskId, taskInfo.getTaskStatus().getState()).get(1, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUwNDUwNg==", "bodyText": "change the order of conditions:\nif (newState == FLUSHING || newState.isDone())", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461504506", "createdAt": "2020-07-28T11:17:27Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/scheduler/SqlQueryScheduler.java", "diffHunk": "@@ -421,7 +421,7 @@ else if (partitioningHandle.equals(SCALED_WRITER_DISTRIBUTION)) {\n         }\n         Set<SqlStageExecution> childStages = childStagesBuilder.build();\n         stage.addStateChangeListener(newState -> {\n-            if (newState.isDone()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUwNTY1MQ==", "bodyText": "Do we need distributed runner for this test?", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461505651", "createdAt": "2020-07-28T11:19:47Z", "author": {"login": "sopel39"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestSqlStageExecution.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.spi.QueryId;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.SessionTestUtils.TEST_SESSION;\n+import static io.prestosql.execution.QueryState.RUNNING;\n+import static io.prestosql.execution.StageState.CANCELED;\n+import static io.prestosql.execution.StageState.FLUSHING;\n+import static io.prestosql.execution.TestQueryRunnerUtil.createQuery;\n+import static io.prestosql.execution.TestQueryRunnerUtil.createQueryRunner;\n+import static io.prestosql.execution.TestQueryRunnerUtil.waitForQueryState;\n+import static org.testng.Assert.assertEquals;\n+\n+public class TestSqlStageExecution {\n+\n+    private DistributedQueryRunner queryRunner;\n+\n+    @Test(timeOut = 30_000)\n+    public void testFlushingState()\n+            throws Exception\n+    {\n+        queryRunner = createQueryRunner(ImmutableMap.of(\"node-scheduler.include-coordinator\", \"false\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUwNzA2Ng==", "bodyText": "put some sleep here to prevent active loop, e.g:\n            MILLISECONDS.sleep(100);", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461507066", "createdAt": "2020-07-28T11:22:45Z", "author": {"login": "sopel39"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestSqlStageExecution.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.spi.QueryId;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.SessionTestUtils.TEST_SESSION;\n+import static io.prestosql.execution.QueryState.RUNNING;\n+import static io.prestosql.execution.StageState.CANCELED;\n+import static io.prestosql.execution.StageState.FLUSHING;\n+import static io.prestosql.execution.TestQueryRunnerUtil.createQuery;\n+import static io.prestosql.execution.TestQueryRunnerUtil.createQueryRunner;\n+import static io.prestosql.execution.TestQueryRunnerUtil.waitForQueryState;\n+import static org.testng.Assert.assertEquals;\n+\n+public class TestSqlStageExecution {\n+\n+    private DistributedQueryRunner queryRunner;\n+\n+    @Test(timeOut = 30_000)\n+    public void testFlushingState()\n+            throws Exception\n+    {\n+        queryRunner = createQueryRunner(ImmutableMap.of(\"node-scheduler.include-coordinator\", \"false\"));\n+        QueryId queryId = createQuery(queryRunner, TEST_SESSION, \"SELECT * FROM tpch.sf1000.lineitem limit 1\");\n+        waitForQueryState(queryRunner, queryId, RUNNING);\n+\n+        QueryInfo queryInfo = queryRunner.getCoordinator().getFullQueryInfo(queryId);\n+        while (queryInfo.getOutputStage().get().getState() != FLUSHING) {\n+            queryInfo = queryRunner.getCoordinator().getFullQueryInfo(queryId); // wait for the query to finish producing results, but don't poll them", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUwNzE1MQ==", "bodyText": "dittto", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461507151", "createdAt": "2020-07-28T11:22:57Z", "author": {"login": "sopel39"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestSqlStageExecution.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.spi.QueryId;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.SessionTestUtils.TEST_SESSION;\n+import static io.prestosql.execution.QueryState.RUNNING;\n+import static io.prestosql.execution.StageState.CANCELED;\n+import static io.prestosql.execution.StageState.FLUSHING;\n+import static io.prestosql.execution.TestQueryRunnerUtil.createQuery;\n+import static io.prestosql.execution.TestQueryRunnerUtil.createQueryRunner;\n+import static io.prestosql.execution.TestQueryRunnerUtil.waitForQueryState;\n+import static org.testng.Assert.assertEquals;\n+\n+public class TestSqlStageExecution {\n+\n+    private DistributedQueryRunner queryRunner;\n+\n+    @Test(timeOut = 30_000)\n+    public void testFlushingState()\n+            throws Exception\n+    {\n+        queryRunner = createQueryRunner(ImmutableMap.of(\"node-scheduler.include-coordinator\", \"false\"));\n+        QueryId queryId = createQuery(queryRunner, TEST_SESSION, \"SELECT * FROM tpch.sf1000.lineitem limit 1\");\n+        waitForQueryState(queryRunner, queryId, RUNNING);\n+\n+        QueryInfo queryInfo = queryRunner.getCoordinator().getFullQueryInfo(queryId);\n+        while (queryInfo.getOutputStage().get().getState() != FLUSHING) {\n+            queryInfo = queryRunner.getCoordinator().getFullQueryInfo(queryId); // wait for the query to finish producing results, but don't poll them\n+        }\n+\n+        while (queryInfo.getOutputStage().get().getSubStages().get(0).getState() != CANCELED) {\n+            queryInfo = queryRunner.getCoordinator().getFullQueryInfo(queryId); // wait for the sub stages to go to cancelled state", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUwNzQyNg==", "bodyText": "could you also pull results here and wait for the query to finish gracefully?", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461507426", "createdAt": "2020-07-28T11:23:33Z", "author": {"login": "sopel39"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestSqlStageExecution.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.spi.QueryId;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.SessionTestUtils.TEST_SESSION;\n+import static io.prestosql.execution.QueryState.RUNNING;\n+import static io.prestosql.execution.StageState.CANCELED;\n+import static io.prestosql.execution.StageState.FLUSHING;\n+import static io.prestosql.execution.TestQueryRunnerUtil.createQuery;\n+import static io.prestosql.execution.TestQueryRunnerUtil.createQueryRunner;\n+import static io.prestosql.execution.TestQueryRunnerUtil.waitForQueryState;\n+import static org.testng.Assert.assertEquals;\n+\n+public class TestSqlStageExecution {\n+\n+    private DistributedQueryRunner queryRunner;\n+\n+    @Test(timeOut = 30_000)\n+    public void testFlushingState()\n+            throws Exception\n+    {\n+        queryRunner = createQueryRunner(ImmutableMap.of(\"node-scheduler.include-coordinator\", \"false\"));\n+        QueryId queryId = createQuery(queryRunner, TEST_SESSION, \"SELECT * FROM tpch.sf1000.lineitem limit 1\");\n+        waitForQueryState(queryRunner, queryId, RUNNING);\n+\n+        QueryInfo queryInfo = queryRunner.getCoordinator().getFullQueryInfo(queryId);\n+        while (queryInfo.getOutputStage().get().getState() != FLUSHING) {\n+            queryInfo = queryRunner.getCoordinator().getFullQueryInfo(queryId); // wait for the query to finish producing results, but don't poll them\n+        }\n+\n+        while (queryInfo.getOutputStage().get().getSubStages().get(0).getState() != CANCELED) {\n+            queryInfo = queryRunner.getCoordinator().getFullQueryInfo(queryId); // wait for the sub stages to go to cancelled state\n+        }\n+\n+        assertEquals(queryInfo.getState(), RUNNING);\n+        assertEquals(queryInfo.getOutputStage().get().getState(), FLUSHING);\n+        assertEquals(queryInfo.getOutputStage().get().getSubStages().size(), 1);\n+        assertEquals(queryInfo.getOutputStage().get().getSubStages().get(0).getState(), CANCELED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjIyMzIx", "url": "https://github.com/trinodb/trino/pull/4290#pullrequestreview-456622321", "createdAt": "2020-07-28T13:20:10Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzoyMDoxMFrOG4MLrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzoyMDoxMFrOG4MLrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU3MzAzOQ==", "bodyText": "please update canScheduleMoreTasks method", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r461573039", "createdAt": "2020-07-28T13:20:10Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/StageState.java", "diffHunk": "@@ -43,6 +43,11 @@\n      * Stage is running.\n      */\n     RUNNING(false, false),\n+    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NTc2MDky", "url": "https://github.com/trinodb/trino/pull/4290#pullrequestreview-457576092", "createdAt": "2020-07-29T14:25:41Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNDoyNTo0MVrOG47CeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNDoyNTo0MVrOG47CeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM0MDcyOA==", "bodyText": "@dain is this a valid transition for grouped execution or there should be additional conditions? I'm thinking that if there are more execution groups, the task should stay in RUNNING state.", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r462340728", "createdAt": "2020-07-29T14:25:41Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/SqlTaskExecution.java", "diffHunk": "@@ -641,6 +641,7 @@ private synchronized void checkTaskCompletion()\n \n         // are there still pages in the output buffer\n         if (!outputBuffer.isFinished()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NjQwODAw", "url": "https://github.com/trinodb/trino/pull/4290#pullrequestreview-457640800", "createdAt": "2020-07-29T15:31:21Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNTozMToyMVrOG4-Fdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNTo1Nzo1M1rOG4_PIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM5MDY0Ng==", "bodyText": "shouldn't that be moved above outputBufferConsumer.consume(300 + 200, ASSERT_WAIT_TIMEOUT); to prevent race condition?\nDoes outputBufferConsumer.assertBufferComplete(ASSERT_WAIT_TIMEOUT); consume all output?", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r462390646", "createdAt": "2020-07-29T15:31:21Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTaskExecution.java", "diffHunk": "@@ -209,6 +212,7 @@ public void testSimple(PipelineExecutionStrategy executionStrategy)\n                     // assert that task result is produced\n                     outputBufferConsumer.consume(300 + 200, ASSERT_WAIT_TIMEOUT);\n                     outputBufferConsumer.assertBufferComplete(ASSERT_WAIT_TIMEOUT);\n+                    assertEquals(taskStateMachine.getStateChange(RUNNING).get(10, SECONDS), FLUSHING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQwOTUwNw==", "bodyText": "please use assertEventually", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r462409507", "createdAt": "2020-07-29T15:57:53Z", "author": {"login": "sopel39"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestFlushingStageState.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.spi.QueryId;\n+import io.prestosql.testing.DistributedQueryRunner;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.SessionTestUtils.TEST_SESSION;\n+import static io.prestosql.execution.QueryState.RUNNING;\n+import static io.prestosql.execution.StageState.CANCELED;\n+import static io.prestosql.execution.StageState.FLUSHING;\n+import static io.prestosql.execution.TestQueryRunnerUtil.createQuery;\n+import static io.prestosql.execution.TestQueryRunnerUtil.createQueryRunner;\n+import static io.prestosql.execution.TestQueryRunnerUtil.waitForQueryState;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+import static org.testng.Assert.assertEquals;\n+\n+public class TestFlushingStageState\n+{\n+    private DistributedQueryRunner queryRunner;\n+\n+    @Test(timeOut = 30_000)\n+    public void testFlushingState()\n+            throws Exception\n+    {\n+        queryRunner = createQueryRunner(ImmutableMap.of(\"node-scheduler.include-coordinator\", \"false\"));\n+        QueryId queryId = createQuery(queryRunner, TEST_SESSION, \"SELECT * FROM tpch.sf1000.lineitem limit 1\");\n+        waitForQueryState(queryRunner, queryId, RUNNING);\n+\n+        QueryInfo queryInfo = queryRunner.getCoordinator().getFullQueryInfo(queryId);\n+        while (queryInfo.getOutputStage().get().getState() != FLUSHING) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fdbb522e4a48a2b1de368b4dbbe3a118ab7848b", "author": {"user": {"login": "rohangarg", "name": "Rohan Garg"}}, "url": "https://github.com/trinodb/trino/commit/7fdbb522e4a48a2b1de368b4dbbe3a118ab7848b", "committedDate": "2020-07-29T16:31:29Z", "message": "Add FLUSHING state to tasks and stages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1304a49136d80e8a7e36783ec1535f085bd6c76a", "author": {"user": {"login": "rohangarg", "name": "Rohan Garg"}}, "url": "https://github.com/trinodb/trino/commit/1304a49136d80e8a7e36783ec1535f085bd6c76a", "committedDate": "2020-07-29T16:39:30Z", "message": "Fix imports and cleanup in TestSqlTaskExecution"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "d887993088caa0c06332aa05dd1376a931fb7b45", "author": {"user": {"login": "rohangarg", "name": "Rohan Garg"}}, "url": "https://github.com/trinodb/trino/commit/d887993088caa0c06332aa05dd1376a931fb7b45", "committedDate": "2020-07-29T20:07:24Z", "message": "Cancel sub stages in FLUSHING state"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "d887993088caa0c06332aa05dd1376a931fb7b45", "author": {"user": {"login": "rohangarg", "name": "Rohan Garg"}}, "url": "https://github.com/trinodb/trino/commit/d887993088caa0c06332aa05dd1376a931fb7b45", "committedDate": "2020-07-29T20:07:24Z", "message": "Cancel sub stages in FLUSHING state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MjMxMjMw", "url": "https://github.com/trinodb/trino/pull/4290#pullrequestreview-458231230", "createdAt": "2020-07-30T09:20:09Z", "commit": {"oid": "7fdbb522e4a48a2b1de368b4dbbe3a118ab7848b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwOToyMDowOVrOG5bFQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwOToyMDowOVrOG5bFQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2NTczMQ==", "bodyText": "nit this should be separate commit", "url": "https://github.com/trinodb/trino/pull/4290#discussion_r462865731", "createdAt": "2020-07-30T09:20:09Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTaskManager.java", "diffHunk": "@@ -110,21 +112,20 @@ public void testSimpleQuery()\n     {\n         try (SqlTaskManager sqlTaskManager = createSqlTaskManager(new TaskManagerConfig())) {\n             TaskId taskId = TASK_ID;\n-            TaskInfo taskInfo = createTask(sqlTaskManager, taskId, ImmutableSet.of(SPLIT), createInitialEmptyOutputBuffers(PARTITIONED).withBuffer(OUT, 0).withNoMoreBufferIds());\n-            assertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING);\n+            createTask(sqlTaskManager, taskId, ImmutableSet.of(SPLIT), createInitialEmptyOutputBuffers(PARTITIONED).withBuffer(OUT, 0).withNoMoreBufferIds());\n \n-            taskInfo = sqlTaskManager.getTaskInfo(taskId);\n-            assertEquals(taskInfo.getTaskStatus().getState(), TaskState.RUNNING);\n+            TaskInfo taskInfo = sqlTaskManager.getTaskInfo(taskId, TaskState.RUNNING).get(1, TimeUnit.SECONDS);\n+            assertEquals(taskInfo.getTaskStatus().getState(), TaskState.FLUSHING);\n \n             BufferResult results = sqlTaskManager.getTaskResults(taskId, OUT, 0, DataSize.of(1, Unit.MEGABYTE)).get();\n-            assertEquals(results.isBufferComplete(), false);\n+            assertFalse(results.isBufferComplete());\n             assertEquals(results.getSerializedPages().size(), 1);\n             assertEquals(results.getSerializedPages().get(0).getPositionCount(), 1);\n \n             for (boolean moreResults = true; moreResults; moreResults = !results.isBufferComplete()) {\n                 results = sqlTaskManager.getTaskResults(taskId, OUT, results.getToken() + results.getSerializedPages().size(), DataSize.of(1, Unit.MEGABYTE)).get();\n             }\n-            assertEquals(results.isBufferComplete(), true);\n+            assertTrue(results.isBufferComplete());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fdbb522e4a48a2b1de368b4dbbe3a118ab7848b"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 299, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}