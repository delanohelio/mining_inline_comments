{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NjI4ODk4", "number": 4579, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOTo0OTowN1rOEVJROg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDowMzowNlrOEVJitA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNjA3NDE4OnYy", "diffSide": "RIGHT", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOTo0OTowN1rOG7vHyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNDowNzoxOVrOG75aCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5MTIwOQ==", "bodyText": "I think we could inline this method\ntestWithAllFileFormats(this:: testHourTransformForFormat);\ntestWithAllFileFormats(this:: testDayTransformForFormat);\n...", "url": "https://github.com/trinodb/trino/pull/4579#discussion_r465291209", "createdAt": "2020-08-04T19:49:07Z", "author": {"login": "electrum"}, "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -593,6 +593,210 @@ private void testPredicating(Session session, FileFormat fileFormat)\n         dropTable(session, \"test_predicating_on_real\");\n     }\n \n+    @Test\n+    public void testDateTransforms()\n+    {\n+        testWithAllFileFormats(this::testDateTransformsForFormat);\n+    }\n+\n+    private void testDateTransformsForFormat(Session session, FileFormat format)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ1OTcyMQ==", "bodyText": "Inlined.", "url": "https://github.com/trinodb/trino/pull/4579#discussion_r465459721", "createdAt": "2020-08-05T04:07:19Z", "author": {"login": "djsstarburst"}, "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -593,6 +593,210 @@ private void testPredicating(Session session, FileFormat fileFormat)\n         dropTable(session, \"test_predicating_on_real\");\n     }\n \n+    @Test\n+    public void testDateTransforms()\n+    {\n+        testWithAllFileFormats(this::testDateTransformsForFormat);\n+    }\n+\n+    private void testDateTransformsForFormat(Session session, FileFormat format)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5MTIwOQ=="}, "originalCommit": null, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNjA3NzM4OnYy", "diffSide": "RIGHT", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOTo1MDowM1rOG7vJvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNDowNzoxNFrOG75Z9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5MTcxMQ==", "bodyText": "Maybe write this as\nString insertSql = \"INSERT INTO ... \" +\n        \"...\";\nassertUpdate(session, insertSql, 7);\nThen we don't have the trailing 7 at the end", "url": "https://github.com/trinodb/trino/pull/4579#discussion_r465291711", "createdAt": "2020-08-04T19:50:03Z", "author": {"login": "electrum"}, "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -593,6 +593,210 @@ private void testPredicating(Session session, FileFormat fileFormat)\n         dropTable(session, \"test_predicating_on_real\");\n     }\n \n+    @Test\n+    public void testDateTransforms()\n+    {\n+        testWithAllFileFormats(this::testDateTransformsForFormat);\n+    }\n+\n+    private void testDateTransformsForFormat(Session session, FileFormat format)\n+    {\n+        testHourTransformForFormat(session, format);\n+        testDayTransformForFormat(session, format);\n+        testMonthTransformForFormat(session, format);\n+        testYearTransformForFormat(session, format);\n+    }\n+\n+    private void testHourTransformForFormat(Session session, FileFormat format)\n+    {\n+        String select = \"SELECT d_hour, row_count, d.min AS d_min, d.max AS d_max, b.min AS b_min, b.max AS b_max FROM \\\"test_hour_transform$partitions\\\"\";\n+\n+        assertUpdate(session, format(\"CREATE TABLE test_hour_transform (d TIMESTAMP, b BIGINT)\" +\n+                \" WITH (format = '%s', partitioning = ARRAY['hour(d)'])\", format.name()));\n+        assertUpdate(session, \"INSERT INTO test_hour_transform VALUES\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ1OTcwMQ==", "bodyText": "Changed in all 5 places it was done.", "url": "https://github.com/trinodb/trino/pull/4579#discussion_r465459701", "createdAt": "2020-08-05T04:07:14Z", "author": {"login": "djsstarburst"}, "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -593,6 +593,210 @@ private void testPredicating(Session session, FileFormat fileFormat)\n         dropTable(session, \"test_predicating_on_real\");\n     }\n \n+    @Test\n+    public void testDateTransforms()\n+    {\n+        testWithAllFileFormats(this::testDateTransformsForFormat);\n+    }\n+\n+    private void testDateTransformsForFormat(Session session, FileFormat format)\n+    {\n+        testHourTransformForFormat(session, format);\n+        testDayTransformForFormat(session, format);\n+        testMonthTransformForFormat(session, format);\n+        testYearTransformForFormat(session, format);\n+    }\n+\n+    private void testHourTransformForFormat(Session session, FileFormat format)\n+    {\n+        String select = \"SELECT d_hour, row_count, d.min AS d_min, d.max AS d_max, b.min AS b_min, b.max AS b_max FROM \\\"test_hour_transform$partitions\\\"\";\n+\n+        assertUpdate(session, format(\"CREATE TABLE test_hour_transform (d TIMESTAMP, b BIGINT)\" +\n+                \" WITH (format = '%s', partitioning = ARRAY['hour(d)'])\", format.name()));\n+        assertUpdate(session, \"INSERT INTO test_hour_transform VALUES\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5MTcxMQ=="}, "originalCommit": null, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNjA4MTk5OnYy", "diffSide": "RIGHT", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOTo1MTozMlrOG7vMsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNDowNzoxMVrOG75Z7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5MjQ2Ng==", "bodyText": "This is a bit hard to read, wrap the lines\nString expected = (format == FileFormat.PARQUET) ?\n        \"VALUES(394460, 3, TIMESTAMP '2015-01-01 10:01:23', TIMESTAMP '2015-01-01 10:55:00', 1, 3)\" : \n        \"VALUES(394460, 3, NULL, NULL, 1, 3)\";", "url": "https://github.com/trinodb/trino/pull/4579#discussion_r465292466", "createdAt": "2020-08-04T19:51:32Z", "author": {"login": "electrum"}, "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -593,6 +593,210 @@ private void testPredicating(Session session, FileFormat fileFormat)\n         dropTable(session, \"test_predicating_on_real\");\n     }\n \n+    @Test\n+    public void testDateTransforms()\n+    {\n+        testWithAllFileFormats(this::testDateTransformsForFormat);\n+    }\n+\n+    private void testDateTransformsForFormat(Session session, FileFormat format)\n+    {\n+        testHourTransformForFormat(session, format);\n+        testDayTransformForFormat(session, format);\n+        testMonthTransformForFormat(session, format);\n+        testYearTransformForFormat(session, format);\n+    }\n+\n+    private void testHourTransformForFormat(Session session, FileFormat format)\n+    {\n+        String select = \"SELECT d_hour, row_count, d.min AS d_min, d.max AS d_max, b.min AS b_min, b.max AS b_max FROM \\\"test_hour_transform$partitions\\\"\";\n+\n+        assertUpdate(session, format(\"CREATE TABLE test_hour_transform (d TIMESTAMP, b BIGINT)\" +\n+                \" WITH (format = '%s', partitioning = ARRAY['hour(d)'])\", format.name()));\n+        assertUpdate(session, \"INSERT INTO test_hour_transform VALUES\" +\n+                        \"(TIMESTAMP '2015-01-01 10:01:23', 1),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:10:02', 2),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:55:00', 3),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:05:01', 4),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:21:02', 5),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:11:11', 6),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:12:12', 7)\",\n+                7);\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM \\\"test_hour_transform$partitions\\\"\", \"SELECT 3\");\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM test_hour_transform WHERE hour(d) = 10\", \"SELECT 3\");\n+        // 394460 = (2015 - 1970) * 365 * 24 + leap day hours + 10\n+        // Parquet has min/max for timestamps but Orc does not.\n+        String expected = format == FileFormat.PARQUET ? \"VALUES(394460, 3, TIMESTAMP '2015-01-01 10:01:23', TIMESTAMP '2015-01-01 10:55:00', 1, 3)\" : \"VALUES(394460, 3, NULL, NULL, 1, 3)\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ1OTY5NQ==", "bodyText": "Changed in the three places it was done.", "url": "https://github.com/trinodb/trino/pull/4579#discussion_r465459695", "createdAt": "2020-08-05T04:07:11Z", "author": {"login": "djsstarburst"}, "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -593,6 +593,210 @@ private void testPredicating(Session session, FileFormat fileFormat)\n         dropTable(session, \"test_predicating_on_real\");\n     }\n \n+    @Test\n+    public void testDateTransforms()\n+    {\n+        testWithAllFileFormats(this::testDateTransformsForFormat);\n+    }\n+\n+    private void testDateTransformsForFormat(Session session, FileFormat format)\n+    {\n+        testHourTransformForFormat(session, format);\n+        testDayTransformForFormat(session, format);\n+        testMonthTransformForFormat(session, format);\n+        testYearTransformForFormat(session, format);\n+    }\n+\n+    private void testHourTransformForFormat(Session session, FileFormat format)\n+    {\n+        String select = \"SELECT d_hour, row_count, d.min AS d_min, d.max AS d_max, b.min AS b_min, b.max AS b_max FROM \\\"test_hour_transform$partitions\\\"\";\n+\n+        assertUpdate(session, format(\"CREATE TABLE test_hour_transform (d TIMESTAMP, b BIGINT)\" +\n+                \" WITH (format = '%s', partitioning = ARRAY['hour(d)'])\", format.name()));\n+        assertUpdate(session, \"INSERT INTO test_hour_transform VALUES\" +\n+                        \"(TIMESTAMP '2015-01-01 10:01:23', 1),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:10:02', 2),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:55:00', 3),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:05:01', 4),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:21:02', 5),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:11:11', 6),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:12:12', 7)\",\n+                7);\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM \\\"test_hour_transform$partitions\\\"\", \"SELECT 3\");\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM test_hour_transform WHERE hour(d) = 10\", \"SELECT 3\");\n+        // 394460 = (2015 - 1970) * 365 * 24 + leap day hours + 10\n+        // Parquet has min/max for timestamps but Orc does not.\n+        String expected = format == FileFormat.PARQUET ? \"VALUES(394460, 3, TIMESTAMP '2015-01-01 10:01:23', TIMESTAMP '2015-01-01 10:55:00', 1, 3)\" : \"VALUES(394460, 3, NULL, NULL, 1, 3)\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5MjQ2Ng=="}, "originalCommit": null, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNjEwOTgzOnYy", "diffSide": "RIGHT", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDowMDoxM1rOG7vd_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNDowNzowOFrOG75Z4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5Njg5NQ==", "bodyText": "We should test day/month/year transform for timestamp as well. It's fine to do this as a follow up.", "url": "https://github.com/trinodb/trino/pull/4579#discussion_r465296895", "createdAt": "2020-08-04T20:00:13Z", "author": {"login": "electrum"}, "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -593,6 +593,210 @@ private void testPredicating(Session session, FileFormat fileFormat)\n         dropTable(session, \"test_predicating_on_real\");\n     }\n \n+    @Test\n+    public void testDateTransforms()\n+    {\n+        testWithAllFileFormats(this::testDateTransformsForFormat);\n+    }\n+\n+    private void testDateTransformsForFormat(Session session, FileFormat format)\n+    {\n+        testHourTransformForFormat(session, format);\n+        testDayTransformForFormat(session, format);\n+        testMonthTransformForFormat(session, format);\n+        testYearTransformForFormat(session, format);\n+    }\n+\n+    private void testHourTransformForFormat(Session session, FileFormat format)\n+    {\n+        String select = \"SELECT d_hour, row_count, d.min AS d_min, d.max AS d_max, b.min AS b_min, b.max AS b_max FROM \\\"test_hour_transform$partitions\\\"\";\n+\n+        assertUpdate(session, format(\"CREATE TABLE test_hour_transform (d TIMESTAMP, b BIGINT)\" +\n+                \" WITH (format = '%s', partitioning = ARRAY['hour(d)'])\", format.name()));\n+        assertUpdate(session, \"INSERT INTO test_hour_transform VALUES\" +\n+                        \"(TIMESTAMP '2015-01-01 10:01:23', 1),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:10:02', 2),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:55:00', 3),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:05:01', 4),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:21:02', 5),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:11:11', 6),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:12:12', 7)\",\n+                7);\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM \\\"test_hour_transform$partitions\\\"\", \"SELECT 3\");\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM test_hour_transform WHERE hour(d) = 10\", \"SELECT 3\");\n+        // 394460 = (2015 - 1970) * 365 * 24 + leap day hours + 10\n+        // Parquet has min/max for timestamps but Orc does not.\n+        String expected = format == FileFormat.PARQUET ? \"VALUES(394460, 3, TIMESTAMP '2015-01-01 10:01:23', TIMESTAMP '2015-01-01 10:55:00', 1, 3)\" : \"VALUES(394460, 3, NULL, NULL, 1, 3)\";\n+        assertQuery(session, select + \" WHERE d_hour = 394460\", expected);\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM test_hour_transform WHERE hour(d) = 12\", \"SELECT 2\");\n+        expected = format == FileFormat.PARQUET ? \"VALUES(397679, 2, TIMESTAMP '2015-05-15 12:05:01', TIMESTAMP '2015-05-15 12:21:02', 4, 5)\" : \"VALUES(397679, 2, NULL, NULL, 4, 5)\";\n+        assertQuery(session, select + \" WHERE d_hour = 397679\", expected);\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM test_hour_transform WHERE hour(d) = 13\", \"SELECT 2\");\n+        expected = format == FileFormat.PARQUET ? \"VALUES(395687, 2, TIMESTAMP '2015-02-21 13:11:11', TIMESTAMP '2015-02-21 13:12:12', 6, 7)\" : \"VALUES(395687, 2, NULL, NULL, 6, 7)\";\n+        assertQuery(session, select + \" WHERE d_hour = 395687\", expected);\n+\n+        dropTable(session, \"test_hour_transform\");\n+    }\n+\n+    private void testDayTransformForFormat(Session session, FileFormat format)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ1OTY4MA==", "bodyText": "Will do as a follow-up.", "url": "https://github.com/trinodb/trino/pull/4579#discussion_r465459680", "createdAt": "2020-08-05T04:07:08Z", "author": {"login": "djsstarburst"}, "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -593,6 +593,210 @@ private void testPredicating(Session session, FileFormat fileFormat)\n         dropTable(session, \"test_predicating_on_real\");\n     }\n \n+    @Test\n+    public void testDateTransforms()\n+    {\n+        testWithAllFileFormats(this::testDateTransformsForFormat);\n+    }\n+\n+    private void testDateTransformsForFormat(Session session, FileFormat format)\n+    {\n+        testHourTransformForFormat(session, format);\n+        testDayTransformForFormat(session, format);\n+        testMonthTransformForFormat(session, format);\n+        testYearTransformForFormat(session, format);\n+    }\n+\n+    private void testHourTransformForFormat(Session session, FileFormat format)\n+    {\n+        String select = \"SELECT d_hour, row_count, d.min AS d_min, d.max AS d_max, b.min AS b_min, b.max AS b_max FROM \\\"test_hour_transform$partitions\\\"\";\n+\n+        assertUpdate(session, format(\"CREATE TABLE test_hour_transform (d TIMESTAMP, b BIGINT)\" +\n+                \" WITH (format = '%s', partitioning = ARRAY['hour(d)'])\", format.name()));\n+        assertUpdate(session, \"INSERT INTO test_hour_transform VALUES\" +\n+                        \"(TIMESTAMP '2015-01-01 10:01:23', 1),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:10:02', 2),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:55:00', 3),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:05:01', 4),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:21:02', 5),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:11:11', 6),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:12:12', 7)\",\n+                7);\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM \\\"test_hour_transform$partitions\\\"\", \"SELECT 3\");\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM test_hour_transform WHERE hour(d) = 10\", \"SELECT 3\");\n+        // 394460 = (2015 - 1970) * 365 * 24 + leap day hours + 10\n+        // Parquet has min/max for timestamps but Orc does not.\n+        String expected = format == FileFormat.PARQUET ? \"VALUES(394460, 3, TIMESTAMP '2015-01-01 10:01:23', TIMESTAMP '2015-01-01 10:55:00', 1, 3)\" : \"VALUES(394460, 3, NULL, NULL, 1, 3)\";\n+        assertQuery(session, select + \" WHERE d_hour = 394460\", expected);\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM test_hour_transform WHERE hour(d) = 12\", \"SELECT 2\");\n+        expected = format == FileFormat.PARQUET ? \"VALUES(397679, 2, TIMESTAMP '2015-05-15 12:05:01', TIMESTAMP '2015-05-15 12:21:02', 4, 5)\" : \"VALUES(397679, 2, NULL, NULL, 4, 5)\";\n+        assertQuery(session, select + \" WHERE d_hour = 397679\", expected);\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM test_hour_transform WHERE hour(d) = 13\", \"SELECT 2\");\n+        expected = format == FileFormat.PARQUET ? \"VALUES(395687, 2, TIMESTAMP '2015-02-21 13:11:11', TIMESTAMP '2015-02-21 13:12:12', 6, 7)\" : \"VALUES(395687, 2, NULL, NULL, 6, 7)\";\n+        assertQuery(session, select + \" WHERE d_hour = 395687\", expected);\n+\n+        dropTable(session, \"test_hour_transform\");\n+    }\n+\n+    private void testDayTransformForFormat(Session session, FileFormat format)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5Njg5NQ=="}, "originalCommit": null, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNjExNDA5OnYy", "diffSide": "RIGHT", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDowMTozMFrOG7vgtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNDowNzowNFrOG75Zwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5NzU4OA==", "bodyText": "Nit: all capital ORC", "url": "https://github.com/trinodb/trino/pull/4579#discussion_r465297588", "createdAt": "2020-08-04T20:01:30Z", "author": {"login": "electrum"}, "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -593,6 +593,210 @@ private void testPredicating(Session session, FileFormat fileFormat)\n         dropTable(session, \"test_predicating_on_real\");\n     }\n \n+    @Test\n+    public void testDateTransforms()\n+    {\n+        testWithAllFileFormats(this::testDateTransformsForFormat);\n+    }\n+\n+    private void testDateTransformsForFormat(Session session, FileFormat format)\n+    {\n+        testHourTransformForFormat(session, format);\n+        testDayTransformForFormat(session, format);\n+        testMonthTransformForFormat(session, format);\n+        testYearTransformForFormat(session, format);\n+    }\n+\n+    private void testHourTransformForFormat(Session session, FileFormat format)\n+    {\n+        String select = \"SELECT d_hour, row_count, d.min AS d_min, d.max AS d_max, b.min AS b_min, b.max AS b_max FROM \\\"test_hour_transform$partitions\\\"\";\n+\n+        assertUpdate(session, format(\"CREATE TABLE test_hour_transform (d TIMESTAMP, b BIGINT)\" +\n+                \" WITH (format = '%s', partitioning = ARRAY['hour(d)'])\", format.name()));\n+        assertUpdate(session, \"INSERT INTO test_hour_transform VALUES\" +\n+                        \"(TIMESTAMP '2015-01-01 10:01:23', 1),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:10:02', 2),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:55:00', 3),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:05:01', 4),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:21:02', 5),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:11:11', 6),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:12:12', 7)\",\n+                7);\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM \\\"test_hour_transform$partitions\\\"\", \"SELECT 3\");\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM test_hour_transform WHERE hour(d) = 10\", \"SELECT 3\");\n+        // 394460 = (2015 - 1970) * 365 * 24 + leap day hours + 10\n+        // Parquet has min/max for timestamps but Orc does not.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ1OTY1MA==", "bodyText": "Capitalized.", "url": "https://github.com/trinodb/trino/pull/4579#discussion_r465459650", "createdAt": "2020-08-05T04:07:04Z", "author": {"login": "djsstarburst"}, "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -593,6 +593,210 @@ private void testPredicating(Session session, FileFormat fileFormat)\n         dropTable(session, \"test_predicating_on_real\");\n     }\n \n+    @Test\n+    public void testDateTransforms()\n+    {\n+        testWithAllFileFormats(this::testDateTransformsForFormat);\n+    }\n+\n+    private void testDateTransformsForFormat(Session session, FileFormat format)\n+    {\n+        testHourTransformForFormat(session, format);\n+        testDayTransformForFormat(session, format);\n+        testMonthTransformForFormat(session, format);\n+        testYearTransformForFormat(session, format);\n+    }\n+\n+    private void testHourTransformForFormat(Session session, FileFormat format)\n+    {\n+        String select = \"SELECT d_hour, row_count, d.min AS d_min, d.max AS d_max, b.min AS b_min, b.max AS b_max FROM \\\"test_hour_transform$partitions\\\"\";\n+\n+        assertUpdate(session, format(\"CREATE TABLE test_hour_transform (d TIMESTAMP, b BIGINT)\" +\n+                \" WITH (format = '%s', partitioning = ARRAY['hour(d)'])\", format.name()));\n+        assertUpdate(session, \"INSERT INTO test_hour_transform VALUES\" +\n+                        \"(TIMESTAMP '2015-01-01 10:01:23', 1),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:10:02', 2),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:55:00', 3),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:05:01', 4),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:21:02', 5),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:11:11', 6),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:12:12', 7)\",\n+                7);\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM \\\"test_hour_transform$partitions\\\"\", \"SELECT 3\");\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM test_hour_transform WHERE hour(d) = 10\", \"SELECT 3\");\n+        // 394460 = (2015 - 1970) * 365 * 24 + leap day hours + 10\n+        // Parquet has min/max for timestamps but Orc does not.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5NzU4OA=="}, "originalCommit": null, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNjExODkyOnYy", "diffSide": "RIGHT", "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDowMzowNlrOG7vj1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNDowNzowMFrOG75Ztw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5ODM5MQ==", "bodyText": "What time zone are the tests using? Can you check if they're using legacy timestamps? If it's not UTC time zone and legacy timestamps, I'm surprised this works.", "url": "https://github.com/trinodb/trino/pull/4579#discussion_r465298391", "createdAt": "2020-08-04T20:03:06Z", "author": {"login": "electrum"}, "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -593,6 +593,210 @@ private void testPredicating(Session session, FileFormat fileFormat)\n         dropTable(session, \"test_predicating_on_real\");\n     }\n \n+    @Test\n+    public void testDateTransforms()\n+    {\n+        testWithAllFileFormats(this::testDateTransformsForFormat);\n+    }\n+\n+    private void testDateTransformsForFormat(Session session, FileFormat format)\n+    {\n+        testHourTransformForFormat(session, format);\n+        testDayTransformForFormat(session, format);\n+        testMonthTransformForFormat(session, format);\n+        testYearTransformForFormat(session, format);\n+    }\n+\n+    private void testHourTransformForFormat(Session session, FileFormat format)\n+    {\n+        String select = \"SELECT d_hour, row_count, d.min AS d_min, d.max AS d_max, b.min AS b_min, b.max AS b_max FROM \\\"test_hour_transform$partitions\\\"\";\n+\n+        assertUpdate(session, format(\"CREATE TABLE test_hour_transform (d TIMESTAMP, b BIGINT)\" +\n+                \" WITH (format = '%s', partitioning = ARRAY['hour(d)'])\", format.name()));\n+        assertUpdate(session, \"INSERT INTO test_hour_transform VALUES\" +\n+                        \"(TIMESTAMP '2015-01-01 10:01:23', 1),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:10:02', 2),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:55:00', 3),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:05:01', 4),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:21:02', 5),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:11:11', 6),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:12:12', 7)\",\n+                7);\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM \\\"test_hour_transform$partitions\\\"\", \"SELECT 3\");\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM test_hour_transform WHERE hour(d) = 10\", \"SELECT 3\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5OTYzMQ==", "bodyText": "Can you change all of these to use SELECT d so that we confirm the exact timestamps we expect are returned? Same goes for all of the tests that use SELECT count(*)", "url": "https://github.com/trinodb/trino/pull/4579#discussion_r465299631", "createdAt": "2020-08-04T20:05:36Z", "author": {"login": "electrum"}, "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -593,6 +593,210 @@ private void testPredicating(Session session, FileFormat fileFormat)\n         dropTable(session, \"test_predicating_on_real\");\n     }\n \n+    @Test\n+    public void testDateTransforms()\n+    {\n+        testWithAllFileFormats(this::testDateTransformsForFormat);\n+    }\n+\n+    private void testDateTransformsForFormat(Session session, FileFormat format)\n+    {\n+        testHourTransformForFormat(session, format);\n+        testDayTransformForFormat(session, format);\n+        testMonthTransformForFormat(session, format);\n+        testYearTransformForFormat(session, format);\n+    }\n+\n+    private void testHourTransformForFormat(Session session, FileFormat format)\n+    {\n+        String select = \"SELECT d_hour, row_count, d.min AS d_min, d.max AS d_max, b.min AS b_min, b.max AS b_max FROM \\\"test_hour_transform$partitions\\\"\";\n+\n+        assertUpdate(session, format(\"CREATE TABLE test_hour_transform (d TIMESTAMP, b BIGINT)\" +\n+                \" WITH (format = '%s', partitioning = ARRAY['hour(d)'])\", format.name()));\n+        assertUpdate(session, \"INSERT INTO test_hour_transform VALUES\" +\n+                        \"(TIMESTAMP '2015-01-01 10:01:23', 1),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:10:02', 2),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:55:00', 3),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:05:01', 4),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:21:02', 5),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:11:11', 6),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:12:12', 7)\",\n+                7);\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM \\\"test_hour_transform$partitions\\\"\", \"SELECT 3\");\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM test_hour_transform WHERE hour(d) = 10\", \"SELECT 3\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5ODM5MQ=="}, "originalCommit": null, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ1OTYzOQ==", "bodyText": "The Session.timeZoneKey = \"Pacific/Apia\".  The session's system properties map is empty, i.e., no legacy_timestamp property.\nI changed all the SELECT count(*) uses to explicitly test which rows were returned.", "url": "https://github.com/trinodb/trino/pull/4579#discussion_r465459639", "createdAt": "2020-08-05T04:07:00Z", "author": {"login": "djsstarburst"}, "path": "presto-iceberg/src/test/java/io/prestosql/plugin/iceberg/TestIcebergSmoke.java", "diffHunk": "@@ -593,6 +593,210 @@ private void testPredicating(Session session, FileFormat fileFormat)\n         dropTable(session, \"test_predicating_on_real\");\n     }\n \n+    @Test\n+    public void testDateTransforms()\n+    {\n+        testWithAllFileFormats(this::testDateTransformsForFormat);\n+    }\n+\n+    private void testDateTransformsForFormat(Session session, FileFormat format)\n+    {\n+        testHourTransformForFormat(session, format);\n+        testDayTransformForFormat(session, format);\n+        testMonthTransformForFormat(session, format);\n+        testYearTransformForFormat(session, format);\n+    }\n+\n+    private void testHourTransformForFormat(Session session, FileFormat format)\n+    {\n+        String select = \"SELECT d_hour, row_count, d.min AS d_min, d.max AS d_max, b.min AS b_min, b.max AS b_max FROM \\\"test_hour_transform$partitions\\\"\";\n+\n+        assertUpdate(session, format(\"CREATE TABLE test_hour_transform (d TIMESTAMP, b BIGINT)\" +\n+                \" WITH (format = '%s', partitioning = ARRAY['hour(d)'])\", format.name()));\n+        assertUpdate(session, \"INSERT INTO test_hour_transform VALUES\" +\n+                        \"(TIMESTAMP '2015-01-01 10:01:23', 1),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:10:02', 2),\" +\n+                        \"(TIMESTAMP '2015-01-01 10:55:00', 3),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:05:01', 4),\" +\n+                        \"(TIMESTAMP '2015-05-15 12:21:02', 5),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:11:11', 6),\" +\n+                        \"(TIMESTAMP '2015-02-21 13:12:12', 7)\",\n+                7);\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM \\\"test_hour_transform$partitions\\\"\", \"SELECT 3\");\n+\n+        assertQuery(session, \"SELECT COUNT(*) FROM test_hour_transform WHERE hour(d) = 10\", \"SELECT 3\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI5ODM5MQ=="}, "originalCommit": null, "originalPosition": 45}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3773, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}