{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1MDc0Mzg0", "number": 4372, "title": "Add salesforce authenticator.", "bodyText": "This allows Presto admins to enable users to authenticate to Presto via Salesforce username and password/token. This is not a Salesforce connector, and does not allow users to query Salesforce data. It's simply a means by which users can authenticate to Presto, similar to LDAP or password file.\nThere is a single layer of security beyond simply providing username and password/token, which is that the admin can configure, via salesforce.org in etc/password-authenticator.properties, one or more 18 character Salesforce Organization Id's in a comma separated list. The user's successful login to Salesforce must return a matching Organization Id. Optionally, the admin can configure \"all\" to explicitly ignore this layer of security.\n@lhofhansl", "createdAt": "2020-07-07T00:50:55Z", "url": "https://github.com/trinodb/trino/pull/4372", "merged": true, "mergeCommit": {"oid": "7bdb74cc7c250119551025d1baadc0ad4411f657"}, "closed": true, "closedAt": "2020-08-14T20:38:28Z", "author": {"login": "weissleb"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcya1B6gH2gAyNDQ1MDc0Mzg0OmY3YzUxOTRlMzZmYWJkNDg4ODcxNGE3NjRjNjRjODExOWQ0YjkxOGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8cdycgFqTQ2MzAyMTk5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c", "author": {"user": {"login": "bweissler-sf", "name": "Brian Weissler"}}, "url": "https://github.com/trinodb/trino/commit/f7c5194e36fabd4888714a764c64c8119d4b918c", "committedDate": "2020-07-07T00:37:45Z", "message": "Add salesforce authenticator."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMDkyMDg2", "url": "https://github.com/trinodb/trino/pull/4372#pullrequestreview-451092086", "createdAt": "2020-07-19T01:34:21Z", "commit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "state": "COMMENTED", "comments": {"totalCount": 34, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQwMTozNDoyMVrOGzrr0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQwMzoxMDoyN1rOGzsD2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0NjI5MA==", "bodyText": "[style] Instead of aligned end of line comments, we place comments above the field.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456846290", "createdAt": "2020-07-19T01:34:21Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0NjM5MA==", "bodyText": "I'm pretty sure this and responseMap can be final.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456846390", "createdAt": "2020-07-19T01:35:28Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0NjQyNw==", "bodyText": "Make a defensive copy with ImmutableSet.copyOf(config.getOrgSet())", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456846427", "createdAt": "2020-07-19T01:36:07Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.\n+    private Map<String, String> responseMap = new HashMap<>();  // A flattened map of xml elements from the Salesforce login response.\n+    private String key = \"\";                                    // Will hold the xml element tag, we can add to the map with its text attribute.\n+    private final HttpClient httpClient;                        // An http client for posting to the Salesforce login endpoint.\n+    private final LoadingCache<Credential, Principal> userCache;\n+\n+    private final Locale locale = Locale.US;                    // Tested API request and response for user with Japanese locale and language preference,\n+    // and responses are English, and organization id is not in Japaneses characters (this is\n+    // also true of the organization id in the UI, even with other text showing in Japanese).\n+\n+    @Inject\n+    public SalesforceBasicAuthenticator(SalesforceConfig config, @SalesforceAuthenticationClient HttpClient httpClient)\n+    {\n+        this.orgs = config.getOrgSet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0NjY3Nw==", "bodyText": "check not null:\nthis.httpClient = requireNonNull(httpClient, \"httpClient is null\");", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456846677", "createdAt": "2020-07-19T01:39:56Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.\n+    private Map<String, String> responseMap = new HashMap<>();  // A flattened map of xml elements from the Salesforce login response.\n+    private String key = \"\";                                    // Will hold the xml element tag, we can add to the map with its text attribute.\n+    private final HttpClient httpClient;                        // An http client for posting to the Salesforce login endpoint.\n+    private final LoadingCache<Credential, Principal> userCache;\n+\n+    private final Locale locale = Locale.US;                    // Tested API request and response for user with Japanese locale and language preference,\n+    // and responses are English, and organization id is not in Japaneses characters (this is\n+    // also true of the organization id in the UI, even with other text showing in Japanese).\n+\n+    @Inject\n+    public SalesforceBasicAuthenticator(SalesforceConfig config, @SalesforceAuthenticationClient HttpClient httpClient)\n+    {\n+        this.orgs = config.getOrgSet();\n+        this.httpClient = httpClient;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0OTcxMw==", "bodyText": "I don't think this parsing code is thread safe.  I think this can be done much simpler without converting the whole response into a map.  After playing with the Document APIs for a little bit, here is what I came up with:\n        Document xmlResponse;\n        try {\n            DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n            DocumentBuilder builder = factory.newDocumentBuilder();\n            xmlResponse = builder.parse(new InputSource(new StringReader(response.getBody())));\n        }\n        catch (ParserConfigurationException | SAXException | IOException  e) {\n            throw new RuntimeException(String.format(\n                    \"Error parsing response: %s\\n\\tReceived error message: %s\",\n                    response.getBody(),\n                    e.getMessage()));\n        }\n\n        // sessionId is required by not used\n        getElementValue(xmlResponse, \"sessionId\");\n\n        // Verify organization is in allowed o\n        String returnedOrg = getElementValue(xmlResponse, \"organizationId\");\n        if (!(allowedOrganization.size() == 1 && allowedOrganization.contains(\"all\")) && !allowedOrganization.contains(returnedOrg.toLowerCase(US))) {\n            throw new AccessDeniedException(String.format(\n                    \"Login successful, but for wrong Salesforce org.  Got %s, but expected a different org.\",\n                    returnedOrg));\n        }\n        return new BasicPrincipal(username);\n    }\n\n    private static String getElementValue(Document document, String elementName)\n    {\n        NodeList nodeList = document.getElementsByTagName(elementName);\n        if (nodeList.getLength() == 0) {\n            throw new RuntimeException(String.format(\"Salesforce login response does not contain a '%s' entry\", elementName));\n        }\n        if (nodeList.getLength() > 1) {\n            throw new RuntimeException(String.format(\"Salesforce login response contains multiple '%s' entries\", elementName));\n        }\n        String content = emptyToNull(nodeList.item(0).getTextContent());\n        if (content == null) {\n            throw new RuntimeException(String.format(\"Salesforce login response contains an empty '%s' entry\", elementName));\n        }\n        return content;\n    }", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456849713", "createdAt": "2020-07-19T02:27:30Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.\n+    private Map<String, String> responseMap = new HashMap<>();  // A flattened map of xml elements from the Salesforce login response.\n+    private String key = \"\";                                    // Will hold the xml element tag, we can add to the map with its text attribute.\n+    private final HttpClient httpClient;                        // An http client for posting to the Salesforce login endpoint.\n+    private final LoadingCache<Credential, Principal> userCache;\n+\n+    private final Locale locale = Locale.US;                    // Tested API request and response for user with Japanese locale and language preference,\n+    // and responses are English, and organization id is not in Japaneses characters (this is\n+    // also true of the organization id in the UI, even with other text showing in Japanese).\n+\n+    @Inject\n+    public SalesforceBasicAuthenticator(SalesforceConfig config, @SalesforceAuthenticationClient HttpClient httpClient)\n+    {\n+        this.orgs = config.getOrgSet();\n+        this.httpClient = httpClient;\n+\n+        this.userCache = CacheBuilder.newBuilder()\n+                .maximumSize(config.getCacheSize())\n+                .expireAfterWrite(config.getCacheExpireSeconds(), TimeUnit.SECONDS)\n+                .build(CacheLoader.from(this::doLogin));\n+    }\n+\n+    @Override\n+    public Principal createAuthenticatedPrincipal(String username, String password)\n+    {\n+        try (ThreadContextClassLoader ignored = new ThreadContextClassLoader(getClass().getClassLoader())) {\n+            return userCache.getUnchecked(new Credential(username, password));\n+        }\n+        catch (UncheckedExecutionException e) {\n+            throwIfInstanceOf(e.getCause(), AccessDeniedException.class);\n+            throw e;\n+        }\n+    }\n+\n+    // This does the work of logging into Salesforce.\n+    private Principal doLogin(Credential credential)\n+    {\n+        log.info(\"Logging into Salesforce.\");\n+        String username = credential.getUser();\n+        String password = credential.getPassword();\n+\n+        // Login requests must be POSTs\n+        Request request = new Request.Builder()\n+                .setUri(URI.create(LOGINURL + APIVERSION))\n+                .setHeader(\"Content-Type\", \"text/xml;charset=UTF-8\")\n+                .setHeader(\"SOAPAction\", \"login\")\n+                .setMethod(\"POST\")\n+                .setBodyGenerator(StaticBodyGenerator.createStaticBodyGenerator(String.format(LOGIN_SOAP_MESSAGE, username, password), UTF_8))\n+                .build();\n+\n+        StringResponseHandler.StringResponse response = httpClient.execute(request, StringResponseHandler.createStringResponseHandler());\n+\n+        final int statusCode = response.getStatusCode();\n+        if (statusCode < 200 || statusCode >= 300) {\n+            throw new AccessDeniedException(String.format(\"Invalid response for login [%s]: %s. %s\",\n+                    statusCode,\n+                    response.getBody(),\n+                    response.getHeaders()));\n+        }\n+\n+        Document xmlResponse;\n+        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+        DocumentBuilder builder;\n+        try {\n+            builder = factory.newDocumentBuilder();\n+            xmlResponse = builder.parse(new InputSource(new StringReader(\n+                    response.getBody())));\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(String.format(\"Error parsing response: %s\\n\\tReceived error message: %s\",\n+                    response.getBody(),\n+                    e.getMessage()));\n+        }\n+\n+        // Parse the response into a flattened map.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0OTgyNA==", "bodyText": "I suggest renaming this to allowedOrganization and then we can remove the comment as the usage is obvious.  Also, we generally try to avoid abbreviations, because they can be difficult for non-native speakers to understand.  In the case \"org\" is pretty common, so it wouldn't necessary need a change, but I think allowedOrganization is much more understandable.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456849824", "createdAt": "2020-07-19T02:29:29Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0OTg0Ng==", "bodyText": "The comment is necessary as the usage is obvious.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456849846", "createdAt": "2020-07-19T02:29:51Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.\n+    private Map<String, String> responseMap = new HashMap<>();  // A flattened map of xml elements from the Salesforce login response.\n+    private String key = \"\";                                    // Will hold the xml element tag, we can add to the map with its text attribute.\n+    private final HttpClient httpClient;                        // An http client for posting to the Salesforce login endpoint.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MDA3Ng==", "bodyText": "I'd inline this into the usage.  I don't think the comment isn't really necessary here, and this code is really only following the lower in the config class.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456850076", "createdAt": "2020-07-19T02:33:37Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.\n+    private Map<String, String> responseMap = new HashMap<>();  // A flattened map of xml elements from the Salesforce login response.\n+    private String key = \"\";                                    // Will hold the xml element tag, we can add to the map with its text attribute.\n+    private final HttpClient httpClient;                        // An http client for posting to the Salesforce login endpoint.\n+    private final LoadingCache<Credential, Principal> userCache;\n+\n+    private final Locale locale = Locale.US;                    // Tested API request and response for user with Japanese locale and language preference,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MDA4OQ==", "bodyText": "(nit) static import SECONDS", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456850089", "createdAt": "2020-07-19T02:33:57Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.\n+    private Map<String, String> responseMap = new HashMap<>();  // A flattened map of xml elements from the Salesforce login response.\n+    private String key = \"\";                                    // Will hold the xml element tag, we can add to the map with its text attribute.\n+    private final HttpClient httpClient;                        // An http client for posting to the Salesforce login endpoint.\n+    private final LoadingCache<Credential, Principal> userCache;\n+\n+    private final Locale locale = Locale.US;                    // Tested API request and response for user with Japanese locale and language preference,\n+    // and responses are English, and organization id is not in Japaneses characters (this is\n+    // also true of the organization id in the UI, even with other text showing in Japanese).\n+\n+    @Inject\n+    public SalesforceBasicAuthenticator(SalesforceConfig config, @SalesforceAuthenticationClient HttpClient httpClient)\n+    {\n+        this.orgs = config.getOrgSet();\n+        this.httpClient = httpClient;\n+\n+        this.userCache = CacheBuilder.newBuilder()\n+                .maximumSize(config.getCacheSize())\n+                .expireAfterWrite(config.getCacheExpireSeconds(), TimeUnit.SECONDS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MDE1Mg==", "bodyText": "Is the ThreadContextClassLoader required here?  I don't think anything inside of this method uses a special class loader.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456850152", "createdAt": "2020-07-19T02:34:57Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.\n+    private Map<String, String> responseMap = new HashMap<>();  // A flattened map of xml elements from the Salesforce login response.\n+    private String key = \"\";                                    // Will hold the xml element tag, we can add to the map with its text attribute.\n+    private final HttpClient httpClient;                        // An http client for posting to the Salesforce login endpoint.\n+    private final LoadingCache<Credential, Principal> userCache;\n+\n+    private final Locale locale = Locale.US;                    // Tested API request and response for user with Japanese locale and language preference,\n+    // and responses are English, and organization id is not in Japaneses characters (this is\n+    // also true of the organization id in the UI, even with other text showing in Japanese).\n+\n+    @Inject\n+    public SalesforceBasicAuthenticator(SalesforceConfig config, @SalesforceAuthenticationClient HttpClient httpClient)\n+    {\n+        this.orgs = config.getOrgSet();\n+        this.httpClient = httpClient;\n+\n+        this.userCache = CacheBuilder.newBuilder()\n+                .maximumSize(config.getCacheSize())\n+                .expireAfterWrite(config.getCacheExpireSeconds(), TimeUnit.SECONDS)\n+                .build(CacheLoader.from(this::doLogin));\n+    }\n+\n+    @Override\n+    public Principal createAuthenticatedPrincipal(String username, String password)\n+    {\n+        try (ThreadContextClassLoader ignored = new ThreadContextClassLoader(getClass().getClassLoader())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MDI3Mg==", "bodyText": "I don't think this will be helpful in a production server.  I would remove this message", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456850272", "createdAt": "2020-07-19T02:36:24Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.\n+    private Map<String, String> responseMap = new HashMap<>();  // A flattened map of xml elements from the Salesforce login response.\n+    private String key = \"\";                                    // Will hold the xml element tag, we can add to the map with its text attribute.\n+    private final HttpClient httpClient;                        // An http client for posting to the Salesforce login endpoint.\n+    private final LoadingCache<Credential, Principal> userCache;\n+\n+    private final Locale locale = Locale.US;                    // Tested API request and response for user with Japanese locale and language preference,\n+    // and responses are English, and organization id is not in Japaneses characters (this is\n+    // also true of the organization id in the UI, even with other text showing in Japanese).\n+\n+    @Inject\n+    public SalesforceBasicAuthenticator(SalesforceConfig config, @SalesforceAuthenticationClient HttpClient httpClient)\n+    {\n+        this.orgs = config.getOrgSet();\n+        this.httpClient = httpClient;\n+\n+        this.userCache = CacheBuilder.newBuilder()\n+                .maximumSize(config.getCacheSize())\n+                .expireAfterWrite(config.getCacheExpireSeconds(), TimeUnit.SECONDS)\n+                .build(CacheLoader.from(this::doLogin));\n+    }\n+\n+    @Override\n+    public Principal createAuthenticatedPrincipal(String username, String password)\n+    {\n+        try (ThreadContextClassLoader ignored = new ThreadContextClassLoader(getClass().getClassLoader())) {\n+            return userCache.getUnchecked(new Credential(username, password));\n+        }\n+        catch (UncheckedExecutionException e) {\n+            throwIfInstanceOf(e.getCause(), AccessDeniedException.class);\n+            throw e;\n+        }\n+    }\n+\n+    // This does the work of logging into Salesforce.\n+    private Principal doLogin(Credential credential)\n+    {\n+        log.info(\"Logging into Salesforce.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MDMyMQ==", "bodyText": "(nit) static import createStaticBodyGenerator.  The factory methods that are named createFullClassName are designed to be static imported`", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456850321", "createdAt": "2020-07-19T02:37:16Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.\n+    private Map<String, String> responseMap = new HashMap<>();  // A flattened map of xml elements from the Salesforce login response.\n+    private String key = \"\";                                    // Will hold the xml element tag, we can add to the map with its text attribute.\n+    private final HttpClient httpClient;                        // An http client for posting to the Salesforce login endpoint.\n+    private final LoadingCache<Credential, Principal> userCache;\n+\n+    private final Locale locale = Locale.US;                    // Tested API request and response for user with Japanese locale and language preference,\n+    // and responses are English, and organization id is not in Japaneses characters (this is\n+    // also true of the organization id in the UI, even with other text showing in Japanese).\n+\n+    @Inject\n+    public SalesforceBasicAuthenticator(SalesforceConfig config, @SalesforceAuthenticationClient HttpClient httpClient)\n+    {\n+        this.orgs = config.getOrgSet();\n+        this.httpClient = httpClient;\n+\n+        this.userCache = CacheBuilder.newBuilder()\n+                .maximumSize(config.getCacheSize())\n+                .expireAfterWrite(config.getCacheExpireSeconds(), TimeUnit.SECONDS)\n+                .build(CacheLoader.from(this::doLogin));\n+    }\n+\n+    @Override\n+    public Principal createAuthenticatedPrincipal(String username, String password)\n+    {\n+        try (ThreadContextClassLoader ignored = new ThreadContextClassLoader(getClass().getClassLoader())) {\n+            return userCache.getUnchecked(new Credential(username, password));\n+        }\n+        catch (UncheckedExecutionException e) {\n+            throwIfInstanceOf(e.getCause(), AccessDeniedException.class);\n+            throw e;\n+        }\n+    }\n+\n+    // This does the work of logging into Salesforce.\n+    private Principal doLogin(Credential credential)\n+    {\n+        log.info(\"Logging into Salesforce.\");\n+        String username = credential.getUser();\n+        String password = credential.getPassword();\n+\n+        // Login requests must be POSTs\n+        Request request = new Request.Builder()\n+                .setUri(URI.create(LOGINURL + APIVERSION))\n+                .setHeader(\"Content-Type\", \"text/xml;charset=UTF-8\")\n+                .setHeader(\"SOAPAction\", \"login\")\n+                .setMethod(\"POST\")\n+                .setBodyGenerator(StaticBodyGenerator.createStaticBodyGenerator(String.format(LOGIN_SOAP_MESSAGE, username, password), UTF_8))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MDM3NA==", "bodyText": "(nit) We don't use final on local variables in Presto", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456850374", "createdAt": "2020-07-19T02:38:23Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.\n+    private Map<String, String> responseMap = new HashMap<>();  // A flattened map of xml elements from the Salesforce login response.\n+    private String key = \"\";                                    // Will hold the xml element tag, we can add to the map with its text attribute.\n+    private final HttpClient httpClient;                        // An http client for posting to the Salesforce login endpoint.\n+    private final LoadingCache<Credential, Principal> userCache;\n+\n+    private final Locale locale = Locale.US;                    // Tested API request and response for user with Japanese locale and language preference,\n+    // and responses are English, and organization id is not in Japaneses characters (this is\n+    // also true of the organization id in the UI, even with other text showing in Japanese).\n+\n+    @Inject\n+    public SalesforceBasicAuthenticator(SalesforceConfig config, @SalesforceAuthenticationClient HttpClient httpClient)\n+    {\n+        this.orgs = config.getOrgSet();\n+        this.httpClient = httpClient;\n+\n+        this.userCache = CacheBuilder.newBuilder()\n+                .maximumSize(config.getCacheSize())\n+                .expireAfterWrite(config.getCacheExpireSeconds(), TimeUnit.SECONDS)\n+                .build(CacheLoader.from(this::doLogin));\n+    }\n+\n+    @Override\n+    public Principal createAuthenticatedPrincipal(String username, String password)\n+    {\n+        try (ThreadContextClassLoader ignored = new ThreadContextClassLoader(getClass().getClassLoader())) {\n+            return userCache.getUnchecked(new Credential(username, password));\n+        }\n+        catch (UncheckedExecutionException e) {\n+            throwIfInstanceOf(e.getCause(), AccessDeniedException.class);\n+            throw e;\n+        }\n+    }\n+\n+    // This does the work of logging into Salesforce.\n+    private Principal doLogin(Credential credential)\n+    {\n+        log.info(\"Logging into Salesforce.\");\n+        String username = credential.getUser();\n+        String password = credential.getPassword();\n+\n+        // Login requests must be POSTs\n+        Request request = new Request.Builder()\n+                .setUri(URI.create(LOGINURL + APIVERSION))\n+                .setHeader(\"Content-Type\", \"text/xml;charset=UTF-8\")\n+                .setHeader(\"SOAPAction\", \"login\")\n+                .setMethod(\"POST\")\n+                .setBodyGenerator(StaticBodyGenerator.createStaticBodyGenerator(String.format(LOGIN_SOAP_MESSAGE, username, password), UTF_8))\n+                .build();\n+\n+        StringResponseHandler.StringResponse response = httpClient.execute(request, StringResponseHandler.createStringResponseHandler());\n+\n+        final int statusCode = response.getStatusCode();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MDQ5NA==", "bodyText": "Instead of allowing all 2xx responses, I would check the actual response that Salesforce sends.  In this case, I would guess that the only valid response is 200.  If so, I would inline statusCode variable.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456850494", "createdAt": "2020-07-19T02:39:58Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.\n+    private Map<String, String> responseMap = new HashMap<>();  // A flattened map of xml elements from the Salesforce login response.\n+    private String key = \"\";                                    // Will hold the xml element tag, we can add to the map with its text attribute.\n+    private final HttpClient httpClient;                        // An http client for posting to the Salesforce login endpoint.\n+    private final LoadingCache<Credential, Principal> userCache;\n+\n+    private final Locale locale = Locale.US;                    // Tested API request and response for user with Japanese locale and language preference,\n+    // and responses are English, and organization id is not in Japaneses characters (this is\n+    // also true of the organization id in the UI, even with other text showing in Japanese).\n+\n+    @Inject\n+    public SalesforceBasicAuthenticator(SalesforceConfig config, @SalesforceAuthenticationClient HttpClient httpClient)\n+    {\n+        this.orgs = config.getOrgSet();\n+        this.httpClient = httpClient;\n+\n+        this.userCache = CacheBuilder.newBuilder()\n+                .maximumSize(config.getCacheSize())\n+                .expireAfterWrite(config.getCacheExpireSeconds(), TimeUnit.SECONDS)\n+                .build(CacheLoader.from(this::doLogin));\n+    }\n+\n+    @Override\n+    public Principal createAuthenticatedPrincipal(String username, String password)\n+    {\n+        try (ThreadContextClassLoader ignored = new ThreadContextClassLoader(getClass().getClassLoader())) {\n+            return userCache.getUnchecked(new Credential(username, password));\n+        }\n+        catch (UncheckedExecutionException e) {\n+            throwIfInstanceOf(e.getCause(), AccessDeniedException.class);\n+            throw e;\n+        }\n+    }\n+\n+    // This does the work of logging into Salesforce.\n+    private Principal doLogin(Credential credential)\n+    {\n+        log.info(\"Logging into Salesforce.\");\n+        String username = credential.getUser();\n+        String password = credential.getPassword();\n+\n+        // Login requests must be POSTs\n+        Request request = new Request.Builder()\n+                .setUri(URI.create(LOGINURL + APIVERSION))\n+                .setHeader(\"Content-Type\", \"text/xml;charset=UTF-8\")\n+                .setHeader(\"SOAPAction\", \"login\")\n+                .setMethod(\"POST\")\n+                .setBodyGenerator(StaticBodyGenerator.createStaticBodyGenerator(String.format(LOGIN_SOAP_MESSAGE, username, password), UTF_8))\n+                .build();\n+\n+        StringResponseHandler.StringResponse response = httpClient.execute(request, StringResponseHandler.createStringResponseHandler());\n+\n+        final int statusCode = response.getStatusCode();\n+        if (statusCode < 200 || statusCode >= 300) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MDcyMA==", "bodyText": "Exception is a bit broad, and will result in a runtime exception wrapped in a runtime exception.  Instead I would use:\ncatch (ParserConfigurationException | SAXException | IOException  e) {", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456850720", "createdAt": "2020-07-19T02:43:55Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StaticBodyGenerator;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.classloader.ThreadContextClassLoader;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+import org.xml.sax.InputSource;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.APIVERSION;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGINURL;\n+import static io.prestosql.plugin.password.salesforce.SalesforceConfig.LOGIN_SOAP_MESSAGE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    private Set<String> orgs;                                   // Set of Salesforce orgs, which users must belong to in order to authN.\n+    private Map<String, String> responseMap = new HashMap<>();  // A flattened map of xml elements from the Salesforce login response.\n+    private String key = \"\";                                    // Will hold the xml element tag, we can add to the map with its text attribute.\n+    private final HttpClient httpClient;                        // An http client for posting to the Salesforce login endpoint.\n+    private final LoadingCache<Credential, Principal> userCache;\n+\n+    private final Locale locale = Locale.US;                    // Tested API request and response for user with Japanese locale and language preference,\n+    // and responses are English, and organization id is not in Japaneses characters (this is\n+    // also true of the organization id in the UI, even with other text showing in Japanese).\n+\n+    @Inject\n+    public SalesforceBasicAuthenticator(SalesforceConfig config, @SalesforceAuthenticationClient HttpClient httpClient)\n+    {\n+        this.orgs = config.getOrgSet();\n+        this.httpClient = httpClient;\n+\n+        this.userCache = CacheBuilder.newBuilder()\n+                .maximumSize(config.getCacheSize())\n+                .expireAfterWrite(config.getCacheExpireSeconds(), TimeUnit.SECONDS)\n+                .build(CacheLoader.from(this::doLogin));\n+    }\n+\n+    @Override\n+    public Principal createAuthenticatedPrincipal(String username, String password)\n+    {\n+        try (ThreadContextClassLoader ignored = new ThreadContextClassLoader(getClass().getClassLoader())) {\n+            return userCache.getUnchecked(new Credential(username, password));\n+        }\n+        catch (UncheckedExecutionException e) {\n+            throwIfInstanceOf(e.getCause(), AccessDeniedException.class);\n+            throw e;\n+        }\n+    }\n+\n+    // This does the work of logging into Salesforce.\n+    private Principal doLogin(Credential credential)\n+    {\n+        log.info(\"Logging into Salesforce.\");\n+        String username = credential.getUser();\n+        String password = credential.getPassword();\n+\n+        // Login requests must be POSTs\n+        Request request = new Request.Builder()\n+                .setUri(URI.create(LOGINURL + APIVERSION))\n+                .setHeader(\"Content-Type\", \"text/xml;charset=UTF-8\")\n+                .setHeader(\"SOAPAction\", \"login\")\n+                .setMethod(\"POST\")\n+                .setBodyGenerator(StaticBodyGenerator.createStaticBodyGenerator(String.format(LOGIN_SOAP_MESSAGE, username, password), UTF_8))\n+                .build();\n+\n+        StringResponseHandler.StringResponse response = httpClient.execute(request, StringResponseHandler.createStringResponseHandler());\n+\n+        final int statusCode = response.getStatusCode();\n+        if (statusCode < 200 || statusCode >= 300) {\n+            throw new AccessDeniedException(String.format(\"Invalid response for login [%s]: %s. %s\",\n+                    statusCode,\n+                    response.getBody(),\n+                    response.getHeaders()));\n+        }\n+\n+        Document xmlResponse;\n+        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+        DocumentBuilder builder;\n+        try {\n+            builder = factory.newDocumentBuilder();\n+            xmlResponse = builder.parse(new InputSource(new StringReader(\n+                    response.getBody())));\n+        }\n+        catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MDgxMw==", "bodyText": "I would just inline this and drop the comment.  We can fix this later if it becomes an issue.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456850813", "createdAt": "2020-07-19T02:45:15Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceConfig.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.ConfigDescription;\n+import io.airlift.log.Logger;\n+\n+import javax.validation.constraints.Max;\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Set;\n+\n+public class SalesforceConfig\n+{\n+    private static final Logger log = Logger.get(SalesforceConfig.class);\n+\n+    protected static final String LOGINURL = \"https://login.salesforce.com/services/Soap/u/\";\n+    protected static final String APIVERSION = \"46.0\";\n+\n+    protected static final String LOGIN_SOAP_MESSAGE = \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\" ?>\\n\" +\n+            \"<env:Envelope xmlns:xsd=\\\"http://www.w3.org/2001/XMLSchema\\\"\\n\" +\n+            \"xmlns:urn=\\\"urn:enterprise.soap.sforce.com\\\"\\n\" +\n+            \"   xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"\\n\" +\n+            \"   xmlns:env=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\">\\n\" +\n+            \" <env:Header>\\n\" +\n+            \"     <urn:CallOptions>\\n\" +\n+            \"       <urn:client>presto</urn:client>\\n\" +\n+            \"     </urn:CallOptions>\\n\" +\n+            \" </env:Header>\\n\" +\n+            \" <env:Body>\\n\" +\n+            \"   <n1:login xmlns:n1=\\\"urn:partner.soap.sforce.com\\\">\\n\" +\n+            \"     <n1:username>%s</n1:username>\\n\" +\n+            \"     <n1:password>%s</n1:password>\\n\" +\n+            \"   </n1:login>\\n\" +\n+            \" </env:Body>\\n\" +\n+            \"</env:Envelope>\\n\";\n+\n+    public static final int MAX_EXPIRE = 3600;\n+    private int cacheSize = 4096;\n+    private int cacheExpireSeconds = 120;\n+    private String orgs;\n+\n+    private final Locale locale = Locale.US;    // Tested API request and response for user with Japanese locale and language preference,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MDg2Mg==", "bodyText": "Is there any reason to not have the default be \"all\"?", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456850862", "createdAt": "2020-07-19T02:46:01Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceConfig.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.ConfigDescription;\n+import io.airlift.log.Logger;\n+\n+import javax.validation.constraints.Max;\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Set;\n+\n+public class SalesforceConfig\n+{\n+    private static final Logger log = Logger.get(SalesforceConfig.class);\n+\n+    protected static final String LOGINURL = \"https://login.salesforce.com/services/Soap/u/\";\n+    protected static final String APIVERSION = \"46.0\";\n+\n+    protected static final String LOGIN_SOAP_MESSAGE = \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\" ?>\\n\" +\n+            \"<env:Envelope xmlns:xsd=\\\"http://www.w3.org/2001/XMLSchema\\\"\\n\" +\n+            \"xmlns:urn=\\\"urn:enterprise.soap.sforce.com\\\"\\n\" +\n+            \"   xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"\\n\" +\n+            \"   xmlns:env=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\">\\n\" +\n+            \" <env:Header>\\n\" +\n+            \"     <urn:CallOptions>\\n\" +\n+            \"       <urn:client>presto</urn:client>\\n\" +\n+            \"     </urn:CallOptions>\\n\" +\n+            \" </env:Header>\\n\" +\n+            \" <env:Body>\\n\" +\n+            \"   <n1:login xmlns:n1=\\\"urn:partner.soap.sforce.com\\\">\\n\" +\n+            \"     <n1:username>%s</n1:username>\\n\" +\n+            \"     <n1:password>%s</n1:password>\\n\" +\n+            \"   </n1:login>\\n\" +\n+            \" </env:Body>\\n\" +\n+            \"</env:Envelope>\\n\";\n+\n+    public static final int MAX_EXPIRE = 3600;\n+    private int cacheSize = 4096;\n+    private int cacheExpireSeconds = 120;\n+    private String orgs;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MDkxMA==", "bodyText": "I would change this to salesforce.allowed-organization, which will make usage more obvious", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456850910", "createdAt": "2020-07-19T02:46:53Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceConfig.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.ConfigDescription;\n+import io.airlift.log.Logger;\n+\n+import javax.validation.constraints.Max;\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Set;\n+\n+public class SalesforceConfig\n+{\n+    private static final Logger log = Logger.get(SalesforceConfig.class);\n+\n+    protected static final String LOGINURL = \"https://login.salesforce.com/services/Soap/u/\";\n+    protected static final String APIVERSION = \"46.0\";\n+\n+    protected static final String LOGIN_SOAP_MESSAGE = \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\" ?>\\n\" +\n+            \"<env:Envelope xmlns:xsd=\\\"http://www.w3.org/2001/XMLSchema\\\"\\n\" +\n+            \"xmlns:urn=\\\"urn:enterprise.soap.sforce.com\\\"\\n\" +\n+            \"   xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"\\n\" +\n+            \"   xmlns:env=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\">\\n\" +\n+            \" <env:Header>\\n\" +\n+            \"     <urn:CallOptions>\\n\" +\n+            \"       <urn:client>presto</urn:client>\\n\" +\n+            \"     </urn:CallOptions>\\n\" +\n+            \" </env:Header>\\n\" +\n+            \" <env:Body>\\n\" +\n+            \"   <n1:login xmlns:n1=\\\"urn:partner.soap.sforce.com\\\">\\n\" +\n+            \"     <n1:username>%s</n1:username>\\n\" +\n+            \"     <n1:password>%s</n1:password>\\n\" +\n+            \"   </n1:login>\\n\" +\n+            \" </env:Body>\\n\" +\n+            \"</env:Envelope>\\n\";\n+\n+    public static final int MAX_EXPIRE = 3600;\n+    private int cacheSize = 4096;\n+    private int cacheExpireSeconds = 120;\n+    private String orgs;\n+\n+    private final Locale locale = Locale.US;    // Tested API request and response for user with Japanese locale and language preference,\n+    // and responses are English, and organization id is not in Japaneses characters (this is\n+    // also true of the organization id in the UI, even with other text showing in Japanese).\n+\n+    @NotNull(message = \"Must set salesforce.org with one or more Salesforce 18 char OrgId's, or \\\"all\\\"\")\n+    public String getOrgs()\n+    {\n+        return orgs;\n+    }\n+\n+    public Set<String> getOrgSet()\n+    {\n+        Set<String> tmp = new HashSet<>();\n+        if (orgs == null) {\n+            orgs = \"\";\n+        }\n+        String[] orgsSplit = orgs.split(\"[,;]\");\n+        for (String s : orgsSplit) {\n+            tmp.add(s.toLowerCase(locale).trim());\n+        }\n+\n+        return tmp;\n+    }\n+\n+    @Config(\"salesforce.org\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MTE2NA==", "bodyText": "The XML document encodes this in element \"organizationId\".  Does Salesforce refer to this as OrgId in the documentation?  Also I don't think the possessive on OrgId is correct.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456851164", "createdAt": "2020-07-19T02:50:36Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceConfig.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.ConfigDescription;\n+import io.airlift.log.Logger;\n+\n+import javax.validation.constraints.Max;\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Set;\n+\n+public class SalesforceConfig\n+{\n+    private static final Logger log = Logger.get(SalesforceConfig.class);\n+\n+    protected static final String LOGINURL = \"https://login.salesforce.com/services/Soap/u/\";\n+    protected static final String APIVERSION = \"46.0\";\n+\n+    protected static final String LOGIN_SOAP_MESSAGE = \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\" ?>\\n\" +\n+            \"<env:Envelope xmlns:xsd=\\\"http://www.w3.org/2001/XMLSchema\\\"\\n\" +\n+            \"xmlns:urn=\\\"urn:enterprise.soap.sforce.com\\\"\\n\" +\n+            \"   xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"\\n\" +\n+            \"   xmlns:env=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\">\\n\" +\n+            \" <env:Header>\\n\" +\n+            \"     <urn:CallOptions>\\n\" +\n+            \"       <urn:client>presto</urn:client>\\n\" +\n+            \"     </urn:CallOptions>\\n\" +\n+            \" </env:Header>\\n\" +\n+            \" <env:Body>\\n\" +\n+            \"   <n1:login xmlns:n1=\\\"urn:partner.soap.sforce.com\\\">\\n\" +\n+            \"     <n1:username>%s</n1:username>\\n\" +\n+            \"     <n1:password>%s</n1:password>\\n\" +\n+            \"   </n1:login>\\n\" +\n+            \" </env:Body>\\n\" +\n+            \"</env:Envelope>\\n\";\n+\n+    public static final int MAX_EXPIRE = 3600;\n+    private int cacheSize = 4096;\n+    private int cacheExpireSeconds = 120;\n+    private String orgs;\n+\n+    private final Locale locale = Locale.US;    // Tested API request and response for user with Japanese locale and language preference,\n+    // and responses are English, and organization id is not in Japaneses characters (this is\n+    // also true of the organization id in the UI, even with other text showing in Japanese).\n+\n+    @NotNull(message = \"Must set salesforce.org with one or more Salesforce 18 char OrgId's, or \\\"all\\\"\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MTI3MQ==", "bodyText": "Instead of using a field containing a hard coded unit, use io.airlift.units.Duration.  This is used throughout Presto, so examples should be easy to find.  There is also a MaxDuration annotation that can be used here.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456851271", "createdAt": "2020-07-19T02:52:45Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceConfig.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.ConfigDescription;\n+import io.airlift.log.Logger;\n+\n+import javax.validation.constraints.Max;\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Set;\n+\n+public class SalesforceConfig\n+{\n+    private static final Logger log = Logger.get(SalesforceConfig.class);\n+\n+    protected static final String LOGINURL = \"https://login.salesforce.com/services/Soap/u/\";\n+    protected static final String APIVERSION = \"46.0\";\n+\n+    protected static final String LOGIN_SOAP_MESSAGE = \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\" ?>\\n\" +\n+            \"<env:Envelope xmlns:xsd=\\\"http://www.w3.org/2001/XMLSchema\\\"\\n\" +\n+            \"xmlns:urn=\\\"urn:enterprise.soap.sforce.com\\\"\\n\" +\n+            \"   xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"\\n\" +\n+            \"   xmlns:env=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\">\\n\" +\n+            \" <env:Header>\\n\" +\n+            \"     <urn:CallOptions>\\n\" +\n+            \"       <urn:client>presto</urn:client>\\n\" +\n+            \"     </urn:CallOptions>\\n\" +\n+            \" </env:Header>\\n\" +\n+            \" <env:Body>\\n\" +\n+            \"   <n1:login xmlns:n1=\\\"urn:partner.soap.sforce.com\\\">\\n\" +\n+            \"     <n1:username>%s</n1:username>\\n\" +\n+            \"     <n1:password>%s</n1:password>\\n\" +\n+            \"   </n1:login>\\n\" +\n+            \" </env:Body>\\n\" +\n+            \"</env:Envelope>\\n\";\n+\n+    public static final int MAX_EXPIRE = 3600;\n+    private int cacheSize = 4096;\n+    private int cacheExpireSeconds = 120;\n+    private String orgs;\n+\n+    private final Locale locale = Locale.US;    // Tested API request and response for user with Japanese locale and language preference,\n+    // and responses are English, and organization id is not in Japaneses characters (this is\n+    // also true of the organization id in the UI, even with other text showing in Japanese).\n+\n+    @NotNull(message = \"Must set salesforce.org with one or more Salesforce 18 char OrgId's, or \\\"all\\\"\")\n+    public String getOrgs()\n+    {\n+        return orgs;\n+    }\n+\n+    public Set<String> getOrgSet()\n+    {\n+        Set<String> tmp = new HashSet<>();\n+        if (orgs == null) {\n+            orgs = \"\";\n+        }\n+        String[] orgsSplit = orgs.split(\"[,;]\");\n+        for (String s : orgsSplit) {\n+            tmp.add(s.toLowerCase(locale).trim());\n+        }\n+\n+        return tmp;\n+    }\n+\n+    @Config(\"salesforce.org\")\n+    @ConfigDescription(\"Comma separated list of Salesforce 18 Character OrgId.\")\n+    public SalesforceConfig setOrgs(String orgs)\n+    {\n+        this.orgs = orgs;\n+        return this;\n+    }\n+\n+    public int getCacheSize()\n+    {\n+        return cacheSize;\n+    }\n+\n+    @Config(\"salesforce.cache-size\")\n+    @ConfigDescription(\"Maximum size of the cache that holds authenticated users.\")\n+    public SalesforceConfig setCacheSize(int cacheSize)\n+    {\n+        this.cacheSize = cacheSize;\n+        return this;\n+    }\n+\n+    @Max(value = MAX_EXPIRE, message = \"The salesforce.cache-expire-seconds is set too high.  Maximum is \" + MAX_EXPIRE + \" seconds.\")\n+    public int getCacheExpireSeconds()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MTQxMw==", "bodyText": "Config should be used for user configuration.  I'd move this constants to the class that uses them, and make them private.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456851413", "createdAt": "2020-07-19T02:55:02Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceConfig.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.ConfigDescription;\n+import io.airlift.log.Logger;\n+\n+import javax.validation.constraints.Max;\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Set;\n+\n+public class SalesforceConfig\n+{\n+    private static final Logger log = Logger.get(SalesforceConfig.class);\n+\n+    protected static final String LOGINURL = \"https://login.salesforce.com/services/Soap/u/\";\n+    protected static final String APIVERSION = \"46.0\";\n+\n+    protected static final String LOGIN_SOAP_MESSAGE = \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\" ?>\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MTUwNQ==", "bodyText": "This comment isn't necessary.... there are tons of these config tests in Presto and they all work the same way", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456851505", "createdAt": "2020-07-19T02:56:19Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/salesforce/TestSalesforceConfig.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.collect.ImmutableMap;\n+import org.testng.annotations.Test;\n+\n+import java.util.Map;\n+\n+import static io.airlift.configuration.testing.ConfigAssertions.assertFullMapping;\n+import static io.airlift.configuration.testing.ConfigAssertions.assertRecordedDefaults;\n+import static io.airlift.configuration.testing.ConfigAssertions.recordDefaults;\n+import static org.testng.Assert.assertEquals;\n+\n+public class TestSalesforceConfig\n+{\n+    private final int defaultCacheSize = 4096;\n+    private final int defaultCacheExpireSeconds = 120;\n+\n+    @Test\n+    public void testDefault()\n+    {\n+        assertRecordedDefaults(recordDefaults(SalesforceConfig.class)\n+                .setOrgs(null)\n+                .setCacheSize(defaultCacheSize)\n+                .setCacheExpireSeconds(defaultCacheExpireSeconds));\n+    }\n+\n+    // Test will only pass if config is created with properties that are different than the defaults.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MTUzOA==", "bodyText": "Pick values that are extremely unlikely default values... so maybe 111 and 3333.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456851538", "createdAt": "2020-07-19T02:56:56Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/salesforce/TestSalesforceConfig.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.collect.ImmutableMap;\n+import org.testng.annotations.Test;\n+\n+import java.util.Map;\n+\n+import static io.airlift.configuration.testing.ConfigAssertions.assertFullMapping;\n+import static io.airlift.configuration.testing.ConfigAssertions.assertRecordedDefaults;\n+import static io.airlift.configuration.testing.ConfigAssertions.recordDefaults;\n+import static org.testng.Assert.assertEquals;\n+\n+public class TestSalesforceConfig\n+{\n+    private final int defaultCacheSize = 4096;\n+    private final int defaultCacheExpireSeconds = 120;\n+\n+    @Test\n+    public void testDefault()\n+    {\n+        assertRecordedDefaults(recordDefaults(SalesforceConfig.class)\n+                .setOrgs(null)\n+                .setCacheSize(defaultCacheSize)\n+                .setCacheExpireSeconds(defaultCacheExpireSeconds));\n+    }\n+\n+    // Test will only pass if config is created with properties that are different than the defaults.\n+    @Test\n+    public void testExplicitConfig()\n+    {\n+        String org = \"my18CharOrgId\";\n+        String cacheSize = \"128\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MTY5MQ==", "bodyText": "These two fields can be constants.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456851691", "createdAt": "2020-07-19T02:59:12Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/salesforce/TestSalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.net.MediaType;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.HttpStatus;\n+import io.airlift.http.client.jetty.JettyHttpClient;\n+import io.airlift.http.client.testing.TestingHttpClient;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import org.testng.SkipException;\n+import org.testng.annotations.BeforeSuite;\n+import org.testng.annotations.Test;\n+\n+import java.security.Principal;\n+\n+import static io.airlift.http.client.testing.TestingResponse.mockResponse;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+public class TestSalesforceBasicAuthenticator\n+{\n+    private HttpClient testHttpClient;\n+    private String org;\n+    private String username;\n+    private String password;\n+    private String successResponse;\n+    private String failedResponse;\n+    private SalesforceConfig config;\n+    private boolean forReal;\n+\n+    @BeforeSuite\n+    void initOnce()\n+    {\n+        successResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns=\\\"urn:partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><loginResponse><result><metadataServerUrl>https://example.salesforce.com/services/Soap/m/46.0/example</metadataServerUrl><passwordExpired>false</passwordExpired><sandbox>false</sandbox><serverUrl>https://example.salesforce.com/services/Soap/u/46.0/example</serverUrl><sessionId>example</sessionId><userId>example</userId><userInfo><accessibilityMode>false</accessibilityMode><chatterExternal>false</chatterExternal><currencySymbol>$</currencySymbol><orgAttachmentFileSizeLimit>5242880</orgAttachmentFileSizeLimit><orgDefaultCurrencyIsoCode>USD</orgDefaultCurrencyIsoCode><orgDefaultCurrencyLocale>en_US</orgDefaultCurrencyLocale><orgDisallowHtmlAttachments>false</orgDisallowHtmlAttachments><orgHasPersonAccounts>true</orgHasPersonAccounts><organizationId>%s</organizationId><organizationMultiCurrency>false</organizationMultiCurrency><organizationName>example</organizationName><profileId>example</profileId><roleId>example</roleId><sessionSecondsValid>7200</sessionSecondsValid><userDefaultCurrencyIsoCode xsi:nil=\\\"true\\\"/><userEmail>user@salesforce.com</userEmail><userFullName>Vince Chase</userFullName><userId>example</userId><userLanguage>en_US</userLanguage><userLocale>en_US</userLocale><userName>%s</userName><userTimeZone>America/Chicago</userTimeZone><userType>Standard</userType><userUiSkin>Theme3</userUiSkin></userInfo></result></loginResponse></soapenv:Body></soapenv:Envelope>\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MTgxMg==", "bodyText": "This technique for enabling full integration tests doesn't look like other tests in Presto I have seen.  I could be wrong, but I would look at the other tests and copy the techniques.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456851812", "createdAt": "2020-07-19T03:01:13Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/salesforce/TestSalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.net.MediaType;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.HttpStatus;\n+import io.airlift.http.client.jetty.JettyHttpClient;\n+import io.airlift.http.client.testing.TestingHttpClient;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import org.testng.SkipException;\n+import org.testng.annotations.BeforeSuite;\n+import org.testng.annotations.Test;\n+\n+import java.security.Principal;\n+\n+import static io.airlift.http.client.testing.TestingResponse.mockResponse;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+public class TestSalesforceBasicAuthenticator\n+{\n+    private HttpClient testHttpClient;\n+    private String org;\n+    private String username;\n+    private String password;\n+    private String successResponse;\n+    private String failedResponse;\n+    private SalesforceConfig config;\n+    private boolean forReal;\n+\n+    @BeforeSuite\n+    void initOnce()\n+    {\n+        successResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns=\\\"urn:partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><loginResponse><result><metadataServerUrl>https://example.salesforce.com/services/Soap/m/46.0/example</metadataServerUrl><passwordExpired>false</passwordExpired><sandbox>false</sandbox><serverUrl>https://example.salesforce.com/services/Soap/u/46.0/example</serverUrl><sessionId>example</sessionId><userId>example</userId><userInfo><accessibilityMode>false</accessibilityMode><chatterExternal>false</chatterExternal><currencySymbol>$</currencySymbol><orgAttachmentFileSizeLimit>5242880</orgAttachmentFileSizeLimit><orgDefaultCurrencyIsoCode>USD</orgDefaultCurrencyIsoCode><orgDefaultCurrencyLocale>en_US</orgDefaultCurrencyLocale><orgDisallowHtmlAttachments>false</orgDisallowHtmlAttachments><orgHasPersonAccounts>true</orgHasPersonAccounts><organizationId>%s</organizationId><organizationMultiCurrency>false</organizationMultiCurrency><organizationName>example</organizationName><profileId>example</profileId><roleId>example</roleId><sessionSecondsValid>7200</sessionSecondsValid><userDefaultCurrencyIsoCode xsi:nil=\\\"true\\\"/><userEmail>user@salesforce.com</userEmail><userFullName>Vince Chase</userFullName><userId>example</userId><userLanguage>en_US</userLanguage><userLocale>en_US</userLocale><userName>%s</userName><userTimeZone>America/Chicago</userTimeZone><userType>Standard</userType><userUiSkin>Theme3</userUiSkin></userInfo></result></loginResponse></soapenv:Body></soapenv:Envelope>\";\n+        failedResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns:sf=\\\"urn:fault.partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><soapenv:Fault><faultcode>sf:INVALID_LOGIN</faultcode><faultstring>INVALID_LOGIN: Invalid username, password, security token; or user locked out.</faultstring><detail><sf:LoginFault xsi:type=\\\"sf:LoginFault\\\"><sf:exceptionCode>INVALID_LOGIN</sf:exceptionCode><sf:exceptionMessage>Invalid username, password, security token; or user locked out.</sf:exceptionMessage></sf:LoginFault></detail></soapenv:Fault></soapenv:Body></soapenv:Envelope>\";\n+        forReal = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MTg3OA==", "bodyText": "Presto runs test in parallel with multiple threads, and I don't think this is thread safe.\nI suggest removing all of the fields here and up, and just using local variables.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456851878", "createdAt": "2020-07-19T03:02:13Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/salesforce/TestSalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.net.MediaType;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.HttpStatus;\n+import io.airlift.http.client.jetty.JettyHttpClient;\n+import io.airlift.http.client.testing.TestingHttpClient;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import org.testng.SkipException;\n+import org.testng.annotations.BeforeSuite;\n+import org.testng.annotations.Test;\n+\n+import java.security.Principal;\n+\n+import static io.airlift.http.client.testing.TestingResponse.mockResponse;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+public class TestSalesforceBasicAuthenticator\n+{\n+    private HttpClient testHttpClient;\n+    private String org;\n+    private String username;\n+    private String password;\n+    private String successResponse;\n+    private String failedResponse;\n+    private SalesforceConfig config;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MTkzOQ==", "bodyText": "You can wrapper all of these with emptyToNull to simplify the usages", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456851939", "createdAt": "2020-07-19T03:03:27Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/salesforce/TestSalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.net.MediaType;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.HttpStatus;\n+import io.airlift.http.client.jetty.JettyHttpClient;\n+import io.airlift.http.client.testing.TestingHttpClient;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import org.testng.SkipException;\n+import org.testng.annotations.BeforeSuite;\n+import org.testng.annotations.Test;\n+\n+import java.security.Principal;\n+\n+import static io.airlift.http.client.testing.TestingResponse.mockResponse;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+public class TestSalesforceBasicAuthenticator\n+{\n+    private HttpClient testHttpClient;\n+    private String org;\n+    private String username;\n+    private String password;\n+    private String successResponse;\n+    private String failedResponse;\n+    private SalesforceConfig config;\n+    private boolean forReal;\n+\n+    @BeforeSuite\n+    void initOnce()\n+    {\n+        successResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns=\\\"urn:partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><loginResponse><result><metadataServerUrl>https://example.salesforce.com/services/Soap/m/46.0/example</metadataServerUrl><passwordExpired>false</passwordExpired><sandbox>false</sandbox><serverUrl>https://example.salesforce.com/services/Soap/u/46.0/example</serverUrl><sessionId>example</sessionId><userId>example</userId><userInfo><accessibilityMode>false</accessibilityMode><chatterExternal>false</chatterExternal><currencySymbol>$</currencySymbol><orgAttachmentFileSizeLimit>5242880</orgAttachmentFileSizeLimit><orgDefaultCurrencyIsoCode>USD</orgDefaultCurrencyIsoCode><orgDefaultCurrencyLocale>en_US</orgDefaultCurrencyLocale><orgDisallowHtmlAttachments>false</orgDisallowHtmlAttachments><orgHasPersonAccounts>true</orgHasPersonAccounts><organizationId>%s</organizationId><organizationMultiCurrency>false</organizationMultiCurrency><organizationName>example</organizationName><profileId>example</profileId><roleId>example</roleId><sessionSecondsValid>7200</sessionSecondsValid><userDefaultCurrencyIsoCode xsi:nil=\\\"true\\\"/><userEmail>user@salesforce.com</userEmail><userFullName>Vince Chase</userFullName><userId>example</userId><userLanguage>en_US</userLanguage><userLocale>en_US</userLocale><userName>%s</userName><userTimeZone>America/Chicago</userTimeZone><userType>Standard</userType><userUiSkin>Theme3</userUiSkin></userInfo></result></loginResponse></soapenv:Body></soapenv:Envelope>\";\n+        failedResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns:sf=\\\"urn:fault.partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><soapenv:Fault><faultcode>sf:INVALID_LOGIN</faultcode><faultstring>INVALID_LOGIN: Invalid username, password, security token; or user locked out.</faultstring><detail><sf:LoginFault xsi:type=\\\"sf:LoginFault\\\"><sf:exceptionCode>INVALID_LOGIN</sf:exceptionCode><sf:exceptionMessage>Invalid username, password, security token; or user locked out.</sf:exceptionMessage></sf:LoginFault></detail></soapenv:Fault></soapenv:Body></soapenv:Envelope>\";\n+        forReal = false;\n+        String forRealEnvVar = System.getenv(\"SALESFORCE_TEST_FORREAL\");\n+        if (forRealEnvVar != null && forRealEnvVar.equalsIgnoreCase(\"TRUE\")) {\n+            forReal = true;\n+        }\n+    }\n+\n+    @Test\n+    public void createAuthenticatedPrincipal_success()\n+            throws InterruptedException\n+    {\n+        org = \"my18CharOrgId\";  // As if from salesforce.org property.\n+        username = \"user@salesforce.com\";\n+        password = \"passtoken\";\n+\n+        config = new SalesforceConfig()\n+                .setOrgs(org)\n+                .setCacheExpireSeconds(1); // Test cache timeout.\n+\n+        String xmlResponse = String.format(successResponse, org, username);\n+\n+        testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.OK, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+\n+        Principal principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name.\");\n+\n+        principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name from cache.\");\n+\n+        Thread.sleep(2000L);\n+        principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name from expired cache.\");\n+    }\n+\n+    @Test(expectedExceptions = AccessDeniedException.class)\n+    public void createAuthenticatedPrincipal_wrongOrg()\n+    {\n+        org = \"my18CharOrgId\";  // As if from salesforce.org property.\n+        username = \"user@salesforce.com\";\n+        password = \"passtoken\";\n+\n+        config = new SalesforceConfig()\n+                .setOrgs(org);\n+\n+        final String xmlResponse = String.format(successResponse, \"NotMyOrg\", username);\n+\n+        testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.OK, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+        authenticator.createAuthenticatedPrincipal(username, password);\n+    }\n+\n+    @Test(expectedExceptions = AccessDeniedException.class)\n+    public void createAuthenticatedPrincipal_badPass()\n+    {\n+        org = \"my18CharOrgId\";  // As if from salesforce.org property.\n+        username = \"user@salesforce.com\";\n+        password = \"passtoken\";\n+\n+        config = new SalesforceConfig()\n+                .setOrgs(org);\n+\n+        final String xmlResponse = failedResponse;\n+\n+        testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.INTERNAL_SERVER_ERROR, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+        Principal principal = authenticator.createAuthenticatedPrincipal(username, password);\n+    }\n+\n+    @Test\n+    public void createAuthenticatedPrincipalAllOrgs()\n+    {\n+        org = \"all\";  // As if from salesforce.org property.\n+        username = \"user@salesforce.com\";\n+        password = \"passtoken\";\n+\n+        config = new SalesforceConfig()\n+                .setOrgs(org);\n+\n+        String xmlResponse = String.format(successResponse, \"some18CharOrgId\", username);\n+\n+        testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.OK, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+\n+        Principal principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test allowing all orgs.\");\n+    }\n+\n+    @Test\n+    public void createAuthenticatedPrincipalFewOrgs()\n+    {\n+        org = \"my18CharOrgId,your18CharOrgId, his18CharOrgId ,her18CharOrgId\";  // As if from salesforce.org property.\n+        username = \"user@salesforce.com\";\n+        password = \"passtoken\";\n+\n+        config = new SalesforceConfig()\n+                .setOrgs(org);\n+\n+        String xmlResponse = String.format(successResponse, \"my18CharOrgId\", username);\n+\n+        testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.OK, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+\n+        Principal principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test allowing a few orgs.\");\n+    }\n+\n+    /*\n+     * Real tests that use Salesforce credentials and actually attempt to login.\n+     * These should be disabled for automated builds and test runs.\n+     *\n+     * In order to run these, the following environment variables need to be set.\n+     *\n+     *   - SALESFORCE_TEST_ORG (this is the 18 character organization id)\n+     *   - SALESFORCE_TEST_USERNAME\n+     *   - SALESFORCE_TEST_PASSWORD (this must be password and security token concatenation)\n+     *   - SALESFORCE_TEST_FORREAL must be TRUE\n+     */\n+\n+    // Test a real login.\n+    @Test(description = \"Test principal name for real, yo!\")\n+    void createAuthenticatedPrincipal_realSuccess()\n+    {\n+        // Skip this test if SALESFORCE_TEST_FORREAL is not set to TRUE.\n+        if (!forReal) {\n+            throw new SkipException(\"Skipping real tests.\");\n+        }\n+\n+        org = System.getenv(\"SALESFORCE_TEST_ORG\");\n+        if (org == null || org.length() == 0) {\n+            fail(\"Must set SALESFORCE_TEST_ORG environment variable.\");\n+        }\n+        username = System.getenv(\"SALESFORCE_TEST_USERNAME\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 180}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MjAxOA==", "bodyText": "this form username.length() == 0 should be replaced with username.isEmpty(). Your IDE should be making this suggestion for you automatically.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456852018", "createdAt": "2020-07-19T03:04:29Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/salesforce/TestSalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.net.MediaType;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.HttpStatus;\n+import io.airlift.http.client.jetty.JettyHttpClient;\n+import io.airlift.http.client.testing.TestingHttpClient;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import org.testng.SkipException;\n+import org.testng.annotations.BeforeSuite;\n+import org.testng.annotations.Test;\n+\n+import java.security.Principal;\n+\n+import static io.airlift.http.client.testing.TestingResponse.mockResponse;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+public class TestSalesforceBasicAuthenticator\n+{\n+    private HttpClient testHttpClient;\n+    private String org;\n+    private String username;\n+    private String password;\n+    private String successResponse;\n+    private String failedResponse;\n+    private SalesforceConfig config;\n+    private boolean forReal;\n+\n+    @BeforeSuite\n+    void initOnce()\n+    {\n+        successResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns=\\\"urn:partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><loginResponse><result><metadataServerUrl>https://example.salesforce.com/services/Soap/m/46.0/example</metadataServerUrl><passwordExpired>false</passwordExpired><sandbox>false</sandbox><serverUrl>https://example.salesforce.com/services/Soap/u/46.0/example</serverUrl><sessionId>example</sessionId><userId>example</userId><userInfo><accessibilityMode>false</accessibilityMode><chatterExternal>false</chatterExternal><currencySymbol>$</currencySymbol><orgAttachmentFileSizeLimit>5242880</orgAttachmentFileSizeLimit><orgDefaultCurrencyIsoCode>USD</orgDefaultCurrencyIsoCode><orgDefaultCurrencyLocale>en_US</orgDefaultCurrencyLocale><orgDisallowHtmlAttachments>false</orgDisallowHtmlAttachments><orgHasPersonAccounts>true</orgHasPersonAccounts><organizationId>%s</organizationId><organizationMultiCurrency>false</organizationMultiCurrency><organizationName>example</organizationName><profileId>example</profileId><roleId>example</roleId><sessionSecondsValid>7200</sessionSecondsValid><userDefaultCurrencyIsoCode xsi:nil=\\\"true\\\"/><userEmail>user@salesforce.com</userEmail><userFullName>Vince Chase</userFullName><userId>example</userId><userLanguage>en_US</userLanguage><userLocale>en_US</userLocale><userName>%s</userName><userTimeZone>America/Chicago</userTimeZone><userType>Standard</userType><userUiSkin>Theme3</userUiSkin></userInfo></result></loginResponse></soapenv:Body></soapenv:Envelope>\";\n+        failedResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns:sf=\\\"urn:fault.partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><soapenv:Fault><faultcode>sf:INVALID_LOGIN</faultcode><faultstring>INVALID_LOGIN: Invalid username, password, security token; or user locked out.</faultstring><detail><sf:LoginFault xsi:type=\\\"sf:LoginFault\\\"><sf:exceptionCode>INVALID_LOGIN</sf:exceptionCode><sf:exceptionMessage>Invalid username, password, security token; or user locked out.</sf:exceptionMessage></sf:LoginFault></detail></soapenv:Fault></soapenv:Body></soapenv:Envelope>\";\n+        forReal = false;\n+        String forRealEnvVar = System.getenv(\"SALESFORCE_TEST_FORREAL\");\n+        if (forRealEnvVar != null && forRealEnvVar.equalsIgnoreCase(\"TRUE\")) {\n+            forReal = true;\n+        }\n+    }\n+\n+    @Test\n+    public void createAuthenticatedPrincipal_success()\n+            throws InterruptedException\n+    {\n+        org = \"my18CharOrgId\";  // As if from salesforce.org property.\n+        username = \"user@salesforce.com\";\n+        password = \"passtoken\";\n+\n+        config = new SalesforceConfig()\n+                .setOrgs(org)\n+                .setCacheExpireSeconds(1); // Test cache timeout.\n+\n+        String xmlResponse = String.format(successResponse, org, username);\n+\n+        testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.OK, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+\n+        Principal principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name.\");\n+\n+        principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name from cache.\");\n+\n+        Thread.sleep(2000L);\n+        principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name from expired cache.\");\n+    }\n+\n+    @Test(expectedExceptions = AccessDeniedException.class)\n+    public void createAuthenticatedPrincipal_wrongOrg()\n+    {\n+        org = \"my18CharOrgId\";  // As if from salesforce.org property.\n+        username = \"user@salesforce.com\";\n+        password = \"passtoken\";\n+\n+        config = new SalesforceConfig()\n+                .setOrgs(org);\n+\n+        final String xmlResponse = String.format(successResponse, \"NotMyOrg\", username);\n+\n+        testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.OK, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+        authenticator.createAuthenticatedPrincipal(username, password);\n+    }\n+\n+    @Test(expectedExceptions = AccessDeniedException.class)\n+    public void createAuthenticatedPrincipal_badPass()\n+    {\n+        org = \"my18CharOrgId\";  // As if from salesforce.org property.\n+        username = \"user@salesforce.com\";\n+        password = \"passtoken\";\n+\n+        config = new SalesforceConfig()\n+                .setOrgs(org);\n+\n+        final String xmlResponse = failedResponse;\n+\n+        testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.INTERNAL_SERVER_ERROR, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+        Principal principal = authenticator.createAuthenticatedPrincipal(username, password);\n+    }\n+\n+    @Test\n+    public void createAuthenticatedPrincipalAllOrgs()\n+    {\n+        org = \"all\";  // As if from salesforce.org property.\n+        username = \"user@salesforce.com\";\n+        password = \"passtoken\";\n+\n+        config = new SalesforceConfig()\n+                .setOrgs(org);\n+\n+        String xmlResponse = String.format(successResponse, \"some18CharOrgId\", username);\n+\n+        testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.OK, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+\n+        Principal principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test allowing all orgs.\");\n+    }\n+\n+    @Test\n+    public void createAuthenticatedPrincipalFewOrgs()\n+    {\n+        org = \"my18CharOrgId,your18CharOrgId, his18CharOrgId ,her18CharOrgId\";  // As if from salesforce.org property.\n+        username = \"user@salesforce.com\";\n+        password = \"passtoken\";\n+\n+        config = new SalesforceConfig()\n+                .setOrgs(org);\n+\n+        String xmlResponse = String.format(successResponse, \"my18CharOrgId\", username);\n+\n+        testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.OK, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+\n+        Principal principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test allowing a few orgs.\");\n+    }\n+\n+    /*\n+     * Real tests that use Salesforce credentials and actually attempt to login.\n+     * These should be disabled for automated builds and test runs.\n+     *\n+     * In order to run these, the following environment variables need to be set.\n+     *\n+     *   - SALESFORCE_TEST_ORG (this is the 18 character organization id)\n+     *   - SALESFORCE_TEST_USERNAME\n+     *   - SALESFORCE_TEST_PASSWORD (this must be password and security token concatenation)\n+     *   - SALESFORCE_TEST_FORREAL must be TRUE\n+     */\n+\n+    // Test a real login.\n+    @Test(description = \"Test principal name for real, yo!\")\n+    void createAuthenticatedPrincipal_realSuccess()\n+    {\n+        // Skip this test if SALESFORCE_TEST_FORREAL is not set to TRUE.\n+        if (!forReal) {\n+            throw new SkipException(\"Skipping real tests.\");\n+        }\n+\n+        org = System.getenv(\"SALESFORCE_TEST_ORG\");\n+        if (org == null || org.length() == 0) {\n+            fail(\"Must set SALESFORCE_TEST_ORG environment variable.\");\n+        }\n+        username = System.getenv(\"SALESFORCE_TEST_USERNAME\");\n+        password = System.getenv(\"SALESFORCE_TEST_PASSWORD\");\n+        if (username == null || username.length() == 0 || password == null || password.length() == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 182}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MjA2NA==", "bodyText": "(nit) removed unused variable principal", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456852064", "createdAt": "2020-07-19T03:05:00Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/salesforce/TestSalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.net.MediaType;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.HttpStatus;\n+import io.airlift.http.client.jetty.JettyHttpClient;\n+import io.airlift.http.client.testing.TestingHttpClient;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import org.testng.SkipException;\n+import org.testng.annotations.BeforeSuite;\n+import org.testng.annotations.Test;\n+\n+import java.security.Principal;\n+\n+import static io.airlift.http.client.testing.TestingResponse.mockResponse;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+public class TestSalesforceBasicAuthenticator\n+{\n+    private HttpClient testHttpClient;\n+    private String org;\n+    private String username;\n+    private String password;\n+    private String successResponse;\n+    private String failedResponse;\n+    private SalesforceConfig config;\n+    private boolean forReal;\n+\n+    @BeforeSuite\n+    void initOnce()\n+    {\n+        successResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns=\\\"urn:partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><loginResponse><result><metadataServerUrl>https://example.salesforce.com/services/Soap/m/46.0/example</metadataServerUrl><passwordExpired>false</passwordExpired><sandbox>false</sandbox><serverUrl>https://example.salesforce.com/services/Soap/u/46.0/example</serverUrl><sessionId>example</sessionId><userId>example</userId><userInfo><accessibilityMode>false</accessibilityMode><chatterExternal>false</chatterExternal><currencySymbol>$</currencySymbol><orgAttachmentFileSizeLimit>5242880</orgAttachmentFileSizeLimit><orgDefaultCurrencyIsoCode>USD</orgDefaultCurrencyIsoCode><orgDefaultCurrencyLocale>en_US</orgDefaultCurrencyLocale><orgDisallowHtmlAttachments>false</orgDisallowHtmlAttachments><orgHasPersonAccounts>true</orgHasPersonAccounts><organizationId>%s</organizationId><organizationMultiCurrency>false</organizationMultiCurrency><organizationName>example</organizationName><profileId>example</profileId><roleId>example</roleId><sessionSecondsValid>7200</sessionSecondsValid><userDefaultCurrencyIsoCode xsi:nil=\\\"true\\\"/><userEmail>user@salesforce.com</userEmail><userFullName>Vince Chase</userFullName><userId>example</userId><userLanguage>en_US</userLanguage><userLocale>en_US</userLocale><userName>%s</userName><userTimeZone>America/Chicago</userTimeZone><userType>Standard</userType><userUiSkin>Theme3</userUiSkin></userInfo></result></loginResponse></soapenv:Body></soapenv:Envelope>\";\n+        failedResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns:sf=\\\"urn:fault.partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><soapenv:Fault><faultcode>sf:INVALID_LOGIN</faultcode><faultstring>INVALID_LOGIN: Invalid username, password, security token; or user locked out.</faultstring><detail><sf:LoginFault xsi:type=\\\"sf:LoginFault\\\"><sf:exceptionCode>INVALID_LOGIN</sf:exceptionCode><sf:exceptionMessage>Invalid username, password, security token; or user locked out.</sf:exceptionMessage></sf:LoginFault></detail></soapenv:Fault></soapenv:Body></soapenv:Envelope>\";\n+        forReal = false;\n+        String forRealEnvVar = System.getenv(\"SALESFORCE_TEST_FORREAL\");\n+        if (forRealEnvVar != null && forRealEnvVar.equalsIgnoreCase(\"TRUE\")) {\n+            forReal = true;\n+        }\n+    }\n+\n+    @Test\n+    public void createAuthenticatedPrincipal_success()\n+            throws InterruptedException\n+    {\n+        org = \"my18CharOrgId\";  // As if from salesforce.org property.\n+        username = \"user@salesforce.com\";\n+        password = \"passtoken\";\n+\n+        config = new SalesforceConfig()\n+                .setOrgs(org)\n+                .setCacheExpireSeconds(1); // Test cache timeout.\n+\n+        String xmlResponse = String.format(successResponse, org, username);\n+\n+        testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.OK, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+\n+        Principal principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name.\");\n+\n+        principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name from cache.\");\n+\n+        Thread.sleep(2000L);\n+        principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name from expired cache.\");\n+    }\n+\n+    @Test(expectedExceptions = AccessDeniedException.class)\n+    public void createAuthenticatedPrincipal_wrongOrg()\n+    {\n+        org = \"my18CharOrgId\";  // As if from salesforce.org property.\n+        username = \"user@salesforce.com\";\n+        password = \"passtoken\";\n+\n+        config = new SalesforceConfig()\n+                .setOrgs(org);\n+\n+        final String xmlResponse = String.format(successResponse, \"NotMyOrg\", username);\n+\n+        testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.OK, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+        authenticator.createAuthenticatedPrincipal(username, password);\n+    }\n+\n+    @Test(expectedExceptions = AccessDeniedException.class)\n+    public void createAuthenticatedPrincipal_badPass()\n+    {\n+        org = \"my18CharOrgId\";  // As if from salesforce.org property.\n+        username = \"user@salesforce.com\";\n+        password = \"passtoken\";\n+\n+        config = new SalesforceConfig()\n+                .setOrgs(org);\n+\n+        final String xmlResponse = failedResponse;\n+\n+        testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.INTERNAL_SERVER_ERROR, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+        Principal principal = authenticator.createAuthenticatedPrincipal(username, password);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MjIwOA==", "bodyText": "(nit) I don't think we use underscores in method names in Presto", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456852208", "createdAt": "2020-07-19T03:07:14Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/salesforce/TestSalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.net.MediaType;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.HttpStatus;\n+import io.airlift.http.client.jetty.JettyHttpClient;\n+import io.airlift.http.client.testing.TestingHttpClient;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import org.testng.SkipException;\n+import org.testng.annotations.BeforeSuite;\n+import org.testng.annotations.Test;\n+\n+import java.security.Principal;\n+\n+import static io.airlift.http.client.testing.TestingResponse.mockResponse;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+public class TestSalesforceBasicAuthenticator\n+{\n+    private HttpClient testHttpClient;\n+    private String org;\n+    private String username;\n+    private String password;\n+    private String successResponse;\n+    private String failedResponse;\n+    private SalesforceConfig config;\n+    private boolean forReal;\n+\n+    @BeforeSuite\n+    void initOnce()\n+    {\n+        successResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns=\\\"urn:partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><loginResponse><result><metadataServerUrl>https://example.salesforce.com/services/Soap/m/46.0/example</metadataServerUrl><passwordExpired>false</passwordExpired><sandbox>false</sandbox><serverUrl>https://example.salesforce.com/services/Soap/u/46.0/example</serverUrl><sessionId>example</sessionId><userId>example</userId><userInfo><accessibilityMode>false</accessibilityMode><chatterExternal>false</chatterExternal><currencySymbol>$</currencySymbol><orgAttachmentFileSizeLimit>5242880</orgAttachmentFileSizeLimit><orgDefaultCurrencyIsoCode>USD</orgDefaultCurrencyIsoCode><orgDefaultCurrencyLocale>en_US</orgDefaultCurrencyLocale><orgDisallowHtmlAttachments>false</orgDisallowHtmlAttachments><orgHasPersonAccounts>true</orgHasPersonAccounts><organizationId>%s</organizationId><organizationMultiCurrency>false</organizationMultiCurrency><organizationName>example</organizationName><profileId>example</profileId><roleId>example</roleId><sessionSecondsValid>7200</sessionSecondsValid><userDefaultCurrencyIsoCode xsi:nil=\\\"true\\\"/><userEmail>user@salesforce.com</userEmail><userFullName>Vince Chase</userFullName><userId>example</userId><userLanguage>en_US</userLanguage><userLocale>en_US</userLocale><userName>%s</userName><userTimeZone>America/Chicago</userTimeZone><userType>Standard</userType><userUiSkin>Theme3</userUiSkin></userInfo></result></loginResponse></soapenv:Body></soapenv:Envelope>\";\n+        failedResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns:sf=\\\"urn:fault.partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><soapenv:Fault><faultcode>sf:INVALID_LOGIN</faultcode><faultstring>INVALID_LOGIN: Invalid username, password, security token; or user locked out.</faultstring><detail><sf:LoginFault xsi:type=\\\"sf:LoginFault\\\"><sf:exceptionCode>INVALID_LOGIN</sf:exceptionCode><sf:exceptionMessage>Invalid username, password, security token; or user locked out.</sf:exceptionMessage></sf:LoginFault></detail></soapenv:Fault></soapenv:Body></soapenv:Envelope>\";\n+        forReal = false;\n+        String forRealEnvVar = System.getenv(\"SALESFORCE_TEST_FORREAL\");\n+        if (forRealEnvVar != null && forRealEnvVar.equalsIgnoreCase(\"TRUE\")) {\n+            forReal = true;\n+        }\n+    }\n+\n+    @Test\n+    public void createAuthenticatedPrincipal_success()\n+            throws InterruptedException\n+    {\n+        org = \"my18CharOrgId\";  // As if from salesforce.org property.\n+        username = \"user@salesforce.com\";\n+        password = \"passtoken\";\n+\n+        config = new SalesforceConfig()\n+                .setOrgs(org)\n+                .setCacheExpireSeconds(1); // Test cache timeout.\n+\n+        String xmlResponse = String.format(successResponse, org, username);\n+\n+        testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.OK, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+\n+        Principal principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name.\");\n+\n+        principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name from cache.\");\n+\n+        Thread.sleep(2000L);\n+        principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name from expired cache.\");\n+    }\n+\n+    @Test(expectedExceptions = AccessDeniedException.class)\n+    public void createAuthenticatedPrincipal_wrongOrg()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MjM1NA==", "bodyText": "(nit) Add underscores to the names to the spell checker in the ID doesn't complain", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456852354", "createdAt": "2020-07-19T03:09:40Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceConfig.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.ConfigDescription;\n+import io.airlift.log.Logger;\n+\n+import javax.validation.constraints.Max;\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Set;\n+\n+public class SalesforceConfig\n+{\n+    private static final Logger log = Logger.get(SalesforceConfig.class);\n+\n+    protected static final String LOGINURL = \"https://login.salesforce.com/services/Soap/u/\";\n+    protected static final String APIVERSION = \"46.0\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MjQwMw==", "bodyText": "This isn't used", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456852403", "createdAt": "2020-07-19T03:09:53Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceConfig.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.ConfigDescription;\n+import io.airlift.log.Logger;\n+\n+import javax.validation.constraints.Max;\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Set;\n+\n+public class SalesforceConfig\n+{\n+    private static final Logger log = Logger.get(SalesforceConfig.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MjQzNw==", "bodyText": "Also rename to allowedOrganizations", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456852437", "createdAt": "2020-07-19T03:10:15Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceConfig.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.ConfigDescription;\n+import io.airlift.log.Logger;\n+\n+import javax.validation.constraints.Max;\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Set;\n+\n+public class SalesforceConfig\n+{\n+    private static final Logger log = Logger.get(SalesforceConfig.class);\n+\n+    protected static final String LOGINURL = \"https://login.salesforce.com/services/Soap/u/\";\n+    protected static final String APIVERSION = \"46.0\";\n+\n+    protected static final String LOGIN_SOAP_MESSAGE = \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\" ?>\\n\" +\n+            \"<env:Envelope xmlns:xsd=\\\"http://www.w3.org/2001/XMLSchema\\\"\\n\" +\n+            \"xmlns:urn=\\\"urn:enterprise.soap.sforce.com\\\"\\n\" +\n+            \"   xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"\\n\" +\n+            \"   xmlns:env=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\">\\n\" +\n+            \" <env:Header>\\n\" +\n+            \"     <urn:CallOptions>\\n\" +\n+            \"       <urn:client>presto</urn:client>\\n\" +\n+            \"     </urn:CallOptions>\\n\" +\n+            \" </env:Header>\\n\" +\n+            \" <env:Body>\\n\" +\n+            \"   <n1:login xmlns:n1=\\\"urn:partner.soap.sforce.com\\\">\\n\" +\n+            \"     <n1:username>%s</n1:username>\\n\" +\n+            \"     <n1:password>%s</n1:password>\\n\" +\n+            \"   </n1:login>\\n\" +\n+            \" </env:Body>\\n\" +\n+            \"</env:Envelope>\\n\";\n+\n+    public static final int MAX_EXPIRE = 3600;\n+    private int cacheSize = 4096;\n+    private int cacheExpireSeconds = 120;\n+    private String orgs;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MDg2Mg=="}, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1MjQ0Mg==", "bodyText": "This can be private", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r456852442", "createdAt": "2020-07-19T03:10:27Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceConfig.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.ConfigDescription;\n+import io.airlift.log.Logger;\n+\n+import javax.validation.constraints.Max;\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Set;\n+\n+public class SalesforceConfig\n+{\n+    private static final Logger log = Logger.get(SalesforceConfig.class);\n+\n+    protected static final String LOGINURL = \"https://login.salesforce.com/services/Soap/u/\";\n+    protected static final String APIVERSION = \"46.0\";\n+\n+    protected static final String LOGIN_SOAP_MESSAGE = \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\" ?>\\n\" +\n+            \"<env:Envelope xmlns:xsd=\\\"http://www.w3.org/2001/XMLSchema\\\"\\n\" +\n+            \"xmlns:urn=\\\"urn:enterprise.soap.sforce.com\\\"\\n\" +\n+            \"   xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"\\n\" +\n+            \"   xmlns:env=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\">\\n\" +\n+            \" <env:Header>\\n\" +\n+            \"     <urn:CallOptions>\\n\" +\n+            \"       <urn:client>presto</urn:client>\\n\" +\n+            \"     </urn:CallOptions>\\n\" +\n+            \" </env:Header>\\n\" +\n+            \" <env:Body>\\n\" +\n+            \"   <n1:login xmlns:n1=\\\"urn:partner.soap.sforce.com\\\">\\n\" +\n+            \"     <n1:username>%s</n1:username>\\n\" +\n+            \"     <n1:password>%s</n1:password>\\n\" +\n+            \"   </n1:login>\\n\" +\n+            \" </env:Body>\\n\" +\n+            \"</env:Envelope>\\n\";\n+\n+    public static final int MAX_EXPIRE = 3600;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7c5194e36fabd4888714a764c64c8119d4b918c"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e980142135dae30e630189904f984fd59d3378a", "author": {"user": {"login": "bweissler-sf", "name": "Brian Weissler"}}, "url": "https://github.com/trinodb/trino/commit/5e980142135dae30e630189904f984fd59d3378a", "committedDate": "2020-07-20T00:05:50Z", "message": "Addressed feedback from Dain."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMjUwMTIz", "url": "https://github.com/trinodb/trino/pull/4372#pullrequestreview-460250123", "createdAt": "2020-08-03T18:28:54Z", "commit": {"oid": "5e980142135dae30e630189904f984fd59d3378a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxODoyODo1NVrOG7ERkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMToxMDo0MVrOG7Nlwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4OTIwMA==", "bodyText": "Since we are interpolating into XML let's run the values through Guava's xml excape method: https://guava.dev/releases/20.0/api/docs/com/google/common/xml/XmlEscapers.html", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r464589200", "createdAt": "2020-08-03T18:28:55Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,185 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.NodeList;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+import javax.xml.parsers.ParserConfigurationException;\n+\n+import java.io.IOException;\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.Locale;\n+import java.util.Set;\n+\n+import static com.google.common.base.Strings.emptyToNull;\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.airlift.http.client.StaticBodyGenerator.createStaticBodyGenerator;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    // Set of Salesforce orgs, which users must belong to in order to authN.\n+    private final Set<String> allowedOrganizations;\n+    private final HttpClient httpClient;\n+    private final LoadingCache<Credential, Principal> userCache;\n+\n+    @Inject\n+    public SalesforceBasicAuthenticator(SalesforceConfig config, @SalesforceAuthenticationClient HttpClient httpClient)\n+    {\n+        this.allowedOrganizations = ImmutableSet.copyOf(config.getOrgSet());\n+        this.httpClient = requireNonNull(httpClient, \"httpClient is null\");\n+\n+        this.userCache = CacheBuilder.newBuilder()\n+                .maximumSize(config.getCacheSize())\n+                .expireAfterWrite(config.getCacheExpireSeconds().toMillis(), MILLISECONDS)\n+                .build(CacheLoader.from(this::doLogin));\n+    }\n+\n+    @Override\n+    public Principal createAuthenticatedPrincipal(String username, String password)\n+    {\n+        try {\n+            return userCache.getUnchecked(new Credential(username, password));\n+        }\n+        catch (UncheckedExecutionException e) {\n+            throwIfInstanceOf(e.getCause(), AccessDeniedException.class);\n+            throw e;\n+        }\n+    }\n+\n+    // This does the work of logging into Salesforce.\n+    private Principal doLogin(Credential credential)\n+    {\n+        log.debug(\"Logging into Salesforce.\");\n+        String username = credential.getUser();\n+        String password = credential.getPassword();\n+\n+        // Login requests must be POSTs\n+        String loginSoapMessage = \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\" ?>\\n\" +\n+                \"<env:Envelope xmlns:xsd=\\\"http://www.w3.org/2001/XMLSchema\\\"\\n\" +\n+                \"xmlns:urn=\\\"urn:enterprise.soap.sforce.com\\\"\\n\" +\n+                \"   xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"\\n\" +\n+                \"   xmlns:env=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\">\\n\" +\n+                \" <env:Header>\\n\" +\n+                \"     <urn:CallOptions>\\n\" +\n+                \"       <urn:client>presto</urn:client>\\n\" +\n+                \"     </urn:CallOptions>\\n\" +\n+                \" </env:Header>\\n\" +\n+                \" <env:Body>\\n\" +\n+                \"   <n1:login xmlns:n1=\\\"urn:partner.soap.sforce.com\\\">\\n\" +\n+                \"     <n1:username>%s</n1:username>\\n\" +\n+                \"     <n1:password>%s</n1:password>\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e980142135dae30e630189904f984fd59d3378a"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU5MDM5Ng==", "bodyText": "you can use allowedOrganizations.equals(ImmutableList.of(\"all\") &&.  Also, for the style, I believe we put the && on the end of the line.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r464590396", "createdAt": "2020-08-03T18:31:28Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,185 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.Request;\n+import io.airlift.http.client.StringResponseHandler;\n+import io.airlift.log.Logger;\n+import io.prestosql.plugin.password.Credential;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.PasswordAuthenticator;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.NodeList;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n+\n+import javax.inject.Inject;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+import javax.xml.parsers.ParserConfigurationException;\n+\n+import java.io.IOException;\n+import java.io.StringReader;\n+import java.net.URI;\n+import java.security.Principal;\n+import java.util.Locale;\n+import java.util.Set;\n+\n+import static com.google.common.base.Strings.emptyToNull;\n+import static com.google.common.base.Throwables.throwIfInstanceOf;\n+import static io.airlift.http.client.StaticBodyGenerator.createStaticBodyGenerator;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+/**\n+ * Allows users to authenticate to Presto using their Salesforce username and password + security token concatenation.  You can learn about\n+ * the Salesforce security token at https://help.salesforce.com/articleView?id=user_security_token.htm.\n+ * <br><br>\n+ * If your password is <code>foo</code> and token is <code>bar</code>, then your Presto password will be <code>foobar</code>.\n+ * <br><br>\n+ * Admins can configure one or more Salesforce Organization Ids (18 char) via <code>salesforce.org</code> in <code>password-authenticator.properties</code>\n+ * to act as a single layer of authZ.  Essentially, if the user who logs in is not part of the configured org, their access will be denied.  Alternatively,\n+ * the admin can specify \"all\", rather than actual orgs.  This will allow any authenticated Salesforce user access to Presto.\n+ */\n+public class SalesforceBasicAuthenticator\n+        implements PasswordAuthenticator\n+{\n+    private static final Logger log = Logger.get(SalesforceBasicAuthenticator.class);\n+\n+    // Set of Salesforce orgs, which users must belong to in order to authN.\n+    private final Set<String> allowedOrganizations;\n+    private final HttpClient httpClient;\n+    private final LoadingCache<Credential, Principal> userCache;\n+\n+    @Inject\n+    public SalesforceBasicAuthenticator(SalesforceConfig config, @SalesforceAuthenticationClient HttpClient httpClient)\n+    {\n+        this.allowedOrganizations = ImmutableSet.copyOf(config.getOrgSet());\n+        this.httpClient = requireNonNull(httpClient, \"httpClient is null\");\n+\n+        this.userCache = CacheBuilder.newBuilder()\n+                .maximumSize(config.getCacheSize())\n+                .expireAfterWrite(config.getCacheExpireSeconds().toMillis(), MILLISECONDS)\n+                .build(CacheLoader.from(this::doLogin));\n+    }\n+\n+    @Override\n+    public Principal createAuthenticatedPrincipal(String username, String password)\n+    {\n+        try {\n+            return userCache.getUnchecked(new Credential(username, password));\n+        }\n+        catch (UncheckedExecutionException e) {\n+            throwIfInstanceOf(e.getCause(), AccessDeniedException.class);\n+            throw e;\n+        }\n+    }\n+\n+    // This does the work of logging into Salesforce.\n+    private Principal doLogin(Credential credential)\n+    {\n+        log.debug(\"Logging into Salesforce.\");\n+        String username = credential.getUser();\n+        String password = credential.getPassword();\n+\n+        // Login requests must be POSTs\n+        String loginSoapMessage = \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\" ?>\\n\" +\n+                \"<env:Envelope xmlns:xsd=\\\"http://www.w3.org/2001/XMLSchema\\\"\\n\" +\n+                \"xmlns:urn=\\\"urn:enterprise.soap.sforce.com\\\"\\n\" +\n+                \"   xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"\\n\" +\n+                \"   xmlns:env=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\">\\n\" +\n+                \" <env:Header>\\n\" +\n+                \"     <urn:CallOptions>\\n\" +\n+                \"       <urn:client>presto</urn:client>\\n\" +\n+                \"     </urn:CallOptions>\\n\" +\n+                \" </env:Header>\\n\" +\n+                \" <env:Body>\\n\" +\n+                \"   <n1:login xmlns:n1=\\\"urn:partner.soap.sforce.com\\\">\\n\" +\n+                \"     <n1:username>%s</n1:username>\\n\" +\n+                \"     <n1:password>%s</n1:password>\\n\" +\n+                \"   </n1:login>\\n\" +\n+                \" </env:Body>\\n\" +\n+                \"</env:Envelope>\\n\";\n+        String apiVersion = \"46.0\";\n+        String loginUrl = \"https://login.salesforce.com/services/Soap/u/\";\n+        Request request = new Request.Builder()\n+                .setUri(URI.create(loginUrl + apiVersion))\n+                .setHeader(\"Content-Type\", \"text/xml;charset=UTF-8\")\n+                .setHeader(\"SOAPAction\", \"login\")\n+                .setMethod(\"POST\")\n+                .setBodyGenerator(createStaticBodyGenerator(String.format(loginSoapMessage, username, password), UTF_8))\n+                .build();\n+\n+        StringResponseHandler.StringResponse response = httpClient.execute(request, StringResponseHandler.createStringResponseHandler());\n+\n+        if (response.getStatusCode() != 200) {\n+            throw new AccessDeniedException(String.format(\"Invalid response for login\\n.%s\",\n+                    response.getBody()));\n+        }\n+\n+        Document xmlResponse;\n+        try {\n+            DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+            DocumentBuilder builder = factory.newDocumentBuilder();\n+            xmlResponse = builder.parse(new InputSource(new StringReader(\n+                    response.getBody())));\n+        }\n+        catch (ParserConfigurationException | SAXException | IOException e) {\n+            throw new RuntimeException(String.format(\"Error parsing response: %s\\n\\tReceived error message: %s\",\n+                    response.getBody(),\n+                    e.getMessage()));\n+        }\n+\n+        // Make sure a Session Id has been returned.\n+        getElementValue(xmlResponse, \"sessionId\");\n+\n+        // We want the organizationId from the response to compare it to the configured org from password-authenticator.properties.\n+        String returnedOrg = getElementValue(xmlResponse, \"organizationId\");\n+        // If the only entry in the set is \"all\", don't bother to check, otherwise make sure the returned org is in the set.\n+        // The organizationId is always in Locale.US, regardless of the user's locale and language.\n+        if (!(allowedOrganizations.size() == 1 && allowedOrganizations.contains(\"all\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e980142135dae30e630189904f984fd59d3378a"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyNzc2Nw==", "bodyText": "I'd use 1h here instead", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r464727767", "createdAt": "2020-08-04T00:16:59Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceConfig.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.ConfigDescription;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDuration;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+public class SalesforceConfig\n+{\n+    private int cacheSize = 4096;\n+    private Duration cacheExpireSeconds = Duration.succinctDuration(120, TimeUnit.SECONDS);\n+    private String allowedOrganizations;\n+\n+    @NotNull(message = \"Must set salesforce.allowed-organization with one or more Salesforce 18 char Organization Ids, or \\\"all\\\"\")\n+    public String getAllowedOrganizations()\n+    {\n+        return allowedOrganizations;\n+    }\n+\n+    public Set<String> getOrgSet()\n+    {\n+        Set<String> tmp = new HashSet<>();\n+        if (allowedOrganizations == null) {\n+            allowedOrganizations = \"\";\n+        }\n+        String[] orgsSplit = allowedOrganizations.split(\"[,;]\");\n+        for (String s : orgsSplit) {\n+            // The organizationId is always in Locale.US, regardless of the user's locale and language.\n+            tmp.add(s.toLowerCase(Locale.US).trim());\n+        }\n+\n+        return tmp;\n+    }\n+\n+    @Config(\"salesforce.allowed-organizations\")\n+    @ConfigDescription(\"Comma separated list of Salesforce 18 Character Organization Ids.\")\n+    public SalesforceConfig setAllowedOrganizations(String allowedOrganizations)\n+    {\n+        this.allowedOrganizations = allowedOrganizations;\n+        return this;\n+    }\n+\n+    public int getCacheSize()\n+    {\n+        return cacheSize;\n+    }\n+\n+    @Config(\"salesforce.cache-size\")\n+    @ConfigDescription(\"Maximum size of the cache that holds authenticated users.  Default is 4096 entries.\")\n+    public SalesforceConfig setCacheSize(int cacheSize)\n+    {\n+        this.cacheSize = cacheSize;\n+        return this;\n+    }\n+\n+    @MaxDuration(value = \"3600s\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e980142135dae30e630189904f984fd59d3378a"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyNzc4OA==", "bodyText": "This should not be named -seconds now that we are using Duration since duration can be any unit.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r464727788", "createdAt": "2020-08-04T00:17:03Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceConfig.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.ConfigDescription;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDuration;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+public class SalesforceConfig\n+{\n+    private int cacheSize = 4096;\n+    private Duration cacheExpireSeconds = Duration.succinctDuration(120, TimeUnit.SECONDS);\n+    private String allowedOrganizations;\n+\n+    @NotNull(message = \"Must set salesforce.allowed-organization with one or more Salesforce 18 char Organization Ids, or \\\"all\\\"\")\n+    public String getAllowedOrganizations()\n+    {\n+        return allowedOrganizations;\n+    }\n+\n+    public Set<String> getOrgSet()\n+    {\n+        Set<String> tmp = new HashSet<>();\n+        if (allowedOrganizations == null) {\n+            allowedOrganizations = \"\";\n+        }\n+        String[] orgsSplit = allowedOrganizations.split(\"[,;]\");\n+        for (String s : orgsSplit) {\n+            // The organizationId is always in Locale.US, regardless of the user's locale and language.\n+            tmp.add(s.toLowerCase(Locale.US).trim());\n+        }\n+\n+        return tmp;\n+    }\n+\n+    @Config(\"salesforce.allowed-organizations\")\n+    @ConfigDescription(\"Comma separated list of Salesforce 18 Character Organization Ids.\")\n+    public SalesforceConfig setAllowedOrganizations(String allowedOrganizations)\n+    {\n+        this.allowedOrganizations = allowedOrganizations;\n+        return this;\n+    }\n+\n+    public int getCacheSize()\n+    {\n+        return cacheSize;\n+    }\n+\n+    @Config(\"salesforce.cache-size\")\n+    @ConfigDescription(\"Maximum size of the cache that holds authenticated users.  Default is 4096 entries.\")\n+    public SalesforceConfig setCacheSize(int cacheSize)\n+    {\n+        this.cacheSize = cacheSize;\n+        return this;\n+    }\n+\n+    @MaxDuration(value = \"3600s\")\n+    public Duration getCacheExpireSeconds()\n+    {\n+        return cacheExpireSeconds;\n+    }\n+\n+    @Config(\"salesforce.cache-expire-seconds\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e980142135dae30e630189904f984fd59d3378a"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyODY2NA==", "bodyText": "style: we don't use final on local variables (or parameters)", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r464728664", "createdAt": "2020-08-04T00:20:15Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/salesforce/TestSalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,266 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.net.MediaType;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.HttpStatus;\n+import io.airlift.http.client.jetty.JettyHttpClient;\n+import io.airlift.http.client.testing.TestingHttpClient;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import org.testng.SkipException;\n+import org.testng.annotations.BeforeSuite;\n+import org.testng.annotations.Test;\n+\n+import java.security.Principal;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Strings.emptyToNull;\n+import static io.airlift.http.client.testing.TestingResponse.mockResponse;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+public class TestSalesforceBasicAuthenticator\n+{\n+    private boolean forReal;\n+\n+    private final String successResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns=\\\"urn:partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><loginResponse><result><metadataServerUrl>https://example.salesforce.com/services/Soap/m/46.0/example</metadataServerUrl><passwordExpired>false</passwordExpired><sandbox>false</sandbox><serverUrl>https://example.salesforce.com/services/Soap/u/46.0/example</serverUrl><sessionId>example</sessionId><userId>example</userId><userInfo><accessibilityMode>false</accessibilityMode><chatterExternal>false</chatterExternal><currencySymbol>$</currencySymbol><orgAttachmentFileSizeLimit>5242880</orgAttachmentFileSizeLimit><orgDefaultCurrencyIsoCode>USD</orgDefaultCurrencyIsoCode><orgDefaultCurrencyLocale>en_US</orgDefaultCurrencyLocale><orgDisallowHtmlAttachments>false</orgDisallowHtmlAttachments><orgHasPersonAccounts>true</orgHasPersonAccounts><organizationId>%s</organizationId><organizationMultiCurrency>false</organizationMultiCurrency><organizationName>example</organizationName><profileId>example</profileId><roleId>example</roleId><sessionSecondsValid>7200</sessionSecondsValid><userDefaultCurrencyIsoCode xsi:nil=\\\"true\\\"/><userEmail>user@salesforce.com</userEmail><userFullName>Vince Chase</userFullName><userId>example</userId><userLanguage>en_US</userLanguage><userLocale>en_US</userLocale><userName>%s</userName><userTimeZone>America/Chicago</userTimeZone><userType>Standard</userType><userUiSkin>Theme3</userUiSkin></userInfo></result></loginResponse></soapenv:Body></soapenv:Envelope>\";\n+    private final String failedResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns:sf=\\\"urn:fault.partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><soapenv:Fault><faultcode>sf:INVALID_LOGIN</faultcode><faultstring>INVALID_LOGIN: Invalid username, password, security token; or user locked out.</faultstring><detail><sf:LoginFault xsi:type=\\\"sf:LoginFault\\\"><sf:exceptionCode>INVALID_LOGIN</sf:exceptionCode><sf:exceptionMessage>Invalid username, password, security token; or user locked out.</sf:exceptionMessage></sf:LoginFault></detail></soapenv:Fault></soapenv:Body></soapenv:Envelope>\";\n+\n+    @BeforeSuite\n+    void initOnce()\n+    {\n+        forReal = false;\n+        String forRealEnvVar = System.getenv(\"SALESFORCE_TEST_FORREAL\");\n+        if (forRealEnvVar != null && forRealEnvVar.equalsIgnoreCase(\"TRUE\")) {\n+            forReal = true;\n+        }\n+    }\n+\n+    @Test\n+    public void createAuthenticatedPrincipalSuccess()\n+            throws InterruptedException\n+    {\n+        String org = \"my18CharOrgId\";  // As if from salesforce.org property.\n+        String username = \"user@salesforce.com\";\n+        String password = \"passtoken\";\n+\n+        SalesforceConfig config = new SalesforceConfig()\n+                .setAllowedOrganizations(org)\n+                .setCacheExpireSeconds(Duration.succinctDuration(1, TimeUnit.SECONDS)); // Test cache timeout.\n+\n+        String xmlResponse = String.format(successResponse, org, username);\n+\n+        HttpClient testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.OK, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+\n+        Principal principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name.\");\n+\n+        principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name from cache.\");\n+\n+        Thread.sleep(2000L);\n+        principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name from expired cache.\");\n+    }\n+\n+    @Test(expectedExceptions = AccessDeniedException.class)\n+    public void createAuthenticatedPrincipalWrongOrg()\n+    {\n+        String org = \"my18CharOrgId\";  // As if from salesforce.org property.\n+        String username = \"user@salesforce.com\";\n+        String password = \"passtoken\";\n+\n+        SalesforceConfig config = new SalesforceConfig()\n+                .setAllowedOrganizations(org);\n+\n+        final String xmlResponse = String.format(successResponse, \"NotMyOrg\", username);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e980142135dae30e630189904f984fd59d3378a"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyODc4NQ==", "bodyText": "Consider static importing the response code and media types", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r464728785", "createdAt": "2020-08-04T00:20:43Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/salesforce/TestSalesforceBasicAuthenticator.java", "diffHunk": "@@ -0,0 +1,266 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import com.google.common.net.MediaType;\n+import io.airlift.http.client.HttpClient;\n+import io.airlift.http.client.HttpStatus;\n+import io.airlift.http.client.jetty.JettyHttpClient;\n+import io.airlift.http.client.testing.TestingHttpClient;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.security.AccessDeniedException;\n+import org.testng.SkipException;\n+import org.testng.annotations.BeforeSuite;\n+import org.testng.annotations.Test;\n+\n+import java.security.Principal;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.google.common.base.Strings.emptyToNull;\n+import static io.airlift.http.client.testing.TestingResponse.mockResponse;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+public class TestSalesforceBasicAuthenticator\n+{\n+    private boolean forReal;\n+\n+    private final String successResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns=\\\"urn:partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><loginResponse><result><metadataServerUrl>https://example.salesforce.com/services/Soap/m/46.0/example</metadataServerUrl><passwordExpired>false</passwordExpired><sandbox>false</sandbox><serverUrl>https://example.salesforce.com/services/Soap/u/46.0/example</serverUrl><sessionId>example</sessionId><userId>example</userId><userInfo><accessibilityMode>false</accessibilityMode><chatterExternal>false</chatterExternal><currencySymbol>$</currencySymbol><orgAttachmentFileSizeLimit>5242880</orgAttachmentFileSizeLimit><orgDefaultCurrencyIsoCode>USD</orgDefaultCurrencyIsoCode><orgDefaultCurrencyLocale>en_US</orgDefaultCurrencyLocale><orgDisallowHtmlAttachments>false</orgDisallowHtmlAttachments><orgHasPersonAccounts>true</orgHasPersonAccounts><organizationId>%s</organizationId><organizationMultiCurrency>false</organizationMultiCurrency><organizationName>example</organizationName><profileId>example</profileId><roleId>example</roleId><sessionSecondsValid>7200</sessionSecondsValid><userDefaultCurrencyIsoCode xsi:nil=\\\"true\\\"/><userEmail>user@salesforce.com</userEmail><userFullName>Vince Chase</userFullName><userId>example</userId><userLanguage>en_US</userLanguage><userLocale>en_US</userLocale><userName>%s</userName><userTimeZone>America/Chicago</userTimeZone><userType>Standard</userType><userUiSkin>Theme3</userUiSkin></userInfo></result></loginResponse></soapenv:Body></soapenv:Envelope>\";\n+    private final String failedResponse = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns:sf=\\\"urn:fault.partner.soap.sforce.com\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"><soapenv:Body><soapenv:Fault><faultcode>sf:INVALID_LOGIN</faultcode><faultstring>INVALID_LOGIN: Invalid username, password, security token; or user locked out.</faultstring><detail><sf:LoginFault xsi:type=\\\"sf:LoginFault\\\"><sf:exceptionCode>INVALID_LOGIN</sf:exceptionCode><sf:exceptionMessage>Invalid username, password, security token; or user locked out.</sf:exceptionMessage></sf:LoginFault></detail></soapenv:Fault></soapenv:Body></soapenv:Envelope>\";\n+\n+    @BeforeSuite\n+    void initOnce()\n+    {\n+        forReal = false;\n+        String forRealEnvVar = System.getenv(\"SALESFORCE_TEST_FORREAL\");\n+        if (forRealEnvVar != null && forRealEnvVar.equalsIgnoreCase(\"TRUE\")) {\n+            forReal = true;\n+        }\n+    }\n+\n+    @Test\n+    public void createAuthenticatedPrincipalSuccess()\n+            throws InterruptedException\n+    {\n+        String org = \"my18CharOrgId\";  // As if from salesforce.org property.\n+        String username = \"user@salesforce.com\";\n+        String password = \"passtoken\";\n+\n+        SalesforceConfig config = new SalesforceConfig()\n+                .setAllowedOrganizations(org)\n+                .setCacheExpireSeconds(Duration.succinctDuration(1, TimeUnit.SECONDS)); // Test cache timeout.\n+\n+        String xmlResponse = String.format(successResponse, org, username);\n+\n+        HttpClient testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.OK, MediaType.ANY_TEXT_TYPE, xmlResponse)));\n+        SalesforceBasicAuthenticator authenticator = new SalesforceBasicAuthenticator(config, testHttpClient);\n+\n+        Principal principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name.\");\n+\n+        principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name from cache.\");\n+\n+        Thread.sleep(2000L);\n+        principal = authenticator.createAuthenticatedPrincipal(username, password);\n+        assertEquals(principal.getName(), username, \"Test principal name from expired cache.\");\n+    }\n+\n+    @Test(expectedExceptions = AccessDeniedException.class)\n+    public void createAuthenticatedPrincipalWrongOrg()\n+    {\n+        String org = \"my18CharOrgId\";  // As if from salesforce.org property.\n+        String username = \"user@salesforce.com\";\n+        String password = \"passtoken\";\n+\n+        SalesforceConfig config = new SalesforceConfig()\n+                .setAllowedOrganizations(org);\n+\n+        final String xmlResponse = String.format(successResponse, \"NotMyOrg\", username);\n+\n+        HttpClient testHttpClient = new TestingHttpClient((request -> mockResponse(HttpStatus.OK, MediaType.ANY_TEXT_TYPE, xmlResponse)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e980142135dae30e630189904f984fd59d3378a"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0MTgyNg==", "bodyText": "Let's go with Expire time in for an entry in cache since last write. The description should not include the default value.  The default is printed separately during setup, and the airlift config system has a way to override the defaults.  Also, I don't think we include the max in any descriptions.", "url": "https://github.com/trinodb/trino/pull/4372#discussion_r464741826", "createdAt": "2020-08-04T01:10:41Z", "author": {"login": "dain"}, "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/salesforce/SalesforceConfig.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.password.salesforce;\n+\n+import io.airlift.configuration.Config;\n+import io.airlift.configuration.ConfigDescription;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MaxDuration;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+public class SalesforceConfig\n+{\n+    private int cacheSize = 4096;\n+    private Duration cacheExpireSeconds = Duration.succinctDuration(120, TimeUnit.SECONDS);\n+    private String allowedOrganizations;\n+\n+    @NotNull(message = \"Must set salesforce.allowed-organization with one or more Salesforce 18 char Organization Ids, or \\\"all\\\"\")\n+    public String getAllowedOrganizations()\n+    {\n+        return allowedOrganizations;\n+    }\n+\n+    public Set<String> getOrgSet()\n+    {\n+        Set<String> tmp = new HashSet<>();\n+        if (allowedOrganizations == null) {\n+            allowedOrganizations = \"\";\n+        }\n+        String[] orgsSplit = allowedOrganizations.split(\"[,;]\");\n+        for (String s : orgsSplit) {\n+            // The organizationId is always in Locale.US, regardless of the user's locale and language.\n+            tmp.add(s.toLowerCase(Locale.US).trim());\n+        }\n+\n+        return tmp;\n+    }\n+\n+    @Config(\"salesforce.allowed-organizations\")\n+    @ConfigDescription(\"Comma separated list of Salesforce 18 Character Organization Ids.\")\n+    public SalesforceConfig setAllowedOrganizations(String allowedOrganizations)\n+    {\n+        this.allowedOrganizations = allowedOrganizations;\n+        return this;\n+    }\n+\n+    public int getCacheSize()\n+    {\n+        return cacheSize;\n+    }\n+\n+    @Config(\"salesforce.cache-size\")\n+    @ConfigDescription(\"Maximum size of the cache that holds authenticated users.  Default is 4096 entries.\")\n+    public SalesforceConfig setCacheSize(int cacheSize)\n+    {\n+        this.cacheSize = cacheSize;\n+        return this;\n+    }\n+\n+    @MaxDuration(value = \"3600s\")\n+    public Duration getCacheExpireSeconds()\n+    {\n+        return cacheExpireSeconds;\n+    }\n+\n+    @Config(\"salesforce.cache-expire-seconds\")\n+    @ConfigDescription(\"Expire time in seconds for an entry in cache since last write.  Default is 120 seconds, max is 3600 seconds.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e980142135dae30e630189904f984fd59d3378a"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00d66e4fbb65529d877e7a645561b1510cf7cbcc", "author": {"user": {"login": "bweissler-sf", "name": "Brian Weissler"}}, "url": "https://github.com/trinodb/trino/commit/00d66e4fbb65529d877e7a645561b1510cf7cbcc", "committedDate": "2020-08-05T13:41:54Z", "message": "Addressed second round of review comments, mainly added xml escaping and changing cache expiration property to reflect Duration type."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMDIxOTky", "url": "https://github.com/trinodb/trino/pull/4372#pullrequestreview-463021992", "createdAt": "2020-08-07T04:11:25Z", "commit": {"oid": "00d66e4fbb65529d877e7a645561b1510cf7cbcc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4984, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}