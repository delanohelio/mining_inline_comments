{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NDk5OTE0", "number": 2639, "reviewThreads": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjo0NTo1OVrODfCBTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyNjowMlrODfCXjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODY1NTQ4OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/ldap.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjo0NTo1OVrOFogKCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjo0NTo1OVrOFogKCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxNDIxNw==", "bodyText": "Should this be\n\nFile containing rules for mapping users.\n\nuser-extraction -> user-mapping", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378014217", "createdAt": "2020-02-12T02:45:59Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/ldap.rst", "diffHunk": "@@ -76,24 +76,29 @@ to the coordinator's ``config.properties`` file:\n     http-server.https.keystore.path=/etc/presto_keystore.jks\n     http-server.https.keystore.key=keystore_password\n \n-======================================================= ======================================================\n-Property                                                Description\n-======================================================= ======================================================\n-``http-server.authentication.type``                     Enable password authentication for the Presto\n-                                                        coordinator. Must be set to ``PASSWORD``.\n-``http-server.https.enabled``                           Enables HTTPS access for the Presto coordinator.\n-                                                        Should be set to ``true``. Default value is\n-                                                        ``false``.\n-``http-server.https.port``                              HTTPS server port.\n-``http-server.https.keystore.path``                     The location of the Java Keystore file that will be\n-                                                        used to secure TLS.\n-``http-server.https.keystore.key``                      The password for the keystore. This must match the\n-                                                        password you specified when creating the keystore.\n-``http-server.authentication.allow-forwarded-https``    Enable treating forwarded HTTPS requests over HTTP\n-                                                        as secure.  Requires the ``X-Forwarded-Proto`` header\n-                                                        to be set to ``https`` on forwarded requests.\n-                                                        Default value is ``false``.\n-======================================================= ======================================================\n+============================================================= ======================================================\n+Property                                                      Description\n+============================================================= ======================================================\n+``http-server.authentication.type``                           Enable password authentication for the Presto\n+                                                              coordinator. Must be set to ``PASSWORD``.\n+``http-server.https.enabled``                                 Enables HTTPS access for the Presto coordinator.\n+                                                              Should be set to ``true``. Default value is\n+                                                              ``false``.\n+``http-server.https.port``                                    HTTPS server port.\n+``http-server.https.keystore.path``                           The location of the Java Keystore file that will be\n+                                                              used to secure TLS.\n+``http-server.https.keystore.key``                            The password for the keystore. This must match the\n+                                                              password you specified when creating the keystore.\n+``http-server.authentication.allow-forwarded-https``          Enable treating forwarded HTTPS requests over HTTP\n+                                                              as secure.  Requires the ``X-Forwarded-Proto`` header\n+                                                              to be set to ``https`` on forwarded requests.\n+                                                              Default value is ``false``.\n+``http-server.authentication.password.user-mapping.pattern``  Regex to match against user.  If matched, user will be\n+                                                              replaced with first regex group. If not matched,\n+                                                              authentication is denied.  Default is ``(.*)``.\n+``http-server.authentication.password.user-extraction.file``  File containing rules for extracting user.  See", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODY1Nzk4OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/server.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjo0Nzo1OFrOFogLqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjo0Nzo1OFrOFogLqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxNDYzNA==", "bodyText": "Should this be\n\nFile containing rules for mapping users.", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378014634", "createdAt": "2020-02-12T02:47:58Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/server.rst", "diffHunk": "@@ -97,29 +97,34 @@ Kerberos authentication is configured in the coordinator node's\n     http-server.https.keystore.path=/etc/presto_keystore.jks\n     http-server.https.keystore.key=keystore_password\n \n-======================================================= ======================================================\n-Property                                                Description\n-======================================================= ======================================================\n-``http-server.authentication.type``                     Authentication type for the Presto\n-                                                        coordinator. Must be set to ``KERBEROS``.\n-``http-server.authentication.krb5.service-name``        The Kerberos service name for the Presto coordinator.\n-                                                        Must match the Kerberos principal.\n-``http-server.authentication.krb5.principal-hostname``  The Kerberos hostname for the Presto coordinator.\n-                                                        Must match the Kerberos principal. This parameter is\n-                                                        optional. If included, Presto uses this value\n-                                                        in the host part of the Kerberos principal instead\n-                                                        of the machine's hostname.\n-``http-server.authentication.krb5.keytab``              The location of the keytab that can be used to\n-                                                        authenticate the Kerberos principal.\n-``http.authentication.krb5.config``                     The location of the Kerberos configuration file.\n-``http-server.https.enabled``                           Enables HTTPS access for the Presto coordinator.\n-                                                        Should be set to ``true``.\n-``http-server.https.port``                              HTTPS server port.\n-``http-server.https.keystore.path``                     The location of the Java Keystore file that is\n-                                                        used to secure TLS.\n-``http-server.https.keystore.key``                      The password for the keystore. This must match the\n-                                                        password you specified when creating the keystore.\n-======================================================= ======================================================\n+========================================================= ======================================================\n+Property                                                  Description\n+========================================================= ======================================================\n+``http-server.authentication.type``                       Authentication type for the Presto\n+                                                          coordinator. Must be set to ``KERBEROS``.\n+``http-server.authentication.krb5.service-name``          The Kerberos service name for the Presto coordinator.\n+                                                          Must match the Kerberos principal.\n+``http-server.authentication.krb5.principal-hostname``    The Kerberos hostname for the Presto coordinator.\n+                                                          Must match the Kerberos principal. This parameter is\n+                                                          optional. If included, Presto uses this value\n+                                                          in the host part of the Kerberos principal instead\n+                                                          of the machine's hostname.\n+``http-server.authentication.krb5.keytab``                The location of the keytab that can be used to\n+                                                          authenticate the Kerberos principal.\n+``http.authentication.krb5.config``                       The location of the Kerberos configuration file.\n+``http-server.https.enabled``                             Enables HTTPS access for the Presto coordinator.\n+                                                          Should be set to ``true``.\n+``http-server.https.port``                                HTTPS server port.\n+``http-server.https.keystore.path``                       The location of the Java Keystore file that is\n+                                                          used to secure TLS.\n+``http-server.https.keystore.key``                        The password for the keystore. This must match the\n+                                                          password you specified when creating the keystore.\n+``http-server.authentication.krb5.user-mapping.pattern``  Regex to match against user.  If matched, user will be\n+                                                          replaced with first regex group. If not matched,\n+                                                          authentication is denied.  Default is ``(.*)``.\n+``http-server.authentication.krb5.user-mapping.file``     File containing rules for extracting user.  See", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODY1OTM2OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/server.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjo0OTowMFrOFogMnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjo0OTowMFrOFogMnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxNDg3OQ==", "bodyText": "using a user mapping", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378014879", "createdAt": "2020-02-12T02:49:00Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/server.rst", "diffHunk": "@@ -151,6 +156,16 @@ See :doc:`/develop/system-access-control` for details.\n \n .. _coordinator-troubleshooting:\n \n+User Mapping\n+------------\n+\n+After authenticating with Kerberos, the Presto server receives the user's principal which is typically similar to\n+an email address.  For example, when ``alice`` logs in in Presto might receive ``alice@example.com``.  By default,\n+Presto will use the full Kerberos principal name, but this can be mapped to a shorter name using an user-extraction", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODY1OTc1OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/server.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjo0OToxNVrOFogM2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjo0OToxNVrOFogM2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxNDkzNg==", "bodyText": "Comma after \"rules\"\nuser-extraction -> user-mapping", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378014936", "createdAt": "2020-02-12T02:49:15Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/server.rst", "diffHunk": "@@ -151,6 +156,16 @@ See :doc:`/develop/system-access-control` for details.\n \n .. _coordinator-troubleshooting:\n \n+User Mapping\n+------------\n+\n+After authenticating with Kerberos, the Presto server receives the user's principal which is typically similar to\n+an email address.  For example, when ``alice`` logs in in Presto might receive ``alice@example.com``.  By default,\n+Presto will use the full Kerberos principal name, but this can be mapped to a shorter name using an user-extraction\n+pattern.  For simple extraction rules the  ``http-server.authentication.krb5.user-extraction.pattern`` configuration", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODY2MDgxOnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/server.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjo1MDowM1rOFogNgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMjo1MDowM1rOFogNgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxNTEwNw==", "bodyText": "Missing word \"a\"\n\ncan be set to a Java regular expression", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378015107", "createdAt": "2020-02-12T02:50:03Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/server.rst", "diffHunk": "@@ -151,6 +156,16 @@ See :doc:`/develop/system-access-control` for details.\n \n .. _coordinator-troubleshooting:\n \n+User Mapping\n+------------\n+\n+After authenticating with Kerberos, the Presto server receives the user's principal which is typically similar to\n+an email address.  For example, when ``alice`` logs in in Presto might receive ``alice@example.com``.  By default,\n+Presto will use the full Kerberos principal name, but this can be mapped to a shorter name using an user-extraction\n+pattern.  For simple extraction rules the  ``http-server.authentication.krb5.user-extraction.pattern`` configuration\n+property can be set to Java regular expression, and Presto will use the value of the first matcher group.  If the", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODY4NzI2OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/server.rst", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzowNzoxNlrOFogdJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzowNzo0MlrOFogdgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxOTEwOA==", "bodyText": "Extra word \"do\"", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378019108", "createdAt": "2020-02-12T03:07:16Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/server.rst", "diffHunk": "@@ -151,6 +156,16 @@ See :doc:`/develop/system-access-control` for details.\n \n .. _coordinator-troubleshooting:\n \n+User Mapping\n+------------\n+\n+After authenticating with Kerberos, the Presto server receives the user's principal which is typically similar to\n+an email address.  For example, when ``alice`` logs in in Presto might receive ``alice@example.com``.  By default,\n+Presto will use the full Kerberos principal name, but this can be mapped to a shorter name using an user-extraction\n+pattern.  For simple extraction rules the  ``http-server.authentication.krb5.user-extraction.pattern`` configuration\n+property can be set to Java regular expression, and Presto will use the value of the first matcher group.  If the\n+regular expression do does not match, the authentication is denied.  For more complex user-extraction rules see .", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxOTIwMQ==", "bodyText": "This last sentence seems wrong (mentions \"extraction\") and doesn't link anywhere", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378019201", "createdAt": "2020-02-12T03:07:42Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/server.rst", "diffHunk": "@@ -151,6 +156,16 @@ See :doc:`/develop/system-access-control` for details.\n \n .. _coordinator-troubleshooting:\n \n+User Mapping\n+------------\n+\n+After authenticating with Kerberos, the Presto server receives the user's principal which is typically similar to\n+an email address.  For example, when ``alice`` logs in in Presto might receive ``alice@example.com``.  By default,\n+Presto will use the full Kerberos principal name, but this can be mapped to a shorter name using an user-extraction\n+pattern.  For simple extraction rules the  ``http-server.authentication.krb5.user-extraction.pattern`` configuration\n+property can be set to Java regular expression, and Presto will use the value of the first matcher group.  If the\n+regular expression do does not match, the authentication is denied.  For more complex user-extraction rules see .", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxOTEwOA=="}, "originalCommit": null, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODY5MTg2OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/built-in-system-access-control.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoxMDoyN1rOFogf1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoxMDoyN1rOFogf1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxOTc5Ng==", "bodyText": "Remove extra blank line", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378019796", "createdAt": "2020-02-12T03:10:27Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/built-in-system-access-control.rst", "diffHunk": "@@ -143,9 +144,47 @@ and deny all other access, you can use the following rules:\n       ]\n     }\n \n+Impersonation Rules\n+-------------------\n+\n+These rules control the ability of a user to impersonate another user.  In\n+some environments it is desirable for an administrator (or managed system) to\n+run queries on behalf of other users.  In these cases the administrator\n+authenticates using their credentials, and then submits a query as a different\n+user.  When the user context is changed, Presto will verify the administrator\n+is authorized to run queries as the target user.\n+\n+When these rules are present, the authorization is based on the first matching\n+rule read from top to bottom.  If no rules match, the authorization is denied.\n+If impersonation rules are not present but the legacy principal rules are specified,\n+it is assumed impersonation access control is being handled by the principal rules,\n+so impersonation is allowed.  If neither impersonation or principal rules are\n+defined, impersonation is not allowed.\n+\n+Each impersonation rule is composed of the following fields:\n+\n+* ``originalUser`` (required): regex to match against the user requesting the impersonation.\n+* ``newUser`` (required): regex to match against the user that will be impersonated.\n+* ``allow`` (optional): boolean indicating if the authentication should be allowed.\n+\n+The following example allows the two admins ``alice`` and ``bob`` to impersonate\n+any user, except not the other admin.  It also allows any user to impersonate the\n+``test`` user:\n+\n+.. literalinclude:: user-impersonation.json\n+    :language: json\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODY5MjkxOnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/user-mapping.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoxMToxNVrOFoggeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoxMToxNVrOFoggeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxOTk2MQ==", "bodyText": "and -> or", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378019961", "createdAt": "2020-02-12T03:11:15Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/user-mapping.rst", "diffHunk": "@@ -0,0 +1,61 @@\n+============\n+User Mapping\n+============\n+\n+User mapping defines rules for mapping from users in the authentication system to Presto users.  This\n+mapping is particularly important for Kerberos and certificate authentication where the user names", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODY5NjA1OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/user-mapping.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoxMzozOVrOFogiWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoxMzozOVrOFogiWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyMDQ0Mg==", "bodyText": "password -> Password", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378020442", "createdAt": "2020-02-12T03:13:39Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/user-mapping.rst", "diffHunk": "@@ -0,0 +1,61 @@\n+============\n+User Mapping\n+============\n+\n+User mapping defines rules for mapping from users in the authentication system to Presto users.  This\n+mapping is particularly important for Kerberos and certificate authentication where the user names\n+are complex like ``alice@example`` or ``CN=Alice Smith, OU=Finance, O=Acme, C=US``.\n+\n+User mapping can be configured with a simple regex extraction pattern, or more complex rules in a\n+separate configuration file.\n+\n+Pattern Mapping Rule\n+--------------------\n+\n+The pattern mapping rule maps the authentication user to the first matching group in the regular\n+expression.  If the regular expression does not match the authentication user, authentication is\n+denied.\n+\n+Each authentication system has a separate property for the user mapping pattern to allow different mapping\n+when multiple authentication systems are enabled:\n+\n+===================================== ===============================================================\n+Authentication                        Property\n+===================================== ===============================================================\n+Username and password (file or LDAP)  ``http-server.authentication.password.user-mapping.pattern``", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODY5NzUzOnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/user-mapping.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoxNDo1NlrOFogjRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoxNDo1NlrOFogjRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyMDY3Ng==", "bodyText": "json -> JSON", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378020676", "createdAt": "2020-02-12T03:14:56Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/user-mapping.rst", "diffHunk": "@@ -0,0 +1,61 @@\n+============\n+User Mapping\n+============\n+\n+User mapping defines rules for mapping from users in the authentication system to Presto users.  This\n+mapping is particularly important for Kerberos and certificate authentication where the user names\n+are complex like ``alice@example`` or ``CN=Alice Smith, OU=Finance, O=Acme, C=US``.\n+\n+User mapping can be configured with a simple regex extraction pattern, or more complex rules in a\n+separate configuration file.\n+\n+Pattern Mapping Rule\n+--------------------\n+\n+The pattern mapping rule maps the authentication user to the first matching group in the regular\n+expression.  If the regular expression does not match the authentication user, authentication is\n+denied.\n+\n+Each authentication system has a separate property for the user mapping pattern to allow different mapping\n+when multiple authentication systems are enabled:\n+\n+===================================== ===============================================================\n+Authentication                        Property\n+===================================== ===============================================================\n+Username and password (file or LDAP)  ``http-server.authentication.password.user-mapping.pattern``\n+Kerberos                              ``http-server.authentication.krb5.user-mapping.pattern``\n+Certificate                           ``http-server.authentication.certificate.user-mapping.pattern``\n+Json Web Token                        ``http-server.authentication.jwt.user-mapping.pattern``\n+===================================== ===============================================================\n+\n+File Mapping Rules\n+------------------\n+\n+The file mapping rules allow for more complex mappings from the authentication user.  These rules are\n+loaded from a json file defined in a configuration property.  The mapping is based on the first matching", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODY5ODM0OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/user-mapping.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoxNTozN1rOFogjyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoxNTozN1rOFogjyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyMDgwOQ==", "bodyText": "The mapping is based on the first matching rule, processed from top to bottom.", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378020809", "createdAt": "2020-02-12T03:15:37Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/user-mapping.rst", "diffHunk": "@@ -0,0 +1,61 @@\n+============\n+User Mapping\n+============\n+\n+User mapping defines rules for mapping from users in the authentication system to Presto users.  This\n+mapping is particularly important for Kerberos and certificate authentication where the user names\n+are complex like ``alice@example`` or ``CN=Alice Smith, OU=Finance, O=Acme, C=US``.\n+\n+User mapping can be configured with a simple regex extraction pattern, or more complex rules in a\n+separate configuration file.\n+\n+Pattern Mapping Rule\n+--------------------\n+\n+The pattern mapping rule maps the authentication user to the first matching group in the regular\n+expression.  If the regular expression does not match the authentication user, authentication is\n+denied.\n+\n+Each authentication system has a separate property for the user mapping pattern to allow different mapping\n+when multiple authentication systems are enabled:\n+\n+===================================== ===============================================================\n+Authentication                        Property\n+===================================== ===============================================================\n+Username and password (file or LDAP)  ``http-server.authentication.password.user-mapping.pattern``\n+Kerberos                              ``http-server.authentication.krb5.user-mapping.pattern``\n+Certificate                           ``http-server.authentication.certificate.user-mapping.pattern``\n+Json Web Token                        ``http-server.authentication.jwt.user-mapping.pattern``\n+===================================== ===============================================================\n+\n+File Mapping Rules\n+------------------\n+\n+The file mapping rules allow for more complex mappings from the authentication user.  These rules are\n+loaded from a json file defined in a configuration property.  The mapping is based on the first matching\n+rule read from top to bottom. If no rules match, authentication is denied.  Each rule is composed of the", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODcwMTM5OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/user-mapping.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoxNzo0MFrOFogllQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoxNzo0MFrOFogllQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyMTI2OQ==", "bodyText": "Missing second backquote on bob@uk.example.com", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378021269", "createdAt": "2020-02-12T03:17:40Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/user-mapping.rst", "diffHunk": "@@ -0,0 +1,61 @@\n+============\n+User Mapping\n+============\n+\n+User mapping defines rules for mapping from users in the authentication system to Presto users.  This\n+mapping is particularly important for Kerberos and certificate authentication where the user names\n+are complex like ``alice@example`` or ``CN=Alice Smith, OU=Finance, O=Acme, C=US``.\n+\n+User mapping can be configured with a simple regex extraction pattern, or more complex rules in a\n+separate configuration file.\n+\n+Pattern Mapping Rule\n+--------------------\n+\n+The pattern mapping rule maps the authentication user to the first matching group in the regular\n+expression.  If the regular expression does not match the authentication user, authentication is\n+denied.\n+\n+Each authentication system has a separate property for the user mapping pattern to allow different mapping\n+when multiple authentication systems are enabled:\n+\n+===================================== ===============================================================\n+Authentication                        Property\n+===================================== ===============================================================\n+Username and password (file or LDAP)  ``http-server.authentication.password.user-mapping.pattern``\n+Kerberos                              ``http-server.authentication.krb5.user-mapping.pattern``\n+Certificate                           ``http-server.authentication.certificate.user-mapping.pattern``\n+Json Web Token                        ``http-server.authentication.jwt.user-mapping.pattern``\n+===================================== ===============================================================\n+\n+File Mapping Rules\n+------------------\n+\n+The file mapping rules allow for more complex mappings from the authentication user.  These rules are\n+loaded from a json file defined in a configuration property.  The mapping is based on the first matching\n+rule read from top to bottom. If no rules match, authentication is denied.  Each rule is composed of the\n+following fields:\n+\n+* ``pattern`` (required): regex to match against authentication user.\n+* ``user`` (optional): replacement string to substitute against pattern.\n+  The default value is ``$1``.\n+* ``allow`` (optional): boolean indicating if the authentication should be allowed.\n+\n+The following example maps all users like ``alice@example.com`` to just ``alice``, except for the ``test``\n+user which is denied authentication, and it maps users like ``bob@uk.example.com` to ``bob_uk``:", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODcwNDc1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/server/security/TestUserMapping.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyMDowOFrOFognhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyMDowOFrOFognhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyMTc2NQ==", "bodyText": "Add another region like apple_tw", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378021765", "createdAt": "2020-02-12T03:20:08Z", "author": {"login": "electrum"}, "path": "presto-main/src/test/java/io/prestosql/server/security/TestUserMapping.java", "diffHunk": "@@ -88,4 +88,18 @@ public void testMultipleRule()\n         assertThrows(UserMappingException.class, () -> userMapping.extractUser(\"test@example.com\"));\n         assertThrows(UserMappingException.class, () -> userMapping.extractUser(\"apple@other.example.com\"));\n     }\n+\n+    @Test\n+    public void testDocsExample()\n+            throws Exception\n+    {\n+        // TODO: figure out a better way to validate documentation\n+        File docExample = new File(\"../presto-docs/src/main/sphinx/security/user-mapping.json\");\n+        UserMapping userMapping = createUserMapping(Optional.empty(), Optional.of(docExample));\n+\n+        assertEquals(userMapping.extractUser(\"apple@example.com\"), \"apple\");\n+        assertEquals(userMapping.extractUser(\"apple@uk.example.com\"), \"apple_uk\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODcwNTcxOnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/built-in-system-access-control.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyMDo1NFrOFogoFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyMDo1NFrOFogoFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyMTkwOA==", "bodyText": "specifying -> specify", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378021908", "createdAt": "2020-02-12T03:20:54Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/built-in-system-access-control.rst", "diffHunk": "@@ -71,9 +71,10 @@ contents:\n The config file is specified in JSON format.\n \n * It contains the rules defining which catalog can be accessed by which user (see Catalog Rules below).\n+* The impersonation rules specifying which user impersonations are allowed (see Impersonation Rules below).", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODcwNjc0OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/built-in-system-access-control.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyMTozOVrOFogoqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyMTozOVrOFogoqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyMjA1Nw==", "bodyText": "Comma after \"cases\"", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378022057", "createdAt": "2020-02-12T03:21:39Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/built-in-system-access-control.rst", "diffHunk": "@@ -143,9 +144,47 @@ and deny all other access, you can use the following rules:\n       ]\n     }\n \n+Impersonation Rules\n+-------------------\n+\n+These rules control the ability of a user to impersonate another user.  In\n+some environments it is desirable for an administrator (or managed system) to\n+run queries on behalf of other users.  In these cases the administrator", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODcwODA5OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/built-in-system-access-control.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyMjo1MVrOFogpdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyMjo1MVrOFogpdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyMjI2MA==", "bodyText": "the authorization is based on the first matching rule, processed from top to bottom.", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378022260", "createdAt": "2020-02-12T03:22:51Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/built-in-system-access-control.rst", "diffHunk": "@@ -143,9 +144,47 @@ and deny all other access, you can use the following rules:\n       ]\n     }\n \n+Impersonation Rules\n+-------------------\n+\n+These rules control the ability of a user to impersonate another user.  In\n+some environments it is desirable for an administrator (or managed system) to\n+run queries on behalf of other users.  In these cases the administrator\n+authenticates using their credentials, and then submits a query as a different\n+user.  When the user context is changed, Presto will verify the administrator\n+is authorized to run queries as the target user.\n+\n+When these rules are present, the authorization is based on the first matching", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODcwODc3OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/built-in-system-access-control.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyMzoxOVrOFogp3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyMzoxOVrOFogp3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyMjM2Nw==", "bodyText": "or -> nor", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378022367", "createdAt": "2020-02-12T03:23:19Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/built-in-system-access-control.rst", "diffHunk": "@@ -143,9 +144,47 @@ and deny all other access, you can use the following rules:\n       ]\n     }\n \n+Impersonation Rules\n+-------------------\n+\n+These rules control the ability of a user to impersonate another user.  In\n+some environments it is desirable for an administrator (or managed system) to\n+run queries on behalf of other users.  In these cases the administrator\n+authenticates using their credentials, and then submits a query as a different\n+user.  When the user context is changed, Presto will verify the administrator\n+is authorized to run queries as the target user.\n+\n+When these rules are present, the authorization is based on the first matching\n+rule read from top to bottom.  If no rules match, the authorization is denied.\n+If impersonation rules are not present but the legacy principal rules are specified,\n+it is assumed impersonation access control is being handled by the principal rules,\n+so impersonation is allowed.  If neither impersonation or principal rules are", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODcxMTg1OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/built-in-system-access-control.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyNTozOFrOFogr0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyNTozOFrOFogr0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyMjg2NQ==", "bodyText": "Commas around \"alice and bob\"", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378022865", "createdAt": "2020-02-12T03:25:38Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/built-in-system-access-control.rst", "diffHunk": "@@ -143,9 +144,47 @@ and deny all other access, you can use the following rules:\n       ]\n     }\n \n+Impersonation Rules\n+-------------------\n+\n+These rules control the ability of a user to impersonate another user.  In\n+some environments it is desirable for an administrator (or managed system) to\n+run queries on behalf of other users.  In these cases the administrator\n+authenticates using their credentials, and then submits a query as a different\n+user.  When the user context is changed, Presto will verify the administrator\n+is authorized to run queries as the target user.\n+\n+When these rules are present, the authorization is based on the first matching\n+rule read from top to bottom.  If no rules match, the authorization is denied.\n+If impersonation rules are not present but the legacy principal rules are specified,\n+it is assumed impersonation access control is being handled by the principal rules,\n+so impersonation is allowed.  If neither impersonation or principal rules are\n+defined, impersonation is not allowed.\n+\n+Each impersonation rule is composed of the following fields:\n+\n+* ``originalUser`` (required): regex to match against the user requesting the impersonation.\n+* ``newUser`` (required): regex to match against the user that will be impersonated.\n+* ``allow`` (optional): boolean indicating if the authentication should be allowed.\n+\n+The following example allows the two admins ``alice`` and ``bob`` to impersonate", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODcxMjQ1OnYy", "diffSide": "RIGHT", "path": "presto-docs/src/main/sphinx/security/built-in-system-access-control.rst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyNjowMlrOFogsJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMzoyNjowMlrOFogsJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAyMjk1MQ==", "bodyText": "Maybe change to\n\nexcept they may not impersonate each other", "url": "https://github.com/trinodb/trino/pull/2639#discussion_r378022951", "createdAt": "2020-02-12T03:26:02Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/security/built-in-system-access-control.rst", "diffHunk": "@@ -143,9 +144,47 @@ and deny all other access, you can use the following rules:\n       ]\n     }\n \n+Impersonation Rules\n+-------------------\n+\n+These rules control the ability of a user to impersonate another user.  In\n+some environments it is desirable for an administrator (or managed system) to\n+run queries on behalf of other users.  In these cases the administrator\n+authenticates using their credentials, and then submits a query as a different\n+user.  When the user context is changed, Presto will verify the administrator\n+is authorized to run queries as the target user.\n+\n+When these rules are present, the authorization is based on the first matching\n+rule read from top to bottom.  If no rules match, the authorization is denied.\n+If impersonation rules are not present but the legacy principal rules are specified,\n+it is assumed impersonation access control is being handled by the principal rules,\n+so impersonation is allowed.  If neither impersonation or principal rules are\n+defined, impersonation is not allowed.\n+\n+Each impersonation rule is composed of the following fields:\n+\n+* ``originalUser`` (required): regex to match against the user requesting the impersonation.\n+* ``newUser`` (required): regex to match against the user that will be impersonated.\n+* ``allow`` (optional): boolean indicating if the authentication should be allowed.\n+\n+The following example allows the two admins ``alice`` and ``bob`` to impersonate\n+any user, except not the other admin.  It also allows any user to impersonate the", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 957, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}