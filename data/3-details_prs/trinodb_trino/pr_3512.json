{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3NDkyMzA1", "number": 3512, "title": "Optimize Elasticsearch queries that fetch no columns", "bodyText": "In that case, the connector only needs to produce pages with\na row count. We leverage Elasticsearch's count API.", "createdAt": "2020-04-22T19:30:03Z", "url": "https://github.com/trinodb/trino/pull/3512", "merged": true, "mergeCommit": {"oid": "176d22929c3af77c4bf5ca472e6237038ef58714"}, "closed": true, "closedAt": "2020-05-11T05:39:55Z", "author": {"login": "martint"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaRe7igBqjMyNjI4ODU3MjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcf98sLABqjMzMjA0OTI2MTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NzA2OTY1", "url": "https://github.com/trinodb/trino/pull/3512#pullrequestreview-398706965", "createdAt": "2020-04-23T01:55:33Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwMTo1NTozM1rOGKTGtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwMTo1NTozM1rOGKTGtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ1MTk1OA==", "bodyText": "Interesting that POST works.  Shouldn't this be a GET?", "url": "https://github.com/trinodb/trino/pull/3512#discussion_r413451958", "createdAt": "2020-04-23T01:55:33Z", "author": {"login": "aalbu"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/client/ElasticsearchClient.java", "diffHunk": "@@ -615,6 +607,45 @@ public SearchResponse nextPage(String scrollId)\n         }\n     }\n \n+    public long count(String index, int shard, QueryBuilder query)\n+    {\n+        SearchSourceBuilder sourceBuilder = SearchSourceBuilder.searchSource()\n+                .query(query);\n+\n+        LOG.debug(\"Count: %s:%s, query: %s\", index, shard, sourceBuilder);\n+\n+        long start = System.nanoTime();\n+        try {\n+            Response response;\n+            try {\n+                response = client.getLowLevelClient()\n+                        .performRequest(\n+                                \"POST\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 72}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMDg0ODU3", "url": "https://github.com/trinodb/trino/pull/3512#pullrequestreview-402084857", "createdAt": "2020-04-28T18:04:19Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMTM5MzEz", "url": "https://github.com/trinodb/trino/pull/3512#pullrequestreview-402139313", "createdAt": "2020-04-28T19:19:40Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxOToxOTo0MVrOGNjQYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxOTozMToyMVrOGNjqng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg2MjMwNQ==", "bodyText": "@sopel39 is it safe to inject 2 billion row pages into the system?\nin case of select count(*) from .., they are going to be partial aggregated quickly\nwhat about select 1 from .. query?\n(Martin, if you make pages, smaller, make it also lazy, as pages list  may grow big. Currently, it's well consttrained by my imagination)", "url": "https://github.com/trinodb/trino/pull/3512#discussion_r416862305", "createdAt": "2020-04-28T19:19:41Z", "author": {"login": "findepi"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/ElasticsearchPageSourceProvider.java", "diffHunk": "@@ -53,10 +58,33 @@ public ConnectorPageSource createPageSource(\n         requireNonNull(split, \"split is null\");\n         requireNonNull(table, \"table is null\");\n \n-        return new ElasticsearchPageSource(\n+        ElasticsearchTableHandle elasticsearchTable = (ElasticsearchTableHandle) table;\n+        ElasticsearchSplit elasticsearchSplit = (ElasticsearchSplit) split;\n+\n+        if (columns.isEmpty()) {\n+            long count = client.count(\n+                    elasticsearchSplit.getIndex(),\n+                    elasticsearchSplit.getShard(),\n+                    buildSearchQuery(session, elasticsearchTable.getConstraint().transform(ElasticsearchColumnHandle.class::cast), elasticsearchTable.getQuery()));\n+\n+            if (elasticsearchTable.getLimit().isPresent()) {\n+                count = Math.min(elasticsearchTable.getLimit().getAsLong(), count);\n+            }\n+\n+            ImmutableList.Builder<Page> pages = ImmutableList.builder();\n+            while (count > 0) {\n+                int batch = Ints.saturatedCast(count);\n+                pages.add(new Page(batch));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg2MjgzMQ==", "bodyText": "ScanQueryPageSource is going to repeat the same logic.\nMaybe do it here once, and pass to client.count or ScanQueryPageSource?", "url": "https://github.com/trinodb/trino/pull/3512#discussion_r416862831", "createdAt": "2020-04-28T19:20:31Z", "author": {"login": "findepi"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/ElasticsearchPageSourceProvider.java", "diffHunk": "@@ -53,10 +58,33 @@ public ConnectorPageSource createPageSource(\n         requireNonNull(split, \"split is null\");\n         requireNonNull(table, \"table is null\");\n \n-        return new ElasticsearchPageSource(\n+        ElasticsearchTableHandle elasticsearchTable = (ElasticsearchTableHandle) table;\n+        ElasticsearchSplit elasticsearchSplit = (ElasticsearchSplit) split;\n+\n+        if (columns.isEmpty()) {\n+            long count = client.count(\n+                    elasticsearchSplit.getIndex(),\n+                    elasticsearchSplit.getShard(),\n+                    buildSearchQuery(session, elasticsearchTable.getConstraint().transform(ElasticsearchColumnHandle.class::cast), elasticsearchTable.getQuery()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg2NzQ1MQ==", "bodyText": "would be nice to use sth like ThriftMetastoreApiStats -- less verbose and count failures too\n(no change requested)", "url": "https://github.com/trinodb/trino/pull/3512#discussion_r416867451", "createdAt": "2020-04-28T19:28:32Z", "author": {"login": "findepi"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/client/ElasticsearchClient.java", "diffHunk": "@@ -613,6 +605,45 @@ public SearchResponse nextPage(String scrollId)\n         }\n     }\n \n+    public long count(String index, int shard, QueryBuilder query)\n+    {\n+        SearchSourceBuilder sourceBuilder = SearchSourceBuilder.searchSource()\n+                .query(query);\n+\n+        LOG.debug(\"Count: %s:%s, query: %s\", index, shard, sourceBuilder);\n+\n+        long start = System.nanoTime();\n+        try {\n+            Response response;\n+            try {\n+                response = client.getLowLevelClient()\n+                        .performRequest(\n+                                \"GET\",\n+                                format(\"/%s/_count?preference=_shards:%s\", index, shard),\n+                                ImmutableMap.of(),\n+                                new StringEntity(sourceBuilder.toString()),\n+                                new BasicHeader(\"Content-Type\", \"application/json\"));\n+            }\n+            catch (ResponseException e) {\n+                throw propagate(e);\n+            }\n+            catch (IOException e) {\n+                throw new PrestoException(ELASTICSEARCH_CONNECTION_ERROR, e);\n+            }\n+\n+            try {\n+                return COUNT_RESPONSE_CODEC.fromJson(EntityUtils.toByteArray(response.getEntity()))\n+                        .getCount();\n+            }\n+            catch (IOException e) {\n+                throw new PrestoException(ELASTICSEARCH_INVALID_RESPONSE, e);\n+            }\n+        }\n+        finally {\n+            countStats.add(Duration.nanosSince(start));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg2Nzk4OA==", "bodyText": "would be nice to extract this in a separate \"extract ..\" commit\n(i assume nothing material changed beyond that btw)", "url": "https://github.com/trinodb/trino/pull/3512#discussion_r416867988", "createdAt": "2020-04-28T19:29:29Z", "author": {"login": "findepi"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/client/ElasticsearchClient.java", "diffHunk": "@@ -663,6 +701,31 @@ public TimeStat getNextPageStats()\n         return handler.process(body);\n     }\n \n+    private static PrestoException propagate(ResponseException exception)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg2OTAyMg==", "bodyText": "as we are heading towards more agg pushdowns, you can add this as generic test cases in\nio.prestosql.testing.AbstractTestIntegrationSmokeTest#testCountAll", "url": "https://github.com/trinodb/trino/pull/3512#discussion_r416869022", "createdAt": "2020-04-28T19:31:21Z", "author": {"login": "findepi"}, "path": "presto-elasticsearch/src/test/java/io/prestosql/elasticsearch/BaseElasticsearchSmokeTest.java", "diffHunk": "@@ -739,6 +740,15 @@ public void testMultiIndexAlias()\n                 \"SELECT (SELECT count(*) FROM region) + (SELECT count(*) FROM nation)\");\n     }\n \n+    @Test\n+    public void testCount()\n+    {\n+        assertQuery(\"SELECT count(*) FROM orders\");\n+        assertQuery(\"SELECT count(*) FROM orders WHERE orderkey > 10\");\n+        assertQuery(\"SELECT count(*) FROM (SELECT * FROM orders LIMIT 10)\");\n+        assertQuery(\"SELECT count(*) FROM (SELECT * FROM orders WHERE orderkey > 10 LIMIT 10)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd06d27a2bd465bb68c2e774f23bbbb895b79172", "author": {"user": {"login": "martint", "name": "Martin Traverso"}}, "url": "https://github.com/trinodb/trino/commit/dd06d27a2bd465bb68c2e774f23bbbb895b79172", "committedDate": "2020-05-09T00:35:05Z", "message": "Extract error handling processing to a separate method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjQ2MTY5", "url": "https://github.com/trinodb/trino/pull/3512#pullrequestreview-408646169", "createdAt": "2020-05-09T12:29:34Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxMjoyOTozNFrOGS6vig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxMjozMDowOFrOGS6vxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4OTk5NA==", "bodyText": "please capture some motivation how we ended up with a modest number as a comment", "url": "https://github.com/trinodb/trino/pull/3512#discussion_r422489994", "createdAt": "2020-05-09T12:29:34Z", "author": {"login": "findepi"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/CountQueryPageSource.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.elasticsearch;\n+\n+import io.prestosql.elasticsearch.client.ElasticsearchClient;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.connector.ConnectorPageSource;\n+import io.prestosql.spi.connector.ConnectorSession;\n+\n+import static io.prestosql.elasticsearch.ElasticsearchQueryBuilder.buildSearchQuery;\n+import static java.util.Objects.requireNonNull;\n+\n+class CountQueryPageSource\n+        implements ConnectorPageSource\n+{\n+    private static final int BATCH_SIZE = 10000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ5MDA1Mw==", "bodyText": "readTime -> readTimeNanos\n(btw we have readTimeNanos in ScanQueryPageSource)", "url": "https://github.com/trinodb/trino/pull/3512#discussion_r422490053", "createdAt": "2020-05-09T12:30:08Z", "author": {"login": "findepi"}, "path": "presto-elasticsearch/src/main/java/io/prestosql/elasticsearch/CountQueryPageSource.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.elasticsearch;\n+\n+import io.prestosql.elasticsearch.client.ElasticsearchClient;\n+import io.prestosql.spi.Page;\n+import io.prestosql.spi.connector.ConnectorPageSource;\n+import io.prestosql.spi.connector.ConnectorSession;\n+\n+import static io.prestosql.elasticsearch.ElasticsearchQueryBuilder.buildSearchQuery;\n+import static java.util.Objects.requireNonNull;\n+\n+class CountQueryPageSource\n+        implements ConnectorPageSource\n+{\n+    private static final int BATCH_SIZE = 10000;\n+\n+    private final long readTime;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a675a93e6b5da4624be08068f32da70d1aaa7ea", "author": {"user": {"login": "martint", "name": "Martin Traverso"}}, "url": "https://github.com/trinodb/trino/commit/8a675a93e6b5da4624be08068f32da70d1aaa7ea", "committedDate": "2020-05-10T16:47:59Z", "message": "Optimize Elasticsearch queries that fetch no columns\n\nIn that case, the connector only needs to produce pages with\na row count. We leverage Elasticsearch's count API."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "8a675a93e6b5da4624be08068f32da70d1aaa7ea", "author": {"user": {"login": "martint", "name": "Martin Traverso"}}, "url": "https://github.com/trinodb/trino/commit/8a675a93e6b5da4624be08068f32da70d1aaa7ea", "committedDate": "2020-05-10T16:47:59Z", "message": "Optimize Elasticsearch queries that fetch no columns\n\nIn that case, the connector only needs to produce pages with\na row count. We leverage Elasticsearch's count API."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1616, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}