{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4ODIxNDE5", "number": 4858, "title": "Allow to restart flaky tests", "bodyText": "", "createdAt": "2020-08-17T13:09:05Z", "url": "https://github.com/trinodb/trino/pull/4858", "merged": true, "mergeCommit": {"oid": "b1bfe9e815f16b792bfb133f4aca35b62ecbe126"}, "closed": true, "closedAt": "2020-08-20T12:50:17Z", "author": {"login": "kokosing"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_yL61gFqTQ2ODQ0ODQ2OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdB_JPGAFqTQ3MzI4NzAyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NDQ4NDY5", "url": "https://github.com/trinodb/trino/pull/4858#pullrequestreview-468448469", "createdAt": "2020-08-17T13:11:35Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMzoxMTozNVrOHBoHLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMzoxMTozNVrOHBoHLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ2NzgyMg==", "bodyText": "\ud83d\ude31", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r471467822", "createdAt": "2020-08-17T13:11:35Z", "author": {"login": "kokosing"}, "path": "presto-main/pom.xml", "diffHunk": "@@ -56,6 +56,12 @@\n             <artifactId>presto-spi</artifactId>\n         </dependency>\n \n+        <dependency>\n+            <!-- transitive test dependency -->", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MTUzNzMx", "url": "https://github.com/trinodb/trino/pull/4858#pullrequestreview-469153731", "createdAt": "2020-08-18T09:30:46Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwOTozMDo0NlrOHCLXVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwOTo0MDo0MVrOHCLtvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0NTM5OQ==", "bodyText": "can we use presto-testing for this?", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472045399", "createdAt": "2020-08-18T09:30:46Z", "author": {"login": "findepi"}, "path": "pom.xml", "diffHunk": "@@ -142,6 +142,7 @@\n         <module>presto-testing</module>\n         <module>presto-testing-kafka</module>\n         <module>presto-testing-server-launcher</module>\n+        <module>presto-testng-services</module>", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0NzM5MA==", "bodyText": "typo", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472047390", "createdAt": "2020-08-18T09:34:20Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -32,29 +34,34 @@\n     @Override\n     public void onBeforeClass(ITestClass testClass)\n     {\n-        Method[] publicMethods = testClass.getRealClass().getMethods();\n-\n-        List<Method> unannotatedMethods = Arrays.stream(publicMethods)\n-                .filter(method -> method.getDeclaringClass() != Object.class)\n-                .filter(method -> !Modifier.isStatic(method.getModifiers()))\n-                .filter(method -> !method.isBridge())\n-                .filter(method -> !isTestMethod(method))\n-                .collect(toImmutableList());\n-\n-        if (!unannotatedMethods.isEmpty()) {\n+        Class<?> realClass = testClass.getRealClass();\n+        List<Method> unnatedTestMethods = findUnannotatedTestMethods(realClass);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODAwMg==", "bodyText": "equals, or is prefix", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472048002", "createdAt": "2020-08-18T09:35:19Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -92,11 +99,44 @@ private static boolean isTestAnnotated(Method method)\n                         // testng annotation (@Test, @Before*, @DataProvider, etc.)\n                         return true;\n                     }\n-                    if (\"io.prestosql.tempto\".equals(annotationClass.getPackage().getName())) {\n+                    if (isTemptoClass(annotationClass)) {\n                         // tempto annotation (@BeforeTestWithContext, @AfterTestWithContext)\n                         return true;\n                     }\n                     return false;\n                 });\n     }\n+\n+    private static boolean isSpiMethod(Method method)\n+    {\n+        return Stream.of(method.getDeclaringClass().getInterfaces())\n+                .filter(ReportUnannotatedMethods::isTemptoClass)\n+                .map(Class::getMethods)\n+                .flatMap(Stream::of)\n+                .anyMatch(actualMethod -> hasSameNameAndParameters(method, actualMethod));\n+    }\n+\n+    private static boolean hasSameNameAndParameters(Method first, Method second)\n+    {\n+        if (!first.getName().equals(second.getName())) {\n+            return false;\n+        }\n+\n+        if (first.getParameterTypes().length != second.getParameterTypes().length) {\n+            return false;\n+        }\n+\n+        for (int i = 0; i < first.getParameterTypes().length; i++) {\n+            if (!first.getParameterTypes()[i].getName().equals(second.getParameterTypes()[i].getName())) {\n+                return false;\n+            }\n+        }\n+\n+        return true;\n+    }\n+\n+    private static boolean isTemptoClass(Class<?> aClass)\n+    {\n+        return \"io.prestosql.tempto\".equals(aClass.getPackage().getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODQ2Ng==", "bodyText": "is this kind of quadratic?", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472048466", "createdAt": "2020-08-18T09:36:03Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -32,29 +34,34 @@\n     @Override\n     public void onBeforeClass(ITestClass testClass)\n     {\n-        Method[] publicMethods = testClass.getRealClass().getMethods();\n-\n-        List<Method> unannotatedMethods = Arrays.stream(publicMethods)\n-                .filter(method -> method.getDeclaringClass() != Object.class)\n-                .filter(method -> !Modifier.isStatic(method.getModifiers()))\n-                .filter(method -> !method.isBridge())\n-                .filter(method -> !isTestMethod(method))\n-                .collect(toImmutableList());\n-\n-        if (!unannotatedMethods.isEmpty()) {\n+        Class<?> realClass = testClass.getRealClass();\n+        List<Method> unnatedTestMethods = findUnannotatedTestMethods(realClass);\n+        if (!unnatedTestMethods.isEmpty()) {\n             // TestNG may or may not propagate listener's exception as test execution exception.\n             // Therefore, instead of throwing, we terminate the JVM.\n             System.err.println(format(\n                     \"FATAL: Test class %s has methods which are public but not explicitly annotated. Are they missing @Test?%s\",\n-                    testClass.getRealClass().getName(),\n-                    unannotatedMethods.stream()\n+                    realClass.getName(),\n+                    unnatedTestMethods.stream()\n                             .map(Method::toString)\n                             .collect(joining(\"\\n\\t\\t\", \"\\n\\t\\t\", \"\"))));\n             System.err.println(\"JVM will be terminated\");\n             System.exit(1);\n         }\n     }\n \n+    @VisibleForTesting\n+    static List<Method> findUnannotatedTestMethods(Class<?> realClass)\n+    {\n+        return Arrays.stream(realClass.getMethods())\n+                .filter(method -> method.getDeclaringClass() != Object.class)\n+                .filter(method -> !Modifier.isStatic(method.getModifiers()))\n+                .filter(method -> !method.isBridge())\n+                .filter(method -> !isTestMethod(method))\n+                .filter(method -> !isSpiMethod(method))", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODUzOQ==", "bodyText": "spi -> temptoSpi", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472048539", "createdAt": "2020-08-18T09:36:11Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -92,11 +99,44 @@ private static boolean isTestAnnotated(Method method)\n                         // testng annotation (@Test, @Before*, @DataProvider, etc.)\n                         return true;\n                     }\n-                    if (\"io.prestosql.tempto\".equals(annotationClass.getPackage().getName())) {\n+                    if (isTemptoClass(annotationClass)) {\n                         // tempto annotation (@BeforeTestWithContext, @AfterTestWithContext)\n                         return true;\n                     }\n                     return false;\n                 });\n     }\n+\n+    private static boolean isSpiMethod(Method method)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODcxMg==", "bodyText": "hasSameNameAndParameters -> overrides ?", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472048712", "createdAt": "2020-08-18T09:36:30Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -92,11 +99,44 @@ private static boolean isTestAnnotated(Method method)\n                         // testng annotation (@Test, @Before*, @DataProvider, etc.)\n                         return true;\n                     }\n-                    if (\"io.prestosql.tempto\".equals(annotationClass.getPackage().getName())) {\n+                    if (isTemptoClass(annotationClass)) {\n                         // tempto annotation (@BeforeTestWithContext, @AfterTestWithContext)\n                         return true;\n                     }\n                     return false;\n                 });\n     }\n+\n+    private static boolean isSpiMethod(Method method)\n+    {\n+        return Stream.of(method.getDeclaringClass().getInterfaces())\n+                .filter(ReportUnannotatedMethods::isTemptoClass)\n+                .map(Class::getMethods)\n+                .flatMap(Stream::of)\n+                .anyMatch(actualMethod -> hasSameNameAndParameters(method, actualMethod));\n+    }\n+\n+    private static boolean hasSameNameAndParameters(Method first, Method second)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0OTQyNw==", "bodyText": "Can we apply FlakyTestRetryAnalyzer twice, on class and method level?\nwhat does it do on the class level?", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472049427", "createdAt": "2020-08-18T09:37:39Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/RetryAnnotationTransformer.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import io.airlift.log.Logger;\n+import org.testng.IAnnotationTransformer;\n+import org.testng.annotations.ITestAnnotation;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.Method;\n+\n+public class RetryAnnotationTransformer\n+        implements IAnnotationTransformer\n+{\n+    private static final Logger log = Logger.get(RetryAnnotationTransformer.class);\n+\n+    @Override\n+    public void transform(ITestAnnotation annotation, Class testClass, Constructor testConstructor, Method testMethod)\n+    {\n+        if (testClass != null) {\n+            log.debug(\"Instrumenting class %s with %s.\", testClass.getSimpleName(), FlakyTestRetryAnalyzer.class.getSimpleName());\n+            annotation.setRetryAnalyzer(FlakyTestRetryAnalyzer.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1MDEwMQ==", "bodyText": "Does this work for parameterized methods (dataprovider)?\nmaybe we could explicitly detect & reject this?", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472050101", "createdAt": "2020-08-18T09:38:48Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/FlakyTestRetryAnalyzer.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import io.airlift.log.Logger;\n+import org.testng.IRetryAnalyzer;\n+import org.testng.ITestNGMethod;\n+import org.testng.ITestResult;\n+\n+import javax.annotation.concurrent.GuardedBy;\n+\n+import java.lang.reflect.Method;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.lang.String.format;\n+\n+public class FlakyTestRetryAnalyzer\n+        implements IRetryAnalyzer\n+{\n+    private static final Logger log = Logger.get(FlakyTestRetryAnalyzer.class);\n+\n+    public static final int ALLOWED_RETRIES_COUNT = 2;\n+\n+    @GuardedBy(\"this\")\n+    private final Map<String, Long> retryCounter = new HashMap<>();\n+\n+    @Override\n+    public boolean retry(ITestResult result)\n+    {\n+        if (!isTestRetryable(result)) {\n+            return false;\n+        }\n+        long retryCount;\n+        synchronized (this) {\n+            String name = getName(result.getMethod());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1MDM3Ng==", "bodyText": "Add a comment whether the class name is defining class (eg abstract base), or actual class (the test class)", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472050376", "createdAt": "2020-08-18T09:39:17Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/FlakyTestRetryAnalyzer.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import io.airlift.log.Logger;\n+import org.testng.IRetryAnalyzer;\n+import org.testng.ITestNGMethod;\n+import org.testng.ITestResult;\n+\n+import javax.annotation.concurrent.GuardedBy;\n+\n+import java.lang.reflect.Method;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.lang.String.format;\n+\n+public class FlakyTestRetryAnalyzer\n+        implements IRetryAnalyzer\n+{\n+    private static final Logger log = Logger.get(FlakyTestRetryAnalyzer.class);\n+\n+    public static final int ALLOWED_RETRIES_COUNT = 2;\n+\n+    @GuardedBy(\"this\")\n+    private final Map<String, Long> retryCounter = new HashMap<>();\n+\n+    @Override\n+    public boolean retry(ITestResult result)\n+    {\n+        if (!isTestRetryable(result)) {\n+            return false;\n+        }\n+        long retryCount;\n+        synchronized (this) {\n+            String name = getName(result.getMethod());\n+            retryCount = retryCounter.getOrDefault(name, 0L);\n+            retryCount++;\n+            if (retryCount > ALLOWED_RETRIES_COUNT) {\n+                return false;\n+            }\n+            retryCounter.put(name, retryCount);\n+        }\n+        log.warn(\n+                result.getThrowable(),\n+                \"Test %s::%s attempt %s failed, retrying...,\",\n+                result.getTestClass().getName(),\n+                result.getMethod().getMethodName(),\n+                retryCount);\n+        return true;\n+    }\n+\n+    private static boolean isTestRetryable(ITestResult result)\n+    {\n+        Method method = result.getMethod().getConstructorOrMethod().getMethod();\n+        if (method == null) {\n+            return false;\n+        }\n+        return method.getAnnotation(Flaky.class) != null;\n+    }\n+\n+    public static String getName(ITestNGMethod method)\n+    {\n+        return format(\"%s::%s\", method.getTestClass().getName(), method.getMethodName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1MTEzNQ==", "bodyText": "I'd (ab)use @Deprecated here\n/**\n * @deprecated Use of this is strongly discouraged\n */\n@Deprecated\n\nso that every use of this annotation visually stands out and calls for a fix", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472051135", "createdAt": "2020-08-18T09:40:41Z", "author": {"login": "findepi"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/Flaky.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.Target;\n+\n+import static java.lang.annotation.ElementType.METHOD;\n+import static java.lang.annotation.RetentionPolicy.RUNTIME;\n+\n+@Retention(RUNTIME)\n+@Target(METHOD)\n+public @interface Flaky", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MzU0MDc4", "url": "https://github.com/trinodb/trino/pull/4858#pullrequestreview-469354078", "createdAt": "2020-08-18T12:08:22Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5Mzc1NzU5", "url": "https://github.com/trinodb/trino/pull/4858#pullrequestreview-469375759", "createdAt": "2020-08-18T12:18:37Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxMjoxODozN1rOHCQwvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxMjo0NToxNVrOHCR9SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEzMzgyMw==", "bodyText": "Maybe I could use some caching here to not verify same methods multiple times, but I don't think it is a real problem here anyway.", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472133823", "createdAt": "2020-08-18T12:18:37Z", "author": {"login": "kokosing"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -32,29 +34,34 @@\n     @Override\n     public void onBeforeClass(ITestClass testClass)\n     {\n-        Method[] publicMethods = testClass.getRealClass().getMethods();\n-\n-        List<Method> unannotatedMethods = Arrays.stream(publicMethods)\n-                .filter(method -> method.getDeclaringClass() != Object.class)\n-                .filter(method -> !Modifier.isStatic(method.getModifiers()))\n-                .filter(method -> !method.isBridge())\n-                .filter(method -> !isTestMethod(method))\n-                .collect(toImmutableList());\n-\n-        if (!unannotatedMethods.isEmpty()) {\n+        Class<?> realClass = testClass.getRealClass();\n+        List<Method> unnatedTestMethods = findUnannotatedTestMethods(realClass);\n+        if (!unnatedTestMethods.isEmpty()) {\n             // TestNG may or may not propagate listener's exception as test execution exception.\n             // Therefore, instead of throwing, we terminate the JVM.\n             System.err.println(format(\n                     \"FATAL: Test class %s has methods which are public but not explicitly annotated. Are they missing @Test?%s\",\n-                    testClass.getRealClass().getName(),\n-                    unannotatedMethods.stream()\n+                    realClass.getName(),\n+                    unnatedTestMethods.stream()\n                             .map(Method::toString)\n                             .collect(joining(\"\\n\\t\\t\", \"\\n\\t\\t\", \"\"))));\n             System.err.println(\"JVM will be terminated\");\n             System.exit(1);\n         }\n     }\n \n+    @VisibleForTesting\n+    static List<Method> findUnannotatedTestMethods(Class<?> realClass)\n+    {\n+        return Arrays.stream(realClass.getMethods())\n+                .filter(method -> method.getDeclaringClass() != Object.class)\n+                .filter(method -> !Modifier.isStatic(method.getModifiers()))\n+                .filter(method -> !method.isBridge())\n+                .filter(method -> !isTestMethod(method))\n+                .filter(method -> !isSpiMethod(method))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODQ2Ng=="}, "originalCommit": null, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEzNjQ5OQ==", "bodyText": "I think all tempto spi is in this package.", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472136499", "createdAt": "2020-08-18T12:23:23Z", "author": {"login": "kokosing"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/ReportUnannotatedMethods.java", "diffHunk": "@@ -92,11 +99,44 @@ private static boolean isTestAnnotated(Method method)\n                         // testng annotation (@Test, @Before*, @DataProvider, etc.)\n                         return true;\n                     }\n-                    if (\"io.prestosql.tempto\".equals(annotationClass.getPackage().getName())) {\n+                    if (isTemptoClass(annotationClass)) {\n                         // tempto annotation (@BeforeTestWithContext, @AfterTestWithContext)\n                         return true;\n                     }\n                     return false;\n                 });\n     }\n+\n+    private static boolean isSpiMethod(Method method)\n+    {\n+        return Stream.of(method.getDeclaringClass().getInterfaces())\n+                .filter(ReportUnannotatedMethods::isTemptoClass)\n+                .map(Class::getMethods)\n+                .flatMap(Stream::of)\n+                .anyMatch(actualMethod -> hasSameNameAndParameters(method, actualMethod));\n+    }\n+\n+    private static boolean hasSameNameAndParameters(Method first, Method second)\n+    {\n+        if (!first.getName().equals(second.getName())) {\n+            return false;\n+        }\n+\n+        if (first.getParameterTypes().length != second.getParameterTypes().length) {\n+            return false;\n+        }\n+\n+        for (int i = 0; i < first.getParameterTypes().length; i++) {\n+            if (!first.getParameterTypes()[i].getName().equals(second.getParameterTypes()[i].getName())) {\n+                return false;\n+            }\n+        }\n+\n+        return true;\n+    }\n+\n+    private static boolean isTemptoClass(Class<?> aClass)\n+    {\n+        return \"io.prestosql.tempto\".equals(aClass.getPackage().getName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODAwMg=="}, "originalCommit": null, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE1MzQxNg==", "bodyText": "Can we apply FlakyTestRetryAnalyzer twice, on class and method level?\n\nWe already did that.\n\nwhat does it do on the class level?\n\nI guess it might want to enable retrying for test methods? (However I know that testng is ready to surprise me here) Anyway @Flaky can be only set for methods so I removed instrumenting class.", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472153416", "createdAt": "2020-08-18T12:45:15Z", "author": {"login": "kokosing"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/RetryAnnotationTransformer.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import io.airlift.log.Logger;\n+import org.testng.IAnnotationTransformer;\n+import org.testng.annotations.ITestAnnotation;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.Method;\n+\n+public class RetryAnnotationTransformer\n+        implements IAnnotationTransformer\n+{\n+    private static final Logger log = Logger.get(RetryAnnotationTransformer.class);\n+\n+    @Override\n+    public void transform(ITestAnnotation annotation, Class testClass, Constructor testConstructor, Method testMethod)\n+    {\n+        if (testClass != null) {\n+            log.debug(\"Instrumenting class %s with %s.\", testClass.getSimpleName(), FlakyTestRetryAnalyzer.class.getSimpleName());\n+            annotation.setRetryAnalyzer(FlakyTestRetryAnalyzer.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0OTQyNw=="}, "originalCommit": null, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODI2NzMw", "url": "https://github.com/trinodb/trino/pull/4858#pullrequestreview-469826730", "createdAt": "2020-08-18T20:59:28Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDo1OToyOVrOHCmfDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMToyNDowNlrOHCnNCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4OTc0MA==", "bodyText": "It's unsupported, isn't it?", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472489740", "createdAt": "2020-08-18T20:59:29Z", "author": {"login": "lukasz-walkiewicz"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveStorageFormats.java", "diffHunk": "@@ -157,6 +158,7 @@ public void testCreateTableAs(StorageFormat storageFormat)\n     }\n \n     @Test(dataProvider = \"storage_formats\", groups = STORAGE_FORMATS)\n+    @Flaky(issue = \"https://github.com/prestosql/presto/issues/2390\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5MzcxOQ==", "bodyText": "I would prefer having public methods before private ones. You can see what class can do pretty easily without going into implementation details. No change requested.", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472493719", "createdAt": "2020-08-18T21:07:49Z", "author": {"login": "lukasz-walkiewicz"}, "path": "presto-testng-services/src/main/java/io/prestosql/testng/services/FlakyTestRetryAnalyzer.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import io.airlift.log.Logger;\n+import org.testng.IRetryAnalyzer;\n+import org.testng.ITestNGMethod;\n+import org.testng.ITestResult;\n+\n+import javax.annotation.concurrent.GuardedBy;\n+\n+import java.lang.reflect.Method;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.lang.String.format;\n+\n+public class FlakyTestRetryAnalyzer\n+        implements IRetryAnalyzer\n+{\n+    private static final Logger log = Logger.get(FlakyTestRetryAnalyzer.class);\n+\n+    public static final int ALLOWED_RETRIES_COUNT = 2;\n+\n+    @GuardedBy(\"this\")\n+    private final Map<String, Long> retryCounter = new HashMap<>();\n+\n+    @Override\n+    public boolean retry(ITestResult result)\n+    {\n+        if (!isTestRetryable(result)) {\n+            return false;\n+        }\n+        long retryCount;\n+        ITestNGMethod method = result.getMethod();\n+        synchronized (this) {\n+            String name = getName(method);\n+            retryCount = retryCounter.getOrDefault(name, 0L);\n+            retryCount++;\n+            if (retryCount > ALLOWED_RETRIES_COUNT) {\n+                return false;\n+            }\n+            retryCounter.put(name, retryCount);\n+        }\n+        log.warn(\n+                result.getThrowable(),\n+                \"Test %s::%s attempt %s failed, retrying...,\",\n+                result.getTestClass().getName(),\n+                method.getMethodName(),\n+                retryCount);\n+        return true;\n+    }\n+\n+    private static boolean isTestRetryable(ITestResult result)\n+    {\n+        Method method = result.getMethod().getConstructorOrMethod().getMethod();\n+        if (method == null) {\n+            return false;\n+        }\n+        if (method.getParameterTypes().length != 0) {\n+            throw new UnsupportedOperationException(\"@Flaky annotation is not yet supported for parametric tests\");\n+        }\n+        return method.getAnnotation(Flaky.class) != null;\n+    }\n+\n+    public static String getName(ITestNGMethod method)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5OTM5Nw==", "bodyText": "I suspect it's hard to write this kind of test but there's no check for the maximum retries count, ie. you do not check what's going to happen when the test fails 3 times.", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472499397", "createdAt": "2020-08-18T21:19:34Z", "author": {"login": "lukasz-walkiewicz"}, "path": "presto-testng-services/src/test/java/io/prestosql/testng/services/TestFlakyTestRetryAnalyzer.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.testng.services.FlakyTestRetryAnalyzer.ALLOWED_RETRIES_COUNT;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.fail;\n+\n+@Test(singleThreaded = true)\n+public class TestFlakyTestRetryAnalyzer", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwMDIwMw==", "bodyText": "Yeah... not the best name.", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472500203", "createdAt": "2020-08-18T21:21:14Z", "author": {"login": "lukasz-walkiewicz"}, "path": "presto-testng-services/src/test/java/io/prestosql/testng/services/TestReportUnannotatedMethods.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import io.prestosql.tempto.Requirement;\n+import io.prestosql.tempto.Requirements;\n+import io.prestosql.tempto.RequirementsProvider;\n+import io.prestosql.tempto.configuration.Configuration;\n+import org.testng.annotations.Test;\n+\n+import java.lang.reflect.Method;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestReportUnannotatedMethods\n+{\n+    private final ReportUnannotatedMethods instance = new ReportUnannotatedMethods();\n+\n+    @Test\n+    public void testTest()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwMTUxMw==", "bodyText": "Actually, the whole class could use less \"test*\" words.", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r472501513", "createdAt": "2020-08-18T21:24:06Z", "author": {"login": "lukasz-walkiewicz"}, "path": "presto-testng-services/src/test/java/io/prestosql/testng/services/TestReportUnannotatedMethods.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.testng.services;\n+\n+import io.prestosql.tempto.Requirement;\n+import io.prestosql.tempto.Requirements;\n+import io.prestosql.tempto.RequirementsProvider;\n+import io.prestosql.tempto.configuration.Configuration;\n+import org.testng.annotations.Test;\n+\n+import java.lang.reflect.Method;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class TestReportUnannotatedMethods\n+{\n+    private final ReportUnannotatedMethods instance = new ReportUnannotatedMethods();\n+\n+    @Test\n+    public void testTest()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwMDIwMw=="}, "originalCommit": null, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "59c9e0eb809773fb65be38736795c7c4854f2216", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/59c9e0eb809773fb65be38736795c7c4854f2216", "committedDate": "2020-08-19T19:53:48Z", "message": "Limit the method visibility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3010f308835b9402f0d320afb8c60198d23a2859", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/3010f308835b9402f0d320afb8c60198d23a2859", "committedDate": "2020-08-19T19:53:48Z", "message": "Extract presto-testng-services module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00eec020c5785fcf9f3b59336bf882dd715fadb8", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/00eec020c5785fcf9f3b59336bf882dd715fadb8", "committedDate": "2020-08-19T19:53:48Z", "message": "Do not report tempto methods as missing @Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f90150534b58f7134fc5c95cebeb66b2d42525f", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/1f90150534b58f7134fc5c95cebeb66b2d42525f", "committedDate": "2020-08-19T19:53:48Z", "message": "Do not verify tempto convention test class names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7fc106898977fc448eaa0c8798b2a476a907936", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/e7fc106898977fc448eaa0c8798b2a476a907936", "committedDate": "2020-08-19T19:53:48Z", "message": "Introduce testng FlakyTestRetryAnalyzer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33d6683e702a1cd76217d16e28f7930c165c8582", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/33d6683e702a1cd76217d16e28f7930c165c8582", "committedDate": "2020-08-19T19:53:48Z", "message": "Mark flaky Hive product tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "33d6683e702a1cd76217d16e28f7930c165c8582", "author": {"user": {"login": "kokosing", "name": "Grzegorz Kokosi\u0144ski"}}, "url": "https://github.com/trinodb/trino/commit/33d6683e702a1cd76217d16e28f7930c165c8582", "committedDate": "2020-08-19T19:53:48Z", "message": "Mark flaky Hive product tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjg3MDIw", "url": "https://github.com/trinodb/trino/pull/4858#pullrequestreview-473287020", "createdAt": "2020-08-24T09:25:16Z", "commit": {"oid": "33d6683e702a1cd76217d16e28f7930c165c8582"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwOToyNToxNlrOHFbwzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwOToyNToxNlrOHFbwzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1OTc4OQ==", "bodyText": "FYI A different test method is tagged than originally reported n #4927\nwill follow-up", "url": "https://github.com/trinodb/trino/pull/4858#discussion_r475459789", "createdAt": "2020-08-24T09:25:16Z", "author": {"login": "findepi"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestHiveTransactionalTable.java", "diffHunk": "@@ -86,6 +87,7 @@ public void testReadFullAcidPartitionedBucketed()\n     }\n \n     @Test(groups = HIVE_TRANSACTIONAL, timeOut = TEST_TIMEOUT)\n+    @Flaky(issue = \"https://github.com/prestosql/presto/issues/4857\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33d6683e702a1cd76217d16e28f7930c165c8582"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4410, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}