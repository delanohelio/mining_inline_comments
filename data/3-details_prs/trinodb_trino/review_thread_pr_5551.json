{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzMTk1MjI4", "number": 5551, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwODo0NzowMlrOEtYZWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwODo0NzowMlrOEtYZWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MDIxMDgzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/execution/buffer/LazyOutputBuffer.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwODo0NzowMlrOHhItGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMjo1ODoyMlrOHhRsvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNzY3Mw==", "bodyText": "is it better that we have it as max(sink.max-buffer-size, sink.max-broadcast-buffer-size)? and mention that in the documentation? so that if someone wants to bump the generic buffer size, the broadcast buffer also gets bumped up automatically.", "url": "https://github.com/trinodb/trino/pull/5551#discussion_r504507673", "createdAt": "2020-10-14T08:47:02Z", "author": {"login": "rohangarg"}, "path": "presto-main/src/main/java/io/prestosql/execution/buffer/LazyOutputBuffer.java", "diffHunk": "@@ -164,7 +167,7 @@ public void setOutputBuffers(OutputBuffers newOutputBuffers)\n                         delegate = new PartitionedOutputBuffer(taskInstanceId, state, newOutputBuffers, maxBufferSize, systemMemoryContextSupplier, executor);\n                         break;\n                     case BROADCAST:\n-                        delegate = new BroadcastOutputBuffer(taskInstanceId, state, maxBufferSize, systemMemoryContextSupplier, executor, notifyStatusChanged);\n+                        delegate = new BroadcastOutputBuffer(taskInstanceId, state, maxBroadcastBufferSize, systemMemoryContextSupplier, executor, notifyStatusChanged);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "670c7e4e036c61814f41e31ffc329627ee13b669"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2NzMzNQ==", "bodyText": "I don't think it's needed to use max between the two. The reason is that amount of data in broadcast buffer should already be capped with CBO (e.g why to increase it above 200MB if CBO broadcast limit is still 100MB?). Additionally, using max would add some extra logic here (instead of simple toggle).\n\nmention that in the documentation?\n\ndocumentation will be in follow-up PR.", "url": "https://github.com/trinodb/trino/pull/5551#discussion_r504567335", "createdAt": "2020-10-14T10:22:57Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/buffer/LazyOutputBuffer.java", "diffHunk": "@@ -164,7 +167,7 @@ public void setOutputBuffers(OutputBuffers newOutputBuffers)\n                         delegate = new PartitionedOutputBuffer(taskInstanceId, state, newOutputBuffers, maxBufferSize, systemMemoryContextSupplier, executor);\n                         break;\n                     case BROADCAST:\n-                        delegate = new BroadcastOutputBuffer(taskInstanceId, state, maxBufferSize, systemMemoryContextSupplier, executor, notifyStatusChanged);\n+                        delegate = new BroadcastOutputBuffer(taskInstanceId, state, maxBroadcastBufferSize, systemMemoryContextSupplier, executor, notifyStatusChanged);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNzY3Mw=="}, "originalCommit": {"oid": "670c7e4e036c61814f41e31ffc329627ee13b669"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDYwMjY1Mw==", "bodyText": "I don't think it's needed to use max between the two. The reason is that amount of data in broadcast buffer should already be capped with CBO (e.g why to increase it above 200MB if CBO broadcast limit is still 100MB?). Additionally, using max would add some extra logic here (instead of simple toggle).\n\nYes, that's right for the default case with CBO. What if someone is tuning the sink.max-buffer-size config? Ideally wouldn't we want the broadcast buffer to be atleast as much as normal buffer? (probably by just having an assertion that the max-broadcast-buffer >= max-buffer, but that could break the server start with existing configs). I am ok if you think that the documentation can cover these things.", "url": "https://github.com/trinodb/trino/pull/5551#discussion_r504602653", "createdAt": "2020-10-14T11:29:21Z", "author": {"login": "rohangarg"}, "path": "presto-main/src/main/java/io/prestosql/execution/buffer/LazyOutputBuffer.java", "diffHunk": "@@ -164,7 +167,7 @@ public void setOutputBuffers(OutputBuffers newOutputBuffers)\n                         delegate = new PartitionedOutputBuffer(taskInstanceId, state, newOutputBuffers, maxBufferSize, systemMemoryContextSupplier, executor);\n                         break;\n                     case BROADCAST:\n-                        delegate = new BroadcastOutputBuffer(taskInstanceId, state, maxBufferSize, systemMemoryContextSupplier, executor, notifyStatusChanged);\n+                        delegate = new BroadcastOutputBuffer(taskInstanceId, state, maxBroadcastBufferSize, systemMemoryContextSupplier, executor, notifyStatusChanged);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNzY3Mw=="}, "originalCommit": {"oid": "670c7e4e036c61814f41e31ffc329627ee13b669"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDYzMDEyNg==", "bodyText": "Ideally wouldn't we want the broadcast buffer to be atleast as much as normal buffer?\n\nIn case of non-broadcast buffer it is important to ensure seamless flow of data without buffer trashing. Non-broadcast exchanges can transmit TBs of data.\nIn case of broadcast buffer it's more about storage of data so that build side tasks can start flushing. Broadcasted data would normally be tiny compared to hash-exchanged data.\n\nIdeally wouldn't we want the broadcast buffer to be atleast as much as normal buffer?\n\nI would consider 200MB a big buffer already. I doubt 200MB would be that beneficial for hash exchange (considering 32MB is sufficient in most of cases). IMO having 200MB buffer for hash exchange would mostly introduce additional memory overhead (in case probe side is \"slow\" to fetch data)", "url": "https://github.com/trinodb/trino/pull/5551#discussion_r504630126", "createdAt": "2020-10-14T12:19:41Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/execution/buffer/LazyOutputBuffer.java", "diffHunk": "@@ -164,7 +167,7 @@ public void setOutputBuffers(OutputBuffers newOutputBuffers)\n                         delegate = new PartitionedOutputBuffer(taskInstanceId, state, newOutputBuffers, maxBufferSize, systemMemoryContextSupplier, executor);\n                         break;\n                     case BROADCAST:\n-                        delegate = new BroadcastOutputBuffer(taskInstanceId, state, maxBufferSize, systemMemoryContextSupplier, executor, notifyStatusChanged);\n+                        delegate = new BroadcastOutputBuffer(taskInstanceId, state, maxBroadcastBufferSize, systemMemoryContextSupplier, executor, notifyStatusChanged);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNzY3Mw=="}, "originalCommit": {"oid": "670c7e4e036c61814f41e31ffc329627ee13b669"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY1NTAzOA==", "bodyText": "Broadcasted data would normally be tiny compared to hash-exchanged data.\nI would consider 200MB a big buffer already. I doubt 200MB would be that beneficial for hash exchange (considering 32MB is sufficient in most of cases).\n\nYes, that's true.", "url": "https://github.com/trinodb/trino/pull/5551#discussion_r504655038", "createdAt": "2020-10-14T12:58:22Z", "author": {"login": "rohangarg"}, "path": "presto-main/src/main/java/io/prestosql/execution/buffer/LazyOutputBuffer.java", "diffHunk": "@@ -164,7 +167,7 @@ public void setOutputBuffers(OutputBuffers newOutputBuffers)\n                         delegate = new PartitionedOutputBuffer(taskInstanceId, state, newOutputBuffers, maxBufferSize, systemMemoryContextSupplier, executor);\n                         break;\n                     case BROADCAST:\n-                        delegate = new BroadcastOutputBuffer(taskInstanceId, state, maxBufferSize, systemMemoryContextSupplier, executor, notifyStatusChanged);\n+                        delegate = new BroadcastOutputBuffer(taskInstanceId, state, maxBroadcastBufferSize, systemMemoryContextSupplier, executor, notifyStatusChanged);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNzY3Mw=="}, "originalCommit": {"oid": "670c7e4e036c61814f41e31ffc329627ee13b669"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4708, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}