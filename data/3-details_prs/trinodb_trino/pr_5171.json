{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3MzU5ODA5", "number": 5171, "title": "Recreate network on environment startup try", "bodyText": "", "createdAt": "2020-09-15T14:59:45Z", "url": "https://github.com/trinodb/trino/pull/5171", "merged": true, "mergeCommit": {"oid": "9ccc78fbb2f491a97629ee4373bbc3685377e5c2"}, "closed": true, "closedAt": "2020-09-17T11:28:24Z", "author": {"login": "wendigo"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJJLz6AFqTQ4ODc4MDg2MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJs5NiAH2gAyNDg3MzU5ODA5OjExOGNjZWM3NWVlYTc4MTYzZTcxMDllYzZjM2I4NjlmODg0MjA0YTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NzgwODYw", "url": "https://github.com/trinodb/trino/pull/5171#pullrequestreview-488780860", "createdAt": "2020-09-15T15:03:10Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTowMzoxMFrOHSGXNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTowMzoxMFrOHSGXNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0MDY2Mw==", "bodyText": "i often use the fact that the containers have fixed, easy name\nsee #4834 (comment)", "url": "https://github.com/trinodb/trino/pull/5171#discussion_r488740663", "createdAt": "2020-09-15T15:03:10Z", "author": {"login": "findepi"}, "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environments.java", "diffHunk": "@@ -109,4 +158,45 @@ public static String nameForConfigClass(Class<? extends EnvironmentConfig> clazz\n     {\n         return CaseFormat.UPPER_CAMEL.to(CaseFormat.LOWER_HYPHEN, clazz.getSimpleName());\n     }\n+\n+    public static String networkName(String environmentName)\n+    {\n+        return format(\"%s.%s\", environmentName, PRODUCT_TEST_ENVIRONMENT);\n+    }\n+\n+    public static String containerId(String environmentName, String containerName)\n+    {\n+        return format(\"%s-%s\", environmentName, containerName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 136}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NDc2MDI4", "url": "https://github.com/trinodb/trino/pull/5171#pullrequestreview-489476028", "createdAt": "2020-09-16T10:11:51Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDoxMTo1MVrOHSp8OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDoxMTo1MVrOHSp8OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMyMzU3Ng==", "bodyText": "nit: constant?", "url": "https://github.com/trinodb/trino/pull/5171#discussion_r489323576", "createdAt": "2020-09-16T10:11:51Z", "author": {"login": "losipiuk"}, "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/Environment.java", "diffHunk": "@@ -195,20 +197,30 @@ public void close()\n         stop();\n     }\n \n-    public static class Builder\n+    private static void attachNetwork(Collection<DockerContainer> values, Network network)\n     {\n-        private final String name;\n-        private DockerContainer.OutputMode outputMode;\n-        private int startupRetries = 1;\n+        values.forEach(container -> container.withNetwork(network));\n+    }\n \n-        @SuppressWarnings(\"resource\")\n-        private Network network = Network.builder()\n+    private static Network createNetwork(String environmentName)\n+    {\n+        Network network = Network.builder()\n                 .createNetworkCmdModifier(createNetworkCmd ->\n                         createNetworkCmd\n                                 .withName(PRODUCT_TEST_LAUNCHER_NETWORK)\n-                                .withLabels(ImmutableMap.of(PRODUCT_TEST_LAUNCHER_STARTED_LABEL_NAME, PRODUCT_TEST_LAUNCHER_STARTED_LABEL_VALUE)))\n+                                .withLabels(ImmutableMap.of(\n+                                        PRODUCT_TEST_LAUNCHER_STARTED_LABEL_NAME, PRODUCT_TEST_LAUNCHER_STARTED_LABEL_VALUE,\n+                                        \"ptl.environment.name\", environmentName)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5ODcwOTk5", "url": "https://github.com/trinodb/trino/pull/5171#pullrequestreview-489870999", "createdAt": "2020-09-16T18:03:04Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxODowMzowNFrOHS8Pgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxODowMzowNFrOHS8Pgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYyMzQyNw==", "bodyText": "Shouldn't we warn also in case when Optional is empty?", "url": "https://github.com/trinodb/trino/pull/5171#discussion_r489623427", "createdAt": "2020-09-16T18:03:04Z", "author": {"login": "losipiuk"}, "path": "presto-product-tests-launcher/src/main/java/io/prestosql/tests/product/launcher/env/EnvironmentListener.java", "diffHunk": "@@ -188,12 +188,14 @@ static EnvironmentListener statsPrintingListener()\n             @Override\n             public void containerStopping(DockerContainer container, InspectContainerResponse response)\n             {\n-                try {\n-                    log.info(\"Container %s stats: %s\", container, mapper.writeValueAsString(container.getStats()));\n-                }\n-                catch (JsonProcessingException e) {\n-                    log.warn(\"Could not display container %s stats: %s\", container, e);\n-                }\n+                container.getStats().ifPresent(statistics -> {\n+                    try {\n+                        log.info(\"Container %s stats: %s\", container, mapper.writeValueAsString(statistics));\n+                    }\n+                    catch (JsonProcessingException e) {\n+                        log.warn(\"Could not display container %s stats: %s\", container, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88883cab98bcaae78872b5c70d0b21c679f8c9ad", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/88883cab98bcaae78872b5c70d0b21c679f8c9ad", "committedDate": "2020-09-16T18:16:21Z", "message": "Create new network on environment startup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0247dc9a51bcdcd666ba9ba1bc62f596b0af915a", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/0247dc9a51bcdcd666ba9ba1bc62f596b0af915a", "committedDate": "2020-09-16T18:16:21Z", "message": "Fix starting multinode environment without presto"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2affe8d9999ceedafd03e53d2804c519a4761ec", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/b2affe8d9999ceedafd03e53d2804c519a4761ec", "committedDate": "2020-09-16T18:16:21Z", "message": "Remove unused constant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec8a3900ec5c27154cd70df7de38a25593f0cf08", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/ec8a3900ec5c27154cd70df7de38a25593f0cf08", "committedDate": "2020-09-16T18:16:21Z", "message": "Make EnvironmentDown callable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a05db517e3edc4f9a398b83a551ff5ec5ffdb0d2", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/a05db517e3edc4f9a398b83a551ff5ec5ffdb0d2", "committedDate": "2020-09-16T18:18:41Z", "message": "Fix displaying stats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afa912f8eff43c2e908b16b803477d7d3f88cc2c", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/afa912f8eff43c2e908b16b803477d7d3f88cc2c", "committedDate": "2020-09-16T18:18:42Z", "message": "Intercept and log listener exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd636ad948504181bf9192230fe51373484b95b3", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/dd636ad948504181bf9192230fe51373484b95b3", "committedDate": "2020-09-16T18:18:42Z", "message": "Improve hadoop-master-2 container configuration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "dd636ad948504181bf9192230fe51373484b95b3", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/dd636ad948504181bf9192230fe51373484b95b3", "committedDate": "2020-09-16T18:18:42Z", "message": "Improve hadoop-master-2 container configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "118ccec75eea78163e7109ec6c3b869f884204a4", "author": {"user": {"login": "wendigo", "name": "Mateusz \"Serafin\" Gajewski"}}, "url": "https://github.com/trinodb/trino/commit/118ccec75eea78163e7109ec6c3b869f884204a4", "committedDate": "2020-09-17T08:40:52Z", "message": "Improve environment shutdown"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4012, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}