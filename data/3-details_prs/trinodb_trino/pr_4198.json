{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5MzMwNjAx", "number": 4198, "title": "Test missing nested array in Parquet files", "bodyText": "Nested array and map present in the metastore schema but missing in the parquet footer used to throw NPEs when the ParquetReader was getting the missing nested fields infos.\nThis got fixed by 6e272ed which enrich the schema read from the parquet footer.\nThis test is there to ensure no regression is introduced by future changes in the ParquetPageSourceFactory.\nWe have a patch to avoid the NPEs thrown by field.getChildren().get(0).get(); in Criteo's fork\n(criteo-forks@3d32603)\nthat I can get rid of thank to the work done in #3396.\nI can also submit the patch which still make sense but it would be dead code so I think just the test is enough.", "createdAt": "2020-06-24T16:55:50Z", "url": "https://github.com/trinodb/trino/pull/4198", "merged": true, "mergeCommit": {"oid": "0b38f5f0674cc07692741d21bdb6f81d8639e77a"}, "closed": true, "closedAt": "2020-07-03T11:11:52Z", "author": {"login": "rclaude"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuvNGrgFqTQzNzUyOTE4MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxQELcgFqTQ0MjI4MTcwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTI5MTgx", "url": "https://github.com/trinodb/trino/pull/4198#pullrequestreview-437529181", "createdAt": "2020-06-25T14:06:26Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDowNjoyNlrOGo8WyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDowNjoyNlrOGo8WyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU4NTA5Ng==", "bodyText": "can we verify the behavior with sessionUsingColumnName as well?\nalso, as this is a regression test, worth recording original NPE failure (can be directly in the commit message)", "url": "https://github.com/trinodb/trino/pull/4198#discussion_r445585096", "createdAt": "2020-06-25T14:06:26Z", "author": {"login": "findepi"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -4376,6 +4376,40 @@ public void testParquetWithMissingColumns()\n         assertUpdate(sessionUsingColumnIndex, \"DROP TABLE \" + multiColumnTableName);\n     }\n \n+    @Test\n+    public void testParquetWithMissingNestedColumns()\n+    {\n+        Session sessionUsingColumnIndex = Session.builder(getSession())\n+                .setCatalogSessionProperty(catalog, \"parquet_use_column_names\", \"true\")\n+                .build();\n+\n+        String missingNestedFieldsTableName = \"test_parquet_missing_nested_fields\";\n+\n+        assertUpdate(format(\n+                \"CREATE TABLE %s(\" +\n+                        \"  a ARRAY(ROW(a2 int))) \" +\n+                        \"WITH (format='PARQUET')\",\n+                missingNestedFieldsTableName));\n+        assertUpdate(sessionUsingColumnIndex, \"INSERT INTO \" + missingNestedFieldsTableName + \" VALUES (ARRAY[ROW(2)])\", 1);\n+\n+        String tableLocation = (String) computeActual(\"SELECT DISTINCT regexp_replace(\\\"$path\\\", '/[^/]*$', '') FROM \" + missingNestedFieldsTableName).getOnlyValue();\n+        String missingNestedArrayTableName = \"test_parquet_missing_nested_array\";\n+        assertUpdate(sessionUsingColumnIndex, format(\n+                \"CREATE TABLE %s(\" +\n+                        \"  a ARRAY(ROW(a1 ARRAY(varchar), a2 int))) \" +\n+                        \"WITH (format='PARQUET', external_location='%s')\",\n+                missingNestedArrayTableName,\n+                tableLocation));\n+\n+        assertQuery(\n+                sessionUsingColumnIndex,\n+                \"SELECT a[1].a1 FROM \" + missingNestedArrayTableName,\n+                \"VALUES (null)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaac947330fbed894aa02ade28189c9a5e29a682", "author": {"user": {"login": "rclaude", "name": "raphael claude"}}, "url": "https://github.com/trinodb/trino/commit/aaac947330fbed894aa02ade28189c9a5e29a682", "committedDate": "2020-07-03T08:29:39Z", "message": "Test missing nested array in Parquet files\n\nNested array and map present in the metastore schema but missing in the parquet footer used to throw NPEs when the ParquetReader was getting the missing nested fields infos.\nThis got fixed by 6e272ed5f865e50dc8b1675c191fe67f49b09dfe which enrich the schema read from the parquet footer.\nThis test is there to ensure no regression is introduced by future changes in the ParquetPageSourceFactory."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "aaac947330fbed894aa02ade28189c9a5e29a682", "author": {"user": {"login": "rclaude", "name": "raphael claude"}}, "url": "https://github.com/trinodb/trino/commit/aaac947330fbed894aa02ade28189c9a5e29a682", "committedDate": "2020-07-03T08:29:39Z", "message": "Test missing nested array in Parquet files\n\nNested array and map present in the metastore schema but missing in the parquet footer used to throw NPEs when the ParquetReader was getting the missing nested fields infos.\nThis got fixed by 6e272ed5f865e50dc8b1675c191fe67f49b09dfe which enrich the schema read from the parquet footer.\nThis test is there to ensure no regression is introduced by future changes in the ParquetPageSourceFactory."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMjgxNzA0", "url": "https://github.com/trinodb/trino/pull/4198#pullrequestreview-442281704", "createdAt": "2020-07-03T09:31:25Z", "commit": {"oid": "aaac947330fbed894aa02ade28189c9a5e29a682"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 158, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}