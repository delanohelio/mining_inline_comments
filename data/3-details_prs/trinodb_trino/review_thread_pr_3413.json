{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMTc1MjM2", "number": 3413, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMjowMzoxNVrODxZ4AA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwOTowNjo1MlrODxjTxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMTMwNzUyOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMjowMzoxNVrOGE27LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNToxNjo0MVrOGE-iiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0NzM3Mw==", "bodyText": "This verify can never fail as there is no way to enter this if block multiple times.", "url": "https://github.com/trinodb/trino/pull/3413#discussion_r407747373", "createdAt": "2020-04-13T22:03:15Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -72,21 +73,21 @@ public LocalDynamicFilter(Multimap<String, Symbol> probeSymbols, Map<String, Int\n \n         this.resultFuture = SettableFuture.create();\n \n-        this.result = TupleDomain.none();\n-        this.partitionsLeft = partitionCount;\n+        this.partitionCount = partitionCount;\n+        this.partitions = new ArrayList<>(partitionCount);\n     }\n \n     private synchronized void addPartition(TupleDomain<String> tupleDomain)\n     {\n         // Called concurrently by each DynamicFilterSourceOperator instance (when collection is over).\n-        partitionsLeft -= 1;\n-        verify(partitionsLeft >= 0);\n+        verify(partitions.size() < partitionCount);\n         // NOTE: may result in a bit more relaxed constraint if there are multiple columns and multiple rows.\n         // See the comment at TupleDomain::columnWiseUnion() for more details.\n-        result = TupleDomain.columnWiseUnion(result, tupleDomain);\n-        if (partitionsLeft == 0) {\n+        partitions.add(tupleDomain);\n+        if (partitions.size() == partitionCount) {\n+            Map<Symbol, Domain> result = convertTupleDomain(TupleDomain.columnWiseUnion(partitions));\n             // No more partitions are left to be processed.\n-            verify(resultFuture.set(convertTupleDomain(result)), \"dynamic filter result is provided more than once\");\n+            verify(resultFuture.set(result), \"dynamic filter result is provided more than once\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg3MjEzOQ==", "bodyText": "Thanks, fixed in d7f7cdd.", "url": "https://github.com/trinodb/trino/pull/3413#discussion_r407872139", "createdAt": "2020-04-14T05:16:41Z", "author": {"login": "rzeyde-varada"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -72,21 +73,21 @@ public LocalDynamicFilter(Multimap<String, Symbol> probeSymbols, Map<String, Int\n \n         this.resultFuture = SettableFuture.create();\n \n-        this.result = TupleDomain.none();\n-        this.partitionsLeft = partitionCount;\n+        this.partitionCount = partitionCount;\n+        this.partitions = new ArrayList<>(partitionCount);\n     }\n \n     private synchronized void addPartition(TupleDomain<String> tupleDomain)\n     {\n         // Called concurrently by each DynamicFilterSourceOperator instance (when collection is over).\n-        partitionsLeft -= 1;\n-        verify(partitionsLeft >= 0);\n+        verify(partitions.size() < partitionCount);\n         // NOTE: may result in a bit more relaxed constraint if there are multiple columns and multiple rows.\n         // See the comment at TupleDomain::columnWiseUnion() for more details.\n-        result = TupleDomain.columnWiseUnion(result, tupleDomain);\n-        if (partitionsLeft == 0) {\n+        partitions.add(tupleDomain);\n+        if (partitions.size() == partitionCount) {\n+            Map<Symbol, Domain> result = convertTupleDomain(TupleDomain.columnWiseUnion(partitions));\n             // No more partitions are left to be processed.\n-            verify(resultFuture.set(convertTupleDomain(result)), \"dynamic filter result is provided more than once\");\n+            verify(resultFuture.set(result), \"dynamic filter result is provided more than once\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0NzM3Mw=="}, "originalCommit": null, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMjg1MzE5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwOTowNjo1MlrOGFFNqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNDo0NDozMVrOGFSJ5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk4MTQ4Mg==", "bodyText": "make this final", "url": "https://github.com/trinodb/trino/pull/3413#discussion_r407981482", "createdAt": "2020-04-14T09:06:52Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -57,11 +58,11 @@\n \n     private final SettableFuture<Map<Symbol, Domain>> resultFuture;\n \n-    // The resulting predicate for local dynamic filtering.\n-    private TupleDomain<String> result;\n+    // Number of build-side partitions to be collected.\n+    private final int partitionCount;\n \n-    // Number of partitions left to be processed.\n-    private int partitionsLeft;\n+    // The resulting predicates from each build-side partition.\n+    private List<TupleDomain<String>> partitions;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE5MzUxMQ==", "bodyText": "Thanks, fixed in 5895edc.", "url": "https://github.com/trinodb/trino/pull/3413#discussion_r408193511", "createdAt": "2020-04-14T14:44:31Z", "author": {"login": "rzeyde-varada"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -57,11 +58,11 @@\n \n     private final SettableFuture<Map<Symbol, Domain>> resultFuture;\n \n-    // The resulting predicate for local dynamic filtering.\n-    private TupleDomain<String> result;\n+    // Number of build-side partitions to be collected.\n+    private final int partitionCount;\n \n-    // Number of partitions left to be processed.\n-    private int partitionsLeft;\n+    // The resulting predicates from each build-side partition.\n+    private List<TupleDomain<String>> partitions;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk4MTQ4Mg=="}, "originalCommit": null, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 408, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}