{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3Mzc3Nzcx", "number": 5872, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMjoyMzozN1rOE2jyiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjoyMzo0NFrOE50qOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NjQ0OTM5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMjoyMzozN1rOHva4Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMjoyMzozN1rOHva4Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ4NTU0Mg==", "bodyText": "nit: grammar typo, remove that in ... parent node that with stats?", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r519485542", "createdAt": "2020-11-08T22:23:37Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -339,6 +371,58 @@ private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n         return new QueryIOMetadata(inputs.build(), output);\n     }\n \n+    private static Multimap<QualifiedObjectName, OperatorStats> extractTableScanOperatorStats(QueryInfo queryInfo)\n+    {\n+        // Note: A plan may scan a table multiple times.\n+        ImmutableMultimap.Builder<QualifiedObjectName, OperatorStats> tableScanOperatorStats = ImmutableMultimap.builder();\n+        getAllStages(queryInfo.getOutputStage())\n+                .forEach(stageInfo -> extractTableScanOperatorStats(stageInfo, tableScanOperatorStats));\n+        return tableScanOperatorStats.build();\n+    }\n+\n+    private static void extractTableScanOperatorStats(StageInfo stageInfo, ImmutableMultimap.Builder<QualifiedObjectName, OperatorStats> tableScanOperatorStats)\n+    {\n+        if (stageInfo.getPlan() == null) {\n+            return;\n+        }\n+\n+        // Note: a plan node may be mapped to multiple operators.  For this code it doesn't matter\n+        // since only the table scan operator has physical stats, but be careful for any other use.\n+        Map<PlanNodeId, Collection<OperatorStats>> allOperatorStats = Multimaps.index(stageInfo.getStageStats().getOperatorSummaries(), OperatorStats::getPlanNodeId).asMap();\n+\n+        // Find the operator stats for each table scanned.  Sometimes a table scan is merged with\n+        // other operators, and in that case, use the stats of the nearest parent node that with stats.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 115}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1Njk3MDMxOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwNToyMzozMVrOHvfXfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwNToyMzozMVrOHvfXfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1OTAzNw==", "bodyText": "optional suggestion: the name may sound like the method is trying to get stats for TableScanOperator, which might not be true. May be switching the order can help e.g. extractStatsForTableScan?", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r519559037", "createdAt": "2020-11-09T05:23:31Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -339,6 +371,58 @@ private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n         return new QueryIOMetadata(inputs.build(), output);\n     }\n \n+    private static Multimap<QualifiedObjectName, OperatorStats> extractTableScanOperatorStats(QueryInfo queryInfo)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzAwMDM3OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwNTo0MDozMFrOHvfoOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwMzoyMzoyNVrOHyYV0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU2MzMyMQ==", "bodyText": "If two inputs for the same table are added with different columns, then this logic will add the same aggregate value for both the inputs right? Should we add a plan node id to Inputinstead and map the stats here appropriately?", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r519563321", "createdAt": "2020-11-09T05:40:30Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -309,15 +322,34 @@ private QueryContext createQueryContext(SessionRepresentation session, Optional<\n \n     private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n     {\n+        Multimap<QualifiedObjectName, OperatorStats> tableOperatorStats = extractTableScanOperatorStats(queryInfo);\n+\n         ImmutableList.Builder<QueryInputMetadata> inputs = ImmutableList.builder();\n         for (Input input : queryInfo.getInputs()) {\n+            // Note: input table may be scanned multiple times", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU4OTY1MA==", "bodyText": "You are right.  This will more difficult...  I added fragment id and plan node id to Input so we can find the exact node in the exact fragment.", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r522589650", "createdAt": "2020-11-13T03:23:25Z", "author": {"login": "dain"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -309,15 +322,34 @@ private QueryContext createQueryContext(SessionRepresentation session, Optional<\n \n     private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n     {\n+        Multimap<QualifiedObjectName, OperatorStats> tableOperatorStats = extractTableScanOperatorStats(queryInfo);\n+\n         ImmutableList.Builder<QueryInputMetadata> inputs = ImmutableList.builder();\n         for (Input input : queryInfo.getInputs()) {\n+            // Note: input table may be scanned multiple times", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU2MzMyMQ=="}, "originalCommit": null, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzAwMjcyOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwNTo0MjowMFrOHvfppw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwNTo0MjowMFrOHvfppw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU2MzY4Nw==", "bodyText": "should we also add the same logic for IndexSourceScanNode like in InputExtractor?", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r519563687", "createdAt": "2020-11-09T05:42:00Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -339,6 +371,58 @@ private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n         return new QueryIOMetadata(inputs.build(), output);\n     }\n \n+    private static Multimap<QualifiedObjectName, OperatorStats> extractTableScanOperatorStats(QueryInfo queryInfo)\n+    {\n+        // Note: A plan may scan a table multiple times.\n+        ImmutableMultimap.Builder<QualifiedObjectName, OperatorStats> tableScanOperatorStats = ImmutableMultimap.builder();\n+        getAllStages(queryInfo.getOutputStage())\n+                .forEach(stageInfo -> extractTableScanOperatorStats(stageInfo, tableScanOperatorStats));\n+        return tableScanOperatorStats.build();\n+    }\n+\n+    private static void extractTableScanOperatorStats(StageInfo stageInfo, ImmutableMultimap.Builder<QualifiedObjectName, OperatorStats> tableScanOperatorStats)\n+    {\n+        if (stageInfo.getPlan() == null) {\n+            return;\n+        }\n+\n+        // Note: a plan node may be mapped to multiple operators.  For this code it doesn't matter\n+        // since only the table scan operator has physical stats, but be careful for any other use.\n+        Map<PlanNodeId, Collection<OperatorStats>> allOperatorStats = Multimaps.index(stageInfo.getStageStats().getOperatorSummaries(), OperatorStats::getPlanNodeId).asMap();\n+\n+        // Find the operator stats for each table scanned.  Sometimes a table scan is merged with\n+        // other operators, and in that case, use the stats of the nearest parent node that with stats.\n+        stageInfo.getPlan().getRoot().accept(\n+                new PlanVisitor<Void, Collection<OperatorStats>>()\n+                {\n+                    @Override\n+                    protected Void visitPlan(PlanNode node, Collection<OperatorStats> parentStats)\n+                    {\n+                        for (PlanNode child : node.getSources()) {\n+                            child.accept(this, allOperatorStats.getOrDefault(node.getId(), parentStats));\n+                        }\n+                        return null;\n+                    }\n+\n+                    @Override\n+                    public Void visitTableScan(TableScanNode node, Collection<OperatorStats> parentStats)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDQ3NTE1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/planner/InputExtractor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMDo1NDoyNlrOH0gHmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMDo1NDoyNlrOH0gHmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxNDIzMg==", "bodyText": "nit: rename context parameter", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r524814232", "createdAt": "2020-11-17T00:54:26Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/InputExtractor.java", "diffHunk": "@@ -75,37 +79,31 @@ private Input createInput(Session session, TableHandle table, Set<Column> column\n         }\n \n         @Override\n-        public Void visitTableScan(TableScanNode node, Void context)\n+        public Void visitTableScan(TableScanNode node, PlanFragmentId fragmentId)\n         {\n-            TableHandle tableHandle = node.getTable();\n-\n-            Set<Column> columns = new HashSet<>();\n-            for (ColumnHandle columnHandle : node.getAssignments().values()) {\n-                columns.add(createColumn(metadata.getColumnMetadata(session, tableHandle, columnHandle)));\n-            }\n-\n-            inputs.add(createInput(session, tableHandle, columns));\n-\n+            processScan(fragmentId, node.getId(), node.getTable(), node.getAssignments());\n             return null;\n         }\n \n         @Override\n-        public Void visitIndexSource(IndexSourceNode node, Void context)\n+        public Void visitIndexSource(IndexSourceNode node, PlanFragmentId fragmentId)\n         {\n-            TableHandle tableHandle = node.getTableHandle();\n+            processScan(fragmentId, node.getId(), node.getTableHandle(), node.getAssignments());\n+            return null;\n+        }\n \n+        private void processScan(PlanFragmentId fragmentId, PlanNodeId planNodeId, TableHandle tableHandle, Map<Symbol, ColumnHandle> assignments)\n+        {\n             Set<Column> columns = new HashSet<>();\n-            for (ColumnHandle columnHandle : node.getAssignments().values()) {\n+            for (ColumnHandle columnHandle : assignments.values()) {\n                 columns.add(createColumn(metadata.getColumnMetadata(session, tableHandle, columnHandle)));\n             }\n \n-            inputs.add(createInput(session, tableHandle, columns));\n-\n-            return null;\n+            inputs.add(createInput(session, tableHandle, columns, fragmentId, planNodeId));\n         }\n \n         @Override\n-        protected Void visitPlan(PlanNode node, Void context)\n+        protected Void visitPlan(PlanNode node, PlanFragmentId context)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDUyNTkxOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMToxNjo1M1rOH0gkqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMToxNjo1M1rOH0gkqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgyMTY3NA==", "bodyText": "nit: typo with with?", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r524821674", "createdAt": "2020-11-17T01:16:53Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -339,6 +374,71 @@ private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n         return new QueryIOMetadata(inputs.build(), output);\n     }\n \n+    private static Multimap<FragmentNode, OperatorStats> extractStatsForTableScan(QueryInfo queryInfo)\n+    {\n+        // Note: A plan may scan a table multiple times.\n+        ImmutableMultimap.Builder<FragmentNode, OperatorStats> tableScanOperatorStats = ImmutableMultimap.builder();\n+        getAllStages(queryInfo.getOutputStage())\n+                .forEach(stageInfo -> extractStatsForTableScan(stageInfo, tableScanOperatorStats));\n+        return tableScanOperatorStats.build();\n+    }\n+\n+    private static void extractStatsForTableScan(StageInfo stageInfo, ImmutableMultimap.Builder<FragmentNode, OperatorStats> tableScanOperatorStats)\n+    {\n+        final PlanFragment fragment = stageInfo.getPlan();\n+        if (fragment == null) {\n+            return;\n+        }\n+\n+        // Note: a plan node may be mapped to multiple operators.  For this code it doesn't matter\n+        // since only the table scan operator has physical stats, but be careful for any other use.\n+        Map<PlanNodeId, Collection<OperatorStats>> allOperatorStats = Multimaps.index(stageInfo.getStageStats().getOperatorSummaries(), OperatorStats::getPlanNodeId).asMap();\n+\n+        // Find the operator stats for each table scanned.  Sometimes a table scan is merged with\n+        // other operators, and in that case, use the stats of the nearest parent node with with stats.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 116}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDYwNTg5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMTo1MTo1MFrOH0hSfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjoxMzoxMlrOH2EbwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgzMzQwNQ==", "bodyText": "since the reason behind the usage of Multimap below is that the a plannode can correspond to multiple operators, so the comment might be a bit misleading", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r524833405", "createdAt": "2020-11-17T01:51:50Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -339,6 +374,71 @@ private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n         return new QueryIOMetadata(inputs.build(), output);\n     }\n \n+    private static Multimap<FragmentNode, OperatorStats> extractStatsForTableScan(QueryInfo queryInfo)\n+    {\n+        // Note: A plan may scan a table multiple times.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1Nzc5Mg==", "bodyText": "Right... it could be mapped to multiple operators, but each scan would have a different entry.", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r526457792", "createdAt": "2020-11-18T22:13:12Z", "author": {"login": "dain"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -339,6 +374,71 @@ private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n         return new QueryIOMetadata(inputs.build(), output);\n     }\n \n+    private static Multimap<FragmentNode, OperatorStats> extractStatsForTableScan(QueryInfo queryInfo)\n+    {\n+        // Note: A plan may scan a table multiple times.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgzMzQwNQ=="}, "originalCommit": null, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDY0MzM2OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjoxMDoxN1rOH0hoDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzowOTo1M1rOH2GBtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgzODkyNQ==", "bodyText": "since we're now keying on FragmentNode, we could exclude the \"table scan\" logic here, and just invoke an extractStats method that treats all nodes equally. I think that may be easier to reason about.\nThe visitor can just have\n                    protected Void visitPlan(PlanNode node, Collection<OperatorStats> parentStats)\n                    {\n                        if (parentStats != null) {\n                            tableScanOperatorStats.putAll(new FragmentNode(fragment.getId(), node.getId()), allOperatorStats.getOrDefault(node.getId(), parentStats));\n                        }\n\n                        for (PlanNode child : node.getSources()) {\n                            child.accept(this, allOperatorStats.getOrDefault(node.getId(), parentStats));\n                        }\n                        return null;\n                    }\n\nBut if you'd like to make this method stand-out specifically for table scan stats usecase (and save some bytes), the current implementation seems fine too.", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r524838925", "createdAt": "2020-11-17T02:10:17Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -309,15 +325,34 @@ private QueryContext createQueryContext(SessionRepresentation session, Optional<\n \n     private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n     {\n+        Multimap<FragmentNode, OperatorStats> tableOperatorStats = extractStatsForTableScan(queryInfo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4Mzg5Mw==", "bodyText": "I like this style better.  I updated to code like the above.", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r526483893", "createdAt": "2020-11-18T23:09:53Z", "author": {"login": "dain"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -309,15 +325,34 @@ private QueryContext createQueryContext(SessionRepresentation session, Optional<\n \n     private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n     {\n+        Multimap<FragmentNode, OperatorStats> tableOperatorStats = extractStatsForTableScan(queryInfo);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgzODkyNQ=="}, "originalCommit": null, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDY1MzAxOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjoxNToyMVrOH0htrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjoxNToyMVrOH0htrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0MDM2NA==", "bodyText": "same comment about the comment here: the reason seems to be a plan node corresponding to multiple operators", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r524840364", "createdAt": "2020-11-17T02:15:21Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -309,15 +325,34 @@ private QueryContext createQueryContext(SessionRepresentation session, Optional<\n \n     private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n     {\n+        Multimap<FragmentNode, OperatorStats> tableOperatorStats = extractStatsForTableScan(queryInfo);\n+\n         ImmutableList.Builder<QueryInputMetadata> inputs = ImmutableList.builder();\n         for (Input input : queryInfo.getInputs()) {\n+            // Note: input table may be scanned multiple times\n+            Collection<OperatorStats> inputTableOperatorStats = tableOperatorStats.get(new FragmentNode(input.getFragmentId(), input.getPlanNodeId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDY3MDY1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjoyMzo0NFrOH0h3jA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzoxMDozNFrOH2GCpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0Mjg5Mg==", "bodyText": "The logic here seems to be kind of non-trivial to me, I was wondering if it'd be worth adding a unit test (for this or  the caller method). Not sure if there's a straightforward way currently.", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r524842892", "createdAt": "2020-11-17T02:23:44Z", "author": {"login": "phd3"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -339,6 +374,71 @@ private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n         return new QueryIOMetadata(inputs.build(), output);\n     }\n \n+    private static Multimap<FragmentNode, OperatorStats> extractStatsForTableScan(QueryInfo queryInfo)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4NDEzMw==", "bodyText": "I changed it to the simple form you suggested.", "url": "https://github.com/trinodb/trino/pull/5872#discussion_r526484133", "createdAt": "2020-11-18T23:10:34Z", "author": {"login": "dain"}, "path": "presto-main/src/main/java/io/prestosql/event/QueryMonitor.java", "diffHunk": "@@ -339,6 +374,71 @@ private static QueryIOMetadata getQueryIOMetadata(QueryInfo queryInfo)\n         return new QueryIOMetadata(inputs.build(), output);\n     }\n \n+    private static Multimap<FragmentNode, OperatorStats> extractStatsForTableScan(QueryInfo queryInfo)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0Mjg5Mg=="}, "originalCommit": null, "originalPosition": 95}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4427, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}