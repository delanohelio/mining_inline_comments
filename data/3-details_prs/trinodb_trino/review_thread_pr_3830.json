{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMTY2ODA1", "number": 3830, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QwNzoxNDo0NlrOD_HZGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMzo0ODoxOVrOEA5Y8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NTA3OTkzOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/procedure/SyncPartitionMetadataProcedure.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QwNzoxNDo0NlrOGZn8ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QxMjowNDo0MVrOGZpC8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUyMjEwNg==", "bodyText": "it should rather be procedure (optional) parameter. Sorry for miscommunication on this.", "url": "https://github.com/trinodb/trino/pull/3830#discussion_r429522106", "createdAt": "2020-05-23T07:14:46Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/procedure/SyncPartitionMetadataProcedure.java", "diffHunk": "@@ -144,28 +145,31 @@ private void doSyncPartitionMetadata(ConnectorSession session, String schemaName\n         syncPartitions(partitionsToAdd, partitionsToDrop, syncMode, metastore, session, table);\n     }\n \n-    private static List<FileStatus> listDirectory(FileSystem fileSystem, FileStatus current, List<Column> partitionColumns, int depth)\n+    private static List<FileStatus> listDirectory(ConnectorSession session, FileSystem fileSystem, FileStatus current, List<Column> partitionColumns, int depth)\n     {\n         if (depth == 0) {\n             return ImmutableList.of(current);\n         }\n \n         try {\n             return Stream.of(fileSystem.listStatus(current.getPath()))\n-                    .filter(fileStatus -> isValidPartitionPath(fileStatus, partitionColumns.get(partitionColumns.size() - depth)))\n-                    .flatMap(directory -> listDirectory(fileSystem, directory, partitionColumns, depth - 1).stream())\n+                    .filter(fileStatus -> isValidPartitionPath(session, fileStatus, partitionColumns.get(partitionColumns.size() - depth)))\n+                    .flatMap(directory -> listDirectory(session, fileSystem, directory, partitionColumns, depth - 1).stream())\n                     .collect(toImmutableList());\n         }\n         catch (IOException e) {\n             throw new PrestoException(HIVE_FILESYSTEM_ERROR, e);\n         }\n     }\n \n-    private static boolean isValidPartitionPath(FileStatus file, Column column)\n+    private static boolean isValidPartitionPath(ConnectorSession session, FileStatus file, Column column)\n     {\n-        Path path = file.getPath();\n+        String path = file.getPath().getName();\n+        if (isAllowMixedCasePartitions(session)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU0MDA4MA==", "bodyText": "My bad, I misread the Github issue description.", "url": "https://github.com/trinodb/trino/pull/3830#discussion_r429540080", "createdAt": "2020-05-23T12:04:41Z", "author": {"login": "aalbu"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/procedure/SyncPartitionMetadataProcedure.java", "diffHunk": "@@ -144,28 +145,31 @@ private void doSyncPartitionMetadata(ConnectorSession session, String schemaName\n         syncPartitions(partitionsToAdd, partitionsToDrop, syncMode, metastore, session, table);\n     }\n \n-    private static List<FileStatus> listDirectory(FileSystem fileSystem, FileStatus current, List<Column> partitionColumns, int depth)\n+    private static List<FileStatus> listDirectory(ConnectorSession session, FileSystem fileSystem, FileStatus current, List<Column> partitionColumns, int depth)\n     {\n         if (depth == 0) {\n             return ImmutableList.of(current);\n         }\n \n         try {\n             return Stream.of(fileSystem.listStatus(current.getPath()))\n-                    .filter(fileStatus -> isValidPartitionPath(fileStatus, partitionColumns.get(partitionColumns.size() - depth)))\n-                    .flatMap(directory -> listDirectory(fileSystem, directory, partitionColumns, depth - 1).stream())\n+                    .filter(fileStatus -> isValidPartitionPath(session, fileStatus, partitionColumns.get(partitionColumns.size() - depth)))\n+                    .flatMap(directory -> listDirectory(session, fileSystem, directory, partitionColumns, depth - 1).stream())\n                     .collect(toImmutableList());\n         }\n         catch (IOException e) {\n             throw new PrestoException(HIVE_FILESYSTEM_ERROR, e);\n         }\n     }\n \n-    private static boolean isValidPartitionPath(FileStatus file, Column column)\n+    private static boolean isValidPartitionPath(ConnectorSession session, FileStatus file, Column column)\n     {\n-        Path path = file.getPath();\n+        String path = file.getPath().getName();\n+        if (isAllowMixedCasePartitions(session)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUyMjEwNg=="}, "originalCommit": null, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NTQyMzUwOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/procedure/SyncPartitionMetadataProcedure.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QxODozMTozMlrOGZqwXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QxODozMTozMlrOGZqwXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU2ODA5NA==", "bodyText": "Make this case_sensitive since \u201cinsensitive\u201d is a negative and using negatives for booleans can be confusing. This is my fault since I suggested a bad name when filing the issue.", "url": "https://github.com/trinodb/trino/pull/3830#discussion_r429568094", "createdAt": "2020-05-23T18:31:32Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/procedure/SyncPartitionMetadataProcedure.java", "diffHunk": "@@ -94,18 +97,19 @@ public Procedure get()\n                 ImmutableList.of(\n                         new Argument(\"schema_name\", VARCHAR),\n                         new Argument(\"table_name\", VARCHAR),\n-                        new Argument(\"mode\", VARCHAR)),\n+                        new Argument(\"mode\", VARCHAR),\n+                        new Argument(\"case_insensitive\", BOOLEAN, false, FALSE)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NTQyNDY1OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/procedure/SyncPartitionMetadataProcedure.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QxODozMzo0NVrOGZqxAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QxODozMzo0NVrOGZqxAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU2ODI1Ng==", "bodyText": "Session is not needed here", "url": "https://github.com/trinodb/trino/pull/3830#discussion_r429568256", "createdAt": "2020-05-23T18:33:45Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/procedure/SyncPartitionMetadataProcedure.java", "diffHunk": "@@ -127,7 +131,7 @@ private void doSyncPartitionMetadata(ConnectorSession session, String schemaName\n             FileSystem fileSystem = hdfsEnvironment.getFileSystem(hdfsContext, tableLocation);\n             List<String> partitionsInMetastore = metastore.getPartitionNames(identity, schemaName, tableName)\n                     .orElseThrow(() -> new TableNotFoundException(schemaTableName));\n-            List<String> partitionsInFileSystem = listDirectory(fileSystem, fileSystem.getFileStatus(tableLocation), table.getPartitionColumns(), table.getPartitionColumns().size()).stream()\n+            List<String> partitionsInFileSystem = listDirectory(session, fileSystem, fileSystem.getFileStatus(tableLocation), table.getPartitionColumns(), table.getPartitionColumns().size(), caseInsensitive).stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NTQyNDc5OnYy", "diffSide": "RIGHT", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestSyncPartitionMetadata.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QxODozNDoyM1rOGZqxHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QyMzoyMzoyNVrOGZr0qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU2ODI4NA==", "bodyText": "This looks unused", "url": "https://github.com/trinodb/trino/pull/3830#discussion_r429568284", "createdAt": "2020-05-23T18:34:23Z", "author": {"login": "electrum"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestSyncPartitionMetadata.java", "diffHunk": "@@ -22,13 +22,16 @@\n import io.prestosql.tempto.query.QueryResult;\n import org.testng.annotations.Test;\n \n+import java.sql.SQLException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU4NTU3OA==", "bodyText": "It's used in an assertion below (https://github.com/prestosql/presto/pull/3830/files#diff-6536cdd5dd9e669a967fccf854e75924R124).", "url": "https://github.com/trinodb/trino/pull/3830#discussion_r429585578", "createdAt": "2020-05-23T23:23:25Z", "author": {"login": "aalbu"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestSyncPartitionMetadata.java", "diffHunk": "@@ -22,13 +22,16 @@\n import io.prestosql.tempto.query.QueryResult;\n import org.testng.annotations.Test;\n \n+import java.sql.SQLException;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU2ODI4NA=="}, "originalCommit": null, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NTQyNTUzOnYy", "diffSide": "RIGHT", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestSyncPartitionMetadata.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QxODozNTozN1rOGZqxgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QxODozNTozN1rOGZqxgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU2ODM4NA==", "bodyText": "This needs updating", "url": "https://github.com/trinodb/trino/pull/3830#discussion_r429568384", "createdAt": "2020-05-23T18:35:37Z", "author": {"login": "electrum"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestSyncPartitionMetadata.java", "diffHunk": "@@ -92,25 +95,56 @@ public void testInvalidSyncMode()\n         cleanup(tableName);\n     }\n \n+    @Test(groups = {HIVE_PARTITIONING, SMOKE})\n+    public void testMixedCasePartitionNames()\n+    {\n+        String tableName = \"test_sync_partition_mixed_case\";\n+        prepare(hdfsClient, hdfsDataSourceWriter, tableName);\n+        String tableLocation = WAREHOUSE_DIRECTORY_PATH + tableName;\n+        HiveDataSource dataSource = createResourceDataSource(tableName, \"io/prestosql/tests/hive/data/single_int_column/data.orc\");\n+        hdfsDataSourceWriter.ensureDataOnHdfs(tableLocation + \"/col_X=g/Col_y=10\", dataSource);\n+        hdfsDataSourceWriter.ensureDataOnHdfs(tableLocation + \"/COL_X=h/col_y=11\", dataSource);\n+\n+        query(\"CALL system.sync_partition_metadata('default', '\" + tableName + \"', 'FULL', true)\");\n+        assertPartitions(tableName, row(\"a\", \"1\"), row(\"f\", \"9\"), row(\"g\", \"10\"), row(\"h\", \"11\"));\n+        assertData(tableName, row(1, \"a\", \"1\"), row(42, \"f\", \"9\"), row(42, \"g\", \"10\"), row(42, \"h\", \"11\"));\n+    }\n+\n+    @Test(groups = {HIVE_PARTITIONING, SMOKE})\n+    public void testConflictingMixedCasePartitionNames()\n+    {\n+        String tableName = \"test_sync_partition_mixed_case\";\n+        prepare(hdfsClient, hdfsDataSourceWriter, tableName);\n+        String tableLocation = WAREHOUSE_DIRECTORY_PATH + tableName;\n+        HiveDataSource dataSource = createResourceDataSource(tableName, \"io/prestosql/tests/hive/data/single_int_column/data.orc\");\n+        // this conflicts with a partition that already exits in the metastore\n+        hdfsDataSourceWriter.ensureDataOnHdfs(tableLocation + \"/COL_X=a/cOl_y=1\", dataSource);\n+\n+        assertThatThrownBy(() -> query(\"CALL system.sync_partition_metadata('default', '\" + tableName + \"', 'ADD', true)\"))\n+                .hasCauseInstanceOf(SQLException.class)\n+                .hasMessageContaining(\"One or more partitions already exist for table 'default.test_sync_partition_mixed_case'\");\n+        assertPartitions(tableName, row(\"a\", \"1\"), row(\"b\", \"2\"));\n+    }\n+\n     private static void prepare(HdfsClient hdfsClient, HdfsDataSourceWriter hdfsDataSourceWriter, String tableName)\n     {\n         query(\"DROP TABLE IF EXISTS \" + tableName);\n \n-        query(\"CREATE TABLE \" + tableName + \" (payload bigint, x varchar, y varchar) WITH (format = 'ORC', partitioned_by = ARRAY[ 'x', 'y' ])\");\n+        query(\"CREATE TABLE \" + tableName + \" (payload bigint, col_x varchar, col_y varchar) WITH (format = 'ORC', partitioned_by = ARRAY[ 'col_x', 'col_y' ])\");\n         query(\"INSERT INTO \" + tableName + \" VALUES (1, 'a', '1'), (2, 'b', '2')\");\n \n         String tableLocation = WAREHOUSE_DIRECTORY_PATH + tableName;\n-        // remove partition x=b/y=2\n-        hdfsClient.delete(tableLocation + \"/x=b/y=2\");\n-        // add partition directory x=f/y=9 with single_int_column/data.orc file\n-        hdfsClient.createDirectory(tableLocation + \"/x=f/y=9\");\n+        // remove partition x=b/col_y=2", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NTQyNTg3OnYy", "diffSide": "RIGHT", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestSyncPartitionMetadata.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QxODozNjowNlrOGZqxrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QxODozNjowNlrOGZqxrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU2ODQzMA==", "bodyText": "Same", "url": "https://github.com/trinodb/trino/pull/3830#discussion_r429568430", "createdAt": "2020-05-23T18:36:06Z", "author": {"login": "electrum"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestSyncPartitionMetadata.java", "diffHunk": "@@ -92,25 +95,56 @@ public void testInvalidSyncMode()\n         cleanup(tableName);\n     }\n \n+    @Test(groups = {HIVE_PARTITIONING, SMOKE})\n+    public void testMixedCasePartitionNames()\n+    {\n+        String tableName = \"test_sync_partition_mixed_case\";\n+        prepare(hdfsClient, hdfsDataSourceWriter, tableName);\n+        String tableLocation = WAREHOUSE_DIRECTORY_PATH + tableName;\n+        HiveDataSource dataSource = createResourceDataSource(tableName, \"io/prestosql/tests/hive/data/single_int_column/data.orc\");\n+        hdfsDataSourceWriter.ensureDataOnHdfs(tableLocation + \"/col_X=g/Col_y=10\", dataSource);\n+        hdfsDataSourceWriter.ensureDataOnHdfs(tableLocation + \"/COL_X=h/col_y=11\", dataSource);\n+\n+        query(\"CALL system.sync_partition_metadata('default', '\" + tableName + \"', 'FULL', true)\");\n+        assertPartitions(tableName, row(\"a\", \"1\"), row(\"f\", \"9\"), row(\"g\", \"10\"), row(\"h\", \"11\"));\n+        assertData(tableName, row(1, \"a\", \"1\"), row(42, \"f\", \"9\"), row(42, \"g\", \"10\"), row(42, \"h\", \"11\"));\n+    }\n+\n+    @Test(groups = {HIVE_PARTITIONING, SMOKE})\n+    public void testConflictingMixedCasePartitionNames()\n+    {\n+        String tableName = \"test_sync_partition_mixed_case\";\n+        prepare(hdfsClient, hdfsDataSourceWriter, tableName);\n+        String tableLocation = WAREHOUSE_DIRECTORY_PATH + tableName;\n+        HiveDataSource dataSource = createResourceDataSource(tableName, \"io/prestosql/tests/hive/data/single_int_column/data.orc\");\n+        // this conflicts with a partition that already exits in the metastore\n+        hdfsDataSourceWriter.ensureDataOnHdfs(tableLocation + \"/COL_X=a/cOl_y=1\", dataSource);\n+\n+        assertThatThrownBy(() -> query(\"CALL system.sync_partition_metadata('default', '\" + tableName + \"', 'ADD', true)\"))\n+                .hasCauseInstanceOf(SQLException.class)\n+                .hasMessageContaining(\"One or more partitions already exist for table 'default.test_sync_partition_mixed_case'\");\n+        assertPartitions(tableName, row(\"a\", \"1\"), row(\"b\", \"2\"));\n+    }\n+\n     private static void prepare(HdfsClient hdfsClient, HdfsDataSourceWriter hdfsDataSourceWriter, String tableName)\n     {\n         query(\"DROP TABLE IF EXISTS \" + tableName);\n \n-        query(\"CREATE TABLE \" + tableName + \" (payload bigint, x varchar, y varchar) WITH (format = 'ORC', partitioned_by = ARRAY[ 'x', 'y' ])\");\n+        query(\"CREATE TABLE \" + tableName + \" (payload bigint, col_x varchar, col_y varchar) WITH (format = 'ORC', partitioned_by = ARRAY[ 'col_x', 'col_y' ])\");\n         query(\"INSERT INTO \" + tableName + \" VALUES (1, 'a', '1'), (2, 'b', '2')\");\n \n         String tableLocation = WAREHOUSE_DIRECTORY_PATH + tableName;\n-        // remove partition x=b/y=2\n-        hdfsClient.delete(tableLocation + \"/x=b/y=2\");\n-        // add partition directory x=f/y=9 with single_int_column/data.orc file\n-        hdfsClient.createDirectory(tableLocation + \"/x=f/y=9\");\n+        // remove partition x=b/col_y=2\n+        hdfsClient.delete(tableLocation + \"/col_x=b/col_y=2\");\n+        // add partition directory x=f/col_y=9 with single_int_column/data.orc file", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NTYwNzkwOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/procedure/SyncPartitionMetadataProcedure.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQwMTo1Nzo0NVrOGZsNPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQwMjowMTowNFrOGZsNxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU5MTg3MQ==", "bodyText": "Should this be Locale.getDefault()?", "url": "https://github.com/trinodb/trino/pull/3830#discussion_r429591871", "createdAt": "2020-05-24T01:57:45Z", "author": {"login": "aalbu"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/procedure/SyncPartitionMetadataProcedure.java", "diffHunk": "@@ -144,28 +148,31 @@ private void doSyncPartitionMetadata(ConnectorSession session, String schemaName\n         syncPartitions(partitionsToAdd, partitionsToDrop, syncMode, metastore, session, table);\n     }\n \n-    private static List<FileStatus> listDirectory(FileSystem fileSystem, FileStatus current, List<Column> partitionColumns, int depth)\n+    private static List<FileStatus> listDirectory(ConnectorSession session, FileSystem fileSystem, FileStatus current, List<Column> partitionColumns, int depth, boolean caseInsensitive)\n     {\n         if (depth == 0) {\n             return ImmutableList.of(current);\n         }\n \n         try {\n             return Stream.of(fileSystem.listStatus(current.getPath()))\n-                    .filter(fileStatus -> isValidPartitionPath(fileStatus, partitionColumns.get(partitionColumns.size() - depth)))\n-                    .flatMap(directory -> listDirectory(fileSystem, directory, partitionColumns, depth - 1).stream())\n+                    .filter(fileStatus -> isValidPartitionPath(session, fileStatus, partitionColumns.get(partitionColumns.size() - depth), caseInsensitive))\n+                    .flatMap(directory -> listDirectory(session, fileSystem, directory, partitionColumns, depth - 1, caseInsensitive).stream())\n                     .collect(toImmutableList());\n         }\n         catch (IOException e) {\n             throw new PrestoException(HIVE_FILESYSTEM_ERROR, e);\n         }\n     }\n \n-    private static boolean isValidPartitionPath(FileStatus file, Column column)\n+    private static boolean isValidPartitionPath(ConnectorSession session, FileStatus file, Column column, boolean caseInsensitive)\n     {\n-        Path path = file.getPath();\n+        String path = file.getPath().getName();\n+        if (caseInsensitive) {\n+            path = path.toLowerCase(ENGLISH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU5MjAwNw==", "bodyText": "No, we never (or should not) depend on the JVM locale.", "url": "https://github.com/trinodb/trino/pull/3830#discussion_r429592007", "createdAt": "2020-05-24T02:01:04Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/procedure/SyncPartitionMetadataProcedure.java", "diffHunk": "@@ -144,28 +148,31 @@ private void doSyncPartitionMetadata(ConnectorSession session, String schemaName\n         syncPartitions(partitionsToAdd, partitionsToDrop, syncMode, metastore, session, table);\n     }\n \n-    private static List<FileStatus> listDirectory(FileSystem fileSystem, FileStatus current, List<Column> partitionColumns, int depth)\n+    private static List<FileStatus> listDirectory(ConnectorSession session, FileSystem fileSystem, FileStatus current, List<Column> partitionColumns, int depth, boolean caseInsensitive)\n     {\n         if (depth == 0) {\n             return ImmutableList.of(current);\n         }\n \n         try {\n             return Stream.of(fileSystem.listStatus(current.getPath()))\n-                    .filter(fileStatus -> isValidPartitionPath(fileStatus, partitionColumns.get(partitionColumns.size() - depth)))\n-                    .flatMap(directory -> listDirectory(fileSystem, directory, partitionColumns, depth - 1).stream())\n+                    .filter(fileStatus -> isValidPartitionPath(session, fileStatus, partitionColumns.get(partitionColumns.size() - depth), caseInsensitive))\n+                    .flatMap(directory -> listDirectory(session, fileSystem, directory, partitionColumns, depth - 1, caseInsensitive).stream())\n                     .collect(toImmutableList());\n         }\n         catch (IOException e) {\n             throw new PrestoException(HIVE_FILESYSTEM_ERROR, e);\n         }\n     }\n \n-    private static boolean isValidPartitionPath(FileStatus file, Column column)\n+    private static boolean isValidPartitionPath(ConnectorSession session, FileStatus file, Column column, boolean caseInsensitive)\n     {\n-        Path path = file.getPath();\n+        String path = file.getPath().getName();\n+        if (caseInsensitive) {\n+            path = path.toLowerCase(ENGLISH);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU5MTg3MQ=="}, "originalCommit": null, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5Mzc1NzI5OnYy", "diffSide": "RIGHT", "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestSyncPartitionMetadata.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMzo0ODoxOVrOGcdWtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMzo0ODoxOVrOGcdWtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ5NDI2MA==", "bodyText": "add a case with COL_X=UPPER_CASE that woud verify the value is registered as UPPER_CASE and not upper_case", "url": "https://github.com/trinodb/trino/pull/3830#discussion_r432494260", "createdAt": "2020-05-29T13:48:19Z", "author": {"login": "findepi"}, "path": "presto-product-tests/src/main/java/io/prestosql/tests/hive/TestSyncPartitionMetadata.java", "diffHunk": "@@ -92,25 +93,57 @@ public void testInvalidSyncMode()\n         cleanup(tableName);\n     }\n \n+    @Test(groups = {HIVE_PARTITIONING, SMOKE})\n+    public void testMixedCasePartitionNames()\n+    {\n+        String tableName = \"test_sync_partition_mixed_case\";\n+        prepare(hdfsClient, hdfsDataSourceWriter, tableName);\n+        String tableLocation = WAREHOUSE_DIRECTORY_PATH + tableName;\n+        HiveDataSource dataSource = createResourceDataSource(tableName, \"io/prestosql/tests/hive/data/single_int_column/data.orc\");\n+        hdfsDataSourceWriter.ensureDataOnHdfs(tableLocation + \"/col_x=h/col_Y=11\", dataSource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4925, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}