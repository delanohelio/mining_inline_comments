{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMjc4MTE3", "number": 3623, "title": "Enable testColumnName in TestCassandraDistributedQueries", "bodyText": "This requires changes of AbstractTestDistributedQueries.\n\nCassandra allows only 48 characters for column names\nColumn name id is automatically generated in Cassandra connector\n\n(Ongoing Oracle PR's column length limitation is 30 due to the image version)", "createdAt": "2020-05-05T02:44:50Z", "url": "https://github.com/trinodb/trino/pull/3623", "merged": true, "mergeCommit": {"oid": "fdbeea304bcf3252e7cd1be718dcd148340cf764"}, "closed": true, "closedAt": "2020-05-06T04:10:07Z", "author": {"login": "ebyhr"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceLGVUgBqjMzMDI0MTk5MTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceSdyLABqjMzMDM4MDQ1NDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NDkwNzI4", "url": "https://github.com/trinodb/trino/pull/3623#pullrequestreview-405490728", "createdAt": "2020-05-05T04:50:28Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNDo1MDoyOFrOGQaVYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNDo1MDoyOFrOGQaVYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg2MTg1OA==", "bodyText": "can we simply change the default here? 12 was quite big.", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r419861858", "createdAt": "2020-05-05T04:50:28Z", "author": {"login": "kokosing"}, "path": "presto-testing/src/main/java/io/prestosql/testing/sql/TestTable.java", "diffHunk": "@@ -67,8 +67,13 @@ public void close()\n     }\n \n     public static String randomTableSuffix()\n+    {\n+        return randomTableSuffix(RANDOM_SUFFIX_LENGTH);\n+    }\n+\n+    public static String randomTableSuffix(int maxLength)\n     {\n         String randomSuffix = Long.toString(abs(random.nextLong()), MAX_RADIX);\n-        return randomSuffix.substring(0, min(RANDOM_SUFFIX_LENGTH, randomSuffix.length()));\n+        return randomSuffix.substring(0, min(maxLength, randomSuffix.length()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NTcxNjgx", "url": "https://github.com/trinodb/trino/pull/3623#pullrequestreview-405571681", "createdAt": "2020-05-05T08:06:22Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwODowNjoyM1rOGQeoDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwODowNzo1NlrOGQerVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzMjE3NQ==", "bodyText": "Escaping should be done when we construct a CQL query", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r419932175", "createdAt": "2020-05-05T08:06:23Z", "author": {"login": "findepi"}, "path": "presto-cassandra/src/main/java/io/prestosql/plugin/cassandra/CassandraMetadata.java", "diffHunk": "@@ -289,7 +290,7 @@ private CassandraOutputTableHandle createTable(ConnectorTableMetadata tableMetad\n         for (ColumnMetadata column : tableMetadata.getColumns()) {\n             columnNames.add(column.getName());\n             columnTypes.add(column.getType());\n-            columnExtra.add(new ExtraColumnMetadata(column.getName(), column.isHidden()));\n+            columnExtra.add(new ExtraColumnMetadata(escapeSingleQuote(column.getName()), column.isHidden()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzMjU5Ng==", "bodyText": "I am concerned about escape function that doesn't quote.\nGenerally, escaping and quoting should be done at the same time, so they should be done\nat once, in one function.", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r419932596", "createdAt": "2020-05-05T08:07:10Z", "author": {"login": "findepi"}, "path": "presto-cassandra/src/main/java/io/prestosql/plugin/cassandra/util/CassandraCqlUtils.java", "diffHunk": "@@ -48,12 +49,12 @@ public static String validColumnName(String identifier)\n             return \"\\\"\\\"\";\n         }\n \n-        return quoteIdentifier(identifier);\n+        return quote(identifier);\n     }\n \n-    private static String quoteIdentifier(String identifier)\n+    public static String escapeSingleQuote(String identifier)\n     {\n-        return '\"' + identifier + '\"';\n+        return identifier.replace(\"'\", \"''\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzMzAxMw==", "bodyText": "Please remove, as per @kokosing's https://github.com/prestosql/presto/pull/3623/files#r419861858 comment", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r419933013", "createdAt": "2020-05-05T08:07:56Z", "author": {"login": "findepi"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -94,6 +93,11 @@ protected boolean supportsArrays()\n         return true;\n     }\n \n+    protected String randomTableSuffix()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NjU0NjAw", "url": "https://github.com/trinodb/trino/pull/3623#pullrequestreview-405654600", "createdAt": "2020-05-05T10:11:20Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDoxMToyMFrOGQi0xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDoxNTowOFrOGQi8WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAwMDk2Ng==", "bodyText": "about 2^31 options, but since we generate them a lot.... can this be eg 8?\nwe can shorted the table name's base a bit maybe?", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r420000966", "createdAt": "2020-05-05T10:11:20Z", "author": {"login": "findepi"}, "path": "presto-testing/src/main/java/io/prestosql/testing/sql/TestTable.java", "diffHunk": "@@ -27,7 +27,7 @@\n         implements AutoCloseable\n {\n     private static final SecureRandom random = new SecureRandom();\n-    private static final int RANDOM_SUFFIX_LENGTH = 12;\n+    private static final int RANDOM_SUFFIX_LENGTH = 6;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAwMTMyOQ==", "bodyText": "Rename id column to key in testColumnName\n\nin the commit message maybe mention that id has a special meaning in Cassandra.", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r420001329", "createdAt": "2020-05-05T10:12:01Z", "author": {"login": "findepi"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestDistributedQueries.java", "diffHunk": "@@ -1180,7 +1180,7 @@ private void testColumnName(String columnName, boolean delimited)\n \n         try {\n             // TODO test with both CTAS *and* CREATE TABLE + INSERT, since they use different connector API methods.\n-            assertUpdate(\"CREATE TABLE \" + tableName + \"(id varchar, \" + nameInSql + \" varchar)\");\n+            assertUpdate(\"CREATE TABLE \" + tableName + \"(key varchar, \" + nameInSql + \" varchar)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAwMjkwNA==", "bodyText": "Enable testColumnName in TestCassandraDistributedQueries\n\nConsider squashing this commit with Use Metadata.quote in CassandraCqlUtils -- if this is what fixes Cassandra and makes this test pass now.", "url": "https://github.com/trinodb/trino/pull/3623#discussion_r420002904", "createdAt": "2020-05-05T10:15:08Z", "author": {"login": "findepi"}, "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/TestCassandraDistributedQueries.java", "diffHunk": "@@ -150,16 +150,6 @@ protected TestTable createTableWithDefaultColumns()\n         throw new SkipException(\"Cassandra connector does not support column default values\");\n     }\n \n-    @Override\n-    public void testColumnName(String columnName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc4fbffe275785e136390f26a66232db6c408d95", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/cc4fbffe275785e136390f26a66232db6c408d95", "committedDate": "2020-05-05T11:31:53Z", "message": "Rename id column to key and shorten name in testColumnName\n\nThe id column name is reserved in Cassandra connector.\nReplace 0startingwithdigit with 0startwithdigit to avoid\ncolumn name length limitation (48) in Cassandra."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c97ac99422f107cd80e4a59392ee54b0a8dab4ec", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/c97ac99422f107cd80e4a59392ee54b0a8dab4ec", "committedDate": "2020-05-05T11:32:30Z", "message": "Use Metadata.quote in CassandraCqlUtils\n\nTo use escaping logic of Metadata.quote method.\nAdditionally, escape single quotation for table comment\nand enable testColumnName in Cassandra."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "c97ac99422f107cd80e4a59392ee54b0a8dab4ec", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/c97ac99422f107cd80e4a59392ee54b0a8dab4ec", "committedDate": "2020-05-05T11:32:30Z", "message": "Use Metadata.quote in CassandraCqlUtils\n\nTo use escaping logic of Metadata.quote method.\nAdditionally, escape single quotation for table comment\nand enable testColumnName in Cassandra."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1384, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}