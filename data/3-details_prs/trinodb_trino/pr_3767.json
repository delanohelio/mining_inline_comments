{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5MDg1NjYx", "number": 3767, "title": "Add support for CREATE and DROP TABLE in BigQuery", "bodyText": "", "createdAt": "2020-05-17T09:27:22Z", "url": "https://github.com/trinodb/trino/pull/3767", "merged": true, "mergeCommit": {"oid": "ada5147903c477d0ae58a708c16de878b19f4935"}, "closed": true, "closedAt": "2021-03-01T09:42:44Z", "author": {"login": "ebyhr"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYO8mmgBqjM5NDUxMTMyMTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd-z14WgFqTYwMDQ5NjgxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d6bc45befe7a85de6cefb4432587ac7fc1abe06", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/3d6bc45befe7a85de6cefb4432587ac7fc1abe06", "committedDate": "2020-05-17T09:22:03Z", "message": "Add support for CREATE and DROP TABLE in BigQuery"}, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc5MzAxMDQy", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-579301042", "createdAt": "2021-01-29T14:24:02Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQxNDoyNDowMlrOIcmH4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQxNDozMjozMVrOIcmeow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg1NTY0OA==", "bodyText": "The tableIds map in BigQueryClient doesn't actually store anything useful since both the keys and values are same.\nEach get on the map is also accompanied by an API call too so we should perform the API call directly.\nI've removed this map in #6748 in favour of a cache which maintains a mapping of lowercase name to remote name.", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r566855648", "createdAt": "2021-01-29T14:24:02Z", "author": {"login": "hashhar"}, "path": "plugin/trino-bigquery/src/main/java/io/trino/plugin/bigquery/BigQueryClient.java", "diffHunk": "@@ -126,6 +126,18 @@ Table update(TableInfo table)\n         return bigQuery.update(table);\n     }\n \n+    public void createTable(TableInfo tableInfo)\n+    {\n+        bigQuery.create(tableInfo);\n+        tableIds.put(tableInfo.getTableId(), tableInfo.getTableId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg1NzM4Mw==", "bodyText": "nit: static import Field.Mode.REPEATED.", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r566857383", "createdAt": "2021-01-29T14:26:32Z", "author": {"login": "hashhar"}, "path": "plugin/trino-bigquery/src/main/java/io/trino/plugin/bigquery/BigQueryType.java", "diffHunk": "@@ -182,6 +191,70 @@ static String bytesToStringConverter(Object value)\n         return format(\"FROM_BASE64('%s')\", Base64.getEncoder().encodeToString(slice.getBytes()));\n     }\n \n+    public static Field toField(String name, Type type)\n+    {\n+        if (type instanceof ArrayType) {\n+            Type elementType = ((ArrayType) type).getElementType();\n+            if (elementType instanceof RowType) {\n+                return Field.newBuilder(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) elementType)).setMode(Field.Mode.REPEATED).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg1ODE2Mg==", "bodyText": "Do we do this in any other connector? Naming anonymous fields in ROW types?", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r566858162", "createdAt": "2021-01-29T14:27:43Z", "author": {"login": "hashhar"}, "path": "plugin/trino-bigquery/src/main/java/io/trino/plugin/bigquery/BigQueryType.java", "diffHunk": "@@ -182,6 +191,70 @@ static String bytesToStringConverter(Object value)\n         return format(\"FROM_BASE64('%s')\", Base64.getEncoder().encodeToString(slice.getBytes()));\n     }\n \n+    public static Field toField(String name, Type type)\n+    {\n+        if (type instanceof ArrayType) {\n+            Type elementType = ((ArrayType) type).getElementType();\n+            if (elementType instanceof RowType) {\n+                return Field.newBuilder(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) elementType)).setMode(Field.Mode.REPEATED).build();\n+            }\n+            return Field.newBuilder(name, toStandardSqlTypeName(elementType)).setMode(Field.Mode.REPEATED).build();\n+        }\n+        if (type instanceof RowType) {\n+            return Field.of(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) type));\n+        }\n+        return Field.of(name, toStandardSqlTypeName(type));\n+    }\n+\n+    private static FieldList toFieldList(RowType rowType)\n+    {\n+        List<Field> fields = rowType.getFields().stream()\n+                .map(field -> toField(field.getName().orElse(\"field\" + rowType.getFields().indexOf(field)), field.getType()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg1ODgxNg==", "bodyText": "nit: static import and replace with toImmutableList since we aren't modifying it after return.", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r566858816", "createdAt": "2021-01-29T14:28:36Z", "author": {"login": "hashhar"}, "path": "plugin/trino-bigquery/src/main/java/io/trino/plugin/bigquery/BigQueryType.java", "diffHunk": "@@ -182,6 +191,70 @@ static String bytesToStringConverter(Object value)\n         return format(\"FROM_BASE64('%s')\", Base64.getEncoder().encodeToString(slice.getBytes()));\n     }\n \n+    public static Field toField(String name, Type type)\n+    {\n+        if (type instanceof ArrayType) {\n+            Type elementType = ((ArrayType) type).getElementType();\n+            if (elementType instanceof RowType) {\n+                return Field.newBuilder(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) elementType)).setMode(Field.Mode.REPEATED).build();\n+            }\n+            return Field.newBuilder(name, toStandardSqlTypeName(elementType)).setMode(Field.Mode.REPEATED).build();\n+        }\n+        if (type instanceof RowType) {\n+            return Field.of(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) type));\n+        }\n+        return Field.of(name, toStandardSqlTypeName(type));\n+    }\n+\n+    private static FieldList toFieldList(RowType rowType)\n+    {\n+        List<Field> fields = rowType.getFields().stream()\n+                .map(field -> toField(field.getName().orElse(\"field\" + rowType.getFields().indexOf(field)), field.getType()))\n+                .collect(Collectors.toUnmodifiableList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg2MDExOQ==", "bodyText": "We will need to keep this in sync with the type mappings otherwise CTAS statement's schema might differ from the table that gets created.\nWould it be helpful to define a bi-directional map somewhere with this mapping and use it for both read type mappings and write mappings?", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r566860119", "createdAt": "2021-01-29T14:30:27Z", "author": {"login": "hashhar"}, "path": "plugin/trino-bigquery/src/main/java/io/trino/plugin/bigquery/BigQueryType.java", "diffHunk": "@@ -182,6 +191,70 @@ static String bytesToStringConverter(Object value)\n         return format(\"FROM_BASE64('%s')\", Base64.getEncoder().encodeToString(slice.getBytes()));\n     }\n \n+    public static Field toField(String name, Type type)\n+    {\n+        if (type instanceof ArrayType) {\n+            Type elementType = ((ArrayType) type).getElementType();\n+            if (elementType instanceof RowType) {\n+                return Field.newBuilder(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) elementType)).setMode(Field.Mode.REPEATED).build();\n+            }\n+            return Field.newBuilder(name, toStandardSqlTypeName(elementType)).setMode(Field.Mode.REPEATED).build();\n+        }\n+        if (type instanceof RowType) {\n+            return Field.of(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) type));\n+        }\n+        return Field.of(name, toStandardSqlTypeName(type));\n+    }\n+\n+    private static FieldList toFieldList(RowType rowType)\n+    {\n+        List<Field> fields = rowType.getFields().stream()\n+                .map(field -> toField(field.getName().orElse(\"field\" + rowType.getFields().indexOf(field)), field.getType()))\n+                .collect(Collectors.toUnmodifiableList());\n+        return FieldList.of(fields);\n+    }\n+\n+    private static StandardSQLTypeName toStandardSqlTypeName(Type type)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg2MTQ3NQ==", "bodyText": "Since CREATE TABLE is now supported we can add roundtrip tests for the data types to ensure our read and write mappings are in sync.", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r566861475", "createdAt": "2021-01-29T14:32:31Z", "author": {"login": "hashhar"}, "path": "plugin/trino-bigquery/src/test/java/io/trino/plugin/bigquery/TestBigQueryIntegrationSmokeTest.java", "diffHunk": "@@ -61,6 +63,78 @@ public void testDescribeTable()\n         assertEquals(actualColumns, expectedColumns);\n     }\n \n+    @Test\n+    public void createTableWithEveryType()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgwMjA0ODIz", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-580204823", "createdAt": "2021-02-01T10:22:35Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMVQxMDoyMjozNVrOIdaTBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMVQxMDoyMjozNVrOIdaTBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzcxMDQ2OA==", "bodyText": "I assume that createTable would throw if table already exists. Can you determine if reason for an exception is that table was already in bigquery. And then ignore the exception if boolean ignoreExisting is true?", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r567710468", "createdAt": "2021-02-01T10:22:35Z", "author": {"login": "losipiuk"}, "path": "plugin/trino-bigquery/src/main/java/io/trino/plugin/bigquery/BigQueryMetadata.java", "diffHunk": "@@ -238,6 +240,20 @@ public ConnectorTableProperties getTableProperties(ConnectorSession session, Con\n         return new ConnectorTableProperties();\n     }\n \n+    @Override\n+    public void createTable(ConnectorSession session, ConnectorTableMetadata tableMetadata, boolean ignoreExisting)\n+    {\n+        createTable(tableMetadata);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgwMjExNjk0", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-580211694", "createdAt": "2021-02-01T10:30:27Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMVQxMDozMDoyOFrOIdansA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMVQxMDozMDoyOFrOIdansA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzcxNTc2MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static Field toField(String name, Type type)\n          \n          \n            \n                {\n          \n          \n            \n                    if (type instanceof ArrayType) {\n          \n          \n            \n                        Type elementType = ((ArrayType) type).getElementType();\n          \n          \n            \n                        if (elementType instanceof RowType) {\n          \n          \n            \n                            return Field.newBuilder(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) elementType)).setMode(REPEATED).build();\n          \n          \n            \n                        }\n          \n          \n            \n                        return Field.newBuilder(name, toStandardSqlTypeName(elementType)).setMode(REPEATED).build();\n          \n          \n            \n                    }\n          \n          \n            \n                    if (type instanceof RowType) {\n          \n          \n            \n                        return Field.of(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) type));\n          \n          \n            \n                    }\n          \n          \n            \n                    return Field.of(name, toStandardSqlTypeName(type));\n          \n          \n            \n                }\n          \n          \n            \n                public static Field toField(String name, Type type)\n          \n          \n            \n                {\n          \n          \n            \n                    if (type instanceof ArrayType) {\n          \n          \n            \n                        Type elementType = ((ArrayType) type).getElementType();\n          \n          \n            \n                        return toInnerFieldBuilder(name, elementType).setMode(REPEATED).build();\n          \n          \n            \n                    }\n          \n          \n            \n                    return toInnerFieldBuilder(name, type).build();\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                private static Field.Builder toInnerFieldBuilder(String name, Type type)\n          \n          \n            \n                {\n          \n          \n            \n                    if (type instanceof RowType) {\n          \n          \n            \n                        return Field.newBuilder(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) type));\n          \n          \n            \n                    }\n          \n          \n            \n                    return Field.newBuilder(name, toStandardSqlTypeName(type));\n          \n          \n            \n                }", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r567715760", "createdAt": "2021-02-01T10:30:28Z", "author": {"login": "losipiuk"}, "path": "plugin/trino-bigquery/src/main/java/io/trino/plugin/bigquery/BigQueryType.java", "diffHunk": "@@ -182,6 +192,70 @@ static String bytesToStringConverter(Object value)\n         return format(\"FROM_BASE64('%s')\", Base64.getEncoder().encodeToString(slice.getBytes()));\n     }\n \n+    public static Field toField(String name, Type type)\n+    {\n+        if (type instanceof ArrayType) {\n+            Type elementType = ((ArrayType) type).getElementType();\n+            if (elementType instanceof RowType) {\n+                return Field.newBuilder(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) elementType)).setMode(REPEATED).build();\n+            }\n+            return Field.newBuilder(name, toStandardSqlTypeName(elementType)).setMode(REPEATED).build();\n+        }\n+        if (type instanceof RowType) {\n+            return Field.of(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) type));\n+        }\n+        return Field.of(name, toStandardSqlTypeName(type));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgwMjE4ODU0", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-580218854", "createdAt": "2021-02-01T10:38:41Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMVQxMDozODo0MVrOIda8pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMVQxMDozODo0MVrOIda8pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzcyMTEyNQ==", "bodyText": "nit: would it take much more test-execution time to provide type and expected type via test parameters and use @DataProvider to pass those. Then each test execution would create table with just one column. Having separate tests for each type can make investigating failures later on easier.", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r567721125", "createdAt": "2021-02-01T10:38:41Z", "author": {"login": "losipiuk"}, "path": "plugin/trino-bigquery/src/test/java/io/trino/plugin/bigquery/TestBigQueryIntegrationSmokeTest.java", "diffHunk": "@@ -61,6 +63,78 @@ public void testDescribeTable()\n         assertEquals(actualColumns, expectedColumns);\n     }\n \n+    @Test\n+    public void createTableWithEveryType()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgwMjE5MTAx", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-580219101", "createdAt": "2021-02-01T10:38:58Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTkwNDYxNjg5", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-590461689", "createdAt": "2021-02-15T13:09:58Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xNVQxMzowOTo1OFrOIlfTjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xNVQxMzowOTo1OFrOIlfTjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjE4MTEzMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    TableId tableId = TableId.of(projectId, bigQueryTable.getRemoteTableName().getDatasetName(), bigQueryTable.getRemoteTableName().getTableName());\n          \n          \n            \n                    TableId tableId = bigQueryTable.getRemoteTableName().toTableId();", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r576181132", "createdAt": "2021-02-15T13:09:58Z", "author": {"login": "hashhar"}, "path": "plugin/trino-bigquery/src/main/java/io/trino/plugin/bigquery/BigQueryMetadata.java", "diffHunk": "@@ -286,6 +292,28 @@ public ConnectorTableProperties getTableProperties(ConnectorSession session, Con\n         return new ConnectorTableProperties();\n     }\n \n+    @Override\n+    public void createTable(ConnectorSession session, ConnectorTableMetadata tableMetadata, boolean ignoreExisting)\n+    {\n+        try {\n+            createTable(tableMetadata);\n+        }\n+        catch (BigQueryException e) {\n+            if (ignoreExisting && e.getCode() == 409) {\n+                return;\n+            }\n+            throw e;\n+        }\n+    }\n+\n+    @Override\n+    public void dropTable(ConnectorSession session, ConnectorTableHandle tableHandle)\n+    {\n+        BigQueryTableHandle bigQueryTable = (BigQueryTableHandle) tableHandle;\n+        TableId tableId = TableId.of(projectId, bigQueryTable.getRemoteTableName().getDatasetName(), bigQueryTable.getRemoteTableName().getTableName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 44}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk1MDQ0MDYy", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-595044062", "createdAt": "2021-02-22T06:39:49Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk2Njc2Nzcz", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-596676773", "createdAt": "2021-02-23T18:39:53Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0yM1QxODozOTo1M1rOIqXaLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0yM1QxODozOTo1M1rOIqXaLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTI5NDYzNw==", "bodyText": "nit: put this one just below public craeteTable", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r581294637", "createdAt": "2021-02-23T18:39:53Z", "author": {"login": "losipiuk"}, "path": "plugin/trino-bigquery/src/main/java/io/trino/plugin/bigquery/BigQueryMetadata.java", "diffHunk": "@@ -396,4 +424,20 @@ public RecordCursor cursor(ConnectorTransactionHandle transactionHandle, Connect\n             }\n         };\n     }\n+\n+    private void createTable(ConnectorTableMetadata tableMetadata)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk2NjkxOTk1", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-596691995", "createdAt": "2021-02-23T18:57:45Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0yM1QxODo1Nzo0NVrOIqYH1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0yM1QxODo1Nzo0NVrOIqYH1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTMwNjMyNg==", "bodyText": "nit: IMO using Field as return type, passing repeated flag via parameter and using Builder only internally makes code a bit easier to read.\nWDYT:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static Field toField(String name, Type type)\n          \n          \n            \n                {\n          \n          \n            \n                    if (type instanceof ArrayType) {\n          \n          \n            \n                        Type elementType = ((ArrayType) type).getElementType();\n          \n          \n            \n                        return toInnerFieldBuilder(name, elementType).setMode(REPEATED).build();\n          \n          \n            \n                    }\n          \n          \n            \n                    return toInnerFieldBuilder(name, type).build();\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                private static Field.Builder toInnerFieldBuilder(String name, Type type)\n          \n          \n            \n                {\n          \n          \n            \n                    if (type instanceof RowType) {\n          \n          \n            \n                        return Field.newBuilder(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) type));\n          \n          \n            \n                    }\n          \n          \n            \n                    return Field.newBuilder(name, toStandardSqlTypeName(type));\n          \n          \n            \n                }\n          \n          \n            \n                public static Field toField(String name, Type type)\n          \n          \n            \n                {\n          \n          \n            \n                    if (type instanceof ArrayType) {\n          \n          \n            \n                        Type elementType = ((ArrayType) type).getElementType();\n          \n          \n            \n                        return toInnerField(name, elementType, true);\n          \n          \n            \n                    }\n          \n          \n            \n                    return toInnerField(name, type, false);\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                private static Field toInnerField(String name, Type type, boolean repeated)\n          \n          \n            \n                {\n          \n          \n            \n                    Field.Builder builder;\n          \n          \n            \n                    if (type instanceof RowType) {\n          \n          \n            \n                        builder = Field.newBuilder(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) type));\n          \n          \n            \n                    }\n          \n          \n            \n                    else {\n          \n          \n            \n                        builder = Field.newBuilder(name, toStandardSqlTypeName(type));\n          \n          \n            \n                    }\n          \n          \n            \n                    if (repeated) {\n          \n          \n            \n                        builder = builder.setMode(REPEATED);\n          \n          \n            \n                    }\n          \n          \n            \n                    return builder.build();\n          \n          \n            \n                }", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r581306326", "createdAt": "2021-02-23T18:57:45Z", "author": {"login": "losipiuk"}, "path": "plugin/trino-bigquery/src/main/java/io/trino/plugin/bigquery/BigQueryType.java", "diffHunk": "@@ -182,6 +194,75 @@ static String bytesToStringConverter(Object value)\n         return format(\"FROM_BASE64('%s')\", Base64.getEncoder().encodeToString(slice.getBytes()));\n     }\n \n+    public static Field toField(String name, Type type)\n+    {\n+        if (type instanceof ArrayType) {\n+            Type elementType = ((ArrayType) type).getElementType();\n+            return toInnerFieldBuilder(name, elementType).setMode(REPEATED).build();\n+        }\n+        return toInnerFieldBuilder(name, type).build();\n+    }\n+\n+    private static Field.Builder toInnerFieldBuilder(String name, Type type)\n+    {\n+        if (type instanceof RowType) {\n+            return Field.newBuilder(name, StandardSQLTypeName.STRUCT, toFieldList((RowType) type));\n+        }\n+        return Field.newBuilder(name, toStandardSqlTypeName(type));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk2Njk1MTU4", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-596695158", "createdAt": "2021-02-23T19:01:23Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0yM1QxOTowMToyM1rOIqYRUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0yM1QxOTowMToyM1rOIqYRUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTMwODc1Mw==", "bodyText": "let's not use random suffix here. In other tests we are not using that and we have perparatory  assertUpdate(\"DROP TABLE IF EXISTS \" + tableName); because of that.\nIf we use randomsuffixes we can pollute test environment and as far as I know we do not have any cleaner in place right now.", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r581308753", "createdAt": "2021-02-23T19:01:23Z", "author": {"login": "losipiuk"}, "path": "plugin/trino-bigquery/src/test/java/io/trino/plugin/bigquery/TestBigQueryIntegrationSmokeTest.java", "diffHunk": "@@ -61,6 +64,76 @@ public void testDescribeTable()\n         assertEquals(actualColumns, expectedColumns);\n     }\n \n+    @Test(dataProvider = \"createTableColumnTypes\")\n+    public void testCreateTableWithEveryType(String createType, String expectedType)\n+    {\n+        String tableName = \"test_types_table_\" + randomTableSuffix();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk2Njk1NTk1", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-596695595", "createdAt": "2021-02-23T19:01:50Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0yM1QxOTowMTo1MFrOIqYSZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0yM1QxOTowMTo1MFrOIqYSZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTMwOTAzMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            computeScalar(\"SElECT data_type FROM information_schema.columns WHERE table_name = '\" + tableName + \"' AND column_name = 'col1'\"),\n          \n          \n            \n                            computeScalar(\"SELECT data_type FROM information_schema.columns WHERE table_name = '\" + tableName + \"' AND column_name = 'col1'\"),", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r581309031", "createdAt": "2021-02-23T19:01:50Z", "author": {"login": "losipiuk"}, "path": "plugin/trino-bigquery/src/test/java/io/trino/plugin/bigquery/TestBigQueryIntegrationSmokeTest.java", "diffHunk": "@@ -61,6 +64,76 @@ public void testDescribeTable()\n         assertEquals(actualColumns, expectedColumns);\n     }\n \n+    @Test(dataProvider = \"createTableColumnTypes\")\n+    public void testCreateTableWithEveryType(String createType, String expectedType)\n+    {\n+        String tableName = \"test_types_table_\" + randomTableSuffix();\n+\n+        assertUpdate(\"DROP TABLE IF EXISTS \" + tableName);\n+\n+        assertUpdate(format(\"CREATE TABLE %s (col1 %s)\", tableName, createType));\n+\n+        assertEquals(\n+                computeScalar(\"SElECT data_type FROM information_schema.columns WHERE table_name = '\" + tableName + \"' AND column_name = 'col1'\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk2Njk2ODY2", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-596696866", "createdAt": "2021-02-23T19:03:17Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0yM1QxOTowMzoxN1rOIqYWcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0yM1QxOTowMzoxN1rOIqYWcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTMxMDA2NA==", "bodyText": "maybe some test for unsupported type?", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r581310064", "createdAt": "2021-02-23T19:03:17Z", "author": {"login": "losipiuk"}, "path": "plugin/trino-bigquery/src/test/java/io/trino/plugin/bigquery/TestBigQueryIntegrationSmokeTest.java", "diffHunk": "@@ -61,6 +64,76 @@ public void testDescribeTable()\n         assertEquals(actualColumns, expectedColumns);\n     }\n \n+    @Test(dataProvider = \"createTableColumnTypes\")\n+    public void testCreateTableWithEveryType(String createType, String expectedType)\n+    {\n+        String tableName = \"test_types_table_\" + randomTableSuffix();\n+\n+        assertUpdate(\"DROP TABLE IF EXISTS \" + tableName);\n+\n+        assertUpdate(format(\"CREATE TABLE %s (col1 %s)\", tableName, createType));\n+\n+        assertEquals(\n+                computeScalar(\"SElECT data_type FROM information_schema.columns WHERE table_name = '\" + tableName + \"' AND column_name = 'col1'\"),\n+                expectedType);\n+\n+        assertUpdate(\"DROP TABLE \" + tableName);\n+    }\n+\n+    @DataProvider\n+    public Object[][] createTableColumnTypes()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk2NzAwMDY0", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-596700064", "createdAt": "2021-02-23T19:07:01Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0yM1QxOTowNzowMVrOIqYfuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0yM1QxOTowNzowMVrOIqYfuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTMxMjQ0Mw==", "bodyText": "add test checking that CREATE TABLE fails if table already exists and CREATE TABLE IF NOT EXISTS works fine as a noop.", "url": "https://github.com/trinodb/trino/pull/3767#discussion_r581312443", "createdAt": "2021-02-23T19:07:01Z", "author": {"login": "losipiuk"}, "path": "plugin/trino-bigquery/src/test/java/io/trino/plugin/bigquery/TestBigQueryIntegrationSmokeTest.java", "diffHunk": "@@ -61,6 +64,76 @@ public void testDescribeTable()\n         assertEquals(actualColumns, expectedColumns);\n     }\n \n+    @Test(dataProvider = \"createTableColumnTypes\")\n+    public void testCreateTableWithEveryType(String createType, String expectedType)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk2NzAwMzQ2", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-596700346", "createdAt": "2021-02-23T19:07:21Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "515b5f9920cf8498b7e1fa74a3c8d95336fdc4b0", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/515b5f9920cf8498b7e1fa74a3c8d95336fdc4b0", "committedDate": "2021-02-28T11:22:56Z", "message": "Add support for CREATE and DROP TABLE in BigQuery"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "515b5f9920cf8498b7e1fa74a3c8d95336fdc4b0", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/515b5f9920cf8498b7e1fa74a3c8d95336fdc4b0", "committedDate": "2021-02-28T11:22:56Z", "message": "Add support for CREATE and DROP TABLE in BigQuery"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjAwNDk2ODE4", "url": "https://github.com/trinodb/trino/pull/3767#pullrequestreview-600496818", "createdAt": "2021-03-01T08:44:33Z", "commit": {"oid": "515b5f9920cf8498b7e1fa74a3c8d95336fdc4b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1141, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}