{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NzUzNDQ3", "number": 5636, "title": "Enforce hive.translate-hive-views propertry", "bodyText": "Fixes #5623", "createdAt": "2020-10-21T17:52:38Z", "url": "https://github.com/trinodb/trino/pull/5636", "merged": true, "mergeCommit": {"oid": "f4eb7f06a4289138337ba39f3ad0f1a0c453da6c"}, "closed": true, "closedAt": "2020-10-23T16:48:48Z", "author": {"login": "phd3"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUxL3pABqjM5MDUyMDg3Mjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVXYcxABqjM5MTQyMDMyMzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MDQwNTMy", "url": "https://github.com/trinodb/trino/pull/5636#pullrequestreview-514040532", "createdAt": "2020-10-21T18:05:18Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxODowNToxOFrOHl7aGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxODowNToxOFrOHl7aGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUzMjY5Ng==", "bodyText": "Can we please have some test for that?", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r509532696", "createdAt": "2020-10-21T18:05:18Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveMetadata.java", "diffHunk": "@@ -1856,6 +1856,10 @@ public void dropView(ConnectorSession session, SchemaTableName viewName)\n         return metastore.getTable(new HiveIdentity(session), viewName.getSchemaName(), viewName.getTableName())\n                 .filter(ViewReaderUtil::canDecodeView)\n                 .map(view -> {\n+                    if (!translateHiveViews && !isPrestoView(view)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NDQyOTgw", "url": "https://github.com/trinodb/trino/pull/5636#pullrequestreview-514442980", "createdAt": "2020-10-22T07:43:06Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNzo0MzowNlrOHmUqRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNzo0MzowNlrOHmUqRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk0NjQzNw==", "bodyText": "It would be nice add a test where changing config property would actually return a view here.\nWe have product tests for that, so if adding a test here is problematic then maybe a comment would be enough.", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r509946437", "createdAt": "2020-10-22T07:43:06Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/AbstractTestHive.java", "diffHunk": "@@ -2556,6 +2557,38 @@ public void testViewCreation()\n         }\n     }\n \n+    @Test\n+    public void testHiveViewTranslationError()\n+    {\n+        String tableName = \"test_hive_view\";\n+        ConnectorSession session = newSession();\n+        Table table = Table.builder()\n+                .setDatabaseName(database)\n+                .setTableName(tableName)\n+                .setOwner(session.getUser())\n+                // Create a view without using PRESTO_VIEW_FLAG\n+                .setTableType(TableType.VIRTUAL_VIEW.name())\n+                .setDataColumns(ImmutableList.of(new Column(\"dummy\", HIVE_STRING, Optional.empty())))\n+                .setPartitionColumns(ImmutableList.of())\n+                .setViewOriginalText(Optional.of(\"SELECT 'a'\"))\n+                .withStorage(storage -> storage.setStorageFormat(VIEW_STORAGE_FORMAT)\n+                        .setLocation(\"\")\n+                        .build())\n+                .build();\n+\n+        metastoreClient.createTable(new HiveIdentity(session), table, testingPrincipalPrivilege(session));\n+\n+        try (Transaction transaction = newTransaction()) {\n+            ConnectorMetadata metadata = transaction.getMetadata();\n+            assertThatThrownBy(() -> metadata.getView(session, new SchemaTableName(database, tableName)))\n+                    .isInstanceOf(HiveViewNotSupportedException.class)\n+                    .hasMessageContaining(\"Hive views are not supported\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTYxMjY1", "url": "https://github.com/trinodb/trino/pull/5636#pullrequestreview-515161265", "createdAt": "2020-10-22T22:22:47Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMjoyMjo0N1rOHm18KA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMjozMDowOFrOHm2Gqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5MTY4OA==", "bodyText": "We shouldn't need any view specific logic in the metastore, as the metastore's job is to simply store/retrieve the table metadata. This specific check seems to be a sanity check that the file metastore doesn't contain a Hive view, but that should be impossible since the code is only used by Presto.", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510491688", "createdAt": "2020-10-22T22:22:47Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/file/FileHiveMetastore.java", "diffHunk": "@@ -314,7 +316,15 @@ else if (table.getTableType().equals(EXTERNAL_TABLE.name())) {\n     @Override\n     public synchronized Optional<Table> getTable(HiveIdentity identity, String databaseName, String tableName)\n     {\n-        return getTable(databaseName, tableName);\n+        Optional<Table> optionalTable = getTable(databaseName, tableName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5MjA0Mw==", "bodyText": "Similar to the other comment, this check should be done in HiveMetadata where the translation occurs.", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510492043", "createdAt": "2020-10-22T22:23:53Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/thrift/ThriftHiveMetastore.java", "diffHunk": "@@ -343,6 +343,14 @@ public ThriftMetastoreStats getStats()\n                     .stopOnIllegalExceptions()\n                     .run(\"getTable\", stats.getGetTable().wrap(() -> {\n                         Table table = getTableFromMetastore(identity, databaseName, tableName);\n+\n+                        // Check if hive view is supported\n+                        if (!translateHiveViews", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5NDM3OA==", "bodyText": "We shouldn't need to create a new Hive view here, as these tests already create presto_test_view (referenced by the view field in this class). It should be enough to call\nmetadata.getView(session, view);", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510494378", "createdAt": "2020-10-22T22:30:08Z", "author": {"login": "electrum"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/AbstractTestHive.java", "diffHunk": "@@ -2556,6 +2557,40 @@ public void testViewCreation()\n         }\n     }\n \n+    @Test\n+    public void testHiveViewTranslationError()\n+    {\n+        String tableName = \"test_hive_view\";\n+        ConnectorSession session = newSession();\n+        Table table = Table.builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MjA5NDIw", "url": "https://github.com/trinodb/trino/pull/5636#pullrequestreview-515209420", "createdAt": "2020-10-23T00:41:30Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMDo0MTozMFrOHm4liQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMDo0MTozMFrOHm4liQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUzNTA0OQ==", "bodyText": "as per @mosabua 's comment: #5623 (comment)", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510535049", "createdAt": "2020-10-23T00:41:30Z", "author": {"login": "phd3"}, "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -306,6 +306,8 @@ Property Name                                      Description\n ``hive.temporary-staging-directory-path``          Controls the location of temporary staging directory that    ``/tmp/${USER}``\n                                                    is used for write operations. The ``${USER}`` placeholder\n                                                    can be used to use a different location for each user.\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NzAwMDk5", "url": "https://github.com/trinodb/trino/pull/5636#pullrequestreview-515700099", "createdAt": "2020-10-23T14:06:15Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNDowNjoxNlrOHnPYVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNDowNjoxNlrOHnPYVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkwODUwMA==", "bodyText": "Please capitalize Hive", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510908500", "createdAt": "2020-10-23T14:06:16Z", "author": {"login": "electrum"}, "path": "presto-docs/src/main/sphinx/connector/hive.rst", "diffHunk": "@@ -306,6 +306,8 @@ Property Name                                      Description\n ``hive.temporary-staging-directory-path``          Controls the location of temporary staging directory that    ``/tmp/${USER}``\n                                                    is used for write operations. The ``${USER}`` placeholder\n                                                    can be used to use a different location for each user.\n+\n+``hive.translate-hive-views``                      Enable translation for hive views. (experimental)            ``false``", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NzAxNzYy", "url": "https://github.com/trinodb/trino/pull/5636#pullrequestreview-515701762", "createdAt": "2020-10-23T14:08:09Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NzA0MTU5", "url": "https://github.com/trinodb/trino/pull/5636#pullrequestreview-515704159", "createdAt": "2020-10-23T14:10:55Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNDoxMDo1NVrOHnPkSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNDoxMDo1NVrOHnPkSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkxMTU2MQ==", "bodyText": "currently not possible ...\n\nthis is not true, it is possible (#5636 (comment))\nat most, we decided not to do this\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // TODO: combine this with tests for successful translation in TestHiveViews product test, it is\n          \n          \n            \n                        // currently not possible because translation is not controlled by a session property\n          \n          \n            \n                        // TODO: combine this with tests for successful translation in TestHiveViews product test", "url": "https://github.com/trinodb/trino/pull/5636#discussion_r510911561", "createdAt": "2020-10-23T14:10:55Z", "author": {"login": "findepi"}, "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/TestHive.java", "diffHunk": "@@ -80,4 +81,17 @@ public void testHideDeltaLakeTables()\n \n         throw new SkipException(\"not supported\");\n     }\n+\n+    @Test\n+    public void testHiveViewTranslationError()\n+    {\n+        try (Transaction transaction = newTransaction()) {\n+            assertThatThrownBy(() -> transaction.getMetadata().getView(newSession(), view))\n+                    .isInstanceOf(HiveViewNotSupportedException.class)\n+                    .hasMessageContaining(\"Hive views are not supported\");\n+\n+            // TODO: combine this with tests for successful translation in TestHiveViews product test, it is\n+            // currently not possible because translation is not controlled by a session property", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "7be6a0f7c12044bb7d74d6ed41faa143c3538214", "author": {"user": {"login": "phd3", "name": "Pratham"}}, "url": "https://github.com/trinodb/trino/commit/7be6a0f7c12044bb7d74d6ed41faa143c3538214", "committedDate": "2020-10-23T14:21:28Z", "message": "Enforce hive.translate-hive-views propertry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20961dc4aa168f87c8ba7e8d5f6f4d815b6b5b9e", "author": {"user": {"login": "phd3", "name": "Pratham"}}, "url": "https://github.com/trinodb/trino/commit/20961dc4aa168f87c8ba7e8d5f6f4d815b6b5b9e", "committedDate": "2020-10-23T14:22:34Z", "message": "Add documentation for hive.translate-hive-views"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "20961dc4aa168f87c8ba7e8d5f6f4d815b6b5b9e", "author": {"user": {"login": "phd3", "name": "Pratham"}}, "url": "https://github.com/trinodb/trino/commit/20961dc4aa168f87c8ba7e8d5f6f4d815b6b5b9e", "committedDate": "2020-10-23T14:22:34Z", "message": "Add documentation for hive.translate-hive-views"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3067, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}