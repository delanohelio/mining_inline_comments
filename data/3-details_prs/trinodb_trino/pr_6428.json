{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0NzE0MDMx", "number": 6428, "title": "Support JWK with certificate chain", "bodyText": "JWK can contain arrays, for example: x5c which represents the x.509 certificate chain (https://auth0.com/docs/tokens/json-web-tokens/json-web-key-set-properties).\nFixes #6290", "createdAt": "2020-12-23T10:59:47Z", "url": "https://github.com/trinodb/trino/pull/6428", "merged": true, "mergeCommit": {"oid": "bc312ab040f5f2ed49c31730fcb04b23214bc4a9"}, "closed": true, "closedAt": "2021-01-07T11:01:11Z", "author": {"login": "lukasz-walkiewicz"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdo9sFZAFqTU1NzgwODcyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtyBskAFqTU2MzM5NjU5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3ODA4NzI1", "url": "https://github.com/trinodb/trino/pull/6428#pullrequestreview-557808725", "createdAt": "2020-12-23T11:22:24Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxMToyMjoyNFrOIKhy_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxMTozNzoyOVrOIKiIGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxMDM5Nw==", "bodyText": "static import?", "url": "https://github.com/trinodb/trino/pull/6428#discussion_r547910397", "createdAt": "2020-12-23T11:22:24Z", "author": {"login": "s2lomon"}, "path": "presto-main/src/main/java/io/prestosql/server/security/jwt/JwkDecoder.java", "diffHunk": "@@ -52,84 +56,104 @@ private JwkDecoder() {}\n                 .collect(toImmutableMap(JwkPublicKey::getKeyId, Function.identity()));\n     }\n \n-    public static Optional<? extends JwkPublicKey> tryDecodeJwkKey(Map<String, String> properties)\n+    public static Optional<? extends JwkPublicKey> tryDecodeJwkKey(Key key)\n     {\n-        String keyId = properties.get(\"kid\");\n-        if (Strings.isNullOrEmpty(keyId)) {\n-            // key id is required to index the key\n+        // key id is required to index the key\n+        if (key.getKid().filter(Predicate.not(String::isEmpty)).isEmpty()) {\n             return Optional.empty();\n         }\n-\n-        String keyType = properties.get(\"kty\");\n-        switch (keyType) {\n+        switch (key.getKty()) {\n             case \"RSA\":\n-                return tryDecodeRsaKey(keyId, properties);\n+                return tryDecodeRsaKey(key.getKid().get(), key);\n             case \"EC\":\n-                return tryDecodeEcKey(keyId, properties);\n+                return tryDecodeEcKey(key.getKid().get(), key);\n             default:\n                 // ignore non unknown keys\n                 return Optional.empty();\n         }\n     }\n \n-    public static Optional<JwkRsaPublicKey> tryDecodeRsaKey(String keyId, Map<String, String> properties)\n+    public static Optional<JwkRsaPublicKey> tryDecodeRsaKey(String keyId, Key key)\n     {\n         // alg field is optional so not verified\n         // use field is optional so not verified\n \n-        String encodedModulus = properties.get(\"n\");\n-        if (Strings.isNullOrEmpty(encodedModulus)) {\n+        Object encodedModulus = key.getOther().get(\"n\");\n+        if (!(encodedModulus instanceof String)) {\n+            log.error(\"JWK RSA key %s contains invalid value '%s' for modulus field 'n'\", keyId, encodedModulus);\n+            return Optional.empty();\n+        }\n+        if (Strings.isNullOrEmpty((String) encodedModulus)) {\n             log.error(\"JWK RSA key %s does not contain the required modulus field 'n'\", keyId);\n             return Optional.empty();\n         }\n-        String encodedExponent = properties.get(\"e\");\n-        if (Strings.isNullOrEmpty(encodedExponent)) {\n+\n+        Object encodedExponent = key.getOther().get(\"e\");\n+        if (!(encodedExponent instanceof String)) {\n+            log.error(\"JWK RSA key %s contains invalid value '%s' for exponent field 'e'\", keyId, encodedExponent);\n+            return Optional.empty();\n+        }\n+        if (Strings.isNullOrEmpty((String) encodedExponent)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxNTgwMg==", "bodyText": "if(key.getKid().map(String::isEmpty).orElse(true)) maybe? I find calculating the boolean from Optional state after filter a bit too convoluted for me.\nActually, why not inlining it?\n    Optional<String> kid = key.getKid().filter(not(String::isEmpty)));\n    switch (key.getKty()) {\n          case \"RSA\":  \n               return kid.map(k -> tryDecodeRsaKey(k, key));\n          case \"EC\":\n               return kid.map(k -> tryDecodeEcKey(k, key))\n          default:\n              // ignore non unknown keys\n              return Optional.empty();\n      }", "url": "https://github.com/trinodb/trino/pull/6428#discussion_r547915802", "createdAt": "2020-12-23T11:37:29Z", "author": {"login": "s2lomon"}, "path": "presto-main/src/main/java/io/prestosql/server/security/jwt/JwkDecoder.java", "diffHunk": "@@ -52,84 +56,104 @@ private JwkDecoder() {}\n                 .collect(toImmutableMap(JwkPublicKey::getKeyId, Function.identity()));\n     }\n \n-    public static Optional<? extends JwkPublicKey> tryDecodeJwkKey(Map<String, String> properties)\n+    public static Optional<? extends JwkPublicKey> tryDecodeJwkKey(Key key)\n     {\n-        String keyId = properties.get(\"kid\");\n-        if (Strings.isNullOrEmpty(keyId)) {\n-            // key id is required to index the key\n+        // key id is required to index the key\n+        if (key.getKid().filter(Predicate.not(String::isEmpty)).isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MDg4OTY3", "url": "https://github.com/trinodb/trino/pull/6428#pullrequestreview-558088967", "createdAt": "2020-12-23T16:50:22Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNjo1MDoyMlrOIKqVWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNzowNDowMVrOIKqrCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA1MDI2Ng==", "bodyText": "I'm guessing you already tried, but can this be a constructor argument?", "url": "https://github.com/trinodb/trino/pull/6428#discussion_r548050266", "createdAt": "2020-12-23T16:50:22Z", "author": {"login": "dain"}, "path": "presto-main/src/main/java/io/prestosql/server/security/jwt/JwkDecoder.java", "diffHunk": "@@ -259,17 +283,55 @@ public String getFormat()\n \n     public static class Keys\n     {\n-        private final List<Map<String, String>> keys;\n+        private final List<Key> keys;\n \n         @JsonCreator\n-        public Keys(@JsonProperty(\"keys\") List<Map<String, String>> keys)\n+        public Keys(@JsonProperty(\"keys\") List<Key> keys)\n         {\n             this.keys = ImmutableList.copyOf(requireNonNull(keys, \"keys is null\"));\n         }\n \n-        public List<Map<String, String>> getKeys()\n+        public List<Key> getKeys()\n         {\n             return keys;\n         }\n     }\n+\n+    public static class Key\n+    {\n+        private final String kty;\n+        private final Optional<String> kid;\n+        private final Map<String, Object> other = new HashMap<>();\n+\n+        @JsonCreator\n+        public Key(\n+                @JsonProperty(\"kty\") String kty,\n+                @JsonProperty(\"kid\") Optional<String> kid)\n+        {\n+            this.kty = requireNonNull(kty, \"kty is null\");\n+            this.kid = requireNonNull(kid, \"kid is null\");\n+        }\n+\n+        public String getKty()\n+        {\n+            return kty;\n+        }\n+\n+        public Optional<String> getKid()\n+        {\n+            return kid;\n+        }\n+\n+        @JsonAnyGetter\n+        public Map<String, Object> getOther()\n+        {\n+            return other;\n+        }\n+\n+        @JsonAnySetter\n+        public void set(String name, Object value)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 211}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA1MzgzNA==", "bodyText": "I don't think you need this annotation because the class not designed for writing (for example the kty and kid fields don't write)", "url": "https://github.com/trinodb/trino/pull/6428#discussion_r548053834", "createdAt": "2020-12-23T16:58:57Z", "author": {"login": "dain"}, "path": "presto-main/src/main/java/io/prestosql/server/security/jwt/JwkDecoder.java", "diffHunk": "@@ -259,17 +283,55 @@ public String getFormat()\n \n     public static class Keys\n     {\n-        private final List<Map<String, String>> keys;\n+        private final List<Key> keys;\n \n         @JsonCreator\n-        public Keys(@JsonProperty(\"keys\") List<Map<String, String>> keys)\n+        public Keys(@JsonProperty(\"keys\") List<Key> keys)\n         {\n             this.keys = ImmutableList.copyOf(requireNonNull(keys, \"keys is null\"));\n         }\n \n-        public List<Map<String, String>> getKeys()\n+        public List<Key> getKeys()\n         {\n             return keys;\n         }\n     }\n+\n+    public static class Key\n+    {\n+        private final String kty;\n+        private final Optional<String> kid;\n+        private final Map<String, Object> other = new HashMap<>();\n+\n+        @JsonCreator\n+        public Key(\n+                @JsonProperty(\"kty\") String kty,\n+                @JsonProperty(\"kid\") Optional<String> kid)\n+        {\n+            this.kty = requireNonNull(kty, \"kty is null\");\n+            this.kid = requireNonNull(kid, \"kid is null\");\n+        }\n+\n+        public String getKty()\n+        {\n+            return kty;\n+        }\n+\n+        public Optional<String> getKid()\n+        {\n+            return kid;\n+        }\n+\n+        @JsonAnyGetter", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 204}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA1NTgxOQ==", "bodyText": "It looks like every usage of this is of the form:\nObject encodedY = key.getOther().get(\"y\");\nif (!(encodedY instanceof String)) {\n    log.error(\"something about property being an invalid value\");\n    return Optional.empty();\n}\nif (isNullOrEmpty((String) encodedY)) {\n    log.error(\"something the key not containing a required property\");\n    return Optional.empty();\n}\n\nI just added the extra detailed logging because it was easy.\nI suggest we simplify this code to a method on the getter that tests if the value is a non empty string.  If it is not we return Optional.empty() otherwise we return the value.  Something like:\npublic Optional<String> getStringProperty(String name) {\n    Object value = other.get(name);\n    if (value instanceof String && !((String)value).isEmpty) {\n        return Optional.of(value);\n    }\n    return Optional.empty();\n}", "url": "https://github.com/trinodb/trino/pull/6428#discussion_r548055819", "createdAt": "2020-12-23T17:04:01Z", "author": {"login": "dain"}, "path": "presto-main/src/main/java/io/prestosql/server/security/jwt/JwkDecoder.java", "diffHunk": "@@ -259,17 +283,55 @@ public String getFormat()\n \n     public static class Keys\n     {\n-        private final List<Map<String, String>> keys;\n+        private final List<Key> keys;\n \n         @JsonCreator\n-        public Keys(@JsonProperty(\"keys\") List<Map<String, String>> keys)\n+        public Keys(@JsonProperty(\"keys\") List<Key> keys)\n         {\n             this.keys = ImmutableList.copyOf(requireNonNull(keys, \"keys is null\"));\n         }\n \n-        public List<Map<String, String>> getKeys()\n+        public List<Key> getKeys()\n         {\n             return keys;\n         }\n     }\n+\n+    public static class Key\n+    {\n+        private final String kty;\n+        private final Optional<String> kid;\n+        private final Map<String, Object> other = new HashMap<>();\n+\n+        @JsonCreator\n+        public Key(\n+                @JsonProperty(\"kty\") String kty,\n+                @JsonProperty(\"kid\") Optional<String> kid)\n+        {\n+            this.kty = requireNonNull(kty, \"kty is null\");\n+            this.kid = requireNonNull(kid, \"kid is null\");\n+        }\n+\n+        public String getKty()\n+        {\n+            return kty;\n+        }\n+\n+        public Optional<String> getKid()\n+        {\n+            return kid;\n+        }\n+\n+        @JsonAnyGetter\n+        public Map<String, Object> getOther()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 205}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MjM3MjAw", "url": "https://github.com/trinodb/trino/pull/6428#pullrequestreview-558237200", "createdAt": "2020-12-23T21:31:58Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4OTQ1NjM3", "url": "https://github.com/trinodb/trino/pull/6428#pullrequestreview-558945637", "createdAt": "2020-12-27T17:36:00Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyOTk3MTUz", "url": "https://github.com/trinodb/trino/pull/6428#pullrequestreview-562997153", "createdAt": "2021-01-06T19:51:53Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00414e61c20334b3770e01bb2f3c7fb28e7992aa", "author": {"user": {"login": "lukasz-walkiewicz", "name": "\u0141ukasz Walkiewicz"}}, "url": "https://github.com/trinodb/trino/commit/00414e61c20334b3770e01bb2f3c7fb28e7992aa", "committedDate": "2021-01-07T09:47:59Z", "message": "Support JWK with certificate chain"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "00414e61c20334b3770e01bb2f3c7fb28e7992aa", "author": {"user": {"login": "lukasz-walkiewicz", "name": "\u0141ukasz Walkiewicz"}}, "url": "https://github.com/trinodb/trino/commit/00414e61c20334b3770e01bb2f3c7fb28e7992aa", "committedDate": "2021-01-07T09:47:59Z", "message": "Support JWK with certificate chain"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMzk2NTk0", "url": "https://github.com/trinodb/trino/pull/6428#pullrequestreview-563396594", "createdAt": "2021-01-07T11:00:56Z", "commit": {"oid": "00414e61c20334b3770e01bb2f3c7fb28e7992aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1913, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}