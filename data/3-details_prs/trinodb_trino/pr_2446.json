{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNzIyNzg2", "number": 2446, "title": "Add deprecated function warning", "bodyText": "Generate a warning when a query is using a @Deprecated function.\nThis works for annotated Scalar, Parametric Scalar, Aggregation, Window functions.\nBoth built-in UDFs and UDFs from plugin are supported.\nDoesn't work for classes that are directly implements SqlFunction without using annotation.\nThis feature can be enabled by the feature flag analyzer.query-diagnosis-warning-enabled or enable_query_diagnosis_warning session. Default is not enabled.\nI have two questions:\n\nIs the feature flag needed?\nShould this function be default ON / OFF?\n\n@Deprecated\n@ScalarFunction(\"deprecated_function\")\npublic static Slice funcABC() { ... }\npresto> SELECT deprecated_function();\n.....\n(1 row)\n\nWARNING: Detected use of deprecated function: deprecated_function\nSupersedes #1006", "createdAt": "2020-01-09T01:04:06Z", "url": "https://github.com/trinodb/trino/pull/2446", "merged": true, "mergeCommit": {"oid": "8e242e803dd97f3b471f9852d3bd8afe2e6c7763"}, "closed": true, "closedAt": "2020-01-22T19:54:27Z", "author": {"login": "oneonestar"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4gcHzABqjI5MzMzNzE4MjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8r_abABqjI5Njg0NDY5MTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MzA1NTgy", "url": "https://github.com/trinodb/trino/pull/2446#pullrequestreview-344305582", "createdAt": "2020-01-17T00:40:26Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMDo0MDoyNlrOFer20g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMDo0NjoyMVrOFer8cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcyMDE0Ng==", "bodyText": "This should be done in the analyzer, not during query optimization. The check should go in ExpressionAnalyzer.visitFunctionCall.", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r367720146", "createdAt": "2020-01-17T00:40:26Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/sanity/warnings/DeprecatedFunctionWarning.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.sql.planner.sanity.warnings;\n+\n+import io.prestosql.Session;\n+import io.prestosql.execution.warnings.WarningCollector;\n+import io.prestosql.metadata.FunctionMetadata;\n+import io.prestosql.metadata.Metadata;\n+import io.prestosql.metadata.ResolvedFunction;\n+import io.prestosql.spi.PrestoWarning;\n+import io.prestosql.sql.planner.ExpressionExtractor;\n+import io.prestosql.sql.planner.SimplePlanVisitor;\n+import io.prestosql.sql.planner.TypeAnalyzer;\n+import io.prestosql.sql.planner.TypeProvider;\n+import io.prestosql.sql.planner.plan.AggregationNode;\n+import io.prestosql.sql.planner.plan.PlanNode;\n+import io.prestosql.sql.planner.plan.WindowNode;\n+import io.prestosql.sql.planner.sanity.PlanSanityChecker;\n+import io.prestosql.sql.tree.DefaultTraversalVisitor;\n+import io.prestosql.sql.tree.Expression;\n+import io.prestosql.sql.tree.FunctionCall;\n+\n+import java.util.Optional;\n+\n+import static io.prestosql.spi.connector.StandardWarningCode.DREPRCATED_FUNCTION;\n+\n+public final class DeprecatedFunctionWarning\n+        implements PlanSanityChecker.Checker\n+{\n+    @Override\n+    public void validate(PlanNode plan, Session session, Metadata metadata, TypeAnalyzer typeAnalyzer, TypeProvider types, WarningCollector warningCollector)\n+    {\n+        for (Expression expression : ExpressionExtractor.extractExpressions(plan)) {\n+            new DefaultTraversalVisitor<Void, Void>()\n+            {\n+                @Override\n+                protected Void visitFunctionCall(FunctionCall node, Void context)\n+                {\n+                    Optional<ResolvedFunction> resolvedFunction = ResolvedFunction.fromQualifiedName(node.getName());\n+                    if (resolvedFunction.isPresent()) {\n+                        FunctionMetadata functionMetadata = metadata.getFunctionMetadata(resolvedFunction.get());\n+                        if (functionMetadata.isDeprecated()) {\n+                            warningCollector.add(new PrestoWarning(DREPRCATED_FUNCTION,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcyMDI4NA==", "bodyText": "What's the purpose of this session property?", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r367720284", "createdAt": "2020-01-17T00:40:58Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/SystemSessionProperties.java", "diffHunk": "@@ -552,6 +553,11 @@ public SystemSessionProperties(\n                         IGNORE_DOWNSTREAM_PREFERENCES,\n                         \"Ignore Parent's PreferredProperties in AddExchange optimizer\",\n                         featuresConfig.isIgnoreDownstreamPreferences(),\n+                        false),\n+                booleanProperty(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcyMTM2MA==", "bodyText": "Ideally, the deprecation message should be able to contain instructions about the reason for deprecation and possible substitutions. So, we'll need to capture this information in the deprecation annotation. Since @Deprecated doesn't take a description, we might need an additional annotation.", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r367721360", "createdAt": "2020-01-17T00:45:34Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/sanity/warnings/DeprecatedFunctionWarning.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.sql.planner.sanity.warnings;\n+\n+import io.prestosql.Session;\n+import io.prestosql.execution.warnings.WarningCollector;\n+import io.prestosql.metadata.FunctionMetadata;\n+import io.prestosql.metadata.Metadata;\n+import io.prestosql.metadata.ResolvedFunction;\n+import io.prestosql.spi.PrestoWarning;\n+import io.prestosql.sql.planner.ExpressionExtractor;\n+import io.prestosql.sql.planner.SimplePlanVisitor;\n+import io.prestosql.sql.planner.TypeAnalyzer;\n+import io.prestosql.sql.planner.TypeProvider;\n+import io.prestosql.sql.planner.plan.AggregationNode;\n+import io.prestosql.sql.planner.plan.PlanNode;\n+import io.prestosql.sql.planner.plan.WindowNode;\n+import io.prestosql.sql.planner.sanity.PlanSanityChecker;\n+import io.prestosql.sql.tree.DefaultTraversalVisitor;\n+import io.prestosql.sql.tree.Expression;\n+import io.prestosql.sql.tree.FunctionCall;\n+\n+import java.util.Optional;\n+\n+import static io.prestosql.spi.connector.StandardWarningCode.DREPRCATED_FUNCTION;\n+\n+public final class DeprecatedFunctionWarning\n+        implements PlanSanityChecker.Checker\n+{\n+    @Override\n+    public void validate(PlanNode plan, Session session, Metadata metadata, TypeAnalyzer typeAnalyzer, TypeProvider types, WarningCollector warningCollector)\n+    {\n+        for (Expression expression : ExpressionExtractor.extractExpressions(plan)) {\n+            new DefaultTraversalVisitor<Void, Void>()\n+            {\n+                @Override\n+                protected Void visitFunctionCall(FunctionCall node, Void context)\n+                {\n+                    Optional<ResolvedFunction> resolvedFunction = ResolvedFunction.fromQualifiedName(node.getName());\n+                    if (resolvedFunction.isPresent()) {\n+                        FunctionMetadata functionMetadata = metadata.getFunctionMetadata(resolvedFunction.get());\n+                        if (functionMetadata.isDeprecated()) {\n+                            warningCollector.add(new PrestoWarning(DREPRCATED_FUNCTION,\n+                                    String.format(\"Detected use of deprecated function: %s\", functionMetadata.getSignature().getName())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcyMTU4NA==", "bodyText": "Typo: DREPRCATED", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r367721584", "createdAt": "2020-01-17T00:46:21Z", "author": {"login": "martint"}, "path": "presto-spi/src/main/java/io/prestosql/spi/connector/StandardWarningCode.java", "diffHunk": "@@ -21,6 +21,7 @@\n {\n     TOO_MANY_STAGES(0x0000_0001),\n     REDUNDANT_ORDER_BY(0x0000_0002),\n+    DREPRCATED_FUNCTION(0x0000_0003),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTE1MzY3", "url": "https://github.com/trinodb/trino/pull/2446#pullrequestreview-345515367", "createdAt": "2020-01-20T20:14:22Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDoxNDoyM1rOFfoX6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDoxNDoyM1rOFfoX6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcxMTY1Ng==", "bodyText": "deprecated. It should", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r368711656", "createdAt": "2020-01-20T20:14:23Z", "author": {"login": "mosabua"}, "path": "presto-docs/src/main/sphinx/develop/functions.rst", "diffHunk": "@@ -282,3 +282,25 @@ function follows:\n   is used when performing a ``GROUP BY`` aggregation, and an implementation\n   will be automatically generated for you, if you don't specify a\n   ``AccumulatorStateFactory``\n+\n+Deprecated Function\n+-------------------\n+\n+The ``@Deprecated`` annotation can be used to mark a function as deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTE1NDQz", "url": "https://github.com/trinodb/trino/pull/2446#pullrequestreview-345515443", "createdAt": "2020-01-20T20:14:36Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDoxNDozNlrOFfoYGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDoxNDozNlrOFfoYGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcxMTcwNQ==", "bodyText": "Presto generates", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r368711705", "createdAt": "2020-01-20T20:14:36Z", "author": {"login": "mosabua"}, "path": "presto-docs/src/main/sphinx/develop/functions.rst", "diffHunk": "@@ -282,3 +282,25 @@ function follows:\n   is used when performing a ``GROUP BY`` aggregation, and an implementation\n   will be automatically generated for you, if you don't specify a\n   ``AccumulatorStateFactory``\n+\n+Deprecated Function\n+-------------------\n+\n+The ``@Deprecated`` annotation can be used to mark a function as deprecated\n+and should no longer be used. Presto will generates a warning whenever a SQL", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTE3MzA1", "url": "https://github.com/trinodb/trino/pull/2446#pullrequestreview-345517305", "createdAt": "2020-01-20T20:20:10Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDoyMDoxMVrOFfodxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDoyMDoxMVrOFfodxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcxMzE1Nw==", "bodyText": "When a functions is deprecated, the @Description needs to be replaced with a note about the deprecation and the replacement function:", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r368713157", "createdAt": "2020-01-20T20:20:11Z", "author": {"login": "mosabua"}, "path": "presto-docs/src/main/sphinx/develop/functions.rst", "diffHunk": "@@ -282,3 +282,25 @@ function follows:\n   is used when performing a ``GROUP BY`` aggregation, and an implementation\n   will be automatically generated for you, if you don't specify a\n   ``AccumulatorStateFactory``\n+\n+Deprecated Function\n+-------------------\n+\n+The ``@Deprecated`` annotation can be used to mark a function as deprecated\n+and should no longer be used. Presto will generates a warning whenever a SQL\n+uses a deprecated function. When a function is deprecated, it should also be", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 10}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTE2Mjcw", "url": "https://github.com/trinodb/trino/pull/2446#pullrequestreview-345516270", "createdAt": "2020-01-20T20:17:08Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDoxNzowOFrOFfoanA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDo1MToxNVrOFgIZIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcxMjM0OA==", "bodyText": "Use a more descriptive name than c.", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r368712348", "createdAt": "2020-01-20T20:17:08Z", "author": {"login": "martint"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestDeprecatedFunctionWarning.java", "diffHunk": "@@ -0,0 +1,296 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.Session;\n+import io.prestosql.client.Warning;\n+import io.prestosql.operator.aggregation.state.LongAndDoubleState;\n+import io.prestosql.operator.window.RankFunction;\n+import io.prestosql.spi.WarningCode;\n+import io.prestosql.spi.block.BlockBuilder;\n+import io.prestosql.spi.connector.StandardWarningCode;\n+import io.prestosql.spi.function.AggregationFunction;\n+import io.prestosql.spi.function.CombineFunction;\n+import io.prestosql.spi.function.Description;\n+import io.prestosql.spi.function.InputFunction;\n+import io.prestosql.spi.function.OutputFunction;\n+import io.prestosql.spi.function.ScalarFunction;\n+import io.prestosql.spi.function.SqlNullable;\n+import io.prestosql.spi.function.SqlType;\n+import io.prestosql.spi.function.TypeParameter;\n+import io.prestosql.spi.function.WindowFunctionSignature;\n+import io.prestosql.spi.type.StandardTypes;\n+import io.prestosql.testing.QueryRunner;\n+import org.intellij.lang.annotations.Language;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import static com.google.common.collect.ImmutableSet.toImmutableSet;\n+import static io.prestosql.execution.TestQueryRunnerUtil.createQueryRunner;\n+import static io.prestosql.metadata.FunctionExtractor.extractFunctions;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.testng.Assert.fail;\n+\n+public class TestDeprecatedFunctionWarning\n+{\n+    private static final WarningCode DEPRECATED_FUNCTION_WARNING_CODE = StandardWarningCode.DEPRECATED_FUNCTION.toWarningCode();\n+    private static final String EXPECTED_WARNING_MSG = \"(DEPRECATED) Use foo() instead.\";\n+\n+    private QueryRunner queryRunner;\n+\n+    @BeforeClass\n+    public void setUp()\n+            throws Exception\n+    {\n+        queryRunner = createQueryRunner(ImmutableMap.of());\n+        ImmutableList.of(TestScalaFunction.class,\n+                TestDeprecatedParametericScalaFunction.class,\n+                TestNonDeprecatedParametericScalaFunction.class,\n+                TestDeprecatedAggregation.class,\n+                TestNonDeprecatedAggregation.class,\n+                TestDeprecatedWindow.class,\n+                TestNonDeprecatedWindow.class)\n+                .forEach(c -> queryRunner.addFunctions(extractFunctions(c)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcxMjQzNg==", "bodyText": "First element should go on the next line since we're breaking them up across multiple lines", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r368712436", "createdAt": "2020-01-20T20:17:32Z", "author": {"login": "martint"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestDeprecatedFunctionWarning.java", "diffHunk": "@@ -0,0 +1,296 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import io.prestosql.Session;\n+import io.prestosql.client.Warning;\n+import io.prestosql.operator.aggregation.state.LongAndDoubleState;\n+import io.prestosql.operator.window.RankFunction;\n+import io.prestosql.spi.WarningCode;\n+import io.prestosql.spi.block.BlockBuilder;\n+import io.prestosql.spi.connector.StandardWarningCode;\n+import io.prestosql.spi.function.AggregationFunction;\n+import io.prestosql.spi.function.CombineFunction;\n+import io.prestosql.spi.function.Description;\n+import io.prestosql.spi.function.InputFunction;\n+import io.prestosql.spi.function.OutputFunction;\n+import io.prestosql.spi.function.ScalarFunction;\n+import io.prestosql.spi.function.SqlNullable;\n+import io.prestosql.spi.function.SqlType;\n+import io.prestosql.spi.function.TypeParameter;\n+import io.prestosql.spi.function.WindowFunctionSignature;\n+import io.prestosql.spi.type.StandardTypes;\n+import io.prestosql.testing.QueryRunner;\n+import org.intellij.lang.annotations.Language;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import static com.google.common.collect.ImmutableSet.toImmutableSet;\n+import static io.prestosql.execution.TestQueryRunnerUtil.createQueryRunner;\n+import static io.prestosql.metadata.FunctionExtractor.extractFunctions;\n+import static io.prestosql.spi.type.DoubleType.DOUBLE;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static org.testng.Assert.fail;\n+\n+public class TestDeprecatedFunctionWarning\n+{\n+    private static final WarningCode DEPRECATED_FUNCTION_WARNING_CODE = StandardWarningCode.DEPRECATED_FUNCTION.toWarningCode();\n+    private static final String EXPECTED_WARNING_MSG = \"(DEPRECATED) Use foo() instead.\";\n+\n+    private QueryRunner queryRunner;\n+\n+    @BeforeClass\n+    public void setUp()\n+            throws Exception\n+    {\n+        queryRunner = createQueryRunner(ImmutableMap.of());\n+        ImmutableList.of(TestScalaFunction.class,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzMTI2NQ==", "bodyText": "This is a little ambiguous. It's not clear whether it refers to the function or the annotation. Maybe rephrase as:\n\nThe @Deprecated annotation can be used to mark a function as deprecated and to indicate that it should no longer be used.\n\n@mosabua, do you have any suggestions?", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r369231265", "createdAt": "2020-01-21T20:40:02Z", "author": {"login": "martint"}, "path": "presto-docs/src/main/sphinx/develop/functions.rst", "diffHunk": "@@ -282,3 +282,25 @@ function follows:\n   is used when performing a ``GROUP BY`` aggregation, and an implementation\n   will be automatically generated for you, if you don't specify a\n   ``AccumulatorStateFactory``\n+\n+Deprecated Function\n+-------------------\n+\n+The ``@Deprecated`` annotation can be used to mark a function as deprecated.\n+It should no longer be used. Presto generates a warning whenever a SQL statement", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzMTg5Mg==", "bodyText": "I don't think this is necessary. This change does not affect behavior or break compatibility, so there's no need to make it configurable. It also won't be \"active\" unless a function is already deprecated.", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r369231892", "createdAt": "2020-01-21T20:41:30Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/SystemSessionProperties.java", "diffHunk": "@@ -523,6 +524,11 @@ public SystemSessionProperties(\n                         \"Experimental: Use late materialization (including WorkProcessor pipelines)\",\n                         featuresConfig.isLateMaterializationEnabled(),\n                         false),\n+                booleanProperty(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzMzM1NA==", "bodyText": "This should be a separate change. Also, we should discuss whether we want to deprecate those functions or fix their behavior. So, let's start with an issue that describes how the behavior is broken and go from there.", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r369233354", "createdAt": "2020-01-21T20:44:51Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/operator/scalar/JsonFunctions.java", "diffHunk": "@@ -360,17 +361,21 @@ public static Boolean jsonArrayContains(@SqlType(StandardTypes.JSON) Slice json,\n         }\n     }\n \n+    @Deprecated\n     @SqlNullable\n     @ScalarFunction(\"json_array_get\")\n+    @Description(\"(DEPRECATED) If the extracted element is a string, it will be converted into an invalid JSON\")\n     @LiteralParameters(\"x\")\n     @SqlType(StandardTypes.JSON)\n     public static Slice varcharJsonArrayGet(@SqlType(\"varchar(x)\") Slice json, @SqlType(StandardTypes.BIGINT) long index)\n     {\n         return jsonArrayGet(json, index);\n     }\n \n+    @Deprecated\n     @SqlNullable\n     @ScalarFunction\n+    @Description(\"(DEPRECATED) If the extracted element is a string, it will be converted into an invalid JSON\")\n     @SqlType(StandardTypes.JSON)\n     public static Slice jsonArrayGet(@SqlType(StandardTypes.JSON) Slice json, @SqlType(StandardTypes.BIGINT) long index)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzNTQzMg==", "bodyText": "Same here... I don't think this is necessary. This change does not affect behavior or break compatibility, so there's no need to make it configurable.", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r369235432", "createdAt": "2020-01-21T20:49:21Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/FeaturesConfig.java", "diffHunk": "@@ -965,6 +966,18 @@ public FeaturesConfig setLateMaterializationEnabled(boolean lateMaterializationE\n         return this;\n     }\n \n+    public boolean isDeprecatedFunctionWarningEnabled()\n+    {\n+        return deprecatedFunctionWarningEnabled;\n+    }\n+\n+    @Config(\"analyzer.deprecated-function-warning-enabled\")\n+    public FeaturesConfig setDeprecatedFunctionWarningEnabled(boolean deprecatedFunctionWarningEnabled)\n+    {\n+        this.deprecatedFunctionWarningEnabled = deprecatedFunctionWarningEnabled;\n+        return this;\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzNjI1OA==", "bodyText": "This class name has too many redundant words. How about calling it DeprecatedFunctionsPlugin?", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r369236258", "createdAt": "2020-01-21T20:51:15Z", "author": {"login": "martint"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestUDFPluginDeprecatedUDFPlugin.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.execution;\n+\n+import com.google.common.collect.ImmutableSet;\n+import io.prestosql.spi.Plugin;\n+import io.prestosql.spi.function.Description;\n+import io.prestosql.spi.function.ScalarFunction;\n+import io.prestosql.spi.function.SqlType;\n+import io.prestosql.spi.type.StandardTypes;\n+\n+import java.util.Set;\n+\n+public class TestUDFPluginDeprecatedUDFPlugin", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MzA0MTgy", "url": "https://github.com/trinodb/trino/pull/2446#pullrequestreview-346304182", "createdAt": "2020-01-22T01:46:52Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMTo0Njo1M1rOFgOZ4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMTo0Njo1M1rOFgOZ4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMzNDc1NQ==", "bodyText": "Rename s to server", "url": "https://github.com/trinodb/trino/pull/2446#discussion_r369334755", "createdAt": "2020-01-22T01:46:53Z", "author": {"login": "martint"}, "path": "presto-testing/src/main/java/io/prestosql/testing/DistributedQueryRunner.java", "diffHunk": "@@ -278,6 +279,12 @@ public void installPlugin(Plugin plugin)\n         log.info(\"Installed plugin %s in %s\", plugin.getClass().getSimpleName(), nanosSince(start).convertToMostSuccinctTimeUnit());\n     }\n \n+    @Override\n+    public void addFunctions(List<? extends SqlFunction> functions)\n+    {\n+        servers.forEach(s -> s.getMetadata().addFunctions(functions));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fe651952e2a3506f1dc0e128831b5460a5e9284", "author": {"user": {"login": "oneonestar", "name": "oneonestar"}}, "url": "https://github.com/trinodb/trino/commit/6fe651952e2a3506f1dc0e128831b5460a5e9284", "committedDate": "2020-01-22T01:55:28Z", "message": "Add deprecated function warning"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "6fe651952e2a3506f1dc0e128831b5460a5e9284", "author": {"user": {"login": "oneonestar", "name": "oneonestar"}}, "url": "https://github.com/trinodb/trino/commit/6fe651952e2a3506f1dc0e128831b5460a5e9284", "committedDate": "2020-01-22T01:55:28Z", "message": "Add deprecated function warning"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1055, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}