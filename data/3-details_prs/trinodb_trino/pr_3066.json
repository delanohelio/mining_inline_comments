{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2NDUyNzUw", "number": 3066, "title": "Add support for CREATE SCHEMA name AUTHORIZATION", "bodyText": "This adds support for setting a different owner (user or role) when a schema is created.\nSee also #2974\nIn a followup PR I will add SHOW CREATE SCHEMA to show the current owner.", "createdAt": "2020-03-11T02:37:32Z", "url": "https://github.com/trinodb/trino/pull/3066", "merged": true, "mergeCommit": {"oid": "c62673c113937734cf90ef9663d0d1d4a64413ee"}, "closed": true, "closedAt": "2020-03-26T12:20:09Z", "author": {"login": "lhofhansl"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMio3fgFqTM3MjUzMzM1NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRN-uCAH2gAyMzg2NDUyNzUwOjI1NWM5ZDFjZGNjNjE0ZWJlYmUzOTExZTlhYzc5MDE1MTJjMDNiYmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNTMzMzU0", "url": "https://github.com/trinodb/trino/pull/3066#pullrequestreview-372533354", "createdAt": "2020-03-11T07:51:36Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwNzo1MTozNlrOF0sHqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwODoxMzoyOVrOF0sp6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc5MzEyOQ==", "bodyText": "shouldn't this be one line above.\nCREATE SCHEMA x AUTHORIZATION owner_of_x WITH (properties...), instead of\nCREATE SCHEMA x WITH (properties...) AUHTORIZATION owner_of_x?\nI see that in SqlBase.g4 it is defined differently.", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390793129", "createdAt": "2020-03-11T07:51:36Z", "author": {"login": "kokosing"}, "path": "presto-docs/src/main/sphinx/sql/create-schema.rst", "diffHunk": "@@ -9,6 +9,7 @@ Synopsis\n \n     CREATE SCHEMA [ IF NOT EXISTS ] schema_name\n     [ WITH ( property_name = expression [, ...] ) ]\n+    [ AUTHORIZATION ( user | USER user | ROLE role ) ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc5MzQ0Mw==", "bodyText": "Please give an example with properties. Also it would be nice to give fully featured example for hive connector with custom schema owner and schema location.", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390793443", "createdAt": "2020-03-11T07:52:29Z", "author": {"login": "kokosing"}, "path": "presto-docs/src/main/sphinx/sql/create-schema.rst", "diffHunk": "@@ -40,6 +41,14 @@ Create the schema ``traffic`` if it does not already exist::\n \n     CREATE SCHEMA IF NOT EXISTS traffic\n \n+Create a new schema ``web`` and set the owner to user ``alice``::\n+\n+    CREATE SCHEMA web AUTHORIZATION alice\n+\n+Create a new schema ``web`` and allow everyone to drop schema and create tables in schema ``web``::\n+\n+    CREATE SCHEMA web AUTHORIZATION ROLE PUBLIC", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc5NDEwMA==", "bodyText": "can you add tests where different user cannot access that table or create another table in that schema?\nCan admin access that schema (I guess in Hive ROLE ADMIN can do anything)?", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390794100", "createdAt": "2020-03-11T07:54:09Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -481,6 +481,12 @@ public void testSchemaAuthorizationForUser()\n         assertUpdate(user, \"CREATE TABLE test_schema_authorization_user.test (x bigint)\");\n         assertUpdate(user, \"DROP TABLE test_schema_authorization_user.test\");\n         assertUpdate(user, \"DROP SCHEMA test_schema_authorization_user\");\n+\n+        // now test create creations with authorization\n+        assertUpdate(admin, \"CREATE SCHEMA test_schema_authorization_user AUTHORIZATION user\");\n+        assertUpdate(user, \"CREATE TABLE test_schema_authorization_user.test (x bigint)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc5NDMxNQ==", "bodyText": "can you add tests where different role cannot access that table or create another table in that schema?", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390794315", "createdAt": "2020-03-11T07:54:42Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -512,6 +518,13 @@ public void testSchemaAuthorizationForRole()\n         assertUpdate(user, \"DROP TABLE test_schema_authorization_role.test\");\n         assertUpdate(user, \"DROP SCHEMA test_schema_authorization_role\");\n \n+        // now test create creations with authorization\n+        assertQueryFails(admin, \"CREATE SCHEMA test_schema_authorization_role AUTHORIZATION ROLE nonexisting_role\", \".*?Role 'nonexisting_role' does not exist\");\n+        assertUpdate(admin, \"CREATE SCHEMA test_schema_authorization_role AUTHORIZATION ROLE authorized_users\");\n+        assertUpdate(user, \"CREATE TABLE test_schema_authorization_role.test (x bigint)\");\n+        assertUpdate(user, \"DROP TABLE test_schema_authorization_role.test\");\n+        assertUpdate(user, \"DROP SCHEMA test_schema_authorization_role\");\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc5NTU3Nw==", "bodyText": "Please extract this as method, then you could just write:\n        PrestoPrincipal principal = getCreateSchemaAuthorization(...);\n\n(no uninitialized variables).", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390795577", "createdAt": "2020-03-11T07:57:44Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateSchemaTask.java", "diffHunk": "@@ -71,6 +76,19 @@ public String explain(CreateSchema statement, List<Expression> parameters)\n         CatalogName catalogName = metadata.getCatalogHandle(session, schema.getCatalogName())\n                 .orElseThrow(() -> new PrestoException(NOT_FOUND, \"Catalog does not exist: \" + schema.getCatalogName()));\n \n+        PrestoPrincipal principal;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc5NjY0Mg==", "bodyText": "Can you pass something more meaningful here, new Principal(USER, SESION.getUser())?", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390796642", "createdAt": "2020-03-11T08:00:17Z", "author": {"login": "kokosing"}, "path": "presto-memory/src/test/java/io/prestosql/plugin/memory/TestMemoryMetadata.java", "diffHunk": "@@ -151,7 +151,7 @@ public void testReadTableBeforeCreationCompleted()\n     public void testCreateSchema()\n     {\n         assertEquals(metadata.listSchemaNames(SESSION), ImmutableList.of(\"default\"));\n-        metadata.createSchema(SESSION, \"test\", ImmutableMap.of());\n+        metadata.createSchema(SESSION, \"test\", ImmutableMap.of(), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc5NjcwOA==", "bodyText": "same here and below", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390796708", "createdAt": "2020-03-11T08:00:25Z", "author": {"login": "kokosing"}, "path": "presto-memory/src/test/java/io/prestosql/plugin/memory/TestMemoryMetadata.java", "diffHunk": "@@ -173,7 +173,7 @@ public void testCreateSchema()\n     public void testCreateViewWithoutReplace()\n     {\n         SchemaTableName test = new SchemaTableName(\"test\", \"test_view\");\n-        metadata.createSchema(SESSION, \"test\", ImmutableMap.of());\n+        metadata.createSchema(SESSION, \"test\", ImmutableMap.of(), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc5NzUxNA==", "bodyText": "move (WITH...) to next line", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390797514", "createdAt": "2020-03-11T08:02:21Z", "author": {"login": "kokosing"}, "path": "presto-parser/src/main/antlr4/io/prestosql/sql/parser/SqlBase.g4", "diffHunk": "@@ -39,7 +39,7 @@ statement\n     | USE schema=identifier                                            #use\n     | USE catalog=identifier '.' schema=identifier                     #use\n     | CREATE SCHEMA (IF NOT EXISTS)? qualifiedName\n-        (WITH properties)?                                             #createSchema\n+       (AUTHORIZATION principal)? (WITH properties)?                   #createSchema", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc5NzU4NQ==", "bodyText": "remove", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390797585", "createdAt": "2020-03-11T08:02:32Z", "author": {"login": "kokosing"}, "path": "presto-parser/src/main/antlr4/io/prestosql/sql/parser/SqlBase.g4", "diffHunk": "@@ -96,6 +96,7 @@ statement\n     | EXPLAIN ANALYZE? VERBOSE?\n         ('(' explainOption (',' explainOption)* ')')? statement        #explain\n     | SHOW CREATE TABLE qualifiedName                                  #showCreateTable\n+    | SHOW CREATE SCHEMA qualifiedName                                 #showCreateSchema", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDgwMTA3Mw==", "bodyText": "I guess this should be mentioned before properties (possibly there are some missing tests).", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390801073", "createdAt": "2020-03-11T08:11:25Z", "author": {"login": "kokosing"}, "path": "presto-parser/src/main/java/io/prestosql/sql/SqlFormatter.java", "diffHunk": "@@ -812,6 +812,11 @@ protected Void visitCreateSchema(CreateSchema node, Integer context)\n             builder.append(formatName(node.getSchemaName()));\n             builder.append(formatPropertiesMultiLine(node.getProperties()));\n \n+            if (node.getPrincipal().isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDgwMTE5MQ==", "bodyText": "s/principal/authorization?", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390801191", "createdAt": "2020-03-11T08:11:42Z", "author": {"login": "kokosing"}, "path": "presto-parser/src/main/java/io/prestosql/sql/tree/CreateSchema.java", "diffHunk": "@@ -28,23 +28,25 @@\n     private final QualifiedName schemaName;\n     private final boolean notExists;\n     private final List<Property> properties;\n+    private final Optional<PrincipalSpecification> principal;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDgwMTMwMw==", "bodyText": "please add tests with authorization and with with clauses", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390801303", "createdAt": "2020-03-11T08:11:59Z", "author": {"login": "kokosing"}, "path": "presto-parser/src/test/java/io/prestosql/sql/parser/TestStatementBuilder.java", "diffHunk": "@@ -193,6 +193,8 @@ public void testStatementBuilder()\n         printStatement(\"alter table a.b.c drop column x\");\n \n         printStatement(\"create schema test\");\n+        printStatement(\"create schema test authorization alice\");\n+        printStatement(\"create schema test authorization role public\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDgwMTUxMA==", "bodyText": "add test with WITH and AUTHORIZATION", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390801510", "createdAt": "2020-03-11T08:12:35Z", "author": {"login": "kokosing"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueries.java", "diffHunk": "@@ -5111,6 +5111,7 @@ public void testDescribeOutputNonSelect()\n         assertDescribeOutputEmpty(\"GRANT INSERT ON foo TO bar\");\n         assertDescribeOutputEmpty(\"REVOKE INSERT ON foo FROM bar\");\n         assertDescribeOutputEmpty(\"CREATE SCHEMA foo\");\n+        assertDescribeOutputEmpty(\"CREATE SCHEMA foo AUTHORIZATION bar\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDgwMTYyMg==", "bodyText": "remove", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390801622", "createdAt": "2020-03-11T08:12:53Z", "author": {"login": "kokosing"}, "path": "presto-spi/src/main/java/io/prestosql/spi/connector/ConnectorMetadata.java", "diffHunk": "@@ -231,8 +231,9 @@ default TableStatistics getTableStatistics(ConnectorSession session, ConnectorTa\n \n     /**\n      * Creates a schema.\n+     * @param principal TODO", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDgwMTg5Ng==", "bodyText": "s/principal/authorization or owner (but if you choose one thing, then please use coherently across the commit).", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r390801896", "createdAt": "2020-03-11T08:13:29Z", "author": {"login": "kokosing"}, "path": "presto-spi/src/main/java/io/prestosql/spi/connector/ConnectorMetadata.java", "diffHunk": "@@ -231,8 +231,9 @@ default TableStatistics getTableStatistics(ConnectorSession session, ConnectorTa\n \n     /**\n      * Creates a schema.\n+     * @param principal TODO\n      */\n-    default void createSchema(ConnectorSession session, String schemaName, Map<String, Object> properties)\n+    default void createSchema(ConnectorSession session, String schemaName, Map<String, Object> properties, PrestoPrincipal principal)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjkwNDE0", "url": "https://github.com/trinodb/trino/pull/3066#pullrequestreview-373290414", "createdAt": "2020-03-12T05:42:12Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNTo0MjoxM1rOF1R2xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNTo0MjoxM1rOF1R2xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMTM5OQ==", "bodyText": "@kokosing Any idea on this one? Every SELECT query fails with an error indicating that schema test_schema_authorization_user does not exist, even though I was just able to create a table in it.\nIt does not matter on behalf of which user I do this.\nAnd it happens only in this test, not in a real cluster.\nAny ideas?", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r391411399", "createdAt": "2020-03-12T05:42:13Z", "author": {"login": "lhofhansl"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -471,14 +471,46 @@ public void testSchemaAuthorizationForUser()\n                 .setIdentity(Identity.forUser(\"user\").withPrincipal(getSession().getIdentity().getPrincipal()).build())\n                 .build();\n \n+        Session anotherUser = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setSchema(\"test_schema_authorization_user\")\n+                .setIdentity(Identity.forUser(\"anotheruser\").withPrincipal(getSession().getIdentity().getPrincipal()).build())\n+                .build();\n+\n         // ordinary users cannot drop a schema or create a table in a schema the do not own\n         assertQueryFails(user, \"DROP SCHEMA test_schema_authorization_user\", \"Access Denied: Cannot drop schema test_schema_authorization_user\");\n         assertQueryFails(user, \"CREATE TABLE test_schema_authorization_user.test (x bigint)\", \"Access Denied: Cannot create table test_schema_authorization_user.test\");\n \n         // change owner to user\n         assertUpdate(admin, \"ALTER SCHEMA test_schema_authorization_user SET AUTHORIZATION user\");\n \n+        // another user still cannot create tables\n+        assertQueryFails(anotherUser, \"CREATE TABLE test_schema_authorization_user.test (x bigint)\", \"Access Denied: Cannot create table test_schema_authorization_user.test\");\n+\n         assertUpdate(user, \"CREATE TABLE test_schema_authorization_user.test (x bigint)\");\n+        String selectSQL = \"SELECT 1 FROM test_schema_authorization_user.test\";\n+        // TODO: This cannot find the schema for some reason\n+        // assertQuery(user, selectSQL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MTQ0Nzg4", "url": "https://github.com/trinodb/trino/pull/3066#pullrequestreview-374144788", "createdAt": "2020-03-13T09:13:19Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwOToxMzoxOVrOF18YlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwOToyMTo0N1rOF18npw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwODE4MQ==", "bodyText": "I don't like passing nulls. Please pass there some valid variable like: new PrestoPrincipal(USER, SESSION.getUSER())", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r392108181", "createdAt": "2020-03-13T09:13:19Z", "author": {"login": "kokosing"}, "path": "presto-blackhole/src/test/java/io/prestosql/plugin/blackhole/TestBlackHoleMetadata.java", "diffHunk": "@@ -46,7 +46,7 @@\n     public void testCreateSchema()\n     {\n         assertEquals(metadata.listSchemaNames(SESSION), ImmutableList.of(\"default\"));\n-        metadata.createSchema(SESSION, \"test\", ImmutableMap.of());\n+        metadata.createSchema(SESSION, \"test\", ImmutableMap.of(), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwODczMg==", "bodyText": "there is no such property for hive schemas. Hive only supports only location property so far.", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r392108732", "createdAt": "2020-03-13T09:14:31Z", "author": {"login": "kokosing"}, "path": "presto-docs/src/main/sphinx/sql/create-schema.rst", "diffHunk": "@@ -40,6 +44,18 @@ Create the schema ``traffic`` if it does not already exist::\n \n     CREATE SCHEMA IF NOT EXISTS traffic\n \n+Create a new schema ``web`` and set the owner to user ``alice``::\n+\n+    CREATE SCHEMA web AUTHORIZATION alice\n+\n+Create a new schema ``web``, set the ``format`` property to ``ORC`` and set the owner to user ``alice``::\n+\n+    CREATE SCHEMA web AUTHORIZATION alice WITH ( format = 'ORC' )", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwOTE4Ng==", "bodyText": "Please put this example below example with ROLE.\n@mosabua, @electrum  Would you like take a look at docs changes?", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r392109186", "createdAt": "2020-03-13T09:15:33Z", "author": {"login": "kokosing"}, "path": "presto-docs/src/main/sphinx/sql/create-schema.rst", "diffHunk": "@@ -40,6 +44,18 @@ Create the schema ``traffic`` if it does not already exist::\n \n     CREATE SCHEMA IF NOT EXISTS traffic\n \n+Create a new schema ``web`` and set the owner to user ``alice``::\n+\n+    CREATE SCHEMA web AUTHORIZATION alice\n+\n+Create a new schema ``web``, set the ``format`` property to ``ORC`` and set the owner to user ``alice``::\n+\n+    CREATE SCHEMA web AUTHORIZATION alice WITH ( format = 'ORC' )", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjExMDg3NA==", "bodyText": ".setIdentity(Identity.forUser(\"anotheruser\")\n     .withPrincipal(getSession().getIdentity().getPrincipal())\n     .build())", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r392110874", "createdAt": "2020-03-13T09:19:28Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -471,14 +471,41 @@ public void testSchemaAuthorizationForUser()\n                 .setIdentity(Identity.forUser(\"user\").withPrincipal(getSession().getIdentity().getPrincipal()).build())\n                 .build();\n \n+        Session anotherUser = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setSchema(\"test_schema_authorization_user\")\n+                .setIdentity(Identity.forUser(\"anotheruser\").withPrincipal(getSession().getIdentity().getPrincipal()).build())", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjExMTQ5NA==", "bodyText": "Please have a dedicated test for CREATE SCHEMA WITH AUTHORIZATION. If you mix this with ALTER SCHEMA it is getting very complicated.", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r392111494", "createdAt": "2020-03-13T09:20:47Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -471,14 +471,41 @@ public void testSchemaAuthorizationForUser()\n                 .setIdentity(Identity.forUser(\"user\").withPrincipal(getSession().getIdentity().getPrincipal()).build())\n                 .build();\n \n+        Session anotherUser = testSessionBuilder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjExMjAzOQ==", "bodyText": "Please have dedicated tests for CREATE SCHEMA .. AUTHORIZATION ROLE ....\nIf you mix this with ALTER SCHEMA it is getting very complicated.", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r392112039", "createdAt": "2020-03-13T09:21:47Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -508,7 +535,32 @@ public void testSchemaAuthorizationForRole()\n                 .setIdentity(Identity.forUser(\"user\").withPrincipal(getSession().getIdentity().getPrincipal()).build())\n                 .build();\n \n+        Session anotherUser = testSessionBuilder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1ODE3MDQ1", "url": "https://github.com/trinodb/trino/pull/3066#pullrequestreview-375817045", "createdAt": "2020-03-17T08:18:05Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODoxODowNVrOF3RvoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODoyNDoxOFrOF3R7ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUwNjcyMQ==", "bodyText": "static import for USER", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r393506721", "createdAt": "2020-03-17T08:18:05Z", "author": {"login": "kokosing"}, "path": "presto-blackhole/src/test/java/io/prestosql/plugin/blackhole/TestBlackHoleMetadata.java", "diffHunk": "@@ -46,7 +48,7 @@\n     public void testCreateSchema()\n     {\n         assertEquals(metadata.listSchemaNames(SESSION), ImmutableList.of(\"default\"));\n-        metadata.createSchema(SESSION, \"test\", ImmutableMap.of());\n+        metadata.createSchema(SESSION, \"test\", ImmutableMap.of(), new PrestoPrincipal(PrincipalType.USER, SESSION.getUser()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUwNzA1OA==", "bodyText": "try to wrap lines about 80 characters with (convention in docs)", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r393507058", "createdAt": "2020-03-17T08:18:48Z", "author": {"login": "kokosing"}, "path": "presto-docs/src/main/sphinx/sql/create-schema.rst", "diffHunk": "@@ -40,6 +44,22 @@ Create the schema ``traffic`` if it does not already exist::\n \n     CREATE SCHEMA IF NOT EXISTS traffic\n \n+Create a new schema ``web`` and set the owner to user ``alice``::\n+\n+    CREATE SCHEMA web AUTHORIZATION alice\n+\n+Create a new schema ``web``, set the ``LOCATION`` property to ``/hive/data/web`` and set the owner to user ``alice``::", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUwODQ3Mw==", "bodyText": "can you try to create another table when user has this role disabled (or enabled different role)?", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r393508473", "createdAt": "2020-03-17T08:21:47Z", "author": {"login": "kokosing"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -505,16 +524,112 @@ public void testSchemaAuthorizationForRole()\n         Session user = testSessionBuilder()\n                 .setCatalog(getSession().getCatalog().get())\n                 .setSchema(\"test_schema_authorization_role\")\n-                .setIdentity(Identity.forUser(\"user\").withPrincipal(getSession().getIdentity().getPrincipal()).build())\n+                .setIdentity(Identity.forUser(\"user\")\n+                     .withPrincipal(getSession().getIdentity().getPrincipal())\n+                     .build())\n+                .build();\n+\n+        Session anotherUser = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setSchema(\"test_schema_authorization_role\")\n+                .setIdentity(Identity.forUser(\"anotheruser\")\n+                     .withPrincipal(getSession().getIdentity().getPrincipal())\n+                     .build())\n                 .build();\n \n         assertUpdate(user, \"CREATE TABLE test_schema_authorization_role.test (x bigint)\");\n+\n+        // another user should not be able to drop the table\n+        assertQueryFails(anotherUser, \"DROP TABLE test_schema_authorization_role.test\", \"Access Denied: Cannot drop table test_schema_authorization_role.test\");\n+        // or access the table in any way\n+        assertQueryFails(anotherUser, \"SELECT 1 FROM test_schema_authorization_role.test\", \"Access Denied: Cannot select from table test_schema_authorization_role.test\");\n+\n         assertUpdate(user, \"DROP TABLE test_schema_authorization_role.test\");\n         assertUpdate(user, \"DROP SCHEMA test_schema_authorization_role\");\n \n         assertUpdate(admin, \"DROP ROLE authorized_users\");\n     }\n \n+    @Test\n+    public void testCreateSchemaWithAuthorizationForUser()\n+    {\n+        Session admin = Session.builder(getQueryRunner().getDefaultSession())\n+                .setIdentity(Identity.forUser(\"hive\")\n+                        .withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\")))\n+                        .build())\n+                .build();\n+\n+        Session user = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setSchema(\"test_createschema_authorization_user\")\n+                .setIdentity(Identity.forUser(\"user\")\n+                     .withPrincipal(getSession().getIdentity().getPrincipal())\n+                     .build())\n+                .build();\n+\n+        Session anotherUser = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setSchema(\"test_createschema_authorization_user\")\n+                .setIdentity(Identity.forUser(\"anotheruser\")\n+                     .withPrincipal(getSession().getIdentity().getPrincipal())\n+                     .build())\n+                .build();\n+\n+        assertUpdate(admin, \"CREATE SCHEMA test_createschema_authorization_user AUTHORIZATION user\");\n+        assertUpdate(user, \"CREATE TABLE test_createschema_authorization_user.test (x bigint)\");\n+\n+        // another user should not be able to drop the table\n+        assertQueryFails(anotherUser, \"DROP TABLE test_createschema_authorization_user.test\", \"Access Denied: Cannot drop table test_createschema_authorization_user.test\");\n+        // or access the table in any way\n+        assertQueryFails(anotherUser, \"SELECT 1 FROM test_createschema_authorization_user.test\", \"Access Denied: Cannot select from table test_createschema_authorization_user.test\");\n+\n+        assertUpdate(user, \"DROP TABLE test_createschema_authorization_user.test\");\n+        assertUpdate(user, \"DROP SCHEMA test_createschema_authorization_user\");\n+    }\n+\n+    @Test\n+    public void testCreateSchemaWithAuthorizationForRole()\n+    {\n+        Session admin = Session.builder(getQueryRunner().getDefaultSession())\n+                .setIdentity(Identity.forUser(\"hive\")\n+                        .withRole(\"hive\", new SelectedRole(ROLE, Optional.of(\"admin\")))\n+                        .build())\n+                .build();\n+\n+        Session user = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setSchema(\"test_createschema_authorization_role\")\n+                .setIdentity(Identity.forUser(\"user\")\n+                     .withPrincipal(getSession().getIdentity().getPrincipal())\n+                     .build())\n+                .build();\n+\n+        Session anotherUser = testSessionBuilder()\n+                .setCatalog(getSession().getCatalog().get())\n+                .setSchema(\"test_createschema_authorization_role\")\n+                .setIdentity(Identity.forUser(\"anotheruser\")\n+                     .withPrincipal(getSession().getIdentity().getPrincipal())\n+                     .build())\n+                .build();\n+\n+        assertUpdate(admin, \"CREATE ROLE authorized_users\");\n+        assertUpdate(admin, \"GRANT authorized_users TO user\");\n+\n+        assertQueryFails(admin, \"CREATE SCHEMA test_createschema_authorization_role AUTHORIZATION ROLE nonexisting_role\", \".*?Role 'nonexisting_role' does not exist\");\n+        assertUpdate(admin, \"CREATE SCHEMA test_createschema_authorization_role AUTHORIZATION ROLE authorized_users\");\n+        assertUpdate(user, \"CREATE TABLE test_createschema_authorization_role.test (x bigint)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUwODY1NA==", "bodyText": "no need for empty line here", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r393508654", "createdAt": "2020-03-17T08:22:12Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/CreateSchemaTask.java", "diffHunk": "@@ -79,8 +84,26 @@ public String explain(CreateSchema statement, List<Expression> parameters)\n                 metadata,\n                 parameterExtractor(statement, parameters));\n \n-        metadata.createSchema(session, schema, properties);\n+        PrestoPrincipal principal = getCreatePrincipal(statement, session, metadata);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUwODc2OQ==", "bodyText": "static import for USER", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r393508769", "createdAt": "2020-03-17T08:22:26Z", "author": {"login": "kokosing"}, "path": "presto-memory/src/test/java/io/prestosql/plugin/memory/TestMemoryMetadata.java", "diffHunk": "@@ -151,7 +153,7 @@ public void testReadTableBeforeCreationCompleted()\n     public void testCreateSchema()\n     {\n         assertEquals(metadata.listSchemaNames(SESSION), ImmutableList.of(\"default\"));\n-        metadata.createSchema(SESSION, \"test\", ImmutableMap.of());\n+        metadata.createSchema(SESSION, \"test\", ImmutableMap.of(), new PrestoPrincipal(PrincipalType.USER, SESSION.getUser()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUwOTEwNw==", "bodyText": "you changed the indentation, please restore previous indentation", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r393509107", "createdAt": "2020-03-17T08:23:07Z", "author": {"login": "kokosing"}, "path": "presto-parser/src/main/antlr4/io/prestosql/sql/parser/SqlBase.g4", "diffHunk": "@@ -39,7 +39,8 @@ statement\n     | USE schema=identifier                                            #use\n     | USE catalog=identifier '.' schema=identifier                     #use\n     | CREATE SCHEMA (IF NOT EXISTS)? qualifiedName\n-        (WITH properties)?                                             #createSchema\n+       (AUTHORIZATION principal)?", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUwOTczMw==", "bodyText": "Also add:\n        printStatement(\"create schema test authorization user alice\");\n        printStatement(\"create schema test authorization user alice with ( format = 'ORC' )\");", "url": "https://github.com/trinodb/trino/pull/3066#discussion_r393509733", "createdAt": "2020-03-17T08:24:18Z", "author": {"login": "kokosing"}, "path": "presto-parser/src/test/java/io/prestosql/sql/parser/TestStatementBuilder.java", "diffHunk": "@@ -193,6 +193,10 @@ public void testStatementBuilder()\n         printStatement(\"alter table a.b.c drop column x\");\n \n         printStatement(\"create schema test\");\n+        printStatement(\"create schema test authorization alice\");\n+        printStatement(\"create schema test authorization alice with ( format = 'ORC' )\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "255c9d1cdcc614ebebe3911e9ac7901512c03bbe", "author": {"user": {"login": "lhofhansl", "name": null}}, "url": "https://github.com/trinodb/trino/commit/255c9d1cdcc614ebebe3911e9ac7901512c03bbe", "committedDate": "2020-03-25T21:00:04Z", "message": "Add support for CREATE SCHEMA name AUTHORIZATION\n\nThis adds support for setting a different owner (user or role) when a schema is created."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2149, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}