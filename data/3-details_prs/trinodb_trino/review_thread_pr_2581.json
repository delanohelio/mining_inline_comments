{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1OTU4MTc3", "number": 2581, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMzo1OTozOVrODaLdoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxOToyNDo0N1rOEIf32A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Nzc3Mzc2OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpiller.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMzo1OTozOVrOFg_EqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMzo1OTozOVrOFg_EqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzMjEzNw==", "bodyText": "The commit tittle is a big too long", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r370132137", "createdAt": "2020-01-23T13:59:39Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpiller.java", "diffHunk": "@@ -71,14 +71,17 @@\n     private long spilledPagesInMemorySize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Nzc4MzcwOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpillerFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowMjoxOFrOFg_Klg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowMjoxOFrOFg_Klg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzMzY1NA==", "bodyText": "code style mistake. Other than that I would inline this method.", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r370133654", "createdAt": "2020-01-23T14:02:18Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpillerFactory.java", "diffHunk": "@@ -215,4 +225,8 @@ private boolean isSeeminglyHealthy(Path path)\n             return false;\n         }\n     }\n+\n+    private void clearDiskHealthCache() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Nzc4NzExOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpillerFactory.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDowMzoxN1rOFg_Mpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNzo1MjoyMFrOFk6Scw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNDE4Mg==", "bodyText": "Maybe instead of exposing a field, create a method that exposes just the size of cache.", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r370134182", "createdAt": "2020-01-23T14:03:17Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpillerFactory.java", "diffHunk": "@@ -78,7 +78,9 @@\n     private final double maxUsedSpaceThreshold;\n     private final boolean spillEncryptionEnabled;\n     private int roundRobinIndex;\n-    private final LoadingCache<Path, Boolean> spillPathHealthCache;\n+\n+    @VisibleForTesting\n+    final LoadingCache<Path, Boolean> spillPathHealthCache;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA5NjU3OQ==", "bodyText": "It looks like this comment is not addressed", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r374096579", "createdAt": "2020-02-03T13:20:20Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpillerFactory.java", "diffHunk": "@@ -78,7 +78,9 @@\n     private final double maxUsedSpaceThreshold;\n     private final boolean spillEncryptionEnabled;\n     private int roundRobinIndex;\n-    private final LoadingCache<Path, Boolean> spillPathHealthCache;\n+\n+    @VisibleForTesting\n+    final LoadingCache<Path, Boolean> spillPathHealthCache;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNDE4Mg=="}, "originalCommit": null, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI0ODA1MQ==", "bodyText": "Ah, didn't push the last commit. Fixed.", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r374248051", "createdAt": "2020-02-03T17:52:20Z", "author": {"login": "dfinninger"}, "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpillerFactory.java", "diffHunk": "@@ -78,7 +78,9 @@\n     private final double maxUsedSpaceThreshold;\n     private final boolean spillEncryptionEnabled;\n     private int roundRobinIndex;\n-    private final LoadingCache<Path, Boolean> spillPathHealthCache;\n+\n+    @VisibleForTesting\n+    final LoadingCache<Path, Boolean> spillPathHealthCache;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDEzNDE4Mg=="}, "originalCommit": null, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMzQ1NjUwOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpiller.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzoxOTo1MFrOFkxBqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzoxOTo1MFrOFkxBqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA5NjI5OA==", "bodyText": "requireNonNull", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r374096298", "createdAt": "2020-02-03T13:19:50Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpiller.java", "diffHunk": "@@ -99,10 +102,12 @@ public FileSingleStreamSpiller(\n         // before/after the spiller thread allocates that memory -- -- whether before or after depends on whether writePages() is in the\n         // middle of execution when close() is called (note that this applies to both readPages() and writePages() methods).\n         this.memoryContext.setBytes(BUFFER_SIZE);\n+        this.filesystemErrorHandler = filesystemErrorHandler;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjI2MjQxOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpiller.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0MzowMFrOFlL5dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0MzowMFrOFlL5dA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUzNjU2NA==", "bodyText": "add a message that \"filesystemErrorHandler is null\"", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r374536564", "createdAt": "2020-02-04T08:43:00Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpiller.java", "diffHunk": "@@ -99,10 +102,12 @@ public FileSingleStreamSpiller(\n         // before/after the spiller thread allocates that memory -- -- whether before or after depends on whether writePages() is in the\n         // middle of execution when close() is called (note that this applies to both readPages() and writePages() methods).\n         this.memoryContext.setBytes(BUFFER_SIZE);\n+        this.filesystemErrorHandler = requireNonNull(filesystemErrorHandler);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjI2MjY1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpiller.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0MzowNFrOFlL5lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0MzowNFrOFlL5lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUzNjU5OQ==", "bodyText": "final", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r374536599", "createdAt": "2020-02-04T08:43:04Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpiller.java", "diffHunk": "@@ -71,14 +71,17 @@\n     private long spilledPagesInMemorySize;\n     private ListenableFuture<?> spillInProgress = Futures.immediateFuture(null);\n \n+    private Runnable filesystemErrorHandler;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjI2MzIwOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpillerFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0MzoxNVrOFlL56g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0MzoxNVrOFlL56g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUzNjY4Mg==", "bodyText": "undo", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r374536682", "createdAt": "2020-02-04T08:43:15Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpillerFactory.java", "diffHunk": "@@ -78,6 +78,7 @@\n     private final double maxUsedSpaceThreshold;\n     private final boolean spillEncryptionEnabled;\n     private int roundRobinIndex;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjI2NDEwOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpillerFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0MzozMVrOFlL6aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0MzozMVrOFlL6aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUzNjgxMQ==", "bodyText": "@VisibleForTesting?", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r374536811", "createdAt": "2020-02-04T08:43:31Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpillerFactory.java", "diffHunk": "@@ -215,4 +224,9 @@ private boolean isSeeminglyHealthy(Path path)\n             return false;\n         }\n     }\n+\n+    protected long getSpillPathCacheSize()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjI2Njk0OnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/spiller/TestFileSingleStreamSpillerFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0NDoyOFrOFlL8HQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0NDoyOFrOFlL8HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUzNzI0NQ==", "bodyText": "can you extract a method where you create spillerFactory", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r374537245", "createdAt": "2020-02-04T08:44:28Z", "author": {"login": "kokosing"}, "path": "presto-main/src/test/java/io/prestosql/spiller/TestFileSingleStreamSpillerFactory.java", "diffHunk": "@@ -147,6 +147,87 @@ public void testDistributesSpillOverPathsBadDisk()\n         assertEquals(listFiles(spillPath2.toPath()).size(), 0);\n     }\n \n+    @Test\n+    public void testCacheInvalidatedOnBadDisk()\n+            throws Exception\n+    {\n+        List<Type> types = ImmutableList.of(BIGINT);\n+        List<Path> spillPaths = ImmutableList.of(spillPath1.toPath(), spillPath2.toPath());\n+        FileSingleStreamSpillerFactory spillerFactory = new FileSingleStreamSpillerFactory(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjI3MDA5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/spiller/TestFileSingleStreamSpillerFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0NTo0MlrOFlL-FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0NTo0MlrOFlL-FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUzNzc0OA==", "bodyText": "Please use org.assertj.core.api.AssertionsForClassTypes#assertThatThrownBy(org.assertj.core.api.ThrowableAssert.ThrowingCallable)\nto verify expected exceptions.", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r374537748", "createdAt": "2020-02-04T08:45:42Z", "author": {"login": "kokosing"}, "path": "presto-main/src/test/java/io/prestosql/spiller/TestFileSingleStreamSpillerFactory.java", "diffHunk": "@@ -147,6 +147,87 @@ public void testDistributesSpillOverPathsBadDisk()\n         assertEquals(listFiles(spillPath2.toPath()).size(), 0);\n     }\n \n+    @Test\n+    public void testCacheInvalidatedOnBadDisk()\n+            throws Exception\n+    {\n+        List<Type> types = ImmutableList.of(BIGINT);\n+        List<Path> spillPaths = ImmutableList.of(spillPath1.toPath(), spillPath2.toPath());\n+        FileSingleStreamSpillerFactory spillerFactory = new FileSingleStreamSpillerFactory(\n+                executor, // executor won't be closed, because we don't call destroy() on the spiller factory\n+                blockEncodingSerde,\n+                new SpillerStats(),\n+                spillPaths,\n+                1.0,\n+                false,\n+                false);\n+\n+        assertEquals(listFiles(spillPath1.toPath()).size(), 0);\n+        assertEquals(listFiles(spillPath2.toPath()).size(), 0);\n+\n+        Page page = buildPage();\n+        List<SingleStreamSpiller> spillers = new ArrayList<>();\n+        for (int i = 0; i < 2; ++i) {\n+            SingleStreamSpiller singleStreamSpiller = spillerFactory.create(types, bytes -> {}, newSimpleAggregatedMemoryContext().newLocalMemoryContext(\"test\"));\n+\n+            if (i == 1) {\n+                // Set second spiller path to read-only after initialization to emulate a disk failing during runtime\n+                setPosixFilePermissions(spillPath2.toPath(), ImmutableSet.of(PosixFilePermission.OWNER_READ));\n+            }\n+\n+            try {\n+                getUnchecked(singleStreamSpiller.spill(page));\n+            }\n+            catch (Exception ignored) {\n+                // Do nothing because we expect this to fail due to file permissions", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjI3MzYwOnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/spiller/TestFileSingleStreamSpillerFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0Njo1NlrOFlMAUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0Njo1NlrOFlMAUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUzODMyMg==", "bodyText": "Please unroll this loop", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r374538322", "createdAt": "2020-02-04T08:46:56Z", "author": {"login": "kokosing"}, "path": "presto-main/src/test/java/io/prestosql/spiller/TestFileSingleStreamSpillerFactory.java", "diffHunk": "@@ -147,6 +147,87 @@ public void testDistributesSpillOverPathsBadDisk()\n         assertEquals(listFiles(spillPath2.toPath()).size(), 0);\n     }\n \n+    @Test\n+    public void testCacheInvalidatedOnBadDisk()\n+            throws Exception\n+    {\n+        List<Type> types = ImmutableList.of(BIGINT);\n+        List<Path> spillPaths = ImmutableList.of(spillPath1.toPath(), spillPath2.toPath());\n+        FileSingleStreamSpillerFactory spillerFactory = new FileSingleStreamSpillerFactory(\n+                executor, // executor won't be closed, because we don't call destroy() on the spiller factory\n+                blockEncodingSerde,\n+                new SpillerStats(),\n+                spillPaths,\n+                1.0,\n+                false,\n+                false);\n+\n+        assertEquals(listFiles(spillPath1.toPath()).size(), 0);\n+        assertEquals(listFiles(spillPath2.toPath()).size(), 0);\n+\n+        Page page = buildPage();\n+        List<SingleStreamSpiller> spillers = new ArrayList<>();\n+        for (int i = 0; i < 2; ++i) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjI3NTc0OnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/spiller/TestFileSingleStreamSpillerFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0Nzo0NFrOFlMBsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODo0Nzo0NFrOFlMBsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUzODY3Mg==", "bodyText": "you haven't modified permissions in this test.", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r374538672", "createdAt": "2020-02-04T08:47:44Z", "author": {"login": "kokosing"}, "path": "presto-main/src/test/java/io/prestosql/spiller/TestFileSingleStreamSpillerFactory.java", "diffHunk": "@@ -147,6 +147,87 @@ public void testDistributesSpillOverPathsBadDisk()\n         assertEquals(listFiles(spillPath2.toPath()).size(), 0);\n     }\n \n+    @Test\n+    public void testCacheInvalidatedOnBadDisk()\n+            throws Exception\n+    {\n+        List<Type> types = ImmutableList.of(BIGINT);\n+        List<Path> spillPaths = ImmutableList.of(spillPath1.toPath(), spillPath2.toPath());\n+        FileSingleStreamSpillerFactory spillerFactory = new FileSingleStreamSpillerFactory(\n+                executor, // executor won't be closed, because we don't call destroy() on the spiller factory\n+                blockEncodingSerde,\n+                new SpillerStats(),\n+                spillPaths,\n+                1.0,\n+                false,\n+                false);\n+\n+        assertEquals(listFiles(spillPath1.toPath()).size(), 0);\n+        assertEquals(listFiles(spillPath2.toPath()).size(), 0);\n+\n+        Page page = buildPage();\n+        List<SingleStreamSpiller> spillers = new ArrayList<>();\n+        for (int i = 0; i < 2; ++i) {\n+            SingleStreamSpiller singleStreamSpiller = spillerFactory.create(types, bytes -> {}, newSimpleAggregatedMemoryContext().newLocalMemoryContext(\"test\"));\n+\n+            if (i == 1) {\n+                // Set second spiller path to read-only after initialization to emulate a disk failing during runtime\n+                setPosixFilePermissions(spillPath2.toPath(), ImmutableSet.of(PosixFilePermission.OWNER_READ));\n+            }\n+\n+            try {\n+                getUnchecked(singleStreamSpiller.spill(page));\n+            }\n+            catch (Exception ignored) {\n+                // Do nothing because we expect this to fail due to file permissions\n+            }\n+            spillers.add(singleStreamSpiller);\n+        }\n+\n+        assertEquals(spillerFactory.getSpillPathCacheSize(), 0, \"cache still contains entries\");\n+\n+        // restore permissions to allow cleanup\n+        setPosixFilePermissions(spillPath2.toPath(), ImmutableSet.of(PosixFilePermission.OWNER_READ, PosixFilePermission.OWNER_WRITE, PosixFilePermission.OWNER_EXECUTE));\n+        spillers.forEach(SingleStreamSpiller::close);\n+        assertEquals(listFiles(spillPath1.toPath()).size(), 0);\n+        assertEquals(listFiles(spillPath2.toPath()).size(), 0);\n+    }\n+\n+    @Test\n+    public void testCacheFull()\n+            throws Exception\n+    {\n+        List<Type> types = ImmutableList.of(BIGINT);\n+        List<Path> spillPaths = ImmutableList.of(spillPath1.toPath(), spillPath2.toPath());\n+        FileSingleStreamSpillerFactory spillerFactory = new FileSingleStreamSpillerFactory(\n+                executor, // executor won't be closed, because we don't call destroy() on the spiller factory\n+                blockEncodingSerde,\n+                new SpillerStats(),\n+                spillPaths,\n+                1.0,\n+                false,\n+                false);\n+\n+        assertEquals(listFiles(spillPath1.toPath()).size(), 0);\n+        assertEquals(listFiles(spillPath2.toPath()).size(), 0);\n+\n+        Page page = buildPage();\n+        List<SingleStreamSpiller> spillers = new ArrayList<>();\n+        for (int i = 0; i < 2; ++i) {\n+            SingleStreamSpiller singleStreamSpiller = spillerFactory.create(types, bytes -> {}, newSimpleAggregatedMemoryContext().newLocalMemoryContext(\"test\"));\n+            getUnchecked(singleStreamSpiller.spill(page));\n+            spillers.add(singleStreamSpiller);\n+        }\n+\n+        assertEquals(spillerFactory.getSpillPathCacheSize(), 2, \"cache contains no entries\");\n+\n+        // restore permissions to allow cleanup\n+        setPosixFilePermissions(spillPath2.toPath(), ImmutableSet.of(PosixFilePermission.OWNER_READ, PosixFilePermission.OWNER_WRITE, PosixFilePermission.OWNER_EXECUTE));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMDAwNTc3OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpillerFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwODo1NDowMFrOFlv5IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwODo1NDowMFrOFlv5IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyNjMwNQ==", "bodyText": "I think it does need to be protected. Just package should be enough.", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r375126305", "createdAt": "2020-02-05T08:54:00Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpillerFactory.java", "diffHunk": "@@ -215,4 +223,10 @@ private boolean isSeeminglyHealthy(Path path)\n             return false;\n         }\n     }\n+\n+    @VisibleForTesting\n+    protected long getSpillPathCacheSize()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMDAxMDQ4OnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/spiller/TestFileSingleStreamSpillerFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwODo1NToyNFrOFlv8Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwODo1NToyNFrOFlv8Bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyNzA0Nw==", "bodyText": "please extract this change to separate commit, before your actual change. Because it is just a refactoring. Also please put this method somewhere at the bottom, it is not just much important as it is only utility method.", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r375127047", "createdAt": "2020-02-05T08:55:24Z", "author": {"login": "kokosing"}, "path": "presto-main/src/test/java/io/prestosql/spiller/TestFileSingleStreamSpillerFactory.java", "diffHunk": "@@ -75,20 +76,30 @@ public void tearDown()\n         closer.close();\n     }\n \n-    @Test\n-    public void testDistributesSpillOverPaths()\n-            throws Exception\n+    private FileSingleStreamSpillerFactory spillerFactoryFactory(List<Path> paths)\n     {\n-        List<Type> types = ImmutableList.of(BIGINT);\n-        List<Path> spillPaths = ImmutableList.of(spillPath1.toPath(), spillPath2.toPath());\n-        FileSingleStreamSpillerFactory spillerFactory = new FileSingleStreamSpillerFactory(\n+        return spillerFactoryFactory (paths, 1.0);\n+    }\n+\n+    private FileSingleStreamSpillerFactory spillerFactoryFactory(List<Path> paths, Double maxUsedSpaceThreshold)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MzQ2MDUzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpiller.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxOToyNDowN1rOGof7hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxOToyNDowN1rOGof7hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTExOTM2NQ==", "bodyText": "rename variable and field to fileSystemErrorHandler", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r445119365", "createdAt": "2020-06-24T19:24:07Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpiller.java", "diffHunk": "@@ -71,14 +71,17 @@\n     private long spilledPagesInMemorySize;\n     private ListenableFuture<?> spillInProgress = Futures.immediateFuture(null);\n \n+    private final Runnable filesystemErrorHandler;\n+\n     public FileSingleStreamSpiller(\n             PagesSerde serde,\n             ListeningExecutorService executor,\n             Path spillPath,\n             SpillerStats spillerStats,\n             SpillContext spillContext,\n             LocalMemoryContext memoryContext,\n-            Optional<SpillCipher> spillCipher)\n+            Optional<SpillCipher> spillCipher,\n+            Runnable filesystemErrorHandler)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MzQ2MjY0OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpiller.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxOToyNDo0N1rOGof84A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMToxNzowNFrOGpu81w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTExOTcxMg==", "bodyText": "there is no point to use this.\nshould we wrap this with try-catch so we don't swallow the current exception? If so please extract the method.", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r445119712", "createdAt": "2020-06-24T19:24:47Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpiller.java", "diffHunk": "@@ -150,6 +155,7 @@ private void writePages(Iterator<Page> pageIterator)\n             }\n         }\n         catch (UncheckedIOException | IOException e) {\n+            this.filesystemErrorHandler.run();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQxNDAzOQ==", "bodyText": "Fixed usage of this, where applicable.\nWe could wrap the fileSystemErrorHandler in an exception, but the current impl is LoadingCache::invalidateAll, which doesn't throw an exception.", "url": "https://github.com/trinodb/trino/pull/2581#discussion_r446414039", "createdAt": "2020-06-26T21:17:04Z", "author": {"login": "dfinninger"}, "path": "presto-main/src/main/java/io/prestosql/spiller/FileSingleStreamSpiller.java", "diffHunk": "@@ -150,6 +155,7 @@ private void writePages(Iterator<Page> pageIterator)\n             }\n         }\n         catch (UncheckedIOException | IOException e) {\n+            this.filesystemErrorHandler.run();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTExOTcxMg=="}, "originalCommit": null, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1065, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}