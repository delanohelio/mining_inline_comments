{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxNzEwNDk2", "number": 4924, "title": "Short circuit lazy dynamic filters on Domain.all", "bodyText": "", "createdAt": "2020-08-21T15:47:48Z", "url": "https://github.com/trinodb/trino/pull/4924", "merged": true, "mergeCommit": {"oid": "1fced9e323eba47d18e5e920c332207b6ccdccf2"}, "closed": true, "closedAt": "2020-08-24T09:35:49Z", "author": {"login": "sopel39"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBFw15AH2gAyNDcxNzEwNDk2OjkyOWEwZGNiMDJlM2IyNWZkMzZlOWQ0N2NlNDlkY2YyYmQwMjc1MmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBIPF0gFqTQ3MjY2MzY1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "929a0dcb02e3b25fd36e9d47ce49dcf2bd02752c", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/929a0dcb02e3b25fd36e9d47ce49dcf2bd02752c", "committedDate": "2020-08-21T14:34:02Z", "message": "Don't set future in synchronized context\n\nCalling SettableFuture#set might result\nin callback, which should not be executed in\nsynchronization context."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a05e91fee593162be3ff0325fd916b712b2feacd", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/a05e91fee593162be3ff0325fd916b712b2feacd", "committedDate": "2020-08-21T15:57:57Z", "message": "Short circuit lazy dynamic filters on Domain.all"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "a05e91fee593162be3ff0325fd916b712b2feacd", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/a05e91fee593162be3ff0325fd916b712b2feacd", "committedDate": "2020-08-21T15:57:57Z", "message": "Short circuit lazy dynamic filters on Domain.all"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNjA5NDYx", "url": "https://github.com/trinodb/trino/pull/4924#pullrequestreview-472609461", "createdAt": "2020-08-21T15:59:20Z", "commit": {"oid": "a05e91fee593162be3ff0325fd916b712b2feacd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNjMxODM0", "url": "https://github.com/trinodb/trino/pull/4924#pullrequestreview-472631834", "createdAt": "2020-08-21T16:33:10Z", "commit": {"oid": "a05e91fee593162be3ff0325fd916b712b2feacd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNjYzNjUz", "url": "https://github.com/trinodb/trino/pull/4924#pullrequestreview-472663653", "createdAt": "2020-08-21T17:24:33Z", "commit": {"oid": "929a0dcb02e3b25fd36e9d47ce49dcf2bd02752c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNzoyNDozM1rOHE1TjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNzoyNjo1MFrOHE1X5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyOTcwOA==", "bodyText": "What if two calls to addPartition race with each other? Whoever's watching resultFuture may see one value and miss the other one. If resultFuture is being used in any way other that as a flag to indicate something changed, that would be a problem.", "url": "https://github.com/trinodb/trino/pull/4924#discussion_r474829708", "createdAt": "2020-08-21T17:24:33Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilterConsumer.java", "diffHunk": "@@ -91,16 +91,22 @@ public LocalDynamicFilterConsumer(Multimap<DynamicFilterId, Symbol> probeSymbols\n         return Futures.transform(resultFuture, this::convertTupleDomainForLocalFilters, directExecutor());\n     }\n \n-    private synchronized void addPartition(TupleDomain<DynamicFilterId> tupleDomain)\n+    private void addPartition(TupleDomain<DynamicFilterId> tupleDomain)\n     {\n-        // Called concurrently by each DynamicFilterSourceOperator instance (when collection is over).\n-        verify(partitions.size() < partitionCount);\n-        // NOTE: may result in a bit more relaxed constraint if there are multiple columns and multiple rows.\n-        // See the comment at TupleDomain::columnWiseUnion() for more details.\n-        partitions.add(tupleDomain);\n-        if (partitions.size() == partitionCount) {\n-            TupleDomain<DynamicFilterId> result = TupleDomain.columnWiseUnion(partitions);\n-            // No more partitions are left to be processed.\n+        TupleDomain<DynamicFilterId> result = null;\n+        synchronized (this) {\n+            // Called concurrently by each DynamicFilterSourceOperator instance (when collection is over).\n+            verify(partitions.size() < partitionCount);\n+            // NOTE: may result in a bit more relaxed constraint if there are multiple columns and multiple rows.\n+            // See the comment at TupleDomain::columnWiseUnion() for more details.\n+            partitions.add(tupleDomain);\n+            if (partitions.size() == partitionCount) {\n+                // No more partitions are left to be processed.\n+                result = TupleDomain.columnWiseUnion(partitions);\n+            }\n+        }\n+\n+        if (result != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "929a0dcb02e3b25fd36e9d47ce49dcf2bd02752c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzMDgyMg==", "bodyText": "Not sure I understand why. Aren't the filters \"ANDed\" together?", "url": "https://github.com/trinodb/trino/pull/4924#discussion_r474830822", "createdAt": "2020-08-21T17:26:50Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -268,6 +268,11 @@ void collectDynamicFilters()\n                         .collect(groupingBy(Map.Entry::getKey, mapping(Map.Entry::getValue, toImmutableList())))\n                         .entrySet().stream()\n                         .filter(stageDomains -> {\n+                            if (stageDomains.getValue().stream().anyMatch(Domain::isAll)) {\n+                                // if one of the domains is all, we don't need to get dynamic filters from all tasks", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a05e91fee593162be3ff0325fd916b712b2feacd"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4059, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}