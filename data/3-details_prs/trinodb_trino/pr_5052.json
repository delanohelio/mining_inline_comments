{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3NTIwOTY5", "number": 5052, "title": "Add support for ABFS OAuth 2 authentication", "bodyText": "This PR is based on #4889.\nThe tests need appropriate secrets to run.", "createdAt": "2020-09-02T02:00:09Z", "url": "https://github.com/trinodb/trino/pull/5052", "merged": true, "mergeCommit": {"oid": "cc30d16a7fd7604b758ee554b59a13f9c26b4cf8"}, "closed": true, "closedAt": "2020-09-17T18:36:11Z", "author": {"login": "jirassimok"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE47DVgFqTQ4MDY1MjEwMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJ1ON1gBqjM3NzkzMjc3MTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjUyMTAw", "url": "https://github.com/trinodb/trino/pull/5052#pullrequestreview-480652100", "createdAt": "2020-09-02T09:39:20Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTozOToyMVrOHLnOFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTo1MToxN1rOHLno1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkzODk2NA==", "bodyText": "typo in commit message", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r481938964", "createdAt": "2020-09-02T09:39:21Z", "author": {"login": "losipiuk"}, "path": "presto-hive-hadoop2/bin/common.sh", "diffHunk": "@@ -86,7 +86,7 @@ SCRIPT_DIR=\"${BASH_SOURCE%/*}\"\n INTEGRATION_TESTS_ROOT=\"${SCRIPT_DIR}/..\"\n PROJECT_ROOT=\"${INTEGRATION_TESTS_ROOT}/..\"\n DOCKER_COMPOSE_LOCATION=\"${INTEGRATION_TESTS_ROOT}/conf/docker-compose.yml\"\n-source \"${BASH_SOURCE%/*}/../../presto-product-tests/conf/product-tests-defaults.sh\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk0NDg3MA==", "bodyText": "extend TestHiveAzureConfig", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r481944870", "createdAt": "2020-09-02T09:49:42Z", "author": {"login": "losipiuk"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/azure/HiveAzureConfig.java", "diffHunk": "@@ -118,4 +121,43 @@ public HiveAzureConfig setAdlRefreshUrl(String adlRefreshUrl)\n         this.adlRefreshUrl = adlRefreshUrl;\n         return this;\n     }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk0NTgxNA==", "bodyText": "can you add unit test for this validation rules?", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r481945814", "createdAt": "2020-09-02T09:51:17Z", "author": {"login": "losipiuk"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/azure/PrestoAzureConfigurationInitializer.java", "diffHunk": "@@ -68,6 +71,19 @@ public PrestoAzureConfigurationInitializer(HiveAzureConfig config)\n                     adlClientId.isPresent() && adlCredential.isPresent() && adlRefreshUrl.isPresent(),\n                     \"If any of ADL client ID, credential, and refresh URL are set, all must be set.\");\n         }\n+\n+        this.abfsOAuthClientEndpoint = dropEmpty(config.getAbfsOAuthClientEndpoint());\n+        this.abfsOAuthClientId = dropEmpty(config.getAbfsOAuthClientId());\n+        this.abfsOAuthClientSecret = dropEmpty(config.getAbfsOAuthClientSecret());\n+        if (abfsOAuthClientEndpoint.isPresent() || abfsOAuthClientSecret.isPresent() || abfsOAuthClientId.isPresent()) {\n+            checkArgument(\n+                    abfsOAuthClientEndpoint.isPresent() && abfsOAuthClientId.isPresent() && abfsOAuthClientSecret.isPresent(),\n+                    \"If any of ABFS OAuth2 Client endpoint, ID, and secret are set, all must be set.\");\n+        }\n+\n+        checkArgument(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMjYxNzQz", "url": "https://github.com/trinodb/trino/pull/5052#pullrequestreview-481261743", "createdAt": "2020-09-02T20:08:47Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDowODo0N1rOHMC7EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDozMzoxM1rOHME5Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM5Mjg0OQ==", "bodyText": "Do you need to exclude the new test you added (TestHiveFileSystemAbfsOAuth )?", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r482392849", "createdAt": "2020-09-02T20:08:47Z", "author": {"login": "aalbu"}, "path": "presto-hive-hadoop2/pom.xml", "diffHunk": "@@ -127,7 +127,7 @@\n                                 <exclude>**/TestHiveFileSystemS3.java</exclude>\n                                 <exclude>**/TestHiveFileSystemS3SelectPushdown.java</exclude>\n                                 <exclude>**/TestHiveFileSystemWasb.java</exclude>\n-                                <exclude>**/TestHiveFileSystemAbfs.java</exclude>\n+                                <exclude>**/TestHiveFileSystemAbfsAccessKey.java</exclude>", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM5NzIyNA==", "bodyText": "Perhaps we could just keep a test-hive-hadoop2-abfs1 profile to run both tests.", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r482397224", "createdAt": "2020-09-02T20:11:59Z", "author": {"login": "aalbu"}, "path": "presto-hive-hadoop2/pom.xml", "diffHunk": "@@ -186,15 +186,31 @@\n             </build>\n         </profile>\n         <profile>\n-            <id>test-hive-hadoop2-abfs</id>\n+            <id>test-hive-hadoop2-abfs-access-key</id>\n             <build>\n                 <plugins>\n                     <plugin>\n                         <groupId>org.apache.maven.plugins</groupId>\n                         <artifactId>maven-surefire-plugin</artifactId>\n                         <configuration>\n                             <includes>\n-                                <include>**/TestHiveFileSystemAbfs.java</include>\n+                                <include>**/TestHiveFileSystemAbfsAccessKey.java</include>\n+                            </includes>\n+                        </configuration>\n+                    </plugin>\n+                </plugins>\n+            </build>\n+        </profile>\n+        <profile>\n+            <id>test-hive-hadoop2-abfs-oauth</id>", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQyNTE4Mg==", "bodyText": "That's kind of an unusual contract.  Why do we need an empty HiveAzureConfig as an argument?  The method could just instantiate one.", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r482425182", "createdAt": "2020-09-02T20:33:13Z", "author": {"login": "aalbu"}, "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/AbstractTestHiveFileSystemAbfs.java", "diffHunk": "@@ -106,12 +94,13 @@ private void ensureTableExists(SchemaTableName table, String tableDirectoryName,\n         }\n     }\n \n+    /** Given an empty {@code HiveAzureConfig}, return a configured instance. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 79}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNDU3MTg2", "url": "https://github.com/trinodb/trino/pull/5052#pullrequestreview-482457186", "createdAt": "2020-09-04T08:23:23Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "feb69fc0ae518dc6387aed20da74f5e5e6d8d2aa", "author": {"user": {"login": "jirassimok", "name": "Jacob Ilias Komissar"}}, "url": "https://github.com/trinodb/trino/commit/feb69fc0ae518dc6387aed20da74f5e5e6d8d2aa", "committedDate": "2020-09-09T17:27:43Z", "message": "DO NOT MERGE Show core-site.xml template & restart hive server in ABFS access key tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "feb69fc0ae518dc6387aed20da74f5e5e6d8d2aa", "author": {"user": {"login": "jirassimok", "name": "Jacob Ilias Komissar"}}, "url": "https://github.com/trinodb/trino/commit/feb69fc0ae518dc6387aed20da74f5e5e6d8d2aa", "committedDate": "2020-09-09T17:27:43Z", "message": "DO NOT MERGE Show core-site.xml template & restart hive server in ABFS access key tests"}, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mjg3NTM5", "url": "https://github.com/trinodb/trino/pull/5052#pullrequestreview-486287539", "createdAt": "2020-09-10T20:30:57Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMDozMDo1N1rOHQEqTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMDozNDoxNlrOHQEwaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxNTYyOQ==", "bodyText": "We can shorten these names to drop the redundant \"client\" part and make them more consistent with the others\nAZURE_ABFS_OAUTH_ENDPOINT\nAZURE_ABFS_OAUTH_CLIENTID\nAZURE_ABFS_OAUTH_SECRET", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r486615629", "createdAt": "2020-09-10T20:30:57Z", "author": {"login": "electrum"}, "path": ".github/workflows/ci.yml", "diffHunk": "@@ -137,6 +137,19 @@ jobs:\n             source presto-product-tests/conf/product-tests-${{ matrix.config }}.sh &&\n               presto-hive-hadoop2/bin/run_hive_abfs_access_key_tests.sh\n           fi\n+      - name: Run Hive Azure ABFS OAuth Tests\n+        if: matrix.config != 'config-empty' # Hive 1.x does not support Azure storage\n+        env:\n+          ABFS_CONTAINER: ${{ secrets.AZURE_ABFS_CONTAINER }}\n+          ABFS_ACCOUNT: ${{ secrets.AZURE_ABFS_ACCOUNT }}\n+          ABFS_OAUTH_CLIENT_ENDPOINT: ${{ secrets.AZURE_ABFS_OAUTH_CLIENT_ENDPOINT }}", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxNjUyMA==", "bodyText": "Add a dot after oauth since this is a separate group\nhive.azure.abfs.oauth.client-endpoint\nhive.azure.abfs.oauth.client-id\nhive.azure.abfs.oauth.client-secret", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r486616520", "createdAt": "2020-09-10T20:32:54Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/azure/HiveAzureConfig.java", "diffHunk": "@@ -118,4 +121,43 @@ public HiveAzureConfig setAdlRefreshUrl(String adlRefreshUrl)\n         this.adlRefreshUrl = adlRefreshUrl;\n         return this;\n     }\n+\n+    @ConfigSecuritySensitive\n+    @Config(\"hive.azure.abfs.oauth-client-endpoint\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxNzE5Mg==", "bodyText": "Add test. to all of these so that the names are consistent. Also, it's makes it clear these are test parameters and not system properties getting directly translated to config properties.", "url": "https://github.com/trinodb/trino/pull/5052#discussion_r486617192", "createdAt": "2020-09-10T20:34:16Z", "author": {"login": "electrum"}, "path": "presto-hive-hadoop2/src/test/java/io/prestosql/plugin/hive/TestHiveFileSystemAbfsOAuth.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.plugin.hive;\n+\n+import io.prestosql.plugin.hive.azure.HiveAzureConfig;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Parameters;\n+\n+public class TestHiveFileSystemAbfsOAuth\n+        extends AbstractTestHiveFileSystemAbfs\n+{\n+    private String clientEndpoint;\n+    private String clientId;\n+    private String clientSecret;\n+\n+    @Parameters({\n+            \"hive.hadoop2.metastoreHost\",\n+            \"hive.hadoop2.metastorePort\",\n+            \"hive.hadoop2.databaseName\",\n+            \"test.hive.azure.abfs.container\",\n+            \"test.hive.azure.abfs.storage-account\",\n+            \"test.hive.azure.abfs.test-directory\",\n+            \"hive.azure.abfs.oauth-client-endpoint\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "8db118a96416fe86283ccdbc1de1e9f4e734ac7e", "author": {"user": {"login": "jirassimok", "name": "Jacob Ilias Komissar"}}, "url": "https://github.com/trinodb/trino/commit/8db118a96416fe86283ccdbc1de1e9f4e734ac7e", "committedDate": "2020-09-17T15:29:00Z", "message": "fixup! Add support for ABFS OAuth authentication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67241cf01ba8d3fe1f20f8d0183ba0547a0352c5", "author": {"user": {"login": "jirassimok", "name": "Jacob Ilias Komissar"}}, "url": "https://github.com/trinodb/trino/commit/67241cf01ba8d3fe1f20f8d0183ba0547a0352c5", "committedDate": "2020-09-17T18:22:32Z", "message": "Add support for ABFS OAuth authentication"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8db118a96416fe86283ccdbc1de1e9f4e734ac7e", "author": {"user": {"login": "jirassimok", "name": "Jacob Ilias Komissar"}}, "url": "https://github.com/trinodb/trino/commit/8db118a96416fe86283ccdbc1de1e9f4e734ac7e", "committedDate": "2020-09-17T15:29:00Z", "message": "fixup! Add support for ABFS OAuth authentication"}, "afterCommit": {"oid": "67241cf01ba8d3fe1f20f8d0183ba0547a0352c5", "author": {"user": {"login": "jirassimok", "name": "Jacob Ilias Komissar"}}, "url": "https://github.com/trinodb/trino/commit/67241cf01ba8d3fe1f20f8d0183ba0547a0352c5", "committedDate": "2020-09-17T18:22:32Z", "message": "Add support for ABFS OAuth authentication"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3838, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}