{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5ODI0NDMz", "number": 6158, "title": "Efficiently enumerate symlinked files from manifest", "bodyText": "Get file statuses in bulk when symlinked\nfiles have single common parent directlory.\nSupersedes #5349", "createdAt": "2020-11-30T21:33:23Z", "url": "https://github.com/trinodb/trino/pull/6158", "merged": true, "mergeCommit": {"oid": "cea86fb98aaa7bc20668081589721e7989ccb0f8"}, "closed": true, "closedAt": "2020-12-02T09:54:21Z", "author": {"login": "sopel39"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhsTvJgBqjQwNTQwNTQ5NzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiLfayABqjQwNjE0MjA2MDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "decd097e0e45b8dd8265f71d797866c84f398074", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/decd097e0e45b8dd8265f71d797866c84f398074", "committedDate": "2020-12-01T13:43:17Z", "message": "Extract BackgroundHiveSplitLoader#createHiveSymlinkSplits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMTA2NDcx", "url": "https://github.com/trinodb/trino/pull/6158#pullrequestreview-542106471", "createdAt": "2020-12-01T16:58:01Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNjo1ODowMlrOH82k3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNjo1ODowMlrOH82k3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU3MDc4Mg==", "bodyText": "The test relies on ordering in paths being preserved. Maybe use assertEqualsNoOrder(paths, Streams.stream(splitIterator.get()).map(InternalHiveSplit::getPath).collect(toImmutableList())?", "url": "https://github.com/trinodb/trino/pull/6158#discussion_r533570782", "createdAt": "2020-12-01T16:58:02Z", "author": {"login": "willmostly"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -742,6 +749,81 @@ public void testValidateFileBuckets()\n         BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 30, \"tableName\", \"partitionName\");\n     }\n \n+    @Test\n+    public void testBuildManifestFileIterator()\n+            throws Exception\n+    {\n+        CachingDirectoryLister directoryLister = new CachingDirectoryLister(new Duration(5, TimeUnit.MINUTES), 1000, ImmutableList.of());\n+        Configuration configuration = new Configuration(false);\n+        Properties schema = new Properties();\n+        schema.setProperty(FILE_INPUT_FORMAT, SymlinkTextInputFormat.class.getName());\n+        schema.setProperty(SERIALIZATION_LIB, AVRO.getSerDe());\n+\n+        Path firstFilePath = new Path(\"hdfs://VOL1:9000/db_name/table_name/file1\");\n+        Path secondFilePath = new Path(\"hdfs://VOL1:9000/db_name/table_name/file2\");\n+        List<Path> paths = ImmutableList.of(firstFilePath, secondFilePath);\n+        List<LocatedFileStatus> files = paths.stream()\n+                .map(TestBackgroundHiveSplitLoader::locatedFileStatus)\n+                .collect(toImmutableList());\n+\n+        BackgroundHiveSplitLoader backgroundHiveSplitLoader = backgroundHiveSplitLoader(\n+                files,\n+                directoryLister);\n+        Optional<Iterator<InternalHiveSplit>> splitIterator = backgroundHiveSplitLoader.buildManifestFileIterator(\n+                configuration,\n+                \"partition\",\n+                schema,\n+                ImmutableList.of(),\n+                TupleDomain.all(),\n+                () -> true,\n+                false,\n+                TableToPartitionMapping.empty(),\n+                new Path(\"hdfs://VOL1:9000/db_name/table_name\"),\n+                paths,\n+                true);\n+        assertTrue(splitIterator.isPresent());\n+        List<InternalHiveSplit> splits = Streams.stream(splitIterator.get())\n+                .collect(toImmutableList());\n+        assertEquals(splits.size(), 2);\n+        assertEquals(splits.get(0).getPath(), firstFilePath.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMjU2MjIz", "url": "https://github.com/trinodb/trino/pull/6158#pullrequestreview-542256223", "createdAt": "2020-12-01T20:09:19Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDowOToxOVrOH8924g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDoxNzo0NFrOH8-Jbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MDA4Mg==", "bodyText": "Nit: declare variable as Set", "url": "https://github.com/trinodb/trino/pull/6158#discussion_r533690082", "createdAt": "2020-12-01T20:09:19Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -361,13 +370,40 @@ private void invokeNoMoreSplitsIfNecessary()\n         FileSystem fs = hdfsEnvironment.getFileSystem(hdfsContext, path);\n         boolean s3SelectPushdownEnabled = shouldEnablePushdownForTable(session, table, path.toString(), partition.getPartition());\n \n+        // S3 Select pushdown works at the granularity of individual S3 objects,\n+        // therefore we must not split files when it is enabled.\n+        // Skip header / footer lines are not splittable except for a special case when skip.header.line.count=1\n+        boolean splittable = !s3SelectPushdownEnabled && getFooterCount(schema) == 0 && getHeaderCount(schema) <= 1;\n+\n         if (inputFormat instanceof SymlinkTextInputFormat) {\n             if (tableBucketInfo.isPresent()) {\n                 throw new PrestoException(NOT_SUPPORTED, \"Bucketed table in SymlinkTextInputFormat is not yet supported\");\n             }\n             List<Path> targetPaths = hdfsEnvironment.doAs(\n                     hdfsContext.getIdentity().getUser(),\n                     () -> getTargetPathsFromSymlink(fs, path));\n+            ImmutableSet<Path> parents = targetPaths.stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MTc1NQ==", "bodyText": "For a locally used map, I would just a HashMap", "url": "https://github.com/trinodb/trino/pull/6158#discussion_r533691755", "createdAt": "2020-12-01T20:12:07Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -601,6 +631,63 @@ private void invokeNoMoreSplitsIfNecessary()\n         return lastResult;\n     }\n \n+    @VisibleForTesting\n+    Optional<Iterator<InternalHiveSplit>> buildManifestFileIterator(\n+            Configuration configuration,\n+            String partitionName,\n+            Properties schema,\n+            List<HivePartitionKey> partitionKeys,\n+            TupleDomain<HiveColumnHandle> effectivePredicate,\n+            BooleanSupplier partitionMatchSupplier,\n+            boolean s3SelectPushdownEnabled,\n+            TableToPartitionMapping tableToPartitionMapping,\n+            Path parent,\n+            List<Path> paths,\n+            boolean splittable)\n+            throws IOException\n+    {\n+        FileSystem targetFilesystem = hdfsEnvironment.getFileSystem(hdfsContext, parent);\n+\n+        ImmutableMap.Builder<Path, LocatedFileStatus> fileStatusesBuilder = ImmutableMap.builder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MjQzNQ==", "bodyText": "Move this comment before the \"if\", since it's explaining what it does", "url": "https://github.com/trinodb/trino/pull/6158#discussion_r533692435", "createdAt": "2020-12-01T20:13:23Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -601,6 +631,63 @@ private void invokeNoMoreSplitsIfNecessary()\n         return lastResult;\n     }\n \n+    @VisibleForTesting\n+    Optional<Iterator<InternalHiveSplit>> buildManifestFileIterator(\n+            Configuration configuration,\n+            String partitionName,\n+            Properties schema,\n+            List<HivePartitionKey> partitionKeys,\n+            TupleDomain<HiveColumnHandle> effectivePredicate,\n+            BooleanSupplier partitionMatchSupplier,\n+            boolean s3SelectPushdownEnabled,\n+            TableToPartitionMapping tableToPartitionMapping,\n+            Path parent,\n+            List<Path> paths,\n+            boolean splittable)\n+            throws IOException\n+    {\n+        FileSystem targetFilesystem = hdfsEnvironment.getFileSystem(hdfsContext, parent);\n+\n+        ImmutableMap.Builder<Path, LocatedFileStatus> fileStatusesBuilder = ImmutableMap.builder();\n+        HiveFileIterator fileStatusIterator = new HiveFileIterator(table, parent, targetFilesystem, directoryLister, namenodeStats, IGNORED, false);\n+        fileStatusIterator.forEachRemaining(status -> fileStatusesBuilder.put(getPathWithoutSchemeAndAuthority(status.getPath()), status));\n+\n+        Map<Path, LocatedFileStatus> fileStatuses = fileStatusesBuilder.build();\n+        List<LocatedFileStatus> locatedFileStatuses = new ArrayList<>();\n+        for (Path path : paths) {\n+            LocatedFileStatus status = fileStatuses.get(getPathWithoutSchemeAndAuthority(path));\n+            if (status == null) {\n+                return Optional.empty();\n+                // This check will catch all directories in the manifest since HiveFileIterator will not return any directories.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MzYyOA==", "bodyText": "Remove period at end of description (we don't have that for others)\nLet's use the word \"directory\" instead of \"folder\", since that's the more common term for Hadoop", "url": "https://github.com/trinodb/trino/pull/6158#discussion_r533693628", "createdAt": "2020-12-01T20:15:29Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveConfig.java", "diffHunk": "@@ -1009,4 +1011,17 @@ public HiveConfig setTimestampPrecision(HiveTimestampPrecision timestampPrecisio\n         this.timestampPrecision = timestampPrecision;\n         return this;\n     }\n+\n+    public boolean isOptimizeSymlinkListing()\n+    {\n+        return this.optimizeSymlinkListing;\n+    }\n+\n+    @Config(\"hive.optimize-symlink-listing\")\n+    @ConfigDescription(\"Optimize listing for SymlinkTextFormat tables with files in a single folder.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5NDMwOA==", "bodyText": "Same comments as other description", "url": "https://github.com/trinodb/trino/pull/6158#discussion_r533694308", "createdAt": "2020-12-01T20:16:45Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HiveSessionProperties.java", "diffHunk": "@@ -390,6 +391,11 @@ public HiveSessionProperties(\n                         DYNAMIC_FILTERING_PROBE_BLOCKING_TIMEOUT,\n                         \"Duration to wait for completion of dynamic filters during split generation for probe side table\",\n                         hiveConfig.getDynamicFilteringProbeBlockingTimeout(),\n+                        false),\n+                booleanProperty(\n+                        OPTIMIZE_SYMLINK_LISTING,\n+                        \"Optimize listing for SymlinkTextFormat tables with files in a single folder.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5NDgzMA==", "bodyText": "This can be\n List<InternalHiveSplit> splits = ImmutableList.copyOf(splitIterator.get());", "url": "https://github.com/trinodb/trino/pull/6158#discussion_r533694830", "createdAt": "2020-12-01T20:17:44Z", "author": {"login": "electrum"}, "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/TestBackgroundHiveSplitLoader.java", "diffHunk": "@@ -742,6 +749,81 @@ public void testValidateFileBuckets()\n         BackgroundHiveSplitLoader.validateFileBuckets(bucketFiles, 30, \"tableName\", \"partitionName\");\n     }\n \n+    @Test\n+    public void testBuildManifestFileIterator()\n+            throws Exception\n+    {\n+        CachingDirectoryLister directoryLister = new CachingDirectoryLister(new Duration(5, TimeUnit.MINUTES), 1000, ImmutableList.of());\n+        Configuration configuration = new Configuration(false);\n+        Properties schema = new Properties();\n+        schema.setProperty(FILE_INPUT_FORMAT, SymlinkTextInputFormat.class.getName());\n+        schema.setProperty(SERIALIZATION_LIB, AVRO.getSerDe());\n+\n+        Path firstFilePath = new Path(\"hdfs://VOL1:9000/db_name/table_name/file1\");\n+        Path secondFilePath = new Path(\"hdfs://VOL1:9000/db_name/table_name/file2\");\n+        List<Path> paths = ImmutableList.of(firstFilePath, secondFilePath);\n+        List<LocatedFileStatus> files = paths.stream()\n+                .map(TestBackgroundHiveSplitLoader::locatedFileStatus)\n+                .collect(toImmutableList());\n+\n+        BackgroundHiveSplitLoader backgroundHiveSplitLoader = backgroundHiveSplitLoader(\n+                files,\n+                directoryLister);\n+        Optional<Iterator<InternalHiveSplit>> splitIterator = backgroundHiveSplitLoader.buildManifestFileIterator(\n+                configuration,\n+                \"partition\",\n+                schema,\n+                ImmutableList.of(),\n+                TupleDomain.all(),\n+                () -> true,\n+                false,\n+                TableToPartitionMapping.empty(),\n+                new Path(\"hdfs://VOL1:9000/db_name/table_name\"),\n+                paths,\n+                true);\n+        assertTrue(splitIterator.isPresent());\n+        List<InternalHiveSplit> splits = Streams.stream(splitIterator.get())", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26187760a4079c03f77dac700fc206c36ba2a34c", "author": {"user": {"login": "willmostly", "name": "Will Morrison"}}, "url": "https://github.com/trinodb/trino/commit/26187760a4079c03f77dac700fc206c36ba2a34c", "committedDate": "2020-12-01T21:30:08Z", "message": "Efficiently enumerate symlinked files from manifest\n\nGet file statuses in bulk when symlinked\nfiles have single common parent directory."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "362be2a322602e4ea238cb6c722b5b12bb34f169", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/362be2a322602e4ea238cb6c722b5b12bb34f169", "committedDate": "2020-12-02T09:53:42Z", "message": "Add Parquet symlink table product test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "362be2a322602e4ea238cb6c722b5b12bb34f169", "author": {"user": {"login": "sopel39", "name": "Karol Sobczak"}}, "url": "https://github.com/trinodb/trino/commit/362be2a322602e4ea238cb6c722b5b12bb34f169", "committedDate": "2020-12-02T09:53:42Z", "message": "Add Parquet symlink table product test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2453, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}