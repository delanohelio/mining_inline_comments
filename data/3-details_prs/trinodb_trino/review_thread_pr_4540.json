{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1Mjg2MzI2", "number": 4540, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo0Nzo0NlrOERLLNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo0ODowMFrOERLLkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDQ0MzQxOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/InternalHiveSplitFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo0Nzo0NlrOG1vq8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo1NDowNVrOG1v5pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODc1Mg==", "bodyText": "Wrap here for readability\nsplittable = splittable &&\n        status.getLen() >= minimumSplittableSizeInBytes &&\n        isSplittable(inputFormat, fileSystem, status.getPath());", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459008752", "createdAt": "2020-07-22T18:47:46Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/InternalHiveSplitFactory.java", "diffHunk": "@@ -98,7 +103,7 @@ public String getPartitionName()\n \n     public Optional<InternalHiveSplit> createInternalHiveSplit(LocatedFileStatus status, OptionalInt bucketNumber, boolean splittable, Optional<AcidInfo> acidInfo)\n     {\n-        splittable = splittable && isSplittable(inputFormat, fileSystem, status.getPath());\n+        splittable = splittable && status.getLen() >= minimumSplittableSizeInBytes && isSplittable(inputFormat, fileSystem, status.getPath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxMjUxOA==", "bodyText": "Sure, done.", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459012518", "createdAt": "2020-07-22T18:54:05Z", "author": {"login": "pettyjamesm"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/util/InternalHiveSplitFactory.java", "diffHunk": "@@ -98,7 +103,7 @@ public String getPartitionName()\n \n     public Optional<InternalHiveSplit> createInternalHiveSplit(LocatedFileStatus status, OptionalInt bucketNumber, boolean splittable, Optional<AcidInfo> acidInfo)\n     {\n-        splittable = splittable && isSplittable(inputFormat, fileSystem, status.getPath());\n+        splittable = splittable && status.getLen() >= minimumSplittableSizeInBytes && isSplittable(inputFormat, fileSystem, status.getPath());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODc1Mg=="}, "originalCommit": null, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDQ0NDMyOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo0ODowMFrOG1vrgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNjo1MTowOFrOG2TI_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODg5Nw==", "bodyText": "These should be getMaxInitialSplitSize(), otherwise we won't split files that are between the initial size and max size (default in the 32MB to 64MB range).", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459008897", "createdAt": "2020-07-22T18:48:00Z", "author": {"login": "electrum"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -375,6 +376,7 @@ private void invokeNoMoreSplitsIfNecessary()\n                         partitionMatchSupplier,\n                         partition.getTableToPartitionMapping(),\n                         Optional.empty(),\n+                        getMaxSplitSize(session),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxMjM1MA==", "bodyText": "I can see the argument either way here actually. It's true that this would bypass the initial split size logic, but when splits are smaller than 64MB do we really want to spend time trying to split them into parts or do we want to bias towards avoiding the isSplittable check?\nI've been leaning towards this iteration, especially since there will only be a difference for the first X splits generated but I could be convinced to go the other way on it.", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459012350", "createdAt": "2020-07-22T18:53:47Z", "author": {"login": "pettyjamesm"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -375,6 +376,7 @@ private void invokeNoMoreSplitsIfNecessary()\n                         partitionMatchSupplier,\n                         partition.getTableToPartitionMapping(),\n                         Optional.empty(),\n+                        getMaxSplitSize(session),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODg5Nw=="}, "originalCommit": null, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzMDUzMw==", "bodyText": "The initial split size is about increasing parallelism for small tables, so I would say we do what that.", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459030533", "createdAt": "2020-07-22T19:26:34Z", "author": {"login": "dain"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -375,6 +376,7 @@ private void invokeNoMoreSplitsIfNecessary()\n                         partitionMatchSupplier,\n                         partition.getTableToPartitionMapping(),\n                         Optional.empty(),\n+                        getMaxSplitSize(session),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODg5Nw=="}, "originalCommit": null, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2MDM2MA==", "bodyText": "It's worth noting that this interacts with the behavior change in #4485. When producing initial splits from files between maxInitialSplitSize and maxSplitSize (32MB and 64MB respectively by default):\n\nIf we choose max initial split size as the threshold, those will yield initial splits in the range of 16-32MB because they will be considered splitable and then split into equal portions.\nIf we choose max split size as the threshold, files those will yield a single split between 32-64MB past which point this difference is not especially material because standard split generation logic holds.", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459060360", "createdAt": "2020-07-22T20:22:33Z", "author": {"login": "pettyjamesm"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -375,6 +376,7 @@ private void invokeNoMoreSplitsIfNecessary()\n                         partitionMatchSupplier,\n                         partition.getTableToPartitionMapping(),\n                         Optional.empty(),\n+                        getMaxSplitSize(session),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODg5Nw=="}, "originalCommit": null, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4OTg4NA==", "bodyText": "After some offline discussion, I'm in the camp now where I think that max initial split size is the right trade off here. Since the code already reflects that, this is ready for re-review.", "url": "https://github.com/trinodb/trino/pull/4540#discussion_r459589884", "createdAt": "2020-07-23T16:51:08Z", "author": {"login": "pettyjamesm"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/BackgroundHiveSplitLoader.java", "diffHunk": "@@ -375,6 +376,7 @@ private void invokeNoMoreSplitsIfNecessary()\n                         partitionMatchSupplier,\n                         partition.getTableToPartitionMapping(),\n                         Optional.empty(),\n+                        getMaxSplitSize(session),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODg5Nw=="}, "originalCommit": null, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3735, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}