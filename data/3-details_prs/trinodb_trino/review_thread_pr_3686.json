{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NjA3OTU5", "number": 3686, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQyMjoyNTo1MVrOD66KfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMTozODowMVrOD8qJrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMDk2OTU2OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/planner/optimizations/AddExchanges.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQyMjoyNTo1MVrOGS-pKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwNzo1OToxMlrOGTBxsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1Mzg5Nw==", "bodyText": "should this be applied when child.getProperties().isNodePartitionedOn(partitioningRequirement) && node.hasEmptyGroupingSet()?", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r422553897", "createdAt": "2020-05-09T22:25:51Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/optimizations/AddExchanges.java", "diffHunk": "@@ -227,7 +227,8 @@ public PlanWithProperties visitAggregation(AggregationNode node, PreferredProper\n                         gatheringExchange(idAllocator.getNextId(), REMOTE, child.getNode()),\n                         child.getProperties());\n             }\n-            else if (!child.getProperties().isStreamPartitionedOn(partitioningRequirement) && !child.getProperties().isNodePartitionedOn(partitioningRequirement)) {\n+            else if ((!child.getProperties().isStreamPartitionedOn(partitioningRequirement) && !child.getProperties().isNodePartitionedOn(partitioningRequirement)) ||\n+                    node.hasEmptyGroupingSet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1NTA5OA==", "bodyText": "Yes, it has to be applied unconditionally. In the sample query, the subquery is partitioned in a compatible way and it prevents the partial from being pushed down beyond the exchange, which causes the failure.", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r422555098", "createdAt": "2020-05-09T22:40:06Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/optimizations/AddExchanges.java", "diffHunk": "@@ -227,7 +227,8 @@ public PlanWithProperties visitAggregation(AggregationNode node, PreferredProper\n                         gatheringExchange(idAllocator.getNextId(), REMOTE, child.getNode()),\n                         child.getProperties());\n             }\n-            else if (!child.getProperties().isStreamPartitionedOn(partitioningRequirement) && !child.getProperties().isNodePartitionedOn(partitioningRequirement)) {\n+            else if ((!child.getProperties().isStreamPartitionedOn(partitioningRequirement) && !child.getProperties().isNodePartitionedOn(partitioningRequirement)) ||\n+                    node.hasEmptyGroupingSet()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1Mzg5Nw=="}, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYwNDU1Mw==", "bodyText": "if it is already repartitioned in the compatible way, maybe we don't need a partial?", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r422604553", "createdAt": "2020-05-10T07:54:33Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/optimizations/AddExchanges.java", "diffHunk": "@@ -227,7 +227,8 @@ public PlanWithProperties visitAggregation(AggregationNode node, PreferredProper\n                         gatheringExchange(idAllocator.getNextId(), REMOTE, child.getNode()),\n                         child.getProperties());\n             }\n-            else if (!child.getProperties().isStreamPartitionedOn(partitioningRequirement) && !child.getProperties().isNodePartitionedOn(partitioningRequirement)) {\n+            else if ((!child.getProperties().isStreamPartitionedOn(partitioningRequirement) && !child.getProperties().isNodePartitionedOn(partitioningRequirement)) ||\n+                    node.hasEmptyGroupingSet()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1Mzg5Nw=="}, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYwNDkxNQ==", "bodyText": "Partials and remote exchanges are required when default aggregation is present. Each partial aggregation produces default value and such rows are then aggregated in final exchange so that only single default value is outputted", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r422604915", "createdAt": "2020-05-10T07:57:00Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/optimizations/AddExchanges.java", "diffHunk": "@@ -227,7 +227,8 @@ public PlanWithProperties visitAggregation(AggregationNode node, PreferredProper\n                         gatheringExchange(idAllocator.getNextId(), REMOTE, child.getNode()),\n                         child.getProperties());\n             }\n-            else if (!child.getProperties().isStreamPartitionedOn(partitioningRequirement) && !child.getProperties().isNodePartitionedOn(partitioningRequirement)) {\n+            else if ((!child.getProperties().isStreamPartitionedOn(partitioningRequirement) && !child.getProperties().isNodePartitionedOn(partitioningRequirement)) ||\n+                    node.hasEmptyGroupingSet()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1Mzg5Nw=="}, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYwNTIzMg==", "bodyText": "Makes sense, thanks for explanation. Maybe let's capture this as a code comment.", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r422605232", "createdAt": "2020-05-10T07:59:12Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/optimizations/AddExchanges.java", "diffHunk": "@@ -227,7 +227,8 @@ public PlanWithProperties visitAggregation(AggregationNode node, PreferredProper\n                         gatheringExchange(idAllocator.getNextId(), REMOTE, child.getNode()),\n                         child.getProperties());\n             }\n-            else if (!child.getProperties().isStreamPartitionedOn(partitioningRequirement) && !child.getProperties().isNodePartitionedOn(partitioningRequirement)) {\n+            else if ((!child.getProperties().isStreamPartitionedOn(partitioningRequirement) && !child.getProperties().isNodePartitionedOn(partitioningRequirement)) ||\n+                    node.hasEmptyGroupingSet()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU1Mzg5Nw=="}, "originalCommit": null, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NzQ2MzU4OnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestLogicalPlanner.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMzozNjoxNFrOGVcl2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMzozNjoxNFrOGVcl2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE0MTcyMQ==", "bodyText": "each arg in newline", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r425141721", "createdAt": "2020-05-14T13:36:14Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestLogicalPlanner.java", "diffHunk": "@@ -1377,6 +1377,25 @@ public void testRemoveRedundantRightJoin()\n                         values(ImmutableList.of(\"regionkey\"))));\n     }\n \n+    @Test\n+    public void testGroupingSetsWithDefaultValue()\n+    {\n+        assertDistributedPlan(\"SELECT orderkey, COUNT(DISTINCT k) FROM (SELECT orderkey, 1 k FROM orders) GROUP BY GROUPING SETS ((), orderkey)\",\n+                output(\n+                        anyTree(\n+                                aggregation(\n+                                        ImmutableMap.of(\"final_count\", functionCall(\"count\", ImmutableList.of(\"partial_count\"))),\n+                                        FINAL,\n+                                        exchange(LOCAL, REPARTITION,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0OTMxNzU3OnYy", "diffSide": "RIGHT", "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueries.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMTozODowMVrOGVvJ6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMTozODowMVrOGVvJ6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ0NTg2Nw==", "bodyText": "this should go to AbstractTestAggregations", "url": "https://github.com/trinodb/trino/pull/3686#discussion_r425445867", "createdAt": "2020-05-14T21:38:01Z", "author": {"login": "sopel39"}, "path": "presto-testing/src/main/java/io/prestosql/testing/AbstractTestQueries.java", "diffHunk": "@@ -1924,4 +1924,12 @@ public void testSubqueriesWithDisjunction()\n                         \"LIMIT 2\",\n                 \"VALUES true, null\");\n     }\n+\n+    @Test\n+    public void testGroupingSetsWithDefaultValue() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 75, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}