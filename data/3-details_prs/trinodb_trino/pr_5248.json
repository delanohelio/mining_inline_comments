{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNTA3NTc0", "number": 5248, "title": "Simplify dynamic filter matching in plans", "bodyText": "", "createdAt": "2020-09-21T19:20:39Z", "url": "https://github.com/trinodb/trino/pull/5248", "merged": true, "mergeCommit": {"oid": "f537bdb9058baf9080ca7c7c859b69f21bff3621"}, "closed": true, "closedAt": "2020-09-23T10:54:07Z", "author": {"login": "raunaqmorarka"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLJXTWABqjM3OTA0Mzg4NzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLqXrugFqTQ5NDUzMjYyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMjk1MjQ5", "url": "https://github.com/trinodb/trino/pull/5248#pullrequestreview-493295249", "createdAt": "2020-09-22T09:50:03Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOTo1MDowM1rOHVyeAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOTo1MDowM1rOHVyeAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYwOTAyNw==", "bodyText": "testNestedDynamicFiltersRemoval supposedly tests that the filter got removed\nbut, with anyTree here, we can't really know, can we?", "url": "https://github.com/trinodb/trino/pull/5248#discussion_r492609027", "createdAt": "2020-09-22T09:50:03Z", "author": {"login": "findepi"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestDynamicFilter.java", "diffHunk": "@@ -254,8 +261,8 @@ public void testNestedDynamicFiltersRemoval()\n                                 INNER,\n                                 ImmutableList.of(equiJoinClause(\"ORDERS_CK\", \"ORDERS_CK6\")),\n                                 ImmutableMap.of(\"ORDERS_CK\", \"ORDERS_CK6\"),\n-                                Optional.empty(),\n-                                tableScan(\"orders\", ImmutableMap.of(\"ORDERS_CK\", \"clerk\")),\n+                                anyTree(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMzAwMzIy", "url": "https://github.com/trinodb/trino/pull/5248#pullrequestreview-493300322", "createdAt": "2020-09-22T09:56:46Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOTo1Njo0NlrOHVytFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMDozNDoyMlrOHVz69g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYxMjg4Nw==", "bodyText": "Could we collect Symbol -> DynamicFilterId mapping instead (like actualSymbolToFilterId)? That would correspond to direction from expectedDynamicFilterAliases and won't require multimap", "url": "https://github.com/trinodb/trino/pull/5248#discussion_r492612887", "createdAt": "2020-09-22T09:56:46Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/assertions/JoinMatcher.java", "diffHunk": "@@ -116,11 +131,48 @@ public MatchResult detailMatches(PlanNode node, StatsProvider stats, Session ses\n             return NO_MATCH;\n         }\n \n-        if (dynamicFilter.isPresent() && !dynamicFilter.get().match(joinNode, symbolAliases).isMatch()) {\n-            return NO_MATCH;\n+        return new MatchResult(matchDynamicFilters(joinNode, symbolAliases));\n+    }\n+\n+    private boolean matchDynamicFilters(JoinNode joinNode, SymbolAliases symbolAliases)\n+    {\n+        if (expectedDynamicFilterAliases.isEmpty()) {\n+            return true;\n+        }\n+        Set<DynamicFilterId> dynamicFilterIds = joinNode.getDynamicFilters().keySet();\n+        Multimap<DynamicFilterId, Symbol> idToProbeSymbolMultiMap = searchFrom(joinNode.getLeft())", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzMDYxMQ==", "bodyText": "I think this test requires some comment. As I read it now, I'm not sure what nested DF this test is about.", "url": "https://github.com/trinodb/trino/pull/5248#discussion_r492630611", "createdAt": "2020-09-22T10:30:07Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestDynamicFilter.java", "diffHunk": "@@ -254,8 +261,8 @@ public void testNestedDynamicFiltersRemoval()\n                                 INNER,\n                                 ImmutableList.of(equiJoinClause(\"ORDERS_CK\", \"ORDERS_CK6\")),\n                                 ImmutableMap.of(\"ORDERS_CK\", \"ORDERS_CK6\"),\n-                                Optional.empty(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzMjMzMQ==", "bodyText": "nit: we could use DynamicFilters#createDynamicFilterExpression as in  TestRemoveUnsupportedDynamicFilters#testDynamicFilterConsumedOnBuildSide to be little more explicit\nAt least please validate that there is filter node above table scan", "url": "https://github.com/trinodb/trino/pull/5248#discussion_r492632331", "createdAt": "2020-09-22T10:33:29Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestDynamicFilter.java", "diffHunk": "@@ -101,8 +103,8 @@ public void testJoin()\n                                 INNER,\n                                 ImmutableList.of(equiJoinClause(\"ORDERS_OK\", \"LINEITEM_OK\")),\n                                 ImmutableMap.of(\"ORDERS_OK\", \"LINEITEM_OK\"),\n-                                Optional.empty(),\n-                                tableScan(\"orders\", ImmutableMap.of(\"ORDERS_OK\", \"orderkey\")),\n+                                anyTree(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzMjgyMg==", "bodyText": "could we enhance io.prestosql.sql.planner.optimizations.TestRemoveUnsupportedDynamicFilters tests as part of this PR. Currently, these tests don't validate that joins no longer have DF.", "url": "https://github.com/trinodb/trino/pull/5248#discussion_r492632822", "createdAt": "2020-09-22T10:34:22Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestDynamicFilter.java", "diffHunk": "@@ -72,6 +72,7 @@ public void testNonInnerJoin()\n                         join(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "967449042ad649e4f288c4695793559329735377", "author": {"user": {"login": "raunaqmorarka", "name": "Raunaq Morarka"}}, "url": "https://github.com/trinodb/trino/commit/967449042ad649e4f288c4695793559329735377", "committedDate": "2020-09-23T09:46:28Z", "message": "Simplify dynamic filter matching in plans"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "967449042ad649e4f288c4695793559329735377", "author": {"user": {"login": "raunaqmorarka", "name": "Raunaq Morarka"}}, "url": "https://github.com/trinodb/trino/commit/967449042ad649e4f288c4695793559329735377", "committedDate": "2020-09-23T09:46:28Z", "message": "Simplify dynamic filter matching in plans"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NTMyNjI5", "url": "https://github.com/trinodb/trino/pull/5248#pullrequestreview-494532629", "createdAt": "2020-09-23T10:50:01Z", "commit": {"oid": "967449042ad649e4f288c4695793559329735377"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMDo1MDowMlrOHWlYCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMDo1MDowMlrOHWlYCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ0MzA4Mg==", "bodyText": "How does it become part of nested expression? I don't see this.", "url": "https://github.com/trinodb/trino/pull/5248#discussion_r493443082", "createdAt": "2020-09-23T10:50:02Z", "author": {"login": "sopel39"}, "path": "presto-main/src/test/java/io/prestosql/sql/planner/TestDynamicFilter.java", "diffHunk": "@@ -254,8 +261,8 @@ public void testNestedDynamicFiltersRemoval()\n                                 INNER,\n                                 ImmutableList.of(equiJoinClause(\"ORDERS_CK\", \"ORDERS_CK6\")),\n                                 ImmutableMap.of(\"ORDERS_CK\", \"ORDERS_CK6\"),\n-                                Optional.empty(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYzMDYxMQ=="}, "originalCommit": null, "originalPosition": 106}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3699, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}