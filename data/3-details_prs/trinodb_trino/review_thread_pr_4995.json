{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0NDQ3NzI1", "number": 4995, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwNzowMjo1NlrOEdFriQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwNTowMDoxNVrOEivtng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4OTM3MjI1OnYy", "diffSide": "RIGHT", "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwNzowMjo1NlrOHIDC4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwODowNjozMVrOHIFFKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIwMDU0Nw==", "bodyText": "If we change to CTAS from the current implementation, it breaks the existing behavior when GTID mode is on. We need to look for other approach (e.g. Use CREATE TABLE LIKE only when GTID mode is on or just adding cofiguration).", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r478200547", "createdAt": "2020-08-27T07:02:56Z", "author": {"login": "ebyhr"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -307,8 +307,9 @@ public void renameColumn(JdbcIdentity identity, JdbcTableHandle handle, JdbcColu\n     @Override\n     protected void copyTableSchema(Connection connection, String catalogName, String schemaName, String tableName, String newTableName, List<String> columnNames)\n     {\n+        // Create a temporary table not only include columns to be inserted but all columns,  Need them for `NOT NULL` check.\n         String sql = format(\n-                \"CREATE TABLE %s LIKE %s\",\n+                \"CREATE TABLE %s AS SELECT * FROM %s WHERE 0 = 1\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIzMTk4NQ==", "bodyText": "do we have tests for this? or not possible? (sorry, dont remember)\n(sadly, all checks paassd... )", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r478231985", "createdAt": "2020-08-27T08:03:01Z", "author": {"login": "findepi"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -307,8 +307,9 @@ public void renameColumn(JdbcIdentity identity, JdbcTableHandle handle, JdbcColu\n     @Override\n     protected void copyTableSchema(Connection connection, String catalogName, String schemaName, String tableName, String newTableName, List<String> columnNames)\n     {\n+        // Create a temporary table not only include columns to be inserted but all columns,  Need them for `NOT NULL` check.\n         String sql = format(\n-                \"CREATE TABLE %s LIKE %s\",\n+                \"CREATE TABLE %s AS SELECT * FROM %s WHERE 0 = 1\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIwMDU0Nw=="}, "originalCommit": null, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIzMjcxMQ==", "bodyText": "I see, CTAS not working in GTID mode. I found this issue  #2251", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r478232711", "createdAt": "2020-08-27T08:04:20Z", "author": {"login": "ssquan"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -307,8 +307,9 @@ public void renameColumn(JdbcIdentity identity, JdbcTableHandle handle, JdbcColu\n     @Override\n     protected void copyTableSchema(Connection connection, String catalogName, String schemaName, String tableName, String newTableName, List<String> columnNames)\n     {\n+        // Create a temporary table not only include columns to be inserted but all columns,  Need them for `NOT NULL` check.\n         String sql = format(\n-                \"CREATE TABLE %s LIKE %s\",\n+                \"CREATE TABLE %s AS SELECT * FROM %s WHERE 0 = 1\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIwMDU0Nw=="}, "originalCommit": null, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIzMzg5OA==", "bodyText": "do we have tests for this? or not possible? (sorry, dont remember)\n(sadly, all checks paassd... )\n\n@ebyhr just file an issue to add tests in GTID mode :) #4997", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r478233898", "createdAt": "2020-08-27T08:06:31Z", "author": {"login": "ssquan"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -307,8 +307,9 @@ public void renameColumn(JdbcIdentity identity, JdbcTableHandle handle, JdbcColu\n     @Override\n     protected void copyTableSchema(Connection connection, String catalogName, String schemaName, String tableName, String newTableName, List<String> columnNames)\n     {\n+        // Create a temporary table not only include columns to be inserted but all columns,  Need them for `NOT NULL` check.\n         String sql = format(\n-                \"CREATE TABLE %s LIKE %s\",\n+                \"CREATE TABLE %s AS SELECT * FROM %s WHERE 0 = 1\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIwMDU0Nw=="}, "originalCommit": null, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMjE0MjUxOnYy", "diffSide": "RIGHT", "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMzoyNDozMVrOHJ4uIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMzoyNDozMVrOHJ4uIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEyODU0Ng==", "bodyText": "Move this method to after jsonColumnMapping method.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean isGTIDMode(Connection connection)\n          \n          \n            \n                private boolean isGtidMode(Connection connection)", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r480128546", "createdAt": "2020-08-31T13:24:31Z", "author": {"login": "ebyhr"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -268,6 +268,21 @@ else if (varcharType.getBoundedLength() <= 16777215) {\n         return super.toWriteMapping(session, type);\n     }\n \n+    private boolean isGTIDMode(Connection connection)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMjE3MjU2OnYy", "diffSide": "RIGHT", "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMzozMjoyNFrOHJ5AVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMzozMjoyNFrOHJ5AVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzMzIwNg==", "bodyText": "We can make this line try-with-resources and please upper case for keywords.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ResultSet resultSet = statement.executeQuery(\"show variables like 'gtid_mode'\");\n          \n          \n            \n                        ResultSet resultSet = statement.executeQuery(\"SHOW VARIABLES LIKE 'gtid_mode'\");", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r480133206", "createdAt": "2020-08-31T13:32:24Z", "author": {"login": "ebyhr"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -268,6 +268,21 @@ else if (varcharType.getBoundedLength() <= 16777215) {\n         return super.toWriteMapping(session, type);\n     }\n \n+    private boolean isGTIDMode(Connection connection)\n+    {\n+        try (java.sql.Statement statement = connection.createStatement()) {\n+            ResultSet resultSet = statement.executeQuery(\"show variables like 'gtid_mode'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMjIwMjYxOnYy", "diffSide": "RIGHT", "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMzo0MDowMVrOHJ5SPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwNzoyOToxN1rOHLgo8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzNzc5MA==", "bodyText": "ON_PERMISSIVE is also possible value.", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r480137790", "createdAt": "2020-08-31T13:40:01Z", "author": {"login": "ebyhr"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -268,6 +268,21 @@ else if (varcharType.getBoundedLength() <= 16777215) {\n         return super.toWriteMapping(session, type);\n     }\n \n+    private boolean isGTIDMode(Connection connection)\n+    {\n+        try (java.sql.Statement statement = connection.createStatement()) {\n+            ResultSet resultSet = statement.executeQuery(\"show variables like 'gtid_mode'\");\n+            if (resultSet.next()) {\n+                return resultSet.getString(\"Value\").equalsIgnoreCase(\"ON\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgzMTE1Mw==", "bodyText": "I use a not OFF mode check here to consider OFF_PERMISSIVE \u3001ON__PERMISSIVE and ON modes at the same time. Mysql may use GTID-based replication in OFF_PERMISSIVE mode according to MySQL dev doc", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r481831153", "createdAt": "2020-09-02T07:29:17Z", "author": {"login": "ssquan"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -268,6 +268,21 @@ else if (varcharType.getBoundedLength() <= 16777215) {\n         return super.toWriteMapping(session, type);\n     }\n \n+    private boolean isGTIDMode(Connection connection)\n+    {\n+        try (java.sql.Statement statement = connection.createStatement()) {\n+            ResultSet resultSet = statement.executeQuery(\"show variables like 'gtid_mode'\");\n+            if (resultSet.next()) {\n+                return resultSet.getString(\"Value\").equalsIgnoreCase(\"ON\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzNzc5MA=="}, "originalCommit": null, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMTY1ODk3OnYy", "diffSide": "RIGHT", "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwNDoyMjoyM1rOHLWCuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwNDoyMjoyM1rOHLWCuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTY1NzUzMQ==", "bodyText": "You don't need to split into 2 try.", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r481657531", "createdAt": "2020-09-02T04:22:23Z", "author": {"login": "ebyhr"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -344,6 +348,22 @@ private ColumnMapping jsonColumnMapping()\n                 DISABLE_PUSHDOWN);\n     }\n \n+    private boolean isGtidMode(Connection connection)\n+    {\n+        try (java.sql.Statement statement = connection.createStatement()) {\n+            try (ResultSet resultSet = statement.executeQuery(\"SHOW VARIABLES LIKE 'gtid_mode'\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0ODY4NzY2OnYy", "diffSide": "RIGHT", "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwNTowMDoxNVrOHQyn2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwNTowMDoxNVrOHQyn2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM2ODY2NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean isGtidMode(Connection connection)\n          \n          \n            \n                private static boolean isGtidMode(Connection connection)", "url": "https://github.com/trinodb/trino/pull/4995#discussion_r487368664", "createdAt": "2020-09-12T05:00:15Z", "author": {"login": "ebyhr"}, "path": "presto-mysql/src/main/java/io/prestosql/plugin/mysql/MySqlClient.java", "diffHunk": "@@ -344,6 +348,21 @@ private ColumnMapping jsonColumnMapping()\n                 DISABLE_PUSHDOWN);\n     }\n \n+    private boolean isGtidMode(Connection connection)", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3344, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}