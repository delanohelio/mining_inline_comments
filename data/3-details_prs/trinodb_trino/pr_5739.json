{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNDAwOTk3", "number": 5739, "title": "Simplify HivePageSource bucket filtering", "bodyText": "Extracted and adapted changes from prestodb/presto#15373\nAdds an early return path for when all rows or no rows are filtered as inelligible as part of bucket adaptation in HivePageSource", "createdAt": "2020-10-29T16:24:59Z", "url": "https://github.com/trinodb/trino/pull/5739", "merged": true, "mergeCommit": {"oid": "20a9be5406667c3c4b68025d8ca19afad1d23b3f"}, "closed": true, "closedAt": "2020-10-30T21:34:58Z", "author": {"login": "pettyjamesm"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXWkergBqjM5Mzc4MzE0Mjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXmUhVABqjM5NDEwNzIxMDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMTA4Mzk5", "url": "https://github.com/trinodb/trino/pull/5739#pullrequestreview-520108399", "createdAt": "2020-10-29T21:39:44Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMTozOTo0NFrOHqvtEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMTo0NDoyNFrOHqv1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU4MzgyNA==", "bodyText": "That's a bug fix. Please make it into a separate commit.\nIs it possible to test? Are we having similar problem somewhere else?", "url": "https://github.com/trinodb/trino/pull/5739#discussion_r514583824", "createdAt": "2020-10-29T21:39:44Z", "author": {"login": "findepi"}, "path": "presto-main/src/main/java/io/prestosql/testing/MaterializedResult.java", "diffHunk": "@@ -397,7 +397,7 @@ public static MaterializedResult materializeSourceDataStream(ConnectorSession se\n         while (!pageSource.isFinished()) {\n             Page outputPage = pageSource.getNextPage();\n             if (outputPage == null) {\n-                break;\n+                continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU4NTY3OA==", "bodyText": "kept -> retained", "url": "https://github.com/trinodb/trino/pull/5739#discussion_r514585678", "createdAt": "2020-10-29T21:43:57Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HivePageSource.java", "diffHunk": "@@ -631,7 +626,14 @@ public IntArrayList computeEligibleRowIds(Page page)\n                     ids.add(position);\n                 }\n             }\n-            return ids;\n+            int keptRowCount = ids.size();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU4NTkwOA==", "bodyText": "i think the comments are redundant, but up to you", "url": "https://github.com/trinodb/trino/pull/5739#discussion_r514585908", "createdAt": "2020-10-29T21:44:24Z", "author": {"login": "findepi"}, "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/HivePageSource.java", "diffHunk": "@@ -631,7 +626,14 @@ public IntArrayList computeEligibleRowIds(Page page)\n                     ids.add(position);\n                 }\n             }\n-            return ids;\n+            int keptRowCount = ids.size();\n+            if (keptRowCount == 0) {\n+                return null; // Empty page after filtering\n+            }\n+            if (keptRowCount == page.getPositionCount()) {\n+                return page; // Unchanged after filtering", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f9ce5e58d572d59ea29179945c65999374fa7fa", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/7f9ce5e58d572d59ea29179945c65999374fa7fa", "committedDate": "2020-10-30T12:54:26Z", "message": "Fix MaterializedResult PageSource handling bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b8a1aa9928eadca25f493930354ecb1b3de232c", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/2b8a1aa9928eadca25f493930354ecb1b3de232c", "committedDate": "2020-10-30T12:55:40Z", "message": "Simplify HivePageSource bucket filtering\n\nAdds an early return path for when all rows or no rows are filtered\nas inelligible as part of bucket adaptation in HivePageSource"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "2b8a1aa9928eadca25f493930354ecb1b3de232c", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/trinodb/trino/commit/2b8a1aa9928eadca25f493930354ecb1b3de232c", "committedDate": "2020-10-30T12:55:40Z", "message": "Simplify HivePageSource bucket filtering\n\nAdds an early return path for when all rows or no rows are filtered\nas inelligible as part of bucket adaptation in HivePageSource"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2681, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}