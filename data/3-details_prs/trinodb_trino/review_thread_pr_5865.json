{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MTI1MzAw", "number": 5865, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMjoyNzo0M1rOE4I6Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMTo1NzowMFrOFF001A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MzAxNjc5OnYy", "diffSide": "RIGHT", "path": "presto-bigquery/src/test/java/io/prestosql/plugin/bigquery/TestBigQueryIntegrationSmokeTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMjoyNzo0M1rOHx4jnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMjoyNzo0M1rOHx4jnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA2ODg5Mg==", "bodyText": "Can you please add two rows to a table, so the expected count(*) with and without filters is different?", "url": "https://github.com/trinodb/trino/pull/5865#discussion_r522068892", "createdAt": "2020-11-12T12:27:43Z", "author": {"login": "losipiuk"}, "path": "presto-bigquery/src/test/java/io/prestosql/plugin/bigquery/TestBigQueryIntegrationSmokeTest.java", "diffHunk": "@@ -105,6 +105,33 @@ public void testPredicatePushdownPrunnedColumns()\n                 \"VALUES (1)\");\n     }\n \n+    @Test(description = \"regression test for https://github.com/prestosql/presto/issues/5635\")\n+    public void testCountAggregationView()\n+    {\n+        BigQuery client = createBigQueryClient();\n+\n+        String tableName = \"test.count_aggregation_table\";\n+        String viewName = \"test.count_aggregation_view\";\n+\n+        executeBigQuerySql(client, \"DROP TABLE IF EXISTS \" + tableName);\n+        executeBigQuerySql(client, \"DROP VIEW IF EXISTS \" + viewName);\n+        executeBigQuerySql(client, \"CREATE TABLE \" + tableName + \" (a INT64, b INT64, c INT64)\");\n+        executeBigQuerySql(client, \"INSERT INTO \" + tableName + \" VALUES (1, 2, 3)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxNjUyNjkyOnYy", "diffSide": "RIGHT", "path": "presto-bigquery/src/main/java/io/prestosql/plugin/bigquery/BigQuerySplitManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMTo1NzowMFrOIGhw_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMToyMjoyNlrOIGnXTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcxNTU4Mw==", "bodyText": "Notice that unless there's some caching on the materialized tables references, then any call to count(*) will trigger a new query and create a new table - incurring additional costs on the users. Another approach is to trigger a sql SELECT COUNT(*) FROM view and use the result, which will give BigQuery the option to use some optimizations.", "url": "https://github.com/trinodb/trino/pull/5865#discussion_r543715583", "createdAt": "2020-12-15T21:57:00Z", "author": {"login": "davidrabinowitz"}, "path": "presto-bigquery/src/main/java/io/prestosql/plugin/bigquery/BigQuerySplitManager.java", "diffHunk": "@@ -124,8 +128,22 @@ private static boolean emptyProjectionIsRequired(Optional<List<ColumnHandle>> pr\n                 numberOfRows = result.iterateAll().iterator().next().get(0).getLongValue();\n             }\n             else {\n-                // no filters, so we can take the value from the table info\n-                numberOfRows = bigQueryClient.getTable(tableId).getNumRows().longValue();\n+                // no filters, so we can take the value from the table info when the object is TABLE\n+                TableInfo tableInfo = bigQueryClient.getTable(tableId);\n+                if (tableInfo.getDefinition().getType() == TABLE) {\n+                    numberOfRows = tableInfo.getNumRows().longValue();\n+                }\n+                else if (tableInfo.getDefinition().getType() == VIEW) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgwNzMwOA==", "bodyText": "Thanks. As I left to PR description, I considered your \"another\" approach as well. If BigQuery optimizes the aggregation query internally, I would choose COUNT(*) query approach.", "url": "https://github.com/trinodb/trino/pull/5865#discussion_r543807308", "createdAt": "2020-12-16T01:22:26Z", "author": {"login": "ebyhr"}, "path": "presto-bigquery/src/main/java/io/prestosql/plugin/bigquery/BigQuerySplitManager.java", "diffHunk": "@@ -124,8 +128,22 @@ private static boolean emptyProjectionIsRequired(Optional<List<ColumnHandle>> pr\n                 numberOfRows = result.iterateAll().iterator().next().get(0).getLongValue();\n             }\n             else {\n-                // no filters, so we can take the value from the table info\n-                numberOfRows = bigQueryClient.getTable(tableId).getNumRows().longValue();\n+                // no filters, so we can take the value from the table info when the object is TABLE\n+                TableInfo tableInfo = bigQueryClient.getTable(tableId);\n+                if (tableInfo.getDefinition().getType() == TABLE) {\n+                    numberOfRows = tableInfo.getNumRows().longValue();\n+                }\n+                else if (tableInfo.getDefinition().getType() == VIEW) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcxNTU4Mw=="}, "originalCommit": null, "originalPosition": 49}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4994, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}