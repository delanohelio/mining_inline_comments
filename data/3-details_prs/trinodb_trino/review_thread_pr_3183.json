{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNzE1Mzc1", "number": 3183, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxOToyNTozOVrODqGpTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDo0OTozM1rODqvKfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDc1NjYxOnYy", "diffSide": "LEFT", "path": "presto-main/src/main/java/io/prestosql/execution/Input.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxOToyNTozOVrOF5rOpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QyMTozNjoxNFrOF6ZAVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAyMTQxMg==", "bodyText": "CatalogSchemaTableName or io.prestosql.metadata.QualifiedObjectName instead of using these three?", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r396021412", "createdAt": "2020-03-21T19:25:39Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/Input.java", "diffHunk": "@@ -30,15 +29,15 @@\n @Immutable\n public final class Input\n {\n-    private final CatalogName catalogName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc3MTQxNA==", "bodyText": "I think that's overkill. QualifiedObjectName is not json-serializable, and CatalogSchemaTableName has a weird structure that just muddles things (it has catalog + schema-table as a nested object)", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r396771414", "createdAt": "2020-03-23T21:36:14Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/execution/Input.java", "diffHunk": "@@ -30,15 +29,15 @@\n @Immutable\n public final class Input\n {\n-    private final CatalogName catalogName;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAyMTQxMg=="}, "originalCommit": null, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDc1ODc0OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/execution/QueryStateMachine.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxOToyOTozMlrOF5rP1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxOTo1Nzo0M1rOF7A0Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAyMTcxNw==", "bodyText": "use null initial values, to make sure it was not yet set, then in setReferencedTables please verify that previous value was null", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r396021717", "createdAt": "2020-03-21T19:29:32Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/execution/QueryStateMachine.java", "diffHunk": "@@ -148,6 +149,7 @@\n \n     private final AtomicReference<Set<Input>> inputs = new AtomicReference<>(ImmutableSet.of());\n     private final AtomicReference<Optional<Output>> output = new AtomicReference<>(Optional.empty());\n+    private final AtomicReference<List<TableInfo>> referencedTables = new AtomicReference<>(ImmutableList.of());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQyMzY3OA==", "bodyText": "Actually, that doesn't work. There are many paths that don't even call the setInput/setOutput/setReferencedTables methods.", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r397423678", "createdAt": "2020-03-24T19:57:43Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/execution/QueryStateMachine.java", "diffHunk": "@@ -148,6 +149,7 @@\n \n     private final AtomicReference<Set<Input>> inputs = new AtomicReference<>(ImmutableSet.of());\n     private final AtomicReference<Optional<Output>> output = new AtomicReference<>(Optional.empty());\n+    private final AtomicReference<List<TableInfo>> referencedTables = new AtomicReference<>(ImmutableList.of());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAyMTcxNw=="}, "originalCommit": null, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDc1OTA1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/Analysis.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxOTozMDoxMlrOF5rQBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxOTozMDoxMlrOF5rQBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAyMTc2Nw==", "bodyText": "return tables.get(NodeRef.of(table))\n     .getHandle()\n     .orElseThrow(() -> new IllegalArgumentException(format(\"%s is not a table reference\", table)));\n\nPlease be polite for my poor eyesight.", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r396021767", "createdAt": "2020-03-21T19:30:12Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/Analysis.java", "diffHunk": "@@ -481,17 +488,27 @@ public RelationType getOutputDescriptor(Node node)\n \n     public TableHandle getTableHandle(Table table)\n     {\n-        return tables.get(NodeRef.of(table));\n+        return tables.get(NodeRef.of(table)).getHandle().orElseThrow(() -> new IllegalArgumentException(format(\"%s is not a table reference\", table)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDc2MjMzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/Analysis.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxOTozNTowNlrOF5rRmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxOTozNTowNlrOF5rRmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAyMjE2OA==", "bodyText": "toImmutableList()? static import. Apply the same for everywhere below.", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r396022168", "createdAt": "2020-03-21T19:35:06Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/Analysis.java", "diffHunk": "@@ -738,6 +760,39 @@ public void addColumnMask(Table table, String column, Expression mask)\n         return columnMasks.getOrDefault(NodeRef.of(table), ImmutableMap.of());\n     }\n \n+    public List<TableInfo> getReferencedTables()\n+    {\n+        return tables.entrySet().stream()\n+                .map(entry -> {\n+                    NodeRef<Table> table = entry.getKey();\n+\n+                    List<ColumnInfo> columns = referencedFields.get(table).stream()\n+                            .map(field -> {\n+                                String fieldName = field.getName().get();\n+\n+                                return new ColumnInfo(\n+                                        fieldName,\n+                                        columnMasks.getOrDefault(table, ImmutableMap.of())\n+                                                .getOrDefault(fieldName, ImmutableList.of()).stream()\n+                                                .map(Expression::toString)\n+                                                .collect(Collectors.toList()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 116}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDc2MzQwOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/FailedDispatchQuery.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxOTozNzowNVrOF5rSNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxOTozNzowNVrOF5rSNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAyMjMyNA==", "bodyText": "Do we have tests for event listener? Please add some.", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r396022324", "createdAt": "2020-03-21T19:37:05Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/FailedDispatchQuery.java", "diffHunk": "@@ -226,6 +226,7 @@ private static QueryInfo immediateFailureQueryInfo(\n                 ImmutableList.of(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDc2ODg5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/dispatcher/FailedDispatchQuery.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxOTo0NjozNlrOF5rVMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QyMTo1MTo1OVrOF6ZcgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAyMzA4OA==", "bodyText": "There are missing information about accessed:\n\nprocedures (must have)\nfunctions (must have)\nDDL queries\nset session\nSHOW queries\nquery checks\n\nAll these surely should go as separate pull requests.", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r396023088", "createdAt": "2020-03-21T19:46:36Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/FailedDispatchQuery.java", "diffHunk": "@@ -226,6 +226,7 @@ private static QueryInfo immediateFailureQueryInfo(\n                 ImmutableList.of(),\n                 ImmutableSet.of(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc3ODYyNQ==", "bodyText": "DDL queries can be inferred from the query type + user + target table. Session properties can be inferred from the session properties in the query + user. Functions and procedures can be added, but I'll do it in a separate PR.", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r396778625", "createdAt": "2020-03-23T21:51:59Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/dispatcher/FailedDispatchQuery.java", "diffHunk": "@@ -226,6 +226,7 @@ private static QueryInfo immediateFailureQueryInfo(\n                 ImmutableList.of(),\n                 ImmutableSet.of(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAyMzA4OA=="}, "originalCommit": null, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MTM4MzQzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/Analysis.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDo0NjowNlrOF6qgwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDo0NjowNlrOF6qgwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1ODI0MA==", "bodyText": "toImmutableList?", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r397058240", "createdAt": "2020-03-24T10:46:06Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/Analysis.java", "diffHunk": "@@ -738,6 +762,39 @@ public void addColumnMask(Table table, String column, Expression mask)\n         return columnMasks.getOrDefault(NodeRef.of(table), ImmutableMap.of());\n     }\n \n+    public List<TableInfo> getReferencedTables()\n+    {\n+        return tables.entrySet().stream()\n+                .map(entry -> {\n+                    NodeRef<Table> table = entry.getKey();\n+\n+                    List<ColumnInfo> columns = referencedFields.get(table).stream()\n+                            .map(field -> {\n+                                String fieldName = field.getName().get();\n+\n+                                return new ColumnInfo(\n+                                        fieldName,\n+                                        columnMasks.getOrDefault(table, ImmutableMap.of())\n+                                                .getOrDefault(fieldName, ImmutableList.of()).stream()\n+                                                .map(Expression::toString)\n+                                                .collect(toImmutableList()));\n+                            })\n+                            .collect(Collectors.toList());\n+\n+                    TableEntry info = entry.getValue();\n+                    return new TableInfo(\n+                            info.getName().getCatalogName(),\n+                            info.getName().getSchemaName(),\n+                            info.getName().getObjectName(),\n+                            info.getAuthorization(),\n+                            rowFilters.getOrDefault(table, ImmutableList.of()).stream()\n+                                    .map(Expression::toString)\n+                                    .collect(toImmutableList()),\n+                            columns);\n+                })\n+                .collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 133}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MTM4Mzc1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/Analysis.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDo0NjoxMFrOF6qg9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDo0NjoxMFrOF6qg9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1ODI5NQ==", "bodyText": "toImmutableList?", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r397058295", "createdAt": "2020-03-24T10:46:10Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/Analysis.java", "diffHunk": "@@ -738,6 +762,39 @@ public void addColumnMask(Table table, String column, Expression mask)\n         return columnMasks.getOrDefault(NodeRef.of(table), ImmutableMap.of());\n     }\n \n+    public List<TableInfo> getReferencedTables()\n+    {\n+        return tables.entrySet().stream()\n+                .map(entry -> {\n+                    NodeRef<Table> table = entry.getKey();\n+\n+                    List<ColumnInfo> columns = referencedFields.get(table).stream()\n+                            .map(field -> {\n+                                String fieldName = field.getName().get();\n+\n+                                return new ColumnInfo(\n+                                        fieldName,\n+                                        columnMasks.getOrDefault(table, ImmutableMap.of())\n+                                                .getOrDefault(fieldName, ImmutableList.of()).stream()\n+                                                .map(Expression::toString)\n+                                                .collect(toImmutableList()));\n+                            })\n+                            .collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 120}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MTM4ODAzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/RelationId.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDo0NzoyN1rOF6qjvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDo0NzoyN1rOF6qjvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1OTAwNg==", "bodyText": "Return Optional<Node>", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r397059006", "createdAt": "2020-03-24T10:47:27Z", "author": {"login": "kokosing"}, "path": "presto-main/src/main/java/io/prestosql/sql/analyzer/RelationId.java", "diffHunk": "@@ -53,6 +53,12 @@ public boolean isAnonymous()\n         return sourceNode == null;\n     }\n \n+    @Nullable\n+    public Node getSourceNode()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MTM5MDM5OnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/io/prestosql/spi/eventlistener/TableInfo.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDo0ODowNFrOF6qlIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDo0ODowNFrOF6qlIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1OTM2MA==", "bodyText": "requireNonNulls", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r397059360", "createdAt": "2020-03-24T10:48:04Z", "author": {"login": "kokosing"}, "path": "presto-spi/src/main/java/io/prestosql/spi/eventlistener/TableInfo.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.spi.eventlistener;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.List;\n+\n+public class TableInfo\n+{\n+    private final String catalogName;\n+    private final String schema;\n+    private final String table;\n+    private final String authorization;\n+\n+    private final List<String> filters;\n+    private final List<ColumnInfo> columns;\n+\n+    public TableInfo(String catalogName, String schema, String table, String authorization, List<String> filters, List<ColumnInfo> columns)\n+    {\n+        this.catalogName = catalogName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MTM5MTQ4OnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/io/prestosql/spi/eventlistener/TableInfo.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDo0ODoyOVrOF6ql7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDo0ODoyOVrOF6ql7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1OTU2NA==", "bodyText": "Please copy collections", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r397059564", "createdAt": "2020-03-24T10:48:29Z", "author": {"login": "kokosing"}, "path": "presto-spi/src/main/java/io/prestosql/spi/eventlistener/TableInfo.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.spi.eventlistener;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.List;\n+\n+public class TableInfo\n+{\n+    private final String catalogName;\n+    private final String schema;\n+    private final String table;\n+    private final String authorization;\n+\n+    private final List<String> filters;\n+    private final List<ColumnInfo> columns;\n+\n+    public TableInfo(String catalogName, String schema, String table, String authorization, List<String> filters, List<ColumnInfo> columns)\n+    {\n+        this.catalogName = catalogName;\n+        this.schema = schema;\n+        this.table = table;\n+        this.authorization = authorization;\n+        this.filters = filters;\n+        this.columns = columns;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MTM5NTE5OnYy", "diffSide": "RIGHT", "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDo0OTozM1rOF6qoWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMDoxMzo0MFrOF7BUZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA2MDE4NQ==", "bodyText": "it would be nice to see that filters and masks can be also collected. io.prestosql.connector.MockConnectorFactory could be modified to return some dummy masks and filters.", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r397060185", "createdAt": "2020-03-24T10:49:33Z", "author": {"login": "kokosing"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -250,6 +252,32 @@ public void testNormalQuery()\n         assertEquals(queryCompletedEvent.getStatistics().getTotalRows(), expectedCompletedPositions);\n     }\n \n+    @Test\n+    public void testReferencedTables()\n+            throws Exception\n+    {\n+        // We expect the following events\n+        // QueryCreated: 1, QueryCompleted: 1, Splits: SPLITS_PER_NODE (leaf splits) + LocalExchange[SINGLE] split + Aggregation/Output split\n+        int expectedEvents = 1 + 1 + SPLITS_PER_NODE + 1 + 1;\n+        runQueryAndWaitForEvents(\"SELECT sum(linenumber) FROM lineitem\", expectedEvents);\n+\n+        QueryCompletedEvent event = getOnlyElement(generatedEvents.getQueryCompletedEvents());\n+\n+        List<TableInfo> tables = event.getMetadata().getTables();\n+        assertEquals(tables.size(), 1);\n+\n+        TableInfo table = tables.get(0);\n+        assertEquals(table.getCatalogName(), \"tpch\");\n+        assertEquals(table.getSchema(), \"tiny\");\n+        assertEquals(table.getAuthorization(), \"user\");\n+        assertTrue(table.getFilters().isEmpty());\n+        assertEquals(table.getColumns().size(), 1);\n+\n+        ColumnInfo column = table.getColumns().get(0);\n+        assertEquals(column.getColumn(), \"linenumber\");\n+        assertTrue(column.getMasks().isEmpty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQzMTkxMQ==", "bodyText": "Masks and filters are part of AccessControl, not ConnectorMetadata, unfortunately. There's no infrastructure to replace the default access control in tests with a mock one. That would require some major surgery that I want to keep out of the scope of this PR.", "url": "https://github.com/trinodb/trino/pull/3183#discussion_r397431911", "createdAt": "2020-03-24T20:13:40Z", "author": {"login": "martint"}, "path": "presto-tests/src/test/java/io/prestosql/execution/TestEventListener.java", "diffHunk": "@@ -250,6 +252,32 @@ public void testNormalQuery()\n         assertEquals(queryCompletedEvent.getStatistics().getTotalRows(), expectedCompletedPositions);\n     }\n \n+    @Test\n+    public void testReferencedTables()\n+            throws Exception\n+    {\n+        // We expect the following events\n+        // QueryCreated: 1, QueryCompleted: 1, Splits: SPLITS_PER_NODE (leaf splits) + LocalExchange[SINGLE] split + Aggregation/Output split\n+        int expectedEvents = 1 + 1 + SPLITS_PER_NODE + 1 + 1;\n+        runQueryAndWaitForEvents(\"SELECT sum(linenumber) FROM lineitem\", expectedEvents);\n+\n+        QueryCompletedEvent event = getOnlyElement(generatedEvents.getQueryCompletedEvents());\n+\n+        List<TableInfo> tables = event.getMetadata().getTables();\n+        assertEquals(tables.size(), 1);\n+\n+        TableInfo table = tables.get(0);\n+        assertEquals(table.getCatalogName(), \"tpch\");\n+        assertEquals(table.getSchema(), \"tiny\");\n+        assertEquals(table.getAuthorization(), \"user\");\n+        assertTrue(table.getFilters().isEmpty());\n+        assertEquals(table.getColumns().size(), 1);\n+\n+        ColumnInfo column = table.getColumns().get(0);\n+        assertEquals(column.getColumn(), \"linenumber\");\n+        assertTrue(column.getMasks().isEmpty());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA2MDE4NQ=="}, "originalCommit": null, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 440, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}