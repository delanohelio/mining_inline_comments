{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4NDg0NzIy", "number": 2377, "title": "Use dockerized Cassandra in tests", "bodyText": "Fixes #2182\nI tried org.testcontainers:cassandra at first, but it conflicted with the existing library and I couldn't find the benefit to use CassandraContainer instead of GenericContainer. I mean, even if we use CassandraContainer, the code will be almost the same in our test code.\n2020-01-01T10:17:53.5606938Z +-io.prestosql:presto-cassandra:328-SNAPSHOT\n2020-01-01T10:17:53.5607907Z   +-io.prestosql.cassandra:cassandra-driver:3.1.4-2\n2020-01-01T10:17:53.5609386Z     +-io.netty:netty-handler:4.0.37.Final\n2020-01-01T10:17:53.5610012Z and\n2020-01-01T10:17:53.5612375Z +-io.prestosql:presto-cassandra:328-SNAPSHOT\n2020-01-01T10:17:53.5653490Z   +-org.testcontainers:cassandra:1.12.3\n2020-01-01T10:17:53.5654227Z     +-com.datastax.cassandra:cassandra-driver-core:3.7.1\n2020-01-01T10:17:53.5655207Z       +-io.netty:netty-handler:4.0.56.Final\n2020-01-01T10:17:53.5655323Z , \n2020-01-01T10:17:53.5655672Z Require upper bound dependencies error for io.dropwizard.metrics:metrics-core:3.1.2 paths to dependency are:\n2020-01-01T10:17:53.5656098Z +-io.prestosql:presto-cassandra:328-SNAPSHOT\n2020-01-01T10:17:53.5656330Z   +-io.prestosql.cassandra:cassandra-driver:3.1.4-2\n2020-01-01T10:17:53.5767977Z     +-io.dropwizard.metrics:metrics-core:3.1.2\n2020-01-01T10:17:53.5768427Z and\n2020-01-01T10:17:53.5768962Z +-io.prestosql:presto-cassandra:328-SNAPSHOT\n2020-01-01T10:17:53.5769501Z   +-org.testcontainers:cassandra:1.12.3\n2020-01-01T10:17:53.5770041Z     +-com.datastax.cassandra:cassandra-driver-core:3.7.1\n2020-01-01T10:17:53.5770587Z       +-io.dropwizard.metrics:metrics-core:3.2.2", "createdAt": "2020-01-01T12:42:35Z", "url": "https://github.com/trinodb/trino/pull/2377", "merged": true, "mergeCommit": {"oid": "22650410f550632f5b6cefd52960fb756cc5e30e"}, "closed": true, "closedAt": "2020-01-05T08:37:27Z", "author": {"login": "ebyhr"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2Fg3oAFqTMzNzQ4OTA1OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb3OpdPgBqjI5MjIxNzc1OTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM3NDg5MDU4", "url": "https://github.com/trinodb/trino/pull/2377#pullrequestreview-337489058", "createdAt": "2020-01-01T13:44:35Z", "commit": {"oid": "705b923103e9f6dca122761d2ef1d67bf0684d38"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wMVQxMzo0NDozNlrOFZigMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wMVQxMzo1MjoxMlrOFZihyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyNDAxOQ==", "bodyText": "When this is merged, we should archive the https://github.com/prestosql/presto-cassandra-server repository.", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362324019", "createdAt": "2020-01-01T13:44:36Z", "author": {"login": "findepi"}, "path": "presto-cassandra/pom.xml", "diffHunk": "@@ -160,8 +160,8 @@\n         </dependency>\n \n         <dependency>\n-            <groupId>io.prestosql.cassandra</groupId>\n-            <artifactId>cassandra-server</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "705b923103e9f6dca122761d2ef1d67bf0684d38"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyNDI4OA==", "bodyText": "i am thinking it could make sense to convert CassandraServer to normal object, rather than having it a static instance.\n-- are we benefiting from the reuse of single cassandra instance across test classes?\nFWIW cassandra module runs tests single threaded today (https://github.com/prestosql/presto/blob/7aaa0f5fac1454b23e4bd2ac3a511d749bd00fbe/presto-cassandra/pom.xml#L17)\n\nthis means we don't need to worry about increased mem usage from multiple tests runs now\nhaving CassandraServer as an object could allow us to run the tests in 2 threads (memory permitting)", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362324288", "createdAt": "2020-01-01T13:49:41Z", "author": {"login": "findepi"}, "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/CassandraQueryRunner.java", "diffHunk": "@@ -44,16 +44,16 @@ public static synchronized DistributedQueryRunner createCassandraQueryRunner()\n \n         queryRunner.installPlugin(new CassandraPlugin());\n         queryRunner.createCatalog(\"cassandra\", \"cassandra\", ImmutableMap.of(\n-                \"cassandra.contact-points\", EmbeddedCassandra.getHost(),\n-                \"cassandra.native-protocol-port\", Integer.toString(EmbeddedCassandra.getPort()),\n+                \"cassandra.contact-points\", CassandraServer.getHost(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "705b923103e9f6dca122761d2ef1d67bf0684d38"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyNDQyNg==", "bodyText": "how long does it take to start cassandra?", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362324426", "createdAt": "2020-01-01T13:52:12Z", "author": {"login": "findepi"}, "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/CassandraQueryRunner.java", "diffHunk": "@@ -44,16 +44,16 @@ public static synchronized DistributedQueryRunner createCassandraQueryRunner()\n \n         queryRunner.installPlugin(new CassandraPlugin());\n         queryRunner.createCatalog(\"cassandra\", \"cassandra\", ImmutableMap.of(\n-                \"cassandra.contact-points\", EmbeddedCassandra.getHost(),\n-                \"cassandra.native-protocol-port\", Integer.toString(EmbeddedCassandra.getPort()),\n+                \"cassandra.contact-points\", CassandraServer.getHost(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyNDI4OA=="}, "originalCommit": {"oid": "705b923103e9f6dca122761d2ef1d67bf0684d38"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80450d42b99ef3efc9763e8dc9c1bad75c45d225", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/80450d42b99ef3efc9763e8dc9c1bad75c45d225", "committedDate": "2020-01-02T03:08:55Z", "message": "Fix syntax warning in Cassandra test"}, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM3NTU5MDQ2", "url": "https://github.com/trinodb/trino/pull/2377#pullrequestreview-337559046", "createdAt": "2020-01-02T08:09:49Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wMlQwODowOTo0OVrOFZmv6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wMlQwODoxMjoyOFrOFZmxtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjM5MzU3OA==", "bodyText": "You want to retain ref to CassandraServer so that you close the docker container in @AfterClass\nit may be simpler to write if CassandraQueryRunner remains a utility class and simply takes the server as a param:\nprotected QueryRunner createQueryRunner()\n{ \n  this.server = new CassandraServer();\n  return CassandraQueryRunner.createCassandraQueryRunner(server);\n}\n\n@AfterClass(alwaysRun=true)\npublic void tearDown()\n{\n  this.server.close();\n}", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362393578", "createdAt": "2020-01-02T08:09:49Z", "author": {"login": "findepi"}, "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/TestCassandraDistributedQueries.java", "diffHunk": "@@ -32,7 +32,7 @@\n     protected QueryRunner createQueryRunner()\n             throws Exception\n     {\n-        return CassandraQueryRunner.createCassandraQueryRunner();\n+        return new CassandraQueryRunner().createCassandraQueryRunner();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjM5NDAzNg==", "bodyText": "Add @AfterClass(alwaysRun=true) to clean this up", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362394036", "createdAt": "2020-01-02T08:12:28Z", "author": {"login": "findepi"}, "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/TestCassandraTokenSplitManager.java", "diffHunk": "@@ -30,15 +30,16 @@\n     private static final String KEYSPACE = \"test_cassandra_token_split_manager_keyspace\";\n     private static final int PARTITION_COUNT = 1000;\n \n+    private CassandraServer cassandraServer;\n     private CassandraSession session;\n     private CassandraTokenSplitManager splitManager;\n \n     @BeforeClass\n     public void setUp()\n             throws Exception\n     {\n-        CassandraServer.start();\n-        session = CassandraServer.getSession();\n+        cassandraServer = new CassandraServer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM3NzAyOTI1", "url": "https://github.com/trinodb/trino/pull/2377#pullrequestreview-337702925", "createdAt": "2020-01-02T15:14:26Z", "commit": {"oid": "705b923103e9f6dca122761d2ef1d67bf0684d38"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wMlQxNToxNDoyNlrOFZttsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wMlQxNToyNTowN1rOFZt9-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjUwNzY5OA==", "bodyText": "Also remove this:\nhttps://github.com/prestosql/presto/blob/c1e0d245787b503142a8b8dfc9733a34d0441017/pom.xml#L1190-L1200", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362507698", "createdAt": "2020-01-02T15:14:26Z", "author": {"login": "findepi"}, "path": "presto-cassandra/pom.xml", "diffHunk": "@@ -160,8 +160,8 @@\n         </dependency>\n \n         <dependency>\n-            <groupId>io.prestosql.cassandra</groupId>\n-            <artifactId>cassandra-server</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyNDAxOQ=="}, "originalCommit": {"oid": "705b923103e9f6dca122761d2ef1d67bf0684d38"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjUwODQxNQ==", "bodyText": "Was cassandra-foreground and cassandra.native.epoll.enabled something important?", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362508415", "createdAt": "2020-01-02T15:16:07Z", "author": {"login": "findepi"}, "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/CassandraServer.java", "diffHunk": "@@ -70,18 +68,16 @@ public static synchronized void start()\n \n         log.info(\"Starting cassandra...\");\n \n-        System.setProperty(\"cassandra.config\", \"file:\" + prepareCassandraYaml());\n-        System.setProperty(\"cassandra-foreground\", \"true\");\n-        System.setProperty(\"cassandra.native.epoll.enabled\", \"false\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "705b923103e9f6dca122761d2ef1d67bf0684d38"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjUwOTUxOQ==", "bodyText": "We can probably save some time by limiting this to only the tables we need (some test classes need 1-2 tables). This is how we do for eg Postgres.\n(no change requested; might be a follow-up)", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362509519", "createdAt": "2020-01-02T15:18:48Z", "author": {"login": "findepi"}, "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/CassandraQueryRunner.java", "diffHunk": "@@ -30,32 +30,25 @@\n {\n     private CassandraQueryRunner() {}\n \n-    private static boolean tpchLoaded;\n-\n-    public static synchronized DistributedQueryRunner createCassandraQueryRunner()\n+    public static DistributedQueryRunner createCassandraQueryRunner(CassandraServer server)\n             throws Exception\n     {\n-        CassandraServer.start();\n-\n         DistributedQueryRunner queryRunner = new DistributedQueryRunner(createCassandraSession(\"tpch\"), 4);\n \n         queryRunner.installPlugin(new TpchPlugin());\n         queryRunner.createCatalog(\"tpch\", \"tpch\");\n \n         queryRunner.installPlugin(new CassandraPlugin());\n         queryRunner.createCatalog(\"cassandra\", \"cassandra\", ImmutableMap.of(\n-                \"cassandra.contact-points\", CassandraServer.getHost(),\n-                \"cassandra.native-protocol-port\", Integer.toString(CassandraServer.getPort()),\n+                \"cassandra.contact-points\", server.getHost(),\n+                \"cassandra.native-protocol-port\", Integer.toString(server.getPort()),\n                 \"cassandra.allow-drop-table\", \"true\"));\n \n-        if (!tpchLoaded) {\n-            createKeyspace(CassandraServer.getSession(), \"tpch\");\n-            List<TpchTable<?>> tables = TpchTable.getTables();\n-            copyTpchTables(queryRunner, \"tpch\", TINY_SCHEMA_NAME, createCassandraSession(\"tpch\"), tables);\n-            for (TpchTable<?> table : tables) {\n-                CassandraServer.refreshSizeEstimates(\"tpch\", table.getTableName());\n-            }\n-            tpchLoaded = true;\n+        createKeyspace(server.getSession(), \"tpch\");\n+        List<TpchTable<?>> tables = TpchTable.getTables();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjUxMDgxNg==", "bodyText": "\ud83d\ude04", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362510816", "createdAt": "2020-01-02T15:22:12Z", "author": {"login": "findepi"}, "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/CassandraTestingUtils.java", "diffHunk": "@@ -132,7 +132,7 @@ public static void createTableClusteringKeysInequality(CassandraSession session,\n \n     public static void insertIntoTableClusteringKeysInequality(CassandraSession session, SchemaTableName table, Date date, int rowsCount)\n     {\n-        for (Integer rowNumber = 1; rowNumber <= rowsCount; rowNumber++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjUxMTg2Ng==", "bodyText": "Let's see if this comment is still applicable.", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362511866", "createdAt": "2020-01-02T15:25:07Z", "author": {"login": "findepi"}, "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/TestCassandraDistributedQueries.java", "diffHunk": "@@ -17,15 +17,11 @@\n import io.prestosql.testing.MaterializedResult;\n import io.prestosql.testing.QueryRunner;\n import org.testng.annotations.AfterClass;\n-import org.testng.annotations.Test;\n \n import static io.prestosql.spi.type.VarcharType.VARCHAR;\n import static io.prestosql.testing.MaterializedResult.resultBuilder;\n import static io.prestosql.testing.assertions.Assert.assertEquals;\n \n-//Integrations tests fail when parallel, due to a bug or configuration error in the embedded\n-//cassandra instance. This problem results in either a hang in Thrift calls or broken sockets.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c3720455c233082627d2d71503e242fc4c312d9", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/1c3720455c233082627d2d71503e242fc4c312d9", "committedDate": "2020-01-05T03:04:19Z", "message": "Use dockerized Cassandra in tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8baacf724d7bcdab396521294d01adbf6de0fc13", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/8baacf724d7bcdab396521294d01adbf6de0fc13", "committedDate": "2020-01-05T03:04:19Z", "message": "Make CassandraServer non-static"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2738fefe3be6c77f1185e0e82f5f91971ab79c10", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/2738fefe3be6c77f1185e0e82f5f91971ab79c10", "committedDate": "2020-01-05T03:04:19Z", "message": "Run Cassandra tests with two threads"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f79bb4412ffe849078632383d990c70fb4a4e1f7", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/f79bb4412ffe849078632383d990c70fb4a4e1f7", "committedDate": "2020-01-05T03:04:19Z", "message": "Fix syntax warning in Cassandra test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "f79bb4412ffe849078632383d990c70fb4a4e1f7", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/f79bb4412ffe849078632383d990c70fb4a4e1f7", "committedDate": "2020-01-05T03:04:19Z", "message": "Fix syntax warning in Cassandra test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 999, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}