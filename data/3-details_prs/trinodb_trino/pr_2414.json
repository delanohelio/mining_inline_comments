{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MzgyNDcy", "number": 2414, "title": "Use testcontainers for SQLServer tests", "bodyText": "Both ACCEPT_EULA and SA_PASSWORD are handled in MSSQLServerContainer.\nReference: https://www.testcontainers.org/modules/databases/mssqlserver/", "createdAt": "2020-01-06T04:11:59Z", "url": "https://github.com/trinodb/trino/pull/2414", "merged": true, "mergeCommit": {"oid": "c34b4a5da51352b78d0deb35578a763382d41d99"}, "closed": true, "closedAt": "2020-01-17T14:23:41Z", "author": {"login": "ebyhr"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3lQkegFqTMzODQ3MjA3Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4lVZmgBqjI5MzM5NjM3MTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDcyMDcy", "url": "https://github.com/trinodb/trino/pull/2414#pullrequestreview-338472072", "createdAt": "2020-01-06T05:22:54Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNToyMjo1NVrOFaVpQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNToyNDo0OFrOFaVqFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2MTkyMg==", "bodyText": "I think this can use dockerContainer.createConnection(\"\")", "url": "https://github.com/trinodb/trino/pull/2414#discussion_r363161922", "createdAt": "2020-01-06T05:22:55Z", "author": {"login": "electrum"}, "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestingSqlServer.java", "diffHunk": "@@ -13,49 +13,29 @@\n  */\n package io.prestosql.plugin.sqlserver;\n \n-import com.google.common.collect.ImmutableMap;\n-import io.prestosql.testing.docker.DockerContainer;\n-import io.prestosql.testing.docker.DockerContainer.HostPortProvider;\n+import org.testcontainers.containers.MSSQLServerContainer;\n \n import java.io.Closeable;\n import java.sql.Connection;\n import java.sql.DriverManager;\n import java.sql.Statement;\n \n-import static java.lang.String.format;\n-\n public final class TestingSqlServer\n         implements Closeable\n {\n-    private static final int SQL_SERVER_PORT = 1433;\n-\n-    public static final String USER = \"sa\";\n-    public static final String PASSWORD = \"SQLServerPass1\";\n-\n-    private final DockerContainer dockerContainer;\n+    private final MSSQLServerContainer<?> dockerContainer;\n \n     public TestingSqlServer()\n     {\n-        this.dockerContainer = DockerContainer.forImage(\"microsoft/mssql-server-linux:2017-CU13\")\n-                .setPorts(SQL_SERVER_PORT)\n-                .setEnvironment(ImmutableMap.of(\n-                        \"ACCEPT_EULA\", \"Y\",\n-                        \"SA_PASSWORD\", \"SQLServerPass1\"))\n-                .setHealthCheck(portProvider -> TestingSqlServer.execute(portProvider, \"SELECT 1\"))\n-                .start();\n+        this.dockerContainer = new MSSQLServerContainer(\"microsoft/mssql-server-linux:2017-CU13\");\n+        dockerContainer.start();\n     }\n \n     public void execute(String sql)\n     {\n-        execute(dockerContainer::getHostPort, sql);\n-    }\n-\n-    private static void execute(HostPortProvider hostPortProvider, String sql)\n-    {\n-        String jdbcUrl = getJdbcUrl(hostPortProvider.getHostPort(SQL_SERVER_PORT));\n-        try (Connection conn = DriverManager.getConnection(jdbcUrl, USER, PASSWORD);\n-                Statement stmt = conn.createStatement()) {\n-            stmt.execute(sql);\n+        try (Connection connection = DriverManager.getConnection(dockerContainer.getJdbcUrl(), dockerContainer.getUsername(), dockerContainer.getPassword());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2MjEzNQ==", "bodyText": "Consider removing this class. I'm not sure it provides much value compared to using MSSQLServerContainer directly. I did that in these two and it seems to work well: #2408 #2410", "url": "https://github.com/trinodb/trino/pull/2414#discussion_r363162135", "createdAt": "2020-01-06T05:24:48Z", "author": {"login": "electrum"}, "path": "presto-sqlserver/src/test/java/io/prestosql/plugin/sqlserver/TestingSqlServer.java", "diffHunk": "@@ -13,49 +13,29 @@\n  */\n package io.prestosql.plugin.sqlserver;\n \n-import com.google.common.collect.ImmutableMap;\n-import io.prestosql.testing.docker.DockerContainer;\n-import io.prestosql.testing.docker.DockerContainer.HostPortProvider;\n+import org.testcontainers.containers.MSSQLServerContainer;\n \n import java.io.Closeable;\n import java.sql.Connection;\n import java.sql.DriverManager;\n import java.sql.Statement;\n \n-import static java.lang.String.format;\n-\n public final class TestingSqlServer", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4ODMzMjQ2", "url": "https://github.com/trinodb/trino/pull/2414#pullrequestreview-338833246", "createdAt": "2020-01-06T19:07:31Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "01a9ef2b972856c374867a8b291c9ae391cd5de9", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/01a9ef2b972856c374867a8b291c9ae391cd5de9", "committedDate": "2020-01-09T02:47:51Z", "message": "Use testcontainers for SQLServer tests\n\nAdditionally:\n- rename abbreviated variables\n- override createQueryRunner instead of constructor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "01a9ef2b972856c374867a8b291c9ae391cd5de9", "author": {"user": {"login": "ebyhr", "name": "Yuya Ebihara"}}, "url": "https://github.com/trinodb/trino/commit/01a9ef2b972856c374867a8b291c9ae391cd5de9", "committedDate": "2020-01-09T02:47:51Z", "message": "Use testcontainers for SQLServer tests\n\nAdditionally:\n- rename abbreviated variables\n- override createQueryRunner instead of constructor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1027, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}