{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwNzE3ODQ3", "number": 3795, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwOTowNTozOFrOD-hx3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMToxNzoxOFrOD-wNeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2ODkxNzQzOnYy", "diffSide": "RIGHT", "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwOTowNTozOFrOGYrrrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMToxNDo1OVrOGZDGvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDcwMg==", "bodyText": "otherwise the tests end up giving a ORA-12519\n\nthis could mention the message too\n\nbut this command needs a database restart and if we restart the docker the configuration is lost.\n\nthis could be solved with a custom entry point, or a command.\nhow much would it add to the startup time?", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428534702", "createdAt": "2020-05-21T09:05:38Z", "author": {"login": "findepi"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -40,7 +40,7 @@ public TestingOracleServer()\n         // to fix this we have to change the number of processes of SPFILE\n         // but this command needs a database restart and if we restart the docker the configuration is lost.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcwMTYxNA==", "bodyText": "@findepi The startup takes about 25 seconds. Do you mean https://www.testcontainers.org/features/commands/ and run /bin/bash /etc/init.d/oracle-xe restart?", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428701614", "createdAt": "2020-05-21T14:51:25Z", "author": {"login": "ebyhr"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -40,7 +40,7 @@ public TestingOracleServer()\n         // to fix this we have to change the number of processes of SPFILE\n         // but this command needs a database restart and if we restart the docker the configuration is lost.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDcwMg=="}, "originalCommit": null, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODczMTM2Mg==", "bodyText": "Confirmed the parameters were set correctly.\nSQL> SHOW PARAMETERS processes;\n\nNAME\t\t\t\t     TYPE\t VALUE\n------------------------------------ ----------- ------------------------------\naq_tm_processes \t\t     integer\t 0\ndb_writer_processes\t\t     integer\t 1\ngcs_server_processes\t\t     integer\t 0\nglobal_txn_processes\t\t     integer\t 1\njob_queue_processes\t\t     integer\t 4\nlog_archive_max_processes\t     integer\t 4\nprocesses\t\t\t     integer\t 1000\nSQL>\nSQL> SHOW PARAMETERS disk_asynch_io;\n\nNAME\t\t\t\t     TYPE\t VALUE\n------------------------------------ ----------- ------------------------------\ndisk_asynch_io\t\t\t     boolean\t FALSE", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428731362", "createdAt": "2020-05-21T15:33:56Z", "author": {"login": "ebyhr"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -40,7 +40,7 @@ public TestingOracleServer()\n         // to fix this we have to change the number of processes of SPFILE\n         // but this command needs a database restart and if we restart the docker the configuration is lost.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDcwMg=="}, "originalCommit": null, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkxODQ2MQ==", "bodyText": "bq. Do you mean https://www.testcontainers.org/features/commands/ and run /bin/bash /etc/init.d/oracle-xe restart?\nThis would work for tests, but would not be appropriate for product test environment (which we should have).", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428918461", "createdAt": "2020-05-21T21:14:59Z", "author": {"login": "findepi"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -40,7 +40,7 @@ public TestingOracleServer()\n         // to fix this we have to change the number of processes of SPFILE\n         // but this command needs a database restart and if we restart the docker the configuration is lost.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDcwMg=="}, "originalCommit": null, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2ODkxOTExOnYy", "diffSide": "RIGHT", "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwOTowNjowNlrOGYrsog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMToxNTozM1rOGZDHug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDk0Ng==", "bodyText": "if i would like to amend, or recreate the spfileXE.ora, how would i do that?", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428534946", "createdAt": "2020-05-21T09:06:06Z", "author": {"login": "findepi"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -40,7 +40,7 @@ public TestingOracleServer()\n         // to fix this we have to change the number of processes of SPFILE\n         // but this command needs a database restart and if we restart the docker the configuration is lost.\n         // configuration added:\n-        // ALTER SYSTEM SET processes=500 SCOPE=SPFILE\n+        // ALTER SYSTEM SET processes=1000 SCOPE=SPFILE\n         // ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\n         this.addFileSystemBind(\"src/test/resources/spfileXE.ora\",\n                 \"/u01/app/oracle/product/11.2.0/xe/dbs/spfileXE.ora\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcxMTAwMg==", "bodyText": "@findepi Steps to update the file are:\n\nReplace BindMode.READ_ONLY with BindMode.READ_WRITE at L47\nRemove or comment out L52 ~ 55 and add\n\n            statement.execute(\"ALTER SYSTEM SET processes=1000 SCOPE=SPFILE\");\n            statement.execute(\"ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\");\n\nRun OracleQueryRunner.main", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428711002", "createdAt": "2020-05-21T15:01:50Z", "author": {"login": "ebyhr"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -40,7 +40,7 @@ public TestingOracleServer()\n         // to fix this we have to change the number of processes of SPFILE\n         // but this command needs a database restart and if we restart the docker the configuration is lost.\n         // configuration added:\n-        // ALTER SYSTEM SET processes=500 SCOPE=SPFILE\n+        // ALTER SYSTEM SET processes=1000 SCOPE=SPFILE\n         // ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\n         this.addFileSystemBind(\"src/test/resources/spfileXE.ora\",\n                 \"/u01/app/oracle/product/11.2.0/xe/dbs/spfileXE.ora\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDk0Ng=="}, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcyMjg5Mw==", "bodyText": "Let me change to the above approach (restarting Oracle server inside the container).", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428722893", "createdAt": "2020-05-21T15:20:31Z", "author": {"login": "ebyhr"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -40,7 +40,7 @@ public TestingOracleServer()\n         // to fix this we have to change the number of processes of SPFILE\n         // but this command needs a database restart and if we restart the docker the configuration is lost.\n         // configuration added:\n-        // ALTER SYSTEM SET processes=500 SCOPE=SPFILE\n+        // ALTER SYSTEM SET processes=1000 SCOPE=SPFILE\n         // ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\n         this.addFileSystemBind(\"src/test/resources/spfileXE.ora\",\n                 \"/u01/app/oracle/product/11.2.0/xe/dbs/spfileXE.ora\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDk0Ng=="}, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkxODcxNA==", "bodyText": "Steps to update the file are:\n\nReplace BindMode.READ_ONLY with BindMode.READ_WRITE at L47\nRemove or comment out L52 ~ 55 and add\n\n            statement.execute(\"ALTER SYSTEM SET processes=1000 SCOPE=SPFILE\");\n            statement.execute(\"ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\");\n\nRun OracleQueryRunner.main\n\n\nThanks @ebyhr!\nis it documented somewhere?", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428918714", "createdAt": "2020-05-21T21:15:33Z", "author": {"login": "findepi"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -40,7 +40,7 @@ public TestingOracleServer()\n         // to fix this we have to change the number of processes of SPFILE\n         // but this command needs a database restart and if we restart the docker the configuration is lost.\n         // configuration added:\n-        // ALTER SYSTEM SET processes=500 SCOPE=SPFILE\n+        // ALTER SYSTEM SET processes=1000 SCOPE=SPFILE\n         // ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\n         this.addFileSystemBind(\"src/test/resources/spfileXE.ora\",\n                 \"/u01/app/oracle/product/11.2.0/xe/dbs/spfileXE.ora\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNDk0Ng=="}, "originalCommit": null, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3MTI4MDMxOnYy", "diffSide": "RIGHT", "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMToxNjozOVrOGZDJvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMToxNjozOVrOGZDJvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkxOTIzMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try (Connection connection = DriverManager.getConnection(getJdbcUrl(), super.getUsername(), super.getPassword());\n          \n          \n            \n                    try (Connection connection = DriverManager.getConnection(getJdbcUrl(), getUsername(), getPassword());\n          \n      \n    \n    \n  \n\n-- you didn't need super, did you?", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428919230", "createdAt": "2020-05-21T21:16:39Z", "author": {"login": "findepi"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -36,17 +36,28 @@ public TestingOracleServer()\n     {\n         super(\"wnameless/oracle-xe-11g-r2\");\n \n-        // this is added to allow more processes on database, otherwise the tests end up giving a ORA-12519\n-        // to fix this we have to change the number of processes of SPFILE\n-        // but this command needs a database restart and if we restart the docker the configuration is lost.\n-        // configuration added:\n-        // ALTER SYSTEM SET processes=500 SCOPE=SPFILE\n-        // ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\n-        this.addFileSystemBind(\"src/test/resources/spfileXE.ora\",\n-                \"/u01/app/oracle/product/11.2.0/xe/dbs/spfileXE.ora\",\n-                BindMode.READ_ONLY);\n-\n         start();\n+\n+        try (Connection connection = DriverManager.getConnection(getJdbcUrl(), super.getUsername(), super.getPassword());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3MTI4MTg1OnYy", "diffSide": "RIGHT", "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMToxNzoxOFrOGZDKzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwMjoyNjo1OFrOGZIvJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkxOTUwMA==", "bodyText": "Does it wait for the db to be back opertional?", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r428919500", "createdAt": "2020-05-21T21:17:18Z", "author": {"login": "findepi"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -36,17 +36,28 @@ public TestingOracleServer()\n     {\n         super(\"wnameless/oracle-xe-11g-r2\");\n \n-        // this is added to allow more processes on database, otherwise the tests end up giving a ORA-12519\n-        // to fix this we have to change the number of processes of SPFILE\n-        // but this command needs a database restart and if we restart the docker the configuration is lost.\n-        // configuration added:\n-        // ALTER SYSTEM SET processes=500 SCOPE=SPFILE\n-        // ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\n-        this.addFileSystemBind(\"src/test/resources/spfileXE.ora\",\n-                \"/u01/app/oracle/product/11.2.0/xe/dbs/spfileXE.ora\",\n-                BindMode.READ_ONLY);\n-\n         start();\n+\n+        try (Connection connection = DriverManager.getConnection(getJdbcUrl(), super.getUsername(), super.getPassword());\n+                Statement statement = connection.createStatement()) {\n+            // this is added to allow more processes on database, otherwise the tests end up giving\n+            // ORA-12519, TNS:no appropriate service handler found\n+            // ORA-12505, TNS:listener does not currently know of SID given in connect descriptor\n+            // to fix this we have to change the number of processes of SPFILE\n+            statement.execute(\"ALTER SYSTEM SET processes=1000 SCOPE=SPFILE\");\n+            statement.execute(\"ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\");\n+        }\n+        catch (SQLException e) {\n+            throw new RuntimeException(e);\n+        }\n+\n+        try {\n+            execInContainer(\"/bin/bash\", \"/etc/init.d/oracle-xe\", \"restart\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAxMDcyNg==", "bodyText": "@findepi As far as checked the script, yes. But added waitUntilContainerStarted() just in case.", "url": "https://github.com/trinodb/trino/pull/3795#discussion_r429010726", "createdAt": "2020-05-22T02:26:58Z", "author": {"login": "ebyhr"}, "path": "presto-oracle/src/test/java/io/prestosql/plugin/oracle/TestingOracleServer.java", "diffHunk": "@@ -36,17 +36,28 @@ public TestingOracleServer()\n     {\n         super(\"wnameless/oracle-xe-11g-r2\");\n \n-        // this is added to allow more processes on database, otherwise the tests end up giving a ORA-12519\n-        // to fix this we have to change the number of processes of SPFILE\n-        // but this command needs a database restart and if we restart the docker the configuration is lost.\n-        // configuration added:\n-        // ALTER SYSTEM SET processes=500 SCOPE=SPFILE\n-        // ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\n-        this.addFileSystemBind(\"src/test/resources/spfileXE.ora\",\n-                \"/u01/app/oracle/product/11.2.0/xe/dbs/spfileXE.ora\",\n-                BindMode.READ_ONLY);\n-\n         start();\n+\n+        try (Connection connection = DriverManager.getConnection(getJdbcUrl(), super.getUsername(), super.getPassword());\n+                Statement statement = connection.createStatement()) {\n+            // this is added to allow more processes on database, otherwise the tests end up giving\n+            // ORA-12519, TNS:no appropriate service handler found\n+            // ORA-12505, TNS:listener does not currently know of SID given in connect descriptor\n+            // to fix this we have to change the number of processes of SPFILE\n+            statement.execute(\"ALTER SYSTEM SET processes=1000 SCOPE=SPFILE\");\n+            statement.execute(\"ALTER SYSTEM SET disk_asynch_io = FALSE SCOPE = SPFILE\");\n+        }\n+        catch (SQLException e) {\n+            throw new RuntimeException(e);\n+        }\n+\n+        try {\n+            execInContainer(\"/bin/bash\", \"/etc/init.d/oracle-xe\", \"restart\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkxOTUwMA=="}, "originalCommit": null, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4888, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}