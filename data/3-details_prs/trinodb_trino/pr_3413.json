{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMTc1MjM2", "number": 3413, "title": "Optimize TupleDomain.columnWiseUnion during dynamic filtering partition collection", "bodyText": "Otherwise, the collection complexity is quadratic in the number of partitions.", "createdAt": "2020-04-11T11:07:28Z", "url": "https://github.com/trinodb/trino/pull/3413", "merged": true, "mergeCommit": {"oid": "e087f783948507843303338dc82649d11094c37e"}, "closed": true, "closedAt": "2020-04-14T17:53:32Z", "author": {"login": "rzeyde-varada"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWkuazABqjMyMjQwMDI4NjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXkl5bgBqjMyMzE0NzYyNjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNDY5OTcx", "url": "https://github.com/trinodb/trino/pull/3413#pullrequestreview-392469971", "createdAt": "2020-04-13T22:00:29Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNDcxMjcz", "url": "https://github.com/trinodb/trino/pull/3413#pullrequestreview-392471273", "createdAt": "2020-04-13T22:03:14Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMjowMzoxNVrOGE27LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMjowMzoxNVrOGE27LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0NzM3Mw==", "bodyText": "This verify can never fail as there is no way to enter this if block multiple times.", "url": "https://github.com/trinodb/trino/pull/3413#discussion_r407747373", "createdAt": "2020-04-13T22:03:15Z", "author": {"login": "martint"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -72,21 +73,21 @@ public LocalDynamicFilter(Multimap<String, Symbol> probeSymbols, Map<String, Int\n \n         this.resultFuture = SettableFuture.create();\n \n-        this.result = TupleDomain.none();\n-        this.partitionsLeft = partitionCount;\n+        this.partitionCount = partitionCount;\n+        this.partitions = new ArrayList<>(partitionCount);\n     }\n \n     private synchronized void addPartition(TupleDomain<String> tupleDomain)\n     {\n         // Called concurrently by each DynamicFilterSourceOperator instance (when collection is over).\n-        partitionsLeft -= 1;\n-        verify(partitionsLeft >= 0);\n+        verify(partitions.size() < partitionCount);\n         // NOTE: may result in a bit more relaxed constraint if there are multiple columns and multiple rows.\n         // See the comment at TupleDomain::columnWiseUnion() for more details.\n-        result = TupleDomain.columnWiseUnion(result, tupleDomain);\n-        if (partitionsLeft == 0) {\n+        partitions.add(tupleDomain);\n+        if (partitions.size() == partitionCount) {\n+            Map<Symbol, Domain> result = convertTupleDomain(TupleDomain.columnWiseUnion(partitions));\n             // No more partitions are left to be processed.\n-            verify(resultFuture.set(convertTupleDomain(result)), \"dynamic filter result is provided more than once\");\n+            verify(resultFuture.set(result), \"dynamic filter result is provided more than once\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 49}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNzM5NTEx", "url": "https://github.com/trinodb/trino/pull/3413#pullrequestreview-392739511", "createdAt": "2020-04-14T09:06:51Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwOTowNjo1MlrOGFFNqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwOTowNjo1MlrOGFFNqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk4MTQ4Mg==", "bodyText": "make this final", "url": "https://github.com/trinodb/trino/pull/3413#discussion_r407981482", "createdAt": "2020-04-14T09:06:52Z", "author": {"login": "sopel39"}, "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilter.java", "diffHunk": "@@ -57,11 +58,11 @@\n \n     private final SettableFuture<Map<Symbol, Domain>> resultFuture;\n \n-    // The resulting predicate for local dynamic filtering.\n-    private TupleDomain<String> result;\n+    // Number of build-side partitions to be collected.\n+    private final int partitionCount;\n \n-    // Number of partitions left to be processed.\n-    private int partitionsLeft;\n+    // The resulting predicates from each build-side partition.\n+    private List<TupleDomain<String>> partitions;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5895edc03a7e4ba99b5dd4694bd5c0ebb20a2ec6", "author": {"user": {"login": "rzeyde-varada", "name": "Roman Z"}}, "url": "https://github.com/trinodb/trino/commit/5895edc03a7e4ba99b5dd4694bd5c0ebb20a2ec6", "committedDate": "2020-04-14T14:43:49Z", "message": "Optimize TupleDomain#columnWiseUnion during dynamic filtering collection"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "5895edc03a7e4ba99b5dd4694bd5c0ebb20a2ec6", "author": {"user": {"login": "rzeyde-varada", "name": "Roman Z"}}, "url": "https://github.com/trinodb/trino/commit/5895edc03a7e4ba99b5dd4694bd5c0ebb20a2ec6", "committedDate": "2020-04-14T14:43:49Z", "message": "Optimize TupleDomain#columnWiseUnion during dynamic filtering collection"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1900, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}