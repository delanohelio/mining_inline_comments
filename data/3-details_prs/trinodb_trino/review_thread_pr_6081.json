{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2Nzk1MTU2", "number": 6081, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMTozNDoxMFrOE87mIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTozODowNFrOE9mRKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMzI2NDMyOnYy", "diffSide": "RIGHT", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/CachingJdbcClient.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMTozNDoxMFrOH5WCyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMzo0ODo1MFrOH6HMiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg5MjA0Mg==", "bodyText": "Can you please add a test for that?", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r529892042", "createdAt": "2020-11-24T21:34:10Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/CachingJdbcClient.java", "diffHunk": "@@ -196,7 +196,7 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n             return cachedTableHandle;\n         }\n         Optional<JdbcTableHandle> tableHandle = delegate.getTableHandle(identity, schemaTableName);\n-        if (tableHandle.isEmpty() || cacheMissing) {\n+        if (tableHandle.isPresent() || cacheMissing) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkxNzQ5Mw==", "bodyText": "maybe no-one needed this cache after all :)", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r529917493", "createdAt": "2020-11-24T22:05:02Z", "author": {"login": "findepi"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/CachingJdbcClient.java", "diffHunk": "@@ -196,7 +196,7 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n             return cachedTableHandle;\n         }\n         Optional<JdbcTableHandle> tableHandle = delegate.getTableHandle(identity, schemaTableName);\n-        if (tableHandle.isEmpty() || cacheMissing) {\n+        if (tableHandle.isPresent() || cacheMissing) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg5MjA0Mg=="}, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQzOTM5Ng==", "bodyText": "@kokosing as discussed, test will be delivered in separate pr. Please AC.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530439396", "createdAt": "2020-11-25T15:03:02Z", "author": {"login": "ssheikin"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/CachingJdbcClient.java", "diffHunk": "@@ -196,7 +196,7 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n             return cachedTableHandle;\n         }\n         Optional<JdbcTableHandle> tableHandle = delegate.getTableHandle(identity, schemaTableName);\n-        if (tableHandle.isEmpty() || cacheMissing) {\n+        if (tableHandle.isPresent() || cacheMissing) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg5MjA0Mg=="}, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY5NzM1Mw==", "bodyText": "test is added as separate commit in this pr.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530697353", "createdAt": "2020-11-25T23:48:50Z", "author": {"login": "ssheikin"}, "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/CachingJdbcClient.java", "diffHunk": "@@ -196,7 +196,7 @@ public boolean isLimitGuaranteed(ConnectorSession session)\n             return cachedTableHandle;\n         }\n         Optional<JdbcTableHandle> tableHandle = delegate.getTableHandle(identity, schemaTableName);\n-        if (tableHandle.isEmpty() || cacheMissing) {\n+        if (tableHandle.isPresent() || cacheMissing) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg5MjA0Mg=="}, "originalCommit": null, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyOTEyNTUyOnYy", "diffSide": "RIGHT", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwNjoxNDo1NVrOH6NFWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMDo1NDoxMFrOH6WL4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDc5MzgxNw==", "bodyText": "Why not to simply mock jdbc client?", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530793817", "createdAt": "2020-11-26T06:14:55Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,175 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDc5NDE2Nw==", "bodyText": "Also you might want to run this test by single thread", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530794167", "createdAt": "2020-11-26T06:16:12Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,175 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDc5MzgxNw=="}, "originalCommit": null, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgxOTM3Ng==", "bodyText": "To mock it you can use proxy class from guava. Forwarding jdbc client could also be helpful. See how mock connector is implemented.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530819376", "createdAt": "2020-11-26T07:28:38Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,175 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDc5MzgxNw=="}, "originalCommit": null, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk0Mjk0NA==", "bodyText": "Why not to simply mock jdbc client?\n\nGood point, initially I didn't think about this because absence of mockito in dependencies repels from this approach.\nHowever current version shows contrast differences between CachingJdbcClient and usual jdbcClient behaviour in real world scenario without execution time or maintenance overhead.\nI'd left it as is unless you have compelling arguments.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530942944", "createdAt": "2020-11-26T10:54:10Z", "author": {"login": "ssheikin"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,175 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDc5MzgxNw=="}, "originalCommit": null, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDIyMDE4OnYy", "diffSide": "RIGHT", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMToyNzo1NVrOH6XY9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNTozOTo1MVrOH6gS3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2MjY3OQ==", "bodyText": "it is not a hacker, please simply call it jdbcClient", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530962679", "createdAt": "2020-11-26T11:27:55Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();\n+        cachingJdbcClient = createCachingJdbcClient(true);\n+        dbHacker = database.getJdbcClient();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAwMTYwMQ==", "bodyText": "I liked this name.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r531001601", "createdAt": "2020-11-26T12:39:14Z", "author": {"login": "ssheikin"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();\n+        cachingJdbcClient = createCachingJdbcClient(true);\n+        dbHacker = database.getJdbcClient();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2MjY3OQ=="}, "originalCommit": null, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwODU3NQ==", "bodyText": "Renamed, despite it ruined fairy tale about hackers.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r531108575", "createdAt": "2020-11-26T15:39:51Z", "author": {"login": "ssheikin"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();\n+        cachingJdbcClient = createCachingJdbcClient(true);\n+        dbHacker = database.getJdbcClient();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2MjY3OQ=="}, "originalCommit": null, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDIyMTY4OnYy", "diffSide": "RIGHT", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMToyODoyM1rOH6XZ8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTo1NToyNlrOH6YUlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2MjkyOA==", "bodyText": "1 day is not forever", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530962928", "createdAt": "2020-11-26T11:28:23Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk3MDUzMg==", "bodyText": "It is more than life time for test. Please suggest better name.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530970532", "createdAt": "2020-11-26T11:42:14Z", "author": {"login": "ssheikin"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2MjkyOA=="}, "originalCommit": null, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk3NDM5Mw==", "bodyText": "ONE_DAY", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530974393", "createdAt": "2020-11-26T11:49:01Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2MjkyOA=="}, "originalCommit": null, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk3Nzk0MA==", "bodyText": "Actually we are not interested wether it's one day or three or a just a few hours or whatever. The current name hints that it's something that cannot be reached. ONE_DAY says nothing except what is written after =. I'd be glad to change FOREVER to something which better depicts its nature.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530977940", "createdAt": "2020-11-26T11:55:26Z", "author": {"login": "ssheikin"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2MjkyOA=="}, "originalCommit": null, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDIyMjgxOnYy", "diffSide": "RIGHT", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMToyODo0NFrOH6Xatw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMToyODo0NFrOH6Xatw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2MzEyNw==", "bodyText": "io.prestosql.testing.TestingConnectorSession#SESSION", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530963127", "createdAt": "2020-11-26T11:28:44Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDIzMDY1OnYy", "diffSide": "RIGHT", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTozMDo1OVrOH6XfkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTo0Nzo1MVrOH6YEVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2NDM2OA==", "bodyText": "Why not to reuse it between tests? Then you can use io.prestosql.testing.AbstractTestQueryFramework#closeAfterClass. Then you can make it concurrent again", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530964368", "createdAt": "2020-11-26T11:30:59Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk3Mzc4MA==", "bodyText": "This way each test has etalon data as input. Other failing tests could not interfere with one been executing.\nThis is quite lightweight: a few milliseconds less does not worth developer time to find the actual failing test.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530973780", "createdAt": "2020-11-26T11:47:51Z", "author": {"login": "ssheikin"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2NDM2OA=="}, "originalCommit": null, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDIzOTk4OnYy", "diffSide": "RIGHT", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTozMzozOFrOH6XlYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNTo0NDoyMVrOH6gcmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2NTg1Ng==", "bodyText": "Declare type as View. Instead of using difference please use jdbcClient.getSchemaNames() and just verify that cached schemas do not contain phantom_schema", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530965856", "createdAt": "2020-11-26T11:33:38Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();\n+        cachingJdbcClient = createCachingJdbcClient(true);\n+        dbHacker = database.getJdbcClient();\n+        schema = dbHacker.getSchemaNames(identity).iterator().next();\n+    }\n+\n+    private CachingJdbcClient createCachingJdbcClient(boolean cacheMissing)\n+    {\n+        return new CachingJdbcClient(database.getJdbcClient(), FOREVER, cacheMissing);\n+    }\n+\n+    @AfterMethod(alwaysRun = true)\n+    public void tearDown()\n+            throws Exception\n+    {\n+        database.close();\n+    }\n+\n+    @Test\n+    public void testSchemaNamesCached()\n+    {\n+        String phantomSchema = \"phantom_schema\";\n+\n+        dbHacker.createSchema(identity, phantomSchema);\n+        Set<String> cachedSchemas = cachingJdbcClient.getSchemaNames(identity);\n+        dbHacker.dropSchema(identity, phantomSchema);\n+\n+        Sets.SetView<String> actualDbState = difference(cachedSchemas, Set.of(phantomSchema));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTExMTA2Nw==", "bodyText": "This was a way to express test via actualDbState. With contains and doesNotContain there is no sense in this variable at all. However it seems that despite it's less verbose it's still expressive.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r531111067", "createdAt": "2020-11-26T15:44:21Z", "author": {"login": "ssheikin"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();\n+        cachingJdbcClient = createCachingJdbcClient(true);\n+        dbHacker = database.getJdbcClient();\n+        schema = dbHacker.getSchemaNames(identity).iterator().next();\n+    }\n+\n+    private CachingJdbcClient createCachingJdbcClient(boolean cacheMissing)\n+    {\n+        return new CachingJdbcClient(database.getJdbcClient(), FOREVER, cacheMissing);\n+    }\n+\n+    @AfterMethod(alwaysRun = true)\n+    public void tearDown()\n+            throws Exception\n+    {\n+        database.close();\n+    }\n+\n+    @Test\n+    public void testSchemaNamesCached()\n+    {\n+        String phantomSchema = \"phantom_schema\";\n+\n+        dbHacker.createSchema(identity, phantomSchema);\n+        Set<String> cachedSchemas = cachingJdbcClient.getSchemaNames(identity);\n+        dbHacker.dropSchema(identity, phantomSchema);\n+\n+        Sets.SetView<String> actualDbState = difference(cachedSchemas, Set.of(phantomSchema));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2NTg1Ng=="}, "originalCommit": null, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDI0MjkwOnYy", "diffSide": "RIGHT", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTozNDoyOFrOH6XnIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMjowODowNFrOH6Yv3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2NjMwNQ==", "bodyText": "Please create it every test. I noticed that sometimes it is created and sometimes it is created here. So lets be coherent.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530966305", "createdAt": "2020-11-26T11:34:28Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();\n+        cachingJdbcClient = createCachingJdbcClient(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk4NDkyNQ==", "bodyText": "You are right, however this is a trade-off. This is the only one cachingJdbcClient 'override' of the 'default setup' provided by class fields which are widely used. The same could be said about schema which is not used by testSchemaNamesCached and that's why it's could be more clear to define in each other test method. As the most exaggerated example database is not used by preexisting test methods, and possibly could be included to new methods.\nThere is no difference for Tests clarity if the default value is overriden in test method or just not used in test method.\nI'll left it as is unless you have better arguments.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530984925", "createdAt": "2020-11-26T12:08:04Z", "author": {"login": "ssheikin"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();\n+        cachingJdbcClient = createCachingJdbcClient(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2NjMwNQ=="}, "originalCommit": null, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDI0OTU0OnYy", "diffSide": "RIGHT", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTozNjowN1rOH6XrBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMjo0MjoxN1rOH6Z4BA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2NzMwMA==", "bodyText": "You might want to use io.prestosql.testing.sql.TestTable#randomTableSuffix", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530967300", "createdAt": "2020-11-26T11:36:07Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();\n+        cachingJdbcClient = createCachingJdbcClient(true);\n+        dbHacker = database.getJdbcClient();\n+        schema = dbHacker.getSchemaNames(identity).iterator().next();\n+    }\n+\n+    private CachingJdbcClient createCachingJdbcClient(boolean cacheMissing)\n+    {\n+        return new CachingJdbcClient(database.getJdbcClient(), FOREVER, cacheMissing);\n+    }\n+\n+    @AfterMethod(alwaysRun = true)\n+    public void tearDown()\n+            throws Exception\n+    {\n+        database.close();\n+    }\n+\n+    @Test\n+    public void testSchemaNamesCached()\n+    {\n+        String phantomSchema = \"phantom_schema\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAwMzM5Ng==", "bodyText": "Could you please describe what benefits it will add here?\nI'm not sure that it worth to add additional dependency here.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r531003396", "createdAt": "2020-11-26T12:42:17Z", "author": {"login": "ssheikin"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();\n+        cachingJdbcClient = createCachingJdbcClient(true);\n+        dbHacker = database.getJdbcClient();\n+        schema = dbHacker.getSchemaNames(identity).iterator().next();\n+    }\n+\n+    private CachingJdbcClient createCachingJdbcClient(boolean cacheMissing)\n+    {\n+        return new CachingJdbcClient(database.getJdbcClient(), FOREVER, cacheMissing);\n+    }\n+\n+    @AfterMethod(alwaysRun = true)\n+    public void tearDown()\n+            throws Exception\n+    {\n+        database.close();\n+    }\n+\n+    @Test\n+    public void testSchemaNamesCached()\n+    {\n+        String phantomSchema = \"phantom_schema\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2NzMwMA=="}, "originalCommit": null, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDI1NDAyOnYy", "diffSide": "RIGHT", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTozNzoyNlrOH6XtyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTozNzoyNlrOH6XtyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2ODAwOQ==", "bodyText": "Please apply above comments to all tests below.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530968009", "createdAt": "2020-11-26T11:37:26Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();\n+        cachingJdbcClient = createCachingJdbcClient(true);\n+        dbHacker = database.getJdbcClient();\n+        schema = dbHacker.getSchemaNames(identity).iterator().next();\n+    }\n+\n+    private CachingJdbcClient createCachingJdbcClient(boolean cacheMissing)\n+    {\n+        return new CachingJdbcClient(database.getJdbcClient(), FOREVER, cacheMissing);\n+    }\n+\n+    @AfterMethod(alwaysRun = true)\n+    public void tearDown()\n+            throws Exception\n+    {\n+        database.close();\n+    }\n+\n+    @Test\n+    public void testSchemaNamesCached()\n+    {\n+        String phantomSchema = \"phantom_schema\";\n+\n+        dbHacker.createSchema(identity, phantomSchema);\n+        Set<String> cachedSchemas = cachingJdbcClient.getSchemaNames(identity);\n+        dbHacker.dropSchema(identity, phantomSchema);\n+\n+        Sets.SetView<String> actualDbState = difference(cachedSchemas, Set.of(phantomSchema));\n+        assertThat(dbHacker.getSchemaNames(identity)).containsExactlyInAnyOrderElementsOf(actualDbState);\n+        assertThat(cachingJdbcClient.getSchemaNames(identity)).containsExactlyInAnyOrderElementsOf(cachedSchemas);\n+    }\n+\n+    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDI1NTc5OnYy", "diffSide": "RIGHT", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTozODowNFrOH6XvAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNTo1Mzo1NVrOH6gxxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2ODMyMQ==", "bodyText": "now please invalidate cache and see it got refreshed after the second call.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r530968321", "createdAt": "2020-11-26T11:38:04Z", "author": {"login": "kokosing"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();\n+        cachingJdbcClient = createCachingJdbcClient(true);\n+        dbHacker = database.getJdbcClient();\n+        schema = dbHacker.getSchemaNames(identity).iterator().next();\n+    }\n+\n+    private CachingJdbcClient createCachingJdbcClient(boolean cacheMissing)\n+    {\n+        return new CachingJdbcClient(database.getJdbcClient(), FOREVER, cacheMissing);\n+    }\n+\n+    @AfterMethod(alwaysRun = true)\n+    public void tearDown()\n+            throws Exception\n+    {\n+        database.close();\n+    }\n+\n+    @Test\n+    public void testSchemaNamesCached()\n+    {\n+        String phantomSchema = \"phantom_schema\";\n+\n+        dbHacker.createSchema(identity, phantomSchema);\n+        Set<String> cachedSchemas = cachingJdbcClient.getSchemaNames(identity);\n+        dbHacker.dropSchema(identity, phantomSchema);\n+\n+        Sets.SetView<String> actualDbState = difference(cachedSchemas, Set.of(phantomSchema));\n+        assertThat(dbHacker.getSchemaNames(identity)).containsExactlyInAnyOrderElementsOf(actualDbState);\n+        assertThat(cachingJdbcClient.getSchemaNames(identity)).containsExactlyInAnyOrderElementsOf(cachedSchemas);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAwOTQyMw==", "bodyText": "There is no good way to do this.\nI'd propose to make private void invalidate.....Cache() methods as public api for cachingJdbcClient.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r531009423", "createdAt": "2020-11-26T12:53:41Z", "author": {"login": "ssheikin"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();\n+        cachingJdbcClient = createCachingJdbcClient(true);\n+        dbHacker = database.getJdbcClient();\n+        schema = dbHacker.getSchemaNames(identity).iterator().next();\n+    }\n+\n+    private CachingJdbcClient createCachingJdbcClient(boolean cacheMissing)\n+    {\n+        return new CachingJdbcClient(database.getJdbcClient(), FOREVER, cacheMissing);\n+    }\n+\n+    @AfterMethod(alwaysRun = true)\n+    public void tearDown()\n+            throws Exception\n+    {\n+        database.close();\n+    }\n+\n+    @Test\n+    public void testSchemaNamesCached()\n+    {\n+        String phantomSchema = \"phantom_schema\";\n+\n+        dbHacker.createSchema(identity, phantomSchema);\n+        Set<String> cachedSchemas = cachingJdbcClient.getSchemaNames(identity);\n+        dbHacker.dropSchema(identity, phantomSchema);\n+\n+        Sets.SetView<String> actualDbState = difference(cachedSchemas, Set.of(phantomSchema));\n+        assertThat(dbHacker.getSchemaNames(identity)).containsExactlyInAnyOrderElementsOf(actualDbState);\n+        assertThat(cachingJdbcClient.getSchemaNames(identity)).containsExactlyInAnyOrderElementsOf(cachedSchemas);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2ODMyMQ=="}, "originalCommit": null, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTExNjQ4Nw==", "bodyText": "I'm not sure it worth to do in this pr. Let's postpone it.", "url": "https://github.com/trinodb/trino/pull/6081#discussion_r531116487", "createdAt": "2020-11-26T15:53:55Z", "author": {"login": "ssheikin"}, "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestCachingJdbcClient.java", "diffHunk": "@@ -14,15 +14,176 @@\n package io.prestosql.plugin.jdbc;\n \n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.airlift.units.Duration;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.connector.ConnectorSession;\n+import io.prestosql.spi.connector.ConnectorTableMetadata;\n+import io.prestosql.spi.connector.SchemaTableName;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n import java.lang.reflect.Method;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n import java.util.Set;\n \n+import static com.google.common.collect.Sets.difference;\n import static io.prestosql.spi.testing.InterfaceTestUtils.assertAllMethodsOverridden;\n+import static io.prestosql.spi.type.IntegerType.INTEGER;\n+import static io.prestosql.testing.TestingSession.testSessionBuilder;\n+import static java.util.Collections.emptyList;\n+import static java.util.concurrent.TimeUnit.DAYS;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n+@Test(singleThreaded = true)\n public class TestCachingJdbcClient\n {\n+    private static final Duration FOREVER = Duration.succinctDuration(1, DAYS);\n+    private static final ConnectorSession session = testSessionBuilder().build().toConnectorSession();\n+    private static final JdbcIdentity identity = JdbcIdentity.from(session);\n+\n+    private TestingDatabase database;\n+    private CachingJdbcClient cachingJdbcClient;\n+    private JdbcClient dbHacker;\n+    private String schema;\n+\n+    @BeforeMethod\n+    public void setUp()\n+            throws Exception\n+    {\n+        database = new TestingDatabase();\n+        cachingJdbcClient = createCachingJdbcClient(true);\n+        dbHacker = database.getJdbcClient();\n+        schema = dbHacker.getSchemaNames(identity).iterator().next();\n+    }\n+\n+    private CachingJdbcClient createCachingJdbcClient(boolean cacheMissing)\n+    {\n+        return new CachingJdbcClient(database.getJdbcClient(), FOREVER, cacheMissing);\n+    }\n+\n+    @AfterMethod(alwaysRun = true)\n+    public void tearDown()\n+            throws Exception\n+    {\n+        database.close();\n+    }\n+\n+    @Test\n+    public void testSchemaNamesCached()\n+    {\n+        String phantomSchema = \"phantom_schema\";\n+\n+        dbHacker.createSchema(identity, phantomSchema);\n+        Set<String> cachedSchemas = cachingJdbcClient.getSchemaNames(identity);\n+        dbHacker.dropSchema(identity, phantomSchema);\n+\n+        Sets.SetView<String> actualDbState = difference(cachedSchemas, Set.of(phantomSchema));\n+        assertThat(dbHacker.getSchemaNames(identity)).containsExactlyInAnyOrderElementsOf(actualDbState);\n+        assertThat(cachingJdbcClient.getSchemaNames(identity)).containsExactlyInAnyOrderElementsOf(cachedSchemas);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2ODMyMQ=="}, "originalCommit": null, "originalPosition": 73}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4651, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}