{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxMDQ2OTky", "number": 652, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjozMzo0MlrOEmK6-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwODo0NjozN1rOEmcmHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NDYwMjgwOnYy", "diffSide": "RIGHT", "path": "opensrp-app/src/main/java/org/smartregister/repository/P2PSenderTransferDao.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjozMzo0MlrOHWC2DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjozMzo0MlrOHWC2DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg3NzMyNA==", "bodyText": "We can also depend on the presence of the location filter here to decide if we should extract the locationId", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r492877324", "createdAt": "2020-09-22T16:33:42Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/P2PSenderTransferDao.java", "diffHunk": "@@ -28,37 +30,51 @@\n     @Nullable\n     @Override\n     public TreeSet<DataType> getDataTypes() {\n-        return (TreeSet<DataType>) dataTypes.clone();\n+        TreeSet<DataType> dataTypeTreeSet = new TreeSet<>();\n+        int start = dataTypes.size() + 1;\n+        P2POptions p2POptions = CoreLibrary.getInstance().getP2POptions();\n+        if (p2POptions != null && !ArrayUtils.isEmpty(p2POptions.getLocationsFilter())) {\n+            for (String location : p2POptions.getLocationsFilter()) {\n+                for (DataType dataType : dataTypes) {\n+                    dataTypeTreeSet.add(new DataType(dataType.getName() + \":\" + location, dataType.getType(), start + dataTypeTreeSet.size()));\n+                }\n+            }\n+        }\n+        TreeSet<DataType> dataTypesClone = new TreeSet<>(dataTypes);\n+        dataTypesClone.addAll(dataTypeTreeSet);\n+        return dataTypesClone;\n     }\n \n     @Nullable\n     @Override\n     public JsonData getJsonData(@NonNull DataType dataType, long lastRecordId, int batchSize) {\n-        if (dataType.getName().equals(event.getName())) {\n+        String[] dataTypeParams = dataType.getName().split(\":\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80f73d0cbf2bf13404b18d00b5b58bc0ce731ce0"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NzI3OTQ3OnYy", "diffSide": "RIGHT", "path": "opensrp-app/src/main/java/org/smartregister/repository/P2PSenderTransferDao.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwODowOTo0OVrOHWb-xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMTozMjoyOVrOHWnmYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI4OTE1Ng==", "bodyText": "Let's disable this. I just looked at the workflow and we'll have to call\nCoreLibrary.getInstance().getP2POptions().setLocationsFilter(locationsFilter) everytime before starting the P2P activity. The instance of this class is created at the start of the application at which point we don't know the specific filters", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493289156", "createdAt": "2020-09-23T08:09:49Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/P2PSenderTransferDao.java", "diffHunk": "@@ -25,40 +27,73 @@\n \n public class P2PSenderTransferDao extends BaseP2PTransferDao implements SenderTransferDao {\n \n+    private static final String SEPARATOR = \"-\";\n+\n+    private P2POptions p2POptions;\n+\n+    public P2PSenderTransferDao() {\n+        this(null);\n+    }\n+\n+    public P2PSenderTransferDao(P2POptions p2POptions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09f2352fb929a580d5eef914feb7f4c760302ce9"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ3OTUyMA==", "bodyText": "Removed", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493479520", "createdAt": "2020-09-23T11:32:29Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/P2PSenderTransferDao.java", "diffHunk": "@@ -25,40 +27,73 @@\n \n public class P2PSenderTransferDao extends BaseP2PTransferDao implements SenderTransferDao {\n \n+    private static final String SEPARATOR = \"-\";\n+\n+    private P2POptions p2POptions;\n+\n+    public P2PSenderTransferDao() {\n+        this(null);\n+    }\n+\n+    public P2PSenderTransferDao(P2POptions p2POptions) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI4OTE1Ng=="}, "originalCommit": {"oid": "09f2352fb929a580d5eef914feb7f4c760302ce9"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NzMyNDY5OnYy", "diffSide": "RIGHT", "path": "opensrp-app/src/main/java/org/smartregister/repository/P2PSenderTransferDao.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwODoxNzoyMlrOHWccOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwOTozNDo1MlrOHWhFhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI5NjY5Ng==", "bodyText": "Set the DataType#position in the third param as the loop position. This is used to order the datatypes so that the syncing is done in the correct order.\nI think you should also change the loops i.e the dataType loop should be the outer loop so that the order is\n\nclient-{locationId1}\nclient-{locationId2}\nclient-{locationId3}\nevent-{locationId1}\nevent-{locationId2} ...", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493296696", "createdAt": "2020-09-23T08:17:22Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/P2PSenderTransferDao.java", "diffHunk": "@@ -25,40 +27,73 @@\n \n public class P2PSenderTransferDao extends BaseP2PTransferDao implements SenderTransferDao {\n \n+    private static final String SEPARATOR = \"-\";\n+\n+    private P2POptions p2POptions;\n+\n+    public P2PSenderTransferDao() {\n+        this(null);\n+    }\n+\n+    public P2PSenderTransferDao(P2POptions p2POptions) {\n+        super();\n+        this.p2POptions = p2POptions;\n+    }\n+\n     @Nullable\n     @Override\n     public TreeSet<DataType> getDataTypes() {\n-        return (TreeSet<DataType>) dataTypes.clone();\n+        TreeSet<DataType> dataTypeTreeSet = new TreeSet<>();\n+\n+        if (locationFilterEnabled()) {\n+            for (String location : p2POptions.getLocationsFilter()) {\n+                for (DataType dataType : dataTypes) {\n+                    dataTypeTreeSet.add(new DataType(dataType.getName() + SEPARATOR + location, dataType.getType(), dataTypeTreeSet.size()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09f2352fb929a580d5eef914feb7f4c760302ce9"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM3MjgwNQ==", "bodyText": "Not sure wanted for it order sync data per locations, so that if the user checks a particular location chances are that data is synced or its not. Ordering the data type maybe confusing when user opens an location with some data synced while others is not synched", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493372805", "createdAt": "2020-09-23T09:34:52Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/P2PSenderTransferDao.java", "diffHunk": "@@ -25,40 +27,73 @@\n \n public class P2PSenderTransferDao extends BaseP2PTransferDao implements SenderTransferDao {\n \n+    private static final String SEPARATOR = \"-\";\n+\n+    private P2POptions p2POptions;\n+\n+    public P2PSenderTransferDao() {\n+        this(null);\n+    }\n+\n+    public P2PSenderTransferDao(P2POptions p2POptions) {\n+        super();\n+        this.p2POptions = p2POptions;\n+    }\n+\n     @Nullable\n     @Override\n     public TreeSet<DataType> getDataTypes() {\n-        return (TreeSet<DataType>) dataTypes.clone();\n+        TreeSet<DataType> dataTypeTreeSet = new TreeSet<>();\n+\n+        if (locationFilterEnabled()) {\n+            for (String location : p2POptions.getLocationsFilter()) {\n+                for (DataType dataType : dataTypes) {\n+                    dataTypeTreeSet.add(new DataType(dataType.getName() + SEPARATOR + location, dataType.getType(), dataTypeTreeSet.size()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI5NjY5Ng=="}, "originalCommit": {"oid": "09f2352fb929a580d5eef914feb7f4c760302ce9"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NzQ2MzUzOnYy", "diffSide": "RIGHT", "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwODo0MDo0NVrOHWd0sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwODo0MDo0NVrOHWd0sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzMxOTM0NQ==", "bodyText": "Use event_column.locationId on this line and next line", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493319345", "createdAt": "2020-09-23T08:40:45Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -146,6 +146,17 @@ public static void createAdditionalColumns(SQLiteDatabase db) {\n         createAdditionalColumns(db, Table.event.name(), Table.client.name());\n     }\n \n+    /**\n+     * add locationId  column on event table\n+     *\n+     * @param db the database being upgraded\n+     */\n+    public static void addEventLocationId(SQLiteDatabase db) {\n+        DatabaseMigrationUtils.addColumnIfNotExists(db, Table.event.name(), client_column.locationId.name(), VARCHAR);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09f2352fb929a580d5eef914feb7f4c760302ce9"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NzQ5ODU0OnYy", "diffSide": "RIGHT", "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwODo0NjozN1rOHWeLWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMTozMjo1MVrOHWnnaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzMyNTE0NQ==", "bodyText": "This works perfect except for situations where the event does not have a locationId. I don't know if that is possible on Reveal currently", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493325145", "createdAt": "2020-09-23T08:46:37Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -154,7 +154,7 @@ public static void createAdditionalColumns(SQLiteDatabase db) {\n     public static void addEventLocationId(SQLiteDatabase db) {\n         DatabaseMigrationUtils.addColumnIfNotExists(db, Table.event.name(), client_column.locationId.name(), VARCHAR);\n         DatabaseMigrationUtils.addIndexIfNotExists(db, Table.event.name(), client_column.locationId.name());\n-\n+        db.execSQL(String.format(\"UPDATE %s set %s = %s\", Table.event.name(), event_column.locationId.name(), \"substr(json,instr(json, '\\\"locationId\\\":')+14,36)\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f12fdda2fa4761329ccba6540817676a9f7af0d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ3OTc4NQ==", "bodyText": "Added a filter for only events with locationId", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493479785", "createdAt": "2020-09-23T11:32:51Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -154,7 +154,7 @@ public static void createAdditionalColumns(SQLiteDatabase db) {\n     public static void addEventLocationId(SQLiteDatabase db) {\n         DatabaseMigrationUtils.addColumnIfNotExists(db, Table.event.name(), client_column.locationId.name(), VARCHAR);\n         DatabaseMigrationUtils.addIndexIfNotExists(db, Table.event.name(), client_column.locationId.name());\n-\n+        db.execSQL(String.format(\"UPDATE %s set %s = %s\", Table.event.name(), event_column.locationId.name(), \"substr(json,instr(json, '\\\"locationId\\\":')+14,36)\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzMyNTE0NQ=="}, "originalCommit": {"oid": "4f12fdda2fa4761329ccba6540817676a9f7af0d"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2112, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}