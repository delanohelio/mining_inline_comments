{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5MDAwODUw", "number": 685, "title": "use set to check formsubmissionid during batch insert", "bodyText": "", "createdAt": "2020-11-11T07:08:16Z", "url": "https://github.com/opensrp/opensrp-client-core/pull/685", "merged": true, "mergeCommit": {"oid": "11a2a05ca0ff1b8761ebea7eb24ea420784268f2"}, "closed": true, "closedAt": "2020-11-18T15:14:44Z", "author": {"login": "bennsimon"}, "timelineItems": {"totalCount": 34, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbYgiTgH2gAyNTE5MDAwODUwOjI3MDE3ZGIwMGFjOWVlZWRmMGNlMmJlM2RjNmFmZTg1M2Q2ZDU2Y2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddvE26gFqTUzMzUwMzcwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "27017db00ac9eeedf0ce2be3dc6afe853d6d56ce", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/27017db00ac9eeedf0ce2be3dc6afe853d6d56ce", "committedDate": "2020-11-11T07:06:27Z", "message": "use set to check formsubmissionid during bathc insert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d08cbec07e2c2468376e6edb1cf3252e643b8c2", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/9d08cbec07e2c2468376e6edb1cf3252e643b8c2", "committedDate": "2020-11-11T07:08:24Z", "message": "Merge branch 'master' into update-checkFormSubmissionId"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3OTU5NTY0", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#pullrequestreview-527959564", "createdAt": "2020-11-11T08:29:58Z", "commit": {"oid": "9d08cbec07e2c2468376e6edb1cf3252e643b8c2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwODoyOTo1OFrOHxDJkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwODozNDoyM1rOHxDSoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE5Mzg3Mg==", "bodyText": "this should be checking the form submission ids  from the events in the JSONArray", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#discussion_r521193872", "createdAt": "2020-11-11T08:29:58Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -532,14 +569,17 @@ public boolean batchInsertEvents(JSONArray array, long serverVersion) {\n         return batchInsertEvents(array, serverVersion, getWritableDatabase());\n     }\n \n-    public boolean batchInsertEvents(JSONArray array, long serverVersion, SQLiteDatabase sqLiteDatabase) {\n+    public boolean batchInsertEvents(JSONArray array, long serverVersion, SQLiteDatabase\n+            sqLiteDatabase) {\n         if (array == null || array.length() == 0) {\n             return false;\n         }\n \n         SQLiteStatement insertStatement = null;\n         SQLiteStatement updateStatement = null;\n \n+        populateFormSubmissionIds();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d08cbec07e2c2468376e6edb1cf3252e643b8c2"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE5NDE5MQ==", "bodyText": "This should check for submissionids from those passed in the array. Also return the set in this method", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#discussion_r521194191", "createdAt": "2020-11-11T08:30:28Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -255,11 +257,45 @@ public Boolean checkIfExists(Table table, String baseEntityId, SQLiteDatabase sq\n         return false;\n     }\n \n+    public void populateFormSubmissionIds() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d08cbec07e2c2468376e6edb1cf3252e643b8c2"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE5NDI5OQ==", "bodyText": "use try with resources", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#discussion_r521194299", "createdAt": "2020-11-11T08:30:40Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -255,11 +257,45 @@ public Boolean checkIfExists(Table table, String baseEntityId, SQLiteDatabase sq\n         return false;\n     }\n \n+    public void populateFormSubmissionIds() {\n+        Cursor mCursor = null;\n+        if (formSubmissionIds == null)\n+            formSubmissionIds = new HashSet<>();\n+\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d08cbec07e2c2468376e6edb1cf3252e643b8c2"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE5NTUyNQ==", "bodyText": "This should be returned in the method and should not be an instance variable so that its reclaimed after batchInsert completes", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#discussion_r521195525", "createdAt": "2020-11-11T08:33:01Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -63,6 +63,8 @@\n     protected Table clientTable;\n     protected Table eventTable;\n \n+    private Set<String> formSubmissionIds;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d08cbec07e2c2468376e6edb1cf3252e643b8c2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE5NjE5Mw==", "bodyText": "Not sure of this, can this just be formSubmissionIds.contains(formSubmissionId)", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#discussion_r521196193", "createdAt": "2020-11-11T08:34:23Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -255,11 +257,45 @@ public Boolean checkIfExists(Table table, String baseEntityId, SQLiteDatabase sq\n         return false;\n     }\n \n+    public void populateFormSubmissionIds() {\n+        Cursor mCursor = null;\n+        if (formSubmissionIds == null)\n+            formSubmissionIds = new HashSet<>();\n+\n+        try {\n+            String query = \"SELECT \"\n+                    + event_column.formSubmissionId\n+                    + \" FROM \"\n+                    + eventTable.name();\n+            mCursor = getReadableDatabase().rawQuery(query, new String[]{});\n+            if (mCursor != null) {\n+                while (mCursor.moveToNext()) {\n+                    formSubmissionIds.add(mCursor.getString(0));\n+                }\n+            }\n+        } catch (Exception e) {\n+            Timber.e(e);\n+        } finally {\n+            if (mCursor != null) {\n+                mCursor.close();\n+            }\n+        }\n+\n+    }\n+\n+    public Boolean checkIfExistsByFormSubmissionId(String formSubmissionId) {\n+        if (formSubmissionIds != null && StringUtils.isNotBlank(formSubmissionId)) {\n+            return !formSubmissionIds.add(formSubmissionId);\n+        }\n+        return false;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d08cbec07e2c2468376e6edb1cf3252e643b8c2"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3OTYyODc5", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#pullrequestreview-527962879", "createdAt": "2020-11-11T08:34:57Z", "commit": {"oid": "9d08cbec07e2c2468376e6edb1cf3252e643b8c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwODozNDo1N1rOHxDTuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwODozNDo1N1rOHxDTuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE5NjQ3Mg==", "bodyText": "check formatting here", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#discussion_r521196472", "createdAt": "2020-11-11T08:34:57Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -1467,7 +1508,8 @@ public JSONObject getEventsByBaseEntityIdAndEventType(String baseEntityId, Strin\n         return null;\n     }\n \n-    public List<EventClient> getEventsByBaseEntityIdsAndSyncStatus(String syncStatus, List<String> baseEntityIds) {\n+    public List<EventClient> getEventsByBaseEntityIdsAndSyncStatus(String\n+                                                                           syncStatus, List<String> baseEntityIds) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d08cbec07e2c2468376e6edb1cf3252e643b8c2"}, "originalPosition": 111}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0677d2e96d7a0f471504841b17a2d88bb603fd5", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/a0677d2e96d7a0f471504841b17a2d88bb603fd5", "committedDate": "2020-11-11T09:30:11Z", "message": "code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cd05cca3d58fd71e567eb350152dbd08d229970", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/9cd05cca3d58fd71e567eb350152dbd08d229970", "committedDate": "2020-11-11T09:30:52Z", "message": "Merge branch 'update-checkFormSubmissionId' of github.com:OpenSRP/opensrp-client-core into update-checkFormSubmissionId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84b887c21d079e968709279b5e3781b431076657", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/84b887c21d079e968709279b5e3781b431076657", "committedDate": "2020-11-11T09:35:24Z", "message": "use try with resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c558f1b4d578e4fa126db03645648577ee3ca3ca", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/c558f1b4d578e4fa126db03645648577ee3ca3ca", "committedDate": "2020-11-11T09:36:23Z", "message": "update selection args"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b5ef683e26f389511cf0f5aeeb209baa21bb1c2", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/0b5ef683e26f389511cf0f5aeeb209baa21bb1c2", "committedDate": "2020-11-12T07:15:24Z", "message": "add tests and code cleanup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c429d9800115f1949aaf8bb9731a315fa0a034b8", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/c429d9800115f1949aaf8bb9731a315fa0a034b8", "committedDate": "2020-11-12T07:12:35Z", "message": "code cleanup and addt test"}, "afterCommit": {"oid": "0b5ef683e26f389511cf0f5aeeb209baa21bb1c2", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/0b5ef683e26f389511cf0f5aeeb209baa21bb1c2", "committedDate": "2020-11-12T07:15:24Z", "message": "add tests and code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c693e986854c6718169d8fe0b88ed40d0ebdff35", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/c693e986854c6718169d8fe0b88ed40d0ebdff35", "committedDate": "2020-11-13T10:08:41Z", "message": "remove lastServerVersion (-1) offset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "385836ff1f0497ef52f9611f2529d05c5e216af6", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/385836ff1f0497ef52f9611f2529d05c5e216af6", "committedDate": "2020-11-13T10:13:40Z", "message": "code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eca573914a4e4fa7e22457fd2bc36c0e9c649d1", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/4eca573914a4e4fa7e22457fd2bc36c0e9c649d1", "committedDate": "2020-11-13T11:52:31Z", "message": "revert offset change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53a69301f31b15df1a9e8e651957340168d8b0c2", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/53a69301f31b15df1a9e8e651957340168d8b0c2", "committedDate": "2020-11-13T11:53:25Z", "message": "code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1007d874e3d27cc203bf05055c252118670c1139", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/1007d874e3d27cc203bf05055c252118670c1139", "committedDate": "2020-11-13T15:36:11Z", "message": "Merge branch 'master' into update-checkFormSubmissionId"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMTg3MzA3", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#pullrequestreview-530187307", "createdAt": "2020-11-13T16:02:50Z", "commit": {"oid": "1007d874e3d27cc203bf05055c252118670c1139"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjowMjo1MFrOHy0LBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjowMjo1MFrOHy0LBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA0NTYzOQ==", "bodyText": "use ? i.e    StringUtils.repeat(\"?\",tempList.length) and pass the formsubmissions in rawQuery as second args. This is a safer database operation", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#discussion_r523045639", "createdAt": "2020-11-13T16:02:50Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -255,11 +259,78 @@ public Boolean checkIfExists(Table table, String baseEntityId, SQLiteDatabase sq\n         return false;\n     }\n \n+    private List<String> getFormSubmissionIdsFromJsonArray(JSONArray array) {\n+        if (array != null && array.length() != 0) {\n+            List<String> stringList = new ArrayList<>();\n+            for (int i = 0; i < array.length(); i++) {\n+                JSONObject jsonObject = array.optJSONObject(i);\n+                if (jsonObject != null) {\n+                    String formSubmissionId = jsonObject.optString(event_column.formSubmissionId.name());\n+                    if (StringUtils.isNotBlank(formSubmissionId)) {\n+                        stringList.add(formSubmissionId);\n+                    }\n+                }\n+            }\n+            return stringList;\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    protected void populateFormSubmissionIds(@NonNull List<String> formSubmissionIdsList,\n+                                             Set<String> formSubmissionIds) {\n+        populateFormSubmissionIds(formSubmissionIdsList, formSubmissionIds, null);\n+    }\n+\n+    protected void populateFormSubmissionIds(@NonNull List<String> formSubmissionIdsList,\n+                                             Set<String> formSubmissionIds, @Nullable Integer pageSize) {\n+        Integer pageSizeInteger = pageSize;\n+\n+        if (pageSizeInteger == null) {\n+            pageSizeInteger = FORM_SUBMISSION_IDS_PAGE_SIZE;\n+        }\n+\n+        String query = \"SELECT \"\n+                + EventClientRepository.event_column.formSubmissionId\n+                + \" FROM event\";\n+\n+        List<String> tempList;\n+\n+        boolean shouldEnd = false;\n+\n+        if (formSubmissionIdsList.size() <= pageSizeInteger) {\n+            tempList = formSubmissionIdsList;\n+            shouldEnd = true;\n+        } else {\n+            tempList = formSubmissionIdsList.subList(0, pageSizeInteger);\n+        }\n+\n+        int limit = formSubmissionIdsList.size() - pageSizeInteger;\n+\n+        query += \" WHERE \" + EventClientRepository.event_column.formSubmissionId + \" IN ('\" + StringUtils.join(tempList, \"','\") + \"')\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1007d874e3d27cc203bf05055c252118670c1139"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMTg5ODUy", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#pullrequestreview-530189852", "createdAt": "2020-11-13T16:05:54Z", "commit": {"oid": "1007d874e3d27cc203bf05055c252118670c1139"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjowNTo1NFrOHy0ScQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjowNTo1NFrOHy0ScQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA0NzUzNw==", "bodyText": "This should return formSubmissionIds as this is a recursive function", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#discussion_r523047537", "createdAt": "2020-11-13T16:05:54Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -255,11 +259,78 @@ public Boolean checkIfExists(Table table, String baseEntityId, SQLiteDatabase sq\n         return false;\n     }\n \n+    private List<String> getFormSubmissionIdsFromJsonArray(JSONArray array) {\n+        if (array != null && array.length() != 0) {\n+            List<String> stringList = new ArrayList<>();\n+            for (int i = 0; i < array.length(); i++) {\n+                JSONObject jsonObject = array.optJSONObject(i);\n+                if (jsonObject != null) {\n+                    String formSubmissionId = jsonObject.optString(event_column.formSubmissionId.name());\n+                    if (StringUtils.isNotBlank(formSubmissionId)) {\n+                        stringList.add(formSubmissionId);\n+                    }\n+                }\n+            }\n+            return stringList;\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    protected void populateFormSubmissionIds(@NonNull List<String> formSubmissionIdsList,\n+                                             Set<String> formSubmissionIds) {\n+        populateFormSubmissionIds(formSubmissionIdsList, formSubmissionIds, null);\n+    }\n+\n+    protected void populateFormSubmissionIds(@NonNull List<String> formSubmissionIdsList,\n+                                             Set<String> formSubmissionIds, @Nullable Integer pageSize) {\n+        Integer pageSizeInteger = pageSize;\n+\n+        if (pageSizeInteger == null) {\n+            pageSizeInteger = FORM_SUBMISSION_IDS_PAGE_SIZE;\n+        }\n+\n+        String query = \"SELECT \"\n+                + EventClientRepository.event_column.formSubmissionId\n+                + \" FROM event\";\n+\n+        List<String> tempList;\n+\n+        boolean shouldEnd = false;\n+\n+        if (formSubmissionIdsList.size() <= pageSizeInteger) {\n+            tempList = formSubmissionIdsList;\n+            shouldEnd = true;\n+        } else {\n+            tempList = formSubmissionIdsList.subList(0, pageSizeInteger);\n+        }\n+\n+        int limit = formSubmissionIdsList.size() - pageSizeInteger;\n+\n+        query += \" WHERE \" + EventClientRepository.event_column.formSubmissionId + \" IN ('\" + StringUtils.join(tempList, \"','\") + \"')\";\n+\n+        try (Cursor mCursor = getReadableDatabase().rawQuery(query, null)) {\n+            if (mCursor != null) {\n+                while (mCursor.moveToNext()) {\n+                    formSubmissionIds.add(mCursor.getString(0));\n+                }\n+            }\n+        } catch (SQLException e) {\n+            Timber.e(e);\n+        }\n+\n+        if (shouldEnd) {\n+            return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1007d874e3d27cc203bf05055c252118670c1139"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMTkxODY5", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#pullrequestreview-530191869", "createdAt": "2020-11-13T16:08:30Z", "commit": {"oid": "1007d874e3d27cc203bf05055c252118670c1139"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjowODozMFrOHy0Yhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjowODozMFrOHy0Yhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA0OTA5NQ==", "bodyText": "can be properly named", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#discussion_r523049095", "createdAt": "2020-11-13T16:08:30Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -255,11 +259,78 @@ public Boolean checkIfExists(Table table, String baseEntityId, SQLiteDatabase sq\n         return false;\n     }\n \n+    private List<String> getFormSubmissionIdsFromJsonArray(JSONArray array) {\n+        if (array != null && array.length() != 0) {\n+            List<String> stringList = new ArrayList<>();\n+            for (int i = 0; i < array.length(); i++) {\n+                JSONObject jsonObject = array.optJSONObject(i);\n+                if (jsonObject != null) {\n+                    String formSubmissionId = jsonObject.optString(event_column.formSubmissionId.name());\n+                    if (StringUtils.isNotBlank(formSubmissionId)) {\n+                        stringList.add(formSubmissionId);\n+                    }\n+                }\n+            }\n+            return stringList;\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    protected void populateFormSubmissionIds(@NonNull List<String> formSubmissionIdsList,\n+                                             Set<String> formSubmissionIds) {\n+        populateFormSubmissionIds(formSubmissionIdsList, formSubmissionIds, null);\n+    }\n+\n+    protected void populateFormSubmissionIds(@NonNull List<String> formSubmissionIdsList,\n+                                             Set<String> formSubmissionIds, @Nullable Integer pageSize) {\n+        Integer pageSizeInteger = pageSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1007d874e3d27cc203bf05055c252118670c1139"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ec9a37a10082ddba60b578d3381e7354167bf7f", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/0ec9a37a10082ddba60b578d3381e7354167bf7f", "committedDate": "2020-11-16T07:26:40Z", "message": "code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74e15f037b6d0f930c8e87bf2f1eaec59082c912", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/74e15f037b6d0f930c8e87bf2f1eaec59082c912", "committedDate": "2020-11-16T07:27:23Z", "message": "Merge branch 'update-checkFormSubmissionId' of github.com:OpenSRP/opensrp-client-core into update-checkFormSubmissionId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71213bb121415192f6598db6ddba9ad8d61a26a8", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/71213bb121415192f6598db6ddba9ad8d61a26a8", "committedDate": "2020-11-16T07:29:27Z", "message": "Merge branch 'master' into update-checkFormSubmissionId"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNDA2NDg1", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#pullrequestreview-531406485", "createdAt": "2020-11-16T15:05:29Z", "commit": {"oid": "71213bb121415192f6598db6ddba9ad8d61a26a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTowNToyOVrOH0C5cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTowNToyOVrOH0C5cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMzNTQ3Mg==", "bodyText": "limit = formSubmissionIdsList.size() - tempPageSize;\nand we are passing tempPageSize + limit which is simplified to formSubmissionIdsList.size()", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#discussion_r524335472", "createdAt": "2020-11-16T15:05:29Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -255,11 +259,78 @@ public Boolean checkIfExists(Table table, String baseEntityId, SQLiteDatabase sq\n         return false;\n     }\n \n+    private List<String> getFormSubmissionIdsFromJsonArray(JSONArray array) {\n+        if (array != null && array.length() != 0) {\n+            List<String> stringList = new ArrayList<>();\n+            for (int i = 0; i < array.length(); i++) {\n+                JSONObject jsonObject = array.optJSONObject(i);\n+                if (jsonObject != null) {\n+                    String formSubmissionId = jsonObject.optString(event_column.formSubmissionId.name());\n+                    if (StringUtils.isNotBlank(formSubmissionId)) {\n+                        stringList.add(formSubmissionId);\n+                    }\n+                }\n+            }\n+            return stringList;\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    protected void populateFormSubmissionIds(@NonNull List<String> formSubmissionIdsList,\n+                                             Set<String> formSubmissionIds) {\n+        populateFormSubmissionIds(formSubmissionIdsList, formSubmissionIds, null);\n+    }\n+\n+    protected void populateFormSubmissionIds(@NonNull List<String> formSubmissionIdsList,\n+                                             Set<String> formSubmissionIds, @Nullable Integer pageSize) {\n+        Integer tempPageSize = pageSize;\n+\n+        if (tempPageSize == null) {\n+            tempPageSize = FORM_SUBMISSION_IDS_PAGE_SIZE;\n+        }\n+\n+        String query = \"SELECT \"\n+                + EventClientRepository.event_column.formSubmissionId\n+                + \" FROM event\";\n+\n+        List<String> tempList;\n+\n+        boolean shouldEnd = false;\n+\n+        if (formSubmissionIdsList.size() <= tempPageSize) {\n+            tempList = formSubmissionIdsList;\n+            shouldEnd = true;\n+        } else {\n+            tempList = formSubmissionIdsList.subList(0, tempPageSize);\n+        }\n+\n+        int limit = formSubmissionIdsList.size() - tempPageSize;\n+\n+        query += \" WHERE \" + EventClientRepository.event_column.formSubmissionId + \" IN ( \" + StringUtils.repeat(\"?\", \", \", tempList.size()) + \")\";\n+\n+        try (Cursor mCursor = getReadableDatabase().rawQuery(query, tempList.toArray(new String[0]))) {\n+            if (mCursor != null) {\n+                while (mCursor.moveToNext()) {\n+                    formSubmissionIds.add(mCursor.getString(0));\n+                }\n+            }\n+        } catch (SQLException e) {\n+            Timber.e(e);\n+        }\n+\n+        if (shouldEnd) {\n+            return;\n+        }\n+\n+        populateFormSubmissionIds(formSubmissionIdsList.subList(tempPageSize, tempPageSize + limit), formSubmissionIds, tempPageSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71213bb121415192f6598db6ddba9ad8d61a26a8"}, "originalPosition": 94}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNDEwMjgy", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#pullrequestreview-531410282", "createdAt": "2020-11-16T15:09:22Z", "commit": {"oid": "71213bb121415192f6598db6ddba9ad8d61a26a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTowOToyMlrOH0DEHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTowOToyMlrOH0DEHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMzODIwNg==", "bodyText": "Can we just remove creation of additional variables and just use FORM_SUBMISSION_IDS_PAGE_SIZE", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#discussion_r524338206", "createdAt": "2020-11-16T15:09:22Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -255,11 +259,78 @@ public Boolean checkIfExists(Table table, String baseEntityId, SQLiteDatabase sq\n         return false;\n     }\n \n+    private List<String> getFormSubmissionIdsFromJsonArray(JSONArray array) {\n+        if (array != null && array.length() != 0) {\n+            List<String> stringList = new ArrayList<>();\n+            for (int i = 0; i < array.length(); i++) {\n+                JSONObject jsonObject = array.optJSONObject(i);\n+                if (jsonObject != null) {\n+                    String formSubmissionId = jsonObject.optString(event_column.formSubmissionId.name());\n+                    if (StringUtils.isNotBlank(formSubmissionId)) {\n+                        stringList.add(formSubmissionId);\n+                    }\n+                }\n+            }\n+            return stringList;\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    protected void populateFormSubmissionIds(@NonNull List<String> formSubmissionIdsList,\n+                                             Set<String> formSubmissionIds) {\n+        populateFormSubmissionIds(formSubmissionIdsList, formSubmissionIds, null);\n+    }\n+\n+    protected void populateFormSubmissionIds(@NonNull List<String> formSubmissionIdsList,\n+                                             Set<String> formSubmissionIds, @Nullable Integer pageSize) {\n+        Integer tempPageSize = pageSize;\n+\n+        if (tempPageSize == null) {\n+            tempPageSize = FORM_SUBMISSION_IDS_PAGE_SIZE;\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71213bb121415192f6598db6ddba9ad8d61a26a8"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNDEwODIx", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#pullrequestreview-531410821", "createdAt": "2020-11-16T15:09:55Z", "commit": {"oid": "71213bb121415192f6598db6ddba9ad8d61a26a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTowOTo1NlrOH0DFyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTowOTo1NlrOH0DFyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMzODYzMw==", "bodyText": "not sure can we remove parameter @Nullable Integer pageSize and use FORM_SUBMISSION_IDS_PAGE_SIZE", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#discussion_r524338633", "createdAt": "2020-11-16T15:09:56Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -255,11 +259,78 @@ public Boolean checkIfExists(Table table, String baseEntityId, SQLiteDatabase sq\n         return false;\n     }\n \n+    private List<String> getFormSubmissionIdsFromJsonArray(JSONArray array) {\n+        if (array != null && array.length() != 0) {\n+            List<String> stringList = new ArrayList<>();\n+            for (int i = 0; i < array.length(); i++) {\n+                JSONObject jsonObject = array.optJSONObject(i);\n+                if (jsonObject != null) {\n+                    String formSubmissionId = jsonObject.optString(event_column.formSubmissionId.name());\n+                    if (StringUtils.isNotBlank(formSubmissionId)) {\n+                        stringList.add(formSubmissionId);\n+                    }\n+                }\n+            }\n+            return stringList;\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    protected void populateFormSubmissionIds(@NonNull List<String> formSubmissionIdsList,\n+                                             Set<String> formSubmissionIds) {\n+        populateFormSubmissionIds(formSubmissionIdsList, formSubmissionIds, null);\n+    }\n+\n+    protected void populateFormSubmissionIds(@NonNull List<String> formSubmissionIdsList,\n+                                             Set<String> formSubmissionIds, @Nullable Integer pageSize) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71213bb121415192f6598db6ddba9ad8d61a26a8"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNDEyODcx", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#pullrequestreview-531412871", "createdAt": "2020-11-16T15:12:04Z", "commit": {"oid": "71213bb121415192f6598db6ddba9ad8d61a26a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToxMjowNVrOH0DLzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToxMjowNVrOH0DLzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM0MDE3NA==", "bodyText": "Can we define the whole query variable here", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#discussion_r524340174", "createdAt": "2020-11-16T15:12:05Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -255,11 +259,78 @@ public Boolean checkIfExists(Table table, String baseEntityId, SQLiteDatabase sq\n         return false;\n     }\n \n+    private List<String> getFormSubmissionIdsFromJsonArray(JSONArray array) {\n+        if (array != null && array.length() != 0) {\n+            List<String> stringList = new ArrayList<>();\n+            for (int i = 0; i < array.length(); i++) {\n+                JSONObject jsonObject = array.optJSONObject(i);\n+                if (jsonObject != null) {\n+                    String formSubmissionId = jsonObject.optString(event_column.formSubmissionId.name());\n+                    if (StringUtils.isNotBlank(formSubmissionId)) {\n+                        stringList.add(formSubmissionId);\n+                    }\n+                }\n+            }\n+            return stringList;\n+        }\n+        return new ArrayList<>();\n+    }\n+\n+    protected void populateFormSubmissionIds(@NonNull List<String> formSubmissionIdsList,\n+                                             Set<String> formSubmissionIds) {\n+        populateFormSubmissionIds(formSubmissionIdsList, formSubmissionIds, null);\n+    }\n+\n+    protected void populateFormSubmissionIds(@NonNull List<String> formSubmissionIdsList,\n+                                             Set<String> formSubmissionIds, @Nullable Integer pageSize) {\n+        Integer tempPageSize = pageSize;\n+\n+        if (tempPageSize == null) {\n+            tempPageSize = FORM_SUBMISSION_IDS_PAGE_SIZE;\n+        }\n+\n+        String query = \"SELECT \"\n+                + EventClientRepository.event_column.formSubmissionId\n+                + \" FROM event\";\n+\n+        List<String> tempList;\n+\n+        boolean shouldEnd = false;\n+\n+        if (formSubmissionIdsList.size() <= tempPageSize) {\n+            tempList = formSubmissionIdsList;\n+            shouldEnd = true;\n+        } else {\n+            tempList = formSubmissionIdsList.subList(0, tempPageSize);\n+        }\n+\n+        int limit = formSubmissionIdsList.size() - tempPageSize;\n+\n+        query += \" WHERE \" + EventClientRepository.event_column.formSubmissionId + \" IN ( \" + StringUtils.repeat(\"?\", \", \", tempList.size()) + \")\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71213bb121415192f6598db6ddba9ad8d61a26a8"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "376c7bb4560117e05dcadf082ed692f59d59266c", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/376c7bb4560117e05dcadf082ed692f59d59266c", "committedDate": "2020-11-17T06:18:36Z", "message": "code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "653f2b742a04ca05014503eba6b192768dd30873", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/653f2b742a04ca05014503eba6b192768dd30873", "committedDate": "2020-11-17T06:19:07Z", "message": "Merge branch 'update-checkFormSubmissionId' of github.com:OpenSRP/opensrp-client-core into update-checkFormSubmissionId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "717b68795cef707647ecefc10bb05073cc0ac58f", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/717b68795cef707647ecefc10bb05073cc0ac58f", "committedDate": "2020-11-17T06:19:40Z", "message": "Merge branch 'master' into update-checkFormSubmissionId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d23a1f47ee63a97baaf97e8b31fb38edda73dd99", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/d23a1f47ee63a97baaf97e8b31fb38edda73dd99", "committedDate": "2020-11-18T07:22:45Z", "message": "Merge branch 'master' into update-checkFormSubmissionId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a857819c418747d9504ef091430939c5bfe0f289", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/a857819c418747d9504ef091430939c5bfe0f289", "committedDate": "2020-11-18T07:35:21Z", "message": "Merge branch 'master' into update-checkFormSubmissionId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1019b6f54ee90914424a815677dc6eb10599baff", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/1019b6f54ee90914424a815677dc6eb10599baff", "committedDate": "2020-11-18T12:36:14Z", "message": "Merge branch 'master' into update-checkFormSubmissionId"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNDExNzk4", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#pullrequestreview-533411798", "createdAt": "2020-11-18T12:49:40Z", "commit": {"oid": "1019b6f54ee90914424a815677dc6eb10599baff"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2401aa1daf0a7a0045bed8ddd81aac1c0ac2d445", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/2401aa1daf0a7a0045bed8ddd81aac1c0ac2d445", "committedDate": "2020-11-18T12:51:51Z", "message": "update snapshot version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNTAzNzAy", "url": "https://github.com/opensrp/opensrp-client-core/pull/685#pullrequestreview-533503702", "createdAt": "2020-11-18T14:31:53Z", "commit": {"oid": "2401aa1daf0a7a0045bed8ddd81aac1c0ac2d445"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2516, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}