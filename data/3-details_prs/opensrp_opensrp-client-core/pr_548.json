{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3NzE4ODcy", "number": 548, "title": "Retry sync for plans, locations and tasks", "bodyText": "Resolves #542", "createdAt": "2020-06-04T09:49:11Z", "url": "https://github.com/opensrp/opensrp-client-core/pull/548", "merged": true, "mergeCommit": {"oid": "eadd94fa36194583ffabc0a8d1cd5927eb9961cd"}, "closed": true, "closedAt": "2020-06-26T09:31:41Z", "author": {"login": "Rkareko"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcn4QkzgH2gAyNDI3NzE4ODcyOmQ1NzcyNmU3MzRkZmYxYTYzM2M4NGYwNmVkOWJjNzgzMTEyOGVlY2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcu_3rbAFqTQzODE1MTcyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d57726e734dff1a633c84f06ed9bc7831128eecf", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/d57726e734dff1a633c84f06ed9bc7831128eecf", "committedDate": "2020-06-04T06:41:55Z", "message": "Retry sync for tasks if records are returned"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60f70e5e28e7c5749ecf2c99c69302d2549c57b6", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/60f70e5e28e7c5749ecf2c99c69302d2549c57b6", "committedDate": "2020-06-04T06:53:35Z", "message": "Retry sync for plans if record are returned"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b7eded0392444e39c52b64fe7cdf15a4a396ff5", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/1b7eded0392444e39c52b64fe7cdf15a4a396ff5", "committedDate": "2020-06-04T07:20:31Z", "message": "Retry sync for locations and structures if more records are available"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "079a396b53716730ddc73b2715689be0a48bcb74", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/079a396b53716730ddc73b2715689be0a48bcb74", "committedDate": "2020-06-04T07:34:21Z", "message": "Rename variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed8ae691781bcedd71129f98f98d6f4c8c105571", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/ed8ae691781bcedd71129f98f98d6f4c8c105571", "committedDate": "2020-06-04T09:49:18Z", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09226f70c3d7eaf06bcd9d4e449735afb025c467", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/09226f70c3d7eaf06bcd9d4e449735afb025c467", "committedDate": "2020-06-08T13:46:45Z", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdeb7cd5aef2563ad225ea70ed31900ee412b467", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/fdeb7cd5aef2563ad225ea70ed31900ee412b467", "committedDate": "2020-06-10T08:23:15Z", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "997cf6f9fe7eb68dc2071ab7bc519406877f1b26", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/997cf6f9fe7eb68dc2071ab7bc519406877f1b26", "committedDate": "2020-06-18T12:15:03Z", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzODY3NTI0", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#pullrequestreview-433867524", "createdAt": "2020-06-19T07:40:33Z", "commit": {"oid": "997cf6f9fe7eb68dc2071ab7bc519406877f1b26"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwNzo0MDozM1rOGmLQhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwNzo0MDozM1rOGmLQhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4MzUyNQ==", "bodyText": "since the limit can always be changed from the server, retry sync if any record was synced", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#discussion_r442683525", "createdAt": "2020-06-19T07:40:33Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/sync/helper/PlanIntentServiceHelper.java", "diffHunk": "@@ -59,6 +60,15 @@ private PlanIntentServiceHelper(PlanDefinitionRepository planRepository, Locatio\n     }\n \n     public void syncPlans() {\n+        int batchFetchCount = batchFetchPlansFromServer();\n+\n+        while(batchFetchCount >= PLAN_PULL_LIMIT) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997cf6f9fe7eb68dc2071ab7bc519406877f1b26"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzODY3NTg0", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#pullrequestreview-433867584", "createdAt": "2020-06-19T07:40:40Z", "commit": {"oid": "997cf6f9fe7eb68dc2071ab7bc519406877f1b26"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwNzo0MDo0MFrOGmLQxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwNzo0MDo0MFrOGmLQxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4MzU4OA==", "bodyText": "since the limit can always be changed from the server, retry sync if any record was synced", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#discussion_r442683588", "createdAt": "2020-06-19T07:40:40Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/sync/helper/LocationServiceHelper.java", "diffHunk": "@@ -78,6 +79,19 @@ public static LocationServiceHelper getInstance() {\n     }\n \n     protected List<Location> syncLocationsStructures(boolean isJurisdiction) {\n+        List<Location> locationStructures = batchSyncLocationsStructures(isJurisdiction);\n+        int batchFetchCount = locationStructures.size();\n+\n+        while( locationStructures != null &&  batchFetchCount >= LOCATION_PULL_LIMIT) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997cf6f9fe7eb68dc2071ab7bc519406877f1b26"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzODY3OTgy", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#pullrequestreview-433867982", "createdAt": "2020-06-19T07:41:23Z", "commit": {"oid": "997cf6f9fe7eb68dc2071ab7bc519406877f1b26"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwNzo0MToyM1rOGmLR3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwNzo0MToyM1rOGmLR3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4Mzg3MQ==", "bodyText": "since the limit can always be changed from the server, retry sync if any record was synced", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#discussion_r442683871", "createdAt": "2020-06-19T07:41:23Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/sync/helper/TaskServiceHelper.java", "diffHunk": "@@ -95,6 +96,20 @@ public TaskServiceHelper(TaskRepository taskRepository) {\n     public List<Task> fetchTasksFromServer() {\n         Set<String> planDefinitions = getPlanDefinitionIds();\n         List<String> groups = getLocationIds();\n+\n+        List<Task> tasks = batchFetchTasksFromServer(planDefinitions,groups);\n+        int batchFetchCount = tasks.size();\n+\n+        while( tasks != null &&  batchFetchCount >= TASK_PULL_LIMIT) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997cf6f9fe7eb68dc2071ab7bc519406877f1b26"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf3cb14540d08ab561cf2911fbff7df4a31fbcad", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/bf3cb14540d08ab561cf2911fbff7df4a31fbcad", "committedDate": "2020-06-19T08:35:44Z", "message": "Retry sync if any records are fetched from the server"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8e8ca8c18dc8f24c15ce09a0d4b9e241324a6ef", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/d8e8ca8c18dc8f24c15ce09a0d4b9e241324a6ef", "committedDate": "2020-06-19T08:55:14Z", "message": "Perform null checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bacd7a5bba946a08d1aea54176185458d7b8b1d8", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/bacd7a5bba946a08d1aea54176185458d7b8b1d8", "committedDate": "2020-06-19T09:01:35Z", "message": "Merge branch 'retry-sync-for-plans-locations-tasks' of github.com:OpenSRP/opensrp-client-core into retry-sync-for-plans-locations-tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67cc94109686f2773a128b85f6caa684181b15d4", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/67cc94109686f2773a128b85f6caa684181b15d4", "committedDate": "2020-06-19T13:31:49Z", "message": "Use recursion for retrying sync"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MDgyNTU1", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#pullrequestreview-434082555", "createdAt": "2020-06-19T13:36:00Z", "commit": {"oid": "67cc94109686f2773a128b85f6caa684181b15d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzozNjowMVrOGmVFSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzozNjowMVrOGmVFSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg0NDQ5MQ==", "bodyText": "No need for this", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#discussion_r442844491", "createdAt": "2020-06-19T13:36:01Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/sync/helper/PlanIntentServiceHelper.java", "diffHunk": "@@ -86,10 +91,15 @@ public void syncPlans() {\n             // update most recent server version\n             if (!Utils.isEmptyCollection(plans)) {\n                 allSharedPreferences.savePreference(PLAN_LAST_SYNC_DATE, String.valueOf(getPlanDefinitionMaxServerVersion(plans, maxServerVersion)));\n+\n+                // retry fetch since there were items synced from the server\n+                batchFetchPlansFromServer();\n             }\n         } catch (Exception e) {\n             Timber.e(e, \"EXCEPTION %s\", e.toString());\n         }\n+\n+        return ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67cc94109686f2773a128b85f6caa684181b15d4"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MDg0NjMz", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#pullrequestreview-434084633", "createdAt": "2020-06-19T13:38:53Z", "commit": {"oid": "67cc94109686f2773a128b85f6caa684181b15d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzozODo1M1rOGmVLcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzozODo1M1rOGmVLcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg0NjA2NA==", "bodyText": "for recursion add a param  List<Task to batchFetchTasksFromServer\nThen this is how you recall the method\ntasks.addAll(batchFetchTasks);\nreturn  batchFetchTasksFromServer(planDefinitions, groups,tasks);", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#discussion_r442846064", "createdAt": "2020-06-19T13:38:53Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/sync/helper/TaskServiceHelper.java", "diffHunk": "@@ -120,6 +127,9 @@ public TaskServiceHelper(TaskRepository taskRepository) {\n             }\n             if (!Utils.isEmptyCollection(tasks)) {\n                 allSharedPreferences.savePreference(TASK_LAST_SYNC_DATE, String.valueOf(getTaskMaxServerVersion(tasks, maxServerVersion)));\n+                // retry fetch since there were items synced from the server\n+                List<Task> batchFetchTasks = batchFetchTasksFromServer(planDefinitions, groups);\n+                tasks.addAll(batchFetchTasks);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67cc94109686f2773a128b85f6caa684181b15d4"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MDg1MDAx", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#pullrequestreview-434085001", "createdAt": "2020-06-19T13:39:23Z", "commit": {"oid": "67cc94109686f2773a128b85f6caa684181b15d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzozOToyM1rOGmVMiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzozOToyM1rOGmVMiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg0NjM0Nw==", "bodyText": "check https://github.com/OpenSRP/opensrp-client-core/pull/548/files#r442846064", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#discussion_r442846347", "createdAt": "2020-06-19T13:39:23Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/sync/helper/LocationServiceHelper.java", "diffHunk": "@@ -108,6 +113,10 @@ public static LocationServiceHelper getInstance() {\n                 String maxServerVersion = getMaxServerVersion(locations);\n                 String updateKey = isJurisdiction ? LOCATION_LAST_SYNC_DATE : STRUCTURES_LAST_SYNC_DATE;\n                 allSharedPreferences.savePreference(updateKey, maxServerVersion);\n+\n+                // retry fetch since there were items synced from the server\n+                List<Location> batchLocationStructures = batchSyncLocationsStructures(isJurisdiction);\n+                locations.addAll(batchLocationStructures);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67cc94109686f2773a128b85f6caa684181b15d4"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c256a3b2e80305c9921bc7f0d53ea2db749da0f4", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/c256a3b2e80305c9921bc7f0d53ea2db749da0f4", "committedDate": "2020-06-19T13:53:19Z", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb69c25ace2b1881eb67d264f8a01684e48182cd", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/bb69c25ace2b1881eb67d264f8a01684e48182cd", "committedDate": "2020-06-19T14:15:54Z", "message": "Update recursive funtion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd9632315b4d267f446c245551b423dbc0f68079", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/fd9632315b4d267f446c245551b423dbc0f68079", "committedDate": "2020-06-21T11:09:52Z", "message": "Fix termination conditional for recursive functional to return total entities"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff92f0a497b72f976525560e5fc78ab3bbf82e43", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/ff92f0a497b72f976525560e5fc78ab3bbf82e43", "committedDate": "2020-06-23T10:04:06Z", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "458e7fc230f2f98bb459e5dfb1d82d4725e09f68", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/458e7fc230f2f98bb459e5dfb1d82d4725e09f68", "committedDate": "2020-06-23T10:58:55Z", "message": "Update test to return empty list on second location sync call"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30a92ae688648644b95d6d4f25a76d7be53c829b", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/30a92ae688648644b95d6d4f25a76d7be53c829b", "committedDate": "2020-06-23T11:52:46Z", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecd1c238bffb4eaabfe339c6da9b538c6800d3bf", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/ecd1c238bffb4eaabfe339c6da9b538c6800d3bf", "committedDate": "2020-06-24T08:55:47Z", "message": "Nullify geometry when returning synced locations/structures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62215b511df719d5ee9d42f11f20ecbce9841a72", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/62215b511df719d5ee9d42f11f20ecbce9841a72", "committedDate": "2020-06-24T08:56:19Z", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2ODgyOTA4", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#pullrequestreview-436882908", "createdAt": "2020-06-24T18:01:21Z", "commit": {"oid": "62215b511df719d5ee9d42f11f20ecbce9841a72"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af4f74661c8964ec050ea43b61f9b22ea8f679aa", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/af4f74661c8964ec050ea43b61f9b22ea8f679aa", "committedDate": "2020-06-26T09:10:05Z", "message": "Bump version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MTUxNzI1", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#pullrequestreview-438151725", "createdAt": "2020-06-26T09:31:26Z", "commit": {"oid": "af4f74661c8964ec050ea43b61f9b22ea8f679aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2588, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}