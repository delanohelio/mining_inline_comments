{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4NTk4MTc4", "number": 705, "title": "add gps properties to their own obs", "bodyText": "Adds latitude,longitude,altitude,accuracy to their own Obs", "createdAt": "2020-11-27T12:55:35Z", "url": "https://github.com/opensrp/opensrp-client-core/pull/705", "merged": true, "mergeCommit": {"oid": "90c7eaa020f1c171b7d206f907a83cccdbd44462"}, "closed": true, "closedAt": "2020-11-30T14:23:08Z", "author": {"login": "bennsimon"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgnC5AAH2gAyNTI4NTk4MTc4OjNmMDliNzZhYzI5MzQxN2VlNmJmMDQxOTNjNjRjZTIzMjQyNDU0YTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhmDHgAFqTU0MDk0NzQ5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3f09b76ac293417ee6bf04193c64ce23242454a3", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/3f09b76ac293417ee6bf04193c64ce23242454a3", "committedDate": "2020-11-27T12:52:16Z", "message": "add gps properties to their own obs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a807a5df982211bec065753ed4f676082b4b68af", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/a807a5df982211bec065753ed4f676082b4b68af", "committedDate": "2020-11-27T13:04:59Z", "message": "fix fqn issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c0920d5606374a5a2cf7a22cb63e37b93922e3b", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/7c0920d5606374a5a2cf7a22cb63e37b93922e3b", "committedDate": "2020-11-27T14:03:06Z", "message": "Merge branch 'master' of github.com:OpenSRP/opensrp-client-core into add-gps-properties-to-obs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6880cd75e0584bf39a08277fe9226f0078ec29f", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/a6880cd75e0584bf39a08277fe9226f0078ec29f", "committedDate": "2020-11-27T15:43:06Z", "message": "update snapshot version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNjQ0OTc0", "url": "https://github.com/opensrp/opensrp-client-core/pull/705#pullrequestreview-540644974", "createdAt": "2020-11-30T07:16:38Z", "commit": {"oid": "a6880cd75e0584bf39a08277fe9226f0078ec29f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNzoxNjozOFrOH7uU6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNzoxNjozOFrOH7uU6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM4NzA1MA==", "bodyText": "Any reason to save each observation separately? Wouldn't it be more compact and consistent to use the approach native radio widget takes of saving key-value pairs as part of the obs using https://github.com/OpenSRP/opensrp-client-core/blob/a6880cd75e0584bf39a08277fe9226f0078ec29f/opensrp-app/src/main/java/org/smartregister/util/JsonFormUtils.java#L588?", "url": "https://github.com/opensrp/opensrp-client-core/pull/705#discussion_r532387050", "createdAt": "2020-11-30T07:16:38Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/util/JsonFormUtils.java", "diffHunk": "@@ -466,11 +465,45 @@ public static void addObservation(Event e, JSONObject jsonObject) {\n             } catch (JSONException e1) {\n                 Timber.e(e1);\n             }\n+        } else if (AllConstants.GPS.equals(type)) {\n+            createGpsObservation(e, jsonObject, value);\n         } else {\n             createObservation(e, jsonObject, value);\n         }\n     }\n \n+    private static void createGpsObservation(Event e, JSONObject jsonObject, String value) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6880cd75e0584bf39a08277fe9226f0078ec29f"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNzA5Njcx", "url": "https://github.com/opensrp/opensrp-client-core/pull/705#pullrequestreview-540709671", "createdAt": "2020-11-30T09:03:11Z", "commit": {"oid": "a6880cd75e0584bf39a08277fe9226f0078ec29f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwOTowMzoxMVrOH7xdSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwOTowMzoxMVrOH7xdSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQzODM0Ng==", "bodyText": "The code here looks duplicated, we can maybe move the common code into a private method.", "url": "https://github.com/opensrp/opensrp-client-core/pull/705#discussion_r532438346", "createdAt": "2020-11-30T09:03:11Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/util/JsonFormUtils.java", "diffHunk": "@@ -466,11 +465,45 @@ public static void addObservation(Event e, JSONObject jsonObject) {\n             } catch (JSONException e1) {\n                 Timber.e(e1);\n             }\n+        } else if (AllConstants.GPS.equals(type)) {\n+            createGpsObservation(e, jsonObject, value);\n         } else {\n             createObservation(e, jsonObject, value);\n         }\n     }\n \n+    private static void createGpsObservation(Event e, JSONObject jsonObject, String value) {\n+        createObservation(e, jsonObject, value);\n+        if (StringUtils.isNotBlank(value)) {\n+            String[] valueArr = value.split(\" \");\n+            String formSubmissionFieldPrefix = getString(jsonObject, KEY);\n+            if (valueArr.length >= 2) {\n+                String latitude = valueArr[0];\n+                String longitude = valueArr[1];\n+                String formSubmissionField = formSubmissionFieldPrefix + \"_\" + AllConstants.GpsConstants.LATITUDE;\n+                addObs(e, formSubmissionField, AllConstants.TEXT, Collections.singletonList(latitude));\n+\n+                formSubmissionField = formSubmissionFieldPrefix + \"_\" + AllConstants.GpsConstants.LONGITUDE;\n+                addObs(e, formSubmissionField, AllConstants.TEXT, Collections.singletonList(longitude));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6880cd75e0584bf39a08277fe9226f0078ec29f"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNzA5ODQ1", "url": "https://github.com/opensrp/opensrp-client-core/pull/705#pullrequestreview-540709845", "createdAt": "2020-11-30T09:03:24Z", "commit": {"oid": "a6880cd75e0584bf39a08277fe9226f0078ec29f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwOTowMzoyNFrOH7xduw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwOTowMzoyNFrOH7xduw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQzODQ1OQ==", "bodyText": "https://github.com/OpenSRP/opensrp-client-core/pull/705/files#r532438346", "url": "https://github.com/opensrp/opensrp-client-core/pull/705#discussion_r532438459", "createdAt": "2020-11-30T09:03:24Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/util/JsonFormUtils.java", "diffHunk": "@@ -466,11 +465,45 @@ public static void addObservation(Event e, JSONObject jsonObject) {\n             } catch (JSONException e1) {\n                 Timber.e(e1);\n             }\n+        } else if (AllConstants.GPS.equals(type)) {\n+            createGpsObservation(e, jsonObject, value);\n         } else {\n             createObservation(e, jsonObject, value);\n         }\n     }\n \n+    private static void createGpsObservation(Event e, JSONObject jsonObject, String value) {\n+        createObservation(e, jsonObject, value);\n+        if (StringUtils.isNotBlank(value)) {\n+            String[] valueArr = value.split(\" \");\n+            String formSubmissionFieldPrefix = getString(jsonObject, KEY);\n+            if (valueArr.length >= 2) {\n+                String latitude = valueArr[0];\n+                String longitude = valueArr[1];\n+                String formSubmissionField = formSubmissionFieldPrefix + \"_\" + AllConstants.GpsConstants.LATITUDE;\n+                addObs(e, formSubmissionField, AllConstants.TEXT, Collections.singletonList(latitude));\n+\n+                formSubmissionField = formSubmissionFieldPrefix + \"_\" + AllConstants.GpsConstants.LONGITUDE;\n+                addObs(e, formSubmissionField, AllConstants.TEXT, Collections.singletonList(longitude));\n+\n+                if (valueArr.length >= 4) {\n+                    String altitude = valueArr[2];\n+                    String accuracy = valueArr[3];\n+                    formSubmissionField = formSubmissionFieldPrefix + \"_\" + AllConstants.GpsConstants.ALTITUDE;\n+                    addObs(e, formSubmissionField, AllConstants.TEXT, Collections.singletonList(altitude));\n+\n+                    formSubmissionField = formSubmissionFieldPrefix + \"_\" + AllConstants.GpsConstants.ACCURACY;\n+                    addObs(e, formSubmissionField, AllConstants.TEXT, Collections.singletonList(accuracy));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6880cd75e0584bf39a08277fe9226f0078ec29f"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00859c14bddfcc8f96f5f4ca17f29e18a907f936", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/00859c14bddfcc8f96f5f4ca17f29e18a907f936", "committedDate": "2020-11-30T09:19:40Z", "message": "code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29fdc2c345c9ad6debedfa31d0e320b51964e86c", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/29fdc2c345c9ad6debedfa31d0e320b51964e86c", "committedDate": "2020-11-30T11:25:28Z", "message": "Merge branch 'master' into add-gps-properties-to-obs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwODM2MTEz", "url": "https://github.com/opensrp/opensrp-client-core/pull/705#pullrequestreview-540836113", "createdAt": "2020-11-30T11:50:54Z", "commit": {"oid": "29fdc2c345c9ad6debedfa31d0e320b51964e86c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMTo1MDo1NFrOH73rlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMTo1MDo1NFrOH73rlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU0MDMxMA==", "bodyText": "These operations : formSubmissionFieldPrefix + \"_\" +, AllConstants.TEXT and Collections.singletonList() are still repeated. I think it's possible to simplify this by passing an event and formSubmissionFieldPrefix and suffix to a method that will perform the duplicated functionality.", "url": "https://github.com/opensrp/opensrp-client-core/pull/705#discussion_r532540310", "createdAt": "2020-11-30T11:50:54Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/util/JsonFormUtils.java", "diffHunk": "@@ -466,11 +465,38 @@ public static void addObservation(Event e, JSONObject jsonObject) {\n             } catch (JSONException e1) {\n                 Timber.e(e1);\n             }\n+        } else if (AllConstants.GPS.equals(type)) {\n+            createGpsObservation(e, jsonObject, value);\n         } else {\n             createObservation(e, jsonObject, value);\n         }\n     }\n \n+    private static void createGpsObservation(Event e, JSONObject jsonObject, String value) {\n+        createObservation(e, jsonObject, value);\n+        if (StringUtils.isNotBlank(value)) {\n+            String[] valueArr = value.split(\" \");\n+            String formSubmissionFieldPrefix = getString(jsonObject, KEY);\n+            if (valueArr.length >= 2) {\n+                String latitude = valueArr[0];\n+                String longitude = valueArr[1];\n+                addObs(e, formSubmissionFieldPrefix + \"_\" + AllConstants.GpsConstants.LATITUDE, AllConstants.TEXT, Collections.singletonList(latitude));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29fdc2c345c9ad6debedfa31d0e320b51964e86c"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e780822f2330cbd93fe278b22d7392bdad95a452", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/e780822f2330cbd93fe278b22d7392bdad95a452", "committedDate": "2020-11-30T13:08:01Z", "message": "code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4455ae2e685e98d770c35a3cb4f0abbf22770cd", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/c4455ae2e685e98d770c35a3cb4f0abbf22770cd", "committedDate": "2020-11-30T13:08:25Z", "message": "Merge branch 'add-gps-properties-to-obs' of github.com:OpenSRP/opensrp-client-core into add-gps-properties-to-obs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTE3MzI5", "url": "https://github.com/opensrp/opensrp-client-core/pull/705#pullrequestreview-540917329", "createdAt": "2020-11-30T13:42:10Z", "commit": {"oid": "e780822f2330cbd93fe278b22d7392bdad95a452"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMzo0MjoxMFrOH77mdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMzo0MjoxMFrOH77mdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwNDUzMw==", "bodyText": "Why not use:\nString[] gpsKeys = new String{AllConstants.GpsConstants.ALTITUDE,...,...};\nfor (int i = 0; i < valueArr; i++) {\n   addGpsObs(e, formSubmissionFieldPrefix, gpsKeys[i], valueArr[i]);\n}\n\nThis removes the need to check for lengths and is a bit more concise.", "url": "https://github.com/opensrp/opensrp-client-core/pull/705#discussion_r532604533", "createdAt": "2020-11-30T13:42:10Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/util/JsonFormUtils.java", "diffHunk": "@@ -480,18 +481,27 @@ private static void createGpsObservation(Event e, JSONObject jsonObject, String\n             if (valueArr.length >= 2) {\n                 String latitude = valueArr[0];\n                 String longitude = valueArr[1];\n-                addObs(e, formSubmissionFieldPrefix + \"_\" + AllConstants.GpsConstants.LATITUDE, AllConstants.TEXT, Collections.singletonList(latitude));\n-                addObs(e, formSubmissionFieldPrefix + \"_\" + AllConstants.GpsConstants.LONGITUDE, AllConstants.TEXT, Collections.singletonList(longitude));\n+                addGpsObs(e, formSubmissionFieldPrefix, AllConstants.GpsConstants.LATITUDE, latitude);\n+                addGpsObs(e, formSubmissionFieldPrefix, AllConstants.GpsConstants.LONGITUDE, longitude);\n                 if (valueArr.length >= 4) {\n                     String altitude = valueArr[2];\n                     String accuracy = valueArr[3];\n-                    addObs(e, formSubmissionFieldPrefix + \"_\" + AllConstants.GpsConstants.ALTITUDE, AllConstants.TEXT, Collections.singletonList(altitude));\n-                    addObs(e, formSubmissionFieldPrefix + \"_\" + AllConstants.GpsConstants.ACCURACY, AllConstants.TEXT, Collections.singletonList(accuracy));\n+                    addGpsObs(e, formSubmissionFieldPrefix, AllConstants.GpsConstants.ALTITUDE, altitude);\n+                    addGpsObs(e, formSubmissionFieldPrefix, AllConstants.GpsConstants.ACCURACY, accuracy);\n                 }\n             }\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e780822f2330cbd93fe278b22d7392bdad95a452"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b835d2bc9ff94a867b4cd2e7ee0df3538647ead3", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/b835d2bc9ff94a867b4cd2e7ee0df3538647ead3", "committedDate": "2020-11-30T13:48:10Z", "message": "apply pr feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTQ3NDUz", "url": "https://github.com/opensrp/opensrp-client-core/pull/705#pullrequestreview-540947453", "createdAt": "2020-11-30T14:16:29Z", "commit": {"oid": "b835d2bc9ff94a867b4cd2e7ee0df3538647ead3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDoxNjoyOVrOH79B6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDoxNjoyOVrOH79B6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyNzk0NQ==", "bodyText": "This should really be a switch-case.", "url": "https://github.com/opensrp/opensrp-client-core/pull/705#discussion_r532627945", "createdAt": "2020-11-30T14:16:29Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/test/java/org/smartregister/util/JsonFormUtilsTest.java", "diffHunk": "@@ -1472,4 +1473,35 @@ public void testCreateObservationShouldCreateCorrectObservation() throws Excepti\n         assertEquals(values, obs.getValues());\n         assertEquals(keyValPairs, obs.getKeyValPairs());\n     }\n+\n+    @Test\n+    public void addObservationAddsGpsObservationsToEvent() throws Exception {\n+        String observationJsonObjectString =\n+                \"{\\\"value\\\":\\\"-2.4535 37.324 0.2 0.3\\\",\\\"openmrs_entity\\\":\\\"\\\",\" +\n+                        \"\\\"openmrs_entity_id\\\":\\\"\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\" +\n+                        \"\\\"openmrs_data_type\\\":\\\"text\\\",\\\"type\\\":\\\"gps\\\",\\\"key\\\":\\\"gps\\\"}\";\n+        JSONObject observationJsonObject = new JSONObject(observationJsonObjectString);\n+        Event event = Mockito.spy(new Event());\n+        JsonFormUtils.addObservation(event, observationJsonObject);\n+        Mockito.verify(event, Mockito.times(5)).addObs(any(Obs.class));\n+        String values[] = observationJsonObject.optString(VALUE).split(\" \");\n+        String latitudeKey = observationJsonObject.getString(KEY) + \"_\" + AllConstants.GpsConstants.LATITUDE;\n+        String longitudeKey = observationJsonObject.getString(KEY) + \"_\" + AllConstants.GpsConstants.LONGITUDE;\n+        String altitudeKey = observationJsonObject.getString(KEY) + \"_\" + AllConstants.GpsConstants.ALTITUDE;\n+        String accuracyKey = observationJsonObject.getString(KEY) + \"_\" + AllConstants.GpsConstants.ACCURACY;\n+        List<String> formSubmissionFields = Arrays.asList(latitudeKey, longitudeKey, accuracyKey, altitudeKey, \"gps\");\n+        for (Obs obs : event.getObs()) {\n+            String formSubmissionField = obs.getFormSubmissionField();\n+            assertTrue(formSubmissionFields.contains(formSubmissionField));\n+            if (formSubmissionField.equals(latitudeKey)) {\n+                assertEquals(values[0], obs.getValues().get(0));\n+            } else if (formSubmissionField.equals(longitudeKey)) {\n+                assertEquals(values[1], obs.getValues().get(0));\n+            } else if (formSubmissionField.equals(altitudeKey)) {\n+                assertEquals(values[2], obs.getValues().get(0));\n+            } else if (formSubmissionField.equals(accuracyKey)) {\n+                assertEquals(values[3], obs.getValues().get(0));\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b835d2bc9ff94a867b4cd2e7ee0df3538647ead3"}, "originalPosition": 118}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTQ3NDk5", "url": "https://github.com/opensrp/opensrp-client-core/pull/705#pullrequestreview-540947499", "createdAt": "2020-11-30T14:16:32Z", "commit": {"oid": "b835d2bc9ff94a867b4cd2e7ee0df3538647ead3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2529, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}