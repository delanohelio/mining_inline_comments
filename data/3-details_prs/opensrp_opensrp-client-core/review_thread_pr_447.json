{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0ODA1ODU5", "number": 447, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMTo0Mzo0MlrODqwTAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNTozMDo1M1rODrRKXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MTU4MDgwOnYy", "diffSide": "RIGHT", "path": "opensrp-app/src/main/java/org/smartregister/sync/intent/SyncIntentService.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMTo0Mzo0MlrOF6sc1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNToyMDo0OVrOF7gT_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5MDAwNQ==", "bodyText": "This should be after if(!hasValidAuthorization) as its more efficient as hasValidAuthorization is already known.\nIS_APP_VERSION_ALLOWED will always be false even after an APK has been upgraded if it was false as it will not be set to true again why not save the minimum version itself and just check against that instead of boolean", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397090005", "createdAt": "2020-03-24T11:43:42Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/sync/intent/SyncIntentService.java", "diffHunk": "@@ -79,12 +82,16 @@ private void doSync() {\n             if (hasValidAuthorization || !CoreLibrary.getInstance().getSyncConfiguration().disableSyncToServerIfUserIsDisabled()) {\n                 pushToServer();\n             }\n-            if (hasValidAuthorization) {\n-                pullECFromServer();\n-            } else {\n+\n+            if (!syncUtils.isAppVersionAllowed()) {\n+                AllSettings settingsRepository = org.smartregister.Context.getInstance().allSettings();\n+                settingsRepository.put(IS_APP_VERSION_ALLOWED, \"false\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f903b2b17ee132e371ed6d7ec9a90f380c0b806"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxOTc0Mw==", "bodyText": "Fixed the first concern.\nI'm not sure I understand the second concern. An upgrade can only be done by uninstalling the current app or by clearing data on the phone and upgrading with a new apk. So the IS_APP_VERSION_ALLOWED will definitely be recomputed.\nOnce a user is logged out, they cannot log back in until they upgrade the app by following one of the two options above.", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397819743", "createdAt": "2020-03-25T12:36:10Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/sync/intent/SyncIntentService.java", "diffHunk": "@@ -79,12 +82,16 @@ private void doSync() {\n             if (hasValidAuthorization || !CoreLibrary.getInstance().getSyncConfiguration().disableSyncToServerIfUserIsDisabled()) {\n                 pushToServer();\n             }\n-            if (hasValidAuthorization) {\n-                pullECFromServer();\n-            } else {\n+\n+            if (!syncUtils.isAppVersionAllowed()) {\n+                AllSettings settingsRepository = org.smartregister.Context.getInstance().allSettings();\n+                settingsRepository.put(IS_APP_VERSION_ALLOWED, \"false\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5MDAwNQ=="}, "originalCommit": {"oid": "7f903b2b17ee132e371ed6d7ec9a90f380c0b806"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg0MzQyMA==", "bodyText": "Its possible to upgrade without uninstall of the current app and this is the upgrade recommended for the OpenSRP.\nThe concert is valid when the APK is upgraded", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397843420", "createdAt": "2020-03-25T13:15:43Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/sync/intent/SyncIntentService.java", "diffHunk": "@@ -79,12 +82,16 @@ private void doSync() {\n             if (hasValidAuthorization || !CoreLibrary.getInstance().getSyncConfiguration().disableSyncToServerIfUserIsDisabled()) {\n                 pushToServer();\n             }\n-            if (hasValidAuthorization) {\n-                pullECFromServer();\n-            } else {\n+\n+            if (!syncUtils.isAppVersionAllowed()) {\n+                AllSettings settingsRepository = org.smartregister.Context.getInstance().allSettings();\n+                settingsRepository.put(IS_APP_VERSION_ALLOWED, \"false\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5MDAwNQ=="}, "originalCommit": {"oid": "7f903b2b17ee132e371ed6d7ec9a90f380c0b806"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkzOTcxMQ==", "bodyText": "Fixed.", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397939711", "createdAt": "2020-03-25T15:20:49Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/sync/intent/SyncIntentService.java", "diffHunk": "@@ -79,12 +82,16 @@ private void doSync() {\n             if (hasValidAuthorization || !CoreLibrary.getInstance().getSyncConfiguration().disableSyncToServerIfUserIsDisabled()) {\n                 pushToServer();\n             }\n-            if (hasValidAuthorization) {\n-                pullECFromServer();\n-            } else {\n+\n+            if (!syncUtils.isAppVersionAllowed()) {\n+                AllSettings settingsRepository = org.smartregister.Context.getInstance().allSettings();\n+                settingsRepository.put(IS_APP_VERSION_ALLOWED, \"false\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5MDAwNQ=="}, "originalCommit": {"oid": "7f903b2b17ee132e371ed6d7ec9a90f380c0b806"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MTU5MjgxOnYy", "diffSide": "RIGHT", "path": "opensrp-app/src/main/java/org/smartregister/util/SyncUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMTo0NzoyOFrOF6skZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxMjoyNDo0NlrOF7YnfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5MTk0Mg==", "bodyText": "maybe break from loop here", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397091942", "createdAt": "2020-03-24T11:47:28Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/util/SyncUtils.java", "diffHunk": "@@ -84,4 +96,39 @@ public void logoutUser() {\n         opensrpContent.userService().logoutSession();\n     }\n \n+    public boolean isAppVersionAllowed() throws PackageManager.NameNotFoundException {\n+        boolean isAppVersionAllowed = true;\n+\n+        AllSettings settingsRepository = opensrpContent.allSettings();\n+        Setting minAllowedAppVersionSetting = settingsRepository.getSetting(MIN_ALLOWED_APP_VERSION);\n+        if (minAllowedAppVersionSetting == null) {\n+            return isAppVersionAllowed;\n+        }\n+\n+        int minAllowedAppVersion = extractMinAllowedAppVersion(minAllowedAppVersionSetting.getValue());\n+        if (getVersionCode(context) < minAllowedAppVersion) {\n+            isAppVersionAllowed = false;\n+        }\n+\n+        return isAppVersionAllowed;\n+    }\n+\n+    private int extractMinAllowedAppVersion(String setting) {\n+        int minAllowedAppVersion = 0;\n+        try {\n+            JSONArray settings = new JSONObject(setting).optJSONArray(SETTINGS);\n+            for (int i = 0; i < settings.length(); i++) {\n+                JSONObject currSettingObj = settings.optJSONObject(i);\n+                String currKey = currSettingObj.optString(KEY);\n+                if (MIN_ALLOWED_APP_VERSION.equals(currKey)) {\n+                    minAllowedAppVersion = currSettingObj.optInt(VALUE, minAllowedAppVersion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f903b2b17ee132e371ed6d7ec9a90f380c0b806"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxMzYyOQ==", "bodyText": "Done.", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397813629", "createdAt": "2020-03-25T12:24:46Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/util/SyncUtils.java", "diffHunk": "@@ -84,4 +96,39 @@ public void logoutUser() {\n         opensrpContent.userService().logoutSession();\n     }\n \n+    public boolean isAppVersionAllowed() throws PackageManager.NameNotFoundException {\n+        boolean isAppVersionAllowed = true;\n+\n+        AllSettings settingsRepository = opensrpContent.allSettings();\n+        Setting minAllowedAppVersionSetting = settingsRepository.getSetting(MIN_ALLOWED_APP_VERSION);\n+        if (minAllowedAppVersionSetting == null) {\n+            return isAppVersionAllowed;\n+        }\n+\n+        int minAllowedAppVersion = extractMinAllowedAppVersion(minAllowedAppVersionSetting.getValue());\n+        if (getVersionCode(context) < minAllowedAppVersion) {\n+            isAppVersionAllowed = false;\n+        }\n+\n+        return isAppVersionAllowed;\n+    }\n+\n+    private int extractMinAllowedAppVersion(String setting) {\n+        int minAllowedAppVersion = 0;\n+        try {\n+            JSONArray settings = new JSONObject(setting).optJSONArray(SETTINGS);\n+            for (int i = 0; i < settings.length(); i++) {\n+                JSONObject currSettingObj = settings.optJSONObject(i);\n+                String currKey = currSettingObj.optString(KEY);\n+                if (MIN_ALLOWED_APP_VERSION.equals(currKey)) {\n+                    minAllowedAppVersion = currSettingObj.optInt(VALUE, minAllowedAppVersion);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5MTk0Mg=="}, "originalCommit": {"oid": "7f903b2b17ee132e371ed6d7ec9a90f380c0b806"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2Njk1OTk1OnYy", "diffSide": "RIGHT", "path": "opensrp-app/src/main/java/org/smartregister/AllConstants.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNToyOTo0N1rOF7gweg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwOTo0Njo0N1rOF7-xtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk0NzAwMg==", "bodyText": "This is no longer used", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397947002", "createdAt": "2020-03-25T15:29:47Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/AllConstants.java", "diffHunk": "@@ -450,4 +450,15 @@\n \n     }\n \n+    public interface FORCED_LOGOUT {\n+        String MIN_ALLOWED_APP_VERSION_SETTING = \"min_allowed_app_version_setting\";\n+        String MIN_ALLOWED_APP_VERSION = \"min_allowed_app_version\";\n+        String IS_APP_VERSION_ALLOWED = \"is_app_version_allowed\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e30fdbf2cf1195f0ab5058180bceb688d94d8c7b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQzODgzNg==", "bodyText": "Removed.", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r398438836", "createdAt": "2020-03-26T09:46:47Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/AllConstants.java", "diffHunk": "@@ -450,4 +450,15 @@\n \n     }\n \n+    public interface FORCED_LOGOUT {\n+        String MIN_ALLOWED_APP_VERSION_SETTING = \"min_allowed_app_version_setting\";\n+        String MIN_ALLOWED_APP_VERSION = \"min_allowed_app_version\";\n+        String IS_APP_VERSION_ALLOWED = \"is_app_version_allowed\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk0NzAwMg=="}, "originalCommit": {"oid": "e30fdbf2cf1195f0ab5058180bceb688d94d8c7b"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2Njk2NTQwOnYy", "diffSide": "RIGHT", "path": "opensrp-app/src/main/java/org/smartregister/sync/intent/SyncIntentService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNTozMDo1M1rOF7g0DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwOTo0Njo1NFrOF7-x_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk0NzkxNg==", "bodyText": "import not used", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397947916", "createdAt": "2020-03-25T15:30:53Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/sync/intent/SyncIntentService.java", "diffHunk": "@@ -31,6 +32,8 @@\n \n import timber.log.Timber;\n \n+import static org.smartregister.AllConstants.FORCED_LOGOUT.IS_APP_VERSION_ALLOWED;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e30fdbf2cf1195f0ab5058180bceb688d94d8c7b"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQzODkwOA==", "bodyText": "Removed.", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r398438908", "createdAt": "2020-03-26T09:46:54Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/sync/intent/SyncIntentService.java", "diffHunk": "@@ -31,6 +32,8 @@\n \n import timber.log.Timber;\n \n+import static org.smartregister.AllConstants.FORCED_LOGOUT.IS_APP_VERSION_ALLOWED;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk0NzkxNg=="}, "originalCommit": {"oid": "e30fdbf2cf1195f0ab5058180bceb688d94d8c7b"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2200, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}