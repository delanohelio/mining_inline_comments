{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NzYzNzk5", "number": 688, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMjoxNTo0M1rOE6ihIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMjoxNTo0M1rOE6ihIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5ODE4NDAyOnYy", "diffSide": "RIGHT", "path": "opensrp-app/src/main/java/org/smartregister/Context.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMjoxNTo0M1rOH1rAqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMzowNzoxN1rOH1s2ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA0MTI1Ng==", "bodyText": "What is the difference in these?In case this fails what is the fall back, stop app or use normal preferences?", "url": "https://github.com/opensrp/opensrp-client-core/pull/688#discussion_r526041256", "createdAt": "2020-11-18T12:15:43Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/Context.java", "diffHunk": "@@ -580,12 +591,46 @@ public AllSettings allSettings() {\n \n     public AllSharedPreferences allSharedPreferences() {\n         if (allSharedPreferences == null) {\n-            allSharedPreferences = new AllSharedPreferences(\n-                    getDefaultSharedPreferences(this.applicationContext));\n+            allSharedPreferences = new AllSharedPreferences(createSharedPreferences(this.applicationContext));\n         }\n         return allSharedPreferences;\n     }\n \n+    private SharedPreferences createSharedPreferences(android.content.Context context) {\n+        SyncConfiguration syncConfiguration = CoreLibrary.getInstance().getSyncConfiguration();\n+        \n+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M\n+                && syncConfiguration != null\n+                && syncConfiguration.encryptSharedPreferences()) {\n+\n+            return createEncryptedSharedPreferences(context);\n+        } else {\n+            return getDefaultSharedPreferences(context);\n+        }\n+    }\n+\n+    private SharedPreferences createEncryptedSharedPreferences(android.content.Context context) {\n+        SharedPreferences sharedPreferences = null;\n+\n+        try {\n+            String masterKeyAlias = MasterKeys.getOrCreate(MasterKeys.AES256_GCM_SPEC);\n+\n+            sharedPreferences = EncryptedSharedPreferences.create(\n+                    SHARED_PREFERENCES_FILENAME,\n+                    masterKeyAlias,\n+                    context,\n+                    EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,\n+                    EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM\n+            );\n+        } catch (GeneralSecurityException e) {\n+            Timber.e(e);\n+        } catch (IOException e) {\n+            Timber.e(e);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25f561b74f80d61322c133f66fe5d691543da307"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA3MTQxOQ==", "bodyText": "Updated to fall back to unencrypted SharedPreferences on error", "url": "https://github.com/opensrp/opensrp-client-core/pull/688#discussion_r526071419", "createdAt": "2020-11-18T13:07:17Z", "author": {"login": "qiarie"}, "path": "opensrp-app/src/main/java/org/smartregister/Context.java", "diffHunk": "@@ -580,12 +591,46 @@ public AllSettings allSettings() {\n \n     public AllSharedPreferences allSharedPreferences() {\n         if (allSharedPreferences == null) {\n-            allSharedPreferences = new AllSharedPreferences(\n-                    getDefaultSharedPreferences(this.applicationContext));\n+            allSharedPreferences = new AllSharedPreferences(createSharedPreferences(this.applicationContext));\n         }\n         return allSharedPreferences;\n     }\n \n+    private SharedPreferences createSharedPreferences(android.content.Context context) {\n+        SyncConfiguration syncConfiguration = CoreLibrary.getInstance().getSyncConfiguration();\n+        \n+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M\n+                && syncConfiguration != null\n+                && syncConfiguration.encryptSharedPreferences()) {\n+\n+            return createEncryptedSharedPreferences(context);\n+        } else {\n+            return getDefaultSharedPreferences(context);\n+        }\n+    }\n+\n+    private SharedPreferences createEncryptedSharedPreferences(android.content.Context context) {\n+        SharedPreferences sharedPreferences = null;\n+\n+        try {\n+            String masterKeyAlias = MasterKeys.getOrCreate(MasterKeys.AES256_GCM_SPEC);\n+\n+            sharedPreferences = EncryptedSharedPreferences.create(\n+                    SHARED_PREFERENCES_FILENAME,\n+                    masterKeyAlias,\n+                    context,\n+                    EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,\n+                    EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM\n+            );\n+        } catch (GeneralSecurityException e) {\n+            Timber.e(e);\n+        } catch (IOException e) {\n+            Timber.e(e);\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA0MTI1Ng=="}, "originalCommit": {"oid": "25f561b74f80d61322c133f66fe5d691543da307"}, "originalPosition": 134}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2128, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}