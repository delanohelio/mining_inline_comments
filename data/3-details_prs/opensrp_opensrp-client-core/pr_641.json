{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyODk2MzY2", "number": 641, "title": "combine checkbox values for openmrs entities", "bodyText": "", "createdAt": "2020-09-09T14:43:40Z", "url": "https://github.com/opensrp/opensrp-client-core/pull/641", "merged": true, "mergeCommit": {"oid": "8fb9f80bd2ff5385024ee9c7efa9b165cc7349ae"}, "closed": true, "closedAt": "2020-09-11T12:50:30Z", "author": {"login": "bennsimon"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHNRybAH2gAyNDgyODk2MzY2OjRlZmQzYzM4ZjA3YzM4NjZkNTZkNjIyZDdkNDQyMWNiYmVhZGJkY2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH02IvAFqTQ4Njc3NDg0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4efd3c38f07c3866d56d622d7d4421cbbeadbdcb", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/4efd3c38f07c3866d56d622d7d4421cbbeadbdcb", "committedDate": "2020-09-09T14:42:54Z", "message": "combine checkbox values for openmrs entities"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27858faed8d80f89fc4eb5f39dc78c294a08f173", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/27858faed8d80f89fc4eb5f39dc78c294a08f173", "committedDate": "2020-09-09T14:48:11Z", "message": "Merge branch 'master' into combine-check-box-values-for-concept"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NjQ0MDE5", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#pullrequestreview-486644019", "createdAt": "2020-09-11T09:18:57Z", "commit": {"oid": "27858faed8d80f89fc4eb5f39dc78c294a08f173"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwOToxODo1N1rOHQV37g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwOToxODo1N1rOHQV37g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg5NzY0Ng==", "bodyText": "Should these be part of the if block? Is it used elsewhere?", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486897646", "createdAt": "2020-09-11T09:18:57Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/util/JsonFormUtils.java", "diffHunk": "@@ -407,26 +409,39 @@ private static JSONObject getCheckBoxJsonObjects(Event event, JSONObject parentO\n \n     public static void addObservation(Event e, JSONObject jsonObject) {\n         String value = getString(jsonObject, VALUE);\n-        if (StringUtils.isBlank(value)) { return; }\n+        if (StringUtils.isBlank(value)) {\n+            return;\n+        }\n \n         String type = getString(jsonObject, AllConstants.TYPE);\n         if (AllConstants.CHECK_BOX.equals(type)) {\n             try {\n                 List<Object> optionValues = new ArrayList<>();\n+                List<Object> optionEntityIds = new ArrayList<>();\n                 Map<String, Object> optionKeyVals = new HashMap<>();\n                 if (jsonObject.has(AllConstants.OPTIONS)) {\n                     JSONArray options = jsonObject.getJSONArray(AllConstants.OPTIONS);\n+                    boolean shouldBeCombined = jsonObject.optBoolean(AllConstants.COMBINE_CHECKBOX_OPTION_VALUES);\n+                    String entity = getString(jsonObject, OPENMRS_ENTITY);\n                     for (int i = 0; i < options.length(); i++) {\n                         JSONObject option = options.getJSONObject(i);\n                         boolean optionValue = option.optBoolean(VALUE);\n                         if (!optionValue) {\n                             continue;\n                         }\n-                        if (CONCEPT.equals(getString(jsonObject, OPENMRS_ENTITY))) {\n+                        if (CONCEPT.equals(entity)) {\n+                            String optionKey = option.optString(KEY);\n+                            String openmrsEntityId = option.optString(OPENMRS_ENTITY_ID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27858faed8d80f89fc4eb5f39dc78c294a08f173"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NjQ0OTYx", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#pullrequestreview-486644961", "createdAt": "2020-09-11T09:20:14Z", "commit": {"oid": "27858faed8d80f89fc4eb5f39dc78c294a08f173"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwOToyMDoxNFrOHQV8yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwOToyMDoxNFrOHQV8yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg5ODg4OA==", "bodyText": "Isn't createObservation being called on line 445?", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486898888", "createdAt": "2020-09-11T09:20:14Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/util/JsonFormUtils.java", "diffHunk": "@@ -435,8 +450,13 @@ public static void addObservation(Event e, JSONObject jsonObject) {\n                         }\n                     }\n                     if (!optionValues.isEmpty()) {\n-                        // For options without concepts combine the values into one observation\n-                        createObservation(e, jsonObject, optionKeyVals, optionValues);\n+                        if (CONCEPT.equals(entity) && shouldBeCombined) {\n+                            e.addObs(new Obs(CONCEPT, AllConstants.CHECK_BOX, jsonObject.optString(OPENMRS_ENTITY_ID), jsonObject.optString(OPENMRS_ENTITY_PARENT), optionEntityIds, optionValues, null,\n+                                    jsonObject.optString(KEY)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27858faed8d80f89fc4eb5f39dc78c294a08f173"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NjQ2NTA2", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#pullrequestreview-486646506", "createdAt": "2020-09-11T09:22:26Z", "commit": {"oid": "27858faed8d80f89fc4eb5f39dc78c294a08f173"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwOToyMjoyNlrOHQWFmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwOToyMjoyNlrOHQWFmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjkwMTE0Nw==", "bodyText": "Not sure I understand this change?", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486901147", "createdAt": "2020-09-11T09:22:26Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/location/helper/LocationHelper.java", "diffHunk": "@@ -168,7 +168,7 @@ public String getOpenMrsLocationId(@NonNull String locationName) {\n         } catch (Exception e) {\n             Timber.e(e);\n         }\n-        return locationName.equals(response) ? AllConstants.ADVANCED_DATA_CAPTURE_STRATEGY_PREFIX + locationName.trim().replaceAll(\" \", \"-\").toLowerCase(Locale.ENGLISH) : response;\n+        return response;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27858faed8d80f89fc4eb5f39dc78c294a08f173"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a804d99ef338ba2fb915e2b527c9c5f21807c120", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/a804d99ef338ba2fb915e2b527c9c5f21807c120", "committedDate": "2020-09-11T09:52:51Z", "message": "add variables to be reused"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "908d23f4eaa6b85270e4dd207b67fb10296ecf33", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/908d23f4eaa6b85270e4dd207b67fb10296ecf33", "committedDate": "2020-09-11T09:53:34Z", "message": "Merge branch 'combine-check-box-values-for-concept' of github.com:OpenSRP/opensrp-client-core into combine-check-box-values-for-concept"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fba12a5fbcb4f5f65e1534e26d1880303deb562", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/4fba12a5fbcb4f5f65e1534e26d1880303deb562", "committedDate": "2020-09-11T10:18:55Z", "message": "change the scope of option variables\n\nupdate snapshot version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NzIzMTUx", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#pullrequestreview-486723151", "createdAt": "2020-09-11T11:26:12Z", "commit": {"oid": "4fba12a5fbcb4f5f65e1534e26d1880303deb562"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMToyNjoxM1rOHQbCYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMToyNjoxM1rOHQbCYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk4MjI0MQ==", "bodyText": "fieldKey?", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486982241", "createdAt": "2020-09-11T11:26:13Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/util/JsonFormUtils.java", "diffHunk": "@@ -407,26 +409,42 @@ private static JSONObject getCheckBoxJsonObjects(Event event, JSONObject parentO\n \n     public static void addObservation(Event e, JSONObject jsonObject) {\n         String value = getString(jsonObject, VALUE);\n-        if (StringUtils.isBlank(value)) { return; }\n+        if (StringUtils.isBlank(value)) {\n+            return;\n+        }\n \n         String type = getString(jsonObject, AllConstants.TYPE);\n         if (AllConstants.CHECK_BOX.equals(type)) {\n             try {\n                 List<Object> optionValues = new ArrayList<>();\n+                List<Object> optionEntityIds = new ArrayList<>();\n                 Map<String, Object> optionKeyVals = new HashMap<>();\n                 if (jsonObject.has(AllConstants.OPTIONS)) {\n                     JSONArray options = jsonObject.getJSONArray(AllConstants.OPTIONS);\n+                    String fieldsOpenmrsEntityId = jsonObject.optString(OPENMRS_ENTITY_ID);\n+                    String fieldOpenmrsEntityParent = jsonObject.optString(OPENMRS_ENTITY_PARENT);\n+                    String fieldKey = jsonObject.optString(KEY);\n+                    boolean shouldBeCombined = jsonObject.optBoolean(AllConstants.COMBINE_CHECKBOX_OPTION_VALUES);\n+                    String entity = getString(jsonObject, OPENMRS_ENTITY);\n                     for (int i = 0; i < options.length(); i++) {\n                         JSONObject option = options.getJSONObject(i);\n                         boolean optionValue = option.optBoolean(VALUE);\n                         if (!optionValue) {\n                             continue;\n                         }\n-                        if (CONCEPT.equals(getString(jsonObject, OPENMRS_ENTITY))) {\n+                        if (CONCEPT.equals(entity)) {\n                             // For options with concepts create an observation for each\n                             option.put(AllConstants.TYPE, type);\n-                            option.put(AllConstants.PARENT_ENTITY_ID, jsonObject.getString(OPENMRS_ENTITY_ID));\n+                            option.put(AllConstants.PARENT_ENTITY_ID, fieldsOpenmrsEntityId);\n                             option.put(KEY, jsonObject.getString(KEY));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fba12a5fbcb4f5f65e1534e26d1880303deb562"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NzIzNjk1", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#pullrequestreview-486723695", "createdAt": "2020-09-11T11:27:11Z", "commit": {"oid": "4fba12a5fbcb4f5f65e1534e26d1880303deb562"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMToyNzoxMVrOHQbEBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMToyNzoxMVrOHQbEBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk4MjY2MA==", "bodyText": "Should this be part of an else block?\nDo we need to do this if someone explicitly specifies that they should be combined?", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486982660", "createdAt": "2020-09-11T11:27:11Z", "author": {"login": "vincent-karuri"}, "path": "opensrp-app/src/main/java/org/smartregister/util/JsonFormUtils.java", "diffHunk": "@@ -407,26 +409,42 @@ private static JSONObject getCheckBoxJsonObjects(Event event, JSONObject parentO\n \n     public static void addObservation(Event e, JSONObject jsonObject) {\n         String value = getString(jsonObject, VALUE);\n-        if (StringUtils.isBlank(value)) { return; }\n+        if (StringUtils.isBlank(value)) {\n+            return;\n+        }\n \n         String type = getString(jsonObject, AllConstants.TYPE);\n         if (AllConstants.CHECK_BOX.equals(type)) {\n             try {\n                 List<Object> optionValues = new ArrayList<>();\n+                List<Object> optionEntityIds = new ArrayList<>();\n                 Map<String, Object> optionKeyVals = new HashMap<>();\n                 if (jsonObject.has(AllConstants.OPTIONS)) {\n                     JSONArray options = jsonObject.getJSONArray(AllConstants.OPTIONS);\n+                    String fieldsOpenmrsEntityId = jsonObject.optString(OPENMRS_ENTITY_ID);\n+                    String fieldOpenmrsEntityParent = jsonObject.optString(OPENMRS_ENTITY_PARENT);\n+                    String fieldKey = jsonObject.optString(KEY);\n+                    boolean shouldBeCombined = jsonObject.optBoolean(AllConstants.COMBINE_CHECKBOX_OPTION_VALUES);\n+                    String entity = getString(jsonObject, OPENMRS_ENTITY);\n                     for (int i = 0; i < options.length(); i++) {\n                         JSONObject option = options.getJSONObject(i);\n                         boolean optionValue = option.optBoolean(VALUE);\n                         if (!optionValue) {\n                             continue;\n                         }\n-                        if (CONCEPT.equals(getString(jsonObject, OPENMRS_ENTITY))) {\n+                        if (CONCEPT.equals(entity)) {\n                             // For options with concepts create an observation for each\n                             option.put(AllConstants.TYPE, type);\n-                            option.put(AllConstants.PARENT_ENTITY_ID, jsonObject.getString(OPENMRS_ENTITY_ID));\n+                            option.put(AllConstants.PARENT_ENTITY_ID, fieldsOpenmrsEntityId);\n                             option.put(KEY, jsonObject.getString(KEY));\n+\n+                            if (shouldBeCombined) {\n+                                String optionKey = option.optString(KEY);\n+                                String optionsOpenmrsEntityId = option.optString(OPENMRS_ENTITY_ID);\n+                                optionValues.add(optionKey);\n+                                optionEntityIds.add(optionsOpenmrsEntityId);\n+                                continue;\n+                            }\n                             createObservation(e, option, String.valueOf(option.getBoolean(VALUE)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fba12a5fbcb4f5f65e1534e26d1880303deb562"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43b318c9276c789c242cd208bcc933c02fec9233", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/43b318c9276c789c242cd208bcc933c02fec9233", "committedDate": "2020-09-11T12:35:12Z", "message": "code cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Nzc0ODQy", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#pullrequestreview-486774842", "createdAt": "2020-09-11T12:48:54Z", "commit": {"oid": "43b318c9276c789c242cd208bcc933c02fec9233"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2488, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}