{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMzI0NjM1", "number": 484, "title": "Enable multiple logins across teams by resetting the app", "bodyText": "Add ability to clear preferences, db & PrivateKeyEntries\n\nFixes #483", "createdAt": "2020-04-09T09:52:16Z", "url": "https://github.com/opensrp/opensrp-client-core/pull/484", "merged": true, "mergeCommit": {"oid": "5059bce240256fb49b4faddab0e790bb84161cc1"}, "closed": true, "closedAt": "2020-04-29T12:47:50Z", "author": {"login": "ekigamba"}, "timelineItems": {"totalCount": 47, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV5ZtrAH2gAyNDAxMzI0NjM1OjM1MzM1MjVmNjNlMjI4OWVmNzQ1ZDRlM2EzNTBhZDU3MzhiMmU1NmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccXs1cgH2gAyNDAxMzI0NjM1OmUyMWI2OWQ5ZjQ4YjIwZWJhZjJjYjI4MjBmNGU0YWIzY2Y3Njc3ZDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3533525f63e2289ef745d4e3a350ad5738b2e56e", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/3533525f63e2289ef745d4e3a350ad5738b2e56e", "committedDate": "2020-04-09T09:51:10Z", "message": "Add ability to clear preferences, db & PrivateKeyEntries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b476cd1d48b340164b339c48ae342e087775c9a", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/8b476cd1d48b340164b339c48ae342e087775c9a", "committedDate": "2020-04-09T13:54:29Z", "message": "Enable checking if there are any unsynced events\n\n- Provide boolean returns for delete operations\n- Deprecate the logout() method in the SecureFragment since it's unsecure and we are providing a better method\n- Add a method that returns the no of unsynced events\n- Change the ResetAppUtil class to take in the application for which to clear data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3975dba78dc447195c1b874721e48c930f2406c", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/a3975dba78dc447195c1b874721e48c930f2406c", "committedDate": "2020-04-09T14:24:05Z", "message": "Enable broadcasting sync upload progress"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b54c3e902a3de0660881da45573eb9db1d42b98d", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/b54c3e902a3de0660881da45573eb9db1d42b98d", "committedDate": "2020-04-09T14:18:10Z", "message": "Enable broadcasting sync upload progress"}, "afterCommit": {"oid": "a3975dba78dc447195c1b874721e48c930f2406c", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/a3975dba78dc447195c1b874721e48c930f2406c", "committedDate": "2020-04-09T14:24:05Z", "message": "Enable broadcasting sync upload progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bae335fb479ba989fbc6181ce2f85e819cb4b8e0", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/bae335fb479ba989fbc6181ce2f85e819cb4b8e0", "committedDate": "2020-04-09T15:23:46Z", "message": "Add configurable Pre-reset app checks & operations\n\n- Move default event-client sync check for PreResetAppCheck class configuration\n- Add CoreLibrary executors to handle default behaviour running on threads\n- Add FetchStatus.fetchProgress enum\n- Add logic to start reset-app process from a UI call\n- Extend SyncService to be used for same-thread operations without pull from the server\n- Add Contract to be used by the reset-app feature UI that handles progress, confirmation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46e9e8a99f2f7351c2e902f12809f3ed5d98ad34", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/46e9e8a99f2f7351c2e902f12809f3ed5d98ad34", "committedDate": "2020-04-14T15:02:58Z", "message": "Clear p2p tracking db during reset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "495f1ef0d74439bde84dc723101abf60a2849c1e", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/495f1ef0d74439bde84dc723101abf60a2849c1e", "committedDate": "2020-04-14T16:26:39Z", "message": "Add tests for ResetAppUtil"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "719a6a797ad9e05dc21d41406041c9c6fcba38a7", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/719a6a797ad9e05dc21d41406041c9c6fcba38a7", "committedDate": "2020-04-15T06:21:55Z", "message": "Merge branch 'master' into issue/483-enable-multiple-logins"}, "afterCommit": {"oid": "495f1ef0d74439bde84dc723101abf60a2849c1e", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/495f1ef0d74439bde84dc723101abf60a2849c1e", "committedDate": "2020-04-14T16:26:39Z", "message": "Add tests for ResetAppUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a274ca97ad6d45231b56924b1e5b226877896da6", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/a274ca97ad6d45231b56924b1e5b226877896da6", "committedDate": "2020-04-16T08:23:13Z", "message": "Fix event-client sync not working before reset-app\n\n- Move to login page once done logging out completely\n- Cancel all jobs when resetting the app\n- Fix event-client synced records check query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eb96eedcdd83199e0c5fbb4d09959d64eabba2e", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/3eb96eedcdd83199e0c5fbb4d09959d64eabba2e", "committedDate": "2020-04-16T11:59:52Z", "message": "Delete p2p wal & shm file after deleting database"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c8c0f5eb7dd44f1bd5383632cd7a87ab89c061f", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/3c8c0f5eb7dd44f1bd5383632cd7a87ab89c061f", "committedDate": "2020-04-16T14:52:34Z", "message": "Fix event-client sync starting but crashes from NPE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a268b4cb4d36d75f8405b91d545f858030a1bd04", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/a268b4cb4d36d75f8405b91d545f858030a1bd04", "committedDate": "2020-04-16T14:55:22Z", "message": "Add Reset app progress dialog\n\n- Enable clicking on cancel to cancel the quit process"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "452b9b8ebea9397f40c8be46cca42a40f03c7a9d", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/452b9b8ebea9397f40c8be46cca42a40f03c7a9d", "committedDate": "2020-04-16T14:58:39Z", "message": "Dismiss progress dialog when reset-app process is cancelled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b62c82d20a7a5d66b6f6634b8f0055569458b79f", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/b62c82d20a7a5d66b6f6634b8f0055569458b79f", "committedDate": "2020-04-16T15:37:55Z", "message": "Add check for unsynced structures\n\n- Rename the PreResetSync to EventClientSync\n- Unsubscribe from broadcast receiver after the event-client sync is complete\n- Add repository method to count created structures not synced\n- Enable syncing of structures in case they have not all been synced to the server"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40db98ac1c12a265d3b5029e4f625f70ca0059d4", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/40db98ac1c12a265d3b5029e4f625f70ca0059d4", "committedDate": "2020-04-16T15:41:26Z", "message": "Add inherited WorkerThread annotations & cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5af3f1e8fae4715a3050e0a956d1bbee376fe663", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/5af3f1e8fae4715a3050e0a956d1bbee376fe663", "committedDate": "2020-04-16T15:59:04Z", "message": "Add check for unsynced tasks\n\n- Add repository method to check for unsynced tasks\n- Add task sync to default pre-reset app checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "616aea9a5701cd517dc2ba7c636c1ff1f0a7098c", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/616aea9a5701cd517dc2ba7c636c1ff1f0a7098c", "committedDate": "2020-04-16T16:05:05Z", "message": "Extend created tasks check to check for unsynced task statuses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57aa13b6da8d1436877f356134287de290604b9c", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/57aa13b6da8d1436877f356134287de290604b9c", "committedDate": "2020-04-17T06:55:26Z", "message": "Add check for unsynced settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba9b1d8c8ef4bdf66776b7977dc190daada90206", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/ba9b1d8c8ef4bdf66776b7977dc190daada90206", "committedDate": "2020-04-17T13:38:10Z", "message": "Remove activity test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05dd6ea1fd8c9b6e015f2ddbc10d6adbcd00f268", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/05dd6ea1fd8c9b6e015f2ddbc10d6adbcd00f268", "committedDate": "2020-04-21T14:36:27Z", "message": "Merge branch 'master' into issue/483-enable-multiple-logins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74dc59c2ede4d238748b094cdcc82e29cc9d04a7", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/74dc59c2ede4d238748b094cdcc82e29cc9d04a7", "committedDate": "2020-04-21T15:31:51Z", "message": "Enable killing of services while syncing\n\n- Code cleanup\n- Remove imports\n- Move strings to strings.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e4c36408c79f6e5ad064c781297ba0f1ba444be", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/5e4c36408c79f6e5ad064c781297ba0f1ba444be", "committedDate": "2020-04-22T10:01:48Z", "message": "Refactor file locations for multi-tenant features\n\n1. Add tests for the reset-app feature\n2. Code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "884ad629f491e256b71c48f9186f77838494a094", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/884ad629f491e256b71c48f9186f77838494a094", "committedDate": "2020-04-22T10:36:37Z", "message": "Merge branch 'master' into issue/483-enable-multiple-logins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a7a3dd7c872902a7ae11ba3dc118b3105310de3", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/0a7a3dd7c872902a7ae11ba3dc118b3105310de3", "committedDate": "2020-04-22T12:19:12Z", "message": "Log the user deletion in crashlytics\n\n- This will be updated later with a better strategy using Firebase Analytics Events OR what-was Fabric Answers\n- Updated version to 1.10.3-SNAPSHOT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwODA0Nzk4", "url": "https://github.com/opensrp/opensrp-client-core/pull/484#pullrequestreview-400804798", "createdAt": "2020-04-27T10:02:31Z", "commit": {"oid": "0a7a3dd7c872902a7ae11ba3dc118b3105310de3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMDowMjozMVrOGMbD9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMDowMjozMVrOGMbD9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY3OTQ3OA==", "bodyText": "There is already existing class org.smartregister.util.AppExecutors", "url": "https://github.com/opensrp/opensrp-client-core/pull/484#discussion_r415679478", "createdAt": "2020-04-27T10:02:31Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/executor/CoreLibraryExecutors.java", "diffHunk": "@@ -0,0 +1,77 @@\n+package org.smartregister.executor;\n+\n+import android.os.Handler;\n+import android.os.Looper;\n+import android.support.annotation.NonNull;\n+\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * <p>\n+ * Global executor pools for plug-and-play CoreLibrary operations.\n+ * <p>\n+ * Grouping tasks like this avoids the effects of task starvation (e.g. disk reads don't wait behind\n+ * webservice requests).\n+ *\n+ * Created by Ephraim Kigamba - nek.eam@gmail.com on 09-04-2020.\n+ */\n+public class CoreLibraryExecutors {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a7a3dd7c872902a7ae11ba3dc118b3105310de3"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwODA2ODg2", "url": "https://github.com/opensrp/opensrp-client-core/pull/484#pullrequestreview-400806886", "createdAt": "2020-04-27T10:05:27Z", "commit": {"oid": "0a7a3dd7c872902a7ae11ba3dc118b3105310de3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMDowNToyN1rOGMbLkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMDowNToyN1rOGMbLkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY4MTQyNg==", "bodyText": "Maybe this should be warning, if the intention is to send to crashlytics", "url": "https://github.com/opensrp/opensrp-client-core/pull/484#discussion_r415681426", "createdAt": "2020-04-27T10:05:27Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/multitenant/ResetAppHelper.java", "diffHunk": "@@ -0,0 +1,232 @@\n+package org.smartregister.multitenant;\n+\n+import android.content.SharedPreferences;\n+import android.support.annotation.AnyThread;\n+import android.support.annotation.NonNull;\n+import android.support.annotation.Nullable;\n+import android.support.v7.app.AppCompatActivity;\n+import android.widget.Toast;\n+\n+import com.evernote.android.job.JobManager;\n+\n+import org.smartregister.CoreLibrary;\n+import org.smartregister.P2POptions;\n+import org.smartregister.R;\n+import org.smartregister.exception.AppResetException;\n+import org.smartregister.multitenant.check.EventClientSyncedCheck;\n+import org.smartregister.multitenant.check.PreResetAppCheck;\n+import org.smartregister.multitenant.check.SettingsSyncedCheck;\n+import org.smartregister.multitenant.check.StructureSyncedCheck;\n+import org.smartregister.multitenant.check.TaskSyncedCheck;\n+import org.smartregister.exception.PreResetAppOperationException;\n+import org.smartregister.executor.CoreLibraryExecutors;\n+import org.smartregister.view.dialog.ResetAppDialog;\n+import org.smartregister.p2p.P2PLibrary;\n+import org.smartregister.p2p.model.AppDatabase;\n+import org.smartregister.util.NetworkUtils;\n+import org.smartregister.util.Utils;\n+import org.smartregister.view.activity.DrishtiApplication;\n+\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.util.ArrayList;\n+import java.util.Enumeration;\n+\n+import timber.log.Timber;\n+\n+/**\n+ * Created by Ephraim Kigamba - nek.eam@gmail.com on 09-04-2020.\n+ */\n+public class ResetAppHelper {\n+\n+    private DrishtiApplication application;\n+    private CoreLibraryExecutors coreLibraryExecutors;\n+    private ArrayList<PreResetAppCheck> preResetAppChecks = new ArrayList<>();\n+    private ResetAppDialog resetAppDialog;\n+    private boolean resetCancelled = false;\n+\n+    public ResetAppHelper(@NonNull DrishtiApplication drishtiApplication) {\n+        this.application = drishtiApplication;\n+        coreLibraryExecutors = new CoreLibraryExecutors();\n+        preResetAppChecks.add(new EventClientSyncedCheck());\n+        preResetAppChecks.add(new SettingsSyncedCheck());\n+        preResetAppChecks.add(new StructureSyncedCheck());\n+        preResetAppChecks.add(new TaskSyncedCheck());\n+    }\n+\n+    public void startResetProcess(@NonNull AppCompatActivity activity) {\n+        resetCancelled = false;\n+        // Show some UI here to display the reset progress\n+        resetAppDialog = ResetAppDialog.newInstance();\n+        resetAppDialog.show(activity.getSupportFragmentManager(), \"rest-app-dialog\");\n+        resetAppDialog.setOnCancelListener((dialogInterface) -> {\n+            showProgressText(activity.getString(R.string.cancelling));\n+            resetCancelled = true;\n+        });\n+\n+        resetAppDialog.showText(activity.getString(R.string.stopping_services));\n+        JobManager.create(application).cancelAll();\n+\n+        resetAppDialog.showText(activity.getString(R.string.performing_data_checks));\n+\n+        if (!resetCancelled) {\n+            performPreResetChecks();\n+        }\n+    }\n+\n+    public void performPreResetChecks() {\n+        // Should be handled in the background\n+        coreLibraryExecutors.diskIO()\n+                .execute(() -> {\n+                    try {\n+                        for (PreResetAppCheck preResetAppCheck : preResetAppChecks) {\n+                            if (!preResetAppCheck.isCheckOk(application)) {\n+                                if (resetCancelled) {\n+                                    dismissDialog();\n+                                    return;\n+                                }\n+\n+                                if (!NetworkUtils.isNetworkAvailable()) {\n+                                    dismissDialog();\n+                                    coreLibraryExecutors.mainThread().execute(new Runnable() {\n+                                        @Override\n+                                        public void run() {\n+                                            Toast.makeText(application, \"No Internet Connection Available\", Toast.LENGTH_LONG)\n+                                                    .show();\n+                                        }\n+                                    });\n+\n+                                    resetCancelled = true;\n+                                    return;\n+                                }\n+\n+                                performPreResetOperations(preResetAppCheck);\n+                            }\n+                        }\n+\n+                        if (resetCancelled) {\n+                            dismissDialog();\n+                            return;\n+                        }\n+\n+                        showProgressText(application.getString(R.string.clearing_application_data));\n+\n+                        if (resetCancelled) {\n+                            dismissDialog();\n+                            return;\n+                        }\n+\n+                        Timber.e(\"User %s has completely reset the app\", application.getUsername());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a7a3dd7c872902a7ae11ba3dc118b3105310de3"}, "originalPosition": 119}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwOTc2ODE2", "url": "https://github.com/opensrp/opensrp-client-core/pull/484#pullrequestreview-400976816", "createdAt": "2020-04-27T13:56:34Z", "commit": {"oid": "0a7a3dd7c872902a7ae11ba3dc118b3105310de3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzo1NjozNFrOGMkh1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzo1NjozNFrOGMkh1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNDU4MQ==", "bodyText": "Maybe this can be a function for deleting journal, shm and wal", "url": "https://github.com/opensrp/opensrp-client-core/pull/484#discussion_r415834581", "createdAt": "2020-04-27T13:56:34Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/util/Utils.java", "diffHunk": "@@ -793,4 +793,56 @@ public static void copyDatabase(String dbName, String copyDbName, Context contex\n     public static Locale getDefaultLocale() {\n         return Locale.getDefault().toString().startsWith(\"ar\") ? Locale.ENGLISH : Locale.getDefault();\n     }\n+\n+    public static boolean deleteRoomDb(@NonNull Context context, @NonNull String databaseName) {\n+        File databases = new File(context.getApplicationInfo().dataDir + \"/databases\");\n+        File db = new File(databases, databaseName);\n+        if (!db.exists()) {\n+            Timber.i(\"Room database %s does not exist\", databaseName);\n+            return false;\n+        }\n+\n+        if (db.delete()) {\n+            Timber.i(\"Room database %s deleted\", databaseName);\n+        } else {\n+            Timber.i(\"Failed to delete database %s\", databaseName);\n+            return false;\n+        }\n+\n+        // Delete the journal file\n+        File journal = new File(databases, databaseName + \"-journal\");\n+        if (journal.exists()) {\n+            if (journal.delete()) {\n+                Timber.i(\"Database %s journal deleted\", databaseName);\n+            } else {\n+                Timber.e(\"Failed to delete database %s journal\", databaseName);\n+                return false;\n+            }\n+        }\n+\n+        // Delete the journal shm file\n+        File shmFile = new File(databases, databaseName + \"-shm\");\n+        if (shmFile.exists()) {\n+            if (shmFile.delete()) {\n+                Timber.i(\"Database %s-shm deleted\", databaseName);\n+            } else {\n+                Timber.e(\"Failed to delete database %s-shm\", databaseName);\n+                return false;\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a7a3dd7c872902a7ae11ba3dc118b3105310de3"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwOTc3OTEz", "url": "https://github.com/opensrp/opensrp-client-core/pull/484#pullrequestreview-400977913", "createdAt": "2020-04-27T13:57:43Z", "commit": {"oid": "0a7a3dd7c872902a7ae11ba3dc118b3105310de3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzo1Nzo0M1rOGMklIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzo1Nzo0M1rOGMklIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNTQyNA==", "bodyText": "This would leave the shm and wal which can lead to inconsistencies", "url": "https://github.com/opensrp/opensrp-client-core/pull/484#discussion_r415835424", "createdAt": "2020-04-27T13:57:43Z", "author": {"login": "githengi"}, "path": "opensrp-app/src/main/java/org/smartregister/util/Utils.java", "diffHunk": "@@ -793,4 +793,56 @@ public static void copyDatabase(String dbName, String copyDbName, Context contex\n     public static Locale getDefaultLocale() {\n         return Locale.getDefault().toString().startsWith(\"ar\") ? Locale.ENGLISH : Locale.getDefault();\n     }\n+\n+    public static boolean deleteRoomDb(@NonNull Context context, @NonNull String databaseName) {\n+        File databases = new File(context.getApplicationInfo().dataDir + \"/databases\");\n+        File db = new File(databases, databaseName);\n+        if (!db.exists()) {\n+            Timber.i(\"Room database %s does not exist\", databaseName);\n+            return false;\n+        }\n+\n+        if (db.delete()) {\n+            Timber.i(\"Room database %s deleted\", databaseName);\n+        } else {\n+            Timber.i(\"Failed to delete database %s\", databaseName);\n+            return false;\n+        }\n+\n+        // Delete the journal file\n+        File journal = new File(databases, databaseName + \"-journal\");\n+        if (journal.exists()) {\n+            if (journal.delete()) {\n+                Timber.i(\"Database %s journal deleted\", databaseName);\n+            } else {\n+                Timber.e(\"Failed to delete database %s journal\", databaseName);\n+                return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a7a3dd7c872902a7ae11ba3dc118b3105310de3"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d128c19b28b6693bf310ebe1dc1a1f89232ba91", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/3d128c19b28b6693bf310ebe1dc1a1f89232ba91", "committedDate": "2020-04-28T12:40:15Z", "message": "Refactor code as-per code review\n\n- Move functionality to delete db journal, wal & shm file to methods\n- Use AppExecutor functionality\n- Delete other DB files irrespective of the previous db file result"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a7a3dd7c872902a7ae11ba3dc118b3105310de3", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/0a7a3dd7c872902a7ae11ba3dc118b3105310de3", "committedDate": "2020-04-22T12:19:12Z", "message": "Log the user deletion in crashlytics\n\n- This will be updated later with a better strategy using Firebase Analytics Events OR what-was Fabric Answers\n- Updated version to 1.10.3-SNAPSHOT"}, "afterCommit": {"oid": "563fe01bb3c66a433cca4b9f2df07c0a6448fa30", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/563fe01bb3c66a433cca4b9f2df07c0a6448fa30", "committedDate": "2020-04-28T12:43:00Z", "message": "Refactor code as-per code review\n\n- Move functionality to delete db journal, wal & shm file to methods\n- Use AppExecutor functionality\n- Delete other DB files irrespective of the previous db file result"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "563fe01bb3c66a433cca4b9f2df07c0a6448fa30", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/563fe01bb3c66a433cca4b9f2df07c0a6448fa30", "committedDate": "2020-04-28T12:43:00Z", "message": "Refactor code as-per code review\n\n- Move functionality to delete db journal, wal & shm file to methods\n- Use AppExecutor functionality\n- Delete other DB files irrespective of the previous db file result"}, "afterCommit": {"oid": "3d128c19b28b6693bf310ebe1dc1a1f89232ba91", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/3d128c19b28b6693bf310ebe1dc1a1f89232ba91", "committedDate": "2020-04-28T12:40:15Z", "message": "Refactor code as-per code review\n\n- Move functionality to delete db journal, wal & shm file to methods\n- Use AppExecutor functionality\n- Delete other DB files irrespective of the previous db file result"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1525f322d14a5e9f702fd993e4e19a548a095919", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/1525f322d14a5e9f702fd993e4e19a548a095919", "committedDate": "2020-04-28T12:57:32Z", "message": "Code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b23717f4d87cdd8991d9e971a3f327bbce078c5", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/8b23717f4d87cdd8991d9e971a3f327bbce078c5", "committedDate": "2020-04-28T14:31:35Z", "message": "Plugin clear-app data to current logout functionality\n\n- This functionality will be enabled when the SyncConfiguration#shouldClearDataOnLogout() returns true"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe009558a74a90ca0f21b79270b38ee56782aa8d", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/fe009558a74a90ca0f21b79270b38ee56782aa8d", "committedDate": "2020-04-28T13:08:12Z", "message": "Merge branch 'master' into issue/483-enable-multiple-logins"}, "afterCommit": {"oid": "8b23717f4d87cdd8991d9e971a3f327bbce078c5", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/8b23717f4d87cdd8991d9e971a3f327bbce078c5", "committedDate": "2020-04-28T14:31:35Z", "message": "Plugin clear-app data to current logout functionality\n\n- This functionality will be enabled when the SyncConfiguration#shouldClearDataOnLogout() returns true"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2b93483258bf172efa4ee6560ba4cd3b47911fb", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/b2b93483258bf172efa4ee6560ba4cd3b47911fb", "committedDate": "2020-04-28T15:04:09Z", "message": "Fix failing tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f63ade3a419c9ad654063843212c7737aed9501b", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/f63ade3a419c9ad654063843212c7737aed9501b", "committedDate": "2020-04-28T14:59:47Z", "message": "Fix failing tests"}, "afterCommit": {"oid": "b2b93483258bf172efa4ee6560ba4cd3b47911fb", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/b2b93483258bf172efa4ee6560ba4cd3b47911fb", "committedDate": "2020-04-28T15:04:09Z", "message": "Fix failing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f77497209e137723e53a9770791ee02b83740cef", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/f77497209e137723e53a9770791ee02b83740cef", "committedDate": "2020-04-28T15:50:34Z", "message": "Merge branch 'master' into issue/483-enable-multiple-logins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ea1237a6906a69d4560424458a6b82af10d53b4", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/7ea1237a6906a69d4560424458a6b82af10d53b4", "committedDate": "2020-04-29T09:01:47Z", "message": "Move clear data feature to login with different team/location\n\n- If the user is not within the same group ID & the reset-app data configuration is true, the app will show a dialog asking the user if the are sure they want to clear data. It will then perform the process and try to relogin with the same username/password"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17db37f6efe18359e0c2e0fa372a7e4bda5da861", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/17db37f6efe18359e0c2e0fa372a7e4bda5da861", "committedDate": "2020-04-29T09:01:47Z", "message": "Remove sdk min & target in core-library AndroidManifest.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d922fde500158e9512623a8775b736791b8def0", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/9d922fde500158e9512623a8775b736791b8def0", "committedDate": "2020-04-29T09:01:47Z", "message": "Update ResetAppHelper tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d92a5a49322efde2f7d5cd016f203ab46e3eea2d", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/d92a5a49322efde2f7d5cd016f203ab46e3eea2d", "committedDate": "2020-04-29T09:06:13Z", "message": "Move clear data dialog strings to strings.xml"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNTIwNTA5", "url": "https://github.com/opensrp/opensrp-client-core/pull/484#pullrequestreview-402520509", "createdAt": "2020-04-29T09:55:29Z", "commit": {"oid": "d92a5a49322efde2f7d5cd016f203ab46e3eea2d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwOTo1NToyOVrOGN3ufA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwOTo1NToyOVrOGN3ufA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE5NzY5Mg==", "bodyText": "Use passive tense for this message also mention the actual team/username that would be cleared", "url": "https://github.com/opensrp/opensrp-client-core/pull/484#discussion_r417197692", "createdAt": "2020-04-29T09:55:29Z", "author": {"login": "githengi"}, "path": "opensrp-app/res/values/strings.xml", "diffHunk": "@@ -414,5 +414,13 @@\n     <string name=\"sync_failed_timeout_error\">Sync Failed. Could not connect to the server.</string>\n \n     <string name=\"outdated_app\">This is an outdated app. Please update to the latest version to continue.</string>\n+    <string name=\"sync_upload_progress_float\">Sync upload progress %d%%</string>\n+    <string name=\"cancelling\">Cancelling...</string>\n+    <string name=\"stopping_services\">Stopping services..</string>\n+    <string name=\"performing_data_checks\">Performing data checks...</string>\n+    <string name=\"app_reset_status\">App Reset Status</string>\n+    <string name=\"clearing_application_data\">Clearing application data...</string>\n+    <string name=\"clear_data_dialog_title\">Do you want to clear data to login with a different team/location</string>\n+    <string name=\"clear_data_dialog_message\">You are trying to login with a user in a different team/location. This will require as to upload any pending data and clear the data for the current user. Do you want to continue?</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d92a5a49322efde2f7d5cd016f203ab46e3eea2d"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNTM2NjI1", "url": "https://github.com/opensrp/opensrp-client-core/pull/484#pullrequestreview-402536625", "createdAt": "2020-04-29T10:19:54Z", "commit": {"oid": "d92a5a49322efde2f7d5cd016f203ab46e3eea2d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "feb2dbcdc6dc20cdd5b3d5db9358193d87242dfc", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/feb2dbcdc6dc20cdd5b3d5db9358193d87242dfc", "committedDate": "2020-04-29T11:31:32Z", "message": "Change user message during logout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcfa14a2b0e2fb50b8d2b83396fb0191a5fd340e", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/fcfa14a2b0e2fb50b8d2b83396fb0191a5fd340e", "committedDate": "2020-04-29T11:12:01Z", "message": "Change user message during logout"}, "afterCommit": {"oid": "feb2dbcdc6dc20cdd5b3d5db9358193d87242dfc", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/feb2dbcdc6dc20cdd5b3d5db9358193d87242dfc", "committedDate": "2020-04-29T11:31:32Z", "message": "Change user message during logout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNjE2NTY3", "url": "https://github.com/opensrp/opensrp-client-core/pull/484#pullrequestreview-402616567", "createdAt": "2020-04-29T12:27:42Z", "commit": {"oid": "feb2dbcdc6dc20cdd5b3d5db9358193d87242dfc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e21b69d9f48b20ebaf2cb2820f4e4ab3cf7677d7", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/e21b69d9f48b20ebaf2cb2820f4e4ab3cf7677d7", "committedDate": "2020-04-29T12:32:45Z", "message": "Retrigger codacy"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2544, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}