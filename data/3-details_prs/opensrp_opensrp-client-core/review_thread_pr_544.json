{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NTE2NjYy", "number": 544, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwODoyOTowMFrOECDc0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwODo0MjowOFrOECDvAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNTg5MTM4OnYy", "diffSide": "RIGHT", "path": "opensrp-app/src/test/java/org/smartregister/service/HTTPAgentTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwODoyOTowMFrOGeRgFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOToxODo1MVrOGeTWZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM5NzIwNA==", "bodyText": "I think this should get getErrorStream\nI also think that the loginresponse for an internal error is a custom message & not the message checked in this test. Kindly fix and confirm if the assumptions here are correct", "url": "https://github.com/opensrp/opensrp-client-core/pull/544#discussion_r434397204", "createdAt": "2020-06-03T08:29:00Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/test/java/org/smartregister/service/HTTPAgentTest.java", "diffHunk": "@@ -560,4 +566,342 @@ public void testOauth2authenticateRefreshTokenInvokesOauth2authenticateCoreWithC\n \n \n     }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponse() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doReturn(inputStream).when(httpsURLConnection).getInputStream();\n+        Mockito.doReturn(HttpURLConnection.HTTP_OK).when(httpsURLConnection).getResponseCode();\n+\n+        PowerMockito.mockStatic(IOUtils.class);\n+        PowerMockito.when(IOUtils.toString(inputStream)).thenReturn(LoginResponseTestData.USER_DETAILS_REQUEST_SERVER_RESPONSE);\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Login successful.\", loginResponse.message());\n+        Assert.assertNotNull(loginResponse.payload());\n+\n+        Assert.assertNotNull(loginResponse.payload().user);\n+        Assert.assertEquals(\"demo\", loginResponse.payload().user.getUsername());\n+        Assert.assertEquals(\"Demo User\", loginResponse.payload().user.getPreferredName());\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().user.getBaseEntityId());\n+\n+        Assert.assertNotNull(loginResponse.payload().time);\n+        Assert.assertEquals(\"2020-06-02 08:21:40\", loginResponse.payload().time.getTime());\n+        Assert.assertEquals(\"Africa/Nairobi\", loginResponse.payload().time.getTimeZone());\n+\n+        Assert.assertNotNull(loginResponse.payload().locations);\n+        Assert.assertNotNull(loginResponse.payload().locations.getLocationsHierarchy());\n+\n+        Assert.assertNotNull(loginResponse.payload().jurisdictions);\n+        Assert.assertEquals(1, loginResponse.payload().jurisdictions.size());\n+        Assert.assertNotNull(\"Health Team Kasarani\", loginResponse.payload().jurisdictions.get(0));\n+\n+        Assert.assertNotNull(loginResponse.payload().team);\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().team.identifier);\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().team.uuid);\n+\n+        Assert.assertEquals(\"SUCCESS\", loginResponse.name());\n+\n+        ArgumentCaptor<String> headerKey = ArgumentCaptor.forClass(String.class);\n+        ArgumentCaptor<String> headerValue = ArgumentCaptor.forClass(String.class);\n+\n+        Mockito.verify(httpsURLConnection).setRequestProperty(headerKey.capture(), headerValue.capture());\n+        String capturedKey = headerKey.getValue();\n+        String capturedValue = headerValue.getValue();\n+\n+        Assert.assertEquals(capturedKey, AllConstants.HTTP_REQUEST_HEADERS.AUTHORIZATION);\n+        Assert.assertEquals(capturedValue, AllConstants.HTTP_REQUEST_AUTH_TOKEN_TYPE.BEARER + \" \" + SAMPLE_TEST_TOKEN);\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForUnauthorizedRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doReturn(HttpURLConnection.HTTP_UNAUTHORIZED).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Please check the credentials\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"UNAUTHORIZED\", loginResponse.name());\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForRandomServerError() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+\n+        Mockito.doReturn(errorStream).when(httpsURLConnection).getInputStream();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdb4315fd910de403f43911fe5d57cba826a5882"}, "originalPosition": 157}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQwNTc3MQ==", "bodyText": "This might be a duplicate with test on line 880", "url": "https://github.com/opensrp/opensrp-client-core/pull/544#discussion_r434405771", "createdAt": "2020-06-03T08:43:20Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/test/java/org/smartregister/service/HTTPAgentTest.java", "diffHunk": "@@ -560,4 +566,342 @@ public void testOauth2authenticateRefreshTokenInvokesOauth2authenticateCoreWithC\n \n \n     }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponse() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doReturn(inputStream).when(httpsURLConnection).getInputStream();\n+        Mockito.doReturn(HttpURLConnection.HTTP_OK).when(httpsURLConnection).getResponseCode();\n+\n+        PowerMockito.mockStatic(IOUtils.class);\n+        PowerMockito.when(IOUtils.toString(inputStream)).thenReturn(LoginResponseTestData.USER_DETAILS_REQUEST_SERVER_RESPONSE);\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Login successful.\", loginResponse.message());\n+        Assert.assertNotNull(loginResponse.payload());\n+\n+        Assert.assertNotNull(loginResponse.payload().user);\n+        Assert.assertEquals(\"demo\", loginResponse.payload().user.getUsername());\n+        Assert.assertEquals(\"Demo User\", loginResponse.payload().user.getPreferredName());\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().user.getBaseEntityId());\n+\n+        Assert.assertNotNull(loginResponse.payload().time);\n+        Assert.assertEquals(\"2020-06-02 08:21:40\", loginResponse.payload().time.getTime());\n+        Assert.assertEquals(\"Africa/Nairobi\", loginResponse.payload().time.getTimeZone());\n+\n+        Assert.assertNotNull(loginResponse.payload().locations);\n+        Assert.assertNotNull(loginResponse.payload().locations.getLocationsHierarchy());\n+\n+        Assert.assertNotNull(loginResponse.payload().jurisdictions);\n+        Assert.assertEquals(1, loginResponse.payload().jurisdictions.size());\n+        Assert.assertNotNull(\"Health Team Kasarani\", loginResponse.payload().jurisdictions.get(0));\n+\n+        Assert.assertNotNull(loginResponse.payload().team);\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().team.identifier);\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().team.uuid);\n+\n+        Assert.assertEquals(\"SUCCESS\", loginResponse.name());\n+\n+        ArgumentCaptor<String> headerKey = ArgumentCaptor.forClass(String.class);\n+        ArgumentCaptor<String> headerValue = ArgumentCaptor.forClass(String.class);\n+\n+        Mockito.verify(httpsURLConnection).setRequestProperty(headerKey.capture(), headerValue.capture());\n+        String capturedKey = headerKey.getValue();\n+        String capturedValue = headerValue.getValue();\n+\n+        Assert.assertEquals(capturedKey, AllConstants.HTTP_REQUEST_HEADERS.AUTHORIZATION);\n+        Assert.assertEquals(capturedValue, AllConstants.HTTP_REQUEST_AUTH_TOKEN_TYPE.BEARER + \" \" + SAMPLE_TEST_TOKEN);\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForUnauthorizedRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doReturn(HttpURLConnection.HTTP_UNAUTHORIZED).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Please check the credentials\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"UNAUTHORIZED\", loginResponse.name());\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForRandomServerError() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+\n+        Mockito.doReturn(errorStream).when(httpsURLConnection).getInputStream();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM5NzIwNA=="}, "originalCommit": {"oid": "bdb4315fd910de403f43911fe5d57cba826a5882"}, "originalPosition": 157}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQyNzQ5NA==", "bodyText": "Fixed the first one\n880 tests a different method with has a similar response flow", "url": "https://github.com/opensrp/opensrp-client-core/pull/544#discussion_r434427494", "createdAt": "2020-06-03T09:18:51Z", "author": {"login": "ndegwamartin"}, "path": "opensrp-app/src/test/java/org/smartregister/service/HTTPAgentTest.java", "diffHunk": "@@ -560,4 +566,342 @@ public void testOauth2authenticateRefreshTokenInvokesOauth2authenticateCoreWithC\n \n \n     }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponse() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doReturn(inputStream).when(httpsURLConnection).getInputStream();\n+        Mockito.doReturn(HttpURLConnection.HTTP_OK).when(httpsURLConnection).getResponseCode();\n+\n+        PowerMockito.mockStatic(IOUtils.class);\n+        PowerMockito.when(IOUtils.toString(inputStream)).thenReturn(LoginResponseTestData.USER_DETAILS_REQUEST_SERVER_RESPONSE);\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Login successful.\", loginResponse.message());\n+        Assert.assertNotNull(loginResponse.payload());\n+\n+        Assert.assertNotNull(loginResponse.payload().user);\n+        Assert.assertEquals(\"demo\", loginResponse.payload().user.getUsername());\n+        Assert.assertEquals(\"Demo User\", loginResponse.payload().user.getPreferredName());\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().user.getBaseEntityId());\n+\n+        Assert.assertNotNull(loginResponse.payload().time);\n+        Assert.assertEquals(\"2020-06-02 08:21:40\", loginResponse.payload().time.getTime());\n+        Assert.assertEquals(\"Africa/Nairobi\", loginResponse.payload().time.getTimeZone());\n+\n+        Assert.assertNotNull(loginResponse.payload().locations);\n+        Assert.assertNotNull(loginResponse.payload().locations.getLocationsHierarchy());\n+\n+        Assert.assertNotNull(loginResponse.payload().jurisdictions);\n+        Assert.assertEquals(1, loginResponse.payload().jurisdictions.size());\n+        Assert.assertNotNull(\"Health Team Kasarani\", loginResponse.payload().jurisdictions.get(0));\n+\n+        Assert.assertNotNull(loginResponse.payload().team);\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().team.identifier);\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().team.uuid);\n+\n+        Assert.assertEquals(\"SUCCESS\", loginResponse.name());\n+\n+        ArgumentCaptor<String> headerKey = ArgumentCaptor.forClass(String.class);\n+        ArgumentCaptor<String> headerValue = ArgumentCaptor.forClass(String.class);\n+\n+        Mockito.verify(httpsURLConnection).setRequestProperty(headerKey.capture(), headerValue.capture());\n+        String capturedKey = headerKey.getValue();\n+        String capturedValue = headerValue.getValue();\n+\n+        Assert.assertEquals(capturedKey, AllConstants.HTTP_REQUEST_HEADERS.AUTHORIZATION);\n+        Assert.assertEquals(capturedValue, AllConstants.HTTP_REQUEST_AUTH_TOKEN_TYPE.BEARER + \" \" + SAMPLE_TEST_TOKEN);\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForUnauthorizedRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doReturn(HttpURLConnection.HTTP_UNAUTHORIZED).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Please check the credentials\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"UNAUTHORIZED\", loginResponse.name());\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForRandomServerError() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+\n+        Mockito.doReturn(errorStream).when(httpsURLConnection).getInputStream();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM5NzIwNA=="}, "originalCommit": {"oid": "bdb4315fd910de403f43911fe5d57cba826a5882"}, "originalPosition": 157}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNTkyNDk1OnYy", "diffSide": "RIGHT", "path": "opensrp-app/src/test/java/org/smartregister/service/HTTPAgentTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwODozODozNFrOGeR2OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOToxOTo1M1rOGeTYwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQwMjg3Mg==", "bodyText": "Spelling to WithoutNetworkConnectivity", "url": "https://github.com/opensrp/opensrp-client-core/pull/544#discussion_r434402872", "createdAt": "2020-06-03T08:38:34Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/test/java/org/smartregister/service/HTTPAgentTest.java", "diffHunk": "@@ -560,4 +566,342 @@ public void testOauth2authenticateRefreshTokenInvokesOauth2authenticateCoreWithC\n \n \n     }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponse() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doReturn(inputStream).when(httpsURLConnection).getInputStream();\n+        Mockito.doReturn(HttpURLConnection.HTTP_OK).when(httpsURLConnection).getResponseCode();\n+\n+        PowerMockito.mockStatic(IOUtils.class);\n+        PowerMockito.when(IOUtils.toString(inputStream)).thenReturn(LoginResponseTestData.USER_DETAILS_REQUEST_SERVER_RESPONSE);\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Login successful.\", loginResponse.message());\n+        Assert.assertNotNull(loginResponse.payload());\n+\n+        Assert.assertNotNull(loginResponse.payload().user);\n+        Assert.assertEquals(\"demo\", loginResponse.payload().user.getUsername());\n+        Assert.assertEquals(\"Demo User\", loginResponse.payload().user.getPreferredName());\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().user.getBaseEntityId());\n+\n+        Assert.assertNotNull(loginResponse.payload().time);\n+        Assert.assertEquals(\"2020-06-02 08:21:40\", loginResponse.payload().time.getTime());\n+        Assert.assertEquals(\"Africa/Nairobi\", loginResponse.payload().time.getTimeZone());\n+\n+        Assert.assertNotNull(loginResponse.payload().locations);\n+        Assert.assertNotNull(loginResponse.payload().locations.getLocationsHierarchy());\n+\n+        Assert.assertNotNull(loginResponse.payload().jurisdictions);\n+        Assert.assertEquals(1, loginResponse.payload().jurisdictions.size());\n+        Assert.assertNotNull(\"Health Team Kasarani\", loginResponse.payload().jurisdictions.get(0));\n+\n+        Assert.assertNotNull(loginResponse.payload().team);\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().team.identifier);\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().team.uuid);\n+\n+        Assert.assertEquals(\"SUCCESS\", loginResponse.name());\n+\n+        ArgumentCaptor<String> headerKey = ArgumentCaptor.forClass(String.class);\n+        ArgumentCaptor<String> headerValue = ArgumentCaptor.forClass(String.class);\n+\n+        Mockito.verify(httpsURLConnection).setRequestProperty(headerKey.capture(), headerValue.capture());\n+        String capturedKey = headerKey.getValue();\n+        String capturedValue = headerValue.getValue();\n+\n+        Assert.assertEquals(capturedKey, AllConstants.HTTP_REQUEST_HEADERS.AUTHORIZATION);\n+        Assert.assertEquals(capturedValue, AllConstants.HTTP_REQUEST_AUTH_TOKEN_TYPE.BEARER + \" \" + SAMPLE_TEST_TOKEN);\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForUnauthorizedRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doReturn(HttpURLConnection.HTTP_UNAUTHORIZED).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Please check the credentials\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"UNAUTHORIZED\", loginResponse.name());\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForRandomServerError() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+\n+        Mockito.doReturn(errorStream).when(httpsURLConnection).getInputStream();\n+        Mockito.doReturn(HttpURLConnection.HTTP_INTERNAL_ERROR).when(httpsURLConnection).getResponseCode();\n+\n+        PowerMockito.mockStatic(IOUtils.class);\n+        PowerMockito.when(IOUtils.toString(errorStream)).thenReturn(\"<html><p><b>message</b> Oops, something went wrong </u></p></html>\");\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Dristhi login failed. Try later\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"UNKNOWN_RESPONSE\", loginResponse.name());\n+\n+    }\n+\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForMalformedURLRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doThrow(new MalformedURLException()).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Incorrect url\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"MALFORMED_URL\", loginResponse.name());\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForConnectionTimedOutRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doThrow(new SocketTimeoutException()).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"The server could not be reached. Try again\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"TIMEOUT\", loginResponse.name());\n+\n+    }\n+\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForRequestsWithNetworkConnectivity() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdb4315fd910de403f43911fe5d57cba826a5882"}, "originalPosition": 221}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQyODA5OA==", "bodyText": "Fixed", "url": "https://github.com/opensrp/opensrp-client-core/pull/544#discussion_r434428098", "createdAt": "2020-06-03T09:19:53Z", "author": {"login": "ndegwamartin"}, "path": "opensrp-app/src/test/java/org/smartregister/service/HTTPAgentTest.java", "diffHunk": "@@ -560,4 +566,342 @@ public void testOauth2authenticateRefreshTokenInvokesOauth2authenticateCoreWithC\n \n \n     }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponse() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doReturn(inputStream).when(httpsURLConnection).getInputStream();\n+        Mockito.doReturn(HttpURLConnection.HTTP_OK).when(httpsURLConnection).getResponseCode();\n+\n+        PowerMockito.mockStatic(IOUtils.class);\n+        PowerMockito.when(IOUtils.toString(inputStream)).thenReturn(LoginResponseTestData.USER_DETAILS_REQUEST_SERVER_RESPONSE);\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Login successful.\", loginResponse.message());\n+        Assert.assertNotNull(loginResponse.payload());\n+\n+        Assert.assertNotNull(loginResponse.payload().user);\n+        Assert.assertEquals(\"demo\", loginResponse.payload().user.getUsername());\n+        Assert.assertEquals(\"Demo User\", loginResponse.payload().user.getPreferredName());\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().user.getBaseEntityId());\n+\n+        Assert.assertNotNull(loginResponse.payload().time);\n+        Assert.assertEquals(\"2020-06-02 08:21:40\", loginResponse.payload().time.getTime());\n+        Assert.assertEquals(\"Africa/Nairobi\", loginResponse.payload().time.getTimeZone());\n+\n+        Assert.assertNotNull(loginResponse.payload().locations);\n+        Assert.assertNotNull(loginResponse.payload().locations.getLocationsHierarchy());\n+\n+        Assert.assertNotNull(loginResponse.payload().jurisdictions);\n+        Assert.assertEquals(1, loginResponse.payload().jurisdictions.size());\n+        Assert.assertNotNull(\"Health Team Kasarani\", loginResponse.payload().jurisdictions.get(0));\n+\n+        Assert.assertNotNull(loginResponse.payload().team);\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().team.identifier);\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().team.uuid);\n+\n+        Assert.assertEquals(\"SUCCESS\", loginResponse.name());\n+\n+        ArgumentCaptor<String> headerKey = ArgumentCaptor.forClass(String.class);\n+        ArgumentCaptor<String> headerValue = ArgumentCaptor.forClass(String.class);\n+\n+        Mockito.verify(httpsURLConnection).setRequestProperty(headerKey.capture(), headerValue.capture());\n+        String capturedKey = headerKey.getValue();\n+        String capturedValue = headerValue.getValue();\n+\n+        Assert.assertEquals(capturedKey, AllConstants.HTTP_REQUEST_HEADERS.AUTHORIZATION);\n+        Assert.assertEquals(capturedValue, AllConstants.HTTP_REQUEST_AUTH_TOKEN_TYPE.BEARER + \" \" + SAMPLE_TEST_TOKEN);\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForUnauthorizedRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doReturn(HttpURLConnection.HTTP_UNAUTHORIZED).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Please check the credentials\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"UNAUTHORIZED\", loginResponse.name());\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForRandomServerError() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+\n+        Mockito.doReturn(errorStream).when(httpsURLConnection).getInputStream();\n+        Mockito.doReturn(HttpURLConnection.HTTP_INTERNAL_ERROR).when(httpsURLConnection).getResponseCode();\n+\n+        PowerMockito.mockStatic(IOUtils.class);\n+        PowerMockito.when(IOUtils.toString(errorStream)).thenReturn(\"<html><p><b>message</b> Oops, something went wrong </u></p></html>\");\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Dristhi login failed. Try later\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"UNKNOWN_RESPONSE\", loginResponse.name());\n+\n+    }\n+\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForMalformedURLRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doThrow(new MalformedURLException()).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Incorrect url\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"MALFORMED_URL\", loginResponse.name());\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForConnectionTimedOutRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doThrow(new SocketTimeoutException()).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"The server could not be reached. Try again\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"TIMEOUT\", loginResponse.name());\n+\n+    }\n+\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForRequestsWithNetworkConnectivity() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQwMjg3Mg=="}, "originalCommit": {"oid": "bdb4315fd910de403f43911fe5d57cba826a5882"}, "originalPosition": 221}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNTkzNzkzOnYy", "diffSide": "RIGHT", "path": "opensrp-app/src/test/java/org/smartregister/service/HTTPAgentTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwODo0MjowOFrOGeR-rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOToxOTo1OFrOGeTY6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQwNTAzOA==", "bodyText": "I think this test name is incorrect. We have a socket timeout being thrown on line 707 in this file. I am not sure if this test is a duplicate since we also have another test that checks for MalformedURLException", "url": "https://github.com/opensrp/opensrp-client-core/pull/544#discussion_r434405038", "createdAt": "2020-06-03T08:42:08Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/test/java/org/smartregister/service/HTTPAgentTest.java", "diffHunk": "@@ -560,4 +566,342 @@ public void testOauth2authenticateRefreshTokenInvokesOauth2authenticateCoreWithC\n \n \n     }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponse() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doReturn(inputStream).when(httpsURLConnection).getInputStream();\n+        Mockito.doReturn(HttpURLConnection.HTTP_OK).when(httpsURLConnection).getResponseCode();\n+\n+        PowerMockito.mockStatic(IOUtils.class);\n+        PowerMockito.when(IOUtils.toString(inputStream)).thenReturn(LoginResponseTestData.USER_DETAILS_REQUEST_SERVER_RESPONSE);\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Login successful.\", loginResponse.message());\n+        Assert.assertNotNull(loginResponse.payload());\n+\n+        Assert.assertNotNull(loginResponse.payload().user);\n+        Assert.assertEquals(\"demo\", loginResponse.payload().user.getUsername());\n+        Assert.assertEquals(\"Demo User\", loginResponse.payload().user.getPreferredName());\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().user.getBaseEntityId());\n+\n+        Assert.assertNotNull(loginResponse.payload().time);\n+        Assert.assertEquals(\"2020-06-02 08:21:40\", loginResponse.payload().time.getTime());\n+        Assert.assertEquals(\"Africa/Nairobi\", loginResponse.payload().time.getTimeZone());\n+\n+        Assert.assertNotNull(loginResponse.payload().locations);\n+        Assert.assertNotNull(loginResponse.payload().locations.getLocationsHierarchy());\n+\n+        Assert.assertNotNull(loginResponse.payload().jurisdictions);\n+        Assert.assertEquals(1, loginResponse.payload().jurisdictions.size());\n+        Assert.assertNotNull(\"Health Team Kasarani\", loginResponse.payload().jurisdictions.get(0));\n+\n+        Assert.assertNotNull(loginResponse.payload().team);\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().team.identifier);\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().team.uuid);\n+\n+        Assert.assertEquals(\"SUCCESS\", loginResponse.name());\n+\n+        ArgumentCaptor<String> headerKey = ArgumentCaptor.forClass(String.class);\n+        ArgumentCaptor<String> headerValue = ArgumentCaptor.forClass(String.class);\n+\n+        Mockito.verify(httpsURLConnection).setRequestProperty(headerKey.capture(), headerValue.capture());\n+        String capturedKey = headerKey.getValue();\n+        String capturedValue = headerValue.getValue();\n+\n+        Assert.assertEquals(capturedKey, AllConstants.HTTP_REQUEST_HEADERS.AUTHORIZATION);\n+        Assert.assertEquals(capturedValue, AllConstants.HTTP_REQUEST_AUTH_TOKEN_TYPE.BEARER + \" \" + SAMPLE_TEST_TOKEN);\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForUnauthorizedRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doReturn(HttpURLConnection.HTTP_UNAUTHORIZED).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Please check the credentials\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"UNAUTHORIZED\", loginResponse.name());\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForRandomServerError() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+\n+        Mockito.doReturn(errorStream).when(httpsURLConnection).getInputStream();\n+        Mockito.doReturn(HttpURLConnection.HTTP_INTERNAL_ERROR).when(httpsURLConnection).getResponseCode();\n+\n+        PowerMockito.mockStatic(IOUtils.class);\n+        PowerMockito.when(IOUtils.toString(errorStream)).thenReturn(\"<html><p><b>message</b> Oops, something went wrong </u></p></html>\");\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Dristhi login failed. Try later\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"UNKNOWN_RESPONSE\", loginResponse.name());\n+\n+    }\n+\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForMalformedURLRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doThrow(new MalformedURLException()).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Incorrect url\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"MALFORMED_URL\", loginResponse.name());\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForConnectionTimedOutRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doThrow(new SocketTimeoutException()).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"The server could not be reached. Try again\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"TIMEOUT\", loginResponse.name());\n+\n+    }\n+\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForRequestsWithNetworkConnectivity() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doThrow(new IOException()).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"No internet connection. Please ensure data connectivity\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"NO_INTERNET_CONNECTIVITY\", loginResponse.name());\n+\n+    }\n+\n+\n+    @Test\n+    public void testVerifyAuthorizationReturnsTrueForAuthorizedResponse() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(TEST_BASE_URL).when(dristhiConfiguration).dristhiBaseURL();\n+        Mockito.doReturn(httpURLConnection).when(httpAgentSpy).getHttpURLConnection(KEYClOAK_CONFIGURATION_ENDPOINT);\n+\n+        Mockito.doReturn(HttpURLConnection.HTTP_OK).when(httpURLConnection).getResponseCode();\n+\n+        boolean isVerified = httpAgentSpy.verifyAuthorization();\n+        Assert.assertTrue(isVerified);\n+\n+    }\n+\n+    @Test\n+    public void testVerifyAuthorizationReturnsFalseForUnauthorizedResponse() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(TEST_BASE_URL).when(dristhiConfiguration).dristhiBaseURL();\n+        Mockito.doReturn(TEST_USERNAME).when(allSharedPreferences).fetchRegisteredANM();\n+        Mockito.doReturn(httpURLConnection).when(httpAgentSpy).getHttpURLConnection(\"https://my-server.com/user-details?anm-id=\" + TEST_USERNAME);\n+\n+        Mockito.doReturn(HttpURLConnection.HTTP_UNAUTHORIZED).when(httpURLConnection).getResponseCode();\n+\n+        boolean isVerified = httpAgentSpy.verifyAuthorization();\n+        Assert.assertFalse(isVerified);\n+\n+    }\n+\n+    @Test\n+    public void testUrlCanBeAccessWithGivenCredentialsReturnsUnauthorizedResponse() throws Exception {\n+\n+        PowerMockito.mockStatic(Base64.class);\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(TEST_BASE_URL).when(dristhiConfiguration).dristhiBaseURL();\n+        Mockito.doReturn(TEST_USERNAME).when(allSharedPreferences).fetchRegisteredANM();\n+        Mockito.doReturn(httpURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+\n+        Mockito.doReturn(HttpURLConnection.HTTP_UNAUTHORIZED).when(httpURLConnection).getResponseCode();\n+\n+        LoginResponse response = httpAgentSpy.urlCanBeAccessWithGivenCredentials(USER_DETAILS_ENDPOINT, TEST_USERNAME, TEST_PASSWORD);\n+        Assert.assertNotNull(response);\n+        Assert.assertNotNull(response.message());\n+        Assert.assertNull(response.payload());\n+        Assert.assertEquals(\"Please check the credentials\", response.message());\n+\n+    }\n+\n+    @Test\n+    public void testUrlCanBeAccessWithGivenCredentialsReturnsErrorResponseForMalformedURL() throws Exception {\n+\n+        PowerMockito.mockStatic(Base64.class);\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(TEST_BASE_URL).when(dristhiConfiguration).dristhiBaseURL();\n+        Mockito.doReturn(TEST_USERNAME).when(allSharedPreferences).fetchRegisteredANM();\n+        Mockito.doReturn(httpURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+\n+        Mockito.doThrow(new MalformedURLException()).when(httpURLConnection).getResponseCode();\n+\n+        LoginResponse response = httpAgentSpy.urlCanBeAccessWithGivenCredentials(USER_DETAILS_ENDPOINT, TEST_USERNAME, TEST_PASSWORD);\n+        Assert.assertNotNull(response);\n+        Assert.assertNull(response.payload());\n+        Assert.assertNotNull(response.message());\n+        Assert.assertEquals(LoginResponse.MALFORMED_URL.name(), response.name());\n+\n+    }\n+\n+    @Test\n+    public void testUrlCanBeAccessWithGivenCredentialsReturnsCorrectErrorResponseForSocketTimeout() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdb4315fd910de403f43911fe5d57cba826a5882"}, "originalPosition": 329}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQyODEzOA==", "bodyText": "Fixed", "url": "https://github.com/opensrp/opensrp-client-core/pull/544#discussion_r434428138", "createdAt": "2020-06-03T09:19:58Z", "author": {"login": "ndegwamartin"}, "path": "opensrp-app/src/test/java/org/smartregister/service/HTTPAgentTest.java", "diffHunk": "@@ -560,4 +566,342 @@ public void testOauth2authenticateRefreshTokenInvokesOauth2authenticateCoreWithC\n \n \n     }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponse() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doReturn(inputStream).when(httpsURLConnection).getInputStream();\n+        Mockito.doReturn(HttpURLConnection.HTTP_OK).when(httpsURLConnection).getResponseCode();\n+\n+        PowerMockito.mockStatic(IOUtils.class);\n+        PowerMockito.when(IOUtils.toString(inputStream)).thenReturn(LoginResponseTestData.USER_DETAILS_REQUEST_SERVER_RESPONSE);\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Login successful.\", loginResponse.message());\n+        Assert.assertNotNull(loginResponse.payload());\n+\n+        Assert.assertNotNull(loginResponse.payload().user);\n+        Assert.assertEquals(\"demo\", loginResponse.payload().user.getUsername());\n+        Assert.assertEquals(\"Demo User\", loginResponse.payload().user.getPreferredName());\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().user.getBaseEntityId());\n+\n+        Assert.assertNotNull(loginResponse.payload().time);\n+        Assert.assertEquals(\"2020-06-02 08:21:40\", loginResponse.payload().time.getTime());\n+        Assert.assertEquals(\"Africa/Nairobi\", loginResponse.payload().time.getTimeZone());\n+\n+        Assert.assertNotNull(loginResponse.payload().locations);\n+        Assert.assertNotNull(loginResponse.payload().locations.getLocationsHierarchy());\n+\n+        Assert.assertNotNull(loginResponse.payload().jurisdictions);\n+        Assert.assertEquals(1, loginResponse.payload().jurisdictions.size());\n+        Assert.assertNotNull(\"Health Team Kasarani\", loginResponse.payload().jurisdictions.get(0));\n+\n+        Assert.assertNotNull(loginResponse.payload().team);\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().team.identifier);\n+        Assert.assertEquals(\"93c6526-6667-3333-a611112-f3b309999999\", loginResponse.payload().team.uuid);\n+\n+        Assert.assertEquals(\"SUCCESS\", loginResponse.name());\n+\n+        ArgumentCaptor<String> headerKey = ArgumentCaptor.forClass(String.class);\n+        ArgumentCaptor<String> headerValue = ArgumentCaptor.forClass(String.class);\n+\n+        Mockito.verify(httpsURLConnection).setRequestProperty(headerKey.capture(), headerValue.capture());\n+        String capturedKey = headerKey.getValue();\n+        String capturedValue = headerValue.getValue();\n+\n+        Assert.assertEquals(capturedKey, AllConstants.HTTP_REQUEST_HEADERS.AUTHORIZATION);\n+        Assert.assertEquals(capturedValue, AllConstants.HTTP_REQUEST_AUTH_TOKEN_TYPE.BEARER + \" \" + SAMPLE_TEST_TOKEN);\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForUnauthorizedRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doReturn(HttpURLConnection.HTTP_UNAUTHORIZED).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Please check the credentials\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"UNAUTHORIZED\", loginResponse.name());\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForRandomServerError() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+\n+        Mockito.doReturn(errorStream).when(httpsURLConnection).getInputStream();\n+        Mockito.doReturn(HttpURLConnection.HTTP_INTERNAL_ERROR).when(httpsURLConnection).getResponseCode();\n+\n+        PowerMockito.mockStatic(IOUtils.class);\n+        PowerMockito.when(IOUtils.toString(errorStream)).thenReturn(\"<html><p><b>message</b> Oops, something went wrong </u></p></html>\");\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Dristhi login failed. Try later\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"UNKNOWN_RESPONSE\", loginResponse.name());\n+\n+    }\n+\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForMalformedURLRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doThrow(new MalformedURLException()).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"Incorrect url\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"MALFORMED_URL\", loginResponse.name());\n+\n+    }\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForConnectionTimedOutRequests() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doThrow(new SocketTimeoutException()).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"The server could not be reached. Try again\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"TIMEOUT\", loginResponse.name());\n+\n+    }\n+\n+\n+    @Test\n+    public void testFetchUserDetailsConstructsCorrectResponseForRequestsWithNetworkConnectivity() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(httpsURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+        Mockito.doThrow(new IOException()).when(httpsURLConnection).getResponseCode();\n+\n+        LoginResponse loginResponse = httpAgentSpy.fetchUserDetails(USER_DETAILS_ENDPOINT, SAMPLE_TEST_TOKEN);\n+\n+        Assert.assertNotNull(loginResponse);\n+        Assert.assertNotNull(loginResponse.message());\n+        Assert.assertEquals(\"No internet connection. Please ensure data connectivity\", loginResponse.message());\n+        Assert.assertNull(loginResponse.payload());\n+\n+        Assert.assertEquals(\"NO_INTERNET_CONNECTIVITY\", loginResponse.name());\n+\n+    }\n+\n+\n+    @Test\n+    public void testVerifyAuthorizationReturnsTrueForAuthorizedResponse() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(TEST_BASE_URL).when(dristhiConfiguration).dristhiBaseURL();\n+        Mockito.doReturn(httpURLConnection).when(httpAgentSpy).getHttpURLConnection(KEYClOAK_CONFIGURATION_ENDPOINT);\n+\n+        Mockito.doReturn(HttpURLConnection.HTTP_OK).when(httpURLConnection).getResponseCode();\n+\n+        boolean isVerified = httpAgentSpy.verifyAuthorization();\n+        Assert.assertTrue(isVerified);\n+\n+    }\n+\n+    @Test\n+    public void testVerifyAuthorizationReturnsFalseForUnauthorizedResponse() throws Exception {\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(TEST_BASE_URL).when(dristhiConfiguration).dristhiBaseURL();\n+        Mockito.doReturn(TEST_USERNAME).when(allSharedPreferences).fetchRegisteredANM();\n+        Mockito.doReturn(httpURLConnection).when(httpAgentSpy).getHttpURLConnection(\"https://my-server.com/user-details?anm-id=\" + TEST_USERNAME);\n+\n+        Mockito.doReturn(HttpURLConnection.HTTP_UNAUTHORIZED).when(httpURLConnection).getResponseCode();\n+\n+        boolean isVerified = httpAgentSpy.verifyAuthorization();\n+        Assert.assertFalse(isVerified);\n+\n+    }\n+\n+    @Test\n+    public void testUrlCanBeAccessWithGivenCredentialsReturnsUnauthorizedResponse() throws Exception {\n+\n+        PowerMockito.mockStatic(Base64.class);\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(TEST_BASE_URL).when(dristhiConfiguration).dristhiBaseURL();\n+        Mockito.doReturn(TEST_USERNAME).when(allSharedPreferences).fetchRegisteredANM();\n+        Mockito.doReturn(httpURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+\n+        Mockito.doReturn(HttpURLConnection.HTTP_UNAUTHORIZED).when(httpURLConnection).getResponseCode();\n+\n+        LoginResponse response = httpAgentSpy.urlCanBeAccessWithGivenCredentials(USER_DETAILS_ENDPOINT, TEST_USERNAME, TEST_PASSWORD);\n+        Assert.assertNotNull(response);\n+        Assert.assertNotNull(response.message());\n+        Assert.assertNull(response.payload());\n+        Assert.assertEquals(\"Please check the credentials\", response.message());\n+\n+    }\n+\n+    @Test\n+    public void testUrlCanBeAccessWithGivenCredentialsReturnsErrorResponseForMalformedURL() throws Exception {\n+\n+        PowerMockito.mockStatic(Base64.class);\n+\n+        URL url = PowerMockito.mock(URL.class);\n+        Assert.assertNotNull(url);\n+\n+        HTTPAgent httpAgentSpy = Mockito.spy(httpAgent);\n+\n+        Mockito.doReturn(TEST_BASE_URL).when(dristhiConfiguration).dristhiBaseURL();\n+        Mockito.doReturn(TEST_USERNAME).when(allSharedPreferences).fetchRegisteredANM();\n+        Mockito.doReturn(httpURLConnection).when(httpAgentSpy).getHttpURLConnection(USER_DETAILS_ENDPOINT);\n+\n+        Mockito.doThrow(new MalformedURLException()).when(httpURLConnection).getResponseCode();\n+\n+        LoginResponse response = httpAgentSpy.urlCanBeAccessWithGivenCredentials(USER_DETAILS_ENDPOINT, TEST_USERNAME, TEST_PASSWORD);\n+        Assert.assertNotNull(response);\n+        Assert.assertNull(response.payload());\n+        Assert.assertNotNull(response.message());\n+        Assert.assertEquals(LoginResponse.MALFORMED_URL.name(), response.name());\n+\n+    }\n+\n+    @Test\n+    public void testUrlCanBeAccessWithGivenCredentialsReturnsCorrectErrorResponseForSocketTimeout() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQwNTAzOA=="}, "originalCommit": {"oid": "bdb4315fd910de403f43911fe5d57cba826a5882"}, "originalPosition": 329}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2175, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}