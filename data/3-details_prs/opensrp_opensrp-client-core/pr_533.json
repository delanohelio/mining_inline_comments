{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwNzQyMTk3", "number": 533, "title": "Handle crashes from form invalid forms, sub-forms, rules & properties files", "bodyText": "Fixes #527", "createdAt": "2020-05-20T13:12:48Z", "url": "https://github.com/opensrp/opensrp-client-core/pull/533", "merged": true, "mergeCommit": {"oid": "1878b21e13683ec8a65af1bcd53a3280929d048f"}, "closed": true, "closedAt": "2020-06-04T09:32:38Z", "author": {"login": "ekigamba"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjuy_zABqjMzNjM5NjMxODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn6sNvgFqTQyNDI2Njk3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dd87553cc7461651d45cbf21b25c31bcee8cc883", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/dd87553cc7461651d45cbf21b25c31bcee8cc883", "committedDate": "2020-05-21T15:25:28Z", "message": "Add form rollback dialog\n\n- Add org.smartregister.util.ViewUtil#showAvailableRollbackFormsDialog method to show dialog rollback to user\n- Prevent rollback-reversal during sync by using latest form instead of active form since the active form might be unstable\n- Fix exception when checking if form is new when openning JSON Form"}, "afterCommit": {"oid": "fa37e5491231d81e6c71654a6c47164e59ae276d", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/fa37e5491231d81e6c71654a6c47164e59ae276d", "committedDate": "2020-05-22T09:21:48Z", "message": "Add form rollback dialog\n\n- Add org.smartregister.util.ViewUtil#showAvailableRollbackFormsDialog method to show dialog rollback to user\n- Prevent rollback-reversal during sync by using latest form instead of active form since the active form might be unstable\n- Fix exception when checking if form is new when openning JSON Form"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f2bde71477ae8152d8720cb6f650e5ca8cd4fdd", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/1f2bde71477ae8152d8720cb6f650e5ca8cd4fdd", "committedDate": "2020-05-22T14:44:33Z", "message": "Add tests for ClientFormRepositoryTest & FormRollbackDialogTest"}, "afterCommit": {"oid": "a20f52484b284945e7be1e778085faed5189314b", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/a20f52484b284945e7be1e778085faed5189314b", "committedDate": "2020-05-27T13:36:57Z", "message": "Update native-form version to 1.9.2-SNAPSHOT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a20f52484b284945e7be1e778085faed5189314b", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/a20f52484b284945e7be1e778085faed5189314b", "committedDate": "2020-05-27T13:36:57Z", "message": "Update native-form version to 1.9.2-SNAPSHOT"}, "afterCommit": {"oid": "d6d10e72aa3b531dacdef13f8495b0ce57ff6c36", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/d6d10e72aa3b531dacdef13f8495b0ce57ff6c36", "committedDate": "2020-05-27T14:10:20Z", "message": "Update native-form version to 1.9.2-SNAPSHOT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d6d10e72aa3b531dacdef13f8495b0ce57ff6c36", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/d6d10e72aa3b531dacdef13f8495b0ce57ff6c36", "committedDate": "2020-05-27T14:10:20Z", "message": "Update native-form version to 1.9.2-SNAPSHOT"}, "afterCommit": {"oid": "807b86aad683bccdf75f8dee9ead8cf837654bb3", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/807b86aad683bccdf75f8dee9ead8cf837654bb3", "committedDate": "2020-05-27T15:24:27Z", "message": "Update native-form version to 1.9.2-SNAPSHOT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "807b86aad683bccdf75f8dee9ead8cf837654bb3", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/807b86aad683bccdf75f8dee9ead8cf837654bb3", "committedDate": "2020-05-27T15:24:27Z", "message": "Update native-form version to 1.9.2-SNAPSHOT"}, "afterCommit": {"oid": "cdb31f114e6f1705a55bada1af82f8d1413a0754", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/cdb31f114e6f1705a55bada1af82f8d1413a0754", "committedDate": "2020-05-28T07:35:54Z", "message": "Update native-form version to 1.9.2-SNAPSHOT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNzE3MDEy", "url": "https://github.com/opensrp/opensrp-client-core/pull/533#pullrequestreview-420717012", "createdAt": "2020-05-29T07:33:44Z", "commit": {"oid": "fd2282f3c258a12a93fe3e1097dfa34649dbe9b3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwNzozMzo0NFrOGcR38g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwNzo0Mzo0OFrOGcSLMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMwNjE2Mg==", "bodyText": "Does this account for MLS v2.0 where even if the locale changes we still the same form?", "url": "https://github.com/opensrp/opensrp-client-core/pull/533#discussion_r432306162", "createdAt": "2020-05-29T07:33:44Z", "author": {"login": "dubdabasoduba"}, "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1130,11 +1135,64 @@ private void createNewClientDocument(org.smartregister.cloudant.models.Client cl\n         mCloudantDataHandler.createClientDocument(client);\n     }\n \n-    public JSONObject getFormJsonFromRepositoryOrAssets(String formIdentity) {\n-        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n-        String locale = mContext.getResources().getConfiguration().locale.getLanguage();\n+    @Nullable\n+    public JSONObject getFormJsonFromRepositoryOrAssets(@NonNull String formIdentity) {\n+        return getFormJsonFromRepositoryOrAssetsWithOptionalCallback(formIdentity, null);\n+    }\n+\n+    public void getFormJsonFromRepositoryOrAssets(@NonNull String formIdentity, @Nullable OnFormFetchedCallback<JSONObject> onFormFetchedCallback) {\n+        getFormJsonFromRepositoryOrAssetsWithOptionalCallback(formIdentity, onFormFetchedCallback);\n+    }\n+\n+    private JSONObject getFormJsonFromRepositoryOrAssetsWithOptionalCallback(String formIdentity, @Nullable OnFormFetchedCallback<JSONObject> onFormFetchedCallback) {\n+        ClientForm clientForm = getClientFormFromRepository(formIdentity);\n+\n+        try {\n+            if (clientForm != null) {\n+                Timber.d(\"============%s form loaded from db============\", formIdentity);\n+\n+                JSONObject formJson = new JSONObject(clientForm.getJson());\n+                injectFormStatus(formJson, clientForm);\n+\n+                if (onFormFetchedCallback != null) {\n+                    onFormFetchedCallback.onFormFetched(formJson);\n+                    return null;\n+                }  else {\n+                    return formJson;\n+                }\n+            }\n+        } catch (JSONException e) {\n+            Timber.e(e);\n+\n+            if (onFormFetchedCallback != null) {\n+                handleJsonFormOrRulesError(false, formIdentity, form -> {\n+                    try {\n+                        JSONObject jsonObject = form == null ? null : new JSONObject(form);\n+                        onFormFetchedCallback.onFormFetched(jsonObject);\n+                    } catch (JSONException ex) {\n+                        Timber.e(ex);\n+                    }\n+                });\n+            } else {\n+                return null;\n+            }\n+        }\n+\n+        Timber.d(\"============%s form loaded from Assets=============\", formIdentity);\n+        JSONObject jsonObject = getFormJson(formIdentity);\n \n+        if (onFormFetchedCallback != null) {\n+            onFormFetchedCallback.onFormFetched(jsonObject);\n+            return null;\n+        }  else {\n+            return jsonObject;\n+        }\n+    }\n+\n+    private ClientForm getClientFormFromRepository(String formIdentity) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd2282f3c258a12a93fe3e1097dfa34649dbe9b3"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMwODQ3MA==", "bodyText": "Are we checking for the APK compatibility when suggesting the form rollback version.", "url": "https://github.com/opensrp/opensrp-client-core/pull/533#discussion_r432308470", "createdAt": "2020-05-29T07:38:45Z", "author": {"login": "dubdabasoduba"}, "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1146,25 +1204,60 @@ public JSONObject getFormJsonFromRepositoryOrAssets(String formIdentity) {\n             String revisedFormName = extractFormNameWithoutExtension(localeFormIdentity);\n             clientForm = clientFormRepository.getActiveClientFormByIdentifier(revisedFormName);\n         }\n+        return clientForm;\n+    }\n \n-        try {\n-            if (clientForm != null) {\n-                Timber.d(\"============%s form loaded from db============\", formIdentity);\n+    public void handleJsonFormOrRulesError(@NonNull String formIdentity, @NonNull OnFormFetchedCallback<String> onFormFetchedCallback) {\n+        handleJsonFormOrRulesError(false, formIdentity, onFormFetchedCallback);\n+    }\n \n-                JSONObject formJson = new JSONObject(clientForm.getJson());\n-                injectFormStatus(formJson, clientForm);\n+    public void handleJsonFormOrRulesError(boolean isRulesFile, @NonNull String formIdentity, @NonNull OnFormFetchedCallback<String> onFormFetchedCallback) {\n+        ClientForm clientForm = getClientFormFromRepository(formIdentity);\n+        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n+        List<ClientForm> clientForms = clientFormRepository.getClientFormByIdentifier(clientForm.getIdentifier());\n+\n+        if (clientForms.size() > 0) {\n+            // Show dialog asking user if they want to rollback to the previous available version X\n+            // if YES, then provide that form instead", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd2282f3c258a12a93fe3e1097dfa34649dbe9b3"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMxMTA5MA==", "bodyText": "Hope you are checking for nulls in the places where these methods are used", "url": "https://github.com/opensrp/opensrp-client-core/pull/533#discussion_r432311090", "createdAt": "2020-05-29T07:43:48Z", "author": {"login": "dubdabasoduba"}, "path": "opensrp-app/src/main/java/org/smartregister/view/activity/FormConfigurationJsonFormActivity.java", "diffHunk": "@@ -70,7 +74,7 @@ public void run() {\n                 });\n     }\n \n-    @NonNull\n+    @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd2282f3c258a12a93fe3e1097dfa34649dbe9b3"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMzQ1NzQw", "url": "https://github.com/opensrp/opensrp-client-core/pull/533#pullrequestreview-423345740", "createdAt": "2020-06-03T08:48:27Z", "commit": {"oid": "fd2282f3c258a12a93fe3e1097dfa34649dbe9b3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNTE5MTkx", "url": "https://github.com/opensrp/opensrp-client-core/pull/533#pullrequestreview-423519191", "createdAt": "2020-06-03T12:51:34Z", "commit": {"oid": "32a974f4dc5b3f4899c567b2703ceeea641aa49b"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxMjo1MTozNFrOGeaWog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxMjo1MTozNFrOGeaWog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0MjI0Mg==", "bodyText": "Delete this block if its not being used", "url": "https://github.com/opensrp/opensrp-client-core/pull/533#discussion_r434542242", "createdAt": "2020-06-03T12:51:34Z", "author": {"login": "dubdabasoduba"}, "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1258,5 +1348,24 @@ public static int getClientFormId(@NonNull JSONObject jsonObject) {\n     public static boolean isFormNew(@NonNull JSONObject jsonObject) {\n         return jsonObject.optBoolean(AllConstants.JSON.Property.IS_NEW, false);\n     }\n+/*\n+    @Nullable\n+    public List<ClientForm> getAvailableRollbackForms(@NonNull ClientForm corruptedForm) {\n+        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n+        ManifestRepository manifestRepository = CoreLibrary.getInstance().context().getManifestRepository();\n+        List<ClientForm> clientForms = clientFormRepository.getClientFormByIdentifier(corruptedForm.getIdentifier());\n+        List<Manifest> manifests = manifestRepository.getAllManifests();\n+\n+        Collections.sort(manifests, new Comparator<Manifest>() {\n+            @Override\n+            public int compare(Manifest o1, Manifest o2) {\n+                DefaultArtifactVersion v2 = new DefaultArtifactVersion(o1.getFormVersion());\n+\n+                return 0;\n+            }\n+        });\n+\n+        // Remove the current form from the available options\n+    }*/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32a974f4dc5b3f4899c567b2703ceeea641aa49b"}, "originalPosition": 216}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd062786f9c96f053ef84bcf8231328f6a9f3c0c", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/dd062786f9c96f053ef84bcf8231328f6a9f3c0c", "committedDate": "2020-06-04T08:55:25Z", "message": "Add stub methods to handle rollback when openning corrupted forms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1df85e5c1fcbfc50fb7ebd04f6126523a4327d11", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/1df85e5c1fcbfc50fb7ebd04f6126523a4327d11", "committedDate": "2020-06-04T08:55:25Z", "message": "Add form rollback dialog\n\n- Add org.smartregister.util.ViewUtil#showAvailableRollbackFormsDialog method to show dialog rollback to user\n- Prevent rollback-reversal during sync by using latest form instead of active form since the active form might be unstable\n- Fix exception when checking if form is new when openning JSON Form"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0fe7cca7bb303e7a028607cc26e9dbc1b9f4d7b", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/c0fe7cca7bb303e7a028607cc26e9dbc1b9f4d7b", "committedDate": "2020-06-04T08:55:25Z", "message": "Code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a140bb565f6e93c47051fb92d48d75d94e310576", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/a140bb565f6e93c47051fb92d48d75d94e310576", "committedDate": "2020-06-04T08:55:25Z", "message": "Add tests for ClientFormRepositoryTest & FormRollbackDialogTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bc93e43f1458c47df35b6bfbf578f75cc5b4b6c", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/9bc93e43f1458c47df35b6bfbf578f75cc5b4b6c", "committedDate": "2020-06-04T08:55:25Z", "message": "Add error handling & rollback for sub-forms & rules files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f940f13aed40d96043147048c14314b8b5e075c", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/9f940f13aed40d96043147048c14314b8b5e075c", "committedDate": "2020-06-04T08:55:25Z", "message": "Handle form config sub-form JSONException error\n\n- Prevent multiple form error dialogs for rules file errors & sub-form file errors\n- Prevent showing toast message when no rollback form is chosen"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fdcc8278308718c02de902503dbe8ef0f419a28", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/5fdcc8278308718c02de902503dbe8ef0f419a28", "committedDate": "2020-06-04T08:55:25Z", "message": "Update native-form version to 1.9.2-SNAPSHOT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae83562df6087fcee546b9569a2d3d465e0850ed", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/ae83562df6087fcee546b9569a2d3d465e0850ed", "committedDate": "2020-06-04T08:55:25Z", "message": "Add tests for FormUtils\n\n- Add tests for org.smartregister.util.FormUtils#injectFormStatus\n- Add tests for org.smartregister.util.FormUtils#getClientFormId\n- Add test for org.smartregister.util.FormUtils#isFormNew"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dda9e5cdfd5b6ec412c04158fef87ffd6837d2aa", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/dda9e5cdfd5b6ec412c04158fef87ffd6837d2aa", "committedDate": "2020-06-04T08:55:25Z", "message": "Rename DynamicJsonFormActivity to FormCOnfigurationJsonFormActivity\n\n- Add test for org.smartregister.repository.ClientFormRepository#setIsNew\n- Add test for org.smartregister.repository.ClientFormRepository#readCursor\n- Add test for org.smartregister.view.activity.FormConfigurationJsonFormActivity#getSubForm\n- Add test for org.smartregister.view.activity.FormConfigurationJsonFormActivity#handleFormError\n- Add tests for org.smartregister.view.activity.FormConfigurationJsonFormActivity#showFormVersionUpdateDialog\n- Add test for org.smartregister.view.activity.FormConfigurationJsonFormActivity#onCreate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b17826bcd93e5f8149a976ab7866672e9a8dbd6", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/7b17826bcd93e5f8149a976ab7866672e9a8dbd6", "committedDate": "2020-06-04T08:55:25Z", "message": ":arrow-up: Increment version to 1.11.7-SNAPSHOT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7df21bdebc29d653b9821ec8b404705790b538db", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/7df21bdebc29d653b9821ec8b404705790b538db", "committedDate": "2020-06-04T08:55:25Z", "message": "Code cleanup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32a974f4dc5b3f4899c567b2703ceeea641aa49b", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/32a974f4dc5b3f4899c567b2703ceeea641aa49b", "committedDate": "2020-06-03T12:35:09Z", "message": ":arrow-up: Increment version to 1.11.7-SNAPSHOT"}, "afterCommit": {"oid": "7df21bdebc29d653b9821ec8b404705790b538db", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/7df21bdebc29d653b9821ec8b404705790b538db", "committedDate": "2020-06-04T08:55:25Z", "message": "Code cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MjY2OTc4", "url": "https://github.com/opensrp/opensrp-client-core/pull/533#pullrequestreview-424266978", "createdAt": "2020-06-04T09:31:55Z", "commit": {"oid": "7df21bdebc29d653b9821ec8b404705790b538db"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2581, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}