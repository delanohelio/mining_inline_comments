{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxMDQ2OTky", "number": 652, "title": "Support P2P sync by locations", "bodyText": "Resolves #651", "createdAt": "2020-09-22T16:07:44Z", "url": "https://github.com/opensrp/opensrp-client-core/pull/652", "merged": true, "mergeCommit": {"oid": "1da0ccbf1d542d2ecac7b7177a9d8832f6e8016c"}, "closed": true, "closedAt": "2020-09-23T13:25:34Z", "author": {"login": "githengi"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLZDb_gH2gAyNDkxMDQ2OTkyOjlkODVkMDYwY2I0ZGQ1YjE1ODk4ZmJjOWUwOTc0NjY4ZmY4MjZmMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLseEUAFqTQ5NDY0OTk1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9d85d060cb4dd5b15898fbc9e0974668ff826f11", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/9d85d060cb4dd5b15898fbc9e0974668ff826f11", "committedDate": "2020-09-22T14:41:47Z", "message": "Allow sync by location Ids for clients"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b63d2c4da49d6a78c49f37043f37728a8bde65f7", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/b63d2c4da49d6a78c49f37043f37728a8bde65f7", "committedDate": "2020-09-22T16:02:09Z", "message": "If location filters are provided sync data by locationIds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80f73d0cbf2bf13404b18d00b5b58bc0ce731ce0", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/80f73d0cbf2bf13404b18d00b5b58bc0ce731ce0", "committedDate": "2020-09-22T16:22:23Z", "message": "Support lookup by location Id for events and clients"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNjQ3OTk3", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#pullrequestreview-493647997", "createdAt": "2020-09-22T16:33:42Z", "commit": {"oid": "80f73d0cbf2bf13404b18d00b5b58bc0ce731ce0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjozMzo0MlrOHWC2DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjozMzo0MlrOHWC2DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg3NzMyNA==", "bodyText": "We can also depend on the presence of the location filter here to decide if we should extract the locationId", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r492877324", "createdAt": "2020-09-22T16:33:42Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/P2PSenderTransferDao.java", "diffHunk": "@@ -28,37 +30,51 @@\n     @Nullable\n     @Override\n     public TreeSet<DataType> getDataTypes() {\n-        return (TreeSet<DataType>) dataTypes.clone();\n+        TreeSet<DataType> dataTypeTreeSet = new TreeSet<>();\n+        int start = dataTypes.size() + 1;\n+        P2POptions p2POptions = CoreLibrary.getInstance().getP2POptions();\n+        if (p2POptions != null && !ArrayUtils.isEmpty(p2POptions.getLocationsFilter())) {\n+            for (String location : p2POptions.getLocationsFilter()) {\n+                for (DataType dataType : dataTypes) {\n+                    dataTypeTreeSet.add(new DataType(dataType.getName() + \":\" + location, dataType.getType(), start + dataTypeTreeSet.size()));\n+                }\n+            }\n+        }\n+        TreeSet<DataType> dataTypesClone = new TreeSet<>(dataTypes);\n+        dataTypesClone.addAll(dataTypeTreeSet);\n+        return dataTypesClone;\n     }\n \n     @Nullable\n     @Override\n     public JsonData getJsonData(@NonNull DataType dataType, long lastRecordId, int batchSize) {\n-        if (dataType.getName().equals(event.getName())) {\n+        String[] dataTypeParams = dataType.getName().split(\":\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80f73d0cbf2bf13404b18d00b5b58bc0ce731ce0"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d42027713c6fd901a07102bced57d2b908bd598", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/3d42027713c6fd901a07102bced57d2b908bd598", "committedDate": "2020-09-22T16:39:23Z", "message": " build dynamic data types only when location filter is defined, otherwise use default data types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd923c8aaff47a4c71798078af13ca29c33144be", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/cd923c8aaff47a4c71798078af13ca29c33144be", "committedDate": "2020-09-22T16:47:24Z", "message": "extract locationId only if location filter is enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1eabe1ebed4bae54427d8ff6e480b7e978dc18a3", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/1eabe1ebed4bae54427d8ff6e480b7e978dc18a3", "committedDate": "2020-09-22T16:59:01Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a2a0f33334f81f5d43e655b39ff712c82ff96b2", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/4a2a0f33334f81f5d43e655b39ff712c82ff96b2", "committedDate": "2020-09-23T06:55:14Z", "message": "Implement location filter for structure and task p2p sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d8287ec7c962c4334e2d511088804c9884ff155", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/1d8287ec7c962c4334e2d511088804c9884ff155", "committedDate": "2020-09-23T07:19:47Z", "message": "pass p2p options in core library"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f9ae5e4ec9e8fc0a62dfef08491897d3a425438", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/2f9ae5e4ec9e8fc0a62dfef08491897d3a425438", "committedDate": "2020-09-23T07:21:15Z", "message": "Code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09f2352fb929a580d5eef914feb7f4c760302ce9", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/09f2352fb929a580d5eef914feb7f4c760302ce9", "committedDate": "2020-09-23T07:36:09Z", "message": "location Id on event table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f12fdda2fa4761329ccba6540817676a9f7af0d", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/4f12fdda2fa4761329ccba6540817676a9f7af0d", "committedDate": "2020-09-23T08:00:49Z", "message": "Populate locationId on event table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cb79df451237be78a7d278c8caaf7379a1c2a4a", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/6cb79df451237be78a7d278c8caaf7379a1c2a4a", "committedDate": "2020-09-23T08:16:37Z", "message": "Bump up version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NDA1Njc4", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#pullrequestreview-494405678", "createdAt": "2020-09-23T08:09:49Z", "commit": {"oid": "09f2352fb929a580d5eef914feb7f4c760302ce9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwODowOTo0OVrOHWb-xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwODoxNzoyMlrOHWccOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI4OTE1Ng==", "bodyText": "Let's disable this. I just looked at the workflow and we'll have to call\nCoreLibrary.getInstance().getP2POptions().setLocationsFilter(locationsFilter) everytime before starting the P2P activity. The instance of this class is created at the start of the application at which point we don't know the specific filters", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493289156", "createdAt": "2020-09-23T08:09:49Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/P2PSenderTransferDao.java", "diffHunk": "@@ -25,40 +27,73 @@\n \n public class P2PSenderTransferDao extends BaseP2PTransferDao implements SenderTransferDao {\n \n+    private static final String SEPARATOR = \"-\";\n+\n+    private P2POptions p2POptions;\n+\n+    public P2PSenderTransferDao() {\n+        this(null);\n+    }\n+\n+    public P2PSenderTransferDao(P2POptions p2POptions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09f2352fb929a580d5eef914feb7f4c760302ce9"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI5NjY5Ng==", "bodyText": "Set the DataType#position in the third param as the loop position. This is used to order the datatypes so that the syncing is done in the correct order.\nI think you should also change the loops i.e the dataType loop should be the outer loop so that the order is\n\nclient-{locationId1}\nclient-{locationId2}\nclient-{locationId3}\nevent-{locationId1}\nevent-{locationId2} ...", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493296696", "createdAt": "2020-09-23T08:17:22Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/P2PSenderTransferDao.java", "diffHunk": "@@ -25,40 +27,73 @@\n \n public class P2PSenderTransferDao extends BaseP2PTransferDao implements SenderTransferDao {\n \n+    private static final String SEPARATOR = \"-\";\n+\n+    private P2POptions p2POptions;\n+\n+    public P2PSenderTransferDao() {\n+        this(null);\n+    }\n+\n+    public P2PSenderTransferDao(P2POptions p2POptions) {\n+        super();\n+        this.p2POptions = p2POptions;\n+    }\n+\n     @Nullable\n     @Override\n     public TreeSet<DataType> getDataTypes() {\n-        return (TreeSet<DataType>) dataTypes.clone();\n+        TreeSet<DataType> dataTypeTreeSet = new TreeSet<>();\n+\n+        if (locationFilterEnabled()) {\n+            for (String location : p2POptions.getLocationsFilter()) {\n+                for (DataType dataType : dataTypes) {\n+                    dataTypeTreeSet.add(new DataType(dataType.getName() + SEPARATOR + location, dataType.getType(), dataTypeTreeSet.size()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09f2352fb929a580d5eef914feb7f4c760302ce9"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NDMxMzcy", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#pullrequestreview-494431372", "createdAt": "2020-09-23T08:40:45Z", "commit": {"oid": "09f2352fb929a580d5eef914feb7f4c760302ce9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwODo0MDo0NVrOHWd0sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwODo0MDo0NVrOHWd0sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzMxOTM0NQ==", "bodyText": "Use event_column.locationId on this line and next line", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493319345", "createdAt": "2020-09-23T08:40:45Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -146,6 +146,17 @@ public static void createAdditionalColumns(SQLiteDatabase db) {\n         createAdditionalColumns(db, Table.event.name(), Table.client.name());\n     }\n \n+    /**\n+     * add locationId  column on event table\n+     *\n+     * @param db the database being upgraded\n+     */\n+    public static void addEventLocationId(SQLiteDatabase db) {\n+        DatabaseMigrationUtils.addColumnIfNotExists(db, Table.event.name(), client_column.locationId.name(), VARCHAR);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09f2352fb929a580d5eef914feb7f4c760302ce9"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NDM2MTE1", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#pullrequestreview-494436115", "createdAt": "2020-09-23T08:46:36Z", "commit": {"oid": "4f12fdda2fa4761329ccba6540817676a9f7af0d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwODo0NjozN1rOHWeLWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwODo0NjozN1rOHWeLWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzMyNTE0NQ==", "bodyText": "This works perfect except for situations where the event does not have a locationId. I don't know if that is possible on Reveal currently", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493325145", "createdAt": "2020-09-23T08:46:37Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -154,7 +154,7 @@ public static void createAdditionalColumns(SQLiteDatabase db) {\n     public static void addEventLocationId(SQLiteDatabase db) {\n         DatabaseMigrationUtils.addColumnIfNotExists(db, Table.event.name(), client_column.locationId.name(), VARCHAR);\n         DatabaseMigrationUtils.addIndexIfNotExists(db, Table.event.name(), client_column.locationId.name());\n-\n+        db.execSQL(String.format(\"UPDATE %s set %s = %s\", Table.event.name(), event_column.locationId.name(), \"substr(json,instr(json, '\\\"locationId\\\":')+14,36)\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f12fdda2fa4761329ccba6540817676a9f7af0d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54896796dc388959f89b961b2afc97bed6b8010f", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/54896796dc388959f89b961b2afc97bed6b8010f", "committedDate": "2020-09-23T09:30:44Z", "message": "only populate locationId if its found on event"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0619b1fae5a6edb893cb6db34ec28e0ec04608b", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/f0619b1fae5a6edb893cb6db34ec28e0ec04608b", "committedDate": "2020-09-23T10:36:32Z", "message": "PR review requested changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa00314ed1eb86c8a5cf321527de4e2dd875be40", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/fa00314ed1eb86c8a5cf321527de4e2dd875be40", "committedDate": "2020-09-23T10:36:00Z", "message": "PR review requested changes"}, "afterCommit": {"oid": "f0619b1fae5a6edb893cb6db34ec28e0ec04608b", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/f0619b1fae5a6edb893cb6db34ec28e0ec04608b", "committedDate": "2020-09-23T10:36:32Z", "message": "PR review requested changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3838bee7b5eadee288ae6ae8439e85825168f7d7", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/3838bee7b5eadee288ae6ae8439e85825168f7d7", "committedDate": "2020-09-23T12:01:36Z", "message": "populate location id when saving events"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NTg5Mzc5", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#pullrequestreview-494589379", "createdAt": "2020-09-23T12:09:46Z", "commit": {"oid": "3838bee7b5eadee288ae6ae8439e85825168f7d7"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20b03361968280b83413b41c28cce19299c702a0", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/20b03361968280b83413b41c28cce19299c702a0", "committedDate": "2020-09-23T12:12:26Z", "message": "Optimize imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NjQ5OTU5", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#pullrequestreview-494649959", "createdAt": "2020-09-23T13:19:04Z", "commit": {"oid": "20b03361968280b83413b41c28cce19299c702a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2493, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}