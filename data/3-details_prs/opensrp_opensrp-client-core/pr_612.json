{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3NjI0NTgw", "number": 612, "title": "Added sync intent service tests", "bodyText": "", "createdAt": "2020-07-28T07:58:08Z", "url": "https://github.com/opensrp/opensrp-client-core/pull/612", "merged": true, "mergeCommit": {"oid": "e1f404358149bc4d26438ce688bc219fe8c93255"}, "closed": true, "closedAt": "2020-08-18T09:58:36Z", "author": {"login": "Rkareko"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5Rl5sgH2gAyNDU3NjI0NTgwOmU1Nzk5NWM1M2Y2NDExMzI3NGMyYTAwMmI3MGMzNWU1MjY4ZTVmMDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAEA4UgFqTQ2OTE3MzQ5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e57995c53f64113274c2a002b70c35e5268e5f01", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/e57995c53f64113274c2a002b70c35e5268e5f01", "committedDate": "2020-07-28T07:49:33Z", "message": "Added sync intent service tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5780b575f6d2435a1d148f1d273442ae6fdeef4", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/b5780b575f6d2435a1d148f1d273442ae6fdeef4", "committedDate": "2020-07-28T16:24:45Z", "message": "Merge branch 'master' into rkareko-tt-23"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c8e0feaf044e12f0e75b72048656c156f4a51b8", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/6c8e0feaf044e12f0e75b72048656c156f4a51b8", "committedDate": "2020-08-04T08:16:39Z", "message": "Merge branch 'master' into rkareko-tt-23"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c749fbe905b5433c7e7e05eb18ac6990967d306f", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/c749fbe905b5433c7e7e05eb18ac6990967d306f", "committedDate": "2020-08-04T08:48:36Z", "message": "Add pull ec from server when sync filter param is null test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c23c46c5e5c2d9fed98c3964b01f2ec9cab4b14b", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/c23c46c5e5c2d9fed98c3964b01f2ec9cab4b14b", "committedDate": "2020-08-04T09:54:25Z", "message": "Add pull ec from server when sync filter values is null test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78ab3493af06b54ae8093a3d7247dc30c00bd027", "author": {"user": {"login": "githengi", "name": "Samuel Githengi"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/78ab3493af06b54ae8093a3d7247dc30c00bd027", "committedDate": "2020-08-13T07:53:14Z", "message": "Merge branch 'master' into rkareko-tt-23"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NjkwNDg0", "url": "https://github.com/opensrp/opensrp-client-core/pull/612#pullrequestreview-466690484", "createdAt": "2020-08-13T11:55:32Z", "commit": {"oid": "78ab3493af06b54ae8093a3d7247dc30c00bd027"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMTo1NTozMlrOHAIL-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMTo1NTo0MFrOHAIMMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg5NjE4Ng==", "bodyText": "call pullECFromServer() since it's protected. Otherwise the rest is OK", "url": "https://github.com/opensrp/opensrp-client-core/pull/612#discussion_r469896186", "createdAt": "2020-08-13T11:55:32Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/test/java/org/smartregister/sync/intent/SyncIntentServiceTest.java", "diffHunk": "@@ -84,4 +85,64 @@ public void testHandleSyncCallsLogoutUserIfHasValidAuthorizationIsFalse() {\n         verify(syncUtils).logoutUser();\n     }\n \n+    @Test\n+    public void testHandleSyncCallsLogOutUserIfAppVersionIsNotAllowedAnd() {\n+        syncIntentService = spy(syncIntentService);\n+        Whitebox.setInternalState(syncIntentService, \"syncUtils\", syncUtils);\n+        when(syncUtils.verifyAuthorization()).thenReturn(true);\n+        when(syncConfiguration.disableSyncToServerIfUserIsDisabled()).thenReturn(true);\n+        syncIntentService.handleSync();\n+        verify(syncUtils).logoutUser();\n+    }\n+\n+    @Test\n+    public void testHandleSyncCallsPullECFromServerIfHasValidAuthorizationAndIsAppVersionAllowed() throws PackageManager.NameNotFoundException {\n+        syncIntentService = spy(syncIntentService);\n+        Whitebox.setInternalState(syncIntentService, \"syncUtils\", syncUtils);\n+        when(syncUtils.verifyAuthorization()).thenReturn(true);\n+        when(syncUtils.isAppVersionAllowed()).thenReturn(true);\n+        when(syncConfiguration.disableSyncToServerIfUserIsDisabled()).thenReturn(true);\n+        syncIntentService.handleSync();\n+        verify(syncIntentService).pullECFromServer();\n+    }\n+\n+    @Test\n+    public void testPullEcFromServerWhenSyncFilterParamIsNull() throws PackageManager.NameNotFoundException {\n+        initMocksForPullECFromServer();\n+        syncIntentService.handleSync();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78ab3493af06b54ae8093a3d7247dc30c00bd027"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg5NjI0Mw==", "bodyText": "call pullECFromServer() since it's protected. Otherwise the rest is OK", "url": "https://github.com/opensrp/opensrp-client-core/pull/612#discussion_r469896243", "createdAt": "2020-08-13T11:55:40Z", "author": {"login": "ekigamba"}, "path": "opensrp-app/src/test/java/org/smartregister/sync/intent/SyncIntentServiceTest.java", "diffHunk": "@@ -84,4 +85,64 @@ public void testHandleSyncCallsLogoutUserIfHasValidAuthorizationIsFalse() {\n         verify(syncUtils).logoutUser();\n     }\n \n+    @Test\n+    public void testHandleSyncCallsLogOutUserIfAppVersionIsNotAllowedAnd() {\n+        syncIntentService = spy(syncIntentService);\n+        Whitebox.setInternalState(syncIntentService, \"syncUtils\", syncUtils);\n+        when(syncUtils.verifyAuthorization()).thenReturn(true);\n+        when(syncConfiguration.disableSyncToServerIfUserIsDisabled()).thenReturn(true);\n+        syncIntentService.handleSync();\n+        verify(syncUtils).logoutUser();\n+    }\n+\n+    @Test\n+    public void testHandleSyncCallsPullECFromServerIfHasValidAuthorizationAndIsAppVersionAllowed() throws PackageManager.NameNotFoundException {\n+        syncIntentService = spy(syncIntentService);\n+        Whitebox.setInternalState(syncIntentService, \"syncUtils\", syncUtils);\n+        when(syncUtils.verifyAuthorization()).thenReturn(true);\n+        when(syncUtils.isAppVersionAllowed()).thenReturn(true);\n+        when(syncConfiguration.disableSyncToServerIfUserIsDisabled()).thenReturn(true);\n+        syncIntentService.handleSync();\n+        verify(syncIntentService).pullECFromServer();\n+    }\n+\n+    @Test\n+    public void testPullEcFromServerWhenSyncFilterParamIsNull() throws PackageManager.NameNotFoundException {\n+        initMocksForPullECFromServer();\n+        syncIntentService.handleSync();\n+        verify(syncIntentService, times(2)).sendBroadcast(intentArgumentCaptor.capture());\n+        // sync fetch started broadcast sent\n+        assertEquals(SyncStatusBroadcastReceiver.ACTION_SYNC_STATUS, intentArgumentCaptor.getAllValues().get(0).getAction());\n+        assertEquals(FetchStatus.fetchStarted, intentArgumentCaptor.getAllValues().get(0).getSerializableExtra(SyncStatusBroadcastReceiver.EXTRA_FETCH_STATUS));\n+\n+        // sync fetch failed broadcast sent\n+        assertEquals(SyncStatusBroadcastReceiver.ACTION_SYNC_STATUS, intentArgumentCaptor.getAllValues().get(1).getAction());\n+        assertEquals(FetchStatus.fetchedFailed, intentArgumentCaptor.getAllValues().get(1).getSerializableExtra(SyncStatusBroadcastReceiver.EXTRA_FETCH_STATUS));\n+\n+    }\n+\n+    @Test\n+    public void testPullEcFromServerWhenSyncFilterValueIsNull() throws PackageManager.NameNotFoundException {\n+        initMocksForPullECFromServer();\n+        when(syncConfiguration.getSyncFilterParam()).thenReturn(SyncFilter.LOCATION);\n+        syncIntentService.handleSync();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78ab3493af06b54ae8093a3d7247dc30c00bd027"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f206318d2cd236d6a877b460579dfff6caef629", "author": {"user": {"login": "Rkareko", "name": null}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/3f206318d2cd236d6a877b460579dfff6caef629", "committedDate": "2020-08-17T15:09:51Z", "message": "Update unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MTczNDk4", "url": "https://github.com/opensrp/opensrp-client-core/pull/612#pullrequestreview-469173498", "createdAt": "2020-08-18T09:57:49Z", "commit": {"oid": "3f206318d2cd236d6a877b460579dfff6caef629"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2464, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}