{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MDc4NTM1", "number": 523, "title": "Load subforms & rules files from db", "bodyText": "Fixes #502", "createdAt": "2020-05-14T15:38:31Z", "url": "https://github.com/opensrp/opensrp-client-core/pull/523", "merged": true, "mergeCommit": {"oid": "c241c8f05c3c537f932ed3323fc2ca1ff2c850a1"}, "closed": true, "closedAt": "2020-05-22T07:09:54Z", "author": {"login": "ekigamba"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchPhpxgBqjMzMzcyNjYyMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjYbnZgFqTQxNTkzMTc0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3668b7f588bd412c2cfa54b2dc6e9ac005f68680", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/3668b7f588bd412c2cfa54b2dc6e9ac005f68680", "committedDate": "2020-05-14T15:33:55Z", "message": "Fix loading sub-forms & forms\n\n- URL Encode client form identifiers\n- Fix issue where client form identifier with backslash cannot be fetched from server because the backslash is not escaped"}, "afterCommit": {"oid": "c25e3f3af82b630ab57c99b36906ff5a61076542", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/c25e3f3af82b630ab57c99b36906ff5a61076542", "committedDate": "2020-05-14T15:50:38Z", "message": "Fix loading sub-forms & forms\n\n- URL Encode client form identifiers\n- Fix issue where client form identifier with backslash cannot be fetched from server because the backslash is not escaped"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0324dc6ebefdee178d9d575d2e6cf48909fdfcf4", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/0324dc6ebefdee178d9d575d2e6cf48909fdfcf4", "committedDate": "2020-05-15T08:53:11Z", "message": "Load sub-forms & rules from the DB in JSONFormActivity\n\n- Extends JsonFormActivity\n- Add native form as a dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1937d723cb7f44be8cda3cff1006849861f1d80d", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/1937d723cb7f44be8cda3cff1006849861f1d80d", "committedDate": "2020-05-15T08:53:12Z", "message": "Fix loading sub-forms & forms\n\n- URL Encode client form identifiers\n- Fix issue where client form identifier with backslash cannot be fetched from server because the backslash is not escaped"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "201aed1a96ea7c1a6ea2f11041f9b2972e18e0d0", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/201aed1a96ea7c1a6ea2f11041f9b2972e18e0d0", "committedDate": "2020-05-15T08:53:12Z", "message": "Change native-form version to 1.8.6-SNAPSHOT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12abcdfcf56733ef70e17675bbb8f8e4652d1aca", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/12abcdfcf56733ef70e17675bbb8f8e4652d1aca", "committedDate": "2020-05-15T08:48:11Z", "message": "Change native-form version to 1.8.6-SNAPSHOT"}, "afterCommit": {"oid": "201aed1a96ea7c1a6ea2f11041f9b2972e18e0d0", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/201aed1a96ea7c1a6ea2f11041f9b2972e18e0d0", "committedDate": "2020-05-15T08:53:12Z", "message": "Change native-form version to 1.8.6-SNAPSHOT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "committedDate": "2020-05-15T10:00:57Z", "message": "Revert escaping of backslach & cleanup code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "922a73e6f7698b23d59e75b35701d99654b0c811", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/922a73e6f7698b23d59e75b35701d99654b0c811", "committedDate": "2020-05-15T09:47:22Z", "message": "Fix failing tests due to new URLEncode on doc config endpoints"}, "afterCommit": {"oid": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "committedDate": "2020-05-15T10:00:57Z", "message": "Revert escaping of backslach & cleanup code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MjU2NTk4", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#pullrequestreview-414256598", "createdAt": "2020-05-19T09:16:14Z", "commit": {"oid": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwOToxNjoxNFrOGXXYtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwOToyNToxN1rOGXXujA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1MzU5MQ==", "bodyText": "use Locale.ENGLISH instead or en", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#discussion_r427153591", "createdAt": "2020-05-19T09:16:14Z", "author": {"login": "dubdabasoduba"}, "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1147,4 +1158,66 @@ public JSONObject getFormJsonFromRepositoryOrAssets(String formIdentity) {\n         return getFormJson(formIdentity);\n     }\n \n+    @Nullable\n+    public JSONObject getSubFormJsonFromRepository(String formIdentity, String subFormsLocation, Context context, boolean translateSubForm) {\n+        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n+        String locale = mContext.getResources().getConfiguration().locale.getLanguage();\n+\n+        //Check the current locale of the app to load the correct version of the form in the desired language\n+        String localeFormIdentity = formIdentity;\n+        if (!\"en\".equals(locale)) {\n+            localeFormIdentity = localeFormIdentity + \"-\" + locale;\n+        }\n+\n+        String dbFormName = TextUtils.isEmpty(subFormsLocation) ? localeFormIdentity : subFormsLocation + \"/\" + localeFormIdentity;\n+        ClientForm clientForm = clientFormRepository.getActiveClientFormByIdentifier(dbFormName);\n+\n+        if (clientForm == null) {\n+            String revisedFormName = dbFormName.endsWith(\".json\")\n+                    ? dbFormName.substring(0, localeFormIdentity.length() - 5) : dbFormName + \".json\";\n+            clientForm = clientFormRepository.getActiveClientFormByIdentifier(revisedFormName);\n+\n+            if (clientForm == null) {\n+                String finalSubFormsLocation = com.vijay.jsonwizard.utils.FormUtils.getSubFormLocation(subFormsLocation);\n+                dbFormName = TextUtils.isEmpty(finalSubFormsLocation) ? localeFormIdentity : finalSubFormsLocation + \"/\" + localeFormIdentity;\n+                clientForm = clientFormRepository.getActiveClientFormByIdentifier(dbFormName);\n+            }\n+        }\n+\n+        try {\n+            if (clientForm != null) {\n+                Timber.d(\"============%s form loaded from db============\", dbFormName);\n+                String originalJson = clientForm.getJson();\n+\n+                return new JSONObject(NativeFormLangUtils.getTranslatedString(originalJson, context));\n+            }\n+        } catch (JSONException e) {\n+            Timber.e(e);\n+        }\n+\n+        return null;\n+    }\n+\n+    @Nullable\n+    public BufferedReader getRulesFromRepository(String fileName) {\n+        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n+        String locale = mContext.getResources().getConfiguration().locale.getLanguage();\n+\n+        //Check the current locale of the app to load the correct version of the form in the desired language\n+        String localeFormIdentity = fileName;\n+        if (!\"en\".equals(locale)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1NDIwMQ==", "bodyText": "Where are this imports used in this class?", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#discussion_r427154201", "createdAt": "2020-05-19T09:17:13Z", "author": {"login": "dubdabasoduba"}, "path": "opensrp-app/src/main/java/org/smartregister/service/DocumentConfigurationService.java", "diffHunk": "@@ -17,6 +17,8 @@\n import org.smartregister.repository.ClientFormRepository;\n import org.smartregister.repository.ManifestRepository;\n \n+import java.io.UnsupportedEncodingException;\n+import java.net.URLEncoder;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1NTAyNA==", "bodyText": "use Locale.ENGLISH instead of the  string en", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#discussion_r427155024", "createdAt": "2020-05-19T09:18:30Z", "author": {"login": "dubdabasoduba"}, "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1147,4 +1158,66 @@ public JSONObject getFormJsonFromRepositoryOrAssets(String formIdentity) {\n         return getFormJson(formIdentity);\n     }\n \n+    @Nullable\n+    public JSONObject getSubFormJsonFromRepository(String formIdentity, String subFormsLocation, Context context, boolean translateSubForm) {\n+        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n+        String locale = mContext.getResources().getConfiguration().locale.getLanguage();\n+\n+        //Check the current locale of the app to load the correct version of the form in the desired language\n+        String localeFormIdentity = formIdentity;\n+        if (!\"en\".equals(locale)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1NzI5Mg==", "bodyText": "StringUtils.isNotBlank or StringUtils.isBlank is more efficient than TextUtils.isEmpty since it checks for whitespaces too", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#discussion_r427157292", "createdAt": "2020-05-19T09:22:10Z", "author": {"login": "dubdabasoduba"}, "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1147,4 +1158,66 @@ public JSONObject getFormJsonFromRepositoryOrAssets(String formIdentity) {\n         return getFormJson(formIdentity);\n     }\n \n+    @Nullable\n+    public JSONObject getSubFormJsonFromRepository(String formIdentity, String subFormsLocation, Context context, boolean translateSubForm) {\n+        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n+        String locale = mContext.getResources().getConfiguration().locale.getLanguage();\n+\n+        //Check the current locale of the app to load the correct version of the form in the desired language\n+        String localeFormIdentity = formIdentity;\n+        if (!\"en\".equals(locale)) {\n+            localeFormIdentity = localeFormIdentity + \"-\" + locale;\n+        }\n+\n+        String dbFormName = TextUtils.isEmpty(subFormsLocation) ? localeFormIdentity : subFormsLocation + \"/\" + localeFormIdentity;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1NzU2NQ==", "bodyText": "Can we have the .json  defined as a constant?", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#discussion_r427157565", "createdAt": "2020-05-19T09:22:41Z", "author": {"login": "dubdabasoduba"}, "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1147,4 +1158,66 @@ public JSONObject getFormJsonFromRepositoryOrAssets(String formIdentity) {\n         return getFormJson(formIdentity);\n     }\n \n+    @Nullable\n+    public JSONObject getSubFormJsonFromRepository(String formIdentity, String subFormsLocation, Context context, boolean translateSubForm) {\n+        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n+        String locale = mContext.getResources().getConfiguration().locale.getLanguage();\n+\n+        //Check the current locale of the app to load the correct version of the form in the desired language\n+        String localeFormIdentity = formIdentity;\n+        if (!\"en\".equals(locale)) {\n+            localeFormIdentity = localeFormIdentity + \"-\" + locale;\n+        }\n+\n+        String dbFormName = TextUtils.isEmpty(subFormsLocation) ? localeFormIdentity : subFormsLocation + \"/\" + localeFormIdentity;\n+        ClientForm clientForm = clientFormRepository.getActiveClientFormByIdentifier(dbFormName);\n+\n+        if (clientForm == null) {\n+            String revisedFormName = dbFormName.endsWith(\".json\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1ODY2NQ==", "bodyText": "This has been repeated in line 1176 please refactor it for reuse", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#discussion_r427158665", "createdAt": "2020-05-19T09:24:30Z", "author": {"login": "dubdabasoduba"}, "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1135,6 +1139,13 @@ public JSONObject getFormJsonFromRepositoryOrAssets(String formIdentity) {\n         }\n \n         ClientForm clientForm = clientFormRepository.getActiveClientFormByIdentifier(localeFormIdentity);\n+\n+        if (clientForm == null) {\n+            String revisedFormName = localeFormIdentity .endsWith(\".json\")\n+                    ? localeFormIdentity.substring(0, localeFormIdentity.length() - 5) : localeFormIdentity + \".json\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1OTE4MA==", "bodyText": "StringUtils.isNotBlank or StringUtils.isBlank is more efficient than TextUtils.isEmpty since it checks for whitespaces too & refactor for reuse.", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#discussion_r427159180", "createdAt": "2020-05-19T09:25:17Z", "author": {"login": "dubdabasoduba"}, "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1147,4 +1158,66 @@ public JSONObject getFormJsonFromRepositoryOrAssets(String formIdentity) {\n         return getFormJson(formIdentity);\n     }\n \n+    @Nullable\n+    public JSONObject getSubFormJsonFromRepository(String formIdentity, String subFormsLocation, Context context, boolean translateSubForm) {\n+        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n+        String locale = mContext.getResources().getConfiguration().locale.getLanguage();\n+\n+        //Check the current locale of the app to load the correct version of the form in the desired language\n+        String localeFormIdentity = formIdentity;\n+        if (!\"en\".equals(locale)) {\n+            localeFormIdentity = localeFormIdentity + \"-\" + locale;\n+        }\n+\n+        String dbFormName = TextUtils.isEmpty(subFormsLocation) ? localeFormIdentity : subFormsLocation + \"/\" + localeFormIdentity;\n+        ClientForm clientForm = clientFormRepository.getActiveClientFormByIdentifier(dbFormName);\n+\n+        if (clientForm == null) {\n+            String revisedFormName = dbFormName.endsWith(\".json\")\n+                    ? dbFormName.substring(0, localeFormIdentity.length() - 5) : dbFormName + \".json\";\n+            clientForm = clientFormRepository.getActiveClientFormByIdentifier(revisedFormName);\n+\n+            if (clientForm == null) {\n+                String finalSubFormsLocation = com.vijay.jsonwizard.utils.FormUtils.getSubFormLocation(subFormsLocation);\n+                dbFormName = TextUtils.isEmpty(finalSubFormsLocation) ? localeFormIdentity : finalSubFormsLocation + \"/\" + localeFormIdentity;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MjY0OTIw", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#pullrequestreview-414264920", "createdAt": "2020-05-19T09:27:02Z", "commit": {"oid": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96692c0ce82fc67f96dfd2b4cc218834cb0c2bc5", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/96692c0ce82fc67f96dfd2b4cc218834cb0c2bc5", "committedDate": "2020-05-19T12:20:14Z", "message": "Code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7cd082786240081424a3b037a72911d57180c7f", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/e7cd082786240081424a3b037a72911d57180c7f", "committedDate": "2020-05-19T13:00:56Z", "message": "Add tests for FormUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d86c1b44a64422e65c692e5de59c2fbfa228bed", "author": {"user": {"login": "ekigamba", "name": "Ephraim Kigamba"}}, "url": "https://github.com/opensrp/opensrp-client-core/commit/9d86c1b44a64422e65c692e5de59c2fbfa228bed", "committedDate": "2020-05-19T13:56:22Z", "message": "Add tests for DynamicJsonFormActivityTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTMxNzQ1", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#pullrequestreview-415931745", "createdAt": "2020-05-21T07:21:19Z", "commit": {"oid": "9d86c1b44a64422e65c692e5de59c2fbfa228bed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2575, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}