{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxMjIzMDI3", "number": 7249, "title": "Fix list streams crashing if parent object was deleted.", "bodyText": "Finally managed to get Android Studio working again \ud83d\ude44\nCloses #7242\nThis PR fixes a bug in our RxJava/Corutine implementation that didn't correctly handle streams from lists when the parent object holding the list was deleted.\nHow to handle it is a bit up for debate though. I could see 4 choices:\n\nEither emit the invalid collection. In which case people would have to guard for it. But it would return false for frozen unlike everything else.\nReturn a null collection and then close the stream. This would introduce null checks everywhere in the Kotlin API\nThrow an exception in the stream.\nDo not emit anything and just close the stream gracefully.\n\nI opted for the last option as deleting parents seems like a valid use case, and completing the stream does indicate that no further changes will be coming. Alternatively, I was also leaning towards 2, but it does make consuming the API a bit annoying for the common case.\nAny thoughts on this?\nI also exposed our BlockingLooperThread as a Dispatcher. I think it can be useful to clean up some of the other tests (In another PR).", "createdAt": "2020-12-16T14:54:50Z", "url": "https://github.com/realm/realm-java/pull/7249", "merged": true, "mergeCommit": {"oid": "883bd3bcf48aa99f646876c660f527aa4b707d30"}, "closed": true, "closedAt": "2021-01-12T08:32:28Z", "author": {"login": "cmelchior"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmwF1_gH2gAyNTQxMjIzMDI3OmI2ODkwMDUwMzk4YjY1MTQ3YzQzOThiNmQ3ZjJmNWVjZGI5Y2NkNTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvW4AvAH2gAyNTQxMjIzMDI3OmU5Yzk2NGQzMDI3ZmJhNDkyMzg4NTQwNDJiMjI1ZjMxZjZiMTQ0OWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b6890050398b65147c4398b6d7f2f5ecdb9ccd59", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/b6890050398b65147c4398b6d7f2f5ecdb9ccd59", "committedDate": "2020-12-16T14:48:11Z", "message": "Fix list streams crashing if parent object was deleted."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MzQ3MjY1", "url": "https://github.com/realm/realm-java/pull/7249#pullrequestreview-554347265", "createdAt": "2020-12-17T07:47:11Z", "commit": {"oid": "b6890050398b65147c4398b6d7f2f5ecdb9ccd59"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwNzo0NzoxMVrOIHonGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwNzo0NzoxMVrOIHonGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDg3NjMxMw==", "bodyText": "Maybe not required for now, but I guess you could communicate through a channel now that we are in a coroutine context. That would make it cleaner when waiting for the result. Good old CSP.", "url": "https://github.com/realm/realm-java/pull/7249#discussion_r544876313", "createdAt": "2020-12-17T07:47:11Z", "author": {"login": "rorbech"}, "path": "realm/kotlin-extensions/src/androidTest/kotlin/io/realm/CoroutinesTests.kt", "diffHunk": "@@ -924,6 +928,160 @@ class CoroutinesTests {\n         TestHelper.awaitOrFail(countDownLatch)\n     }\n \n+    @Test\n+    fun realmList_flow_parentDeletionComplete() = looperThread.runBlocking {\n+        val realm = Realm.getInstance(configuration)\n+        realm.beginTransaction()\n+        val parent = realm.createObject<AllTypes>()\n+        val list = parent.columnRealmList\n+        list.add(Dog(\"dog\"))\n+        realm.commitTransaction()\n+\n+        val collectingStarted = AtomicBoolean(false)\n+        val context = looperThread.asDispatcher()\n+        val scope = CoroutineScope(context)\n+        scope.launch {\n+            // We should only emit valid lists. If the parent of the list is invalidated\n+            // it should close the stream gracefully resulting in onComplete being called.\n+            list.toFlow()\n+                    .onEach { assertTrue(it.isValid) }\n+                    .onCompletion {\n+                        realm.close()\n+                        looperThread.testComplete()\n+                    }.collect {\n+                        collectingStarted.set(true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6890050398b65147c4398b6d7f2f5ecdb9ccd59"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NTg5NzUw", "url": "https://github.com/realm/realm-java/pull/7249#pullrequestreview-554589750", "createdAt": "2020-12-17T13:12:45Z", "commit": {"oid": "b6890050398b65147c4398b6d7f2f5ecdb9ccd59"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzoxMjo0NlrOIH1AEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzoxNzoxNVrOIH1LAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA3OTMxNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            * RxJava Flowables/Observables and Coroutine Flows would crash if they where created from a `RealmList` and the parent object holding the list was deleted. Now, the stream is disposed/closed instead. (Issue [#7242](https://github.com/realm/realm-java/issues/7242)) \n          \n          \n            \n            * RxJava Flowables/Observables and Coroutine Flows would crash if they were created from a `RealmList` and the parent object holding the list was deleted. Now, the stream is disposed/closed instead. (Issue [#7242](https://github.com/realm/realm-java/issues/7242))", "url": "https://github.com/realm/realm-java/pull/7249#discussion_r545079314", "createdAt": "2020-12-17T13:12:46Z", "author": {"login": "edualonso"}, "path": "CHANGELOG.md", "diffHunk": "@@ -1,3 +1,19 @@\n+## 10.2.1 (YYYY-MM-DD)\n+\n+### Enhancements\n+* None.\n+\n+### Fixes\n+* RxJava Flowables/Observables and Coroutine Flows would crash if they where created from a `RealmList` and the parent object holding the list was deleted. Now, the stream is disposed/closed instead. (Issue [#7242](https://github.com/realm/realm-java/issues/7242)) ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6890050398b65147c4398b6d7f2f5ecdb9ccd59"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA4MjExMg==", "bodyText": "\ud83d\udc4f", "url": "https://github.com/realm/realm-java/pull/7249#discussion_r545082112", "createdAt": "2020-12-17T13:17:15Z", "author": {"login": "edualonso"}, "path": "realm/realm-library/src/testUtils/kotlin/io/realm/rule/BlockingLooperThread.kt", "diffHunk": "@@ -222,6 +208,11 @@ class BlockingLooperThread {\n         }\n     }\n \n+    fun asDispatcher(): CoroutineContext {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6890050398b65147c4398b6d7f2f5ecdb9ccd59"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5897549fa4878999a96e0b02c5deb08ec17d44a7", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/5897549fa4878999a96e0b02c5deb08ec17d44a7", "committedDate": "2021-01-12T08:29:41Z", "message": "Merge branch 'releases' into cm/bug/stream-delete-list-parent\n\n# Conflicts:\n#\tCHANGELOG.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9c964d3027fba49238854042b225f31f6b1449e", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/e9c964d3027fba49238854042b225f31f6b1449e", "committedDate": "2021-01-12T08:30:46Z", "message": "Fix changelog"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2241, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}