{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0MDc0MzQ0", "number": 7019, "title": "Correctly refresh Java connections", "bodyText": "Closes #7003\nThis fixes a bug where calling SyncManager.refreshConnections() didn't actually refresh connections that where in a backoff state on the Java side. This meant that even if you called refreshConnections() users could still end up waiting the maximum 5 minutes before the connection was established.", "createdAt": "2020-08-06T14:45:11Z", "url": "https://github.com/realm/realm-java/pull/7019", "merged": true, "mergeCommit": {"oid": "7a926719cc4608bc3ec3fb3b253c33a2e4b22056"}, "closed": true, "closedAt": "2020-08-13T14:28:08Z", "author": {"login": "cmelchior"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8Q3GOAH2gAyNDY0MDc0MzQ0OjZhZTNjMmJlM2UwOWU3ODNkOTU3NmY2OTMxYzkyZjBjZDIzOTk5ZGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-f1XaAFqTQ2NjcyODc2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6ae3c2be3e09e783d9576f6931c92f0cd23999da", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/6ae3c2be3e09e783d9576f6931c92f0cd23999da", "committedDate": "2020-08-06T14:40:12Z", "message": "SyncManager.refreshConnections() should also refresh Java network requests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4cf7c2203eb39c22350719e2b337d478bde2774", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/c4cf7c2203eb39c22350719e2b337d478bde2774", "committedDate": "2020-08-06T15:12:15Z", "message": "Add missing file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNjY3ODE0", "url": "https://github.com/realm/realm-java/pull/7019#pullrequestreview-462667814", "createdAt": "2020-08-06T16:12:14Z", "commit": {"oid": "c4cf7c2203eb39c22350719e2b337d478bde2774"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNjoxMjoxNVrOG86fmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNjoxMjoxNVrOG86fmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUyNjEwNw==", "bodyText": "Shouldn't this be  synchronized on the SyncSession instance? Is it not reachable from user code through SyncManager.refreshConnection?", "url": "https://github.com/realm/realm-java/pull/7019#discussion_r466526107", "createdAt": "2020-08-06T16:12:15Z", "author": {"login": "rorbech"}, "path": "realm/realm-library/src/objectServer/java/io/realm/SyncSession.java", "diffHunk": "@@ -888,26 +896,43 @@ protected void onSuccess(AuthenticateResponse response) {\n                             scheduleRefreshAccessToken(authServer, response.getAccessToken().expiresMs());\n                         }\n                     }\n+                    refreshTokenNetworkRequest = null;\n                 }\n             }\n \n             @Override\n             protected void onError(AuthenticateResponse response) {\n                 if (!isClosed && !Thread.currentThread().isInterrupted()) {\n                     onGoingAccessTokenQuery.set(false);\n-                    RealmLog.error(\"Unrecoverable error, while refreshing the access Token (\" + response.getError().toString() + \") reschedule will not happen\");\n+                    RealmLog.debug(\"Session[%s]: Unrecoverable error, while refreshing the access Token. Reschedule will not happen. %s\", configuration.getPath(), response.getError());\n                 }\n+                refreshTokenNetworkRequest = null;\n+            }\n+\n+            @Override\n+            protected String getName() {\n+                return taskName;\n             }\n-        });\n-        refreshTokenNetworkRequest = new RealmAsyncTaskImpl(task, SyncManager.NETWORK_POOL_EXECUTOR);\n+        }, SyncManager.NETWORK_POOL_EXECUTOR);\n+    }\n+\n+    void refreshConnection() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4cf7c2203eb39c22350719e2b337d478bde2774"}, "originalPosition": 121}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "192624bac054dc7d94b953f68de88e36d2d3d323", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/192624bac054dc7d94b953f68de88e36d2d3d323", "committedDate": "2020-08-07T08:58:45Z", "message": "Correctly synchronize access to Session"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMTYxMzUw", "url": "https://github.com/realm/realm-java/pull/7019#pullrequestreview-463161350", "createdAt": "2020-08-07T09:15:52Z", "commit": {"oid": "192624bac054dc7d94b953f68de88e36d2d3d323"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOToxNTo1MlrOG9Ss5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOToxNTo1MlrOG9Ss5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyMjcyNQ==", "bodyText": "Not sure that I have the full overview of all execution paths, but seems like refreshTokenNetworkRequest could have been cleared in the meantime, so should be checked for null?", "url": "https://github.com/realm/realm-java/pull/7019#discussion_r466922725", "createdAt": "2020-08-07T09:15:52Z", "author": {"login": "rorbech"}, "path": "realm/realm-library/src/objectServer/java/io/realm/SyncSession.java", "diffHunk": "@@ -873,7 +881,7 @@ protected AuthenticateResponse execute() {\n             protected void onSuccess(AuthenticateResponse response) {\n                 synchronized (SyncSession.this) {\n                     if (!isClosed && !Thread.currentThread().isInterrupted() && !refreshTokenNetworkRequest.isCancelled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "192624bac054dc7d94b953f68de88e36d2d3d323"}, "originalPosition": 122}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd30507c718c7754495ca1bcc5cd395fa3e77983", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/bd30507c718c7754495ca1bcc5cd395fa3e77983", "committedDate": "2020-08-07T13:33:16Z", "message": "Backport CI changes to master/releases branch in order to use emulators"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afd777208aa864a3d9a4f05c439f504cb0e3fb20", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/afd777208aa864a3d9a4f05c439f504cb0e3fb20", "committedDate": "2020-08-07T13:59:54Z", "message": "Downgrade android version to match"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cf7c500d3ae74ba52c10f3404ff5d8ed1be6c84", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/8cf7c500d3ae74ba52c10f3404ff5d8ed1be6c84", "committedDate": "2020-08-07T16:56:48Z", "message": "Set NDK version correctly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65da5b5dc357889b09b490fd4e93744a1385a9b9", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/65da5b5dc357889b09b490fd4e93744a1385a9b9", "committedDate": "2020-08-10T07:55:20Z", "message": "Update dependencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ce75ca159e15d372e97caa9018a538fb61b4882", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/6ce75ca159e15d372e97caa9018a538fb61b4882", "committedDate": "2020-08-10T08:29:54Z", "message": "Remove NDK check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b06ba47806b07debae0e98e57c59bffe3f3234b", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/9b06ba47806b07debae0e98e57c59bffe3f3234b", "committedDate": "2020-08-10T12:50:45Z", "message": "Add CMake changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1bb0c72e281f0f80f4a2d648a6e7f2bd0915af1", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/c1bb0c72e281f0f80f4a2d648a6e7f2bd0915af1", "committedDate": "2020-08-10T12:58:03Z", "message": "Fix source code ref"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dec2224f4201f995f9aa86e08a3ec831d604b1d", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/7dec2224f4201f995f9aa86e08a3ec831d604b1d", "committedDate": "2020-08-10T13:46:31Z", "message": "Fix Gradle Plugin tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1225ae52f19f008cce9cbc5824913f1e779de46", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/c1225ae52f19f008cce9cbc5824913f1e779de46", "committedDate": "2020-08-10T13:51:39Z", "message": "Disable unit test example"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e52535700c7d20ab712cfa273638ed84cbcbf7c", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/3e52535700c7d20ab712cfa273638ed84cbcbf7c", "committedDate": "2020-08-10T14:36:05Z", "message": "Fix annotation processor tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e55ce376953583f052a1b128827e968470b3e03", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/6e55ce376953583f052a1b128827e968470b3e03", "committedDate": "2020-08-10T15:01:35Z", "message": "Disable test classes for FindBugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b37492ee8b26e0dc5e580a663e2b6f8f75a94e8", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/5b37492ee8b26e0dc5e580a663e2b6f8f75a94e8", "committedDate": "2020-08-10T15:15:25Z", "message": "Ignore proxy classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6455297b05bdc9843e1fa40f2c33a6edcafb20bb", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/6455297b05bdc9843e1fa40f2c33a6edcafb20bb", "committedDate": "2020-08-10T15:28:17Z", "message": "Ignore test model classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fd06889dc057dd1bae3612795f96675cf7a95f2", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/5fd06889dc057dd1bae3612795f96675cf7a95f2", "committedDate": "2020-08-11T11:42:09Z", "message": "Fix Findbugs warnings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3153c672f44b1cb0cfc90dae20c1f65a37038ae4", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/3153c672f44b1cb0cfc90dae20c1f65a37038ae4", "committedDate": "2020-08-11T12:11:17Z", "message": "Delete unused class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c846d1941064a3d5aeff830df3555a4e3b6fa4b1", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/c846d1941064a3d5aeff830df3555a4e3b6fa4b1", "committedDate": "2020-08-12T11:14:48Z", "message": "Disable PMD"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3afeb5d76310fb63725eb5450ab7a265e0310d66", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/3afeb5d76310fb63725eb5450ab7a265e0310d66", "committedDate": "2020-08-12T14:30:44Z", "message": "Disable PMD file upload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9719698d0d9cd3917d5fb858827072031866f89", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/f9719698d0d9cd3917d5fb858827072031866f89", "committedDate": "2020-08-13T08:16:26Z", "message": "Fix storing server logs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NzI4NzYz", "url": "https://github.com/realm/realm-java/pull/7019#pullrequestreview-466728763", "createdAt": "2020-08-13T12:50:12Z", "commit": {"oid": "f9719698d0d9cd3917d5fb858827072031866f89"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMjo1MDoxMlrOHAKCCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMjo1MDoxMlrOHAKCCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkyNjQwOA==", "bodyText": "Has google() stopped working? Maybe just backporting something. Seems to ring a bell about asking this before.", "url": "https://github.com/realm/realm-java/pull/7019#discussion_r469926408", "createdAt": "2020-08-13T12:50:12Z", "author": {"login": "rorbech"}, "path": "gradle-plugin/src/test/groovy/io/realm/gradle/PluginTest.groovy", "diffHunk": "@@ -121,7 +121,9 @@ class PluginTest {\n     void pluginAddsRightRepositories_noRepositorySet() {\n         project.buildscript {\n             repositories {\n-                google()\n+                maven {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9719698d0d9cd3917d5fb858827072031866f89"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2299, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}