{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwOTQ3Mjg2", "number": 6973, "title": "Fix support for multiple Realms by same user", "bodyText": "Closes #6882\nThis PR fixes the bug that didn't allow the same user to open multiple Realms. The reason was that the way we calculated the file path didn't account for the partition value.\nIt does that now by using the functionality offered in OS. Unfortunately, the OS doesn't support all the things the Java binding did, like checking for FAT32 length limits. It still doesn't, but I'm attempting to fix this in realm/realm-object-store#1049.\nHowever, we have a few beta customers who are blocked by this fix, so I'm putting up this PR before the new OS parts are ready, but I prepared all the current code, so swapping to that should be trivial. In this PR the new path is <rootDir>/<localUserId>/<hashedPartitionValue>.\nUnfortunately, it does mean that we will have another breaking BETA release as the locations on disk will change again once the OS PR is merged.", "createdAt": "2020-06-27T18:41:28Z", "url": "https://github.com/realm/realm-java/pull/6973", "merged": true, "mergeCommit": {"oid": "022fa93ae6ae127e576f0aef7493ff0187ee9d11"}, "closed": true, "closedAt": "2020-08-13T12:51:36Z", "author": {"login": "cmelchior"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvcPCCgH2gAyNDQwOTQ3Mjg2OmFmNWVjZWQzODI1MTEyNjZhNDkzNDM4Mjc3MzY3MzY4ZjhiN2MwNWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-fQurgH2gAyNDQwOTQ3Mjg2OmZkZDI3YmExM2M0MzlmMWIyZWQwNzM3NjBmNzc1OWE5YzgzOGMxNDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "af5eced382511266a493438277367368f8b7c05b", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/af5eced382511266a493438277367368f8b7c05b", "committedDate": "2020-06-27T18:34:17Z", "message": "Fix support for multiple Realms by the same user and let OS calculate the file path instead of doing it in Java."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6d84f6e532428afc4e6c875f1078432e8b67fd5", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/d6d84f6e532428afc4e6c875f1078432e8b67fd5", "committedDate": "2020-06-28T16:30:50Z", "message": "Fix test and Findbugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4OTI5NDA3", "url": "https://github.com/realm/realm-java/pull/6973#pullrequestreview-438929407", "createdAt": "2020-06-29T06:55:18Z", "commit": {"oid": "d6d84f6e532428afc4e6c875f1078432e8b67fd5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNjo1NToxOFrOGqHE-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNjo1NToxOFrOGqHE-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwOTMzNg==", "bodyText": "Was this one not intentionally left out to align feature set with other SDKs?\nI guess it could be added to the other SDKs with realm/realm-object-store#1049, but would it then also make sense to consider adding the directory method in the same go?", "url": "https://github.com/realm/realm-java/pull/6973#discussion_r446809336", "createdAt": "2020-06-29T06:55:18Z", "author": {"login": "rorbech"}, "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/sync/SyncConfiguration.java", "diffHunk": "@@ -592,8 +581,21 @@ private void validateAndSet(URL baseUrl ) {\n             } catch (URISyntaxException e) {\n                 throw new IllegalArgumentException(\"Invalid URI: \" + baseUrl, e);\n             }\n+        }\n+\n+        /**\n+         * FIXME: Make public once https://github.com/realm/realm-object-store/pull/1049 is merged.\n+         *\n+         * Sets the filename for the Realm file on this device.\n+         */\n+        Builder name(String filename) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6d84f6e532428afc4e6c875f1078432e8b67fd5"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6b956727bb78782004f957f214996e06f8e01cf", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/f6b956727bb78782004f957f214996e06f8e01cf", "committedDate": "2020-08-12T10:24:58Z", "message": "Add support for multiple partions for the same user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c360eaabeb07dbfa6a38c5ce0540c63954546f4", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/5c360eaabeb07dbfa6a38c5ce0540c63954546f4", "committedDate": "2020-08-12T10:32:42Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e88b146b9135378e21c086967c044989a6de9d4c", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/e88b146b9135378e21c086967c044989a6de9d4c", "committedDate": "2020-08-12T10:53:14Z", "message": "Merge branch 'v10' into cm/support-multiple-realms-pr-user\n\n# Conflicts:\n#\tCHANGELOG.md\n#\trealm/realm-library/src/androidTestObjectServer/kotlin/io/realm/UserTests.kt\n#\trealm/realm-library/src/androidTestObjectServer/kotlin/io/realm/mongodb/sync/SyncConfigurationTests.kt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "258c6642d7a5f1d66389086bd6a44a20486e5de4", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/258c6642d7a5f1d66389086bd6a44a20486e5de4", "committedDate": "2020-08-12T11:18:55Z", "message": "Fix compiler errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5203339b50473e45c29ce0da05412a72c274294c", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/5203339b50473e45c29ce0da05412a72c274294c", "committedDate": "2020-08-13T06:59:19Z", "message": "Fix unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12a74debd2dd40b842ae0b30714025c29d4c6e6b", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/12a74debd2dd40b842ae0b30714025c29d4c6e6b", "committedDate": "2020-08-13T08:08:27Z", "message": "Fix wrong logging interceptor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bd1fd898d4c97a973e53f3448f1d4a19f490181", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/3bd1fd898d4c97a973e53f3448f1d4a19f490181", "committedDate": "2020-08-13T08:41:00Z", "message": "Fix JVM test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NjQyMDMz", "url": "https://github.com/realm/realm-java/pull/6973#pullrequestreview-466642033", "createdAt": "2020-08-13T10:36:08Z", "commit": {"oid": "3bd1fd898d4c97a973e53f3448f1d4a19f490181"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMDozNjowOFrOHAF34w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMDozNjowOFrOHAF34w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg1ODI3NQ==", "bodyText": "Is this a relevant check? Wouldn't we have sufficient details even if the user is logged out? I give that the chances of actually needing the path in that case would be quite limited.", "url": "https://github.com/realm/realm-java/pull/6973#discussion_r469858275", "createdAt": "2020-08-13T10:36:08Z", "author": {"login": "rorbech"}, "path": "realm/realm-library/src/main/cpp/io_realm_mongodb_sync_Sync.cpp", "diffHunk": "@@ -73,3 +74,34 @@ JNIEXPORT void JNICALL Java_io_realm_mongodb_sync_Sync_nativeCreateSession(JNIEn\n     }\n     CATCH_STD()\n }\n+\n+JNIEXPORT jstring JNICALL Java_io_realm_mongodb_sync_Sync_nativeGetPathForRealm(JNIEnv* env,\n+                                                                                jclass,\n+                                                                                jstring j_user_id,\n+                                                                                jstring j_encoded_partition_value,\n+                                                                                jstring j_override_filename)\n+{\n+    try {\n+        // This is a little bit of a hack. Normally Realm Java doesn't generate the C++ SyncConfig\n+        // until the Realm is opened, but the Sync API for creating the Realm path require that\n+        // it is created up front. So we cheat and create a SyncConfig with the minimal values\n+        // needed for the path to be calculated.\n+        JStringAccessor user_id(env, j_user_id);\n+        std::shared_ptr<SyncUser> user = SyncManager::shared().get_existing_logged_in_user(user_id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bd1fd898d4c97a973e53f3448f1d4a19f490181"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdd27ba13c439f1b2ed073760f7759a9c838c148", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/fdd27ba13c439f1b2ed073760f7759a9c838c148", "committedDate": "2020-08-13T12:34:43Z", "message": "Add changelog entry"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2265, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}