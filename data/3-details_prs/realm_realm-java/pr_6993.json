{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2MDY5MDAx", "number": 6993, "title": "Enable and fix link user tests", "bodyText": "Enable and verify the tests for linking users.", "createdAt": "2020-07-08T08:05:05Z", "url": "https://github.com/realm/realm-java/pull/6993", "merged": true, "mergeCommit": {"oid": "a30d90fca455f4158f4a9f8649657c4e4cebc6af"}, "closed": true, "closedAt": "2020-07-29T08:35:21Z", "author": {"login": "clementetb"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcy1yYxAH2gAyNDQ2MDY5MDAxOjU3OGMxNjNiMDI4ZDMyZWUwOWM4ZTc2NTFhZTdlNWRiMmJkZTBjYjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5Hd7-AFqTQ1NjA5MzM0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "578c163b028d32ee09c8e7651ae7e5db2bde0cb5", "author": {"user": {"login": "clementetb", "name": null}}, "url": "https://github.com/realm/realm-java/commit/578c163b028d32ee09c8e7651ae7e5db2bde0cb5", "committedDate": "2020-07-08T08:02:18Z", "message": "Enable and fix link user tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NTA2NDAz", "url": "https://github.com/realm/realm-java/pull/6993#pullrequestreview-444506403", "createdAt": "2020-07-08T08:06:44Z", "commit": {"oid": "578c163b028d32ee09c8e7651ae7e5db2bde0cb5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODowNjo0NFrOGuczcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODowNjo0NFrOGuczcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM1OTYwMw==", "bodyText": "If the user had >1 identities a out of bounds exception was risen.", "url": "https://github.com/realm/realm-java/pull/6993#discussion_r451359603", "createdAt": "2020-07-08T08:06:44Z", "author": {"login": "clementetb"}, "path": "realm/realm-library/src/objectServer/java/io/realm/internal/objectstore/OsSyncUser.java", "diffHunk": "@@ -108,7 +108,7 @@ public String getRefreshToken() {\n         @SuppressWarnings(\"unchecked\")\n         Pair<String, String>[] identities = new Pair[identityData.length/2];\n         for (int i = 0; i < identityData.length; i = i + 2) {\n-            identities[i] = new Pair<>(identityData[i], identityData[i+1]);\n+            identities[i/2] = new Pair<>(identityData[i], identityData[i+1]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "578c163b028d32ee09c8e7651ae7e5db2bde0cb5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NTA3NDM1", "url": "https://github.com/realm/realm-java/pull/6993#pullrequestreview-444507435", "createdAt": "2020-07-08T08:08:11Z", "commit": {"oid": "578c163b028d32ee09c8e7651ae7e5db2bde0cb5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODowODoxMVrOGuc2ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODowODoxMVrOGuc2ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM2MDQ1MQ==", "bodyText": "While testing the error the app returns is an INVALID_SESSION instead of a BAD_REQUEST.\nChanged the test to match the returning error.", "url": "https://github.com/realm/realm-java/pull/6993#discussion_r451360451", "createdAt": "2020-07-08T08:08:11Z", "author": {"login": "clementetb"}, "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/UserTests.kt", "diffHunk": "@@ -183,34 +179,34 @@ class UserTests {\n         assertTrue(anonUser === linkedUser)\n         assertEquals(2, linkedUser.identities.size)\n         assertEquals(Credentials.IdentityProvider.EMAIL_PASSWORD, linkedUser.identities[1].provider)\n-        admin.setAutomaticConfirmation(enabled = true)\n \n         val otherEmail = TestHelper.getRandomEmail()\n         val otherPassword = \"123456\"\n         app.emailPasswordAuth.registerUser(otherEmail, otherPassword)\n-        linkedUser = anonUser.linkCredentials(Credentials.emailPassword(email, password))\n-        assertTrue(anonUser === linkedUser)\n-        assertEquals(3, linkedUser.identities.size)\n-        assertEquals(Credentials.IdentityProvider.EMAIL_PASSWORD, linkedUser.identities[2].provider)\n+\n+        val credentials = Credentials.emailPassword(otherEmail, otherPassword)\n+\n+        // Validate that we cannot link a second set of credentials\n+        assertFails {\n+            linkedUser = anonUser.linkCredentials(credentials)\n+        }\n+\n         admin.setAutomaticConfirmation(enabled = true)\n     }\n \n-    @Ignore(\"FIXME: Wait for linkUser support in ObjectStore\")\n     @Test\n     fun linkUser_existingCredentialsThrows() {\n         val email = TestHelper.getRandomEmail()\n         val password = \"123456\"\n         val emailUser: User = app.registerUserAndLogin(email, password)\n-        val anonymousUser: User = app.login(Credentials.anonymous())\n         try {\n-            anonymousUser.linkCredentials(Credentials.emailPassword(email, password))\n+            anonUser.linkCredentials(Credentials.emailPassword(email, password))\n             fail()\n         } catch (ex: AppException) {\n-            assertEquals(ErrorCode.BAD_REQUEST, ex.errorCode)\n+            assertEquals(ErrorCode.INVALID_SESSION, ex.errorCode)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "578c163b028d32ee09c8e7651ae7e5db2bde0cb5"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NTA4NTY2", "url": "https://github.com/realm/realm-java/pull/6993#pullrequestreview-444508566", "createdAt": "2020-07-08T08:09:46Z", "commit": {"oid": "578c163b028d32ee09c8e7651ae7e5db2bde0cb5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODowOTo0NlrOGuc6Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODowOTo0NlrOGuc6Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM2MTM2Nw==", "bodyText": "Users are limited to 1 local userpass credentials.\nServer error\nSERVICE_INTERNAL_SERVER_ERROR(realm::app::ServiceError:16): linking a local-userpass identity is not allowed when one is already linked\nModified it to validate that it should fail if we try to add a second one.", "url": "https://github.com/realm/realm-java/pull/6993#discussion_r451361367", "createdAt": "2020-07-08T08:09:46Z", "author": {"login": "clementetb"}, "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/UserTests.kt", "diffHunk": "@@ -183,34 +179,34 @@ class UserTests {\n         assertTrue(anonUser === linkedUser)\n         assertEquals(2, linkedUser.identities.size)\n         assertEquals(Credentials.IdentityProvider.EMAIL_PASSWORD, linkedUser.identities[1].provider)\n-        admin.setAutomaticConfirmation(enabled = true)\n \n         val otherEmail = TestHelper.getRandomEmail()\n         val otherPassword = \"123456\"\n         app.emailPasswordAuth.registerUser(otherEmail, otherPassword)\n-        linkedUser = anonUser.linkCredentials(Credentials.emailPassword(email, password))\n-        assertTrue(anonUser === linkedUser)\n-        assertEquals(3, linkedUser.identities.size)\n-        assertEquals(Credentials.IdentityProvider.EMAIL_PASSWORD, linkedUser.identities[2].provider)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "578c163b028d32ee09c8e7651ae7e5db2bde0cb5"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NzE1NTQ1", "url": "https://github.com/realm/realm-java/pull/6993#pullrequestreview-444715545", "createdAt": "2020-07-08T12:30:39Z", "commit": {"oid": "578c163b028d32ee09c8e7651ae7e5db2bde0cb5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMjozMDozOVrOGul0ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMjozMTo1NFrOGul3SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTUwNzMwMQ==", "bodyText": "Add more tests that link other credentials types and put them in different methods, e.g. fun linkUser_userApiKey().", "url": "https://github.com/realm/realm-java/pull/6993#discussion_r451507301", "createdAt": "2020-07-08T12:30:39Z", "author": {"login": "edualonso"}, "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/UserTests.kt", "diffHunk": "@@ -161,19 +160,16 @@ class UserTests {\n \n     @Test\n     fun logOutAsync_throwsOnNonLooperThread() {\n-        val user: User = app.login(Credentials.anonymous())\n         try {\n-            user.logOutAsync { fail() }\n+            anonUser.logOutAsync { fail() }\n             fail()\n         } catch (ignore: IllegalStateException) {\n         }\n     }\n \n-    @Ignore(\"FIXME: Wait for linkUser support in ObjectStore\")\n     @Test\n     fun linkUser() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "578c163b028d32ee09c8e7651ae7e5db2bde0cb5"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTUwODA0MA==", "bodyText": "I'm not sure whether this is expected or not. Maybe ask someone from the server team about adding more than one userpass credential and about the existence of limitations in the types/amount of credentials being linked?", "url": "https://github.com/realm/realm-java/pull/6993#discussion_r451508040", "createdAt": "2020-07-08T12:31:54Z", "author": {"login": "edualonso"}, "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/UserTests.kt", "diffHunk": "@@ -183,34 +179,34 @@ class UserTests {\n         assertTrue(anonUser === linkedUser)\n         assertEquals(2, linkedUser.identities.size)\n         assertEquals(Credentials.IdentityProvider.EMAIL_PASSWORD, linkedUser.identities[1].provider)\n-        admin.setAutomaticConfirmation(enabled = true)\n \n         val otherEmail = TestHelper.getRandomEmail()\n         val otherPassword = \"123456\"\n         app.emailPasswordAuth.registerUser(otherEmail, otherPassword)\n-        linkedUser = anonUser.linkCredentials(Credentials.emailPassword(email, password))\n-        assertTrue(anonUser === linkedUser)\n-        assertEquals(3, linkedUser.identities.size)\n-        assertEquals(Credentials.IdentityProvider.EMAIL_PASSWORD, linkedUser.identities[2].provider)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM2MTM2Nw=="}, "originalCommit": {"oid": "578c163b028d32ee09c8e7651ae7e5db2bde0cb5"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf397b3b1f6e3d45a5005e246d7991d41f4c06d4", "author": {"user": {"login": "clementetb", "name": null}}, "url": "https://github.com/realm/realm-java/commit/cf397b3b1f6e3d45a5005e246d7991d41f4c06d4", "committedDate": "2020-07-08T16:35:14Z", "message": "Add tests for apiKey and serverKey linkage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9a2c9d0e5385712128ed800c25fe230b230a88c", "author": {"user": {"login": "clementetb", "name": null}}, "url": "https://github.com/realm/realm-java/commit/c9a2c9d0e5385712128ed800c25fe230b230a88c", "committedDate": "2020-07-08T16:40:28Z", "message": "Add custom function credentials link test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ea3e86b36b0847a4157580ca6193dc2a7546f14", "author": {"user": {"login": "clementetb", "name": null}}, "url": "https://github.com/realm/realm-java/commit/1ea3e86b36b0847a4157580ca6193dc2a7546f14", "committedDate": "2020-07-22T10:12:21Z", "message": "Update credential link test cases to the expected behaviour"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMzcxODk0", "url": "https://github.com/realm/realm-java/pull/6993#pullrequestreview-453371894", "createdAt": "2020-07-22T14:26:55Z", "commit": {"oid": "1ea3e86b36b0847a4157580ca6193dc2a7546f14"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNDoyNjo1NVrOG1k_vA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNDoyNzozNFrOG1lBlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzMzg1Mg==", "bodyText": "This won't work. This file is used for JVM unit tests and the test helper is located inside the Android instrumentation test package, so it won't find it.", "url": "https://github.com/realm/realm-java/pull/6993#discussion_r458833852", "createdAt": "2020-07-22T14:26:55Z", "author": {"login": "edualonso"}, "path": "realm/realm-library/src/testObjectServer/kotlin/io/realm/ObfuscatorHelper.kt", "diffHunk": "@@ -53,9 +53,9 @@ object ObfuscatorHelper {\n \n     val CUSTOM_FUNCTION_ORIGINAL_INPUT = \"\"\"\n {\n-  \"mail\":\"myfakemail@mongodb.com\",\n+  \"mail\":\"${TestHelper.getRandomEmail()}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ea3e86b36b0847a4157580ca6193dc2a7546f14"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzNDExMQ==", "bodyText": "That's why the build is failing: https://ci.realm.io/blue/organizations/jenkins/realm%2Frealm-java/detail/PR-6993/4/pipeline/74", "url": "https://github.com/realm/realm-java/pull/6993#discussion_r458834111", "createdAt": "2020-07-22T14:27:17Z", "author": {"login": "edualonso"}, "path": "realm/realm-library/src/testObjectServer/kotlin/io/realm/ObfuscatorHelper.kt", "diffHunk": "@@ -53,9 +53,9 @@ object ObfuscatorHelper {\n \n     val CUSTOM_FUNCTION_ORIGINAL_INPUT = \"\"\"\n {\n-  \"mail\":\"myfakemail@mongodb.com\",\n+  \"mail\":\"${TestHelper.getRandomEmail()}\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzMzg1Mg=="}, "originalCommit": {"oid": "1ea3e86b36b0847a4157580ca6193dc2a7546f14"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzNDMyNw==", "bodyText": "Good catch", "url": "https://github.com/realm/realm-java/pull/6993#discussion_r458834327", "createdAt": "2020-07-22T14:27:34Z", "author": {"login": "edualonso"}, "path": "tools/sync_test_server/app_config/functions/testAuthFunc/source.js", "diffHunk": "@@ -1,7 +1,10 @@\n exports = ({mail, id}) => {\n-    if (mail != \"myfakemail@mongodb.com\" || id != 666) {\n+    // Auth function will fail for emails with a domain different to @androidtest.realm.io\n+    // or with id lower than 666\n+    if (!new RegExp(\"@androidtest.realm.io$\").test(mail) || id < 666) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ea3e86b36b0847a4157580ca6193dc2a7546f14"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f694fe6afe4ffb3e862b147c8e198841735b66a9", "author": {"user": {"login": "clementetb", "name": null}}, "url": "https://github.com/realm/realm-java/commit/f694fe6afe4ffb3e862b147c8e198841735b66a9", "committedDate": "2020-07-22T15:45:25Z", "message": "Fix missing dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "063fe73678c56d25b7c351131eaa13724789f17b", "author": {"user": {"login": "clementetb", "name": null}}, "url": "https://github.com/realm/realm-java/commit/063fe73678c56d25b7c351131eaa13724789f17b", "committedDate": "2020-07-27T15:08:20Z", "message": "Disable automatic confirmation from test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b29eb6abfd0ef12f3f59b4dd1385db0377a7bd77", "author": {"user": {"login": "clementetb", "name": null}}, "url": "https://github.com/realm/realm-java/commit/b29eb6abfd0ef12f3f59b4dd1385db0377a7bd77", "committedDate": "2020-07-27T15:41:32Z", "message": "Remove assert on error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcd396d4542e7528bd2222e3931b94c8d62f0d84", "author": {"user": {"login": "clementetb", "name": null}}, "url": "https://github.com/realm/realm-java/commit/bcd396d4542e7528bd2222e3931b94c8d62f0d84", "committedDate": "2020-07-27T15:56:56Z", "message": "Remove any checks on what kind of exception we get"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MDkzMzQ5", "url": "https://github.com/realm/realm-java/pull/6993#pullrequestreview-456093349", "createdAt": "2020-07-27T20:01:48Z", "commit": {"oid": "bcd396d4542e7528bd2222e3931b94c8d62f0d84"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2282, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}