{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNzI1ODEy", "number": 6935, "title": "Add support for push notifications", "bodyText": "Added a PushClient that allows clients to register/deregister for push notifications. The client is obtained through the User.", "createdAt": "2020-06-09T11:30:07Z", "url": "https://github.com/realm/realm-java/pull/6935", "merged": true, "mergeCommit": {"oid": "672a355e340b62d6a54a863e44eb864d27d05c92"}, "closed": true, "closedAt": "2020-06-11T07:37:05Z", "author": {"login": "edualonso"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcphqMiAH2gAyNDMxNzI1ODEyOjg0YjRjY2ZjNGIxNjViNWE4OGZkMGE1ZTkyNzc0ZjZmZGI5NDdkNjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqIrxQgFqTQyODYzODA2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "84b4ccfc4b165b5a88fd0a5e92774f6fdb947d66", "author": {"user": null}, "url": "https://github.com/realm/realm-java/commit/84b4ccfc4b165b5a88fd0a5e92774f6fdb947d66", "committedDate": "2020-06-09T09:29:56Z", "message": "Added support for push notifications"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a0eda4779a45340444456b0f648967bdb181cc3", "author": {"user": null}, "url": "https://github.com/realm/realm-java/commit/3a0eda4779a45340444456b0f648967bdb181cc3", "committedDate": "2020-06-09T09:44:52Z", "message": "Added OsPushClient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bb26cfa70b80c549a269286fb8d509b6a185e8a", "author": {"user": null}, "url": "https://github.com/realm/realm-java/commit/3bb26cfa70b80c549a269286fb8d509b6a185e8a", "committedDate": "2020-06-09T10:01:10Z", "message": "Removed unused includes in native code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77fb87e779149e523889986dc22856b21fa59b48", "author": {"user": null}, "url": "https://github.com/realm/realm-java/commit/77fb87e779149e523889986dc22856b21fa59b48", "committedDate": "2020-06-09T11:30:23Z", "message": "Added documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98efe0e0b7625dfea3eb28899752141cf294f417", "author": {"user": null}, "url": "https://github.com/realm/realm-java/commit/98efe0e0b7625dfea3eb28899752141cf294f417", "committedDate": "2020-06-09T20:56:00Z", "message": "Restore Gradle build tools version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c3d98f6d1fe83898621e1dd254b0e2d67a7aaa9", "author": {"user": null}, "url": "https://github.com/realm/realm-java/commit/7c3d98f6d1fe83898621e1dd254b0e2d67a7aaa9", "committedDate": "2020-06-09T20:58:15Z", "message": "Merge branch 'v10' into el/push-notifications"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de16065b8c670c535758d54287e83abb852f097b", "author": {"user": null}, "url": "https://github.com/realm/realm-java/commit/de16065b8c670c535758d54287e83abb852f097b", "committedDate": "2020-06-09T21:32:26Z", "message": "Removed FCM config file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c866a6fea9383c5d1ca7721c5159b540bc45dd7", "author": {"user": null}, "url": "https://github.com/realm/realm-java/commit/8c866a6fea9383c5d1ca7721c5159b540bc45dd7", "committedDate": "2020-06-10T08:15:49Z", "message": "Moved FCM config params to script instead of having them in the config files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NzU0MjEz", "url": "https://github.com/realm/realm-java/pull/6935#pullrequestreview-427754213", "createdAt": "2020-06-10T06:47:17Z", "commit": {"oid": "de16065b8c670c535758d54287e83abb852f097b"}, "state": "APPROVED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwNjo0NzoxN1rOGhm_Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwODoxNToyOFrOGhp7kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg5NDk0Nw==", "bodyText": "Any reason for not just letting an exception cause the test to fail. It will be easier to see what caused it if the exception is part of the report.", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r437894947", "createdAt": "2020-06-10T06:47:17Z", "author": {"login": "rorbech"}, "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/mongodb/push/PushClientTest.kt", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.mongodb.push\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.platform.app.InstrumentationRegistry\n+import io.realm.Realm\n+import io.realm.TestApp\n+import io.realm.TestHelper\n+import io.realm.mongodb.*\n+import io.realm.util.assertFailsWithErrorCode\n+import io.realm.util.blockingGetResult\n+import org.junit.After\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+import kotlin.test.assertFailsWith\n+import kotlin.test.assertTrue\n+import kotlin.test.fail\n+\n+private const val SERVICE_NAME = \"gcm\"      // it comes from the test server's gcm/config.json\n+private const val SAMPLE_TOKEN = \"fXXW6Qv0Tb2fgNf3pFOtqt:APA91bGs4YUXswCC2w8-X9tSdwo9-r6KwAeicP0FDJtBubyuFgorbAICNTftI4SbSSynvN0s-KVWXaGUo1eWuumkGJzFWngwuxQWWv5uolsfjidYz3kLEdiwWW0D_igtD5nRtYZu6gMW\"\n+\n+@RunWith(AndroidJUnit4::class)\n+class PushClientTest {\n+\n+    private lateinit var app: TestApp\n+    private lateinit var user: User\n+\n+    @Before\n+    fun setUp() {\n+        Realm.init(InstrumentationRegistry.getInstrumentation().targetContext)\n+\n+        app = TestApp()\n+        user = app.registerUserAndLogin(TestHelper.getRandomEmail(), \"123456\")\n+    }\n+\n+    @After\n+    fun tearDown() {\n+        if (this::app.isInitialized) {\n+            app.close()\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice() {\n+        var allGood = true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de16065b8c670c535758d54287e83abb852f097b"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg5NTM4OQ==", "bodyText": "Maybe add note on why this is something we need to have a test for.", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r437895389", "createdAt": "2020-06-10T06:48:15Z", "author": {"login": "rorbech"}, "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/mongodb/push/PushClientTest.kt", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.mongodb.push\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.platform.app.InstrumentationRegistry\n+import io.realm.Realm\n+import io.realm.TestApp\n+import io.realm.TestHelper\n+import io.realm.mongodb.*\n+import io.realm.util.assertFailsWithErrorCode\n+import io.realm.util.blockingGetResult\n+import org.junit.After\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+import kotlin.test.assertFailsWith\n+import kotlin.test.assertTrue\n+import kotlin.test.fail\n+\n+private const val SERVICE_NAME = \"gcm\"      // it comes from the test server's gcm/config.json\n+private const val SAMPLE_TOKEN = \"fXXW6Qv0Tb2fgNf3pFOtqt:APA91bGs4YUXswCC2w8-X9tSdwo9-r6KwAeicP0FDJtBubyuFgorbAICNTftI4SbSSynvN0s-KVWXaGUo1eWuumkGJzFWngwuxQWWv5uolsfjidYz3kLEdiwWW0D_igtD5nRtYZu6gMW\"\n+\n+@RunWith(AndroidJUnit4::class)\n+class PushClientTest {\n+\n+    private lateinit var app: TestApp\n+    private lateinit var user: User\n+\n+    @Before\n+    fun setUp() {\n+        Realm.init(InstrumentationRegistry.getInstrumentation().targetContext)\n+\n+        app = TestApp()\n+        user = app.registerUserAndLogin(TestHelper.getRandomEmail(), \"123456\")\n+    }\n+\n+    @After\n+    fun tearDown() {\n+        if (this::app.isInitialized) {\n+            app.close()\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice() {\n+        var allGood = true\n+        try {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            allGood = false\n+        }\n+        assertTrue(allGood)\n+    }\n+\n+    @Test\n+    fun registerDevice_twice() {\n+        var allGood = true\n+        try {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de16065b8c670c535758d54287e83abb852f097b"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg5NTgzNw==", "bodyText": "Not needed. Should be thrown by assertFailsWithErrorCode.", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r437895837", "createdAt": "2020-06-10T06:49:22Z", "author": {"login": "rorbech"}, "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/mongodb/push/PushClientTest.kt", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.mongodb.push\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.platform.app.InstrumentationRegistry\n+import io.realm.Realm\n+import io.realm.TestApp\n+import io.realm.TestHelper\n+import io.realm.mongodb.*\n+import io.realm.util.assertFailsWithErrorCode\n+import io.realm.util.blockingGetResult\n+import org.junit.After\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+import kotlin.test.assertFailsWith\n+import kotlin.test.assertTrue\n+import kotlin.test.fail\n+\n+private const val SERVICE_NAME = \"gcm\"      // it comes from the test server's gcm/config.json\n+private const val SAMPLE_TOKEN = \"fXXW6Qv0Tb2fgNf3pFOtqt:APA91bGs4YUXswCC2w8-X9tSdwo9-r6KwAeicP0FDJtBubyuFgorbAICNTftI4SbSSynvN0s-KVWXaGUo1eWuumkGJzFWngwuxQWWv5uolsfjidYz3kLEdiwWW0D_igtD5nRtYZu6gMW\"\n+\n+@RunWith(AndroidJUnit4::class)\n+class PushClientTest {\n+\n+    private lateinit var app: TestApp\n+    private lateinit var user: User\n+\n+    @Before\n+    fun setUp() {\n+        Realm.init(InstrumentationRegistry.getInstrumentation().targetContext)\n+\n+        app = TestApp()\n+        user = app.registerUserAndLogin(TestHelper.getRandomEmail(), \"123456\")\n+    }\n+\n+    @After\n+    fun tearDown() {\n+        if (this::app.isInitialized) {\n+            app.close()\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice() {\n+        var allGood = true\n+        try {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            allGood = false\n+        }\n+        assertTrue(allGood)\n+    }\n+\n+    @Test\n+    fun registerDevice_twice() {\n+        var allGood = true\n+        try {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            allGood = false\n+        }\n+        assertTrue(allGood)\n+    }\n+\n+    @Test\n+    fun registerDevice_throwsBecauseOfUnknownService() {\n+        assertFailsWithErrorCode(ErrorCode.SERVICE_NOT_FOUND) {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, \"asdf\").blockingGetResult()\n+            fail(\"should never reach this\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de16065b8c670c535758d54287e83abb852f097b"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg5NjQ0Nw==", "bodyText": "The test is called deregister, but calls registerDevice??", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r437896447", "createdAt": "2020-06-10T06:50:46Z", "author": {"login": "rorbech"}, "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/mongodb/push/PushClientTest.kt", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.mongodb.push\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.platform.app.InstrumentationRegistry\n+import io.realm.Realm\n+import io.realm.TestApp\n+import io.realm.TestHelper\n+import io.realm.mongodb.*\n+import io.realm.util.assertFailsWithErrorCode\n+import io.realm.util.blockingGetResult\n+import org.junit.After\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+import kotlin.test.assertFailsWith\n+import kotlin.test.assertTrue\n+import kotlin.test.fail\n+\n+private const val SERVICE_NAME = \"gcm\"      // it comes from the test server's gcm/config.json\n+private const val SAMPLE_TOKEN = \"fXXW6Qv0Tb2fgNf3pFOtqt:APA91bGs4YUXswCC2w8-X9tSdwo9-r6KwAeicP0FDJtBubyuFgorbAICNTftI4SbSSynvN0s-KVWXaGUo1eWuumkGJzFWngwuxQWWv5uolsfjidYz3kLEdiwWW0D_igtD5nRtYZu6gMW\"\n+\n+@RunWith(AndroidJUnit4::class)\n+class PushClientTest {\n+\n+    private lateinit var app: TestApp\n+    private lateinit var user: User\n+\n+    @Before\n+    fun setUp() {\n+        Realm.init(InstrumentationRegistry.getInstrumentation().targetContext)\n+\n+        app = TestApp()\n+        user = app.registerUserAndLogin(TestHelper.getRandomEmail(), \"123456\")\n+    }\n+\n+    @After\n+    fun tearDown() {\n+        if (this::app.isInitialized) {\n+            app.close()\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice() {\n+        var allGood = true\n+        try {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            allGood = false\n+        }\n+        assertTrue(allGood)\n+    }\n+\n+    @Test\n+    fun registerDevice_twice() {\n+        var allGood = true\n+        try {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            allGood = false\n+        }\n+        assertTrue(allGood)\n+    }\n+\n+    @Test\n+    fun registerDevice_throwsBecauseOfUnknownService() {\n+        assertFailsWithErrorCode(ErrorCode.SERVICE_NOT_FOUND) {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, \"asdf\").blockingGetResult()\n+            fail(\"should never reach this\")\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice_throwsBecauseOfLoggedOutUser() {\n+        user.logOut()\n+        assertFailsWithErrorCode(ErrorCode.SERVICE_UNKNOWN) {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+            fail(\"should never reach this\")\n+        }\n+    }\n+\n+    @Test\n+    fun deregisterDevice() {\n+        var allGood = true\n+        try {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de16065b8c670c535758d54287e83abb852f097b"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg5NjgwNg==", "bodyText": "Name of test seems off compared to what it actually does.", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r437896806", "createdAt": "2020-06-10T06:51:40Z", "author": {"login": "rorbech"}, "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/mongodb/push/PushClientTest.kt", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.mongodb.push\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.platform.app.InstrumentationRegistry\n+import io.realm.Realm\n+import io.realm.TestApp\n+import io.realm.TestHelper\n+import io.realm.mongodb.*\n+import io.realm.util.assertFailsWithErrorCode\n+import io.realm.util.blockingGetResult\n+import org.junit.After\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+import kotlin.test.assertFailsWith\n+import kotlin.test.assertTrue\n+import kotlin.test.fail\n+\n+private const val SERVICE_NAME = \"gcm\"      // it comes from the test server's gcm/config.json\n+private const val SAMPLE_TOKEN = \"fXXW6Qv0Tb2fgNf3pFOtqt:APA91bGs4YUXswCC2w8-X9tSdwo9-r6KwAeicP0FDJtBubyuFgorbAICNTftI4SbSSynvN0s-KVWXaGUo1eWuumkGJzFWngwuxQWWv5uolsfjidYz3kLEdiwWW0D_igtD5nRtYZu6gMW\"\n+\n+@RunWith(AndroidJUnit4::class)\n+class PushClientTest {\n+\n+    private lateinit var app: TestApp\n+    private lateinit var user: User\n+\n+    @Before\n+    fun setUp() {\n+        Realm.init(InstrumentationRegistry.getInstrumentation().targetContext)\n+\n+        app = TestApp()\n+        user = app.registerUserAndLogin(TestHelper.getRandomEmail(), \"123456\")\n+    }\n+\n+    @After\n+    fun tearDown() {\n+        if (this::app.isInitialized) {\n+            app.close()\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice() {\n+        var allGood = true\n+        try {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            allGood = false\n+        }\n+        assertTrue(allGood)\n+    }\n+\n+    @Test\n+    fun registerDevice_twice() {\n+        var allGood = true\n+        try {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            allGood = false\n+        }\n+        assertTrue(allGood)\n+    }\n+\n+    @Test\n+    fun registerDevice_throwsBecauseOfUnknownService() {\n+        assertFailsWithErrorCode(ErrorCode.SERVICE_NOT_FOUND) {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, \"asdf\").blockingGetResult()\n+            fail(\"should never reach this\")\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice_throwsBecauseOfLoggedOutUser() {\n+        user.logOut()\n+        assertFailsWithErrorCode(ErrorCode.SERVICE_UNKNOWN) {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+            fail(\"should never reach this\")\n+        }\n+    }\n+\n+    @Test\n+    fun deregisterDevice() {\n+        var allGood = true\n+        try {\n+            user.pushNotifications.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            allGood = false\n+        }\n+        assertTrue(allGood)\n+    }\n+\n+    @Test\n+    fun deregisterDevice_twice() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de16065b8c670c535758d54287e83abb852f097b"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg5ODQyNg==", "bodyText": "Do not know if this is expensive, but you could just allocate it when needed. I image it to be quite common not always needing a PushClient or MongoClient.", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r437898426", "createdAt": "2020-06-10T06:55:31Z", "author": {"login": "rorbech"}, "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/User.java", "diffHunk": "@@ -59,6 +60,8 @@\n     private ApiKeyAuth apiKeyAuthProvider = null;\n     private MongoClient mongoClient = null;\n     private Functions functions = null;\n+    private PushClient pushClient = null;\n+    private TaskDispatcher dispatcher = new TaskDispatcher();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de16065b8c670c535758d54287e83abb852f097b"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg5OTg0Mw==", "bodyText": "I guess it will probably not lead to incorrect behavior, but could consider synchronizing to avoid creating multiple instance on races.", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r437899843", "createdAt": "2020-06-10T06:58:47Z", "author": {"login": "rorbech"}, "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/User.java", "diffHunk": "@@ -505,10 +514,14 @@ public Functions getFunctions(CodecRegistry codecRegistry) {\n     }\n \n     /**\n-     * FIXME Add support for push notifications.\n+     * Returns the {@link PushClient} instance for allowing support for push notifications.\n      */\n-    Push getPush() {\n-        return null;\n+    public PushClient getPushNotifications() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de16065b8c670c535758d54287e83abb852f097b"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkwMDM4MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Returns the {@link PushClient} instance for allowing support for push notifications.\n          \n          \n            \n                 * Returns the {@link PushClient} instance for managing push notification registrations.", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r437900380", "createdAt": "2020-06-10T06:59:57Z", "author": {"login": "rorbech"}, "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/User.java", "diffHunk": "@@ -505,10 +514,14 @@ public Functions getFunctions(CodecRegistry codecRegistry) {\n     }\n \n     /**\n-     * FIXME Add support for push notifications.\n+     * Returns the {@link PushClient} instance for allowing support for push notifications.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de16065b8c670c535758d54287e83abb852f097b"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkzNjEyNQ==", "bodyText": "Is it safe to have these here, or should we move them to a local environment variable?", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r437936125", "createdAt": "2020-06-10T08:03:56Z", "author": {"login": "rorbech"}, "path": "tools/sync_test_server/setup_mongodb_realm.sh", "diffHunk": "@@ -59,6 +59,14 @@ stitch-cli secrets add \\\n                   --base-url=http://localhost:9090 \\\n                   --config-path=/tmp/stitch-config\n \n+#    - b) Firebase Cloud Messaging: create your own app and paste the \"server key\" here\n+stitch-cli secrets add \\\n+                  --name=\"FCM\" \\\n+                  --value=\"AAAAQLogIEA:APA91bGq5nvqcwR0NE3aQKADal14gP9sFS9MJ28JFqXeJ8h8kffHUaQ2GnpWFzbPRRCQn4P2Ux_HGTWJ9xxgZUmkv-Stcl4-Nbj3vcLOQP253wdzsQsc3dSIDKG53eWxTXWMr0_uleAE\" \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de16065b8c670c535758d54287e83abb852f097b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkzODE2Nw==", "bodyText": "According to the decision log this should be Push, so maybe check up on the naming.", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r437938167", "createdAt": "2020-06-10T08:07:13Z", "author": {"login": "rorbech"}, "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/push/PushClient.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.realm.mongodb.push;\n+\n+import com.google.android.gms.tasks.Task;\n+\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import io.realm.annotations.Beta;\n+import io.realm.internal.common.TaskDispatcher;\n+import io.realm.internal.jni.OsJNIVoidResultCallback;\n+import io.realm.internal.network.ResultHandler;\n+import io.realm.internal.objectstore.OsPushClient;\n+import io.realm.mongodb.AppException;\n+\n+/**\n+ * The PushClient allows to register/deregister for push notifications from a client app.\n+ */\n+@Beta\n+public abstract class PushClient {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de16065b8c670c535758d54287e83abb852f097b"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk0MzE4Ng==", "bodyText": "Since there is not results involved here, we could might as well go directly for RealmAsyncTask. But then we would probably need both a sync and async. Maybe just tag it with a TODO linking it to the task of aligning async API for now!?", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r437943186", "createdAt": "2020-06-10T08:15:28Z", "author": {"login": "rorbech"}, "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/push/PushClient.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.realm.mongodb.push;\n+\n+import com.google.android.gms.tasks.Task;\n+\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import io.realm.annotations.Beta;\n+import io.realm.internal.common.TaskDispatcher;\n+import io.realm.internal.jni.OsJNIVoidResultCallback;\n+import io.realm.internal.network.ResultHandler;\n+import io.realm.internal.objectstore.OsPushClient;\n+import io.realm.mongodb.AppException;\n+\n+/**\n+ * The PushClient allows to register/deregister for push notifications from a client app.\n+ */\n+@Beta\n+public abstract class PushClient {\n+\n+    private final TaskDispatcher dispatcher;\n+    private final OsPushClient osPushClient;\n+\n+    public PushClient(final OsPushClient osPushClient, TaskDispatcher dispatcher) {\n+        this.osPushClient = osPushClient;\n+        this.dispatcher = dispatcher;\n+    }\n+\n+    /**\n+     * Registers the given FCM registration token with the currently logged in user's\n+     * device on MongoDB Realm.\n+     *\n+     * @param registrationToken the registration token to register.\n+     * @return A {@link Task} that completes when the registration is finished.\n+     */\n+    public Task<Void> registerDevice(String registrationToken, String serviceName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de16065b8c670c535758d54287e83abb852f097b"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eea3d0c5313950258615a91e294540dd69e4ed3", "author": {"user": null}, "url": "https://github.com/realm/realm-java/commit/4eea3d0c5313950258615a91e294540dd69e4ed3", "committedDate": "2020-06-10T09:34:17Z", "message": "Removed rest of needed push test parameters from config files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "115f2668606eca7d65966e27523605ce22c815a9", "author": {"user": null}, "url": "https://github.com/realm/realm-java/commit/115f2668606eca7d65966e27523605ce22c815a9", "committedDate": "2020-06-10T09:59:52Z", "message": "Restored server config to not use FCM app keys but placeholder values instead"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "236c0eff6e9872fb84d78aca2f84034c86503240", "author": {"user": null}, "url": "https://github.com/realm/realm-java/commit/236c0eff6e9872fb84d78aca2f84034c86503240", "committedDate": "2020-06-10T10:02:34Z", "message": "Addressed comments from PR review: renamed client to Push, corrected wrong operations in tests and a bit of cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MDA1MjQ0", "url": "https://github.com/realm/realm-java/pull/6935#pullrequestreview-428005244", "createdAt": "2020-06-10T12:34:06Z", "commit": {"oid": "236c0eff6e9872fb84d78aca2f84034c86503240"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjozNDowNlrOGhyodg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjo0MTozM1rOGhy49g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA4NTc1MA==", "bodyText": "This isn't needed... an uncaught exception will fail the test", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r438085750", "createdAt": "2020-06-10T12:34:06Z", "author": {"login": "cmelchior"}, "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/mongodb/push/PushTest.kt", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.mongodb.push\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.platform.app.InstrumentationRegistry\n+import io.realm.Realm\n+import io.realm.TestApp\n+import io.realm.TestHelper\n+import io.realm.mongodb.ErrorCode\n+import io.realm.mongodb.User\n+import io.realm.mongodb.close\n+import io.realm.mongodb.registerUserAndLogin\n+import io.realm.util.assertFailsWithErrorCode\n+import io.realm.util.blockingGetResult\n+import org.junit.After\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+import kotlin.test.fail\n+\n+private const val SERVICE_NAME = \"gcm\"      // it comes from the test server's gcm/config.json\n+private const val SAMPLE_TOKEN = \"fXXW6Qv0Tb2fgNf3pFOtqt:APA91bGs4YUXswCC2w8-X9tSdwo9-r6KwAeicP0FDJtBubyuFgorbAICNTftI4SbSSynvN0s-KVWXaGUo1eWuumkGJzFWngwuxQWWv5uolsfjidYz3kLEdiwWW0D_igtD5nRtYZu6gMW\"\n+\n+@RunWith(AndroidJUnit4::class)\n+class PushTest {\n+\n+    private lateinit var app: TestApp\n+    private lateinit var user: User\n+\n+    @Before\n+    fun setUp() {\n+        Realm.init(InstrumentationRegistry.getInstrumentation().targetContext)\n+\n+        app = TestApp()\n+        user = app.registerUserAndLogin(TestHelper.getRandomEmail(), \"123456\")\n+    }\n+\n+    @After\n+    fun tearDown() {\n+        if (this::app.isInitialized) {\n+            app.close()\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice() {\n+        try {\n+            user.push.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            fail(e.toString())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "236c0eff6e9872fb84d78aca2f84034c86503240"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA4NTk1NQ==", "bodyText": "Unnecessary", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r438085955", "createdAt": "2020-06-10T12:34:32Z", "author": {"login": "cmelchior"}, "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/mongodb/push/PushTest.kt", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.mongodb.push\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.platform.app.InstrumentationRegistry\n+import io.realm.Realm\n+import io.realm.TestApp\n+import io.realm.TestHelper\n+import io.realm.mongodb.ErrorCode\n+import io.realm.mongodb.User\n+import io.realm.mongodb.close\n+import io.realm.mongodb.registerUserAndLogin\n+import io.realm.util.assertFailsWithErrorCode\n+import io.realm.util.blockingGetResult\n+import org.junit.After\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+import kotlin.test.fail\n+\n+private const val SERVICE_NAME = \"gcm\"      // it comes from the test server's gcm/config.json\n+private const val SAMPLE_TOKEN = \"fXXW6Qv0Tb2fgNf3pFOtqt:APA91bGs4YUXswCC2w8-X9tSdwo9-r6KwAeicP0FDJtBubyuFgorbAICNTftI4SbSSynvN0s-KVWXaGUo1eWuumkGJzFWngwuxQWWv5uolsfjidYz3kLEdiwWW0D_igtD5nRtYZu6gMW\"\n+\n+@RunWith(AndroidJUnit4::class)\n+class PushTest {\n+\n+    private lateinit var app: TestApp\n+    private lateinit var user: User\n+\n+    @Before\n+    fun setUp() {\n+        Realm.init(InstrumentationRegistry.getInstrumentation().targetContext)\n+\n+        app = TestApp()\n+        user = app.registerUserAndLogin(TestHelper.getRandomEmail(), \"123456\")\n+    }\n+\n+    @After\n+    fun tearDown() {\n+        if (this::app.isInitialized) {\n+            app.close()\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice() {\n+        try {\n+            user.push.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            fail(e.toString())\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice_twice() {\n+        // the API allows registering/deregistering twice, just checking we don't get errors\n+        try {\n+            user.push.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+            user.push.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            fail(e.toString())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "236c0eff6e9872fb84d78aca2f84034c86503240"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA4NjUwOQ==", "bodyText": "Unnecessary", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r438086509", "createdAt": "2020-06-10T12:35:33Z", "author": {"login": "cmelchior"}, "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/mongodb/push/PushTest.kt", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.mongodb.push\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.platform.app.InstrumentationRegistry\n+import io.realm.Realm\n+import io.realm.TestApp\n+import io.realm.TestHelper\n+import io.realm.mongodb.ErrorCode\n+import io.realm.mongodb.User\n+import io.realm.mongodb.close\n+import io.realm.mongodb.registerUserAndLogin\n+import io.realm.util.assertFailsWithErrorCode\n+import io.realm.util.blockingGetResult\n+import org.junit.After\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+import kotlin.test.fail\n+\n+private const val SERVICE_NAME = \"gcm\"      // it comes from the test server's gcm/config.json\n+private const val SAMPLE_TOKEN = \"fXXW6Qv0Tb2fgNf3pFOtqt:APA91bGs4YUXswCC2w8-X9tSdwo9-r6KwAeicP0FDJtBubyuFgorbAICNTftI4SbSSynvN0s-KVWXaGUo1eWuumkGJzFWngwuxQWWv5uolsfjidYz3kLEdiwWW0D_igtD5nRtYZu6gMW\"\n+\n+@RunWith(AndroidJUnit4::class)\n+class PushTest {\n+\n+    private lateinit var app: TestApp\n+    private lateinit var user: User\n+\n+    @Before\n+    fun setUp() {\n+        Realm.init(InstrumentationRegistry.getInstrumentation().targetContext)\n+\n+        app = TestApp()\n+        user = app.registerUserAndLogin(TestHelper.getRandomEmail(), \"123456\")\n+    }\n+\n+    @After\n+    fun tearDown() {\n+        if (this::app.isInitialized) {\n+            app.close()\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice() {\n+        try {\n+            user.push.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            fail(e.toString())\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice_twice() {\n+        // the API allows registering/deregistering twice, just checking we don't get errors\n+        try {\n+            user.push.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+            user.push.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            fail(e.toString())\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice_throwsBecauseOfUnknownService() {\n+        assertFailsWithErrorCode(ErrorCode.SERVICE_NOT_FOUND) {\n+            user.push.registerDevice(SAMPLE_TOKEN, \"asdf\").blockingGetResult()\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice_throwsBecauseOfLoggedOutUser() {\n+        user.logOut()\n+        assertFailsWithErrorCode(ErrorCode.SERVICE_UNKNOWN) {\n+            user.push.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        }\n+    }\n+\n+    @Test\n+    fun deregisterDevice() {\n+        try {\n+            user.push.deregisterDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            fail(e.toString())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "236c0eff6e9872fb84d78aca2f84034c86503240"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA4NjU3OQ==", "bodyText": "Unnecessary", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r438086579", "createdAt": "2020-06-10T12:35:40Z", "author": {"login": "cmelchior"}, "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/mongodb/push/PushTest.kt", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.mongodb.push\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.platform.app.InstrumentationRegistry\n+import io.realm.Realm\n+import io.realm.TestApp\n+import io.realm.TestHelper\n+import io.realm.mongodb.ErrorCode\n+import io.realm.mongodb.User\n+import io.realm.mongodb.close\n+import io.realm.mongodb.registerUserAndLogin\n+import io.realm.util.assertFailsWithErrorCode\n+import io.realm.util.blockingGetResult\n+import org.junit.After\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+import kotlin.test.fail\n+\n+private const val SERVICE_NAME = \"gcm\"      // it comes from the test server's gcm/config.json\n+private const val SAMPLE_TOKEN = \"fXXW6Qv0Tb2fgNf3pFOtqt:APA91bGs4YUXswCC2w8-X9tSdwo9-r6KwAeicP0FDJtBubyuFgorbAICNTftI4SbSSynvN0s-KVWXaGUo1eWuumkGJzFWngwuxQWWv5uolsfjidYz3kLEdiwWW0D_igtD5nRtYZu6gMW\"\n+\n+@RunWith(AndroidJUnit4::class)\n+class PushTest {\n+\n+    private lateinit var app: TestApp\n+    private lateinit var user: User\n+\n+    @Before\n+    fun setUp() {\n+        Realm.init(InstrumentationRegistry.getInstrumentation().targetContext)\n+\n+        app = TestApp()\n+        user = app.registerUserAndLogin(TestHelper.getRandomEmail(), \"123456\")\n+    }\n+\n+    @After\n+    fun tearDown() {\n+        if (this::app.isInitialized) {\n+            app.close()\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice() {\n+        try {\n+            user.push.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            fail(e.toString())\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice_twice() {\n+        // the API allows registering/deregistering twice, just checking we don't get errors\n+        try {\n+            user.push.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+            user.push.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            fail(e.toString())\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice_throwsBecauseOfUnknownService() {\n+        assertFailsWithErrorCode(ErrorCode.SERVICE_NOT_FOUND) {\n+            user.push.registerDevice(SAMPLE_TOKEN, \"asdf\").blockingGetResult()\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice_throwsBecauseOfLoggedOutUser() {\n+        user.logOut()\n+        assertFailsWithErrorCode(ErrorCode.SERVICE_UNKNOWN) {\n+            user.push.registerDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        }\n+    }\n+\n+    @Test\n+    fun deregisterDevice() {\n+        try {\n+            user.push.deregisterDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            fail(e.toString())\n+        }\n+    }\n+\n+    @Test\n+    fun deregisterDevice_twice() {\n+        // the API allows registering/deregistering twice, just checking we don't get errors\n+        try {\n+            user.push.deregisterDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+            user.push.deregisterDevice(SAMPLE_TOKEN, SERVICE_NAME).blockingGetResult()\n+        } catch (e: Exception) {\n+            fail(e.toString())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "236c0eff6e9872fb84d78aca2f84034c86503240"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA4OTk3NA==", "bodyText": "IMO we should use the registerDevice/registerDeviceAsync pattern just like for Functions instead of the Task interface. Or is there a reason you opted for the Task here?\nUsing the Task pattern requires people to bring their own threading and we just kept it for the Mongo API's as we assumed people would already have infrastructure in place for those legacy API's, but IMO the sync/async pattern is easier to consume for new users.\nThoughts?", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r438089974", "createdAt": "2020-06-10T12:41:33Z", "author": {"login": "cmelchior"}, "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/push/Push.java", "diffHunk": "@@ -15,11 +15,60 @@\n  */\n package io.realm.mongodb.push;\n \n+import com.google.android.gms.tasks.Task;\n+\n+import java.util.concurrent.Callable;\n+\n import io.realm.annotations.Beta;\n+import io.realm.internal.common.TaskDispatcher;\n+import io.realm.internal.objectstore.OsPush;\n \n /**\n- * FIXME: Add Javadoc and implementation\n+ * The Push client allows to register/deregister for push notifications from a client app.\n  */\n @Beta\n-public class Push {\n+public abstract class Push {\n+\n+    private final TaskDispatcher dispatcher;\n+    private final OsPush osPush;\n+\n+    public Push(final OsPush osPush, TaskDispatcher dispatcher) {\n+        this.osPush = osPush;\n+        this.dispatcher = dispatcher;\n+    }\n+\n+    // TODO: Task vs RealmAsyncTask - https://github.com/realm/realm-java/issues/6914\n+    /**\n+     * Registers the given FCM registration token with the currently logged in user's\n+     * device on MongoDB Realm.\n+     *\n+     * @param registrationToken the registration token to register.\n+     * @return A {@link Task} that completes when the registration is finished.\n+     */\n+    public Task<Void> registerDevice(String registrationToken, String serviceName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "236c0eff6e9872fb84d78aca2f84034c86503240"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "252168d1e47b418e334be74ea5a0f7033f34040b", "author": {"user": null}, "url": "https://github.com/realm/realm-java/commit/252168d1e47b418e334be74ea5a0f7033f34040b", "committedDate": "2020-06-10T12:42:40Z", "message": "Added synchronized to mongoclient as well"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MDEzMjQx", "url": "https://github.com/realm/realm-java/pull/6935#pullrequestreview-428013241", "createdAt": "2020-06-10T12:44:35Z", "commit": {"oid": "252168d1e47b418e334be74ea5a0f7033f34040b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjo0NDozNVrOGhzAEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjo0NDo0NFrOGhzAWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA5MTc5Mg==", "bodyText": "It shouldn't take the current user, the user should be provided as an argument", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r438091792", "createdAt": "2020-06-10T12:44:35Z", "author": {"login": "cmelchior"}, "path": "realm/realm-library/src/main/cpp/io_realm_internal_objectstore_OsPush.cpp", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+#include \"io_realm_internal_objectstore_OsPush.h\"\n+\n+#include \"java_class_global_def.hpp\"\n+#include \"java_network_transport.hpp\"\n+#include \"util.hpp\"\n+#include \"jni_util/java_method.hpp\"\n+#include \"jni_util/jni_utils.hpp\"\n+\n+#include <realm/util/optional.hpp>\n+#include <sync/app.hpp>\n+#include <jni.h>\n+\n+using namespace realm;\n+using namespace realm::app;\n+using namespace realm::bson;\n+using namespace realm::jni_util;\n+using namespace realm::_impl;\n+\n+static void finalize_push_client(jlong ptr) {\n+    delete reinterpret_cast<PushClient*>(ptr);\n+}\n+\n+JNIEXPORT jlong JNICALL\n+Java_io_realm_internal_objectstore_OsPush_nativeGetFinalizerMethodPtr(JNIEnv*, jclass) {\n+    return reinterpret_cast<jlong>(&finalize_push_client);\n+}\n+\n+JNIEXPORT void JNICALL\n+Java_io_realm_internal_objectstore_OsPush_nativeRegisterDevice(JNIEnv *env,\n+                                                               jclass,\n+                                                               jlong j_app_ptr,\n+                                                               jstring j_service_name,\n+                                                               jstring j_registration_token,\n+                                                               jobject j_callback) {\n+    try {\n+        std::shared_ptr<App> &app = *reinterpret_cast<std::shared_ptr<App> *>(j_app_ptr);\n+\n+        JStringAccessor service_name(env, j_service_name);\n+        JStringAccessor registration_token(env, j_registration_token);\n+\n+        app->push_notification_client(service_name)\n+                .register_device(registration_token,\n+                                 app->current_user(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "252168d1e47b418e334be74ea5a0f7033f34040b"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA5MTg2Nw==", "bodyText": "It shouldn't take the current user, the user should be provided as an argument", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r438091867", "createdAt": "2020-06-10T12:44:44Z", "author": {"login": "cmelchior"}, "path": "realm/realm-library/src/main/cpp/io_realm_internal_objectstore_OsPush.cpp", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+#include \"io_realm_internal_objectstore_OsPush.h\"\n+\n+#include \"java_class_global_def.hpp\"\n+#include \"java_network_transport.hpp\"\n+#include \"util.hpp\"\n+#include \"jni_util/java_method.hpp\"\n+#include \"jni_util/jni_utils.hpp\"\n+\n+#include <realm/util/optional.hpp>\n+#include <sync/app.hpp>\n+#include <jni.h>\n+\n+using namespace realm;\n+using namespace realm::app;\n+using namespace realm::bson;\n+using namespace realm::jni_util;\n+using namespace realm::_impl;\n+\n+static void finalize_push_client(jlong ptr) {\n+    delete reinterpret_cast<PushClient*>(ptr);\n+}\n+\n+JNIEXPORT jlong JNICALL\n+Java_io_realm_internal_objectstore_OsPush_nativeGetFinalizerMethodPtr(JNIEnv*, jclass) {\n+    return reinterpret_cast<jlong>(&finalize_push_client);\n+}\n+\n+JNIEXPORT void JNICALL\n+Java_io_realm_internal_objectstore_OsPush_nativeRegisterDevice(JNIEnv *env,\n+                                                               jclass,\n+                                                               jlong j_app_ptr,\n+                                                               jstring j_service_name,\n+                                                               jstring j_registration_token,\n+                                                               jobject j_callback) {\n+    try {\n+        std::shared_ptr<App> &app = *reinterpret_cast<std::shared_ptr<App> *>(j_app_ptr);\n+\n+        JStringAccessor service_name(env, j_service_name);\n+        JStringAccessor registration_token(env, j_registration_token);\n+\n+        app->push_notification_client(service_name)\n+                .register_device(registration_token,\n+                                 app->current_user(),\n+                                 JavaNetworkTransport::create_void_callback(env, j_callback));\n+    }\n+    CATCH_STD()\n+}\n+\n+JNIEXPORT void JNICALL\n+Java_io_realm_internal_objectstore_OsPush_nativeDeregisterDevice(JNIEnv *env,\n+                                                                 jclass,\n+                                                                 jlong j_app_ptr,\n+                                                                 jstring j_service_name,\n+                                                                 jstring j_registration_token,\n+                                                                 jobject j_callback) {\n+    try {\n+        std::shared_ptr<App> &app = *reinterpret_cast<std::shared_ptr<App> *>(j_app_ptr);\n+\n+        JStringAccessor service_name(env, j_service_name);\n+        JStringAccessor registration_token(env, j_registration_token);\n+\n+        app->push_notification_client(service_name)\n+                .deregister_device(registration_token,\n+                                   app->current_user(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "252168d1e47b418e334be74ea5a0f7033f34040b"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd1a807af030aafb609921690051678d2d300ef4", "author": {"user": null}, "url": "https://github.com/realm/realm-java/commit/cd1a807af030aafb609921690051678d2d300ef4", "committedDate": "2020-06-10T14:53:18Z", "message": "Removed Task and favour a sync/async implementation instead. Removed currentUser and use a pointer to a user instead. Fixed wrong initialisation of push client from the Java side, as I was unknowingly instantiating a native PushClient with every register/deregister call."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NjM4MDY2", "url": "https://github.com/realm/realm-java/pull/6935#pullrequestreview-428638066", "createdAt": "2020-06-11T06:55:16Z", "commit": {"oid": "cd1a807af030aafb609921690051678d2d300ef4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNjo1NToxNlrOGiQvbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNjo1NToxNlrOGiQvbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3OTA1NQ==", "bodyText": "Nitpick, but you can use\nfun registerDeviceAsync = looperThread.runBlocking {\n\n}\n\nSyntax to save a few lines in these cases", "url": "https://github.com/realm/realm-java/pull/6935#discussion_r438579055", "createdAt": "2020-06-11T06:55:16Z", "author": {"login": "cmelchior"}, "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/mongodb/push/PushTest.kt", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.mongodb.push\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.platform.app.InstrumentationRegistry\n+import io.realm.Realm\n+import io.realm.TestApp\n+import io.realm.TestHelper\n+import io.realm.mongodb.ErrorCode\n+import io.realm.mongodb.User\n+import io.realm.mongodb.close\n+import io.realm.mongodb.registerUserAndLogin\n+import io.realm.rule.BlockingLooperThread\n+import io.realm.util.assertFailsWithErrorCode\n+import org.junit.After\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+import kotlin.test.assertEquals\n+import kotlin.test.assertFailsWith\n+\n+private const val SERVICE_NAME = \"gcm\"      // it comes from the test server's gcm/config.json\n+private const val SAMPLE_TOKEN = \"fXXW6Qv0Tb2fgNf3pFOtqt:APA91bGs4YUXswCC2w8-X9tSdwo9-r6KwAeicP0FDJtBubyuFgorbAICNTftI4SbSSynvN0s-KVWXaGUo1eWuumkGJzFWngwuxQWWv5uolsfjidYz3kLEdiwWW0D_igtD5nRtYZu6gMW\"\n+\n+@RunWith(AndroidJUnit4::class)\n+class PushTest {\n+\n+    private lateinit var app: TestApp\n+    private lateinit var user: User\n+\n+    private val looperThread = BlockingLooperThread()\n+\n+    @Before\n+    fun setUp() {\n+        Realm.init(InstrumentationRegistry.getInstrumentation().targetContext)\n+\n+        app = TestApp()\n+        user = app.registerUserAndLogin(TestHelper.getRandomEmail(), \"123456\")\n+    }\n+\n+    @After\n+    fun tearDown() {\n+        if (this::app.isInitialized) {\n+            app.close()\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice() {\n+        user.getPush(SERVICE_NAME).registerDevice(SAMPLE_TOKEN)\n+    }\n+\n+    @Test\n+    fun registerDevice_twice() {\n+        // the API allows registering/deregistering twice, just checking we don't get errors\n+        user.getPush(SERVICE_NAME).registerDevice(SAMPLE_TOKEN)\n+        user.getPush(SERVICE_NAME).registerDevice(SAMPLE_TOKEN)\n+    }\n+\n+    @Test\n+    fun registerDevice_throwsBecauseOfUnknownService() {\n+        assertFailsWithErrorCode(ErrorCode.SERVICE_NOT_FOUND) {\n+            user.getPush(\"asdf\").registerDevice(SAMPLE_TOKEN)\n+        }\n+    }\n+\n+    @Test\n+    fun registerDevice_throwsBecauseOfLoggedOutUser() {\n+        user.logOut()\n+        assertFailsWithErrorCode(ErrorCode.SERVICE_UNKNOWN) {\n+            user.getPush(SERVICE_NAME).registerDevice(SAMPLE_TOKEN)\n+        }\n+    }\n+\n+    @Test\n+    fun registerDeviceAsync() {\n+        looperThread.runBlocking {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd1a807af030aafb609921690051678d2d300ef4"}, "originalPosition": 92}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2594, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}