{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyNDM4NDQz", "number": 7055, "title": "Add test for realm version clean-up on close", "bodyText": "Closes #6977", "createdAt": "2020-08-24T11:01:00Z", "url": "https://github.com/realm/realm-java/pull/7055", "merged": true, "mergeCommit": {"oid": "a118124ed7223eaac09bfadc826bfbbc5007ae16"}, "closed": true, "closedAt": "2020-09-01T06:06:35Z", "author": {"login": "rorbech"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCAHZnAH2gAyNDcyNDM4NDQzOjI3YTBlMzlkM2YwNzNjZjViOTliZjdmOGRhODExYzNhNGE4YWZlNjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEUZ7KgH2gAyNDcyNDM4NDQzOjNjYmQ1ZThiY2MyYWEyYjk3OGIzNzc2YTU1ZTE2NDhkNDQ1ODRkNmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "27a0e39d3f073cf5b99bf7f8da811c3a4a8afe63", "author": {"user": {"login": "rorbech", "name": "Claus R\u00f8rbech"}}, "url": "https://github.com/realm/realm-java/commit/27a0e39d3f073cf5b99bf7f8da811c3a4a8afe63", "committedDate": "2020-08-24T10:33:10Z", "message": "Add test for realm version clean-up on close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1d051ea63c0e8fdec97dc75e0594add056f1c5e", "author": {"user": {"login": "rorbech", "name": "Claus R\u00f8rbech"}}, "url": "https://github.com/realm/realm-java/commit/d1d051ea63c0e8fdec97dc75e0594add056f1c5e", "committedDate": "2020-08-26T08:48:10Z", "message": "Expose OS get_number_of_versions on internal OsSharedRealm"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ddf7297f5def1b07ed02d7e86e0adee97f4b969", "author": {"user": {"login": "rorbech", "name": "Claus R\u00f8rbech"}}, "url": "https://github.com/realm/realm-java/commit/4ddf7297f5def1b07ed02d7e86e0adee97f4b969", "committedDate": "2020-08-26T08:48:37Z", "message": "Test wrap up"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NjM1MDIw", "url": "https://github.com/realm/realm-java/pull/7055#pullrequestreview-475635020", "createdAt": "2020-08-26T16:00:04Z", "commit": {"oid": "4ddf7297f5def1b07ed02d7e86e0adee97f4b969"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNjowMDowNFrOHHS-Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNjowMDowNFrOHHS-Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMjk2Ng==", "bodyText": "Replacing this with long objectCount = realm.where(AllJavaTypes.class).count(); works. This could indicate that it is the TableView created by findAll() that somehow isn't being updated correctly thus leaking the version and causing the test to crash.\nI'll try to move this to ObjectStore and see if I can replicate the behavior there.", "url": "https://github.com/realm/realm-java/pull/7055#discussion_r477412966", "createdAt": "2020-08-26T16:00:04Z", "author": {"login": "cmelchior"}, "path": "realm/realm-library/src/androidTest/java/io/realm/RealmTests.java", "diffHunk": "@@ -4560,6 +4560,58 @@ public void hittingMaxNumberOfVersionsThrows() {\n         }\n     }\n \n+    @Test\n+    @RunTestInLooperThread\n+    // FIXME Maybe a bit convoluted, consider deleting it again.\n+    public void numberOfVersionsDecreasedOnClose() {\n+        int count = 50;\n+        final CountDownLatch bgThreadDoneLatch = new CountDownLatch(count);\n+\n+        RealmConfiguration config = configFactory.createConfigurationBuilder()\n+                // The multiple embedded threads seems to cause trouble with factory's directory setting\n+                .directory(context.getFilesDir())\n+                .name(\"versions-test.realm\")\n+                .maxNumberOfActiveVersions(5)\n+                .build();\n+\n+        // Read only instance\n+        looperThread.postRunnable(() -> {\n+            Realm realm = Realm.getInstance(config);\n+            realm.addChangeListener(realm1 -> {\n+                // FIXME Seems like versions are not deprecated if we do queries here\n+                //int objectCount = realm.where(AllJavaTypes.class).findAll().size();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ddf7297f5def1b07ed02d7e86e0adee97f4b969"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f12fac6e6f6814bde5faea266608d080773dd67", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/8f12fac6e6f6814bde5faea266608d080773dd67", "committedDate": "2020-08-31T08:59:08Z", "message": "Fix versions not being cleaned up in change listeners."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NDQ5ODQw", "url": "https://github.com/realm/realm-java/pull/7055#pullrequestreview-478449840", "createdAt": "2020-08-31T09:17:44Z", "commit": {"oid": "8f12fac6e6f6814bde5faea266608d080773dd67"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NDQ5NjA0", "url": "https://github.com/realm/realm-java/pull/7055#pullrequestreview-478449604", "createdAt": "2020-08-31T09:17:16Z", "commit": {"oid": "8f12fac6e6f6814bde5faea266608d080773dd67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwOToxNzoxN1rOHJw_Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwOToxNzoxN1rOHJw_Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAwMTg5NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            * Addded `Realm.getNumberOfActiveVersions()`, which give back the current number of active versions maintained by the Realm file.\n          \n          \n            \n            * Added `Realm.getNumberOfActiveVersions()`, which returns the current number of active versions maintained by the Realm file.", "url": "https://github.com/realm/realm-java/pull/7055#discussion_r480001894", "createdAt": "2020-08-31T09:17:17Z", "author": {"login": "rorbech"}, "path": "CHANGELOG.md", "diffHunk": "@@ -1,4 +1,21 @@\n-## 7.0.2(2020-08-14)\n+## 7.0.3 (YYYY-MM-DD)\n+\n+### Enhancements\n+* Addded `Realm.getNumberOfActiveVersions()`, which give back the current number of active versions maintained by the Realm file.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f12fac6e6f6814bde5faea266608d080773dd67"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04c09bba195e8e2320e9e0d69f0168c25994d1f0", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/04c09bba195e8e2320e9e0d69f0168c25994d1f0", "committedDate": "2020-08-31T09:58:19Z", "message": "Remove TODO items."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d8d6ea3dc9b18aafea1a51a923ac561f353d4d9", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/1d8d6ea3dc9b18aafea1a51a923ac561f353d4d9", "committedDate": "2020-08-31T10:13:43Z", "message": "Update CHANGELOG.md\n\nCo-authored-by: Claus R\u00f8rbech <claus.rorbech@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e3316a5c8941decbb4afe6812b704a76214a725", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/2e3316a5c8941decbb4afe6812b704a76214a725", "committedDate": "2020-08-31T13:46:19Z", "message": "Cleanup Realm files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cbd5e8bcc2aa2b978b3776a55e1648d44584d6a", "author": {"user": {"login": "cmelchior", "name": "Christian Melchior"}}, "url": "https://github.com/realm/realm-java/commit/3cbd5e8bcc2aa2b978b3776a55e1648d44584d6a", "committedDate": "2020-08-31T15:19:21Z", "message": "Don't delay creating Realm instance and changelistener."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2339, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}