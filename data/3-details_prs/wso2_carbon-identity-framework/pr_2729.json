{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMjMwMTg5", "number": 2729, "title": "Add improvement to UserClaimsAuditLogger to log only updated claims", "bodyText": "Resolves wso2/product-is#7443\nThis PR is to add improvement to audit logs so that whenever any claim of a user got updated, it will log only the information of which claim got updated with what value.\nTo enable this requirement 'LogUpdatedClaimsOnly' property should be enabled in the deployment.toml file as follows.\n[event.default_listener.user_claim_audit_logger]     \npriority = 9\nenable = true\nLogUpdatedClaimsOnly = true\n\nFollowing is a sample log printed when the above property is enabled.\nTID: [-1234] [2020-02-07 16:11:29,555] [b8140222-378d-404a-a60e-4b2e97979b7f]  INFO {AUDIT_LOG} - Initiator : admin@carbon.super | Action : doPreSetUserClaimValues | Target : sam | Added Claims : { \"http://wso2.org/claims/mobile\" : \"012345678\" } | Updated Claims : { \"http://wso2.org/claims/emailaddress\" : \"sam1234@gmail.com\" } | Removed Claims : { \"http://wso2.org/claims/country\" : \"Sri Lanka\" }", "createdAt": "2020-02-07T04:34:22Z", "url": "https://github.com/wso2/carbon-identity-framework/pull/2729", "merged": true, "mergeCommit": {"oid": "baed02db8e2ffbc23efad8fdfc40e7b02f861eed"}, "closed": true, "closedAt": "2020-02-07T11:34:29Z", "author": {"login": "sachiniWettasinghe"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcB33IOAFqTM1NDkyODUzNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcB9INdgFqTM1NTA3NzM2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0OTI4NTM1", "url": "https://github.com/wso2/carbon-identity-framework/pull/2729#pullrequestreview-354928535", "createdAt": "2020-02-07T04:45:00Z", "commit": {"oid": "739d2af1184ec9b0581da9694e381ee6d7e98ae5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwNDo0NTowMFrOFmyMRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwNDo0NTowMFrOFmyMRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIxMjU0OA==", "bodyText": "Shall we change the method name as \"logUpdatedClaims\"?", "url": "https://github.com/wso2/carbon-identity-framework/pull/2729#discussion_r376212548", "createdAt": "2020-02-07T04:45:00Z", "author": {"login": "nilasini"}, "path": "components/user-mgt/org.wso2.carbon.user.mgt/src/main/java/org/wso2/carbon/user/mgt/listeners/UserClaimsAuditLogger.java", "diffHunk": "@@ -114,11 +123,65 @@ public boolean doPreSetUserClaimValues(String userName, Map<String, String> clai\n     public boolean doPostSetUserClaimValues(String userName, Map<String, String> claims, String profileName, UserStoreManager userStoreManager) throws UserStoreException {\n \n         if (isEnable()) {\n-            logClaims(userName, \"doPostSetUserClaimValues\", userStoreManager);\n+            if (isLogUpdatedClaimsOnlyPropertyEnabled()) {\n+                return true;\n+            } else {\n+                logClaims(userName, \"doPostSetUserClaimValues\", userStoreManager);\n+            }\n         }\n         return true;\n     }\n \n+    private boolean isLogUpdatedClaimsOnlyPropertyEnabled() {\n+\n+        Object propertyValue = IdentityUtil.readEventListenerProperty(EVENT_LISTENER_TYPE, this.getClass().getName())\n+                .getProperties().get(LOG_UPDATED_CLAIMS_ONLY_PROPERTY);\n+        if (propertyValue != null) {\n+            return Boolean.parseBoolean(propertyValue.toString());\n+        }\n+\n+        return false;\n+    }\n+\n+    /**\n+     * This will log only the updated user claims rather than logging every claim that is added under the loggable\n+     * claims configuration.\n+     *\n+     * @param userName         Username.\n+     * @param claims           User claims.\n+     * @param action           Action to be logged in the audit log.\n+     * @param userStoreManager Userstore manager.\n+     */\n+    private void logOnlyUpdatedClaims(String userName, Map<String, String> claims, String action,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "739d2af1184ec9b0581da9694e381ee6d7e98ae5"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0OTI5MzQ1", "url": "https://github.com/wso2/carbon-identity-framework/pull/2729#pullrequestreview-354929345", "createdAt": "2020-02-07T04:49:15Z", "commit": {"oid": "739d2af1184ec9b0581da9694e381ee6d7e98ae5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwNDo0OToxNVrOFmyO8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwNDo0OToxNVrOFmyO8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIxMzIzMg==", "bodyText": "Shall we add a method comment here", "url": "https://github.com/wso2/carbon-identity-framework/pull/2729#discussion_r376213232", "createdAt": "2020-02-07T04:49:15Z", "author": {"login": "sarubi"}, "path": "components/user-mgt/org.wso2.carbon.user.mgt/src/main/java/org/wso2/carbon/user/mgt/listeners/UserClaimsAuditLogger.java", "diffHunk": "@@ -114,11 +123,65 @@ public boolean doPreSetUserClaimValues(String userName, Map<String, String> clai\n     public boolean doPostSetUserClaimValues(String userName, Map<String, String> claims, String profileName, UserStoreManager userStoreManager) throws UserStoreException {\n \n         if (isEnable()) {\n-            logClaims(userName, \"doPostSetUserClaimValues\", userStoreManager);\n+            if (isLogUpdatedClaimsOnlyPropertyEnabled()) {\n+                return true;\n+            } else {\n+                logClaims(userName, \"doPostSetUserClaimValues\", userStoreManager);\n+            }\n         }\n         return true;\n     }\n \n+    private boolean isLogUpdatedClaimsOnlyPropertyEnabled() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "739d2af1184ec9b0581da9694e381ee6d7e98ae5"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1bc014f2c5992055ef6a1a4561e62047c987b0a", "author": {"user": {"login": "sachiniWettasinghe", "name": "Sachini"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/b1bc014f2c5992055ef6a1a4561e62047c987b0a", "committedDate": "2020-02-07T05:34:34Z", "message": "Add improvement to log only updated claims"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "739d2af1184ec9b0581da9694e381ee6d7e98ae5", "author": {"user": {"login": "sachiniWettasinghe", "name": "Sachini"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/739d2af1184ec9b0581da9694e381ee6d7e98ae5", "committedDate": "2020-02-07T04:25:39Z", "message": "Add improvement to log only updated claims"}, "afterCommit": {"oid": "b1bc014f2c5992055ef6a1a4561e62047c987b0a", "author": {"user": {"login": "sachiniWettasinghe", "name": "Sachini"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/b1bc014f2c5992055ef6a1a4561e62047c987b0a", "committedDate": "2020-02-07T05:34:34Z", "message": "Add improvement to log only updated claims"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0OTM5NzE0", "url": "https://github.com/wso2/carbon-identity-framework/pull/2729#pullrequestreview-354939714", "createdAt": "2020-02-07T05:38:17Z", "commit": {"oid": "b1bc014f2c5992055ef6a1a4561e62047c987b0a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0OTQ0MjAw", "url": "https://github.com/wso2/carbon-identity-framework/pull/2729#pullrequestreview-354944200", "createdAt": "2020-02-07T05:57:13Z", "commit": {"oid": "b1bc014f2c5992055ef6a1a4561e62047c987b0a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1a205aa54e648fa266480635a46659613146dac", "author": {"user": {"login": "sachiniWettasinghe", "name": "Sachini"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/c1a205aa54e648fa266480635a46659613146dac", "committedDate": "2020-02-07T10:45:11Z", "message": "Add improvement to log set and removed claim values"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDc3MzYx", "url": "https://github.com/wso2/carbon-identity-framework/pull/2729#pullrequestreview-355077361", "createdAt": "2020-02-07T10:53:11Z", "commit": {"oid": "c1a205aa54e648fa266480635a46659613146dac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2383, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}