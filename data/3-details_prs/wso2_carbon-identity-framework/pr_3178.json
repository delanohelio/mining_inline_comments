{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3MjA5NDU5", "number": 3178, "title": "Session data cleanup for session_app_info, session_meta_data tables", "bodyText": "This PR\n\nIntroduces session data clean up for the IDN_AUTH_SESSION_APP_INFO, IDN_AUTH_SESSION_META_DATA tables to the existing mysql, postgresql-9, postgresql-11, mssql, oracle session data scripts.\nAdds cleaning up of IDN_AUTH_USER_SESSION_MAPPING table to the operational data clean up section of all scripts.\nAdds a check to verify if the table exists before cleaning up the tables - IDN_AUTH_USER_SESSION_MAPPING, IDN_AUTH_SESSION_APP_INFO, IDN_AUTH_SESSION_META_DATA\n\nResolves : wso2/product-is#9929, wso2/product-is#5287, wso2/product-is#7996", "createdAt": "2020-10-21T02:44:23Z", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178", "merged": true, "mergeCommit": {"oid": "204dc2f0c314366b8ed25279f92c45f791413e36"}, "closed": true, "closedAt": "2020-11-12T18:07:55Z", "author": {"login": "DinikaSen"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUU2IigH2gAyNTA3MjA5NDU5OmIwZDE5MTk1YjRlYmIxMDA0OTBjZjVjNmQ1OTBlMTA1MDgxNzEzZDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbtftMgFqTUyODgxMTE4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b0d19195b4ebb100490cf5c6d590e105081713d5", "author": {"user": {"login": "DinikaSen", "name": "Dinika Senarath"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/b0d19195b4ebb100490cf5c6d590e105081713d5", "committedDate": "2020-10-20T08:52:57Z", "message": "Add session data clean up for idn_auth_session_app_info,idn_auth_session_meta_data tables to mysql,postgresql9,postgresql11 scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce", "author": {"user": {"login": "DinikaSen", "name": "Dinika Senarath"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/976ae86acc2b7583f4b3caf8b3ae3b9476572dce", "committedDate": "2020-10-21T02:29:49Z", "message": "Add session data clean up for idn_auth_session_app_info,idn_auth_session_meta_data tables to mssql and oracle db scripts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NzU4MjQ5", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#pullrequestreview-528758249", "createdAt": "2020-11-12T05:24:34Z", "commit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNToyNDozNFrOHxrBxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNToyNDozNFrOHxrBxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NzIzOQ==", "bodyText": "remove the spaces", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521847239", "createdAt": "2020-11-12T05:24:34Z", "author": {"login": "inthirakumaaran"}, "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/oracle/sessiondata-cleanup/oracle-sessiondata-cleanup.sql", "diffHunk": "@@ -127,14 +137,49 @@ BEGIN\n             END IF;\n \n             -- Deleting user-session mappings from 'IDN_AUTH_USER_SESSION_MAPPING' table\n-            EXECUTE IMMEDIATE 'DELETE FROM IDN_AUTH_USER_SESSION_MAPPING WHERE SESSION_ID IN (SELECT SESSION_ID FROM TEMP_SESSION_BATCH)';\n-            sessionmappingcleanupcount := SQL%rowcount;\n-            COMMIT;\n+            SELECT COUNT(*) INTO ROWCOUNT from ALL_TABLES where OWNER = CURRENT_SCHEMA AND table_name = upper('IDN_AUTH_USER_SESSION_MAPPING');\n+            IF (ROWCOUNT = 1) then\n+                EXECUTE IMMEDIATE 'DELETE FROM IDN_AUTH_USER_SESSION_MAPPING WHERE SESSION_ID IN (SELECT SESSION_ID FROM TEMP_SESSION_BATCH)';\n+                sessionmappingcleanupcount := SQL%rowcount;\n+                COMMIT;\n \n-            IF ( tracingenabled ) THEN\n-            EXECUTE IMMEDIATE 'INSERT INTO LOG_WSO2_SESSION_CLEANUP_SP (TIMESTAMP,LOG) VALUES (TO_CHAR( SYSTIMESTAMP, ''DD.MM.YYYY HH24:MI:SS:FF4''),''DELETED USER-SESSION MAPPINGS COMPLETED WITH '|| sessionmappingcleanupcount||''')';\n-            COMMIT;\n-            END IF;\n+                IF ( tracingenabled ) THEN", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NzU4Njc5", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#pullrequestreview-528758679", "createdAt": "2020-11-12T05:25:51Z", "commit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNToyNTo1MVrOHxrDnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNToyNTo1MVrOHxrDnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NzcwOA==", "bodyText": "Do we need this space?", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521847708", "createdAt": "2020-11-12T05:25:51Z", "author": {"login": "inthirakumaaran"}, "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/postgresql/postgre-11x/sessiondata-cleanup/postgresql_11-session-data-cleanup.sql", "diffHunk": "@@ -340,21 +389,65 @@ LOOP\n         END IF;\n \n         -- Deleting user-session mappings from 'idn_auth_user_session_mapping' table\n-        IF (enableLog AND logLevel IN ('TRACE')) THEN\n-        notice := 'BATCH DELETE START ON TABLE '||purgingSessionUserMappingTable||' WITH :'||batchCount;\n-        RAISE NOTICE '%',notice;\n-        END IF;\n+        EXECUTE 'SELECT count(1) from pg_catalog.pg_tables WHERE schemaname = current_schema() AND tablename =  $1' into rowcount USING purgingSessionUserMappingTable;\n+        IF (rowcount = 1)\n+        THEN\n+            IF (enableLog AND logLevel IN ('TRACE')) THEN\n+                notice := 'BATCH DELETE START ON TABLE '||purgingSessionUserMappingTable||' WITH :'||batchCount;\n+                RAISE NOTICE '%',notice;\n+            END IF;\n \n-        EXECUTE 'DELETE from '||quote_ident(purgingSessionUserMappingTable)||' a USING '||purgingBatchTable||' b where a.'||purgeBseColmn||' = b.'||purgeBseColmn||'';\n-        GET diagnostics deleteMappingCount := ROW_COUNT;\n-        COMMIT;\n+            EXECUTE 'DELETE from '||quote_ident(purgingSessionUserMappingTable)||' a USING '||purgingBatchTable||' b where a.'||purgeBseColmn||' = b.'||purgeBseColmn||'';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce"}, "originalPosition": 121}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NzU5NDc0", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#pullrequestreview-528759474", "createdAt": "2020-11-12T05:27:58Z", "commit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNToyNzo1OFrOHxrGdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNToyNzo1OFrOHxrGdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0ODQzNg==", "bodyText": "Do we need this change?", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521848436", "createdAt": "2020-11-12T05:27:58Z", "author": {"login": "inthirakumaaran"}, "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/postgresql/postgre-9x/sessiondata-cleanup/postgresql-session-data-cleanup.sql", "diffHunk": "@@ -344,10 +354,49 @@ auditTable :=  purgingTable||'_auditlog';\n \t            GET diagnostics deleteMappingCount := ROW_COUNT;\n \n \t            IF (enableLog AND logLevel IN ('DEBUG','TRACE')) THEN\n-\t            notice := 'BATCH DELETE FINISHED ON TABLE'||purgingSessionUserMappingTable||' WITH :'||deleteMappingCount;\n+\t            notice := 'BATCH DELETE FINISHED ON TABLE '||purgingSessionUserMappingTable||' WITH :'||deleteMappingCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NzYwNjgw", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#pullrequestreview-528760680", "createdAt": "2020-11-12T05:31:40Z", "commit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d2233c7745ad78dc3f6e7e384b163ed21b9ddaa", "author": {"user": {"login": "DinikaSen", "name": "Dinika Senarath"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/3d2233c7745ad78dc3f6e7e384b163ed21b9ddaa", "committedDate": "2020-11-12T05:37:30Z", "message": "Remove extra blank lines"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4ODExMTg1", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#pullrequestreview-528811185", "createdAt": "2020-11-12T07:33:33Z", "commit": {"oid": "3d2233c7745ad78dc3f6e7e384b163ed21b9ddaa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2145, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}