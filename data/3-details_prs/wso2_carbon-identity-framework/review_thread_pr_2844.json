{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2MjY1NDM4", "number": 2844, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNDo0NDozOFrOEiYSsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNDo0NTo0OVrOEiYTkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDg1MDQxOnYy", "diffSide": "RIGHT", "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/internal/impl/UserSessionManagementServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNDo0NDozOFrOHQOGXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNjoyMDowM1rOHQPybQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc3MDI3MA==", "bodyText": "With the change, we have removed the debug log that was previously there. Is there any specific reason to do that?", "url": "https://github.com/wso2/carbon-identity-framework/pull/2844#discussion_r486770270", "createdAt": "2020-09-11T04:44:38Z", "author": {"login": "mefarazath"}, "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/internal/impl/UserSessionManagementServiceImpl.java", "diffHunk": "@@ -57,17 +61,71 @@ public void terminateSessionsOfUser(String username, String userStoreDomain, Str\n             UserSessionException {\n \n         validate(username, userStoreDomain, tenantDomain);\n-        List<String> sessionListOfUser = getSessionsOfUser(username, userStoreDomain, tenantDomain);\n \n-        if (!sessionListOfUser.isEmpty()) {\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Terminating all the active sessions of user: \" + username + \" of userstore domain: \" +\n-                        userStoreDomain + \" in tenant: \" + tenantDomain);\n+        String userId = resolveUserIdFromUsername(getTenantId(tenantDomain), userStoreDomain, username);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a1080b20f1c34489eeef126bef61c3864d42b85"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc5NzkzMw==", "bodyText": "Fixed 8a7f232", "url": "https://github.com/wso2/carbon-identity-framework/pull/2844#discussion_r486797933", "createdAt": "2020-09-11T06:20:03Z", "author": {"login": "GANGANI"}, "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/internal/impl/UserSessionManagementServiceImpl.java", "diffHunk": "@@ -57,17 +61,71 @@ public void terminateSessionsOfUser(String username, String userStoreDomain, Str\n             UserSessionException {\n \n         validate(username, userStoreDomain, tenantDomain);\n-        List<String> sessionListOfUser = getSessionsOfUser(username, userStoreDomain, tenantDomain);\n \n-        if (!sessionListOfUser.isEmpty()) {\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Terminating all the active sessions of user: \" + username + \" of userstore domain: \" +\n-                        userStoreDomain + \" in tenant: \" + tenantDomain);\n+        String userId = resolveUserIdFromUsername(getTenantId(tenantDomain), userStoreDomain, username);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc3MDI3MA=="}, "originalCommit": {"oid": "6a1080b20f1c34489eeef126bef61c3864d42b85"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDg1MTQyOnYy", "diffSide": "RIGHT", "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/internal/impl/UserSessionManagementServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNDo0NTowN1rOHQOG7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNjoyMDoxNVrOHQPyog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc3MDQxMg==", "bodyText": "Include some context information like full qualified username or userid", "url": "https://github.com/wso2/carbon-identity-framework/pull/2844#discussion_r486770412", "createdAt": "2020-09-11T04:45:07Z", "author": {"login": "mefarazath"}, "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/internal/impl/UserSessionManagementServiceImpl.java", "diffHunk": "@@ -57,17 +61,71 @@ public void terminateSessionsOfUser(String username, String userStoreDomain, Str\n             UserSessionException {\n \n         validate(username, userStoreDomain, tenantDomain);\n-        List<String> sessionListOfUser = getSessionsOfUser(username, userStoreDomain, tenantDomain);\n \n-        if (!sessionListOfUser.isEmpty()) {\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Terminating all the active sessions of user: \" + username + \" of userstore domain: \" +\n-                        userStoreDomain + \" in tenant: \" + tenantDomain);\n+        String userId = resolveUserIdFromUsername(getTenantId(tenantDomain), userStoreDomain, username);\n+        try {\n+            terminateSessionsByUserId(userId);\n+        } catch (SessionManagementException e) {\n+            throw new UserSessionException(\"Error while terminating sessions of user.\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a1080b20f1c34489eeef126bef61c3864d42b85"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc5Nzk4Ng==", "bodyText": "Fixed 8a7f232", "url": "https://github.com/wso2/carbon-identity-framework/pull/2844#discussion_r486797986", "createdAt": "2020-09-11T06:20:15Z", "author": {"login": "GANGANI"}, "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/internal/impl/UserSessionManagementServiceImpl.java", "diffHunk": "@@ -57,17 +61,71 @@ public void terminateSessionsOfUser(String username, String userStoreDomain, Str\n             UserSessionException {\n \n         validate(username, userStoreDomain, tenantDomain);\n-        List<String> sessionListOfUser = getSessionsOfUser(username, userStoreDomain, tenantDomain);\n \n-        if (!sessionListOfUser.isEmpty()) {\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Terminating all the active sessions of user: \" + username + \" of userstore domain: \" +\n-                        userStoreDomain + \" in tenant: \" + tenantDomain);\n+        String userId = resolveUserIdFromUsername(getTenantId(tenantDomain), userStoreDomain, username);\n+        try {\n+            terminateSessionsByUserId(userId);\n+        } catch (SessionManagementException e) {\n+            throw new UserSessionException(\"Error while terminating sessions of user.\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc3MDQxMg=="}, "originalCommit": {"oid": "6a1080b20f1c34489eeef126bef61c3864d42b85"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDg1MjY2OnYy", "diffSide": "RIGHT", "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/internal/impl/UserSessionManagementServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNDo0NTo0OVrOHQOHoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNjoyMDoyOFrOHQPy7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc3MDU5Mg==", "bodyText": "Would be better to have the userstoreDomain included as a debug log", "url": "https://github.com/wso2/carbon-identity-framework/pull/2844#discussion_r486770592", "createdAt": "2020-09-11T04:45:49Z", "author": {"login": "mefarazath"}, "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/internal/impl/UserSessionManagementServiceImpl.java", "diffHunk": "@@ -57,17 +61,71 @@ public void terminateSessionsOfUser(String username, String userStoreDomain, Str\n             UserSessionException {\n \n         validate(username, userStoreDomain, tenantDomain);\n-        List<String> sessionListOfUser = getSessionsOfUser(username, userStoreDomain, tenantDomain);\n \n-        if (!sessionListOfUser.isEmpty()) {\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Terminating all the active sessions of user: \" + username + \" of userstore domain: \" +\n-                        userStoreDomain + \" in tenant: \" + tenantDomain);\n+        String userId = resolveUserIdFromUsername(getTenantId(tenantDomain), userStoreDomain, username);\n+        try {\n+            terminateSessionsByUserId(userId);\n+        } catch (SessionManagementException e) {\n+            throw new UserSessionException(\"Error while terminating sessions of user.\", e);\n+        }\n+    }\n+\n+    /**\n+     * Retrieves the unique user id of the given username.\n+     *\n+     * @param tenantId          id of the tenant domain of the user\n+     * @param userStoreDomain   userstore of the user\n+     * @param username          username\n+     * @return                  unique user id of the user\n+     * @throws UserSessionException\n+     */\n+    private String resolveUserIdFromUsername(int tenantId, String userStoreDomain, String username) throws\n+            UserSessionException {\n+\n+        try {\n+            if (userStoreDomain == null) {\n+                userStoreDomain = UserCoreConstants.PRIMARY_DEFAULT_DOMAIN_NAME;\n+            }\n+            UserStoreManager userStoreManager = getUserStoreManager(tenantId, userStoreDomain);\n+            try {\n+                if (userStoreManager instanceof AbstractUserStoreManager) {\n+                    return ((AbstractUserStoreManager) userStoreManager).getUserIDFromUserName(username);\n+                }\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Provided user store manager for the user: \" + username + \", is not an instance of the \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a1080b20f1c34489eeef126bef61c3864d42b85"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc5ODA2Mw==", "bodyText": "Fixed 8a7f232", "url": "https://github.com/wso2/carbon-identity-framework/pull/2844#discussion_r486798063", "createdAt": "2020-09-11T06:20:28Z", "author": {"login": "GANGANI"}, "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/internal/impl/UserSessionManagementServiceImpl.java", "diffHunk": "@@ -57,17 +61,71 @@ public void terminateSessionsOfUser(String username, String userStoreDomain, Str\n             UserSessionException {\n \n         validate(username, userStoreDomain, tenantDomain);\n-        List<String> sessionListOfUser = getSessionsOfUser(username, userStoreDomain, tenantDomain);\n \n-        if (!sessionListOfUser.isEmpty()) {\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Terminating all the active sessions of user: \" + username + \" of userstore domain: \" +\n-                        userStoreDomain + \" in tenant: \" + tenantDomain);\n+        String userId = resolveUserIdFromUsername(getTenantId(tenantDomain), userStoreDomain, username);\n+        try {\n+            terminateSessionsByUserId(userId);\n+        } catch (SessionManagementException e) {\n+            throw new UserSessionException(\"Error while terminating sessions of user.\", e);\n+        }\n+    }\n+\n+    /**\n+     * Retrieves the unique user id of the given username.\n+     *\n+     * @param tenantId          id of the tenant domain of the user\n+     * @param userStoreDomain   userstore of the user\n+     * @param username          username\n+     * @return                  unique user id of the user\n+     * @throws UserSessionException\n+     */\n+    private String resolveUserIdFromUsername(int tenantId, String userStoreDomain, String username) throws\n+            UserSessionException {\n+\n+        try {\n+            if (userStoreDomain == null) {\n+                userStoreDomain = UserCoreConstants.PRIMARY_DEFAULT_DOMAIN_NAME;\n+            }\n+            UserStoreManager userStoreManager = getUserStoreManager(tenantId, userStoreDomain);\n+            try {\n+                if (userStoreManager instanceof AbstractUserStoreManager) {\n+                    return ((AbstractUserStoreManager) userStoreManager).getUserIDFromUserName(username);\n+                }\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Provided user store manager for the user: \" + username + \", is not an instance of the \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc3MDU5Mg=="}, "originalCommit": {"oid": "6a1080b20f1c34489eeef126bef61c3864d42b85"}, "originalPosition": 58}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2267, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}