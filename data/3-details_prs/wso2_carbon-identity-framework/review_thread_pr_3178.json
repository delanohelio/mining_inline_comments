{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3MjA5NDU5", "number": 3178, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNToyNDozNFrOE4AJnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNToyNzo1OFrOE4AM8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MTU4MTc1OnYy", "diffSide": "RIGHT", "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/oracle/sessiondata-cleanup/oracle-sessiondata-cleanup.sql", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNToyNDozNFrOHxrBxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNTo0MDowNlrOHxrUIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NzIzOQ==", "bodyText": "remove the spaces", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521847239", "createdAt": "2020-11-12T05:24:34Z", "author": {"login": "inthirakumaaran"}, "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/oracle/sessiondata-cleanup/oracle-sessiondata-cleanup.sql", "diffHunk": "@@ -127,14 +137,49 @@ BEGIN\n             END IF;\n \n             -- Deleting user-session mappings from 'IDN_AUTH_USER_SESSION_MAPPING' table\n-            EXECUTE IMMEDIATE 'DELETE FROM IDN_AUTH_USER_SESSION_MAPPING WHERE SESSION_ID IN (SELECT SESSION_ID FROM TEMP_SESSION_BATCH)';\n-            sessionmappingcleanupcount := SQL%rowcount;\n-            COMMIT;\n+            SELECT COUNT(*) INTO ROWCOUNT from ALL_TABLES where OWNER = CURRENT_SCHEMA AND table_name = upper('IDN_AUTH_USER_SESSION_MAPPING');\n+            IF (ROWCOUNT = 1) then\n+                EXECUTE IMMEDIATE 'DELETE FROM IDN_AUTH_USER_SESSION_MAPPING WHERE SESSION_ID IN (SELECT SESSION_ID FROM TEMP_SESSION_BATCH)';\n+                sessionmappingcleanupcount := SQL%rowcount;\n+                COMMIT;\n \n-            IF ( tracingenabled ) THEN\n-            EXECUTE IMMEDIATE 'INSERT INTO LOG_WSO2_SESSION_CLEANUP_SP (TIMESTAMP,LOG) VALUES (TO_CHAR( SYSTIMESTAMP, ''DD.MM.YYYY HH24:MI:SS:FF4''),''DELETED USER-SESSION MAPPINGS COMPLETED WITH '|| sessionmappingcleanupcount||''')';\n-            COMMIT;\n-            END IF;\n+                IF ( tracingenabled ) THEN", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0Nzk4Mw==", "bodyText": "Check other places as well", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521847983", "createdAt": "2020-11-12T05:26:32Z", "author": {"login": "inthirakumaaran"}, "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/oracle/sessiondata-cleanup/oracle-sessiondata-cleanup.sql", "diffHunk": "@@ -127,14 +137,49 @@ BEGIN\n             END IF;\n \n             -- Deleting user-session mappings from 'IDN_AUTH_USER_SESSION_MAPPING' table\n-            EXECUTE IMMEDIATE 'DELETE FROM IDN_AUTH_USER_SESSION_MAPPING WHERE SESSION_ID IN (SELECT SESSION_ID FROM TEMP_SESSION_BATCH)';\n-            sessionmappingcleanupcount := SQL%rowcount;\n-            COMMIT;\n+            SELECT COUNT(*) INTO ROWCOUNT from ALL_TABLES where OWNER = CURRENT_SCHEMA AND table_name = upper('IDN_AUTH_USER_SESSION_MAPPING');\n+            IF (ROWCOUNT = 1) then\n+                EXECUTE IMMEDIATE 'DELETE FROM IDN_AUTH_USER_SESSION_MAPPING WHERE SESSION_ID IN (SELECT SESSION_ID FROM TEMP_SESSION_BATCH)';\n+                sessionmappingcleanupcount := SQL%rowcount;\n+                COMMIT;\n \n-            IF ( tracingenabled ) THEN\n-            EXECUTE IMMEDIATE 'INSERT INTO LOG_WSO2_SESSION_CLEANUP_SP (TIMESTAMP,LOG) VALUES (TO_CHAR( SYSTIMESTAMP, ''DD.MM.YYYY HH24:MI:SS:FF4''),''DELETED USER-SESSION MAPPINGS COMPLETED WITH '|| sessionmappingcleanupcount||''')';\n-            COMMIT;\n-            END IF;\n+                IF ( tracingenabled ) THEN", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NzIzOQ=="}, "originalCommit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg1MTkzNg==", "bodyText": "Addressed in 3d2233c", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521851936", "createdAt": "2020-11-12T05:40:06Z", "author": {"login": "DinikaSen"}, "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/oracle/sessiondata-cleanup/oracle-sessiondata-cleanup.sql", "diffHunk": "@@ -127,14 +137,49 @@ BEGIN\n             END IF;\n \n             -- Deleting user-session mappings from 'IDN_AUTH_USER_SESSION_MAPPING' table\n-            EXECUTE IMMEDIATE 'DELETE FROM IDN_AUTH_USER_SESSION_MAPPING WHERE SESSION_ID IN (SELECT SESSION_ID FROM TEMP_SESSION_BATCH)';\n-            sessionmappingcleanupcount := SQL%rowcount;\n-            COMMIT;\n+            SELECT COUNT(*) INTO ROWCOUNT from ALL_TABLES where OWNER = CURRENT_SCHEMA AND table_name = upper('IDN_AUTH_USER_SESSION_MAPPING');\n+            IF (ROWCOUNT = 1) then\n+                EXECUTE IMMEDIATE 'DELETE FROM IDN_AUTH_USER_SESSION_MAPPING WHERE SESSION_ID IN (SELECT SESSION_ID FROM TEMP_SESSION_BATCH)';\n+                sessionmappingcleanupcount := SQL%rowcount;\n+                COMMIT;\n \n-            IF ( tracingenabled ) THEN\n-            EXECUTE IMMEDIATE 'INSERT INTO LOG_WSO2_SESSION_CLEANUP_SP (TIMESTAMP,LOG) VALUES (TO_CHAR( SYSTIMESTAMP, ''DD.MM.YYYY HH24:MI:SS:FF4''),''DELETED USER-SESSION MAPPINGS COMPLETED WITH '|| sessionmappingcleanupcount||''')';\n-            COMMIT;\n-            END IF;\n+                IF ( tracingenabled ) THEN", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NzIzOQ=="}, "originalCommit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MTU4NTA2OnYy", "diffSide": "RIGHT", "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/postgresql/postgre-11x/sessiondata-cleanup/postgresql_11-session-data-cleanup.sql", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNToyNTo1MVrOHxrDnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNTo0MDowMVrOHxrUAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NzcwOA==", "bodyText": "Do we need this space?", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521847708", "createdAt": "2020-11-12T05:25:51Z", "author": {"login": "inthirakumaaran"}, "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/postgresql/postgre-11x/sessiondata-cleanup/postgresql_11-session-data-cleanup.sql", "diffHunk": "@@ -340,21 +389,65 @@ LOOP\n         END IF;\n \n         -- Deleting user-session mappings from 'idn_auth_user_session_mapping' table\n-        IF (enableLog AND logLevel IN ('TRACE')) THEN\n-        notice := 'BATCH DELETE START ON TABLE '||purgingSessionUserMappingTable||' WITH :'||batchCount;\n-        RAISE NOTICE '%',notice;\n-        END IF;\n+        EXECUTE 'SELECT count(1) from pg_catalog.pg_tables WHERE schemaname = current_schema() AND tablename =  $1' into rowcount USING purgingSessionUserMappingTable;\n+        IF (rowcount = 1)\n+        THEN\n+            IF (enableLog AND logLevel IN ('TRACE')) THEN\n+                notice := 'BATCH DELETE START ON TABLE '||purgingSessionUserMappingTable||' WITH :'||batchCount;\n+                RAISE NOTICE '%',notice;\n+            END IF;\n \n-        EXECUTE 'DELETE from '||quote_ident(purgingSessionUserMappingTable)||' a USING '||purgingBatchTable||' b where a.'||purgeBseColmn||' = b.'||purgeBseColmn||'';\n-        GET diagnostics deleteMappingCount := ROW_COUNT;\n-        COMMIT;\n+            EXECUTE 'DELETE from '||quote_ident(purgingSessionUserMappingTable)||' a USING '||purgingBatchTable||' b where a.'||purgeBseColmn||' = b.'||purgeBseColmn||'';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg1MTkwNQ==", "bodyText": "Addressed in 3d2233c", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521851905", "createdAt": "2020-11-12T05:40:01Z", "author": {"login": "DinikaSen"}, "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/postgresql/postgre-11x/sessiondata-cleanup/postgresql_11-session-data-cleanup.sql", "diffHunk": "@@ -340,21 +389,65 @@ LOOP\n         END IF;\n \n         -- Deleting user-session mappings from 'idn_auth_user_session_mapping' table\n-        IF (enableLog AND logLevel IN ('TRACE')) THEN\n-        notice := 'BATCH DELETE START ON TABLE '||purgingSessionUserMappingTable||' WITH :'||batchCount;\n-        RAISE NOTICE '%',notice;\n-        END IF;\n+        EXECUTE 'SELECT count(1) from pg_catalog.pg_tables WHERE schemaname = current_schema() AND tablename =  $1' into rowcount USING purgingSessionUserMappingTable;\n+        IF (rowcount = 1)\n+        THEN\n+            IF (enableLog AND logLevel IN ('TRACE')) THEN\n+                notice := 'BATCH DELETE START ON TABLE '||purgingSessionUserMappingTable||' WITH :'||batchCount;\n+                RAISE NOTICE '%',notice;\n+            END IF;\n \n-        EXECUTE 'DELETE from '||quote_ident(purgingSessionUserMappingTable)||' a USING '||purgingBatchTable||' b where a.'||purgeBseColmn||' = b.'||purgeBseColmn||'';\n-        GET diagnostics deleteMappingCount := ROW_COUNT;\n-        COMMIT;\n+            EXECUTE 'DELETE from '||quote_ident(purgingSessionUserMappingTable)||' a USING '||purgingBatchTable||' b where a.'||purgeBseColmn||' = b.'||purgeBseColmn||'';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NzcwOA=="}, "originalCommit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce"}, "originalPosition": 121}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MTU5MDI0OnYy", "diffSide": "RIGHT", "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/postgresql/postgre-9x/sessiondata-cleanup/postgresql-session-data-cleanup.sql", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNToyNzo1OFrOHxrGdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNTozMDowN1rOHxrIxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0ODQzNg==", "bodyText": "Do we need this change?", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521848436", "createdAt": "2020-11-12T05:27:58Z", "author": {"login": "inthirakumaaran"}, "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/postgresql/postgre-9x/sessiondata-cleanup/postgresql-session-data-cleanup.sql", "diffHunk": "@@ -344,10 +354,49 @@ auditTable :=  purgingTable||'_auditlog';\n \t            GET diagnostics deleteMappingCount := ROW_COUNT;\n \n \t            IF (enableLog AND logLevel IN ('DEBUG','TRACE')) THEN\n-\t            notice := 'BATCH DELETE FINISHED ON TABLE'||purgingSessionUserMappingTable||' WITH :'||deleteMappingCount;\n+\t            notice := 'BATCH DELETE FINISHED ON TABLE '||purgingSessionUserMappingTable||' WITH :'||deleteMappingCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0OTAyOA==", "bodyText": "This is only a formatting fix to add a missing space to the log message", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521849028", "createdAt": "2020-11-12T05:30:07Z", "author": {"login": "DinikaSen"}, "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/postgresql/postgre-9x/sessiondata-cleanup/postgresql-session-data-cleanup.sql", "diffHunk": "@@ -344,10 +354,49 @@ auditTable :=  purgingTable||'_auditlog';\n \t            GET diagnostics deleteMappingCount := ROW_COUNT;\n \n \t            IF (enableLog AND logLevel IN ('DEBUG','TRACE')) THEN\n-\t            notice := 'BATCH DELETE FINISHED ON TABLE'||purgingSessionUserMappingTable||' WITH :'||deleteMappingCount;\n+\t            notice := 'BATCH DELETE FINISHED ON TABLE '||purgingSessionUserMappingTable||' WITH :'||deleteMappingCount;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0ODQzNg=="}, "originalCommit": {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce"}, "originalPosition": 60}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2479, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}