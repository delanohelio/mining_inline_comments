{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MDYyNzcx", "number": 2978, "title": "Tenant qualify config store API", "bodyText": "Fixes wso2/product-is#8545", "createdAt": "2020-06-19T12:02:34Z", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978", "merged": true, "mergeCommit": {"oid": "5533c84b16f82a1e534cc02fa5b4e4bf4c7d33fe"}, "closed": true, "closedAt": "2020-07-02T08:43:51Z", "author": {"login": "emswbandara"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABctoRdkgFqTQzNDU4MjQ3MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcw5wx7gFqTQ0MTQxOTY1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NTgyNDcw", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#pullrequestreview-434582470", "createdAt": "2020-06-22T03:27:56Z", "commit": {"oid": "755d01bf09b510da4a52066fbb0267ff4e2d525c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwMzoyNzo1NlrOGmw7ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwMzoyNzo1NlrOGmw7ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwMDczMQ==", "bodyText": "Is this needed. Isn't the expectation of the dao is to read tenant from PrivilegedCarbonContext.\nIn that case, we can have a tenant flow initiated from the service layer right", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r443300731", "createdAt": "2020-06-22T03:27:56Z", "author": {"login": "malithie"}, "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java", "diffHunk": "@@ -652,9 +652,15 @@ public void addResource(Resource resource) throws ConfigurationManagementExcepti\n                         preparedStatement -> {\n                             int initialParameterIndex = 1;\n                             preparedStatement.setString(initialParameterIndex, resource.getResourceId());\n-                            preparedStatement.setInt(++initialParameterIndex,\n-                                    PrivilegedCarbonContext.getThreadLocalCarbonContext()\n-                                            .getTenantId());\n+                            int tenantId;\n+                            String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();\n+                            if (StringUtils.isBlank(tenantDomain)) {\n+                                tenantId = PrivilegedCarbonContext.getThreadLocalCarbonContext()\n+                                        .getTenantId();\n+                            } else {\n+                                tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n+                            }\n+                            preparedStatement.setInt(++initialParameterIndex, tenantId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "755d01bf09b510da4a52066fbb0267ff4e2d525c"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NjI2Njg3", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#pullrequestreview-434626687", "createdAt": "2020-06-22T06:10:57Z", "commit": {"oid": "755d01bf09b510da4a52066fbb0267ff4e2d525c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjoxMDo1N1rOGmzCtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjoxMDo1N1rOGmzCtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMzNTM1MQ==", "bodyText": "Can't we call getTenantDomain() method here?", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r443335351", "createdAt": "2020-06-22T06:10:57Z", "author": {"login": "mefarazath"}, "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java", "diffHunk": "@@ -441,12 +482,25 @@ private void validateResourcesRetrieveRequest(String resourceTypeName)\n \n     private int getTenantId() {\n \n-        return PrivilegedCarbonContext.getThreadLocalCarbonContext().getTenantId();\n+        int tenantId;\n+        String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "755d01bf09b510da4a52066fbb0267ff4e2d525c"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NjI3MDQ2", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#pullrequestreview-434627046", "createdAt": "2020-06-22T06:11:56Z", "commit": {"oid": "755d01bf09b510da4a52066fbb0267ff4e2d525c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjoxMTo1NlrOGmzD4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjoxMTo1NlrOGmzD4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMzNTY0OQ==", "bodyText": "This logic seems to repeat. Can we move this logic to a common function / utility and re-use?", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r443335649", "createdAt": "2020-06-22T06:11:56Z", "author": {"login": "mefarazath"}, "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java", "diffHunk": "@@ -987,8 +999,15 @@ private void updateMetadataForH2(Resource resource, String resourceTypeId, boole\n                     template.executeInsert(UPDATE_RESOURCE_H2,\n                             preparedStatement -> {\n                                 int initialParameterIndex = 1;\n-                                preparedStatement.setInt(initialParameterIndex,\n-                                        PrivilegedCarbonContext.getThreadLocalCarbonContext().getTenantId());\n+                                int tenantId;\n+                                String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();\n+                                if (StringUtils.isBlank(tenantDomain)) {\n+                                    tenantId = PrivilegedCarbonContext.getThreadLocalCarbonContext()\n+                                            .getTenantId();\n+                                } else {\n+                                    tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n+                                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "755d01bf09b510da4a52066fbb0267ff4e2d525c"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e9bb50b9481490795e594732f480d261eefc0bc", "author": {"user": {"login": "emswbandara", "name": "Sathya Bandara"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/8e9bb50b9481490795e594732f480d261eefc0bc", "committedDate": "2020-06-22T14:52:46Z", "message": "Tenant qualify config store API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29225c991017fa6dda45cb84cae0e1fe27cf40d4", "author": {"user": {"login": "emswbandara", "name": "Sathya Bandara"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/29225c991017fa6dda45cb84cae0e1fe27cf40d4", "committedDate": "2020-06-22T14:53:01Z", "message": "Add unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "684a879df2e64ec845c75489018b9144a974055b", "author": {"user": {"login": "emswbandara", "name": "Sathya Bandara"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/684a879df2e64ec845c75489018b9144a974055b", "committedDate": "2020-06-22T15:00:32Z", "message": "Add configs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1ODY4MDMz", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#pullrequestreview-435868033", "createdAt": "2020-06-23T14:54:46Z", "commit": {"oid": "684a879df2e64ec845c75489018b9144a974055b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4ODAxMDI3", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#pullrequestreview-438801027", "createdAt": "2020-06-28T18:01:05Z", "commit": {"oid": "684a879df2e64ec845c75489018b9144a974055b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNjQ4NDY1", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#pullrequestreview-440648465", "createdAt": "2020-07-01T08:19:18Z", "commit": {"oid": "684a879df2e64ec845c75489018b9144a974055b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwODoxOToxOFrOGrbx4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwODoxOToxOFrOGrbx4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5NzA4OA==", "bodyText": "shall we deprecate this?", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r448197088", "createdAt": "2020-07-01T08:19:18Z", "author": {"login": "tharindu-bandara"}, "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManager.java", "diffHunk": "@@ -43,6 +43,17 @@\n      */\n     Resources getTenantResources(Condition searchCondition) throws ConfigurationManagementException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "684a879df2e64ec845c75489018b9144a974055b"}, "originalPosition": 2}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNjUxOTgx", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#pullrequestreview-440651981", "createdAt": "2020-07-01T08:23:47Z", "commit": {"oid": "684a879df2e64ec845c75489018b9144a974055b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a84cfdda5fd231bd8bd30a6e6e041fa440c4bfc", "author": {"user": {"login": "emswbandara", "name": "Sathya Bandara"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/4a84cfdda5fd231bd8bd30a6e6e041fa440c4bfc", "committedDate": "2020-07-01T09:32:34Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDgyNTUy", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#pullrequestreview-441082552", "createdAt": "2020-07-01T17:54:19Z", "commit": {"oid": "4a84cfdda5fd231bd8bd30a6e6e041fa440c4bfc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNzo1NDoxOVrOGrv3yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNzo1NDoxOVrOGrv3yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNjI4MQ==", "bodyText": "If tenant qualified URL is not enabled will this have an impact?\nIIRC, the thread-local gets populated on tenant qualified mode only, whereas this API is implemented to be accessible from a tenant in the path in the legacy way", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r448526281", "createdAt": "2020-07-01T17:54:19Z", "author": {"login": "malithie"}, "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.endpoint/src/main/java/org/wso2/carbon/identity/configuration/mgt/endpoint/impl/SearchApiServiceImpl.java", "diffHunk": "@@ -42,14 +44,20 @@\n public class SearchApiServiceImpl extends SearchApiService {\n \n     private static final Log LOG = LogFactory.getLog(SearchApiServiceImpl.class);\n+    private boolean allowCrossTenantSearch = Boolean.parseBoolean(IdentityUtil.getProperty(\"ConfigurationStore\" +\n+            \".AllowCrossTenantSearch\"));\n \n     @Override\n     public Response searchGet(SearchContext searchContext) {\n \n         try {\n-            Resources resources = getConfigurationManager().getTenantResources(\n-                    getSearchCondition(searchContext)\n-            );\n+            Resources resources;\n+            if (allowCrossTenantSearch) {\n+                resources = getConfigurationManager().getTenantResources(getSearchCondition(searchContext));\n+            } else {\n+                resources = getConfigurationManager().getTenantResources(IdentityTenantUtil\n+                                .getTenantDomainFromContext(), getSearchCondition(searchContext));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a84cfdda5fd231bd8bd30a6e6e041fa440c4bfc"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNDAzMDE1", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#pullrequestreview-441403015", "createdAt": "2020-07-02T07:06:21Z", "commit": {"oid": "4a84cfdda5fd231bd8bd30a6e6e041fa440c4bfc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNDE5NjU1", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#pullrequestreview-441419655", "createdAt": "2020-07-02T07:32:19Z", "commit": {"oid": "4a84cfdda5fd231bd8bd30a6e6e041fa440c4bfc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2209, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}