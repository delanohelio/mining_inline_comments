{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczMTIwNTMx", "number": 2735, "title": "Fix expired session data cleanup", "bodyText": "Proposed changes in this pull request\n\nFix wso2/product-is#7392.\n\nApproach\n\nWhen deleting expired session data by chunks, each chunk deletion query needs to be committed per chunk. Also, try-with-resources is used to work with the prepared statement to improve the prepared statement closing.", "createdAt": "2020-02-10T12:59:06Z", "url": "https://github.com/wso2/carbon-identity-framework/pull/2735", "merged": true, "mergeCommit": {"oid": "f404af82d01fe605af3cddbdc4707ab68ce6a695"}, "closed": true, "closedAt": "2020-02-10T14:05:15Z", "author": {"login": "tharindu-bandara"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcC8q6BAH2gAyMzczMTIwNTMxOjIzOGQzMDhmOGRiYmIyNGU5YTE1NmU4NDI5MTVkM2QyNDQyMGM4Zjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcC9fs7AFqTM1NTk1MDc5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "238d308f8dbbb24e9a156e842915d3d24420c8f8", "author": {"user": {"login": "tharindu-bandara", "name": "Tharindu Bandara"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/238d308f8dbbb24e9a156e842915d3d24420c8f8", "committedDate": "2020-02-10T12:55:06Z", "message": "Fix expired session data cleanup\n\n- Commit session data chunk deletion per each chunk"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1OTIwMTYz", "url": "https://github.com/wso2/carbon-identity-framework/pull/2735#pullrequestreview-355920163", "createdAt": "2020-02-10T13:07:10Z", "commit": {"oid": "238d308f8dbbb24e9a156e842915d3d24420c8f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1OTQwMDc4", "url": "https://github.com/wso2/carbon-identity-framework/pull/2735#pullrequestreview-355940078", "createdAt": "2020-02-10T13:37:27Z", "commit": {"oid": "238d308f8dbbb24e9a156e842915d3d24420c8f8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzozNzoyOFrOFnmRIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzozODo1OVrOFnmUdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2NTc2Mg==", "bodyText": "Formatting issue", "url": "https://github.com/wso2/carbon-identity-framework/pull/2735#discussion_r377065762", "createdAt": "2020-02-10T13:37:28Z", "author": {"login": "madurangasiriwardena"}, "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/store/SessionDataStore.java", "diffHunk": "@@ -445,26 +443,26 @@ private void removeExpiredSessionData(String sqlQuery) {\n             boolean deleteCompleted = false;\n             int totalDeletedEntries = 0;\n             while (!deleteCompleted) {\n-                statement = connection.prepareStatement(sqlQuery);\n-                statement.setLong(1, currentTime);\n-\n-                int noOfDeletedRecords = statement.executeUpdate();\n-                deleteCompleted = noOfDeletedRecords < deleteChunkSize;\n-                totalDeletedEntries += noOfDeletedRecords;\n-                if (log.isDebugEnabled()) {\n-                    log.debug(String.format(\"Removed %d expired session records.\",\n-                            noOfDeletedRecords));\n+                try (PreparedStatement statement = connection.prepareStatement(sqlQuery)){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "238d308f8dbbb24e9a156e842915d3d24420c8f8"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2NjYxMw==", "bodyText": "Let's remove the finally block and enclose the connection in a try with resource block.", "url": "https://github.com/wso2/carbon-identity-framework/pull/2735#discussion_r377066613", "createdAt": "2020-02-10T13:38:59Z", "author": {"login": "madurangasiriwardena"}, "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/store/SessionDataStore.java", "diffHunk": "@@ -445,26 +443,26 @@ private void removeExpiredSessionData(String sqlQuery) {\n             boolean deleteCompleted = false;\n             int totalDeletedEntries = 0;\n             while (!deleteCompleted) {\n-                statement = connection.prepareStatement(sqlQuery);\n-                statement.setLong(1, currentTime);\n-\n-                int noOfDeletedRecords = statement.executeUpdate();\n-                deleteCompleted = noOfDeletedRecords < deleteChunkSize;\n-                totalDeletedEntries += noOfDeletedRecords;\n-                if (log.isDebugEnabled()) {\n-                    log.debug(String.format(\"Removed %d expired session records.\",\n-                            noOfDeletedRecords));\n+                try (PreparedStatement statement = connection.prepareStatement(sqlQuery)){\n+                    statement.setLong(1, currentTime);\n+                    int noOfDeletedRecords = statement.executeUpdate();\n+                    deleteCompleted = noOfDeletedRecords < deleteChunkSize;\n+                    totalDeletedEntries += noOfDeletedRecords;\n+                    // Commit the chunk deletion.\n+                    IdentityDatabaseUtil.commitTransaction(connection);\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(String.format(\"Removed %d expired session records.\", noOfDeletedRecords));\n+                    }\n                 }\n-                IdentityDatabaseUtil.rollbackTransaction(connection);\n             }\n             if (log.isDebugEnabled()) {\n-                log.debug(String.format(\"Deleted total of %d entries \", totalDeletedEntries));\n+                log.debug(String.format(\"Deleted total of %d entries\", totalDeletedEntries));\n             }\n         } catch (SQLException e) {\n             IdentityDatabaseUtil.rollbackTransaction(connection);\n-            log.error(\"Error while removing session data from the database for nano time \" + currentTime, e);\n+            log.error(\"Error while removing session data from the database for nano time: \" + currentTime, e);\n         } finally {\n-            IdentityDatabaseUtil.closeAllConnections(connection, null, statement);\n+            IdentityDatabaseUtil.closeAllConnections(connection, null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "238d308f8dbbb24e9a156e842915d3d24420c8f8"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5f2647666a6f6cd722efacc141af549d9a14496", "author": {"user": {"login": "tharindu-bandara", "name": "Tharindu Bandara"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/a5f2647666a6f6cd722efacc141af549d9a14496", "committedDate": "2020-02-10T13:46:46Z", "message": "Use try-with-resources for database connection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1OTUwNzk4", "url": "https://github.com/wso2/carbon-identity-framework/pull/2735#pullrequestreview-355950798", "createdAt": "2020-02-10T13:52:47Z", "commit": {"oid": "a5f2647666a6f6cd722efacc141af549d9a14496"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2389, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}