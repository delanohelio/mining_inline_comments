{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MDYyNzcx", "number": 2978, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwMzoyNzo1NlrOEHaslQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNzo1NDoxOVrOEKm4fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MjEyODg1OnYy", "diffSide": "RIGHT", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwMzoyNzo1NlrOGmw7ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMTozODo1NVrOGm88Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwMDczMQ==", "bodyText": "Is this needed. Isn't the expectation of the dao is to read tenant from PrivilegedCarbonContext.\nIn that case, we can have a tenant flow initiated from the service layer right", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r443300731", "createdAt": "2020-06-22T03:27:56Z", "author": {"login": "malithie"}, "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java", "diffHunk": "@@ -652,9 +652,15 @@ public void addResource(Resource resource) throws ConfigurationManagementExcepti\n                         preparedStatement -> {\n                             int initialParameterIndex = 1;\n                             preparedStatement.setString(initialParameterIndex, resource.getResourceId());\n-                            preparedStatement.setInt(++initialParameterIndex,\n-                                    PrivilegedCarbonContext.getThreadLocalCarbonContext()\n-                                            .getTenantId());\n+                            int tenantId;\n+                            String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();\n+                            if (StringUtils.isBlank(tenantDomain)) {\n+                                tenantId = PrivilegedCarbonContext.getThreadLocalCarbonContext()\n+                                        .getTenantId();\n+                            } else {\n+                                tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n+                            }\n+                            preparedStatement.setInt(++initialParameterIndex, tenantId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "755d01bf09b510da4a52066fbb0267ff4e2d525c"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQxOTUwNw==", "bodyText": "It seems that correct tenant domain is retrieved from PrivilegedCarbonContext even though we don't have a tenant flow initiated from the service layer. So shall I keep the old code as it is?", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r443419507", "createdAt": "2020-06-22T09:08:01Z", "author": {"login": "emswbandara"}, "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java", "diffHunk": "@@ -652,9 +652,15 @@ public void addResource(Resource resource) throws ConfigurationManagementExcepti\n                         preparedStatement -> {\n                             int initialParameterIndex = 1;\n                             preparedStatement.setString(initialParameterIndex, resource.getResourceId());\n-                            preparedStatement.setInt(++initialParameterIndex,\n-                                    PrivilegedCarbonContext.getThreadLocalCarbonContext()\n-                                            .getTenantId());\n+                            int tenantId;\n+                            String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();\n+                            if (StringUtils.isBlank(tenantDomain)) {\n+                                tenantId = PrivilegedCarbonContext.getThreadLocalCarbonContext()\n+                                        .getTenantId();\n+                            } else {\n+                                tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n+                            }\n+                            preparedStatement.setInt(++initialParameterIndex, tenantId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwMDczMQ=="}, "originalCommit": {"oid": "755d01bf09b510da4a52066fbb0267ff4e2d525c"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5NzUxMA==", "bodyText": "+1", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r443497510", "createdAt": "2020-06-22T11:38:55Z", "author": {"login": "malithie"}, "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java", "diffHunk": "@@ -652,9 +652,15 @@ public void addResource(Resource resource) throws ConfigurationManagementExcepti\n                         preparedStatement -> {\n                             int initialParameterIndex = 1;\n                             preparedStatement.setString(initialParameterIndex, resource.getResourceId());\n-                            preparedStatement.setInt(++initialParameterIndex,\n-                                    PrivilegedCarbonContext.getThreadLocalCarbonContext()\n-                                            .getTenantId());\n+                            int tenantId;\n+                            String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();\n+                            if (StringUtils.isBlank(tenantDomain)) {\n+                                tenantId = PrivilegedCarbonContext.getThreadLocalCarbonContext()\n+                                        .getTenantId();\n+                            } else {\n+                                tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n+                            }\n+                            preparedStatement.setInt(++initialParameterIndex, tenantId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwMDczMQ=="}, "originalCommit": {"oid": "755d01bf09b510da4a52066fbb0267ff4e2d525c"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MjM1MzQ4OnYy", "diffSide": "RIGHT", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjoxMDo1N1rOGmzCtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjoxMDo1N1rOGmzCtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMzNTM1MQ==", "bodyText": "Can't we call getTenantDomain() method here?", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r443335351", "createdAt": "2020-06-22T06:10:57Z", "author": {"login": "mefarazath"}, "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManagerImpl.java", "diffHunk": "@@ -441,12 +482,25 @@ private void validateResourcesRetrieveRequest(String resourceTypeName)\n \n     private int getTenantId() {\n \n-        return PrivilegedCarbonContext.getThreadLocalCarbonContext().getTenantId();\n+        int tenantId;\n+        String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "755d01bf09b510da4a52066fbb0267ff4e2d525c"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MjM1NTM5OnYy", "diffSide": "RIGHT", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjoxMTo1NlrOGmzD4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjoxMTo1NlrOGmzD4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMzNTY0OQ==", "bodyText": "This logic seems to repeat. Can we move this logic to a common function / utility and re-use?", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r443335649", "createdAt": "2020-06-22T06:11:56Z", "author": {"login": "mefarazath"}, "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/dao/impl/ConfigurationDAOImpl.java", "diffHunk": "@@ -987,8 +999,15 @@ private void updateMetadataForH2(Resource resource, String resourceTypeId, boole\n                     template.executeInsert(UPDATE_RESOURCE_H2,\n                             preparedStatement -> {\n                                 int initialParameterIndex = 1;\n-                                preparedStatement.setInt(initialParameterIndex,\n-                                        PrivilegedCarbonContext.getThreadLocalCarbonContext().getTenantId());\n+                                int tenantId;\n+                                String tenantDomain = IdentityTenantUtil.getTenantDomainFromContext();\n+                                if (StringUtils.isBlank(tenantDomain)) {\n+                                    tenantId = PrivilegedCarbonContext.getThreadLocalCarbonContext()\n+                                            .getTenantId();\n+                                } else {\n+                                    tenantId = IdentityTenantUtil.getTenantId(tenantDomain);\n+                                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "755d01bf09b510da4a52066fbb0267ff4e2d525c"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MzUzMzQyOnYy", "diffSide": "RIGHT", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwODoxOToxOFrOGrbx4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwOTozMzo0NFrOGreZ8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5NzA4OA==", "bodyText": "shall we deprecate this?", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r448197088", "createdAt": "2020-07-01T08:19:18Z", "author": {"login": "tharindu-bandara"}, "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManager.java", "diffHunk": "@@ -43,6 +43,17 @@\n      */\n     Resources getTenantResources(Condition searchCondition) throws ConfigurationManagementException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "684a879df2e64ec845c75489018b9144a974055b"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI0MDExMw==", "bodyText": "fixed", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r448240113", "createdAt": "2020-07-01T09:33:44Z", "author": {"login": "emswbandara"}, "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.core/src/main/java/org/wso2/carbon/identity/configuration/mgt/core/ConfigurationManager.java", "diffHunk": "@@ -43,6 +43,17 @@\n      */\n     Resources getTenantResources(Condition searchCondition) throws ConfigurationManagementException;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5NzA4OA=="}, "originalCommit": {"oid": "684a879df2e64ec845c75489018b9144a974055b"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTU4MjY4OnYy", "diffSide": "RIGHT", "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.endpoint/src/main/java/org/wso2/carbon/identity/configuration/mgt/endpoint/impl/SearchApiServiceImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNzo1NDoxOVrOGrv3yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNDowNToxM1rOGr8sAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNjI4MQ==", "bodyText": "If tenant qualified URL is not enabled will this have an impact?\nIIRC, the thread-local gets populated on tenant qualified mode only, whereas this API is implemented to be accessible from a tenant in the path in the legacy way", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r448526281", "createdAt": "2020-07-01T17:54:19Z", "author": {"login": "malithie"}, "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.endpoint/src/main/java/org/wso2/carbon/identity/configuration/mgt/endpoint/impl/SearchApiServiceImpl.java", "diffHunk": "@@ -42,14 +44,20 @@\n public class SearchApiServiceImpl extends SearchApiService {\n \n     private static final Log LOG = LogFactory.getLog(SearchApiServiceImpl.class);\n+    private boolean allowCrossTenantSearch = Boolean.parseBoolean(IdentityUtil.getProperty(\"ConfigurationStore\" +\n+            \".AllowCrossTenantSearch\"));\n \n     @Override\n     public Response searchGet(SearchContext searchContext) {\n \n         try {\n-            Resources resources = getConfigurationManager().getTenantResources(\n-                    getSearchCondition(searchContext)\n-            );\n+            Resources resources;\n+            if (allowCrossTenantSearch) {\n+                resources = getConfigurationManager().getTenantResources(getSearchCondition(searchContext));\n+            } else {\n+                resources = getConfigurationManager().getTenantResources(IdentityTenantUtil\n+                                .getTenantDomainFromContext(), getSearchCondition(searchContext));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a84cfdda5fd231bd8bd30a6e6e041fa440c4bfc"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODczNjI1Ng==", "bodyText": "This worked as expected even when tenant qualified URL mode is disabled.", "url": "https://github.com/wso2/carbon-identity-framework/pull/2978#discussion_r448736256", "createdAt": "2020-07-02T04:05:13Z", "author": {"login": "emswbandara"}, "path": "components/configuration-mgt/org.wso2.carbon.identity.configuration.mgt.endpoint/src/main/java/org/wso2/carbon/identity/configuration/mgt/endpoint/impl/SearchApiServiceImpl.java", "diffHunk": "@@ -42,14 +44,20 @@\n public class SearchApiServiceImpl extends SearchApiService {\n \n     private static final Log LOG = LogFactory.getLog(SearchApiServiceImpl.class);\n+    private boolean allowCrossTenantSearch = Boolean.parseBoolean(IdentityUtil.getProperty(\"ConfigurationStore\" +\n+            \".AllowCrossTenantSearch\"));\n \n     @Override\n     public Response searchGet(SearchContext searchContext) {\n \n         try {\n-            Resources resources = getConfigurationManager().getTenantResources(\n-                    getSearchCondition(searchContext)\n-            );\n+            Resources resources;\n+            if (allowCrossTenantSearch) {\n+                resources = getConfigurationManager().getTenantResources(getSearchCondition(searchContext));\n+            } else {\n+                resources = getConfigurationManager().getTenantResources(IdentityTenantUtil\n+                                .getTenantDomainFromContext(), getSearchCondition(searchContext));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNjI4MQ=="}, "originalCommit": {"oid": "4a84cfdda5fd231bd8bd30a6e6e041fa440c4bfc"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2580, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}