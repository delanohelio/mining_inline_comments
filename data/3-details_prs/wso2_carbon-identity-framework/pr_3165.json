{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyNjM1MjI3", "number": 3165, "title": "[Fix] Non-existing roles as provisioning roles", "bodyText": "Resolves wso2/product-is#9590\nApproach\n\nCommit1: Refactoring error messages as client and server errors\nCommit2:\nResolves: wso2/product-is#9590\nApproach: Introduced a new method to RoleManagementService to check for the existing role names. Invoked the new API to check the existence of added roles.", "createdAt": "2020-10-13T17:54:01Z", "url": "https://github.com/wso2/carbon-identity-framework/pull/3165", "merged": true, "mergeCommit": {"oid": "b9d4381249749d8bc6e3176749cd8fa7ce1ba52d"}, "closed": true, "closedAt": "2020-10-14T15:36:10Z", "author": {"login": "somindatommy"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSNHZXgFqTUwNzczMDExNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSamJMABqjM4NzU4NTY4ODU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NzMwMTE2", "url": "https://github.com/wso2/carbon-identity-framework/pull/3165#pullrequestreview-507730116", "createdAt": "2020-10-13T18:43:25Z", "commit": {"oid": "b90664d65c4a684c2b1b21561752b984f278edc1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODo0MzoyNVrOHg0pRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODo0NDozOFrOHg0r1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3OTAxMw==", "bodyText": "I assume you want to show the list of non existing roles in the error response. In that case, this logic seems not to work when 2+ non-existing roles are given. In the 2nd iteration this will replace \"1st_role,\" with \"2nd_role\" instead of appending", "url": "https://github.com/wso2/carbon-identity-framework/pull/3165#discussion_r504179013", "createdAt": "2020-10-13T18:43:25Z", "author": {"login": "pulasthi7"}, "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/IdentityProviderManager.java", "diffHunk": "@@ -2880,4 +2883,43 @@ private String getIDPNameByMetadataProperty(Connection dbConnection, String prop\n \n         return idPName;\n     }\n+\n+    /**\n+     * Validate whether the outbound provisioning roles does exist.\n+     *\n+     * @param identityProvider IdentityProvider.\n+     * @param tenantDomain     Tenant Domain.\n+     * @throws IdentityProviderManagementException If an error occurred while checking for role existence.\n+     */\n+    private void validateOutboundProvisioningRoles(IdentityProvider identityProvider, String tenantDomain)\n+            throws IdentityProviderManagementException {\n+\n+        String provisioningRole = identityProvider.getProvisioningRole();\n+        if (StringUtils.isBlank(provisioningRole)) {\n+            return;\n+        }\n+        String[] outboundProvisioningRoles = StringUtils.split(provisioningRole, \",\");\n+\n+        try {\n+            String notExistingRoles = null;\n+            RoleManagementService roleManagementService =\n+                    IdpMgtServiceComponentHolder.getInstance().getRoleManagementService();\n+            for (String roleName : outboundProvisioningRoles) {\n+                if (StringUtils.isNotBlank(notExistingRoles)) {\n+                    notExistingRoles = notExistingRoles + \",\";\n+                }\n+                if (!roleManagementService.isExistingRoleName(roleName, tenantDomain)) {\n+                    notExistingRoles = roleName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b90664d65c4a684c2b1b21561752b984f278edc1"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3OTY3MA==", "bodyText": "are we handling this exception properly? In case of this exception, we need to have the old behavior, which is to continue without validation", "url": "https://github.com/wso2/carbon-identity-framework/pull/3165#discussion_r504179670", "createdAt": "2020-10-13T18:44:38Z", "author": {"login": "pulasthi7"}, "path": "components/role-mgt/org.wso2.carbon.identity.role.mgt.core/src/main/java/org/wso2/carbon/identity/role/mgt/core/RoleManagementService.java", "diffHunk": "@@ -175,4 +175,17 @@ RoleBasicInfo setPermissionsForRole(String roleID, List<String> permissions, Str\n      * @throws IdentityRoleManagementException IdentityRoleManagementException.\n      */\n     boolean isExistingRole(String roleID, String tenantDomain) throws IdentityRoleManagementException;\n+\n+    /**\n+     * Check whether the given role name exist.\n+     *\n+     * @param roleName     Role name.\n+     * @param tenantDomain Tenant domain.\n+     * @return {@code true} if the the given role ID exist.\n+     * @throws IdentityRoleManagementException IdentityRoleManagementException.\n+     */\n+    default boolean isExistingRoleName(String roleName, String tenantDomain) throws IdentityRoleManagementException {\n+\n+        throw new IdentityRoleManagementException(\"isExistingRoleName method is not implemented\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b90664d65c4a684c2b1b21561752b984f278edc1"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MDIyODUw", "url": "https://github.com/wso2/carbon-identity-framework/pull/3165#pullrequestreview-508022850", "createdAt": "2020-10-14T06:13:29Z", "commit": {"oid": "6e0fc1ec8b588b6e08171f9343bb2064ccb46263"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "967eea8b87cf20a5310005e358379d47a53ad282", "author": {"user": {"login": "somindatommy", "name": "Sominda Gamage"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/967eea8b87cf20a5310005e358379d47a53ad282", "committedDate": "2020-10-14T10:14:13Z", "message": "Refactoring error messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2724f22f051c970456628d0c2103b1fab9f94c63", "author": {"user": {"login": "somindatommy", "name": "Sominda Gamage"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/2724f22f051c970456628d0c2103b1fab9f94c63", "committedDate": "2020-10-14T10:14:39Z", "message": "[Fix] Non-existing roles as provisioning roles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "536a74c51345b05e84630e4cdda5378fc92c7ba5", "author": {"user": {"login": "somindatommy", "name": "Sominda Gamage"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/536a74c51345b05e84630e4cdda5378fc92c7ba5", "committedDate": "2020-10-14T10:14:40Z", "message": "handling NotImplementedException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10179be9cd5a1e194a0c555ca341cc439a8d1e06", "author": {"user": {"login": "somindatommy", "name": "Sominda Gamage"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/10179be9cd5a1e194a0c555ca341cc439a8d1e06", "committedDate": "2020-10-14T10:14:40Z", "message": "Refactoring role validation error message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e0fc1ec8b588b6e08171f9343bb2064ccb46263", "author": {"user": {"login": "somindatommy", "name": "Sominda Gamage"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/6e0fc1ec8b588b6e08171f9343bb2064ccb46263", "committedDate": "2020-10-14T05:40:15Z", "message": "Refactoring role validation error message"}, "afterCommit": {"oid": "10179be9cd5a1e194a0c555ca341cc439a8d1e06", "author": {"user": {"login": "somindatommy", "name": "Sominda Gamage"}}, "url": "https://github.com/wso2/carbon-identity-framework/commit/10179be9cd5a1e194a0c555ca341cc439a8d1e06", "committedDate": "2020-10-14T10:14:40Z", "message": "Refactoring role validation error message"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2203, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}