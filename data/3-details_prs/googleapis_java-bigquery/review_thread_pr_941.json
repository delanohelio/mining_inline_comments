{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwMTIzODE1", "number": 941, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDozMDozNVrOE4V7lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxOTowNjozNlrOE4y75g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NTE1MDMwOnYy", "diffSide": "RIGHT", "path": "google-cloud-bigquery/src/main/java/com/google/cloud/bigquery/BigQueryImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDozMDozNVrOHyNOMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjo1MDo0OVrOHy2BjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQwNzQ3Mw==", "bodyText": "This block reads quite confusing now.\nconsider flipping it..\nif (results.getJobComplete() && results.getSchema() != null) {\nschema = Schema.fromPb(results.getSchema());\n// Your logic below for numRows, numDml...\n} else {\nJobId jobId = ....\n....\n}", "url": "https://github.com/googleapis/java-bigquery/pull/941#discussion_r522407473", "createdAt": "2020-11-12T20:30:35Z", "author": {"login": "epavan123"}, "path": "google-cloud-bigquery/src/main/java/com/google/cloud/bigquery/BigQueryImpl.java", "diffHunk": "@@ -1268,7 +1268,7 @@ private TableResult queryRpc(\n \n     long numRows;\n     Schema schema;\n-    if (results.getSchema() == null && results.getJobComplete()) {\n+    if ((results.getSchema() == null && results.getJobComplete()) || !results.getJobComplete()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd75e609c70208c04d79221c2188fbc564a739ec"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3NTk4MQ==", "bodyText": "done", "url": "https://github.com/googleapis/java-bigquery/pull/941#discussion_r523075981", "createdAt": "2020-11-13T16:50:49Z", "author": {"login": "stephaniewang526"}, "path": "google-cloud-bigquery/src/main/java/com/google/cloud/bigquery/BigQueryImpl.java", "diffHunk": "@@ -1268,7 +1268,7 @@ private TableResult queryRpc(\n \n     long numRows;\n     Schema schema;\n-    if (results.getSchema() == null && results.getJobComplete()) {\n+    if ((results.getSchema() == null && results.getJobComplete()) || !results.getJobComplete()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQwNzQ3Mw=="}, "originalCommit": {"oid": "fd75e609c70208c04d79221c2188fbc564a739ec"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NTE1MjkzOnYy", "diffSide": "RIGHT", "path": "google-cloud-bigquery/src/test/java/com/google/cloud/bigquery/it/ITBigQueryTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDozMToxOFrOHyNPyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjo1MDo1NVrOHy2Byg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQwNzg4MA==", "bodyText": "Please also add a mock test showing that the subsequent getQueryResults call gets made.", "url": "https://github.com/googleapis/java-bigquery/pull/941#discussion_r522407880", "createdAt": "2020-11-12T20:31:18Z", "author": {"login": "epavan123"}, "path": "google-cloud-bigquery/src/test/java/com/google/cloud/bigquery/it/ITBigQueryTest.java", "diffHunk": "@@ -1813,6 +1813,36 @@ public void testFastDDLQuery() throws InterruptedException {\n     }\n   }\n \n+  @Test\n+  public void testFastQuerySlowDDL() throws InterruptedException {\n+    String tableName =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd75e609c70208c04d79221c2188fbc564a739ec"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3NjA0Mg==", "bodyText": "done", "url": "https://github.com/googleapis/java-bigquery/pull/941#discussion_r523076042", "createdAt": "2020-11-13T16:50:55Z", "author": {"login": "stephaniewang526"}, "path": "google-cloud-bigquery/src/test/java/com/google/cloud/bigquery/it/ITBigQueryTest.java", "diffHunk": "@@ -1813,6 +1813,36 @@ public void testFastDDLQuery() throws InterruptedException {\n     }\n   }\n \n+  @Test\n+  public void testFastQuerySlowDDL() throws InterruptedException {\n+    String tableName =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQwNzg4MA=="}, "originalCommit": {"oid": "fd75e609c70208c04d79221c2188fbc564a739ec"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3OTg4NTc0OnYy", "diffSide": "RIGHT", "path": "google-cloud-bigquery/src/main/java/com/google/cloud/bigquery/BigQueryImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxOTowMTowNFrOHy7YnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxOTowMzo0NVrOHy7dhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE2MzgwNA==", "bodyText": "Please add a comment here.\n// Query is long running (> 10s) and hasn't completed yet, or query completed but didn't return the schema, fallback. Some operations don't return the schema and can be optimized here, but this is left as future work.", "url": "https://github.com/googleapis/java-bigquery/pull/941#discussion_r523163804", "createdAt": "2020-11-13T19:01:04Z", "author": {"login": "epavan123"}, "path": "google-cloud-bigquery/src/main/java/com/google/cloud/bigquery/BigQueryImpl.java", "diffHunk": "@@ -1268,20 +1268,20 @@ private TableResult queryRpc(\n \n     long numRows;\n     Schema schema;\n-    if (results.getSchema() == null && results.getJobComplete()) {\n-      JobId jobId = JobId.fromPb(results.getJobReference());\n-      Job job = getJob(jobId, options);\n-      TableResult tableResult = job.getQueryResults();\n-      return tableResult;\n-    } else {\n-      schema = results.getSchema() == null ? null : Schema.fromPb(results.getSchema());\n+    if (results.getJobComplete() && results.getSchema() != null) {\n+      schema = Schema.fromPb(results.getSchema());\n       if (results.getNumDmlAffectedRows() == null && results.getTotalRows() == null) {\n         numRows = 0L;\n       } else if (results.getNumDmlAffectedRows() != null) {\n         numRows = results.getNumDmlAffectedRows();\n       } else {\n         numRows = results.getTotalRows().longValue();\n       }\n+    } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e561ab4956a49a0ea297dfcb95d0ae9c308c047c"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE2NTA2MQ==", "bodyText": "done", "url": "https://github.com/googleapis/java-bigquery/pull/941#discussion_r523165061", "createdAt": "2020-11-13T19:03:45Z", "author": {"login": "stephaniewang526"}, "path": "google-cloud-bigquery/src/main/java/com/google/cloud/bigquery/BigQueryImpl.java", "diffHunk": "@@ -1268,20 +1268,20 @@ private TableResult queryRpc(\n \n     long numRows;\n     Schema schema;\n-    if (results.getSchema() == null && results.getJobComplete()) {\n-      JobId jobId = JobId.fromPb(results.getJobReference());\n-      Job job = getJob(jobId, options);\n-      TableResult tableResult = job.getQueryResults();\n-      return tableResult;\n-    } else {\n-      schema = results.getSchema() == null ? null : Schema.fromPb(results.getSchema());\n+    if (results.getJobComplete() && results.getSchema() != null) {\n+      schema = Schema.fromPb(results.getSchema());\n       if (results.getNumDmlAffectedRows() == null && results.getTotalRows() == null) {\n         numRows = 0L;\n       } else if (results.getNumDmlAffectedRows() != null) {\n         numRows = results.getNumDmlAffectedRows();\n       } else {\n         numRows = results.getTotalRows().longValue();\n       }\n+    } else {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE2MzgwNA=="}, "originalCommit": {"oid": "e561ab4956a49a0ea297dfcb95d0ae9c308c047c"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3OTkwMjQ2OnYy", "diffSide": "RIGHT", "path": "google-cloud-bigquery/src/main/java/com/google/cloud/bigquery/BigQueryImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxOTowNjozNlrOHy7i6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxOTo0MDoxNlrOHy8kAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE2NjQ0MA==", "bodyText": "nit: simplify as return job.getQueryResults(); ?", "url": "https://github.com/googleapis/java-bigquery/pull/941#discussion_r523166440", "createdAt": "2020-11-13T19:06:36Z", "author": {"login": "shollyman"}, "path": "google-cloud-bigquery/src/main/java/com/google/cloud/bigquery/BigQueryImpl.java", "diffHunk": "@@ -1268,20 +1268,23 @@ private TableResult queryRpc(\n \n     long numRows;\n     Schema schema;\n-    if (results.getSchema() == null && results.getJobComplete()) {\n-      JobId jobId = JobId.fromPb(results.getJobReference());\n-      Job job = getJob(jobId, options);\n-      TableResult tableResult = job.getQueryResults();\n-      return tableResult;\n-    } else {\n-      schema = results.getSchema() == null ? null : Schema.fromPb(results.getSchema());\n+    if (results.getJobComplete() && results.getSchema() != null) {\n+      schema = Schema.fromPb(results.getSchema());\n       if (results.getNumDmlAffectedRows() == null && results.getTotalRows() == null) {\n         numRows = 0L;\n       } else if (results.getNumDmlAffectedRows() != null) {\n         numRows = results.getNumDmlAffectedRows();\n       } else {\n         numRows = results.getTotalRows().longValue();\n       }\n+    } else {\n+      // Query is long running (> 10s) and hasn't completed yet, or query completed but didn't\n+      // return the schema, fallback. Some operations don't return the schema and can be optimized\n+      // here, but this is left as future work.\n+      JobId jobId = JobId.fromPb(results.getJobReference());\n+      Job job = getJob(jobId, options);\n+      TableResult tableResult = job.getQueryResults();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a782a827fc5efe2bad3b0f102e5f3dae2d717c0"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE4MzEwNQ==", "bodyText": "done - ty!", "url": "https://github.com/googleapis/java-bigquery/pull/941#discussion_r523183105", "createdAt": "2020-11-13T19:40:16Z", "author": {"login": "stephaniewang526"}, "path": "google-cloud-bigquery/src/main/java/com/google/cloud/bigquery/BigQueryImpl.java", "diffHunk": "@@ -1268,20 +1268,23 @@ private TableResult queryRpc(\n \n     long numRows;\n     Schema schema;\n-    if (results.getSchema() == null && results.getJobComplete()) {\n-      JobId jobId = JobId.fromPb(results.getJobReference());\n-      Job job = getJob(jobId, options);\n-      TableResult tableResult = job.getQueryResults();\n-      return tableResult;\n-    } else {\n-      schema = results.getSchema() == null ? null : Schema.fromPb(results.getSchema());\n+    if (results.getJobComplete() && results.getSchema() != null) {\n+      schema = Schema.fromPb(results.getSchema());\n       if (results.getNumDmlAffectedRows() == null && results.getTotalRows() == null) {\n         numRows = 0L;\n       } else if (results.getNumDmlAffectedRows() != null) {\n         numRows = results.getNumDmlAffectedRows();\n       } else {\n         numRows = results.getTotalRows().longValue();\n       }\n+    } else {\n+      // Query is long running (> 10s) and hasn't completed yet, or query completed but didn't\n+      // return the schema, fallback. Some operations don't return the schema and can be optimized\n+      // here, but this is left as future work.\n+      JobId jobId = JobId.fromPb(results.getJobReference());\n+      Job job = getJob(jobId, options);\n+      TableResult tableResult = job.getQueryResults();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE2NjQ0MA=="}, "originalCommit": {"oid": "6a782a827fc5efe2bad3b0f102e5f3dae2d717c0"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3574, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}