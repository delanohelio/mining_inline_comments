{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwMTIzODE1", "number": 941, "title": "fix: make sure to fall back to old query path when query job is incomplete", "bodyText": "When the query job takes more than 10s we must fall back to the old query path!\ncc @epavan", "createdAt": "2020-11-12T19:58:45Z", "url": "https://github.com/googleapis/java-bigquery/pull/941", "merged": true, "mergeCommit": {"oid": "bd7d85c489cd260feeabbdc9ecbb8dcdc8d9ae77"}, "closed": true, "closedAt": "2020-11-13T19:40:08Z", "author": {"login": "stephaniewang526"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdb4JWMgH2gAyNTIwMTIzODE1OjQyMzEwNTdjYTk4YmYwYzc2ZDYxNTYzMGYwYzAzMzJjYzM0OWZmNmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcMKlOAH2gAyNTIwMTIzODE1OjVhYTBmN2Y4M2UzNWQ2NDFjZjc5NzgyYTQyZDNhOWJiYWMwZmIyMDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4231057ca98bf0c76d615630f0c0332cc349ff6b", "author": {"user": {"login": "stephaniewang526", "name": "Stephanie Wang"}}, "url": "https://github.com/googleapis/java-bigquery/commit/4231057ca98bf0c76d615630f0c0332cc349ff6b", "committedDate": "2020-11-12T19:58:05Z", "message": "fix: make sure to fall back to old query path when query job is incomplete (takes more than 10s)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd75e609c70208c04d79221c2188fbc564a739ec", "author": {"user": {"login": "stephaniewang526", "name": "Stephanie Wang"}}, "url": "https://github.com/googleapis/java-bigquery/commit/fd75e609c70208c04d79221c2188fbc564a739ec", "committedDate": "2020-11-12T19:59:59Z", "message": "nit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NDczMjcz", "url": "https://github.com/googleapis/java-bigquery/pull/941#pullrequestreview-529473273", "createdAt": "2020-11-12T20:30:35Z", "commit": {"oid": "fd75e609c70208c04d79221c2188fbc564a739ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDozMDozNVrOHyNOMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDozMDozNVrOHyNOMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQwNzQ3Mw==", "bodyText": "This block reads quite confusing now.\nconsider flipping it..\nif (results.getJobComplete() && results.getSchema() != null) {\nschema = Schema.fromPb(results.getSchema());\n// Your logic below for numRows, numDml...\n} else {\nJobId jobId = ....\n....\n}", "url": "https://github.com/googleapis/java-bigquery/pull/941#discussion_r522407473", "createdAt": "2020-11-12T20:30:35Z", "author": {"login": "epavan123"}, "path": "google-cloud-bigquery/src/main/java/com/google/cloud/bigquery/BigQueryImpl.java", "diffHunk": "@@ -1268,7 +1268,7 @@ private TableResult queryRpc(\n \n     long numRows;\n     Schema schema;\n-    if (results.getSchema() == null && results.getJobComplete()) {\n+    if ((results.getSchema() == null && results.getJobComplete()) || !results.getJobComplete()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd75e609c70208c04d79221c2188fbc564a739ec"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NDczODM1", "url": "https://github.com/googleapis/java-bigquery/pull/941#pullrequestreview-529473835", "createdAt": "2020-11-12T20:31:18Z", "commit": {"oid": "fd75e609c70208c04d79221c2188fbc564a739ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDozMToxOFrOHyNPyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDozMToxOFrOHyNPyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQwNzg4MA==", "bodyText": "Please also add a mock test showing that the subsequent getQueryResults call gets made.", "url": "https://github.com/googleapis/java-bigquery/pull/941#discussion_r522407880", "createdAt": "2020-11-12T20:31:18Z", "author": {"login": "epavan123"}, "path": "google-cloud-bigquery/src/test/java/com/google/cloud/bigquery/it/ITBigQueryTest.java", "diffHunk": "@@ -1813,6 +1813,36 @@ public void testFastDDLQuery() throws InterruptedException {\n     }\n   }\n \n+  @Test\n+  public void testFastQuerySlowDDL() throws InterruptedException {\n+    String tableName =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd75e609c70208c04d79221c2188fbc564a739ec"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e561ab4956a49a0ea297dfcb95d0ae9c308c047c", "author": {"user": {"login": "stephaniewang526", "name": "Stephanie Wang"}}, "url": "https://github.com/googleapis/java-bigquery/commit/e561ab4956a49a0ea297dfcb95d0ae9c308c047c", "committedDate": "2020-11-13T16:46:03Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMjQ1Njg4", "url": "https://github.com/googleapis/java-bigquery/pull/941#pullrequestreview-530245688", "createdAt": "2020-11-13T17:08:09Z", "commit": {"oid": "e561ab4956a49a0ea297dfcb95d0ae9c308c047c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMzI5NDg2", "url": "https://github.com/googleapis/java-bigquery/pull/941#pullrequestreview-530329486", "createdAt": "2020-11-13T19:01:04Z", "commit": {"oid": "e561ab4956a49a0ea297dfcb95d0ae9c308c047c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxOTowMTowNFrOHy7YnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxOTowMTowNFrOHy7YnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE2MzgwNA==", "bodyText": "Please add a comment here.\n// Query is long running (> 10s) and hasn't completed yet, or query completed but didn't return the schema, fallback. Some operations don't return the schema and can be optimized here, but this is left as future work.", "url": "https://github.com/googleapis/java-bigquery/pull/941#discussion_r523163804", "createdAt": "2020-11-13T19:01:04Z", "author": {"login": "epavan123"}, "path": "google-cloud-bigquery/src/main/java/com/google/cloud/bigquery/BigQueryImpl.java", "diffHunk": "@@ -1268,20 +1268,20 @@ private TableResult queryRpc(\n \n     long numRows;\n     Schema schema;\n-    if (results.getSchema() == null && results.getJobComplete()) {\n-      JobId jobId = JobId.fromPb(results.getJobReference());\n-      Job job = getJob(jobId, options);\n-      TableResult tableResult = job.getQueryResults();\n-      return tableResult;\n-    } else {\n-      schema = results.getSchema() == null ? null : Schema.fromPb(results.getSchema());\n+    if (results.getJobComplete() && results.getSchema() != null) {\n+      schema = Schema.fromPb(results.getSchema());\n       if (results.getNumDmlAffectedRows() == null && results.getTotalRows() == null) {\n         numRows = 0L;\n       } else if (results.getNumDmlAffectedRows() != null) {\n         numRows = results.getNumDmlAffectedRows();\n       } else {\n         numRows = results.getTotalRows().longValue();\n       }\n+    } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e561ab4956a49a0ea297dfcb95d0ae9c308c047c"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMzI5NTM3", "url": "https://github.com/googleapis/java-bigquery/pull/941#pullrequestreview-530329537", "createdAt": "2020-11-13T19:01:09Z", "commit": {"oid": "e561ab4956a49a0ea297dfcb95d0ae9c308c047c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a782a827fc5efe2bad3b0f102e5f3dae2d717c0", "author": {"user": {"login": "stephaniewang526", "name": "Stephanie Wang"}}, "url": "https://github.com/googleapis/java-bigquery/commit/6a782a827fc5efe2bad3b0f102e5f3dae2d717c0", "committedDate": "2020-11-13T19:03:37Z", "message": "add comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMzMzMTQ0", "url": "https://github.com/googleapis/java-bigquery/pull/941#pullrequestreview-530333144", "createdAt": "2020-11-13T19:06:35Z", "commit": {"oid": "6a782a827fc5efe2bad3b0f102e5f3dae2d717c0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxOTowNjozNlrOHy7i6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxOTowNjozNlrOHy7i6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE2NjQ0MA==", "bodyText": "nit: simplify as return job.getQueryResults(); ?", "url": "https://github.com/googleapis/java-bigquery/pull/941#discussion_r523166440", "createdAt": "2020-11-13T19:06:36Z", "author": {"login": "shollyman"}, "path": "google-cloud-bigquery/src/main/java/com/google/cloud/bigquery/BigQueryImpl.java", "diffHunk": "@@ -1268,20 +1268,23 @@ private TableResult queryRpc(\n \n     long numRows;\n     Schema schema;\n-    if (results.getSchema() == null && results.getJobComplete()) {\n-      JobId jobId = JobId.fromPb(results.getJobReference());\n-      Job job = getJob(jobId, options);\n-      TableResult tableResult = job.getQueryResults();\n-      return tableResult;\n-    } else {\n-      schema = results.getSchema() == null ? null : Schema.fromPb(results.getSchema());\n+    if (results.getJobComplete() && results.getSchema() != null) {\n+      schema = Schema.fromPb(results.getSchema());\n       if (results.getNumDmlAffectedRows() == null && results.getTotalRows() == null) {\n         numRows = 0L;\n       } else if (results.getNumDmlAffectedRows() != null) {\n         numRows = results.getNumDmlAffectedRows();\n       } else {\n         numRows = results.getTotalRows().longValue();\n       }\n+    } else {\n+      // Query is long running (> 10s) and hasn't completed yet, or query completed but didn't\n+      // return the schema, fallback. Some operations don't return the schema and can be optimized\n+      // here, but this is left as future work.\n+      JobId jobId = JobId.fromPb(results.getJobReference());\n+      Job job = getJob(jobId, options);\n+      TableResult tableResult = job.getQueryResults();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a782a827fc5efe2bad3b0f102e5f3dae2d717c0"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5aa0f7f83e35d641cf79782a42d3a9bbac0fb206", "author": {"user": {"login": "stephaniewang526", "name": "Stephanie Wang"}}, "url": "https://github.com/googleapis/java-bigquery/commit/5aa0f7f83e35d641cf79782a42d3a9bbac0fb206", "committedDate": "2020-11-13T19:17:32Z", "message": "nit update"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1305, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}