{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3OTc4NjU1", "number": 637, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQxMToxMTowMlrOEYsL3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQxMToxMTowMlrOEYsL3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0MzI1MjEyOnYy", "diffSide": "RIGHT", "path": "snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/request/SnomedConceptMapSearchRequestEvaluator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQxMToxMTowMlrOHBJhZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjoxNTowOVrOHBa78Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NjYzMA==", "bodyText": "Missing all() or explicit setLimit call.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/637#discussion_r470966630", "createdAt": "2020-08-15T11:11:02Z", "author": {"login": "cmark"}, "path": "snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/request/SnomedConceptMapSearchRequestEvaluator.java", "diffHunk": "@@ -61,36 +62,41 @@\n \t@Override\n \tpublic ConceptMapMappings evaluate(CodeSystemURI uri, BranchContext context, Options search) {\n \t\tSnomedReferenceSetMembers referenceSetMembers = fetchRefsetMembers(uri, context, search);\n-\t\treturn toCollectionResource(referenceSetMembers, uri, context);\n+\t\treturn toCollectionResource(referenceSetMembers, uri, context, search);\n \t}\n \n-\tprivate ConceptMapMappings toCollectionResource(SnomedReferenceSetMembers referenceSetMembers, CodeSystemURI uri, BranchContext context) {\n+\tprivate ConceptMapMappings toCollectionResource(SnomedReferenceSetMembers referenceSetMembers, CodeSystemURI uri, BranchContext context, Options search) {\n+\t\tMap<String, ComponentURI> targetComponentMap = getTargetComponentMap(context, search);\n \t\tList<ConceptMapMapping> mappings = referenceSetMembers.stream()\n \t\t\t\t.filter(m -> SnomedTerminologyComponentConstants.CONCEPT_NUMBER == m.getReferencedComponent().getTerminologyComponentId())\n-\t\t\t\t.map(m -> toMapping(m, uri, getTargetComponentURI(context, m.getReferenceSetId())))\n+\t\t\t\t.map(m -> {\n+\t\t\t\t\treturn toMapping(m, uri, targetComponentMap.get(m.getReferenceSetId()));\n+\t\t\t\t})\n \t\t\t\t.collect(Collectors.toList());\n \t\t\n \t\tif (!mappings.isEmpty()) {\n-\t\t\tSet<String> targetComponentURIs = mappings.stream().map(ConceptMapMapping::getTargetComponentURI).map(ComponentURI::identifier).collect(Collectors.toSet());\n-\t\t\t\n-\t\t\tMap<String, Concept> mapTargetsById = CodeSystemRequests.prepareSearchConcepts()\n-\t\t\t\t.filterByIds(targetComponentURIs)\n-\t\t\t\t.build(mappings.stream().findFirst().get().getTargetComponentURI().codeSystemUri())\n-\t\t\t\t.execute(context.service(IEventBus.class))\n-\t\t\t\t.getSync(5, TimeUnit.MINUTES)\n-\t\t\t\t.stream()\n-\t\t\t\t.collect(Collectors.toMap(Concept::getId, c -> c));\n-\t\t\t\n-\t\t\tmappings = mappings.stream().map(mapping -> {\n-\t\t\t\tfinal String mapTarget = mapping.getTargetComponentURI().identifier();\n-\t\t\t\tif (mapTargetsById.containsKey(mapTarget)) {\n-\t\t\t\t\treturn mapping.toBuilder()\n-\t\t\t\t\t\t.targetTerm(mapTargetsById.get(mapTarget).getTerm())\n-\t\t\t\t\t\t.build();\n-\t\t\t\t} else {\n-\t\t\t\t\treturn mapping;\n-\t\t\t\t}\n-\t\t\t}).collect(Collectors.toList());\n+\t\t\tSet<String> targetIds = mappings.stream().map(ConceptMapMapping::getTargetComponentURI).map(ComponentURI::identifier).collect(Collectors.toSet());\n+\t\t\tString codeSystem = mappings.stream().findFirst().get().getTargetComponentURI().codeSystem();\n+\n+\t\t\tif (!ComponentURI.UNSPECIFIED.codeSystem().equals(codeSystem)) {\n+\t\t\t\tMap<String, Concept> mapTargetsById = CodeSystemRequests.prepareSearchConcepts()\n+\t\t\t\t\t\t.filterByIds(targetIds)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "125e3ba71e5982972f566a74677bd62ce721c437"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1MTk1Mw==", "bodyText": "Done", "url": "https://github.com/b2ihealthcare/snow-owl/pull/637#discussion_r471251953", "createdAt": "2020-08-17T06:15:09Z", "author": {"login": "molnarlaura"}, "path": "snomed/com.b2international.snowowl.snomed.datastore/src/com/b2international/snowowl/snomed/datastore/request/SnomedConceptMapSearchRequestEvaluator.java", "diffHunk": "@@ -61,36 +62,41 @@\n \t@Override\n \tpublic ConceptMapMappings evaluate(CodeSystemURI uri, BranchContext context, Options search) {\n \t\tSnomedReferenceSetMembers referenceSetMembers = fetchRefsetMembers(uri, context, search);\n-\t\treturn toCollectionResource(referenceSetMembers, uri, context);\n+\t\treturn toCollectionResource(referenceSetMembers, uri, context, search);\n \t}\n \n-\tprivate ConceptMapMappings toCollectionResource(SnomedReferenceSetMembers referenceSetMembers, CodeSystemURI uri, BranchContext context) {\n+\tprivate ConceptMapMappings toCollectionResource(SnomedReferenceSetMembers referenceSetMembers, CodeSystemURI uri, BranchContext context, Options search) {\n+\t\tMap<String, ComponentURI> targetComponentMap = getTargetComponentMap(context, search);\n \t\tList<ConceptMapMapping> mappings = referenceSetMembers.stream()\n \t\t\t\t.filter(m -> SnomedTerminologyComponentConstants.CONCEPT_NUMBER == m.getReferencedComponent().getTerminologyComponentId())\n-\t\t\t\t.map(m -> toMapping(m, uri, getTargetComponentURI(context, m.getReferenceSetId())))\n+\t\t\t\t.map(m -> {\n+\t\t\t\t\treturn toMapping(m, uri, targetComponentMap.get(m.getReferenceSetId()));\n+\t\t\t\t})\n \t\t\t\t.collect(Collectors.toList());\n \t\t\n \t\tif (!mappings.isEmpty()) {\n-\t\t\tSet<String> targetComponentURIs = mappings.stream().map(ConceptMapMapping::getTargetComponentURI).map(ComponentURI::identifier).collect(Collectors.toSet());\n-\t\t\t\n-\t\t\tMap<String, Concept> mapTargetsById = CodeSystemRequests.prepareSearchConcepts()\n-\t\t\t\t.filterByIds(targetComponentURIs)\n-\t\t\t\t.build(mappings.stream().findFirst().get().getTargetComponentURI().codeSystemUri())\n-\t\t\t\t.execute(context.service(IEventBus.class))\n-\t\t\t\t.getSync(5, TimeUnit.MINUTES)\n-\t\t\t\t.stream()\n-\t\t\t\t.collect(Collectors.toMap(Concept::getId, c -> c));\n-\t\t\t\n-\t\t\tmappings = mappings.stream().map(mapping -> {\n-\t\t\t\tfinal String mapTarget = mapping.getTargetComponentURI().identifier();\n-\t\t\t\tif (mapTargetsById.containsKey(mapTarget)) {\n-\t\t\t\t\treturn mapping.toBuilder()\n-\t\t\t\t\t\t.targetTerm(mapTargetsById.get(mapTarget).getTerm())\n-\t\t\t\t\t\t.build();\n-\t\t\t\t} else {\n-\t\t\t\t\treturn mapping;\n-\t\t\t\t}\n-\t\t\t}).collect(Collectors.toList());\n+\t\t\tSet<String> targetIds = mappings.stream().map(ConceptMapMapping::getTargetComponentURI).map(ComponentURI::identifier).collect(Collectors.toSet());\n+\t\t\tString codeSystem = mappings.stream().findFirst().get().getTargetComponentURI().codeSystem();\n+\n+\t\t\tif (!ComponentURI.UNSPECIFIED.codeSystem().equals(codeSystem)) {\n+\t\t\t\tMap<String, Concept> mapTargetsById = CodeSystemRequests.prepareSearchConcepts()\n+\t\t\t\t\t\t.filterByIds(targetIds)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NjYzMA=="}, "originalCommit": {"oid": "125e3ba71e5982972f566a74677bd62ce721c437"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1652, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}