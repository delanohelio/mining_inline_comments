{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MTY1Mjc0", "number": 709, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwOTo0MDoxNlrOE3JB1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMDowOTozMVrOE3JztQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MjU1MDYxOnYy", "diffSide": "RIGHT", "path": "core/com.b2international.snowowl.core/src/com/b2international/snowowl/core/repository/RepositoryTransactionContext.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwOTo0MDoxNlrOHwT_yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwOTo0MDoxNlrOHwT_yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyMTMyMg==", "bodyText": "It turns out there is exactly one caller of TransactionContext#commit that is interested in the timestamp, returned via a CommitResult instance: \n  \n    \n      snow-owl/snomed/com.b2international.snowowl.snomed.reasoner/src/com/b2international/snowowl/snomed/reasoner/request/SaveJobRequest.java\n    \n    \n         Line 216\n      in\n      7f5e60d\n    \n    \n    \n    \n\n        \n          \n           classificationTracker.classificationSaved(classificationId, commitResult.getCommitTimestamp());", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520421322", "createdAt": "2020-11-10T09:40:16Z", "author": {"login": "apeteri"}, "path": "core/com.b2international.snowowl.core/src/com/b2international/snowowl/core/repository/RepositoryTransactionContext.java", "diffHunk": "@@ -280,7 +280,7 @@ public Long commit(String author, String commitComment, String parentLockContext\n \t\t\tlog().info(\"Persisting changes to {}@{}\", path(), timestamp);\n \t\t\tcommit = staging.commit(null, timestamp, author, commitComment);\n \t\t\tlog().info(\"Changes have been successfully persisted to {}@{}.\", path(), timestamp);\n-\t\t\treturn commit == null ? null : commit.getTimestamp();\n+\t\t\treturn commit == null ? Commit.NO_COMMIT_TIMESTAMP : commit.getTimestamp();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b28663442d251360ffcfda2cd02ed1b0148fc17"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MjU4MTU2OnYy", "diffSide": "LEFT", "path": "commons/com.b2international.index/src/com/b2international/index/revision/Revision.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwOTo0NzoxNVrOHwUSgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwOTo0NzoxNVrOHwUSgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNjExMw==", "bodyText": "Please add a comment somewhere that this field is only updated in Elasticsearch via the updateRevised script defined at the top, is never de-serialized (so if one looks at a Revision instance, it will not contain the revised branch+timestamp pairs) and is used in ES search expressions only.\nI got a bit confused when I saw that the setter could be removed, Jackson is only using the field when converting to JSON, it is always initialized with an empty list and no one is interested in the contents in Java either \ud83d\ude03", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520426113", "createdAt": "2020-11-10T09:47:15Z", "author": {"login": "apeteri"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/Revision.java", "diffHunk": "@@ -73,10 +76,6 @@ final void setCreated(RevisionBranchPoint created) {\n \t\tthis.created = created;\n \t}\n \t\n-\tfinal void setRevised(List<RevisionBranchPoint> revised) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b28663442d251360ffcfda2cd02ed1b0148fc17"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MjU5NTA2OnYy", "diffSide": "LEFT", "path": "commons/com.b2international.index/src/com/b2international/index/revision/Revision.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwOTo1MDoyOVrOHwUa0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMDo1MDoyNVrOHwW1-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyODI0Mw==", "bodyText": "The inner Builder class could also be pushed down to RevisionDocument, like this method.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520428243", "createdAt": "2020-11-10T09:50:29Z", "author": {"login": "apeteri"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/Revision.java", "diffHunk": "@@ -122,15 +112,6 @@ protected ToStringHelper doToString() {\n \t\t\t\t.add(Revision.Fields.REVISED, revised);\n \t}\n \t\n-\t/**\n-\t * Converts an immutable object into a mutable builder with the usual prefixless setter methods.\n-\t * \n-\t * @return\n-\t */\n-\tprotected Builder<?, ? extends Revision> toBuilder() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b28663442d251360ffcfda2cd02ed1b0148fc17"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ2MjQ0Nw==", "bodyText": "Yes, true, but there is one class that has this method implemented in the index.tests sources.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520462447", "createdAt": "2020-11-10T10:41:45Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/Revision.java", "diffHunk": "@@ -122,15 +112,6 @@ protected ToStringHelper doToString() {\n \t\t\t\t.add(Revision.Fields.REVISED, revised);\n \t}\n \t\n-\t/**\n-\t * Converts an immutable object into a mutable builder with the usual prefixless setter methods.\n-\t * \n-\t * @return\n-\t */\n-\tprotected Builder<?, ? extends Revision> toBuilder() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyODI0Mw=="}, "originalCommit": {"oid": "8b28663442d251360ffcfda2cd02ed1b0148fc17"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ2Nzk2MA==", "bodyText": "It is used by a handful of rebase tests in RevisionBranchMergeConflictTest which could be replaced with withXYZ methods (making the builder on RevisionData also redundant, and allowing this refactor to take place). They take the revision and change a single field on it.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520467960", "createdAt": "2020-11-10T10:50:25Z", "author": {"login": "apeteri"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/Revision.java", "diffHunk": "@@ -122,15 +112,6 @@ protected ToStringHelper doToString() {\n \t\t\t\t.add(Revision.Fields.REVISED, revised);\n \t}\n \t\n-\t/**\n-\t * Converts an immutable object into a mutable builder with the usual prefixless setter methods.\n-\t * \n-\t * @return\n-\t */\n-\tprotected Builder<?, ? extends Revision> toBuilder() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyODI0Mw=="}, "originalCommit": {"oid": "8b28663442d251360ffcfda2cd02ed1b0148fc17"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MjY3ODI5OnYy", "diffSide": "RIGHT", "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMDowOTozMVrOHwVOgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMDowOTozMVrOHwVOgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ0MTQ3NQ==", "bodyText": "These two properties could be added to fieldsToSkip at initialization time. Otherwise Revision.Fields.REVISED will needlessly undergo the collection-like conversion above \ud83e\udd14", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520441475", "createdAt": "2020-11-10T10:09:31Z", "author": {"login": "apeteri"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "diffHunk": "@@ -859,19 +849,39 @@ private RevisionDiff(Revision oldRevision, Revision newRevision) {\n \t\tpublic boolean hasChanges() {\n \t\t\treturn rawDiff().size() > 0;\n \t\t}\n+\t\t\n+\t\tpublic DocumentMapping getMapping() {\n+\t\t\treturn index.admin().mappings().getMapping(newRevision.getClass());\n+\t\t}\n \n \t\tprivate ArrayNode rawDiff() {\n \t\t\tif (rawDiff == null) {\n+\t\t\t\tfinal DocumentMapping mapping = getMapping();\n \t\t\t\tObjectNode oldRevisionSource = mapper.valueToTree(oldRevision);\n \t\t\t\tObjectNode newRevisionSource = mapper.valueToTree(newRevision);\n \t\t\t\tfinal JsonNode diff = JsonDiff.asJson(oldRevisionSource, newRevisionSource, DIFF_FLAGS);\n \t\t\t\tfinal ArrayNode rawDiff = ClassUtils.checkAndCast(diff, ArrayNode.class);\n \t\t\t\tfinal ArrayNode filteredRawDiff = mapper.createArrayNode();\n \t\t\t\tfinal Iterator<JsonNode> elements = rawDiff.elements();\n+\t\t\t\tSet<String> fieldsToSkip = null; \n \t\t\t\twhile (elements.hasNext()) {\n-\t\t\t\t\tJsonNode node = elements.next();\n-\t\t\t\t\tfinal ObjectNode change = ClassUtils.checkAndCast(node, ObjectNode.class);\n-\t\t\t\t\tfinal String property = change.get(\"path\").asText().substring(1);\n+\t\t\t\t\tObjectNode change = ClassUtils.checkAndCast(elements.next(), ObjectNode.class);\n+\t\t\t\t\tfinal String property = getChangeRootProperty(change);\n+\t\t\t\t\t\n+\t\t\t\t\tif (fieldsToSkip != null && fieldsToSkip.contains(property)) {\n+\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t}\n+\t\t\t\t\t\n+\t\t\t\t\t// in case of a collection-like tracked property, convert the first diff to a full prop diff and ignore the rest of the prop changes on the same property\n+\t\t\t\t\tif (mapping.getRevisionFields().contains(property) && mapping.isCollection(property)) {\n+\t\t\t\t\t\t// construct a replacement JSON array patch node\n+\t\t\t\t\t\tchange = new RevisionPropertyDiff(property, serializeToCommitDetailValue(oldRevisionSource, property), serializeToCommitDetailValue(newRevisionSource, property))\n+\t\t\t\t\t\t\t\t.asPatch(mapper, oldRevisionSource, true /* includeFromValue */);\n+\t\t\t\t\t\tif (fieldsToSkip == null) {\n+\t\t\t\t\t\t\tfieldsToSkip = Sets.newHashSetWithExpectedSize(1); // expect a single array like property per type\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\tfieldsToSkip.add(property);\n+\t\t\t\t\t}\n \t\t\t\t\t\n \t\t\t\t\t// Remove administrative revision fields from diff, but keep all other ones\n \t\t\t\t\tif (!Revision.Fields.CREATED.equals(property) && !Revision.Fields.REVISED.equals(property)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b28663442d251360ffcfda2cd02ed1b0148fc17"}, "originalPosition": 105}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1622, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}