{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MzEwMDcw", "number": 575, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMDowNToxOFrOEB5wcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjoxMjoyN1rOEEXfjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNDMwMzIwOnYy", "diffSide": "RIGHT", "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMDowNToxOFrOGeCGKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMDowNToxOFrOGeCGKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE0NDgxMA==", "bodyText": "It would be better to apply the exclusions immediately when we set them on the StagingArea and not relying on a method call with removeExclusions.\nAlso, this eliminates the actual objects from the StagingArea while I think it would be better to keep them around and just apply the exclusions as a filter on top of them.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r434144810", "createdAt": "2020-06-02T20:05:18Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "diffHunk": "@@ -937,4 +937,15 @@ public StagedObject removed(Object object, RevisionDiff diff, boolean commit) {\n \t\treturn new StagedObject(StageKind.REMOVED, object, diff, commit);\n \t}\n \n+\tpublic void removeExclusions(Set<String> exclusions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64bd3202dc1d1773c0c5032b875c00a628760be5"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNDMwODQ5OnYy", "diffSide": "RIGHT", "path": "commons/com.b2international.index.tests/src/com/b2international/index/revision/RevisionBranchMergeTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMDowNzowNFrOGeCJvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxOTozOToyMlrOGgtpyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE0NTcyNQ==", "bodyText": "I would rename the setExclusions() method to just exclude() and give it a few overloaded versions:\nexclude(String...ids)\nexclude(Collection<String> ids)", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r434145725", "createdAt": "2020-06-02T20:07:04Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index.tests/src/com/b2international/index/revision/RevisionBranchMergeTest.java", "diffHunk": "@@ -99,6 +100,33 @@ public void fastForwardMergeBranchWithNewRevisionToParent() throws Exception {\n \t\tassertNotNull(getRevision(MAIN, RevisionData.class, STORAGE_KEY1));\n \t}\n \t\n+\t@Test\n+\tpublic void forwardMergeBranchWithExclusions() throws Exception {\n+\t\tString child = createBranch(MAIN, \"a\");\n+\t\t// create a revisions on child branch\n+\t\tindexRevision(child, NEW_DATA);\n+\t\tindexRevision(child, NEW_DATA2);\n+\t\t// after commit child branch becomes FORWARD\n+\t\tassertState(child, MAIN, BranchState.FORWARD);\n+\t\t// do the merge with an exclusion\n+\t\tbranching()\n+\t\t\t.prepareMerge(child, MAIN)\n+\t\t\t.setExclusions(ImmutableSet.of(STORAGE_KEY1))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64bd3202dc1d1773c0c5032b875c00a628760be5"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk1NTU5Mw==", "bodyText": "This suggestion is still not implemented, could you please add these as well?", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r436955593", "createdAt": "2020-06-08T19:39:22Z", "author": {"login": "nagyo"}, "path": "commons/com.b2international.index.tests/src/com/b2international/index/revision/RevisionBranchMergeTest.java", "diffHunk": "@@ -99,6 +100,33 @@ public void fastForwardMergeBranchWithNewRevisionToParent() throws Exception {\n \t\tassertNotNull(getRevision(MAIN, RevisionData.class, STORAGE_KEY1));\n \t}\n \t\n+\t@Test\n+\tpublic void forwardMergeBranchWithExclusions() throws Exception {\n+\t\tString child = createBranch(MAIN, \"a\");\n+\t\t// create a revisions on child branch\n+\t\tindexRevision(child, NEW_DATA);\n+\t\tindexRevision(child, NEW_DATA2);\n+\t\t// after commit child branch becomes FORWARD\n+\t\tassertState(child, MAIN, BranchState.FORWARD);\n+\t\t// do the merge with an exclusion\n+\t\tbranching()\n+\t\t\t.prepareMerge(child, MAIN)\n+\t\t\t.setExclusions(ImmutableSet.of(STORAGE_KEY1))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE0NTcyNQ=="}, "originalCommit": {"oid": "64bd3202dc1d1773c0c5032b875c00a628760be5"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNDMxMTE3OnYy", "diffSide": "RIGHT", "path": "commons/com.b2international.index/src/com/b2international/index/revision/BranchMergeOperation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyNDo1N1rOGhC9fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyNDo1N1rOGhC9fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNDcwMA==", "bodyText": "Use String...ids varargs here with defensive copy.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r437304700", "createdAt": "2020-06-09T10:24:57Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/BranchMergeOperation.java", "diffHunk": "@@ -68,8 +69,12 @@ public Commit merge() {\n \t\treturn branching.doMerge(this);\n \t}\n \n-\tpublic BranchMergeOperation setExclusions(Set<String> exclusions) {\n-\t\tthis.exclusions = exclusions;\n+\tpublic BranchMergeOperation exclude(String id) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12b4bd2340bc4410b80e886656701303e6f84798"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNDMxMjY3OnYy", "diffSide": "RIGHT", "path": "commons/com.b2international.index/src/com/b2international/index/revision/BranchMergeOperation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyNToyM1rOGhC-aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyNToyM1rOGhC-aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNDkzOQ==", "bodyText": "Use Iterable<String> argument here with defensive copy.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r437304939", "createdAt": "2020-06-09T10:25:23Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/BranchMergeOperation.java", "diffHunk": "@@ -68,8 +69,12 @@ public Commit merge() {\n \t\treturn branching.doMerge(this);\n \t}\n \n-\tpublic BranchMergeOperation setExclusions(Set<String> exclusions) {\n-\t\tthis.exclusions = exclusions;\n+\tpublic BranchMergeOperation exclude(String id) {\n+\t\treturn exclude(Collections.singleton(id));\n+\t}\n+\t\n+\tpublic BranchMergeOperation exclude(Set<String> ids) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12b4bd2340bc4410b80e886656701303e6f84798"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNDMxNTA0OnYy", "diffSide": "RIGHT", "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyNjowN1rOGhC_3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyNjowN1rOGhC_3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNTMwOQ==", "bodyText": "Use Collections.emptySet() for initialization.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r437305309", "createdAt": "2020-06-09T10:26:07Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "diffHunk": "@@ -70,6 +71,7 @@\n \t\tthis.index = index;\n \t\tthis.branchPath = branchPath;\n \t\tthis.mapper = mapper;\n+\t\tthis.exclusions = Sets.newHashSet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12b4bd2340bc4410b80e886656701303e6f84798"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNDMxODkwOnYy", "diffSide": "RIGHT", "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyNzoxMFrOGhDCOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyNzoxMFrOGhDCOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNTkxNA==", "bodyText": "Please extract the filtered view to a private method, getFilteredStagedObjects()", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r437305914", "createdAt": "2020-06-09T10:27:10Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "diffHunk": "@@ -247,7 +249,10 @@ private Commit doCommit(String commitGroupId, long timestamp, String author, Str\n \t\tfinal Multimap<ObjectId, ObjectId> removedComponentsByContainer = HashMultimap.create();\n \t\tfinal Multimap<Class<?>, String> deletedIdsByType = HashMultimap.create();\n \n-\t\tstagedObjects.forEach((key, value) -> {\n+\t\tstagedObjects.entrySet().stream().filter(entry -> !exclusions.contains(entry.getKey().id())).forEach( entry -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12b4bd2340bc4410b80e886656701303e6f84798"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczMDEzNTA4OnYy", "diffSide": "RIGHT", "path": "commons/com.b2international.index.tests/src/com/b2international/index/revision/RevisionBranchMergeTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjoxMDozNFrOGh8S1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjoxMDozNFrOGh8S1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NDA1NQ==", "bodyText": "Unnecessary assertion, please remove!", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r438244055", "createdAt": "2020-06-10T16:10:34Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index.tests/src/com/b2international/index/revision/RevisionBranchMergeTest.java", "diffHunk": "@@ -127,6 +126,63 @@ public void forwardMergeBranchWithExclusions() throws Exception {\n \t\tassertNull(getRevision(MAIN, RevisionData.class, STORAGE_KEY1));\n \t}\n \t\n+\t@Test\n+\tpublic void forwardMergeBranchExcludeChange() throws Exception {\n+\t\tindexRevision(MAIN, NEW_DATA);\n+\t\tindexRevision(MAIN, NEW_DATA2);\n+\t\tString child = createBranch(MAIN, \"a\");\n+\t\t// change a revision on the child branch\n+\t\tindexChange(child, NEW_DATA, CHANGED_DATA);\n+\t\t// after commit child branch becomes FORWARD\n+\t\tassertState(child, MAIN, BranchState.FORWARD);\n+\t\t// do the merge with an exclusion\n+\t\tbranching()\n+\t\t\t.prepareMerge(child, MAIN)\n+\t\t\t.exclude(STORAGE_KEY1)\n+\t\t\t.squash(true)\n+\t\t\t.merge();\n+\t\t\n+\t\t// after fast-forward merge\n+\t\t// 1. MAIN falls behind compared to the child\n+\t\tassertState(MAIN, child, BranchState.FORWARD);\n+\t\t\n+\t\t// 2. Child should be UP_TO_DATE state compared to the MAIN\n+\t\tassertState(child, MAIN, BranchState.BEHIND);\n+\t\t\n+\t\t// 3. one revision should be visible from MAIN branch, excluded one should not\n+\t\tassertNotNull(getRevision(MAIN, RevisionData.class, STORAGE_KEY2));\n+\t\tassertNotNull(getRevision(MAIN, RevisionData.class, STORAGE_KEY1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "738668ae477d4be51f53b348bbb85bc5e37effdd"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczMDE0MTA1OnYy", "diffSide": "RIGHT", "path": "commons/com.b2international.index/src/com/b2international/index/revision/BranchMergeOperation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjoxMTozMVrOGh8WuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjoxMTozMVrOGh8WuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NTA0OQ==", "bodyText": "Use ImmutableSet.copyOf(E[] elements).", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r438245049", "createdAt": "2020-06-10T16:11:31Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/BranchMergeOperation.java", "diffHunk": "@@ -69,12 +71,12 @@ public Commit merge() {\n \t\treturn branching.doMerge(this);\n \t}\n \n-\tpublic BranchMergeOperation exclude(String id) {\n-\t\treturn exclude(Collections.singleton(id));\n+\tpublic BranchMergeOperation exclude(String ... ids) {\n+\t\treturn exclude(Arrays.copyOf(ids, ids.length));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "738668ae477d4be51f53b348bbb85bc5e37effdd"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczMDE0NjcwOnYy", "diffSide": "RIGHT", "path": "commons/com.b2international.index/src/com/b2international/index/revision/BranchMergeOperation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjoxMjoyN1rOGh8aRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjoxMjoyN1rOGh8aRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NTk1OA==", "bodyText": "Same here, use ImmutableSet.copyOf(E[] elements). This way you prevent copying the array twice when you use the vararg method.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r438245958", "createdAt": "2020-06-10T16:12:27Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/BranchMergeOperation.java", "diffHunk": "@@ -69,12 +71,12 @@ public Commit merge() {\n \t\treturn branching.doMerge(this);\n \t}\n \n-\tpublic BranchMergeOperation exclude(String id) {\n-\t\treturn exclude(Collections.singleton(id));\n+\tpublic BranchMergeOperation exclude(String ... ids) {\n+\t\treturn exclude(Arrays.copyOf(ids, ids.length));\n \t}\n \t\n-\tpublic BranchMergeOperation exclude(Set<String> ids) {\n-\t\tthis.exclusions = ids;\n+\tpublic BranchMergeOperation exclude(Iterable<String> ids) {\n+\t\tthis.exclusions = Sets.newHashSet(ids);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "738668ae477d4be51f53b348bbb85bc5e37effdd"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1763, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}