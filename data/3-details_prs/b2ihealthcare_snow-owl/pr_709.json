{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MTY1Mjc0", "number": 709, "title": "SO-4460: track array property changes", "bodyText": "", "createdAt": "2020-11-07T17:12:17Z", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709", "merged": true, "mergeCommit": {"oid": "61a82544da858fce54645382a0f34f997ece81fb"}, "closed": true, "closedAt": "2020-11-10T11:00:10Z", "author": {"login": "cmark"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ6TVKgH2gAyNTE3MTY1Mjc0OjFhZTQ0Yjg4ODJhMjJkYzM0NWJkZjBiMDIyM2JlNDQ3MzRkMTUyNjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbHPerAFqTUyNzA4NjYwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1ae44b8882a22dc345bdf0b0223be44734d15269", "author": {"user": {"login": "cmark", "name": "Mark Czotter"}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/1ae44b8882a22dc345bdf0b0223be44734d15269", "committedDate": "2020-11-06T17:20:57Z", "message": "SO-4660: support array property tracking properly\n\nRegister a single change per array property field.\nFromValue is the old array JSON string.\nNewValue is the new array JSON string."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51008d1666f6884e30bb02cd2694a824dda88100", "author": {"user": {"login": "cmark", "name": "Mark Czotter"}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/51008d1666f6884e30bb02cd2694a824dda88100", "committedDate": "2020-11-07T16:40:20Z", "message": "SO-4460: add branch merge resolable array property conflict test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "493cd47f5163610df977ab746cef4914e833b051", "author": {"user": {"login": "cmark", "name": "Mark Czotter"}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/493cd47f5163610df977ab746cef4914e833b051", "committedDate": "2020-11-07T16:40:58Z", "message": "[index] remove unused close method from IndexClient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d53e5b8ca7c19d7252afd8a4c03a38ad0e7acac", "author": {"user": {"login": "cmark", "name": "Mark Czotter"}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/6d53e5b8ca7c19d7252afd8a4c03a38ad0e7acac", "committedDate": "2020-11-07T16:42:25Z", "message": "[index] remove unused setRevised from Revision\n\nMove `Revision.toBuilder()` method to `RevisionDocument`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57232cbf8021fd581801523c51e7c62e9b18753a", "author": {"user": {"login": "cmark", "name": "Mark Czotter"}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/57232cbf8021fd581801523c51e7c62e9b18753a", "committedDate": "2020-11-07T16:43:44Z", "message": "[index] remove unused isRoot method from Revision class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fe242c00f243e97c12f03188322fdbf05e9678b", "author": {"user": {"login": "cmark", "name": "Mark Czotter"}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/1fe242c00f243e97c12f03188322fdbf05e9678b", "committedDate": "2020-11-07T16:52:28Z", "message": "[index] add isDirty check to `StagingArea.commit()`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2aa99f5796a2379e52a0c7dcb265b4a25c6c3b98", "author": {"user": {"login": "cmark", "name": "Mark Czotter"}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/2aa99f5796a2379e52a0c7dcb265b4a25c6c3b98", "committedDate": "2020-11-07T16:54:10Z", "message": "[index] remove unused update branch script from Commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07d09edfbfad88fb995c7d1af19d0a6b5b4b915b", "author": {"user": {"login": "cmark", "name": "Mark Czotter"}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/07d09edfbfad88fb995c7d1af19d0a6b5b4b915b", "committedDate": "2020-11-07T16:59:44Z", "message": "[index] remove unused Scroll constructors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdb64addd180bb27a03926f691b75d3747d9bf18", "author": {"user": {"login": "cmark", "name": "Mark Czotter"}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/fdb64addd180bb27a03926f691b75d3747d9bf18", "committedDate": "2020-11-07T17:02:53Z", "message": "[index] remove unused `BulkUpdate.getIdField()`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b28663442d251360ffcfda2cd02ed1b0148fc17", "author": {"user": {"login": "cmark", "name": "Mark Czotter"}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/8b28663442d251360ffcfda2cd02ed1b0148fc17", "committedDate": "2020-11-07T17:11:21Z", "message": "[index] add isDirty check to `StagingArea.commit()` (fix merge commits)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MDE5NjQ1", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#pullrequestreview-527019645", "createdAt": "2020-11-10T09:40:16Z", "commit": {"oid": "8b28663442d251360ffcfda2cd02ed1b0148fc17"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwOTo0MDoxNlrOHwT_yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwOTo0MDoxNlrOHwT_yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyMTMyMg==", "bodyText": "It turns out there is exactly one caller of TransactionContext#commit that is interested in the timestamp, returned via a CommitResult instance: \n  \n    \n      snow-owl/snomed/com.b2international.snowowl.snomed.reasoner/src/com/b2international/snowowl/snomed/reasoner/request/SaveJobRequest.java\n    \n    \n         Line 216\n      in\n      7f5e60d\n    \n    \n    \n    \n\n        \n          \n           classificationTracker.classificationSaved(classificationId, commitResult.getCommitTimestamp());", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520421322", "createdAt": "2020-11-10T09:40:16Z", "author": {"login": "apeteri"}, "path": "core/com.b2international.snowowl.core/src/com/b2international/snowowl/core/repository/RepositoryTransactionContext.java", "diffHunk": "@@ -280,7 +280,7 @@ public Long commit(String author, String commitComment, String parentLockContext\n \t\t\tlog().info(\"Persisting changes to {}@{}\", path(), timestamp);\n \t\t\tcommit = staging.commit(null, timestamp, author, commitComment);\n \t\t\tlog().info(\"Changes have been successfully persisted to {}@{}.\", path(), timestamp);\n-\t\t\treturn commit == null ? null : commit.getTimestamp();\n+\t\t\treturn commit == null ? Commit.NO_COMMIT_TIMESTAMP : commit.getTimestamp();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b28663442d251360ffcfda2cd02ed1b0148fc17"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MDI2MTQ2", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#pullrequestreview-527026146", "createdAt": "2020-11-10T09:47:15Z", "commit": {"oid": "8b28663442d251360ffcfda2cd02ed1b0148fc17"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwOTo0NzoxNVrOHwUSgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMDowOTozMVrOHwVOgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNjExMw==", "bodyText": "Please add a comment somewhere that this field is only updated in Elasticsearch via the updateRevised script defined at the top, is never de-serialized (so if one looks at a Revision instance, it will not contain the revised branch+timestamp pairs) and is used in ES search expressions only.\nI got a bit confused when I saw that the setter could be removed, Jackson is only using the field when converting to JSON, it is always initialized with an empty list and no one is interested in the contents in Java either \ud83d\ude03", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520426113", "createdAt": "2020-11-10T09:47:15Z", "author": {"login": "apeteri"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/Revision.java", "diffHunk": "@@ -73,10 +76,6 @@ final void setCreated(RevisionBranchPoint created) {\n \t\tthis.created = created;\n \t}\n \t\n-\tfinal void setRevised(List<RevisionBranchPoint> revised) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b28663442d251360ffcfda2cd02ed1b0148fc17"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyODI0Mw==", "bodyText": "The inner Builder class could also be pushed down to RevisionDocument, like this method.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520428243", "createdAt": "2020-11-10T09:50:29Z", "author": {"login": "apeteri"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/Revision.java", "diffHunk": "@@ -122,15 +112,6 @@ protected ToStringHelper doToString() {\n \t\t\t\t.add(Revision.Fields.REVISED, revised);\n \t}\n \t\n-\t/**\n-\t * Converts an immutable object into a mutable builder with the usual prefixless setter methods.\n-\t * \n-\t * @return\n-\t */\n-\tprotected Builder<?, ? extends Revision> toBuilder() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b28663442d251360ffcfda2cd02ed1b0148fc17"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ0MTQ3NQ==", "bodyText": "These two properties could be added to fieldsToSkip at initialization time. Otherwise Revision.Fields.REVISED will needlessly undergo the collection-like conversion above \ud83e\udd14", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520441475", "createdAt": "2020-11-10T10:09:31Z", "author": {"login": "apeteri"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "diffHunk": "@@ -859,19 +849,39 @@ private RevisionDiff(Revision oldRevision, Revision newRevision) {\n \t\tpublic boolean hasChanges() {\n \t\t\treturn rawDiff().size() > 0;\n \t\t}\n+\t\t\n+\t\tpublic DocumentMapping getMapping() {\n+\t\t\treturn index.admin().mappings().getMapping(newRevision.getClass());\n+\t\t}\n \n \t\tprivate ArrayNode rawDiff() {\n \t\t\tif (rawDiff == null) {\n+\t\t\t\tfinal DocumentMapping mapping = getMapping();\n \t\t\t\tObjectNode oldRevisionSource = mapper.valueToTree(oldRevision);\n \t\t\t\tObjectNode newRevisionSource = mapper.valueToTree(newRevision);\n \t\t\t\tfinal JsonNode diff = JsonDiff.asJson(oldRevisionSource, newRevisionSource, DIFF_FLAGS);\n \t\t\t\tfinal ArrayNode rawDiff = ClassUtils.checkAndCast(diff, ArrayNode.class);\n \t\t\t\tfinal ArrayNode filteredRawDiff = mapper.createArrayNode();\n \t\t\t\tfinal Iterator<JsonNode> elements = rawDiff.elements();\n+\t\t\t\tSet<String> fieldsToSkip = null; \n \t\t\t\twhile (elements.hasNext()) {\n-\t\t\t\t\tJsonNode node = elements.next();\n-\t\t\t\t\tfinal ObjectNode change = ClassUtils.checkAndCast(node, ObjectNode.class);\n-\t\t\t\t\tfinal String property = change.get(\"path\").asText().substring(1);\n+\t\t\t\t\tObjectNode change = ClassUtils.checkAndCast(elements.next(), ObjectNode.class);\n+\t\t\t\t\tfinal String property = getChangeRootProperty(change);\n+\t\t\t\t\t\n+\t\t\t\t\tif (fieldsToSkip != null && fieldsToSkip.contains(property)) {\n+\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t}\n+\t\t\t\t\t\n+\t\t\t\t\t// in case of a collection-like tracked property, convert the first diff to a full prop diff and ignore the rest of the prop changes on the same property\n+\t\t\t\t\tif (mapping.getRevisionFields().contains(property) && mapping.isCollection(property)) {\n+\t\t\t\t\t\t// construct a replacement JSON array patch node\n+\t\t\t\t\t\tchange = new RevisionPropertyDiff(property, serializeToCommitDetailValue(oldRevisionSource, property), serializeToCommitDetailValue(newRevisionSource, property))\n+\t\t\t\t\t\t\t\t.asPatch(mapper, oldRevisionSource, true /* includeFromValue */);\n+\t\t\t\t\t\tif (fieldsToSkip == null) {\n+\t\t\t\t\t\t\tfieldsToSkip = Sets.newHashSetWithExpectedSize(1); // expect a single array like property per type\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\tfieldsToSkip.add(property);\n+\t\t\t\t\t}\n \t\t\t\t\t\n \t\t\t\t\t// Remove administrative revision fields from diff, but keep all other ones\n \t\t\t\t\tif (!Revision.Fields.CREATED.equals(property) && !Revision.Fields.REVISED.equals(property)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b28663442d251360ffcfda2cd02ed1b0148fc17"}, "originalPosition": 105}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "966b36cff7444f4c3fa8a490724acc18c5fcd587", "author": {"user": {"login": "cmark", "name": "Mark Czotter"}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/966b36cff7444f4c3fa8a490724acc18c5fcd587", "committedDate": "2020-11-10T10:52:07Z", "message": "SO-4660: add javadoc to Revision's `created` and `revised` fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a613f7ab43f699f4964d1ec221fe8499bb8c67a", "author": {"user": {"login": "cmark", "name": "Mark Czotter"}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/0a613f7ab43f699f4964d1ec221fe8499bb8c67a", "committedDate": "2020-11-10T10:56:29Z", "message": "SO-4660: filter out created/revised early when computing raw diff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d73728aa3a9dda84863641cd632861772dbd463", "author": {"user": {"login": "cmark", "name": "Mark Czotter"}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/5d73728aa3a9dda84863641cd632861772dbd463", "committedDate": "2020-11-10T10:58:24Z", "message": "SO-4660: filter out created/revised early when computing raw diff...\n\n...properly :smile:"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MDg2NjAx", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#pullrequestreview-527086601", "createdAt": "2020-11-10T10:59:26Z", "commit": {"oid": "5d73728aa3a9dda84863641cd632861772dbd463"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4845, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}