{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MzEwMDcw", "number": 575, "title": "Support branch merge revision exclusion list", "bodyText": "", "createdAt": "2020-05-28T07:46:45Z", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575", "merged": true, "mergeCommit": {"oid": "f7db5f74b8b5e8dcea80d21412398fb8a2877232"}, "closed": true, "closedAt": "2020-06-10T19:15:14Z", "author": {"login": "AAAlinaaa"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjahsdAH2gAyNDI0MzEwMDcwOjBmZWEzYTQ3NjlkNDZlMjkxMzU4MGJkMjUyN2I0OGU1MDQzZWE0ZjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcp-mRvAFqTQyODM1MzQyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0fea3a4769d46e2913580bd2527b48e5043ea4f5", "author": {"user": {"login": "AAAlinaaa", "name": null}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/0fea3a4769d46e2913580bd2527b48e5043ea4f5", "committedDate": "2020-05-21T09:47:46Z", "message": "SO-4028: Support exclusions from merge operation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a5697d164991978f1f92267f160d547e4ffd48a", "author": {"user": {"login": "AAAlinaaa", "name": null}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/0a5697d164991978f1f92267f160d547e4ffd48a", "committedDate": "2020-05-21T13:27:44Z", "message": "SO-4028: Use passed in exclusion id set in StagingArea"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e72d1af6b05e8636e5730f51f0022ee513928e8a", "author": {"user": {"login": "AAAlinaaa", "name": null}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/e72d1af6b05e8636e5730f51f0022ee513928e8a", "committedDate": "2020-05-21T15:07:57Z", "message": "SO-4028: Add exclusion merge revision branch index test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64bd3202dc1d1773c0c5032b875c00a628760be5", "author": {"user": {"login": "AAAlinaaa", "name": null}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/64bd3202dc1d1773c0c5032b875c00a628760be5", "committedDate": "2020-05-21T15:10:07Z", "message": "SO-4028: Avoid concurrent map modification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMDE3NzAx", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#pullrequestreview-423017701", "createdAt": "2020-06-02T20:05:18Z", "commit": {"oid": "64bd3202dc1d1773c0c5032b875c00a628760be5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMDowNToxOFrOGeCGKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMDowNzowNFrOGeCJvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE0NDgxMA==", "bodyText": "It would be better to apply the exclusions immediately when we set them on the StagingArea and not relying on a method call with removeExclusions.\nAlso, this eliminates the actual objects from the StagingArea while I think it would be better to keep them around and just apply the exclusions as a filter on top of them.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r434144810", "createdAt": "2020-06-02T20:05:18Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "diffHunk": "@@ -937,4 +937,15 @@ public StagedObject removed(Object object, RevisionDiff diff, boolean commit) {\n \t\treturn new StagedObject(StageKind.REMOVED, object, diff, commit);\n \t}\n \n+\tpublic void removeExclusions(Set<String> exclusions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64bd3202dc1d1773c0c5032b875c00a628760be5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE0NTcyNQ==", "bodyText": "I would rename the setExclusions() method to just exclude() and give it a few overloaded versions:\nexclude(String...ids)\nexclude(Collection<String> ids)", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r434145725", "createdAt": "2020-06-02T20:07:04Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index.tests/src/com/b2international/index/revision/RevisionBranchMergeTest.java", "diffHunk": "@@ -99,6 +100,33 @@ public void fastForwardMergeBranchWithNewRevisionToParent() throws Exception {\n \t\tassertNotNull(getRevision(MAIN, RevisionData.class, STORAGE_KEY1));\n \t}\n \t\n+\t@Test\n+\tpublic void forwardMergeBranchWithExclusions() throws Exception {\n+\t\tString child = createBranch(MAIN, \"a\");\n+\t\t// create a revisions on child branch\n+\t\tindexRevision(child, NEW_DATA);\n+\t\tindexRevision(child, NEW_DATA2);\n+\t\t// after commit child branch becomes FORWARD\n+\t\tassertState(child, MAIN, BranchState.FORWARD);\n+\t\t// do the merge with an exclusion\n+\t\tbranching()\n+\t\t\t.prepareMerge(child, MAIN)\n+\t\t\t.setExclusions(ImmutableSet.of(STORAGE_KEY1))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64bd3202dc1d1773c0c5032b875c00a628760be5"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a70fa83b87ae4c0e1c719de03b7fa0a9da96e52b", "author": {"user": {"login": "AAAlinaaa", "name": null}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/a70fa83b87ae4c0e1c719de03b7fa0a9da96e52b", "committedDate": "2020-06-05T14:29:10Z", "message": "SO-4028: Track excluded objects without removing from staged objects"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NTYyMTU3", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#pullrequestreview-426562157", "createdAt": "2020-06-08T19:39:22Z", "commit": {"oid": "a70fa83b87ae4c0e1c719de03b7fa0a9da96e52b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxOTozOToyMlrOGgtpyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxOTozOToyMlrOGgtpyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk1NTU5Mw==", "bodyText": "This suggestion is still not implemented, could you please add these as well?", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r436955593", "createdAt": "2020-06-08T19:39:22Z", "author": {"login": "nagyo"}, "path": "commons/com.b2international.index.tests/src/com/b2international/index/revision/RevisionBranchMergeTest.java", "diffHunk": "@@ -99,6 +100,33 @@ public void fastForwardMergeBranchWithNewRevisionToParent() throws Exception {\n \t\tassertNotNull(getRevision(MAIN, RevisionData.class, STORAGE_KEY1));\n \t}\n \t\n+\t@Test\n+\tpublic void forwardMergeBranchWithExclusions() throws Exception {\n+\t\tString child = createBranch(MAIN, \"a\");\n+\t\t// create a revisions on child branch\n+\t\tindexRevision(child, NEW_DATA);\n+\t\tindexRevision(child, NEW_DATA2);\n+\t\t// after commit child branch becomes FORWARD\n+\t\tassertState(child, MAIN, BranchState.FORWARD);\n+\t\t// do the merge with an exclusion\n+\t\tbranching()\n+\t\t\t.prepareMerge(child, MAIN)\n+\t\t\t.setExclusions(ImmutableSet.of(STORAGE_KEY1))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE0NTcyNQ=="}, "originalCommit": {"oid": "64bd3202dc1d1773c0c5032b875c00a628760be5"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12b4bd2340bc4410b80e886656701303e6f84798", "author": {"user": {"login": "AAAlinaaa", "name": null}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/12b4bd2340bc4410b80e886656701303e6f84798", "committedDate": "2020-06-09T08:51:13Z", "message": "SO-4028: Rename, overload exclude method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MDAyNDE5", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#pullrequestreview-427002419", "createdAt": "2020-06-09T10:24:57Z", "commit": {"oid": "12b4bd2340bc4410b80e886656701303e6f84798"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyNDo1N1rOGhC9fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyNzoxMFrOGhDCOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNDcwMA==", "bodyText": "Use String...ids varargs here with defensive copy.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r437304700", "createdAt": "2020-06-09T10:24:57Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/BranchMergeOperation.java", "diffHunk": "@@ -68,8 +69,12 @@ public Commit merge() {\n \t\treturn branching.doMerge(this);\n \t}\n \n-\tpublic BranchMergeOperation setExclusions(Set<String> exclusions) {\n-\t\tthis.exclusions = exclusions;\n+\tpublic BranchMergeOperation exclude(String id) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12b4bd2340bc4410b80e886656701303e6f84798"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNDkzOQ==", "bodyText": "Use Iterable<String> argument here with defensive copy.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r437304939", "createdAt": "2020-06-09T10:25:23Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/BranchMergeOperation.java", "diffHunk": "@@ -68,8 +69,12 @@ public Commit merge() {\n \t\treturn branching.doMerge(this);\n \t}\n \n-\tpublic BranchMergeOperation setExclusions(Set<String> exclusions) {\n-\t\tthis.exclusions = exclusions;\n+\tpublic BranchMergeOperation exclude(String id) {\n+\t\treturn exclude(Collections.singleton(id));\n+\t}\n+\t\n+\tpublic BranchMergeOperation exclude(Set<String> ids) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12b4bd2340bc4410b80e886656701303e6f84798"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNTMwOQ==", "bodyText": "Use Collections.emptySet() for initialization.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r437305309", "createdAt": "2020-06-09T10:26:07Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "diffHunk": "@@ -70,6 +71,7 @@\n \t\tthis.index = index;\n \t\tthis.branchPath = branchPath;\n \t\tthis.mapper = mapper;\n+\t\tthis.exclusions = Sets.newHashSet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12b4bd2340bc4410b80e886656701303e6f84798"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNTkxNA==", "bodyText": "Please extract the filtered view to a private method, getFilteredStagedObjects()", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r437305914", "createdAt": "2020-06-09T10:27:10Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "diffHunk": "@@ -247,7 +249,10 @@ private Commit doCommit(String commitGroupId, long timestamp, String author, Str\n \t\tfinal Multimap<ObjectId, ObjectId> removedComponentsByContainer = HashMultimap.create();\n \t\tfinal Multimap<Class<?>, String> deletedIdsByType = HashMultimap.create();\n \n-\t\tstagedObjects.forEach((key, value) -> {\n+\t\tstagedObjects.entrySet().stream().filter(entry -> !exclusions.contains(entry.getKey().id())).forEach( entry -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12b4bd2340bc4410b80e886656701303e6f84798"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71ff49b37bd0aea6bd808870cc53a296ea45fe49", "author": {"user": {"login": "AAAlinaaa", "name": null}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/71ff49b37bd0aea6bd808870cc53a296ea45fe49", "committedDate": "2020-06-10T12:11:12Z", "message": "SO-4028: Create merge exclude tests for changed, remvoed, new revisions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b0bffe37fc4f80d27167be7ef6fe2a46334c89a", "author": {"user": {"login": "AAAlinaaa", "name": null}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/0b0bffe37fc4f80d27167be7ef6fe2a46334c89a", "committedDate": "2020-06-10T12:32:07Z", "message": "SO-4028: Use varargs, defensive copy in merge operation exclude setters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "738668ae477d4be51f53b348bbb85bc5e37effdd", "author": {"user": {"login": "AAAlinaaa", "name": null}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/738668ae477d4be51f53b348bbb85bc5e37effdd", "committedDate": "2020-06-10T12:46:59Z", "message": "SO-4028: Create private method to get filtered staged objects"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MjE2MDgx", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#pullrequestreview-428216081", "createdAt": "2020-06-10T16:10:34Z", "commit": {"oid": "738668ae477d4be51f53b348bbb85bc5e37effdd"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjoxMDozNFrOGh8S1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjoxMjoyN1rOGh8aRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NDA1NQ==", "bodyText": "Unnecessary assertion, please remove!", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r438244055", "createdAt": "2020-06-10T16:10:34Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index.tests/src/com/b2international/index/revision/RevisionBranchMergeTest.java", "diffHunk": "@@ -127,6 +126,63 @@ public void forwardMergeBranchWithExclusions() throws Exception {\n \t\tassertNull(getRevision(MAIN, RevisionData.class, STORAGE_KEY1));\n \t}\n \t\n+\t@Test\n+\tpublic void forwardMergeBranchExcludeChange() throws Exception {\n+\t\tindexRevision(MAIN, NEW_DATA);\n+\t\tindexRevision(MAIN, NEW_DATA2);\n+\t\tString child = createBranch(MAIN, \"a\");\n+\t\t// change a revision on the child branch\n+\t\tindexChange(child, NEW_DATA, CHANGED_DATA);\n+\t\t// after commit child branch becomes FORWARD\n+\t\tassertState(child, MAIN, BranchState.FORWARD);\n+\t\t// do the merge with an exclusion\n+\t\tbranching()\n+\t\t\t.prepareMerge(child, MAIN)\n+\t\t\t.exclude(STORAGE_KEY1)\n+\t\t\t.squash(true)\n+\t\t\t.merge();\n+\t\t\n+\t\t// after fast-forward merge\n+\t\t// 1. MAIN falls behind compared to the child\n+\t\tassertState(MAIN, child, BranchState.FORWARD);\n+\t\t\n+\t\t// 2. Child should be UP_TO_DATE state compared to the MAIN\n+\t\tassertState(child, MAIN, BranchState.BEHIND);\n+\t\t\n+\t\t// 3. one revision should be visible from MAIN branch, excluded one should not\n+\t\tassertNotNull(getRevision(MAIN, RevisionData.class, STORAGE_KEY2));\n+\t\tassertNotNull(getRevision(MAIN, RevisionData.class, STORAGE_KEY1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "738668ae477d4be51f53b348bbb85bc5e37effdd"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NTA0OQ==", "bodyText": "Use ImmutableSet.copyOf(E[] elements).", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r438245049", "createdAt": "2020-06-10T16:11:31Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/BranchMergeOperation.java", "diffHunk": "@@ -69,12 +71,12 @@ public Commit merge() {\n \t\treturn branching.doMerge(this);\n \t}\n \n-\tpublic BranchMergeOperation exclude(String id) {\n-\t\treturn exclude(Collections.singleton(id));\n+\tpublic BranchMergeOperation exclude(String ... ids) {\n+\t\treturn exclude(Arrays.copyOf(ids, ids.length));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "738668ae477d4be51f53b348bbb85bc5e37effdd"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI0NTk1OA==", "bodyText": "Same here, use ImmutableSet.copyOf(E[] elements). This way you prevent copying the array twice when you use the vararg method.", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#discussion_r438245958", "createdAt": "2020-06-10T16:12:27Z", "author": {"login": "cmark"}, "path": "commons/com.b2international.index/src/com/b2international/index/revision/BranchMergeOperation.java", "diffHunk": "@@ -69,12 +71,12 @@ public Commit merge() {\n \t\treturn branching.doMerge(this);\n \t}\n \n-\tpublic BranchMergeOperation exclude(String id) {\n-\t\treturn exclude(Collections.singleton(id));\n+\tpublic BranchMergeOperation exclude(String ... ids) {\n+\t\treturn exclude(Arrays.copyOf(ids, ids.length));\n \t}\n \t\n-\tpublic BranchMergeOperation exclude(Set<String> ids) {\n-\t\tthis.exclusions = ids;\n+\tpublic BranchMergeOperation exclude(Iterable<String> ids) {\n+\t\tthis.exclusions = Sets.newHashSet(ids);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "738668ae477d4be51f53b348bbb85bc5e37effdd"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6595819a62edebdfad99a4e350249a3bdd7a3215", "author": {"user": {"login": "AAAlinaaa", "name": null}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/6595819a62edebdfad99a4e350249a3bdd7a3215", "committedDate": "2020-06-10T17:42:34Z", "message": "SO-4028: Remove unnecessary check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3369261c2de86e955e10df559827909addd5ba0b", "author": {"user": {"login": "AAAlinaaa", "name": null}}, "url": "https://github.com/b2ihealthcare/snow-owl/commit/3369261c2de86e955e10df559827909addd5ba0b", "committedDate": "2020-06-10T17:48:37Z", "message": "SO-4028: Use ImmutableSet in defensive copy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MzQ2ODUz", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#pullrequestreview-428346853", "createdAt": "2020-06-10T19:03:14Z", "commit": {"oid": "3369261c2de86e955e10df559827909addd5ba0b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MzUzNDI2", "url": "https://github.com/b2ihealthcare/snow-owl/pull/575#pullrequestreview-428353426", "createdAt": "2020-06-10T19:12:54Z", "commit": {"oid": "3369261c2de86e955e10df559827909addd5ba0b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4990, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}