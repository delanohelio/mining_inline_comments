{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4OTkyNDUx", "number": 1099, "title": "Handles special case when a destination is both queue and topic", "bodyText": "Fixes #1098", "createdAt": "2020-02-24T13:33:33Z", "url": "https://github.com/openzipkin/brave/pull/1099", "merged": true, "mergeCommit": {"oid": "4804b1dcb2ab446cbbc6f5ff896ee14f60d8e9b0"}, "closed": true, "closedAt": "2020-02-25T02:15:26Z", "author": {"login": "codefromthecrypt"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHdmsoAH2gAyMzc4OTkyNDUxOjYxYzMzYWNlYzc2MzU0MmJjOGE2OTI0MWU3ZmNjZjBhYjNmM2NjYjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHpI-oAFqTM2Mzg0MjE0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "61c33acec763542bc8a69241e7fccf0ab3f3ccb7", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/61c33acec763542bc8a69241e7fccf0ab3f3ccb7", "committedDate": "2020-02-24T13:33:04Z", "message": "Handles special case when a destination is both queue and topic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzODM3NjAy", "url": "https://github.com/openzipkin/brave/pull/1099#pullrequestreview-363837602", "createdAt": "2020-02-25T02:42:31Z", "commit": {"oid": "61c33acec763542bc8a69241e7fccf0ab3f3ccb7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjo0MjozMVrOFt26KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjo0MjozMVrOFt26KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyOTg2NQ==", "bodyText": "Perhaps need to link to the issue here or provide a bit more background. The JMS APIs are generally sketchy, but the javadoc doesn't seem to indicate this name would ever return null.", "url": "https://github.com/openzipkin/brave/pull/1099#discussion_r383629865", "createdAt": "2020-02-25T02:42:31Z", "author": {"login": "anuraaga"}, "path": "instrumentation/jms/src/main/java/brave/jms/MessageParser.java", "diffHunk": "@@ -36,16 +36,35 @@\n   }\n \n   @Nullable static String channelKind(@Nullable Destination destination) {\n-    if (destination instanceof Queue) return \"queue\";\n-    if (destination instanceof Topic) return \"topic\";\n-    return null;\n+    if (destination == null) return null;\n+    return isQueue(destination) ? \"queue\" : \"topic\";\n+  }\n+\n+  /**\n+   * Handles special case of a destination being both a Queue and a Topic by checking if the\n+   * {@linkplain Queue#getQueueName() queue name} is readable.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c33acec763542bc8a69241e7fccf0ab3f3ccb7"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzODQyMTQw", "url": "https://github.com/openzipkin/brave/pull/1099#pullrequestreview-363842140", "createdAt": "2020-02-25T02:59:27Z", "commit": {"oid": "61c33acec763542bc8a69241e7fccf0ab3f3ccb7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjo1OToyOFrOFt3KVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjo1OToyOFrOFt3KVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYzNDAwNg==", "bodyText": "@anuraaga ex we catch this. we had to recently add these catches everywhere because implementations are free to throw for dumb reasons.", "url": "https://github.com/openzipkin/brave/pull/1099#discussion_r383634006", "createdAt": "2020-02-25T02:59:28Z", "author": {"login": "codefromthecrypt"}, "path": "instrumentation/jms/src/main/java/brave/jms/MessageParser.java", "diffHunk": "@@ -36,16 +36,35 @@\n   }\n \n   @Nullable static String channelKind(@Nullable Destination destination) {\n-    if (destination instanceof Queue) return \"queue\";\n-    if (destination instanceof Topic) return \"topic\";\n-    return null;\n+    if (destination == null) return null;\n+    return isQueue(destination) ? \"queue\" : \"topic\";\n+  }\n+\n+  /**\n+   * Handles special case of a destination being both a Queue and a Topic by checking if the\n+   * {@linkplain Queue#getQueueName() queue name} is readable.\n+   */\n+  static boolean isQueue(@Nullable Destination destination) {\n+    boolean isQueue = destination instanceof Queue;\n+    boolean isTopic = destination instanceof Topic;\n+    if (isQueue && isTopic) {\n+      try {\n+        isQueue = ((Queue) destination).getQueueName() != null;\n+      } catch (Throwable t) {\n+        propagateIfFatal(t);\n+        log(t, \"error getting destination name from {0}\", destination, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c33acec763542bc8a69241e7fccf0ab3f3ccb7"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1854, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}