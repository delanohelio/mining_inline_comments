{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3MTY2OTcx", "number": 1170, "title": "Makes Dubbo Error code words not numbers", "bodyText": "This makes \"dubbo.error_code\" use the code name, like \"TIMEOUT_EXCEPTION\", as\nopposed to the code number like 2.\nThis primarily matches conventions being defined in #999, where we prefer error\ncode names over numbers. The below rationale is a copy/paste from the new\nRATIONALE.md for Dubbo, and helps explain the subtle points here vs HTTP status.\n\nHTTP status codes are grouped by classification, and have existed so long that\nsupport teams can usually identify meaning by looking at a number like 401.\nBeing triple digits, it is relatively easy to search for what an HTTP status\nmeans.\nDubbo code numbers are more like enum ordinals. There's no grouping and it is\nnot easy to identify a problem quickly by seeing a number like 2 vs the code\nname \"TIMEOUT_EXCEPTION\". There is no generic documentation on Dubbo errors. If\ngiven only the number 2, a user unfamiliar with how Dubbo works internally will\nhave a hard time. For example, searching Dubbo's code base for \"2\" will return\nless relevant results than searching for \"TIMEOUT_EXCEPTION\".\nIt may seem that exception messages can overcome this problem, and they\ncertainly can when present. Also, exception messages can be localized. However,\nexception messages are not good for trace search because they are long and\ncontain variables.\nFor all these reasons, we use code names, not numbers, for Dubbo, as defined in\nRpcException's constants (so that they are easy to search).", "createdAt": "2020-04-22T09:31:43Z", "url": "https://github.com/openzipkin/brave/pull/1170", "merged": true, "mergeCommit": {"oid": "dda9264a78c1764354016a3854ef421cb3534357"}, "closed": true, "closedAt": "2020-04-22T11:12:03Z", "author": {"login": "codefromthecrypt"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaE6p6AH2gAyNDA3MTY2OTcxOmVhYTBkZjg5MWUwNTIwNDlkMjRlY2UyYmU3OGExODI5NTk5YjRlYjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaFzbsgH2gAyNDA3MTY2OTcxOjk5NWJhMGZmZTdlNTE5MTU4ZjkyOGQ4ZWRkYWM3NDIwYWNlNmNhYTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eaa0df891e052049d24ece2be78a1829599b4eb9", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/eaa0df891e052049d24ece2be78a1829599b4eb9", "committedDate": "2020-04-22T09:31:48Z", "message": "Makes Dubbo Error code words not numbers\n\nThis makes \"dubbo.error_code\" use the code name, like \"TIMEOUT_EXCEPTION\", as\nopposed to the code number like 2.\n\nThis primarily matches conventions being defined in #999, where we prefer error\ncode names over numbers. The below rationale is a copy/paste from the new\nRATIONALE.md for Dubbo, and helps explain the subtle points here vs HTTP status.\n\n---\n\nHTTP status codes are grouped by classification, and have existed so long that\nsupport teams can usually identify meaning by looking at a number like 401.\nBeing triple digits, it is relatively easy to search for what an HTTP status\nmeans.\n\nDubbo code numbers are more like enum ordinals. There's no grouping and it is\nnot easy to identify a problem quickly by seeing a number like 2 vs the code\nname \"TIMEOUT_EXCEPTION\". There is no generic documentation on Dubbo errors. If\ngiven only the number 2, a user unfamiliar with how Dubbo works internally will\nhave a hard time. For example, searching Dubbo's code base for \"2\" will return\nless relevant results than searching for \"TIMEOUT_EXCEPTION\".\n\nIt may seem that exception messages can overcome this problem, and they\ncertainly can when present. Also, exception messages can be localized. However,\nexception messages are not good for trace search because they are long and\ncontain variables.\n\nFor all these reasons, we use code names, not numbers, for Dubbo, as defined in\n`RpcException`'s constants (so that they are easy to search)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4MDEzMTU0", "url": "https://github.com/openzipkin/brave/pull/1170#pullrequestreview-398013154", "createdAt": "2020-04-22T09:33:42Z", "commit": {"oid": "eaa0df891e052049d24ece2be78a1829599b4eb9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwOTozMzo0M1rOGJs8Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwOTozMzo0M1rOGJs8Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgyNjY0Nw==", "bodyText": "I hadn't realized Dubbo are still releasing the Alibaba library.. I bumped just to make sure they are still not adding error codes.", "url": "https://github.com/openzipkin/brave/pull/1170#discussion_r412826647", "createdAt": "2020-04-22T09:33:43Z", "author": {"login": "codefromthecrypt"}, "path": "instrumentation/dubbo-rpc/pom.xml", "diffHunk": "@@ -32,7 +32,7 @@\n     <main.java.version>1.6</main.java.version>\n     <main.signature.artifact>java16</main.signature.artifact>\n     <!-- Use brave-instrumentation-dubbo for Apache Dubbo 2.7+, not this module. -->\n-    <dubbo.version>2.6.7</dubbo.version>\n+    <dubbo.version>2.6.8</dubbo.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaa0df891e052049d24ece2be78a1829599b4eb9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4MDIyMzE4", "url": "https://github.com/openzipkin/brave/pull/1170#pullrequestreview-398022318", "createdAt": "2020-04-22T09:45:35Z", "commit": {"oid": "eaa0df891e052049d24ece2be78a1829599b4eb9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwOTo0NTozNVrOGJtcOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwOTo0NTozNVrOGJtcOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgzNDg3NQ==", "bodyText": "I get where this is coming from. Just to share only one point I'm concerned about - if some servers in a fleet use a new version of instrumentation and others don't, the same exception shows up as name in some, int in others. It does seem quite rare though since why not bump instrumentation when bumping Dubbo? So all good here.", "url": "https://github.com/openzipkin/brave/pull/1170#discussion_r412834875", "createdAt": "2020-04-22T09:45:35Z", "author": {"login": "anuraaga"}, "path": "instrumentation/dubbo-rpc/src/main/java/brave/dubbo/rpc/DubboParser.java", "diffHunk": "@@ -69,19 +69,28 @@ static boolean parseRemoteIpAndPort(Span span) {\n   }\n \n   /**\n-   * We decided to not map Dubbo codes to human readable names like {@link\n-   * RpcException#BIZ_EXCEPTION} even though we defined \"rpc.error_code\" as a human readable name.\n-   *\n-   * <p>The reason was a comparison with HTTP status codes, and the choice was between returning\n-   * just numbers or reusing \"UNKNOWN_EXCEPTION\" which is defined in Dubbo for code \"0\" for any\n-   * unknown code. Returning numbers was the less bad option as it doesn't conflate code words.\n-   *\n-   * <p>Later, we can revert this back to code words, but once this gets into the RPC mapping for\n-   * Dubbo it will be hard to change.\n+   * This library is no-longer being released, so it should not have any maintenance on error codes.\n+   * The error codes here were defined in 2012.\n    */\n   @Nullable static String errorCode(Throwable error) {\n     if (error instanceof RpcException) {\n-      return String.valueOf(((RpcException) error).getCode());\n+      int code = ((RpcException) error).getCode();\n+      switch (code) {\n+        case RpcException.UNKNOWN_EXCEPTION:\n+          return \"UNKNOWN_EXCEPTION\";\n+        case RpcException.NETWORK_EXCEPTION:\n+          return \"NETWORK_EXCEPTION\";\n+        case RpcException.TIMEOUT_EXCEPTION:\n+          return \"TIMEOUT_EXCEPTION\";\n+        case RpcException.BIZ_EXCEPTION:\n+          return \"BIZ_EXCEPTION\";\n+        case RpcException.FORBIDDEN_EXCEPTION:\n+          return \"FORBIDDEN_EXCEPTION\";\n+        case RpcException.SERIALIZATION_EXCEPTION:\n+          return \"SERIALIZATION_EXCEPTION\";\n+        default:\n+          return String.valueOf(code);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaa0df891e052049d24ece2be78a1829599b4eb9"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbc774eb782dff63d1bc76010f4362988a488e99", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/cbc774eb782dff63d1bc76010f4362988a488e99", "committedDate": "2020-04-22T10:18:55Z", "message": "use reflection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4MDQ5Njkx", "url": "https://github.com/openzipkin/brave/pull/1170#pullrequestreview-398049691", "createdAt": "2020-04-22T10:21:20Z", "commit": {"oid": "cbc774eb782dff63d1bc76010f4362988a488e99"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMDoyMToyMFrOGJu7IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMDoyMjo1N1rOGJu_Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg1OTE2OA==", "bodyText": "Nice", "url": "https://github.com/openzipkin/brave/pull/1170#discussion_r412859168", "createdAt": "2020-04-22T10:21:20Z", "author": {"login": "anuraaga"}, "path": "instrumentation/dubbo/src/main/java/brave/dubbo/DubboParser.java", "diffHunk": "@@ -25,6 +29,36 @@\n import org.apache.dubbo.rpc.support.RpcUtils;\n \n final class DubboParser {\n+  static final Map<Integer, String> ERROR_CODE_NUMBER_TO_NAME = errorCodeNumberToName();\n+\n+  /**\n+   * Dubbo adds error codes sometimes. For example, they added two in the last two years. If we did\n+   * a simple switch/case of each code, like {@link RpcException#BIZ_EXCEPTION}, new code names\n+   * would not be seen until an upgrade of Brave. That, or we'd have to fall back to a code number\n+   * until the upgrade of Brave converged.\n+   *\n+   * <p>This uses reflection instead, which is unlikely to fail as Dubbo's error codes are public\n+   * constants.\n+   */\n+  static Map<Integer, String> errorCodeNumberToName() {\n+    Map<Integer, String> result = new LinkedHashMap<>();\n+    for (Field field : RpcException.class.getDeclaredFields()) {\n+      if (Modifier.isStatic(field.getModifiers()) && field.getType() == int.class) {\n+        try {\n+          result.put((Integer) field.get(null), field.getName());\n+        } catch (Exception e) {\n+          assert false : e.getMessage(); // make all unit tests fail", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbc774eb782dff63d1bc76010f4362988a488e99"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg2MDE5MA==", "bodyText": "How about checking Modifier.isPublic too?", "url": "https://github.com/openzipkin/brave/pull/1170#discussion_r412860190", "createdAt": "2020-04-22T10:22:57Z", "author": {"login": "anuraaga"}, "path": "instrumentation/dubbo/src/main/java/brave/dubbo/DubboParser.java", "diffHunk": "@@ -25,6 +29,36 @@\n import org.apache.dubbo.rpc.support.RpcUtils;\n \n final class DubboParser {\n+  static final Map<Integer, String> ERROR_CODE_NUMBER_TO_NAME = errorCodeNumberToName();\n+\n+  /**\n+   * Dubbo adds error codes sometimes. For example, they added two in the last two years. If we did\n+   * a simple switch/case of each code, like {@link RpcException#BIZ_EXCEPTION}, new code names\n+   * would not be seen until an upgrade of Brave. That, or we'd have to fall back to a code number\n+   * until the upgrade of Brave converged.\n+   *\n+   * <p>This uses reflection instead, which is unlikely to fail as Dubbo's error codes are public\n+   * constants.\n+   */\n+  static Map<Integer, String> errorCodeNumberToName() {\n+    Map<Integer, String> result = new LinkedHashMap<>();\n+    for (Field field : RpcException.class.getDeclaredFields()) {\n+      if (Modifier.isStatic(field.getModifiers()) && field.getType() == int.class) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbc774eb782dff63d1bc76010f4362988a488e99"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "995ba0ffe7e519158f928d8eddac7420ace6caa8", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/995ba0ffe7e519158f928d8eddac7420ace6caa8", "committedDate": "2020-04-22T10:33:49Z", "message": "public static final int"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1681, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}