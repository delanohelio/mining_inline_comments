{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4OTkyNDUx", "number": 1099, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjo0MjozMVrODijDYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjo1OToyOFrODijNxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3NTUyNDgyOnYy", "diffSide": "RIGHT", "path": "instrumentation/jms/src/main/java/brave/jms/MessageParser.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjo0MjozMVrOFt26KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMzoxNjo0OFrOFt3Zkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyOTg2NQ==", "bodyText": "Perhaps need to link to the issue here or provide a bit more background. The JMS APIs are generally sketchy, but the javadoc doesn't seem to indicate this name would ever return null.", "url": "https://github.com/openzipkin/brave/pull/1099#discussion_r383629865", "createdAt": "2020-02-25T02:42:31Z", "author": {"login": "anuraaga"}, "path": "instrumentation/jms/src/main/java/brave/jms/MessageParser.java", "diffHunk": "@@ -36,16 +36,35 @@\n   }\n \n   @Nullable static String channelKind(@Nullable Destination destination) {\n-    if (destination instanceof Queue) return \"queue\";\n-    if (destination instanceof Topic) return \"topic\";\n-    return null;\n+    if (destination == null) return null;\n+    return isQueue(destination) ? \"queue\" : \"topic\";\n+  }\n+\n+  /**\n+   * Handles special case of a destination being both a Queue and a Topic by checking if the\n+   * {@linkplain Queue#getQueueName() queue name} is readable.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c33acec763542bc8a69241e7fccf0ab3f3ccb7"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYzMjkzMA==", "bodyText": "we check null anyway, especially as everything can throw JMSException and we coerce those to null. Our bug was one place where we didn't: this line is more about fallback behavior than null.\nThis era of library design didn't have clarifying annotations or docs on null as a matter of course. This matter is compounded by TCKs not being open source either.. I don't think it would help to assume non-null on JMS properties with or without this change.\nI could add a comment about the example of something implementing both, but I'd hesitate to use this as a why something can return null as generally they can become null and don't want people mistakenly thinking null is an edge case.\nwdyt?", "url": "https://github.com/openzipkin/brave/pull/1099#discussion_r383632930", "createdAt": "2020-02-25T02:55:00Z", "author": {"login": "codefromthecrypt"}, "path": "instrumentation/jms/src/main/java/brave/jms/MessageParser.java", "diffHunk": "@@ -36,16 +36,35 @@\n   }\n \n   @Nullable static String channelKind(@Nullable Destination destination) {\n-    if (destination instanceof Queue) return \"queue\";\n-    if (destination instanceof Topic) return \"topic\";\n-    return null;\n+    if (destination == null) return null;\n+    return isQueue(destination) ? \"queue\" : \"topic\";\n+  }\n+\n+  /**\n+   * Handles special case of a destination being both a Queue and a Topic by checking if the\n+   * {@linkplain Queue#getQueueName() queue name} is readable.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyOTg2NQ=="}, "originalCommit": {"oid": "61c33acec763542bc8a69241e7fccf0ab3f3ccb7"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYzNzkwNw==", "bodyText": "#1100 hoping this topic doesn't eat our afternoon", "url": "https://github.com/openzipkin/brave/pull/1099#discussion_r383637907", "createdAt": "2020-02-25T03:16:48Z", "author": {"login": "codefromthecrypt"}, "path": "instrumentation/jms/src/main/java/brave/jms/MessageParser.java", "diffHunk": "@@ -36,16 +36,35 @@\n   }\n \n   @Nullable static String channelKind(@Nullable Destination destination) {\n-    if (destination instanceof Queue) return \"queue\";\n-    if (destination instanceof Topic) return \"topic\";\n-    return null;\n+    if (destination == null) return null;\n+    return isQueue(destination) ? \"queue\" : \"topic\";\n+  }\n+\n+  /**\n+   * Handles special case of a destination being both a Queue and a Topic by checking if the\n+   * {@linkplain Queue#getQueueName() queue name} is readable.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyOTg2NQ=="}, "originalCommit": {"oid": "61c33acec763542bc8a69241e7fccf0ab3f3ccb7"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3NTU1MTQxOnYy", "diffSide": "RIGHT", "path": "instrumentation/jms/src/main/java/brave/jms/MessageParser.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjo1OToyOFrOFt3KVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjo1OToyOFrOFt3KVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYzNDAwNg==", "bodyText": "@anuraaga ex we catch this. we had to recently add these catches everywhere because implementations are free to throw for dumb reasons.", "url": "https://github.com/openzipkin/brave/pull/1099#discussion_r383634006", "createdAt": "2020-02-25T02:59:28Z", "author": {"login": "codefromthecrypt"}, "path": "instrumentation/jms/src/main/java/brave/jms/MessageParser.java", "diffHunk": "@@ -36,16 +36,35 @@\n   }\n \n   @Nullable static String channelKind(@Nullable Destination destination) {\n-    if (destination instanceof Queue) return \"queue\";\n-    if (destination instanceof Topic) return \"topic\";\n-    return null;\n+    if (destination == null) return null;\n+    return isQueue(destination) ? \"queue\" : \"topic\";\n+  }\n+\n+  /**\n+   * Handles special case of a destination being both a Queue and a Topic by checking if the\n+   * {@linkplain Queue#getQueueName() queue name} is readable.\n+   */\n+  static boolean isQueue(@Nullable Destination destination) {\n+    boolean isQueue = destination instanceof Queue;\n+    boolean isTopic = destination instanceof Topic;\n+    if (isQueue && isTopic) {\n+      try {\n+        isQueue = ((Queue) destination).getQueueName() != null;\n+      } catch (Throwable t) {\n+        propagateIfFatal(t);\n+        log(t, \"error getting destination name from {0}\", destination, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c33acec763542bc8a69241e7fccf0ab3f3ccb7"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1539, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}