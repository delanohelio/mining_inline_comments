{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NjU3NDM5", "number": 1198, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjoxNTo0MFrOD67KCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjoxODo1MFrOD67KxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMTEzMjI0OnYy", "diffSide": "RIGHT", "path": "brave/src/test/java/brave/test/TestSpanHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjoxNTo0MFrOGS_y1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjoxNTo0MFrOGS_y1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3Mjc1OQ==", "bodyText": "this is a preview of what will be in brave-tests. The \"reporter\" which was there will be renamed to IntegrationTestSpanHandler", "url": "https://github.com/openzipkin/brave/pull/1198#discussion_r422572759", "createdAt": "2020-05-10T02:15:40Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/test/java/brave/test/TestSpanHandler.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package brave.test;\n+\n+import brave.handler.MutableSpan;\n+import brave.handler.SpanHandler;\n+import brave.propagation.TraceContext;\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.stream.Stream;\n+\n+// copy of what's in brave-tests\n+public final class TestSpanHandler extends SpanHandler implements Iterable<MutableSpan> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fca258f6a83a62e2cb173d9ea6da790c00ad36d"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMTEzMjM4OnYy", "diffSide": "LEFT", "path": "brave/src/test/java/brave/internal/recorder/PendingSpansTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjoxNjowOFrOGS_y6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjoxNjowOFrOGS_y6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3Mjc3Ng==", "bodyText": "this is a zipkin concept so no longer relevant", "url": "https://github.com/openzipkin/brave/pull/1198#discussion_r422572776", "createdAt": "2020-05-10T02:16:08Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/test/java/brave/internal/recorder/PendingSpansTest.java", "diffHunk": "@@ -133,21 +126,22 @@ public void remove_doesntReport() {\n   public void reportOrphanedSpans_afterGC() {\n     TraceContext context1 = context.toBuilder().traceId(1).spanId(1).build();\n     PendingSpan span = pendingSpans.getOrCreate(null, context1, false);\n-    span.span.name(\"foo\");\n+    span.span.tag(\"foo\", \"bar\");\n+    span.span.tag(\"ice\", \"melt\");\n+\n+    // Prove that copy constructor doesn't pin GC\n+    MutableSpan copyOfData = new MutableSpan(span.span);\n     span = null; // clear reference so GC occurs\n+\n     TraceContext context2 = context.toBuilder().traceId(2).spanId(2).build();\n     pendingSpans.getOrCreate(null, context2, false);\n     TraceContext context3 = context.toBuilder().traceId(3).spanId(3).build();\n     pendingSpans.getOrCreate(null, context3, false);\n     TraceContext context4 = context.toBuilder().traceId(4).spanId(4).build();\n     pendingSpans.getOrCreate(null, context4, false);\n-    // ensure sampled local spans are not reported when orphaned unless they are also sampled remote", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fca258f6a83a62e2cb173d9ea6da790c00ad36d"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMTEzMjc1OnYy", "diffSide": "LEFT", "path": "brave/src/test/java/brave/features/handler/SkeletalSpansTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjoxNjo0MVrOGS_zEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjoxNjo0MVrOGS_zEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3MjgxNg==", "bodyText": "not worth the dependency, we can assume this", "url": "https://github.com/openzipkin/brave/pull/1198#discussion_r422572816", "createdAt": "2020-05-10T02:16:41Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/test/java/brave/features/handler/SkeletalSpansTest.java", "diffHunk": "@@ -120,39 +103,13 @@\n       );\n \n     assertThat(skeletalSpans.values())\n-      .extracting(s -> s.stream().map(zipkin2.Span::name).collect(Collectors.toList()))\n+      .extracting(s -> s.stream().map(MutableSpan::name).collect(Collectors.toList()))\n       .containsExactly(\n         asList(\"post\", \"post\", \"get\"),\n         asList(\"post\", \"post\", \"post\", \"get\")\n       );\n   }\n \n-  @Test public void skeletalSpans_produceSameServiceGraph() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fca258f6a83a62e2cb173d9ea6da790c00ad36d"}, "originalPosition": 114}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMTEzMzE2OnYy", "diffSide": "RIGHT", "path": "brave/src/test/java/brave/features/handler/CountingChildrenTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjoxNzozMFrOGS_zRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjoxNzozMFrOGS_zRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3Mjg2OA==", "bodyText": "a lot of tests will drift like this, but it is good as it proves brave doesn't meddle with case format even though our zipkin handler does.", "url": "https://github.com/openzipkin/brave/pull/1198#discussion_r422572868", "createdAt": "2020-05-10T02:17:30Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/test/java/brave/features/handler/CountingChildrenTest.java", "diffHunk": "@@ -136,12 +135,12 @@ public boolean begin(TraceContext context, MutableSpan span, @Nullable TraceCont\n     assertThat(nameToChildCount)\n       .isEqualTo(nameToChildCountDirect)\n       .containsExactly(\n-        tuple(\"root1child1child2child1\", \"0\"),\n-        tuple(\"root2child1\", \"0\"),\n-        tuple(\"root1child1child1\", \"1\"),\n+        tuple(\"root1Child1Child2Child1\", \"0\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fca258f6a83a62e2cb173d9ea6da790c00ad36d"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMTEzMzgxOnYy", "diffSide": "RIGHT", "path": "brave/src/test/java/brave/TracerTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjoxODoxM1rOGS_zig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjoxODoxM1rOGS_zig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3MjkzOA==", "bodyText": "not a bug, just MutableSpan is timestamps not timestamp,duration", "url": "https://github.com/openzipkin/brave/pull/1198#discussion_r422572938", "createdAt": "2020-05-10T02:18:13Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/test/java/brave/TracerTest.java", "diffHunk": "@@ -187,27 +180,27 @@\n    * other for the server.\n    */\n   @Test public void join_sharedDataIsSeparate() {\n-    Span clientSide = tracer.newTrace().kind(Kind.CLIENT).start(1L);\n-    Span serverSide = tracer.joinSpan(clientSide.context()).kind(Kind.SERVER).start(2L);\n+    Span clientSide = tracer.newTrace().kind(CLIENT).start(1L);\n+    Span serverSide = tracer.joinSpan(clientSide.context()).kind(SERVER).start(2L);\n     serverSide.finish(3L);\n     clientSide.finish(4L);\n \n     // Ensure they use the same span ID (sanity check)\n     String spanId = spans.get(0).id();\n-    assertThat(spans).extracting(zipkin2.Span::id)\n+    assertThat(spans).extracting(MutableSpan::id)\n       .containsExactly(spanId, spanId);\n \n     // Ensure the important parts are separated correctly\n     assertThat(spans).extracting(\n-      zipkin2.Span::kind, zipkin2.Span::shared, zipkin2.Span::timestamp, zipkin2.Span::duration\n+      MutableSpan::kind, MutableSpan::shared, MutableSpan::startTimestamp, MutableSpan::finishTimestamp\n     ).containsExactly(\n-      tuple(zipkin2.Span.Kind.SERVER, true, 2L, 1L),\n-      tuple(zipkin2.Span.Kind.CLIENT, null, 1L, 3L)\n+      tuple(SERVER, true, 2L, 3L),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fca258f6a83a62e2cb173d9ea6da790c00ad36d"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMTEzNDEzOnYy", "diffSide": "LEFT", "path": "brave/src/test/java/brave/LazySpanTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjoxODo1MFrOGS_zsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjoxODo1MFrOGS_zsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3Mjk3Nw==", "bodyText": "some tests that did nothing with scopes had strict context, which is distracting.", "url": "https://github.com/openzipkin/brave/pull/1198#discussion_r422572977", "createdAt": "2020-05-10T02:18:50Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/test/java/brave/LazySpanTest.java", "diffHunk": "@@ -14,22 +14,17 @@\n package brave;\n \n import brave.propagation.CurrentTraceContext.Scope;\n-import brave.propagation.StrictCurrentTraceContext;\n import brave.propagation.TraceContext;\n import brave.propagation.TraceContextOrSamplingFlags;\n-import java.util.ArrayList;\n-import java.util.List;\n+import brave.test.TestSpanHandler;\n import org.junit.After;\n import org.junit.Test;\n \n import static org.assertj.core.api.Assertions.assertThat;\n \n public class LazySpanTest {\n-  List<zipkin2.Span> spans = new ArrayList<>();\n-  Tracing tracing = Tracing.newBuilder()\n-    .currentTraceContext(StrictCurrentTraceContext.create())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fca258f6a83a62e2cb173d9ea6da790c00ad36d"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1429, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}