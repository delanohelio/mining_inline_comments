{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NjczMjM0", "number": 1092, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwNzozNTo1OFrODiIUcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzowNTo1NVrODiOcjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MTE0NDgyOnYy", "diffSide": "RIGHT", "path": "instrumentation/http/src/main/java/brave/http/HttpResponse.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwNzozNTo1OFrOFtOyHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNjo0Mzo1OFrOFtWv4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk3MjQ0NQ==", "bodyText": "Maybe it's worth adding Where possible, prefer to populate `{@link #request()} to provide both the method and other information that may be useful during response parsing.", "url": "https://github.com/openzipkin/brave/pull/1092#discussion_r382972445", "createdAt": "2020-02-23T07:35:58Z", "author": {"login": "anuraaga"}, "path": "instrumentation/http/src/main/java/brave/http/HttpResponse.java", "diffHunk": "@@ -28,31 +28,45 @@\n  */\n public abstract class HttpResponse extends Response {\n   /**\n-   * Like {@link HttpRequest#method()} except used in response parsing.\n+   * The request that initiated this HTTP response or {@code null} if unknown.\n    *\n-   * <p>Notably, this is used to create a route-based span name.\n+   * <p>Implementations should return the last wire-level request that caused this response or\n+   * error. HTTP properties like {@linkplain HttpRequest#path() path} and {@linkplain\n+   * HttpRequest#header(String) headers} might be different, due to redirects or authentication.\n+   * Some properties might not be visible until response processing, notably {@link #route()}.\n    *\n    * @since 5.10\n    */\n-  // TODO: Consider `httpResponse.request()` and deprecating `httpResponse.method()` #1086\n-  @Nullable public String method() {\n+  @Nullable public HttpRequest request() {\n     return null;\n   }\n \n   /**\n-   * Returns an expression such as \"/items/:itemId\" representing an application endpoint,\n-   * conventionally associated with the tag key \"http.route\". If no route matched, \"\" (empty string)\n-   * is returned. Null indicates this instrumentation doesn't understand http routes.\n+   * Returns the {@linkplain HttpRequest#method() HTTP method} of the request that caused this\n+   * response or {@code null} if unreadable.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7376780c39738fb30c2fee9bd21abb56a3ecab07"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzEwMjk0NA==", "bodyText": "sure", "url": "https://github.com/openzipkin/brave/pull/1092#discussion_r383102944", "createdAt": "2020-02-24T06:43:58Z", "author": {"login": "codefromthecrypt"}, "path": "instrumentation/http/src/main/java/brave/http/HttpResponse.java", "diffHunk": "@@ -28,31 +28,45 @@\n  */\n public abstract class HttpResponse extends Response {\n   /**\n-   * Like {@link HttpRequest#method()} except used in response parsing.\n+   * The request that initiated this HTTP response or {@code null} if unknown.\n    *\n-   * <p>Notably, this is used to create a route-based span name.\n+   * <p>Implementations should return the last wire-level request that caused this response or\n+   * error. HTTP properties like {@linkplain HttpRequest#path() path} and {@linkplain\n+   * HttpRequest#header(String) headers} might be different, due to redirects or authentication.\n+   * Some properties might not be visible until response processing, notably {@link #route()}.\n    *\n    * @since 5.10\n    */\n-  // TODO: Consider `httpResponse.request()` and deprecating `httpResponse.method()` #1086\n-  @Nullable public String method() {\n+  @Nullable public HttpRequest request() {\n     return null;\n   }\n \n   /**\n-   * Returns an expression such as \"/items/:itemId\" representing an application endpoint,\n-   * conventionally associated with the tag key \"http.route\". If no route matched, \"\" (empty string)\n-   * is returned. Null indicates this instrumentation doesn't understand http routes.\n+   * Returns the {@linkplain HttpRequest#method() HTTP method} of the request that caused this\n+   * response or {@code null} if unreadable.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk3MjQ0NQ=="}, "originalCommit": {"oid": "7376780c39738fb30c2fee9bd21abb56a3ecab07"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MTE0NjcwOnYy", "diffSide": "RIGHT", "path": "instrumentation/servlet/src/main/java/brave/servlet/HttpServletResponseWrapper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwNzo0MDoxMFrOFtOzAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwNzo0MDoxMFrOFtOzAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk3MjY3NQ==", "bodyText": "I had to do a doubletake here, it's an extra line but this could help readers\nif (caught != null) return caught;\nif (request == null) return null;\nreturn request.maybeError();", "url": "https://github.com/openzipkin/brave/pull/1092#discussion_r382972675", "createdAt": "2020-02-23T07:40:10Z", "author": {"login": "anuraaga"}, "path": "instrumentation/servlet/src/main/java/brave/servlet/HttpServletResponseWrapper.java", "diffHunk": "@@ -31,29 +30,37 @@\n // Public for use in sparkjava or other frameworks that re-use servlet types\n public class HttpServletResponseWrapper extends HttpServerResponse { // not final for inner subtype\n   /**\n-   * Looks for the {@link HttpServletRequest#setAttribute(String, Object) request attributes}\n-   * \"http.route\" and \"error\" to customize the result.\n-   *\n    * @param caught an exception caught serving the request.\n    * @since 5.10\n    */\n-  public static HttpServerResponse create(@Nullable HttpServletRequest req,\n-    HttpServletResponse res, @Nullable Throwable caught) {\n-    if (req == null) return new HttpServletResponseWrapper(res, caught);\n-    return new WithRequestProperties(req, res, caught);\n+  public static HttpServerResponse create(@Nullable HttpServletRequest request,\n+    HttpServletResponse response, @Nullable Throwable caught) {\n+    return new HttpServletResponseWrapper(request, response, caught);\n   }\n \n-  final HttpServletResponse delegate;\n+  @Nullable final HttpServletRequestWrapper request;\n+  final HttpServletResponse response;\n   @Nullable final Throwable caught;\n \n-  HttpServletResponseWrapper(HttpServletResponse delegate, @Nullable Throwable caught) {\n-    if (delegate == null) throw new NullPointerException(\"delegate == null\");\n-    this.delegate = delegate;\n+  HttpServletResponseWrapper(@Nullable HttpServletRequest request, HttpServletResponse response,\n+    @Nullable Throwable caught) {\n+    if (response == null) throw new NullPointerException(\"response == null\");\n+    this.request = request != null ? new HttpServletRequestWrapper(request) : null;\n+    this.response = response;\n     this.caught = caught;\n   }\n \n+  @Override public HttpRequest request() {\n+    return request;\n+  }\n+\n+  @Override public Throwable error() {\n+    if (caught != null || request == null) return caught;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7376780c39738fb30c2fee9bd21abb56a3ecab07"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MTE0NzQzOnYy", "diffSide": "LEFT", "path": "instrumentation/servlet/src/main/java/brave/servlet/HttpServletResponseWrapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwNzo0MToyMVrOFtOzXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwNzo0MToyMVrOFtOzXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk3Mjc2Nw==", "bodyText": "Fun to see this class get deleted", "url": "https://github.com/openzipkin/brave/pull/1092#discussion_r382972767", "createdAt": "2020-02-23T07:41:21Z", "author": {"login": "anuraaga"}, "path": "instrumentation/servlet/src/main/java/brave/servlet/HttpServletResponseWrapper.java", "diffHunk": "@@ -65,34 +72,7 @@ public static HttpServerResponse create(@Nullable HttpServletRequest req,\n     return result;\n   }\n \n-  @Override public Throwable error() {\n-    return caught;\n-  }\n-\n   @Override public final Object unwrap() {\n-    return delegate;\n-  }\n-\n-  static final class WithRequestProperties extends HttpServletResponseWrapper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7376780c39738fb30c2fee9bd21abb56a3ecab07"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MjE0ODYzOnYy", "diffSide": "RIGHT", "path": "instrumentation/http/src/main/java/brave/http/HttpResponse.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzowNTo1NVrOFtXAZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwODozMDoyMVrOFtYYTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzEwNzE3NA==", "bodyText": "@anuraaga I feel like this should be on Response, not HttpResponse. We added Response in 5.10 (this pending version). If we pull it up afterwards (for Rpc) it will look awkward I think..", "url": "https://github.com/openzipkin/brave/pull/1092#discussion_r383107174", "createdAt": "2020-02-24T07:05:55Z", "author": {"login": "codefromthecrypt"}, "path": "instrumentation/http/src/main/java/brave/http/HttpResponse.java", "diffHunk": "@@ -28,31 +28,45 @@\n  */\n public abstract class HttpResponse extends Response {\n   /**\n-   * Like {@link HttpRequest#method()} except used in response parsing.\n+   * The request that initiated this HTTP response or {@code null} if unknown.\n    *\n-   * <p>Notably, this is used to create a route-based span name.\n+   * <p>Implementations should return the last wire-level request that caused this response or\n+   * error. HTTP properties like {@linkplain HttpRequest#path() path} and {@linkplain\n+   * HttpRequest#header(String) headers} might be different, due to redirects or authentication.\n+   * Some properties might not be visible until response processing, notably {@link #route()}.\n    *\n    * @since 5.10\n    */\n-  // TODO: Consider `httpResponse.request()` and deprecating `httpResponse.method()` #1086\n-  @Nullable public String method() {\n+  @Nullable public HttpRequest request() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7376780c39738fb30c2fee9bd21abb56a3ecab07"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzEyOTY3OA==", "bodyText": "Ah yeah that makes sense to me", "url": "https://github.com/openzipkin/brave/pull/1092#discussion_r383129678", "createdAt": "2020-02-24T08:30:21Z", "author": {"login": "anuraaga"}, "path": "instrumentation/http/src/main/java/brave/http/HttpResponse.java", "diffHunk": "@@ -28,31 +28,45 @@\n  */\n public abstract class HttpResponse extends Response {\n   /**\n-   * Like {@link HttpRequest#method()} except used in response parsing.\n+   * The request that initiated this HTTP response or {@code null} if unknown.\n    *\n-   * <p>Notably, this is used to create a route-based span name.\n+   * <p>Implementations should return the last wire-level request that caused this response or\n+   * error. HTTP properties like {@linkplain HttpRequest#path() path} and {@linkplain\n+   * HttpRequest#header(String) headers} might be different, due to redirects or authentication.\n+   * Some properties might not be visible until response processing, notably {@link #route()}.\n    *\n    * @since 5.10\n    */\n-  // TODO: Consider `httpResponse.request()` and deprecating `httpResponse.method()` #1086\n-  @Nullable public String method() {\n+  @Nullable public HttpRequest request() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzEwNzE3NA=="}, "originalCommit": {"oid": "7376780c39738fb30c2fee9bd21abb56a3ecab07"}, "originalPosition": 17}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1531, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}