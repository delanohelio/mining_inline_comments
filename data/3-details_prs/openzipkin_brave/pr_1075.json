{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMjA5Njk1", "number": 1075, "title": "Adds defense for incorrectly implemented client and server requests", "bodyText": "It is invalid to return null when unwrapping the portable http client\nor server types. However, if someone did return null, it is hard to\ndetermine what went wrong. This tolerates the incorrect code similarly\nto how we do in toString. The result is that the span will finish and\nthe code won't crash.", "createdAt": "2020-02-05T06:44:46Z", "url": "https://github.com/openzipkin/brave/pull/1075", "merged": true, "mergeCommit": {"oid": "75dfaaa0ff52bb7c58cf2fbe06c693bc5e77db2f"}, "closed": true, "closedAt": "2020-02-05T11:28:16Z", "author": {"login": "codefromthecrypt"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBQYm9AFqTM1MzQ5NDY5Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBSMlzgH2gAyMzcxMjA5Njk1OmY1ZDRlNDIyMTY2ZTE2ZTNlNjM0ZjA0MzgxMjhmMDM2NDU3MWIwZWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNDk0Njky", "url": "https://github.com/openzipkin/brave/pull/1075#pullrequestreview-353494692", "createdAt": "2020-02-05T06:45:21Z", "commit": {"oid": "7b1f4dd790549481182a3d2779f49f67e45e0570"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwNjo0NToyMlrOFltNuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwNjo0NToyMlrOFltNuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA4MjQyNQ==", "bodyText": "copied from the parser#response javadoc", "url": "https://github.com/openzipkin/brave/pull/1075#discussion_r375082425", "createdAt": "2020-02-05T06:45:22Z", "author": {"login": "codefromthecrypt"}, "path": "instrumentation/http/src/main/java/brave/http/HttpClientHandler.java", "diffHunk": "@@ -176,16 +176,25 @@ public Span handleSend(HttpClientRequest request, Span span) {\n    * <p>This is typically called once the response headers are received, and after the span is\n    * {@link brave.Tracer.SpanInScope#close() no longer in scope}.\n    *\n+   * <p>Note: Either the response or error parameters may be null, but not both.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b1f4dd790549481182a3d2779f49f67e45e0570"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b1f4dd790549481182a3d2779f49f67e45e0570", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/7b1f4dd790549481182a3d2779f49f67e45e0570", "committedDate": "2020-02-05T06:44:19Z", "message": "Adds defense for incorrectly implemented client and server requests\n\nIt is invalid to return null when unwrapping the portable http client\nor server types. However, if someone did return null, it is hard to\ndetermine what went wrong. This tolerates the incorrect code similarly\nto how we do in toString. The result is that the span will finish and\nthe code won't crash."}, "afterCommit": {"oid": "d4f93d336e13987ed6a637f992f522be8d725ef4", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/d4f93d336e13987ed6a637f992f522be8d725ef4", "committedDate": "2020-02-05T07:21:15Z", "message": "Adds defense for incorrectly implemented client and server requests\n\nIt is invalid to return null when unwrapping the portable http client\nor server types. However, if someone did return null, it is hard to\ndetermine what went wrong. This tolerates the incorrect code similarly\nto how we do in toString. The result is that the span will finish and\nthe code won't crash."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4f93d336e13987ed6a637f992f522be8d725ef4", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/d4f93d336e13987ed6a637f992f522be8d725ef4", "committedDate": "2020-02-05T07:21:15Z", "message": "Adds defense for incorrectly implemented client and server requests\n\nIt is invalid to return null when unwrapping the portable http client\nor server types. However, if someone did return null, it is hard to\ndetermine what went wrong. This tolerates the incorrect code similarly\nto how we do in toString. The result is that the span will finish and\nthe code won't crash."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNTE4OTE0", "url": "https://github.com/openzipkin/brave/pull/1075#pullrequestreview-353518914", "createdAt": "2020-02-05T07:53:03Z", "commit": {"oid": "d4f93d336e13987ed6a637f992f522be8d725ef4"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwNzo1MzowM1rOFlubtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwNzo1Mzo0MFrOFluchA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEwMjM4OA==", "bodyText": "Should we throw an exception instead of using assert since it indicates bad code?", "url": "https://github.com/openzipkin/brave/pull/1075#discussion_r375102388", "createdAt": "2020-02-05T07:53:03Z", "author": {"login": "anuraaga"}, "path": "instrumentation/http/src/main/java/brave/http/HttpClientHandler.java", "diffHunk": "@@ -176,16 +176,25 @@ public Span handleSend(HttpClientRequest request, Span span) {\n    * <p>This is typically called once the response headers are received, and after the span is\n    * {@link brave.Tracer.SpanInScope#close() no longer in scope}.\n    *\n+   * <p>Note: Either the response or error parameters may be null, but not both.\n+   *\n    * @see HttpClientParser#response(HttpAdapter, Object, Throwable, SpanCustomizer)\n    * @since 4.3\n    */\n   public void handleReceive(@Nullable Resp response, @Nullable Throwable error, Span span) {\n-    if (response instanceof HttpClientResponse) {\n-      HttpClientResponse.Adapter adapter =\n-        new HttpClientResponse.Adapter((HttpClientResponse) response);\n-      handleFinish(adapter, adapter.unwrapped, error, span);\n-    } else {\n+    assert response != null || error != null :", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4f93d336e13987ed6a637f992f522be8d725ef4"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEwMjU5Ng==", "bodyText": "Or log? How do we find the bugs in the instrumentation?", "url": "https://github.com/openzipkin/brave/pull/1075#discussion_r375102596", "createdAt": "2020-02-05T07:53:40Z", "author": {"login": "anuraaga"}, "path": "instrumentation/http/src/main/java/brave/http/HttpClientHandler.java", "diffHunk": "@@ -176,16 +176,25 @@ public Span handleSend(HttpClientRequest request, Span span) {\n    * <p>This is typically called once the response headers are received, and after the span is\n    * {@link brave.Tracer.SpanInScope#close() no longer in scope}.\n    *\n+   * <p>Note: Either the response or error parameters may be null, but not both.\n+   *\n    * @see HttpClientParser#response(HttpAdapter, Object, Throwable, SpanCustomizer)\n    * @since 4.3\n    */\n   public void handleReceive(@Nullable Resp response, @Nullable Throwable error, Span span) {\n-    if (response instanceof HttpClientResponse) {\n-      HttpClientResponse.Adapter adapter =\n-        new HttpClientResponse.Adapter((HttpClientResponse) response);\n-      handleFinish(adapter, adapter.unwrapped, error, span);\n-    } else {\n+    assert response != null || error != null :", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEwMjM4OA=="}, "originalCommit": {"oid": "d4f93d336e13987ed6a637f992f522be8d725ef4"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5d4e422166e16e3e634f0438128f0364571b0ee", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/f5d4e422166e16e3e634f0438128f0364571b0ee", "committedDate": "2020-02-05T08:52:03Z", "message": "throwme"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1826, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}