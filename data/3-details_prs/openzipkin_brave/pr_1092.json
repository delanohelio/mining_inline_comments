{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NjczMjM0", "number": 1092, "title": "Adds HttpResponse.request()", "bodyText": "This adds nullable HttpResponse.request() per discussion in #1086\nThis doesn't deprecate method or route as there are a couple places you\ncan't see the request (unless we propagate it ourselves). Also, we have\na scenario in vert.x where the data holding the route isn't on the\nrequest.\nFixes #1086", "createdAt": "2020-02-23T07:29:45Z", "url": "https://github.com/openzipkin/brave/pull/1092", "merged": true, "mergeCommit": {"oid": "bae135f9cdf74be6c6a66a4c12019df989ef7a6f"}, "closed": true, "closedAt": "2020-02-25T02:56:04Z", "author": {"login": "codefromthecrypt"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHD-zgAFqTM2MzA3MTIyOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHow5nAFqTM2MzgzNTA4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDcxMjI4", "url": "https://github.com/openzipkin/brave/pull/1092#pullrequestreview-363071228", "createdAt": "2020-02-23T07:35:57Z", "commit": {"oid": "7376780c39738fb30c2fee9bd21abb56a3ecab07"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwNzozNTo1OFrOFtOyHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwNzo0MToyMVrOFtOzXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk3MjQ0NQ==", "bodyText": "Maybe it's worth adding Where possible, prefer to populate `{@link #request()} to provide both the method and other information that may be useful during response parsing.", "url": "https://github.com/openzipkin/brave/pull/1092#discussion_r382972445", "createdAt": "2020-02-23T07:35:58Z", "author": {"login": "anuraaga"}, "path": "instrumentation/http/src/main/java/brave/http/HttpResponse.java", "diffHunk": "@@ -28,31 +28,45 @@\n  */\n public abstract class HttpResponse extends Response {\n   /**\n-   * Like {@link HttpRequest#method()} except used in response parsing.\n+   * The request that initiated this HTTP response or {@code null} if unknown.\n    *\n-   * <p>Notably, this is used to create a route-based span name.\n+   * <p>Implementations should return the last wire-level request that caused this response or\n+   * error. HTTP properties like {@linkplain HttpRequest#path() path} and {@linkplain\n+   * HttpRequest#header(String) headers} might be different, due to redirects or authentication.\n+   * Some properties might not be visible until response processing, notably {@link #route()}.\n    *\n    * @since 5.10\n    */\n-  // TODO: Consider `httpResponse.request()` and deprecating `httpResponse.method()` #1086\n-  @Nullable public String method() {\n+  @Nullable public HttpRequest request() {\n     return null;\n   }\n \n   /**\n-   * Returns an expression such as \"/items/:itemId\" representing an application endpoint,\n-   * conventionally associated with the tag key \"http.route\". If no route matched, \"\" (empty string)\n-   * is returned. Null indicates this instrumentation doesn't understand http routes.\n+   * Returns the {@linkplain HttpRequest#method() HTTP method} of the request that caused this\n+   * response or {@code null} if unreadable.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7376780c39738fb30c2fee9bd21abb56a3ecab07"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk3MjY3NQ==", "bodyText": "I had to do a doubletake here, it's an extra line but this could help readers\nif (caught != null) return caught;\nif (request == null) return null;\nreturn request.maybeError();", "url": "https://github.com/openzipkin/brave/pull/1092#discussion_r382972675", "createdAt": "2020-02-23T07:40:10Z", "author": {"login": "anuraaga"}, "path": "instrumentation/servlet/src/main/java/brave/servlet/HttpServletResponseWrapper.java", "diffHunk": "@@ -31,29 +30,37 @@\n // Public for use in sparkjava or other frameworks that re-use servlet types\n public class HttpServletResponseWrapper extends HttpServerResponse { // not final for inner subtype\n   /**\n-   * Looks for the {@link HttpServletRequest#setAttribute(String, Object) request attributes}\n-   * \"http.route\" and \"error\" to customize the result.\n-   *\n    * @param caught an exception caught serving the request.\n    * @since 5.10\n    */\n-  public static HttpServerResponse create(@Nullable HttpServletRequest req,\n-    HttpServletResponse res, @Nullable Throwable caught) {\n-    if (req == null) return new HttpServletResponseWrapper(res, caught);\n-    return new WithRequestProperties(req, res, caught);\n+  public static HttpServerResponse create(@Nullable HttpServletRequest request,\n+    HttpServletResponse response, @Nullable Throwable caught) {\n+    return new HttpServletResponseWrapper(request, response, caught);\n   }\n \n-  final HttpServletResponse delegate;\n+  @Nullable final HttpServletRequestWrapper request;\n+  final HttpServletResponse response;\n   @Nullable final Throwable caught;\n \n-  HttpServletResponseWrapper(HttpServletResponse delegate, @Nullable Throwable caught) {\n-    if (delegate == null) throw new NullPointerException(\"delegate == null\");\n-    this.delegate = delegate;\n+  HttpServletResponseWrapper(@Nullable HttpServletRequest request, HttpServletResponse response,\n+    @Nullable Throwable caught) {\n+    if (response == null) throw new NullPointerException(\"response == null\");\n+    this.request = request != null ? new HttpServletRequestWrapper(request) : null;\n+    this.response = response;\n     this.caught = caught;\n   }\n \n+  @Override public HttpRequest request() {\n+    return request;\n+  }\n+\n+  @Override public Throwable error() {\n+    if (caught != null || request == null) return caught;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7376780c39738fb30c2fee9bd21abb56a3ecab07"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk3Mjc2Nw==", "bodyText": "Fun to see this class get deleted", "url": "https://github.com/openzipkin/brave/pull/1092#discussion_r382972767", "createdAt": "2020-02-23T07:41:21Z", "author": {"login": "anuraaga"}, "path": "instrumentation/servlet/src/main/java/brave/servlet/HttpServletResponseWrapper.java", "diffHunk": "@@ -65,34 +72,7 @@ public static HttpServerResponse create(@Nullable HttpServletRequest req,\n     return result;\n   }\n \n-  @Override public Throwable error() {\n-    return caught;\n-  }\n-\n   @Override public final Object unwrap() {\n-    return delegate;\n-  }\n-\n-  static final class WithRequestProperties extends HttpServletResponseWrapper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7376780c39738fb30c2fee9bd21abb56a3ecab07"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTk0Mjcz", "url": "https://github.com/openzipkin/brave/pull/1092#pullrequestreview-363194273", "createdAt": "2020-02-24T07:05:55Z", "commit": {"oid": "7376780c39738fb30c2fee9bd21abb56a3ecab07"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzowNTo1NVrOFtXAZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzowNTo1NVrOFtXAZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzEwNzE3NA==", "bodyText": "@anuraaga I feel like this should be on Response, not HttpResponse. We added Response in 5.10 (this pending version). If we pull it up afterwards (for Rpc) it will look awkward I think..", "url": "https://github.com/openzipkin/brave/pull/1092#discussion_r383107174", "createdAt": "2020-02-24T07:05:55Z", "author": {"login": "codefromthecrypt"}, "path": "instrumentation/http/src/main/java/brave/http/HttpResponse.java", "diffHunk": "@@ -28,31 +28,45 @@\n  */\n public abstract class HttpResponse extends Response {\n   /**\n-   * Like {@link HttpRequest#method()} except used in response parsing.\n+   * The request that initiated this HTTP response or {@code null} if unknown.\n    *\n-   * <p>Notably, this is used to create a route-based span name.\n+   * <p>Implementations should return the last wire-level request that caused this response or\n+   * error. HTTP properties like {@linkplain HttpRequest#path() path} and {@linkplain\n+   * HttpRequest#header(String) headers} might be different, due to redirects or authentication.\n+   * Some properties might not be visible until response processing, notably {@link #route()}.\n    *\n    * @since 5.10\n    */\n-  // TODO: Consider `httpResponse.request()` and deprecating `httpResponse.method()` #1086\n-  @Nullable public String method() {\n+  @Nullable public HttpRequest request() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7376780c39738fb30c2fee9bd21abb56a3ecab07"}, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7376780c39738fb30c2fee9bd21abb56a3ecab07", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/7376780c39738fb30c2fee9bd21abb56a3ecab07", "committedDate": "2020-02-23T07:27:05Z", "message": "WIP: Adds HttpResponse.request()\n\nThis adds nullable `HttpResponse.request()` per discussion in #1086\n\nThis doesn't deprecate method or route as there are a couple places you\ncan't see the request (unless we propagate it ourselves). Also, we have\na scenario in vert.x where the data holding the route isn't on the\nrequest.\n\nFixes #1086"}, "afterCommit": {"oid": "9c266997ab23cd88d5b93d611001161a139bce44", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/9c266997ab23cd88d5b93d611001161a139bce44", "committedDate": "2020-02-24T07:17:53Z", "message": "feedback + make compile"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c266997ab23cd88d5b93d611001161a139bce44", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/9c266997ab23cd88d5b93d611001161a139bce44", "committedDate": "2020-02-24T07:17:53Z", "message": "feedback + make compile"}, "afterCommit": {"oid": "40821d118043b77bd3ed366fdf6e5b9df8a0d11b", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/40821d118043b77bd3ed366fdf6e5b9df8a0d11b", "committedDate": "2020-02-24T11:05:53Z", "message": "response"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a202584c03a487b4d4af47ef98d6a8d3ad8414d4", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/a202584c03a487b4d4af47ef98d6a8d3ad8414d4", "committedDate": "2020-02-25T02:18:31Z", "message": "WIP: Adds HttpResponse.request()\n\nThis adds nullable `HttpResponse.request()` per discussion in #1086\n\nThis doesn't deprecate method or route as there are a couple places you\ncan't see the request (unless we propagate it ourselves). Also, we have\na scenario in vert.x where the data holding the route isn't on the\nrequest.\n\nFixes #1086"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2919e4d0acf09371cf4b80af1ef0ab0ff054065e", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/2919e4d0acf09371cf4b80af1ef0ab0ff054065e", "committedDate": "2020-02-25T02:18:31Z", "message": "feedback + make compile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afa820f3ce630cf302fa24ceb6d27f4502115ed5", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/afa820f3ce630cf302fa24ceb6d27f4502115ed5", "committedDate": "2020-02-25T02:18:31Z", "message": "response"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d98fc52b84f3a2a2fed4ba32d8329b5da90aac82", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/d98fc52b84f3a2a2fed4ba32d8329b5da90aac82", "committedDate": "2020-02-25T02:18:31Z", "message": "backport progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "841fdabb14bd6aba4a5f100b6cbec32fd75c1486", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/841fdabb14bd6aba4a5f100b6cbec32fd75c1486", "committedDate": "2020-02-25T02:18:31Z", "message": "finishing touches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f49c3ec1a229c285977368f64baeb0546899b4e", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/1f49c3ec1a229c285977368f64baeb0546899b4e", "committedDate": "2020-02-25T02:19:54Z", "message": "fuzz"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a561f61944ea6fae1de4c22120f1e8e144c1651", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/8a561f61944ea6fae1de4c22120f1e8e144c1651", "committedDate": "2020-02-24T13:08:52Z", "message": "finishing touches"}, "afterCommit": {"oid": "1f49c3ec1a229c285977368f64baeb0546899b4e", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/1f49c3ec1a229c285977368f64baeb0546899b4e", "committedDate": "2020-02-25T02:19:54Z", "message": "fuzz"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzODM1MDgz", "url": "https://github.com/openzipkin/brave/pull/1092#pullrequestreview-363835083", "createdAt": "2020-02-25T02:33:10Z", "commit": {"oid": "1f49c3ec1a229c285977368f64baeb0546899b4e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1848, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}