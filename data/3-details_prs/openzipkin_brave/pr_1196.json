{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NTY3MTY5", "number": 1196, "title": "Makes MutableSpan easier with tags() and annotations() method", "bodyText": "This makes MutableSpan easier, especially in tests, by adding methods\nfor tags and annotations similar to zipkin2.Span. Unlike\nzipkin2.Span, this presents annotations as a collection of Map.Entry.\nDoing so keeps us from having to define a new type mostly used in tests.\nThe allocation-free consumer functions are left in place.\nOne unit test was converted in the process. We can convert the rest of\nthem following this PR.\nUnder the scenes, this uses the same UnsafeArrayMap we use in baggage.\nTo port to this model, we had to use arrays directly instead of arraylist.\nHowever, we act internally the same as arraylist does.", "createdAt": "2020-05-09T12:14:35Z", "url": "https://github.com/openzipkin/brave/pull/1196", "merged": true, "mergeCommit": {"oid": "cabbf67a229b7cffe11e8d4824e8a5678ab544ac"}, "closed": true, "closedAt": "2020-05-10T01:01:30Z", "author": {"login": "codefromthecrypt"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcflXEQgH2gAyNDE1NTY3MTY5OjZhYWZmNzE4Yzg2MzA2ZjUxYTIxYTE5NGMwNzg1YWI1Mzc2MjYyYzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfv7-hgH2gAyNDE1NTY3MTY5OjFmNWYyYjYyZjU3OWFjNTJjZTM0NzM1YjQ4YjU1NDUxYThmM2I5MzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6aaff718c86306f51a21a194c0785ab5376262c5", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/6aaff718c86306f51a21a194c0785ab5376262c5", "committedDate": "2020-05-09T12:09:25Z", "message": "Makes MutableSpan easier with tags() and annotations() method\n\nThis makes `MutableSpan` easier, especially in tests, by adding methods\nfor tags and annotations similar to `zipkin2.Span`. Unlike\n`zipkin2.Span`, this presents annotations as a collection of `Map.Entry`.\n\nDoing so keeps us from having to define a new type mostly used in tests.\nThe allocation-free consumer functions are left in place. This replaces\nthe 'count' methods formerly there (in order to try to keep method count\ndown).\n\nOne unit test was converted in the process. We can convert the rest of\nthem following this PR.\n\nUnder the scenes, this uses the same `UnsafeArrayMap` we use in baggage.\nTo port to this model, we had to switch this to use copy-on-write arrays\ninstead of array list. This will actually allocate less except when a\ntag is overwritten as before overwriting didn't allocate an array.\nHowever, this also cheapens usage by a couple copies anyway so it should\nbe a wash or better for most folks."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjQ1MjA0", "url": "https://github.com/openzipkin/brave/pull/1196#pullrequestreview-408645204", "createdAt": "2020-05-09T12:15:24Z", "commit": {"oid": "6aaff718c86306f51a21a194c0785ab5376262c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxMjoxNToyNFrOGS6qJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxMjoxNToyNFrOGS6qJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4ODYxMw==", "bodyText": "I switched only one test to show decoupling from zipkin types", "url": "https://github.com/openzipkin/brave/pull/1196#discussion_r422488613", "createdAt": "2020-05-09T12:15:24Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/test/java/brave/features/handler/RedactingSpanHandlerTest.java", "diffHunk": "@@ -28,9 +28,8 @@\n import java.util.regex.Pattern;\n import org.junit.After;\n import org.junit.Test;\n-import zipkin2.Annotation;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6aaff718c86306f51a21a194c0785ab5376262c5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjQ1NDI4", "url": "https://github.com/openzipkin/brave/pull/1196#pullrequestreview-408645428", "createdAt": "2020-05-09T12:18:41Z", "commit": {"oid": "6aaff718c86306f51a21a194c0785ab5376262c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxMjoxODo0MVrOGS6rUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxMjoxODo0MVrOGS6rUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4ODkxNQ==", "bodyText": "in hindsight maybe it is worth putting these back.. they are allocation free ways to get the count..", "url": "https://github.com/openzipkin/brave/pull/1196#discussion_r422488915", "createdAt": "2020-05-09T12:18:41Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/test/java/brave/handler/MutableSpanTest.java", "diffHunk": "@@ -91,7 +89,7 @@\n     // When exporting into a list, a lambda would usually need to close over the list, which results\n     // in a new instance per invocation. Since there's a target type parameter, the lambda for this\n     // style of conversion can be constant, reducing overhead.\n-    List<Tag> listTarget = new ArrayList<>(span.tagCount());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6aaff718c86306f51a21a194c0785ab5376262c5"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62ad1ec7ffdf11fb2607ba43d3419d53e7a96fe3", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/62ad1ec7ffdf11fb2607ba43d3419d53e7a96fe3", "committedDate": "2020-05-09T12:31:04Z", "message": "puts count back and fixes test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjUyMzA3", "url": "https://github.com/openzipkin/brave/pull/1196#pullrequestreview-408652307", "createdAt": "2020-05-09T13:58:09Z", "commit": {"oid": "62ad1ec7ffdf11fb2607ba43d3419d53e7a96fe3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxMzo1ODowOVrOGS7S7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxMzo1ODowOVrOGS7S7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ5OTA1NA==", "bodyText": "Just to confirm it's ok for this to not be volatile. I guess an ArrayList would have already had issues when resizing though if there is a problem, but I'm not sure that memory is synced if users allowed to mutate without the lock.", "url": "https://github.com/openzipkin/brave/pull/1196#discussion_r422499054", "createdAt": "2020-05-09T13:58:09Z", "author": {"login": "anuraaga"}, "path": "brave/src/main/java/brave/handler/MutableSpan.java", "diffHunk": "@@ -81,9 +85,9 @@\n   int localPort, remotePort;\n \n   /** To reduce the amount of allocation use a pair-indexed list for tag (key, value). */\n-  ArrayList<String> tags;\n-  /** Also use pair indexing for annotations, but type object to store (startTimestamp, value). */\n-  ArrayList<Object> annotations;\n+  Object[] tags = EMPTY_ARRAY;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62ad1ec7ffdf11fb2607ba43d3419d53e7a96fe3"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8877e7bc4e42f57c0c2d1b706e244df4393109cc", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/8877e7bc4e42f57c0c2d1b706e244df4393109cc", "committedDate": "2020-05-09T15:19:42Z", "message": "clarify and fix copy constructor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjYwNDgz", "url": "https://github.com/openzipkin/brave/pull/1196#pullrequestreview-408660483", "createdAt": "2020-05-09T15:44:43Z", "commit": {"oid": "8877e7bc4e42f57c0c2d1b706e244df4393109cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxNTo0NDo0NFrOGS8AXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQxNTo0NDo0NFrOGS8AXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUxMDY4Ng==", "bodyText": "oops we don't need to do this.. all we need to do is shift and set null. Otherwise dropping all but one tag (like skeletal spans do) will thrash. will fix", "url": "https://github.com/openzipkin/brave/pull/1196#discussion_r422510686", "createdAt": "2020-05-09T15:44:44Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/main/java/brave/handler/MutableSpan.java", "diffHunk": "@@ -883,6 +928,32 @@ static void writeEndpoint(StringBuilder b,\n     b.append('}');\n   }\n \n+  static Object[] add(Object[] input, Object key, Object value) {\n+    int newIndex = input.length;\n+    Object[] result = Arrays.copyOf(input, input.length + 2); // copy-on-write\n+    result[newIndex] = key;\n+    result[newIndex + 1] = value;\n+    return result;\n+  }\n+\n+  // this is externally synchronized, so we can edit it directly\n+  static Object[] update(Object[] input, int i, Object value) {\n+    if (value.equals(input[i + 1])) return input;\n+    input[i + 1] = value;\n+    return input;\n+  }\n+\n+  static Object[] copy(Object[] input) {\n+    return input.length > 0 ? Arrays.copyOf(input, input.length) : EMPTY_ARRAY;\n+  }\n+\n+  static Object[] remove(Object[] input, int i) {\n+    if (input.length == 2 && i == 0) return EMPTY_ARRAY;\n+    Object[] result = Arrays.copyOf(input, input.length - 2);\n+    System.arraycopy(input, i + 2, result, i, input.length - i - 2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8877e7bc4e42f57c0c2d1b706e244df4393109cc"}, "originalPosition": 501}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10f7435cc3f2ebb137b182ef5731c7d952cbf33e", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/10f7435cc3f2ebb137b182ef5731c7d952cbf33e", "committedDate": "2020-05-09T16:08:25Z", "message": "don't thrash"}, "afterCommit": {"oid": "444121d003c15581a66f854a2b5635fc81ea0499", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/444121d003c15581a66f854a2b5635fc81ea0499", "committedDate": "2020-05-10T00:26:03Z", "message": "Fixes bugs in equals and hashCode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "444121d003c15581a66f854a2b5635fc81ea0499", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/444121d003c15581a66f854a2b5635fc81ea0499", "committedDate": "2020-05-10T00:26:03Z", "message": "Fixes bugs in equals and hashCode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f5f2b62f579ac52ce34735b48b55451a8f3b933", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/1f5f2b62f579ac52ce34735b48b55451a8f3b933", "committedDate": "2020-05-10T00:28:47Z", "message": "fuzz"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1730, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}