{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3ODg1ODk5", "number": 1213, "title": "Demonstrates how SpanHandler can now set root baggage", "bodyText": "This is something we couldn't do before without depending on HTTP. With\nSpanHandler, we can now set default baggage even based on root by heuristically\nlooking to see if the value was formerly set. (you can't depend on lack of\nparent ID as some formats remove this).\nhttps://gitter.im/spring-cloud/spring-cloud-sleuth?at=5ebaa80f7c04b92f535b5844", "createdAt": "2020-05-14T09:57:41Z", "url": "https://github.com/openzipkin/brave/pull/1213", "merged": true, "mergeCommit": {"oid": "f7151adcd7dcadc6e946b034026ec392ab302a1c"}, "closed": true, "closedAt": "2020-05-16T05:43:26Z", "author": {"login": "codefromthecrypt"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchKeUagH2gAyNDE3ODg1ODk5OjBjNWU3NjJkMmMzOWYwNmJhZDg5NjM4Y2EyMTY1NDM3YjcyNWM0ZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchKfLGgFqTQxMTY0OTg5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0c5e762d2c39f06bad89638ca2165437b725c4f2", "author": {"user": null}, "url": "https://github.com/openzipkin/brave/commit/0c5e762d2c39f06bad89638ca2165437b725c4f2", "committedDate": "2020-05-14T09:57:45Z", "message": "Demonstrates how SpanHandler can now set root tags\n\nThis is something we couldn't do before without depending on HTTP. With\nSpanHandler, we can now set default baggage even based on root by heuristically\nlooking to see if the value was formerly set. (you can't depend on lack of\nparent ID as some formats remove this).\n\nhttps://gitter.im/spring-cloud/spring-cloud-sleuth?at=5ebaa80f7c04b92f535b5844"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNjQ5ODk3", "url": "https://github.com/openzipkin/brave/pull/1213#pullrequestreview-411649897", "createdAt": "2020-05-14T09:58:41Z", "commit": {"oid": "0c5e762d2c39f06bad89638ca2165437b725c4f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTo1ODo0MVrOGVU_Gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTo1ODo0MVrOGVU_Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAxNzExNA==", "bodyText": "this is only to make the value change for the two traces :P", "url": "https://github.com/openzipkin/brave/pull/1213#discussion_r425017114", "createdAt": "2020-05-14T09:58:41Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/test/java/brave/features/propagation/SetOnceBaggageTest.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Copyright 2013-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package brave.features.propagation;\n+\n+import brave.Tags;\n+import brave.Tracer;\n+import brave.Tracing;\n+import brave.baggage.BaggageField;\n+import brave.baggage.BaggagePropagationConfig.SingleBaggageField;\n+import brave.handler.MutableSpan;\n+import brave.handler.SpanHandler;\n+import brave.internal.Nullable;\n+import brave.propagation.B3Propagation;\n+import brave.propagation.Propagation;\n+import brave.propagation.TraceContext;\n+import brave.test.TestSpanHandler;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import org.junit.After;\n+import org.junit.Test;\n+\n+import static brave.baggage.BaggagePropagation.newFactoryBuilder;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+/**\n+ * This shows how to compute a value for Baggage only once per trace, by checking its value existed\n+ * first. Notably, this is at the lowest abstraction: {@link SpanHandler} has no reliance on HTTP or\n+ * otherwise.\n+ */\n+public class SetOnceBaggageTest {\n+  static final BaggageField EPOCH_SECONDS = BaggageField.create(\"epoch_seconds\");\n+\n+  static final class RootOnlyBaggage extends SpanHandler {\n+    @Override\n+    public boolean begin(TraceContext context, MutableSpan span, @Nullable TraceContext parent) {\n+      if (EPOCH_SECONDS.getValue(context) == null) { // only set at the first span\n+        long epochSeconds = System.currentTimeMillis() / 1000;\n+        sleepSlightlyOverASecond();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c5e762d2c39f06bad89638ca2165437b725c4f2"}, "originalPosition": 49}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1752, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}