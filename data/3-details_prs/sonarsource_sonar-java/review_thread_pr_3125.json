{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMDM2MTIx", "number": 3125, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNDo1Mzo1MFrOEVcwhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNToyMjo0NlrOEVdjGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwOTI2NzI1OnYy", "diffSide": "RIGHT", "path": "java-frontend/src/main/java/org/sonar/java/se/checks/UnclosedResourcesCheck.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNDo1Mzo1MFrOG8NY8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNDo1Mzo1MFrOG8NY8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc4NzEyMw==", "bodyText": "What about going one step further and avoid creating it for every instance of PostStatementVisitor (having a static field of the check).", "url": "https://github.com/SonarSource/sonar-java/pull/3125#discussion_r465787123", "createdAt": "2020-08-05T14:53:50Z", "author": {"login": "quentin-jaquier-sonarsource"}, "path": "java-frontend/src/main/java/org/sonar/java/se/checks/UnclosedResourcesCheck.java", "diffHunk": "@@ -448,13 +467,15 @@ public void visitIdentifier(IdentifierTree tree) {\n \n   private class PostStatementVisitor extends CheckerTreeNodeVisitor {\n \n+    private final Pattern methodNamesOpeningResource = Pattern.compile(\"(new|create|open).*\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fa6afc04d6dc94149cc582e6a693c3707508ab2"}, "originalPosition": 202}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwOTM2NzExOnYy", "diffSide": "RIGHT", "path": "java-frontend/src/main/java/org/sonar/java/se/checks/UnclosedResourcesCheck.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNToxNjoxMVrOG8OYsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNToxNjoxMVrOG8OYsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwMzQ0Mw==", "bodyText": "It was not clear to me that the content of this set was used only to know if you already collected the resources from the try. Maybe renaming it as visitedTryWithResourcesTrees  or something like this would help?", "url": "https://github.com/SonarSource/sonar-java/pull/3125#discussion_r465803443", "createdAt": "2020-08-05T15:16:11Z", "author": {"login": "quentin-jaquier-sonarsource"}, "path": "java-frontend/src/main/java/org/sonar/java/se/checks/UnclosedResourcesCheck.java", "diffHunk": "@@ -87,6 +89,8 @@ public String valueAsString() {\n   public String excludedTypes = \"\";\n   private final List<String> excludedTypesList = new ArrayList<>();\n \n+  private final Set<TryStatementTree> tryWithResourcesTrees = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddfff71d51160e04b6313e82f9c4f51cd0e83214"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwOTM5NjczOnYy", "diffSide": "RIGHT", "path": "java-frontend/src/main/java/org/sonar/java/se/checks/UnclosedResourcesCheck.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNToyMjo0NlrOG8OrRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNzoyMjo0M1rOG8mcVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwODE5OQ==", "bodyText": "Question: I would typically use a BaseTreeVisitor to do something like this, is there any reasons you are using something else?", "url": "https://github.com/SonarSource/sonar-java/pull/3125#discussion_r465808199", "createdAt": "2020-08-05T15:22:46Z", "author": {"login": "quentin-jaquier-sonarsource"}, "path": "java-frontend/src/main/java/org/sonar/java/se/checks/UnclosedResourcesCheck.java", "diffHunk": "@@ -129,18 +135,60 @@ public String valueAsString() {\n     .addWithoutParametersMatcher()\n     .build();\n \n+  @Override\n+  public void scanFile(JavaFileScannerContext context) {\n+    this.tryWithResourcesTrees.clear();\n+    this.knownResources.clear();\n+    super.scanFile(context);\n+  }\n+\n   @Override\n   public void init(MethodTree methodTree, CFG cfg) {\n     this.visitedMethodOwnerType = methodTree.symbol().owner().type();\n   }\n \n   @Override\n   public ProgramState checkPreStatement(CheckerContext context, Tree syntaxNode) {\n+    collectTryWithResources(syntaxNode);\n     final PreStatementVisitor visitor = new PreStatementVisitor(context);\n     syntaxNode.accept(visitor);\n     return visitor.programState;\n   }\n \n+  private void collectTryWithResources(Tree syntaxNode) {\n+    if (syntaxNode.is(Tree.Kind.TRY_STATEMENT)) {\n+      TryStatementTree tryStatementTree = (TryStatementTree) syntaxNode;\n+      ListTree<Tree> resourceList = tryStatementTree.resourceList();\n+      if (!resourceList.isEmpty() && tryWithResourcesTrees.add(tryStatementTree)) {\n+        knownResources.addAll(collectAllResourceTrees(resourceList));\n+      }\n+    }\n+  }\n+\n+  private static Set<Tree> collectAllResourceTrees(Tree tree) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fa6afc04d6dc94149cc582e6a693c3707508ab2"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5NzU5MQ==", "bodyText": "I initially wanted to collect all possible trees, without exception, and with a BaseTreeVisitor I would have had to override all the methods to do so. On a second pass, I only collected identifiers, method invocations, and initializers, so the approach with a visitor is indeed easier to get.", "url": "https://github.com/SonarSource/sonar-java/pull/3125#discussion_r466197591", "createdAt": "2020-08-06T07:22:43Z", "author": {"login": "m-g-sonar"}, "path": "java-frontend/src/main/java/org/sonar/java/se/checks/UnclosedResourcesCheck.java", "diffHunk": "@@ -129,18 +135,60 @@ public String valueAsString() {\n     .addWithoutParametersMatcher()\n     .build();\n \n+  @Override\n+  public void scanFile(JavaFileScannerContext context) {\n+    this.tryWithResourcesTrees.clear();\n+    this.knownResources.clear();\n+    super.scanFile(context);\n+  }\n+\n   @Override\n   public void init(MethodTree methodTree, CFG cfg) {\n     this.visitedMethodOwnerType = methodTree.symbol().owner().type();\n   }\n \n   @Override\n   public ProgramState checkPreStatement(CheckerContext context, Tree syntaxNode) {\n+    collectTryWithResources(syntaxNode);\n     final PreStatementVisitor visitor = new PreStatementVisitor(context);\n     syntaxNode.accept(visitor);\n     return visitor.programState;\n   }\n \n+  private void collectTryWithResources(Tree syntaxNode) {\n+    if (syntaxNode.is(Tree.Kind.TRY_STATEMENT)) {\n+      TryStatementTree tryStatementTree = (TryStatementTree) syntaxNode;\n+      ListTree<Tree> resourceList = tryStatementTree.resourceList();\n+      if (!resourceList.isEmpty() && tryWithResourcesTrees.add(tryStatementTree)) {\n+        knownResources.addAll(collectAllResourceTrees(resourceList));\n+      }\n+    }\n+  }\n+\n+  private static Set<Tree> collectAllResourceTrees(Tree tree) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwODE5OQ=="}, "originalCommit": {"oid": "2fa6afc04d6dc94149cc582e6a693c3707508ab2"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3971, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}