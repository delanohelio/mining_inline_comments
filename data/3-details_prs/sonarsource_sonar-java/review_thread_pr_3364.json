{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0MTQwOTg0", "number": 3364, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwOTowMjo0OFrOFIf0Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwOToyMToyMlrOFIgaaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NDU0MTc4OnYy", "diffSide": "RIGHT", "path": "java-checks/src/main/java/org/sonar/java/checks/UselessPackageInfoCheck.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwOTowMjo0OFrOIKc8yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxMDowMzo1MFrOIKfygg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzgzMDk4NA==", "bodyText": "The behavior of scanFile seems to be that it adds a package to one or the other but not both. Is the explicit removal of valid packages from the the set of unneeded packages necessary?", "url": "https://github.com/SonarSource/sonar-java/pull/3364#discussion_r547830984", "createdAt": "2020-12-23T09:02:48Z", "author": {"login": "dorian-burihabwa-sonarsource"}, "path": "java-checks/src/main/java/org/sonar/java/checks/UselessPackageInfoCheck.java", "diffHunk": "@@ -20,23 +20,57 @@\n package org.sonar.java.checks;\n \n import java.io.File;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n import org.sonar.check.Rule;\n+import org.sonar.java.EndOfAnalysisCheck;\n+import org.sonar.java.checks.helpers.ExpressionsHelper;\n import org.sonar.plugins.java.api.JavaFileScanner;\n import org.sonar.plugins.java.api.JavaFileScannerContext;\n+import org.sonar.plugins.java.api.tree.PackageDeclarationTree;\n \n @Rule(key = \"S4032\")\n-public class UselessPackageInfoCheck implements JavaFileScanner {\n+public class UselessPackageInfoCheck implements JavaFileScanner, EndOfAnalysisCheck {\n+\n+  private final Map<String, JavaFileScannerContext> unneededPackageInfoFiles = new HashMap<>();\n+  private final Set<String> knownPackagesWithOtherFiles = new HashSet<>();\n \n   @Override\n   public void scanFile(JavaFileScannerContext context) {\n-    File file = context.getInputFile().file();\n-    if (\"package-info.java\".equals(file.getName()) && isOnlyFileFromPackage(file)) {\n-      context.addIssueOnFile(this, \"Remove this package.\");\n+    PackageDeclarationTree packageDeclaration = context.getTree().packageDeclaration();\n+    String packageName = packageDeclaration == null ? null : ExpressionsHelper.concatenate(packageDeclaration.packageName());\n+\n+    // default package or already processed package\n+    if (packageName == null || knownPackagesWithOtherFiles.contains(packageName)) {\n+      return;\n+    }\n+\n+    File packageDirectory = context.getInputFile().file().getParentFile();\n+    File packageInfoFile = new File(packageDirectory, \"package-info.java\");\n+    boolean hasOtherFiles = !isOnlyFileFromPackage(packageDirectory, packageInfoFile);\n+\n+    if (hasOtherFiles) {\n+      knownPackagesWithOtherFiles.add(packageName);\n+    } else if (packageInfoFile.isFile()) {\n+      unneededPackageInfoFiles.put(packageName, context);\n+    }\n+  }\n+\n+  @Override\n+  public void endOfAnalysis() {\n+    unneededPackageInfoFiles.keySet().removeAll(knownPackagesWithOtherFiles);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dee94e241c351f192f13a266c014b19cd97a1076"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzg3NzUwNg==", "bodyText": "Yes, it is needed to avoid FP in case the analysis scan the same package multiple times (from different source folder). In such a case, the package may be present in both collections, but we do not want to raise an issue.", "url": "https://github.com/SonarSource/sonar-java/pull/3364#discussion_r547877506", "createdAt": "2020-12-23T10:03:50Z", "author": {"login": "christophe-zurn-sonarsource"}, "path": "java-checks/src/main/java/org/sonar/java/checks/UselessPackageInfoCheck.java", "diffHunk": "@@ -20,23 +20,57 @@\n package org.sonar.java.checks;\n \n import java.io.File;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n import org.sonar.check.Rule;\n+import org.sonar.java.EndOfAnalysisCheck;\n+import org.sonar.java.checks.helpers.ExpressionsHelper;\n import org.sonar.plugins.java.api.JavaFileScanner;\n import org.sonar.plugins.java.api.JavaFileScannerContext;\n+import org.sonar.plugins.java.api.tree.PackageDeclarationTree;\n \n @Rule(key = \"S4032\")\n-public class UselessPackageInfoCheck implements JavaFileScanner {\n+public class UselessPackageInfoCheck implements JavaFileScanner, EndOfAnalysisCheck {\n+\n+  private final Map<String, JavaFileScannerContext> unneededPackageInfoFiles = new HashMap<>();\n+  private final Set<String> knownPackagesWithOtherFiles = new HashSet<>();\n \n   @Override\n   public void scanFile(JavaFileScannerContext context) {\n-    File file = context.getInputFile().file();\n-    if (\"package-info.java\".equals(file.getName()) && isOnlyFileFromPackage(file)) {\n-      context.addIssueOnFile(this, \"Remove this package.\");\n+    PackageDeclarationTree packageDeclaration = context.getTree().packageDeclaration();\n+    String packageName = packageDeclaration == null ? null : ExpressionsHelper.concatenate(packageDeclaration.packageName());\n+\n+    // default package or already processed package\n+    if (packageName == null || knownPackagesWithOtherFiles.contains(packageName)) {\n+      return;\n+    }\n+\n+    File packageDirectory = context.getInputFile().file().getParentFile();\n+    File packageInfoFile = new File(packageDirectory, \"package-info.java\");\n+    boolean hasOtherFiles = !isOnlyFileFromPackage(packageDirectory, packageInfoFile);\n+\n+    if (hasOtherFiles) {\n+      knownPackagesWithOtherFiles.add(packageName);\n+    } else if (packageInfoFile.isFile()) {\n+      unneededPackageInfoFiles.put(packageName, context);\n+    }\n+  }\n+\n+  @Override\n+  public void endOfAnalysis() {\n+    unneededPackageInfoFiles.keySet().removeAll(knownPackagesWithOtherFiles);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzgzMDk4NA=="}, "originalCommit": {"oid": "dee94e241c351f192f13a266c014b19cd97a1076"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NDYzOTc2OnYy", "diffSide": "RIGHT", "path": "java-checks/src/test/java/org/sonar/java/checks/UselessPackageInfoCheckTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwOToyMToyMlrOIKd8kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwOToyMToyMlrOIKd8kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzg0NzMxMw==", "bodyText": "To avoid  the silent corruption of one of the test files,  we should probably repeat the test with a call to singular onFile.", "url": "https://github.com/SonarSource/sonar-java/pull/3364#discussion_r547847313", "createdAt": "2020-12-23T09:21:22Z", "author": {"login": "dorian-burihabwa-sonarsource"}, "path": "java-checks/src/test/java/org/sonar/java/checks/UselessPackageInfoCheckTest.java", "diffHunk": "@@ -45,7 +45,17 @@ void withOtherFile() {\n   @Test\n   void notAPackageInfo() {\n     JavaCheckVerifier.newVerifier()\n-      .onFile(testSourcesPath(\"checks/UselessPackageInfoCheck/packageWithNoOtherFilesButNotPackageInfo/HelloWorld.java\"))\n+      .onFiles(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dee94e241c351f192f13a266c014b19cd97a1076"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3750, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}