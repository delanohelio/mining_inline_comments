{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0MjM1MDc0", "number": 2948, "title": "SONARJAVA-3346 Deprecate S1148 in favor of S4507", "bodyText": "", "createdAt": "2020-05-06T17:33:25Z", "url": "https://github.com/SonarSource/sonar-java/pull/2948", "merged": true, "mergeCommit": {"oid": "21861e73e42f3c1d61377c3becb9494ea80d2168"}, "closed": true, "closedAt": "2020-05-07T11:20:02Z", "author": {"login": "sebastian-hungerecker-sonarsource"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcetBBJgBqjMzMDk3NTk3MTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABce6jdTABqjMzMTIyMDc3MDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff29ecd7ce00490db0c17d0c9a684223c9fafb16", "author": {"user": {"login": "sebastian-hungerecker-sonarsource", "name": "Sebastian Hungerecker"}}, "url": "https://github.com/SonarSource/sonar-java/commit/ff29ecd7ce00490db0c17d0c9a684223c9fafb16", "committedDate": "2020-05-06T17:28:42Z", "message": "SONARJAVA-3346 Deprecate S1148 in favor of S4507"}, "afterCommit": {"oid": "837b76177ce7d09f217cd07e3bdb6307cfaed247", "author": {"user": {"login": "sebastian-hungerecker-sonarsource", "name": "Sebastian Hungerecker"}}, "url": "https://github.com/SonarSource/sonar-java/commit/837b76177ce7d09f217cd07e3bdb6307cfaed247", "committedDate": "2020-05-06T18:30:26Z", "message": "SONARJAVA-3346 Deprecate S1148 in favor of S4507"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MjU1NDIw", "url": "https://github.com/SonarSource/sonar-java/pull/2948#pullrequestreview-407255420", "createdAt": "2020-05-07T08:28:08Z", "commit": {"oid": "837b76177ce7d09f217cd07e3bdb6307cfaed247"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwODoyODowOVrOGRz6iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwODozMzozMlrOGR0HhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMyOTU0NQ==", "bodyText": "\ud83d\ude31 the previous implementation of the rule was complex and not using the MethodMatchers API.\nwe should use a matcher like:\n  private static final MethodMatchers PRINT_STACK_TRACE_MATCHER = MethodMatchers.create()\n    .ofSubTypes(\"java.lang.Throwable\").names(\"printStackTrace\").addWithoutParametersMatcher().build();\n\nthem checkMethodInvocation will become far more easier to read:\n  private void checkMethodInvocation(MethodInvocationTree tree) {\n    if (PRINT_STACK_TRACE_MATCHER.matches(tree)) {\n      reportIssue(ExpressionUtils.methodName(tree), MESSAGE);\n    }\n  }", "url": "https://github.com/SonarSource/sonar-java/pull/2948#discussion_r421329545", "createdAt": "2020-05-07T08:28:09Z", "author": {"login": "alban-auzeill"}, "path": "java-checks/src/main/java/org/sonar/java/checks/security/DebugFeatureEnabledCheck.java", "diffHunk": "@@ -19,32 +19,74 @@\n  */\n package org.sonar.java.checks.security;\n \n-import java.util.Collections;\n+import java.util.Arrays;\n+import java.util.Deque;\n+import java.util.LinkedList;\n import java.util.List;\n import java.util.Objects;\n import javax.annotation.CheckForNull;\n import org.sonar.check.Rule;\n import org.sonar.java.checks.helpers.ExpressionsHelper;\n import org.sonar.plugins.java.api.IssuableSubscriptionVisitor;\n+import org.sonar.plugins.java.api.semantic.Symbol;\n import org.sonar.plugins.java.api.tree.AnnotationTree;\n import org.sonar.plugins.java.api.tree.AssignmentExpressionTree;\n+import org.sonar.plugins.java.api.tree.ClassTree;\n import org.sonar.plugins.java.api.tree.ExpressionTree;\n import org.sonar.plugins.java.api.tree.IdentifierTree;\n+import org.sonar.plugins.java.api.tree.MemberSelectExpressionTree;\n+import org.sonar.plugins.java.api.tree.MethodInvocationTree;\n import org.sonar.plugins.java.api.tree.Tree;\n \n @Rule(key = \"S4507\")\n public class DebugFeatureEnabledCheck extends IssuableSubscriptionVisitor {\n \n   private static final String MESSAGE = \"Make sure this debug feature is deactivated before delivering the code in production.\";\n \n+  private final Deque<Symbol.TypeSymbol> enclosingClass = new LinkedList<>();\n+\n   @Override\n   public List<Tree.Kind> nodesToVisit() {\n-    return Collections.singletonList(Tree.Kind.ANNOTATION);\n+    return Arrays.asList(Tree.Kind.ANNOTATION, Tree.Kind.CLASS, Tree.Kind.METHOD_INVOCATION);\n   }\n \n   @Override\n   public void visitNode(Tree tree) {\n-    AnnotationTree annotation = (AnnotationTree) tree;\n+    switch (tree.kind()) {\n+      case ANNOTATION:\n+        checkAnnotation((AnnotationTree) tree);\n+        break;\n+      case METHOD_INVOCATION:\n+        checkMethodInvocation((MethodInvocationTree) tree);\n+        break;\n+      default:\n+        ClassTree classTree = (ClassTree) tree;\n+        enclosingClass.push(classTree.symbol());\n+        break;\n+    }\n+  }\n+\n+  @Override\n+  public void leaveNode(Tree tree) {\n+    if (tree instanceof ClassTree) {\n+      enclosingClass.pop();\n+    }\n+  }\n+\n+  private void checkMethodInvocation(MethodInvocationTree tree) {\n+    if (tree.methodSelect().is(Tree.Kind.MEMBER_SELECT)) {\n+      MemberSelectExpressionTree memberSelectExpressionTree = (MemberSelectExpressionTree) tree.methodSelect();\n+      IdentifierTree identifierTree = memberSelectExpressionTree.identifier();\n+      if (!enclosingClassExtendsThrowable()\n+        && \"printStackTrace\".equals(identifierTree.name())\n+        && calledOnTypeInheritedFromThrowable(memberSelectExpressionTree.expression())\n+        && tree.arguments().isEmpty()) {\n+        reportIssue(identifierTree, MESSAGE);\n+      }\n+    }\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "837b76177ce7d09f217cd07e3bdb6307cfaed247"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMzMjg2OQ==", "bodyText": "With a MethodMatcher:\n\nthe above two methods can be removed\nenclosingClass field can be removed\nnodesToVisit() on  Tree.Kind.CLASS can be removed\nleaveNode() can be removed\n\n\ud83d\ude0e", "url": "https://github.com/SonarSource/sonar-java/pull/2948#discussion_r421332869", "createdAt": "2020-05-07T08:33:32Z", "author": {"login": "alban-auzeill"}, "path": "java-checks/src/main/java/org/sonar/java/checks/security/DebugFeatureEnabledCheck.java", "diffHunk": "@@ -67,4 +109,12 @@ private static AssignmentExpressionTree getDebugArgument(ExpressionTree expressi\n     return null;\n   }\n \n+  private boolean enclosingClassExtendsThrowable() {\n+    return enclosingClass.peek() != null && enclosingClass.peek().type().isSubtypeOf(\"java.lang.Throwable\");\n+  }\n+\n+  private static boolean calledOnTypeInheritedFromThrowable(ExpressionTree tree) {\n+    return tree.symbolType().isSubtypeOf(\"java.lang.Throwable\");\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "837b76177ce7d09f217cd07e3bdb6307cfaed247"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daf4f536d281b4726bb7a422468cc9657327df23", "author": {"user": {"login": "sebastian-hungerecker-sonarsource", "name": "Sebastian Hungerecker"}}, "url": "https://github.com/SonarSource/sonar-java/commit/daf4f536d281b4726bb7a422468cc9657327df23", "committedDate": "2020-05-07T10:16:39Z", "message": "SONARJAVA-3346 Deprecate S1148 in favor of S4507"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f54f3223c239a1ca03b9517383150f3ebc62e826", "author": {"user": {"login": "sebastian-hungerecker-sonarsource", "name": "Sebastian Hungerecker"}}, "url": "https://github.com/SonarSource/sonar-java/commit/f54f3223c239a1ca03b9517383150f3ebc62e826", "committedDate": "2020-05-07T10:16:39Z", "message": "Simplify code by using MethodMatchers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "837b76177ce7d09f217cd07e3bdb6307cfaed247", "author": {"user": {"login": "sebastian-hungerecker-sonarsource", "name": "Sebastian Hungerecker"}}, "url": "https://github.com/SonarSource/sonar-java/commit/837b76177ce7d09f217cd07e3bdb6307cfaed247", "committedDate": "2020-05-06T18:30:26Z", "message": "SONARJAVA-3346 Deprecate S1148 in favor of S4507"}, "afterCommit": {"oid": "f54f3223c239a1ca03b9517383150f3ebc62e826", "author": {"user": {"login": "sebastian-hungerecker-sonarsource", "name": "Sebastian Hungerecker"}}, "url": "https://github.com/SonarSource/sonar-java/commit/f54f3223c239a1ca03b9517383150f3ebc62e826", "committedDate": "2020-05-07T10:16:39Z", "message": "Simplify code by using MethodMatchers"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1685, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}