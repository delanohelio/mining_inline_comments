{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMDM2MTIx", "number": 3125, "title": "SONARJAVA-3494: Improve performance of S2095", "bodyText": "", "createdAt": "2020-08-03T08:40:20Z", "url": "https://github.com/SonarSource/sonar-java/pull/3125", "merged": true, "mergeCommit": {"oid": "209bbaa71ae8e732527dc036cbce5ed6a9159bf0"}, "closed": true, "closedAt": "2020-08-06T08:29:40Z", "author": {"login": "m-g-sonar"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc756YLAH2gAyNDYyMDM2MTIxOmY0ZThhOGY5Zjk2YmUxZjhiMDdlODk0YjA5ZDAwOTEzOTI2ZDI5OTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8KuyzAH2gAyNDYyMDM2MTIxOmJlY2QwZDRiMjZhMTg2MzQ4MDAwZjFiZDRjZWNmMTk4MTRkNmEwYTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f4e8a8f9f96be1f8b07e894b09d00913926d2999", "author": {"user": {"login": "m-g-sonar", "name": "Michael Gumowski"}}, "url": "https://github.com/SonarSource/sonar-java/commit/f4e8a8f9f96be1f8b07e894b09d00913926d2999", "committedDate": "2020-08-05T11:55:58Z", "message": "Do not recompute pattern all the time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd86413cc5bf8b910ea706ed24c3aeed1ffdebee", "author": {"user": {"login": "m-g-sonar", "name": "Michael Gumowski"}}, "url": "https://github.com/SonarSource/sonar-java/commit/cd86413cc5bf8b910ea706ed24c3aeed1ffdebee", "committedDate": "2020-08-05T11:55:58Z", "message": "Avoid checking for parents to get the enclosing type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90bb5c16f80c13a076bbd14a314c275bf653d714", "author": {"user": {"login": "m-g-sonar", "name": "Michael Gumowski"}}, "url": "https://github.com/SonarSource/sonar-java/commit/90bb5c16f80c13a076bbd14a314c275bf653d714", "committedDate": "2020-08-05T11:55:58Z", "message": "Use stream instead of loop to simplify logic"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d232a6f45ca380fdcec74e26ee3c8ca40ff74a6", "author": {"user": {"login": "m-g-sonar", "name": "Michael Gumowski"}}, "url": "https://github.com/SonarSource/sonar-java/commit/8d232a6f45ca380fdcec74e26ee3c8ca40ff74a6", "committedDate": "2020-08-03T08:33:51Z", "message": "Avoid checking for parents to get the enclosing type"}, "afterCommit": {"oid": "67ada734b4d09b096f1f2ba306813ba67f0c438f", "author": {"user": {"login": "m-g-sonar", "name": "Michael Gumowski"}}, "url": "https://github.com/SonarSource/sonar-java/commit/67ada734b4d09b096f1f2ba306813ba67f0c438f", "committedDate": "2020-08-05T11:55:58Z", "message": "Get rid of call to parent() when checking if resouces are within a try-with-resource header"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67ada734b4d09b096f1f2ba306813ba67f0c438f", "author": {"user": {"login": "m-g-sonar", "name": "Michael Gumowski"}}, "url": "https://github.com/SonarSource/sonar-java/commit/67ada734b4d09b096f1f2ba306813ba67f0c438f", "committedDate": "2020-08-05T11:55:58Z", "message": "Get rid of call to parent() when checking if resouces are within a try-with-resource header"}, "afterCommit": {"oid": "a310d06cd8469220803848f27b4c41cc6e889eb8", "author": {"user": {"login": "m-g-sonar", "name": "Michael Gumowski"}}, "url": "https://github.com/SonarSource/sonar-java/commit/a310d06cd8469220803848f27b4c41cc6e889eb8", "committedDate": "2020-08-05T12:02:15Z", "message": "Get rid of call to parent() when checking if resouces are within a try-with-resource header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddfff71d51160e04b6313e82f9c4f51cd0e83214", "author": {"user": {"login": "m-g-sonar", "name": "Michael Gumowski"}}, "url": "https://github.com/SonarSource/sonar-java/commit/ddfff71d51160e04b6313e82f9c4f51cd0e83214", "committedDate": "2020-08-05T12:30:59Z", "message": "Get rid of call to parent() when checking if resouces are within a try-with-resource header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fa6afc04d6dc94149cc582e6a693c3707508ab2", "author": {"user": {"login": "m-g-sonar", "name": "Michael Gumowski"}}, "url": "https://github.com/SonarSource/sonar-java/commit/2fa6afc04d6dc94149cc582e6a693c3707508ab2", "committedDate": "2020-08-05T12:45:33Z", "message": "Fix nullness issues"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a310d06cd8469220803848f27b4c41cc6e889eb8", "author": {"user": {"login": "m-g-sonar", "name": "Michael Gumowski"}}, "url": "https://github.com/SonarSource/sonar-java/commit/a310d06cd8469220803848f27b4c41cc6e889eb8", "committedDate": "2020-08-05T12:02:15Z", "message": "Get rid of call to parent() when checking if resouces are within a try-with-resource header"}, "afterCommit": {"oid": "2fa6afc04d6dc94149cc582e6a693c3707508ab2", "author": {"user": {"login": "m-g-sonar", "name": "Michael Gumowski"}}, "url": "https://github.com/SonarSource/sonar-java/commit/2fa6afc04d6dc94149cc582e6a693c3707508ab2", "committedDate": "2020-08-05T12:45:33Z", "message": "Fix nullness issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNzQ0NDgw", "url": "https://github.com/SonarSource/sonar-java/pull/3125#pullrequestreview-461744480", "createdAt": "2020-08-05T14:53:50Z", "commit": {"oid": "2fa6afc04d6dc94149cc582e6a693c3707508ab2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNDo1Mzo1MFrOG8NY8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNToyMjo0NlrOG8OrRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc4NzEyMw==", "bodyText": "What about going one step further and avoid creating it for every instance of PostStatementVisitor (having a static field of the check).", "url": "https://github.com/SonarSource/sonar-java/pull/3125#discussion_r465787123", "createdAt": "2020-08-05T14:53:50Z", "author": {"login": "quentin-jaquier-sonarsource"}, "path": "java-frontend/src/main/java/org/sonar/java/se/checks/UnclosedResourcesCheck.java", "diffHunk": "@@ -448,13 +467,15 @@ public void visitIdentifier(IdentifierTree tree) {\n \n   private class PostStatementVisitor extends CheckerTreeNodeVisitor {\n \n+    private final Pattern methodNamesOpeningResource = Pattern.compile(\"(new|create|open).*\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fa6afc04d6dc94149cc582e6a693c3707508ab2"}, "originalPosition": 202}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwMzQ0Mw==", "bodyText": "It was not clear to me that the content of this set was used only to know if you already collected the resources from the try. Maybe renaming it as visitedTryWithResourcesTrees  or something like this would help?", "url": "https://github.com/SonarSource/sonar-java/pull/3125#discussion_r465803443", "createdAt": "2020-08-05T15:16:11Z", "author": {"login": "quentin-jaquier-sonarsource"}, "path": "java-frontend/src/main/java/org/sonar/java/se/checks/UnclosedResourcesCheck.java", "diffHunk": "@@ -87,6 +89,8 @@ public String valueAsString() {\n   public String excludedTypes = \"\";\n   private final List<String> excludedTypesList = new ArrayList<>();\n \n+  private final Set<TryStatementTree> tryWithResourcesTrees = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddfff71d51160e04b6313e82f9c4f51cd0e83214"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwODE5OQ==", "bodyText": "Question: I would typically use a BaseTreeVisitor to do something like this, is there any reasons you are using something else?", "url": "https://github.com/SonarSource/sonar-java/pull/3125#discussion_r465808199", "createdAt": "2020-08-05T15:22:46Z", "author": {"login": "quentin-jaquier-sonarsource"}, "path": "java-frontend/src/main/java/org/sonar/java/se/checks/UnclosedResourcesCheck.java", "diffHunk": "@@ -129,18 +135,60 @@ public String valueAsString() {\n     .addWithoutParametersMatcher()\n     .build();\n \n+  @Override\n+  public void scanFile(JavaFileScannerContext context) {\n+    this.tryWithResourcesTrees.clear();\n+    this.knownResources.clear();\n+    super.scanFile(context);\n+  }\n+\n   @Override\n   public void init(MethodTree methodTree, CFG cfg) {\n     this.visitedMethodOwnerType = methodTree.symbol().owner().type();\n   }\n \n   @Override\n   public ProgramState checkPreStatement(CheckerContext context, Tree syntaxNode) {\n+    collectTryWithResources(syntaxNode);\n     final PreStatementVisitor visitor = new PreStatementVisitor(context);\n     syntaxNode.accept(visitor);\n     return visitor.programState;\n   }\n \n+  private void collectTryWithResources(Tree syntaxNode) {\n+    if (syntaxNode.is(Tree.Kind.TRY_STATEMENT)) {\n+      TryStatementTree tryStatementTree = (TryStatementTree) syntaxNode;\n+      ListTree<Tree> resourceList = tryStatementTree.resourceList();\n+      if (!resourceList.isEmpty() && tryWithResourcesTrees.add(tryStatementTree)) {\n+        knownResources.addAll(collectAllResourceTrees(resourceList));\n+      }\n+    }\n+  }\n+\n+  private static Set<Tree> collectAllResourceTrees(Tree tree) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fa6afc04d6dc94149cc582e6a693c3707508ab2"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "becd0d4b26a186348000f1bd4cecf19814d6a0a8", "author": {"user": {"login": "m-g-sonar", "name": "Michael Gumowski"}}, "url": "https://github.com/SonarSource/sonar-java/commit/becd0d4b26a186348000f1bd4cecf19814d6a0a8", "committedDate": "2020-08-06T07:31:42Z", "message": "Fix from review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1671, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}