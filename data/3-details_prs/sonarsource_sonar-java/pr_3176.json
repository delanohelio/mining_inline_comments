{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2NTYzNDY1", "number": 3176, "title": "SONARJAVA-3513 Improve S5810 to support static and test methods with return values", "bodyText": "", "createdAt": "2020-09-14T12:13:08Z", "url": "https://github.com/SonarSource/sonar-java/pull/3176", "merged": true, "mergeCommit": {"oid": "e7f38f7ea8cdc7777ca7a56c0ddc1513d3dcdd2d"}, "closed": true, "closedAt": "2020-09-16T06:57:03Z", "author": {"login": "alban-auzeill"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdI1uJQAFqTQ4NzkxMjg0OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJWzDrAFqTQ4OTMyNTU2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3OTEyODQ5", "url": "https://github.com/SonarSource/sonar-java/pull/3176#pullrequestreview-487912849", "createdAt": "2020-09-14T15:50:15Z", "commit": {"oid": "7bae5061155923a469545c46d1bafccf36fbc3dc"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNTo1MDoxNVrOHRbmmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNjoyMjo1N1rOHRc8Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA0MDA4OA==", "bodyText": "In addition to removing hasSemantic() check, you can also remove this test.", "url": "https://github.com/SonarSource/sonar-java/pull/3176#discussion_r488040088", "createdAt": "2020-09-14T15:50:15Z", "author": {"login": "quentin-jaquier-sonarsource"}, "path": "java-checks/src/test/java/org/sonar/java/checks/tests/JUnit5DefaultPackageClassAndMethodCheckTest.java", "diffHunk": "@@ -34,7 +34,10 @@ void test() {\n       .onFile(testSourcePath)\n       .withCheck(new JUnit5DefaultPackageClassAndMethodCheck())\n       .verifyIssues();\n+  }\n \n+  @Test\n+  void test_without_semantic() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bae5061155923a469545c46d1bafccf36fbc3dc"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA0MDI3Mw==", "bodyText": "Same here, you can remove it.", "url": "https://github.com/SonarSource/sonar-java/pull/3176#discussion_r488040273", "createdAt": "2020-09-14T15:50:34Z", "author": {"login": "quentin-jaquier-sonarsource"}, "path": "java-checks/src/test/java/org/sonar/java/checks/tests/JUnit5SilentlyIgnoreClassAndMethodCheckTest.java", "diffHunk": "@@ -22,24 +22,36 @@\n import org.junit.jupiter.api.Test;\n import org.sonar.java.checks.verifier.JavaCheckVerifier;\n \n+import static org.sonar.java.CheckTestUtils.nonCompilingTestSourcesPath;\n import static org.sonar.java.CheckTestUtils.testSourcesPath;\n \n-class JUnit5PrivateClassAndMethodCheckTest {\n+class JUnit5SilentlyIgnoreClassAndMethodCheckTest {\n \n-  private static final String testSourcePath = testSourcesPath(\"checks/JUnit5PrivateClassAndMethodCheck.java\");\n+  private static final String SOURCE_PATH = \"checks/JUnit5SilentlyIgnoreClassAndMethodCheck.java\";\n \n   @Test\n   void test() {\n     JavaCheckVerifier.newVerifier()\n-      .onFile(testSourcePath)\n-      .withCheck(new JUnit5PrivateClassAndMethodCheck())\n+      .onFile(testSourcesPath(SOURCE_PATH))\n+      .withCheck(new JUnit5SilentlyIgnoreClassAndMethodCheck())\n       .verifyIssues();\n+  }\n \n+  @Test\n+  void test_without_semantic() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bae5061155923a469545c46d1bafccf36fbc3dc"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA2MjAxOA==", "bodyText": "I understand that you wanted to follow the same pattern as raiseIssueOnNotCompliantModifiers, but this code can report an issue only in one of the children, does it make sense to keep it in the common part?", "url": "https://github.com/SonarSource/sonar-java/pull/3176#discussion_r488062018", "createdAt": "2020-09-14T16:22:57Z", "author": {"login": "quentin-jaquier-sonarsource"}, "path": "java-checks/src/main/java/org/sonar/java/checks/tests/AbstractJUnit5NotCompliantModifierChecker.java", "diffHunk": "@@ -24,45 +24,56 @@\n import java.util.stream.Collectors;\n import org.sonar.java.checks.helpers.UnitTestUtils;\n import org.sonar.plugins.java.api.IssuableSubscriptionVisitor;\n+import org.sonar.plugins.java.api.semantic.Symbol.MethodSymbol;\n import org.sonar.plugins.java.api.tree.ClassTree;\n import org.sonar.plugins.java.api.tree.MethodTree;\n import org.sonar.plugins.java.api.tree.Modifier;\n import org.sonar.plugins.java.api.tree.ModifiersTree;\n import org.sonar.plugins.java.api.tree.Tree;\n+import org.sonar.plugins.java.api.tree.TypeTree;\n \n public abstract class AbstractJUnit5NotCompliantModifierChecker extends IssuableSubscriptionVisitor {\n \n-  protected abstract boolean isNotCompliant(Modifier modifier);\n+  protected abstract boolean isNotCompliantModifier(Modifier modifier, boolean isMethod);\n+\n+  protected abstract boolean isNotCompliantReturnType(TypeTree returnType, MethodSymbol symbol);\n \n   public List<Tree.Kind> nodesToVisit() {\n     return Collections.singletonList(Tree.Kind.CLASS);\n   }\n \n   @Override\n   public void visitNode(Tree tree) {\n-    if (!hasSemantic()) {\n-      return;\n-    }\n-\n     ClassTree classTree = (ClassTree) tree;\n     List<MethodTree> testMethods = classTree.members().stream()\n       .filter(member -> member.is(Tree.Kind.METHOD))\n       .map(MethodTree.class::cast)\n       .filter(UnitTestUtils::hasJUnit5TestAnnotation)\n       .collect(Collectors.toList());\n \n-    testMethods.stream().map(MethodTree::modifiers).forEach(this::raiseIssueOnNotCompliantModifiers);\n+    for (MethodTree testMethod : testMethods) {\n+      raiseIssueOnNotCompliantModifiers(testMethod.modifiers(), true);\n+      raiseIssueOnNotCompliantReturnType(testMethod);\n+    }\n \n     if (!testMethods.isEmpty()) {\n-      raiseIssueOnNotCompliantModifiers(classTree.modifiers());\n+      raiseIssueOnNotCompliantModifiers(classTree.modifiers(), false);\n     }\n   }\n \n-  private void raiseIssueOnNotCompliantModifiers(ModifiersTree modifierTree) {\n+  private void raiseIssueOnNotCompliantModifiers(ModifiersTree modifierTree, boolean isMethod) {\n     modifierTree.modifiers().stream()\n-      .filter(modifier -> isNotCompliant(modifier.modifier()))\n+      .filter(modifier -> isNotCompliantModifier(modifier.modifier(), isMethod))\n       .findFirst()\n       .ifPresent(modifier -> reportIssue(modifier, \"Remove this '\" + modifier.keyword().text() + \"' modifier.\"));\n   }\n \n+  private void raiseIssueOnNotCompliantReturnType(MethodTree methodTree) {\n+    // Return type of METHOD is never null (unlike CONSTRUCTOR)\n+    TypeTree returnType = methodTree.returnType();\n+    if (isNotCompliantReturnType(returnType, methodTree.symbol())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bae5061155923a469545c46d1bafccf36fbc3dc"}, "originalPosition": 60}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7bae5061155923a469545c46d1bafccf36fbc3dc", "author": {"user": {"login": "alban-auzeill", "name": "Alban Auzeill"}}, "url": "https://github.com/SonarSource/sonar-java/commit/7bae5061155923a469545c46d1bafccf36fbc3dc", "committedDate": "2020-09-14T12:12:42Z", "message": "SONARJAVA-3513 Improve S5810 to support static and test methods with return values"}, "afterCommit": {"oid": "872799ca5ca218c01fec7834ade907b27ac20f73", "author": {"user": {"login": "alban-auzeill", "name": "Alban Auzeill"}}, "url": "https://github.com/SonarSource/sonar-java/commit/872799ca5ca218c01fec7834ade907b27ac20f73", "committedDate": "2020-09-15T12:43:29Z", "message": "Inline raiseIssueOnNotCompliantReturnType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "548449bba2977c3c1b47206e45098ae3b45c34a4", "author": {"user": {"login": "alban-auzeill", "name": "Alban Auzeill"}}, "url": "https://github.com/SonarSource/sonar-java/commit/548449bba2977c3c1b47206e45098ae3b45c34a4", "committedDate": "2020-09-15T14:21:35Z", "message": "SONARJAVA-3513 Improve S5810 to support static and test methods with return values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbccdb04e8b29f9013c7c7af4be7d9c657474a29", "author": {"user": {"login": "alban-auzeill", "name": "Alban Auzeill"}}, "url": "https://github.com/SonarSource/sonar-java/commit/dbccdb04e8b29f9013c7c7af4be7d9c657474a29", "committedDate": "2020-09-15T14:21:35Z", "message": "Replace isNotCompliantReturnType by raiseIssueOnNotCompliantReturnType"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "872799ca5ca218c01fec7834ade907b27ac20f73", "author": {"user": {"login": "alban-auzeill", "name": "Alban Auzeill"}}, "url": "https://github.com/SonarSource/sonar-java/commit/872799ca5ca218c01fec7834ade907b27ac20f73", "committedDate": "2020-09-15T12:43:29Z", "message": "Inline raiseIssueOnNotCompliantReturnType"}, "afterCommit": {"oid": "dbccdb04e8b29f9013c7c7af4be7d9c657474a29", "author": {"user": {"login": "alban-auzeill", "name": "Alban Auzeill"}}, "url": "https://github.com/SonarSource/sonar-java/commit/dbccdb04e8b29f9013c7c7af4be7d9c657474a29", "committedDate": "2020-09-15T14:21:35Z", "message": "Replace isNotCompliantReturnType by raiseIssueOnNotCompliantReturnType"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MzI1NTY5", "url": "https://github.com/SonarSource/sonar-java/pull/3176#pullrequestreview-489325569", "createdAt": "2020-09-16T06:56:14Z", "commit": {"oid": "dbccdb04e8b29f9013c7c7af4be7d9c657474a29"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1983, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}