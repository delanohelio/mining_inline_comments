{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMjIzMDEx", "number": 2925, "title": "SONARJAVA-3355 Improve SourceMap API to provide InputFile for source file", "bodyText": "", "createdAt": "2020-04-28T16:19:22Z", "url": "https://github.com/SonarSource/sonar-java/pull/2925", "merged": true, "mergeCommit": {"oid": "6b228f29641eef1d4e989569a43a88fefdd65103"}, "closed": true, "closedAt": "2020-04-30T14:02:46Z", "author": {"login": "saberduck"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccGf4ggBqjMyODExNDg0MTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccsQengH2gAyNDEwMjIzMDExOjBhMWRkMjk5YjgzMTY3MGFjYTNiMmJkNzM4ZjU3NWFiY2MwMGU3Mjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab00eddbefe9add70c95041cb69eea3e3fc6caa8", "author": {"user": {"login": "saberduck", "name": "Tibor Blenessy"}}, "url": "https://github.com/SonarSource/sonar-java/commit/ab00eddbefe9add70c95041cb69eea3e3fc6caa8", "committedDate": "2020-04-28T16:18:39Z", "message": "SONARJAVA-3355 Improve SourceMap API to provide InputFile for source file"}, "afterCommit": {"oid": "cdfe88681b44952fbf82001829597db91e2dd8fd", "author": {"user": {"login": "saberduck", "name": "Tibor Blenessy"}}, "url": "https://github.com/SonarSource/sonar-java/commit/cdfe88681b44952fbf82001829597db91e2dd8fd", "committedDate": "2020-04-28T16:30:04Z", "message": "SONARJAVA-3355 Improve SourceMap API to provide InputFile for source file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNDUyNTEy", "url": "https://github.com/SonarSource/sonar-java/pull/2925#pullrequestreview-402452512", "createdAt": "2020-04-29T08:18:10Z", "commit": {"oid": "cdfe88681b44952fbf82001829597db91e2dd8fd"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwODoxODoxMFrOGN0ZDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwODoxODoxMFrOGN0ZDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE0MzA1Mw==", "bodyText": "We can maybe avoid looking up the same lineFileId for every line by having just a check of the difference of lineInfo.lineFileId with the previous one as in most cases (if not all) we should not have a difference.", "url": "https://github.com/SonarSource/sonar-java/pull/2925#discussion_r417143053", "createdAt": "2020-04-29T08:18:10Z", "author": {"login": "benzonico"}, "path": "java-frontend/src/main/java/org/sonar/java/model/GeneratedFile.java", "diffHunk": "@@ -80,21 +81,26 @@ public void addSmap(SmapFile smap) {\n \n     final Map<Integer, Location> lines = new HashMap<>();\n \n-    private SourceMapImpl() {\n+    private SourceMapImpl(Function<Path, Optional<InputFile>> fileResolver) {\n       for (SmapFile sm : smapFiles) {\n         for (SmapFile.LineInfo lineInfo : sm.getLineSection()) {\n-          for (int i = 0; i < lineInfo.repeatCount; i++) {\n-            int inputLine = lineInfo.inputStartLine + i;\n-            Path inputFile = sm.getUriRoot().resolve(sm.getFileSection().get(lineInfo.lineFileId).sourcePath);\n-            LocationImpl location = new LocationImpl(inputFile, inputLine, inputLine);\n-            int outputStart = lineInfo.outputStartLine + (i * lineInfo.outputLineIncrement);\n-            int outputEnd = lineInfo.outputStartLine + ((i + 1) * lineInfo.outputLineIncrement) - 1;\n-            // when outputLineIncrement == 0, end will be less than start (looks like bug in spec)\n-            outputEnd = max(outputStart, outputEnd);\n-            for (int j = outputStart; j <= outputEnd; j++) {\n-              lines.merge(j, location, LocationImpl::mergeLocations);\n-            }\n-          }\n+          Path sourcePath = sm.getUriRoot().resolve(sm.getFileSection().get(lineInfo.lineFileId).sourcePath);\n+          Optional<InputFile> inputFile = fileResolver.apply(sourcePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdfe88681b44952fbf82001829597db91e2dd8fd"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cdfe88681b44952fbf82001829597db91e2dd8fd", "author": {"user": {"login": "saberduck", "name": "Tibor Blenessy"}}, "url": "https://github.com/SonarSource/sonar-java/commit/cdfe88681b44952fbf82001829597db91e2dd8fd", "committedDate": "2020-04-28T16:30:04Z", "message": "SONARJAVA-3355 Improve SourceMap API to provide InputFile for source file"}, "afterCommit": {"oid": "16497ef451ef335f0343f38731884de7fcdfc304", "author": {"user": {"login": "saberduck", "name": "Tibor Blenessy"}}, "url": "https://github.com/SonarSource/sonar-java/commit/16497ef451ef335f0343f38731884de7fcdfc304", "committedDate": "2020-04-29T20:43:41Z", "message": "SONARJAVA-3355 [JSP] Improve SourceMap API to provide InputFile for source file"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16497ef451ef335f0343f38731884de7fcdfc304", "author": {"user": {"login": "saberduck", "name": "Tibor Blenessy"}}, "url": "https://github.com/SonarSource/sonar-java/commit/16497ef451ef335f0343f38731884de7fcdfc304", "committedDate": "2020-04-29T20:43:41Z", "message": "SONARJAVA-3355 [JSP] Improve SourceMap API to provide InputFile for source file"}, "afterCommit": {"oid": "624bf7ab6a4968729c9601f3a094a79137f96778", "author": {"user": {"login": "saberduck", "name": "Tibor Blenessy"}}, "url": "https://github.com/SonarSource/sonar-java/commit/624bf7ab6a4968729c9601f3a094a79137f96778", "committedDate": "2020-04-29T20:57:27Z", "message": "SONARJAVA-3355 [JSP] Improve SourceMap API to provide InputFile for source file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "056a002f104cbd1c02d3aa1b587056794bdde962", "author": {"user": {"login": "saberduck", "name": "Tibor Blenessy"}}, "url": "https://github.com/SonarSource/sonar-java/commit/056a002f104cbd1c02d3aa1b587056794bdde962", "committedDate": "2020-04-29T21:20:43Z", "message": "SONARJAVA-3355 [JSP] Improve SourceMap API to provide InputFile for source file"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "624bf7ab6a4968729c9601f3a094a79137f96778", "author": {"user": {"login": "saberduck", "name": "Tibor Blenessy"}}, "url": "https://github.com/SonarSource/sonar-java/commit/624bf7ab6a4968729c9601f3a094a79137f96778", "committedDate": "2020-04-29T20:57:27Z", "message": "SONARJAVA-3355 [JSP] Improve SourceMap API to provide InputFile for source file"}, "afterCommit": {"oid": "056a002f104cbd1c02d3aa1b587056794bdde962", "author": {"user": {"login": "saberduck", "name": "Tibor Blenessy"}}, "url": "https://github.com/SonarSource/sonar-java/commit/056a002f104cbd1c02d3aa1b587056794bdde962", "committedDate": "2020-04-29T21:20:43Z", "message": "SONARJAVA-3355 [JSP] Improve SourceMap API to provide InputFile for source file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9daf8b82ee4493c60218c2d249a664384c39aa9d", "author": {"user": {"login": "saberduck", "name": "Tibor Blenessy"}}, "url": "https://github.com/SonarSource/sonar-java/commit/9daf8b82ee4493c60218c2d249a664384c39aa9d", "committedDate": "2020-04-30T09:41:11Z", "message": "Make API backwards compatible"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20c6ef30108dd175172d22caf8b3a774f05f60a3", "author": {"user": {"login": "saberduck", "name": "Tibor Blenessy"}}, "url": "https://github.com/SonarSource/sonar-java/commit/20c6ef30108dd175172d22caf8b3a774f05f60a3", "committedDate": "2020-04-30T09:38:11Z", "message": "Make API backwards compatible"}, "afterCommit": {"oid": "9daf8b82ee4493c60218c2d249a664384c39aa9d", "author": {"user": {"login": "saberduck", "name": "Tibor Blenessy"}}, "url": "https://github.com/SonarSource/sonar-java/commit/9daf8b82ee4493c60218c2d249a664384c39aa9d", "committedDate": "2020-04-30T09:41:11Z", "message": "Make API backwards compatible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8f9d2940e074df62ab8560c5be2aa5bce8a9565", "author": {"user": {"login": "saberduck", "name": "Tibor Blenessy"}}, "url": "https://github.com/SonarSource/sonar-java/commit/d8f9d2940e074df62ab8560c5be2aa5bce8a9565", "committedDate": "2020-04-30T12:10:10Z", "message": "remove leftover @Nullable annotation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNDU3ODY5", "url": "https://github.com/SonarSource/sonar-java/pull/2925#pullrequestreview-403457869", "createdAt": "2020-04-30T12:09:30Z", "commit": {"oid": "9daf8b82ee4493c60218c2d249a664384c39aa9d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxMjowOTozMVrOGOmYAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxMjowOTozMVrOGOmYAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk2MTk4NQ==", "bodyText": "This should not be annotated with @Nullable. This can not happen in production, only in tests.", "url": "https://github.com/SonarSource/sonar-java/pull/2925#discussion_r417961985", "createdAt": "2020-04-30T12:09:31Z", "author": {"login": "m-g-sonar"}, "path": "java-frontend/src/main/java/org/sonar/java/model/GeneratedFile.java", "diffHunk": "@@ -48,17 +47,17 @@\n \n public class GeneratedFile implements InputFile {\n \n-  private static final Logger LOG = Loggers.get(GeneratedFile.class);\n-\n   private final Path path;\n \n   @VisibleForTesting\n   final List<SmapFile> smapFiles = new ArrayList<>();\n+  private final InputFile jspSourceFile;\n \n   private SourceMap sourceMap;\n \n-  public GeneratedFile(Path path) {\n+  public GeneratedFile(Path path, @Nullable InputFile jspSourceFile) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9daf8b82ee4493c60218c2d249a664384c39aa9d"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a1dd299b831670aca3b2bd738f575abcc00e727", "author": {"user": {"login": "saberduck", "name": "Tibor Blenessy"}}, "url": "https://github.com/SonarSource/sonar-java/commit/0a1dd299b831670aca3b2bd738f575abcc00e727", "committedDate": "2020-04-30T12:29:47Z", "message": "fix coverage"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1791, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}