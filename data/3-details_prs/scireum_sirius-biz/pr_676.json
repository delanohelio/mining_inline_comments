{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4Mjc2NDA0", "number": 676, "title": "Efficient move operations for VFS files (SIRI-102)", "bodyText": "", "createdAt": "2020-01-28T22:40:58Z", "url": "https://github.com/scireum/sirius-biz/pull/676", "merged": true, "mergeCommit": {"oid": "03c10107af67cc89efae09e832a34391b0998ffc"}, "closed": true, "closedAt": "2020-02-14T07:58:58Z", "author": {"login": "andyHa"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-4ZkrgH2gAyMzY4Mjc2NDA0OmZjOTU0NzQ3MTVmYTc2YmNiY2ExNDNhMGM5MDk5OTYxMTc4OGY1ZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEK1JkgFqTM1ODc2MzkzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fc95474715fa76bcbca143a0c90999611788f5f1", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/fc95474715fa76bcbca143a0c90999611788f5f1", "committedDate": "2020-01-28T21:40:51Z", "message": "Merge branch 'aha/13.0-rc79-HF' into aha/vfs-move\n\n# Conflicts:\n#\tsrc/main/java/sirius/biz/storage/layer3/uplink/sftp/SFTPUplinkConnectorConfig.java\n#\tsrc/main/java/sirius/biz/storage/layer3/uplink/util/UplinkConnector.java\n#\tsrc/main/java/sirius/biz/storage/layer3/uplink/util/UplinkConnectorFactory.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4287e709877194122d308a1d5182086899fcb1be", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/4287e709877194122d308a1d5182086899fcb1be", "committedDate": "2020-01-28T21:40:58Z", "message": "Merge remote-tracking branch 'origin/master' into aha/vfs-move"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a274c537c26b0f48fc65487cb93ce24edd8fec1", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/6a274c537c26b0f48fc65487cb93ce24edd8fec1", "committedDate": "2020-01-28T21:42:41Z", "message": "Adds some retry magic for the SFTPUplink.\n\nThis had previously been done for the FTPUplink"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45b1f587721c3446b0fa0e52763fb35edc7682f8", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/45b1f587721c3446b0fa0e52763fb35edc7682f8", "committedDate": "2020-01-28T21:44:54Z", "message": "Properly names efficient move functions.\n\nThese are considered \"fastMove\" operations as they\nhopefully only perform a rename or inode move instead of\njuggling any bytes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52bfc626811af049ae3515c1bbdf9ea31080d6c4", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/52bfc626811af049ae3515c1bbdf9ea31080d6c4", "committedDate": "2020-01-28T21:45:33Z", "message": "Provides an efficient move operation when moving files within a CIFS share.\n\nFixes: SIRI-102"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0a608e4b496d8d5f110c487ea0036a0816f45ce", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/c0a608e4b496d8d5f110c487ea0036a0816f45ce", "committedDate": "2020-01-28T21:45:50Z", "message": "Provides an efficient move operation when moving files within the local file system.\n\nFixes: SIRI-102"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cb6636d8ff320fae5f74206cc76195f2694d52a", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/4cb6636d8ff320fae5f74206cc76195f2694d52a", "committedDate": "2020-01-28T21:46:12Z", "message": "Provides an efficient move operation when moving files within a FTP uplink.\n\nFixes: SIRI-102"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28203d96b3f97e8a93ddf02a90f92108bfe9e5dc", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/28203d96b3f97e8a93ddf02a90f92108bfe9e5dc", "committedDate": "2020-01-28T21:46:29Z", "message": "Provides an efficient move operation when moving files within a SFTP uplink.\n\nFixes: SIRI-102"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4296b16155f3fa3ed40b9e2c286f0c464ef877fa", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/4296b16155f3fa3ed40b9e2c286f0c464ef877fa", "committedDate": "2020-01-28T21:47:10Z", "message": "Makes the efficient move operations of Level 2 accessible in the layer 3 (VFS).\n\nFixes: SIRI-102"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODg4MzM0", "url": "https://github.com/scireum/sirius-biz/pull/676#pullrequestreview-349888334", "createdAt": "2020-01-29T06:41:51Z", "commit": {"oid": "4296b16155f3fa3ed40b9e2c286f0c464ef877fa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjo0MTo1MVrOFi9-hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjo0ODo0NVrOFi-EuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxMTMzNQ==", "bodyText": "javadoc ?: can move file into new parent directory if they belong both to the same space", "url": "https://github.com/scireum/sirius-biz/pull/676#discussion_r372211335", "createdAt": "2020-01-29T06:41:51Z", "author": {"login": "tbiScireum"}, "path": "src/main/java/sirius/biz/storage/layer2/L3Uplink.java", "diffHunk": "@@ -359,16 +359,32 @@ private boolean deleteHandler(VirtualFile file) {\n         return false;\n     }\n \n-    private boolean moveHandler(VirtualFile file, VirtualFile newParent) {\n+    private boolean canFastMoveHandler(VirtualFile file, VirtualFile newParent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4296b16155f3fa3ed40b9e2c286f0c464ef877fa"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxMjkyMA==", "bodyText": "unncessary", "url": "https://github.com/scireum/sirius-biz/pull/676#discussion_r372212920", "createdAt": "2020-01-29T06:48:45Z", "author": {"login": "tbiScireum"}, "path": "src/main/java/sirius/biz/storage/layer3/uplink/util/UplinkConnectorPool.java", "diffHunk": "@@ -8,9 +8,11 @@\n \n package sirius.biz.storage.layer3.uplink.util;\n \n+import org.apache.commons.pool2.impl.DefaultPooledObject;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4296b16155f3fa3ed40b9e2c286f0c464ef877fa"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bff5e7d07f9b26191ce9ba1100cded52f3cfde54", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/bff5e7d07f9b26191ce9ba1100cded52f3cfde54", "committedDate": "2020-01-29T19:37:17Z", "message": "Widens the number of exceptions being handled."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5d3e2c55f46515ad29b6aa9e63d7ffc44ef9c80", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/e5d3e2c55f46515ad29b6aa9e63d7ffc44ef9c80", "committedDate": "2020-01-29T19:37:38Z", "message": "Also force closes a connector when a fast move fails."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1248fe58173f5872014aeace648f6edf13677990", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/1248fe58173f5872014aeace648f6edf13677990", "committedDate": "2020-01-29T19:38:16Z", "message": "Merge branch 'aha/13.0-rc79-3' into aha/vfs-move\n\n# Conflicts:\n#\tsrc/main/java/sirius/biz/storage/layer3/uplink/ftp/FTPUplink.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1742f7114d2911853b51e39c179779324982ffc6", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/1742f7114d2911853b51e39c179779324982ffc6", "committedDate": "2020-01-29T19:39:26Z", "message": "Fixes the name of the commend being referenced."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96059ff10c936d227b8ad6e38e825619018267e5", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/96059ff10c936d227b8ad6e38e825619018267e5", "committedDate": "2020-01-29T19:39:35Z", "message": "Code format."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNjAyMjM2", "url": "https://github.com/scireum/sirius-biz/pull/676#pullrequestreview-350602236", "createdAt": "2020-01-30T06:23:21Z", "commit": {"oid": "96059ff10c936d227b8ad6e38e825619018267e5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwNjoyMzoyMVrOFjgdmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwNjoyMzoyMVrOFjgdmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc3NjM0Nw==", "bodyText": "Wie w\u00e4rs mit Exceptions.getRootCause ?", "url": "https://github.com/scireum/sirius-biz/pull/676#discussion_r372776347", "createdAt": "2020-01-30T06:23:21Z", "author": {"login": "tbiScireum"}, "path": "src/main/java/sirius/biz/storage/layer3/uplink/util/Attempt.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.storage.layer3.uplink.util;\n+\n+import sirius.biz.storage.layer3.uplink.sftp.SFTPUplink;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Helps to distinguishes an initial first attempt from a rety.\n+ * <p>\n+ * If is used by uplinks like {@link sirius.biz.storage.layer3.uplink.ftp.FTPUplink} or {@link SFTPUplink} to\n+ * permit a retry for all IO related operations. Therefore the helper method {@link #shouldThrow(Exception)}\n+ * can be used to determine if an <tt>IOException</tt> is swallowed if it occurs during a first attempt but\n+ * will be thrown during a retry.\n+ * <p>\n+ * The pattern to use this looks something like:\n+ * <pre>{@code\n+ * for(Attempt attempt : Attempt.values()) {\n+ *     try {\n+ *         ...do something\n+ *         return;\n+ *     } catch(Exception e) {\n+ *         if (attempt.shouldThrow(e)) {\n+ *             throw Exceptions.handle...\n+ *         }\n+ *     }\n+ * }\n+ * }</pre>\n+ * <p>\n+ * This approach permits to perform inner returns and also enables some optimizations to the compiler (as opposed to\n+ * use lambdas).\n+ */\n+public enum Attempt {\n+    FIRST_ATTEMPT, RETRY;\n+\n+    /**\n+     * Determines if the given exception should be thrown.\n+     *\n+     * @param exception the exception to check\n+     * @return <tt>true</tt> if the exception should be thrown, <tt>false</tt> if it should be swallowed\n+     */\n+    public boolean shouldThrow(Exception exception) {\n+        return this == RETRY || !((exception instanceof IOException) || (exception.getCause() instanceof IOException));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96059ff10c936d227b8ad6e38e825619018267e5"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62542c6f66680c20fee6300a5ff11ac0209a2072", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/62542c6f66680c20fee6300a5ff11ac0209a2072", "committedDate": "2020-01-30T14:36:57Z", "message": "Merge branch 'aha/13.0-rc79-3' into aha/vfs-move"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad0717b76a93710e1cabf69a4578be42bb271fa6", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/ad0717b76a93710e1cabf69a4578be42bb271fa6", "committedDate": "2020-01-30T14:41:40Z", "message": "Also test connectors being returned into the pool.\n\nIf a retry-able io operation crashes, we attempt a retry\nbut we also forcefully close the connector we used.\n\nThis will invalidate the object. By enforcing a validation\nbefore actually returning the object into the pool we\ncan save some overhead. Note that this shouldn't\nhave any semantic side-effects as the connector would\nbe tested before its use anyway - therefore this is really\njust a shortcut."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f11e124b09fcbfaf8ab13fbf39ef79adb034518", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/3f11e124b09fcbfaf8ab13fbf39ef79adb034518", "committedDate": "2020-01-30T14:41:54Z", "message": "Code cleanup."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eb00f529135b056a32b6b2691fd7997862dc4db", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/3eb00f529135b056a32b6b2691fd7997862dc4db", "committedDate": "2020-01-30T14:47:43Z", "message": "Moves a helper into a generic package as it is used by several sub-frameworks."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNTE0MTMw", "url": "https://github.com/scireum/sirius-biz/pull/676#pullrequestreview-351514130", "createdAt": "2020-01-31T13:47:44Z", "commit": {"oid": "3eb00f529135b056a32b6b2691fd7997862dc4db"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxMzo0Nzo0NFrOFkLzfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxMzo0Nzo0NFrOFkLzfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4NjQ2MQ==", "bodyText": "can we put that for loop & error handling in an extra method with a runnable or consumer as parameter?\nThis looks like copy & paste on 3 different places. Maybe:\nattemptConnection(Consumer<UplinkConnector>)", "url": "https://github.com/scireum/sirius-biz/pull/676#discussion_r373486461", "createdAt": "2020-01-31T13:47:44Z", "author": {"login": "tbiScireum"}, "path": "src/main/java/sirius/biz/storage/layer3/uplink/ftp/FTPUplink.java", "diffHunk": "@@ -185,25 +204,35 @@ private MutableVirtualFile wrap(VirtualFile parent, FTPFile file, String filenam\n             return Optional.of(result);\n         }\n \n-        try (UplinkConnector<FTPClient> connector = connectorPool.obtain(ftpConfig)) {\n-            FTPFile[] ftpFiles = list(connector.connector(),\n-                                      file.parent().as(RemotePath.class),\n-                                      ftpFile -> Strings.areEqual(ftpFile.getName(), file.name()));\n-            if (ftpFiles.length == 1) {\n-                file.attach(ftpFiles[0]);\n-                return Optional.of(ftpFiles[0]);\n-            } else {\n-                return Optional.empty();\n+        for (Attempt attempt : Attempt.values()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eb00f529135b056a32b6b2691fd7997862dc4db"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7889a0a7eb7ce1c2c687fa8d66aaba3ae5890a2", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/b7889a0a7eb7ce1c2c687fa8d66aaba3ae5890a2", "committedDate": "2020-02-13T15:55:36Z", "message": "Merge remote-tracking branch 'origin/master' into aha/vfs-move\n\n# Conflicts:\n#\tsrc/main/java/sirius/biz/storage/layer3/uplink/util/UplinkConnectorFactory.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6087eae28d610cf8bc097c4f0774ef275193441c", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/6087eae28d610cf8bc097c4f0774ef275193441c", "committedDate": "2020-02-02T21:08:18Z", "message": "TMPCMT"}, "afterCommit": {"oid": "b7889a0a7eb7ce1c2c687fa8d66aaba3ae5890a2", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/b7889a0a7eb7ce1c2c687fa8d66aaba3ae5890a2", "committedDate": "2020-02-13T15:55:36Z", "message": "Merge remote-tracking branch 'origin/master' into aha/vfs-move\n\n# Conflicts:\n#\tsrc/main/java/sirius/biz/storage/layer3/uplink/util/UplinkConnectorFactory.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NTA1ODkw", "url": "https://github.com/scireum/sirius-biz/pull/676#pullrequestreview-358505890", "createdAt": "2020-02-13T19:51:57Z", "commit": {"oid": "b7889a0a7eb7ce1c2c687fa8d66aaba3ae5890a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NzYzOTM4", "url": "https://github.com/scireum/sirius-biz/pull/676#pullrequestreview-358763938", "createdAt": "2020-02-14T07:58:53Z", "commit": {"oid": "b7889a0a7eb7ce1c2c687fa8d66aaba3ae5890a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4520, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}