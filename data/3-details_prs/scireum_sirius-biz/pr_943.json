{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNjg1NDI0", "number": 943, "title": "Misc Fixes: Replication, Conversion Engine, Processes", "bodyText": "The replication task storages now properly compute the executable tasks.\nThe conversion engine runs more tasks in parallel and also measures the actual conversion performance properly.\nSome cleanup in the default configs.\nIf a Process get terminated due to a system restart, we now mark it as erroneous.\n\nFixes: SIRI-294", "createdAt": "2020-12-17T08:09:29Z", "url": "https://github.com/scireum/sirius-biz/pull/943", "merged": true, "mergeCommit": {"oid": "85fa2c161da06ce77dd074ccdc43e65fa3ccefea"}, "closed": true, "closedAt": "2020-12-18T12:33:10Z", "author": {"login": "andyHa"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm-5vCAH2gAyNTQxNjg1NDI0OmU4OTNlZGI2OTY5YzBhYzIxYjFkNDAzOGVlMzI5MGViMDA5YmNjYWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdm_5MjgFqTU1NDQwNzM2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e893edb6969c0ac21b1d4038ee3290eb009bccab", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/e893edb6969c0ac21b1d4038ee3290eb009bccab", "committedDate": "2020-12-17T08:03:32Z", "message": "Uses the proper compare method to determine which tasks are executable."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79028a8a308b817e3bbd7a803759c4b957f53a8b", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/79028a8a308b817e3bbd7a803759c4b957f53a8b", "committedDate": "2020-12-17T08:03:57Z", "message": "Fixes the name of config limits."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2361dcca67fa692973cb36926e8c6c444204927f", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/2361dcca67fa692973cb36926e8c6c444204927f", "committedDate": "2020-12-17T08:04:49Z", "message": "Increases the conversion performance.\n\nAs the conversion engine not only does the actual conversion\nbut also juggles files from and to the storage engine. We an run\nquite a few conversions in parallel."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f67da9919acdb64a1f2a889935c46eb91c87006", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/4f67da9919acdb64a1f2a889935c46eb91c87006", "committedDate": "2020-12-17T08:05:46Z", "message": "Uses a proper way to measure the conversion duration.\n\nWith the previous way, we also included the \"wait time\" when\nthen task is queued."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "478b2ab017c680eef859402271eb7ff169ff996e", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/478b2ab017c680eef859402271eb7ff169ff996e", "committedDate": "2020-12-17T08:06:51Z", "message": "Marks a process as canceled if it is stopped externally.\n\nThis might happen if we shut down the node and the\nprocess gets terminated this way. In this case we must\nmark the process as erroneous as it didn't complete\nits task."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MzY0Njgx", "url": "https://github.com/scireum/sirius-biz/pull/943#pullrequestreview-554364681", "createdAt": "2020-12-17T08:15:41Z", "commit": {"oid": "4f67da9919acdb64a1f2a889935c46eb91c87006"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwODoxNTo0MVrOIHpi0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwODoxNTo0MVrOIHpi0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDg5MTYwMA==", "bodyText": "Is this enough added precision for now or do we want to track download, conversion and upload duration separately right away?", "url": "https://github.com/scireum/sirius-biz/pull/943#discussion_r544891600", "createdAt": "2020-12-17T08:15:41Z", "author": {"login": "sabieber"}, "path": "src/main/java/sirius/biz/storage/layer2/BasicBlobStorageSpace.java", "diffHunk": "@@ -1408,12 +1407,14 @@ private V awaitConversionResultAndRetryToFindVariant(B blob, String variantName,\n      * @param variant the variant to generate\n      */\n     private void invokeConversionPipelineAsync(B blob, V variant) {\n-        Watch watch = Watch.start();\n-        conversionEngine.performConversion(blob, variant.getVariantName()).onSuccess(handle -> {\n-            try (FileHandle automaticHandle = handle) {\n+        conversionEngine.performConversion(blob, variant.getVariantName()).onSuccess(handleAndWatch -> {\n+            try (FileHandle automaticHandle = handleAndWatch.getFirst()) {\n                 String physicalKey = keyGenerator.generateId();\n                 getPhysicalSpace().upload(physicalKey, automaticHandle.getFile());\n-                markConversionSuccess(variant, physicalKey, automaticHandle.getFile().length(), watch.elapsedMillis());\n+                markConversionSuccess(variant,\n+                                      physicalKey,\n+                                      automaticHandle.getFile().length(),\n+                                      handleAndWatch.getSecond().elapsedMillis());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f67da9919acdb64a1f2a889935c46eb91c87006"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MzY2MjQ0", "url": "https://github.com/scireum/sirius-biz/pull/943#pullrequestreview-554366244", "createdAt": "2020-12-17T08:17:56Z", "commit": {"oid": "478b2ab017c680eef859402271eb7ff169ff996e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NDAwNDU1", "url": "https://github.com/scireum/sirius-biz/pull/943#pullrequestreview-554400455", "createdAt": "2020-12-17T09:04:27Z", "commit": {"oid": "478b2ab017c680eef859402271eb7ff169ff996e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NDA3MzY3", "url": "https://github.com/scireum/sirius-biz/pull/943#pullrequestreview-554407367", "createdAt": "2020-12-17T09:12:51Z", "commit": {"oid": "478b2ab017c680eef859402271eb7ff169ff996e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4286, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}