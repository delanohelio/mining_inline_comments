{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNDEyMjY4", "number": 936, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNjoxMzo1M1rOE_OogA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozMjozOVrOE_h44g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0NzM1NDg4OnYy", "diffSide": "RIGHT", "path": "src/main/java/sirius/biz/storage/layer2/jdbc/SQLProcessBlobChangesLoop.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNjoxMzo1M1rOH80j_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNjoxMzo1M1rOH80j_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzUzNzc4OA==", "bodyText": "sure? shouldnt this be SqlDirectory.ID == dir.getId()?", "url": "https://github.com/scireum/sirius-biz/pull/936#discussion_r533537788", "createdAt": "2020-12-01T16:13:53Z", "author": {"login": "sabieber"}, "path": "src/main/java/sirius/biz/storage/layer2/jdbc/SQLProcessBlobChangesLoop.java", "diffHunk": "@@ -91,4 +91,61 @@ protected void propagateDelete(Directory dir) {\n                     dir.getSpaceName()).handle();\n         }\n     }\n+\n+    @Override\n+    protected void processRenamedDirectories(Runnable counter) {\n+        oma.select(SQLDirectory.class).eq(SQLDirectory.RENAMED, true).limit(256).iterateAll(dir -> {\n+            try {\n+                propagateRename(dir);\n+                oma.updateStatement(SQLDirectory.class)\n+                   .set(SQLDirectory.RENAMED, false)\n+                   .where(SQLDirectory.PARENT, dir.getId())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5639497f93de78a310564077c79c0f66158458a"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDMxOTk5OnYy", "diffSide": "RIGHT", "path": "src/main/java/sirius/biz/storage/layer2/BlobParentChangedHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwODo0ODozMlrOH9QMOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwODo0ODozMlrOH9QMOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5MDQ1OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Method executed when a blob has its parent {@link Directory} changed.\n          \n          \n            \n                 * Executed when a blob has its parent {@link Directory} changed.", "url": "https://github.com/scireum/sirius-biz/pull/936#discussion_r533990458", "createdAt": "2020-12-02T08:48:32Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/layer2/BlobParentChangedHandler.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.storage.layer2;\n+\n+import sirius.kernel.di.std.Priorized;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Defines handlers to process {@link Blob blobs} which parent have been moved between {@link Directory directories}.\n+ *\n+ * @see ProcessBlobChangesLoop\n+ */\n+public interface BlobParentChangedHandler extends Priorized {\n+    /**\n+     * Method executed when a blob has its parent {@link Directory} changed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0cf38a4f9e1a25099c3c40901a631af1c2f853d"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDMzMDg2OnYy", "diffSide": "RIGHT", "path": "src/main/java/sirius/biz/storage/layer2/mongo/MongoProcessBlobChangesLoop.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwODo1MToxMVrOH9QSzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwODo1MToxMVrOH9QSzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5MjE0Mw==", "bodyText": "didn't we want to increase all the 256's to s.th. larger - like 1k oder 512? goes for all blocks. First step would be to define a constant in a base class and use this everywhere to it can be centrally controlled(?)", "url": "https://github.com/scireum/sirius-biz/pull/936#discussion_r533992143", "createdAt": "2020-12-02T08:51:11Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/layer2/mongo/MongoProcessBlobChangesLoop.java", "diffHunk": "@@ -78,4 +78,45 @@ protected void propagateDelete(@Nonnull Directory dir) {\n              .executeFor(MongoDirectory.class);\n         mongo.update().set(MongoBlob.DELETED, true).where(MongoBlob.PARENT, directoryId).executeFor(MongoBlob.class);\n     }\n+\n+    @Override\n+    protected void processRenamedDirectories(Runnable counter) {\n+        mango.select(MongoDirectory.class).eq(MongoDirectory.RENAMED, true).limit(256).iterateAll(dir -> {\n+            try {\n+                propagateRename(dir);\n+                mongo.update()\n+                     .set(MongoDirectory.RENAMED, false)\n+                     .where(MongoDirectory.ID, dir.getId())\n+                     .executeFor(MongoDirectory.class);\n+            } catch (Exception e) {\n+                handleDirectoryRenameException(dir, e);\n+            }\n+            counter.run();\n+        });\n+    }\n+\n+    @Override\n+    protected void propagateRename(@Nonnull Directory dir) {\n+        String directoryId = dir.getIdAsString();\n+        mongo.update()\n+             .set(MongoDirectory.RENAMED, true)\n+             .where(MongoDirectory.PARENT, directoryId)\n+             .executeFor(MongoDirectory.class);\n+        mongo.update()\n+             .set(MongoBlob.PARENT_CHANGED, true)\n+             .where(MongoBlob.PARENT, directoryId)\n+             .executeFor(MongoBlob.class);\n+    }\n+\n+    @Override\n+    protected void processParentChangedBlobs(Runnable counter) {\n+        mango.select(MongoBlob.class).eq(MongoBlob.PARENT_CHANGED, true).limit(256).iterateAll(blob -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0cf38a4f9e1a25099c3c40901a631af1c2f853d"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDUwOTc4OnYy", "diffSide": "RIGHT", "path": "src/main/java/sirius/biz/storage/layer2/ProcessBlobChangesLoop.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozMjozOVrOH9R_Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozMjozOVrOH9R_Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxOTg3NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected static final int CURSOR_LIMIT = 1024;\n          \n          \n            \n                /**\n          \n          \n            \n                 * Defines the block size used for queries to propagate and handle various change flags.\n          \n          \n            \n                 */\n          \n          \n            \n                protected static final int CURSOR_LIMIT = 1024;", "url": "https://github.com/scireum/sirius-biz/pull/936#discussion_r534019874", "createdAt": "2020-12-02T09:32:39Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/layer2/ProcessBlobChangesLoop.java", "diffHunk": "@@ -25,10 +25,14 @@\n public abstract class ProcessBlobChangesLoop extends BackgroundLoop {\n \n     private static final double FREQUENCY_EVERY_FIFTEEN_SECONDS = 1 / 15d;\n+    protected static final int CURSOR_LIMIT = 1024;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ba4e70b7a92e1112d9e2c9edfed6a88d4be9e46"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1879, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}