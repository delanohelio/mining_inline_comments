{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzNDU4MTcx", "number": 939, "title": "SIRI-286 Sanitize paths in the storage engine", "bodyText": "", "createdAt": "2020-12-07T07:44:08Z", "url": "https://github.com/scireum/sirius-biz/pull/939", "merged": true, "mergeCommit": {"oid": "f4e2fc4613cd5d27bf47a53d49f83b060e384c61"}, "closed": true, "closedAt": "2020-12-08T13:10:16Z", "author": {"login": "jmuscireum"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjwc-0gH2gAyNTMzNDU4MTcxOjMyZDFhNTIzNTZiNWRkMGVjY2M0NzNhMWY1NWZlZGZkNWNlYmEwOGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkJyhJAFqTU0NzIxMjI2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "32d1a52356b5dd0eccc473a1f55fedfd5ceba08f", "author": {"user": {"login": "jmuscireum", "name": null}}, "url": "https://github.com/scireum/sirius-biz/commit/32d1a52356b5dd0eccc473a1f55fedfd5ceba08f", "committedDate": "2020-12-07T07:31:41Z", "message": "Add a utility function to sanitize paths\n\nThe old method (copied from the old framework) was marked as deprecated,\nas it isn't used anywhere.\n\nFixes: SIRI-286"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43a5a8cf7dd1a7d42d384bf2b79d38af57e95bc1", "author": {"user": {"login": "jmuscireum", "name": null}}, "url": "https://github.com/scireum/sirius-biz/commit/43a5a8cf7dd1a7d42d384bf2b79d38af57e95bc1", "committedDate": "2020-12-07T07:37:24Z", "message": "Sanitize the paths in the blob storage space\n\nThis also makes the method ensureRelativePath redundant as the sanitized\npaths are stripped of leading slashes already.\n\nFixes: SIRI-286"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abf008b0187082eb44b9c83428241f83cc97a10d", "author": {"user": {"login": "jmuscireum", "name": null}}, "url": "https://github.com/scireum/sirius-biz/commit/abf008b0187082eb44b9c83428241f83cc97a10d", "committedDate": "2020-12-07T07:41:32Z", "message": "Sanitize the paths in the virtual file system\n\nThis also makes the method ensureRelativePath redundant as the sanitized\npaths are stripped of leading slashes already.\n\nFixes: SIRI-286"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d37ac3b15f673301ffd86ca12a92b1c81b905a48", "author": {"user": {"login": "jmuscireum", "name": null}}, "url": "https://github.com/scireum/sirius-biz/commit/d37ac3b15f673301ffd86ca12a92b1c81b905a48", "committedDate": "2020-12-07T07:43:03Z", "message": "Ensure that newly created blobs are cached\n\nFixes: SIRI-286"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1ODk3Mzkw", "url": "https://github.com/scireum/sirius-biz/pull/939#pullrequestreview-545897390", "createdAt": "2020-12-07T07:51:58Z", "commit": {"oid": "43a5a8cf7dd1a7d42d384bf2b79d38af57e95bc1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwNzo1MTo1OVrOIAZ5Cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwNzo1MTo1OVrOIAZ5Cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI5NTExNQ==", "bodyText": "I think this call has to be added to Blob::updateContent as well as we could otherwise overwrite a sanitized path with an unsanitized one by accident when updating the content of a blob and passing a file name", "url": "https://github.com/scireum/sirius-biz/pull/939#discussion_r537295115", "createdAt": "2020-12-07T07:51:59Z", "author": {"login": "sabieber"}, "path": "src/main/java/sirius/biz/storage/layer2/BasicBlobStorageSpace.java", "diffHunk": "@@ -373,36 +375,30 @@ protected Blob fetchByPath(String tenantId, @Nonnull String path) {\n         }\n     }\n \n-    protected String ensureRelativePath(String path) {\n-        if (path.startsWith(\"/\")) {\n-            return path.substring(1);\n-        }\n-\n-        return path;\n-    }\n-\n     @Override\n     public Optional<? extends Blob> findByPath(String path) {\n         return findByPath(UserContext.getCurrentUser().getTenantId(), path);\n     }\n \n     @Override\n     public Blob findOrCreateByPath(String tenantId, String path) {\n-        if (Strings.isEmpty(path)) {\n+        String sanitizedPath = utils.sanitizePath(path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43a5a8cf7dd1a7d42d384bf2b79d38af57e95bc1"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1ODk2OTMz", "url": "https://github.com/scireum/sirius-biz/pull/939#pullrequestreview-545896933", "createdAt": "2020-12-07T07:51:16Z", "commit": {"oid": "d37ac3b15f673301ffd86ca12a92b1c81b905a48"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwNzo1MToxN1rOIAZ3dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwNzo1MzozMVrOIAZ78Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI5NDcxMQ==", "bodyText": "ReplaceAll?", "url": "https://github.com/scireum/sirius-biz/pull/939#discussion_r537294711", "createdAt": "2020-12-07T07:51:17Z", "author": {"login": "qw3ry"}, "path": "src/main/java/sirius/biz/storage/util/StorageUtils.java", "diffHunk": "@@ -173,6 +176,39 @@ public static String normalizePath(@Nullable String path) {\n         return normalizedPath;\n     }\n \n+    /**\n+     * Sanitizes the given path.\n+     *\n+     * @param path the path to cleanup\n+     * @return the sanitized path without backslashes, successive slashes, and without leading and trailing slashes\n+     */\n+    @Nonnull\n+    public String sanitizePath(@Nullable String path) {\n+        path = Strings.trim(path);\n+\n+        if (Strings.isEmpty(path)) {\n+            return \"\";\n+        }\n+\n+        if (path.contains(\"\\\\\")) {\n+            path = path.replace(\"\\\\\", \"/\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37ac3b15f673301ffd86ca12a92b1c81b905a48"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI5NTg1Nw==", "bodyText": "Ist absolut = relativ? War vorher ja das gleiche Verhalten, aber das verdient IMO nen erkl\u00e4renden Kommentar", "url": "https://github.com/scireum/sirius-biz/pull/939#discussion_r537295857", "createdAt": "2020-12-07T07:53:31Z", "author": {"login": "qw3ry"}, "path": "src/main/java/sirius/biz/storage/util/StorageUtils.java", "diffHunk": "@@ -173,6 +176,39 @@ public static String normalizePath(@Nullable String path) {\n         return normalizedPath;\n     }\n \n+    /**\n+     * Sanitizes the given path.\n+     *\n+     * @param path the path to cleanup\n+     * @return the sanitized path without backslashes, successive slashes, and without leading and trailing slashes\n+     */\n+    @Nonnull\n+    public String sanitizePath(@Nullable String path) {\n+        path = Strings.trim(path);\n+\n+        if (Strings.isEmpty(path)) {\n+            return \"\";\n+        }\n+\n+        if (path.contains(\"\\\\\")) {\n+            path = path.replace(\"\\\\\", \"/\");\n+        }\n+\n+        if (path.contains(\"//\")) {\n+            path = path.replaceAll(\"/+\", \"/\");\n+        }\n+\n+        if (path.startsWith(\"/\")) {\n+            path = path.substring(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37ac3b15f673301ffd86ca12a92b1c81b905a48"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70e78591acc4e17e51492ce5555ce59572e47d18", "author": {"user": {"login": "jmuscireum", "name": null}}, "url": "https://github.com/scireum/sirius-biz/commit/70e78591acc4e17e51492ce5555ce59572e47d18", "committedDate": "2020-12-07T08:11:33Z", "message": "More JavaDoc\n\nFixes: SIRI-286"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1OTIzMzM0", "url": "https://github.com/scireum/sirius-biz/pull/939#pullrequestreview-545923334", "createdAt": "2020-12-07T08:32:44Z", "commit": {"oid": "70e78591acc4e17e51492ce5555ce59572e47d18"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwODozMjo0NVrOIAbQww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwODozMjo0NVrOIAbQww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMxNzU3MQ==", "bodyText": "why check for a contains?", "url": "https://github.com/scireum/sirius-biz/pull/939#discussion_r537317571", "createdAt": "2020-12-07T08:32:45Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/util/StorageUtils.java", "diffHunk": "@@ -173,6 +176,42 @@ public static String normalizePath(@Nullable String path) {\n         return normalizedPath;\n     }\n \n+    /**\n+     * Sanitizes the given path.\n+     * <p>\n+     * This will replace backslashes with forward slashes, and remove successive slashes. Trailing slashes are removed\n+     * from directory paths, and absolute paths are made relative by removing leading slashes.\n+     *\n+     * @param path the path to cleanup\n+     * @return the sanitized path without backslashes, successive slashes, and without leading and trailing slashes\n+     */\n+    @Nonnull\n+    public String sanitizePath(@Nullable String path) {\n+        path = Strings.trim(path);\n+\n+        if (Strings.isEmpty(path)) {\n+            return \"\";\n+        }\n+\n+        if (path.contains(\"\\\\\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70e78591acc4e17e51492ce5555ce59572e47d18"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1OTIzNDcz", "url": "https://github.com/scireum/sirius-biz/pull/939#pullrequestreview-545923473", "createdAt": "2020-12-07T08:32:55Z", "commit": {"oid": "70e78591acc4e17e51492ce5555ce59572e47d18"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwODozMjo1NVrOIAbRPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwODozMjo1NVrOIAbRPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMxNzY5Mw==", "bodyText": "s.a.", "url": "https://github.com/scireum/sirius-biz/pull/939#discussion_r537317693", "createdAt": "2020-12-07T08:32:55Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/util/StorageUtils.java", "diffHunk": "@@ -173,6 +176,42 @@ public static String normalizePath(@Nullable String path) {\n         return normalizedPath;\n     }\n \n+    /**\n+     * Sanitizes the given path.\n+     * <p>\n+     * This will replace backslashes with forward slashes, and remove successive slashes. Trailing slashes are removed\n+     * from directory paths, and absolute paths are made relative by removing leading slashes.\n+     *\n+     * @param path the path to cleanup\n+     * @return the sanitized path without backslashes, successive slashes, and without leading and trailing slashes\n+     */\n+    @Nonnull\n+    public String sanitizePath(@Nullable String path) {\n+        path = Strings.trim(path);\n+\n+        if (Strings.isEmpty(path)) {\n+            return \"\";\n+        }\n+\n+        if (path.contains(\"\\\\\")) {\n+            path = path.replace(\"\\\\\", \"/\");\n+        }\n+\n+        if (path.contains(\"//\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70e78591acc4e17e51492ce5555ce59572e47d18"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1OTI0NTk3", "url": "https://github.com/scireum/sirius-biz/pull/939#pullrequestreview-545924597", "createdAt": "2020-12-07T08:34:30Z", "commit": {"oid": "70e78591acc4e17e51492ce5555ce59572e47d18"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ece13d92582b068fb77ff789182bb2d922b1ab32", "author": {"user": {"login": "jmuscireum", "name": null}}, "url": "https://github.com/scireum/sirius-biz/commit/ece13d92582b068fb77ff789182bb2d922b1ab32", "committedDate": "2020-12-07T11:14:28Z", "message": "Replace consecutive slashes and backslashes in one go\n\nAlso remove the check if the replace is necessary and use a precompiled\npattern.\n\nFixes: SIRI-286"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0d8871ad99b32c2b9c7fda4b74137fd16291827", "author": {"user": {"login": "jmuscireum", "name": null}}, "url": "https://github.com/scireum/sirius-biz/commit/c0d8871ad99b32c2b9c7fda4b74137fd16291827", "committedDate": "2020-12-07T11:15:17Z", "message": "Remove the unused normalizePath method instead of making it deprecated\n\nFixes: SIRI-286"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MDU2MzQz", "url": "https://github.com/scireum/sirius-biz/pull/939#pullrequestreview-546056343", "createdAt": "2020-12-07T11:23:43Z", "commit": {"oid": "c0d8871ad99b32c2b9c7fda4b74137fd16291827"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MDU5ODU2", "url": "https://github.com/scireum/sirius-biz/pull/939#pullrequestreview-546059856", "createdAt": "2020-12-07T11:28:52Z", "commit": {"oid": "c0d8871ad99b32c2b9c7fda4b74137fd16291827"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MDMxODg0", "url": "https://github.com/scireum/sirius-biz/pull/939#pullrequestreview-547031884", "createdAt": "2020-12-08T10:22:06Z", "commit": {"oid": "c0d8871ad99b32c2b9c7fda4b74137fd16291827"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MjAyOTcz", "url": "https://github.com/scireum/sirius-biz/pull/939#pullrequestreview-547202973", "createdAt": "2020-12-08T12:50:42Z", "commit": {"oid": "c0d8871ad99b32c2b9c7fda4b74137fd16291827"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjo1MDo0MlrOIBZHLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjo1MDo0MlrOIBZHLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMzMDkyNw==", "bodyText": "wasn't this put here intentionally as removed is distributed over the intercom and put isn't? @idlira", "url": "https://github.com/scireum/sirius-biz/pull/939#discussion_r538330927", "createdAt": "2020-12-08T12:50:42Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/layer2/BasicBlobStorageSpace.java", "diffHunk": "@@ -373,36 +375,30 @@ protected Blob fetchByPath(String tenantId, @Nonnull String path) {\n         }\n     }\n \n-    protected String ensureRelativePath(String path) {\n-        if (path.startsWith(\"/\")) {\n-            return path.substring(1);\n-        }\n-\n-        return path;\n-    }\n-\n     @Override\n     public Optional<? extends Blob> findByPath(String path) {\n         return findByPath(UserContext.getCurrentUser().getTenantId(), path);\n     }\n \n     @Override\n     public Blob findOrCreateByPath(String tenantId, String path) {\n-        if (Strings.isEmpty(path)) {\n+        String sanitizedPath = utils.sanitizePath(path);\n+\n+        if (Strings.isEmpty(sanitizedPath)) {\n             throw new IllegalArgumentException(\"An empty path was provided!\");\n         }\n \n-        String key = determinePathCacheKey(tenantId, path);\n+        String key = determinePathCacheKey(tenantId, sanitizedPath);\n         Blob blob = blobByPathCache.get(key);\n         if (blob == null) {\n-            blobByPathCache.remove(key);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0d8871ad99b32c2b9c7fda4b74137fd16291827"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d32fdbfe350e3f58a3d0cc441b701752f6167015", "author": {"user": {"login": "jmuscireum", "name": null}}, "url": "https://github.com/scireum/sirius-biz/commit/d32fdbfe350e3f58a3d0cc441b701752f6167015", "committedDate": "2020-12-08T13:01:14Z", "message": "Invalidate the old cache entry again before adding the new one\n\nThis is required as we need to invalidate the entry on all nodes. The\nput is only executed on the current node. Also this time we add a\ncomment so it's not removed again.\n\nFixes: SIRI-286"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MjExOTIy", "url": "https://github.com/scireum/sirius-biz/pull/939#pullrequestreview-547211922", "createdAt": "2020-12-08T13:02:25Z", "commit": {"oid": "d32fdbfe350e3f58a3d0cc441b701752f6167015"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MjEyMjYw", "url": "https://github.com/scireum/sirius-biz/pull/939#pullrequestreview-547212260", "createdAt": "2020-12-08T13:02:50Z", "commit": {"oid": "d32fdbfe350e3f58a3d0cc441b701752f6167015"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4284, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}