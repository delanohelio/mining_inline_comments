{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2OTQ3ODIz", "number": 870, "title": "Enables XSD validation for XML Export Jobs", "bodyText": "Fixes: SIRI-255", "createdAt": "2020-10-02T14:35:25Z", "url": "https://github.com/scireum/sirius-biz/pull/870", "merged": true, "mergeCommit": {"oid": "f73c3ca6e0252c012f92d85ecaaf95750a7d911d"}, "closed": true, "closedAt": "2020-10-05T14:43:05Z", "author": {"login": "idlira"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOPqhoAH2gAyNDk2OTQ3ODIzOmE1NmJhYmUwNThjYjU1NWU5ZmQyYTcwMWQzZjBkYmY4MDkxYjk2MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPkxfGAFqTUwMjEyMjkxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a56babe058cb555e9fd2a701d3f0dbf8091b9616", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/a56babe058cb555e9fd2a701d3f0dbf8091b9616", "committedDate": "2020-10-01T11:27:12Z", "message": "Adds the XML export job class from scireum-core\n\nFixes: SIRI-255"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f90b0d546fb235aafde5227fa05582033ee3e503", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/f90b0d546fb235aafde5227fa05582033ee3e503", "committedDate": "2020-10-02T14:02:11Z", "message": "Adds method to get the inputstream to a file in the process\n\nFixes: SIRI-255"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "618c449060eba3ab818a869107ae362d339a8bc2", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/618c449060eba3ab818a869107ae362d339a8bc2", "committedDate": "2020-10-02T14:04:41Z", "message": "Adds a method to digest the exported file\n\nFixes: SIRI-255"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4374ed709ecc7ee615d7679b52c4930991e6a60d", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/4374ed709ecc7ee615d7679b52c4930991e6a60d", "committedDate": "2020-10-02T14:05:05Z", "message": "Adds a method to digest the exported entries of an archive export\n\nFixes: SIRI-255"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "423235f0b390788dad5111e98bb5f0768a74e719", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/423235f0b390788dad5111e98bb5f0768a74e719", "committedDate": "2020-10-02T14:33:50Z", "message": "Enables XSD validation on export jobs\n\nFixes: SIRI-255"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMTk0MjAx", "url": "https://github.com/scireum/sirius-biz/pull/870#pullrequestreview-501194201", "createdAt": "2020-10-02T14:39:51Z", "commit": {"oid": "423235f0b390788dad5111e98bb5f0768a74e719"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNDozOTo1MVrOHbwOHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNDozOTo1MVrOHbwOHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2MzY0NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Note that it the responsibility of the caller to close the stream upon usage.\n          \n          \n            \n                 * Note that it is the responsibility of the caller to close the stream upon usage.", "url": "https://github.com/scireum/sirius-biz/pull/870#discussion_r498863645", "createdAt": "2020-10-02T14:39:51Z", "author": {"login": "bwiedmann"}, "path": "src/main/java/sirius/biz/process/Processes.java", "diffHunk": "@@ -631,6 +633,24 @@ public OutputStream addFile(String processId, String filename) {\n         return process.getFiles().findOrCreateAttachedBlobByName(filename).createOutputStream(filename);\n     }\n \n+    /**\n+     * Returns an input stream to a file stored in the process.\n+     * <p>\n+     * Note that it the responsibility of the caller to close the stream upon usage.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "423235f0b390788dad5111e98bb5f0768a74e719"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "402ea5bb53185e0ef089b882b03328aa2d2229bd", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/402ea5bb53185e0ef089b882b03328aa2d2229bd", "committedDate": "2020-10-02T14:46:00Z", "message": "Update src/main/java/sirius/biz/process/Processes.java\n\nCo-authored-by: Benjamin Wiedmann <bwi@scireum.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjAxNTky", "url": "https://github.com/scireum/sirius-biz/pull/870#pullrequestreview-501201592", "createdAt": "2020-10-02T14:48:24Z", "commit": {"oid": "402ea5bb53185e0ef089b882b03328aa2d2229bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNzgxMzcy", "url": "https://github.com/scireum/sirius-biz/pull/870#pullrequestreview-501781372", "createdAt": "2020-10-05T07:27:11Z", "commit": {"oid": "402ea5bb53185e0ef089b882b03328aa2d2229bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxOTQyMjgy", "url": "https://github.com/scireum/sirius-biz/pull/870#pullrequestreview-501942282", "createdAt": "2020-10-05T11:01:11Z", "commit": {"oid": "402ea5bb53185e0ef089b882b03328aa2d2229bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMTowMToxMVrOHcX8yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMTowMToxMVrOHcX8yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUxNDU2OQ==", "bodyText": "Careful: super.close may throw an exception, in which case the digestExportedFile wont get executed", "url": "https://github.com/scireum/sirius-biz/pull/870#discussion_r499514569", "createdAt": "2020-10-05T11:01:11Z", "author": {"login": "qw3ry"}, "path": "src/main/java/sirius/biz/jobs/batch/file/XMLExportJob.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.jobs.batch.file;\n+\n+import sirius.biz.process.ProcessContext;\n+import sirius.biz.storage.layer3.FileOrDirectoryParameter;\n+import sirius.kernel.di.std.Part;\n+import sirius.kernel.health.Exceptions;\n+import sirius.kernel.xml.XMLStructuredOutput;\n+import sirius.web.resources.Resource;\n+import sirius.web.resources.Resources;\n+\n+import javax.annotation.Nonnull;\n+import javax.xml.transform.Source;\n+import javax.xml.transform.stream.StreamSource;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+\n+/**\n+ * Provides basic functionalities to write data into XML file entries inside an archive.\n+ */\n+public abstract class XMLExportJob extends ArchiveExportJob {\n+\n+    @Part\n+    private static Resources resources;\n+\n+    private final boolean requireValidFile;\n+    private final String xsdResourcePath;\n+    protected XMLStructuredOutput xml;\n+    private OutputStream xmlOutputStream;\n+\n+    /**\n+     * Creates a new job for the given process context.\n+     *\n+     * @param destinationParameter the parameter used to select the destination for the file being written\n+     * @param process              the context in which the process will be executed\n+     */\n+    protected XMLExportJob(@Nonnull XMLExportJobFactory factory,\n+                           FileOrDirectoryParameter destinationParameter,\n+                           ProcessContext process) {\n+        super(destinationParameter, process);\n+        requireValidFile = process.getParameter(factory.requireValidFile).orElse(false);\n+        xsdResourcePath = factory.getXsdResourcePath();\n+    }\n+\n+    protected void initializeXmlFile(String filename) throws IOException {\n+        closeOpenStream();\n+        xmlOutputStream = createEntry(filename);\n+        xml = new XMLStructuredOutput(xmlOutputStream);\n+    }\n+\n+    @Override\n+    public void close() throws IOException {\n+        closeOpenStream();\n+        super.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "402ea5bb53185e0ef089b882b03328aa2d2229bd"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxOTQ3MTMy", "url": "https://github.com/scireum/sirius-biz/pull/870#pullrequestreview-501947132", "createdAt": "2020-10-05T11:08:39Z", "commit": {"oid": "402ea5bb53185e0ef089b882b03328aa2d2229bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxOTcyMTcy", "url": "https://github.com/scireum/sirius-biz/pull/870#pullrequestreview-501972172", "createdAt": "2020-10-05T11:45:02Z", "commit": {"oid": "402ea5bb53185e0ef089b882b03328aa2d2229bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMTo0NTowM1rOHcZVZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMTo0NTowM1rOHcZVZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUzNzI1NQ==", "bodyText": "why should this be overwritten?\nwhen is this invoked where?", "url": "https://github.com/scireum/sirius-biz/pull/870#discussion_r499537255", "createdAt": "2020-10-05T11:45:03Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/jobs/batch/file/ArchiveExportJob.java", "diffHunk": "@@ -79,5 +83,28 @@ protected void collectParameters(Consumer<Parameter<?, ?>> parameterCollector) {\n             super.collectParameters(parameterCollector);\n         }\n     }\n+\n+    /**\n+     * Digests every entry of a fresh created export archive.\n+     * <p>\n+     * Override this method in order to perform validations on contents of the final archive.\n+     *\n+     * @param digester a consumer receiving the name and the {@link InputStream} of each entry\n+     */\n+    protected void digestExportedFile(BiConsumer<String, InputStream> digester) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "402ea5bb53185e0ef089b882b03328aa2d2229bd"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f54128af45b567b5154cc01a72d04904270a0cef", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/f54128af45b567b5154cc01a72d04904270a0cef", "committedDate": "2020-10-05T12:27:58Z", "message": "Corrects JavaDoc\n\nMethods weren't meant to be overwritten but simply called if needed.\n\nSIRI-255"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMTIyOTE5", "url": "https://github.com/scireum/sirius-biz/pull/870#pullrequestreview-502122919", "createdAt": "2020-10-05T14:36:44Z", "commit": {"oid": "f54128af45b567b5154cc01a72d04904270a0cef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4184, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}