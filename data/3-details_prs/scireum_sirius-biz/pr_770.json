{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3NjMyNzA4", "number": 770, "title": "SE-9718 Adds a cache for resolving blobs by path", "bodyText": "", "createdAt": "2020-06-04T07:06:11Z", "url": "https://github.com/scireum/sirius-biz/pull/770", "merged": true, "mergeCommit": {"oid": "35de90282f6ff5dc2b43a410b3725adc9a062f59"}, "closed": true, "closedAt": "2020-06-04T13:44:53Z", "author": {"login": "jmuscireum"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcn4KbQAH2gAyNDI3NjMyNzA4OmE0MmJjNjdlZjA3MWY0OWViNTQxMzkxZWQzZTM3OTJiOWFiODk4MDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn-TjaAFqTQyNDQ2MzcyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a42bc67ef071f49eb541391ed3e3792b9ab89801", "author": {"user": {"login": "jmuscireum", "name": null}}, "url": "https://github.com/scireum/sirius-biz/commit/a42bc67ef071f49eb541391ed3e3792b9ab89801", "committedDate": "2020-06-04T06:35:12Z", "message": "Adds a cache for resolving blobs by path\n\nBecause S2 needs to resolve files for public viewing using the path,\nthis leads to a lot of database lookups. To counter this we now employ\na cache.\n\nFixes: SE-9718"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ff2c509de602ab217e51254d48d72d8ab821de1", "author": {"user": {"login": "jmuscireum", "name": null}}, "url": "https://github.com/scireum/sirius-biz/commit/1ff2c509de602ab217e51254d48d72d8ab821de1", "committedDate": "2020-06-04T07:01:09Z", "message": "Moves the deletes into the abstract class\n\nThis allows the cache handling to happen in one place.\n\nFixes: SE-9718"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071", "author": {"user": {"login": "jmuscireum", "name": null}}, "url": "https://github.com/scireum/sirius-biz/commit/754b8a4b443a5273f4ec82304a3c9b17160a6071", "committedDate": "2020-06-04T07:01:50Z", "message": "Also clear the path cache when updating a blob\n\nThis might update the filename. Thus we need to clear the cache.\n\nFixes: SE-9718"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MTY1MTUz", "url": "https://github.com/scireum/sirius-biz/pull/770#pullrequestreview-424165153", "createdAt": "2020-06-04T07:19:37Z", "commit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MTcwMTEz", "url": "https://github.com/scireum/sirius-biz/pull/770#pullrequestreview-424170113", "createdAt": "2020-06-04T07:25:33Z", "commit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzoyNTozM1rOGe5FqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzoyNTozM1rOGe5FqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0NTgwMQ==", "bodyText": "shouldn't the bucket name be in here somewhere?", "url": "https://github.com/scireum/sirius-biz/pull/770#discussion_r435045801", "createdAt": "2020-06-04T07:25:33Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/layer2/BasicBlobStorageSpace.java", "diffHunk": "@@ -298,6 +313,13 @@ public Directory getRoot(String tenantId) {\n         if (Strings.isEmpty(path)) {\n             return Optional.empty();\n         }\n+\n+        String cacheKey = tenantId + \"-\" + ensureRelativePath(path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MTcwOTE0", "url": "https://github.com/scireum/sirius-biz/pull/770#pullrequestreview-424170914", "createdAt": "2020-06-04T07:26:41Z", "commit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzoyNjo0MlrOGe5IDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzoyNjo0MlrOGe5IDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0NjQxMw==", "bodyText": "looks redundant to the code above", "url": "https://github.com/scireum/sirius-biz/pull/770#discussion_r435046413", "createdAt": "2020-06-04T07:26:42Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/layer2/BasicBlobStorageSpace.java", "diffHunk": "@@ -332,6 +354,12 @@ public Blob findOrCreateByPath(String tenantId, String path) {\n             throw new IllegalArgumentException(\"An empty path was provided!\");\n         }\n \n+        String cacheKey = tenantId + \"-\" + ensureRelativePath(path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MTcxMzc1", "url": "https://github.com/scireum/sirius-biz/pull/770#pullrequestreview-424171375", "createdAt": "2020-06-04T07:27:22Z", "commit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzoyNzoyMlrOGe5Jbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzoyNzoyMlrOGe5Jbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0Njc2Nw==", "bodyText": "is this intentionally exposed as public. the official way is Directory.delete()", "url": "https://github.com/scireum/sirius-biz/pull/770#discussion_r435046767", "createdAt": "2020-06-04T07:27:22Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/layer2/BasicBlobStorageSpace.java", "diffHunk": "@@ -701,6 +730,24 @@ private void handleTenantMismatch(Object objectToModify, D newParent) {\n                         .handle();\n     }\n \n+    /**\n+     * Deletes the given directory.\n+     *\n+     * @param directory the directory to delete\n+     */\n+    public void deleteDirectory(D directory) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MTcxNjYz", "url": "https://github.com/scireum/sirius-biz/pull/770#pullrequestreview-424171663", "createdAt": "2020-06-04T07:27:45Z", "commit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzoyNzo0NVrOGe5KVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzoyNzo0NVrOGe5KVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0Njk5OA==", "bodyText": "s.a. Blob.delete()", "url": "https://github.com/scireum/sirius-biz/pull/770#discussion_r435046998", "createdAt": "2020-06-04T07:27:45Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/layer2/BasicBlobStorageSpace.java", "diffHunk": "@@ -770,6 +821,24 @@ public void move(B blob, @Nullable D newParent) {\n      */\n     protected abstract void updateBlobParent(B blob, D newParent);\n \n+    /**\n+     * Deletes the given blob.\n+     *\n+     * @param blob the blob to delete\n+     */\n+    public void delete(B blob) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071"}, "originalPosition": 131}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MTcyNDkz", "url": "https://github.com/scireum/sirius-biz/pull/770#pullrequestreview-424172493", "createdAt": "2020-06-04T07:28:58Z", "commit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzoyODo1OFrOGe5NLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzoyODo1OFrOGe5NLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0NzcyNA==", "bodyText": "only if name changes?", "url": "https://github.com/scireum/sirius-biz/pull/770#discussion_r435047724", "createdAt": "2020-06-04T07:28:58Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/layer2/BasicBlobStorageSpace.java", "diffHunk": "@@ -841,6 +912,8 @@ public void updateContent(B blob, @Nullable String filename, File file) {\n                 blob.fetchVariants().forEach(BlobVariant::delete);\n                 getPhysicalSpace().delete(previousPhysicalId.get());\n             }\n+\n+            blobByPathCache.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071"}, "originalPosition": 162}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MTcyNTY5", "url": "https://github.com/scireum/sirius-biz/pull/770#pullrequestreview-424172569", "createdAt": "2020-06-04T07:29:04Z", "commit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzoyOTowNVrOGe5Nbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzoyOTowNVrOGe5Nbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0Nzc5MQ==", "bodyText": "s.a.", "url": "https://github.com/scireum/sirius-biz/pull/770#discussion_r435047791", "createdAt": "2020-06-04T07:29:05Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/layer2/BasicBlobStorageSpace.java", "diffHunk": "@@ -891,6 +964,8 @@ public void updateContent(B blob, String filename, InputStream data, long conten\n                 blob.fetchVariants().forEach(BlobVariant::delete);\n                 getPhysicalSpace().delete(previousPhysicalId.get());\n             }\n+\n+            blobByPathCache.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071"}, "originalPosition": 171}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MTczNTkw", "url": "https://github.com/scireum/sirius-biz/pull/770#pullrequestreview-424173590", "createdAt": "2020-06-04T07:30:34Z", "commit": {"oid": "754b8a4b443a5273f4ec82304a3c9b17160a6071"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2593500d818c0c13aa4417fbd77693fb9135eb99", "author": {"user": {"login": "jmuscireum", "name": null}}, "url": "https://github.com/scireum/sirius-biz/commit/2593500d818c0c13aa4417fbd77693fb9135eb99", "committedDate": "2020-06-04T09:04:24Z", "message": "Also use the space name inside the cache key\n\nThe space name needs to be part of the key, as there might be files\nwith the same path in different spaces.\n\nFixes: SE-9718"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef0d3c450dd92b0018a36428753d172c45638030", "author": {"user": {"login": "jmuscireum", "name": null}}, "url": "https://github.com/scireum/sirius-biz/commit/ef0d3c450dd92b0018a36428753d172c45638030", "committedDate": "2020-06-04T09:05:12Z", "message": "Only clear the cache when updating a blob if the name was changed\n\nFixes: SE-9718"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MzQ2ODcy", "url": "https://github.com/scireum/sirius-biz/pull/770#pullrequestreview-424346872", "createdAt": "2020-06-04T11:25:59Z", "commit": {"oid": "ef0d3c450dd92b0018a36428753d172c45638030"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MzcxNDE2", "url": "https://github.com/scireum/sirius-biz/pull/770#pullrequestreview-424371416", "createdAt": "2020-06-04T12:02:50Z", "commit": {"oid": "ef0d3c450dd92b0018a36428753d172c45638030"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NDYzNzI2", "url": "https://github.com/scireum/sirius-biz/pull/770#pullrequestreview-424463726", "createdAt": "2020-06-04T13:44:36Z", "commit": {"oid": "ef0d3c450dd92b0018a36428753d172c45638030"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4306, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}