{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0NjU0NTcz", "number": 741, "title": "Improves alias handling and permits to suppress tenant checks.", "bodyText": "", "createdAt": "2020-05-07T12:28:46Z", "url": "https://github.com/scireum/sirius-biz/pull/741", "merged": true, "mergeCommit": {"oid": "8783bab291cd0e5ed841b98ec4f5772cd4e5183e"}, "closed": true, "closedAt": "2020-05-20T07:18:56Z", "author": {"login": "andyHa"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABce8FU-AH2gAyNDE0NjU0NTczOmE2MjlmYjYxNmU2MDZhYTEzMGE0YTM2YTA5YWNjNDIwNTk2NzZiODA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABciy3ExgBqjMzNTE0MDI2NzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a629fb616e606aa130a4a36a09acc42059676b80", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/a629fb616e606aa130a4a36a09acc42059676b80", "committedDate": "2020-05-07T12:03:56Z", "message": "Centralizes alias handling.\n\nWe now always add the name and label of a field as an alias\ninto the import handler. This was previously performed in the\nBaseImportHandler when also loading the aliases from the\nconfig.\n\nHowever, this doesn't work for manually created aliases,\ntherefore this was moved into the dictionary itself.\n\nWe also keep the aliases in an non-normalized state for reporting\nthem to the user in a proper way.\n\nFinally, we only report a fatal alias error, if the alias points to another\nfield. Everything else is only reported if a config error is present in the\nsystem configuration."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06806f9f26087414217988c8f0c2f3c6ce875b46", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/06806f9f26087414217988c8f0c2f3c6ce875b46", "committedDate": "2020-05-07T12:04:24Z", "message": "Removes an unnecessary parameter and moves a method to its proper location."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52855e2f941d1dead7352c0d18a9bb0e5fc34e0d", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/52855e2f941d1dead7352c0d18a9bb0e5fc34e0d", "committedDate": "2020-05-07T12:25:45Z", "message": "Moves a method into the real implementation classes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97098d7763c9a01a76f13f720eb356bb317dc2f0", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/97098d7763c9a01a76f13f720eb356bb317dc2f0", "committedDate": "2020-05-07T12:27:00Z", "message": "Permits to skip the tenant checks when importing TenantAware entities.\n\nSometimes special jobs / tasks require to modify data of a child or parent tenant,\nor in the case of the system tenant, of any other tenant. Therefore the framework\ncan be requested to skip then tenant check."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acc16219be3643447fed0b07bf3961721ab58116", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/acc16219be3643447fed0b07bf3961721ab58116", "committedDate": "2020-05-07T12:28:09Z", "message": "Removes a tricky check suppression.\n\nNow each job requiring this behavior can call .skipTenantChecks\non the modified entities."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NDI5MDMy", "url": "https://github.com/scireum/sirius-biz/pull/741#pullrequestreview-407429032", "createdAt": "2020-05-07T12:39:04Z", "commit": {"oid": "acc16219be3643447fed0b07bf3961721ab58116"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4ODk2Nzc0", "url": "https://github.com/scireum/sirius-biz/pull/741#pullrequestreview-408896774", "createdAt": "2020-05-11T06:40:49Z", "commit": {"oid": "acc16219be3643447fed0b07bf3961721ab58116"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwODc1ODE0", "url": "https://github.com/scireum/sirius-biz/pull/741#pullrequestreview-410875814", "createdAt": "2020-05-13T12:33:30Z", "commit": {"oid": "acc16219be3643447fed0b07bf3961721ab58116"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNTIyMTYx", "url": "https://github.com/scireum/sirius-biz/pull/741#pullrequestreview-412522161", "createdAt": "2020-05-15T10:16:21Z", "commit": {"oid": "acc16219be3643447fed0b07bf3961721ab58116"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMDoxNjoyMVrOGV--Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMDoxNjo1MVrOGV-_YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcwNTAzOA==", "bodyText": "Die Fehlermeldung passt nicht! Das alte alias wird ja ersetzt...", "url": "https://github.com/scireum/sirius-biz/pull/741#discussion_r425705038", "createdAt": "2020-05-15T10:16:21Z", "author": {"login": "qw3ry"}, "path": "src/main/java/sirius/biz/importer/format/ImportDictionary.java", "diffHunk": "@@ -83,17 +83,24 @@ public ImportDictionary addField(FieldDefinition field) {\n \n         this.fields.put(field.getName(), field);\n \n-        for (String alias : field.getAliases()) {\n-            if (aliases.containsKey(alias)) {\n-                throw new IllegalArgumentException(Strings.apply(\"An alias named '%s' is already present!\", alias));\n-            }\n-\n-            aliases.put(alias, field.getName());\n-        }\n+        addCheckedAlias(field, field.getName());\n+        addCheckedAlias(field, field.getLabel());\n+        field.getAliases().forEach(alias -> addCheckedAlias(field, alias));\n \n         return this;\n     }\n \n+    private void addCheckedAlias(FieldDefinition field, String alias) {\n+        String previousField = aliases.put(normalize(alias), field.getName());\n+        if (Strings.isFilled(previousField) && !Strings.areEqual(field.getName(), previousField)) {\n+            throw new IllegalArgumentException(Strings.apply(\n+                    \"Cannot add alias '%s' for field '%s', as this alias already points to '%s'!\",\n+                    alias,\n+                    field.getName(),\n+                    previousField));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acc16219be3643447fed0b07bf3961721ab58116"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcwNTMxMw==", "bodyText": "also entweder putIfAbsent oder Fehlermeldung anpassen", "url": "https://github.com/scireum/sirius-biz/pull/741#discussion_r425705313", "createdAt": "2020-05-15T10:16:51Z", "author": {"login": "qw3ry"}, "path": "src/main/java/sirius/biz/importer/format/ImportDictionary.java", "diffHunk": "@@ -83,17 +83,24 @@ public ImportDictionary addField(FieldDefinition field) {\n \n         this.fields.put(field.getName(), field);\n \n-        for (String alias : field.getAliases()) {\n-            if (aliases.containsKey(alias)) {\n-                throw new IllegalArgumentException(Strings.apply(\"An alias named '%s' is already present!\", alias));\n-            }\n-\n-            aliases.put(alias, field.getName());\n-        }\n+        addCheckedAlias(field, field.getName());\n+        addCheckedAlias(field, field.getLabel());\n+        field.getAliases().forEach(alias -> addCheckedAlias(field, alias));\n \n         return this;\n     }\n \n+    private void addCheckedAlias(FieldDefinition field, String alias) {\n+        String previousField = aliases.put(normalize(alias), field.getName());\n+        if (Strings.isFilled(previousField) && !Strings.areEqual(field.getName(), previousField)) {\n+            throw new IllegalArgumentException(Strings.apply(\n+                    \"Cannot add alias '%s' for field '%s', as this alias already points to '%s'!\",\n+                    alias,\n+                    field.getName(),\n+                    previousField));\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcwNTAzOA=="}, "originalCommit": {"oid": "acc16219be3643447fed0b07bf3961721ab58116"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7ecf66e265191c965a3960952dc5c932def5875", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/f7ecf66e265191c965a3960952dc5c932def5875", "committedDate": "2020-05-19T11:33:12Z", "message": "Only adds an alias if none is present."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b93e6511f16a611c620e8497e7b2737f3e12d573", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/b93e6511f16a611c620e8497e7b2737f3e12d573", "committedDate": "2020-05-19T11:33:36Z", "message": "Merge remote-tracking branch 'origin/master' into aha/field-aliases-fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91fe7f1b0f5c341fe079df306bd0178d41ef1891", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/91fe7f1b0f5c341fe079df306bd0178d41ef1891", "committedDate": "2020-05-19T11:30:50Z", "message": "Updates a warning to match the changed behavior.\n\nWe still prefer to overwrite the alias as it is way more\nefficient for the common case (no conflict). Also it is\na bug / problem anyway, so there is no \"correct behavior\"."}, "afterCommit": {"oid": "b93e6511f16a611c620e8497e7b2737f3e12d573", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/b93e6511f16a611c620e8497e7b2737f3e12d573", "committedDate": "2020-05-19T11:33:36Z", "message": "Merge remote-tracking branch 'origin/master' into aha/field-aliases-fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4466, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}