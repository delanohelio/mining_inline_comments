{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2NzA3Nzc5", "number": 900, "title": "BREAKING: Valid languages for Translations are now customizable", "bodyText": "Translations used the same property value for supportedLanguages as MLS did. This value is removed in scireum/sirius-db#377.\nSimilar to the changes in that PR, Translations now also provide a constructor with a custom set of valid language codes. If that set is empty, all language codes are accepted.\nNOTE: marked as breaking due to the changed behavior with an empty set. Translations are not actively used yet, so no other areas are currently affected.\nFixes: SIRI-240", "createdAt": "2020-11-06T12:16:26Z", "url": "https://github.com/scireum/sirius-biz/pull/900", "merged": true, "mergeCommit": {"oid": "aef7b1bf10cd3e36c5b3a2e4b2753f668fe59b1a"}, "closed": true, "closedAt": "2020-12-17T16:00:02Z", "author": {"login": "cschierle"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ1xx6gH2gAyNTE2NzA3Nzc5OjFjMjgxZjQxOWQ4YTM3ZWI0MDY0MzMzNjAwZDkwNzRiOGM4YmE3NTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnDBSOAFqTU1NDU3Mzc5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1c281f419d8a37eb4064333600d9074b8c8ba752", "author": {"user": {"login": "cschierle", "name": "Christian Schierle"}}, "url": "https://github.com/scireum/sirius-biz/commit/1c281f419d8a37eb4064333600d9074b8c8ba752", "committedDate": "2020-11-06T12:04:41Z", "message": "Makes valid languages customizable\n\nFixes: SIRI-240"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2beaee37532e04174099294a23c4565cebac44a8", "author": {"user": {"login": "cschierle", "name": "Christian Schierle"}}, "url": "https://github.com/scireum/sirius-biz/commit/2beaee37532e04174099294a23c4565cebac44a8", "committedDate": "2020-11-06T12:05:11Z", "message": "Adds exception text\n\nFixes: SIRI-243"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e0c75751eab2f7f6589165396b1bced8032de1c", "author": {"user": {"login": "cschierle", "name": "Christian Schierle"}}, "url": "https://github.com/scireum/sirius-biz/commit/0e0c75751eab2f7f6589165396b1bced8032de1c", "committedDate": "2020-11-06T12:05:50Z", "message": "Adds test cases\n\nFixes: SIRI-243"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f7d6a64046929bed3d259a95eeb4b23ef6a6c1a", "author": {"user": {"login": "cschierle", "name": "Christian Schierle"}}, "url": "https://github.com/scireum/sirius-biz/commit/6f7d6a64046929bed3d259a95eeb4b23ef6a6c1a", "committedDate": "2020-11-06T12:06:54Z", "message": "Merge branch 'master' into csc/SIRI-240_MultiLangCheck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3142259ffd92cf6d7c35524a88bd4f1082a172c", "author": {"user": {"login": "cschierle", "name": "Christian Schierle"}}, "url": "https://github.com/scireum/sirius-biz/commit/c3142259ffd92cf6d7c35524a88bd4f1082a172c", "committedDate": "2020-11-06T12:24:23Z", "message": "Restricts translations to supported languages\n\nFixes: SIRI-243"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MTMxODY4", "url": "https://github.com/scireum/sirius-biz/pull/900#pullrequestreview-525131868", "createdAt": "2020-11-06T13:06:14Z", "commit": {"oid": "c3142259ffd92cf6d7c35524a88bd4f1082a172c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72ee9d23dc0860c880627b0076b534d05db5e680", "author": {"user": {"login": "cschierle", "name": "Christian Schierle"}}, "url": "https://github.com/scireum/sirius-biz/commit/72ee9d23dc0860c880627b0076b534d05db5e680", "committedDate": "2020-11-12T07:51:30Z", "message": "Code style\n\nFixes: SIRI-240"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4ODc1MjAw", "url": "https://github.com/scireum/sirius-biz/pull/900#pullrequestreview-528875200", "createdAt": "2020-11-12T09:00:39Z", "commit": {"oid": "72ee9d23dc0860c880627b0076b534d05db5e680"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNDk1Njg3", "url": "https://github.com/scireum/sirius-biz/pull/900#pullrequestreview-533495687", "createdAt": "2020-11-18T14:24:13Z", "commit": {"oid": "72ee9d23dc0860c880627b0076b534d05db5e680"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MTg3NzY4", "url": "https://github.com/scireum/sirius-biz/pull/900#pullrequestreview-535187768", "createdAt": "2020-11-20T07:57:18Z", "commit": {"oid": "72ee9d23dc0860c880627b0076b534d05db5e680"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0b3feec5ec8bc25018484958afea0159b494c00", "author": {"user": {"login": "cschierle", "name": "Christian Schierle"}}, "url": "https://github.com/scireum/sirius-biz/commit/c0b3feec5ec8bc25018484958afea0159b494c00", "committedDate": "2020-12-16T15:08:51Z", "message": "Improves handling of invalid language codes\n\nFixes: SIRI-240"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2dbd64fc535bbad1c130119c082cf23ac73583d", "author": {"user": {"login": "cschierle", "name": "Christian Schierle"}}, "url": "https://github.com/scireum/sirius-biz/commit/b2dbd64fc535bbad1c130119c082cf23ac73583d", "committedDate": "2020-12-16T15:09:02Z", "message": "Typo in NLS key\n\nFixes: SIRI-240"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNzkxNTAx", "url": "https://github.com/scireum/sirius-biz/pull/900#pullrequestreview-553791501", "createdAt": "2020-12-16T15:19:18Z", "commit": {"oid": "b2dbd64fc535bbad1c130119c082cf23ac73583d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNToxOToxOFrOIHKiHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNToxOToxOFrOIHKiHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM4MzUxNg==", "bodyText": "Validity check for languages is already performed during the creation of a Translation entity.\nDouble-checking when getting texts with invalid (or differently spelled) language codes currently leads to exceptions making affected pages unusable. Removed the check, since returning an empty Optional is sufficient here and keeps pages functional.", "url": "https://github.com/scireum/sirius-biz/pull/900#discussion_r544383516", "createdAt": "2020-12-16T15:19:18Z", "author": {"login": "cschierle"}, "path": "src/main/java/sirius/biz/translations/BasicTranslations.java", "diffHunk": "@@ -142,14 +178,8 @@ public void updateText(@Nonnull Mapping field, String lang, String text) {\n      * @param field {@link Mapping} of the translated field\n      * @param lang  language code\n      * @return {@link Optional} with translated text for the given language, or empty if none is found\n-     * @throws IllegalArgumentException if lang is not supported by the system\n      */\n     public Optional<String> getText(@Nonnull Mapping field, String lang) {\n-        if (!isSupportedLanguage(lang)) {\n-            throw new IllegalArgumentException(\n-                    \"lang must be a language code supported by the system (supportedLanguages)!\");\n-        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2dbd64fc535bbad1c130119c082cf23ac73583d"}, "originalPosition": 125}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NDQ0NDcw", "url": "https://github.com/scireum/sirius-biz/pull/900#pullrequestreview-554444470", "createdAt": "2020-12-17T09:57:37Z", "commit": {"oid": "b2dbd64fc535bbad1c130119c082cf23ac73583d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NDQ1Nzkx", "url": "https://github.com/scireum/sirius-biz/pull/900#pullrequestreview-554445791", "createdAt": "2020-12-17T09:59:10Z", "commit": {"oid": "c0b3feec5ec8bc25018484958afea0159b494c00"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwOTo1OToxMFrOIHtq9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwOTo1OToxMFrOIHtq9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk1OTIyMQ==", "bodyText": "Humm, JournalData is not really the place to log errors.", "url": "https://github.com/scireum/sirius-biz/pull/900#discussion_r544959221", "createdAt": "2020-12-17T09:59:10Z", "author": {"login": "idlira"}, "path": "src/main/java/sirius/biz/translations/BasicTranslations.java", "diffHunk": "@@ -111,15 +112,23 @@ public void updateText(@Nonnull Mapping field, String lang, String text) {\n         }\n \n         T translation = findOrCreateTranslation(field, lang, text);\n-        translation.getTranslationData().setText(text);\n-        updateTranslation(translation);\n-\n-        if (owner instanceof Journaled) {\n+        if (translation != null) {\n+            translation.getTranslationData().setText(text);\n+            updateTranslation(translation);\n+            if (owner instanceof Journaled) {\n+                JournalData.addJournalEntry(owner,\n+                                            String.format(\"Updated translated text for %s (%s): '%s'\",\n+                                                          field.getName(),\n+                                                          lang,\n+                                                          text));\n+            }\n+        } else if (owner instanceof Journaled) {\n             JournalData.addJournalEntry(owner,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0b3feec5ec8bc25018484958afea0159b494c00"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NDQ3OTMw", "url": "https://github.com/scireum/sirius-biz/pull/900#pullrequestreview-554447930", "createdAt": "2020-12-17T10:01:44Z", "commit": {"oid": "b2dbd64fc535bbad1c130119c082cf23ac73583d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "233a0874be91cfbfb0e49f403e5dcc386a252a92", "author": {"user": {"login": "cschierle", "name": "Christian Schierle"}}, "url": "https://github.com/scireum/sirius-biz/commit/233a0874be91cfbfb0e49f403e5dcc386a252a92", "committedDate": "2020-12-17T10:21:10Z", "message": "Reverts unnecessary journal entry\n\nFixes: SIRI-240"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NDc5MTM0", "url": "https://github.com/scireum/sirius-biz/pull/900#pullrequestreview-554479134", "createdAt": "2020-12-17T10:40:51Z", "commit": {"oid": "233a0874be91cfbfb0e49f403e5dcc386a252a92"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NTQ5MjU5", "url": "https://github.com/scireum/sirius-biz/pull/900#pullrequestreview-554549259", "createdAt": "2020-12-17T12:17:11Z", "commit": {"oid": "233a0874be91cfbfb0e49f403e5dcc386a252a92"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMjoxNzoxMVrOIHy9Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMjoxODowMFrOIHy-7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA0NTc4Mg==", "bodyText": "this is very unexpected behavior - isXXX returning true/false should never throw instead of returning false.\nRename to \"assert / ensureValidLanguage\" and remove return type?", "url": "https://github.com/scireum/sirius-biz/pull/900#discussion_r545045782", "createdAt": "2020-12-17T12:17:11Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/translations/BasicTranslations.java", "diffHunk": "@@ -58,11 +74,23 @@ protected BasicTranslations(BaseEntity<?> owner) {\n     /**\n      * Provides a validator so translations can only be added for supported languages.\n      *\n-     * @param lang the language code in question\n+     * @param lang  the language code in question\n+     * @param field the name of the field to be translated\n      * @return true if language is supported by the system, false otherwise\n+     * @throws sirius.kernel.health.HandledException if lang is not supported by the system\n      */\n-    protected boolean isSupportedLanguage(String lang) {\n-        return supportedLanguages.contains(lang);\n+    protected boolean isValidLanguage(String lang, String field) {\n+        boolean isSupported = validLanguages.isEmpty() || validLanguages.contains(lang);\n+\n+        if (!isSupported) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "233a0874be91cfbfb0e49f403e5dcc386a252a92"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA0NjE4NQ==", "bodyText": "unreachable code", "url": "https://github.com/scireum/sirius-biz/pull/900#discussion_r545046185", "createdAt": "2020-12-17T12:17:52Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/translations/jdbc/SQLTranslations.java", "diffHunk": "@@ -102,9 +114,8 @@ public void deleteAllTexts(@Nonnull Mapping field) {\n \n     @Override\n     protected SQLTranslation findOrCreateTranslation(@Nonnull Mapping field, String lang, String text) {\n-        if (!isSupportedLanguage(lang)) {\n-            throw new IllegalArgumentException(\n-                    \"lang must be a language code supported by the system (supportedLanguages)!\");\n+        if (!isValidLanguage(lang, field.getName())) {\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "233a0874be91cfbfb0e49f403e5dcc386a252a92"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA0NjI1NQ==", "bodyText": "s.a.", "url": "https://github.com/scireum/sirius-biz/pull/900#discussion_r545046255", "createdAt": "2020-12-17T12:18:00Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/translations/mongo/MongoTranslations.java", "diffHunk": "@@ -71,9 +83,8 @@ public void deleteAllTexts(@Nonnull Mapping field) {\n \n     @Override\n     protected MongoTranslation findOrCreateTranslation(@Nonnull Mapping field, String lang, String text) {\n-        if (!isSupportedLanguage(lang)) {\n-            throw new IllegalArgumentException(\n-                    \"lang must be a language code supported by the system (supportedLanguages)!\");\n+        if (!isValidLanguage(lang, field.getName())) {\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "233a0874be91cfbfb0e49f403e5dcc386a252a92"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe9037a1420e10cbef50aca338398feb3f2c62bd", "author": {"user": {"login": "cschierle", "name": "Christian Schierle"}}, "url": "https://github.com/scireum/sirius-biz/commit/fe9037a1420e10cbef50aca338398feb3f2c62bd", "committedDate": "2020-12-17T12:38:38Z", "message": "Adjustments to remove unreachable code\n\nFixes: SIRI-240"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e66e7d6a730bf96ff0581633be7750bb8bfec54a", "author": {"user": {"login": "cschierle", "name": "Christian Schierle"}}, "url": "https://github.com/scireum/sirius-biz/commit/e66e7d6a730bf96ff0581633be7750bb8bfec54a", "committedDate": "2020-12-17T12:43:29Z", "message": "Renaming and removes return type\n\nFixes: SIRI-240"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NTY5MzMx", "url": "https://github.com/scireum/sirius-biz/pull/900#pullrequestreview-554569331", "createdAt": "2020-12-17T12:45:08Z", "commit": {"oid": "e66e7d6a730bf96ff0581633be7750bb8bfec54a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NTcyMDQ0", "url": "https://github.com/scireum/sirius-biz/pull/900#pullrequestreview-554572044", "createdAt": "2020-12-17T12:49:00Z", "commit": {"oid": "e66e7d6a730bf96ff0581633be7750bb8bfec54a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NTczNzk0", "url": "https://github.com/scireum/sirius-biz/pull/900#pullrequestreview-554573794", "createdAt": "2020-12-17T12:51:24Z", "commit": {"oid": "e66e7d6a730bf96ff0581633be7750bb8bfec54a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4228, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}