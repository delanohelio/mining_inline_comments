{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NDU1ODM5", "number": 906, "title": "Improves handling of archives in file based import jobs and especially reworks the archive extraction job.", "bodyText": "", "createdAt": "2020-11-11T21:17:20Z", "url": "https://github.com/scireum/sirius-biz/pull/906", "merged": true, "mergeCommit": {"oid": "c22aec824b45e73e12ee8c9e982ae8d83f896f07"}, "closed": true, "closedAt": "2020-11-13T07:43:33Z", "author": {"login": "andyHa"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbkL8SgH2gAyNTE5NDU1ODM5Ojk4YTc2NGNiNzBhOGIyMDIzOTU1NDRiMWY2Yzg3NTI3ODU0YzFiZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdb0bnWgFqTUyOTIxMzQzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "98a764cb70a8b202395544b1f6c87527854c1be3", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/98a764cb70a8b202395544b1f6c87527854c1be3", "committedDate": "2020-11-11T20:42:49Z", "message": "Merge branch 'aha/make-parameters-great-again' into aha/archive-jobs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee4bea40e7ef6ffbb852b3f6ff11191b2d8d8fb5", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/ee4bea40e7ef6ffbb852b3f6ff11191b2d8d8fb5", "committedDate": "2020-11-11T21:02:09Z", "message": "Uses the new constants as provided by sirius-db."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8016e7777932d2451ef8321f22af211dfe817ac9", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/8016e7777932d2451ef8321f22af211dfe817ac9", "committedDate": "2020-11-11T21:04:10Z", "message": "Makes the FileImportJob use the ArchiveExtractor and adds support for handling auxiliary files."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "774c048126fcc9d7b404b35daaafac5257d32652", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/774c048126fcc9d7b404b35daaafac5257d32652", "committedDate": "2020-11-11T21:05:02Z", "message": "Uses the new API as defined by the FileImportJob."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8396fa50c19c57e074fe9c36094077649da33a09", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/8396fa50c19c57e074fe9c36094077649da33a09", "committedDate": "2020-11-11T21:06:01Z", "message": "Uses the new API as defined by FileImportJob.\n\nThis greatly simplifies the internal workings as it eliminates a whole\nbunch of duplicate code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc230b5dc579281ba1d8feb62c5d9d4d6db496e1", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/fc230b5dc579281ba1d8feb62c5d9d4d6db496e1", "committedDate": "2020-11-11T21:07:21Z", "message": "Supports the new API as defined by FileImportJob and adds support to import all sheets of an excel file."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8d46aa792eba500cc06f0b6b9b23b5fd1bd2a9b", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/e8d46aa792eba500cc06f0b6b9b23b5fd1bd2a9b", "committedDate": "2020-11-11T21:08:19Z", "message": "Provides updated translations for the refactored jobs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ac8f4a984357e4f952ee8b8ca326da207c8cdd4", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/6ac8f4a984357e4f952ee8b8ca326da207c8cdd4", "committedDate": "2020-11-11T21:08:40Z", "message": "Provides some cleanup for the ArchiveImportJob."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7b86eafd6eb0de75af377f1160013d81bf7038e", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/e7b86eafd6eb0de75af377f1160013d81bf7038e", "committedDate": "2020-11-11T21:15:40Z", "message": "Refactors the extract archive job.\n\nBy default we now overwrite files if a change is detected (SIRI-279) and also permit to delete\nthe archive once all files are extracted (SIRI-276).\n\nWe also reduced the logging quite a bit (which is still available in debug mode). Also we now\nrequire a destination to be given and no longer use the parent directory of the archive\nas fallback (as this provides quite a potential for trouble)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4ODY3MzI0", "url": "https://github.com/scireum/sirius-biz/pull/906#pullrequestreview-528867324", "createdAt": "2020-11-12T08:50:49Z", "commit": {"oid": "e7b86eafd6eb0de75af377f1160013d81bf7038e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwODo1MDo0OVrOHxwcpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwODo1MDo0OVrOHxwcpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkzNjAzOQ==", "bodyText": "sourceParameter", "url": "https://github.com/scireum/sirius-biz/pull/906#discussion_r521936039", "createdAt": "2020-11-12T08:50:49Z", "author": {"login": "mkeckmkeck"}, "path": "src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.storage.layer3;\n+\n+import sirius.biz.jobs.batch.SimpleBatchProcessJobFactory;\n+import sirius.biz.jobs.params.BooleanParameter;\n+import sirius.biz.jobs.params.EnumParameter;\n+import sirius.biz.jobs.params.Parameter;\n+import sirius.biz.process.PersistencePeriod;\n+import sirius.biz.process.ProcessContext;\n+import sirius.biz.process.logs.ProcessLog;\n+import sirius.biz.storage.layer1.FileHandle;\n+import sirius.biz.util.ArchiveExtractor;\n+import sirius.biz.util.ExtractedFile;\n+import sirius.kernel.async.TaskContext;\n+import sirius.kernel.commons.Files;\n+import sirius.kernel.commons.Strings;\n+import sirius.kernel.commons.Watch;\n+import sirius.kernel.di.std.Part;\n+import sirius.kernel.di.std.Register;\n+import sirius.kernel.nls.NLS;\n+import sirius.web.http.QueryString;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.util.ArrayList;\n+import java.util.Map;\n+import java.util.function.Consumer;\n+\n+/**\n+ * Provides a job able to extract archives from the {@link VirtualFileSystem}.\n+ * <p>\n+ * This uses the {@link ArchiveExtractor} so depending if 7-ZIP is enabled this supports either a whole bunch\n+ * of formats (rar, 7z, tar etc.) or \"just\" ZIP files using the Java API.\n+ */\n+@Register\n+public class ExtractArchiveJob extends SimpleBatchProcessJobFactory {\n+\n+    @Part\n+    private VirtualFileSystem vfs;\n+\n+    @Part\n+    private ArchiveExtractor extractor;\n+\n+    private final Parameter<VirtualFile> sourceParamter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7b86eafd6eb0de75af377f1160013d81bf7038e"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26781b29a991845de401bcc27510d029f047a174", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/26781b29a991845de401bcc27510d029f047a174", "committedDate": "2020-11-12T14:52:57Z", "message": "Merge remote-tracking branch 'origin/master' into aha/archive-jobs\n\n# Conflicts:\n#\tsrc/main/java/sirius/biz/jobs/batch/file/VirtualFileExtractionJob.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f838bd1258a19e04e28060ea8ba7364a6739fde5", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/f838bd1258a19e04e28060ea8ba7364a6739fde5", "committedDate": "2020-11-12T14:54:11Z", "message": "Fixes a typo."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f693066045e7c968fcabca60d5df6ace8e683d7a", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/f693066045e7c968fcabca60d5df6ace8e683d7a", "committedDate": "2020-11-12T14:56:43Z", "message": "Improves JavaDocs."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MTcxMDgw", "url": "https://github.com/scireum/sirius-biz/pull/906#pullrequestreview-529171080", "createdAt": "2020-11-12T14:58:31Z", "commit": {"oid": "f693066045e7c968fcabca60d5df6ace8e683d7a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MTkzMDI5", "url": "https://github.com/scireum/sirius-biz/pull/906#pullrequestreview-529193029", "createdAt": "2020-11-12T15:19:08Z", "commit": {"oid": "8016e7777932d2451ef8321f22af211dfe817ac9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNToxOTowOVrOHx_sMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNToxOTowOVrOHx_sMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE4NTc3Ng==", "bodyText": "vfs -> fileSystem?", "url": "https://github.com/scireum/sirius-biz/pull/906#discussion_r522185776", "createdAt": "2020-11-12T15:19:09Z", "author": {"login": "sabieber"}, "path": "src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java", "diffHunk": "@@ -42,7 +50,48 @@\n      */\n     public static final Parameter<VirtualFile> FILE_PARAMETER = createFileParameter(null);\n \n+    /**\n+     * Determines the mode in which auxiliary files are handled (if this job supports it).\n+     */\n+    public static final Parameter<AuxiliaryFileMode> AUX_FILE_MODE_PARAMETER = new EnumParameter<>(\"auxFileMode\",\n+                                                                                                   \"$FileImportJobFactory.auxFileMode\",\n+                                                                                                   AuxiliaryFileMode.class)\n+            .withDefault(AuxiliaryFileMode.UPDATE_ON_CHANGE)\n+            .markRequired()\n+            .build();\n+\n+    @Part\n+    private static VirtualFileSystem vfs;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8016e7777932d2451ef8321f22af211dfe817ac9"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98ae7ce3d33d9850e5b10e05d3f485466c5ec0ec", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/98ae7ce3d33d9850e5b10e05d3f485466c5ec0ec", "committedDate": "2020-11-12T15:35:04Z", "message": "Code style."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MjEwODI1", "url": "https://github.com/scireum/sirius-biz/pull/906#pullrequestreview-529210825", "createdAt": "2020-11-12T15:35:57Z", "commit": {"oid": "98ae7ce3d33d9850e5b10e05d3f485466c5ec0ec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MjEzNDMw", "url": "https://github.com/scireum/sirius-biz/pull/906#pullrequestreview-529213430", "createdAt": "2020-11-12T15:38:25Z", "commit": {"oid": "98ae7ce3d33d9850e5b10e05d3f485466c5ec0ec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4245, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}