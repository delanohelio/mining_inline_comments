{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4OTEwMzk4", "number": 655, "title": "Aha/checks", "bodyText": "", "createdAt": "2020-01-03T08:30:49Z", "url": "https://github.com/scireum/sirius-biz/pull/655", "merged": true, "mergeCommit": {"oid": "6405b3d51333a70e19d80be31d30d0c3c459ad55"}, "closed": true, "closedAt": "2020-01-03T12:52:09Z", "author": {"login": "andyHa"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2aKrVAH2gAyMzU4OTEwMzk4OjY0NTczYWM3YTVjYjNjZTVkOGY2MGMyYTM0YTdlYmExOWI3NjJhZjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb2tKuegFqTMzODA1MjE2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "64573ac7a5cb3ce5d8f60c2a34a7eba19b762af6", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/64573ac7a5cb3ce5d8f60c2a34a7eba19b762af6", "committedDate": "2020-01-02T13:56:02Z", "message": "Updates to the latest sirius libraries."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c91a6fb847a7b85ff5ae3052cc3f48babe5b12f", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/2c91a6fb847a7b85ff5ae3052cc3f48babe5b12f", "committedDate": "2020-01-02T13:59:12Z", "message": "Drops all automatic data checks and provides boilerplate methods instead.\n\nThe automatic checks where sometime too strict, sometimes too lose. Also within a composite\none cannot access the \"isChanged\" detection of the underlying entity, which is a good way to\nprevent tons of unnecessary checks in the first place.\n\nEach entity can now itself implement a BeforeSave method and/or an OnValidate method which\ncalls the appropriate checks of the composites."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd172680a0befe68133c7fce40ff35ad50318059", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/cd172680a0befe68133c7fce40ff35ad50318059", "committedDate": "2020-01-03T08:30:20Z", "message": "Simplifies the checks performed on a UserAccount."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5d5c2bdd472dcdcc19f68731f9507d42544d497", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/e5d5c2bdd472dcdcc19f68731f9507d42544d497", "committedDate": "2020-01-03T09:27:44Z", "message": "Refactors InternationalAddressData to also make all checks optional."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f40d4a85c48069d8fdcad5242611830484d7183", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/8f40d4a85c48069d8fdcad5242611830484d7183", "committedDate": "2020-01-03T09:27:53Z", "message": "Adds a missing i18n key."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "282bf1d0f5c55bf3cd22c6da74441663f2bf1066", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/282bf1d0f5c55bf3cd22c6da74441663f2bf1066", "committedDate": "2020-01-03T09:28:35Z", "message": "Performs a refactoring required by changes in sirius-kernel.\n\nThe settings defined per user/tenant shouldn't be strict as we expect them to be\nonly partially present."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9201152c11d7b568bab0a9f7f25a735b2022b7cb", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/9201152c11d7b568bab0a9f7f25a735b2022b7cb", "committedDate": "2020-01-03T09:28:55Z", "message": "Enforces some validation checks for tenants."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MDI3OTM0", "url": "https://github.com/scireum/sirius-biz/pull/655#pullrequestreview-338027934", "createdAt": "2020-01-03T10:45:43Z", "commit": {"oid": "cd172680a0befe68133c7fce40ff35ad50318059"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxMDo0NTo0M1rOFZ9m3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxMDo0NTo0M1rOFZ9m3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc2ODA5Mg==", "bodyText": "Requires a check if already saved data is lowercase (and a batch-convert) when not?", "url": "https://github.com/scireum/sirius-biz/pull/655#discussion_r362768092", "createdAt": "2020-01-03T10:45:43Z", "author": {"login": "idlira"}, "path": "src/main/java/sirius/biz/tenants/UserAccountData.java", "diffHunk": "@@ -110,28 +109,35 @@ public UserAccountData(BaseEntity<?> userObject) {\n \n     @BeforeSave\n     protected void verifyData() {\n-        if (Strings.isFilled(email)) {\n-            if (ms.isValidMailAddress(email.trim(), null)) {\n-                email = email.toLowerCase();\n-            } else {\n-                throw Exceptions.createHandled().withNLSKey(\"Model.invalidEmail\").set(\"value\", email).handle();\n-            }\n-        }\n+        userObject.ifChangedAndFilled(UserAccount.USER_ACCOUNT_DATA.inner(UserAccountData.PERSON)\n+                                                                   .inner(PersonData.SALUTATION),\n+                                      getPerson()::verifySalutation);\n+\n+        userObject.ifChangedAndFilled(UserAccount.USER_ACCOUNT_DATA.inner(UserAccountData.EMAIL), () -> {\n+            email = email.trim().toLowerCase();\n+            ms.failForInvalidEmail(email, null);\n+        });\n+\n+        fillAndVerifyUsername();\n+    }\n \n+    private void fillAndVerifyUsername() {\n+        // Use email address if no explicit username is present\n         if (Strings.isEmpty(getLogin().getUsername())) {\n             getLogin().setUsername(getEmail());\n         }\n-        if (Strings.isFilled(getLogin().getUsername())) {\n-            getLogin().setUsername(getLogin().getUsername().toLowerCase());\n-        } else {\n-            throw Exceptions.createHandled()\n-                            .withNLSKey(\"Property.fieldNotNullable\")\n-                            .set(\"field\", NLS.get(\"LoginData.username\"))\n-                            .handle();\n-        }\n \n-        userObject.assertUnique(UserAccount.USER_ACCOUNT_DATA.inner(LOGIN).inner(LoginData.USERNAME),\n-                                getLogin().getUsername());\n+        // Ensure that the username is is filled and unique...\n+        userObject.verifyIfChangedFailIfEmpty(UserAccount.USER_ACCOUNT_DATA.inner(LOGIN).inner(LoginData.USERNAME),\n+                                              () -> {\n+                                                  // Make it lowercase...\n+                                                  getLogin().setUsername(getLogin().getUsername().toLowerCase());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd172680a0befe68133c7fce40ff35ad50318059"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MDI4Nzc1", "url": "https://github.com/scireum/sirius-biz/pull/655#pullrequestreview-338028775", "createdAt": "2020-01-03T10:48:10Z", "commit": {"oid": "9201152c11d7b568bab0a9f7f25a735b2022b7cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxMDo0ODoxMFrOFZ9paw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxMDo0ODoxMFrOFZ9paw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc2ODc0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // Ensure that the username is is filled and unique...\n          \n          \n            \n                    // Ensure that the username is filled and unique...", "url": "https://github.com/scireum/sirius-biz/pull/655#discussion_r362768747", "createdAt": "2020-01-03T10:48:10Z", "author": {"login": "idlira"}, "path": "src/main/java/sirius/biz/tenants/UserAccountData.java", "diffHunk": "@@ -110,28 +109,35 @@ public UserAccountData(BaseEntity<?> userObject) {\n \n     @BeforeSave\n     protected void verifyData() {\n-        if (Strings.isFilled(email)) {\n-            if (ms.isValidMailAddress(email.trim(), null)) {\n-                email = email.toLowerCase();\n-            } else {\n-                throw Exceptions.createHandled().withNLSKey(\"Model.invalidEmail\").set(\"value\", email).handle();\n-            }\n-        }\n+        userObject.ifChangedAndFilled(UserAccount.USER_ACCOUNT_DATA.inner(UserAccountData.PERSON)\n+                                                                   .inner(PersonData.SALUTATION),\n+                                      getPerson()::verifySalutation);\n+\n+        userObject.ifChangedAndFilled(UserAccount.USER_ACCOUNT_DATA.inner(UserAccountData.EMAIL), () -> {\n+            email = email.trim().toLowerCase();\n+            ms.failForInvalidEmail(email, null);\n+        });\n+\n+        fillAndVerifyUsername();\n+    }\n \n+    private void fillAndVerifyUsername() {\n+        // Use email address if no explicit username is present\n         if (Strings.isEmpty(getLogin().getUsername())) {\n             getLogin().setUsername(getEmail());\n         }\n-        if (Strings.isFilled(getLogin().getUsername())) {\n-            getLogin().setUsername(getLogin().getUsername().toLowerCase());\n-        } else {\n-            throw Exceptions.createHandled()\n-                            .withNLSKey(\"Property.fieldNotNullable\")\n-                            .set(\"field\", NLS.get(\"LoginData.username\"))\n-                            .handle();\n-        }\n \n-        userObject.assertUnique(UserAccount.USER_ACCOUNT_DATA.inner(LOGIN).inner(LoginData.USERNAME),\n-                                getLogin().getUsername());\n+        // Ensure that the username is is filled and unique...", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9201152c11d7b568bab0a9f7f25a735b2022b7cb"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MDI5MDMw", "url": "https://github.com/scireum/sirius-biz/pull/655#pullrequestreview-338029030", "createdAt": "2020-01-03T10:48:55Z", "commit": {"oid": "9201152c11d7b568bab0a9f7f25a735b2022b7cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxMDo0ODo1NVrOFZ9qOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxMDo0ODo1NVrOFZ9qOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc2ODk1Mg==", "bodyText": "Is this format valid internationally?", "url": "https://github.com/scireum/sirius-biz/pull/655#discussion_r362768952", "createdAt": "2020-01-03T10:48:55Z", "author": {"login": "idlira"}, "path": "src/main/java/sirius/biz/model/ContactData.java", "diffHunk": "@@ -24,21 +22,24 @@\n import sirius.kernel.nls.NLS;\n import sirius.web.mails.Mails;\n \n+import java.util.function.Consumer;\n import java.util.regex.Pattern;\n \n /**\n  * Provides various contact information for a person or company which can be embedded into other entities or mixins.\n+ * <p>\n+ * Note that this class doesn't perform any save checks or validations at all. Any entity which contains this composite\n+ * must decide which checks have to be performed and then either call the <tt>verifyXXX</tt> method within an\n+ * {@link sirius.db.mixing.annotations.BeforeSave} handler or invoke <tt>validateXXX</tt> in an\n+ * {@link sirius.db.mixing.annotations.OnValidate} method. Most probably these checks should be surrounded with\n+ * a {@link sirius.db.mixing.BaseEntity#isChanged(Mapping...)} check to only validate or verify new values.\n  */\n public class ContactData extends Composite {\n \n     /**\n-     * Validates a phone numner.\n+     * Validates a phone number.\n      */\n-    public static final Pattern VALID_PHONE_NUMBER =\n-            Pattern.compile(\"\\\\+?\\\\d+( \\\\d+)*( */( *\\\\d+)+)?( *\\\\-( *\\\\d+)+)?\");\n-\n-    @Transient\n-    private boolean validatePhoneNumbers;\n+    public static final Pattern VALID_PHONE_NUMBER = Pattern.compile(\"\\\\+?\\\\d+( \\\\d+)*( */( *\\\\d+)+)?( *-( *\\\\d+)+)?\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9201152c11d7b568bab0a9f7f25a735b2022b7cb"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MDMwMDIx", "url": "https://github.com/scireum/sirius-biz/pull/655#pullrequestreview-338030021", "createdAt": "2020-01-03T10:51:46Z", "commit": {"oid": "9201152c11d7b568bab0a9f7f25a735b2022b7cb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06a3ff1ba86fb46ebbb4c870085a6b9d3044aadb", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/06a3ff1ba86fb46ebbb4c870085a6b9d3044aadb", "committedDate": "2020-01-03T11:04:43Z", "message": "Updates to the latest sirius-web"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d052f0db3f4836f6d33b9a62e2f30dfd1c00782c", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/d052f0db3f4836f6d33b9a62e2f30dfd1c00782c", "committedDate": "2020-01-03T11:04:54Z", "message": "Updates to ES7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9893b767a15a6585a590103e0aea7198845cd329", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/9893b767a15a6585a590103e0aea7198845cd329", "committedDate": "2020-01-03T11:05:42Z", "message": "Fixes a bug in a unit test.\n\nIf we reset the ID counter we also have to wipe out all existing entities as\notherwise the unique constraint on \"id\" will fail."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fada512436e4406dafe75bb4d6eee8619edb24b", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/2fada512436e4406dafe75bb4d6eee8619edb24b", "committedDate": "2020-01-03T11:06:41Z", "message": "Specifies an ID for the mongo sequences.\n\nAlthough unused, we have to provide a value as otherwise the\nunique constraint on the ID column will fail."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b096b481116ea473e1546b600e4c519f9d02eff0", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/b096b481116ea473e1546b600e4c519f9d02eff0", "committedDate": "2020-01-03T11:07:30Z", "message": "Update src/main/java/sirius/biz/tenants/UserAccountData.java\n\nCo-Authored-By: Idevaldo De Lira <54799255+idlira@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MDUyMTYw", "url": "https://github.com/scireum/sirius-biz/pull/655#pullrequestreview-338052160", "createdAt": "2020-01-03T12:04:17Z", "commit": {"oid": "b096b481116ea473e1546b600e4c519f9d02eff0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4481, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}