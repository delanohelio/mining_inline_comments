{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2MjQ4Njg2", "number": 820, "title": "Synchronous flush of coherent caches.", "bodyText": "", "createdAt": "2020-07-08T13:36:24Z", "url": "https://github.com/scireum/sirius-biz/pull/820", "merged": true, "mergeCommit": {"oid": "692990c0b9a94814b8ac6239a254472f84bfb834"}, "closed": true, "closedAt": "2020-07-08T18:05:37Z", "author": {"login": "andyHa"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcy6gUAgH2gAyNDQ2MjQ4Njg2OmVjNmUxZjAwMjU2MDIyZTkyNTdmZTFlMWE2OGYxYTk4NGQ4YjEzMDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy-aiqAFqTQ0NTAwOTczMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ec6e1f00256022e9257fe1e1a68f1a984d8b1300", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/ec6e1f00256022e9257fe1e1a68f1a984d8b1300", "committedDate": "2020-07-08T13:32:05Z", "message": "Fixes a JavaDoc comment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a32aac02480aedff358badec59cfd8424e777fd6", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/a32aac02480aedff358badec59cfd8424e777fd6", "committedDate": "2020-07-08T13:34:15Z", "message": "Executes cache manipulation calls synchronous for coherent caches.\n\nAfter invoking cache.clear (etc.) we expect the cache to be actually\ncleared on the local node. However, as the Interconnect distributes\nthe update via Redis there is actually a race-condition built-in.\n\nWe now modify the cache locally and Ignore the Interconnect message\nwe sent out, to ensure proper and consistent behavior."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e762db9dd56744c95f0464d1f7a0a533d3c7a7cc", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/e762db9dd56744c95f0464d1f7a0a533d3c7a7cc", "committedDate": "2020-07-08T13:35:33Z", "message": "Removes dead code.\n\nWe did distribute PUT messages across the cluster\nbut that lead to a war of nodes for many caches, as\neach node which loaded a value, dropped it from the cache.\n\nTherefore, to forcefully update a value across all nodes,\nCache.remove or Cache.clear has to be called."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba775af87cca4784f0fd7fbd0bd24022233e76f9", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/ba775af87cca4784f0fd7fbd0bd24022233e76f9", "committedDate": "2020-07-08T13:35:56Z", "message": "Prevents a startup warning in case the statistics framework is disabled."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0Nzc0MzAy", "url": "https://github.com/scireum/sirius-biz/pull/820#pullrequestreview-444774302", "createdAt": "2020-07-08T13:39:45Z", "commit": {"oid": "ba775af87cca4784f0fd7fbd0bd24022233e76f9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0Nzc3NTE3", "url": "https://github.com/scireum/sirius-biz/pull/820#pullrequestreview-444777517", "createdAt": "2020-07-08T13:43:12Z", "commit": {"oid": "ba775af87cca4784f0fd7fbd0bd24022233e76f9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODc3ODU2", "url": "https://github.com/scireum/sirius-biz/pull/820#pullrequestreview-444877856", "createdAt": "2020-07-08T15:24:11Z", "commit": {"oid": "a32aac02480aedff358badec59cfd8424e777fd6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNToyNDoxMVrOGutUSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNToyNTo1MlrOGutZCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYzMDE1Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (Strings.areEqual(CallContext.getNodeName(), event.getString(NODE_IDENTIFIER))) {\n          \n          \n            \n                    if (Strings.areEqual(CallContext.getNodeName(), event.getString(MESSAGE_NODE))) {", "url": "https://github.com/scireum/sirius-biz/pull/820#discussion_r451630153", "createdAt": "2020-07-08T15:24:11Z", "author": {"login": "sabieber"}, "path": "src/main/java/sirius/biz/cluster/InterconnectCacheCoherence.java", "diffHunk": "@@ -63,13 +67,19 @@ public void removeAll(Cache<String, ?> cache, String discriminator, String testI\n                                               .fluentPut(MESSAGE_DISCRIMINATOR, discriminator)\n                                               .fluentPut(MESSAGE_TEST_VALUE, testInput)\n                                               .fluentPut(MESSAGE_NODE, CallContext.getNodeName()));\n+        CacheManager.coherentCacheRemoveAllLocally(getName(), discriminator, testInput);\n     }\n \n     @Override\n     public void handleEvent(JSONObject event) {\n         String type = event.getString(MESSAGE_TYPE);\n         String cache = event.getString(MESSAGE_CACHE);\n \n+        // Ignore our own messages, as we already have executed them...\n+        if (Strings.areEqual(CallContext.getNodeName(), event.getString(NODE_IDENTIFIER))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a32aac02480aedff358badec59cfd8424e777fd6"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYzMTM2OA==", "bodyText": "Oder muss oben auch der NODE_IDENTIFIER rein geschrieben werden? So passt aber glaub auf jeden Fall ned oder?", "url": "https://github.com/scireum/sirius-biz/pull/820#discussion_r451631368", "createdAt": "2020-07-08T15:25:52Z", "author": {"login": "sabieber"}, "path": "src/main/java/sirius/biz/cluster/InterconnectCacheCoherence.java", "diffHunk": "@@ -63,13 +67,19 @@ public void removeAll(Cache<String, ?> cache, String discriminator, String testI\n                                               .fluentPut(MESSAGE_DISCRIMINATOR, discriminator)\n                                               .fluentPut(MESSAGE_TEST_VALUE, testInput)\n                                               .fluentPut(MESSAGE_NODE, CallContext.getNodeName()));\n+        CacheManager.coherentCacheRemoveAllLocally(getName(), discriminator, testInput);\n     }\n \n     @Override\n     public void handleEvent(JSONObject event) {\n         String type = event.getString(MESSAGE_TYPE);\n         String cache = event.getString(MESSAGE_CACHE);\n \n+        // Ignore our own messages, as we already have executed them...\n+        if (Strings.areEqual(CallContext.getNodeName(), event.getString(NODE_IDENTIFIER))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYzMDE1Mw=="}, "originalCommit": {"oid": "a32aac02480aedff358badec59cfd8424e777fd6"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6592e46103b5f47253702bedf51f866fc954204", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/a6592e46103b5f47253702bedf51f866fc954204", "committedDate": "2020-07-08T15:27:31Z", "message": "Removes a unused constant and uses the proper one to compare against."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODgyMTE2", "url": "https://github.com/scireum/sirius-biz/pull/820#pullrequestreview-444882116", "createdAt": "2020-07-08T15:28:43Z", "commit": {"oid": "a6592e46103b5f47253702bedf51f866fc954204"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODgyNDI5", "url": "https://github.com/scireum/sirius-biz/pull/820#pullrequestreview-444882429", "createdAt": "2020-07-08T15:29:01Z", "commit": {"oid": "a6592e46103b5f47253702bedf51f866fc954204"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODg1ODI4", "url": "https://github.com/scireum/sirius-biz/pull/820#pullrequestreview-444885828", "createdAt": "2020-07-08T15:32:46Z", "commit": {"oid": "a6592e46103b5f47253702bedf51f866fc954204"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDA5NzMw", "url": "https://github.com/scireum/sirius-biz/pull/820#pullrequestreview-445009730", "createdAt": "2020-07-08T18:05:24Z", "commit": {"oid": "a6592e46103b5f47253702bedf51f866fc954204"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4376, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}