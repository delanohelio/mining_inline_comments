{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzNjgwNjg2", "number": 775, "title": "BREAKING: Improves the admin UI and permission management", "bodyText": "the admin-ui of tenants has been split into several pages\nthe package and upgrades UI has been improved\na new roles \"system-administrator\" has been introduced to differentiate between users which can manage accounts for any tenant and users which can manage the system users (accounts of the system tenant)\n\nNote that all new sys admins need the role \"system-administrator\" OR the following has to be added to the application.conf as a temporary fix:\n\"flag-system-tenant-member+user-administrator\" {\n     priority = 55\n     system-administrator = true\n}", "createdAt": "2020-06-12T13:30:09Z", "url": "https://github.com/scireum/sirius-biz/pull/775", "merged": true, "mergeCommit": {"oid": "69c2dc67e59477d0a691d8927ef066e7dfb06642"}, "closed": true, "closedAt": "2020-06-16T08:16:41Z", "author": {"login": "andyHa"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqitHSgH2gAyNDMzNjgwNjg2Ojc1ZjM1ZjlhZmYxYmI3YmUzNWVlMDkwMmQzMjczOGY0YzhiMTc2YjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrck6QgFqTQzMDQzNzE2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "75f35f9aff1bb7be35ee0902d32738f4c8b176b6", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/75f35f9aff1bb7be35ee0902d32738f4c8b176b6", "committedDate": "2020-06-12T13:16:57Z", "message": "Adds some convenience methods and makes PackageData aware of its scope.\n\nThis simplifies some UIs and checks."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d684432be459e8cbe275275bbde81c18e0cb089", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/8d684432be459e8cbe275275bbde81c18e0cb089", "committedDate": "2020-06-12T13:17:45Z", "message": "Warns if packages are available but none is assigned to the target entity."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7bd7cb31d68643a35d20b743c4dad0cdd569b46", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/c7bd7cb31d68643a35d20b743c4dad0cdd569b46", "committedDate": "2020-06-12T13:18:27Z", "message": "Adds the possibility to provide a short description for packages and upgrades."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2a7140dbcc57ff9e229c9a46aa5f88678804eda", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/b2a7140dbcc57ff9e229c9a46aa5f88678804eda", "committedDate": "2020-06-12T13:19:25Z", "message": "BREAKING: Reverts a nullability check.\n\nThe API was changed to fully handle null arguments (which seems quite counter intuitive).\nTherefore we now make it explicit, that null is not accepted for most parameters."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4322239fe0ecc0b5e0bdd8cd481cecabf791e963", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/4322239fe0ecc0b5e0bdd8cd481cecabf791e963", "committedDate": "2020-06-12T13:20:36Z", "message": "Splits the tenant admin UI into several pages."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4983172bfa859bcbf28425e91a1caf8ac7127b55", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/4983172bfa859bcbf28425e91a1caf8ac7127b55", "committedDate": "2020-06-12T13:21:07Z", "message": "Fixes a rendering issue (removes a superfluous row-div)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86f56fea8b032ba4b44d593917539d4bd87cb423", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/86f56fea8b032ba4b44d593917539d4bd87cb423", "committedDate": "2020-06-12T13:21:29Z", "message": "Improves the output of available packages and upgrades."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9aa22189d22a6ee2c323e988c6d3f81195404ac", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/b9aa22189d22a6ee2c323e988c6d3f81195404ac", "committedDate": "2020-06-12T13:22:14Z", "message": "Properly splits an extension so separater concerns."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33a31416c8f08daa326f4c595e60dc9b621f09bd", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/33a31416c8f08daa326f4c595e60dc9b621f09bd", "committedDate": "2020-06-12T13:22:40Z", "message": "Provides a translation used in the admin UI."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1848608da007cd20e4a0bbcd92a43211c45bc543", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/1848608da007cd20e4a0bbcd92a43211c45bc543", "committedDate": "2020-06-12T13:22:59Z", "message": "Provides the scope to use for tenant packages and upgrades."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31b5e47b033f999bded0e3f69084b5c9fc8cd5dc", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/31b5e47b033f999bded0e3f69084b5c9fc8cd5dc", "committedDate": "2020-06-12T13:27:35Z", "message": "BREAKING: Splits the user-management permissions.\n\nWe now distinguish between \"managing users of any tenant\" and \"managing\nusers of the system tenant\" as this is entirely another game.\n\nPreviously, every user of the system tenant with the role \"user-administrator\"\nwas system administrator. We now introduced now a extra role and also an\nextra permission which controls if users of the system tenant may be\nupdated.\n\nTo achieve backwards compatibility, add this to the application.conf:\n\n        \"flag-system-tenant-member+user-administrator\" {\n            priority = 10\n\t    system-administrator = true\n        }"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2d772bb5c60a496f3f31f419e5d1b15b662a742", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/e2d772bb5c60a496f3f31f419e5d1b15b662a742", "committedDate": "2020-06-12T13:27:57Z", "message": "Removes and marks legacy permissions."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NzU1MjA5", "url": "https://github.com/scireum/sirius-biz/pull/775#pullrequestreview-429755209", "createdAt": "2020-06-12T13:49:05Z", "commit": {"oid": "e2d772bb5c60a496f3f31f419e5d1b15b662a742"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMzgzNTQz", "url": "https://github.com/scireum/sirius-biz/pull/775#pullrequestreview-430383543", "createdAt": "2020-06-15T07:27:03Z", "commit": {"oid": "31b5e47b033f999bded0e3f69084b5c9fc8cd5dc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNzoyNzowM1rOGjmKYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNzoyNzowM1rOGjmKYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk3ODU5Mw==", "bodyText": "--> Tenants.java dann muss man das nicht \u00fcberall nachimplementieren", "url": "https://github.com/scireum/sirius-biz/pull/775#discussion_r439978593", "createdAt": "2020-06-15T07:27:03Z", "author": {"login": "qw3ry"}, "path": "src/main/java/sirius/biz/tenants/UserAccountController.java", "diffHunk": "@@ -119,6 +125,14 @@ public void accounts(WebContext webContext) {\n         webContext.respondWith().template(\"/templates/biz/tenants/user-accounts.html.pasta\", accounts, getUserClass());\n     }\n \n+    protected void assertProperUserManagementPermission() {\n+        if (tenants.getRequiredTenant().hasPermission(Tenant.PERMISSION_SYSTEM_TENANT)) {\n+            assertPermission(PERMISSION_MANAGE_SYSTEM_USERS);\n+        } else {\n+            assertPermission(PERMISSION_MANAGE_USER_ACCOUNTS);\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31b5e47b033f999bded0e3f69084b5c9fc8cd5dc"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "986e33f8d51b6f38af8a7eff0768dec300b9583b", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/986e33f8d51b6f38af8a7eff0768dec300b9583b", "committedDate": "2020-06-15T08:10:22Z", "message": "Permits to re-use a common permission check.\n\nThis check is kind of specific to the user management.\nTherefore it is provided as static method rather than a\nmethod in Tenants. It is however intended to be reused\nin case an additional controller contributes to the user\nmanagement."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57edbc6c78f75c859b4dda9602d7f62b5688d81f", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/57edbc6c78f75c859b4dda9602d7f62b5688d81f", "committedDate": "2020-06-15T08:10:46Z", "message": "Checks if the current user is logged in before trying to access its tenant."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85c28443fad760dd6752b6ba4dd6fc02e027c79e", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/85c28443fad760dd6752b6ba4dd6fc02e027c79e", "committedDate": "2020-06-15T08:11:03Z", "message": "Uses the proper getter to determine is a package is selectable."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNDIzMDY4", "url": "https://github.com/scireum/sirius-biz/pull/775#pullrequestreview-430423068", "createdAt": "2020-06-15T08:23:51Z", "commit": {"oid": "85c28443fad760dd6752b6ba4dd6fc02e027c79e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwODoyMzo1MVrOGjoAAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwODoyNDoxNFrOGjoA3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAwODcwNw==", "bodyText": "UserAccountController.assertProperUserManagementPermission()", "url": "https://github.com/scireum/sirius-biz/pull/775#discussion_r440008707", "createdAt": "2020-06-15T08:23:51Z", "author": {"login": "qw3ry"}, "path": "src/main/java/sirius/biz/tenants/jdbc/SQLUserAccountExportJobFactory.java", "diffHunk": "@@ -10,27 +10,43 @@\n \n import sirius.biz.jobs.JobFactory;\n import sirius.biz.jobs.batch.file.EntityExportJobFactory;\n+import sirius.biz.tenants.Tenant;\n import sirius.biz.tenants.UserAccountController;\n import sirius.db.jdbc.SmartQuery;\n+import sirius.kernel.di.std.Part;\n import sirius.kernel.di.std.Register;\n import sirius.web.http.QueryString;\n import sirius.web.security.Permission;\n+import sirius.web.security.UserContext;\n+import sirius.web.security.UserInfo;\n \n import javax.annotation.Nonnull;\n \n /**\n  * Provides an export for {@link SQLUserAccount user accounts}.\n  */\n @Register(classes = JobFactory.class, framework = SQLTenants.FRAMEWORK_TENANTS_JDBC)\n-@Permission(UserAccountController.PERMISSION_MANAGE_USER_ACCOUNTS)\n public class SQLUserAccountExportJobFactory extends EntityExportJobFactory<SQLUserAccount, SmartQuery<SQLUserAccount>> {\n \n+    @Part\n+    private SQLTenants tenants;\n+\n     @Nonnull\n     @Override\n     public String getName() {\n         return \"export-sql-user-accounts\";\n     }\n \n+    @Override\n+    protected void checkPermissions() {\n+        UserInfo currentUser = UserContext.getCurrentUser();\n+        if (tenants.getRequiredTenant().hasPermission(Tenant.PERMISSION_SYSTEM_TENANT)) {\n+            currentUser.assertPermission(UserAccountController.PERMISSION_MANAGE_SYSTEM_USERS);\n+        } else {\n+            currentUser.assertPermission(UserAccountController.PERMISSION_MANAGE_USER_ACCOUNTS);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c28443fad760dd6752b6ba4dd6fc02e027c79e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAwODc3NA==", "bodyText": "UserAccountController.assertProperUserManagementPermission()", "url": "https://github.com/scireum/sirius-biz/pull/775#discussion_r440008774", "createdAt": "2020-06-15T08:23:59Z", "author": {"login": "qw3ry"}, "path": "src/main/java/sirius/biz/tenants/jdbc/SQLUserAccountImportJobFactory.java", "diffHunk": "@@ -25,12 +29,25 @@\n @Permission(UserAccountController.PERMISSION_MANAGE_USER_ACCOUNTS)\n public class SQLUserAccountImportJobFactory extends EntityImportJobFactory {\n \n+    @Part\n+    private SQLTenants tenants;\n+\n     @Nonnull\n     @Override\n     public String getName() {\n         return \"import-sql-user-accounts\";\n     }\n \n+    @Override\n+    protected void checkPermissions() {\n+        UserInfo currentUser = UserContext.getCurrentUser();\n+        if (tenants.getRequiredTenant().hasPermission(Tenant.PERMISSION_SYSTEM_TENANT)) {\n+            currentUser.assertPermission(UserAccountController.PERMISSION_MANAGE_SYSTEM_USERS);\n+        } else {\n+            currentUser.assertPermission(UserAccountController.PERMISSION_MANAGE_USER_ACCOUNTS);\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c28443fad760dd6752b6ba4dd6fc02e027c79e"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAwODg0Mw==", "bodyText": "UserAccountController.assertProperUserManagementPermission()", "url": "https://github.com/scireum/sirius-biz/pull/775#discussion_r440008843", "createdAt": "2020-06-15T08:24:06Z", "author": {"login": "qw3ry"}, "path": "src/main/java/sirius/biz/tenants/mongo/MongoUserAccountExportJobFactory.java", "diffHunk": "@@ -10,28 +10,45 @@\n \n import sirius.biz.jobs.JobFactory;\n import sirius.biz.jobs.batch.file.EntityExportJobFactory;\n+import sirius.biz.tenants.Tenant;\n import sirius.biz.tenants.UserAccountController;\n import sirius.db.mongo.MongoQuery;\n+import sirius.kernel.di.std.Part;\n import sirius.kernel.di.std.Register;\n import sirius.web.http.QueryString;\n import sirius.web.security.Permission;\n+import sirius.web.security.UserContext;\n+import sirius.web.security.UserInfo;\n \n import javax.annotation.Nonnull;\n \n /**\n  * Provides an export for {@link MongoUserAccount user accounts}.\n  */\n @Register(classes = JobFactory.class, framework = MongoTenants.FRAMEWORK_TENANTS_MONGO)\n-@Permission(UserAccountController.PERMISSION_MANAGE_USER_ACCOUNTS)\n public class MongoUserAccountExportJobFactory\n         extends EntityExportJobFactory<MongoUserAccount, MongoQuery<MongoUserAccount>> {\n \n+    @Part\n+    private MongoTenants tenants;\n+\n     @Nonnull\n     @Override\n     public String getName() {\n         return \"export-mongo-user-accounts\";\n     }\n \n+\n+    @Override\n+    protected void checkPermissions() {\n+        UserInfo currentUser = UserContext.getCurrentUser();\n+        if (tenants.getRequiredTenant().hasPermission(Tenant.PERMISSION_SYSTEM_TENANT)) {\n+            currentUser.assertPermission(UserAccountController.PERMISSION_MANAGE_SYSTEM_USERS);\n+        } else {\n+            currentUser.assertPermission(UserAccountController.PERMISSION_MANAGE_USER_ACCOUNTS);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c28443fad760dd6752b6ba4dd6fc02e027c79e"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAwODkyNQ==", "bodyText": "UserAccountController.assertProperUserManagementPermission()", "url": "https://github.com/scireum/sirius-biz/pull/775#discussion_r440008925", "createdAt": "2020-06-15T08:24:14Z", "author": {"login": "qw3ry"}, "path": "src/main/java/sirius/biz/tenants/mongo/MongoUserAccountImportJobFactory.java", "diffHunk": "@@ -25,18 +29,30 @@\n @Permission(UserAccountController.PERMISSION_MANAGE_USER_ACCOUNTS)\n public class MongoUserAccountImportJobFactory extends EntityImportJobFactory {\n \n+    @Part\n+    private MongoTenants tenants;\n+\n     @Nonnull\n     @Override\n     public String getName() {\n         return \"import-mongo-user-accounts\";\n     }\n \n+    @Override\n+    protected void checkPermissions() {\n+        UserInfo currentUser = UserContext.getCurrentUser();\n+        if (tenants.getRequiredTenant().hasPermission(Tenant.PERMISSION_SYSTEM_TENANT)) {\n+            currentUser.assertPermission(UserAccountController.PERMISSION_MANAGE_SYSTEM_USERS);\n+        } else {\n+            currentUser.assertPermission(UserAccountController.PERMISSION_MANAGE_USER_ACCOUNTS);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c28443fad760dd6752b6ba4dd6fc02e027c79e"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8db5e1e6c3e1e55cb96d28002615ccff9eeb177d", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/8db5e1e6c3e1e55cb96d28002615ccff9eeb177d", "committedDate": "2020-06-15T08:37:08Z", "message": "Re-uses code for the proper permission check."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f75f244359dd8bc61164924a549f09268c8db457", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/f75f244359dd8bc61164924a549f09268c8db457", "committedDate": "2020-06-15T08:39:00Z", "message": "Removes a startup warning in the tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f516ea5c25ec0117dbb675bb95cd23183ca5fbb1", "author": {"user": {"login": "andyHa", "name": "Andreas Haufler"}}, "url": "https://github.com/scireum/sirius-biz/commit/f516ea5c25ec0117dbb675bb95cd23183ca5fbb1", "committedDate": "2020-06-15T08:40:55Z", "message": "Adds proper parameters for the test scenario."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNDM3MTYz", "url": "https://github.com/scireum/sirius-biz/pull/775#pullrequestreview-430437163", "createdAt": "2020-06-15T08:42:29Z", "commit": {"oid": "f516ea5c25ec0117dbb675bb95cd23183ca5fbb1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4314, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}