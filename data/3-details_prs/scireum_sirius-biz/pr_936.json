{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNDEyMjY4", "number": 936, "title": "Handles additional actions to blobs and directories", "bodyText": "Moving a blob to another folder triggers a new handler which can be implemented to process a parent change\nRenaming a directory marks all child blobs as parent changes and propagates it to child directories\n\nFixes: OX-6076", "createdAt": "2020-12-01T16:09:19Z", "url": "https://github.com/scireum/sirius-biz/pull/936", "merged": true, "mergeCommit": {"oid": "a7f9b911f7ad55cbbea73573563379b4c21db6e3"}, "closed": true, "closedAt": "2020-12-02T09:55:02Z", "author": {"login": "idlira"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh8L-NgH2gAyNTMwNDEyMjY4OjhjZjQ4NmQyZjc1NTVmODg5ZGIyODU1MzMxN2QzZDkxZWIxYjQ4YzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiLc4rAFqTU0MjY2Mzc3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8cf486d2f7555f889db28553317d3d91eb1b48c1", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/8cf486d2f7555f889db28553317d3d91eb1b48c1", "committedDate": "2020-12-01T16:04:07Z", "message": "Marks blobs as parent changed when moved to another directory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "109b7c9bab1b7ec6a6f10532dec8d8824b0301e5", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/109b7c9bab1b7ec6a6f10532dec8d8824b0301e5", "committedDate": "2020-12-01T16:04:37Z", "message": "Marks directories as renamed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c017dd8ff3241a38126f0aa6291627774bc48d30", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/c017dd8ff3241a38126f0aa6291627774bc48d30", "committedDate": "2020-12-01T16:06:58Z", "message": "Processed additional actions on blobs and directories\n\nMoving a blob to another folder triggers a new handler which can be implemented to process a parent change\n\nRenaming a directory marks all child blobs as parent changes and propagates it to child directories"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5639497f93de78a310564077c79c0f66158458a", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/c5639497f93de78a310564077c79c0f66158458a", "committedDate": "2020-12-01T16:07:22Z", "message": "Implements the new database-specific loop methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMDYzNDk5", "url": "https://github.com/scireum/sirius-biz/pull/936#pullrequestreview-542063499", "createdAt": "2020-12-01T16:13:53Z", "commit": {"oid": "c5639497f93de78a310564077c79c0f66158458a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNjoxMzo1M1rOH80j_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNjoxMzo1M1rOH80j_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzUzNzc4OA==", "bodyText": "sure? shouldnt this be SqlDirectory.ID == dir.getId()?", "url": "https://github.com/scireum/sirius-biz/pull/936#discussion_r533537788", "createdAt": "2020-12-01T16:13:53Z", "author": {"login": "sabieber"}, "path": "src/main/java/sirius/biz/storage/layer2/jdbc/SQLProcessBlobChangesLoop.java", "diffHunk": "@@ -91,4 +91,61 @@ protected void propagateDelete(Directory dir) {\n                     dir.getSpaceName()).handle();\n         }\n     }\n+\n+    @Override\n+    protected void processRenamedDirectories(Runnable counter) {\n+        oma.select(SQLDirectory.class).eq(SQLDirectory.RENAMED, true).limit(256).iterateAll(dir -> {\n+            try {\n+                propagateRename(dir);\n+                oma.updateStatement(SQLDirectory.class)\n+                   .set(SQLDirectory.RENAMED, false)\n+                   .where(SQLDirectory.PARENT, dir.getId())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5639497f93de78a310564077c79c0f66158458a"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0cf38a4f9e1a25099c3c40901a631af1c2f853d", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/f0cf38a4f9e1a25099c3c40901a631af1c2f853d", "committedDate": "2020-12-01T16:17:57Z", "message": "Fixes columns used in query - bad copy & paste"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNTMxMDIz", "url": "https://github.com/scireum/sirius-biz/pull/936#pullrequestreview-542531023", "createdAt": "2020-12-02T06:28:15Z", "commit": {"oid": "f0cf38a4f9e1a25099c3c40901a631af1c2f853d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNTc1NTcz", "url": "https://github.com/scireum/sirius-biz/pull/936#pullrequestreview-542575573", "createdAt": "2020-12-02T07:59:19Z", "commit": {"oid": "f0cf38a4f9e1a25099c3c40901a631af1c2f853d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNjA5OTA1", "url": "https://github.com/scireum/sirius-biz/pull/936#pullrequestreview-542609905", "createdAt": "2020-12-02T08:48:32Z", "commit": {"oid": "f0cf38a4f9e1a25099c3c40901a631af1c2f853d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwODo0ODozMlrOH9QMOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwODo1MToxMVrOH9QSzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5MDQ1OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Method executed when a blob has its parent {@link Directory} changed.\n          \n          \n            \n                 * Executed when a blob has its parent {@link Directory} changed.", "url": "https://github.com/scireum/sirius-biz/pull/936#discussion_r533990458", "createdAt": "2020-12-02T08:48:32Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/layer2/BlobParentChangedHandler.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.storage.layer2;\n+\n+import sirius.kernel.di.std.Priorized;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Defines handlers to process {@link Blob blobs} which parent have been moved between {@link Directory directories}.\n+ *\n+ * @see ProcessBlobChangesLoop\n+ */\n+public interface BlobParentChangedHandler extends Priorized {\n+    /**\n+     * Method executed when a blob has its parent {@link Directory} changed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0cf38a4f9e1a25099c3c40901a631af1c2f853d"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5MjE0Mw==", "bodyText": "didn't we want to increase all the 256's to s.th. larger - like 1k oder 512? goes for all blocks. First step would be to define a constant in a base class and use this everywhere to it can be centrally controlled(?)", "url": "https://github.com/scireum/sirius-biz/pull/936#discussion_r533992143", "createdAt": "2020-12-02T08:51:11Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/layer2/mongo/MongoProcessBlobChangesLoop.java", "diffHunk": "@@ -78,4 +78,45 @@ protected void propagateDelete(@Nonnull Directory dir) {\n              .executeFor(MongoDirectory.class);\n         mongo.update().set(MongoBlob.DELETED, true).where(MongoBlob.PARENT, directoryId).executeFor(MongoBlob.class);\n     }\n+\n+    @Override\n+    protected void processRenamedDirectories(Runnable counter) {\n+        mango.select(MongoDirectory.class).eq(MongoDirectory.RENAMED, true).limit(256).iterateAll(dir -> {\n+            try {\n+                propagateRename(dir);\n+                mongo.update()\n+                     .set(MongoDirectory.RENAMED, false)\n+                     .where(MongoDirectory.ID, dir.getId())\n+                     .executeFor(MongoDirectory.class);\n+            } catch (Exception e) {\n+                handleDirectoryRenameException(dir, e);\n+            }\n+            counter.run();\n+        });\n+    }\n+\n+    @Override\n+    protected void propagateRename(@Nonnull Directory dir) {\n+        String directoryId = dir.getIdAsString();\n+        mongo.update()\n+             .set(MongoDirectory.RENAMED, true)\n+             .where(MongoDirectory.PARENT, directoryId)\n+             .executeFor(MongoDirectory.class);\n+        mongo.update()\n+             .set(MongoBlob.PARENT_CHANGED, true)\n+             .where(MongoBlob.PARENT, directoryId)\n+             .executeFor(MongoBlob.class);\n+    }\n+\n+    @Override\n+    protected void processParentChangedBlobs(Runnable counter) {\n+        mango.select(MongoBlob.class).eq(MongoBlob.PARENT_CHANGED, true).limit(256).iterateAll(blob -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0cf38a4f9e1a25099c3c40901a631af1c2f853d"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4cc3a172980d3f8a39972174a57dcdc4054e851", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/d4cc3a172980d3f8a39972174a57dcdc4054e851", "committedDate": "2020-12-02T08:54:48Z", "message": "Improves JavaDoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ba4e70b7a92e1112d9e2c9edfed6a88d4be9e46", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/1ba4e70b7a92e1112d9e2c9edfed6a88d4be9e46", "committedDate": "2020-12-02T09:09:00Z", "message": "Defines a constant for all query limits (defaults to 1024)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNjI4MjQ0", "url": "https://github.com/scireum/sirius-biz/pull/936#pullrequestreview-542628244", "createdAt": "2020-12-02T09:10:54Z", "commit": {"oid": "1ba4e70b7a92e1112d9e2c9edfed6a88d4be9e46"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNjQ2ODY3", "url": "https://github.com/scireum/sirius-biz/pull/936#pullrequestreview-542646867", "createdAt": "2020-12-02T09:31:56Z", "commit": {"oid": "1ba4e70b7a92e1112d9e2c9edfed6a88d4be9e46"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNjQ3NDY4", "url": "https://github.com/scireum/sirius-biz/pull/936#pullrequestreview-542647468", "createdAt": "2020-12-02T09:32:39Z", "commit": {"oid": "1ba4e70b7a92e1112d9e2c9edfed6a88d4be9e46"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozMjozOVrOH9R_Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozMjozOVrOH9R_Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxOTg3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected static final int CURSOR_LIMIT = 1024;\n          \n          \n            \n                /**\n          \n          \n            \n                 * Defines the block size used for queries to propagate and handle various change flags.\n          \n          \n            \n                 */\n          \n          \n            \n                protected static final int CURSOR_LIMIT = 1024;", "url": "https://github.com/scireum/sirius-biz/pull/936#discussion_r534019874", "createdAt": "2020-12-02T09:32:39Z", "author": {"login": "andyHa"}, "path": "src/main/java/sirius/biz/storage/layer2/ProcessBlobChangesLoop.java", "diffHunk": "@@ -25,10 +25,14 @@\n public abstract class ProcessBlobChangesLoop extends BackgroundLoop {\n \n     private static final double FREQUENCY_EVERY_FIFTEEN_SECONDS = 1 / 15d;\n+    protected static final int CURSOR_LIMIT = 1024;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ba4e70b7a92e1112d9e2c9edfed6a88d4be9e46"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0abaa881c7ea167e7ff09e7fb93edc3185977379", "author": {"user": {"login": "idlira", "name": "Idevaldo De Lira"}}, "url": "https://github.com/scireum/sirius-biz/commit/0abaa881c7ea167e7ff09e7fb93edc3185977379", "committedDate": "2020-12-02T09:35:36Z", "message": "Adds a JavaDoc explaining the purpose of the constant"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNjYzNzc1", "url": "https://github.com/scireum/sirius-biz/pull/936#pullrequestreview-542663775", "createdAt": "2020-12-02T09:51:10Z", "commit": {"oid": "0abaa881c7ea167e7ff09e7fb93edc3185977379"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4282, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}