{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMDMzNjM5", "number": 1659, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxMToyODozOVrOD_WolA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNTowOToyMFrOEF-6cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NzU3NzE2OnYy", "diffSide": "RIGHT", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/AddDataCaseFileInstanceCommand.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxMToyODo0MFrOGZ-EEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxMzoxMzowOVrOGaAuLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg4NDQzMg==", "bodyText": "It should control also that variable has a previous value assigned which tries to be overwritten", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r429884432", "createdAt": "2020-05-25T11:28:40Z", "author": {"login": "gmunozfe"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/AddDataCaseFileInstanceCommand.java", "diffHunk": "@@ -73,6 +74,15 @@ public Void execute(Context context) {\n         \n         KieSession ksession = ((RegistryContext) context).lookup( KieSession.class );\n         \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);\n+        VariableScope variableScope = (VariableScope) pi.getContextContainer().getDefaultContext(VariableScope.VARIABLE_SCOPE);\n+        \n+        for (String name: parameters.keySet())\n+        {\n+            if (variableScope.isReadOnly(VariableScope.CASE_FILE_PREFIX+name))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c4ccd4102f105ba2f76ccbe83f34ea73b6b7bf0"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyNzk4MQ==", "bodyText": "Done", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r429927981", "createdAt": "2020-05-25T13:13:09Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/AddDataCaseFileInstanceCommand.java", "diffHunk": "@@ -73,6 +74,15 @@ public Void execute(Context context) {\n         \n         KieSession ksession = ((RegistryContext) context).lookup( KieSession.class );\n         \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);\n+        VariableScope variableScope = (VariableScope) pi.getContextContainer().getDefaultContext(VariableScope.VARIABLE_SCOPE);\n+        \n+        for (String name: parameters.keySet())\n+        {\n+            if (variableScope.isReadOnly(VariableScope.CASE_FILE_PREFIX+name))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg4NDQzMg=="}, "originalCommit": {"oid": "5c4ccd4102f105ba2f76ccbe83f34ea73b6b7bf0"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MDM5MTM2OnYy", "diffSide": "RIGHT", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/StartCaseCommand.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMDo1Mjo0NlrOGaY9BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDozMDoyN1rOGahCbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMyNDk5Ng==", "bodyText": "I am not very convince about this.\nIf you are starting a case o restarting one to avoid any problem with variable you just need to check whether the oldValue and the newOne are the same instead of this. This will fix the issue regarding using the newCaseFileInstance + startCase... reopening will be more tricky as drools and facts are involved.", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r430324996", "createdAt": "2020-05-26T10:52:46Z", "author": {"login": "elguardian"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/StartCaseCommand.java", "diffHunk": "@@ -125,6 +123,7 @@ public void matchCreated(MatchCreatedEvent event) {\n         }\n         // set case id to allow it to use CaseContext when creating runtime engine\n         params.put(EnvironmentName.CASE_ID, caseId);\n+        params.put(VariableScope.FORCE_UPDATE, Boolean.TRUE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9afb2b3b05442e6db2a89d1feb6c2a0b57862309"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ1NzQ1NA==", "bodyText": "Additional parameter has been removed.\nassuming assigment of equal object is not considered assigment, we can avoid it", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r430457454", "createdAt": "2020-05-26T14:30:27Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/StartCaseCommand.java", "diffHunk": "@@ -125,6 +123,7 @@ public void matchCreated(MatchCreatedEvent event) {\n         }\n         // set case id to allow it to use CaseContext when creating runtime engine\n         params.put(EnvironmentName.CASE_ID, caseId);\n+        params.put(VariableScope.FORCE_UPDATE, Boolean.TRUE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMyNDk5Ng=="}, "originalCommit": {"oid": "9afb2b3b05442e6db2a89d1feb6c2a0b57862309"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5Mjc0NDY0OnYy", "diffSide": "RIGHT", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/AddDataCaseFileInstanceCommand.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwODoyMDo1M1rOGcTUFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMjoyNjo0NlrOGcak8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyOTc0OQ==", "bodyText": "logic spreaded between VariableScopeInstance and here.", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432329749", "createdAt": "2020-05-29T08:20:53Z", "author": {"login": "elguardian"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/AddDataCaseFileInstanceCommand.java", "diffHunk": "@@ -85,6 +87,16 @@ public Void execute(Context context) {\n         \n         CaseEventSupport caseEventSupport = getCaseEventSupport(context);\n         caseEventSupport.fireBeforeCaseDataAdded(caseFile.getCaseId(), caseFile, caseFile.getDefinitionId(), parameters);\n+        \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1ODkwMQ==", "bodyText": "VariableScopeInstance is not really used in this scenario. Please check getVariable, which relies on CaseFileInnstan", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432358901", "createdAt": "2020-05-29T09:15:08Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/AddDataCaseFileInstanceCommand.java", "diffHunk": "@@ -85,6 +87,16 @@ public Void execute(Context context) {\n         \n         CaseEventSupport caseEventSupport = getCaseEventSupport(context);\n         caseEventSupport.fireBeforeCaseDataAdded(caseFile.getCaseId(), caseFile, caseFile.getDefinitionId(), parameters);\n+        \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyOTc0OQ=="}, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ0ODc1NQ==", "bodyText": "Code changed to reuse setVariable on VariableScopeInstance", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432448755", "createdAt": "2020-05-29T12:26:46Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/AddDataCaseFileInstanceCommand.java", "diffHunk": "@@ -85,6 +87,16 @@ public Void execute(Context context) {\n         \n         CaseEventSupport caseEventSupport = getCaseEventSupport(context);\n         caseEventSupport.fireBeforeCaseDataAdded(caseFile.getCaseId(), caseFile, caseFile.getDefinitionId(), parameters);\n+        \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyOTc0OQ=="}, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5Mjc0NTQ5OnYy", "diffSide": "RIGHT", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwODoyMTowNFrOGcTUjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMzoxMDo1NlrOGfE-Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyOTg2OA==", "bodyText": "logic spreaded between VariableScopeInstance and here.", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432329868", "createdAt": "2020-05-29T08:21:04Z", "author": {"login": "elguardian"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "diffHunk": "@@ -60,6 +64,17 @@ public Void execute(Context context) {\n         // apply authorization\n         authorizationManager.checkDataAuthorization(caseFile.getCaseId(), caseFile, variableNames);\n         \n+        \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1ODk2NQ==", "bodyText": "VariableScopeInstance is not really used in this scenario. Please check getVariable, which relies on CaseFileInnstan", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432358965", "createdAt": "2020-05-29T09:15:14Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "diffHunk": "@@ -60,6 +64,17 @@ public Void execute(Context context) {\n         // apply authorization\n         authorizationManager.checkDataAuthorization(caseFile.getCaseId(), caseFile, variableNames);\n         \n+        \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyOTg2OA=="}, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ0OTM2Ng==", "bodyText": "Remove logic is very particular of CaseFileInstance (the events published are specific), so there is not really logic spread besided the call to variableScopeInstance.isReadOnly, which I believe is probably fine.", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432449366", "createdAt": "2020-05-29T12:27:56Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "diffHunk": "@@ -60,6 +64,17 @@ public Void execute(Context context) {\n         // apply authorization\n         authorizationManager.checkDataAuthorization(caseFile.getCaseId(), caseFile, variableNames);\n         \n+        \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyOTg2OA=="}, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI0MDQ4Nw==", "bodyText": "After some failed tests, I think the original code is good there, reusing VariableScopeInstance.setVariable cause case duplication because of the way the listeners are handled there.\nI do not think it is wise to change it more deeply.", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r435240487", "createdAt": "2020-06-04T13:10:56Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "diffHunk": "@@ -60,6 +64,17 @@ public Void execute(Context context) {\n         // apply authorization\n         authorizationManager.checkDataAuthorization(caseFile.getCaseId(), caseFile, variableNames);\n         \n+        \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyOTg2OA=="}, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5Mjc0NzQ1OnYy", "diffSide": "RIGHT", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/ReopenCaseCommand.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwODoyMTo0MFrOGcTVxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOTowOTo1N1rOGcU7Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDE4MA==", "bodyText": "why removed the check of null ?", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432330180", "createdAt": "2020-05-29T08:21:40Z", "author": {"login": "elguardian"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/ReopenCaseCommand.java", "diffHunk": "@@ -78,29 +78,43 @@ public Void execute(Context context) {\n         \n         KieSession ksession = ((RegistryContext) context).lookup( KieSession.class );\n                                \n-        CaseFileInstance caseFile = getCaseFile(ksession, caseId);                        \n+        CaseFileInstance caseFile = getCaseFile(ksession, caseId);     \n         \n         caseEventSupport.fireBeforeCaseReopened(caseId, caseFile, deploymentId, caseDefinitionId, data);\n         \n         logger.debug(\"Updating case file in working memory\");\n         FactHandle factHandle = ksession.getFactHandle(caseFile);\n-        ((CaseFileInstanceImpl)caseFile).setCaseReopenDate(new Date());\n-        if (data != null && !data.isEmpty()) {\n-            caseFile.addAll(data);\n-        }\n         ksession.update(factHandle, caseFile);\n         \n         logger.debug(\"Starting process instance for case {} and case definition {}\", caseId, caseDefinitionId);\n         CorrelationKey correlationKey = correlationKeyFactory.newCorrelationKey(caseId);\n         Map<String, Object> params = new HashMap<>();\n         // set case id to allow it to use CaseContext when creating runtime engine\n         params.put(EnvironmentName.CASE_ID, caseId);\n+        final Map<String, Object> caseData = caseFile.getData();\n+        \n+        \n+        for (Map.Entry<String, Object> entry : caseData.entrySet()) {\n+            params.put(VariableScope.CASE_FILE_PREFIX + entry.getKey(), entry.getValue());\n+        }\n+        \n+        if (data != null)   {\n+            for (Map.Entry<String, Object> entry : data.entrySet()) {\n+                params.put(VariableScope.CASE_FILE_PREFIX + entry.getKey(), entry.getValue());\n+            }\n+        }\n+\n         long processInstanceId = processService.startProcess(deploymentId, caseDefinitionId, correlationKey, params);\n+        \n+        ((CaseFileInstanceImpl)caseFile).setCaseReopenDate(new Date());\n+        if (data != null) {\n+            caseFile.addAll(data);\n+        }\n+        \n         logger.debug(\"Removing case file from working memory to allow refiring of rules...\");\n         ksession.delete(factHandle);\n         ksession.insert(caseFile);\n-        final Map<String, Object> caseData = caseFile.getData();\n-        if (caseData != null && !caseData.isEmpty()) {\n+        if (!caseData.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1NjEzOQ==", "bodyText": "because it was unneded and reported as a code smell", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432356139", "createdAt": "2020-05-29T09:09:57Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/ReopenCaseCommand.java", "diffHunk": "@@ -78,29 +78,43 @@ public Void execute(Context context) {\n         \n         KieSession ksession = ((RegistryContext) context).lookup( KieSession.class );\n                                \n-        CaseFileInstance caseFile = getCaseFile(ksession, caseId);                        \n+        CaseFileInstance caseFile = getCaseFile(ksession, caseId);     \n         \n         caseEventSupport.fireBeforeCaseReopened(caseId, caseFile, deploymentId, caseDefinitionId, data);\n         \n         logger.debug(\"Updating case file in working memory\");\n         FactHandle factHandle = ksession.getFactHandle(caseFile);\n-        ((CaseFileInstanceImpl)caseFile).setCaseReopenDate(new Date());\n-        if (data != null && !data.isEmpty()) {\n-            caseFile.addAll(data);\n-        }\n         ksession.update(factHandle, caseFile);\n         \n         logger.debug(\"Starting process instance for case {} and case definition {}\", caseId, caseDefinitionId);\n         CorrelationKey correlationKey = correlationKeyFactory.newCorrelationKey(caseId);\n         Map<String, Object> params = new HashMap<>();\n         // set case id to allow it to use CaseContext when creating runtime engine\n         params.put(EnvironmentName.CASE_ID, caseId);\n+        final Map<String, Object> caseData = caseFile.getData();\n+        \n+        \n+        for (Map.Entry<String, Object> entry : caseData.entrySet()) {\n+            params.put(VariableScope.CASE_FILE_PREFIX + entry.getKey(), entry.getValue());\n+        }\n+        \n+        if (data != null)   {\n+            for (Map.Entry<String, Object> entry : data.entrySet()) {\n+                params.put(VariableScope.CASE_FILE_PREFIX + entry.getKey(), entry.getValue());\n+            }\n+        }\n+\n         long processInstanceId = processService.startProcess(deploymentId, caseDefinitionId, correlationKey, params);\n+        \n+        ((CaseFileInstanceImpl)caseFile).setCaseReopenDate(new Date());\n+        if (data != null) {\n+            caseFile.addAll(data);\n+        }\n+        \n         logger.debug(\"Removing case file from working memory to allow refiring of rules...\");\n         ksession.delete(factHandle);\n         ksession.insert(caseFile);\n-        final Map<String, Object> caseData = caseFile.getData();\n-        if (caseData != null && !caseData.isEmpty()) {\n+        if (!caseData.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDE4MA=="}, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5Mjc0OTQ2OnYy", "diffSide": "RIGHT", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/StartCaseCommand.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwODoyMjoxNVrOGcTXCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMTozNzoxNFrOGcZNWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDUwNQ==", "bodyText": "unneeded", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432330505", "createdAt": "2020-05-29T08:22:15Z", "author": {"login": "elguardian"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/StartCaseCommand.java", "diffHunk": "@@ -112,10 +111,7 @@ public void matchCreated(MatchCreatedEvent event) {\n         });\n         commands.add(commandsFactory.newInsert(caseFile));\n         commands.add(commandsFactory.newFireAllRules());\n-\n-        BatchExecutionCommand batch = commandsFactory.newBatchExecution(commands);\n-        processService.execute(deploymentId, CaseContext.get(caseId), batch);\n-\n+        processService.execute(deploymentId, CaseContext.get(caseId), commandsFactory.newBatchExecution(commands));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyMTk2NA==", "bodyText": "what was unnededed is the definition of a variable which is used in one place, this is an improvement of previous code and should stay", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432421964", "createdAt": "2020-05-29T11:27:11Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/StartCaseCommand.java", "diffHunk": "@@ -112,10 +111,7 @@ public void matchCreated(MatchCreatedEvent event) {\n         });\n         commands.add(commandsFactory.newInsert(caseFile));\n         commands.add(commandsFactory.newFireAllRules());\n-\n-        BatchExecutionCommand batch = commandsFactory.newBatchExecution(commands);\n-        processService.execute(deploymentId, CaseContext.get(caseId), batch);\n-\n+        processService.execute(deploymentId, CaseContext.get(caseId), commandsFactory.newBatchExecution(commands));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDUwNQ=="}, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyNjMzMQ==", "bodyText": "Change rolled back", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432426331", "createdAt": "2020-05-29T11:37:14Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/StartCaseCommand.java", "diffHunk": "@@ -112,10 +111,7 @@ public void matchCreated(MatchCreatedEvent event) {\n         });\n         commands.add(commandsFactory.newInsert(caseFile));\n         commands.add(commandsFactory.newFireAllRules());\n-\n-        BatchExecutionCommand batch = commandsFactory.newBatchExecution(commands);\n-        processService.execute(deploymentId, CaseContext.get(caseId), batch);\n-\n+        processService.execute(deploymentId, CaseContext.get(caseId), commandsFactory.newBatchExecution(commands));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDUwNQ=="}, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5Mjc1MDc3OnYy", "diffSide": "RIGHT", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/model/instance/CaseFileInstanceImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwODoyMjo0MFrOGcTX8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMTozNzozOVrOGcZOLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDczNw==", "bodyText": "unneeded", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432330737", "createdAt": "2020-05-29T08:22:40Z", "author": {"login": "elguardian"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/model/instance/CaseFileInstanceImpl.java", "diffHunk": "@@ -113,7 +113,7 @@ public Date getCaseEndDate() {\n \n     @Override\n     public Map<String, Object> getData() {\n-        return this.data;\n+        return Collections.unmodifiableMap(this.data);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1Njg4MA==", "bodyText": "this is to prevent a backdoor update of the intenal map, it should stay to make the solution more robust", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432356880", "createdAt": "2020-05-29T09:11:20Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/model/instance/CaseFileInstanceImpl.java", "diffHunk": "@@ -113,7 +113,7 @@ public Date getCaseEndDate() {\n \n     @Override\n     public Map<String, Object> getData() {\n-        return this.data;\n+        return Collections.unmodifiableMap(this.data);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDczNw=="}, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyNjU0Mg==", "bodyText": "Change rolled back. Althoung theoretically correct, making the  map unmodifiable is potentially harmful for existing clients", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432426542", "createdAt": "2020-05-29T11:37:39Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/model/instance/CaseFileInstanceImpl.java", "diffHunk": "@@ -113,7 +113,7 @@ public Date getCaseEndDate() {\n \n     @Override\n     public Map<String, Object> getData() {\n-        return this.data;\n+        return Collections.unmodifiableMap(this.data);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMDczNw=="}, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5Mjc1NTA5OnYy", "diffSide": "RIGHT", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwODoyMzo1NFrOGcTakA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOToxMjoyNVrOGcVAJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMTQwOA==", "bodyText": "this will required a full downstream compilation at least. Commands are sensitive. @gmunozfe", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432331408", "createdAt": "2020-05-29T08:23:54Z", "author": {"login": "elguardian"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "diffHunk": "@@ -40,9 +42,11 @@\n \n     private List<String> variableNames;\n     private AuthorizationManager authorizationManager;\n+    private Long processInstanceId;\n     \n-    public RemoveDataCaseFileInstanceCommand(IdentityProvider identityProvider, List<String> variableNames, AuthorizationManager authorizationManager) {                \n+    public RemoveDataCaseFileInstanceCommand(Long processInstanceId, IdentityProvider identityProvider, List<String> variableNames, AuthorizationManager authorizationManager) {                ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1NzQxNQ==", "bodyText": "this is the only way I found to access variable readonly definition in RemoveDataCaseFileInstace. Lets do the full downstream compilation", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432357415", "createdAt": "2020-05-29T09:12:25Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "diffHunk": "@@ -40,9 +42,11 @@\n \n     private List<String> variableNames;\n     private AuthorizationManager authorizationManager;\n+    private Long processInstanceId;\n     \n-    public RemoveDataCaseFileInstanceCommand(IdentityProvider identityProvider, List<String> variableNames, AuthorizationManager authorizationManager) {                \n+    public RemoveDataCaseFileInstanceCommand(Long processInstanceId, IdentityProvider identityProvider, List<String> variableNames, AuthorizationManager authorizationManager) {                ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMTQwOA=="}, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5Mjc1NzI0OnYy", "diffSide": "RIGHT", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/test/resources/cases/UserTaskCaseRestrictedCaseFileItem.bpmn2", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwODoyNDozOFrOGcTcDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwOToxMzoyOVrOGcVCTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMTc5MQ==", "bodyText": "generate new file for these test.", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432331791", "createdAt": "2020-05-29T08:24:38Z", "author": {"login": "elguardian"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/test/resources/cases/UserTaskCaseRestrictedCaseFileItem.bpmn2", "diffHunk": "@@ -18,6 +18,14 @@\n         </tns:metaData>\n       </bpmn2:extensionElements>\n     </bpmn2:property>\n+    \n+    <bpmn2:property id=\"caseFile_r\" itemSubjectRef=\"_sItem\" name=\"caseFile_r\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1Nzk2Ng==", "bodyText": "Duplicating bpmn definitions (as duplicating code through copy paste), does not seem a good idea. The modified file was initially created to check required constraint. It makes full sense to reuse it to check readonly constraint.", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432357966", "createdAt": "2020-05-29T09:13:29Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/test/resources/cases/UserTaskCaseRestrictedCaseFileItem.bpmn2", "diffHunk": "@@ -18,6 +18,14 @@\n         </tns:metaData>\n       </bpmn2:extensionElements>\n     </bpmn2:property>\n+    \n+    <bpmn2:property id=\"caseFile_r\" itemSubjectRef=\"_sItem\" name=\"caseFile_r\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMTc5MQ=="}, "originalCommit": {"oid": "03c7d3b0d82f470b8550181d8c15b17d34622d02"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5Mzk4MjMyOnYy", "diffSide": "RIGHT", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/test/java/org/jbpm/casemgmt/impl/CaseServiceImplTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNDozNzo1MVrOGcfmZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNTo1NzowMVrOGcir5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjUzMTA0NQ==", "bodyText": "It doesn't match with the file name (case sensitive)\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    processes.add(\"cases/UserTaskCaseReadOnlyCaseFileItem.bpmn2\");\n          \n          \n            \n                    processes.add(\"cases/UserTaskCaseReadonlyCaseFileItem.bpmn2\");\n          \n      \n    \n    \n  \n\nor change the file name.", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432531045", "createdAt": "2020-05-29T14:37:51Z", "author": {"login": "gmunozfe"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/test/java/org/jbpm/casemgmt/impl/CaseServiceImplTest.java", "diffHunk": "@@ -146,6 +146,7 @@\n         processes.add(\"cases/UserTaskCaseRequiredCaseFileItem.bpmn2\");\n         processes.add(\"cases/UserTaskCaseRestrictedCaseFileItem.bpmn2\");\n         processes.add(\"cases/UserTaskCaseRequiredRestrictedCaseFileItem.bpmn2\");\n+        processes.add(\"cases/UserTaskCaseReadOnlyCaseFileItem.bpmn2\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9681fd1d6f0629d72d9404b8758885f964e46f65"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU4MTYwNA==", "bodyText": "file name changed", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r432581604", "createdAt": "2020-05-29T15:57:01Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/test/java/org/jbpm/casemgmt/impl/CaseServiceImplTest.java", "diffHunk": "@@ -146,6 +146,7 @@\n         processes.add(\"cases/UserTaskCaseRequiredCaseFileItem.bpmn2\");\n         processes.add(\"cases/UserTaskCaseRestrictedCaseFileItem.bpmn2\");\n         processes.add(\"cases/UserTaskCaseRequiredRestrictedCaseFileItem.bpmn2\");\n+        processes.add(\"cases/UserTaskCaseReadOnlyCaseFileItem.bpmn2\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjUzMTA0NQ=="}, "originalCommit": {"oid": "9681fd1d6f0629d72d9404b8758885f964e46f65"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NjQ0MzY3OnYy", "diffSide": "RIGHT", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/AddDataCaseFileInstanceCommand.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjo0NzowNlrOGkZnWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjoxMDo1NFrOGki2WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyMTU5Mg==", "bodyText": "Can you clarify it here, please? So VariableScopeInstance.setVariable calls fire methods which we don't want to call, so we use this approach?", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440821592", "createdAt": "2020-06-16T12:47:06Z", "author": {"login": "MarianMacik"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/AddDataCaseFileInstanceCommand.java", "diffHunk": "@@ -81,6 +82,16 @@ public Void execute(Context context) {\n         // apply authorization\n         authorizationManager.checkDataAuthorization(caseFile.getCaseId(), caseFile, parameters.keySet());\n         \n+        // check read only variables, due to dependencies between firexxxCaseData methods, we need this logic here, we cannot reuse VariableScopeInstance.setVariable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2615d1a8758c56a9b1a5d8e92e3d669f3d2e7e21"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk3Mjg4OA==", "bodyText": "Yes, after trying to modify original code to call setVariable instance and centralize some logic, some test were failing because the trigger call needs to be invoked at a very specific moment of time (or the case will be added twice), so I was adding that comment to avoid the temptation to do the same change in the future", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440972888", "createdAt": "2020-06-16T16:10:54Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/AddDataCaseFileInstanceCommand.java", "diffHunk": "@@ -81,6 +82,16 @@ public Void execute(Context context) {\n         // apply authorization\n         authorizationManager.checkDataAuthorization(caseFile.getCaseId(), caseFile, parameters.keySet());\n         \n+        // check read only variables, due to dependencies between firexxxCaseData methods, we need this logic here, we cannot reuse VariableScopeInstance.setVariable", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyMTU5Mg=="}, "originalCommit": {"oid": "2615d1a8758c56a9b1a5d8e92e3d669f3d2e7e21"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0Njk2MzI5OnYy", "diffSide": "LEFT", "path": "jbpm-test-coverage/src/main/java/org/jbpm/test/entity/MedicalRecord.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNDo0MjozOFrOGkew8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjowOTowNFrOGkixYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkwNTk3MA==", "bodyText": "Any reason why this was removed?", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440905970", "createdAt": "2020-06-16T14:42:38Z", "author": {"login": "MarianMacik"}, "path": "jbpm-test-coverage/src/main/java/org/jbpm/test/entity/MedicalRecord.java", "diffHunk": "@@ -110,9 +110,6 @@ public boolean equals(Object obj) {\n         if ((this.description == null) ? (other.description != null) : !this.description.equals(other.description)) {\n             return false;\n         }\n-        if (this.patient != other.patient && (this.patient == null || !this.patient.equals(other.patient))) {\n-            return false;\n-        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2615d1a8758c56a9b1a5d8e92e3d669f3d2e7e21"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk3MTYxOA==", "bodyText": "This was changed to avoid a circular dependency between equals that causes StackOverflowException", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440971618", "createdAt": "2020-06-16T16:09:04Z", "author": {"login": "fjtirado"}, "path": "jbpm-test-coverage/src/main/java/org/jbpm/test/entity/MedicalRecord.java", "diffHunk": "@@ -110,9 +110,6 @@ public boolean equals(Object obj) {\n         if ((this.description == null) ? (other.description != null) : !this.description.equals(other.description)) {\n             return false;\n         }\n-        if (this.patient != other.patient && (this.patient == null || !this.patient.equals(other.patient))) {\n-            return false;\n-        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkwNTk3MA=="}, "originalCommit": {"oid": "2615d1a8758c56a9b1a5d8e92e3d669f3d2e7e21"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NzA4NjcyOnYy", "diffSide": "RIGHT", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNTowODoxOVrOGkf-6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjoxMjozNFrOGki6Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkyNTkyOQ==", "bodyText": "In theory somebody can be already using that via ProcessService to be run as a separate command, so we can break backward compatibility, but if there is no other way, it is ok from my side.", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440925929", "createdAt": "2020-06-16T15:08:19Z", "author": {"login": "MarianMacik"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "diffHunk": "@@ -40,9 +42,11 @@\n \n     private List<String> variableNames;\n     private AuthorizationManager authorizationManager;\n+    private Long processInstanceId;\n     \n-    public RemoveDataCaseFileInstanceCommand(IdentityProvider identityProvider, List<String> variableNames, AuthorizationManager authorizationManager) {                \n+    public RemoveDataCaseFileInstanceCommand(Long processInstanceId, IdentityProvider identityProvider, List<String> variableNames, AuthorizationManager authorizationManager) {                ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2615d1a8758c56a9b1a5d8e92e3d669f3d2e7e21"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk3Mzg4Nw==", "bodyText": "Im aware of the potential backward compatiiliry problem, but I cannot find other way, processInstanceId is needed to check the readonly flag (and now both command constructors, add and remove data case are symetrical)", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440973887", "createdAt": "2020-06-16T16:12:34Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "diffHunk": "@@ -40,9 +42,11 @@\n \n     private List<String> variableNames;\n     private AuthorizationManager authorizationManager;\n+    private Long processInstanceId;\n     \n-    public RemoveDataCaseFileInstanceCommand(IdentityProvider identityProvider, List<String> variableNames, AuthorizationManager authorizationManager) {                \n+    public RemoveDataCaseFileInstanceCommand(Long processInstanceId, IdentityProvider identityProvider, List<String> variableNames, AuthorizationManager authorizationManager) {                ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkyNTkyOQ=="}, "originalCommit": {"oid": "2615d1a8758c56a9b1a5d8e92e3d669f3d2e7e21"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NzA5MTA3OnYy", "diffSide": "RIGHT", "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNTowOToyMFrOGkgBwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjoxNDoxNFrOGki-dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkyNjY1OA==", "bodyText": "Maybe use the same message as in VariableScopeInstance?\nthrow new VariableViolationException(getProcessInstance().getId(), name, \"Variable '\" + name + \"' is already set and is marked as read only\");", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440926658", "createdAt": "2020-06-16T15:09:20Z", "author": {"login": "MarianMacik"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "diffHunk": "@@ -59,7 +63,15 @@ public Void execute(Context context) {\n         \n         // apply authorization\n         authorizationManager.checkDataAuthorization(caseFile.getCaseId(), caseFile, variableNames);\n-        \n+          \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);\n+        VariableScope variableScope = (VariableScope) pi.getContextContainer().getDefaultContext(VariableScope.VARIABLE_SCOPE);\n+        for (String name: variableNames) {\n+            if (caseFile.getData(name) != null && variableScope.isReadOnly(VariableScope.CASE_FILE_PREFIX+name)) {\n+                throw new VariableViolationException(pi.getId(), name,\"variable is read only and cannot be removed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2615d1a8758c56a9b1a5d8e92e3d669f3d2e7e21"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk3NDk2Ng==", "bodyText": "Changed", "url": "https://github.com/kiegroup/jbpm/pull/1659#discussion_r440974966", "createdAt": "2020-06-16T16:14:14Z", "author": {"login": "fjtirado"}, "path": "jbpm-case-mgmt/jbpm-case-mgmt-impl/src/main/java/org/jbpm/casemgmt/impl/command/RemoveDataCaseFileInstanceCommand.java", "diffHunk": "@@ -59,7 +63,15 @@ public Void execute(Context context) {\n         \n         // apply authorization\n         authorizationManager.checkDataAuthorization(caseFile.getCaseId(), caseFile, variableNames);\n-        \n+          \n+        org.jbpm.process.instance.ProcessInstance pi = (org.jbpm.process.instance.ProcessInstance) ksession.getProcessInstance(processInstanceId);\n+        VariableScope variableScope = (VariableScope) pi.getContextContainer().getDefaultContext(VariableScope.VARIABLE_SCOPE);\n+        for (String name: variableNames) {\n+            if (caseFile.getData(name) != null && variableScope.isReadOnly(VariableScope.CASE_FILE_PREFIX+name)) {\n+                throw new VariableViolationException(pi.getId(), name,\"variable is read only and cannot be removed\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkyNjY1OA=="}, "originalCommit": {"oid": "2615d1a8758c56a9b1a5d8e92e3d669f3d2e7e21"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1708, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}