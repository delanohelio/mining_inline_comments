{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMzQwOTMz", "number": 1578, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNjo1NTowOVrODW64tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNjo1NTowOVrODW64tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MzYwMDU1OnYy", "diffSide": "RIGHT", "path": "jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/StateBasedNodeInstance.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNjo1NTowOVrOFb8zlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMToyOToxNVrOFcz_Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg1MjExNw==", "bodyText": "Is the casting to DefaultTimerJobInstance needed? For example, replacing defaultTimerInstance in the next line by\n((DefaultJobHandle) timerInstance.getJobHandle()).getTimerJobInstance()\nyou wouldn't need this variable.", "url": "https://github.com/kiegroup/jbpm/pull/1578#discussion_r364852117", "createdAt": "2020-01-09T16:55:09Z", "author": {"login": "gmunozfe"}, "path": "jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/StateBasedNodeInstance.java", "diffHunk": "@@ -345,9 +347,20 @@ private void triggerTimer(TimerInstance timerInstance) {\n         for (Map.Entry<Timer, DroolsAction> entry : getEventBasedNode().getTimers().entrySet()) {\n             if (entry.getKey().getId() == timerInstance.getTimerId()) {\n                 executeAction((Action) entry.getValue().getMetaData(\"Action\"));\n+\n+                // self remove timer instance from this node as it will remove itself \n+                // from timer service once is triggered and there is no next\n+                if (!(timerInstance.getJobHandle() instanceof DefaultJobHandle)) {\n+                    return;\n+                }\n+                DefaultTimerJobInstance defaultTimerInstance = (DefaultTimerJobInstance) ((DefaultJobHandle) timerInstance.getJobHandle()).getTimerJobInstance();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e3295bd1e814894cc3f8ca73b0320c5629ec29d"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEwNzEyMQ==", "bodyText": "yes it is needed JobHandle does not have method getTimerJobInstance", "url": "https://github.com/kiegroup/jbpm/pull/1578#discussion_r365107121", "createdAt": "2020-01-10T07:50:26Z", "author": {"login": "elguardian"}, "path": "jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/StateBasedNodeInstance.java", "diffHunk": "@@ -345,9 +347,20 @@ private void triggerTimer(TimerInstance timerInstance) {\n         for (Map.Entry<Timer, DroolsAction> entry : getEventBasedNode().getTimers().entrySet()) {\n             if (entry.getKey().getId() == timerInstance.getTimerId()) {\n                 executeAction((Action) entry.getValue().getMetaData(\"Action\"));\n+\n+                // self remove timer instance from this node as it will remove itself \n+                // from timer service once is triggered and there is no next\n+                if (!(timerInstance.getJobHandle() instanceof DefaultJobHandle)) {\n+                    return;\n+                }\n+                DefaultTimerJobInstance defaultTimerInstance = (DefaultTimerJobInstance) ((DefaultJobHandle) timerInstance.getJobHandle()).getTimerJobInstance();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg1MjExNw=="}, "originalCommit": {"oid": "4e3295bd1e814894cc3f8ca73b0320c5629ec29d"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc1NjIyMw==", "bodyText": "I mean TimerJobInstance interface already has getTrigger method, so there's no need to cast to DefaultTimerJobInstance, if you don't create an intermediate object (but it's not important, just nitpicking)\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            DefaultTimerJobInstance defaultTimerInstance = (DefaultTimerJobInstance) ((DefaultJobHandle) timerInstance.getJobHandle()).getTimerJobInstance();\n          \n          \n            \n                            if (((DefaultJobHandle) timerInstance.getJobHandle()).getTimerJobInstance().getTrigger().hasNextFireTime() == null) {", "url": "https://github.com/kiegroup/jbpm/pull/1578#discussion_r365756223", "createdAt": "2020-01-13T11:29:15Z", "author": {"login": "gmunozfe"}, "path": "jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/StateBasedNodeInstance.java", "diffHunk": "@@ -345,9 +347,20 @@ private void triggerTimer(TimerInstance timerInstance) {\n         for (Map.Entry<Timer, DroolsAction> entry : getEventBasedNode().getTimers().entrySet()) {\n             if (entry.getKey().getId() == timerInstance.getTimerId()) {\n                 executeAction((Action) entry.getValue().getMetaData(\"Action\"));\n+\n+                // self remove timer instance from this node as it will remove itself \n+                // from timer service once is triggered and there is no next\n+                if (!(timerInstance.getJobHandle() instanceof DefaultJobHandle)) {\n+                    return;\n+                }\n+                DefaultTimerJobInstance defaultTimerInstance = (DefaultTimerJobInstance) ((DefaultJobHandle) timerInstance.getJobHandle()).getTimerJobInstance();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg1MjExNw=="}, "originalCommit": {"oid": "4e3295bd1e814894cc3f8ca73b0320c5629ec29d"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1786, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}