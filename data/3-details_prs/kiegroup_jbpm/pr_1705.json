{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0ODc2NzQ0", "number": 1705, "title": "ProcessInstanceInfo set start date when constructed", "bodyText": "This is my first PR against jbpm \ud83d\ude04 Please let me know if I should open a Jira ticket here for this fix.\n\nIn the PrometheusProcessEventListener, the field startDate from a processInstance is used to time the process instance duration metric.\nhttps://github.com/kiegroup/droolsjbpm-integration/blob/4fb9e4c239dfc21ea99ea5b701877cafeafcbe1d/kie-server-parent/kie-server-services/kie-server-services-prometheus/src/main/java/org/kie/server/services/prometheus/PrometheusProcessEventListener.java#L96\nHowever, the start date was always null because it is being set when getProcessInstance is first called.\nSince getProcessInstance is not called before we trigger the event listener, the start date was never set.\nThe ProcessInstance start date should be set when the ProcessInstanceInfo object is first created.", "createdAt": "2020-07-22T04:44:44Z", "url": "https://github.com/kiegroup/jbpm/pull/1705", "merged": true, "mergeCommit": {"oid": "e81c303c1f5be84379e1e64f4583ab3e3ea393c1"}, "closed": true, "closedAt": "2020-08-04T13:34:16Z", "author": {"login": "hmatt1"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3TS5MgH2gAyNDU0ODc2NzQ0OjU5NzE3ODZmNzc5N2IxMzUwOWNiOWQ0YTkyMDUwYWNmYjIzZDU5ZjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7iJLugFqTQ2MDU5MzE0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5971786f7797b13509cb9d4a92050acfb23d59f5", "author": {"user": {"login": "hmatt1", "name": "Matt Hornung"}}, "url": "https://github.com/kiegroup/jbpm/commit/5971786f7797b13509cb9d4a92050acfb23d59f5", "committedDate": "2020-07-22T04:40:45Z", "message": "ProcessInstanceInfo set start date when constructed\n\nIn the `PrometheusProcessEventListener`, the field `startDate` from a `processInstance` is used to time the process instance duration metric.\nhttps://github.com/kiegroup/droolsjbpm-integration/blob/4fb9e4c239dfc21ea99ea5b701877cafeafcbe1d/kie-server-parent/kie-server-services/kie-server-services-prometheus/src/main/java/org/kie/server/services/prometheus/PrometheusProcessEventListener.java#L96\n\nHowever, the start date was always null because it is being set when `getProcessInstance` is first called.\nSince `getProcessInstance` is not called before we trigger the event listener, the start date was never set.\nThe `ProcessInstance` start date should be set when the `ProcessInstanceInfo` object is first created."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNjMwMTM0", "url": "https://github.com/kiegroup/jbpm/pull/1705#pullrequestreview-453630134", "createdAt": "2020-07-22T19:44:00Z", "commit": {"oid": "5971786f7797b13509cb9d4a92050acfb23d59f5"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MTMyOTE3", "url": "https://github.com/kiegroup/jbpm/pull/1705#pullrequestreview-456132917", "createdAt": "2020-07-27T21:02:44Z", "commit": {"oid": "5971786f7797b13509cb9d4a92050acfb23d59f5"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMTowMjo0NVrOG3zd2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMjoyOTowOVrOG310uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE2ODA5MQ==", "bodyText": "Remove this unused import", "url": "https://github.com/kiegroup/jbpm/pull/1705#discussion_r461168091", "createdAt": "2020-07-27T21:02:45Z", "author": {"login": "gmunozfe"}, "path": "jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java", "diffHunk": "@@ -55,6 +55,7 @@\n import org.jbpm.marshalling.impl.ProtobufRuleFlowProcessInstanceMarshaller;\n import org.jbpm.persistence.api.PersistentProcessInstance;\n import org.jbpm.process.instance.impl.ProcessInstanceImpl;\n+import org.jbpm.workflow.instance.WorkflowProcessInstance;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5971786f7797b13509cb9d4a92050acfb23d59f5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5OTkyNQ==", "bodyText": "You can remove this check, as it will always be true (notice that a null pointer exception will be thrown 2 lines above if processInstance were null)", "url": "https://github.com/kiegroup/jbpm/pull/1705#discussion_r461199925", "createdAt": "2020-07-27T22:11:31Z", "author": {"login": "gmunozfe"}, "path": "jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java", "diffHunk": "@@ -103,6 +104,16 @@ public ProcessInstanceInfo(ProcessInstance processInstance) {\n         this.processInstance = processInstance;\n         this.processId = processInstance.getProcessId();\n         startDate = new Date();\n+\n+        // If we are creating a second Process Instance Info for the same process instance,\n+        // it should not generate a new start date\n+        if (this.processInstance != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5971786f7797b13509cb9d4a92050acfb23d59f5"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNjcxNQ==", "bodyText": "You can move this line inside the first condition, for clarity and not overwriting when getStartDate is not null", "url": "https://github.com/kiegroup/jbpm/pull/1705#discussion_r461206715", "createdAt": "2020-07-27T22:29:09Z", "author": {"login": "gmunozfe"}, "path": "jbpm-persistence/jbpm-persistence-jpa/src/main/java/org/jbpm/persistence/processinstance/ProcessInstanceInfo.java", "diffHunk": "@@ -103,6 +104,16 @@ public ProcessInstanceInfo(ProcessInstance processInstance) {\n         this.processInstance = processInstance;\n         this.processId = processInstance.getProcessId();\n         startDate = new Date();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5971786f7797b13509cb9d4a92050acfb23d59f5"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d6d719fde19a5564100d72a948274785e34b152", "author": {"user": {"login": "hmatt1", "name": "Matt Hornung"}}, "url": "https://github.com/kiegroup/jbpm/commit/2d6d719fde19a5564100d72a948274785e34b152", "committedDate": "2020-07-28T01:30:37Z", "message": "twoProcessInstanceInfoSameStartDateTest\n\nThe twoProcessInstanceInfoSameStartDateTest was added along with other\nminor changes based on review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcd66559913a4d133a900e8369d64e91d6f4e258", "author": {"user": {"login": "hmatt1", "name": "Matt Hornung"}}, "url": "https://github.com/kiegroup/jbpm/commit/fcd66559913a4d133a900e8369d64e91d6f4e258", "committedDate": "2020-07-28T01:36:40Z", "message": "Using this.startDate consistently"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NTAzNTcz", "url": "https://github.com/kiegroup/jbpm/pull/1705#pullrequestreview-456503573", "createdAt": "2020-07-28T10:28:18Z", "commit": {"oid": "fcd66559913a4d133a900e8369d64e91d6f4e258"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdcc0d9d06341b98df7ab90a92dbb5f4df2526fa", "author": {"user": {"login": "hmatt1", "name": "Matt Hornung"}}, "url": "https://github.com/kiegroup/jbpm/commit/fdcc0d9d06341b98df7ab90a92dbb5f4df2526fa", "committedDate": "2020-07-31T04:50:03Z", "message": "Revert \"Using this.startDate consistently\"\n\nThis reverts commit fcd66559913a4d133a900e8369d64e91d6f4e258."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e100dbb9366a62da6e06f48900611e18bdddbe64", "author": {"user": {"login": "hmatt1", "name": "Matt Hornung"}}, "url": "https://github.com/kiegroup/jbpm/commit/e100dbb9366a62da6e06f48900611e18bdddbe64", "committedDate": "2020-07-31T04:50:10Z", "message": "Revert \"twoProcessInstanceInfoSameStartDateTest\"\n\nThis reverts commit 2d6d719fde19a5564100d72a948274785e34b152."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b12f8880d975bf366a0dd020c7eb36295a090572", "author": {"user": {"login": "hmatt1", "name": "Matt Hornung"}}, "url": "https://github.com/kiegroup/jbpm/commit/b12f8880d975bf366a0dd020c7eb36295a090572", "committedDate": "2020-07-31T04:50:25Z", "message": "Revert \"ProcessInstanceInfo set start date when constructed\"\n\nThis reverts commit 5971786f7797b13509cb9d4a92050acfb23d59f5."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dccf21bb85757512972ff5ae637ac984a49e268f", "author": {"user": {"login": "hmatt1", "name": "Matt Hornung"}}, "url": "https://github.com/kiegroup/jbpm/commit/dccf21bb85757512972ff5ae637ac984a49e268f", "committedDate": "2020-07-31T05:06:22Z", "message": "Set startDate in WorkflowProcessInstanceImpl\n\nSet the start date when `start()` is called"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTQ4NzE5", "url": "https://github.com/kiegroup/jbpm/pull/1705#pullrequestreview-460548719", "createdAt": "2020-08-04T07:07:21Z", "commit": {"oid": "dccf21bb85757512972ff5ae637ac984a49e268f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTkzMTQx", "url": "https://github.com/kiegroup/jbpm/pull/1705#pullrequestreview-460593141", "createdAt": "2020-08-04T08:14:25Z", "commit": {"oid": "dccf21bb85757512972ff5ae637ac984a49e268f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 972, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}