{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3NDM2NzIy", "number": 1624, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNzozMjo1NFrOD95p2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo1ODo1NlrOD-O2EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MjM0MzI4OnYy", "diffSide": "RIGHT", "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/regression/task/HumanTaskTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNzozMjo1NFrOGXrLew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNzo1NzowNlrOGYpwQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ3Nzg4Mw==", "bodyText": "beforeTaskActivatedEvent could also be implemented to be tested with a different AtomicBoolean", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r427477883", "createdAt": "2020-05-19T17:32:54Z", "author": {"login": "gmunozfe"}, "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/regression/task/HumanTaskTest.java", "diffHunk": "@@ -230,4 +238,31 @@ public void testInputTransformation() {\n         assertProcessInstanceCompleted(pi.getId());\n     }\n \n+    @Test\n+    public void testHumanTaskListener() {\n+        KieSession ksession = createKSession(HUMAN_TASK_LISTENER);\n+        AtomicBoolean triggered = new AtomicBoolean(false);\n+        TaskLifeCycleEventListener listener = new DefaultTaskEventListener() {\n+            @Override\n+            public void afterTaskActivatedEvent(TaskEvent event) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMzEwNQ==", "bodyText": "changing this to watch how many times is triggered.", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r428503105", "createdAt": "2020-05-21T07:57:06Z", "author": {"login": "elguardian"}, "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/regression/task/HumanTaskTest.java", "diffHunk": "@@ -230,4 +238,31 @@ public void testInputTransformation() {\n         assertProcessInstanceCompleted(pi.getId());\n     }\n \n+    @Test\n+    public void testHumanTaskListener() {\n+        KieSession ksession = createKSession(HUMAN_TASK_LISTENER);\n+        AtomicBoolean triggered = new AtomicBoolean(false);\n+        TaskLifeCycleEventListener listener = new DefaultTaskEventListener() {\n+            @Override\n+            public void afterTaskActivatedEvent(TaskEvent event) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ3Nzg4Mw=="}, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MjM0OTAxOnYy", "diffSide": "RIGHT", "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/regression/task/HumanTaskTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNzozNDoxOFrOGXrPDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNzo1NzoxMlrOGYpwcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ3ODc5Nw==", "bodyText": "When completing first task, second task is added, so listener is invoked twice in this scenario", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r427478797", "createdAt": "2020-05-19T17:34:18Z", "author": {"login": "gmunozfe"}, "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/regression/task/HumanTaskTest.java", "diffHunk": "@@ -230,4 +238,31 @@ public void testInputTransformation() {\n         assertProcessInstanceCompleted(pi.getId());\n     }\n \n+    @Test\n+    public void testHumanTaskListener() {\n+        KieSession ksession = createKSession(HUMAN_TASK_LISTENER);\n+        AtomicBoolean triggered = new AtomicBoolean(false);\n+        TaskLifeCycleEventListener listener = new DefaultTaskEventListener() {\n+            @Override\n+            public void afterTaskActivatedEvent(TaskEvent event) {\n+                triggered.set(true);\n+            }\n+\n+        };\n+        RuntimeEngine engine = getRuntimeEngine();\n+        TaskService taskService = engine.getTaskService();\n+        ((EventService<TaskLifeCycleEventListener>) taskService).registerTaskEventListener(listener);\n+        ProcessInstance pi = ksession.startProcess(HUMAN_TASK_LISTENER_ID);\n+        long processInstanceId = pi.getId();\n+\n+        List<Long> idList = taskService.getTasksByProcessInstanceId(processInstanceId);\n+        for (long taskId : idList) {\n+            taskService.start(taskId, \"john\");\n+            taskService.complete(taskId, \"john\", emptyMap());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMzE1NQ==", "bodyText": "changing this to watch how many times is triggered.", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r428503155", "createdAt": "2020-05-21T07:57:12Z", "author": {"login": "elguardian"}, "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/regression/task/HumanTaskTest.java", "diffHunk": "@@ -230,4 +238,31 @@ public void testInputTransformation() {\n         assertProcessInstanceCompleted(pi.getId());\n     }\n \n+    @Test\n+    public void testHumanTaskListener() {\n+        KieSession ksession = createKSession(HUMAN_TASK_LISTENER);\n+        AtomicBoolean triggered = new AtomicBoolean(false);\n+        TaskLifeCycleEventListener listener = new DefaultTaskEventListener() {\n+            @Override\n+            public void afterTaskActivatedEvent(TaskEvent event) {\n+                triggered.set(true);\n+            }\n+\n+        };\n+        RuntimeEngine engine = getRuntimeEngine();\n+        TaskService taskService = engine.getTaskService();\n+        ((EventService<TaskLifeCycleEventListener>) taskService).registerTaskEventListener(listener);\n+        ProcessInstance pi = ksession.startProcess(HUMAN_TASK_LISTENER_ID);\n+        long processInstanceId = pi.getId();\n+\n+        List<Long> idList = taskService.getTasksByProcessInstanceId(processInstanceId);\n+        for (long taskId : idList) {\n+            taskService.start(taskId, \"john\");\n+            taskService.complete(taskId, \"john\", emptyMap());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ3ODc5Nw=="}, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MjM1MTQ0OnYy", "diffSide": "RIGHT", "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/regression/task/HumanTaskTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNzozNDo1MlrOGXrQeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwODowNToxNlrOGYp95A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ3OTE2Mg==", "bodyText": "This could be part of a finally clause", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r427479162", "createdAt": "2020-05-19T17:34:52Z", "author": {"login": "gmunozfe"}, "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/regression/task/HumanTaskTest.java", "diffHunk": "@@ -230,4 +238,31 @@ public void testInputTransformation() {\n         assertProcessInstanceCompleted(pi.getId());\n     }\n \n+    @Test\n+    public void testHumanTaskListener() {\n+        KieSession ksession = createKSession(HUMAN_TASK_LISTENER);\n+        AtomicBoolean triggered = new AtomicBoolean(false);\n+        TaskLifeCycleEventListener listener = new DefaultTaskEventListener() {\n+            @Override\n+            public void afterTaskActivatedEvent(TaskEvent event) {\n+                triggered.set(true);\n+            }\n+\n+        };\n+        RuntimeEngine engine = getRuntimeEngine();\n+        TaskService taskService = engine.getTaskService();\n+        ((EventService<TaskLifeCycleEventListener>) taskService).registerTaskEventListener(listener);\n+        ProcessInstance pi = ksession.startProcess(HUMAN_TASK_LISTENER_ID);\n+        long processInstanceId = pi.getId();\n+\n+        List<Long> idList = taskService.getTasksByProcessInstanceId(processInstanceId);\n+        for (long taskId : idList) {\n+            taskService.start(taskId, \"john\");\n+            taskService.complete(taskId, \"john\", emptyMap());\n+        }\n+        assertTrue(\"Task should have triggered the event\", triggered.get());\n+\n+        ksession.abortProcessInstance(processInstanceId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwNjU5Ng==", "bodyText": "nope, part of the test. not failure.", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r428506596", "createdAt": "2020-05-21T08:05:16Z", "author": {"login": "elguardian"}, "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/regression/task/HumanTaskTest.java", "diffHunk": "@@ -230,4 +238,31 @@ public void testInputTransformation() {\n         assertProcessInstanceCompleted(pi.getId());\n     }\n \n+    @Test\n+    public void testHumanTaskListener() {\n+        KieSession ksession = createKSession(HUMAN_TASK_LISTENER);\n+        AtomicBoolean triggered = new AtomicBoolean(false);\n+        TaskLifeCycleEventListener listener = new DefaultTaskEventListener() {\n+            @Override\n+            public void afterTaskActivatedEvent(TaskEvent event) {\n+                triggered.set(true);\n+            }\n+\n+        };\n+        RuntimeEngine engine = getRuntimeEngine();\n+        TaskService taskService = engine.getTaskService();\n+        ((EventService<TaskLifeCycleEventListener>) taskService).registerTaskEventListener(listener);\n+        ProcessInstance pi = ksession.startProcess(HUMAN_TASK_LISTENER_ID);\n+        long processInstanceId = pi.getId();\n+\n+        List<Long> idList = taskService.getTasksByProcessInstanceId(processInstanceId);\n+        for (long taskId : idList) {\n+            taskService.start(taskId, \"john\");\n+            taskService.complete(taskId, \"john\", emptyMap());\n+        }\n+        assertTrue(\"Task should have triggered the event\", triggered.get());\n+\n+        ksession.abortProcessInstance(processInstanceId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ3OTE2Mg=="}, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NDY4Nzk2OnYy", "diffSide": "RIGHT", "path": "jbpm-human-task/jbpm-human-task-core/src/main/java/org/jbpm/services/task/impl/TaskInstanceServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwOTowMjoyMFrOGYCGxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNzo1NDoxNlrOGYprKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg1MzUxMA==", "bodyText": "Wondering whether it'd be good to update any possible task changes in the DB in case it's been modified by any additional listener done in the fireBeforeTaskActivated?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            this.taskEventSupport.fireBeforeTaskActivated(task, context);\n          \n          \n            \n                            this.taskEventSupport.fireAfterTaskActivated(task, context);\n          \n          \n            \n                            this.taskEventSupport.fireBeforeTaskActivated(task, context);\n          \n          \n            \n                            context.getPersistenceContext().updateTask(task);\n          \n          \n            \n                            this.taskEventSupport.fireAfterTaskActivated(task, context);", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r427853510", "createdAt": "2020-05-20T09:02:20Z", "author": {"login": "afalhambra"}, "path": "jbpm-human-task/jbpm-human-task-core/src/main/java/org/jbpm/services/task/impl/TaskInstanceServiceImpl.java", "diffHunk": "@@ -497,6 +497,17 @@ protected void resolveTaskDetailsForTaskProperties(Task task) {\n         ((InternalTask)task).setFormName((String) replacements.get(\"formName\"));\n     }\n \n-\n+    @Override\n+    public void fireEvent(Operation operation, long taskId) {\n+        Task task = context.getPersistenceContext().findTask(taskId);\n+        switch (operation) {\n+            case Activate:\n+                this.taskEventSupport.fireBeforeTaskActivated(task, context);\n+                this.taskEventSupport.fireAfterTaskActivated(task, context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMTgwMQ==", "bodyText": "there is already a listener doing that.", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r428501801", "createdAt": "2020-05-21T07:54:16Z", "author": {"login": "elguardian"}, "path": "jbpm-human-task/jbpm-human-task-core/src/main/java/org/jbpm/services/task/impl/TaskInstanceServiceImpl.java", "diffHunk": "@@ -497,6 +497,17 @@ protected void resolveTaskDetailsForTaskProperties(Task task) {\n         ((InternalTask)task).setFormName((String) replacements.get(\"formName\"));\n     }\n \n-\n+    @Override\n+    public void fireEvent(Operation operation, long taskId) {\n+        Task task = context.getPersistenceContext().findTask(taskId);\n+        switch (operation) {\n+            case Activate:\n+                this.taskEventSupport.fireBeforeTaskActivated(task, context);\n+                this.taskEventSupport.fireAfterTaskActivated(task, context);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg1MzUxMA=="}, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NDg0NjM2OnYy", "diffSide": "RIGHT", "path": "jbpm-human-task/jbpm-human-task-audit/src/test/java/org/jbpm/services/task/audit/service/TaskAuditBaseTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwOTo0NDozOFrOGYDtUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNzo1NDowMVrOGYpqtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg3OTc2Mg==", "bodyText": "Why + 2 activate events? It should've been deleted in line  \n  \n    \n      jbpm/jbpm-human-task/jbpm-human-task-audit/src/test/java/org/jbpm/services/task/audit/service/TaskAuditBaseTest.java\n    \n    \n         Line 139\n      in\n      6feccbf\n    \n    \n    \n    \n\n        \n          \n           taskService.execute(new DeleteAuditEventsCommand(taskId));", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r427879762", "createdAt": "2020-05-20T09:44:38Z", "author": {"login": "afalhambra"}, "path": "jbpm-human-task/jbpm-human-task-audit/src/test/java/org/jbpm/services/task/audit/service/TaskAuditBaseTest.java", "diffHunk": "@@ -138,7 +138,8 @@ public void testComplete() {\n \n         taskService.execute(new DeleteAuditEventsCommand(taskId));\n         allTaskEvents = taskService.execute(new GetAuditEventsCommand());\n-        assertEquals(numTaskEvents - numFirstTaskEvents, allTaskEvents.size());\n+        // +2 activate events.\n+        assertEquals(numTaskEvents - numFirstTaskEvents + 2, allTaskEvents.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMTY4Ng==", "bodyText": "it didn't take into accoutn the the new events triggered.", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r428501686", "createdAt": "2020-05-21T07:54:01Z", "author": {"login": "elguardian"}, "path": "jbpm-human-task/jbpm-human-task-audit/src/test/java/org/jbpm/services/task/audit/service/TaskAuditBaseTest.java", "diffHunk": "@@ -138,7 +138,8 @@ public void testComplete() {\n \n         taskService.execute(new DeleteAuditEventsCommand(taskId));\n         allTaskEvents = taskService.execute(new GetAuditEventsCommand());\n-        assertEquals(numTaskEvents - numFirstTaskEvents, allTaskEvents.size());\n+        // +2 activate events.\n+        assertEquals(numTaskEvents - numFirstTaskEvents + 2, allTaskEvents.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg3OTc2Mg=="}, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NDk3MzQyOnYy", "diffSide": "RIGHT", "path": "jbpm-test-coverage/src/test/resources/org/jbpm/test/regression/task/HumanTask-Listener.bpmn2", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMDoxOTo1N1rOGYE9mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMDoxOTo1N1rOGYE9mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzkwMDMxMg==", "bodyText": "To avoid any confusion about what this bpm is doing I think we should get rid off the non-sense defined process and task variables along with the system.out.println java statements defined in the \"on entry\" and \"on exit\" sections.", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r427900312", "createdAt": "2020-05-20T10:19:57Z", "author": {"login": "afalhambra"}, "path": "jbpm-test-coverage/src/test/resources/org/jbpm/test/regression/task/HumanTask-Listener.bpmn2", "diffHunk": "@@ -0,0 +1,328 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<bpmn2:definitions xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://www.omg.org/bpmn20\" xmlns:bpmn2=\"http://www.omg.org/spec/BPMN/20100524/MODEL\" xmlns:bpmndi=\"http://www.omg.org/spec/BPMN/20100524/DI\" xmlns:bpsim=\"http://www.bpsim.org/schemas/1.0\" xmlns:dc=\"http://www.omg.org/spec/DD/20100524/DC\" xmlns:di=\"http://www.omg.org/spec/DD/20100524/DI\" xmlns:drools=\"http://www.jboss.org/drools\" id=\"_eq_ZkGhiEeqRIbB9YdC0SQ\" xsi:schemaLocation=\"http://www.omg.org/spec/BPMN/20100524/MODEL BPMN20.xsd http://www.jboss.org/drools drools.xsd http://www.bpsim.org/schemas/1.0 bpsim.xsd http://www.omg.org/spec/DD/20100524/DC DC.xsd http://www.omg.org/spec/DD/20100524/DI DI.xsd \" exporter=\"jBPM Process Modeler\" exporterVersion=\"2.0\" targetNamespace=\"http://www.omg.org/bpmn20\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTI3NDE5OnYy", "diffSide": "RIGHT", "path": "jbpm-services/jbpm-kie-services/src/test/java/org/jbpm/kie/services/test/UserTaskInstanceWithPotOwnerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMTo1NTo1OVrOGYH_FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNzo1ODowOFrOGYpyJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk0OTg0NQ==", "bodyText": "Why this change? is because an event can be created same day (i.e. logtime column)? But as per the column definition itself this is a timestamp, so I think it shouldn't be a problem here - wdyt?\nhttps://github.com/kiegroup/jbpm/blob/master/jbpm-human-task/jbpm-human-task-audit/src/main/java/org/jbpm/services/task/audit/impl/model/TaskEventImpl.java#L73-L74", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r427949845", "createdAt": "2020-05-20T11:55:59Z", "author": {"login": "afalhambra"}, "path": "jbpm-services/jbpm-kie-services/src/test/java/org/jbpm/kie/services/test/UserTaskInstanceWithPotOwnerTest.java", "diffHunk": "@@ -271,16 +271,16 @@ public void testSearchTaskByPotOwnerQueryParamBuilder() {\n     public void testSearchTaskWithModifVarsMapper() {\n         query = new SqlQueryDefinition(\"jbpmGetTaskWithPO\", dataSourceJNDIname);\n         query.setExpression(\"select t.id as TASKID, t.name as NAME,  t.FORMNAME AS FORMNAME, t.subject as SUBJECT, \" +\n-                \"t.actualowner_id as ACTUALOWNER, po.entity_id as POTOWNER, p.processinstancedescription as PROCESSINSTANCEDESCRIPTION, t.CREATEDON as CREATEDON, \" +\n-                \"t.CREATEDBY_ID as CREATEDBY, t.EXPIRATIONTIME as EXPIRATIONTIME, \" +\n-                \"(select max(logtime) from taskevent where processinstanceid = t.processinstanceid and taskid = t.id) as lastmodificationdate, \" +\n-                \"(select userid from taskevent where logtime = (select max(logtime) from taskevent where processinstanceid = t.processinstanceid and taskid = t.id)) as lastmodificationuser, \" +\n-                \"t.priority as PRIORITY, t.STATUS as STATUS, t.PROCESSINSTANCEID as PROCESSINSTANCEID, t.PROCESSID as PROCESSID, \" +\n-                \"t.deploymentid as DEPLOYMENTID, d.name as TVNAME, d.type as TVTYPE, d.value as TVVALUE \" +\n-                \"from TASK t \" +\n-                \"inner join PEOPLEASSIGNMENTS_POTOWNERS po on t.id=po.task_id \" +\n-                \"inner join PROCESSINSTANCELOG p on t.processinstanceid = p.processinstanceid \" +\n-                \"inner join TASKVARIABLEIMPL d on t.id=d.taskid\");\n+                            \"t.actualowner_id as ACTUALOWNER, po.entity_id as POTOWNER, p.processinstancedescription as PROCESSINSTANCEDESCRIPTION, t.CREATEDON as CREATEDON, \" +\n+                            \"t.CREATEDBY_ID as CREATEDBY, t.EXPIRATIONTIME as EXPIRATIONTIME, \" +\n+                            \"(select max(logtime) from taskevent where processinstanceid = t.processinstanceid and taskid = t.id) as lastmodificationdate, \" +\n+                            \"(select a.userid from taskevent a left join taskevent b on a.id < b.id where b.id IS NULL) as lastmodificationuser, \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMzU5MQ==", "bodyText": "log time is a time stamp. It is better to trust the sequence.", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r428503591", "createdAt": "2020-05-21T07:58:08Z", "author": {"login": "elguardian"}, "path": "jbpm-services/jbpm-kie-services/src/test/java/org/jbpm/kie/services/test/UserTaskInstanceWithPotOwnerTest.java", "diffHunk": "@@ -271,16 +271,16 @@ public void testSearchTaskByPotOwnerQueryParamBuilder() {\n     public void testSearchTaskWithModifVarsMapper() {\n         query = new SqlQueryDefinition(\"jbpmGetTaskWithPO\", dataSourceJNDIname);\n         query.setExpression(\"select t.id as TASKID, t.name as NAME,  t.FORMNAME AS FORMNAME, t.subject as SUBJECT, \" +\n-                \"t.actualowner_id as ACTUALOWNER, po.entity_id as POTOWNER, p.processinstancedescription as PROCESSINSTANCEDESCRIPTION, t.CREATEDON as CREATEDON, \" +\n-                \"t.CREATEDBY_ID as CREATEDBY, t.EXPIRATIONTIME as EXPIRATIONTIME, \" +\n-                \"(select max(logtime) from taskevent where processinstanceid = t.processinstanceid and taskid = t.id) as lastmodificationdate, \" +\n-                \"(select userid from taskevent where logtime = (select max(logtime) from taskevent where processinstanceid = t.processinstanceid and taskid = t.id)) as lastmodificationuser, \" +\n-                \"t.priority as PRIORITY, t.STATUS as STATUS, t.PROCESSINSTANCEID as PROCESSINSTANCEID, t.PROCESSID as PROCESSID, \" +\n-                \"t.deploymentid as DEPLOYMENTID, d.name as TVNAME, d.type as TVTYPE, d.value as TVVALUE \" +\n-                \"from TASK t \" +\n-                \"inner join PEOPLEASSIGNMENTS_POTOWNERS po on t.id=po.task_id \" +\n-                \"inner join PROCESSINSTANCELOG p on t.processinstanceid = p.processinstanceid \" +\n-                \"inner join TASKVARIABLEIMPL d on t.id=d.taskid\");\n+                            \"t.actualowner_id as ACTUALOWNER, po.entity_id as POTOWNER, p.processinstancedescription as PROCESSINSTANCEDESCRIPTION, t.CREATEDON as CREATEDON, \" +\n+                            \"t.CREATEDBY_ID as CREATEDBY, t.EXPIRATIONTIME as EXPIRATIONTIME, \" +\n+                            \"(select max(logtime) from taskevent where processinstanceid = t.processinstanceid and taskid = t.id) as lastmodificationdate, \" +\n+                            \"(select a.userid from taskevent a left join taskevent b on a.id < b.id where b.id IS NULL) as lastmodificationuser, \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk0OTg0NQ=="}, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTgxMzQ5OnYy", "diffSide": "RIGHT", "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/regression/task/HumanTaskTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo1ODozNlrOGYNIng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo1ODozNlrOGYNIng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAzNDIwNg==", "bodyText": "Agree with @gmunozfe", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r428034206", "createdAt": "2020-05-20T13:58:36Z", "author": {"login": "afalhambra"}, "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/regression/task/HumanTaskTest.java", "diffHunk": "@@ -230,4 +238,31 @@ public void testInputTransformation() {\n         assertProcessInstanceCompleted(pi.getId());\n     }\n \n+    @Test\n+    public void testHumanTaskListener() {\n+        KieSession ksession = createKSession(HUMAN_TASK_LISTENER);\n+        AtomicBoolean triggered = new AtomicBoolean(false);\n+        TaskLifeCycleEventListener listener = new DefaultTaskEventListener() {\n+            @Override\n+            public void afterTaskActivatedEvent(TaskEvent event) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTgxNTIxOnYy", "diffSide": "RIGHT", "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/regression/task/HumanTaskTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo1ODo1NlrOGYNJug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNzo1ODoxOFrOGYpyWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAzNDQ5MA==", "bodyText": "same as @gmunozfe - I would make HumanTask-Listener.bpmn2 a litte simpler and cleaner by removing some task/process variables along with some System.out.println stuff in the \"on entry\" and \"on exit\" section of the bpmn.", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r428034490", "createdAt": "2020-05-20T13:58:56Z", "author": {"login": "afalhambra"}, "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/regression/task/HumanTaskTest.java", "diffHunk": "@@ -230,4 +238,31 @@ public void testInputTransformation() {\n         assertProcessInstanceCompleted(pi.getId());\n     }\n \n+    @Test\n+    public void testHumanTaskListener() {\n+        KieSession ksession = createKSession(HUMAN_TASK_LISTENER);\n+        AtomicBoolean triggered = new AtomicBoolean(false);\n+        TaskLifeCycleEventListener listener = new DefaultTaskEventListener() {\n+            @Override\n+            public void afterTaskActivatedEvent(TaskEvent event) {\n+                triggered.set(true);\n+            }\n+\n+        };\n+        RuntimeEngine engine = getRuntimeEngine();\n+        TaskService taskService = engine.getTaskService();\n+        ((EventService<TaskLifeCycleEventListener>) taskService).registerTaskEventListener(listener);\n+        ProcessInstance pi = ksession.startProcess(HUMAN_TASK_LISTENER_ID);\n+        long processInstanceId = pi.getId();\n+\n+        List<Long> idList = taskService.getTasksByProcessInstanceId(processInstanceId);\n+        for (long taskId : idList) {\n+            taskService.start(taskId, \"john\");\n+            taskService.complete(taskId, \"john\", emptyMap());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMzY0Mg==", "bodyText": "already answered", "url": "https://github.com/kiegroup/jbpm/pull/1624#discussion_r428503642", "createdAt": "2020-05-21T07:58:18Z", "author": {"login": "elguardian"}, "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/regression/task/HumanTaskTest.java", "diffHunk": "@@ -230,4 +238,31 @@ public void testInputTransformation() {\n         assertProcessInstanceCompleted(pi.getId());\n     }\n \n+    @Test\n+    public void testHumanTaskListener() {\n+        KieSession ksession = createKSession(HUMAN_TASK_LISTENER);\n+        AtomicBoolean triggered = new AtomicBoolean(false);\n+        TaskLifeCycleEventListener listener = new DefaultTaskEventListener() {\n+            @Override\n+            public void afterTaskActivatedEvent(TaskEvent event) {\n+                triggered.set(true);\n+            }\n+\n+        };\n+        RuntimeEngine engine = getRuntimeEngine();\n+        TaskService taskService = engine.getTaskService();\n+        ((EventService<TaskLifeCycleEventListener>) taskService).registerTaskEventListener(listener);\n+        ProcessInstance pi = ksession.startProcess(HUMAN_TASK_LISTENER_ID);\n+        long processInstanceId = pi.getId();\n+\n+        List<Long> idList = taskService.getTasksByProcessInstanceId(processInstanceId);\n+        for (long taskId : idList) {\n+            taskService.start(taskId, \"john\");\n+            taskService.complete(taskId, \"john\", emptyMap());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAzNDQ5MA=="}, "originalCommit": {"oid": "6feccbf88349380b75bc1015790a8053594edd5f"}, "originalPosition": 75}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1855, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}