{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3ODc0Njgx", "number": 1672, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNTo0NzozMlrOEDAcyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMzozODo0NlrOEMfgSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTg4NTU0OnYy", "diffSide": "RIGHT", "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/Timer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNTo0NzozMlrOGfz31g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMjowNjo1OFrOGgarbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAwODkxOA==", "bodyText": "Add name to the toString of this class", "url": "https://github.com/kiegroup/jbpm/pull/1672#discussion_r436008918", "createdAt": "2020-06-05T15:47:32Z", "author": {"login": "gmunozfe"}, "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/Timer.java", "diffHunk": "@@ -32,7 +32,16 @@\n     private String period;\n     private String date;\n     private int timeType;\n+    private String name;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53a73384973f4aeb02d656c3e5a751593bad49a9"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY0NDcxOA==", "bodyText": "done", "url": "https://github.com/kiegroup/jbpm/pull/1672#discussion_r436644718", "createdAt": "2020-06-08T12:06:58Z", "author": {"login": "fjtirado"}, "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/Timer.java", "diffHunk": "@@ -32,7 +32,16 @@\n     private String period;\n     private String date;\n     private int timeType;\n+    private String name;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAwODkxOA=="}, "originalCommit": {"oid": "53a73384973f4aeb02d656c3e5a751593bad49a9"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTg4ODYzOnYy", "diffSide": "RIGHT", "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/functional/timer/GlobalQuartzDBTimerServiceTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNTo0ODoxOVrOGfz5rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNTo0ODoxOVrOGfz5rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAwOTM5MA==", "bodyText": "typo \"timer\", not ticket", "url": "https://github.com/kiegroup/jbpm/pull/1672#discussion_r436009390", "createdAt": "2020-06-05T15:48:19Z", "author": {"login": "gmunozfe"}, "path": "jbpm-test-coverage/src/test/java/org/jbpm/test/functional/timer/GlobalQuartzDBTimerServiceTest.java", "diffHunk": "@@ -342,10 +342,12 @@ public void testTimerRequiresRecoveryFlagSet() throws Exception {\n             connection = ((DataSource)InitialContext.doLookup(\"jdbc/jbpm-ds\")).getConnection();\n             stmt = connection.createStatement();\n \n-            ResultSet resultSet = stmt.executeQuery(\"select REQUESTS_RECOVERY from QRTZ_JOB_DETAILS\");\n+            ResultSet resultSet = stmt.executeQuery(\"select REQUESTS_RECOVERY, JOB_NAME from QRTZ_JOB_DETAILS\");\n             while(resultSet.next()) {\n                 boolean requestsRecovery = resultSet.getBoolean(1);\n                 assertEquals(\"Requests recovery must be set to true\", true, requestsRecovery);\n+                String jobName = resultSet.getString(2);\n+                assertTrue(jobName + \" does not contain ticket name\", jobName.contains(\"Boundary Event\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53a73384973f4aeb02d656c3e5a751593bad49a9"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxODY5NjExOnYy", "diffSide": "RIGHT", "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/impl/ThreadPoolSchedulerService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwMDozNjoyNVrOGgMzQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMjowNjo0NVrOGgarAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQxNzM0Nw==", "bodyText": "This replacement is not exactly as it was before, as only has to return the activeTime if ctx is instance of ProcessJobContext (missing this condition for all the block, though it's evaluated also inside helper class), wdyt?", "url": "https://github.com/kiegroup/jbpm/pull/1672#discussion_r436417347", "createdAt": "2020-06-08T00:36:25Z", "author": {"login": "gmunozfe"}, "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/impl/ThreadPoolSchedulerService.java", "diffHunk": "@@ -93,18 +92,11 @@ public JobHandle scheduleJob(Job job, JobContext ctx, Trigger trigger) {\n \n         Date date = trigger.hasNextFireTime();\n         if ( date != null ) {\n-            String jobname = null;\n-            if (ctx instanceof ProcessJobContext) {\n-                ProcessJobContext processCtx = (ProcessJobContext) ctx;\n-                jobname = processCtx.getSessionId() + \"-\" + processCtx.getProcessInstanceId() + \"-\" + processCtx.getTimer().getId();\n-                if (processCtx instanceof StartProcessJobContext) {\n-                    jobname = \"StartProcess-\"+((StartProcessJobContext) processCtx).getProcessId()+ \"-\" + processCtx.getTimer().getId();\n-                }\n-                if (activeTimer.containsKey(jobname)) {\n-                    return activeTimer.get(jobname);\n-                }\n-            \n+            String jobname = QuartzNameHelper.getJobName(ctx);\n+            if (activeTimer.containsKey(jobname)) {\n+                return activeTimer.get(jobname);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad71a1903f757e2a0bced1132dd9b6b95470f7f8"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY0NDYxMA==", "bodyText": "I think regardless of the job type, it should not be created again if already exist a unique job name for it", "url": "https://github.com/kiegroup/jbpm/pull/1672#discussion_r436644610", "createdAt": "2020-06-08T12:06:45Z", "author": {"login": "fjtirado"}, "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/impl/ThreadPoolSchedulerService.java", "diffHunk": "@@ -93,18 +92,11 @@ public JobHandle scheduleJob(Job job, JobContext ctx, Trigger trigger) {\n \n         Date date = trigger.hasNextFireTime();\n         if ( date != null ) {\n-            String jobname = null;\n-            if (ctx instanceof ProcessJobContext) {\n-                ProcessJobContext processCtx = (ProcessJobContext) ctx;\n-                jobname = processCtx.getSessionId() + \"-\" + processCtx.getProcessInstanceId() + \"-\" + processCtx.getTimer().getId();\n-                if (processCtx instanceof StartProcessJobContext) {\n-                    jobname = \"StartProcess-\"+((StartProcessJobContext) processCtx).getProcessId()+ \"-\" + processCtx.getTimer().getId();\n-                }\n-                if (activeTimer.containsKey(jobname)) {\n-                    return activeTimer.get(jobname);\n-                }\n-            \n+            String jobname = QuartzNameHelper.getJobName(ctx);\n+            if (activeTimer.containsKey(jobname)) {\n+                return activeTimer.get(jobname);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQxNzM0Nw=="}, "originalCommit": {"oid": "ad71a1903f757e2a0bced1132dd9b6b95470f7f8"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMDAxMjUzOnYy", "diffSide": "RIGHT", "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/impl/QuartzNameHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMToxOToyMVrOGgZX2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMjowNDoyM1rOGgamwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYyMzMyMA==", "bodyText": "update to 2020", "url": "https://github.com/kiegroup/jbpm/pull/1672#discussion_r436623320", "createdAt": "2020-06-08T11:19:21Z", "author": {"login": "gmunozfe"}, "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/impl/QuartzNameHelper.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2017 Red Hat, Inc. and/or its affiliates.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e20ff3acac3b932694ab452ddb70ef69829eeb1a"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY0MzUyMA==", "bodyText": "Done", "url": "https://github.com/kiegroup/jbpm/pull/1672#discussion_r436643520", "createdAt": "2020-06-08T12:04:23Z", "author": {"login": "fjtirado"}, "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/impl/QuartzNameHelper.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2017 Red Hat, Inc. and/or its affiliates.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYyMzMyMA=="}, "originalCommit": {"oid": "e20ff3acac3b932694ab452ddb70ef69829eeb1a"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMDAxNDQ0OnYy", "diffSide": "RIGHT", "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/impl/QuartzNameHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMToxOTo1OFrOGgZZAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMTo0ODoxMFrOGgaJuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYyMzYxNg==", "bodyText": "Shouldn't it be \"public\"?", "url": "https://github.com/kiegroup/jbpm/pull/1672#discussion_r436623616", "createdAt": "2020-06-08T11:19:58Z", "author": {"login": "gmunozfe"}, "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/impl/QuartzNameHelper.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2017 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.jbpm.process.core.timer.impl;\n+\n+import org.drools.core.time.JobContext;\n+import org.jbpm.process.core.timer.NamedJobContext;\n+import org.jbpm.process.instance.timer.TimerManager.ProcessJobContext;\n+import org.jbpm.process.instance.timer.TimerManager.StartProcessJobContext;\n+import org.kie.api.runtime.EnvironmentName;\n+\n+class QuartzNameHelper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e20ff3acac3b932694ab452ddb70ef69829eeb1a"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzNjA5MQ==", "bodyText": "Once this class is used also for EJbTimer, yes, it should be public, before was package becuase it was only used for Quartz ones", "url": "https://github.com/kiegroup/jbpm/pull/1672#discussion_r436636091", "createdAt": "2020-06-08T11:48:10Z", "author": {"login": "fjtirado"}, "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/impl/QuartzNameHelper.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2017 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.jbpm.process.core.timer.impl;\n+\n+import org.drools.core.time.JobContext;\n+import org.jbpm.process.core.timer.NamedJobContext;\n+import org.jbpm.process.instance.timer.TimerManager.ProcessJobContext;\n+import org.jbpm.process.instance.timer.TimerManager.StartProcessJobContext;\n+import org.kie.api.runtime.EnvironmentName;\n+\n+class QuartzNameHelper {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYyMzYxNg=="}, "originalCommit": {"oid": "e20ff3acac3b932694ab452ddb70ef69829eeb1a"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNTM0MTQ3OnYy", "diffSide": "RIGHT", "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/impl/ThreadPoolSchedulerService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMzozNzo1NFrOGuocyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMzozNzo1NFrOGuocyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU1MDQwOA==", "bodyText": "@mswiderski So until now if the JobContext was other than  ProcessJobContext the job name was left null and such job wasn't put in the map of active timers, right? So for example for TaskDeadlineJobContext (instance of NamedJobContext) we might have ended up with the same timer scheduled more than once? So was that actually a bug?\nAs right now we will create a job name for every possible JobContext using JobNameHelper and that also means all timers will be remembered.", "url": "https://github.com/kiegroup/jbpm/pull/1672#discussion_r451550408", "createdAt": "2020-07-08T13:37:54Z", "author": {"login": "MarianMacik"}, "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/impl/ThreadPoolSchedulerService.java", "diffHunk": "@@ -91,21 +91,15 @@ public void shutdown() {\n     @Override\n     public JobHandle scheduleJob(Job job, JobContext ctx, Trigger trigger) {\n \n+        long id = idCounter.getAndIncrement(); \n         Date date = trigger.hasNextFireTime();\n         if ( date != null ) {\n-            String jobname = null;\n-            if (ctx instanceof ProcessJobContext) {\n-                ProcessJobContext processCtx = (ProcessJobContext) ctx;\n-                jobname = processCtx.getSessionId() + \"-\" + processCtx.getProcessInstanceId() + \"-\" + processCtx.getTimer().getId();\n-                if (processCtx instanceof StartProcessJobContext) {\n-                    jobname = \"StartProcess-\"+((StartProcessJobContext) processCtx).getProcessId()+ \"-\" + processCtx.getTimer().getId();\n-                }\n-                if (activeTimer.containsKey(jobname)) {\n-                    return activeTimer.get(jobname);\n-                }\n-            \n+            String jobname = JobNameHelper.getJobName(ctx, id);\n+            if (activeTimer.containsKey(jobname)) {\n+                return activeTimer.get(jobname);\n             }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d41897b87f2656440302eab95c4db169be7c76e5"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNTM0NTM3OnYy", "diffSide": "RIGHT", "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/JobNameHelper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMzozODo0NlrOGuofIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMzozODo0NlrOGuofIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU1MTAxMA==", "bodyText": "Just a readability thing processCtx.getTimer().getName() could be extracted on a new line so the whole line is shorter and easier to read.", "url": "https://github.com/kiegroup/jbpm/pull/1672#discussion_r451551010", "createdAt": "2020-07-08T13:38:46Z", "author": {"login": "MarianMacik"}, "path": "jbpm-flow/src/main/java/org/jbpm/process/core/timer/JobNameHelper.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.jbpm.process.core.timer;\n+\n+import org.drools.core.time.JobContext;\n+import org.jbpm.process.instance.timer.TimerManager.ProcessJobContext;\n+import org.jbpm.process.instance.timer.TimerManager.StartProcessJobContext;\n+import org.kie.api.runtime.EnvironmentName;\n+\n+public class JobNameHelper {\n+\n+    private JobNameHelper() {}\n+\n+    public static String getJobName(JobContext ctx, long id) {\n+        return getJobName(ctx, getGroupName(ctx), id);\n+    }\n+\n+    public static String getJobName(JobContext ctx, String groupName, long id) {\n+        String jobName;\n+        if (ctx instanceof ProcessJobContext) {\n+            ProcessJobContext processCtx = (ProcessJobContext) ctx;\n+            final String timerName = \"-\" + (processCtx.getTimer().getName() != null && !processCtx.getTimer().getName().isEmpty() ? processCtx.getTimer().getName() + \"-\" : \"\") + processCtx.getTimer().getId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d41897b87f2656440302eab95c4db169be7c76e5"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1724, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}