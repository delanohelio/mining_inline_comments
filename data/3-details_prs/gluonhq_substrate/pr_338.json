{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0MzgzNTM4", "number": 338, "title": "Download android toolchain if needed", "bodyText": "Adds automatic download of Android SDK/NDK, includes libffi to android target, adds llvm fixes.\nWIP", "createdAt": "2020-02-12T15:50:19Z", "url": "https://github.com/gluonhq/substrate/pull/338", "merged": true, "mergeCommit": {"oid": "9ca55fe8008101fc01d406449018565581ca3591"}, "closed": true, "closedAt": "2020-02-17T10:38:16Z", "author": {"login": "lazar-mitrovic"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDanEyAH2gAyMzc0MzgzNTM4Ojc5Zjc1NGM2YzE3ZmIwMzhiYTdkOGQ0ZjI2N2ExMGZkZDc1ODIzNmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEST4PgH2gAyMzc0MzgzNTM4OjFmMjYxMDljOTAyNTRjY2Y3ZGZlMTAyOTU5ZjllYmFlNTk5MDk3ZDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "79f754c6c17fb038ba7d8d4f267a10fdd758236e", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/79f754c6c17fb038ba7d8d4f267a10fdd758236e", "committedDate": "2020-02-11T23:48:04Z", "message": "Download Android toolchain if needed\n\n+ llvm fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95aa7fb9a8de83e1ba8d8d29c2d4fbbf48e657b0", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/95aa7fb9a8de83e1ba8d8d29c2d4fbbf48e657b0", "committedDate": "2020-02-12T14:56:46Z", "message": "Remove unused dependencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c560a3c980a92419f5c4a9af58b9295ce4513188", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/c560a3c980a92419f5c4a9af58b9295ce4513188", "committedDate": "2020-02-12T15:03:20Z", "message": "Add comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffeae62869be0d31e0b9f2aea1ff7015ce516e68", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/ffeae62869be0d31e0b9f2aea1ff7015ce516e68", "committedDate": "2020-02-12T15:45:01Z", "message": "Small fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NjE2MDcx", "url": "https://github.com/gluonhq/substrate/pull/338#pullrequestreview-357616071", "createdAt": "2020-02-12T16:48:51Z", "commit": {"oid": "ffeae62869be0d31e0b9f2aea1ff7015ce516e68"}, "state": "COMMENTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNjo0ODo1MVrOFo2Xtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNzoyMTowOFrOFo3jhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM3ODE2Nw==", "bodyText": "Probably better: Constants.OS_ANDROID.equals(configuration.getTargetTriplet().getOs())?", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378378167", "createdAt": "2020-02-12T16:48:51Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -213,6 +224,25 @@ private boolean setupDependencies() throws IOException {\n                 }\n             }\n         }\n+        // Android\n+        if (target.startsWith(\"android\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeae62869be0d31e0b9f2aea1ff7015ce516e68"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM3ODgxOA==", "bodyText": "lowercase: androidSdk, androidNdk", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378378818", "createdAt": "2020-02-12T16:49:45Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -213,6 +224,25 @@ private boolean setupDependencies() throws IOException {\n                 }\n             }\n         }\n+        // Android\n+        if (target.startsWith(\"android\")) {\n+            Path AndroidSdk = configuration.getAndroidSdkPath();\n+            Path AndroidNdk = configuration.getAndroidNdkPath();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeae62869be0d31e0b9f2aea1ff7015ce516e68"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4MjQzNQ==", "bodyText": "I installed Android SDK 27 manually, I don't have a java11 file or folder?", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378382435", "createdAt": "2020-02-12T16:55:23Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -213,6 +224,25 @@ private boolean setupDependencies() throws IOException {\n                 }\n             }\n         }\n+        // Android\n+        if (target.startsWith(\"android\")) {\n+            Path AndroidSdk = configuration.getAndroidSdkPath();\n+            Path AndroidNdk = configuration.getAndroidNdkPath();\n+\n+            Path libsLocation = AndroidSdk.resolve(\"tools\").resolve(\"lib\").resolve(\"java11\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeae62869be0d31e0b9f2aea1ff7015ce516e68"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4MjczNw==", "bodyText": "Add javadoc", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378382737", "createdAt": "2020-02-12T16:55:52Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -319,4 +358,52 @@ private void downloadJavaFXZip(String osarch, Path substratePath ) throws IOExce\n         Logger.logDebug(\"Process zip javafx done\");\n     }\n \n-}\n+    private void downloadAndroidSdkZip() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeae62869be0d31e0b9f2aea1ff7015ce516e68"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4NDAyMg==", "bodyText": "Use Logger.logDebug()", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378384022", "createdAt": "2020-02-12T16:58:01Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -319,4 +358,52 @@ private void downloadJavaFXZip(String osarch, Path substratePath ) throws IOExce\n         Logger.logDebug(\"Process zip javafx done\");\n     }\n \n-}\n+    private void downloadAndroidSdkZip() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        String hostOs = configuration.getHostTriplet().getOs();\n+        String androidSdkUrl = Strings.substitute(ANDROID_SDK_URL, Map.of(\"host\", hostOs));\n+        System.out.println(\"Downloading Android SDK...\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeae62869be0d31e0b9f2aea1ff7015ce516e68"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4NDUwNw==", "bodyText": "Same here (javadoc, logger)", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378384507", "createdAt": "2020-02-12T16:58:50Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -319,4 +358,52 @@ private void downloadJavaFXZip(String osarch, Path substratePath ) throws IOExce\n         Logger.logDebug(\"Process zip javafx done\");\n     }\n \n-}\n+    private void downloadAndroidSdkZip() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        String hostOs = configuration.getHostTriplet().getOs();\n+        String androidSdkUrl = Strings.substitute(ANDROID_SDK_URL, Map.of(\"host\", hostOs));\n+        System.out.println(\"Downloading Android SDK...\");\n+        FileOps.downloadAndUnzip(androidSdkUrl, sdk.getParent(), \"android-sdk.zip\", sdk.getFileName().toString(), \"\");\n+        System.out.println(\"Done\");\n+    }\n+\n+    private void downloadAdditionalAndroidLibs() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeae62869be0d31e0b9f2aea1ff7015ce516e68"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4NDY5Ng==", "bodyText": "and here", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378384696", "createdAt": "2020-02-12T16:59:08Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -319,4 +358,52 @@ private void downloadJavaFXZip(String osarch, Path substratePath ) throws IOExce\n         Logger.logDebug(\"Process zip javafx done\");\n     }\n \n-}\n+    private void downloadAndroidSdkZip() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        String hostOs = configuration.getHostTriplet().getOs();\n+        String androidSdkUrl = Strings.substitute(ANDROID_SDK_URL, Map.of(\"host\", hostOs));\n+        System.out.println(\"Downloading Android SDK...\");\n+        FileOps.downloadAndUnzip(androidSdkUrl, sdk.getParent(), \"android-sdk.zip\", sdk.getFileName().toString(), \"\");\n+        System.out.println(\"Done\");\n+    }\n+\n+    private void downloadAdditionalAndroidLibs() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        Path libsLocation = sdk.resolve(\"tools\").resolve(\"lib\").resolve(\"java11\");\n+\n+        Files.createDirectories(libsLocation);\n+        System.out.println(\"Downloading additional libs ...\");\n+        for (String url : ANDROID_DEPS) {\n+            URL link = new URL(url);\n+            String filename = url.substring(url.lastIndexOf('/')+1, url.length());\n+            FileOps.downloadFile(link, libsLocation.resolve(filename));\n+        }\n+        System.out.println(\"Done\");\n+    }\n+\n+    private void androidSdkManager(String[] args) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeae62869be0d31e0b9f2aea1ff7015ce516e68"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4ODUwMg==", "bodyText": "What Java version is required? Probably better to use full path (i.e $JAVA_HOME/bin/java), verifying that JAVA_HOME is set, or even publicConfig.getGraalPath() if that works as well?", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378388502", "createdAt": "2020-02-12T17:05:37Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -319,4 +358,52 @@ private void downloadJavaFXZip(String osarch, Path substratePath ) throws IOExce\n         Logger.logDebug(\"Process zip javafx done\");\n     }\n \n-}\n+    private void downloadAndroidSdkZip() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        String hostOs = configuration.getHostTriplet().getOs();\n+        String androidSdkUrl = Strings.substitute(ANDROID_SDK_URL, Map.of(\"host\", hostOs));\n+        System.out.println(\"Downloading Android SDK...\");\n+        FileOps.downloadAndUnzip(androidSdkUrl, sdk.getParent(), \"android-sdk.zip\", sdk.getFileName().toString(), \"\");\n+        System.out.println(\"Done\");\n+    }\n+\n+    private void downloadAdditionalAndroidLibs() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        Path libsLocation = sdk.resolve(\"tools\").resolve(\"lib\").resolve(\"java11\");\n+\n+        Files.createDirectories(libsLocation);\n+        System.out.println(\"Downloading additional libs ...\");\n+        for (String url : ANDROID_DEPS) {\n+            URL link = new URL(url);\n+            String filename = url.substring(url.lastIndexOf('/')+1, url.length());\n+            FileOps.downloadFile(link, libsLocation.resolve(filename));\n+        }\n+        System.out.println(\"Done\");\n+    }\n+\n+    private void androidSdkManager(String[] args) {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        Path tools = sdk.resolve(\"tools\");\n+        Path libs = tools.resolve(\"lib\");\n+        Path additionalLibs = libs.resolve(\"java11\");\n+\n+        ProcessRunner sdkmanager = new ProcessRunner(\"java\", \"-Dcom.android.sdklib.toolsdir=\" + tools, \"-classpath\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeae62869be0d31e0b9f2aea1ff7015ce516e68"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4OTUxOQ==", "bodyText": "Probably add exceptions to method signature instead?", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378389519", "createdAt": "2020-02-12T17:07:11Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -319,4 +358,52 @@ private void downloadJavaFXZip(String osarch, Path substratePath ) throws IOExce\n         Logger.logDebug(\"Process zip javafx done\");\n     }\n \n-}\n+    private void downloadAndroidSdkZip() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        String hostOs = configuration.getHostTriplet().getOs();\n+        String androidSdkUrl = Strings.substitute(ANDROID_SDK_URL, Map.of(\"host\", hostOs));\n+        System.out.println(\"Downloading Android SDK...\");\n+        FileOps.downloadAndUnzip(androidSdkUrl, sdk.getParent(), \"android-sdk.zip\", sdk.getFileName().toString(), \"\");\n+        System.out.println(\"Done\");\n+    }\n+\n+    private void downloadAdditionalAndroidLibs() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        Path libsLocation = sdk.resolve(\"tools\").resolve(\"lib\").resolve(\"java11\");\n+\n+        Files.createDirectories(libsLocation);\n+        System.out.println(\"Downloading additional libs ...\");\n+        for (String url : ANDROID_DEPS) {\n+            URL link = new URL(url);\n+            String filename = url.substring(url.lastIndexOf('/')+1, url.length());\n+            FileOps.downloadFile(link, libsLocation.resolve(filename));\n+        }\n+        System.out.println(\"Done\");\n+    }\n+\n+    private void androidSdkManager(String[] args) {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        Path tools = sdk.resolve(\"tools\");\n+        Path libs = tools.resolve(\"lib\");\n+        Path additionalLibs = libs.resolve(\"java11\");\n+\n+        ProcessRunner sdkmanager = new ProcessRunner(\"java\", \"-Dcom.android.sdklib.toolsdir=\" + tools, \"-classpath\",\n+                libs + \"/*:\" + additionalLibs + \"/*\", \"com.android.sdklib.tool.sdkmanager.SdkManagerCli\");\n+        sdkmanager.addArgs(args);\n+        sdkmanager.setInteractive(true); // Needed to accept EULA and show download progress\n+\n+        System.out.println(\"Running sdkmanager with: \" + sdkmanager.getCmd());\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeae62869be0d31e0b9f2aea1ff7015ce516e68"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5MDEyNA==", "bodyText": "Probably warn the user with a logged message that he/she will be prompted", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378390124", "createdAt": "2020-02-12T17:08:11Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -319,4 +358,52 @@ private void downloadJavaFXZip(String osarch, Path substratePath ) throws IOExce\n         Logger.logDebug(\"Process zip javafx done\");\n     }\n \n-}\n+    private void downloadAndroidSdkZip() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        String hostOs = configuration.getHostTriplet().getOs();\n+        String androidSdkUrl = Strings.substitute(ANDROID_SDK_URL, Map.of(\"host\", hostOs));\n+        System.out.println(\"Downloading Android SDK...\");\n+        FileOps.downloadAndUnzip(androidSdkUrl, sdk.getParent(), \"android-sdk.zip\", sdk.getFileName().toString(), \"\");\n+        System.out.println(\"Done\");\n+    }\n+\n+    private void downloadAdditionalAndroidLibs() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        Path libsLocation = sdk.resolve(\"tools\").resolve(\"lib\").resolve(\"java11\");\n+\n+        Files.createDirectories(libsLocation);\n+        System.out.println(\"Downloading additional libs ...\");\n+        for (String url : ANDROID_DEPS) {\n+            URL link = new URL(url);\n+            String filename = url.substring(url.lastIndexOf('/')+1, url.length());\n+            FileOps.downloadFile(link, libsLocation.resolve(filename));\n+        }\n+        System.out.println(\"Done\");\n+    }\n+\n+    private void androidSdkManager(String[] args) {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        Path tools = sdk.resolve(\"tools\");\n+        Path libs = tools.resolve(\"lib\");\n+        Path additionalLibs = libs.resolve(\"java11\");\n+\n+        ProcessRunner sdkmanager = new ProcessRunner(\"java\", \"-Dcom.android.sdklib.toolsdir=\" + tools, \"-classpath\",\n+                libs + \"/*:\" + additionalLibs + \"/*\", \"com.android.sdklib.tool.sdkmanager.SdkManagerCli\");\n+        sdkmanager.addArgs(args);\n+        sdkmanager.setInteractive(true); // Needed to accept EULA and show download progress", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeae62869be0d31e0b9f2aea1ff7015ce516e68"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5MTA2OA==", "bodyText": "don't use static, once set it will be used by all the processes (there is a pending PR to remove the static for the other booleans too)", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378391068", "createdAt": "2020-02-12T17:09:54Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/ProcessRunner.java", "diffHunk": "@@ -57,6 +57,7 @@\n     private static boolean info;\n     private static boolean logToFile;\n     private final Path processLogPath;\n+    private static boolean interactive;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeae62869be0d31e0b9f2aea1ff7015ce516e68"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5NzU3Mw==", "bodyText": "I'm not sure it we should expose this method... We access it through getJavaSDKLibsPath() and getJavaFXSDKLibsPath(), as we also need to get the path to those libraries, and when not found, we download them with setupDependencies().\nIn case of Android, I'd do something similar:\n\npublic Path getAndroidSDKPath() throws IOException {\n        return resolvePath(configuration.getAndroidSdkPath(),\"Fatal error, could not install Android SDK \");\n    }\npublic Path getAndroidNDKPath() throws IOException {\n        return resolvePath(configuration.getAndroidNdkPath(),\"Fatal error, could not install Android NDK \");\n    }", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378397573", "createdAt": "2020-02-12T17:21:08Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -130,7 +140,7 @@ private Path resolvePath(Path path, String errorMessage) throws IOException {\n      * @return true if the processed ended succesfully, false otherwise\n      * @throws IOException in case default path for Substrate dependencies can't be created\n      */\n-    private boolean setupDependencies() throws IOException {\n+    public boolean setupDependencies() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeae62869be0d31e0b9f2aea1ff7015ce516e68"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d78e7946b2dbddf7a7543701a87db5f245f07180", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/d78e7946b2dbddf7a7543701a87db5f245f07180", "committedDate": "2020-02-13T12:23:33Z", "message": "Various fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4Mjk0Mzg1", "url": "https://github.com/gluonhq/substrate/pull/338#pullrequestreview-358294385", "createdAt": "2020-02-13T15:10:39Z", "commit": {"oid": "d78e7946b2dbddf7a7543701a87db5f245f07180"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNToxMDozOVrOFpXe-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNToxMDozOVrOFpXe-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkyMDY5OA==", "bodyText": "Don't we want to fail as fast as possible? When an IOException occurs, it probably means that something failed during the automatic download of the android tools (SDK, NDK or additional libraries). The user will most likely get the following error message instead:\n\nYou specified an android ndk, but it doesn't contain /toolchains/llvm/prebuilt/linux-x86_64/bin/ldlld\n\nThis is both cryptic and and a bit misleading, because the error might be for instance that the download of the Android SDK failed because of http proxy issues. Or any other actual IO exception that caused the download, unpacking or installing any of the android tools to fail.", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378920698", "createdAt": "2020-02-13T15:10:39Z", "author": {"login": "tiainen"}, "path": "src/main/java/com/gluonhq/substrate/target/AndroidTargetConfiguration.java", "diffHunk": "@@ -70,25 +70,25 @@\n \n     public AndroidTargetConfiguration( ProcessPaths paths, InternalProjectConfiguration configuration ) {\n         super(paths,configuration);\n-        // for now, we need to have an ANDROID_NDK\n-        // we will fail fast whenever a method is invoked that uses it (e.g. compile)\n-        String sysndk = System.getenv(\"ANDROID_NDK\");\n-        if (sysndk != null) {\n-            this.ndk = sysndk;\n-            Path ldguess = Paths.get(this.ndk, \"toolchains\", \"llvm\", \"prebuilt\", \"linux-x86_64\", \"bin\", \"ld.lld\");\n-            if (Files.exists(ldguess)) {\n-                ldlld = ldguess;\n-            } else {\n-                ldlld = null;\n-            }\n-            Path clangguess = Paths.get(this.ndk, \"toolchains\", \"llvm\", \"prebuilt\", \"linux-x86_64\", \"bin\", \"clang\");\n-            clang = Files.exists(clangguess) ? clangguess : null;\n-        } else {\n-            this.ndk = null;\n-            this.ldlld = null;\n-            this.clang = null;\n+        \n+        String tmpSdk = \"\";\n+        String tmpNdk = \"\";\n+\n+        try { \n+            tmpSdk = fileDeps.getAndroidSDKPath().toString();\n+            tmpNdk = fileDeps.getAndroidNDKPath().toString();\n+        } catch (IOException e) {\n+            e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78e7946b2dbddf7a7543701a87db5f245f07180"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MzM1NjEz", "url": "https://github.com/gluonhq/substrate/pull/338#pullrequestreview-358335613", "createdAt": "2020-02-13T15:57:31Z", "commit": {"oid": "d78e7946b2dbddf7a7543701a87db5f245f07180"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNTo1NzozMVrOFpZayA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNTo1OTo0MFrOFpZgHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk1MjM5Mg==", "bodyText": "Use Logger.logDebug instead", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378952392", "createdAt": "2020-02-13T15:57:31Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -319,4 +387,67 @@ private void downloadJavaFXZip(String osarch, Path substratePath ) throws IOExce\n         Logger.logDebug(\"Process zip javafx done\");\n     }\n \n-}\n+    /**\n+     * Crafts Android SDK url and then downloads it \n+     * @throws IOException in case anything goes wrong.\n+     */\n+    private void downloadAndroidSdkZip() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        String hostOs = configuration.getHostTriplet().getOs();\n+        String androidSdkUrl = Strings.substitute(ANDROID_SDK_URL, Map.of(\"host\", hostOs));\n+        Logger.logInfo(\"Downloading Android SDK...\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78e7946b2dbddf7a7543701a87db5f245f07180"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk1MzA5MA==", "bodyText": "Maybe it can be removed. If not, use Logger.logDebug with a more descriptive message", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378953090", "createdAt": "2020-02-13T15:58:39Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -319,4 +387,67 @@ private void downloadJavaFXZip(String osarch, Path substratePath ) throws IOExce\n         Logger.logDebug(\"Process zip javafx done\");\n     }\n \n-}\n+    /**\n+     * Crafts Android SDK url and then downloads it \n+     * @throws IOException in case anything goes wrong.\n+     */\n+    private void downloadAndroidSdkZip() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        String hostOs = configuration.getHostTriplet().getOs();\n+        String androidSdkUrl = Strings.substitute(ANDROID_SDK_URL, Map.of(\"host\", hostOs));\n+        Logger.logInfo(\"Downloading Android SDK...\");\n+        FileOps.downloadAndUnzip(androidSdkUrl, sdk.getParent(), \"android-sdk.zip\", sdk.getFileName().toString(), \"\");\n+        Logger.logInfo(\"Done\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78e7946b2dbddf7a7543701a87db5f245f07180"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk1MzE4Ng==", "bodyText": "Same here", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378953186", "createdAt": "2020-02-13T15:58:49Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -319,4 +387,67 @@ private void downloadJavaFXZip(String osarch, Path substratePath ) throws IOExce\n         Logger.logDebug(\"Process zip javafx done\");\n     }\n \n-}\n+    /**\n+     * Crafts Android SDK url and then downloads it \n+     * @throws IOException in case anything goes wrong.\n+     */\n+    private void downloadAndroidSdkZip() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        String hostOs = configuration.getHostTriplet().getOs();\n+        String androidSdkUrl = Strings.substitute(ANDROID_SDK_URL, Map.of(\"host\", hostOs));\n+        Logger.logInfo(\"Downloading Android SDK...\");\n+        FileOps.downloadAndUnzip(androidSdkUrl, sdk.getParent(), \"android-sdk.zip\", sdk.getFileName().toString(), \"\");\n+        Logger.logInfo(\"Done\");\n+    }\n+    /**\n+     * Downloads libraries needed for Android SDK's sdkmanager \n+     * @throws IOException in case anything goes wrong.\n+     */\n+    private void downloadAdditionalAndroidLibs() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        Path libsLocation = sdk.resolve(\"tools\").resolve(\"lib\").resolve(\"java11\");\n+\n+        Files.createDirectories(libsLocation);\n+        Logger.logInfo(\"Downloading additional libs ...\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78e7946b2dbddf7a7543701a87db5f245f07180"}, "originalPosition": 140}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk1MzMzNQ==", "bodyText": "And here", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378953335", "createdAt": "2020-02-13T15:59:01Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -319,4 +387,67 @@ private void downloadJavaFXZip(String osarch, Path substratePath ) throws IOExce\n         Logger.logDebug(\"Process zip javafx done\");\n     }\n \n-}\n+    /**\n+     * Crafts Android SDK url and then downloads it \n+     * @throws IOException in case anything goes wrong.\n+     */\n+    private void downloadAndroidSdkZip() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        String hostOs = configuration.getHostTriplet().getOs();\n+        String androidSdkUrl = Strings.substitute(ANDROID_SDK_URL, Map.of(\"host\", hostOs));\n+        Logger.logInfo(\"Downloading Android SDK...\");\n+        FileOps.downloadAndUnzip(androidSdkUrl, sdk.getParent(), \"android-sdk.zip\", sdk.getFileName().toString(), \"\");\n+        Logger.logInfo(\"Done\");\n+    }\n+    /**\n+     * Downloads libraries needed for Android SDK's sdkmanager \n+     * @throws IOException in case anything goes wrong.\n+     */\n+    private void downloadAdditionalAndroidLibs() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        Path libsLocation = sdk.resolve(\"tools\").resolve(\"lib\").resolve(\"java11\");\n+\n+        Files.createDirectories(libsLocation);\n+        Logger.logInfo(\"Downloading additional libs ...\");\n+        for (String url : ANDROID_DEPS) {\n+            URL link = new URL(url);\n+            String filename = url.substring(url.lastIndexOf('/')+1, url.length());\n+            FileOps.downloadFile(link, libsLocation.resolve(filename));\n+        }\n+        Logger.logInfo(\"Done\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78e7946b2dbddf7a7543701a87db5f245f07180"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk1Mzc1Nw==", "bodyText": "And here", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r378953757", "createdAt": "2020-02-13T15:59:40Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -319,4 +387,67 @@ private void downloadJavaFXZip(String osarch, Path substratePath ) throws IOExce\n         Logger.logDebug(\"Process zip javafx done\");\n     }\n \n-}\n+    /**\n+     * Crafts Android SDK url and then downloads it \n+     * @throws IOException in case anything goes wrong.\n+     */\n+    private void downloadAndroidSdkZip() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        String hostOs = configuration.getHostTriplet().getOs();\n+        String androidSdkUrl = Strings.substitute(ANDROID_SDK_URL, Map.of(\"host\", hostOs));\n+        Logger.logInfo(\"Downloading Android SDK...\");\n+        FileOps.downloadAndUnzip(androidSdkUrl, sdk.getParent(), \"android-sdk.zip\", sdk.getFileName().toString(), \"\");\n+        Logger.logInfo(\"Done\");\n+    }\n+    /**\n+     * Downloads libraries needed for Android SDK's sdkmanager \n+     * @throws IOException in case anything goes wrong.\n+     */\n+    private void downloadAdditionalAndroidLibs() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        Path libsLocation = sdk.resolve(\"tools\").resolve(\"lib\").resolve(\"java11\");\n+\n+        Files.createDirectories(libsLocation);\n+        Logger.logInfo(\"Downloading additional libs ...\");\n+        for (String url : ANDROID_DEPS) {\n+            URL link = new URL(url);\n+            String filename = url.substring(url.lastIndexOf('/')+1, url.length());\n+            FileOps.downloadFile(link, libsLocation.resolve(filename));\n+        }\n+        Logger.logInfo(\"Done\");\n+    }\n+\n+    /**\n+     * Runs Android SDK's sdkmanager with specified arguments\n+     * @param args array of arguments to be passed to process\n+     * @throws IOException in case anything goes wrong.\n+     * @throws InterruptedException in case anything goes wrong.\n+     */\n+    private void androidSdkManager(String[] args) throws IOException, InterruptedException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        Path tools = sdk.resolve(\"tools\");\n+        Path libs = tools.resolve(\"lib\");\n+        Path additionalLibs = libs.resolve(\"java11\");\n+\n+        ProcessRunner sdkmanager = new ProcessRunner(Paths.get(configuration.getGraalPath().toString(), \"bin\", \"java\").toString(), \"-Dcom.android.sdklib.toolsdir=\" + tools, \"-classpath\",\n+                libs + \"/*:\" + additionalLibs + \"/*\", \"com.android.sdklib.tool.sdkmanager.SdkManagerCli\");\n+        sdkmanager.addArgs(args);\n+        sdkmanager.setInteractive(true); // Needed to accept EULA and show download progress\n+\n+        Logger.logInfo(\"Running sdkmanager with: \" + sdkmanager.getCmd());\n+        Logger.logInfo(\"You might be prompted to accept EULA.\");\n+        sdkmanager.runProcess(\"sdkmanager\");\n+    }\n+\n+    /**\n+     * Downloads Android NDK and build tools\n+     * @throws IOException in case anything goes wrong.\n+     * @throws InterruptedException in case anything goes wrong.\n+     */\n+    private void fetchFromSdkManager() throws IOException, InterruptedException {\n+        Logger.logInfo(\"Downloading Android toolchain...\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78e7946b2dbddf7a7543701a87db5f245f07180"}, "originalPosition": 177}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cff9476991456100c10625a73e584bdad4008772", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/cff9476991456100c10625a73e584bdad4008772", "committedDate": "2020-02-13T16:32:50Z", "message": "Various fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea5ad6cb21c307929c647dee758006c2dcc3d7c4", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/ea5ad6cb21c307929c647dee758006c2dcc3d7c4", "committedDate": "2020-02-13T16:36:25Z", "message": "Remove tab"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f01b24826e30e39eab3a96b01ad5b30d4355104e", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/f01b24826e30e39eab3a96b01ad5b30d4355104e", "committedDate": "2020-02-13T16:41:42Z", "message": "More descriptive messages"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NDQzNjQ1", "url": "https://github.com/gluonhq/substrate/pull/338#pullrequestreview-358443645", "createdAt": "2020-02-13T18:17:06Z", "commit": {"oid": "f01b24826e30e39eab3a96b01ad5b30d4355104e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxODoxNzowN1rOFpea-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxODoxNzowN1rOFpea-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzNDM2MQ==", "bodyText": "Missed this before: Can you move this to a constant on top of the file? We shouldn't have these hardcoded versions hidden in a method.", "url": "https://github.com/gluonhq/substrate/pull/338#discussion_r379034361", "createdAt": "2020-02-13T18:17:07Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/util/FileDeps.java", "diffHunk": "@@ -319,4 +387,67 @@ private void downloadJavaFXZip(String osarch, Path substratePath ) throws IOExce\n         Logger.logDebug(\"Process zip javafx done\");\n     }\n \n-}\n+    /**\n+     * Crafts Android SDK url and then downloads it \n+     * @throws IOException in case anything goes wrong.\n+     */\n+    private void downloadAndroidSdkZip() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        String hostOs = configuration.getHostTriplet().getOs();\n+        String androidSdkUrl = Strings.substitute(ANDROID_SDK_URL, Map.of(\"host\", hostOs));\n+        Logger.logDebug(\"Downloading Android SDK...\");\n+        FileOps.downloadAndUnzip(androidSdkUrl, sdk.getParent(), \"android-sdk.zip\", sdk.getFileName().toString(), \"\");\n+        Logger.logDebug(\"Done downloading Android SDK\");\n+    }\n+    /**\n+     * Downloads libraries needed for Android SDK's sdkmanager \n+     * @throws IOException in case anything goes wrong.\n+     */\n+    private void downloadAdditionalAndroidLibs() throws IOException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        Path libsLocation = sdk.resolve(\"tools\").resolve(\"lib\").resolve(\"java11\");\n+\n+        Files.createDirectories(libsLocation);\n+        Logger.logDebug(\"Downloading additional libs ...\");\n+        for (String url : ANDROID_DEPS) {\n+            URL link = new URL(url);\n+            String filename = url.substring(url.lastIndexOf('/')+1, url.length());\n+            FileOps.downloadFile(link, libsLocation.resolve(filename));\n+        }\n+        Logger.logDebug(\"Done downloading additional libs\");\n+    }\n+\n+    /**\n+     * Runs Android SDK's sdkmanager with specified arguments\n+     * @param args array of arguments to be passed to process\n+     * @throws IOException in case anything goes wrong.\n+     * @throws InterruptedException in case anything goes wrong.\n+     */\n+    private void androidSdkManager(String[] args) throws IOException, InterruptedException {\n+        Path sdk = configuration.getAndroidSdkPath();\n+        Path tools = sdk.resolve(\"tools\");\n+        Path libs = tools.resolve(\"lib\");\n+        Path additionalLibs = libs.resolve(\"java11\");\n+\n+        ProcessRunner sdkmanager = new ProcessRunner(Paths.get(configuration.getGraalPath().toString(), \"bin\", \"java\").toString(), \"-Dcom.android.sdklib.toolsdir=\" + tools, \"-classpath\",\n+                libs + \"/*:\" + additionalLibs + \"/*\", \"com.android.sdklib.tool.sdkmanager.SdkManagerCli\");\n+        sdkmanager.addArgs(args);\n+        sdkmanager.setInteractive(true); // Needed to accept EULA and show download progress\n+\n+        Logger.logDebug(\"Running sdkmanager with: \" + sdkmanager.getCmd());\n+        Logger.logDebug(\"You might be prompted to accept EULA.\");\n+        sdkmanager.runProcess(\"sdkmanager\");\n+    }\n+\n+    /**\n+     * Downloads Android NDK and build tools\n+     * @throws IOException in case anything goes wrong.\n+     * @throws InterruptedException in case anything goes wrong.\n+     */\n+    private void fetchFromSdkManager() throws IOException, InterruptedException {\n+        Logger.logDebug(\"Downloading Android toolchain...\");\n+        String[] args = {\"platforms;android-27\", \"build-tools;27.0.3\", \"platform-tools\", \"extras;android;m2repository\", \"extras;google;m2repository\", \"ndk-bundle\"};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f01b24826e30e39eab3a96b01ad5b30d4355104e"}, "originalPosition": 178}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NzIyMTQ1", "url": "https://github.com/gluonhq/substrate/pull/338#pullrequestreview-358722145", "createdAt": "2020-02-14T05:41:41Z", "commit": {"oid": "f01b24826e30e39eab3a96b01ad5b30d4355104e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f13b138168ad6e889dea70200e0679b506aedf84", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/f13b138168ad6e889dea70200e0679b506aedf84", "committedDate": "2020-02-14T13:22:15Z", "message": "Moved constants to the top"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4OTQ0MzAw", "url": "https://github.com/gluonhq/substrate/pull/338#pullrequestreview-358944300", "createdAt": "2020-02-14T13:38:09Z", "commit": {"oid": "f13b138168ad6e889dea70200e0679b506aedf84"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f49a00d526bb1c6e9b17cf2a04de6286f736e3e", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/1f49a00d526bb1c6e9b17cf2a04de6286f736e3e", "committedDate": "2020-02-14T13:38:20Z", "message": "Prepare non-linux builds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28871a34d3cd9302092907c0394317f55686ed6d", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/28871a34d3cd9302092907c0394317f55686ed6d", "committedDate": "2020-02-14T13:42:31Z", "message": "Prepare non-linux builds 2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f26109c90254ccf7dfe102959f9ebae599097d4", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/1f26109c90254ccf7dfe102959f9ebae599097d4", "committedDate": "2020-02-14T16:41:47Z", "message": "Typo"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2225, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}