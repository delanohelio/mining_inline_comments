{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MTAwNTU5", "number": 424, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwOToyNzoxM1rODnY5NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDozMDozOFrODnaQhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjI4OTE3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/gluonhq/substrate/ProjectConfiguration.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwOToyNzoxM1rOF1W1-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwOToyNzoxM1rOF1W1-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ5MzExMg==", "bodyText": "final? (Same for mainClassName?)", "url": "https://github.com/gluonhq/substrate/pull/424#discussion_r391493112", "createdAt": "2020-03-12T09:27:13Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/ProjectConfiguration.java", "diffHunk": "@@ -62,19 +62,32 @@\n     private String appId;\n     private String appName;\n     private String mainClassName;\n+    private String classpath;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fff15f9aeaceda18268af247f6bb8dd10683668d"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjMwNTU0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/gluonhq/substrate/SubstrateDispatcher.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwOTozMjowOVrOF1XATA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwOTozMjowOVrOF1XATA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ5NTc1Ng==", "bodyText": "We should move all System.err, System.out to Logger.log", "url": "https://github.com/gluonhq/substrate/pull/424#discussion_r391495756", "createdAt": "2020-03-12T09:32:09Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/SubstrateDispatcher.java", "diffHunk": "@@ -77,14 +123,48 @@ public static void main(String[] args) throws Exception {\n         config.setJniList(Strings.split(System.getProperty(\"jnilist\")));\n         config.setBundlesList(Strings.split(System.getProperty(\"bundleslist\")));\n         config.setVerbose(verbose);\n-        config.setUsePrismSW(Boolean.parseBoolean(System.getProperty(\"prism.sw\", \"false\")));\n-        config.setUsePrecompiledCode(Boolean.parseBoolean(System.getProperty(\"usePrecompiledCode\", \"true\")));\n+        config.setUsePrismSW(usePrismSW);\n+        config.setUsePrecompiledCode(usePrecompiledCode);\n+        return config;\n+    }\n \n-        Path buildRoot = Paths.get(System.getProperty(\"user.dir\"), \"build\", \"autoclient\");\n+    private static Step getStepToExecute() {\n+        return Optional.ofNullable(System.getProperty(\"step\"))\n+                .map(stepProperty -> {\n+                    try {\n+                        return Step.valueOf(stepProperty.toUpperCase(Locale.ROOT));\n+                    } catch (IllegalArgumentException e) {\n+                        printUsage();\n+                        throw new IllegalArgumentException(String.format(\"Invalid value for 'step' specified. Possible values: %s\", Arrays.toString(Step.values())));\n+                    }\n+                })\n+                .orElse(Step.RUN);\n+    }\n+\n+    public static void executeCompileStep(SubstrateDispatcher dispatcher) {\n+        System.err.println(\"Compiling...\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fff15f9aeaceda18268af247f6bb8dd10683668d"}, "originalPosition": 126}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjMzOTk5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/gluonhq/substrate/target/AndroidTargetConfiguration.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwOTo0MTo1MlrOF1XVtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwOTo0MTo1MlrOF1XVtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUwMTIzNw==", "bodyText": "This is only required when usePrecompiledCode is set to false", "url": "https://github.com/gluonhq/substrate/pull/424#discussion_r391501237", "createdAt": "2020-03-12T09:41:52Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/target/AndroidTargetConfiguration.java", "diffHunk": "@@ -384,10 +301,188 @@ boolean useGraalVMJavaStaticLibraries() {\n         return false;\n     }\n \n-   /*\n-    * Copies the .cap files from the jar resource and store them in\n-    * a directory. Return that directory\n-    */\n+    private Path getApkPath() {\n+        return paths.getGvmPath().resolve(Constants.APK_PATH);\n+    }\n+\n+    private Path getApkBinPath() {\n+        return getApkPath().resolve(\"bin\");\n+    }\n+\n+    private Path getApkClassPath() {\n+        return getApkPath().resolve(\"class\");\n+    }\n+\n+    private Path getApkLibPath() {\n+        return getApkPath().resolve(\"lib\");\n+    }\n+\n+    private Path getApkLibArm64Path() {\n+        return getApkLibPath().resolve(\"arm64-v8a\");\n+    }\n+\n+    private Path getApkAndroidSourcePath() {\n+        return getApkPath().resolve(\"android-source\");\n+    }\n+\n+    private void ensureApkOutputDirectoriesExist() throws IOException {\n+        Files.createDirectories(getApkPath());\n+        Files.createDirectories(getApkBinPath());\n+        Files.createDirectories(getApkClassPath());\n+        Files.createDirectories(getApkLibPath());\n+        Files.createDirectories(getApkLibArm64Path());\n+        Files.createDirectories(getApkAndroidSourcePath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fff15f9aeaceda18268af247f6bb8dd10683668d"}, "originalPosition": 345}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjM1NzIyOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/gluonhq/substrate/SubstrateTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwOTo0Njo0MVrOF1Xgmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwOTo0Njo0MVrOF1Xgmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUwNDAyNg==", "bodyText": "did you mean isUseJavaFX()?", "url": "https://github.com/gluonhq/substrate/pull/424#discussion_r391504026", "createdAt": "2020-03-12T09:46:41Z", "author": {"login": "jperedadnr"}, "path": "src/test/java/com/gluonhq/substrate/SubstrateTest.java", "diffHunk": "@@ -67,40 +67,58 @@ void testWindowsTriplet() {\n     void testIOSTripletOnLinux() throws IOException {\n         assumeTrue(Triplet.fromCurrentOS().getOs().indexOf(\"nux\") > 0);\n         Triplet iosTriplet = new Triplet(Constants.Profile.IOS);\n-        ProjectConfiguration config = new ProjectConfiguration(\"\");\n+        ProjectConfiguration config = new ProjectConfiguration(\"\", \"\");\n         config.setTarget(iosTriplet);\n         config.setGraalPath(Path.of(System.getenv(\"GRAALVM_HOME\")));\n \n         var dispatcher = new SubstrateDispatcher(Path.of(System.getProperty(\"user.home\")), config);\n         // when on linux, nativeCompile should throw an illegalArgumentException\n-        assertThrows(IllegalArgumentException.class, () -> dispatcher.nativeCompile(\"\"));\n+        assertThrows(IllegalArgumentException.class, () -> dispatcher.nativeCompile());\n     }\n \n     @Test\n     void testAssertGraal() {\n-        ProjectConfiguration publicConfig = new ProjectConfiguration(\"\");\n+        ProjectConfiguration publicConfig = new ProjectConfiguration(\"\", \"\");\n         InternalProjectConfiguration config = new InternalProjectConfiguration(publicConfig);\n         assertThrows(NullPointerException.class, config::canRunNativeImage);\n     }\n \n     @Test\n     void testMainClassName() {\n-        assertThrows(NullPointerException.class, () -> new ProjectConfiguration(null));;\n-        var config = new InternalProjectConfiguration( new ProjectConfiguration(\"a.b.Foo\"));\n+        assertThrows(NullPointerException.class, () -> new ProjectConfiguration(null, \"\"));\n+        var config = new InternalProjectConfiguration(new ProjectConfiguration(\"a.b.Foo\", \"a.b-1.0.jar\"));\n         assertEquals(\"a.b.Foo\", config.getMainClassName());\n-        config = new InternalProjectConfiguration( new ProjectConfiguration(\"name/a.b.Foo\"));\n+        config = new InternalProjectConfiguration(new ProjectConfiguration(\"name/a.b.Foo\", \"\"));\n         assertEquals(\"a.b.Foo\", config.getMainClassName());\n     }\n \n+    @Test\n+    void testClasspath() {\n+        assertThrows(NullPointerException.class, () -> new ProjectConfiguration(\"\", null));\n+        var config = new InternalProjectConfiguration(new ProjectConfiguration(\"\", \"a.b-1.0.jar\"));\n+        assertEquals(\"a.b-1.0.jar\", config.getClasspath());\n+    }\n+\n     @Test\n     void testAssertSW() {\n-        ProjectConfiguration publicConfig = new ProjectConfiguration(\"a.b.Foo\");\n+        ProjectConfiguration publicConfig = new ProjectConfiguration(\"a.b.Foo\", \"\");\n         InternalProjectConfiguration config = new InternalProjectConfiguration(publicConfig);\n         assertFalse(config.isUsePrismSW());\n \n-        publicConfig = new ProjectConfiguration(\"a.b.Foo\");\n+        publicConfig = new ProjectConfiguration(\"a.b.Foo\", \"\");\n         publicConfig.setUsePrismSW(true);\n         config = new InternalProjectConfiguration(publicConfig);\n         assertTrue(config.isUsePrismSW());\n     }\n+\n+    @Test\n+    void testAssertUseJavaFX() {\n+        ProjectConfiguration publicConfig = new ProjectConfiguration(\"\", \"javafx-base-14-linux.jar\");\n+        InternalProjectConfiguration config = new InternalProjectConfiguration(publicConfig);\n+        assertTrue(config.isUseJavaFX());\n+\n+        publicConfig = new ProjectConfiguration(\"\", \"apache-commons.jar\");\n+        config = new InternalProjectConfiguration(publicConfig);\n+        assertFalse(config.isUsePrismSW());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fff15f9aeaceda18268af247f6bb8dd10683668d"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjQxOTgxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/gluonhq/substrate/SubstrateDispatcher.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDowMzo0NFrOF1YG4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDowMzo0NFrOF1YG4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUxMzgyNQ==", "bodyText": "Add JavaDoc?", "url": "https://github.com/gluonhq/substrate/pull/424#discussion_r391513825", "createdAt": "2020-03-12T10:03:44Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/SubstrateDispatcher.java", "diffHunk": "@@ -50,25 +51,70 @@\n \n public class SubstrateDispatcher {\n \n-    private static volatile boolean run = true;\n+    private enum Step {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d50182774007066da2d6b5f735b28eaeda9210e"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjQ0NDk3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/gluonhq/substrate/ProjectConfiguration.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDoxMTowM1rOF1YWsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDoxMTowM1rOF1YWsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUxNzg3NQ==", "bodyText": "can this be final?", "url": "https://github.com/gluonhq/substrate/pull/424#discussion_r391517875", "createdAt": "2020-03-12T10:11:03Z", "author": {"login": "johanvos"}, "path": "src/main/java/com/gluonhq/substrate/ProjectConfiguration.java", "diffHunk": "@@ -62,19 +62,32 @@\n     private String appId;\n     private String appName;\n     private String mainClassName;\n+    private String classpath;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d50182774007066da2d6b5f735b28eaeda9210e"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjQ1MjA0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/gluonhq/substrate/SubstrateDispatcher.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDoxMzoyMVrOF1YbRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDoxNzozNlrOF1YkeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUxOTA0Ng==", "bodyText": "print t as well (t.getMessage() is not shown in stacktraces, but may contain relevant info)", "url": "https://github.com/gluonhq/substrate/pull/424#discussion_r391519046", "createdAt": "2020-03-12T10:13:21Z", "author": {"login": "johanvos"}, "path": "src/main/java/com/gluonhq/substrate/SubstrateDispatcher.java", "diffHunk": "@@ -116,20 +189,45 @@ public static void main(String[] args) throws Exception {\n             t.printStackTrace();\n             System.exit(1);\n         }\n+    }\n+\n+    private static void executePackageStep(SubstrateDispatcher dispatcher) {\n+        System.err.println(\"Packaging...\");\n+        try {\n+            dispatcher.nativePackage();\n+        } catch (Throwable t) {\n+            System.err.println(\"Packaging failed with an exception\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d50182774007066da2d6b5f735b28eaeda9210e"}, "originalPosition": 188}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUyMTQwMA==", "bodyText": "The full stack trace is printed the line below, which also prints the message exception. I can revert the statements, so that the exception is printed first, and then the println?", "url": "https://github.com/gluonhq/substrate/pull/424#discussion_r391521400", "createdAt": "2020-03-12T10:17:36Z", "author": {"login": "tiainen"}, "path": "src/main/java/com/gluonhq/substrate/SubstrateDispatcher.java", "diffHunk": "@@ -116,20 +189,45 @@ public static void main(String[] args) throws Exception {\n             t.printStackTrace();\n             System.exit(1);\n         }\n+    }\n+\n+    private static void executePackageStep(SubstrateDispatcher dispatcher) {\n+        System.err.println(\"Packaging...\");\n+        try {\n+            dispatcher.nativePackage();\n+        } catch (Throwable t) {\n+            System.err.println(\"Packaging failed with an exception\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUxOTA0Ng=="}, "originalCommit": {"oid": "4d50182774007066da2d6b5f735b28eaeda9210e"}, "originalPosition": 188}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjQ5NzYxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/gluonhq/substrate/target/AbstractTargetConfiguration.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDoyNjoxMVrOF1Y3Yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNTozODoxNlrOF1j8eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUyNjI0Mw==", "bodyText": "not sure this is still needed or wanted, but that is probably food for another PR", "url": "https://github.com/gluonhq/substrate/pull/424#discussion_r391526243", "createdAt": "2020-03-12T10:26:11Z", "author": {"login": "johanvos"}, "path": "src/main/java/com/gluonhq/substrate/target/AbstractTargetConfiguration.java", "diffHunk": "@@ -79,12 +79,24 @@\n             \"org.graalvm.home.HomeFinderFeature\"\n     );\n \n+    private static final List<String> baseNativeImageArguments = Arrays.asList(\n+            \"--report-unsupported-elements-at-runtime\",\n+            \"-Djdk.internal.lambda.eagerlyInitialize=false\",\n+            \"--no-server\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d50182774007066da2d6b5f735b28eaeda9210e"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcwNzc3MA==", "bodyText": "Indeed, cleanup of the arguments is work for another issue.", "url": "https://github.com/gluonhq/substrate/pull/424#discussion_r391707770", "createdAt": "2020-03-12T15:38:16Z", "author": {"login": "tiainen"}, "path": "src/main/java/com/gluonhq/substrate/target/AbstractTargetConfiguration.java", "diffHunk": "@@ -79,12 +79,24 @@\n             \"org.graalvm.home.HomeFinderFeature\"\n     );\n \n+    private static final List<String> baseNativeImageArguments = Arrays.asList(\n+            \"--report-unsupported-elements-at-runtime\",\n+            \"-Djdk.internal.lambda.eagerlyInitialize=false\",\n+            \"--no-server\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUyNjI0Mw=="}, "originalCommit": {"oid": "4d50182774007066da2d6b5f735b28eaeda9210e"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjUxMjcxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/gluonhq/substrate/SubstrateDispatcher.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDozMDozOFrOF1ZAuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMTowMjo1NlrOF1aEEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUyODYzMw==", "bodyText": "I see that you don't do anything with INSTALL yet, so I guess that's for a follow up PR?", "url": "https://github.com/gluonhq/substrate/pull/424#discussion_r391528633", "createdAt": "2020-03-12T10:30:38Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/SubstrateDispatcher.java", "diffHunk": "@@ -50,25 +51,70 @@\n \n public class SubstrateDispatcher {\n \n-    private static volatile boolean run = true;\n+    private enum Step {\n+        COMPILE(),\n+        LINK(COMPILE),\n+        PACKAGE(LINK),\n+        INSTALL(PACKAGE),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d50182774007066da2d6b5f735b28eaeda9210e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU0NTg3NQ==", "bodyText": "Actually, it can be done in this PR, because at the moment run on the android target is actually install and run combined. So it's indeed best to split that functionality now as well.", "url": "https://github.com/gluonhq/substrate/pull/424#discussion_r391545875", "createdAt": "2020-03-12T11:02:56Z", "author": {"login": "tiainen"}, "path": "src/main/java/com/gluonhq/substrate/SubstrateDispatcher.java", "diffHunk": "@@ -50,25 +51,70 @@\n \n public class SubstrateDispatcher {\n \n-    private static volatile boolean run = true;\n+    private enum Step {\n+        COMPILE(),\n+        LINK(COMPILE),\n+        PACKAGE(LINK),\n+        INSTALL(PACKAGE),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUyODYzMw=="}, "originalCommit": {"oid": "4d50182774007066da2d6b5f735b28eaeda9210e"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2987, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}