{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NDgyNzgy", "number": 297, "title": "Supporting custom native code in project", "bodyText": "This PR adds support for native directory in project which can contain native .h or .c files which would be included for compilation and linking. Without this modification you either need to insert files in target manually or to rebuild Substrate each time you make changes in native code.\nExample usage can be seen here: https://github.com/lazar-mitrovic/HelloNative\nPR also includes jni.h location for linux target.", "createdAt": "2020-01-27T13:12:43Z", "url": "https://github.com/gluonhq/substrate/pull/297", "merged": true, "mergeCommit": {"oid": "895e2e8f2af46c573eb48a3e26fdfc8e8236e649"}, "closed": true, "closedAt": "2020-01-31T12:09:41Z", "author": {"login": "lazar-mitrovic"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9n7QkAH2gAyMzY3NDgyNzgyOmNmNTFlMTE2ZDlmMTI2OWI0MjlkYWNlZjM1MDNjYjg0YWU3Yjk2NTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_sdf2AFqTM1MTQxMDIzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cf51e116d9f1269b429dacef3503cb84ae7b9653", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/cf51e116d9f1269b429dacef3503cb84ae7b9653", "committedDate": "2020-01-24T23:55:20Z", "message": "Added support for native code in project folder\n\n+ added JNI libraries in linux builds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "905a1bc106f1a60db23308717e4c163aab65771d", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/905a1bc106f1a60db23308717e4c163aab65771d", "committedDate": "2020-01-25T00:26:36Z", "message": "Fixed bug with`.h` files inclusion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a313776cff98275b49b977af33565cf12173fe9", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/6a313776cff98275b49b977af33565cf12173fe9", "committedDate": "2020-01-27T13:04:43Z", "message": "Merge remote-tracking branch 'gluonhq/master' into nativeFixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58a25310ab8d1667066a2b006e4ee91e4e4dd9e1", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/58a25310ab8d1667066a2b006e4ee91e4e4dd9e1", "committedDate": "2020-01-27T13:21:22Z", "message": "Make codacy happy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d50a3cf9eb8cae88cac5fafc4f26e86b4dc4c653", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/d50a3cf9eb8cae88cac5fafc4f26e86b4dc4c653", "committedDate": "2020-01-27T13:24:30Z", "message": "Remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NDYyMjU2", "url": "https://github.com/gluonhq/substrate/pull/297#pullrequestreview-349462256", "createdAt": "2020-01-28T15:23:32Z", "commit": {"oid": "d50a3cf9eb8cae88cac5fafc4f26e86b4dc4c653"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNToyMzozMlrOFipHyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNToyMzozMlrOFipHyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg2OTY0MA==", "bodyText": "this can be moved to com.gluonhq.substrate.model.ProcessPaths", "url": "https://github.com/gluonhq/substrate/pull/297#discussion_r371869640", "createdAt": "2020-01-28T15:23:32Z", "author": {"login": "johanvos"}, "path": "src/main/java/com/gluonhq/substrate/target/AbstractTargetConfiguration.java", "diffHunk": "@@ -756,6 +769,20 @@ String getAppPath(String appName) {\n         return Arrays.asList(\"-o\", getAppPath(appName));\n     }\n \n+    protected Path getNativeCodePath() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d50a3cf9eb8cae88cac5fafc4f26e86b4dc4c653"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NTc3Nzgx", "url": "https://github.com/gluonhq/substrate/pull/297#pullrequestreview-349577781", "createdAt": "2020-01-28T17:49:10Z", "commit": {"oid": "d50a3cf9eb8cae88cac5fafc4f26e86b4dc4c653"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNzo0OToxMVrOFiulsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNzo0OToxMVrOFiulsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1OTIxOA==", "bodyText": "this would also bring the header files to the compile command. We need to copy the header files, but they should not be in the compile command line.\ne.g. we need gcc -I/path/to/headers hello.c\nwith hello.c having #include hello.h and hello.h needs to be at path/to/headers\nI just found out that the current code we have for this is wrong (it uses the header file in the gcc argument, which is not what we want)", "url": "https://github.com/gluonhq/substrate/pull/297#discussion_r371959218", "createdAt": "2020-01-28T17:49:11Z", "author": {"login": "johanvos"}, "path": "src/main/java/com/gluonhq/substrate/target/AbstractTargetConfiguration.java", "diffHunk": "@@ -317,11 +323,18 @@ protected boolean compileAdditionalSources()\n             FileOps.copyResource(getAdditionalSourceFileLocation()  + fileName, workDir.resolve(fileName));\n             processBuilder.command().add(fileName);\n         }\n+        \n+        Path nativeCodeDir = getNativeCodePath();\n+        for( String fileName: getNativeCodeList() ) {\n+            FileOps.copyFile(nativeCodeDir.resolve(fileName), workDir.resolve(fileName));\n+            processBuilder.command().add(fileName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d50a3cf9eb8cae88cac5fafc4f26e86b4dc4c653"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d95f3f0ecdc24be42ce98abc5084d78ee0ba10f", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/4d95f3f0ecdc24be42ce98abc5084d78ee0ba10f", "committedDate": "2020-01-29T10:30:58Z", "message": "Moved `getNativeCode` path to `ProcessPaths` + fixed header command"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21cd5ef599f9f6ebd16e8df3b215f7b88ef986ff", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/21cd5ef599f9f6ebd16e8df3b215f7b88ef986ff", "committedDate": "2020-01-29T10:40:52Z", "message": "Check if `native` directory exists before copying"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNjgyMDYw", "url": "https://github.com/gluonhq/substrate/pull/297#pullrequestreview-350682060", "createdAt": "2020-01-30T09:30:21Z", "commit": {"oid": "21cd5ef599f9f6ebd16e8df3b215f7b88ef986ff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNjk4NTQ2", "url": "https://github.com/gluonhq/substrate/pull/297#pullrequestreview-350698546", "createdAt": "2020-01-30T09:55:54Z", "commit": {"oid": "21cd5ef599f9f6ebd16e8df3b215f7b88ef986ff"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwOTo1NTo1NVrOFjlIzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMDowMTo1NVrOFjlVLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg1Mjk0MQ==", "bodyText": "Probably we could use different extensions? Maybe create a method that can be overridden from the platforms if needed?", "url": "https://github.com/gluonhq/substrate/pull/297#discussion_r372852941", "createdAt": "2020-01-30T09:55:55Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/target/AbstractTargetConfiguration.java", "diffHunk": "@@ -756,6 +773,16 @@ String getAppPath(String appName) {\n         return Arrays.asList(\"-o\", getAppPath(appName));\n     }\n \n+    protected List<String> getNativeCodeList() throws IOException {\n+        Path nativeCodeDir = paths.getNativeCodePath();\n+        if (!Files.exists(nativeCodeDir))\n+            return Collections.emptyList();\n+        return Files.list(nativeCodeDir)\n+            .map(p -> p.getFileName().toString())\n+            .filter(s -> s.endsWith(\".c\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21cd5ef599f9f6ebd16e8df3b215f7b88ef986ff"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg1MzEzNw==", "bodyText": "Do you really need collect?", "url": "https://github.com/gluonhq/substrate/pull/297#discussion_r372853137", "createdAt": "2020-01-30T09:56:18Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/target/AbstractTargetConfiguration.java", "diffHunk": "@@ -219,6 +219,12 @@ public boolean link() throws IOException, InterruptedException {\n         linkBuilder.command().add(objectFile.toString());\n         linkBuilder.command().addAll(getTargetSpecificObjectFiles());\n \n+        getNativeCodeList().stream()\n+            .map(s -> s.replaceAll(\"\\\\..*\", \".\" + getObjectFileExtension()))\n+            .distinct()\n+            .collect(Collectors.toList())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21cd5ef599f9f6ebd16e8df3b215f7b88ef986ff"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg1NTI0Mg==", "bodyText": "I'd rather use curly braces on if statements", "url": "https://github.com/gluonhq/substrate/pull/297#discussion_r372855242", "createdAt": "2020-01-30T10:00:07Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/target/AbstractTargetConfiguration.java", "diffHunk": "@@ -313,15 +319,26 @@ protected boolean compileAdditionalSources()\n             processBuilder.command().add(\"-DGVM_VERBOSE\");\n         }\n         processBuilder.command().addAll(getTargetSpecificCCompileFlags());\n+\n+        processBuilder.command().add(\"-I\" + workDir.toString());\n+\n         for( String fileName: getAdditionalSourceFiles() ) {\n             FileOps.copyResource(getAdditionalSourceFileLocation()  + fileName, workDir.resolve(fileName));\n             processBuilder.command().add(fileName);\n         }\n+        \n+        Path nativeCodeDir = paths.getNativeCodePath();\n+        if (Files.isDirectory(nativeCodeDir))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21cd5ef599f9f6ebd16e8df3b215f7b88ef986ff"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg1NTUxNg==", "bodyText": "same here (curly braces)", "url": "https://github.com/gluonhq/substrate/pull/297#discussion_r372855516", "createdAt": "2020-01-30T10:00:43Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/target/AbstractTargetConfiguration.java", "diffHunk": "@@ -756,6 +773,16 @@ String getAppPath(String appName) {\n         return Arrays.asList(\"-o\", getAppPath(appName));\n     }\n \n+    protected List<String> getNativeCodeList() throws IOException {\n+        Path nativeCodeDir = paths.getNativeCodePath();\n+        if (!Files.exists(nativeCodeDir))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21cd5ef599f9f6ebd16e8df3b215f7b88ef986ff"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg1NjEwOQ==", "bodyText": "check non null objects, non null file name, if that make sense?", "url": "https://github.com/gluonhq/substrate/pull/297#discussion_r372856109", "createdAt": "2020-01-30T10:01:55Z", "author": {"login": "jperedadnr"}, "path": "src/main/java/com/gluonhq/substrate/target/AbstractTargetConfiguration.java", "diffHunk": "@@ -756,6 +773,16 @@ String getAppPath(String appName) {\n         return Arrays.asList(\"-o\", getAppPath(appName));\n     }\n \n+    protected List<String> getNativeCodeList() throws IOException {\n+        Path nativeCodeDir = paths.getNativeCodePath();\n+        if (!Files.exists(nativeCodeDir))\n+            return Collections.emptyList();\n+        return Files.list(nativeCodeDir)\n+            .map(p -> p.getFileName().toString())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21cd5ef599f9f6ebd16e8df3b215f7b88ef986ff"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44af8c2c9d34f144c3c378211de1955e3e8a6e0e", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/44af8c2c9d34f144c3c378211de1955e3e8a6e0e", "committedDate": "2020-01-30T23:55:00Z", "message": "Merge remote-tracking branch 'gluonhq/master' into nativeFixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06070b75f2da0793876992a5ce6d1b7a108f314a", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/06070b75f2da0793876992a5ce6d1b7a108f314a", "committedDate": "2020-01-31T00:46:46Z", "message": "Enable per target code extensions, code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c32444e1c6081d72ad39f042aefed3abbb64a0c", "author": {"user": {"login": "lazar-mitrovic", "name": "Lazar Mitrovi\u0107"}}, "url": "https://github.com/gluonhq/substrate/commit/6c32444e1c6081d72ad39f042aefed3abbb64a0c", "committedDate": "2020-01-31T00:56:26Z", "message": "Make codacy happy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNDEwMjM1", "url": "https://github.com/gluonhq/substrate/pull/297#pullrequestreview-351410235", "createdAt": "2020-01-31T10:20:13Z", "commit": {"oid": "6c32444e1c6081d72ad39f042aefed3abbb64a0c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2200, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}