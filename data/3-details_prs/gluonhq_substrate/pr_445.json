{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4ODc4Mjgx", "number": 445, "title": "#438 Scan jars for dalvik precompiled classes", "bodyText": "This PR adds support to scanning all the jars in the classpath for precompiled classes under META-INF/substrate/dalvik\nThese classes will be added to the gvm/apk/class folder and included, if compiling from sources, in the classpath.\nRelated to Keyboard support, the Keyboard Service will include precompiled classes, once gluonhq/attach#60 is merged.\nFixes #438 and #437", "createdAt": "2020-03-15T23:49:16Z", "url": "https://github.com/gluonhq/substrate/pull/445", "merged": true, "mergeCommit": {"oid": "18ab170bedc50d1ec6ab7669355de68e92e50889"}, "closed": true, "closedAt": "2020-03-16T17:21:59Z", "author": {"login": "jperedadnr"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNV0MlgH2gAyMzg4ODc4MjgxOmRjZDNlZGQ0ZTk2YmNhOTFhZGY5ZWMwNWNhMWI4OWVmNDgwN2E2YzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcORbPrAFqTM3NTQyNzE1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dcd3edd4e96bca91adf9ec05ca1b89ef4807a6c3", "author": {"user": null}, "url": "https://github.com/gluonhq/substrate/commit/dcd3edd4e96bca91adf9ec05ca1b89ef4807a6c3", "committedDate": "2020-03-13T19:52:07Z", "message": "#438 Scan jars for dalvik precompiled classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c40dde5a116da7568791f94c382bf43a0aa58be3", "author": {"user": null}, "url": "https://github.com/gluonhq/substrate/commit/c40dde5a116da7568791f94c382bf43a0aa58be3", "committedDate": "2020-03-13T20:20:48Z", "message": "fix path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe749bedf7e6afda921212167e121b06bad8fdf3", "author": {"user": null}, "url": "https://github.com/gluonhq/substrate/commit/fe749bedf7e6afda921212167e121b06bad8fdf3", "committedDate": "2020-03-15T20:15:52Z", "message": "Remove KeyboardView class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "071859c5044d0e4faa3a00460bd0cfb182d28029", "author": {"user": null}, "url": "https://github.com/gluonhq/substrate/commit/071859c5044d0e4faa3a00460bd0cfb182d28029", "committedDate": "2020-03-15T23:35:13Z", "message": "Update MainActivity precompiled classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c30afdb4e5b15a946ef702fcc0be4dd435584561", "author": {"user": null}, "url": "https://github.com/gluonhq/substrate/commit/c30afdb4e5b15a946ef702fcc0be4dd435584561", "committedDate": "2020-03-15T23:36:13Z", "message": "Split compiledGlueCode in two, add existing precompiled classes to classpath"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d2f51f492079c1018a9971d6c349b90d357870e", "author": {"user": null}, "url": "https://github.com/gluonhq/substrate/commit/9d2f51f492079c1018a9971d6c349b90d357870e", "committedDate": "2020-03-15T23:43:05Z", "message": "Update list of classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e074b4d1153472262cf870705a945f0fec4fbf6", "author": {"user": null}, "url": "https://github.com/gluonhq/substrate/commit/7e074b4d1153472262cf870705a945f0fec4fbf6", "committedDate": "2020-03-16T09:28:22Z", "message": "Fix constants import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MjQ0MjYw", "url": "https://github.com/gluonhq/substrate/pull/445#pullrequestreview-375244260", "createdAt": "2020-03-16T14:07:16Z", "commit": {"oid": "7e074b4d1153472262cf870705a945f0fec4fbf6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDowNzoxNlrOF21sLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDowNzoxNlrOF21sLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0NzA4Nw==", "bodyText": "Why +2 here?", "url": "https://github.com/gluonhq/substrate/pull/445#discussion_r393047087", "createdAt": "2020-03-16T14:07:16Z", "author": {"login": "tiainen"}, "path": "src/main/java/com/gluonhq/substrate/target/AndroidTargetConfiguration.java", "diffHunk": "@@ -380,12 +392,43 @@ private int compileDalvikCode(String androidSrc, String androidJar) throws IOExc\n         ProcessRunner processRunner = new ProcessRunner(projectConfiguration.getGraalPath().resolve(\"bin\").resolve(\"javac\").toString(),\n                 \"-d\", getApkClassPath().toString(),\n                 \"-source\", \"1.7\", \"-target\", \"1.7\",\n-                \"-cp\", getApkAndroidSourcePath().toString(),\n+                \"-cp\", getApkAndroidSourcePath().toString() + File.pathSeparator + getApkClassPath().toString(),\n                 \"-bootclasspath\", androidJar);\n         processRunner.addArgs(sources);\n         return processRunner.runProcess(\"dalvikCompilation\");\n     }\n \n+    /**\n+     * Walks through the jars in the classpath, excluding the JavaFX ones,\n+     * and looks for META-INF/substrate/dalvik/*.class files.\n+     *\n+     * The method will copy all the class files found into the target folder\n+     *\n+     * @throws IOException\n+     */\n+    private void copyOtherDalvikClasses() throws IOException, InterruptedException {\n+        Path targetFolder = getApkClassPath();\n+        Logger.logDebug(\"Scanning for dalvik classes\");\n+        final List<File> jars = new ClassPath(projectConfiguration.getClasspath()).getJars(true);\n+        String prefix = META_INF_SUBSTRATE_DALVIK + DALVIK_PRECOMPILED_CLASS;\n+        for (File jar : jars) {\n+            try (ZipFile zip = new ZipFile(jar)) {\n+                Logger.logDebug(\"Scanning \" + jar);\n+                for (Enumeration e = zip.entries(); e.hasMoreElements(); ) {\n+                    ZipEntry zipEntry = (ZipEntry) e.nextElement();\n+                    String name = zipEntry.getName();\n+                    if (!zipEntry.isDirectory() && name.startsWith(META_INF_SUBSTRATE_DALVIK)) {\n+                        Path classPath = targetFolder.resolve(name.substring(prefix.length() + 2));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e074b4d1153472262cf870705a945f0fec4fbf6"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3cfdc6338ea50964bbcb2149d503facc02bdecd", "author": {"user": null}, "url": "https://github.com/gluonhq/substrate/commit/d3cfdc6338ea50964bbcb2149d503facc02bdecd", "committedDate": "2020-03-16T15:42:21Z", "message": "Rename precompiled class to precompiled classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab086f09b9eccf233e0d8e8f8d1cafde9aa805a4", "author": {"user": null}, "url": "https://github.com/gluonhq/substrate/commit/ab086f09b9eccf233e0d8e8f8d1cafde9aa805a4", "committedDate": "2020-03-16T15:45:19Z", "message": "Rename gvm/apk/class folder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MzQ3Mzk2", "url": "https://github.com/gluonhq/substrate/pull/445#pullrequestreview-375347396", "createdAt": "2020-03-16T15:50:58Z", "commit": {"oid": "ab086f09b9eccf233e0d8e8f8d1cafde9aa805a4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNTo1MDo1OFrOF26fxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNTo1MDo1OFrOF26fxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzEyNTgyOQ==", "bodyText": "Rename the method to getApkClassesPath?", "url": "https://github.com/gluonhq/substrate/pull/445#discussion_r393125829", "createdAt": "2020-03-16T15:50:58Z", "author": {"login": "tiainen"}, "path": "src/main/java/com/gluonhq/substrate/target/AndroidTargetConfiguration.java", "diffHunk": "@@ -322,7 +329,7 @@ private Path getApkBinPath() {\n     }\n \n     private Path getApkClassPath() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab086f09b9eccf233e0d8e8f8d1cafde9aa805a4"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dda49497c26a4a3a50775df14d3540708e2a3593", "author": {"user": null}, "url": "https://github.com/gluonhq/substrate/commit/dda49497c26a4a3a50775df14d3540708e2a3593", "committedDate": "2020-03-16T15:54:50Z", "message": "Rename method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MzU2NDQx", "url": "https://github.com/gluonhq/substrate/pull/445#pullrequestreview-375356441", "createdAt": "2020-03-16T16:00:41Z", "commit": {"oid": "dda49497c26a4a3a50775df14d3540708e2a3593"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NDI3MTUx", "url": "https://github.com/gluonhq/substrate/pull/445#pullrequestreview-375427151", "createdAt": "2020-03-16T17:19:10Z", "commit": {"oid": "dda49497c26a4a3a50775df14d3540708e2a3593"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2147, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}