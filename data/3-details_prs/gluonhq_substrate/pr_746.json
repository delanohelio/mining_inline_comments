{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4NzQzMjk5", "number": 746, "title": "Use objdump on Android to check static native libraries", "bodyText": "Fixes #744, checking static native libraries.\nSince we are testing with ProcessRunner, any invalid *.a file in the jar will log a severe message. To avoid this, I've added showSevere to ProcessRunner. In any case, the process result itself is logged to the usual log file, and if the process fails,  (due to invalid format for instance), a file is logged and the message is visible\n[INFO] We will now compile your code for aarch64-linux-android. This may take some time.\n[INFO] Logging process [objdump] to file: HelloFX/target/client/log/process-objdump-1597658045777.log", "createdAt": "2020-08-17T10:29:46Z", "url": "https://github.com/gluonhq/substrate/pull/746", "merged": true, "mergeCommit": {"oid": "6bff9626c252e941e9f87630409bd9e503a5d86f"}, "closed": true, "closedAt": "2020-08-21T08:47:11Z", "author": {"login": "jperedadnr"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_vQrcAH2gAyNDY4NzQzMjk5OjQzOWY2MDU1NTBjOTNjOTcyOTRkYzBhZjMxNzk2N2EyYTAzMjViZDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBAxYlAFqTQ3MjMxMzA5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "439f605550c93c97294dc0af317967a2a0325bd7", "author": {"user": null}, "url": "https://github.com/gluonhq/substrate/commit/439f605550c93c97294dc0af317967a2a0325bd7", "committedDate": "2020-08-17T09:47:04Z", "message": "Add showSevere to show or not the severe message in case of process failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96b41ee32c7cf2f8e988af6095ce52f2bd05a357", "author": {"user": null}, "url": "https://github.com/gluonhq/substrate/commit/96b41ee32c7cf2f8e988af6095ce52f2bd05a357", "committedDate": "2020-08-17T09:47:51Z", "message": "Don\u2019t show severe message when checking native libs on Linux"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bd189864329dbcf6f7a333cd2e1d5fbfe6f7547", "author": {"user": null}, "url": "https://github.com/gluonhq/substrate/commit/0bd189864329dbcf6f7a333cd2e1d5fbfe6f7547", "committedDate": "2020-08-17T09:54:55Z", "message": "Add objdump to Android, and check native libraries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMjYwODY3", "url": "https://github.com/gluonhq/substrate/pull/746#pullrequestreview-470260867", "createdAt": "2020-08-19T08:59:40Z", "commit": {"oid": "0bd189864329dbcf6f7a333cd2e1d5fbfe6f7547"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODo1OTo0MFrOHC9_Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODo1OTo0MFrOHC9_Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg3NDgzOA==", "bodyText": "shouldn't this be in Constants.Profile (full name)", "url": "https://github.com/gluonhq/substrate/pull/746#discussion_r472874838", "createdAt": "2020-08-19T08:59:40Z", "author": {"login": "johanvos"}, "path": "src/main/java/com/gluonhq/substrate/target/AndroidTargetConfiguration.java", "diffHunk": "@@ -64,37 +65,45 @@\n \n public class AndroidTargetConfiguration extends PosixTargetConfiguration {\n \n+    private static final String ANDROID_TRIPLET = \"aarch64-linux-android\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bd189864329dbcf6f7a333cd2e1d5fbfe6f7547"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMjYyNzUx", "url": "https://github.com/gluonhq/substrate/pull/746#pullrequestreview-470262751", "createdAt": "2020-08-19T09:01:59Z", "commit": {"oid": "0bd189864329dbcf6f7a333cd2e1d5fbfe6f7547"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwOTowMTo1OVrOHC-FRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwOTowMTo1OVrOHC-FRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg3NjM1OQ==", "bodyText": "isn't this Triplet.getOsArch() ?", "url": "https://github.com/gluonhq/substrate/pull/746#discussion_r472876359", "createdAt": "2020-08-19T09:01:59Z", "author": {"login": "johanvos"}, "path": "src/main/java/com/gluonhq/substrate/target/AndroidTargetConfiguration.java", "diffHunk": "@@ -64,37 +65,45 @@\n \n public class AndroidTargetConfiguration extends PosixTargetConfiguration {\n \n+    private static final String ANDROID_TRIPLET = \"aarch64-linux-android\";\n+    private static final String ANDROID_MIN_SDK_VERSION = \"21\";\n+\n     private final String ndk;\n     private final String sdk;\n     private final Path ldlld;\n     private final Path clang;\n+    private final Path objdump;\n     private final String hostPlatformFolder;\n \n-    private List<String> androidAdditionalSourceFiles = Arrays.asList(\"launcher.c\", \"javafx_adapter.c\",\n+    private final List<String> androidAdditionalSourceFiles = Arrays.asList(\"launcher.c\", \"javafx_adapter.c\",\n             \"touch_events.c\", \"glibc_shim.c\", \"attach_adapter.c\", \"logger.c\");\n-    private List<String> androidAdditionalHeaderFiles = Arrays.asList(\"grandroid.h\", \"grandroid_ext.h\");\n-    private List<String> cFlags = Arrays.asList(\"-target\", \"aarch64-linux-android\", \"-I.\");\n-    private List<String> linkFlags = Arrays.asList(\"-target\", \"aarch64-linux-android21\", \"-fPIC\", \"-fuse-ld=gold\",\n+    private final List<String> androidAdditionalHeaderFiles = Arrays.asList(\"grandroid.h\", \"grandroid_ext.h\");\n+    private final List<String> cFlags = Arrays.asList(\"-target\", ANDROID_TRIPLET, \"-I.\");\n+    private final List<String> linkFlags = Arrays.asList(\"-target\",\n+            ANDROID_TRIPLET + ANDROID_MIN_SDK_VERSION, \"-fPIC\", \"-fuse-ld=gold\",\n             \"-Wl,--rosegment,--gc-sections,-z,noexecstack\", \"-shared\",\n             \"-landroid\", \"-llog\", \"-lffi\", \"-llibchelper\");\n-    private List<String> javafxLinkFlags = Arrays.asList(\"-Wl,--whole-archive\",\n+    private final List<String> javafxLinkFlags = Arrays.asList(\"-Wl,--whole-archive\",\n             \"-lprism_es2_monocle\", \"-lglass_monocle\", \"-ljavafx_font_freetype\", \"-ljavafx_iio\", \"-Wl,--no-whole-archive\",\n             \"-lGLESv2\", \"-lEGL\", \"-lfreetype\");\n     private final String capLocation = ANDROID_NATIVE_FOLDER + \"cap/\";\n \n-    public AndroidTargetConfiguration( ProcessPaths paths, InternalProjectConfiguration configuration ) throws IOException {\n+    public AndroidTargetConfiguration(ProcessPaths paths, InternalProjectConfiguration configuration) throws IOException {\n         super(paths,configuration);\n \n         this.sdk = fileDeps.getAndroidSDKPath().toString();\n         this.ndk = fileDeps.getAndroidNDKPath().toString();\n-        this.hostPlatformFolder = configuration.getHostTriplet().getOs() + \"-x86_64\";\n+        this.hostPlatformFolder = configuration.getHostTriplet().getOs() + \"-\" + Constants.ARCH_AMD64;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bd189864329dbcf6f7a333cd2e1d5fbfe6f7547"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMjYzOTcz", "url": "https://github.com/gluonhq/substrate/pull/746#pullrequestreview-470263973", "createdAt": "2020-08-19T09:03:42Z", "commit": {"oid": "0bd189864329dbcf6f7a333cd2e1d5fbfe6f7547"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwOTowMzo0MlrOHC-JJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwOTowMzo0MlrOHC-JJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg3NzM1MA==", "bodyText": "better to replace with the getArch() on the targetTriplet (e.g. when we support x86-64 emulator/devices)", "url": "https://github.com/gluonhq/substrate/pull/746#discussion_r472877350", "createdAt": "2020-08-19T09:03:42Z", "author": {"login": "johanvos"}, "path": "src/main/java/com/gluonhq/substrate/target/AndroidTargetConfiguration.java", "diffHunk": "@@ -268,6 +278,26 @@ String getLinkOutputName() {\n         return linkFlags;\n     }\n \n+    @Override\n+    Predicate<Path> getTargetSpecificNativeLibsFilter() {\n+        return this::checkFileArchitecture;\n+    }\n+\n+    private boolean checkFileArchitecture(Path path) {\n+        try {\n+            ProcessRunner pr = new ProcessRunner(objdump.toString(), \"-f\", path.toString());\n+            pr.showSevereMessage(false);\n+            int op = pr.runProcess(\"objdump\");\n+            if (op == 0) {\n+                return pr.getResponses().stream().anyMatch(line -> line.contains(\"architecture: \" + Constants.ARCH_AARCH64));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bd189864329dbcf6f7a333cd2e1d5fbfe6f7547"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1f427ceeb47fcd6c16e604ba924f9b9048a2a9c", "author": {"user": null}, "url": "https://github.com/gluonhq/substrate/commit/e1f427ceeb47fcd6c16e604ba924f9b9048a2a9c", "committedDate": "2020-08-19T10:03:26Z", "message": "Changes based on feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMzEzMDk3", "url": "https://github.com/gluonhq/substrate/pull/746#pullrequestreview-472313097", "createdAt": "2020-08-21T08:45:06Z", "commit": {"oid": "e1f427ceeb47fcd6c16e604ba924f9b9048a2a9c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2099, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}