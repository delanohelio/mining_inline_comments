{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5MDg3Nzk3", "number": 10372, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMjowNjoxNlrOEIi45A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMjoxMjozMFrOEIi-Yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3Mzk1Njg0OnYy", "diffSide": "RIGHT", "path": "handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMjowNjoxNlrOGokwXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwODoxNjo1NVrOGowPJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5ODQzMA==", "bodyText": "IIUC, bytesProduced will be > 0 only if there is an error from flush", "url": "https://github.com/netty/netty/pull/10372#discussion_r445198430", "createdAt": "2020-06-24T22:06:16Z", "author": {"login": "NiteshKant"}, "path": "handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java", "diffHunk": "@@ -840,8 +840,25 @@ public final SSLEngineResult wrap(\n \n                 // There was no pending data in the network BIO -- encrypt any application data\n                 int bytesConsumed = 0;\n+                assert bytesProduced == 0;\n+\n                 // Flush any data that may have been written implicitly by OpenSSL in case a shutdown/alert occurs.\n                 bytesProduced = SSL.bioFlushByteBuffer(networkBIO);\n+\n+                if (bytesProduced > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa2a0b5faed5d44fbb5259f9392a3c56711c7585"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM4NjUzMg==", "bodyText": "no it will be > 0 if there was something pending in the buffer.", "url": "https://github.com/netty/netty/pull/10372#discussion_r445386532", "createdAt": "2020-06-25T08:16:55Z", "author": {"login": "normanmaurer"}, "path": "handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java", "diffHunk": "@@ -840,8 +840,25 @@ public final SSLEngineResult wrap(\n \n                 // There was no pending data in the network BIO -- encrypt any application data\n                 int bytesConsumed = 0;\n+                assert bytesProduced == 0;\n+\n                 // Flush any data that may have been written implicitly by OpenSSL in case a shutdown/alert occurs.\n                 bytesProduced = SSL.bioFlushByteBuffer(networkBIO);\n+\n+                if (bytesProduced > 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5ODQzMA=="}, "originalCommit": {"oid": "aa2a0b5faed5d44fbb5259f9392a3c56711c7585"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3Mzk2MDQ4OnYy", "diffSide": "RIGHT", "path": "handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMjowNzo1N1rOGokytg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwODoxNjozM1rOGowOVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5OTAzMA==", "bodyText": "Can this throw? Worth to handle such that we add the pendingException as the cause?", "url": "https://github.com/netty/netty/pull/10372#discussion_r445199030", "createdAt": "2020-06-24T22:07:57Z", "author": {"login": "NiteshKant"}, "path": "handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java", "diffHunk": "@@ -840,8 +840,25 @@ public final SSLEngineResult wrap(\n \n                 // There was no pending data in the network BIO -- encrypt any application data\n                 int bytesConsumed = 0;\n+                assert bytesProduced == 0;\n+\n                 // Flush any data that may have been written implicitly by OpenSSL in case a shutdown/alert occurs.\n                 bytesProduced = SSL.bioFlushByteBuffer(networkBIO);\n+\n+                if (bytesProduced > 0) {\n+                    return newResultMayFinishHandshake(status, bytesConsumed, bytesProduced);\n+                }\n+                // There was a pending exception that we just delayed because there was something to produce left.\n+                // Throw it now and shutdown the engine.\n+                if (pendingException != null) {\n+                    Throwable error = pendingException;\n+                    pendingException = null;\n+                    shutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa2a0b5faed5d44fbb5259f9392a3c56711c7585"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM4NjMyNw==", "bodyText": "nope it can't.", "url": "https://github.com/netty/netty/pull/10372#discussion_r445386327", "createdAt": "2020-06-25T08:16:33Z", "author": {"login": "normanmaurer"}, "path": "handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java", "diffHunk": "@@ -840,8 +840,25 @@ public final SSLEngineResult wrap(\n \n                 // There was no pending data in the network BIO -- encrypt any application data\n                 int bytesConsumed = 0;\n+                assert bytesProduced == 0;\n+\n                 // Flush any data that may have been written implicitly by OpenSSL in case a shutdown/alert occurs.\n                 bytesProduced = SSL.bioFlushByteBuffer(networkBIO);\n+\n+                if (bytesProduced > 0) {\n+                    return newResultMayFinishHandshake(status, bytesConsumed, bytesProduced);\n+                }\n+                // There was a pending exception that we just delayed because there was something to produce left.\n+                // Throw it now and shutdown the engine.\n+                if (pendingException != null) {\n+                    Throwable error = pendingException;\n+                    pendingException = null;\n+                    shutdown();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5OTAzMA=="}, "originalCommit": {"oid": "aa2a0b5faed5d44fbb5259f9392a3c56711c7585"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3Mzk3MDkxOnYy", "diffSide": "RIGHT", "path": "handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMjoxMjozMFrOGok5IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwODoxNzowOFrOGowPqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIwMDY3Mg==", "bodyText": "I hardly know the control flow here but since this is not just handshakeException now, do we need to also handle a case when pendingException != null?", "url": "https://github.com/netty/netty/pull/10372#discussion_r445200672", "createdAt": "2020-06-24T22:12:30Z", "author": {"login": "NiteshKant"}, "path": "handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java", "diffHunk": "@@ -1260,10 +1277,12 @@ private SSLEngineResult sslReadErrorResult(int error, int stackError, int bytesC\n         // This is needed so we ensure close_notify etc is correctly send to the remote peer.\n         // See https://github.com/netty/netty/issues/3900\n         if (SSL.bioLengthNonApplication(networkBIO) > 0) {\n-            if (handshakeException == null && handshakeState != HandshakeState.FINISHED) {\n+            if (pendingException == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa2a0b5faed5d44fbb5259f9392a3c56711c7585"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM4NjY2NA==", "bodyText": "it should never... let me add an assert tho You are right... let me ensure we handle this", "url": "https://github.com/netty/netty/pull/10372#discussion_r445386664", "createdAt": "2020-06-25T08:17:08Z", "author": {"login": "normanmaurer"}, "path": "handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java", "diffHunk": "@@ -1260,10 +1277,12 @@ private SSLEngineResult sslReadErrorResult(int error, int stackError, int bytesC\n         // This is needed so we ensure close_notify etc is correctly send to the remote peer.\n         // See https://github.com/netty/netty/issues/3900\n         if (SSL.bioLengthNonApplication(networkBIO) > 0) {\n-            if (handshakeException == null && handshakeState != HandshakeState.FINISHED) {\n+            if (pendingException == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIwMDY3Mg=="}, "originalCommit": {"oid": "aa2a0b5faed5d44fbb5259f9392a3c56711c7585"}, "originalPosition": 62}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3826, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}