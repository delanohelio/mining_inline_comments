{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MDYwNzYy", "number": 10586, "title": "Cleanup", "bodyText": "Motivation:\nsome cleanup to make it more readable\nModifications:\n\nFix typos\nRemove cqe kRingMask\nRemove pendingWakeup\n\nResult:\ncleaner code", "createdAt": "2020-09-18T04:22:48Z", "url": "https://github.com/netty/netty/pull/10586", "merged": true, "mergeCommit": {"oid": "0421c9c751c66941a5bb402ce705aaa0198b71e9"}, "closed": true, "closedAt": "2020-09-23T07:55:52Z", "author": {"login": "1Jo1"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKbWnYgFqTQ5MjAwMzE5MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLm1NlgBqjM3OTY1MDE4NDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMDAzMTkw", "url": "https://github.com/netty/netty/pull/10586#pullrequestreview-492003190", "createdAt": "2020-09-19T14:45:50Z", "commit": {"oid": "d4a8fb5716a30a0562f5545cb940236f41b64c18"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQxNDo0NTo1MFrOHUsb-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQxNDo0ODoyN1rOHUsdfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MTYyNw==", "bodyText": "We may want to leave this here since I think some similar logic will be needed to what this is used for with epoll - specifically we need to do a final blocking read upon event loop shutdown before closing the eventfd if this flag is set, otherwise the corresponding \"wakeup\" write could be made after the fd has been reassigned to something else.", "url": "https://github.com/netty/netty/pull/10586#discussion_r491461627", "createdAt": "2020-09-19T14:45:50Z", "author": {"login": "njhill"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -52,9 +52,11 @@\n     private final FileDescriptor eventfd;\n \n     private final IovArrays iovArrays;\n+    // The maximum number of bytes for an InetAddress / Inet6Address\n+    private final byte[] inet4AddressArray = new byte[4];\n+    private final byte[] inet6AddressArray = new byte[16];\n \n     private long prevDeadlineNanos = NONE;\n-    private boolean pendingWakeup;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4a8fb5716a30a0562f5545cb940236f41b64c18"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ2MjAxMg==", "bodyText": "Hmm I see this is unused right now but it probably should be used. It doesn't look like we currently ever remove any channels from the channels map ... this should be done when they are deregistered from the EL (probably after the corresponding CQEs are processed).", "url": "https://github.com/netty/netty/pull/10586#discussion_r491462012", "createdAt": "2020-09-19T14:48:27Z", "author": {"login": "njhill"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -97,27 +99,13 @@ public void run() {\n                 : PlatformDependent.<Runnable>newMpscQueue(maxPendingTasks);\n     }\n \n-    public void add(AbstractIOUringChannel ch) {\n+    void add(AbstractIOUringChannel ch) {\n         logger.trace(\"Add Channel: {} \", ch.socket.intValue());\n         int fd = ch.socket.intValue();\n \n         channels.put(fd, ch);\n     }\n \n-    public void remove(AbstractIOUringChannel ch) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4a8fb5716a30a0562f5545cb940236f41b64c18"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "267913d4a993c0309c79a53e05a4f26db4d0a3d8", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/267913d4a993c0309c79a53e05a4f26db4d0a3d8", "committedDate": "2020-09-19T09:34:40Z", "message": "fix checkstyle"}, "afterCommit": {"oid": "e6f7eeba50f562c98edfa009a5736207b1c7ab10", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/e6f7eeba50f562c98edfa009a5736207b1c7ab10", "committedDate": "2020-09-20T07:12:03Z", "message": "Cleanup\n\nMotivation:\n\nsome cleanup to make it more readable\n\nModifications:\n\n- fix typos\n- remove cqe kRingMask\n- remove unused pendingWakeup\n\nResult:\n\ncleaner code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f37b87a8430874537c9d9499fdcbb389131309bb", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/f37b87a8430874537c9d9499fdcbb389131309bb", "committedDate": "2020-09-20T12:44:04Z", "message": "Remove channel map\n\nMotivation:\n\nwe should remove channels from the channels map when no poll event is scheduled, for example it could occurs when autoread is false\n\nModifications:\n\nremove channel when no poll event is scheduled\n\nResult:\n\nremoved channel"}, "afterCommit": {"oid": "7cf38e6ea0fa384823e540dec8641048aa5ecb9f", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/7cf38e6ea0fa384823e540dec8641048aa5ecb9f", "committedDate": "2020-09-20T23:16:09Z", "message": "Remove channel map\n\nMotivation:\n\nwe should remove channels from the channels map when no poll event is scheduled, for example it could occurs when autoread is false\n\nModifications:\n\nremove channel when no poll event is scheduled\n\nResult:\n\nremoved channel"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7cf38e6ea0fa384823e540dec8641048aa5ecb9f", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/7cf38e6ea0fa384823e540dec8641048aa5ecb9f", "committedDate": "2020-09-20T23:16:09Z", "message": "Remove channel map\n\nMotivation:\n\nwe should remove channels from the channels map when no poll event is scheduled, for example it could occurs when autoread is false\n\nModifications:\n\nremove channel when no poll event is scheduled\n\nResult:\n\nremoved channel"}, "afterCommit": {"oid": "b2c77a3867476dbe36e04d145157115353965861", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/b2c77a3867476dbe36e04d145157115353965861", "committedDate": "2020-09-20T23:25:05Z", "message": "Remove channel map\n\nMotivation:\n\nwe should remove channels from the channels map when no poll event is scheduled, for example it could occurs when autoread is false\n\nModifications:\n\nremove channel when no poll event is scheduled\n\nResult:\n\nremoved channel"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMjMyODIx", "url": "https://github.com/netty/netty/pull/10586#pullrequestreview-492232821", "createdAt": "2020-09-20T23:32:38Z", "commit": {"oid": "b2c77a3867476dbe36e04d145157115353965861"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMFQyMzozMjozOFrOHU97bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMFQyMzozMjozOFrOHU97bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc0ODIwNw==", "bodyText": "@normanmaurer we could just use ioState == 0, I'm not quite sure.. WDYT?", "url": "https://github.com/netty/netty/pull/10586#discussion_r491748207", "createdAt": "2020-09-20T23:32:38Z", "author": {"login": "1Jo1"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringChannel.java", "diffHunk": "@@ -714,10 +714,14 @@ protected void doRegister() throws Exception {\n     }\n \n     @Override\n-    protected void doDeregister() throws Exception {\n+    protected void doDeregister() {\n         IOUringSubmissionQueue submissionQueue = submissionQueue();\n \n         if (submissionQueue != null) {\n+            if ((ioState & (POLL_IN_SCHEDULED | POLL_OUT_SCHEDULED | POLL_RDHUP_SCHEDULED)) == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2c77a3867476dbe36e04d145157115353965861"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNjQwNTkw", "url": "https://github.com/netty/netty/pull/10586#pullrequestreview-493640590", "createdAt": "2020-09-22T16:25:08Z", "commit": {"oid": "b2c77a3867476dbe36e04d145157115353965861"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjoyNTowOFrOHWCftA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjoyNTozNVrOHWCgyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg3MTYwNA==", "bodyText": "@1Jo1 please keep the code above", "url": "https://github.com/netty/netty/pull/10586#discussion_r492871604", "createdAt": "2020-09-22T16:25:08Z", "author": {"login": "normanmaurer"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -108,17 +107,7 @@ void add(AbstractIOUringChannel ch) {\n     }\n \n     void remove(AbstractIOUringChannel ch) {\n-        logger.trace(\"Remove Channel: {}\", ch.socket.intValue());\n-        int fd = ch.socket.intValue();\n-\n-        AbstractIOUringChannel old = channels.remove(fd);\n-        if (old != null && old != ch) {\n-            // The Channel mapping was already replaced due FD reuse, put back the stored Channel.\n-            channels.put(fd, old);\n-\n-            // If we found another Channel in the map that is mapped to the same FD the given Channel MUST be closed.\n-            assert !ch.isOpen();\n-        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2c77a3867476dbe36e04d145157115353965861"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg3MTg4Mw==", "bodyText": "if we don't need the return value we should just call set(...)", "url": "https://github.com/netty/netty/pull/10586#discussion_r492871883", "createdAt": "2020-09-22T16:25:35Z", "author": {"login": "normanmaurer"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -168,8 +157,8 @@ protected void run() {\n                         }\n                     }\n                 } finally {\n-                    if (nextWakeupNanos.get() == AWAKE || nextWakeupNanos.getAndSet(AWAKE) == AWAKE) {\n-                        pendingWakeup = true;\n+                    if (nextWakeupNanos.get() == AWAKE) {\n+                        nextWakeupNanos.getAndSet(AWAKE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2c77a3867476dbe36e04d145157115353965861"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cb4f335e43d8d740374065834854b1fd741ca4d", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/3cb4f335e43d8d740374065834854b1fd741ca4d", "committedDate": "2020-09-23T05:11:38Z", "message": "Cleanup\n\nMotivation:\n\nsome cleanup to make it more readable\n\nModifications:\n\n- fix typos\n- remove cqe kRingMask\n- remove unused pendingWakeup\n\nResult:\n\ncleaner code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be9a04f2683c61ec4814e222ef69c53db70b2fa1", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/be9a04f2683c61ec4814e222ef69c53db70b2fa1", "committedDate": "2020-09-23T05:11:43Z", "message": "Remove channel map\n\nMotivation:\n\nwe should remove channels from the channels map when no poll event is scheduled, for example it could occurs when autoread is false\n\nModifications:\n\nremove channel when no poll event is scheduled\n\nResult:\n\nremoved channel"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b2c77a3867476dbe36e04d145157115353965861", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/b2c77a3867476dbe36e04d145157115353965861", "committedDate": "2020-09-20T23:25:05Z", "message": "Remove channel map\n\nMotivation:\n\nwe should remove channels from the channels map when no poll event is scheduled, for example it could occurs when autoread is false\n\nModifications:\n\nremove channel when no poll event is scheduled\n\nResult:\n\nremoved channel"}, "afterCommit": {"oid": "570084ff0d76c0570bd4021ee2c4fde73cf6115a", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/570084ff0d76c0570bd4021ee2c4fde73cf6115a", "committedDate": "2020-09-23T05:11:43Z", "message": "Address @normanmaurer's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0MjA4MDI5", "url": "https://github.com/netty/netty/pull/10586#pullrequestreview-494208029", "createdAt": "2020-09-23T06:08:14Z", "commit": {"oid": "570084ff0d76c0570bd4021ee2c4fde73cf6115a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNjowODoxNFrOHWXsrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNjowODoxNFrOHWXsrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIxODk5MA==", "bodyText": "remove this change as we already call remove below", "url": "https://github.com/netty/netty/pull/10586#discussion_r493218990", "createdAt": "2020-09-23T06:08:14Z", "author": {"login": "normanmaurer"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -109,6 +108,7 @@ void add(AbstractIOUringChannel ch) {\n \n     void remove(AbstractIOUringChannel ch) {\n         logger.trace(\"Remove Channel: {}\", ch.socket.intValue());\n+        channels.remove(ch.socket.intValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "570084ff0d76c0570bd4021ee2c4fde73cf6115a"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "570084ff0d76c0570bd4021ee2c4fde73cf6115a", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/570084ff0d76c0570bd4021ee2c4fde73cf6115a", "committedDate": "2020-09-23T05:11:43Z", "message": "Address @normanmaurer's comments"}, "afterCommit": {"oid": "beb6dd7e52caf6b7d9015ba79a74693ff8c88f38", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/beb6dd7e52caf6b7d9015ba79a74693ff8c88f38", "committedDate": "2020-09-23T06:14:26Z", "message": "Address @normanmaurer's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0MjYxNDU3", "url": "https://github.com/netty/netty/pull/10586#pullrequestreview-494261457", "createdAt": "2020-09-23T06:39:35Z", "commit": {"oid": "beb6dd7e52caf6b7d9015ba79a74693ff8c88f38"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNjozOTozNVrOHWYfAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNjozOTozNVrOHWYfAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIzMTg3Mg==", "bodyText": "sorry... missed this one. This if makes no sense. Remove it and just call set every time", "url": "https://github.com/netty/netty/pull/10586#discussion_r493231872", "createdAt": "2020-09-23T06:39:35Z", "author": {"login": "normanmaurer"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -168,8 +167,8 @@ protected void run() {\n                         }\n                     }\n                 } finally {\n-                    if (nextWakeupNanos.get() == AWAKE || nextWakeupNanos.getAndSet(AWAKE) == AWAKE) {\n-                        pendingWakeup = true;\n+                    if (nextWakeupNanos.get() == AWAKE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "beb6dd7e52caf6b7d9015ba79a74693ff8c88f38"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6c36d5452faab5e6fd5f85fe9c8a5b36b66b900", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/b6c36d5452faab5e6fd5f85fe9c8a5b36b66b900", "committedDate": "2020-09-23T06:43:51Z", "message": "Address @normanmaurer's comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "beb6dd7e52caf6b7d9015ba79a74693ff8c88f38", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/beb6dd7e52caf6b7d9015ba79a74693ff8c88f38", "committedDate": "2020-09-23T06:14:26Z", "message": "Address @normanmaurer's comments"}, "afterCommit": {"oid": "b6c36d5452faab5e6fd5f85fe9c8a5b36b66b900", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/b6c36d5452faab5e6fd5f85fe9c8a5b36b66b900", "committedDate": "2020-09-23T06:43:51Z", "message": "Address @normanmaurer's comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 65, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}