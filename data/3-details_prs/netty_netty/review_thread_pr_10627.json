{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2MDcwNzQ0", "number": 10627, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODo0NDoyMFrOEpYCXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzo1Mzo0NFrOEpk83g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExODIwODkyOnYy", "diffSide": "RIGHT", "path": "transport-native-unix-common/src/main/java/io/netty/channel/unix/IovArray.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODo0NDoyMFrOHbAdKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwOToxMzozOVrOHbBhHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA4MTA2Nw==", "bodyText": "Hang on, what's up with the setLong?", "url": "https://github.com/netty/netty/pull/10627#discussion_r498081067", "createdAt": "2020-10-01T08:44:20Z", "author": {"login": "chrisvest"}, "path": "transport-native-unix-common/src/main/java/io/netty/channel/unix/IovArray.java", "diffHunk": "@@ -141,17 +146,17 @@ private boolean add(long addr, int len) {\n                 PlatformDependent.putLong(baseOffset + memoryAddress, addr);\n                 PlatformDependent.putLong(lengthOffset + memoryAddress, len);\n             } else {\n-                memory.putLong(baseOffset, addr);\n-                memory.putLong(lengthOffset, len);\n+                memory.setLong(baseOffset, addr);\n+                memory.setLong(lengthOffset, len);\n             }\n         } else {\n             assert ADDRESS_SIZE == 4;\n             if (PlatformDependent.hasUnsafe()) {\n                 PlatformDependent.putInt(baseOffset + memoryAddress, (int) addr);\n                 PlatformDependent.putInt(lengthOffset + memoryAddress, len);\n             } else {\n-                memory.putInt(baseOffset, (int) addr);\n-                memory.putInt(lengthOffset, len);\n+                memory.setLong(baseOffset, (int) addr);\n+                memory.setLong(lengthOffset, len);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ada396a609d0a559222e7d3920d4afc4b2761c66"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA5ODQ2Mw==", "bodyText": "arg... that should be setInt... Thanks", "url": "https://github.com/netty/netty/pull/10627#discussion_r498098463", "createdAt": "2020-10-01T09:13:39Z", "author": {"login": "normanmaurer"}, "path": "transport-native-unix-common/src/main/java/io/netty/channel/unix/IovArray.java", "diffHunk": "@@ -141,17 +146,17 @@ private boolean add(long addr, int len) {\n                 PlatformDependent.putLong(baseOffset + memoryAddress, addr);\n                 PlatformDependent.putLong(lengthOffset + memoryAddress, len);\n             } else {\n-                memory.putLong(baseOffset, addr);\n-                memory.putLong(lengthOffset, len);\n+                memory.setLong(baseOffset, addr);\n+                memory.setLong(lengthOffset, len);\n             }\n         } else {\n             assert ADDRESS_SIZE == 4;\n             if (PlatformDependent.hasUnsafe()) {\n                 PlatformDependent.putInt(baseOffset + memoryAddress, (int) addr);\n                 PlatformDependent.putInt(lengthOffset + memoryAddress, len);\n             } else {\n-                memory.putInt(baseOffset, (int) addr);\n-                memory.putInt(lengthOffset, len);\n+                memory.setLong(baseOffset, (int) addr);\n+                memory.setLong(lengthOffset, len);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA4MTA2Nw=="}, "originalCommit": {"oid": "ada396a609d0a559222e7d3920d4afc4b2761c66"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExODMzMDE5OnYy", "diffSide": "RIGHT", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwOToxNjo1OFrOHbBoyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMTo0MToyMVrOHbGcDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEwMDQyNA==", "bodyText": "do we still need the submissionQueueCallback in the future?", "url": "https://github.com/netty/netty/pull/10627#discussion_r498100424", "createdAt": "2020-10-01T09:16:58Z", "author": {"login": "1Jo1"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -65,14 +63,10 @@\n         // Ensure that we load all native bits as otherwise it may fail when try to use native methods in IovArray\n         IOUring.ensureAvailability();\n \n-        // TODO: Let's hard code this to 8 IovArrays to keep the memory overhead kind of small. We may want to consider\n-        //       allow to change this in the future.\n-        iovArrays = new IovArrays(8);\n         ringBuffer = Native.createRingBuffer(ringSize, iosqeAsyncThreshold, new Runnable() {\n             @Override\n             public void run() {\n-                // Once we submitted its safe to clear the IovArrays and so be able to re-use these.\n-                iovArrays.clear();\n+                // NOOP", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ada396a609d0a559222e7d3920d4afc4b2761c66"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEwMzI0Mw==", "bodyText": "maybe... not sure yet. We can rip it out if we find no usage. It doesn't hurt atm", "url": "https://github.com/netty/netty/pull/10627#discussion_r498103243", "createdAt": "2020-10-01T09:21:44Z", "author": {"login": "normanmaurer"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -65,14 +63,10 @@\n         // Ensure that we load all native bits as otherwise it may fail when try to use native methods in IovArray\n         IOUring.ensureAvailability();\n \n-        // TODO: Let's hard code this to 8 IovArrays to keep the memory overhead kind of small. We may want to consider\n-        //       allow to change this in the future.\n-        iovArrays = new IovArrays(8);\n         ringBuffer = Native.createRingBuffer(ringSize, iosqeAsyncThreshold, new Runnable() {\n             @Override\n             public void run() {\n-                // Once we submitted its safe to clear the IovArrays and so be able to re-use these.\n-                iovArrays.clear();\n+                // NOOP", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEwMDQyNA=="}, "originalCommit": {"oid": "ada396a609d0a559222e7d3920d4afc4b2761c66"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEwNjAxMg==", "bodyText": "let's remove it, @njhill what do you think?", "url": "https://github.com/netty/netty/pull/10627#discussion_r498106012", "createdAt": "2020-10-01T09:26:14Z", "author": {"login": "1Jo1"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -65,14 +63,10 @@\n         // Ensure that we load all native bits as otherwise it may fail when try to use native methods in IovArray\n         IOUring.ensureAvailability();\n \n-        // TODO: Let's hard code this to 8 IovArrays to keep the memory overhead kind of small. We may want to consider\n-        //       allow to change this in the future.\n-        iovArrays = new IovArrays(8);\n         ringBuffer = Native.createRingBuffer(ringSize, iosqeAsyncThreshold, new Runnable() {\n             @Override\n             public void run() {\n-                // Once we submitted its safe to clear the IovArrays and so be able to re-use these.\n-                iovArrays.clear();\n+                // NOOP", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEwMDQyNA=="}, "originalCommit": {"oid": "ada396a609d0a559222e7d3920d4afc4b2761c66"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE3OTA4Nw==", "bodyText": "ok let me do it...", "url": "https://github.com/netty/netty/pull/10627#discussion_r498179087", "createdAt": "2020-10-01T11:41:21Z", "author": {"login": "normanmaurer"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -65,14 +63,10 @@\n         // Ensure that we load all native bits as otherwise it may fail when try to use native methods in IovArray\n         IOUring.ensureAvailability();\n \n-        // TODO: Let's hard code this to 8 IovArrays to keep the memory overhead kind of small. We may want to consider\n-        //       allow to change this in the future.\n-        iovArrays = new IovArrays(8);\n         ringBuffer = Native.createRingBuffer(ringSize, iosqeAsyncThreshold, new Runnable() {\n             @Override\n             public void run() {\n-                // Once we submitted its safe to clear the IovArrays and so be able to re-use these.\n-                iovArrays.clear();\n+                // NOOP", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEwMDQyNA=="}, "originalCommit": {"oid": "ada396a609d0a559222e7d3920d4afc4b2761c66"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDMxOTQ1OnYy", "diffSide": "RIGHT", "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringStreamChannel.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzo1MjowOFrOHbVEsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzo1MjowOFrOHbVEsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQxODg2NA==", "bodyText": "iovArray = null here?", "url": "https://github.com/netty/netty/pull/10627#discussion_r498418864", "createdAt": "2020-10-01T17:52:08Z", "author": {"login": "njhill"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringStreamChannel.java", "diffHunk": "@@ -209,16 +210,22 @@ protected Executor prepareToClose() {\n         }\n \n         private ByteBuf readBuffer;\n+        private IovArray iovArray;\n \n         @Override\n         protected int scheduleWriteMultiple(ChannelOutboundBuffer in) {\n-            final IovArray iovecArray = ((IOUringEventLoop) eventLoop()).iovArray();\n+            assert iovArray == null;\n+            int numElements = Math.min(in.size(), Limits.IOV_MAX);\n+            ByteBuf iovArrayBuffer = alloc().directBuffer(numElements * IovArray.IOV_SIZE);\n+            iovArray = new IovArray(iovArrayBuffer);\n             try {\n-                int offset = iovecArray.count();\n-                in.forEachFlushedMessage(iovecArray);\n+                int offset = iovArray.count();\n+                in.forEachFlushedMessage(iovArray);\n                 submissionQueue().addWritev(socket.intValue(),\n-                        iovecArray.memoryAddress(offset), iovecArray.count() - offset, (short) 0);\n+                        iovArray.memoryAddress(offset), iovArray.count() - offset, (short) 0);\n             } catch (Exception e) {\n+                iovArray.release();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "739cf4b94c1e4a8ac27109f74cc6d0dcea66419c"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDMyNDc4OnYy", "diffSide": "RIGHT", "path": "transport-native-unix-common/src/main/java/io/netty/channel/unix/IovArray.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzo1Mzo0NFrOHbVIIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzo1Mzo0NFrOHbVIIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQxOTc0Ng==", "bodyText": "only do this if !PlatformDependent.hasUnsafe()? otherwise we're unnecessarily allocating/wrapping on intel", "url": "https://github.com/netty/netty/pull/10627#discussion_r498419746", "createdAt": "2020-10-01T17:53:44Z", "author": {"login": "njhill"}, "path": "transport-native-unix-common/src/main/java/io/netty/channel/unix/IovArray.java", "diffHunk": "@@ -52,23 +54,29 @@\n      * The size of an {@code iovec} struct in bytes. This is calculated as we have 2 entries each of the size of the\n      * address.\n      */\n-    private static final int IOV_SIZE = 2 * ADDRESS_SIZE;\n+    public static final int IOV_SIZE = 2 * ADDRESS_SIZE;\n \n     /**\n      * The needed memory to hold up to {@code IOV_MAX} iov entries, where {@code IOV_MAX} signified\n      * the maximum number of {@code iovec} structs that can be passed to {@code writev(...)}.\n      */\n-    private static final int CAPACITY = IOV_MAX * IOV_SIZE;\n+    private static final int MAX_CAPACITY = IOV_MAX * IOV_SIZE;\n \n-    private final ByteBuffer memory;\n-    private final long memoryAddress;\n+    private final ByteBuf memory;\n     private int count;\n     private long size;\n     private long maxBytes = SSIZE_MAX;\n \n     public IovArray() {\n-        memory = Buffer.allocateDirectWithNativeOrder(CAPACITY);\n-        memoryAddress = Buffer.memoryAddress(memory);\n+        this(Unpooled.wrappedBuffer(Buffer.allocateDirectWithNativeOrder(MAX_CAPACITY)));\n+    }\n+\n+    @SuppressWarnings(\"deprecation\")\n+    public IovArray(ByteBuf memory) {\n+        assert memory.writerIndex() == 0;\n+        assert memory.readerIndex() == 0;\n+        this.memory = memory.order(\n+                PlatformDependent.BIG_ENDIAN_NATIVE_ORDER ? ByteOrder.BIG_ENDIAN : ByteOrder.LITTLE_ENDIAN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "739cf4b94c1e4a8ac27109f74cc6d0dcea66419c"}, "originalPosition": 45}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3789, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}