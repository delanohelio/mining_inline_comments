{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3NTE3MzQ1", "number": 10826, "title": "Create bespoke long/long hashmap and long-valued priority queue for PoolChunk", "bodyText": "Motivation:\nThe uncached access to PoolChunk can be made faster, and avoid allocating boxed Longs, if we have a primitive hash map and priority queue implementation for it.\nModification:\nAdd bespoke primitive implementations of a hash map and a priority queue for PoolChunk.\nRemove all the long-boxing caused by the previous implementation.\nThe hashmap is a linear probing map with a fairly short probe that keeps the search within a couple of cache lines.\nThe priority queue is the same priority heap algorithm that the JDK PriorityQueue uses, but without the Long boxing, so it can instead rely on a long[] array.\nThis makes the internal-remove method faster, which is an important operation in PoolChunk.\nResult:\nI see a roughly 25% performance uplift in buffer allocations that miss cache.\n(However, after #10825 fixed the caching, this boost is not so easy to measure)", "createdAt": "2020-11-25T15:15:27Z", "url": "https://github.com/netty/netty/pull/10826", "merged": true, "mergeCommit": {"oid": "c41d46111dc37aaf9c8ee7aec162d87221df1d70"}, "closed": true, "closedAt": "2020-11-29T10:29:47Z", "author": {"login": "chrisvest"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgARWpAH2gAyNTI3NTE3MzQ1OjcxOGYyOWM0ZDQzYTk2MmM3OWZhYWVmN2YzYTQ0M2ZmNWE5MGJiMmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhS5VTgFqTU0MDQyNzA5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "718f29c4d43a962c79faaef7f3a443ff5a90bb2b", "author": {"user": {"login": "chrisvest", "name": "Chris Vest"}}, "url": "https://github.com/netty/netty/commit/718f29c4d43a962c79faaef7f3a443ff5a90bb2b", "committedDate": "2020-11-25T15:41:46Z", "message": "Create bespoke long/long hashmap and long-valued priority queue for PoolChunk\n\nMotivation:\nThe uncached access to PoolChunk can be made faster, and avoid allocating boxed Longs, if we have a primitive hash map and priority queue implementation for it.\n\nModification:\nAdd bespoke primitive implementations of a hash map and a priority queue for PoolChunk.\nRemove all the long-boxing caused by the previous implementation.\nThe hashmap is a linear probing map with a fairly short probe that keeps the search within a couple of cache lines.\nThe priority queue is the same binary heap algorithm that's described in Algorithms by Sedgewick and Wayne.\nThe implementation avoids the Long boxing by relying on a long[] array.\nThis makes the internal-remove method faster, which is an important operation in PoolChunk.\n\nResult:\nI see a roughly 25% performance uplift in buffer allocations that miss cache."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "534c02a9ecd184828c935cdb00b0e384acf64052", "author": {"user": {"login": "chrisvest", "name": "Chris Vest"}}, "url": "https://github.com/netty/netty/commit/534c02a9ecd184828c935cdb00b0e384acf64052", "committedDate": "2020-11-25T14:34:22Z", "message": "Create bespoke long/long hashmap and long-valued priority queue for PoolChunk\n\nMotivation:\nThe uncached access to PoolChunk can be made faster, and avoid allocating boxed Longs, if we have a primitive hash map and priority queue implementation for it.\n\nModification:\nAdd bespoke primitive implementations of a hash map and a priority queue for PoolChunk.\nRemove all the long-boxing caused by the previous implementation.\nThe hashmap is a linear probing map with a fairly short probe that keeps the search within a couple of cache lines.\nThe priority queue is the same priority heap algorithm that the JDK PriorityQueue uses, but without the Long boxing, so it can instead rely on a long[] array.\nThis makes the internal-remove method faster, which is an important operation in PoolChunk.\n\nResult:\nI see a roughly 25% performance uplift in buffer allocations that miss cache."}, "afterCommit": {"oid": "718f29c4d43a962c79faaef7f3a443ff5a90bb2b", "author": {"user": {"login": "chrisvest", "name": "Chris Vest"}}, "url": "https://github.com/netty/netty/commit/718f29c4d43a962c79faaef7f3a443ff5a90bb2b", "committedDate": "2020-11-25T15:41:46Z", "message": "Create bespoke long/long hashmap and long-valued priority queue for PoolChunk\n\nMotivation:\nThe uncached access to PoolChunk can be made faster, and avoid allocating boxed Longs, if we have a primitive hash map and priority queue implementation for it.\n\nModification:\nAdd bespoke primitive implementations of a hash map and a priority queue for PoolChunk.\nRemove all the long-boxing caused by the previous implementation.\nThe hashmap is a linear probing map with a fairly short probe that keeps the search within a couple of cache lines.\nThe priority queue is the same binary heap algorithm that's described in Algorithms by Sedgewick and Wayne.\nThe implementation avoids the Long boxing by relying on a long[] array.\nThis makes the internal-remove method faster, which is an important operation in PoolChunk.\n\nResult:\nI see a roughly 25% performance uplift in buffer allocations that miss cache."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NjM0OTI2", "url": "https://github.com/netty/netty/pull/10826#pullrequestreview-538634926", "createdAt": "2020-11-25T15:51:49Z", "commit": {"oid": "718f29c4d43a962c79faaef7f3a443ff5a90bb2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo1MTo1MFrOH55nUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo1MTo1MFrOH55nUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ3NDgzNA==", "bodyText": "Do we need to also shrink the internal storage at some point ?", "url": "https://github.com/netty/netty/pull/10826#discussion_r530474834", "createdAt": "2020-11-25T15:51:50Z", "author": {"login": "normanmaurer"}, "path": "buffer/src/main/java/io/netty/buffer/PoolChunk.java", "diffHunk": "@@ -643,4 +638,161 @@ static boolean isSubpage(long handle) {\n     static int bitmapIdx(long handle) {\n         return (int) handle;\n     }\n+\n+    private static final class LongLongHashMap {\n+        private static final int MAX_PROBE = 4;\n+        private int mask = 31;\n+        private long[] array = new long[mask + 1];\n+        private long zeroVal;\n+\n+        public long put(long key, long value) {\n+            if (key == 0) {\n+                long prev = zeroVal;\n+                zeroVal = value;\n+                return prev;\n+            }\n+\n+            for (;;) {\n+                int index = index(key);\n+                for (int i = 0; i < MAX_PROBE; i++) {\n+                    long existing = array[index];\n+                    if (existing == key || existing == 0) {\n+                        long prev = array[index + 1];\n+                        array[index] = key;\n+                        array[index + 1] = value;\n+                        return prev;\n+                    }\n+                    index = index + 2 & mask;\n+                }\n+                expand(); // Grow array and re-hash.\n+            }\n+        }\n+\n+        public void remove(long key) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "718f29c4d43a962c79faaef7f3a443ff5a90bb2b"}, "originalPosition": 183}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NjM1MzE0", "url": "https://github.com/netty/netty/pull/10826#pullrequestreview-538635314", "createdAt": "2020-11-25T15:52:15Z", "commit": {"oid": "718f29c4d43a962c79faaef7f3a443ff5a90bb2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo1MjoxNlrOH55oqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo1MjoxNlrOH55oqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ3NTE3Ng==", "bodyText": "Do we also need to shrink the internal storage at some point ?", "url": "https://github.com/netty/netty/pull/10826#discussion_r530475176", "createdAt": "2020-11-25T15:52:16Z", "author": {"login": "normanmaurer"}, "path": "buffer/src/main/java/io/netty/buffer/PoolChunk.java", "diffHunk": "@@ -643,4 +638,161 @@ static boolean isSubpage(long handle) {\n     static int bitmapIdx(long handle) {\n         return (int) handle;\n     }\n+\n+    private static final class LongLongHashMap {\n+        private static final int MAX_PROBE = 4;\n+        private int mask = 31;\n+        private long[] array = new long[mask + 1];\n+        private long zeroVal;\n+\n+        public long put(long key, long value) {\n+            if (key == 0) {\n+                long prev = zeroVal;\n+                zeroVal = value;\n+                return prev;\n+            }\n+\n+            for (;;) {\n+                int index = index(key);\n+                for (int i = 0; i < MAX_PROBE; i++) {\n+                    long existing = array[index];\n+                    if (existing == key || existing == 0) {\n+                        long prev = array[index + 1];\n+                        array[index] = key;\n+                        array[index + 1] = value;\n+                        return prev;\n+                    }\n+                    index = index + 2 & mask;\n+                }\n+                expand(); // Grow array and re-hash.\n+            }\n+        }\n+\n+        public void remove(long key) {\n+            if (key == 0) {\n+                zeroVal = 0;\n+                return;\n+            }\n+            int index = index(key);\n+            for (int i = 0; i < MAX_PROBE; i++) {\n+                long existing = array[index];\n+                if (existing == key) {\n+                    array[index] = 0;\n+                    array[index + 1] = 0;\n+                    break;\n+                }\n+                index = index + 2 & mask;\n+            }\n+        }\n+\n+        public long get(long key) {\n+            if (key == 0) {\n+                return zeroVal;\n+            }\n+            int index = index(key);\n+            for (int i = 0; i < MAX_PROBE; i++) {\n+                long existing = array[index];\n+                if (existing == key) {\n+                    return array[index + 1];\n+                }\n+                index = index + 2 & mask;\n+            }\n+            return -1;\n+        }\n+\n+        private int index(long key) {\n+            return (int) (key << 1 & mask);\n+        }\n+\n+        private void expand() {\n+            long[] prev = array;\n+            int newSize = prev.length * 2;\n+            mask = newSize - 1;\n+            array = new long[newSize];\n+            for (int i = 0; i < prev.length >> 1; i += 2) {\n+                long key = prev[i];\n+                long val = prev[i + 1];\n+                put(key, val);\n+            }\n+        }\n+    }\n+\n+    private static final class LongPriorityQueue {\n+        private long[] array = new long[9];\n+        private int size;\n+\n+        public void offer(long handle) {\n+            size++;\n+            if (size == array.length) {\n+                // Grow queue capacity.\n+                array = Arrays.copyOf(array, 1 + (array.length - 1) * 2);\n+            }\n+            array[size] = handle;\n+            lift();\n+        }\n+\n+        public void remove(long value) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "718f29c4d43a962c79faaef7f3a443ff5a90bb2b"}, "originalPosition": 246}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NjY0NjE3", "url": "https://github.com/netty/netty/pull/10826#pullrequestreview-538664617", "createdAt": "2020-11-25T16:24:25Z", "commit": {"oid": "718f29c4d43a962c79faaef7f3a443ff5a90bb2b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNjoyNDoyNVrOH57B7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNjoyNjoyMlrOH57HfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ5ODAzMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (nextRun == 0) {\n          \n          \n            \n                        if (nextRun == -1) {\n          \n      \n    \n    \n  \n\n== 0 seems like a bug", "url": "https://github.com/netty/netty/pull/10826#discussion_r530498030", "createdAt": "2020-11-25T16:24:25Z", "author": {"login": "normanmaurer"}, "path": "buffer/src/main/java/io/netty/buffer/PoolChunk.java", "diffHunk": "@@ -531,8 +526,8 @@ private long collapseNext(long handle) {\n             int runOffset = runOffset(handle);\n             int runPages = runPages(handle);\n \n-            Long nextRun = getAvailRunByOffset(runOffset + runPages);\n-            if (nextRun == null) {\n+            long nextRun = getAvailRunByOffset(runOffset + runPages);\n+            if (nextRun == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "718f29c4d43a962c79faaef7f3a443ff5a90bb2b"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ5ODQ3OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (pastRun == 0) {\n          \n          \n            \n                        if (pastRun == -1) {\n          \n      \n    \n    \n  \n\n== 0 seems incorrect", "url": "https://github.com/netty/netty/pull/10826#discussion_r530498479", "createdAt": "2020-11-25T16:25:04Z", "author": {"login": "normanmaurer"}, "path": "buffer/src/main/java/io/netty/buffer/PoolChunk.java", "diffHunk": "@@ -507,8 +502,8 @@ private long collapsePast(long handle) {\n             int runOffset = runOffset(handle);\n             int runPages = runPages(handle);\n \n-            Long pastRun = getAvailRunByOffset(runOffset - 1);\n-            if (pastRun == null) {\n+            long pastRun = getAvailRunByOffset(runOffset - 1);\n+            if (pastRun == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "718f29c4d43a962c79faaef7f3a443ff5a90bb2b"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ5OTQ1Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            return 0;\n          \n          \n            \n                            return -1;\n          \n      \n    \n    \n  \n\nI think -1 is better as 0 is a valid value for offer", "url": "https://github.com/netty/netty/pull/10826#discussion_r530499452", "createdAt": "2020-11-25T16:26:22Z", "author": {"login": "normanmaurer"}, "path": "buffer/src/main/java/io/netty/buffer/PoolChunk.java", "diffHunk": "@@ -643,4 +638,161 @@ static boolean isSubpage(long handle) {\n     static int bitmapIdx(long handle) {\n         return (int) handle;\n     }\n+\n+    private static final class LongLongHashMap {\n+        private static final int MAX_PROBE = 4;\n+        private int mask = 31;\n+        private long[] array = new long[mask + 1];\n+        private long zeroVal;\n+\n+        public long put(long key, long value) {\n+            if (key == 0) {\n+                long prev = zeroVal;\n+                zeroVal = value;\n+                return prev;\n+            }\n+\n+            for (;;) {\n+                int index = index(key);\n+                for (int i = 0; i < MAX_PROBE; i++) {\n+                    long existing = array[index];\n+                    if (existing == key || existing == 0) {\n+                        long prev = array[index + 1];\n+                        array[index] = key;\n+                        array[index + 1] = value;\n+                        return prev;\n+                    }\n+                    index = index + 2 & mask;\n+                }\n+                expand(); // Grow array and re-hash.\n+            }\n+        }\n+\n+        public void remove(long key) {\n+            if (key == 0) {\n+                zeroVal = 0;\n+                return;\n+            }\n+            int index = index(key);\n+            for (int i = 0; i < MAX_PROBE; i++) {\n+                long existing = array[index];\n+                if (existing == key) {\n+                    array[index] = 0;\n+                    array[index + 1] = 0;\n+                    break;\n+                }\n+                index = index + 2 & mask;\n+            }\n+        }\n+\n+        public long get(long key) {\n+            if (key == 0) {\n+                return zeroVal;\n+            }\n+            int index = index(key);\n+            for (int i = 0; i < MAX_PROBE; i++) {\n+                long existing = array[index];\n+                if (existing == key) {\n+                    return array[index + 1];\n+                }\n+                index = index + 2 & mask;\n+            }\n+            return -1;\n+        }\n+\n+        private int index(long key) {\n+            return (int) (key << 1 & mask);\n+        }\n+\n+        private void expand() {\n+            long[] prev = array;\n+            int newSize = prev.length * 2;\n+            mask = newSize - 1;\n+            array = new long[newSize];\n+            for (int i = 0; i < prev.length >> 1; i += 2) {\n+                long key = prev[i];\n+                long val = prev[i + 1];\n+                put(key, val);\n+            }\n+        }\n+    }\n+\n+    private static final class LongPriorityQueue {\n+        private long[] array = new long[9];\n+        private int size;\n+\n+        public void offer(long handle) {\n+            size++;\n+            if (size == array.length) {\n+                // Grow queue capacity.\n+                array = Arrays.copyOf(array, 1 + (array.length - 1) * 2);\n+            }\n+            array[size] = handle;\n+            lift();\n+        }\n+\n+        public void remove(long value) {\n+            for (int i = 1; i <= size; i++) {\n+                if (array[i] == value) {\n+                    if (i == size) {\n+                        array[i] = 0;\n+                    } else {\n+                        array[i] = array[size];\n+                        sink(i);\n+                    }\n+                    size--;\n+                    return;\n+                }\n+            }\n+        }\n+\n+        public long poll() {\n+            if (size == 0) {\n+                return 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "718f29c4d43a962c79faaef7f3a443ff5a90bb2b"}, "originalPosition": 263}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1f392e416b275e954c57737ef52eba25344cc6a", "author": {"user": {"login": "chrisvest", "name": "Chris Vest"}}, "url": "https://github.com/netty/netty/commit/d1f392e416b275e954c57737ef52eba25344cc6a", "committedDate": "2020-11-26T13:48:16Z", "message": "Move internal data structures from PoolChunk to top-level classes\n\nMotivation:\nWe wish to test these independently.\n\nModification:\nMake inner classes top-level, moving LongLongHashMap and LongPriorityQueue out of PoolChunk.\n\nResult:\nThese classes can now be accessed from tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee73dfc355359fae184a9e5a6d9afdeca6933640", "author": {"user": {"login": "chrisvest", "name": "Chris Vest"}}, "url": "https://github.com/netty/netty/commit/ee73dfc355359fae184a9e5a6d9afdeca6933640", "committedDate": "2020-11-26T17:09:37Z", "message": "Make the LongPriorityQueue use -1, instead of 0, to signal the absence of a value.\n\nMotivation:\nUsing -1 as a token value for the absence of a value makes more sense, since 0 could be a legal value in the use case in PoolChunk.\n\nModification:\nThe LongPriorityQueue now uses -1 (and has a NO_VALUE constant for it) to signal the absence of a value, or that the queue is empty.\nUsage sites in PoolChunk have been adjusted accordingly.\n\nResult:\nCleaner code."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NDc4MTYz", "url": "https://github.com/netty/netty/pull/10826#pullrequestreview-539478163", "createdAt": "2020-11-26T17:21:58Z", "commit": {"oid": "ee73dfc355359fae184a9e5a6d9afdeca6933640"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNzoyMTo1OFrOH6jY1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNzoyMTo1OFrOH6jY1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE1OTI1Mw==", "bodyText": "let's put a proper assert with monitor check", "url": "https://github.com/netty/netty/pull/10826#discussion_r531159253", "createdAt": "2020-11-26T17:21:58Z", "author": {"login": "franz1981"}, "path": "buffer/src/main/java/io/netty/buffer/PoolArena.java", "diffHunk": "@@ -190,7 +190,7 @@ private void tcacheAllocateNormal(PoolThreadCache cache, PooledByteBuf<T> buf, f\n         }\n     }\n \n-    // Method must be called inside synchronized(this) { ... }\u00a0block\n+    // Method must be called inside synchronized(this) { ... } block", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee73dfc355359fae184a9e5a6d9afdeca6933640"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NDc4NDg0", "url": "https://github.com/netty/netty/pull/10826#pullrequestreview-539478484", "createdAt": "2020-11-26T17:22:40Z", "commit": {"oid": "ee73dfc355359fae184a9e5a6d9afdeca6933640"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NDk1NTM4", "url": "https://github.com/netty/netty/pull/10826#pullrequestreview-539495538", "createdAt": "2020-11-26T18:03:31Z", "commit": {"oid": "ee73dfc355359fae184a9e5a6d9afdeca6933640"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxODowMzozMVrOH6kUVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxODowMzozMVrOH6kUVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE3NDQ4Ng==", "bodyText": "what is the reason for returning 0 and not -1 here ? IMHO -1 would be what I expect for a non existing key as handles will always be positive.", "url": "https://github.com/netty/netty/pull/10826#discussion_r531174486", "createdAt": "2020-11-26T18:03:31Z", "author": {"login": "normanmaurer"}, "path": "buffer/src/main/java/io/netty/buffer/PoolChunk.java", "diffHunk": "@@ -245,18 +239,18 @@ private void insertAvailRun(int runOffset, int pages, Long handle) {\n         }\n     }\n \n-    private void insertAvailRun0(int runOffset, Long handle) {\n-        Long pre = runsAvailMap.put(runOffset, handle);\n-        assert pre == null;\n+    private void insertAvailRun0(int runOffset, long handle) {\n+        long pre = runsAvailMap.put(runOffset, handle);\n+        assert pre == 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee73dfc355359fae184a9e5a6d9afdeca6933640"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31e2fe5deb8c5a726b4651423db96d87e6fcd101", "author": {"user": {"login": "chrisvest", "name": "Chris Vest"}}, "url": "https://github.com/netty/netty/commit/31e2fe5deb8c5a726b4651423db96d87e6fcd101", "committedDate": "2020-11-27T10:30:49Z", "message": "Add tests for LongPriorityQueue\n\nMotivation:\nAlthough the algorithm is simple, it's important that it works correctly.\n\nModification:\nAdd tests for the LongPriorityQueue.\n\nResult:\nThe LongPriorityQueue is now thoroughly tested direct, instead of indirectly through the various buffer and pool tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90f6bae3defe59f8edbfe2c9d8ff994643d8c484", "author": {"user": {"login": "chrisvest", "name": "Chris Vest"}}, "url": "https://github.com/netty/netty/commit/90f6bae3defe59f8edbfe2c9d8ff994643d8c484", "committedDate": "2020-11-27T16:34:11Z", "message": "Add tests for LongLongHashMap and fix bugs\n\nMotivation:\nSomething as complicated as a hash map obviously needs to have its own set of tests.\n\nModification:\nAdd tests for the LongLongHashMap, and fix the bugs found.\n\nResult:\nThe LongLongHashMap is now well tested, and seems to work correctly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b64b8e5a7fbe3dbff2df7944925503a476e9e57e", "author": {"user": {"login": "chrisvest", "name": "Chris Vest"}}, "url": "https://github.com/netty/netty/commit/b64b8e5a7fbe3dbff2df7944925503a476e9e57e", "committedDate": "2020-11-27T16:45:47Z", "message": "Use -1 as the empty value for LongLongHashMap in PoolChunk\n\nMotivation:\n-1 is a more obvious signal for the absence of a value, and it shouldn't be overlapping with the data domain used in PoolChunk.\n\nModification:\nMake PoolChunk instantiate its LongLongHashMap to use -1 as the empty value.\n\nResult:\nCleaner and more obvious code in PoolChunk."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "584552c2b33f952131abc9702c65c6651d98adad", "author": {"user": {"login": "chrisvest", "name": "Chris Vest"}}, "url": "https://github.com/netty/netty/commit/584552c2b33f952131abc9702c65c6651d98adad", "committedDate": "2020-11-27T16:50:43Z", "message": "Remove diamond operators to make things compile on all supported Java versions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMzUzNTAz", "url": "https://github.com/netty/netty/pull/10826#pullrequestreview-540353503", "createdAt": "2020-11-28T09:03:55Z", "commit": {"oid": "584552c2b33f952131abc9702c65c6651d98adad"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNDYxOTA1", "url": "https://github.com/netty/netty/pull/10826#pullrequestreview-540461905", "createdAt": "2020-11-29T09:28:16Z", "commit": {"oid": "584552c2b33f952131abc9702c65c6651d98adad"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNDI3MDk3", "url": "https://github.com/netty/netty/pull/10826#pullrequestreview-540427097", "createdAt": "2020-11-29T01:05:42Z", "commit": {"oid": "584552c2b33f952131abc9702c65c6651d98adad"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQwMTowNTo0MlrOH7eZ-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQwMToyMzo0MVrOH7efYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNjIwMA==", "bodyText": "Curious why the special handling of key 0?", "url": "https://github.com/netty/netty/pull/10826#discussion_r532126200", "createdAt": "2020-11-29T01:05:42Z", "author": {"login": "njhill"}, "path": "buffer/src/main/java/io/netty/buffer/LongLongHashMap.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.buffer;\n+\n+/**\n+ * Internal primitive map implementation that is specifically optimised for the runs availability map use case in {@link\n+ * PoolChunk}.\n+ */\n+final class LongLongHashMap {\n+    private static final int MASK_TEMPLATE = ~1;\n+    private int mask;\n+    private long[] array;\n+    private int maxProbe;\n+    private long zeroVal;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "584552c2b33f952131abc9702c65c6651d98adad"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNjQwOA==", "bodyText": "Since this is special purpose how about just hard-coding this to -1? Might allow bit more compiler optimization (non-static final is untrusted)", "url": "https://github.com/netty/netty/pull/10826#discussion_r532126408", "createdAt": "2020-11-29T01:08:38Z", "author": {"login": "njhill"}, "path": "buffer/src/main/java/io/netty/buffer/LongLongHashMap.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.buffer;\n+\n+/**\n+ * Internal primitive map implementation that is specifically optimised for the runs availability map use case in {@link\n+ * PoolChunk}.\n+ */\n+final class LongLongHashMap {\n+    private static final int MASK_TEMPLATE = ~1;\n+    private int mask;\n+    private long[] array;\n+    private int maxProbe;\n+    private long zeroVal;\n+    private final long emptyVal;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "584552c2b33f952131abc9702c65c6651d98adad"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNzM4Nw==", "bodyText": "nit: no need for var", "url": "https://github.com/netty/netty/pull/10826#discussion_r532127387", "createdAt": "2020-11-29T01:21:20Z", "author": {"login": "njhill"}, "path": "buffer/src/main/java/io/netty/buffer/LongLongHashMap.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.buffer;\n+\n+/**\n+ * Internal primitive map implementation that is specifically optimised for the runs availability map use case in {@link\n+ * PoolChunk}.\n+ */\n+final class LongLongHashMap {\n+    private static final int MASK_TEMPLATE = ~1;\n+    private int mask;\n+    private long[] array;\n+    private int maxProbe;\n+    private long zeroVal;\n+    private final long emptyVal;\n+\n+    LongLongHashMap(long emptyVal) {\n+        this.emptyVal = emptyVal;\n+        zeroVal = emptyVal;\n+        int initialSize = 32;\n+        array = new long[initialSize];\n+        mask = initialSize - 1;\n+        computeMaskAndProbe();\n+    }\n+\n+    public long put(long key, long value) {\n+        if (key == 0) {\n+            long prev = zeroVal;\n+            zeroVal = value;\n+            return prev;\n+        }\n+\n+        for (;;) {\n+            int index = index(key);\n+            for (int i = 0; i < maxProbe; i++) {\n+                long existing = array[index];\n+                if (existing == key || existing == 0) {\n+                    long prev = existing == 0? emptyVal : array[index + 1];\n+                    array[index] = key;\n+                    array[index + 1] = value;\n+                    for (; i < maxProbe; i++) { // Nerf any existing misplaced entries.\n+                        index = index + 2 & mask;\n+                        if (array[index] == key) {\n+                            array[index] = 0;\n+                            prev = array[index + 1];\n+                            break;\n+                        }\n+                    }\n+                    return prev;\n+                }\n+                index = index + 2 & mask;\n+            }\n+            expand(); // Grow array and re-hash.\n+        }\n+    }\n+\n+    public void remove(long key) {\n+        if (key == 0) {\n+            zeroVal = emptyVal;\n+            return;\n+        }\n+        int index = index(key);\n+        for (int i = 0; i < maxProbe; i++) {\n+            long existing = array[index];\n+            if (existing == key) {\n+                array[index] = 0;\n+                break;\n+            }\n+            index = index + 2 & mask;\n+        }\n+    }\n+\n+    public long get(long key) {\n+        if (key == 0) {\n+            return zeroVal;\n+        }\n+        int index = index(key);\n+        for (int i = 0; i < maxProbe; i++) {\n+            long existing = array[index];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "584552c2b33f952131abc9702c65c6651d98adad"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNzU4Nw==", "bodyText": "How about filling the array with -1 here ... could eliminate some branches in the other methods", "url": "https://github.com/netty/netty/pull/10826#discussion_r532127587", "createdAt": "2020-11-29T01:23:41Z", "author": {"login": "njhill"}, "path": "buffer/src/main/java/io/netty/buffer/LongLongHashMap.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.buffer;\n+\n+/**\n+ * Internal primitive map implementation that is specifically optimised for the runs availability map use case in {@link\n+ * PoolChunk}.\n+ */\n+final class LongLongHashMap {\n+    private static final int MASK_TEMPLATE = ~1;\n+    private int mask;\n+    private long[] array;\n+    private int maxProbe;\n+    private long zeroVal;\n+    private final long emptyVal;\n+\n+    LongLongHashMap(long emptyVal) {\n+        this.emptyVal = emptyVal;\n+        zeroVal = emptyVal;\n+        int initialSize = 32;\n+        array = new long[initialSize];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "584552c2b33f952131abc9702c65c6651d98adad"}, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4862, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}