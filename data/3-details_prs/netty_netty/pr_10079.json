{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyOTUxMTg1", "number": 10079, "title": "Use MacOSDnsServerAddressStreamProvider when on the classpath and we \u2026", "bodyText": "\u2026are running on MacOS\nMotivation:\n939e928 introduced MacOSDnsServerAddressStreamProvider which will ensure the right nameservers are selected when running on MacOS. To ensure this is done automatically on MacOS we should use it by default on these platforms.\nModifications:\nTry to use MacOSDnsServerAddressStreamProvider when on MacOS via reflection and fallback if not possible\nResult:\nEnsure the right nameservers are used on MacOS even when a VPN (for example) is used.", "createdAt": "2020-03-03T13:28:55Z", "url": "https://github.com/netty/netty/pull/10079", "merged": true, "mergeCommit": {"oid": "660759b99757748dc416b52028b31f97d80f7d08"}, "closed": true, "closedAt": "2020-03-06T09:41:36Z", "author": {"login": "normanmaurer"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKF-j5gFqTM2ODE4NTE1OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKw4n8gFqTM2OTg2MDYwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MTg1MTU5", "url": "https://github.com/netty/netty/pull/10079#pullrequestreview-368185159", "createdAt": "2020-03-03T17:37:45Z", "commit": {"oid": "aba969b526ae1b662e82de75d0970e288bc2dda7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNzozNzo0NVrOFxPxkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNzo0Mjo1M1rOFxP8og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4Mjk5NA==", "bodyText": "Is it necessary to create a new instance here? Consider invoking ensureAvailability() method instead of isAvailable() and newInstance().", "url": "https://github.com/netty/netty/pull/10079#discussion_r387182994", "createdAt": "2020-03-03T17:37:45Z", "author": {"login": "idelpivnitskiy"}, "path": "resolver-dns/src/main/java/io/netty/resolver/dns/DnsNameResolverBuilder.java", "diffHunk": "@@ -55,13 +66,68 @@\n     private int maxPayloadSize = 4096;\n     private boolean optResourceEnabled = true;\n     private HostsFileEntriesResolver hostsFileEntriesResolver = HostsFileEntriesResolver.DEFAULT;\n-    private DnsServerAddressStreamProvider dnsServerAddressStreamProvider = platformDefault();\n+    private DnsServerAddressStreamProvider dnsServerAddressStreamProvider = defaultStreamProvider();\n     private DnsQueryLifecycleObserverFactory dnsQueryLifecycleObserverFactory =\n             NoopDnsQueryLifecycleObserverFactory.INSTANCE;\n     private String[] searchDomains;\n     private int ndots = -1;\n     private boolean decodeIdn = true;\n \n+    static {\n+        Constructor<? extends DnsServerAddressStreamProvider> constructor = null;\n+        if (PlatformDependent.isOsx()) {\n+            try {\n+                // As MacOSDnsServerAddressStreamProvider is contained in another jar which depends on this jar\n+                // we use reflection to use it if its on the classpath.\n+                Object maybeProvider = AccessController.doPrivileged(new PrivilegedAction<Object>() {\n+                    @Override\n+                    public Object run() {\n+                        try {\n+                            return Class.forName(\n+                                    \"io.netty.resolver.dns.macos.MacOSDnsServerAddressStreamProvider\",\n+                                    false,\n+                                    PlatformDependent.getSystemClassLoader());\n+                        } catch (Throwable cause) {\n+                            return cause;\n+                        }\n+                    }\n+                });\n+                if (maybeProvider instanceof Class) {\n+                    @SuppressWarnings(\"unchecked\")\n+                    Class<? extends DnsServerAddressStreamProvider> providerClass =\n+                            (Class<? extends DnsServerAddressStreamProvider>) maybeProvider;\n+                    Method method = providerClass.getMethod(\"isAvailable\");\n+                    if (Boolean.TRUE.equals(method.invoke(null))) {\n+                        constructor = providerClass.getConstructor();\n+                        constructor.newInstance();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aba969b526ae1b662e82de75d0970e288bc2dda7"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4NTgyNg==", "bodyText": "In DnsServerAddressStreamProviders you decide between windows and unix. Consider moving all this macos logic there as well to keep all os-related decision in one place.", "url": "https://github.com/netty/netty/pull/10079#discussion_r387185826", "createdAt": "2020-03-03T17:42:53Z", "author": {"login": "idelpivnitskiy"}, "path": "resolver-dns/src/main/java/io/netty/resolver/dns/DnsNameResolverBuilder.java", "diffHunk": "@@ -55,13 +66,68 @@\n     private int maxPayloadSize = 4096;\n     private boolean optResourceEnabled = true;\n     private HostsFileEntriesResolver hostsFileEntriesResolver = HostsFileEntriesResolver.DEFAULT;\n-    private DnsServerAddressStreamProvider dnsServerAddressStreamProvider = platformDefault();\n+    private DnsServerAddressStreamProvider dnsServerAddressStreamProvider = defaultStreamProvider();\n     private DnsQueryLifecycleObserverFactory dnsQueryLifecycleObserverFactory =\n             NoopDnsQueryLifecycleObserverFactory.INSTANCE;\n     private String[] searchDomains;\n     private int ndots = -1;\n     private boolean decodeIdn = true;\n \n+    static {\n+        Constructor<? extends DnsServerAddressStreamProvider> constructor = null;\n+        if (PlatformDependent.isOsx()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aba969b526ae1b662e82de75d0970e288bc2dda7"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MjIyOTYz", "url": "https://github.com/netty/netty/pull/10079#pullrequestreview-368222963", "createdAt": "2020-03-03T18:33:10Z", "commit": {"oid": "aba969b526ae1b662e82de75d0970e288bc2dda7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxODozMzoxMFrOFxRnBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxODozMzoxMFrOFxRnBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIxMzA2Mg==", "bodyText": "Can we just use this instance as opposed to keeping a reference to the constructior and call newInstance() from defaultStreamProvider() below?", "url": "https://github.com/netty/netty/pull/10079#discussion_r387213062", "createdAt": "2020-03-03T18:33:10Z", "author": {"login": "NiteshKant"}, "path": "resolver-dns/src/main/java/io/netty/resolver/dns/DnsNameResolverBuilder.java", "diffHunk": "@@ -55,13 +66,68 @@\n     private int maxPayloadSize = 4096;\n     private boolean optResourceEnabled = true;\n     private HostsFileEntriesResolver hostsFileEntriesResolver = HostsFileEntriesResolver.DEFAULT;\n-    private DnsServerAddressStreamProvider dnsServerAddressStreamProvider = platformDefault();\n+    private DnsServerAddressStreamProvider dnsServerAddressStreamProvider = defaultStreamProvider();\n     private DnsQueryLifecycleObserverFactory dnsQueryLifecycleObserverFactory =\n             NoopDnsQueryLifecycleObserverFactory.INSTANCE;\n     private String[] searchDomains;\n     private int ndots = -1;\n     private boolean decodeIdn = true;\n \n+    static {\n+        Constructor<? extends DnsServerAddressStreamProvider> constructor = null;\n+        if (PlatformDependent.isOsx()) {\n+            try {\n+                // As MacOSDnsServerAddressStreamProvider is contained in another jar which depends on this jar\n+                // we use reflection to use it if its on the classpath.\n+                Object maybeProvider = AccessController.doPrivileged(new PrivilegedAction<Object>() {\n+                    @Override\n+                    public Object run() {\n+                        try {\n+                            return Class.forName(\n+                                    \"io.netty.resolver.dns.macos.MacOSDnsServerAddressStreamProvider\",\n+                                    false,\n+                                    PlatformDependent.getSystemClassLoader());\n+                        } catch (Throwable cause) {\n+                            return cause;\n+                        }\n+                    }\n+                });\n+                if (maybeProvider instanceof Class) {\n+                    @SuppressWarnings(\"unchecked\")\n+                    Class<? extends DnsServerAddressStreamProvider> providerClass =\n+                            (Class<? extends DnsServerAddressStreamProvider>) maybeProvider;\n+                    Method method = providerClass.getMethod(\"isAvailable\");\n+                    if (Boolean.TRUE.equals(method.invoke(null))) {\n+                        constructor = providerClass.getConstructor();\n+                        constructor.newInstance();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aba969b526ae1b662e82de75d0970e288bc2dda7"}, "originalPosition": 65}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aba969b526ae1b662e82de75d0970e288bc2dda7", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/aba969b526ae1b662e82de75d0970e288bc2dda7", "committedDate": "2020-03-03T13:26:16Z", "message": "Use MacOSDnsServerAddressStreamProvider when on the classpath and we are running on MacOS\n\nMotivation:\n\n939e928312f1099373582f9811817a6226550987 introduced MacOSDnsServerAddressStreamProvider which will ensure the right nameservers are selected when running on MacOS. To ensure this is done automatically on MacOS we should use it by default on these platforms.\n\nModifications:\n\nTry to use MacOSDnsServerAddressStreamProvider when on MacOS via reflection and fallback if not possible\n\nResult:\n\nEnsure the right nameservers are used on MacOS even when a VPN (for example) is used."}, "afterCommit": {"oid": "a5dcb60161dd1530f03b62eff88f0235e6f8c7be", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/a5dcb60161dd1530f03b62eff88f0235e6f8c7be", "committedDate": "2020-03-04T12:52:42Z", "message": "Use MacOSDnsServerAddressStreamProvider when on the classpath and we are running on MacOS\n\nMotivation:\n\n939e928312f1099373582f9811817a6226550987 introduced MacOSDnsServerAddressStreamProvider which will ensure the right nameservers are selected when running on MacOS. To ensure this is done automatically on MacOS we should use it by default on these platforms.\n\nModifications:\n\nTry to use MacOSDnsServerAddressStreamProvider when on MacOS via reflection and fallback if not possible\n\nResult:\n\nEnsure the right nameservers are used on MacOS even when a VPN (for example) is used."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74334c2a090b57ad7d5bac41b6d5a09de5600d0d", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/74334c2a090b57ad7d5bac41b6d5a09de5600d0d", "committedDate": "2020-03-04T12:54:06Z", "message": "Use MacOSDnsServerAddressStreamProvider when on the classpath and we are running on MacOS\n\nMotivation:\n\n939e928312f1099373582f9811817a6226550987 introduced MacOSDnsServerAddressStreamProvider which will ensure the right nameservers are selected when running on MacOS. To ensure this is done automatically on MacOS we should use it by default on these platforms.\n\nModifications:\n\nTry to use MacOSDnsServerAddressStreamProvider when on MacOS via reflection and fallback if not possible\n\nResult:\n\nEnsure the right nameservers are used on MacOS even when a VPN (for example) is used."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5dcb60161dd1530f03b62eff88f0235e6f8c7be", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/a5dcb60161dd1530f03b62eff88f0235e6f8c7be", "committedDate": "2020-03-04T12:52:42Z", "message": "Use MacOSDnsServerAddressStreamProvider when on the classpath and we are running on MacOS\n\nMotivation:\n\n939e928312f1099373582f9811817a6226550987 introduced MacOSDnsServerAddressStreamProvider which will ensure the right nameservers are selected when running on MacOS. To ensure this is done automatically on MacOS we should use it by default on these platforms.\n\nModifications:\n\nTry to use MacOSDnsServerAddressStreamProvider when on MacOS via reflection and fallback if not possible\n\nResult:\n\nEnsure the right nameservers are used on MacOS even when a VPN (for example) is used."}, "afterCommit": {"oid": "74334c2a090b57ad7d5bac41b6d5a09de5600d0d", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/74334c2a090b57ad7d5bac41b6d5a09de5600d0d", "committedDate": "2020-03-04T12:54:06Z", "message": "Use MacOSDnsServerAddressStreamProvider when on the classpath and we are running on MacOS\n\nMotivation:\n\n939e928312f1099373582f9811817a6226550987 introduced MacOSDnsServerAddressStreamProvider which will ensure the right nameservers are selected when running on MacOS. To ensure this is done automatically on MacOS we should use it by default on these platforms.\n\nModifications:\n\nTry to use MacOSDnsServerAddressStreamProvider when on MacOS via reflection and fallback if not possible\n\nResult:\n\nEnsure the right nameservers are used on MacOS even when a VPN (for example) is used."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MDU5MzE5", "url": "https://github.com/netty/netty/pull/10079#pullrequestreview-369059319", "createdAt": "2020-03-04T19:28:24Z", "commit": {"oid": "74334c2a090b57ad7d5bac41b6d5a09de5600d0d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOToyODoyNVrOFx6m2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOTozNToxN1rOFx617g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4NDc2Mw==", "bodyText": "IIUC, there is a chance that users will never hit this path. Therefore, there is no need to load and initialize DnsServerAddressStreamProviders in advance. Can we use DnsServerAddressStreamProviders.unixDefault() here instead of a static constant?", "url": "https://github.com/netty/netty/pull/10079#discussion_r387884763", "createdAt": "2020-03-04T19:28:25Z", "author": {"login": "idelpivnitskiy"}, "path": "resolver-dns-native-macos/src/main/java/io/netty/resolver/dns/macos/MacOSDnsServerAddressStreamProvider.java", "diffHunk": "@@ -167,7 +169,7 @@ public DnsServerAddressStream nameServerAddressStream(String hostname) {\n                 if (addresses != null) {\n                     return addresses.stream();\n                 }\n-                return DEFAULT_PROVIDER.nameServerAddressStream(originalHostname);\n+                return UNIX_PROVIDER.nameServerAddressStream(originalHostname);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74334c2a090b57ad7d5bac41b6d5a09de5600d0d"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4ODYyMg==", "bodyText": "On macOS users may never hit DEFAULT_DNS_SERVER_ADDRESS_STREAM_PROVIDER. Therefore, we may defer initialization until necessary, if we move this constant to another class.", "url": "https://github.com/netty/netty/pull/10079#discussion_r387888622", "createdAt": "2020-03-04T19:35:17Z", "author": {"login": "idelpivnitskiy"}, "path": "resolver-dns/src/main/java/io/netty/resolver/dns/DnsServerAddressStreamProviders.java", "diffHunk": "@@ -67,6 +116,21 @@ private DnsServerAddressStreamProviders() {\n      * configuration.\n      */\n     public static DnsServerAddressStreamProvider platformDefault() {\n+        if (STREAM_PROVIDER_CONSTRUCTOR != null) {\n+            try {\n+                return STREAM_PROVIDER_CONSTRUCTOR.newInstance();\n+            } catch (IllegalAccessException e) {\n+                // ignore\n+            } catch (InstantiationException e) {\n+                // ignore\n+            } catch (InvocationTargetException e) {\n+                // ignore\n+            }\n+        }\n+        return unixDefault();\n+    }\n+\n+    public static DnsServerAddressStreamProvider unixDefault() {\n         return DEFAULT_DNS_SERVER_ADDRESS_STREAM_PROVIDER;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74334c2a090b57ad7d5bac41b6d5a09de5600d0d"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab2199a228c4c33c1c923e9be9bcef07b5117801", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/ab2199a228c4c33c1c923e9be9bcef07b5117801", "committedDate": "2020-03-05T11:55:33Z", "message": "Lazy init"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9aaa5eefdc8992a0225c8c379b1c26bfff3a9e2f", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/9aaa5eefdc8992a0225c8c379b1c26bfff3a9e2f", "committedDate": "2020-03-05T11:54:30Z", "message": "Lazy init"}, "afterCommit": {"oid": "ab2199a228c4c33c1c923e9be9bcef07b5117801", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/ab2199a228c4c33c1c923e9be9bcef07b5117801", "committedDate": "2020-03-05T11:55:33Z", "message": "Lazy init"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODU3MzQ5", "url": "https://github.com/netty/netty/pull/10079#pullrequestreview-369857349", "createdAt": "2020-03-05T19:37:54Z", "commit": {"oid": "ab2199a228c4c33c1c923e9be9bcef07b5117801"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODYwNjA0", "url": "https://github.com/netty/netty/pull/10079#pullrequestreview-369860604", "createdAt": "2020-03-05T19:42:37Z", "commit": {"oid": "ab2199a228c4c33c1c923e9be9bcef07b5117801"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 380, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}