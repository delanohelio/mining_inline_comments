{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNjUxMzg3", "number": 10615, "title": "Close IOUringEventLoop wakeup/eventfd close shutdown race", "bodyText": "Motivation\nThere is a race condition when shutting down the event loop where the eventFd write performed in the wakeup() method may actually hit a different fd if it's closed and reassigned in the meantime.\nThis was already encountered and addressed in the epoll case.\nModifications\nSimilar to what's done for epoll, in IOUringEventLoop:\n\nReinstatependingWakeup flag which tracks when there is a wakeup pending (CAS of nextWakeupNanos performed by other thread in the wakeup() method)\nAdd logic to the cleanup() method to wait for corresponding READ CQE before closing the eventFd\nRemove unused fields from IOUringCompletionQueue (cleanup)\n\nResult\nNo event loop shutdown race", "createdAt": "2020-09-27T01:18:02Z", "url": "https://github.com/netty/netty/pull/10615", "merged": true, "mergeCommit": {"oid": "f6c84541bef15a13172d5ae57c3a626deeb22b44"}, "closed": true, "closedAt": "2020-09-28T06:47:24Z", "author": {"login": "njhill"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdM0e-CgH2gAyNDkzNjUxMzg3OmY4NWI3YzQ4MGQ3YWIyNmM1YTg4NzgxMjBlYjFlNWUxZjcwOTViMzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNCxJ2gFqTQ5NzA5ODQ4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f85b7c480d7ab26c5a8878120eb1e5e1f7095b37", "author": {"user": {"login": "njhill", "name": "Nick Hill"}}, "url": "https://github.com/netty/netty/commit/f85b7c480d7ab26c5a8878120eb1e5e1f7095b37", "committedDate": "2020-09-27T01:13:13Z", "message": "Close IOUringEventLoop wakeup/eventfd close shutdown race\n\nMotivation\n\nThere is a race condition when shutting down the event loop where the\neventFd write performed in the wakeup() method may actually hit a\ndifferent fd if it's closed and reassigned in the meantime.\n\nThis was already encountered and addressed in the epoll case.\n\nModifications\n\nSimilar to what's done for epoll, in IOUringEventLoop:\n- Reinstate pendingWakeup flag which tracks when there is a wakeup\npending (CAS of nextWakeupNanos performed by other thread in the\nwakeup() method)\n- Add logic to the cleanup() method to wait for corresponding READ CQE\nbefore closing the eventFd\n- Remove unused fields from IOUringCompletionQueue (cleanup)\n\nResult\n\nNo event loop shutdown race"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDg3MjYx", "url": "https://github.com/netty/netty/pull/10615#pullrequestreview-497087261", "createdAt": "2020-09-27T14:56:16Z", "commit": {"oid": "f85b7c480d7ab26c5a8878120eb1e5e1f7095b37"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNDo1NjoxN1rOHYn4eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNDo1NjoxN1rOHYn4eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTMwNA==", "bodyText": "@njhill shouldn't we keep the cancel check ?", "url": "https://github.com/netty/netty/pull/10615#discussion_r495581304", "createdAt": "2020-09-27T14:56:17Z", "author": {"login": "normanmaurer"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -220,9 +223,8 @@ void handleLoopException(Throwable t) {\n     @Override\n     public void handle(int fd, int res, int flags, int op, int data) {\n         if (op == Native.IORING_OP_READ && eventfd.intValue() == fd) {\n-            if (res != Native.ERRNO_ECANCELED_NEGATIVE) {\n-                addEventFdRead(ringBuffer.ioUringSubmissionQueue());\n-            }\n+            pendingWakeup = false;\n+            addEventFdRead(ringBuffer.ioUringSubmissionQueue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f85b7c480d7ab26c5a8878120eb1e5e1f7095b37"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDk4NDgz", "url": "https://github.com/netty/netty/pull/10615#pullrequestreview-497098483", "createdAt": "2020-09-27T17:51:45Z", "commit": {"oid": "f85b7c480d7ab26c5a8878120eb1e5e1f7095b37"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 71, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}