{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NTc1OTIw", "number": 10337, "title": "Fix possible StackOverflowError when try to resolve authorative names\u2026", "bodyText": "\u2026ervers\nMotivation:\nThere is a possibility to end up with a StackOverflowError when trying to resolve authorative nameservers because of incorrect wrapping the AuthoritativeDnsServerCache.\nModifications:\nEnsure we don't end up with an overflow due wrapping\nResult:\nFixes #10246", "createdAt": "2020-06-02T13:13:38Z", "url": "https://github.com/netty/netty/pull/10337", "merged": true, "mergeCommit": {"oid": "0bd87716976f36cfa35d8ddbbb7bc0d700b402e6"}, "closed": true, "closedAt": "2020-06-04T15:57:00Z", "author": {"login": "normanmaurer"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnVd3CgH2gAyNDI2NTc1OTIwOjNhNTlmNTA3ZjMyNWMzYTI3ZmRiZmZkOGE0YWNhMTI5M2QxYWU2NDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnsJMyAFqTQyMzczNTIxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3a59f507f325c3a27fdbffd8a4aca1293d1ae648", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/3a59f507f325c3a27fdbffd8a4aca1293d1ae648", "committedDate": "2020-06-02T14:09:45Z", "message": "Fix possible StackOverflowError when try to resolve authorative nameservers\n\nMotivation:\n\nThere is a possibility to end up with a StackOverflowError when trying to resolve authorative nameservers because of incorrect wrapping the AuthoritativeDnsServerCache.\n\nModifications:\n\nEnsure we don't end up with an overflow due wrapping\n\nResult:\n\nFixes https://github.com/netty/netty/issues/10246"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa80dcc9f39a77e064a9fed1dbc457f29f8a563f", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/fa80dcc9f39a77e064a9fed1dbc457f29f8a563f", "committedDate": "2020-06-02T13:08:11Z", "message": "Fix possible StackOverflowError when try to resolve authorative nameservers\n\nMotivation:\n\nThere is a possibility to end up with a StackOverflowError when trying to resolve authorative nameservers because of incorrect wrapping the AuthoritativeDnsServerCache.\n\nModifications:\n\nEnsure we don't end up with an overflow due wrapping\n\nResult:\n\nFixes https://github.com/netty/netty/issues/10246"}, "afterCommit": {"oid": "3a59f507f325c3a27fdbffd8a4aca1293d1ae648", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/3a59f507f325c3a27fdbffd8a4aca1293d1ae648", "committedDate": "2020-06-02T14:09:45Z", "message": "Fix possible StackOverflowError when try to resolve authorative nameservers\n\nMotivation:\n\nThere is a possibility to end up with a StackOverflowError when trying to resolve authorative nameservers because of incorrect wrapping the AuthoritativeDnsServerCache.\n\nModifications:\n\nEnsure we don't end up with an overflow due wrapping\n\nResult:\n\nFixes https://github.com/netty/netty/issues/10246"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyODk0MDMy", "url": "https://github.com/netty/netty/pull/10337#pullrequestreview-422894032", "createdAt": "2020-06-02T17:19:42Z", "commit": {"oid": "3a59f507f325c3a27fdbffd8a4aca1293d1ae648"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzoxOTo0MlrOGd77Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzoxOTo0MlrOGd77Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA0MzY5MA==", "bodyText": "Consider the opposite approach: write a utility method that will wrap only if it's not an instance of RedirectAuthoritativeDnsServerCache. That will help to avoid allocation of a new object when it's already wrapped.", "url": "https://github.com/netty/netty/pull/10337#discussion_r434043690", "createdAt": "2020-06-02T17:19:42Z", "author": {"login": "idelpivnitskiy"}, "path": "resolver-dns/src/main/java/io/netty/resolver/dns/DnsResolveContext.java", "diffHunk": "@@ -498,34 +498,49 @@ public void operationComplete(final Future<List<InetAddress>> future) {\n                 }\n             }\n         });\n-        if (!DnsNameResolver.doResolveAllCached(nameServerName, additionals, resolverPromise, resolveCache(),\n+        DnsCache resolveCache = resolveCache();\n+        if (!DnsNameResolver.doResolveAllCached(nameServerName, additionals, resolverPromise, resolveCache,\n                 parent.resolvedInternetProtocolFamiliesUnsafe())) {\n-            final AuthoritativeDnsServerCache authoritativeDnsServerCache = authoritativeDnsServerCache();\n             new DnsAddressResolveContext(parent, originalPromise, nameServerName, additionals,\n-                                         parent.newNameServerAddressStream(nameServerName),\n-                                         resolveCache(), new AuthoritativeDnsServerCache() {\n-                @Override\n-                public DnsServerAddressStream get(String hostname) {\n-                    // To not risk falling into any loop, we will not use the cache while following redirects but only\n-                    // on the initial query.\n-                    return null;\n-                }\n+                                         parent.newNameServerAddressStream(nameServerName), resolveCache,\n+                                         new RedirectAuthoritativeDnsServerCache(authoritativeDnsServerCache()), false)\n+                    .resolve(resolverPromise);\n+        }\n+    }\n \n-                @Override\n-                public void cache(String hostname, InetSocketAddress address, long originalTtl, EventLoop loop) {\n-                    authoritativeDnsServerCache.cache(hostname, address, originalTtl, loop);\n-                }\n+    private static final class RedirectAuthoritativeDnsServerCache implements AuthoritativeDnsServerCache {\n+        private final AuthoritativeDnsServerCache wrapped;\n \n-                @Override\n-                public void clear() {\n-                    authoritativeDnsServerCache.clear();\n-                }\n+        RedirectAuthoritativeDnsServerCache(AuthoritativeDnsServerCache authoritativeDnsServerCache) {\n+            // Unwrap to prevent the possibility of an StackOverflowError when wrapping another\n+            // RedirectAuthoritativeDnsServerCache.\n+            if (authoritativeDnsServerCache instanceof RedirectAuthoritativeDnsServerCache) {\n+                this.wrapped = ((RedirectAuthoritativeDnsServerCache) authoritativeDnsServerCache).wrapped;\n+            } else {\n+                this.wrapped = authoritativeDnsServerCache;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a59f507f325c3a27fdbffd8a4aca1293d1ae648"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc3192eda047ae78d674e17b845cf940ba32ebc9", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/cc3192eda047ae78d674e17b845cf940ba32ebc9", "committedDate": "2020-06-03T06:31:31Z", "message": "Address review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNzM1MjEz", "url": "https://github.com/netty/netty/pull/10337#pullrequestreview-423735213", "createdAt": "2020-06-03T16:35:00Z", "commit": {"oid": "cc3192eda047ae78d674e17b845cf940ba32ebc9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 109, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}