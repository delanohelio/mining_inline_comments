{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNzgxMDQ4", "number": 10069, "title": "Preserve order when using alternate event loops", "bodyText": "When the HttpContentCompressor is put on an alternate EventExecutor, the order of events should be\npreserved so that the compressed content is correctly created. This is done by checking that\nthe executor in the ChannelHandlerContext is the same executor as the current executor when\nevaluating if the handler should be skipped.\nMotivation:\nHttpContentCompressor shouldn't mangle the content when it is put on an alternate EventExecutor\nModification:\nDescribe the modifications you've done.\nChecked the executor when examining if the handler could be skipped.\nResult:\nFixes #10067\nIf there is no issue then describe the changes introduced by this PR.", "createdAt": "2020-02-29T06:34:18Z", "url": "https://github.com/netty/netty/pull/10069", "merged": true, "mergeCommit": {"oid": "7fce06a0d1f76865b1494fde99697c31a8a1f92f"}, "closed": true, "closedAt": "2020-03-03T09:42:42Z", "author": {"login": "atcurtis"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJTh3LgFqTM2NjgzODk2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJ9t2_ABqjMwOTEwNTM3NzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2ODM4OTY3", "url": "https://github.com/netty/netty/pull/10069#pullrequestreview-366838967", "createdAt": "2020-03-01T06:56:34Z", "commit": {"oid": "e8dd352c8d17943df310ba1371329c0990e5bbb9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQwNjo1NjozNFrOFwMnGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQwNjo1NjozNFrOFwMnGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA4MjU4Nw==", "bodyText": "this is not correct (and also not the one above) as you will cause a ClassCastException later on if the ChannelHandlerContext does not wrap an ChannelOutboundHandler.", "url": "https://github.com/netty/netty/pull/10069#discussion_r386082587", "createdAt": "2020-03-01T06:56:34Z", "author": {"login": "normanmaurer"}, "path": "transport/src/main/java/io/netty/channel/AbstractChannelHandlerContext.java", "diffHunk": "@@ -906,17 +906,21 @@ private boolean isNotValidPromise(ChannelPromise promise, boolean allowVoidPromi\n \n     private AbstractChannelHandlerContext findContextInbound(int mask) {\n         AbstractChannelHandlerContext ctx = this;\n+        EventExecutor currentExecutor = executor();\n         do {\n             ctx = ctx.next;\n-        } while ((ctx.executionMask & mask) == 0);\n+        } while (!ChannelHandlerMask.isInbound(ctx.executionMask)\n+            || (ctx.executionMask & mask) == 0 && ctx.executor() == currentExecutor);\n         return ctx;\n     }\n \n     private AbstractChannelHandlerContext findContextOutbound(int mask) {\n         AbstractChannelHandlerContext ctx = this;\n+        EventExecutor currentExecutor = executor();\n         do {\n             ctx = ctx.prev;\n-        } while ((ctx.executionMask & mask) == 0);\n+        } while (!ChannelHandlerMask.isOutbound(ctx.executionMask)\n+            || (ctx.executionMask & mask) == 0 && ctx.executor() == currentExecutor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8dd352c8d17943df310ba1371329c0990e5bbb9"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc0e3147dc0b2c8b20b04494322460661e3eefea", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/fc0e3147dc0b2c8b20b04494322460661e3eefea", "committedDate": "2020-03-02T08:36:15Z", "message": "works"}, "afterCommit": {"oid": "9a4fa90032d86c2b1c47039aeb8a3b88ae03cffd", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/9a4fa90032d86c2b1c47039aeb8a3b88ae03cffd", "committedDate": "2020-03-02T09:27:00Z", "message": "Fix context selection"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d43c4870de2663d7f78863d5476ae6ffd7640094", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/d43c4870de2663d7f78863d5476ae6ffd7640094", "committedDate": "2020-03-02T13:36:30Z", "message": "Fix buffer leaks and cleanup"}, "afterCommit": {"oid": "b3725abd87b66a56ab389397d82a98d84b45745c", "author": {"user": {"login": "atcurtis", "name": "Antony T Curtis"}}, "url": "https://github.com/netty/netty/commit/b3725abd87b66a56ab389397d82a98d84b45745c", "committedDate": "2020-03-02T21:50:24Z", "message": "Preserve order when using alternate event loops\n\nWhen the HttpContentCompressor is put on an alternate EventExecutor, the order of events should be\npreserved so that the compressed content is correctly created. This is done by checking that\nthe executor in the ChannelHandlerContext is the same executor as the current executor when\nevaluating if the handler should be skipped."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3725abd87b66a56ab389397d82a98d84b45745c", "author": {"user": {"login": "atcurtis", "name": "Antony T Curtis"}}, "url": "https://github.com/netty/netty/commit/b3725abd87b66a56ab389397d82a98d84b45745c", "committedDate": "2020-03-02T21:50:24Z", "message": "Preserve order when using alternate event loops\n\nWhen the HttpContentCompressor is put on an alternate EventExecutor, the order of events should be\npreserved so that the compressed content is correctly created. This is done by checking that\nthe executor in the ChannelHandlerContext is the same executor as the current executor when\nevaluating if the handler should be skipped."}, "afterCommit": {"oid": "d43c4870de2663d7f78863d5476ae6ffd7640094", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/d43c4870de2663d7f78863d5476ae6ffd7640094", "committedDate": "2020-03-02T13:36:30Z", "message": "Fix buffer leaks and cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e921df1574d8eb6ea34cddd122821142f7adc27e", "author": {"user": {"login": "atcurtis", "name": "Antony T Curtis"}}, "url": "https://github.com/netty/netty/commit/e921df1574d8eb6ea34cddd122821142f7adc27e", "committedDate": "2020-03-03T08:03:50Z", "message": "Preserve order when using alternate event loops\n\nMotivation:\n\nWhen the HttpContentCompressor is put on an alternate EventExecutor, the order of events should be\npreserved so that the compressed content is correctly created.\n\nModifications:\n- checking that the executor in the ChannelHandlerContext is the same executor as the current executor when evaluating if the handler should be skipped.\n- Add unit test\n\nResult:\n\nFixes https://github.com/netty/netty/issues/10067\n\nCo-authored-by: Norman Maurer <norman_maurer@apple.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d43c4870de2663d7f78863d5476ae6ffd7640094", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/d43c4870de2663d7f78863d5476ae6ffd7640094", "committedDate": "2020-03-02T13:36:30Z", "message": "Fix buffer leaks and cleanup"}, "afterCommit": {"oid": "e921df1574d8eb6ea34cddd122821142f7adc27e", "author": {"user": {"login": "atcurtis", "name": "Antony T Curtis"}}, "url": "https://github.com/netty/netty/commit/e921df1574d8eb6ea34cddd122821142f7adc27e", "committedDate": "2020-03-03T08:03:50Z", "message": "Preserve order when using alternate event loops\n\nMotivation:\n\nWhen the HttpContentCompressor is put on an alternate EventExecutor, the order of events should be\npreserved so that the compressed content is correctly created.\n\nModifications:\n- checking that the executor in the ChannelHandlerContext is the same executor as the current executor when evaluating if the handler should be skipped.\n- Add unit test\n\nResult:\n\nFixes https://github.com/netty/netty/issues/10067\n\nCo-authored-by: Norman Maurer <norman_maurer@apple.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 374, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}