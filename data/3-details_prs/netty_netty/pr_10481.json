{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3NDIxOTEy", "number": 10481, "title": "AbstractDiskHttpData#getChunk closes fileChannel only if everything w\u2026", "bodyText": "\u2026as read or an exception is thrown\nMotivation:\nAbstractDiskHttpData#getChunk opens and closes fileChannel every time when it is invoked,\nas a result the uploaded file is corrupted. This is a regression caused by #10270.\nModifications:\n\nClose the fileChannel only if everything was read or an exception is thrown\nAdd unit test\n\nResult:\nAbstractDiskHttpData#getChunk closes fileChannel only if everything was read or an exception is thrown", "createdAt": "2020-08-13T14:26:50Z", "url": "https://github.com/netty/netty/pull/10481", "merged": true, "mergeCommit": {"oid": "b27914e3020fcf1f3d3ce2868c7507e5fea6480a"}, "closed": true, "closedAt": "2020-08-14T08:54:44Z", "author": {"login": "violetagg"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-gswVAH2gAyNDY3NDIxOTEyOmU3ZDE0ZjA4YzIxMTEyYmEyM2I2N2ZkMGRjMzlhMjU1OWZlNTg2M2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-kwdbAFqTQ2NzA0Nzk4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e7d14f08c21112ba23b67fd0dc39a2559fe5863d", "author": {"user": {"login": "violetagg", "name": "Violeta Georgieva"}}, "url": "https://github.com/netty/netty/commit/e7d14f08c21112ba23b67fd0dc39a2559fe5863d", "committedDate": "2020-08-13T14:15:14Z", "message": "AbstractDiskHttpData#getChunk closes fileChannel only if everything was read or an exception is thrown\n\nMotivation:\nAbstractDiskHttpData#getChunk opens and closes fileChannel every time when it is invoked,\nas a result the uploaded file is corrupted. This is a regression caused by #10270.\n\nModifications:\n\n- Close the fileChannel only if everything was read or an exception is thrown\n- Add unit test\n\nResult:\nAbstractDiskHttpData#getChunk closes fileChannel only if everything was read or an exception is thrown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2ODgyMDQ0", "url": "https://github.com/netty/netty/pull/10481#pullrequestreview-466882044", "createdAt": "2020-08-13T15:37:18Z", "commit": {"oid": "e7d14f08c21112ba23b67fd0dc39a2559fe5863d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNTozNzoxOFrOHARL6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNTozNzoxOFrOHARL6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0MzYyNQ==", "bodyText": "@violetagg so you want to assert that both are not equals ?\nWhy not use assertFalse(Arrays.equals(.....)) or assertFalse(buf1.equals(buf2));?", "url": "https://github.com/netty/netty/pull/10481#discussion_r470043625", "createdAt": "2020-08-13T15:37:18Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/AbstractDiskHttpDataTest.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufUtil;\n+import io.netty.util.internal.PlatformDependent;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.nio.charset.Charset;\n+import java.util.UUID;\n+\n+import static io.netty.util.CharsetUtil.UTF_8;\n+import static org.junit.Assert.assertArrayEquals;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+/**\n+ * {@link AbstractDiskHttpData} test cases\n+ */\n+public class AbstractDiskHttpDataTest {\n+\n+    @Test\n+    public void testGetChunk() throws Exception {\n+        TestHttpData test = new TestHttpData(\"test\", UTF_8, 0);\n+        try {\n+            File tmpFile = File.createTempFile(UUID.randomUUID().toString(), \".tmp\");\n+            tmpFile.deleteOnExit();\n+            FileOutputStream fos = new FileOutputStream(tmpFile);\n+            byte[] bytes = new byte[4096];\n+            PlatformDependent.threadLocalRandom().nextBytes(bytes);\n+            try {\n+                fos.write(bytes);\n+                fos.flush();\n+            } finally {\n+                fos.close();\n+            }\n+            test.setContent(tmpFile);\n+            ByteBuf buf1 = test.getChunk(1024);\n+            assertEquals(buf1.readerIndex(), 0);\n+            assertEquals(buf1.writerIndex(), 1024);\n+            ByteBuf buf2 = test.getChunk(1024);\n+            assertEquals(buf2.readerIndex(), 0);\n+            assertEquals(buf2.writerIndex(), 1024);\n+            try {\n+                assertArrayEquals(ByteBufUtil.getBytes(buf1), ByteBufUtil.getBytes(buf2));\n+            } catch (AssertionError e) {\n+                return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7d14f08c21112ba23b67fd0dc39a2559fe5863d"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66383c88aead219a60cb4c84761b5727acb11c02", "author": {"user": {"login": "violetagg", "name": "Violeta Georgieva"}}, "url": "https://github.com/netty/netty/commit/66383c88aead219a60cb4c84761b5727acb11c02", "committedDate": "2020-08-13T15:51:09Z", "message": "Address feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MDQ3OTgw", "url": "https://github.com/netty/netty/pull/10481#pullrequestreview-467047980", "createdAt": "2020-08-13T18:58:54Z", "commit": {"oid": "66383c88aead219a60cb4c84761b5727acb11c02"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 196, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}