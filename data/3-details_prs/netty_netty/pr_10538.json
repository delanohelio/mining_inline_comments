{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxMTYyMjM2", "number": 10538, "title": "Only execute the close once the already added write operations completes", "bodyText": "@normanmaurer\nMotivation:\nWe need to be careful that we only execute the close(...) once the write\noperation completes as otherwise we may close the underlying socket too\nfast and also the writes\nModifications:\nKeep track of if we need to delay the close or not and if so execute it\nonce the write completes\nResult:\nNo more test failures", "createdAt": "2020-09-07T08:01:37Z", "url": "https://github.com/netty/netty/pull/10538", "merged": true, "mergeCommit": {"oid": "8ef5dbc24b97eb665a9e47b6801e90c8158b9ea9"}, "closed": true, "closedAt": "2020-09-09T09:42:38Z", "author": {"login": "normanmaurer"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGebnnAFqTQ4MzMzOTkzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHIZ_WAFqTQ4NDgwNTYwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMzM5OTMw", "url": "https://github.com/netty/netty/pull/10538#pullrequestreview-483339930", "createdAt": "2020-09-07T08:06:57Z", "commit": {"oid": "56a998c03ceeb36caa6d825b6828f91cda91750a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwODowNjo1OFrOHN0_ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwODowNzo0M1rOHN1BAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI2MTc5NQ==", "bodyText": "Wildcard not allowed.", "url": "https://github.com/netty/netty/pull/10538#discussion_r484261795", "createdAt": "2020-09-07T08:06:58Z", "author": {"login": "hyperxpro"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringChannel.java", "diffHunk": "@@ -19,18 +19,7 @@\n import io.netty.buffer.ByteBufAllocator;\n import io.netty.buffer.ByteBufUtil;\n import io.netty.buffer.Unpooled;\n-import io.netty.channel.AbstractChannel;\n-import io.netty.channel.Channel;\n-import io.netty.channel.ChannelConfig;\n-import io.netty.channel.ChannelFuture;\n-import io.netty.channel.ChannelFutureListener;\n-import io.netty.channel.ChannelMetadata;\n-import io.netty.channel.ChannelOutboundBuffer;\n-import io.netty.channel.ChannelPromise;\n-import io.netty.channel.ConnectTimeoutException;\n-import io.netty.channel.DefaultChannelConfig;\n-import io.netty.channel.EventLoop;\n-import io.netty.channel.RecvByteBufAllocator;\n+import io.netty.channel.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56a998c03ceeb36caa6d825b6828f91cda91750a"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI2MjE0NQ==", "bodyText": "Can we use a Logger instead of System.out.println(Object)?", "url": "https://github.com/netty/netty/pull/10538#discussion_r484262145", "createdAt": "2020-09-07T08:07:43Z", "author": {"login": "hyperxpro"}, "path": "transport-native-io_uring/src/test/java/io/netty/channel/uring/PollRemoveTest.java", "diffHunk": "@@ -81,7 +81,7 @@ public void initChannel(SocketChannel ch) throws Exception {\n     public void test() throws Exception {\n \n         io_uring_test();\n-\n+        Thread.sleep(1000);\n         System.out.println(\"io_uring --------------------------------\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56a998c03ceeb36caa6d825b6828f91cda91750a"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56a998c03ceeb36caa6d825b6828f91cda91750a", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/56a998c03ceeb36caa6d825b6828f91cda91750a", "committedDate": "2020-09-07T08:00:27Z", "message": "Address nicks comments"}, "afterCommit": {"oid": "0b164de4f3d8dc166103af2b82f07b216ceaf49a", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/0b164de4f3d8dc166103af2b82f07b216ceaf49a", "committedDate": "2020-09-07T08:34:04Z", "message": "Address nicks comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b164de4f3d8dc166103af2b82f07b216ceaf49a", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/0b164de4f3d8dc166103af2b82f07b216ceaf49a", "committedDate": "2020-09-07T08:34:04Z", "message": "Address nicks comments"}, "afterCommit": {"oid": "ae5a8d795a2be7ec9e2f1fa7aefc2189fee4d8b6", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/ae5a8d795a2be7ec9e2f1fa7aefc2189fee4d8b6", "committedDate": "2020-09-07T08:42:59Z", "message": "Address nicks comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMzgyNzg0", "url": "https://github.com/netty/netty/pull/10538#pullrequestreview-483382784", "createdAt": "2020-09-07T09:02:53Z", "commit": {"oid": "ae5a8d795a2be7ec9e2f1fa7aefc2189fee4d8b6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwOTowMjo1M1rOHN2_Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwOTowOTowNFrOHN3OOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI5NDQ1OA==", "bodyText": "A sleep in a test is always suspicious.", "url": "https://github.com/netty/netty/pull/10538#discussion_r484294458", "createdAt": "2020-09-07T09:02:53Z", "author": {"login": "chrisvest"}, "path": "transport-native-io_uring/src/test/java/io/netty/channel/uring/PollRemoveTest.java", "diffHunk": "@@ -64,6 +64,9 @@ public void initChannel(SocketChannel ch) { }\n     @Test\n     public void test() throws Exception {\n         io_uring_test();\n+\n+        Thread.sleep(1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae5a8d795a2be7ec9e2f1fa7aefc2189fee4d8b6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI5ODI5Nw==", "bodyText": "An alternative to delay enqueueing the close operation, could be to enqueue it with the IOSQE_IO_DRAIN flag. Then the close operation will not be started until prior operations have completed, though following operations will also not be started until the close operation has completion, thus creating a slight queue hiccup. The hiccup might not be a big deal, though, compared to the state tracking we otherwise have to do.", "url": "https://github.com/netty/netty/pull/10538#discussion_r484298297", "createdAt": "2020-09-07T09:09:04Z", "author": {"login": "chrisvest"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringChannel.java", "diffHunk": "@@ -327,23 +346,54 @@ private void doWriteMultiple(ChannelOutboundBuffer in) {\n      }\n \n     protected final void doWriteSingle(ByteBuf buf) {\n+        assert (ioState & WRITE_SCHEDULED) == 0;\n         IOUringSubmissionQueue submissionQueue = submissionQueue();\n         submissionQueue.addWrite(socket.intValue(), buf.memoryAddress(), buf.readerIndex(),\n                 buf.writerIndex());\n         ioState |= WRITE_SCHEDULED;\n     }\n \n     //POLLOUT\n-    private void addPollOut() {\n+    private void schedulePollOut() {\n         assert (ioState & POLL_OUT_SCHEDULED) == 0;\n-        ioState |= POLL_OUT_SCHEDULED;\n         IOUringSubmissionQueue submissionQueue = submissionQueue();\n         submissionQueue.addPollOut(socket.intValue());\n+        ioState |= POLL_OUT_SCHEDULED;\n+    }\n+\n+    void schedulePollRdHup() {\n+        assert (ioState & POLL_RDHUP_SCHEDULED) == 0;\n+        IOUringSubmissionQueue submissionQueue = submissionQueue();\n+        submissionQueue.addPollRdHup(fd().intValue());\n+        ioState |= POLL_RDHUP_SCHEDULED;\n     }\n \n     abstract class AbstractUringUnsafe extends AbstractUnsafe {\n         private IOUringRecvByteAllocatorHandle allocHandle;\n \n+        @Override\n+        public void close(ChannelPromise promise) {\n+            if ((ioState & (WRITE_SCHEDULED | READ_SCHEDULED | CONNECT_SCHEDULED)) == 0) {\n+                forceClose(promise);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae5a8d795a2be7ec9e2f1fa7aefc2189fee4d8b6"}, "originalPosition": 104}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNDIwODI4", "url": "https://github.com/netty/netty/pull/10538#pullrequestreview-483420828", "createdAt": "2020-09-07T09:54:20Z", "commit": {"oid": "657864aaae906e1195d7ec3546d2db0984be8dac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwOTo1NDoyMFrOHN43LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwOTo1NDoyMFrOHN43LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMyNTE2NA==", "bodyText": "This is not needed anymore as even with SO_LINGER we are fine as the close will not block this method ;)", "url": "https://github.com/netty/netty/pull/10538#discussion_r484325164", "createdAt": "2020-09-07T09:54:20Z", "author": {"login": "normanmaurer"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringChannel.java", "diffHunk": "@@ -247,29 +243,16 @@ protected void doClose() throws Exception {\n \n             cancelConnectTimeoutFuture();\n \n-            if (isRegistered()) {\n-                // Need to check if we are on the EventLoop as doClose() may be triggered by the GlobalEventExecutor\n-                // if SO_LINGER is used.\n-                //\n-                // See https://github.com/netty/netty/issues/7159", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "657864aaae906e1195d7ec3546d2db0984be8dac"}, "originalPosition": 82}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNDIxMzQ1", "url": "https://github.com/netty/netty/pull/10538#pullrequestreview-483421345", "createdAt": "2020-09-07T09:55:02Z", "commit": {"oid": "657864aaae906e1195d7ec3546d2db0984be8dac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwOTo1NTowMlrOHN44rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwOTo1NTowMlrOHN44rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMyNTU0OA==", "bodyText": "I need this one for now... We will refactor this later on.", "url": "https://github.com/netty/netty/pull/10538#discussion_r484325548", "createdAt": "2020-09-07T09:55:02Z", "author": {"login": "normanmaurer"}, "path": "transport-native-unix-common/src/main/java/io/netty/channel/unix/FileDescriptor.java", "diffHunk": "@@ -62,23 +62,28 @@ public final int intValue() {\n         return fd;\n     }\n \n-    /**\n-     * Close the file descriptor.\n-     */\n-    public void close() throws IOException {\n+    protected boolean markClosed() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "657864aaae906e1195d7ec3546d2db0984be8dac"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNjY3OTQ4", "url": "https://github.com/netty/netty/pull/10538#pullrequestreview-483667948", "createdAt": "2020-09-07T17:01:57Z", "commit": {"oid": "657864aaae906e1195d7ec3546d2db0984be8dac"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNzowMTo1N1rOHOE_rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxOToxNzo1M1rOHOGjIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUyMzk1MQ==", "bodyText": "nit: combine these?", "url": "https://github.com/netty/netty/pull/10538#discussion_r484523951", "createdAt": "2020-09-07T17:01:57Z", "author": {"login": "njhill"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringChannel.java", "diffHunk": "@@ -288,6 +271,16 @@ protected void doWrite(ChannelOutboundBuffer in) {\n         if ((ioState & WRITE_SCHEDULED) != 0) {\n             return;\n         }\n+        scheduleWrite(in);\n+    }\n+\n+    private void scheduleWrite(ChannelOutboundBuffer in) {\n+        if (delayedClose != null) {\n+            return;\n+        }\n+        if (in == null) {\n+            return;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "657864aaae906e1195d7ec3546d2db0984be8dac"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU0NjUyMQ==", "bodyText": "nit: write -> io", "url": "https://github.com/netty/netty/pull/10538#discussion_r484546521", "createdAt": "2020-09-07T19:00:31Z", "author": {"login": "njhill"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringChannel.java", "diffHunk": "@@ -327,23 +320,54 @@ private void doWriteMultiple(ChannelOutboundBuffer in) {\n      }\n \n     protected final void doWriteSingle(ByteBuf buf) {\n+        assert (ioState & WRITE_SCHEDULED) == 0;\n         IOUringSubmissionQueue submissionQueue = submissionQueue();\n         submissionQueue.addWrite(socket.intValue(), buf.memoryAddress(), buf.readerIndex(),\n                 buf.writerIndex());\n         ioState |= WRITE_SCHEDULED;\n     }\n \n     //POLLOUT\n-    private void addPollOut() {\n+    private void schedulePollOut() {\n         assert (ioState & POLL_OUT_SCHEDULED) == 0;\n-        ioState |= POLL_OUT_SCHEDULED;\n         IOUringSubmissionQueue submissionQueue = submissionQueue();\n         submissionQueue.addPollOut(socket.intValue());\n+        ioState |= POLL_OUT_SCHEDULED;\n+    }\n+\n+    void schedulePollRdHup() {\n+        assert (ioState & POLL_RDHUP_SCHEDULED) == 0;\n+        IOUringSubmissionQueue submissionQueue = submissionQueue();\n+        submissionQueue.addPollRdHup(fd().intValue());\n+        ioState |= POLL_RDHUP_SCHEDULED;\n     }\n \n     abstract class AbstractUringUnsafe extends AbstractUnsafe {\n         private IOUringRecvByteAllocatorHandle allocHandle;\n \n+        @Override\n+        public void close(ChannelPromise promise) {\n+            if ((ioState & (WRITE_SCHEDULED | READ_SCHEDULED | CONNECT_SCHEDULED)) == 0) {\n+                forceClose(promise);\n+            } else {\n+                if (delayedClose == null || delayedClose.isVoid()) {\n+                    // We have a write operation pending that should be completed asap.\n+                    // We will do the actual close operation one this write result is returned as otherwise\n+                    // we may get into trouble as we may close the fd while we did not process the write yet.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "657864aaae906e1195d7ec3546d2db0984be8dac"}, "originalPosition": 168}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU0NzU5Ng==", "bodyText": "nit: else if?", "url": "https://github.com/netty/netty/pull/10538#discussion_r484547596", "createdAt": "2020-09-07T19:06:59Z", "author": {"login": "njhill"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringChannel.java", "diffHunk": "@@ -327,23 +320,54 @@ private void doWriteMultiple(ChannelOutboundBuffer in) {\n      }\n \n     protected final void doWriteSingle(ByteBuf buf) {\n+        assert (ioState & WRITE_SCHEDULED) == 0;\n         IOUringSubmissionQueue submissionQueue = submissionQueue();\n         submissionQueue.addWrite(socket.intValue(), buf.memoryAddress(), buf.readerIndex(),\n                 buf.writerIndex());\n         ioState |= WRITE_SCHEDULED;\n     }\n \n     //POLLOUT\n-    private void addPollOut() {\n+    private void schedulePollOut() {\n         assert (ioState & POLL_OUT_SCHEDULED) == 0;\n-        ioState |= POLL_OUT_SCHEDULED;\n         IOUringSubmissionQueue submissionQueue = submissionQueue();\n         submissionQueue.addPollOut(socket.intValue());\n+        ioState |= POLL_OUT_SCHEDULED;\n+    }\n+\n+    void schedulePollRdHup() {\n+        assert (ioState & POLL_RDHUP_SCHEDULED) == 0;\n+        IOUringSubmissionQueue submissionQueue = submissionQueue();\n+        submissionQueue.addPollRdHup(fd().intValue());\n+        ioState |= POLL_RDHUP_SCHEDULED;\n     }\n \n     abstract class AbstractUringUnsafe extends AbstractUnsafe {\n         private IOUringRecvByteAllocatorHandle allocHandle;\n \n+        @Override\n+        public void close(ChannelPromise promise) {\n+            if ((ioState & (WRITE_SCHEDULED | READ_SCHEDULED | CONNECT_SCHEDULED)) == 0) {\n+                forceClose(promise);\n+            } else {\n+                if (delayedClose == null || delayedClose.isVoid()) {\n+                    // We have a write operation pending that should be completed asap.\n+                    // We will do the actual close operation one this write result is returned as otherwise\n+                    // we may get into trouble as we may close the fd while we did not process the write yet.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU0NjUyMQ=="}, "originalCommit": {"oid": "657864aaae906e1195d7ec3546d2db0984be8dac"}, "originalPosition": 168}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU0NzcwMg==", "bodyText": "nit: could simplify to:\n} else if (!promise.isVoid()) {\n    delayedClose.addListener(new ChannelPromiseNotifier(promise));\n}", "url": "https://github.com/netty/netty/pull/10538#discussion_r484547702", "createdAt": "2020-09-07T19:07:34Z", "author": {"login": "njhill"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringChannel.java", "diffHunk": "@@ -327,23 +320,54 @@ private void doWriteMultiple(ChannelOutboundBuffer in) {\n      }\n \n     protected final void doWriteSingle(ByteBuf buf) {\n+        assert (ioState & WRITE_SCHEDULED) == 0;\n         IOUringSubmissionQueue submissionQueue = submissionQueue();\n         submissionQueue.addWrite(socket.intValue(), buf.memoryAddress(), buf.readerIndex(),\n                 buf.writerIndex());\n         ioState |= WRITE_SCHEDULED;\n     }\n \n     //POLLOUT\n-    private void addPollOut() {\n+    private void schedulePollOut() {\n         assert (ioState & POLL_OUT_SCHEDULED) == 0;\n-        ioState |= POLL_OUT_SCHEDULED;\n         IOUringSubmissionQueue submissionQueue = submissionQueue();\n         submissionQueue.addPollOut(socket.intValue());\n+        ioState |= POLL_OUT_SCHEDULED;\n+    }\n+\n+    void schedulePollRdHup() {\n+        assert (ioState & POLL_RDHUP_SCHEDULED) == 0;\n+        IOUringSubmissionQueue submissionQueue = submissionQueue();\n+        submissionQueue.addPollRdHup(fd().intValue());\n+        ioState |= POLL_RDHUP_SCHEDULED;\n     }\n \n     abstract class AbstractUringUnsafe extends AbstractUnsafe {\n         private IOUringRecvByteAllocatorHandle allocHandle;\n \n+        @Override\n+        public void close(ChannelPromise promise) {\n+            if ((ioState & (WRITE_SCHEDULED | READ_SCHEDULED | CONNECT_SCHEDULED)) == 0) {\n+                forceClose(promise);\n+            } else {\n+                if (delayedClose == null || delayedClose.isVoid()) {\n+                    // We have a write operation pending that should be completed asap.\n+                    // We will do the actual close operation one this write result is returned as otherwise\n+                    // we may get into trouble as we may close the fd while we did not process the write yet.\n+                    delayedClose = promise;\n+                } else {\n+                    if (promise.isVoid()) {\n+                        return;\n+                    }\n+                    delayedClose.addListener(new ChannelPromiseNotifier(promise));\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "657864aaae906e1195d7ec3546d2db0984be8dac"}, "originalPosition": 175}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU0ODUwMg==", "bodyText": "clear RDHUP_SCHEDULED here?", "url": "https://github.com/netty/netty/pull/10538#discussion_r484548502", "createdAt": "2020-09-07T19:12:18Z", "author": {"login": "njhill"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringChannel.java", "diffHunk": "@@ -464,6 +495,9 @@ final void readComplete(int res) {\n          * Called once POLLRDHUP event is ready to be processed\n          */\n         final void pollRdHup(int res) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "657864aaae906e1195d7ec3546d2db0984be8dac"}, "originalPosition": 214}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU0OTQxMQ==", "bodyText": "Could do as a follow-on but this would probably be cleaner to cover non-channel-specific cases first, then lookup the channel once and pass it to appropriate handler if non-null (rather than looking up separately in each of the handlers)", "url": "https://github.com/netty/netty/pull/10538#discussion_r484549411", "createdAt": "2020-09-07T19:17:53Z", "author": {"login": "njhill"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -168,53 +168,69 @@ protected void run() {\n     @Override\n     public boolean handle(int fd, int res, long flags, int op, int pollMask) {\n         IOUringSubmissionQueue submissionQueue = ringBuffer.getIoUringSubmissionQueue();\n+        final AbstractIOUringChannel channel;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "657864aaae906e1195d7ec3546d2db0984be8dac"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzODY4NTQy", "url": "https://github.com/netty/netty/pull/10538#pullrequestreview-483868542", "createdAt": "2020-09-08T07:34:41Z", "commit": {"oid": "c9ddf729e6b101088f1b92af89491883c2bacdc3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9ddf729e6b101088f1b92af89491883c2bacdc3", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/c9ddf729e6b101088f1b92af89491883c2bacdc3", "committedDate": "2020-09-08T06:42:29Z", "message": "More comments of nick"}, "afterCommit": {"oid": "354d0cbbcd95142604172f59d5f6e0a17d2af392", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/354d0cbbcd95142604172f59d5f6e0a17d2af392", "committedDate": "2020-09-08T19:46:15Z", "message": "Fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cc47c439952596fb5b55db4d4a85c5672f4d99d", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/1cc47c439952596fb5b55db4d4a85c5672f4d99d", "committedDate": "2020-09-09T07:59:27Z", "message": "Only execute the close once the already added write operations completes\n\nMotivation:\n\nWe need to be careful that we only execute the close(...) once the write\noperation completes as otherwise we may close the underlying socket too\nfast and also the writes\n\nModifications:\n\nKeep track of if we need to delay the close or not and if so execute it\nonce the write completes\n\nResult:\n\nNo more test failures"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "354d0cbbcd95142604172f59d5f6e0a17d2af392", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/354d0cbbcd95142604172f59d5f6e0a17d2af392", "committedDate": "2020-09-08T19:46:15Z", "message": "Fixes"}, "afterCommit": {"oid": "1cc47c439952596fb5b55db4d4a85c5672f4d99d", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/1cc47c439952596fb5b55db4d4a85c5672f4d99d", "committedDate": "2020-09-09T07:59:27Z", "message": "Only execute the close once the already added write operations completes\n\nMotivation:\n\nWe need to be careful that we only execute the close(...) once the write\noperation completes as otherwise we may close the underlying socket too\nfast and also the writes\n\nModifications:\n\nKeep track of if we need to delay the close or not and if so execute it\nonce the write completes\n\nResult:\n\nNo more test failures"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0ODA1NjAw", "url": "https://github.com/netty/netty/pull/10538#pullrequestreview-484805600", "createdAt": "2020-09-09T09:02:20Z", "commit": {"oid": "1cc47c439952596fb5b55db4d4a85c5672f4d99d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 7, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}