{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0Nzc3ODA0", "number": 10509, "title": "Reduce garbage on MQTT", "bodyText": "Motivation:\nMqttEncoder create many byte[] to encode Strings into UTF-8 bytes\nModification:\nByteBufUtil::utf8Bytes and ByteBufUtil::reserveAndWriteUtf8 allows to perform the same operation GC-free\nResult:\nLess garbage produced on Mqtt encoding", "createdAt": "2020-08-27T15:24:27Z", "url": "https://github.com/netty/netty/pull/10509", "merged": true, "mergeCommit": {"oid": "38f01e08403920f56c05da6d42e407f3651b73dc"}, "closed": true, "closedAt": "2020-09-04T16:27:23Z", "author": {"login": "franz1981"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDPKd4gFqTQ3NzI3ODE5Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFjYDCAFqTQ4MjU2OTY3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3Mjc4MTk3", "url": "https://github.com/netty/netty/pull/10509#pullrequestreview-477278197", "createdAt": "2020-08-28T06:38:56Z", "commit": {"oid": "d9bebc96955da549dd15f9cdc9ae66a713fe0d21"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwNjozODo1NlrOHIrYvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwNjozODo1NlrOHIrYvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg2MTUwMA==", "bodyText": "@franz1981 can we please not use wildcard imports :) ?", "url": "https://github.com/netty/netty/pull/10509#discussion_r478861500", "createdAt": "2020-08-28T06:38:56Z", "author": {"login": "normanmaurer"}, "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttEncoder.java", "diffHunk": "@@ -22,11 +22,11 @@\n import io.netty.channel.ChannelHandlerContext;\n import io.netty.handler.codec.DecoderException;\n import io.netty.handler.codec.MessageToMessageEncoder;\n-import io.netty.util.CharsetUtil;\n import io.netty.util.internal.EmptyArrays;\n \n import java.util.List;\n \n+import static io.netty.buffer.ByteBufUtil.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9bebc96955da549dd15f9cdc9ae66a713fe0d21"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9bebc96955da549dd15f9cdc9ae66a713fe0d21", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/d9bebc96955da549dd15f9cdc9ae66a713fe0d21", "committedDate": "2020-08-27T15:23:44Z", "message": "Reduce garbage on MQTT encoding\n\nMotivation:\n\nMqttEncoder create many byte[] to encode Strings into UTF-8 bytes\n\nModification:\n\nByteBufUtil::utf8Bytes and ByteBufUtil::reserveAndWriteUtf8 allows to perform the same operation GC-free\n\nResult:\nLess garbage produced on Mqtt encoding"}, "afterCommit": {"oid": "1239996eb1303e146562e2f2d468879acff748fd", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/1239996eb1303e146562e2f2d468879acff748fd", "committedDate": "2020-08-28T07:13:56Z", "message": "Reduce garbage on MQTT encoding\n\nMotivation:\n\nMqttEncoder create many byte[] to encode Strings into UTF-8 bytes\n\nModification:\n\nByteBufUtil::utf8Bytes and ByteBufUtil::reserveAndWriteUtf8 allows to perform the same operation GC-free\n\nResult:\nLess garbage produced on Mqtt encoding"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1239996eb1303e146562e2f2d468879acff748fd", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/1239996eb1303e146562e2f2d468879acff748fd", "committedDate": "2020-08-28T07:13:56Z", "message": "Reduce garbage on MQTT encoding\n\nMotivation:\n\nMqttEncoder create many byte[] to encode Strings into UTF-8 bytes\n\nModification:\n\nByteBufUtil::utf8Bytes and ByteBufUtil::reserveAndWriteUtf8 allows to perform the same operation GC-free\n\nResult:\nLess garbage produced on Mqtt encoding"}, "afterCommit": {"oid": "b0bd0c470fecf05a24aff9d22763a0f4d93ef5db", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/b0bd0c470fecf05a24aff9d22763a0f4d93ef5db", "committedDate": "2020-09-01T10:51:31Z", "message": "Reduce garbage on MQTT encoding\n\nMotivation:\n\nMqttEncoder create many byte[] to encode Strings into UTF-8 bytes\n\nModification:\n\nByteBufUtil::utf8Bytes and ByteBufUtil::reserveAndWriteUtf8 allows to perform the same operation GC-free\n\nResult:\nLess garbage produced on Mqtt encoding"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0bd0c470fecf05a24aff9d22763a0f4d93ef5db", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/b0bd0c470fecf05a24aff9d22763a0f4d93ef5db", "committedDate": "2020-09-01T10:51:31Z", "message": "Reduce garbage on MQTT encoding\n\nMotivation:\n\nMqttEncoder create many byte[] to encode Strings into UTF-8 bytes\n\nModification:\n\nByteBufUtil::utf8Bytes and ByteBufUtil::reserveAndWriteUtf8 allows to perform the same operation GC-free\n\nResult:\nLess garbage produced on Mqtt encoding"}, "afterCommit": {"oid": "395f64cfe58b619e7e770be446ccaa0e6a7c466f", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/395f64cfe58b619e7e770be446ccaa0e6a7c466f", "committedDate": "2020-09-01T11:32:27Z", "message": "Reduce garbage on MQTT encoding\n\nMotivation:\n\nMqttEncoder create many byte[] to encode Strings into UTF-8 bytes\n\nModification:\n\nByteBufUtil::utf8Bytes and ByteBufUtil::reserveAndWriteUtf8 allows to perform the same operation GC-free\n\nResult:\nLess garbage produced on Mqtt encoding"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5ODg2NTQy", "url": "https://github.com/netty/netty/pull/10509#pullrequestreview-479886542", "createdAt": "2020-09-01T15:52:58Z", "commit": {"oid": "686e35ee4e56b15ec42dff1b8564ee2251a383f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNTo1Mjo1OFrOHK9CuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNTo1Mjo1OFrOHK9CuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI0NzkyOA==", "bodyText": "I prefer to move the array allocations to the static block, so you don't have to hard code the array length like this. Same in MqttQoS.", "url": "https://github.com/netty/netty/pull/10509#discussion_r481247928", "createdAt": "2020-09-01T15:52:58Z", "author": {"login": "chrisvest"}, "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttProperties.java", "diffHunk": "@@ -67,6 +67,14 @@\n         CORRELATION_DATA(0x09),\n         AUTHENTICATION_DATA(0x16);\n \n+        private static final MqttPropertyType[] VALUES = new MqttPropertyType[43];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "686e35ee4e56b15ec42dff1b8564ee2251a383f1"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "686e35ee4e56b15ec42dff1b8564ee2251a383f1", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/686e35ee4e56b15ec42dff1b8564ee2251a383f1", "committedDate": "2020-09-01T15:22:10Z", "message": "Reduce garbage on MQTT encoding/decoding\n\nMotivation:\n\nSome enums valueOf create unnecessary arrays on the hot paths\n\nModification:\n\nImplemented a GC free const table lookup valueOf\n\nResult:\nLess garbage produced on Mqtt"}, "afterCommit": {"oid": "6b309e1a890ffa6226bd239eb0a18e9dd1eee9de", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/6b309e1a890ffa6226bd239eb0a18e9dd1eee9de", "committedDate": "2020-09-01T18:34:17Z", "message": "Reduce garbage on MQTT encoding/decoding\n\nMotivation:\n\nSome enums valueOf create unnecessary arrays on the hot paths\n\nModification:\n\nImplemented GC free const table lookup/switch valueOf\n\nResult:\nLess garbage produced on Mqtt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMTUwMzQy", "url": "https://github.com/netty/netty/pull/10509#pullrequestreview-480150342", "createdAt": "2020-09-01T22:06:36Z", "commit": {"oid": "c3d43f1d0400b0dba5a9a77dcbe9f767c8201546"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjowNjozNlrOHLJ6Nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjozNDozOFrOHLKj5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ1ODc0Mw==", "bodyText": "I don't think these changes to set max capacity == init capacity should be necessary, it won't affect how the buffer is allocated just the cap on how large it can grow beyond init capacity (which it won't because it's being sized precisely up-front IIUC).", "url": "https://github.com/netty/netty/pull/10509#discussion_r481458743", "createdAt": "2020-09-01T22:06:36Z", "author": {"login": "njhill"}, "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttEncoder.java", "diffHunk": "@@ -169,7 +172,8 @@ private static ByteBuf encodeConnectMessage(\n \n                 int variablePartSize = variableHeaderBufferSize + payloadBufferSize;\n                 int fixedHeaderBufferSize = 1 + getVariableLengthInt(variablePartSize);\n-                ByteBuf buf = ctx.alloc().buffer(fixedHeaderBufferSize + variablePartSize);\n+                int totalSize = fixedHeaderBufferSize + variablePartSize;\n+                ByteBuf buf = ctx.alloc().buffer(totalSize, totalSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3d43f1d0400b0dba5a9a77dcbe9f767c8201546"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ1OTYyOA==", "bodyText": "Above lines could be moved inside the if block I think? (I know not strictly related to this PR)", "url": "https://github.com/netty/netty/pull/10509#discussion_r481459628", "createdAt": "2020-09-01T22:08:58Z", "author": {"login": "njhill"}, "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttEncoder.java", "diffHunk": "@@ -125,23 +128,23 @@ private static ByteBuf encodeConnectMessage(\n         if (!isValidClientId(mqttVersion, clientIdentifier)) {\n             throw new MqttIdentifierRejectedException(\"invalid clientIdentifier: \" + clientIdentifier);\n         }\n-        byte[] clientIdentifierBytes = encodeStringUtf8(clientIdentifier);\n-        payloadBufferSize += 2 + clientIdentifierBytes.length;\n+        int clientIdentifierBytes = utf8Bytes(clientIdentifier);\n+        payloadBufferSize += 2 + clientIdentifierBytes;\n \n         // Will topic and message\n         String willTopic = payload.willTopic();\n-        byte[] willTopicBytes = willTopic != null ? encodeStringUtf8(willTopic) : EmptyArrays.EMPTY_BYTES;\n+        int willTopicBytes = nullableUtf8Bytes(willTopic);\n         byte[] willMessage = payload.willMessageInBytes();\n         byte[] willMessageBytes = willMessage != null ? willMessage : EmptyArrays.EMPTY_BYTES;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3d43f1d0400b0dba5a9a77dcbe9f767c8201546"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2Mzg0NA==", "bodyText": "This should be preciseUtf8Length right?", "url": "https://github.com/netty/netty/pull/10509#discussion_r481463844", "createdAt": "2020-09-01T22:19:08Z", "author": {"login": "njhill"}, "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttEncoder.java", "diffHunk": "@@ -689,10 +697,33 @@ private static void writeVariableLengthInt(ByteBuf buf, int num) {\n         } while (num > 0);\n     }\n \n-    static void writeUTF8String(ByteBuf buf, String s) {\n-        byte[] sBytes = encodeStringUtf8(s);\n-        buf.writeShort(sBytes.length);\n-        buf.writeBytes(sBytes, 0, sBytes.length);\n+    private static int nullableUtf8Bytes(String s) {\n+        if (s == null) {\n+            return 0;\n+        }\n+        return utf8Bytes(s);\n+    }\n+\n+    private static void writeUTF8String(ByteBuf buf, String s, int expectedUtf8Length) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3d43f1d0400b0dba5a9a77dcbe9f767c8201546"}, "originalPosition": 343}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2NTgxOQ==", "bodyText": "This isn't necessary.. buf will be expanded inside reserveAndWriteUtf8 if needed", "url": "https://github.com/netty/netty/pull/10509#discussion_r481465819", "createdAt": "2020-09-01T22:24:27Z", "author": {"login": "njhill"}, "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttEncoder.java", "diffHunk": "@@ -689,10 +697,33 @@ private static void writeVariableLengthInt(ByteBuf buf, int num) {\n         } while (num > 0);\n     }\n \n-    static void writeUTF8String(ByteBuf buf, String s) {\n-        byte[] sBytes = encodeStringUtf8(s);\n-        buf.writeShort(sBytes.length);\n-        buf.writeBytes(sBytes, 0, sBytes.length);\n+    private static int nullableUtf8Bytes(String s) {\n+        if (s == null) {\n+            return 0;\n+        }\n+        return utf8Bytes(s);\n+    }\n+\n+    private static void writeUTF8String(ByteBuf buf, String s, int expectedUtf8Length) {\n+        assert nullableUtf8Bytes(s) == expectedUtf8Length;\n+        assert buf.isWritable(expectedUtf8Length + 2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3d43f1d0400b0dba5a9a77dcbe9f767c8201546"}, "originalPosition": 345}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2NjgwMw==", "bodyText": "nit: could use conditional operator", "url": "https://github.com/netty/netty/pull/10509#discussion_r481466803", "createdAt": "2020-09-01T22:27:00Z", "author": {"login": "njhill"}, "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttProperties.java", "diffHunk": "@@ -214,19 +234,35 @@ public void add(MqttProperty property) {\n                 }\n             }\n         } else {\n+            if (props == null) {\n+                props = new IntObjectHashMap<MqttProperty>();\n+                this.props = props;\n+            }\n             props.put(property.propertyId, property);\n         }\n     }\n \n     public Collection<? extends MqttProperty> listAll() {\n+        IntObjectHashMap<MqttProperty> props = this.props;\n+        if (props == null) {\n+            return Collections.emptyList();\n+        }\n         return props.values();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3d43f1d0400b0dba5a9a77dcbe9f767c8201546"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2Njg1Mg==", "bodyText": "nit: conditional operator", "url": "https://github.com/netty/netty/pull/10509#discussion_r481466852", "createdAt": "2020-09-01T22:27:10Z", "author": {"login": "njhill"}, "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttProperties.java", "diffHunk": "@@ -214,19 +234,35 @@ public void add(MqttProperty property) {\n                 }\n             }\n         } else {\n+            if (props == null) {\n+                props = new IntObjectHashMap<MqttProperty>();\n+                this.props = props;\n+            }\n             props.put(property.propertyId, property);\n         }\n     }\n \n     public Collection<? extends MqttProperty> listAll() {\n+        IntObjectHashMap<MqttProperty> props = this.props;\n+        if (props == null) {\n+            return Collections.emptyList();\n+        }\n         return props.values();\n     }\n \n     public boolean isEmpty() {\n+        IntObjectHashMap<MqttProperty> props = this.props;\n+        if (props == null) {\n+            return true;\n+        }\n         return props.isEmpty();\n     }\n \n     public MqttProperty getProperty(int propertyId) {\n+        IntObjectHashMap<MqttProperty> props = this.props;\n+        if (props == null) {\n+            return null;\n+        }\n         return props.get(propertyId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3d43f1d0400b0dba5a9a77dcbe9f767c8201546"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2Njk3MQ==", "bodyText": "nit: return props == null || props.isEmpty()", "url": "https://github.com/netty/netty/pull/10509#discussion_r481466971", "createdAt": "2020-09-01T22:27:31Z", "author": {"login": "njhill"}, "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttProperties.java", "diffHunk": "@@ -214,19 +234,35 @@ public void add(MqttProperty property) {\n                 }\n             }\n         } else {\n+            if (props == null) {\n+                props = new IntObjectHashMap<MqttProperty>();\n+                this.props = props;\n+            }\n             props.put(property.propertyId, property);\n         }\n     }\n \n     public Collection<? extends MqttProperty> listAll() {\n+        IntObjectHashMap<MqttProperty> props = this.props;\n+        if (props == null) {\n+            return Collections.emptyList();\n+        }\n         return props.values();\n     }\n \n     public boolean isEmpty() {\n+        IntObjectHashMap<MqttProperty> props = this.props;\n+        if (props == null) {\n+            return true;\n+        }\n         return props.isEmpty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3d43f1d0400b0dba5a9a77dcbe9f767c8201546"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2ODU3Mg==", "bodyText": "This is redundant for the same reason, but this whole method should only be used when it's already known that the buffer has sufficient space.. maybe rename it writeUTF8StringUnsafe or something", "url": "https://github.com/netty/netty/pull/10509#discussion_r481468572", "createdAt": "2020-09-01T22:32:19Z", "author": {"login": "njhill"}, "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttEncoder.java", "diffHunk": "@@ -689,10 +697,33 @@ private static void writeVariableLengthInt(ByteBuf buf, int num) {\n         } while (num > 0);\n     }\n \n-    static void writeUTF8String(ByteBuf buf, String s) {\n-        byte[] sBytes = encodeStringUtf8(s);\n-        buf.writeShort(sBytes.length);\n-        buf.writeBytes(sBytes, 0, sBytes.length);\n+    private static int nullableUtf8Bytes(String s) {\n+        if (s == null) {\n+            return 0;\n+        }\n+        return utf8Bytes(s);\n+    }\n+\n+    private static void writeUTF8String(ByteBuf buf, String s, int expectedUtf8Length) {\n+        assert nullableUtf8Bytes(s) == expectedUtf8Length;\n+        assert buf.isWritable(expectedUtf8Length + 2);\n+        buf.writeShort(expectedUtf8Length);\n+        if (expectedUtf8Length > 0) {\n+            final int utf8Length = reserveAndWriteUtf8(buf, s, expectedUtf8Length);\n+            assert expectedUtf8Length == utf8Length;\n+        }\n+    }\n+\n+    private static void writeUTF8String(ByteBuf buf, String s) {\n+        assert buf.isWritable(nullableUtf8Bytes(s) + 2);\n+        final int writerIndex = buf.writerIndex();\n+        buf.ensureWritable(buf.capacity() - writerIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3d43f1d0400b0dba5a9a77dcbe9f767c8201546"}, "originalPosition": 356}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2OTQxMw==", "bodyText": "maxUtf8Bytes could be used to \"ensure\" space for these I think, filling in the length field retroactively", "url": "https://github.com/netty/netty/pull/10509#discussion_r481469413", "createdAt": "2020-09-01T22:34:38Z", "author": {"login": "njhill"}, "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttEncoder.java", "diffHunk": "@@ -629,15 +634,18 @@ private static ByteBuf encodeProperties(ByteBufAllocator byteBufAllocator,\n                         case SERVER_REFERENCE:\n                         case REASON_STRING:\n                             writeVariableLengthInt(propertiesBuf, property.propertyId);\n-                            writeUTF8String(propertiesBuf, ((MqttProperties.StringProperty) property).value);\n+                            String value = ((MqttProperties.StringProperty) property).value;\n+                            writeUTF8String(propertiesBuf, value, nullableUtf8Bytes(value));\n                             break;\n                         case USER_PROPERTY:\n                             final List<MqttProperties.StringPair> pairs =\n                                     ((MqttProperties.UserProperties) property).value;\n                             for (MqttProperties.StringPair pair : pairs) {\n                                 writeVariableLengthInt(propertiesBuf, property.propertyId);\n-                                writeUTF8String(propertiesBuf, pair.key);\n-                                writeUTF8String(propertiesBuf, pair.value);\n+                                String k = pair.key;\n+                                String v = pair.value;\n+                                writeUTF8String(propertiesBuf, k, nullableUtf8Bytes(k));\n+                                writeUTF8String(propertiesBuf, v, nullableUtf8Bytes(v));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3d43f1d0400b0dba5a9a77dcbe9f767c8201546"}, "originalPosition": 324}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3d43f1d0400b0dba5a9a77dcbe9f767c8201546", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/c3d43f1d0400b0dba5a9a77dcbe9f767c8201546", "committedDate": "2020-09-01T20:06:33Z", "message": "Reduce garbage on MqttProperties\n\nMotivation:\n\nMqttProperties uses Integer keys instead of int\n\nModification:\n\nMqttProperties uses a primitive key map\n\nResult:\nLess garbage produced on Mqtt"}, "afterCommit": {"oid": "ab55da1a09b4ada89b3e613d3e3a24850995520f", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/ab55da1a09b4ada89b3e613d3e3a24850995520f", "committedDate": "2020-09-02T07:52:25Z", "message": "Reduce garbage on MqttProperties\n\nMotivation:\n\nMqttProperties uses Integer keys instead of int\n\nModification:\n\nMqttProperties uses a primitive key map\n\nResult:\nLess garbage produced on Mqtt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ecaeb114a4d0eb00db0d849af6b4da696cddca7", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/3ecaeb114a4d0eb00db0d849af6b4da696cddca7", "committedDate": "2020-09-02T07:56:41Z", "message": "Reduce garbage on MQTT encoding\n\nMotivation:\n\nMqttEncoder create many byte[] to encode Strings into UTF-8 bytes\n\nModification:\n\nByteBufUtil::utf8Bytes and ByteBufUtil::reserveAndWriteUtf8 allows to perform the same operation GC-free\n\nResult:\nLess garbage produced on Mqtt encoding"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab55da1a09b4ada89b3e613d3e3a24850995520f", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/ab55da1a09b4ada89b3e613d3e3a24850995520f", "committedDate": "2020-09-02T07:52:25Z", "message": "Reduce garbage on MqttProperties\n\nMotivation:\n\nMqttProperties uses Integer keys instead of int\n\nModification:\n\nMqttProperties uses a primitive key map\n\nResult:\nLess garbage produced on Mqtt"}, "afterCommit": {"oid": "70ee96a1cb524a4d634952d4dd5198b570367f75", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/70ee96a1cb524a4d634952d4dd5198b570367f75", "committedDate": "2020-09-02T07:56:41Z", "message": "Reduce garbage on MqttProperties\n\nMotivation:\n\nMqttProperties uses Integer keys instead of int\n\nModification:\n\nMqttProperties uses a primitive key map\n\nResult:\nLess garbage produced on Mqtt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "70ee96a1cb524a4d634952d4dd5198b570367f75", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/70ee96a1cb524a4d634952d4dd5198b570367f75", "committedDate": "2020-09-02T07:56:41Z", "message": "Reduce garbage on MqttProperties\n\nMotivation:\n\nMqttProperties uses Integer keys instead of int\n\nModification:\n\nMqttProperties uses a primitive key map\n\nResult:\nLess garbage produced on Mqtt"}, "afterCommit": {"oid": "272fa37b463d1f010261a5e40a0960a75d97c741", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/272fa37b463d1f010261a5e40a0960a75d97c741", "committedDate": "2020-09-02T08:02:42Z", "message": "Reduce garbage on MqttProperties\n\nMotivation:\n\nMqttProperties uses Integer keys instead of int\n\nModification:\n\nMqttProperties uses a primitive key map\n\nResult:\nLess garbage produced on Mqtt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNTc4Nzc3", "url": "https://github.com/netty/netty/pull/10509#pullrequestreview-480578777", "createdAt": "2020-09-02T08:04:46Z", "commit": {"oid": "272fa37b463d1f010261a5e40a0960a75d97c741"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODowNDo0NlrOHLigzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODowNDo0NlrOHLigzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg2MTgzOA==", "bodyText": "Why not make it final and avoid further null checks?", "url": "https://github.com/netty/netty/pull/10509#discussion_r481861838", "createdAt": "2020-09-02T08:04:46Z", "author": {"login": "paul-lysak"}, "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttProperties.java", "diffHunk": "@@ -190,20 +201,29 @@ public BinaryProperty(int propertyId, byte[] value) {\n     }\n \n     public MqttProperties() {\n-        this(new HashMap<Integer, MqttProperty>());\n+        this(true);\n     }\n \n-    private MqttProperties(Map<Integer, MqttProperty> props) {\n-        this.props = props;\n+    private MqttProperties(boolean canModify) {\n+        this.canModify = canModify;\n     }\n \n-    private final Map<Integer, MqttProperty> props;\n+    private IntObjectHashMap<MqttProperty> props;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "272fa37b463d1f010261a5e40a0960a75d97c741"}, "originalPosition": 73}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "272fa37b463d1f010261a5e40a0960a75d97c741", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/272fa37b463d1f010261a5e40a0960a75d97c741", "committedDate": "2020-09-02T08:02:42Z", "message": "Reduce garbage on MqttProperties\n\nMotivation:\n\nMqttProperties uses Integer keys instead of int\n\nModification:\n\nMqttProperties uses a primitive key map\n\nResult:\nLess garbage produced on Mqtt"}, "afterCommit": {"oid": "a02630406dccff5bf458b6ce4473e029cf6301a6", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/a02630406dccff5bf458b6ce4473e029cf6301a6", "committedDate": "2020-09-02T08:50:43Z", "message": "Reduce garbage on MqttProperties\n\nMotivation:\n\nMqttProperties uses Integer keys instead of int\n\nModification:\n\nMqttProperties uses a primitive key map\n\nResult:\nLess garbage produced on Mqtt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a02630406dccff5bf458b6ce4473e029cf6301a6", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/a02630406dccff5bf458b6ce4473e029cf6301a6", "committedDate": "2020-09-02T08:50:43Z", "message": "Reduce garbage on MqttProperties\n\nMotivation:\n\nMqttProperties uses Integer keys instead of int\n\nModification:\n\nMqttProperties uses a primitive key map\n\nResult:\nLess garbage produced on Mqtt"}, "afterCommit": {"oid": "b4a8e422b2312cc7be210280839bd78ece769b57", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/b4a8e422b2312cc7be210280839bd78ece769b57", "committedDate": "2020-09-02T08:52:14Z", "message": "Reduce garbage on MqttProperties\n\nMotivation:\n\nMqttProperties uses Integer keys instead of int\n\nModification:\n\nMqttProperties uses a primitive key map\n\nResult:\nLess garbage produced on Mqtt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4a8e422b2312cc7be210280839bd78ece769b57", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/b4a8e422b2312cc7be210280839bd78ece769b57", "committedDate": "2020-09-02T08:52:14Z", "message": "Reduce garbage on MqttProperties\n\nMotivation:\n\nMqttProperties uses Integer keys instead of int\n\nModification:\n\nMqttProperties uses a primitive key map\n\nResult:\nLess garbage produced on Mqtt"}, "afterCommit": {"oid": "864beb975983816fe6dbd26e6e58af19370d9aea", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/864beb975983816fe6dbd26e6e58af19370d9aea", "committedDate": "2020-09-02T10:33:00Z", "message": "Reduce garbage on MqttProperties\n\nMotivation:\n\nMqttProperties uses Integer keys instead of int\n\nModification:\n\nMqttProperties uses a primitive key map\n\nResult:\nLess garbage produced on Mqtt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aab55c456f7737d9c8a8452ecf8ae0212f4f303e", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/aab55c456f7737d9c8a8452ecf8ae0212f4f303e", "committedDate": "2020-09-02T11:24:09Z", "message": "Reduce garbage on MqttProperties\n\nMotivation:\n\nMqttProperties uses Integer keys instead of int\n\nModification:\n\nMqttProperties uses a primitive key map\n\nResult:\nLess garbage produced on Mqtt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b32d69dcba8057c46eb5bba8dcbf1872ab81ce4", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/9b32d69dcba8057c46eb5bba8dcbf1872ab81ce4", "committedDate": "2020-09-02T11:24:09Z", "message": "Reduce garbage on MQTT encoding/decoding\n\nMotivation:\n\nSome enums valueOf create unnecessary arrays on the hot paths\n\nModification:\n\nImplemented GC free const table lookup/switch valueOf\n\nResult:\nLess garbage produced on Mqtt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "864beb975983816fe6dbd26e6e58af19370d9aea", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/864beb975983816fe6dbd26e6e58af19370d9aea", "committedDate": "2020-09-02T10:33:00Z", "message": "Reduce garbage on MqttProperties\n\nMotivation:\n\nMqttProperties uses Integer keys instead of int\n\nModification:\n\nMqttProperties uses a primitive key map\n\nResult:\nLess garbage produced on Mqtt"}, "afterCommit": {"oid": "d5a1e71cdf30791ddfc0f4a2fe68b4cdec7810e0", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/d5a1e71cdf30791ddfc0f4a2fe68b4cdec7810e0", "committedDate": "2020-09-02T12:14:11Z", "message": "Reduce garbage on MQTT decodeMsbLsb\n\nMotivation:\n\nMqttDecoder was using a Result<Integer> on decodeMsbLsb\n\nModification:\n\nUse some bit-tricks to pack 2 ints into a single primitive long\nto store both result and  numberOfBytesConsumed\n\nResult:\nZero garbage produced on MQTT decodeMsbLsb"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d5a1e71cdf30791ddfc0f4a2fe68b4cdec7810e0", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/d5a1e71cdf30791ddfc0f4a2fe68b4cdec7810e0", "committedDate": "2020-09-02T12:14:11Z", "message": "Reduce garbage on MQTT decodeMsbLsb\n\nMotivation:\n\nMqttDecoder was using a Result<Integer> on decodeMsbLsb\n\nModification:\n\nUse some bit-tricks to pack 2 ints into a single primitive long\nto store both result and  numberOfBytesConsumed\n\nResult:\nZero garbage produced on MQTT decodeMsbLsb"}, "afterCommit": {"oid": "a900da1efcb64aa96f28a2f14e6595345064b795", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/a900da1efcb64aa96f28a2f14e6595345064b795", "committedDate": "2020-09-02T12:27:16Z", "message": "Reduce garbage on MQTT decodeMsbLsb and decodeVariableByteInteger\n\nMotivation:\n\nMqttDecoder was using a Result<Integer> on decodeMsbLsb and decodeVariableByteInteger\n\nModification:\n\nUse some bit-tricks to pack 2 ints into a single primitive long\nto store both result ad  numberOfBytesConsumed\n\nResult:\nZero garbage produced on MQTT decodeMsbLsb and decodeVariableByteInteger"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a900da1efcb64aa96f28a2f14e6595345064b795", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/a900da1efcb64aa96f28a2f14e6595345064b795", "committedDate": "2020-09-02T12:27:16Z", "message": "Reduce garbage on MQTT decodeMsbLsb and decodeVariableByteInteger\n\nMotivation:\n\nMqttDecoder was using a Result<Integer> on decodeMsbLsb and decodeVariableByteInteger\n\nModification:\n\nUse some bit-tricks to pack 2 ints into a single primitive long\nto store both result ad  numberOfBytesConsumed\n\nResult:\nZero garbage produced on MQTT decodeMsbLsb and decodeVariableByteInteger"}, "afterCommit": {"oid": "0bdd30eaec885fd885b670f2ce262ce115918188", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/0bdd30eaec885fd885b670f2ce262ce115918188", "committedDate": "2020-09-02T12:55:46Z", "message": "Reduce garbage on MQTT Integer decoding\n\nMotivation:\n\nMqttDecoder was using a Result<Integer>\n\nModification:\n\nUse some bit-tricks to pack 2 ints into a single primitive long\nto store both result and numberOfBytesConsumed\n\nResult:\nZero garbage produced while decoding Integers on MQTT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNzk3NTMx", "url": "https://github.com/netty/netty/pull/10509#pullrequestreview-480797531", "createdAt": "2020-09-02T13:04:58Z", "commit": {"oid": "0bdd30eaec885fd885b670f2ce262ce115918188"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMzowNDo1OFrOHLuIew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMzowNDo1OFrOHLuIew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA1MjIxOQ==", "bodyText": "seems that my codestyle IDEA Netty settings just apply to this forcibly", "url": "https://github.com/netty/netty/pull/10509#discussion_r482052219", "createdAt": "2020-09-02T13:04:58Z", "author": {"login": "franz1981"}, "path": "codec-mqtt/src/main/java/io/netty/handler/codec/mqtt/MqttDecoder.java", "diffHunk": "@@ -672,80 +679,80 @@ private static MqttFixedHeader decodeFixedHeader(ChannelHandlerContext ctx, Byte\n     }\n \n     private static Result<MqttProperties> decodeProperties(ByteBuf buffer) {\n-        final Result<Integer> propertiesLength = decodeVariableByteInteger(buffer);\n-        int totalPropertiesLength = propertiesLength.value;\n-        int numberOfBytesConsumed = propertiesLength.numberOfBytesConsumed;\n+        final long propertiesLength = decodeVariableByteInteger(buffer);\n+        int totalPropertiesLength = unpackA(propertiesLength);\n+        int numberOfBytesConsumed = unpackB(propertiesLength);\n \n         MqttProperties decodedProperties = new MqttProperties();\n         while (numberOfBytesConsumed < totalPropertiesLength) {\n-            Result<Integer> propertyId = decodeVariableByteInteger(buffer);\n-            numberOfBytesConsumed += propertyId.numberOfBytesConsumed;\n-\n-            MqttProperties.MqttPropertyType propertyType = MqttProperties.MqttPropertyType.valueOf(propertyId.value);\n+            long propertyId = decodeVariableByteInteger(buffer);\n+            final int propertyIdValue = unpackA(propertyId);\n+            numberOfBytesConsumed += unpackB(propertyId);\n+            MqttProperties.MqttPropertyType propertyType = MqttProperties.MqttPropertyType.valueOf(propertyIdValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bdd30eaec885fd885b670f2ce262ce115918188"}, "originalPosition": 525}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0bdd30eaec885fd885b670f2ce262ce115918188", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/0bdd30eaec885fd885b670f2ce262ce115918188", "committedDate": "2020-09-02T12:55:46Z", "message": "Reduce garbage on MQTT Integer decoding\n\nMotivation:\n\nMqttDecoder was using a Result<Integer>\n\nModification:\n\nUse some bit-tricks to pack 2 ints into a single primitive long\nto store both result and numberOfBytesConsumed\n\nResult:\nZero garbage produced while decoding Integers on MQTT"}, "afterCommit": {"oid": "c77d4f2f4fe727ab706637577176d34a9a37392c", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/c77d4f2f4fe727ab706637577176d34a9a37392c", "committedDate": "2020-09-02T13:28:56Z", "message": "Reduce garbage on MQTT decoding\n\nMotivation:\n\nMqttDecoder was using unecessary Result<T>\n\nModification:\n\nUse some bit-tricks to pack 2 ints into a single primitive long\nto store both result and numberOfBytesConsumed and\nuse byte[].length to compute numberOfByteConsumed on fly.\nThese changes allowed to save creating Result<T>.\n\nResult:\nZero additional garbage produced while decoding Integers and byte[] on MQTT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbe5f01d94f99bae0a3f1edcc7a4b2f17282664c", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/bbe5f01d94f99bae0a3f1edcc7a4b2f17282664c", "committedDate": "2020-09-02T13:43:46Z", "message": "Reduce garbage on MQTT decoding\n\nMotivation:\n\nMqttDecoder was using unecessary Result<T>\n\nModification:\n\nUse some bit-tricks to pack 2 ints into a single primitive long\nto store both result and numberOfBytesConsumed and\nuse byte[].length to compute numberOfByteConsumed on fly.\nThese changes allowed to save creating Result<T>.\n\nResult:\nZero additional garbage produced while decoding Integers and byte[] on MQTT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c77d4f2f4fe727ab706637577176d34a9a37392c", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/c77d4f2f4fe727ab706637577176d34a9a37392c", "committedDate": "2020-09-02T13:28:56Z", "message": "Reduce garbage on MQTT decoding\n\nMotivation:\n\nMqttDecoder was using unecessary Result<T>\n\nModification:\n\nUse some bit-tricks to pack 2 ints into a single primitive long\nto store both result and numberOfBytesConsumed and\nuse byte[].length to compute numberOfByteConsumed on fly.\nThese changes allowed to save creating Result<T>.\n\nResult:\nZero additional garbage produced while decoding Integers and byte[] on MQTT"}, "afterCommit": {"oid": "bbe5f01d94f99bae0a3f1edcc7a4b2f17282664c", "author": {"user": {"login": "franz1981", "name": "Francesco Nigro"}}, "url": "https://github.com/netty/netty/commit/bbe5f01d94f99bae0a3f1edcc7a4b2f17282664c", "committedDate": "2020-09-02T13:43:46Z", "message": "Reduce garbage on MQTT decoding\n\nMotivation:\n\nMqttDecoder was using unecessary Result<T>\n\nModification:\n\nUse some bit-tricks to pack 2 ints into a single primitive long\nto store both result and numberOfBytesConsumed and\nuse byte[].length to compute numberOfByteConsumed on fly.\nThese changes allowed to save creating Result<T>.\n\nResult:\nZero additional garbage produced while decoding Integers and byte[] on MQTT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNTEyMzkx", "url": "https://github.com/netty/netty/pull/10509#pullrequestreview-482512391", "createdAt": "2020-09-04T09:43:00Z", "commit": {"oid": "bbe5f01d94f99bae0a3f1edcc7a4b2f17282664c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNTY5Njc0", "url": "https://github.com/netty/netty/pull/10509#pullrequestreview-482569674", "createdAt": "2020-09-04T11:19:48Z", "commit": {"oid": "bbe5f01d94f99bae0a3f1edcc7a4b2f17282664c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4988, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}