{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3NjEwNzM0", "number": 10638, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzowNjo0NFrOEqTy9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDowMjowOVrOEqVRdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNzk5OTg5OnYy", "diffSide": "RIGHT", "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriteHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzowNjo0NFrOHccLBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzowNjo0NFrOHccLBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4Mzc1MQ==", "bodyText": "No need to explicitly initialise this to false.", "url": "https://github.com/netty/netty/pull/10638#discussion_r499583751", "createdAt": "2020-10-05T13:06:44Z", "author": {"login": "chrisvest"}, "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriteHandler.java", "diffHunk": "@@ -108,12 +112,18 @@\n      */\n     private InetSocketAddress dstAddr;\n \n+    /**\n+     * Set to {@code true} if {@link #close()} is called and we should stop writing Pcap.\n+     */\n+    private boolean isClosed = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODAwMTI4OnYy", "diffSide": "RIGHT", "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzowNzowN1rOHccL3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzowNzowN1rOHccL3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4Mzk2NQ==", "bodyText": "No need to explicitly initialise this to false.", "url": "https://github.com/netty/netty/pull/10638#discussion_r499583965", "createdAt": "2020-10-05T13:07:07Z", "author": {"login": "chrisvest"}, "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriter.java", "diffHunk": "@@ -29,6 +28,11 @@\n      */\n     private final OutputStream outputStream;\n \n+    /**\n+     * Set to {@code true} if {@link #outputStream} is closed.\n+     */\n+    private boolean isClosed = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODIwMjI2OnYy", "diffSide": "RIGHT", "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriteHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzo1MzoyMlrOHceH4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODoyMzozNVrOHcoprQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNTcxNA==", "bodyText": "What's the meaning of this comment? The handler is not closed, but we called close on the handler?", "url": "https://github.com/netty/netty/pull/10638#discussion_r499615714", "createdAt": "2020-10-05T13:53:22Z", "author": {"login": "chrisvest"}, "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriteHandler.java", "diffHunk": "@@ -517,7 +532,21 @@ public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws E\n             logger.debug(\"Sent Fake TCP RST to close connection\");\n         }\n \n-        this.pCapWriter.close();\n+        close();\n         ctx.fireExceptionCaught(cause);\n     }\n+\n+    /**\n+     * <p> Close {@code PcapWriter} and {@link OutputStream}. </p>\n+     * <p> Note: Calling this method does not close {@link PcapWriteHandler}.\n+     * Only Pcap Writes are closed. </p>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc4ODIwNQ==", "bodyText": "The close method closes OutputStream and PcapWriter so that, Pcap writes are stopped. The handler is not closed because we want data to still travel across.", "url": "https://github.com/netty/netty/pull/10638#discussion_r499788205", "createdAt": "2020-10-05T18:23:35Z", "author": {"login": "hyperxpro"}, "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriteHandler.java", "diffHunk": "@@ -517,7 +532,21 @@ public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws E\n             logger.debug(\"Sent Fake TCP RST to close connection\");\n         }\n \n-        this.pCapWriter.close();\n+        close();\n         ctx.fireExceptionCaught(cause);\n     }\n+\n+    /**\n+     * <p> Close {@code PcapWriter} and {@link OutputStream}. </p>\n+     * <p> Note: Calling this method does not close {@link PcapWriteHandler}.\n+     * Only Pcap Writes are closed. </p>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNTcxNA=="}, "originalCommit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODIwNTgyOnYy", "diffSide": "RIGHT", "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriteHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzo1NDoxMFrOHceJ9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzo1NDoxMFrOHceJ9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNjI0NQ==", "bodyText": "Should this method be idempotent, i.e. a no-op when isClosed is already true?", "url": "https://github.com/netty/netty/pull/10638#discussion_r499616245", "createdAt": "2020-10-05T13:54:10Z", "author": {"login": "chrisvest"}, "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriteHandler.java", "diffHunk": "@@ -517,7 +532,21 @@ public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws E\n             logger.debug(\"Sent Fake TCP RST to close connection\");\n         }\n \n-        this.pCapWriter.close();\n+        close();\n         ctx.fireExceptionCaught(cause);\n     }\n+\n+    /**\n+     * <p> Close {@code PcapWriter} and {@link OutputStream}. </p>\n+     * <p> Note: Calling this method does not close {@link PcapWriteHandler}.\n+     * Only Pcap Writes are closed. </p>\n+     *\n+     * @throws IOException If {@link OutputStream#close()} throws an exception\n+     */\n+    @Override\n+    public void close() throws IOException {\n+        isClosed = true;\n+        pCapWriter.close();\n+        logger.debug(\"PcapWriterHandler is Closed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9"}, "originalPosition": 121}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODIzNTc0OnYy", "diffSide": "RIGHT", "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDowMDo0OFrOHcecSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDowMDo0OFrOHcecSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYyMDkzNg==", "bodyText": "This method should ideally be idempotent, such that closing an already closed PcapWriter does nothing. Relying on the flush call on a closed OutputStream not throwing seems a bit shaky.", "url": "https://github.com/netty/netty/pull/10638#discussion_r499620936", "createdAt": "2020-10-05T14:00:48Z", "author": {"login": "chrisvest"}, "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriter.java", "diffHunk": "@@ -58,22 +62,25 @@\n      * @throws IOException If {@link OutputStream#write(byte[])} throws an exception\n      */\n     void writePacket(ByteBuf packetHeaderBuf, ByteBuf packet) throws IOException {\n-        long currentTime = System.currentTimeMillis();\n+        long timestamp = System.currentTimeMillis();\n \n         PcapHeaders.writePacketHeader(\n                 packetHeaderBuf,\n-                (int) TimeUnit.MILLISECONDS.toSeconds(currentTime),\n-                (int) TimeUnit.MILLISECONDS.toMicros(currentTime) % 1000000,\n+                (int) (timestamp / 1000L),\n+                (int) (timestamp % 1000L * 1000L),\n                 packet.readableBytes(),\n                 packet.readableBytes()\n         );\n \n-        packetHeaderBuf.readBytes(outputStream, packetHeaderBuf.readableBytes());\n-        packet.readBytes(outputStream, packet.readableBytes());\n+        if (!isClosed) {\n+            packetHeaderBuf.readBytes(outputStream, packetHeaderBuf.readableBytes());\n+            packet.readBytes(outputStream, packet.readableBytes());\n+        }\n     }\n \n     @Override\n     public void close() throws IOException {\n+        isClosed = true;\n         outputStream.flush();\n         outputStream.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODI0MTgyOnYy", "diffSide": "RIGHT", "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDowMjowOVrOHcef2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDowMjowOVrOHcef2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYyMTg0OQ==", "bodyText": "Would be better to hoist this condition to the start of the method and return early if the writer is closed, no?", "url": "https://github.com/netty/netty/pull/10638#discussion_r499621849", "createdAt": "2020-10-05T14:02:09Z", "author": {"login": "chrisvest"}, "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriter.java", "diffHunk": "@@ -58,22 +62,25 @@\n      * @throws IOException If {@link OutputStream#write(byte[])} throws an exception\n      */\n     void writePacket(ByteBuf packetHeaderBuf, ByteBuf packet) throws IOException {\n-        long currentTime = System.currentTimeMillis();\n+        long timestamp = System.currentTimeMillis();\n \n         PcapHeaders.writePacketHeader(\n                 packetHeaderBuf,\n-                (int) TimeUnit.MILLISECONDS.toSeconds(currentTime),\n-                (int) TimeUnit.MILLISECONDS.toMicros(currentTime) % 1000000,\n+                (int) (timestamp / 1000L),\n+                (int) (timestamp % 1000L * 1000L),\n                 packet.readableBytes(),\n                 packet.readableBytes()\n         );\n \n-        packetHeaderBuf.readBytes(outputStream, packetHeaderBuf.readableBytes());\n-        packet.readBytes(outputStream, packet.readableBytes());\n+        if (!isClosed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3583, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}