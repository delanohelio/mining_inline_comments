{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwODE2MjIy", "number": 9931, "title": "FlushConsolidationHandler may suppress flushes by mistake", "bodyText": "Motivation:\nWhen consolidatedWhenNoReadInProgress is true, channel.writeAndFlush (data) .addListener (f-> channel.writeAndFlush (data2)) Will cause data2 to never be flushed.\nBecause the flush operation will synchronously execute the channel.writeAndFlush (data2)) in the listener, and at this time, since the current execution thread is still an eventloop(executor.inEventLoop() was true), all handlers will be executed synchronously. At this time, since nextScheduledFlush is still not null, the flush operation of data2 will be ignored in FlushConsolidationHandler#scheduleFlush.\nModification:\n\nreset nextScheduledFlush before ctx.flush\nuse ObjectUtil to polish code\n\nResult:\nFixes #9923", "createdAt": "2020-01-09T07:37:18Z", "url": "https://github.com/netty/netty/pull/9931", "merged": true, "mergeCommit": {"oid": "2be3d888e73defb863ee460fc276a8959cb82604"}, "closed": true, "closedAt": "2020-01-09T13:51:12Z", "author": {"login": "carryxyh"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4k0n8gH2gAyMzYwODE2MjIyOmZhOGUwYjE0NzdkOTJiMDZhZjIxZmMwOWZmMjFlMzQ2MzI0OWExNmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4pNZrAH2gAyMzYwODE2MjIyOmIyNDQxYTA4NzEyOWVkNzM5ODViNTJkZGU2MDIzNDMyZWIxNzZlYTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fa8e0b1477d92b06af21fc09ff21e3463249a16b", "author": {"user": {"login": "carryxyh", "name": "\u65f6\u65e0\u4e24\u4e36"}}, "url": "https://github.com/netty/netty/commit/fa8e0b1477d92b06af21fc09ff21e3463249a16b", "committedDate": "2020-01-09T07:28:45Z", "message": "Fix resend problem."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "206efdfbbf9649df3341948b3a0a35d87bb3aeb6", "author": {"user": {"login": "carryxyh", "name": "\u65f6\u65e0\u4e24\u4e36"}}, "url": "https://github.com/netty/netty/commit/206efdfbbf9649df3341948b3a0a35d87bb3aeb6", "committedDate": "2020-01-09T08:10:43Z", "message": "Add unit test for resend problem."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMzQ2OTA2", "url": "https://github.com/netty/netty/pull/9931#pullrequestreview-340346906", "createdAt": "2020-01-09T08:16:38Z", "commit": {"oid": "206efdfbbf9649df3341948b3a0a35d87bb3aeb6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwODoxNjozOFrOFbttXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwODoxNjo1MlrOFbttrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDYwNDc2NA==", "bodyText": "nit: assertFalse(channel.finish);", "url": "https://github.com/netty/netty/pull/9931#discussion_r364604764", "createdAt": "2020-01-09T08:16:38Z", "author": {"login": "normanmaurer"}, "path": "handler/src/test/java/io/netty/handler/flush/FlushConsolidationHandlerTest.java", "diffHunk": "@@ -152,6 +154,31 @@ public void testFlushViaRemoval() {\n         assertFalse(channel.finish());\n     }\n \n+    /**\n+     * See https://github.com/netty/netty/issues/9923\n+     */\n+    @Test\n+    public void testResend() throws Exception {\n+\n+        final AtomicInteger flushCount = new AtomicInteger();\n+        final EmbeddedChannel channel = newChannel(flushCount, true);\n+\n+        channel.writeAndFlush(1L).addListener(new GenericFutureListener<Future<? super Void>>() {\n+            @Override\n+            public void operationComplete(Future<? super Void> future) throws Exception {\n+                channel.writeAndFlush(1L);\n+            }\n+        });\n+\n+        channel.flushOutbound();\n+\n+        assertEquals(1L, channel.readOutbound());\n+        assertEquals(1L, channel.readOutbound());\n+        assertNull(channel.readOutbound());\n+\n+        channel.finish();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "206efdfbbf9649df3341948b3a0a35d87bb3aeb6"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDYwNDg0Nw==", "bodyText": "nit: remove empty line", "url": "https://github.com/netty/netty/pull/9931#discussion_r364604847", "createdAt": "2020-01-09T08:16:52Z", "author": {"login": "normanmaurer"}, "path": "handler/src/test/java/io/netty/handler/flush/FlushConsolidationHandlerTest.java", "diffHunk": "@@ -152,6 +154,31 @@ public void testFlushViaRemoval() {\n         assertFalse(channel.finish());\n     }\n \n+    /**\n+     * See https://github.com/netty/netty/issues/9923\n+     */\n+    @Test\n+    public void testResend() throws Exception {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "206efdfbbf9649df3341948b3a0a35d87bb3aeb6"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "800140a909d6b1e6d0adcfda2395e110a8c8de01", "author": {"user": {"login": "carryxyh", "name": "\u65f6\u65e0\u4e24\u4e36"}}, "url": "https://github.com/netty/netty/commit/800140a909d6b1e6d0adcfda2395e110a8c8de01", "committedDate": "2020-01-09T08:20:14Z", "message": "polish unit test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2441a087129ed73985b52dde6023432eb176ea4", "author": {"user": {"login": "carryxyh", "name": "\u65f6\u65e0\u4e24\u4e36"}}, "url": "https://github.com/netty/netty/commit/b2441a087129ed73985b52dde6023432eb176ea4", "committedDate": "2020-01-09T12:35:26Z", "message": "fix checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 419, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}