{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NzQyMTQx", "number": 10270, "title": "Fix a potential fd leak in AbstractDiskHttpData.getChunk", "bodyText": "Motivation:\nFileChannel.read() may throw an IOException. We must deal with this in case of the occurrence of I/O error.\nModification:\nPlace the FileChannel.read() method call in the try-finally block.\nResult:\nAdvoid fd leak.", "createdAt": "2020-05-10T16:03:32Z", "url": "https://github.com/netty/netty/pull/10270", "merged": true, "mergeCommit": {"oid": "2183b37892851dc5d993652a3b9d88f11015366d"}, "closed": true, "closedAt": "2020-05-14T08:16:17Z", "author": {"login": "prgitpr"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcf8UzvAH2gAyNDE1NzQyMTQxOjM2YzMxODgxZDc2MTBlYTFlZTY2OTM4OTU3NWQxNGY2NWU2ZTk0Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcg0SgQAFqTQxMDY4Mzk2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "36c31881d7610ea1ee669389575d14f65e6e9438", "author": {"user": null}, "url": "https://github.com/netty/netty/commit/36c31881d7610ea1ee669389575d14f65e6e9438", "committedDate": "2020-05-10T14:54:46Z", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f33aae8e0fb8120757da601874d4403bea3c7e46", "author": {"user": null}, "url": "https://github.com/netty/netty/commit/f33aae8e0fb8120757da601874d4403bea3c7e46", "committedDate": "2020-05-10T16:05:50Z", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NzU5NzUy", "url": "https://github.com/netty/netty/pull/10270#pullrequestreview-408759752", "createdAt": "2020-05-10T16:19:25Z", "commit": {"oid": "36c31881d7610ea1ee669389575d14f65e6e9438"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQxNjoxOToyNlrOGTFgvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQxNjoxOToyNlrOGTFgvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY2NjQzMA==", "bodyText": "Should this try finally better englobing the while loop? Because there, the read operation will be only valid once, then failed since it will be closed from the very first iteration...", "url": "https://github.com/netty/netty/pull/10270#discussion_r422666430", "createdAt": "2020-05-10T16:19:26Z", "author": {"login": "fredericBregier"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/AbstractDiskHttpData.java", "diffHunk": "@@ -301,7 +301,15 @@ public ByteBuf getChunk(int length) throws IOException {\n         int read = 0;\n         ByteBuffer byteBuffer = ByteBuffer.allocate(length);\n         while (read < length) {\n-            int readnow = fileChannel.read(byteBuffer);\n+            int readnow=-1;\n+            try {\n+                readnow = fileChannel.read(byteBuffer);\n+            }catch (IOException e){\n+                logger.warn(\"Failed to read a file.\", e);\n+            }\n+            finally {\n+                fileChannel.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36c31881d7610ea1ee669389575d14f65e6e9438"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ef4aedc8b6f798ddbae0e921036cd91a84a2c8a", "author": {"user": null}, "url": "https://github.com/netty/netty/commit/8ef4aedc8b6f798ddbae0e921036cd91a84a2c8a", "committedDate": "2020-05-11T00:57:44Z", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6e798efb15f957bfc82858a74e97052fc1fee33", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/c6e798efb15f957bfc82858a74e97052fc1fee33", "committedDate": "2020-05-11T07:02:44Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4OTA4NDEy", "url": "https://github.com/netty/netty/pull/10270#pullrequestreview-408908412", "createdAt": "2020-05-11T07:03:19Z", "commit": {"oid": "c6e798efb15f957bfc82858a74e97052fc1fee33"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwNzowMzoxOVrOGTPJTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwNzowMzoxOVrOGTPJTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgyNDI2OQ==", "bodyText": "this will throw a NPE if readnow == -1 is true. you will need to add a null check here", "url": "https://github.com/netty/netty/pull/10270#discussion_r422824269", "createdAt": "2020-05-11T07:03:19Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/AbstractDiskHttpData.java", "diffHunk": "@@ -300,15 +300,19 @@ public ByteBuf getChunk(int length) throws IOException {\n         }\n         int read = 0;\n         ByteBuffer byteBuffer = ByteBuffer.allocate(length);\n-        while (read < length) {\n-            int readnow = fileChannel.read(byteBuffer);\n-            if (readnow == -1) {\n-                fileChannel.close();\n-                fileChannel = null;\n-                break;\n-            } else {\n-                read += readnow;\n+        try {\n+            while (read < length) {\n+                int readnow = fileChannel.read(byteBuffer);\n+                if (readnow == -1) {\n+                    fileChannel.close();\n+                    fileChannel = null;\n+                    break;\n+                } else {\n+                    read += readnow;\n+                }\n             }\n+        } finally {\n+            fileChannel.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6e798efb15f957bfc82858a74e97052fc1fee33"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2628d644e01196594dbc36884c903c135998e950", "author": {"user": null}, "url": "https://github.com/netty/netty/commit/2628d644e01196594dbc36884c903c135998e950", "committedDate": "2020-05-11T14:35:03Z", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4OTk1MDcw", "url": "https://github.com/netty/netty/pull/10270#pullrequestreview-408995070", "createdAt": "2020-05-11T09:10:41Z", "commit": {"oid": "c6e798efb15f957bfc82858a74e97052fc1fee33"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwOToxMDo0MVrOGTTkIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNDo1Njo1MVrOGTgDVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg5NjY3NQ==", "bodyText": "@prgitpr I agree with @normanmaurer\nPerhaps removing the lines 307 and 308 (closing and setting to null fileChannel) but keeping the break is one way to go, moving the setting to null just after the close in the finally part (so moving all close and set to null in the finally)?", "url": "https://github.com/netty/netty/pull/10270#discussion_r422896675", "createdAt": "2020-05-11T09:10:41Z", "author": {"login": "fredericBregier"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/AbstractDiskHttpData.java", "diffHunk": "@@ -300,15 +300,19 @@ public ByteBuf getChunk(int length) throws IOException {\n         }\n         int read = 0;\n         ByteBuffer byteBuffer = ByteBuffer.allocate(length);\n-        while (read < length) {\n-            int readnow = fileChannel.read(byteBuffer);\n-            if (readnow == -1) {\n-                fileChannel.close();\n-                fileChannel = null;\n-                break;\n-            } else {\n-                read += readnow;\n+        try {\n+            while (read < length) {\n+                int readnow = fileChannel.read(byteBuffer);\n+                if (readnow == -1) {\n+                    fileChannel.close();\n+                    fileChannel = null;\n+                    break;\n+                } else {\n+                    read += readnow;\n+                }\n             }\n+        } finally {\n+            fileChannel.close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgyNDI2OQ=="}, "originalCommit": {"oid": "c6e798efb15f957bfc82858a74e97052fc1fee33"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwMTI3MA==", "bodyText": "What about this version? Interest: no close within the loop, setting to null in finally (no check needed)\n    try {\n        while (read < length) {\n            int readnow = fileChannel.read(byteBuffer);\n            if (readnow == -1) {\n                break;\n            }\n            read += readnow;\n        }\n    } finally {\n        fileChannel.close();\n        fileChannel = null;\n    }", "url": "https://github.com/netty/netty/pull/10270#discussion_r423101270", "createdAt": "2020-05-11T14:56:51Z", "author": {"login": "fredericBregier"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/AbstractDiskHttpData.java", "diffHunk": "@@ -300,14 +300,20 @@ public ByteBuf getChunk(int length) throws IOException {\n         }\n         int read = 0;\n         ByteBuffer byteBuffer = ByteBuffer.allocate(length);\n-        while (read < length) {\n-            int readnow = fileChannel.read(byteBuffer);\n-            if (readnow == -1) {\n+        try {\n+            while (read < length) {\n+                int readnow = fileChannel.read(byteBuffer);\n+                if (readnow == -1) {\n+                    fileChannel.close();\n+                    fileChannel = null;\n+                    break;\n+                } else {\n+                    read += readnow;\n+                }\n+            }\n+        } finally {\n+            if (fileChannel != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2628d644e01196594dbc36884c903c135998e950"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a858f0c6e30aeed93b347fcaeae876787433f810", "author": {"user": null}, "url": "https://github.com/netty/netty/commit/a858f0c6e30aeed93b347fcaeae876787433f810", "committedDate": "2020-05-11T15:09:27Z", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d412193fccfd2d12c97a07a996da76ba41defa11", "author": {"user": null}, "url": "https://github.com/netty/netty/commit/d412193fccfd2d12c97a07a996da76ba41defa11", "committedDate": "2020-05-12T01:40:19Z", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MjYxNDE2", "url": "https://github.com/netty/netty/pull/10270#pullrequestreview-409261416", "createdAt": "2020-05-11T15:05:42Z", "commit": {"oid": "2628d644e01196594dbc36884c903c135998e950"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNTowNTo0MlrOGTgdTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNTowNTo0MlrOGTgdTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwNzkxNg==", "bodyText": "yes, it look much clean", "url": "https://github.com/netty/netty/pull/10270#discussion_r423107916", "createdAt": "2020-05-11T15:05:42Z", "author": {"login": "prgitpr"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/AbstractDiskHttpData.java", "diffHunk": "@@ -300,14 +300,20 @@ public ByteBuf getChunk(int length) throws IOException {\n         }\n         int read = 0;\n         ByteBuffer byteBuffer = ByteBuffer.allocate(length);\n-        while (read < length) {\n-            int readnow = fileChannel.read(byteBuffer);\n-            if (readnow == -1) {\n+        try {\n+            while (read < length) {\n+                int readnow = fileChannel.read(byteBuffer);\n+                if (readnow == -1) {\n+                    fileChannel.close();\n+                    fileChannel = null;\n+                    break;\n+                } else {\n+                    read += readnow;\n+                }\n+            }\n+        } finally {\n+            if (fileChannel != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwMTI3MA=="}, "originalCommit": {"oid": "2628d644e01196594dbc36884c903c135998e950"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NzQ2MjI2", "url": "https://github.com/netty/netty/pull/10270#pullrequestreview-409746226", "createdAt": "2020-05-12T06:53:02Z", "commit": {"oid": "d412193fccfd2d12c97a07a996da76ba41defa11"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNjo1MzowMlrOGT4c-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNjo1MzowMlrOGT4c-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwMTA1MA==", "bodyText": "just remove the above two lines as you already call close in the finally block anyway.", "url": "https://github.com/netty/netty/pull/10270#discussion_r423501050", "createdAt": "2020-05-12T06:53:02Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/AbstractDiskHttpData.java", "diffHunk": "@@ -300,14 +300,20 @@ public ByteBuf getChunk(int length) throws IOException {\n         }\n         int read = 0;\n         ByteBuffer byteBuffer = ByteBuffer.allocate(length);\n-        while (read < length) {\n-            int readnow = fileChannel.read(byteBuffer);\n-            if (readnow == -1) {\n+        try {\n+            while (read < length) {\n+                int readnow = fileChannel.read(byteBuffer);\n+                if (readnow == -1) {\n+                    fileChannel.close();\n+                    fileChannel = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d412193fccfd2d12c97a07a996da76ba41defa11"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63dbfdf7caab19a1d48297596d76b6a3f37bbba9", "author": {"user": null}, "url": "https://github.com/netty/netty/commit/63dbfdf7caab19a1d48297596d76b6a3f37bbba9", "committedDate": "2020-05-12T07:26:10Z", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5Nzk4MzE4", "url": "https://github.com/netty/netty/pull/10270#pullrequestreview-409798318", "createdAt": "2020-05-12T08:08:49Z", "commit": {"oid": "63dbfdf7caab19a1d48297596d76b6a3f37bbba9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwODowODo1MFrOGT6_Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwODowODo1MFrOGT6_Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU0MjU2Nw==", "bodyText": "Previously, there was a fileChannel = null; after closing it. I believe that we still need it to be consistent in the finally part.", "url": "https://github.com/netty/netty/pull/10270#discussion_r423542567", "createdAt": "2020-05-12T08:08:50Z", "author": {"login": "fredericBregier"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/AbstractDiskHttpData.java", "diffHunk": "@@ -300,15 +300,17 @@ public ByteBuf getChunk(int length) throws IOException {\n         }\n         int read = 0;\n         ByteBuffer byteBuffer = ByteBuffer.allocate(length);\n-        while (read < length) {\n-            int readnow = fileChannel.read(byteBuffer);\n-            if (readnow == -1) {\n-                fileChannel.close();\n-                fileChannel = null;\n-                break;\n-            } else {\n-                read += readnow;\n+        try {\n+            while (read < length) {\n+                int readnow = fileChannel.read(byteBuffer);\n+                if (readnow == -1) {\n+                    break;\n+                } else {\n+                    read += readnow;\n+                }\n             }\n+        } finally {\n+                fileChannel.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63dbfdf7caab19a1d48297596d76b6a3f37bbba9"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19a61e48ee970fbe809f2af0c6f201355d8e9841", "author": {"user": null}, "url": "https://github.com/netty/netty/commit/19a61e48ee970fbe809f2af0c6f201355d8e9841", "committedDate": "2020-05-12T23:57:42Z", "message": "\"Add try catch on fileChannel.read in AbstractDiskHttpData.getChunk\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "056945f6afcd2dc24fd565ae3972a6d9c83aad8b", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/056945f6afcd2dc24fd565ae3972a6d9c83aad8b", "committedDate": "2020-05-13T06:40:55Z", "message": "Fix whitespaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91e75a85342604229f8b7e5888ec76213280a431", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/91e75a85342604229f8b7e5888ec76213280a431", "committedDate": "2020-05-13T06:41:55Z", "message": "Remove else"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNjgzOTY1", "url": "https://github.com/netty/netty/pull/10270#pullrequestreview-410683965", "createdAt": "2020-05-13T08:06:56Z", "commit": {"oid": "91e75a85342604229f8b7e5888ec76213280a431"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 302, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}