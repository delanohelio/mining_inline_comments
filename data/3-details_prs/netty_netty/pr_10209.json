{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NDAyMjg2", "number": 10209, "title": "HttpPostRequestDecoder: retain instead of copy when first buf is last", "bodyText": "Motivations\nThere is no need to copy the \"offered\" ByteBuf in HttpPostRequestDecoder\nwhen the first HttpContent ByteBuf is also the last (LastHttpContent) as\nthe full content can immediately be decoded. No extra bookeeping needed.\nModifications\nIn HttpPost(Standard|Multipart)RequestDecoder:\n\nRetain the first ByteBuf when it is both the first HttpContent and last (LastHttpContent)\noffered to the decoder.\nRetain slices of the final buffers values\nFor non-multi-part content, URL decoding of Attributes' content ByteBuf no longer creates\na ByteBuf when there is nothing to decode. When decoding is necessary, a ByteBuf is created\nusing the allocator of the HttpContent's ByteBuf.\n\nResults\nByteBufs of FullHttpMessage decoded by HttpPostRequestDecoder are no longer\nunnecessarily copied. Attributes are extracted as retained slices. When URL decoding\nis necessary, the new ByteBuf is created using the allocator of the HttpContent's ByteBuf.\nPartially addresses issue #10200", "createdAt": "2020-04-24T08:19:04Z", "url": "https://github.com/netty/netty/pull/10209", "merged": true, "mergeCommit": {"oid": "c354fa48e10de847cf17c10083a2cbc2c0a63a36"}, "closed": true, "closedAt": "2020-04-28T07:43:06Z", "author": {"login": "fabienrenaud"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcatIUwAFqTM5OTczODYwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbzVZZAFqTQwMTIwMjczNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NzM4NjA4", "url": "https://github.com/netty/netty/pull/10209#pullrequestreview-399738608", "createdAt": "2020-04-24T08:22:22Z", "commit": {"oid": "7760d9b1e0db6c99e44fd146883dfcb7b8419205"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwODoyMjoyMlrOGLMSxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwODoyMjoyMlrOGLMSxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM4ODkzMg==", "bodyText": "@fabienrenaud let's use buf.retainedSlice()", "url": "https://github.com/netty/netty/pull/10209#discussion_r414388932", "createdAt": "2020-04-24T08:22:22Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostMultipartRequestDecoder.java", "diffHunk": "@@ -321,18 +321,19 @@ public InterfaceHttpData getBodyHttpData(String name) {\n     public HttpPostMultipartRequestDecoder offer(HttpContent content) {\n         checkDestroyed();\n \n+        if (content instanceof LastHttpContent) {\n+            isLastChunk = true;\n+        }\n+\n+        ByteBuf buf = content.content();\n         // Maybe we should better not copy here for performance reasons but this will need\n         // more care by the caller to release the content in a correct manner later\n         // So maybe something to optimize on a later stage\n-        ByteBuf buf = content.content();\n         if (undecodedChunk == null) {\n-            undecodedChunk = buf.copy();\n+            undecodedChunk = isLastChunk ? buf.retain() : buf.copy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7760d9b1e0db6c99e44fd146883dfcb7b8419205"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7760d9b1e0db6c99e44fd146883dfcb7b8419205", "author": {"user": {"login": "fabienrenaud", "name": "Fabien Renaud"}}, "url": "https://github.com/netty/netty/commit/7760d9b1e0db6c99e44fd146883dfcb7b8419205", "committedDate": "2020-04-24T08:17:40Z", "message": "HttpPostRequestDecoder: retain instead of copy when first buf is last\n\nMotivations\n-----------\nThere is no need to copy the \"offered\" ByteBuf in HttpPostRequestDecoder\nwhen the first HttpContent ByteBuf is also the last (LastHttpContent) as\nthe full content can immediately be decoded. No extra bookeeping needed.\n\nModifications\n-------------\nHttpPostMultipartRequestDecoder\n - Retain the first ByteBuf when it is both the first HttpContent offered\nto the decoder and is also LastHttpContent.\n - Retain slices of the final buffers values\n\nResults\n-------\nByteBufs of FullHttpMessage decoded by HttpPostRequestDecoder are no longer\nunnecessarily copied. Attributes are extracted as retained slices when\nthe content is multi-part. Non-multi-part content continues to return\nUnpooled buffers.\n\nPartially addresses issue #10200"}, "afterCommit": {"oid": "837f8ed8a4bfc52bf645526b346da0004e092e47", "author": {"user": {"login": "fabienrenaud", "name": "Fabien Renaud"}}, "url": "https://github.com/netty/netty/commit/837f8ed8a4bfc52bf645526b346da0004e092e47", "committedDate": "2020-04-24T08:33:08Z", "message": "HttpPostRequestDecoder: retain instead of copy when first buf is last\n\nMotivations\n-----------\nThere is no need to copy the \"offered\" ByteBuf in HttpPostRequestDecoder\nwhen the first HttpContent ByteBuf is also the last (LastHttpContent) as\nthe full content can immediately be decoded. No extra bookeeping needed.\n\nModifications\n-------------\nHttpPostMultipartRequestDecoder\n - Retain the first ByteBuf when it is both the first HttpContent offered\nto the decoder and is also LastHttpContent.\n - Retain slices of the final buffers values\n\nResults\n-------\nByteBufs of FullHttpMessage decoded by HttpPostRequestDecoder are no longer\nunnecessarily copied. Attributes are extracted as retained slices when\nthe content is multi-part. Non-multi-part content continues to return\nUnpooled buffers.\n\nPartially addresses issue #10200"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODA4Njk5", "url": "https://github.com/netty/netty/pull/10209#pullrequestreview-399808699", "createdAt": "2020-04-24T10:00:20Z", "commit": {"oid": "837f8ed8a4bfc52bf645526b346da0004e092e47"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDowMDoyMVrOGLQKYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDowMDozMVrOGLQK3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1MjMyMg==", "bodyText": "@fabienrenaud Can you add a comment that its only fine to not copy here as we will never call undecodedChunk.writeBytes(...) later on ?", "url": "https://github.com/netty/netty/pull/10209#discussion_r414452322", "createdAt": "2020-04-24T10:00:21Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostMultipartRequestDecoder.java", "diffHunk": "@@ -321,18 +321,19 @@ public InterfaceHttpData getBodyHttpData(String name) {\n     public HttpPostMultipartRequestDecoder offer(HttpContent content) {\n         checkDestroyed();\n \n+        if (content instanceof LastHttpContent) {\n+            isLastChunk = true;\n+        }\n+\n+        ByteBuf buf = content.content();\n         // Maybe we should better not copy here for performance reasons but this will need\n         // more care by the caller to release the content in a correct manner later\n         // So maybe something to optimize on a later stage\n-        ByteBuf buf = content.content();\n         if (undecodedChunk == null) {\n-            undecodedChunk = buf.copy();\n+            undecodedChunk = isLastChunk ? buf.retainedSlice() : buf.copy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "837f8ed8a4bfc52bf645526b346da0004e092e47"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1MjQ0Nw==", "bodyText": "same comment as above", "url": "https://github.com/netty/netty/pull/10209#discussion_r414452447", "createdAt": "2020-04-24T10:00:31Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostStandardRequestDecoder.java", "diffHunk": "@@ -280,18 +280,19 @@ public InterfaceHttpData getBodyHttpData(String name) {\n     public HttpPostStandardRequestDecoder offer(HttpContent content) {\n         checkDestroyed();\n \n+        if (content instanceof LastHttpContent) {\n+            isLastChunk = true;\n+        }\n+\n+        ByteBuf buf = content.content();\n         // Maybe we should better not copy here for performance reasons but this will need\n         // more care by the caller to release the content in a correct manner later\n         // So maybe something to optimize on a later stage\n-        ByteBuf buf = content.content();\n         if (undecodedChunk == null) {\n-            undecodedChunk = buf.copy();\n+            undecodedChunk = isLastChunk ? buf.retainedSlice() : buf.copy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "837f8ed8a4bfc52bf645526b346da0004e092e47"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "837f8ed8a4bfc52bf645526b346da0004e092e47", "author": {"user": {"login": "fabienrenaud", "name": "Fabien Renaud"}}, "url": "https://github.com/netty/netty/commit/837f8ed8a4bfc52bf645526b346da0004e092e47", "committedDate": "2020-04-24T08:33:08Z", "message": "HttpPostRequestDecoder: retain instead of copy when first buf is last\n\nMotivations\n-----------\nThere is no need to copy the \"offered\" ByteBuf in HttpPostRequestDecoder\nwhen the first HttpContent ByteBuf is also the last (LastHttpContent) as\nthe full content can immediately be decoded. No extra bookeeping needed.\n\nModifications\n-------------\nHttpPostMultipartRequestDecoder\n - Retain the first ByteBuf when it is both the first HttpContent offered\nto the decoder and is also LastHttpContent.\n - Retain slices of the final buffers values\n\nResults\n-------\nByteBufs of FullHttpMessage decoded by HttpPostRequestDecoder are no longer\nunnecessarily copied. Attributes are extracted as retained slices when\nthe content is multi-part. Non-multi-part content continues to return\nUnpooled buffers.\n\nPartially addresses issue #10200"}, "afterCommit": {"oid": "a59f1ebfae2e994efe4857518db6e6fd82a3cbd8", "author": {"user": {"login": "fabienrenaud", "name": "Fabien Renaud"}}, "url": "https://github.com/netty/netty/commit/a59f1ebfae2e994efe4857518db6e6fd82a3cbd8", "committedDate": "2020-04-24T14:10:25Z", "message": "HttpPostRequestDecoder: retain instead of copy when first buf is last\n\nMotivations\n-----------\nThere is no need to copy the \"offered\" ByteBuf in HttpPostRequestDecoder\nwhen the first HttpContent ByteBuf is also the last (LastHttpContent) as\nthe full content can immediately be decoded. No extra bookeeping needed.\n\nModifications\n-------------\nHttpPostMultipartRequestDecoder\n - Retain the first ByteBuf when it is both the first HttpContent offered\nto the decoder and is also LastHttpContent.\n - Retain slices of the final buffers values\n\nResults\n-------\nByteBufs of FullHttpMessage decoded by HttpPostRequestDecoder are no longer\nunnecessarily copied. Attributes are extracted as retained slices when\nthe content is multi-part. Non-multi-part content continues to return\nUnpooled buffers.\n\nPartially addresses issue #10200"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1b12d8aa652b0e12ff4be6576164968a066055d5", "author": {"user": {"login": "fabienrenaud", "name": "Fabien Renaud"}}, "url": "https://github.com/netty/netty/commit/1b12d8aa652b0e12ff4be6576164968a066055d5", "committedDate": "2020-04-25T18:30:11Z", "message": "HttpPostStandardRequestDecoder: custom URL decoder to minimize ByteBuf copies"}, "afterCommit": {"oid": "80ffc5d139675d6c36282cd5ef8345281550fbf1", "author": {"user": {"login": "fabienrenaud", "name": "Fabien Renaud"}}, "url": "https://github.com/netty/netty/commit/80ffc5d139675d6c36282cd5ef8345281550fbf1", "committedDate": "2020-04-25T18:42:40Z", "message": "HttpPostStandardRequestDecoder: custom URL decoder to minimize ByteBuf copies"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNjI4Nzkx", "url": "https://github.com/netty/netty/pull/10209#pullrequestreview-400628791", "createdAt": "2020-04-27T05:06:24Z", "commit": {"oid": "80ffc5d139675d6c36282cd5ef8345281550fbf1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80ffc5d139675d6c36282cd5ef8345281550fbf1", "author": {"user": {"login": "fabienrenaud", "name": "Fabien Renaud"}}, "url": "https://github.com/netty/netty/commit/80ffc5d139675d6c36282cd5ef8345281550fbf1", "committedDate": "2020-04-25T18:42:40Z", "message": "HttpPostStandardRequestDecoder: custom URL decoder to minimize ByteBuf copies"}, "afterCommit": {"oid": "420069ff3d6d26e5f6282bb184bd05dac74643e9", "author": {"user": {"login": "fabienrenaud", "name": "Fabien Renaud"}}, "url": "https://github.com/netty/netty/commit/420069ff3d6d26e5f6282bb184bd05dac74643e9", "committedDate": "2020-04-27T16:23:43Z", "message": "HttpPostStandardRequestDecoder: custom URL decoder to minimize ByteBuf copies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6d8dc1dfac627dddb3b13577865de40f5dc00a2", "author": {"user": {"login": "fabienrenaud", "name": "Fabien Renaud"}}, "url": "https://github.com/netty/netty/commit/a6d8dc1dfac627dddb3b13577865de40f5dc00a2", "committedDate": "2020-04-27T17:00:16Z", "message": "HttpPostRequestDecoder: retain instead of copy when first buf is last\n\nMotivations\n-----------\nThere is no need to copy the \"offered\" ByteBuf in HttpPostRequestDecoder\nwhen the first HttpContent ByteBuf is also the last (LastHttpContent) as\nthe full content can immediately be decoded. No extra bookeeping needed.\n\nModifications\n-------------\nHttpPostMultipartRequestDecoder\n - Retain the first ByteBuf when it is both the first HttpContent offered\nto the decoder and is also LastHttpContent.\n - Retain slices of the final buffers values\n\nResults\n-------\nByteBufs of FullHttpMessage decoded by HttpPostRequestDecoder are no longer\nunnecessarily copied. Attributes are extracted as retained slices when\nthe content is multi-part. Non-multi-part content continues to return\nUnpooled buffers.\n\nPartially addresses issue #10200"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33c742305af8643612f93ec48c1f80580dc5ebd7", "author": {"user": {"login": "fabienrenaud", "name": "Fabien Renaud"}}, "url": "https://github.com/netty/netty/commit/33c742305af8643612f93ec48c1f80580dc5ebd7", "committedDate": "2020-04-27T17:00:16Z", "message": "HttpPostStandardRequestDecoder: custom URL decoder to minimize ByteBuf copies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "420069ff3d6d26e5f6282bb184bd05dac74643e9", "author": {"user": {"login": "fabienrenaud", "name": "Fabien Renaud"}}, "url": "https://github.com/netty/netty/commit/420069ff3d6d26e5f6282bb184bd05dac74643e9", "committedDate": "2020-04-27T16:23:43Z", "message": "HttpPostStandardRequestDecoder: custom URL decoder to minimize ByteBuf copies"}, "afterCommit": {"oid": "33c742305af8643612f93ec48c1f80580dc5ebd7", "author": {"user": {"login": "fabienrenaud", "name": "Fabien Renaud"}}, "url": "https://github.com/netty/netty/commit/33c742305af8643612f93ec48c1f80580dc5ebd7", "committedDate": "2020-04-27T17:00:16Z", "message": "HttpPostStandardRequestDecoder: custom URL decoder to minimize ByteBuf copies"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMjAyNzM1", "url": "https://github.com/netty/netty/pull/10209#pullrequestreview-401202735", "createdAt": "2020-04-27T18:10:33Z", "commit": {"oid": "33c742305af8643612f93ec48c1f80580dc5ebd7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODoxMDozM1rOGMw7RQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODoxMDozM1rOGMw7RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAzNzcwMQ==", "bodyText": "@fabienrenaud why this change ?", "url": "https://github.com/netty/netty/pull/10209#discussion_r416037701", "createdAt": "2020-04-27T18:10:33Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/HttpPostRequestDecoderTest.java", "diffHunk": "@@ -747,7 +769,7 @@ public void testNotLeakHeapBufferWhenWrapIllegalArgumentException() {\n     }\n \n     private static void testNotLeakWhenWrapIllegalArgumentException(ByteBuf buf) {\n-        buf.writeCharSequence(\"==\", CharsetUtil.US_ASCII);\n+        buf.writeCharSequence(\"a=b&foo=%22bar%22&==\", CharsetUtil.US_ASCII);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33c742305af8643612f93ec48c1f80580dc5ebd7"}, "originalPosition": 459}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 258, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}