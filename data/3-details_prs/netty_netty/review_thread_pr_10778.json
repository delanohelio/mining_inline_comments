{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2NTU1ODUy", "number": 10778, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODoxMTo0NFrOE1_A9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNTowNTo1MVrOE_qbaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MDQyNDIyOnYy", "diffSide": "RIGHT", "path": "microbench/src/main/java/io/netty/microbench/stomp/StompEncoderBenchmark.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODoxMTo0NFrOHuj6qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODozNToyMVrOHukoOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU4NTAwMg==", "bodyText": "Fork should be at least 2 for dev purposes but way more for regressions benchs", "url": "https://github.com/netty/netty/pull/10778#discussion_r518585002", "createdAt": "2020-11-06T08:11:44Z", "author": {"login": "franz1981"}, "path": "microbench/src/main/java/io/netty/microbench/stomp/StompEncoderBenchmark.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.microbench.stomp;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.PooledByteBufAllocator;\n+import io.netty.buffer.Unpooled;\n+import io.netty.buffer.UnpooledByteBufAllocator;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelPromise;\n+import io.netty.handler.codec.stomp.DefaultStompFrame;\n+import io.netty.handler.codec.stomp.StompFrame;\n+import io.netty.handler.codec.stomp.StompHeadersSubframe;\n+import io.netty.handler.codec.stomp.StompSubframeEncoder;\n+import io.netty.microbench.channel.EmbeddedChannelWriteReleaseHandlerContext;\n+import io.netty.microbench.util.AbstractMicrobenchmark;\n+import io.netty.util.internal.ThreadLocalRandom;\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.Fork;\n+import org.openjdk.jmh.annotations.Level;\n+import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Param;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+import org.openjdk.jmh.annotations.TearDown;\n+import org.openjdk.jmh.annotations.Threads;\n+import org.openjdk.jmh.annotations.Warmup;\n+\n+@State(Scope.Benchmark)\n+@Fork(1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd9ff3a681563343e4e2d92986bf39e358d0effd"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU5NjY2Ng==", "bodyText": "Thx", "url": "https://github.com/netty/netty/pull/10778#discussion_r518596666", "createdAt": "2020-11-06T08:35:21Z", "author": {"login": "amizurov"}, "path": "microbench/src/main/java/io/netty/microbench/stomp/StompEncoderBenchmark.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.microbench.stomp;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.PooledByteBufAllocator;\n+import io.netty.buffer.Unpooled;\n+import io.netty.buffer.UnpooledByteBufAllocator;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelPromise;\n+import io.netty.handler.codec.stomp.DefaultStompFrame;\n+import io.netty.handler.codec.stomp.StompFrame;\n+import io.netty.handler.codec.stomp.StompHeadersSubframe;\n+import io.netty.handler.codec.stomp.StompSubframeEncoder;\n+import io.netty.microbench.channel.EmbeddedChannelWriteReleaseHandlerContext;\n+import io.netty.microbench.util.AbstractMicrobenchmark;\n+import io.netty.util.internal.ThreadLocalRandom;\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.Fork;\n+import org.openjdk.jmh.annotations.Level;\n+import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Param;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+import org.openjdk.jmh.annotations.TearDown;\n+import org.openjdk.jmh.annotations.Threads;\n+import org.openjdk.jmh.annotations.Warmup;\n+\n+@State(Scope.Benchmark)\n+@Fork(1)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU4NTAwMg=="}, "originalCommit": {"oid": "dd9ff3a681563343e4e2d92986bf39e358d0effd"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MDQ0NDM4OnYy", "diffSide": "RIGHT", "path": "codec-stomp/src/main/java/io/netty/handler/codec/stomp/StompSubframeEncoder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODoxODo0N1rOHukG8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODozNzoxNFrOHukrvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU4ODE0NQ==", "bodyText": "private static", "url": "https://github.com/netty/netty/pull/10778#discussion_r518588145", "createdAt": "2020-11-06T08:18:47Z", "author": {"login": "franz1981"}, "path": "codec-stomp/src/main/java/io/netty/handler/codec/stomp/StompSubframeEncoder.java", "diffHunk": "@@ -19,63 +19,91 @@\n import io.netty.buffer.ByteBufUtil;\n import io.netty.channel.ChannelHandlerContext;\n import io.netty.handler.codec.MessageToMessageEncoder;\n-import io.netty.util.CharsetUtil;\n \n import java.util.List;\n import java.util.Map.Entry;\n \n+import static io.netty.handler.codec.stomp.StompConstants.*;\n+\n /**\n  * Encodes a {@link StompFrame} or a {@link StompSubframe} into a {@link ByteBuf}.\n  */\n public class StompSubframeEncoder extends MessageToMessageEncoder<StompSubframe> {\n \n     @Override\n-    protected void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) throws Exception {\n+    protected void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) {\n         if (msg instanceof StompFrame) {\n-            StompFrame frame = (StompFrame) msg;\n-            ByteBuf frameBuf = encodeFrame(frame, ctx);\n-            if (frame.content().isReadable()) {\n-                out.add(frameBuf);\n-                ByteBuf contentBuf = encodeContent(frame, ctx);\n-                out.add(contentBuf);\n-            } else {\n-                frameBuf.writeByte(StompConstants.NUL);\n-                out.add(frameBuf);\n-            }\n+            StompFrame stompFrame = (StompFrame) msg;\n+            ByteBuf buf = encodeFullFrame(stompFrame, ctx);\n+\n+            out.add(converter().convert(stompFrame, buf));\n         } else if (msg instanceof StompHeadersSubframe) {\n-            StompHeadersSubframe frame = (StompHeadersSubframe) msg;\n-            ByteBuf buf = encodeFrame(frame, ctx);\n-            out.add(buf);\n+            StompHeadersSubframe stompHeadersSubframe = (StompHeadersSubframe) msg;\n+            ByteBuf buf = ctx.alloc().buffer(headersSubFrameSize(stompHeadersSubframe));\n+            encodeHeaders(stompHeadersSubframe, buf);\n+\n+            out.add(converter().convert(stompHeadersSubframe, buf));\n         } else if (msg instanceof StompContentSubframe) {\n             StompContentSubframe stompContentSubframe = (StompContentSubframe) msg;\n             ByteBuf buf = encodeContent(stompContentSubframe, ctx);\n-            out.add(buf);\n+\n+            out.add(converter().convert(stompContentSubframe, buf));\n         }\n     }\n \n-    private static ByteBuf encodeContent(StompContentSubframe content, ChannelHandlerContext ctx) {\n-        if (content instanceof LastStompContentSubframe) {\n-            ByteBuf buf = ctx.alloc().buffer(content.content().readableBytes() + 1);\n-            buf.writeBytes(content.content());\n-            buf.writeByte(StompConstants.NUL);\n-            return buf;\n-        } else {\n-            return content.content().retain();\n+    protected StompEncodedSubframeConverter<?> converter() {\n+        return StompEncodedSubframeConverter.NOOP;\n+    }\n+\n+    /**\n+     * Returns a heuristic size for headers (32 bytes per header line) + (2 bytes for colon and eol)\n+     * + (additional command buffer).\n+     */\n+    protected int headersSubFrameSize(StompHeadersSubframe headersSubframe) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd9ff3a681563343e4e2d92986bf39e358d0effd"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU5NzU2Ng==", "bodyText": "I thought to leave it open so that somebody could override it since this is just a heuristic.", "url": "https://github.com/netty/netty/pull/10778#discussion_r518597566", "createdAt": "2020-11-06T08:37:14Z", "author": {"login": "amizurov"}, "path": "codec-stomp/src/main/java/io/netty/handler/codec/stomp/StompSubframeEncoder.java", "diffHunk": "@@ -19,63 +19,91 @@\n import io.netty.buffer.ByteBufUtil;\n import io.netty.channel.ChannelHandlerContext;\n import io.netty.handler.codec.MessageToMessageEncoder;\n-import io.netty.util.CharsetUtil;\n \n import java.util.List;\n import java.util.Map.Entry;\n \n+import static io.netty.handler.codec.stomp.StompConstants.*;\n+\n /**\n  * Encodes a {@link StompFrame} or a {@link StompSubframe} into a {@link ByteBuf}.\n  */\n public class StompSubframeEncoder extends MessageToMessageEncoder<StompSubframe> {\n \n     @Override\n-    protected void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) throws Exception {\n+    protected void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) {\n         if (msg instanceof StompFrame) {\n-            StompFrame frame = (StompFrame) msg;\n-            ByteBuf frameBuf = encodeFrame(frame, ctx);\n-            if (frame.content().isReadable()) {\n-                out.add(frameBuf);\n-                ByteBuf contentBuf = encodeContent(frame, ctx);\n-                out.add(contentBuf);\n-            } else {\n-                frameBuf.writeByte(StompConstants.NUL);\n-                out.add(frameBuf);\n-            }\n+            StompFrame stompFrame = (StompFrame) msg;\n+            ByteBuf buf = encodeFullFrame(stompFrame, ctx);\n+\n+            out.add(converter().convert(stompFrame, buf));\n         } else if (msg instanceof StompHeadersSubframe) {\n-            StompHeadersSubframe frame = (StompHeadersSubframe) msg;\n-            ByteBuf buf = encodeFrame(frame, ctx);\n-            out.add(buf);\n+            StompHeadersSubframe stompHeadersSubframe = (StompHeadersSubframe) msg;\n+            ByteBuf buf = ctx.alloc().buffer(headersSubFrameSize(stompHeadersSubframe));\n+            encodeHeaders(stompHeadersSubframe, buf);\n+\n+            out.add(converter().convert(stompHeadersSubframe, buf));\n         } else if (msg instanceof StompContentSubframe) {\n             StompContentSubframe stompContentSubframe = (StompContentSubframe) msg;\n             ByteBuf buf = encodeContent(stompContentSubframe, ctx);\n-            out.add(buf);\n+\n+            out.add(converter().convert(stompContentSubframe, buf));\n         }\n     }\n \n-    private static ByteBuf encodeContent(StompContentSubframe content, ChannelHandlerContext ctx) {\n-        if (content instanceof LastStompContentSubframe) {\n-            ByteBuf buf = ctx.alloc().buffer(content.content().readableBytes() + 1);\n-            buf.writeBytes(content.content());\n-            buf.writeByte(StompConstants.NUL);\n-            return buf;\n-        } else {\n-            return content.content().retain();\n+    protected StompEncodedSubframeConverter<?> converter() {\n+        return StompEncodedSubframeConverter.NOOP;\n+    }\n+\n+    /**\n+     * Returns a heuristic size for headers (32 bytes per header line) + (2 bytes for colon and eol)\n+     * + (additional command buffer).\n+     */\n+    protected int headersSubFrameSize(StompHeadersSubframe headersSubframe) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU4ODE0NQ=="}, "originalCommit": {"oid": "dd9ff3a681563343e4e2d92986bf39e358d0effd"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2NjI0ODk4OnYy", "diffSide": "RIGHT", "path": "example/src/main/java/io/netty/example/stomp/websocket/StompWebSocketFrameEncoder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMTo0Njo1NVrOHw3xkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMTo0MToxMVrOH2Zbvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAwNzUwNw==", "bodyText": "This methods may be override by some one.", "url": "https://github.com/netty/netty/pull/10778#discussion_r521007507", "createdAt": "2020-11-11T01:46:55Z", "author": {"login": "timandy"}, "path": "example/src/main/java/io/netty/example/stomp/websocket/StompWebSocketFrameEncoder.java", "diffHunk": "@@ -16,53 +16,64 @@\n package io.netty.example.stomp.websocket;\n \n import io.netty.buffer.ByteBuf;\n-import io.netty.buffer.CompositeByteBuf;\n import io.netty.channel.ChannelHandlerContext;\n+import io.netty.handler.codec.http.websocketx.BinaryWebSocketFrame;\n import io.netty.handler.codec.http.websocketx.ContinuationWebSocketFrame;\n import io.netty.handler.codec.http.websocketx.TextWebSocketFrame;\n import io.netty.handler.codec.http.websocketx.WebSocketFrame;\n import io.netty.handler.codec.stomp.LastStompContentSubframe;\n+import io.netty.handler.codec.stomp.StompContentSubframe;\n+import io.netty.handler.codec.stomp.StompEncodedSubframeConverter;\n import io.netty.handler.codec.stomp.StompFrame;\n+import io.netty.handler.codec.stomp.StompHeaders;\n import io.netty.handler.codec.stomp.StompHeadersSubframe;\n import io.netty.handler.codec.stomp.StompSubframe;\n import io.netty.handler.codec.stomp.StompSubframeEncoder;\n \n import java.util.List;\n \n-public class StompWebSocketFrameEncoder extends StompSubframeEncoder {\n+public class StompWebSocketFrameEncoder extends StompSubframeEncoder\n+        implements StompEncodedSubframeConverter<WebSocketFrame> {\n \n     @Override\n-    public void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) throws Exception {\n+    public void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) {\n         super.encode(ctx, msg, out);\n+    }\n+\n+    @Override\n+    protected StompEncodedSubframeConverter<?> converter() {\n+        return this;\n+    }\n \n-        if (out.isEmpty()) {\n-            return;\n+    @Override\n+    public WebSocketFrame convert(StompFrame original, ByteBuf encoded) {\n+        if (isTextFrame(original)) {\n+            return new TextWebSocketFrame(encoded);\n         }\n \n-        final WebSocketFrame webSocketFrame;\n-        if (msg instanceof StompFrame) {\n-            if (out.size() == 1) {\n-                webSocketFrame = new TextWebSocketFrame(getFirst(out));\n-            } else {\n-                CompositeByteBuf content = ctx.alloc().compositeBuffer(out.size());\n-                for (Object byteBuf : out) {\n-                    content.addComponent(true, (ByteBuf) byteBuf);\n-                }\n-                webSocketFrame = new TextWebSocketFrame(content);\n-            }\n-        } else if (msg instanceof StompHeadersSubframe) {\n-            webSocketFrame = new TextWebSocketFrame(false, 0, getFirst(out));\n-        } else if (msg instanceof LastStompContentSubframe) {\n-            webSocketFrame = new ContinuationWebSocketFrame(true, 0, getFirst(out));\n-        } else {\n-            webSocketFrame = new ContinuationWebSocketFrame(false, 0, getFirst(out));\n+        return new BinaryWebSocketFrame(encoded);\n+    }\n+\n+    @Override\n+    public WebSocketFrame convert(StompHeadersSubframe original, ByteBuf encoded) {\n+        if (isTextFrame(original)) {\n+            return new TextWebSocketFrame(false, 0, encoded);\n+        }\n+\n+        return new BinaryWebSocketFrame(false, 0, encoded);\n+    }\n+\n+    @Override\n+    public WebSocketFrame convert(StompContentSubframe original, ByteBuf encoded) {\n+        if (original instanceof LastStompContentSubframe) {\n+            return new ContinuationWebSocketFrame(true, 0, encoded);\n         }\n \n-        out.clear();\n-        out.add(webSocketFrame);\n+        return new ContinuationWebSocketFrame(false, 0, encoded);\n     }\n \n-    private static ByteBuf getFirst(List<Object> container) {\n-        return (ByteBuf) container.get(0);\n+    private static boolean isTextFrame(StompHeadersSubframe headersSubframe) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd9ff3a681563343e4e2d92986bf39e358d0effd"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgwMTg1NQ==", "bodyText": "This is just example for STOMP over WS you can easily write yourself encoder", "url": "https://github.com/netty/netty/pull/10778#discussion_r526801855", "createdAt": "2020-11-19T11:41:11Z", "author": {"login": "amizurov"}, "path": "example/src/main/java/io/netty/example/stomp/websocket/StompWebSocketFrameEncoder.java", "diffHunk": "@@ -16,53 +16,64 @@\n package io.netty.example.stomp.websocket;\n \n import io.netty.buffer.ByteBuf;\n-import io.netty.buffer.CompositeByteBuf;\n import io.netty.channel.ChannelHandlerContext;\n+import io.netty.handler.codec.http.websocketx.BinaryWebSocketFrame;\n import io.netty.handler.codec.http.websocketx.ContinuationWebSocketFrame;\n import io.netty.handler.codec.http.websocketx.TextWebSocketFrame;\n import io.netty.handler.codec.http.websocketx.WebSocketFrame;\n import io.netty.handler.codec.stomp.LastStompContentSubframe;\n+import io.netty.handler.codec.stomp.StompContentSubframe;\n+import io.netty.handler.codec.stomp.StompEncodedSubframeConverter;\n import io.netty.handler.codec.stomp.StompFrame;\n+import io.netty.handler.codec.stomp.StompHeaders;\n import io.netty.handler.codec.stomp.StompHeadersSubframe;\n import io.netty.handler.codec.stomp.StompSubframe;\n import io.netty.handler.codec.stomp.StompSubframeEncoder;\n \n import java.util.List;\n \n-public class StompWebSocketFrameEncoder extends StompSubframeEncoder {\n+public class StompWebSocketFrameEncoder extends StompSubframeEncoder\n+        implements StompEncodedSubframeConverter<WebSocketFrame> {\n \n     @Override\n-    public void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) throws Exception {\n+    public void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) {\n         super.encode(ctx, msg, out);\n+    }\n+\n+    @Override\n+    protected StompEncodedSubframeConverter<?> converter() {\n+        return this;\n+    }\n \n-        if (out.isEmpty()) {\n-            return;\n+    @Override\n+    public WebSocketFrame convert(StompFrame original, ByteBuf encoded) {\n+        if (isTextFrame(original)) {\n+            return new TextWebSocketFrame(encoded);\n         }\n \n-        final WebSocketFrame webSocketFrame;\n-        if (msg instanceof StompFrame) {\n-            if (out.size() == 1) {\n-                webSocketFrame = new TextWebSocketFrame(getFirst(out));\n-            } else {\n-                CompositeByteBuf content = ctx.alloc().compositeBuffer(out.size());\n-                for (Object byteBuf : out) {\n-                    content.addComponent(true, (ByteBuf) byteBuf);\n-                }\n-                webSocketFrame = new TextWebSocketFrame(content);\n-            }\n-        } else if (msg instanceof StompHeadersSubframe) {\n-            webSocketFrame = new TextWebSocketFrame(false, 0, getFirst(out));\n-        } else if (msg instanceof LastStompContentSubframe) {\n-            webSocketFrame = new ContinuationWebSocketFrame(true, 0, getFirst(out));\n-        } else {\n-            webSocketFrame = new ContinuationWebSocketFrame(false, 0, getFirst(out));\n+        return new BinaryWebSocketFrame(encoded);\n+    }\n+\n+    @Override\n+    public WebSocketFrame convert(StompHeadersSubframe original, ByteBuf encoded) {\n+        if (isTextFrame(original)) {\n+            return new TextWebSocketFrame(false, 0, encoded);\n+        }\n+\n+        return new BinaryWebSocketFrame(false, 0, encoded);\n+    }\n+\n+    @Override\n+    public WebSocketFrame convert(StompContentSubframe original, ByteBuf encoded) {\n+        if (original instanceof LastStompContentSubframe) {\n+            return new ContinuationWebSocketFrame(true, 0, encoded);\n         }\n \n-        out.clear();\n-        out.add(webSocketFrame);\n+        return new ContinuationWebSocketFrame(false, 0, encoded);\n     }\n \n-    private static ByteBuf getFirst(List<Object> container) {\n-        return (ByteBuf) container.get(0);\n+    private static boolean isTextFrame(StompHeadersSubframe headersSubframe) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAwNzUwNw=="}, "originalCommit": {"oid": "dd9ff3a681563343e4e2d92986bf39e358d0effd"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMDQzOTkzOnYy", "diffSide": "RIGHT", "path": "codec-stomp/src/main/java/io/netty/handler/codec/stomp/StompSubframeEncoder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMDo1MToxN1rOH463JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMjoxODo1NlrOH9YU4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ0NjY5Mg==", "bodyText": "This a breaking change as someone may have override this method with throws in the signature", "url": "https://github.com/netty/netty/pull/10778#discussion_r529446692", "createdAt": "2020-11-24T10:51:17Z", "author": {"login": "normanmaurer"}, "path": "codec-stomp/src/main/java/io/netty/handler/codec/stomp/StompSubframeEncoder.java", "diffHunk": "@@ -19,63 +19,91 @@\n import io.netty.buffer.ByteBufUtil;\n import io.netty.channel.ChannelHandlerContext;\n import io.netty.handler.codec.MessageToMessageEncoder;\n-import io.netty.util.CharsetUtil;\n \n import java.util.List;\n import java.util.Map.Entry;\n \n+import static io.netty.handler.codec.stomp.StompConstants.*;\n+\n /**\n  * Encodes a {@link StompFrame} or a {@link StompSubframe} into a {@link ByteBuf}.\n  */\n public class StompSubframeEncoder extends MessageToMessageEncoder<StompSubframe> {\n \n     @Override\n-    protected void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) throws Exception {\n+    protected void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd7ed3e9ebfa0fb832660939eb4d87e3ba47a365"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDEyMzc0NQ==", "bodyText": "fixed", "url": "https://github.com/netty/netty/pull/10778#discussion_r534123745", "createdAt": "2020-12-02T12:18:56Z", "author": {"login": "amizurov"}, "path": "codec-stomp/src/main/java/io/netty/handler/codec/stomp/StompSubframeEncoder.java", "diffHunk": "@@ -19,63 +19,91 @@\n import io.netty.buffer.ByteBufUtil;\n import io.netty.channel.ChannelHandlerContext;\n import io.netty.handler.codec.MessageToMessageEncoder;\n-import io.netty.util.CharsetUtil;\n \n import java.util.List;\n import java.util.Map.Entry;\n \n+import static io.netty.handler.codec.stomp.StompConstants.*;\n+\n /**\n  * Encodes a {@link StompFrame} or a {@link StompSubframe} into a {@link ByteBuf}.\n  */\n public class StompSubframeEncoder extends MessageToMessageEncoder<StompSubframe> {\n \n     @Override\n-    protected void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) throws Exception {\n+    protected void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ0NjY5Mg=="}, "originalCommit": {"oid": "fd7ed3e9ebfa0fb832660939eb4d87e3ba47a365"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMDQ0NjEyOnYy", "diffSide": "RIGHT", "path": "example/src/main/java/io/netty/example/stomp/websocket/StompWebSocketFrameEncoder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMDo1MjoxMVrOH467MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMjoxODo1MVrOH9YUwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ0NzcyOA==", "bodyText": "same comment as above... The throws  needs to stay", "url": "https://github.com/netty/netty/pull/10778#discussion_r529447728", "createdAt": "2020-11-24T10:52:11Z", "author": {"login": "normanmaurer"}, "path": "example/src/main/java/io/netty/example/stomp/websocket/StompWebSocketFrameEncoder.java", "diffHunk": "@@ -16,53 +16,64 @@\n package io.netty.example.stomp.websocket;\n \n import io.netty.buffer.ByteBuf;\n-import io.netty.buffer.CompositeByteBuf;\n import io.netty.channel.ChannelHandlerContext;\n+import io.netty.handler.codec.http.websocketx.BinaryWebSocketFrame;\n import io.netty.handler.codec.http.websocketx.ContinuationWebSocketFrame;\n import io.netty.handler.codec.http.websocketx.TextWebSocketFrame;\n import io.netty.handler.codec.http.websocketx.WebSocketFrame;\n import io.netty.handler.codec.stomp.LastStompContentSubframe;\n+import io.netty.handler.codec.stomp.StompContentSubframe;\n+import io.netty.handler.codec.stomp.StompEncodedSubframeConverter;\n import io.netty.handler.codec.stomp.StompFrame;\n+import io.netty.handler.codec.stomp.StompHeaders;\n import io.netty.handler.codec.stomp.StompHeadersSubframe;\n import io.netty.handler.codec.stomp.StompSubframe;\n import io.netty.handler.codec.stomp.StompSubframeEncoder;\n \n import java.util.List;\n \n-public class StompWebSocketFrameEncoder extends StompSubframeEncoder {\n+public class StompWebSocketFrameEncoder extends StompSubframeEncoder\n+        implements StompEncodedSubframeConverter<WebSocketFrame> {\n \n     @Override\n-    public void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) throws Exception {\n+    public void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd7ed3e9ebfa0fb832660939eb4d87e3ba47a365"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDEyMzcxNA==", "bodyText": "fixed", "url": "https://github.com/netty/netty/pull/10778#discussion_r534123714", "createdAt": "2020-12-02T12:18:51Z", "author": {"login": "amizurov"}, "path": "example/src/main/java/io/netty/example/stomp/websocket/StompWebSocketFrameEncoder.java", "diffHunk": "@@ -16,53 +16,64 @@\n package io.netty.example.stomp.websocket;\n \n import io.netty.buffer.ByteBuf;\n-import io.netty.buffer.CompositeByteBuf;\n import io.netty.channel.ChannelHandlerContext;\n+import io.netty.handler.codec.http.websocketx.BinaryWebSocketFrame;\n import io.netty.handler.codec.http.websocketx.ContinuationWebSocketFrame;\n import io.netty.handler.codec.http.websocketx.TextWebSocketFrame;\n import io.netty.handler.codec.http.websocketx.WebSocketFrame;\n import io.netty.handler.codec.stomp.LastStompContentSubframe;\n+import io.netty.handler.codec.stomp.StompContentSubframe;\n+import io.netty.handler.codec.stomp.StompEncodedSubframeConverter;\n import io.netty.handler.codec.stomp.StompFrame;\n+import io.netty.handler.codec.stomp.StompHeaders;\n import io.netty.handler.codec.stomp.StompHeadersSubframe;\n import io.netty.handler.codec.stomp.StompSubframe;\n import io.netty.handler.codec.stomp.StompSubframeEncoder;\n \n import java.util.List;\n \n-public class StompWebSocketFrameEncoder extends StompSubframeEncoder {\n+public class StompWebSocketFrameEncoder extends StompSubframeEncoder\n+        implements StompEncodedSubframeConverter<WebSocketFrame> {\n \n     @Override\n-    public void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) throws Exception {\n+    public void encode(ChannelHandlerContext ctx, StompSubframe msg, List<Object> out) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ0NzcyOA=="}, "originalCommit": {"oid": "fd7ed3e9ebfa0fb832660939eb4d87e3ba47a365"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMDQ1NDQwOnYy", "diffSide": "RIGHT", "path": "codec-stomp/src/main/java/io/netty/handler/codec/stomp/StompEncodedSubframeConverter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMDo1MzoxOVrOH47AZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMjoxODo0MlrOH9YUXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ0OTA2MQ==", "bodyText": "Can't we just add protected methods or something like that ? Adding another interface feels very \"heavyweight\" .", "url": "https://github.com/netty/netty/pull/10778#discussion_r529449061", "createdAt": "2020-11-24T10:53:19Z", "author": {"login": "normanmaurer"}, "path": "codec-stomp/src/main/java/io/netty/handler/codec/stomp/StompEncodedSubframeConverter.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.stomp;\n+\n+import io.netty.buffer.ByteBuf;\n+\n+/**\n+ * Converter is responsible to convert encoded {@link StompSubframe} to other message type.\n+ */\n+public interface StompEncodedSubframeConverter<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd7ed3e9ebfa0fb832660939eb4d87e3ba47a365"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDEyMzYxMg==", "bodyText": "let's do it", "url": "https://github.com/netty/netty/pull/10778#discussion_r534123612", "createdAt": "2020-12-02T12:18:42Z", "author": {"login": "amizurov"}, "path": "codec-stomp/src/main/java/io/netty/handler/codec/stomp/StompEncodedSubframeConverter.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.stomp;\n+\n+import io.netty.buffer.ByteBuf;\n+\n+/**\n+ * Converter is responsible to convert encoded {@link StompSubframe} to other message type.\n+ */\n+public interface StompEncodedSubframeConverter<T> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ0OTA2MQ=="}, "originalCommit": {"oid": "fd7ed3e9ebfa0fb832660939eb4d87e3ba47a365"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MTkwODg4OnYy", "diffSide": "LEFT", "path": "example/src/main/java/io/netty/example/stomp/websocket/StompWebSocketProtocolCodec.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNTowNTo1MVrOH9fXJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNToxMDowOFrOH9fkBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIzOTAxNQ==", "bodyText": "This one still needs to propagate the exception from the frame encoder.", "url": "https://github.com/netty/netty/pull/10778#discussion_r534239015", "createdAt": "2020-12-02T15:05:51Z", "author": {"login": "chrisvest"}, "path": "example/src/main/java/io/netty/example/stomp/websocket/StompWebSocketProtocolCodec.java", "diffHunk": "@@ -52,13 +53,13 @@ public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exc\n     }\n \n     @Override\n-    protected void encode(ChannelHandlerContext ctx, StompSubframe stompFrame, List<Object> out) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f21c05aef871978f7036e2bcb54b159c1632eaf9"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI0MjMxMQ==", "bodyText": "Thx fixed, missed this one  :(", "url": "https://github.com/netty/netty/pull/10778#discussion_r534242311", "createdAt": "2020-12-02T15:10:08Z", "author": {"login": "amizurov"}, "path": "example/src/main/java/io/netty/example/stomp/websocket/StompWebSocketProtocolCodec.java", "diffHunk": "@@ -52,13 +53,13 @@ public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exc\n     }\n \n     @Override\n-    protected void encode(ChannelHandlerContext ctx, StompSubframe stompFrame, List<Object> out) throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIzOTAxNQ=="}, "originalCommit": {"oid": "f21c05aef871978f7036e2bcb54b159c1632eaf9"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3538, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}