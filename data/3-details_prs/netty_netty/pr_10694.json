{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0Mjk4MDUw", "number": 10694, "title": "Allow EventLoops to rethrow Error", "bodyText": "Allows EventLoops to rethrow ThreadDeath errors.\nMotivation:\nThread.stop() works by producing a ThreadDeath error in the target thread. EventLoops swallow all Throwables, which makes them effectively unkillable. This is effectively a memory leak, for our application.\nModification:\nEdit the EventLoops that swallow Throwables to instead rethrow ThreadDeath errors.", "createdAt": "2020-10-15T18:31:50Z", "url": "https://github.com/netty/netty/pull/10694", "merged": true, "mergeCommit": {"oid": "090e9a727196d60af3f463a13762e8bdb697c1f1"}, "closed": true, "closedAt": "2020-10-24T12:56:34Z", "author": {"login": "greenjustin"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdS2DqogH2gAyNTA0Mjk4MDUwOmMxOTI3NjFiNTA0MGNmMjkyZjY2YmI1ZGMwYzI3M2VjNzAwOGFlZDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUdFTzAFqTUxMzAxODI1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c192761b5040cf292f66bb5dc0c273ec7008aed8", "author": {"user": {"login": "greenjustin", "name": null}}, "url": "https://github.com/netty/netty/commit/c192761b5040cf292f66bb5dc0c273ec7008aed8", "committedDate": "2020-10-15T18:26:45Z", "message": "Allow EventLoops to rethrow ThreadDeath errors. This allows them to be killed by Thread.stop()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NjY1Nzg4", "url": "https://github.com/netty/netty/pull/10694#pullrequestreview-509665788", "createdAt": "2020-10-15T18:39:06Z", "commit": {"oid": "c192761b5040cf292f66bb5dc0c273ec7008aed8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxODozOTowNlrOHiVL9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxODozOTowNlrOHiVL9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc2MDc1OA==", "bodyText": "Please refactor to:\ntry {\n    ...\n} catch (ThreadDeath td) {\n    throw (ThreadDeath) td;\n} catch (Throwable t) {\n    handleLoopException(t);\n}\nSome for all other places.", "url": "https://github.com/netty/netty/pull/10694#discussion_r505760758", "createdAt": "2020-10-15T18:39:06Z", "author": {"login": "normanmaurer"}, "path": "transport-native-epoll/src/main/java/io/netty/channel/epoll/EpollEventLoop.java", "diffHunk": "@@ -391,7 +391,11 @@ protected void run() {\n                     events.increase();\n                 }\n             } catch (Throwable t) {\n-                handleLoopException(t);\n+                if (t instanceof ThreadDeath) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c192761b5040cf292f66bb5dc0c273ec7008aed8"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8c21a1886229297fdce64c0a49492ba02c2847c", "author": {"user": {"login": "greenjustin", "name": null}}, "url": "https://github.com/netty/netty/commit/e8c21a1886229297fdce64c0a49492ba02c2847c", "committedDate": "2020-10-15T18:46:57Z", "message": "Refactoring ThreadDeath rethrowing slightly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMzA5Nzgz", "url": "https://github.com/netty/netty/pull/10694#pullrequestreview-510309783", "createdAt": "2020-10-16T09:35:53Z", "commit": {"oid": "e8c21a1886229297fdce64c0a49492ba02c2847c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwOTozNTo1M1rOHixW8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwOTozNTo1M1rOHixW8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMjMyMQ==", "bodyText": "Right below these catch clauses it says \"Always handle shutdown even if the loop processing threw an exception.\"\nShould that perhaps be moved into a finally clause? It's the same deal in all of the event loops modified in this PR.", "url": "https://github.com/netty/netty/pull/10694#discussion_r506222321", "createdAt": "2020-10-16T09:35:53Z", "author": {"login": "chrisvest"}, "path": "transport-native-epoll/src/main/java/io/netty/channel/epoll/EpollEventLoop.java", "diffHunk": "@@ -390,6 +390,8 @@ protected void run() {\n                     //increase the size of the array as we needed the whole space for the events\n                     events.increase();\n                 }\n+            } catch (ThreadDeath td) {\n+                throw (ThreadDeath) td;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8c21a1886229297fdce64c0a49492ba02c2847c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e2f6d600df14fadcc1bfb2df41efd699d9652b7", "author": {"user": {"login": "greenjustin", "name": null}}, "url": "https://github.com/netty/netty/commit/5e2f6d600df14fadcc1bfb2df41efd699d9652b7", "committedDate": "2020-10-16T14:29:16Z", "message": "Move shutdown handling code for EventLoops into a finally block."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10258ed3316133eb90f8d6574c2498ee82e8df0d", "author": {"user": {"login": "greenjustin", "name": null}}, "url": "https://github.com/netty/netty/commit/10258ed3316133eb90f8d6574c2498ee82e8df0d", "committedDate": "2020-10-16T14:36:03Z", "message": "Formatting fixes to EventLoops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwOTY3Mzgz", "url": "https://github.com/netty/netty/pull/10694#pullrequestreview-510967383", "createdAt": "2020-10-17T08:03:51Z", "commit": {"oid": "10258ed3316133eb90f8d6574c2498ee82e8df0d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwODowMzo1MVrOHjYfcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwODowMzo1MVrOHjYfcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjg2MzQ3NQ==", "bodyText": "@greenjustin wouldn't you want to rethrow ThreadDeath here as well ? (same is true for all the other impls)", "url": "https://github.com/netty/netty/pull/10694#discussion_r506863475", "createdAt": "2020-10-17T08:03:51Z", "author": {"login": "normanmaurer"}, "path": "transport-native-epoll/src/main/java/io/netty/channel/epoll/EpollEventLoop.java", "diffHunk": "@@ -390,19 +390,22 @@ protected void run() {\n                     //increase the size of the array as we needed the whole space for the events\n                     events.increase();\n                 }\n+            } catch (ThreadDeath td) {\n+                throw (ThreadDeath) td;\n             } catch (Throwable t) {\n                 handleLoopException(t);\n-            }\n-            // Always handle shutdown even if the loop processing threw an exception.\n-            try {\n-                if (isShuttingDown()) {\n-                    closeAll();\n-                    if (confirmShutdown()) {\n-                        break;\n+            } finally {\n+                // Always handle shutdown even if the loop processing threw an exception.\n+                try {\n+                    if (isShuttingDown()) {\n+                        closeAll();\n+                        if (confirmShutdown()) {\n+                            break;\n+                        }\n                     }\n+                } catch (Throwable t) {\n+                    handleLoopException(t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10258ed3316133eb90f8d6574c2498ee82e8df0d"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b06d4a42eb45cfa8e84f783d88888765dc1a30bd", "author": {"user": {"login": "greenjustin", "name": null}}, "url": "https://github.com/netty/netty/commit/b06d4a42eb45cfa8e84f783d88888765dc1a30bd", "committedDate": "2020-10-19T14:18:52Z", "message": "Rethrow all errors, not just ThreadDeath. Errors are meant to be unrecoverable, like OOM."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMDE4MjUy", "url": "https://github.com/netty/netty/pull/10694#pullrequestreview-513018252", "createdAt": "2020-10-20T18:28:46Z", "commit": {"oid": "b06d4a42eb45cfa8e84f783d88888765dc1a30bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4926, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}