{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2MDcwNzQ0", "number": 10627, "title": "Dont pool IovArray but just allocate on the fly", "bodyText": "Motivation:\nPooling and re-using IovArray works for now but is not safe in its\ncurrent form once SQPOLL is used as we can not assume we can re-use the\nIovArray once we called submit.\nModifications:\nJust allocate the IovArray on the fly when needed by using the\nByteBufAllocator\nResult:\nCode is safe even with SQPOLL", "createdAt": "2020-10-01T08:28:27Z", "url": "https://github.com/netty/netty/pull/10627", "merged": true, "mergeCommit": {"oid": "acd332a3ce8311b768746bd5a861f19368d56f4a"}, "closed": true, "closedAt": "2020-10-02T06:28:42Z", "author": {"login": "normanmaurer"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdONBWegH2gAyNDk2MDcwNzQ0OjU5MWI4MmRlZjZlNTEwOGM3MDExZDQ1NDY2YzAzMWUxOTZjMmE1MTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOe36gAH2gAyNDk2MDcwNzQ0OmFhMDIzNzdjZDAxNjZlOGZlMzBhYWFlNTI1MmVkYzc0NmI5YzViMzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "591b82def6e5108c7011d45466c031e196c2a517", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/591b82def6e5108c7011d45466c031e196c2a517", "committedDate": "2020-10-01T08:22:25Z", "message": "Dont pool IovArray but just allocate on the fly\n\nMotivation:\n\nPooling and re-using IovArray works for now but is not safe in its\ncurrent form once SQPOLL is used as we can not assume we can re-use the\nIovArray once we called submit.\n\nModifications:\n\nJust allocate the IovArray on the fly when needed by using the\nByteBufAllocator\n\nResult:\n\nCode is safe even with SQPOLL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8103e96da67e19ef8acfae5988391c5e08ef5b4a", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/8103e96da67e19ef8acfae5988391c5e08ef5b4a", "committedDate": "2020-10-01T08:29:25Z", "message": "Merge branch 'io-uring' into iovarray_reuse"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ada396a609d0a559222e7d3920d4afc4b2761c66", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/ada396a609d0a559222e7d3920d4afc4b2761c66", "committedDate": "2020-10-01T08:34:34Z", "message": "simplify"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMTMwNTg1", "url": "https://github.com/netty/netty/pull/10627#pullrequestreview-500130585", "createdAt": "2020-10-01T08:43:26Z", "commit": {"oid": "ada396a609d0a559222e7d3920d4afc4b2761c66"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMTMxMjY1", "url": "https://github.com/netty/netty/pull/10627#pullrequestreview-500131265", "createdAt": "2020-10-01T08:44:20Z", "commit": {"oid": "ada396a609d0a559222e7d3920d4afc4b2761c66"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODo0NDoyMFrOHbAdKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODo0NDoyMFrOHbAdKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA4MTA2Nw==", "bodyText": "Hang on, what's up with the setLong?", "url": "https://github.com/netty/netty/pull/10627#discussion_r498081067", "createdAt": "2020-10-01T08:44:20Z", "author": {"login": "chrisvest"}, "path": "transport-native-unix-common/src/main/java/io/netty/channel/unix/IovArray.java", "diffHunk": "@@ -141,17 +146,17 @@ private boolean add(long addr, int len) {\n                 PlatformDependent.putLong(baseOffset + memoryAddress, addr);\n                 PlatformDependent.putLong(lengthOffset + memoryAddress, len);\n             } else {\n-                memory.putLong(baseOffset, addr);\n-                memory.putLong(lengthOffset, len);\n+                memory.setLong(baseOffset, addr);\n+                memory.setLong(lengthOffset, len);\n             }\n         } else {\n             assert ADDRESS_SIZE == 4;\n             if (PlatformDependent.hasUnsafe()) {\n                 PlatformDependent.putInt(baseOffset + memoryAddress, (int) addr);\n                 PlatformDependent.putInt(lengthOffset + memoryAddress, len);\n             } else {\n-                memory.putInt(baseOffset, (int) addr);\n-                memory.putInt(lengthOffset, len);\n+                memory.setLong(baseOffset, (int) addr);\n+                memory.setLong(lengthOffset, len);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ada396a609d0a559222e7d3920d4afc4b2761c66"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMTUwOTMx", "url": "https://github.com/netty/netty/pull/10627#pullrequestreview-500150931", "createdAt": "2020-10-01T09:08:33Z", "commit": {"oid": "ada396a609d0a559222e7d3920d4afc4b2761c66"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMTU3NDE1", "url": "https://github.com/netty/netty/pull/10627#pullrequestreview-500157415", "createdAt": "2020-10-01T09:16:58Z", "commit": {"oid": "ada396a609d0a559222e7d3920d4afc4b2761c66"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwOToxNjo1OFrOHbBoyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwOToxNjo1OFrOHbBoyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEwMDQyNA==", "bodyText": "do we still need the submissionQueueCallback in the future?", "url": "https://github.com/netty/netty/pull/10627#discussion_r498100424", "createdAt": "2020-10-01T09:16:58Z", "author": {"login": "1Jo1"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -65,14 +63,10 @@\n         // Ensure that we load all native bits as otherwise it may fail when try to use native methods in IovArray\n         IOUring.ensureAvailability();\n \n-        // TODO: Let's hard code this to 8 IovArrays to keep the memory overhead kind of small. We may want to consider\n-        //       allow to change this in the future.\n-        iovArrays = new IovArrays(8);\n         ringBuffer = Native.createRingBuffer(ringSize, iosqeAsyncThreshold, new Runnable() {\n             @Override\n             public void run() {\n-                // Once we submitted its safe to clear the IovArrays and so be able to re-use these.\n-                iovArrays.clear();\n+                // NOOP", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ada396a609d0a559222e7d3920d4afc4b2761c66"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed70dfe5a1a731f5a1d23e527009b454d07fab9e", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/ed70dfe5a1a731f5a1d23e527009b454d07fab9e", "committedDate": "2020-10-01T09:18:17Z", "message": "Use setInt(...) and also ensure we not try to write more than what the buffer supports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b71f8e36ef709de609d98a402558aae9765173e0", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/b71f8e36ef709de609d98a402558aae9765173e0", "committedDate": "2020-10-01T09:23:22Z", "message": "simplify"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMTY0OTg4", "url": "https://github.com/netty/netty/pull/10627#pullrequestreview-500164988", "createdAt": "2020-10-01T09:26:33Z", "commit": {"oid": "b71f8e36ef709de609d98a402558aae9765173e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dccc73ce60ae989fb90a6544e9bfc0c4644f7c27", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/dccc73ce60ae989fb90a6544e9bfc0c4644f7c27", "committedDate": "2020-10-01T11:47:42Z", "message": "remove submit callback as its not used anymore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "739cf4b94c1e4a8ac27109f74cc6d0dcea66419c", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/739cf4b94c1e4a8ac27109f74cc6d0dcea66419c", "committedDate": "2020-10-01T12:44:57Z", "message": "ordering"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMzIwMzgw", "url": "https://github.com/netty/netty/pull/10627#pullrequestreview-500320380", "createdAt": "2020-10-01T13:00:38Z", "commit": {"oid": "739cf4b94c1e4a8ac27109f74cc6d0dcea66419c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNTg1NjUz", "url": "https://github.com/netty/netty/pull/10627#pullrequestreview-500585653", "createdAt": "2020-10-01T17:52:08Z", "commit": {"oid": "739cf4b94c1e4a8ac27109f74cc6d0dcea66419c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzo1MjowOFrOHbVEsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNzo1Mzo0NFrOHbVIIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQxODg2NA==", "bodyText": "iovArray = null here?", "url": "https://github.com/netty/netty/pull/10627#discussion_r498418864", "createdAt": "2020-10-01T17:52:08Z", "author": {"login": "njhill"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringStreamChannel.java", "diffHunk": "@@ -209,16 +210,22 @@ protected Executor prepareToClose() {\n         }\n \n         private ByteBuf readBuffer;\n+        private IovArray iovArray;\n \n         @Override\n         protected int scheduleWriteMultiple(ChannelOutboundBuffer in) {\n-            final IovArray iovecArray = ((IOUringEventLoop) eventLoop()).iovArray();\n+            assert iovArray == null;\n+            int numElements = Math.min(in.size(), Limits.IOV_MAX);\n+            ByteBuf iovArrayBuffer = alloc().directBuffer(numElements * IovArray.IOV_SIZE);\n+            iovArray = new IovArray(iovArrayBuffer);\n             try {\n-                int offset = iovecArray.count();\n-                in.forEachFlushedMessage(iovecArray);\n+                int offset = iovArray.count();\n+                in.forEachFlushedMessage(iovArray);\n                 submissionQueue().addWritev(socket.intValue(),\n-                        iovecArray.memoryAddress(offset), iovecArray.count() - offset, (short) 0);\n+                        iovArray.memoryAddress(offset), iovArray.count() - offset, (short) 0);\n             } catch (Exception e) {\n+                iovArray.release();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "739cf4b94c1e4a8ac27109f74cc6d0dcea66419c"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQxOTc0Ng==", "bodyText": "only do this if !PlatformDependent.hasUnsafe()? otherwise we're unnecessarily allocating/wrapping on intel", "url": "https://github.com/netty/netty/pull/10627#discussion_r498419746", "createdAt": "2020-10-01T17:53:44Z", "author": {"login": "njhill"}, "path": "transport-native-unix-common/src/main/java/io/netty/channel/unix/IovArray.java", "diffHunk": "@@ -52,23 +54,29 @@\n      * The size of an {@code iovec} struct in bytes. This is calculated as we have 2 entries each of the size of the\n      * address.\n      */\n-    private static final int IOV_SIZE = 2 * ADDRESS_SIZE;\n+    public static final int IOV_SIZE = 2 * ADDRESS_SIZE;\n \n     /**\n      * The needed memory to hold up to {@code IOV_MAX} iov entries, where {@code IOV_MAX} signified\n      * the maximum number of {@code iovec} structs that can be passed to {@code writev(...)}.\n      */\n-    private static final int CAPACITY = IOV_MAX * IOV_SIZE;\n+    private static final int MAX_CAPACITY = IOV_MAX * IOV_SIZE;\n \n-    private final ByteBuffer memory;\n-    private final long memoryAddress;\n+    private final ByteBuf memory;\n     private int count;\n     private long size;\n     private long maxBytes = SSIZE_MAX;\n \n     public IovArray() {\n-        memory = Buffer.allocateDirectWithNativeOrder(CAPACITY);\n-        memoryAddress = Buffer.memoryAddress(memory);\n+        this(Unpooled.wrappedBuffer(Buffer.allocateDirectWithNativeOrder(MAX_CAPACITY)));\n+    }\n+\n+    @SuppressWarnings(\"deprecation\")\n+    public IovArray(ByteBuf memory) {\n+        assert memory.writerIndex() == 0;\n+        assert memory.readerIndex() == 0;\n+        this.memory = memory.order(\n+                PlatformDependent.BIG_ENDIAN_NATIVE_ORDER ? ByteOrder.BIG_ENDIAN : ByteOrder.LITTLE_ENDIAN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "739cf4b94c1e4a8ac27109f74cc6d0dcea66419c"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "777ed363d33315e25ea489f347baf92cae32ef38", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/777ed363d33315e25ea489f347baf92cae32ef38", "committedDate": "2020-10-01T18:30:02Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjIwMzcw", "url": "https://github.com/netty/netty/pull/10627#pullrequestreview-500620370", "createdAt": "2020-10-01T18:40:07Z", "commit": {"oid": "777ed363d33315e25ea489f347baf92cae32ef38"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa02377cd0166e8fe30aaae5252edc746b9c5b37", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/aa02377cd0166e8fe30aaae5252edc746b9c5b37", "committedDate": "2020-10-02T05:10:24Z", "message": "Update index"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 87, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}