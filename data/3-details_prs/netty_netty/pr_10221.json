{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5NTM0OTY5", "number": 10221, "title": "Detect CNAME loops in the CNAME cache while trying to resolve", "bodyText": "Motivation:\nWe need to detect CNAME loops during lookup the DnsCnameCache as otherwise we may try to follow cnames forever.\nModifications:\n\nCorrectly detect CNAME loops in the cache\nAdd unit test\n\nResult:\nFixes #10220", "createdAt": "2020-04-27T14:22:55Z", "url": "https://github.com/netty/netty/pull/10221", "merged": true, "mergeCommit": {"oid": "387e451c8289f05bf553821170bde30052101f8a"}, "closed": true, "closedAt": "2020-04-28T08:47:10Z", "author": {"login": "normanmaurer"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbwC2yAH2gAyNDA5NTM0OTY5OjdkMjhiMzdhMTE5NWEyNzYwZjQ5ZTRkZDNiMDExYTNiNTliMDA1ZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcb7QyDAFqTQwMTQ3MTU3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7d28b37a1195a2760f49e4dd3b011a3b59b005eb", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/7d28b37a1195a2760f49e4dd3b011a3b59b005eb", "committedDate": "2020-04-27T14:20:36Z", "message": "Detect CNAME loops in the CNAME cache while trying to resolve\n\nMotivation:\n\nWe need to detect CNAME loops during lookup the DnsCnameCache as otherwise we may try to follow cnames forever.\n\nModifications:\n\n- Correctly detect CNAME loops in the cache\n- Add unit test\n\nResult:\n\nFixes https://github.com/netty/netty/issues/10220"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMDEyNTU5", "url": "https://github.com/netty/netty/pull/10221#pullrequestreview-401012559", "createdAt": "2020-04-27T14:33:21Z", "commit": {"oid": "7d28b37a1195a2760f49e4dd3b011a3b59b005eb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNDozMzoyMVrOGMmYFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNDozMzoyMVrOGMmYFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg2NDg1Mg==", "bodyText": "Just code style, so not necessary: I would pack this \"uncommon case\" in a separate method", "url": "https://github.com/netty/netty/pull/10221#discussion_r415864852", "createdAt": "2020-04-27T14:33:21Z", "author": {"login": "franz1981"}, "path": "resolver-dns/src/main/java/io/netty/resolver/dns/DnsResolveContext.java", "diffHunk": "@@ -276,15 +276,48 @@ private static String hostnameWithDot(String name) {\n         return name + '.';\n     }\n \n-    private void internalResolve(String name, Promise<List<T>> promise) {\n-        for (;;) {\n-            // Resolve from cnameCache() until there is no more cname entry cached.\n-            String mapping = cnameCache().get(hostnameWithDot(name));\n-            if (mapping == null) {\n+    // Resolve the final name from the CNAME cache until there is nothing to follow anymore. This also\n+    // guards against loops in the cache but early return once a loop is detected.\n+    private String cnameResolveFromCache(String name) {\n+        DnsCnameCache cnameCache = cnameCache();\n+        String first = cnameCache.get(hostnameWithDot(name));\n+        if (first == null) {\n+            // Nothing in the cache at all\n+            return name;\n+        }\n+\n+        String mapping = cnameCache.get(hostnameWithDot(first));\n+        if (mapping == null) {\n+            // Nothing else to follow, return first match.\n+            return first;\n+        }\n+\n+        if (first.equals(mapping)) {\n+            // Loop detected.... early return.\n+            return first;\n+        }\n+\n+        // Detect loops using a HashSet. We use this as last resort implementation to reduce allocations in the most", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d28b37a1195a2760f49e4dd3b011a3b59b005eb"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMDIyOTY4", "url": "https://github.com/netty/netty/pull/10221#pullrequestreview-401022968", "createdAt": "2020-04-27T14:43:51Z", "commit": {"oid": "7d28b37a1195a2760f49e4dd3b011a3b59b005eb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c0de1ac4c30c4e4975996f92f0d8247aa48bacc", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/3c0de1ac4c30c4e4975996f92f0d8247aa48bacc", "committedDate": "2020-04-27T15:56:09Z", "message": "Move slow code to extra method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNDcxNTcw", "url": "https://github.com/netty/netty/pull/10221#pullrequestreview-401471570", "createdAt": "2020-04-28T03:24:46Z", "commit": {"oid": "3c0de1ac4c30c4e4975996f92f0d8247aa48bacc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 266, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}