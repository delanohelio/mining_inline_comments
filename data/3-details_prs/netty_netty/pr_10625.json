{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1NTE5Mjk0", "number": 10625, "title": "Enable IOSQE_ASYNC depending on how many fds are handled", "bodyText": "Motivation:\nIt has shown in benchmarks that IOSQE_ASYNC can be harmful when there\nare not a lot of fds handled at the same time.\nModifications:\n\nDont use IOSEQ_ASYNC for IORING_IO_TIMEOUT, IORING_IO_POLLADD,\nIORING_IO_POLLREMOVE\nEnable / disable the usage of IOSEQ_ASYNC for others IO ops based on\nthe number of fds that are handled\n\nResult:\nBetter performance without the need of the user to tune things", "createdAt": "2020-09-30T13:41:54Z", "url": "https://github.com/netty/netty/pull/10625", "merged": true, "mergeCommit": {"oid": "ec3641ef2382253fd9b4c19c080486c1c040bd9c"}, "closed": true, "closedAt": "2020-10-01T07:34:21Z", "author": {"login": "normanmaurer"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN88nnAH2gAyNDk1NTE5Mjk0OjE2YjA1YTllZjBiYWIwM2M3YjdlYmU3NGRkMzllMzllZTJlYjY4ZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOAdfNgH2gAyNDk1NTE5Mjk0OjViNWM4N2FlNWZiN2ZjZjAzZGFiMWU3NDk4NGNiMDdlOWQ1ZmU4ZjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "16b05a9ef0bab03c7b7ebe74dd39e39ee2eb68f2", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/16b05a9ef0bab03c7b7ebe74dd39e39ee2eb68f2", "committedDate": "2020-09-30T13:38:46Z", "message": "Enable IOSQE_ASYNC depending on how many fds are handled\n\nMotivation:\n\nIt has shown in benchmarks that IOSQE_ASYNC can be harmful when there\nare not a lot of fds handled at the same time.\n\nModifications:\n\n- Dont use IOSEQ_ASYNC for IORING_IO_TIMEOUT, IORING_IO_POLLADD,\nIORING_IO_POLLREMOVE\n- Enable / disable the usage of IOSEQ_ASYNC for others IO ops based on\nthe number of fds that are handled\n\nResult:\n\nBetter performance without the need of the user to tune things"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NDQ0OTIx", "url": "https://github.com/netty/netty/pull/10625#pullrequestreview-499444921", "createdAt": "2020-09-30T13:44:00Z", "commit": {"oid": "16b05a9ef0bab03c7b7ebe74dd39e39ee2eb68f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMzo0NDowMFrOHaeOyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMzo0NDowMFrOHaeOyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUyMDMyOQ==", "bodyText": "this was the number after which using the flag showed good results here...", "url": "https://github.com/netty/netty/pull/10625#discussion_r497520329", "createdAt": "2020-09-30T13:44:00Z", "author": {"login": "normanmaurer"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/Native.java", "diffHunk": "@@ -32,7 +32,7 @@\n final class Native {\n     private static final InternalLogger logger = InternalLoggerFactory.getInstance(Native.class);\n     static final int DEFAULT_RING_SIZE = Math.max(64, SystemPropertyUtil.getInt(\"io.netty.uring.ringSize\", 4096));\n-    static final boolean DEFAULT_USE_IOSEQ_ASYNC = true;\n+    static final int DEFAULT_IOSEQ_ASYNC_THRESHOLD = 25;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16b05a9ef0bab03c7b7ebe74dd39e39ee2eb68f2"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "819dae76a4e7a7fc2a6e1ff761b992788759c0a7", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/819dae76a4e7a7fc2a6e1ff761b992788759c0a7", "committedDate": "2020-09-30T13:53:59Z", "message": "Use system property"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1969e93c5f9b86d4cc7da318c77f73a675ba029f", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/1969e93c5f9b86d4cc7da318c77f73a675ba029f", "committedDate": "2020-09-30T14:01:59Z", "message": "fix decrement"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NDcyOTAx", "url": "https://github.com/netty/netty/pull/10625#pullrequestreview-499472901", "createdAt": "2020-09-30T14:10:18Z", "commit": {"oid": "1969e93c5f9b86d4cc7da318c77f73a675ba029f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDoxMDoxOVrOHaffug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDoxMDoxOVrOHaffug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU0MTA1MA==", "bodyText": "No need to compute the sqeFlagsAddress anymore. The variable isn't used.", "url": "https://github.com/netty/netty/pull/10625#discussion_r497541050", "createdAt": "2020-09-30T14:10:19Z", "author": {"login": "chrisvest"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringSubmissionQueue.java", "diffHunk": "@@ -86,21 +87,34 @@\n         this.tail = PlatformDependent.getIntVolatile(kTailAddress);\n \n         this.timeoutMemoryAddress = PlatformDependent.allocateMemory(KERNEL_TIMESPEC_SIZE);\n+        this.iosqeAsyncThreshold = iosqeAsyncThreshold;\n \n         // Zero the whole SQE array first\n         PlatformDependent.setMemory(submissionQueueArrayAddress, ringEntries * SQE_SIZE, (byte) 0);\n \n         // Fill SQ array indices (1-1 with SQE array) and set nonzero constant SQE fields\n         long address = kArrayAddress;\n         long sqeFlagsAddress = submissionQueueArrayAddress + SQE_FLAGS_FIELD;\n-        byte flag = iosqeAsync ? (byte) Native.IOSQE_ASYNC : 0;\n         for (int i = 0; i < ringEntries; i++, address += INT_SIZE, sqeFlagsAddress += SQE_SIZE) {\n             PlatformDependent.putInt(address, i);\n-            PlatformDependent.putByte(sqeFlagsAddress, flag);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1969e93c5f9b86d4cc7da318c77f73a675ba029f"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "641873308954aa858cc3d8e460f73103a59dddde", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/641873308954aa858cc3d8e460f73103a59dddde", "committedDate": "2020-09-30T14:31:09Z", "message": "Address comment of chris"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NjI1ODQ2", "url": "https://github.com/netty/netty/pull/10625#pullrequestreview-499625846", "createdAt": "2020-09-30T16:47:15Z", "commit": {"oid": "641873308954aa858cc3d8e460f73103a59dddde"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNjo0NzoxNVrOHamg8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNjo0NzoxNVrOHamg8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY1NjA0OQ==", "bodyText": "I think you don't want to increment here in the case that channels.put returns non-null, right?", "url": "https://github.com/netty/netty/pull/10625#discussion_r497656049", "createdAt": "2020-09-30T16:47:15Z", "author": {"login": "njhill"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringEventLoop.java", "diffHunk": "@@ -104,19 +104,25 @@ void add(AbstractIOUringChannel ch) {\n         int fd = ch.socket.intValue();\n \n         channels.put(fd, ch);\n+        ringBuffer.ioUringSubmissionQueue().incrementHandledFds();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "641873308954aa858cc3d8e460f73103a59dddde"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b5c87ae5fb7fcf03dab1e74984cb07e9d5fe8f5", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/5b5c87ae5fb7fcf03dab1e74984cb07e9d5fe8f5", "committedDate": "2020-09-30T17:44:23Z", "message": "Address nicks comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 82, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}