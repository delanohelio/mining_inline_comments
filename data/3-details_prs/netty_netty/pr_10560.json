{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzMzQ3OTU4", "number": 10560, "title": "Fix DeleteOnExitHook cause memory leak", "bodyText": "Motivation:\nIf DeleteOnExitHook is in the open state and the program runs for a long time, the DeleteOnExitHook file keeps increasing.\nThis results in a cause memory leak\n\nSee #10351\nModification:\nI re-customized a DeleteOnExitHook hook. If DeleteOnExitHook is turned on, this hook will be added when creating a temporary file. After the request ends and the corresponding resources are released, the current file will be removed from this hook, so that it will not increase all the time.\nResult:\nFixes #10351.", "createdAt": "2020-09-10T04:05:49Z", "url": "https://github.com/netty/netty/pull/10560", "merged": true, "mergeCommit": {"oid": "95ce1b95ea5679f826cdefcbaabb3b7c2d596100"}, "closed": true, "closedAt": "2020-09-15T14:38:42Z", "author": {"login": "wuxiansen"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8eWqxgH2gAyNDgzMzQ3OTU4OmRmMzQzMThjOTllZmYyNjcxZjhjYzc1ZTJlNmFmNGIwZWFhNjhlZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdIw3qKAFqTQ4NzYzMjIyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "df34318c99eff2671f8cc75e2e6af4b0eaa68ee2", "author": {"user": {"login": "wuxiansen", "name": "Kevin Wu"}}, "url": "https://github.com/netty/netty/commit/df34318c99eff2671f8cc75e2e6af4b0eaa68ee2", "committedDate": "2020-08-07T06:23:27Z", "message": "Fix https://github.com/netty/netty/issues/10434"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5d9498561c084f68e993a9f633d63b5e83a3afc", "author": {"user": {"login": "wuxiansen", "name": "Kevin Wu"}}, "url": "https://github.com/netty/netty/commit/f5d9498561c084f68e993a9f633d63b5e83a3afc", "committedDate": "2020-08-07T06:29:41Z", "message": "Fix https://github.com/netty/netty/issues/10434"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b", "author": {"user": {"login": "wuxiansen", "name": "Kevin Wu"}}, "url": "https://github.com/netty/netty/commit/96619d74d5604ec4080dd0b242e93310d643ff3b", "committedDate": "2020-09-10T03:20:26Z", "message": "Fix https://github.com/netty/netty/issues/10351"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NzI3MDYz", "url": "https://github.com/netty/netty/pull/10560#pullrequestreview-485727063", "createdAt": "2020-09-10T08:59:42Z", "commit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwODo1OTo0M1rOHPqBNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwOToyMzo1OVrOHPq9Dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE3OTEyNA==", "bodyText": "Use Collections.newSetFromMap(new ConcurrentHashMap<String,Boolean>()) instead. Then we can remove the synchronised in the add and remove methods bellow.", "url": "https://github.com/netty/netty/pull/10560#discussion_r486179124", "createdAt": "2020-09-10T08:59:43Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHook.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2012 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.util.internal.logging.InternalLogger;\n+import io.netty.util.internal.logging.InternalLoggerFactory;\n+\n+import java.io.File;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Extend {@link java.io.DeleteOnExitHook} to dynamically manipulate hook records.\n+ */\n+public final class DeleteFileOnExitHook {\n+    private static Set<String> files = new HashSet<String>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE3OTg5Nw==", "bodyText": "I'm not able to make sense of this comment. We don't actually extend that class.", "url": "https://github.com/netty/netty/pull/10560#discussion_r486179897", "createdAt": "2020-09-10T09:00:52Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHook.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2012 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.util.internal.logging.InternalLogger;\n+import io.netty.util.internal.logging.InternalLoggerFactory;\n+\n+import java.io.File;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Extend {@link java.io.DeleteOnExitHook} to dynamically manipulate hook records.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE4MDAxMA==", "bodyText": "Does this class really need to be public?", "url": "https://github.com/netty/netty/pull/10560#discussion_r486180010", "createdAt": "2020-09-10T09:01:03Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHook.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2012 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.util.internal.logging.InternalLogger;\n+import io.netty.util.internal.logging.InternalLoggerFactory;\n+\n+import java.io.File;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Extend {@link java.io.DeleteOnExitHook} to dynamically manipulate hook records.\n+ */\n+public final class DeleteFileOnExitHook {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE4NTkwOA==", "bodyText": "I don't think there's any exception that can happen here?", "url": "https://github.com/netty/netty/pull/10560#discussion_r486185908", "createdAt": "2020-09-10T09:10:19Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHook.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2012 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.util.internal.logging.InternalLogger;\n+import io.netty.util.internal.logging.InternalLoggerFactory;\n+\n+import java.io.File;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Extend {@link java.io.DeleteOnExitHook} to dynamically manipulate hook records.\n+ */\n+public final class DeleteFileOnExitHook {\n+    private static Set<String> files = new HashSet<String>();\n+    static final InternalLogger logger = InternalLoggerFactory.getInstance(DeleteFileOnExitHook.class);\n+\n+    private DeleteFileOnExitHook() {\n+    }\n+\n+    static {\n+        // DeleteOnExitHook must be the last shutdown hook to be invoked.\n+        // Application shutdown hooks may add the first file to the\n+        // delete on exit list and cause the DeleteOnExitHook to be\n+        // registered during shutdown in progress.\n+        Runtime.getRuntime().addShutdownHook(new Thread() {\n+\n+            @Override\n+            public void run() {\n+                runHooks();\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Remove from the pool to reduce space footprint.\n+     *\n+     * @param file tmp file path\n+     */\n+    public static synchronized void remove(String file) {\n+        try {\n+            if (files != null) {\n+                files.remove(file);\n+            }\n+        } catch (Exception e) {\n+            logger.warn(\"The cleanup file path failed.\", e);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE4Njk1MQ==", "bodyText": "With a Set based on ConcurrentHashMap, we can just iterate it directly. Since we are at JVM shut down at this point, I don't think we need to clear the set.", "url": "https://github.com/netty/netty/pull/10560#discussion_r486186951", "createdAt": "2020-09-10T09:11:58Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHook.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2012 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.util.internal.logging.InternalLogger;\n+import io.netty.util.internal.logging.InternalLoggerFactory;\n+\n+import java.io.File;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Extend {@link java.io.DeleteOnExitHook} to dynamically manipulate hook records.\n+ */\n+public final class DeleteFileOnExitHook {\n+    private static Set<String> files = new HashSet<String>();\n+    static final InternalLogger logger = InternalLoggerFactory.getInstance(DeleteFileOnExitHook.class);\n+\n+    private DeleteFileOnExitHook() {\n+    }\n+\n+    static {\n+        // DeleteOnExitHook must be the last shutdown hook to be invoked.\n+        // Application shutdown hooks may add the first file to the\n+        // delete on exit list and cause the DeleteOnExitHook to be\n+        // registered during shutdown in progress.\n+        Runtime.getRuntime().addShutdownHook(new Thread() {\n+\n+            @Override\n+            public void run() {\n+                runHooks();\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Remove from the pool to reduce space footprint.\n+     *\n+     * @param file tmp file path\n+     */\n+    public static synchronized void remove(String file) {\n+        try {\n+            if (files != null) {\n+                files.remove(file);\n+            }\n+        } catch (Exception e) {\n+            logger.warn(\"The cleanup file path failed.\", e);\n+        }\n+    }\n+\n+    /**\n+     * Add to the hook and clean up when the program exits.\n+     *\n+     * @param file tmp file path\n+     */\n+    public static synchronized void add(String file) {\n+        if (files == null) {\n+            files = new HashSet<String>();\n+        }\n+\n+        files.add(file);\n+    }\n+\n+    static void runHooks() {\n+        Set<String> toBeDeleted;\n+\n+        synchronized (DeleteFileOnExitHook.class) {\n+            toBeDeleted = files;\n+            files = null;\n+        }\n+\n+        if (!toBeDeleted.isEmpty()) {\n+            for (String filename : toBeDeleted) {\n+                (new File(filename)).delete();\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE4NzcwMw==", "bodyText": "Remove comment.", "url": "https://github.com/netty/netty/pull/10560#discussion_r486187703", "createdAt": "2020-09-10T09:13:09Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHookTest.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2017 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.buffer.Unpooled;\n+import io.netty.handler.codec.http.DefaultHttpRequest;\n+import io.netty.handler.codec.http.HttpRequest;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+import static io.netty.handler.codec.http.HttpMethod.POST;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Test DeleteFileOnExitHook\n+ */\n+public class DeleteFileOnExitHookTest {\n+    private static final HttpRequest req1 = new DefaultHttpRequest(HTTP_1_1, POST, \"/form\");\n+\n+    @Test\n+    public void customBaseDirAndDeleteOnHookExit() throws IOException {\n+        final DefaultHttpDataFactory defaultHttpDataFactory = new DefaultHttpDataFactory(true);\n+        final String dir = \"target/DeleteFileOnExitHookTest/customBaseDirAndDeleteOnHookExit\";\n+        File baseDir = new File(dir);\n+        baseDir.mkdirs();  // we don't need to clean it since it is in volatile files anyway\n+\n+        defaultHttpDataFactory.setBaseDir(dir);\n+        defaultHttpDataFactory.setDeleteOnExit(true);\n+        final Attribute attr = defaultHttpDataFactory.createAttribute(req1, \"attribute1\");\n+        final FileUpload fu = defaultHttpDataFactory.createFileUpload(\n+                req1, \"attribute1\", \"tmp_f.txt\", \"text/plain\", null, null, 0);\n+        //DeleteFileOnExitHook.add(new File(dir, fu.getFilename()).getAbsolutePath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE4ODIxMA==", "bodyText": "Easier to do the casts at variable declaration site.", "url": "https://github.com/netty/netty/pull/10560#discussion_r486188210", "createdAt": "2020-09-10T09:13:59Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHookTest.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2017 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.buffer.Unpooled;\n+import io.netty.handler.codec.http.DefaultHttpRequest;\n+import io.netty.handler.codec.http.HttpRequest;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+import static io.netty.handler.codec.http.HttpMethod.POST;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Test DeleteFileOnExitHook\n+ */\n+public class DeleteFileOnExitHookTest {\n+    private static final HttpRequest req1 = new DefaultHttpRequest(HTTP_1_1, POST, \"/form\");\n+\n+    @Test\n+    public void customBaseDirAndDeleteOnHookExit() throws IOException {\n+        final DefaultHttpDataFactory defaultHttpDataFactory = new DefaultHttpDataFactory(true);\n+        final String dir = \"target/DeleteFileOnExitHookTest/customBaseDirAndDeleteOnHookExit\";\n+        File baseDir = new File(dir);\n+        baseDir.mkdirs();  // we don't need to clean it since it is in volatile files anyway\n+\n+        defaultHttpDataFactory.setBaseDir(dir);\n+        defaultHttpDataFactory.setDeleteOnExit(true);\n+        final Attribute attr = defaultHttpDataFactory.createAttribute(req1, \"attribute1\");\n+        final FileUpload fu = defaultHttpDataFactory.createFileUpload(\n+                req1, \"attribute1\", \"tmp_f.txt\", \"text/plain\", null, null, 0);\n+        //DeleteFileOnExitHook.add(new File(dir, fu.getFilename()).getAbsolutePath());\n+\n+        assertEquals(dir, DiskAttribute.class.cast(attr).getBaseDirectory());\n+        assertEquals(dir, DiskFileUpload.class.cast(fu).getBaseDirectory());\n+        assertTrue(DiskAttribute.class.cast(attr).deleteOnExit());\n+        assertTrue(DiskFileUpload.class.cast(fu).deleteOnExit());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE4OTQxOA==", "bodyText": "What behaviour are we trying to verify?", "url": "https://github.com/netty/netty/pull/10560#discussion_r486189418", "createdAt": "2020-09-10T09:15:51Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHookTest.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2017 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.buffer.Unpooled;\n+import io.netty.handler.codec.http.DefaultHttpRequest;\n+import io.netty.handler.codec.http.HttpRequest;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+import static io.netty.handler.codec.http.HttpMethod.POST;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Test DeleteFileOnExitHook\n+ */\n+public class DeleteFileOnExitHookTest {\n+    private static final HttpRequest req1 = new DefaultHttpRequest(HTTP_1_1, POST, \"/form\");\n+\n+    @Test\n+    public void customBaseDirAndDeleteOnHookExit() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE5MDczMg==", "bodyText": "Remove comment.", "url": "https://github.com/netty/netty/pull/10560#discussion_r486190732", "createdAt": "2020-09-10T09:18:00Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHookTest.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2017 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.buffer.Unpooled;\n+import io.netty.handler.codec.http.DefaultHttpRequest;\n+import io.netty.handler.codec.http.HttpRequest;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+import static io.netty.handler.codec.http.HttpMethod.POST;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Test DeleteFileOnExitHook\n+ */\n+public class DeleteFileOnExitHookTest {\n+    private static final HttpRequest req1 = new DefaultHttpRequest(HTTP_1_1, POST, \"/form\");\n+\n+    @Test\n+    public void customBaseDirAndDeleteOnHookExit() throws IOException {\n+        final DefaultHttpDataFactory defaultHttpDataFactory = new DefaultHttpDataFactory(true);\n+        final String dir = \"target/DeleteFileOnExitHookTest/customBaseDirAndDeleteOnHookExit\";\n+        File baseDir = new File(dir);\n+        baseDir.mkdirs();  // we don't need to clean it since it is in volatile files anyway\n+\n+        defaultHttpDataFactory.setBaseDir(dir);\n+        defaultHttpDataFactory.setDeleteOnExit(true);\n+        final Attribute attr = defaultHttpDataFactory.createAttribute(req1, \"attribute1\");\n+        final FileUpload fu = defaultHttpDataFactory.createFileUpload(\n+                req1, \"attribute1\", \"tmp_f.txt\", \"text/plain\", null, null, 0);\n+        //DeleteFileOnExitHook.add(new File(dir, fu.getFilename()).getAbsolutePath());\n+\n+        assertEquals(dir, DiskAttribute.class.cast(attr).getBaseDirectory());\n+        assertEquals(dir, DiskFileUpload.class.cast(fu).getBaseDirectory());\n+        assertTrue(DiskAttribute.class.cast(attr).deleteOnExit());\n+        assertTrue(DiskFileUpload.class.cast(fu).deleteOnExit());\n+\n+        fu.setContent(Unpooled.wrappedBuffer(new byte[]{1, 2, 3, 4}));\n+        assertTrue(fu.getFile().exists());\n+        //fu.delete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE5MjYwNA==", "bodyText": "Why is the length zero when we set 4 bytes of content?", "url": "https://github.com/netty/netty/pull/10560#discussion_r486192604", "createdAt": "2020-09-10T09:21:01Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHookTest.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2017 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.buffer.Unpooled;\n+import io.netty.handler.codec.http.DefaultHttpRequest;\n+import io.netty.handler.codec.http.HttpRequest;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+import static io.netty.handler.codec.http.HttpMethod.POST;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Test DeleteFileOnExitHook\n+ */\n+public class DeleteFileOnExitHookTest {\n+    private static final HttpRequest req1 = new DefaultHttpRequest(HTTP_1_1, POST, \"/form\");\n+\n+    @Test\n+    public void customBaseDirAndDeleteOnHookExit() throws IOException {\n+        final DefaultHttpDataFactory defaultHttpDataFactory = new DefaultHttpDataFactory(true);\n+        final String dir = \"target/DeleteFileOnExitHookTest/customBaseDirAndDeleteOnHookExit\";\n+        File baseDir = new File(dir);\n+        baseDir.mkdirs();  // we don't need to clean it since it is in volatile files anyway\n+\n+        defaultHttpDataFactory.setBaseDir(dir);\n+        defaultHttpDataFactory.setDeleteOnExit(true);\n+        final Attribute attr = defaultHttpDataFactory.createAttribute(req1, \"attribute1\");\n+        final FileUpload fu = defaultHttpDataFactory.createFileUpload(\n+                req1, \"attribute1\", \"tmp_f.txt\", \"text/plain\", null, null, 0);\n+        //DeleteFileOnExitHook.add(new File(dir, fu.getFilename()).getAbsolutePath());\n+\n+        assertEquals(dir, DiskAttribute.class.cast(attr).getBaseDirectory());\n+        assertEquals(dir, DiskFileUpload.class.cast(fu).getBaseDirectory());\n+        assertTrue(DiskAttribute.class.cast(attr).deleteOnExit());\n+        assertTrue(DiskFileUpload.class.cast(fu).deleteOnExit());\n+\n+        fu.setContent(Unpooled.wrappedBuffer(new byte[]{1, 2, 3, 4}));\n+        assertTrue(fu.getFile().exists());\n+        //fu.delete();\n+\n+        assertEquals(0, fu.getFile().length());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE5MzMyNg==", "bodyText": "Remove comment. Also, we should verify that the file no longer exists, and that it's pathname is no longer in the set of files to delete on shut down.", "url": "https://github.com/netty/netty/pull/10560#discussion_r486193326", "createdAt": "2020-09-10T09:22:12Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHookTest.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2017 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.buffer.Unpooled;\n+import io.netty.handler.codec.http.DefaultHttpRequest;\n+import io.netty.handler.codec.http.HttpRequest;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+import static io.netty.handler.codec.http.HttpMethod.POST;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Test DeleteFileOnExitHook\n+ */\n+public class DeleteFileOnExitHookTest {\n+    private static final HttpRequest req1 = new DefaultHttpRequest(HTTP_1_1, POST, \"/form\");\n+\n+    @Test\n+    public void customBaseDirAndDeleteOnHookExit() throws IOException {\n+        final DefaultHttpDataFactory defaultHttpDataFactory = new DefaultHttpDataFactory(true);\n+        final String dir = \"target/DeleteFileOnExitHookTest/customBaseDirAndDeleteOnHookExit\";\n+        File baseDir = new File(dir);\n+        baseDir.mkdirs();  // we don't need to clean it since it is in volatile files anyway\n+\n+        defaultHttpDataFactory.setBaseDir(dir);\n+        defaultHttpDataFactory.setDeleteOnExit(true);\n+        final Attribute attr = defaultHttpDataFactory.createAttribute(req1, \"attribute1\");\n+        final FileUpload fu = defaultHttpDataFactory.createFileUpload(\n+                req1, \"attribute1\", \"tmp_f.txt\", \"text/plain\", null, null, 0);\n+        //DeleteFileOnExitHook.add(new File(dir, fu.getFilename()).getAbsolutePath());\n+\n+        assertEquals(dir, DiskAttribute.class.cast(attr).getBaseDirectory());\n+        assertEquals(dir, DiskFileUpload.class.cast(fu).getBaseDirectory());\n+        assertTrue(DiskAttribute.class.cast(attr).deleteOnExit());\n+        assertTrue(DiskFileUpload.class.cast(fu).deleteOnExit());\n+\n+        fu.setContent(Unpooled.wrappedBuffer(new byte[]{1, 2, 3, 4}));\n+        assertTrue(fu.getFile().exists());\n+        //fu.delete();\n+\n+        assertEquals(0, fu.getFile().length());\n+        fu.delete();\n+        //fu.release();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE5NDQ0Nw==", "bodyText": "We should also have a test that verifies that the registered files are deleted by the shut down hook.", "url": "https://github.com/netty/netty/pull/10560#discussion_r486194447", "createdAt": "2020-09-10T09:23:59Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHookTest.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2017 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.buffer.Unpooled;\n+import io.netty.handler.codec.http.DefaultHttpRequest;\n+import io.netty.handler.codec.http.HttpRequest;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+import static io.netty.handler.codec.http.HttpMethod.POST;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Test DeleteFileOnExitHook\n+ */\n+public class DeleteFileOnExitHookTest {\n+    private static final HttpRequest req1 = new DefaultHttpRequest(HTTP_1_1, POST, \"/form\");\n+\n+    @Test\n+    public void customBaseDirAndDeleteOnHookExit() throws IOException {\n+        final DefaultHttpDataFactory defaultHttpDataFactory = new DefaultHttpDataFactory(true);\n+        final String dir = \"target/DeleteFileOnExitHookTest/customBaseDirAndDeleteOnHookExit\";\n+        File baseDir = new File(dir);\n+        baseDir.mkdirs();  // we don't need to clean it since it is in volatile files anyway\n+\n+        defaultHttpDataFactory.setBaseDir(dir);\n+        defaultHttpDataFactory.setDeleteOnExit(true);\n+        final Attribute attr = defaultHttpDataFactory.createAttribute(req1, \"attribute1\");\n+        final FileUpload fu = defaultHttpDataFactory.createFileUpload(\n+                req1, \"attribute1\", \"tmp_f.txt\", \"text/plain\", null, null, 0);\n+        //DeleteFileOnExitHook.add(new File(dir, fu.getFilename()).getAbsolutePath());\n+\n+        assertEquals(dir, DiskAttribute.class.cast(attr).getBaseDirectory());\n+        assertEquals(dir, DiskFileUpload.class.cast(fu).getBaseDirectory());\n+        assertTrue(DiskAttribute.class.cast(attr).deleteOnExit());\n+        assertTrue(DiskFileUpload.class.cast(fu).deleteOnExit());\n+\n+        fu.setContent(Unpooled.wrappedBuffer(new byte[]{1, 2, 3, 4}));\n+        assertTrue(fu.getFile().exists());\n+        //fu.delete();\n+\n+        assertEquals(0, fu.getFile().length());\n+        fu.delete();\n+        //fu.release();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1ODU2NzIx", "url": "https://github.com/netty/netty/pull/10560#pullrequestreview-485856721", "createdAt": "2020-09-10T12:01:18Z", "commit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMjowMToxOFrOHPwNgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMjowNDowMlrOHPwS5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI4MDU3Nw==", "bodyText": "nit: 2020", "url": "https://github.com/netty/netty/pull/10560#discussion_r486280577", "createdAt": "2020-09-10T12:01:18Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHook.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2012 The Netty Project", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI4MDcwNA==", "bodyText": "please declare it package-private", "url": "https://github.com/netty/netty/pull/10560#discussion_r486280704", "createdAt": "2020-09-10T12:01:33Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHook.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2012 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.util.internal.logging.InternalLogger;\n+import io.netty.util.internal.logging.InternalLoggerFactory;\n+\n+import java.io.File;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Extend {@link java.io.DeleteOnExitHook} to dynamically manipulate hook records.\n+ */\n+public final class DeleteFileOnExitHook {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE4MDAxMA=="}, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI4MTE2OQ==", "bodyText": "I agree with @chrisvest here..", "url": "https://github.com/netty/netty/pull/10560#discussion_r486281169", "createdAt": "2020-09-10T12:02:23Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHook.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2012 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.util.internal.logging.InternalLogger;\n+import io.netty.util.internal.logging.InternalLoggerFactory;\n+\n+import java.io.File;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Extend {@link java.io.DeleteOnExitHook} to dynamically manipulate hook records.\n+ */\n+public final class DeleteFileOnExitHook {\n+    private static Set<String> files = new HashSet<String>();\n+    static final InternalLogger logger = InternalLoggerFactory.getInstance(DeleteFileOnExitHook.class);\n+\n+    private DeleteFileOnExitHook() {\n+    }\n+\n+    static {\n+        // DeleteOnExitHook must be the last shutdown hook to be invoked.\n+        // Application shutdown hooks may add the first file to the\n+        // delete on exit list and cause the DeleteOnExitHook to be\n+        // registered during shutdown in progress.\n+        Runtime.getRuntime().addShutdownHook(new Thread() {\n+\n+            @Override\n+            public void run() {\n+                runHooks();\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Remove from the pool to reduce space footprint.\n+     *\n+     * @param file tmp file path\n+     */\n+    public static synchronized void remove(String file) {\n+        try {\n+            if (files != null) {\n+                files.remove(file);\n+            }\n+        } catch (Exception e) {\n+            logger.warn(\"The cleanup file path failed.\", e);\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE4NTkwOA=="}, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI4MTQyNg==", "bodyText": "2020", "url": "https://github.com/netty/netty/pull/10560#discussion_r486281426", "createdAt": "2020-09-10T12:02:55Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHookTest.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2017 The Netty Project", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI4MTg3Nw==", "bodyText": "This change doesn't seem to be related to this pr ... please revert", "url": "https://github.com/netty/netty/pull/10560#discussion_r486281877", "createdAt": "2020-09-10T12:03:51Z", "author": {"login": "normanmaurer"}, "path": "transport/src/main/java/io/netty/channel/oio/AbstractOioByteChannel.java", "diffHunk": "@@ -93,7 +93,10 @@ private void handleReadException(ChannelPipeline pipeline, ByteBuf byteBuf, Thro\n         allocHandle.readComplete();\n         pipeline.fireChannelReadComplete();\n         pipeline.fireExceptionCaught(cause);\n-        if (close || cause instanceof IOException) {\n+\n+        // If oom will close the read event, release connection.\n+        // See https://github.com/netty/netty/issues/10434\n+        if (close || cause instanceof OutOfMemoryError || cause instanceof IOException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI4MTg5Nw==", "bodyText": "This change doesn't seem to be related to this pr ... please revert", "url": "https://github.com/netty/netty/pull/10560#discussion_r486281897", "createdAt": "2020-09-10T12:03:55Z", "author": {"login": "normanmaurer"}, "path": "transport/src/main/java/io/netty/channel/nio/AbstractNioByteChannel.java", "diffHunk": "@@ -123,7 +123,10 @@ private void handleReadException(ChannelPipeline pipeline, ByteBuf byteBuf, Thro\n             allocHandle.readComplete();\n             pipeline.fireChannelReadComplete();\n             pipeline.fireExceptionCaught(cause);\n-            if (close || cause instanceof IOException) {\n+\n+            // If oom will close the read event, release connection.\n+            // See https://github.com/netty/netty/issues/10434\n+            if (close || cause instanceof OutOfMemoryError || cause instanceof IOException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI4MTkyOQ==", "bodyText": "This change doesn't seem to be related to this pr ... please revert", "url": "https://github.com/netty/netty/pull/10560#discussion_r486281929", "createdAt": "2020-09-10T12:03:59Z", "author": {"login": "normanmaurer"}, "path": "transport-native-kqueue/src/main/java/io/netty/channel/kqueue/AbstractKQueueStreamChannel.java", "diffHunk": "@@ -587,7 +587,10 @@ private void handleReadException(ChannelPipeline pipeline, ByteBuf byteBuf, Thro\n                 allocHandle.readComplete();\n                 pipeline.fireChannelReadComplete();\n                 pipeline.fireExceptionCaught(cause);\n-                if (close || cause instanceof IOException) {\n+\n+                // If oom will close the read event, release connection.\n+                // See https://github.com/netty/netty/issues/10434\n+                if (close || cause instanceof OutOfMemoryError || cause instanceof IOException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI4MTk1Nw==", "bodyText": "This change doesn't seem to be related to this pr ... please revert", "url": "https://github.com/netty/netty/pull/10560#discussion_r486281957", "createdAt": "2020-09-10T12:04:02Z", "author": {"login": "normanmaurer"}, "path": "transport-native-epoll/src/main/java/io/netty/channel/epoll/AbstractEpollStreamChannel.java", "diffHunk": "@@ -726,7 +726,10 @@ private void handleReadException(ChannelPipeline pipeline, ByteBuf byteBuf, Thro\n             allocHandle.readComplete();\n             pipeline.fireChannelReadComplete();\n             pipeline.fireExceptionCaught(cause);\n-            if (close || cause instanceof IOException) {\n+\n+            // If oom will close the read event, release connection.\n+            // See https://github.com/netty/netty/issues/10434\n+            if (close || cause instanceof OutOfMemoryError || cause instanceof IOException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96619d74d5604ec4080dd0b242e93310d643ff3b"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99035cd2434d4ef50712de26042816123f67eb5c", "author": {"user": {"login": "wuxiansen", "name": "Kevin Wu"}}, "url": "https://github.com/netty/netty/commit/99035cd2434d4ef50712de26042816123f67eb5c", "committedDate": "2020-09-10T12:28:01Z", "message": "revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "015eba3348d2f89b84793a03d25bd9cab6894791", "author": {"user": {"login": "wuxiansen", "name": "Kevin Wu"}}, "url": "https://github.com/netty/netty/commit/015eba3348d2f89b84793a03d25bd9cab6894791", "committedDate": "2020-09-10T12:41:09Z", "message": "Optimized code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6a4a30daa899645b6e981b7bad46c649b320ffc", "author": {"user": {"login": "wuxiansen", "name": "Kevin Wu"}}, "url": "https://github.com/netty/netty/commit/e6a4a30daa899645b6e981b7bad46c649b320ffc", "committedDate": "2020-09-10T12:55:20Z", "message": "revert"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MDAzNzgy", "url": "https://github.com/netty/netty/pull/10560#pullrequestreview-486003782", "createdAt": "2020-09-10T14:36:35Z", "commit": {"oid": "e6a4a30daa899645b6e981b7bad46c649b320ffc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDozNjozNVrOHP3PJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDozNjozNVrOHP3PJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM5NTY4NA==", "bodyText": "nit remove empty line", "url": "https://github.com/netty/netty/pull/10560#discussion_r486395684", "createdAt": "2020-09-10T14:36:35Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHook.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import java.io.File;\n+import java.util.Collections;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * DeleteFileOnExitHook.\n+ */\n+final class DeleteFileOnExitHook {\n+    private final static Set<String> FILES = Collections.newSetFromMap(new ConcurrentHashMap<String, Boolean>());\n+\n+    private DeleteFileOnExitHook() {\n+    }\n+\n+    static {\n+        // DeleteOnExitHook must be the last shutdown hook to be invoked.\n+        // Application shutdown hooks may add the first file to the\n+        // delete on exit list and cause the DeleteOnExitHook to be\n+        // registered during shutdown in progress.\n+        Runtime.getRuntime().addShutdownHook(new Thread() {\n+\n+            @Override\n+            public void run() {\n+                runHooks();\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Remove from the pool to reduce space footprint.\n+     *\n+     * @param file tmp file path\n+     */\n+    public static void remove(String file) {\n+        FILES.remove(file);\n+    }\n+\n+    /**\n+     * Add to the hook and clean up when the program exits.\n+     *\n+     * @param file tmp file path\n+     */\n+    public static void add(String file) {\n+        FILES.add(file);\n+    }\n+\n+    /**\n+     * check in records.\n+     *\n+     * @param file target file\n+     * @return true or false\n+     */\n+    public static boolean checkFileExist(String file) {\n+        return FILES.contains(file);\n+    }\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6a4a30daa899645b6e981b7bad46c649b320ffc"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MDA0MTYz", "url": "https://github.com/netty/netty/pull/10560#pullrequestreview-486004163", "createdAt": "2020-09-10T14:36:59Z", "commit": {"oid": "e6a4a30daa899645b6e981b7bad46c649b320ffc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDozNjo1OVrOHP3QXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDozNzowOFrOHP3Qzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM5NTk5OA==", "bodyText": "remove outer ()", "url": "https://github.com/netty/netty/pull/10560#discussion_r486395998", "createdAt": "2020-09-10T14:36:59Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHook.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import java.io.File;\n+import java.util.Collections;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * DeleteFileOnExitHook.\n+ */\n+final class DeleteFileOnExitHook {\n+    private final static Set<String> FILES = Collections.newSetFromMap(new ConcurrentHashMap<String, Boolean>());\n+\n+    private DeleteFileOnExitHook() {\n+    }\n+\n+    static {\n+        // DeleteOnExitHook must be the last shutdown hook to be invoked.\n+        // Application shutdown hooks may add the first file to the\n+        // delete on exit list and cause the DeleteOnExitHook to be\n+        // registered during shutdown in progress.\n+        Runtime.getRuntime().addShutdownHook(new Thread() {\n+\n+            @Override\n+            public void run() {\n+                runHooks();\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Remove from the pool to reduce space footprint.\n+     *\n+     * @param file tmp file path\n+     */\n+    public static void remove(String file) {\n+        FILES.remove(file);\n+    }\n+\n+    /**\n+     * Add to the hook and clean up when the program exits.\n+     *\n+     * @param file tmp file path\n+     */\n+    public static void add(String file) {\n+        FILES.add(file);\n+    }\n+\n+    /**\n+     * check in records.\n+     *\n+     * @param file target file\n+     * @return true or false\n+     */\n+    public static boolean checkFileExist(String file) {\n+        return FILES.contains(file);\n+    }\n+\n+\n+    static void runHooks() {\n+        for (String filename : FILES) {\n+            (new File(filename)).delete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6a4a30daa899645b6e981b7bad46c649b320ffc"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM5NjExMA==", "bodyText": "private ?", "url": "https://github.com/netty/netty/pull/10560#discussion_r486396110", "createdAt": "2020-09-10T14:37:08Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHookTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.buffer.Unpooled;\n+import io.netty.handler.codec.http.DefaultHttpRequest;\n+import io.netty.handler.codec.http.HttpRequest;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.FilenameFilter;\n+import java.io.IOException;\n+\n+import static io.netty.handler.codec.http.HttpMethod.POST;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+import static org.junit.Assert.*;\n+\n+/**\n+ * Test DeleteFileOnExitHook\n+ */\n+public class DeleteFileOnExitHookTest {\n+    private static final HttpRequest req1 = new DefaultHttpRequest(HTTP_1_1, POST, \"/form\");\n+    final String dir = \"target/DeleteFileOnExitHookTest/tmp\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6a4a30daa899645b6e981b7bad46c649b320ffc"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "929465d49b3818d900893dbc6749501065eb9282", "author": {"user": {"login": "wuxiansen", "name": "Kevin Wu"}}, "url": "https://github.com/netty/netty/commit/929465d49b3818d900893dbc6749501065eb9282", "committedDate": "2020-09-11T01:56:41Z", "message": "Optimized code."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NjEwNDgx", "url": "https://github.com/netty/netty/pull/10560#pullrequestreview-486610481", "createdAt": "2020-09-11T08:44:14Z", "commit": {"oid": "929465d49b3818d900893dbc6749501065eb9282"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwODo0NDoxNFrOHQT-RQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwODo1MDoxOFrOHQULqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg2NjUwMQ==", "bodyText": "Nit: make sure files end with a line-break.", "url": "https://github.com/netty/netty/pull/10560#discussion_r486866501", "createdAt": "2020-09-11T08:44:14Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHook.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import java.io.File;\n+import java.util.Collections;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * DeleteFileOnExitHook.\n+ */\n+final class DeleteFileOnExitHook {\n+    private static final Set<String> FILES = Collections.newSetFromMap(new ConcurrentHashMap<String, Boolean>());\n+\n+    private DeleteFileOnExitHook() {\n+    }\n+\n+    static {\n+        // DeleteOnExitHook must be the last shutdown hook to be invoked.\n+        // Application shutdown hooks may add the first file to the\n+        // delete on exit list and cause the DeleteOnExitHook to be\n+        // registered during shutdown in progress.\n+        Runtime.getRuntime().addShutdownHook(new Thread() {\n+\n+            @Override\n+            public void run() {\n+                runHooks();\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Remove from the pool to reduce space footprint.\n+     *\n+     * @param file tmp file path\n+     */\n+    public static void remove(String file) {\n+        FILES.remove(file);\n+    }\n+\n+    /**\n+     * Add to the hook and clean up when the program exits.\n+     *\n+     * @param file tmp file path\n+     */\n+    public static void add(String file) {\n+        FILES.add(file);\n+    }\n+\n+    /**\n+     * Check in the hook files.\n+     *\n+     * @param file target file\n+     * @return true or false\n+     */\n+    public static boolean checkFileExist(String file) {\n+        return FILES.contains(file);\n+    }\n+\n+    /**\n+     * Clean up all the files.\n+     */\n+    private static void runHooks() {\n+        for (String filename : FILES) {\n+            new File(filename).delete();\n+        }\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "929465d49b3818d900893dbc6749501065eb9282"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg2NzUxOQ==", "bodyText": "Nit: another line break, please.", "url": "https://github.com/netty/netty/pull/10560#discussion_r486867519", "createdAt": "2020-09-11T08:45:58Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHookTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.buffer.Unpooled;\n+import io.netty.handler.codec.http.DefaultHttpRequest;\n+import io.netty.handler.codec.http.HttpRequest;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.FilenameFilter;\n+import java.io.IOException;\n+\n+import static io.netty.handler.codec.http.HttpMethod.POST;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+import static org.junit.Assert.*;\n+\n+/**\n+ * Test DeleteFileOnExitHook\n+ */\n+public class DeleteFileOnExitHookTest {\n+    private static final HttpRequest REQUEST = new DefaultHttpRequest(HTTP_1_1, POST, \"/form\");\n+    private static final String HOOK_TEST_TMP = \"target/DeleteFileOnExitHookTest/tmp\";\n+\n+    @Test\n+    public void testTriggerDeleteFileOnExitHook() throws IOException {\n+        final DefaultHttpDataFactory defaultHttpDataFactory = new DefaultHttpDataFactory(true);\n+        File baseDir = new File(HOOK_TEST_TMP);\n+        baseDir.mkdirs();  // we don't need to clean it since it is in volatile files anyway\n+\n+        defaultHttpDataFactory.setBaseDir(HOOK_TEST_TMP);\n+        defaultHttpDataFactory.setDeleteOnExit(true);\n+        final FileUpload fu = defaultHttpDataFactory.createFileUpload(\n+                REQUEST, \"attribute1\", \"tmp_f.txt\", \"text/plain\", null, null, 0);\n+\n+        fu.setContent(Unpooled.wrappedBuffer(new byte[]{1, 2, 3, 4}));\n+        assertTrue(fu.getFile().exists());\n+    }\n+\n+    @Test\n+    public void testDeleteFileOnExitHookExecutionSuccessful() {\n+        File[] files = new File(HOOK_TEST_TMP).listFiles(new FilenameFilter() {\n+            @Override\n+            public boolean accept(File dir, String name) {\n+                return name.startsWith(DiskFileUpload.prefix);\n+            }\n+        });\n+\n+        assertEquals(0, files.length);\n+    }\n+\n+    @Test\n+    public void testAfterHttpDataReleaseCheckFileExist() throws IOException {\n+        final DefaultHttpDataFactory defaultHttpDataFactory = new DefaultHttpDataFactory(true);\n+        File baseDir = new File(HOOK_TEST_TMP);\n+        baseDir.mkdirs();  // we don't need to clean it since it is in volatile files anyway\n+\n+        defaultHttpDataFactory.setBaseDir(HOOK_TEST_TMP);\n+        defaultHttpDataFactory.setDeleteOnExit(true);\n+        final FileUpload fu = defaultHttpDataFactory.createFileUpload(\n+                REQUEST, \"attribute1\", \"tmp_f.txt\", \"text/plain\", null, null, 0);\n+\n+        fu.setContent(Unpooled.wrappedBuffer(new byte[]{1, 2, 3, 4}));\n+        assertTrue(fu.getFile().exists());\n+\n+        String filePath = fu.getFile().getPath();\n+        assertTrue(DeleteFileOnExitHook.checkFileExist(filePath));\n+\n+        fu.release();\n+        assertFalse(DeleteFileOnExitHook.checkFileExist(filePath));\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "929465d49b3818d900893dbc6749501065eb9282"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg2ODczMA==", "bodyText": "Tests don't run in any particular order, so this test also needs to do the work to ensure that some file uploads are created. It can then call runHooks directly (since it has package visibility) to simulate the shutdown.", "url": "https://github.com/netty/netty/pull/10560#discussion_r486868730", "createdAt": "2020-09-11T08:48:12Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHookTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.buffer.Unpooled;\n+import io.netty.handler.codec.http.DefaultHttpRequest;\n+import io.netty.handler.codec.http.HttpRequest;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.FilenameFilter;\n+import java.io.IOException;\n+\n+import static io.netty.handler.codec.http.HttpMethod.POST;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+import static org.junit.Assert.*;\n+\n+/**\n+ * Test DeleteFileOnExitHook\n+ */\n+public class DeleteFileOnExitHookTest {\n+    private static final HttpRequest REQUEST = new DefaultHttpRequest(HTTP_1_1, POST, \"/form\");\n+    private static final String HOOK_TEST_TMP = \"target/DeleteFileOnExitHookTest/tmp\";\n+\n+    @Test\n+    public void testTriggerDeleteFileOnExitHook() throws IOException {\n+        final DefaultHttpDataFactory defaultHttpDataFactory = new DefaultHttpDataFactory(true);\n+        File baseDir = new File(HOOK_TEST_TMP);\n+        baseDir.mkdirs();  // we don't need to clean it since it is in volatile files anyway\n+\n+        defaultHttpDataFactory.setBaseDir(HOOK_TEST_TMP);\n+        defaultHttpDataFactory.setDeleteOnExit(true);\n+        final FileUpload fu = defaultHttpDataFactory.createFileUpload(\n+                REQUEST, \"attribute1\", \"tmp_f.txt\", \"text/plain\", null, null, 0);\n+\n+        fu.setContent(Unpooled.wrappedBuffer(new byte[]{1, 2, 3, 4}));\n+        assertTrue(fu.getFile().exists());\n+    }\n+\n+    @Test\n+    public void testDeleteFileOnExitHookExecutionSuccessful() {\n+        File[] files = new File(HOOK_TEST_TMP).listFiles(new FilenameFilter() {\n+            @Override\n+            public boolean accept(File dir, String name) {\n+                return name.startsWith(DiskFileUpload.prefix);\n+            }\n+        });\n+\n+        assertEquals(0, files.length);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "929465d49b3818d900893dbc6749501065eb9282"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg2OTc0NQ==", "bodyText": "This set-up work could be extracted to a test helper method.", "url": "https://github.com/netty/netty/pull/10560#discussion_r486869745", "createdAt": "2020-09-11T08:49:59Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHookTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.buffer.Unpooled;\n+import io.netty.handler.codec.http.DefaultHttpRequest;\n+import io.netty.handler.codec.http.HttpRequest;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.FilenameFilter;\n+import java.io.IOException;\n+\n+import static io.netty.handler.codec.http.HttpMethod.POST;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+import static org.junit.Assert.*;\n+\n+/**\n+ * Test DeleteFileOnExitHook\n+ */\n+public class DeleteFileOnExitHookTest {\n+    private static final HttpRequest REQUEST = new DefaultHttpRequest(HTTP_1_1, POST, \"/form\");\n+    private static final String HOOK_TEST_TMP = \"target/DeleteFileOnExitHookTest/tmp\";\n+\n+    @Test\n+    public void testTriggerDeleteFileOnExitHook() throws IOException {\n+        final DefaultHttpDataFactory defaultHttpDataFactory = new DefaultHttpDataFactory(true);\n+        File baseDir = new File(HOOK_TEST_TMP);\n+        baseDir.mkdirs();  // we don't need to clean it since it is in volatile files anyway\n+\n+        defaultHttpDataFactory.setBaseDir(HOOK_TEST_TMP);\n+        defaultHttpDataFactory.setDeleteOnExit(true);\n+        final FileUpload fu = defaultHttpDataFactory.createFileUpload(\n+                REQUEST, \"attribute1\", \"tmp_f.txt\", \"text/plain\", null, null, 0);\n+\n+        fu.setContent(Unpooled.wrappedBuffer(new byte[]{1, 2, 3, 4}));\n+        assertTrue(fu.getFile().exists());\n+    }\n+\n+    @Test\n+    public void testDeleteFileOnExitHookExecutionSuccessful() {\n+        File[] files = new File(HOOK_TEST_TMP).listFiles(new FilenameFilter() {\n+            @Override\n+            public boolean accept(File dir, String name) {\n+                return name.startsWith(DiskFileUpload.prefix);\n+            }\n+        });\n+\n+        assertEquals(0, files.length);\n+    }\n+\n+    @Test\n+    public void testAfterHttpDataReleaseCheckFileExist() throws IOException {\n+        final DefaultHttpDataFactory defaultHttpDataFactory = new DefaultHttpDataFactory(true);\n+        File baseDir = new File(HOOK_TEST_TMP);\n+        baseDir.mkdirs();  // we don't need to clean it since it is in volatile files anyway\n+\n+        defaultHttpDataFactory.setBaseDir(HOOK_TEST_TMP);\n+        defaultHttpDataFactory.setDeleteOnExit(true);\n+        final FileUpload fu = defaultHttpDataFactory.createFileUpload(\n+                REQUEST, \"attribute1\", \"tmp_f.txt\", \"text/plain\", null, null, 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "929465d49b3818d900893dbc6749501065eb9282"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg2OTkzMA==", "bodyText": "This variable doesn't need to be final.", "url": "https://github.com/netty/netty/pull/10560#discussion_r486869930", "createdAt": "2020-09-11T08:50:18Z", "author": {"login": "chrisvest"}, "path": "codec-http/src/test/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHookTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import io.netty.buffer.Unpooled;\n+import io.netty.handler.codec.http.DefaultHttpRequest;\n+import io.netty.handler.codec.http.HttpRequest;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.FilenameFilter;\n+import java.io.IOException;\n+\n+import static io.netty.handler.codec.http.HttpMethod.POST;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+import static org.junit.Assert.*;\n+\n+/**\n+ * Test DeleteFileOnExitHook\n+ */\n+public class DeleteFileOnExitHookTest {\n+    private static final HttpRequest REQUEST = new DefaultHttpRequest(HTTP_1_1, POST, \"/form\");\n+    private static final String HOOK_TEST_TMP = \"target/DeleteFileOnExitHookTest/tmp\";\n+\n+    @Test\n+    public void testTriggerDeleteFileOnExitHook() throws IOException {\n+        final DefaultHttpDataFactory defaultHttpDataFactory = new DefaultHttpDataFactory(true);\n+        File baseDir = new File(HOOK_TEST_TMP);\n+        baseDir.mkdirs();  // we don't need to clean it since it is in volatile files anyway\n+\n+        defaultHttpDataFactory.setBaseDir(HOOK_TEST_TMP);\n+        defaultHttpDataFactory.setDeleteOnExit(true);\n+        final FileUpload fu = defaultHttpDataFactory.createFileUpload(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "929465d49b3818d900893dbc6749501065eb9282"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29250260368c44e52e8d15c35090a3750b9bcaed", "author": {"user": {"login": "wuxiansen", "name": "Kevin Wu"}}, "url": "https://github.com/netty/netty/commit/29250260368c44e52e8d15c35090a3750b9bcaed", "committedDate": "2020-09-11T10:46:20Z", "message": "Optimized code."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NzA3MDQ4", "url": "https://github.com/netty/netty/pull/10560#pullrequestreview-486707048", "createdAt": "2020-09-11T10:57:12Z", "commit": {"oid": "29250260368c44e52e8d15c35090a3750b9bcaed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NzY3NDgy", "url": "https://github.com/netty/netty/pull/10560#pullrequestreview-486767482", "createdAt": "2020-09-11T12:38:34Z", "commit": {"oid": "29250260368c44e52e8d15c35090a3750b9bcaed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Nzc4NzAw", "url": "https://github.com/netty/netty/pull/10560#pullrequestreview-486778700", "createdAt": "2020-09-11T12:54:00Z", "commit": {"oid": "929465d49b3818d900893dbc6749501065eb9282"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMjo1NDowMFrOHQdoOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMjo1NDozM1rOHQdpow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAyNDY5OA==", "bodyText": "Try catch ignore exception?", "url": "https://github.com/netty/netty/pull/10560#discussion_r487024698", "createdAt": "2020-09-11T12:54:00Z", "author": {"login": "johnou"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHook.java", "diffHunk": "@@ -71,10 +71,12 @@ public static boolean checkFileExist(String file) {\n         return FILES.contains(file);\n     }\n \n-\n-    static void runHooks() {\n+    /**\n+     * Clean up all the files.\n+     */\n+    private static void runHooks() {\n         for (String filename : FILES) {\n-            (new File(filename)).delete();\n+            new File(filename).delete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "929465d49b3818d900893dbc6749501065eb9282"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAyNTA1OQ==", "bodyText": "run deletion hook?", "url": "https://github.com/netty/netty/pull/10560#discussion_r487025059", "createdAt": "2020-09-11T12:54:33Z", "author": {"login": "johnou"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/multipart/DeleteFileOnExitHook.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.handler.codec.http.multipart;\n+\n+import java.io.File;\n+import java.util.Collections;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * DeleteFileOnExitHook.\n+ */\n+final class DeleteFileOnExitHook {\n+    private static final Set<String> FILES = Collections.newSetFromMap(new ConcurrentHashMap<String, Boolean>());\n+\n+    private DeleteFileOnExitHook() {\n+    }\n+\n+    static {\n+        // DeleteOnExitHook must be the last shutdown hook to be invoked.\n+        // Application shutdown hooks may add the first file to the\n+        // delete on exit list and cause the DeleteOnExitHook to be\n+        // registered during shutdown in progress.\n+        Runtime.getRuntime().addShutdownHook(new Thread() {\n+\n+            @Override\n+            public void run() {\n+                runHooks();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29250260368c44e52e8d15c35090a3750b9bcaed"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bd693b8bfa21ee932d6f382c68749d72e5069d6", "author": {"user": {"login": "wuxiansen", "name": "Kevin Wu"}}, "url": "https://github.com/netty/netty/commit/8bd693b8bfa21ee932d6f382c68749d72e5069d6", "committedDate": "2020-09-14T10:06:26Z", "message": "Optimized code."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NjMyMjI5", "url": "https://github.com/netty/netty/pull/10560#pullrequestreview-487632229", "createdAt": "2020-09-14T10:44:52Z", "commit": {"oid": "8bd693b8bfa21ee932d6f382c68749d72e5069d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 37, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}