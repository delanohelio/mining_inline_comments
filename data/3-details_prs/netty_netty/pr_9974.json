{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MDE5NzI3", "number": 9974, "title": "SslHandler.wrap(...) must ensure it not loose the original exception \u2026", "bodyText": "\u2026when finishWrap(...) fails\nMotivation:\nWhen SslHandler.finishWrap throws an exception, ensure that the promise and buf is not reused to avoid throwing IllegalArgumentException or IllegalReferenceCountException which causes the original exception to be lost.\nModification:\nThe change ensures that the values for the promise and bytebuf are nulled before calling finishWrap so that it will not be called again with the same arguments.\nResult:\nFixes #9971 .\nCo-authored-by: Norman Maurer norman_maurer@apple.com", "createdAt": "2020-01-28T13:40:43Z", "url": "https://github.com/netty/netty/pull/9974", "merged": true, "mergeCommit": {"oid": "663fbaa50661eb5576d88aa0d053f2ccc2fae317"}, "closed": true, "closedAt": "2020-01-29T07:46:38Z", "author": {"login": "normanmaurer"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-xkTVAH2gAyMzY4MDE5NzI3OmZmNmE4NGJlZmNjZDIyZjMwODY2OGYzMzc5MmQxMDc4MzZkMTA5ZWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-2EbwgFqTM0OTYyMjMwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ff6a84befccd22f308668f33792d107836d109ee", "author": {"user": {"login": "atcurtis", "name": "Antony T Curtis"}}, "url": "https://github.com/netty/netty/commit/ff6a84befccd22f308668f33792d107836d109ee", "committedDate": "2020-01-28T13:43:14Z", "message": "SslHandler.wrap(...) must ensure it not loose the original exception when finishWrap(...) fails\n\nMotivation:\n\nWhen SslHandler.finishWrap throws an exception, ensure that the promise and buf is not reused to avoid throwing IllegalArgumentException or IllegalReferenceCountException which causes the original exception to be lost.\n\nModification:\n\nThe change ensures that the values for the promise and bytebuf are nulled before calling finishWrap so that it will not be called again with the same arguments.\n\nResult:\n\nFixes #9971 .\n\nCo-authored-by: Norman Maurer <norman_maurer@apple.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "460baacf92dd15488278bccd0a16fb486d153a6f", "author": {"user": {"login": "atcurtis", "name": "Antony T Curtis"}}, "url": "https://github.com/netty/netty/commit/460baacf92dd15488278bccd0a16fb486d153a6f", "committedDate": "2020-01-28T11:28:49Z", "message": "SslHandler.wrap(...) must ensure it not loose the original exception when finishWrap(...) fails\n\nMotivation:\n\nWhen SslHandler.finishWrap throws an exception, ensure that the promise and buf is not reused to avoid throwing IllegalArgumentException or IllegalReferenceCountException which causes the original exception to be lost.\n\nModification:\n\nThe change ensures that the values for the promise and bytebuf are nulled before calling finishWrap so that it will not be called again with the same arguments.\n\nResult:\n\nFixes #9971 .\n\nCo-authored-by: Norman Maurer <norman_maurer@apple.com>"}, "afterCommit": {"oid": "ff6a84befccd22f308668f33792d107836d109ee", "author": {"user": {"login": "atcurtis", "name": "Antony T Curtis"}}, "url": "https://github.com/netty/netty/commit/ff6a84befccd22f308668f33792d107836d109ee", "committedDate": "2020-01-28T13:43:14Z", "message": "SslHandler.wrap(...) must ensure it not loose the original exception when finishWrap(...) fails\n\nMotivation:\n\nWhen SslHandler.finishWrap throws an exception, ensure that the promise and buf is not reused to avoid throwing IllegalArgumentException or IllegalReferenceCountException which causes the original exception to be lost.\n\nModification:\n\nThe change ensures that the values for the promise and bytebuf are nulled before calling finishWrap so that it will not be called again with the same arguments.\n\nResult:\n\nFixes #9971 .\n\nCo-authored-by: Norman Maurer <norman_maurer@apple.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NTc4MjY1", "url": "https://github.com/netty/netty/pull/9974#pullrequestreview-349578265", "createdAt": "2020-01-28T17:49:52Z", "commit": {"oid": "ff6a84befccd22f308668f33792d107836d109ee"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNzo0OTo1MlrOFiunFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNzo0OTo1MlrOFiunFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1OTU3NQ==", "bodyText": "How about out.clear() here too?", "url": "https://github.com/netty/netty/pull/9974#discussion_r371959575", "createdAt": "2020-01-28T17:49:52Z", "author": {"login": "njhill"}, "path": "handler/src/main/java/io/netty/handler/ssl/SslHandler.java", "diffHunk": "@@ -858,11 +858,25 @@ private void wrap(ChannelHandlerContext ctx, boolean inUnwrap) throws SSLExcepti\n                         case NOT_HANDSHAKING:\n                             setHandshakeSuccessIfStillHandshaking();\n                             // deliberate fall-through\n-                        case NEED_WRAP:\n-                            finishWrap(ctx, out, promise, inUnwrap, false);\n+                        case NEED_WRAP: {\n+                            ChannelPromise p = promise;\n+\n+                            // Null out the promise so it is not reused in the finally block in the cause of\n+                            // finishWrap(...) throwing.\n                             promise = null;\n-                            out = null;\n+                            final ByteBuf b;\n+\n+                            if (out.isReadable()) {\n+                                // There is something in the out buffer. Ensure we null it out so it is not re-used.\n+                                b = out;\n+                                out = null;\n+                            } else {\n+                                // If out is not readable we can re-use it and so save an extra allocation\n+                                b = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff6a84befccd22f308668f33792d107836d109ee"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NjIyMzAw", "url": "https://github.com/netty/netty/pull/9974#pullrequestreview-349622300", "createdAt": "2020-01-28T18:57:57Z", "commit": {"oid": "ff6a84befccd22f308668f33792d107836d109ee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 336, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}