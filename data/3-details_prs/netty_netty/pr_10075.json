{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNTkzNDQ4", "number": 10075, "title": "Make sure we always flush window update frames in AbstractHttp2StreamChannel", "bodyText": "Motivation:\nUnder certain read patters the AbstractHttp2StreamChannel can fail to\nflush, resulting in flow window starvation.\nModifications:\n\nEnsure we flush if we exit the doBeginRead() method.\nAccount for the Http2FrameCodec always synchronously finishing writes\nof window update frames.\n\nResult:\nFixes #10072", "createdAt": "2020-03-02T20:32:27Z", "url": "https://github.com/netty/netty/pull/10075", "merged": true, "mergeCommit": {"oid": "7b946a781e9ed78d9283f7907aeb4b8471dc9a3a"}, "closed": true, "closedAt": "2020-03-04T09:50:42Z", "author": {"login": "bryce-anderson"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJzzqHgFqTM2NzUwNjU5Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKKRauABqjMwOTQxOTM5MjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NTA2NTky", "url": "https://github.com/netty/netty/pull/10075#pullrequestreview-367506592", "createdAt": "2020-03-02T20:32:59Z", "commit": {"oid": "9232b9a499ac6ccf6b571c7143e1a00a83950a91"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMDozMjo1OVrOFwuQ3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMDozMjo1OVrOFwuQ3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYzMzk1MA==", "bodyText": "This feels like something that almost certainly exists somewhere else.", "url": "https://github.com/netty/netty/pull/10075#discussion_r386633950", "createdAt": "2020-03-02T20:32:59Z", "author": {"login": "bryce-anderson"}, "path": "codec-http2/src/test/java/io/netty/handler/codec/http2/Http2TestUtil.java", "diffHunk": "@@ -687,6 +687,14 @@ static ByteBuf bb(String s) {\n         return ByteBufUtil.writeUtf8(UnpooledByteBufAllocator.DEFAULT, s);\n     }\n \n+    static ByteBuf bb(int size) {\n+        ByteBuf buf = UnpooledByteBufAllocator.DEFAULT.buffer();\n+        for (int i = 0; i < size; i++) {\n+            buf.writeByte('a');\n+        }\n+        return buf;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9232b9a499ac6ccf6b571c7143e1a00a83950a91"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NTA3MzI1", "url": "https://github.com/netty/netty/pull/10075#pullrequestreview-367507325", "createdAt": "2020-03-02T20:34:15Z", "commit": {"oid": "9232b9a499ac6ccf6b571c7143e1a00a83950a91"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMDozNDoxNVrOFwuTSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMDozNDoxNVrOFwuTSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYzNDU3MA==", "bodyText": "This change isn't strictly necessary for this patch but I spent a fair amount of time trying to read through this for the nth time and decided to clean it up so the control flow (when the method returns etc, not H2 flow control) is more readable. If desired, we can move it to a different patch.", "url": "https://github.com/netty/netty/pull/10075#discussion_r386634570", "createdAt": "2020-03-02T20:34:15Z", "author": {"login": "bryce-anderson"}, "path": "codec-http2/src/main/java/io/netty/handler/codec/http2/AbstractHttp2StreamChannel.java", "diffHunk": "@@ -920,58 +920,57 @@ public void write(Object msg, final ChannelPromise promise) {\n             try {\n                 if (msg instanceof Http2StreamFrame) {\n                     Http2StreamFrame frame = validateStreamFrame((Http2StreamFrame) msg).stream(stream());\n-                    if (!firstFrameWritten && !isStreamIdValid(stream().id())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9232b9a499ac6ccf6b571c7143e1a00a83950a91"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NTA3NjE0", "url": "https://github.com/netty/netty/pull/10075#pullrequestreview-367507614", "createdAt": "2020-03-02T20:34:43Z", "commit": {"oid": "9232b9a499ac6ccf6b571c7143e1a00a83950a91"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMDozNDo0NFrOFwuUIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMDozNDo0NFrOFwuUIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYzNDc4NQ==", "bodyText": "These are also not strictly necessary but part of the general cleanup I was attempting to do so this is more readable in the future.", "url": "https://github.com/netty/netty/pull/10075#discussion_r386634785", "createdAt": "2020-03-02T20:34:44Z", "author": {"login": "bryce-anderson"}, "path": "codec-http2/src/main/java/io/netty/handler/codec/http2/AbstractHttp2StreamChannel.java", "diffHunk": "@@ -558,10 +558,7 @@ void fireChildRead(Http2Frame frame) {\n             // read (unknown, reset) and the trade off is less conditionals for the hot path (headers/data) at the\n             // cost of additional readComplete notifications on the rare path.\n             if (allocHandle.continueReading()) {\n-                if (!readCompletePending) {\n-                    readCompletePending = true;\n-                    addChannelToReadCompletePendingQueue();\n-                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9232b9a499ac6ccf6b571c7143e1a00a83950a91"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NzYwNTUz", "url": "https://github.com/netty/netty/pull/10075#pullrequestreview-367760553", "createdAt": "2020-03-03T07:51:11Z", "commit": {"oid": "9232b9a499ac6ccf6b571c7143e1a00a83950a91"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzo1MToxMVrOFw7PJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzo1MToxMVrOFw7PJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0NjUwMw==", "bodyText": "nit: private final static", "url": "https://github.com/netty/netty/pull/10075#discussion_r386846503", "createdAt": "2020-03-03T07:51:11Z", "author": {"login": "normanmaurer"}, "path": "codec-http2/src/test/java/io/netty/handler/codec/http2/Http2MultiplexTest.java", "diffHunk": "@@ -1152,6 +1152,66 @@ public void channelRead(ChannelHandlerContext ctx, Object msg) {\n         verifyFramesMultiplexedToCorrectChannel(childChannel, inboundHandler, 3);\n     }\n \n+    class FlushSniffer extends ChannelOutboundHandlerAdapter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9232b9a499ac6ccf6b571c7143e1a00a83950a91"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9232b9a499ac6ccf6b571c7143e1a00a83950a91", "author": {"user": {"login": "bryce-anderson", "name": "Bryce Anderson"}}, "url": "https://github.com/netty/netty/commit/9232b9a499ac6ccf6b571c7143e1a00a83950a91", "committedDate": "2020-03-02T20:31:29Z", "message": "Make sure we always flush window update frames in AbstractHttp2StreamChannel\n\nMotivation:\n\nUnder certain read patters the AbstractHttp2StreamChannel can fail to\nflush, resulting in flow window starvation.\n\nModifications:\n\n- Ensure we flush if we exit the `doBeginRead()` method.\n- Account for the Http2FrameCodec always synchronously finishing writes\n  of window update frames.\n\nResult:\n\nFixes #10072"}, "afterCommit": {"oid": "eed3847f7d7275ba4718eece50a0838d97649c73", "author": {"user": {"login": "bryce-anderson", "name": "Bryce Anderson"}}, "url": "https://github.com/netty/netty/commit/eed3847f7d7275ba4718eece50a0838d97649c73", "committedDate": "2020-03-03T18:25:37Z", "message": "Make sure we always flush window update frames in AbstractHttp2StreamChannel\n\nMotivation:\n\nUnder certain read patters the AbstractHttp2StreamChannel can fail to\nflush, resulting in flow window starvation.\n\nModifications:\n\n- Ensure we flush if we exit the `doBeginRead()` method.\n- Account for the Http2FrameCodec always synchronously finishing writes\n  of window update frames.\n\nResult:\n\nFixes #10072"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MjU3MzM2", "url": "https://github.com/netty/netty/pull/10075#pullrequestreview-368257336", "createdAt": "2020-03-03T19:23:06Z", "commit": {"oid": "eed3847f7d7275ba4718eece50a0838d97649c73"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MzI5MTg2", "url": "https://github.com/netty/netty/pull/10075#pullrequestreview-368329186", "createdAt": "2020-03-03T21:15:01Z", "commit": {"oid": "eed3847f7d7275ba4718eece50a0838d97649c73"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e63317cad1ed65609b71c57b13850b153efb614", "author": {"user": {"login": "bryce-anderson", "name": "Bryce Anderson"}}, "url": "https://github.com/netty/netty/commit/1e63317cad1ed65609b71c57b13850b153efb614", "committedDate": "2020-03-03T22:43:08Z", "message": "Make sure we always flush window update frames in AbstractHttp2StreamChannel\n\nMotivation:\n\nUnder certain read patters the AbstractHttp2StreamChannel can fail to\nflush, resulting in flow window starvation.\n\nModifications:\n\n- Ensure we flush if we exit the `doBeginRead()` method.\n- Account for the Http2FrameCodec always synchronously finishing writes\n  of window update frames.\n\nResult:\n\nFixes #10072"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eed3847f7d7275ba4718eece50a0838d97649c73", "author": {"user": {"login": "bryce-anderson", "name": "Bryce Anderson"}}, "url": "https://github.com/netty/netty/commit/eed3847f7d7275ba4718eece50a0838d97649c73", "committedDate": "2020-03-03T18:25:37Z", "message": "Make sure we always flush window update frames in AbstractHttp2StreamChannel\n\nMotivation:\n\nUnder certain read patters the AbstractHttp2StreamChannel can fail to\nflush, resulting in flow window starvation.\n\nModifications:\n\n- Ensure we flush if we exit the `doBeginRead()` method.\n- Account for the Http2FrameCodec always synchronously finishing writes\n  of window update frames.\n\nResult:\n\nFixes #10072"}, "afterCommit": {"oid": "1e63317cad1ed65609b71c57b13850b153efb614", "author": {"user": {"login": "bryce-anderson", "name": "Bryce Anderson"}}, "url": "https://github.com/netty/netty/commit/1e63317cad1ed65609b71c57b13850b153efb614", "committedDate": "2020-03-03T22:43:08Z", "message": "Make sure we always flush window update frames in AbstractHttp2StreamChannel\n\nMotivation:\n\nUnder certain read patters the AbstractHttp2StreamChannel can fail to\nflush, resulting in flow window starvation.\n\nModifications:\n\n- Ensure we flush if we exit the `doBeginRead()` method.\n- Account for the Http2FrameCodec always synchronously finishing writes\n  of window update frames.\n\nResult:\n\nFixes #10072"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 377, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}