{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2OTA4MDU4", "number": 10632, "title": "Remove POLLRDHUP flag when handlePollAdd is called", "bodyText": "Motivation:\nchannel is never removed as POLLRDHUP is not removed\nModifications:\n-remove doDeregister as it is already called\n-remove POLLRDHUP flag\n-clear the poll flags if poll remove is processed\nResult:\nchannel is removed from channels map", "createdAt": "2020-10-02T13:29:30Z", "url": "https://github.com/netty/netty/pull/10632", "merged": true, "mergeCommit": {"oid": "347668e4018bd6a09f3dffa1e64811b6a5864d9a"}, "closed": true, "closedAt": "2020-10-09T09:19:32Z", "author": {"login": "1Jo1"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOnQhRgFqTUwMTIwODgyMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQik7iAFqTUwNDg1MzMzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjA4ODIx", "url": "https://github.com/netty/netty/pull/10632#pullrequestreview-501208821", "createdAt": "2020-10-02T14:56:31Z", "commit": {"oid": "3404114978d6c3c5e17c81103630a4fe2968744d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNDo1NjozMVrOHbw2iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNDo1NjozMVrOHbw2iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg3Mzk5NQ==", "bodyText": "doh! ... good catch", "url": "https://github.com/netty/netty/pull/10632#discussion_r498873995", "createdAt": "2020-10-02T14:56:31Z", "author": {"login": "normanmaurer"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringChannel.java", "diffHunk": "@@ -493,6 +491,7 @@ final void readComplete(int res, int data) {\n          * Called once POLLRDHUP event is ready to be processed\n          */\n         final void pollRdHup(int res) {\n+            ioState &= ~POLL_RDHUP_SCHEDULED;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3404114978d6c3c5e17c81103630a4fe2968744d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjA4OTMy", "url": "https://github.com/netty/netty/pull/10632#pullrequestreview-501208932", "createdAt": "2020-10-02T14:56:36Z", "commit": {"oid": "3404114978d6c3c5e17c81103630a4fe2968744d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a320f1a509f8b971225e199eb77951b64b899e2", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/4a320f1a509f8b971225e199eb77951b64b899e2", "committedDate": "2020-10-05T13:20:29Z", "message": "Remove POLLRDHUP flag when handlePollAdd is called\n\nMotivation:\n\nchannel is never removed as POLLRDHUP is not removed\n\nModifications:\n\n-remove doDeregister as it is already called\n-remove POLLRDHUP flag\n\nResult:\n\nchannel is removed from channel map"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3404114978d6c3c5e17c81103630a4fe2968744d", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/3404114978d6c3c5e17c81103630a4fe2968744d", "committedDate": "2020-10-02T13:24:20Z", "message": "Remove POLLRDHUP flag when handlePollAdd is called\n\nMotivation:\n\nchannel is never removed as POLLRDHUP is not removed\n\nModification:\n\n-remove doDeregister as as it is already called\n-remove POLLRDHUP flag\n\nResult:\n\nchannel is removed from channel map"}, "afterCommit": {"oid": "bc716215f910ecbff717dcbe748f0158b008a62b", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/bc716215f910ecbff717dcbe748f0158b008a62b", "committedDate": "2020-10-05T13:20:29Z", "message": "clear the poll flags if poll remove is processed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7f6d9295a5bb0fc05fc9dae06bc064767f7f18a", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/b7f6d9295a5bb0fc05fc9dae06bc064767f7f18a", "committedDate": "2020-10-05T13:27:49Z", "message": "clear the poll flags if poll remove is processed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc716215f910ecbff717dcbe748f0158b008a62b", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/bc716215f910ecbff717dcbe748f0158b008a62b", "committedDate": "2020-10-05T13:20:29Z", "message": "clear the poll flags if poll remove is processed"}, "afterCommit": {"oid": "b7f6d9295a5bb0fc05fc9dae06bc064767f7f18a", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/b7f6d9295a5bb0fc05fc9dae06bc064767f7f18a", "committedDate": "2020-10-05T13:27:49Z", "message": "clear the poll flags if poll remove is processed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMTIzNzQ5", "url": "https://github.com/netty/netty/pull/10632#pullrequestreview-502123749", "createdAt": "2020-10-05T14:37:35Z", "commit": {"oid": "b7f6d9295a5bb0fc05fc9dae06bc064767f7f18a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDozNzozNVrOHcgE5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDo0NzozOVrOHcgi7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0NzcxNw==", "bodyText": "\ud83e\udd14", "url": "https://github.com/netty/netty/pull/10632#discussion_r499647717", "createdAt": "2020-10-05T14:37:35Z", "author": {"login": "chrisvest"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringChannel.java", "diffHunk": "@@ -743,17 +742,18 @@ protected final void doDeregister() {\n \n         if (submissionQueue != null) {\n             if ((ioState & (POLL_IN_SCHEDULED | POLL_OUT_SCHEDULED | POLL_RDHUP_SCHEDULED)) == 0) {\n+                System.out.println(\"doDeregister remove Channel\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7f6d9295a5bb0fc05fc9dae06bc064767f7f18a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0ODc1Mg==", "bodyText": "I think checkstyle won't like this \ud83d\ude42", "url": "https://github.com/netty/netty/pull/10632#discussion_r499648752", "createdAt": "2020-10-05T14:38:56Z", "author": {"login": "chrisvest"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/AbstractIOUringChannel.java", "diffHunk": "@@ -830,4 +830,16 @@ private void computeRemote() {\n     private boolean shouldBreakIoUringInReady(ChannelConfig config) {\n         return socket.isInputShutdown() && (inputClosedSeenErrorOnRead || !isAllowHalfClosure(config));\n     }\n+\n+    public void clearPollFlag(int pollMask) {\n+        if (pollMask == Native.POLLIN) {\n+            ioState &= ~POLL_IN_SCHEDULED;\n+        } else if (pollMask == Native.POLLOUT) {\n+            ioState &= ~POLL_OUT_SCHEDULED;\n+        } else if (pollMask == Native.POLLRDHUP) {\n+            ioState &= ~POLL_RDHUP_SCHEDULED;\n+        }\n+\n+\n+     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7f6d9295a5bb0fc05fc9dae06bc064767f7f18a"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY1NTQwNg==", "bodyText": "Maybe we should have an assert that pollMask fits in a short?", "url": "https://github.com/netty/netty/pull/10632#discussion_r499655406", "createdAt": "2020-10-05T14:47:39Z", "author": {"login": "chrisvest"}, "path": "transport-native-io_uring/src/main/java/io/netty/channel/uring/IOUringSubmissionQueue.java", "diffHunk": "@@ -191,9 +191,9 @@ boolean addAccept(int fd, long address, long addressLength, short extraData) {\n     }\n \n     //fill the address which is associated with server poll link user_data\n-    boolean addPollRemove(int fd, int pollMask, short extraData) {\n+    boolean addPollRemove(int fd, int pollMask) {\n         return enqueueSqe(Native.IORING_OP_POLL_REMOVE, 0, 0, fd,\n-                          encode(fd, Native.IORING_OP_POLL_ADD, (short) pollMask), 0, 0, extraData);\n+                          encode(fd, Native.IORING_OP_POLL_ADD, (short) pollMask), 0, 0, (short) pollMask);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7f6d9295a5bb0fc05fc9dae06bc064767f7f18a"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfb6740fa70edc304a0e546040d6bc8c39e0f9aa", "author": {"user": {"login": "1Jo1", "name": "Josef Grieb"}}, "url": "https://github.com/netty/netty/commit/bfb6740fa70edc304a0e546040d6bc8c39e0f9aa", "committedDate": "2020-10-06T14:34:04Z", "message": "chris comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0ODUzMzMy", "url": "https://github.com/netty/netty/pull/10632#pullrequestreview-504853332", "createdAt": "2020-10-08T14:37:08Z", "commit": {"oid": "bfb6740fa70edc304a0e546040d6bc8c39e0f9aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4885, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}