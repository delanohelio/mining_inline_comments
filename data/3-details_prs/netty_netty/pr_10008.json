{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNDQzODE3", "number": 10008, "title": "ClearTextHttp2ServerUpgradeHandler can be merged with inner PriorKnow\u2026", "bodyText": "\u2026ledgeHandler\nMotivation:\nClearTextHttp2ServerUpgradeHandler is currently more complex then needed. We can simplify it by directly implement the prior-knowledge logic as part of the handler.\nModifications:\nMerge inner PriorKnowledgeHandler logic into ClearTextHttp2ServerUpgradeHandler by extending ByteToMessageDecoder directly\nResult:\nCleaner code and less pipeline operations", "createdAt": "2020-02-07T14:39:31Z", "url": "https://github.com/netty/netty/pull/10008", "merged": true, "mergeCommit": {"oid": "e7f291629b404009eb49778b7633b83b4478a87d"}, "closed": true, "closedAt": "2020-02-08T07:49:56Z", "author": {"login": "normanmaurer"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCBTZEgH2gAyMzcyNDQzODE3OmU2MDNmZjEyODAwZWE1MTVmYWYwMmFkOGJlZTc5ZDA5NGQ2M2M5MjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCDhJVgFqTM1NTM0NTEwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e603ff12800ea515faf02ad8bee79d094d63c921", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/e603ff12800ea515faf02ad8bee79d094d63c921", "committedDate": "2020-02-07T15:45:01Z", "message": "ClearTextHttp2ServerUpgradeHandler can be merged with inner PriorKnowledgeHandler\n\nMotivation:\n\nClearTextHttp2ServerUpgradeHandler is currently more complex then needed. We can simplify it by directly implement the prior-knowledge logic as part of the handler.\n\nModifications:\n\nMerge inner PriorKnowledgeHandler logic into ClearTextHttp2ServerUpgradeHandler by extending ByteToMessageDecoder directly\n\nResult:\n\nCleaner code and less pipeline operations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cce2520db61d6ce404e85350f87471faabacdf20", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/cce2520db61d6ce404e85350f87471faabacdf20", "committedDate": "2020-02-07T14:36:56Z", "message": "ClearTextHttp2ServerUpgradeHandler can be merged with inner PriorKnowledgeHandler\n\nMotivation:\n\nClearTextHttp2ServerUpgradeHandler is currently more complex then needed. We can simplify it by directly implement the prior-knowledge logic as part of the handler.\n\nModifications:\n\nMerge inner PriorKnowledgeHandler logic into ClearTextHttp2ServerUpgradeHandler by extending ByteToMessageDecoder directly\n\nResult:\n\nCleaner code and less pipeline operations"}, "afterCommit": {"oid": "e603ff12800ea515faf02ad8bee79d094d63c921", "author": {"user": {"login": "normanmaurer", "name": "Norman Maurer"}}, "url": "https://github.com/netty/netty/commit/e603ff12800ea515faf02ad8bee79d094d63c921", "committedDate": "2020-02-07T15:45:01Z", "message": "ClearTextHttp2ServerUpgradeHandler can be merged with inner PriorKnowledgeHandler\n\nMotivation:\n\nClearTextHttp2ServerUpgradeHandler is currently more complex then needed. We can simplify it by directly implement the prior-knowledge logic as part of the handler.\n\nModifications:\n\nMerge inner PriorKnowledgeHandler logic into ClearTextHttp2ServerUpgradeHandler by extending ByteToMessageDecoder directly\n\nResult:\n\nCleaner code and less pipeline operations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MjUyMzEx", "url": "https://github.com/netty/netty/pull/10008#pullrequestreview-355252311", "createdAt": "2020-02-07T15:51:24Z", "commit": {"oid": "e603ff12800ea515faf02ad8bee79d094d63c921"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNTo1MToyNFrOFnBj_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNTo1MToyNFrOFnBj_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ2NDM4Mw==", "bodyText": "This may or may not conflict with your Netty 5 \"don't sent events from a remove ctx\" patch.", "url": "https://github.com/netty/netty/pull/10008#discussion_r376464383", "createdAt": "2020-02-07T15:51:24Z", "author": {"login": "bryce-anderson"}, "path": "codec-http2/src/main/java/io/netty/handler/codec/http2/CleartextHttp2ServerUpgradeHandler.java", "diffHunk": "@@ -66,36 +65,33 @@ public CleartextHttp2ServerUpgradeHandler(HttpServerCodec httpServerCodec,\n     @Override\n     public void handlerAdded(ChannelHandlerContext ctx) throws Exception {\n         ctx.pipeline()\n-           .addBefore(ctx.name(), null, new PriorKnowledgeHandler())\n-           .addBefore(ctx.name(), null, httpServerCodec)\n-           .replace(this, null, httpServerUpgradeHandler);\n+                .addAfter(ctx.name(), null, httpServerUpgradeHandler)\n+                .addAfter(ctx.name(), null, httpServerCodec);\n     }\n \n     /**\n      * Peek inbound message to determine current connection wants to start HTTP/2\n      * by HTTP upgrade or prior knowledge\n      */\n-    private final class PriorKnowledgeHandler extends ByteToMessageDecoder {\n-        @Override\n-        protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {\n-            int prefaceLength = CONNECTION_PREFACE.readableBytes();\n-            int bytesRead = Math.min(in.readableBytes(), prefaceLength);\n+    @Override\n+    protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {\n+        int prefaceLength = CONNECTION_PREFACE.readableBytes();\n+        int bytesRead = Math.min(in.readableBytes(), prefaceLength);\n \n-            if (!ByteBufUtil.equals(CONNECTION_PREFACE, CONNECTION_PREFACE.readerIndex(),\n-                                    in, in.readerIndex(), bytesRead)) {\n-                ctx.pipeline().remove(this);\n-            } else if (bytesRead == prefaceLength) {\n-                // Full h2 preface match, removed source codec, using http2 codec to handle\n-                // following network traffic\n-                ctx.pipeline()\n-                   .remove(httpServerCodec)\n-                   .remove(httpServerUpgradeHandler);\n+        if (!ByteBufUtil.equals(CONNECTION_PREFACE, CONNECTION_PREFACE.readerIndex(),\n+                in, in.readerIndex(), bytesRead)) {\n+            ctx.pipeline().remove(this);\n+        } else if (bytesRead == prefaceLength) {\n+            // Full h2 preface match, removed source codec, using http2 codec to handle\n+            // following network traffic\n+            ctx.pipeline()\n+                    .remove(httpServerCodec)\n+                    .remove(httpServerUpgradeHandler);\n \n-                ctx.pipeline().addAfter(ctx.name(), null, http2ServerHandler);\n-                ctx.pipeline().remove(this);\n+            ctx.pipeline().addAfter(ctx.name(), null, http2ServerHandler);\n+            ctx.pipeline().remove(this);\n \n-                ctx.fireUserEventTriggered(PriorKnowledgeUpgradeEvent.INSTANCE);\n-            }\n+            ctx.fireUserEventTriggered(PriorKnowledgeUpgradeEvent.INSTANCE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e603ff12800ea515faf02ad8bee79d094d63c921"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MzQ1MTAz", "url": "https://github.com/netty/netty/pull/10008#pullrequestreview-355345103", "createdAt": "2020-02-07T18:19:51Z", "commit": {"oid": "e603ff12800ea515faf02ad8bee79d094d63c921"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 351, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}