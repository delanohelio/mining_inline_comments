{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NDIwNzEy", "number": 10630, "title": "Fix native image build on modern GraalVM versions for the cases when \u2026", "bodyText": "\u2026the program uses netty-dns\nMotivation:\nSince GraalVM version 19.3.0, instances of java.net.InetAddress (and its subclasses Inet4Address and Inet6Address) are not allowed in native image heap (that is, they cannot be stored in static fields of classes initialized at build time or be reachable through static fields of such classes). When building a native image, it makes sense to initialize at build time as many classes as possible.\nBut some fields of some classes in Netty (for example, NetUtil.LOCALHOST4) contain InetAddress instances. If a program is using code path that makes it possible to reach such fields at build time initialization, it becomes impossible to build a native image initializing core Netty classes initialized at runtime. An example of such a program is a client that uses netty-dns.\nModifications:\n\nUpdate GraalVM version to the recent 20.2.0\nAdd netty-testsuite-native-image-client Maven module to test that such an example program can be built after the corresponding fixes\nAdd native-image.properties to resolver-dns module to move initialization of some classes to runtime (some of them are parsing configuration during initialization, so it makes no sense to initialize them at build time; for others, it's needed to avoid InetAddress reachability at build time)\nAdd substitutions for NetUtil.LOCALHOST4, NetUtil.LOCALHOST6 and NetUtil.LOCALHOST to overcome the InetAddress-related prohibition\nExtract some initialization code from NetUtil to NetUtilInitializations to allow it to be used by the substitutions\n\nResult:\nA client program using netty-dns with --initialize-at-build-time=io.netty builds successfully\nLinks:\nThis grows from https://stackoverflow.com/questions/63328298/how-do-you-debug-a-no-instances-of-are-allowed-in-the-image-heap-when-buil", "createdAt": "2020-10-01T17:21:47Z", "url": "https://github.com/netty/netty/pull/10630", "merged": true, "mergeCommit": {"oid": "4ecd78e1044f8874b2f78d1e9b40283d6b62541a"}, "closed": true, "closedAt": "2020-10-26T07:34:32Z", "author": {"login": "rpuch"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOVy3AAFqTUwMDYxNTI5Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdV9sI-ABqjM5MTc2OTUyMjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjE1Mjk3", "url": "https://github.com/netty/netty/pull/10630#pullrequestreview-500615297", "createdAt": "2020-10-01T18:32:48Z", "commit": {"oid": "fcd5022d6e6664f43fce2790b0d6b7d571f5c4a6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODozMjo0OFrOHbWZZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODozNDo1OFrOHbWdpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0MDU0OA==", "bodyText": "NetUtilInitializations", "url": "https://github.com/netty/netty/pull/10630#discussion_r498440548", "createdAt": "2020-10-01T18:32:48Z", "author": {"login": "normanmaurer"}, "path": "common/src/main/java/io/netty/util/NetUtilInitializations.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import io.netty.util.internal.PlatformDependent;\n+import io.netty.util.internal.SocketUtils;\n+import io.netty.util.internal.logging.InternalLogger;\n+import io.netty.util.internal.logging.InternalLoggerFactory;\n+\n+import java.net.Inet4Address;\n+import java.net.Inet6Address;\n+import java.net.InetAddress;\n+import java.net.NetworkInterface;\n+import java.net.SocketException;\n+import java.util.ArrayList;\n+import java.util.Enumeration;\n+import java.util.List;\n+\n+final class NetUtilInitializations {\n+    /**\n+     * The logger being used by this class\n+     */\n+    private static final InternalLogger logger = InternalLoggerFactory.getInstance(NetUtil.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd5022d6e6664f43fce2790b0d6b7d571f5c4a6"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0MDgyMQ==", "bodyText": "static final", "url": "https://github.com/netty/netty/pull/10630#discussion_r498440821", "createdAt": "2020-10-01T18:33:19Z", "author": {"login": "normanmaurer"}, "path": "common/src/main/java/io/netty/util/NetUtilInitializations.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import io.netty.util.internal.PlatformDependent;\n+import io.netty.util.internal.SocketUtils;\n+import io.netty.util.internal.logging.InternalLogger;\n+import io.netty.util.internal.logging.InternalLoggerFactory;\n+\n+import java.net.Inet4Address;\n+import java.net.Inet6Address;\n+import java.net.InetAddress;\n+import java.net.NetworkInterface;\n+import java.net.SocketException;\n+import java.util.ArrayList;\n+import java.util.Enumeration;\n+import java.util.List;\n+\n+final class NetUtilInitializations {\n+    /**\n+     * The logger being used by this class\n+     */\n+    private static final InternalLogger logger = InternalLoggerFactory.getInstance(NetUtil.class);\n+\n+    private NetUtilInitializations() {\n+    }\n+\n+    static Inet4Address createLocalhost4() {\n+        byte[] LOCALHOST4_BYTES = {127, 0, 0, 1};\n+\n+        Inet4Address localhost4 = null;\n+        try {\n+            localhost4 = (Inet4Address) InetAddress.getByAddress(\"localhost\", LOCALHOST4_BYTES);\n+        } catch (Exception e) {\n+            // We should not get here as long as the length of the address is correct.\n+            PlatformDependent.throwException(e);\n+        }\n+\n+        return localhost4;\n+    }\n+\n+    static Inet6Address createLocalhost6() {\n+        byte[] LOCALHOST6_BYTES = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1};\n+\n+        Inet6Address localhost6 = null;\n+        try {\n+            localhost6 = (Inet6Address) InetAddress.getByAddress(\"localhost\", LOCALHOST6_BYTES);\n+        } catch (Exception e) {\n+            // We should not get here as long as the length of the address is correct.\n+            PlatformDependent.throwException(e);\n+        }\n+\n+        return localhost6;\n+    }\n+\n+    static NetworkIfaceAndInetAddress determineLoopback(Inet4Address localhost4, Inet6Address localhost6) {\n+        // Retrieve the list of available network interfaces.\n+        List<NetworkInterface> ifaces = new ArrayList<NetworkInterface>();\n+        try {\n+            Enumeration<NetworkInterface> interfaces = NetworkInterface.getNetworkInterfaces();\n+            if (interfaces != null) {\n+                while (interfaces.hasMoreElements()) {\n+                    NetworkInterface iface = interfaces.nextElement();\n+                    // Use the interface with proper INET addresses only.\n+                    if (SocketUtils.addressesFromNetworkInterface(iface).hasMoreElements()) {\n+                        ifaces.add(iface);\n+                    }\n+                }\n+            }\n+        } catch (SocketException e) {\n+            logger.warn(\"Failed to retrieve the list of available network interfaces\", e);\n+        }\n+\n+        // Find the first loopback interface available from its INET address (127.0.0.1 or ::1)\n+        // Note that we do not use NetworkInterface.isLoopback() in the first place because it takes long time\n+        // on a certain environment. (e.g. Windows with -Djava.net.preferIPv4Stack=true)\n+        NetworkInterface loopbackIface = null;\n+        InetAddress loopbackAddr = null;\n+        loop: for (NetworkInterface iface: ifaces) {\n+            for (Enumeration<InetAddress> i = SocketUtils.addressesFromNetworkInterface(iface); i.hasMoreElements();) {\n+                InetAddress addr = i.nextElement();\n+                if (addr.isLoopbackAddress()) {\n+                    // Found\n+                    loopbackIface = iface;\n+                    loopbackAddr = addr;\n+                    break loop;\n+                }\n+            }\n+        }\n+\n+        // If failed to find the loopback interface from its INET address, fall back to isLoopback().\n+        if (loopbackIface == null) {\n+            try {\n+                for (NetworkInterface iface: ifaces) {\n+                    if (iface.isLoopback()) {\n+                        Enumeration<InetAddress> i = SocketUtils.addressesFromNetworkInterface(iface);\n+                        if (i.hasMoreElements()) {\n+                            // Found the one with INET address.\n+                            loopbackIface = iface;\n+                            loopbackAddr = i.nextElement();\n+                            break;\n+                        }\n+                    }\n+                }\n+\n+                if (loopbackIface == null) {\n+                    logger.warn(\"Failed to find the loopback interface\");\n+                }\n+            } catch (SocketException e) {\n+                logger.warn(\"Failed to find the loopback interface\", e);\n+            }\n+        }\n+\n+        if (loopbackIface != null) {\n+            // Found the loopback interface with an INET address.\n+            logger.debug(\n+                    \"Loopback interface: {} ({}, {})\",\n+                    loopbackIface.getName(), loopbackIface.getDisplayName(), loopbackAddr.getHostAddress());\n+        } else {\n+            // Could not find the loopback interface, but we can't leave LOCALHOST as null.\n+            // Use LOCALHOST6 or LOCALHOST4, preferably the IPv6 one.\n+            if (loopbackAddr == null) {\n+                try {\n+                    if (NetworkInterface.getByInetAddress(localhost6) != null) {\n+                        logger.debug(\"Using hard-coded IPv6 localhost address: {}\", localhost6);\n+                        loopbackAddr = localhost6;\n+                    }\n+                } catch (Exception e) {\n+                    // Ignore\n+                } finally {\n+                    if (loopbackAddr == null) {\n+                        logger.debug(\"Using hard-coded IPv4 localhost address: {}\", localhost4);\n+                        loopbackAddr = localhost4;\n+                    }\n+                }\n+            }\n+        }\n+\n+        return new NetworkIfaceAndInetAddress(loopbackIface, loopbackAddr);\n+    }\n+\n+    static class NetworkIfaceAndInetAddress {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd5022d6e6664f43fce2790b0d6b7d571f5c4a6"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0MDk4Nw==", "bodyText": "remove get prefix as we usually not use these", "url": "https://github.com/netty/netty/pull/10630#discussion_r498440987", "createdAt": "2020-10-01T18:33:39Z", "author": {"login": "normanmaurer"}, "path": "common/src/main/java/io/netty/util/NetUtilInitializations.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import io.netty.util.internal.PlatformDependent;\n+import io.netty.util.internal.SocketUtils;\n+import io.netty.util.internal.logging.InternalLogger;\n+import io.netty.util.internal.logging.InternalLoggerFactory;\n+\n+import java.net.Inet4Address;\n+import java.net.Inet6Address;\n+import java.net.InetAddress;\n+import java.net.NetworkInterface;\n+import java.net.SocketException;\n+import java.util.ArrayList;\n+import java.util.Enumeration;\n+import java.util.List;\n+\n+final class NetUtilInitializations {\n+    /**\n+     * The logger being used by this class\n+     */\n+    private static final InternalLogger logger = InternalLoggerFactory.getInstance(NetUtil.class);\n+\n+    private NetUtilInitializations() {\n+    }\n+\n+    static Inet4Address createLocalhost4() {\n+        byte[] LOCALHOST4_BYTES = {127, 0, 0, 1};\n+\n+        Inet4Address localhost4 = null;\n+        try {\n+            localhost4 = (Inet4Address) InetAddress.getByAddress(\"localhost\", LOCALHOST4_BYTES);\n+        } catch (Exception e) {\n+            // We should not get here as long as the length of the address is correct.\n+            PlatformDependent.throwException(e);\n+        }\n+\n+        return localhost4;\n+    }\n+\n+    static Inet6Address createLocalhost6() {\n+        byte[] LOCALHOST6_BYTES = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1};\n+\n+        Inet6Address localhost6 = null;\n+        try {\n+            localhost6 = (Inet6Address) InetAddress.getByAddress(\"localhost\", LOCALHOST6_BYTES);\n+        } catch (Exception e) {\n+            // We should not get here as long as the length of the address is correct.\n+            PlatformDependent.throwException(e);\n+        }\n+\n+        return localhost6;\n+    }\n+\n+    static NetworkIfaceAndInetAddress determineLoopback(Inet4Address localhost4, Inet6Address localhost6) {\n+        // Retrieve the list of available network interfaces.\n+        List<NetworkInterface> ifaces = new ArrayList<NetworkInterface>();\n+        try {\n+            Enumeration<NetworkInterface> interfaces = NetworkInterface.getNetworkInterfaces();\n+            if (interfaces != null) {\n+                while (interfaces.hasMoreElements()) {\n+                    NetworkInterface iface = interfaces.nextElement();\n+                    // Use the interface with proper INET addresses only.\n+                    if (SocketUtils.addressesFromNetworkInterface(iface).hasMoreElements()) {\n+                        ifaces.add(iface);\n+                    }\n+                }\n+            }\n+        } catch (SocketException e) {\n+            logger.warn(\"Failed to retrieve the list of available network interfaces\", e);\n+        }\n+\n+        // Find the first loopback interface available from its INET address (127.0.0.1 or ::1)\n+        // Note that we do not use NetworkInterface.isLoopback() in the first place because it takes long time\n+        // on a certain environment. (e.g. Windows with -Djava.net.preferIPv4Stack=true)\n+        NetworkInterface loopbackIface = null;\n+        InetAddress loopbackAddr = null;\n+        loop: for (NetworkInterface iface: ifaces) {\n+            for (Enumeration<InetAddress> i = SocketUtils.addressesFromNetworkInterface(iface); i.hasMoreElements();) {\n+                InetAddress addr = i.nextElement();\n+                if (addr.isLoopbackAddress()) {\n+                    // Found\n+                    loopbackIface = iface;\n+                    loopbackAddr = addr;\n+                    break loop;\n+                }\n+            }\n+        }\n+\n+        // If failed to find the loopback interface from its INET address, fall back to isLoopback().\n+        if (loopbackIface == null) {\n+            try {\n+                for (NetworkInterface iface: ifaces) {\n+                    if (iface.isLoopback()) {\n+                        Enumeration<InetAddress> i = SocketUtils.addressesFromNetworkInterface(iface);\n+                        if (i.hasMoreElements()) {\n+                            // Found the one with INET address.\n+                            loopbackIface = iface;\n+                            loopbackAddr = i.nextElement();\n+                            break;\n+                        }\n+                    }\n+                }\n+\n+                if (loopbackIface == null) {\n+                    logger.warn(\"Failed to find the loopback interface\");\n+                }\n+            } catch (SocketException e) {\n+                logger.warn(\"Failed to find the loopback interface\", e);\n+            }\n+        }\n+\n+        if (loopbackIface != null) {\n+            // Found the loopback interface with an INET address.\n+            logger.debug(\n+                    \"Loopback interface: {} ({}, {})\",\n+                    loopbackIface.getName(), loopbackIface.getDisplayName(), loopbackAddr.getHostAddress());\n+        } else {\n+            // Could not find the loopback interface, but we can't leave LOCALHOST as null.\n+            // Use LOCALHOST6 or LOCALHOST4, preferably the IPv6 one.\n+            if (loopbackAddr == null) {\n+                try {\n+                    if (NetworkInterface.getByInetAddress(localhost6) != null) {\n+                        logger.debug(\"Using hard-coded IPv6 localhost address: {}\", localhost6);\n+                        loopbackAddr = localhost6;\n+                    }\n+                } catch (Exception e) {\n+                    // Ignore\n+                } finally {\n+                    if (loopbackAddr == null) {\n+                        logger.debug(\"Using hard-coded IPv4 localhost address: {}\", localhost4);\n+                        loopbackAddr = localhost4;\n+                    }\n+                }\n+            }\n+        }\n+\n+        return new NetworkIfaceAndInetAddress(loopbackIface, loopbackAddr);\n+    }\n+\n+    static class NetworkIfaceAndInetAddress {\n+        private final NetworkInterface iface;\n+        private final InetAddress address;\n+\n+        NetworkIfaceAndInetAddress(NetworkInterface iface, InetAddress address) {\n+            this.iface = iface;\n+            this.address = address;\n+        }\n+\n+        public NetworkInterface getIface() {\n+            return iface;\n+        }\n+\n+        public InetAddress getAddress() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd5022d6e6664f43fce2790b0d6b7d571f5c4a6"}, "originalPosition": 168}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0MTE3OA==", "bodyText": "final", "url": "https://github.com/netty/netty/pull/10630#discussion_r498441178", "createdAt": "2020-10-01T18:34:04Z", "author": {"login": "normanmaurer"}, "path": "common/src/main/java/io/netty/util/NetUtilSubstitutions.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import com.oracle.svm.core.annotate.Alias;\n+import com.oracle.svm.core.annotate.InjectAccessors;\n+import com.oracle.svm.core.annotate.TargetClass;\n+\n+import java.net.Inet4Address;\n+import java.net.Inet6Address;\n+import java.net.InetAddress;\n+\n+@TargetClass(NetUtil.class)\n+final class NetUtilSubstitutions {\n+    private NetUtilSubstitutions() {\n+    }\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhost4Accessor.class)\n+    public static Inet4Address LOCALHOST4;\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhost6Accessor.class)\n+    public static Inet6Address LOCALHOST6;\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhostAccessor.class)\n+    public static InetAddress LOCALHOST;\n+\n+    private static class NetUtilLocalhost4Accessor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd5022d6e6664f43fce2790b0d6b7d571f5c4a6"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0MTI0MA==", "bodyText": "final", "url": "https://github.com/netty/netty/pull/10630#discussion_r498441240", "createdAt": "2020-10-01T18:34:11Z", "author": {"login": "normanmaurer"}, "path": "common/src/main/java/io/netty/util/NetUtilSubstitutions.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import com.oracle.svm.core.annotate.Alias;\n+import com.oracle.svm.core.annotate.InjectAccessors;\n+import com.oracle.svm.core.annotate.TargetClass;\n+\n+import java.net.Inet4Address;\n+import java.net.Inet6Address;\n+import java.net.InetAddress;\n+\n+@TargetClass(NetUtil.class)\n+final class NetUtilSubstitutions {\n+    private NetUtilSubstitutions() {\n+    }\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhost4Accessor.class)\n+    public static Inet4Address LOCALHOST4;\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhost6Accessor.class)\n+    public static Inet6Address LOCALHOST6;\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhostAccessor.class)\n+    public static InetAddress LOCALHOST;\n+\n+    private static class NetUtilLocalhost4Accessor {\n+        static Inet4Address get() {\n+            // using https://en.wikipedia.org/wiki/Initialization-on-demand_holder_idiom\n+            return NetUtilLocalhost4LazyHolder.LOCALHOST4;\n+        }\n+    }\n+\n+    private static class NetUtilLocalhost4LazyHolder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd5022d6e6664f43fce2790b0d6b7d571f5c4a6"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0MTMwMA==", "bodyText": "final", "url": "https://github.com/netty/netty/pull/10630#discussion_r498441300", "createdAt": "2020-10-01T18:34:19Z", "author": {"login": "normanmaurer"}, "path": "common/src/main/java/io/netty/util/NetUtilSubstitutions.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import com.oracle.svm.core.annotate.Alias;\n+import com.oracle.svm.core.annotate.InjectAccessors;\n+import com.oracle.svm.core.annotate.TargetClass;\n+\n+import java.net.Inet4Address;\n+import java.net.Inet6Address;\n+import java.net.InetAddress;\n+\n+@TargetClass(NetUtil.class)\n+final class NetUtilSubstitutions {\n+    private NetUtilSubstitutions() {\n+    }\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhost4Accessor.class)\n+    public static Inet4Address LOCALHOST4;\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhost6Accessor.class)\n+    public static Inet6Address LOCALHOST6;\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhostAccessor.class)\n+    public static InetAddress LOCALHOST;\n+\n+    private static class NetUtilLocalhost4Accessor {\n+        static Inet4Address get() {\n+            // using https://en.wikipedia.org/wiki/Initialization-on-demand_holder_idiom\n+            return NetUtilLocalhost4LazyHolder.LOCALHOST4;\n+        }\n+    }\n+\n+    private static class NetUtilLocalhost4LazyHolder {\n+        private static final Inet4Address LOCALHOST4 = NetUtilInitializations.createLocalhost4();\n+    }\n+\n+    private static class NetUtilLocalhost6Accessor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd5022d6e6664f43fce2790b0d6b7d571f5c4a6"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0MTM1MQ==", "bodyText": "final", "url": "https://github.com/netty/netty/pull/10630#discussion_r498441351", "createdAt": "2020-10-01T18:34:26Z", "author": {"login": "normanmaurer"}, "path": "common/src/main/java/io/netty/util/NetUtilSubstitutions.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import com.oracle.svm.core.annotate.Alias;\n+import com.oracle.svm.core.annotate.InjectAccessors;\n+import com.oracle.svm.core.annotate.TargetClass;\n+\n+import java.net.Inet4Address;\n+import java.net.Inet6Address;\n+import java.net.InetAddress;\n+\n+@TargetClass(NetUtil.class)\n+final class NetUtilSubstitutions {\n+    private NetUtilSubstitutions() {\n+    }\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhost4Accessor.class)\n+    public static Inet4Address LOCALHOST4;\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhost6Accessor.class)\n+    public static Inet6Address LOCALHOST6;\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhostAccessor.class)\n+    public static InetAddress LOCALHOST;\n+\n+    private static class NetUtilLocalhost4Accessor {\n+        static Inet4Address get() {\n+            // using https://en.wikipedia.org/wiki/Initialization-on-demand_holder_idiom\n+            return NetUtilLocalhost4LazyHolder.LOCALHOST4;\n+        }\n+    }\n+\n+    private static class NetUtilLocalhost4LazyHolder {\n+        private static final Inet4Address LOCALHOST4 = NetUtilInitializations.createLocalhost4();\n+    }\n+\n+    private static class NetUtilLocalhost6Accessor {\n+        static Inet6Address get() {\n+            // using https://en.wikipedia.org/wiki/Initialization-on-demand_holder_idiom\n+            return NetUtilLocalhost6LazyHolder.LOCALHOST6;\n+        }\n+    }\n+\n+    private static class NetUtilLocalhost6LazyHolder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd5022d6e6664f43fce2790b0d6b7d571f5c4a6"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0MTQ1Mw==", "bodyText": "final", "url": "https://github.com/netty/netty/pull/10630#discussion_r498441453", "createdAt": "2020-10-01T18:34:38Z", "author": {"login": "normanmaurer"}, "path": "common/src/main/java/io/netty/util/NetUtilSubstitutions.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import com.oracle.svm.core.annotate.Alias;\n+import com.oracle.svm.core.annotate.InjectAccessors;\n+import com.oracle.svm.core.annotate.TargetClass;\n+\n+import java.net.Inet4Address;\n+import java.net.Inet6Address;\n+import java.net.InetAddress;\n+\n+@TargetClass(NetUtil.class)\n+final class NetUtilSubstitutions {\n+    private NetUtilSubstitutions() {\n+    }\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhost4Accessor.class)\n+    public static Inet4Address LOCALHOST4;\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhost6Accessor.class)\n+    public static Inet6Address LOCALHOST6;\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhostAccessor.class)\n+    public static InetAddress LOCALHOST;\n+\n+    private static class NetUtilLocalhost4Accessor {\n+        static Inet4Address get() {\n+            // using https://en.wikipedia.org/wiki/Initialization-on-demand_holder_idiom\n+            return NetUtilLocalhost4LazyHolder.LOCALHOST4;\n+        }\n+    }\n+\n+    private static class NetUtilLocalhost4LazyHolder {\n+        private static final Inet4Address LOCALHOST4 = NetUtilInitializations.createLocalhost4();\n+    }\n+\n+    private static class NetUtilLocalhost6Accessor {\n+        static Inet6Address get() {\n+            // using https://en.wikipedia.org/wiki/Initialization-on-demand_holder_idiom\n+            return NetUtilLocalhost6LazyHolder.LOCALHOST6;\n+        }\n+    }\n+\n+    private static class NetUtilLocalhost6LazyHolder {\n+        private static final Inet6Address LOCALHOST6 = NetUtilInitializations.createLocalhost6();\n+    }\n+\n+    private static class NetUtilLocalhostAccessor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd5022d6e6664f43fce2790b0d6b7d571f5c4a6"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0MTUyMA==", "bodyText": "final", "url": "https://github.com/netty/netty/pull/10630#discussion_r498441520", "createdAt": "2020-10-01T18:34:45Z", "author": {"login": "normanmaurer"}, "path": "common/src/main/java/io/netty/util/NetUtilSubstitutions.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.util;\n+\n+import com.oracle.svm.core.annotate.Alias;\n+import com.oracle.svm.core.annotate.InjectAccessors;\n+import com.oracle.svm.core.annotate.TargetClass;\n+\n+import java.net.Inet4Address;\n+import java.net.Inet6Address;\n+import java.net.InetAddress;\n+\n+@TargetClass(NetUtil.class)\n+final class NetUtilSubstitutions {\n+    private NetUtilSubstitutions() {\n+    }\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhost4Accessor.class)\n+    public static Inet4Address LOCALHOST4;\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhost6Accessor.class)\n+    public static Inet6Address LOCALHOST6;\n+\n+    @Alias\n+    @InjectAccessors(NetUtilLocalhostAccessor.class)\n+    public static InetAddress LOCALHOST;\n+\n+    private static class NetUtilLocalhost4Accessor {\n+        static Inet4Address get() {\n+            // using https://en.wikipedia.org/wiki/Initialization-on-demand_holder_idiom\n+            return NetUtilLocalhost4LazyHolder.LOCALHOST4;\n+        }\n+    }\n+\n+    private static class NetUtilLocalhost4LazyHolder {\n+        private static final Inet4Address LOCALHOST4 = NetUtilInitializations.createLocalhost4();\n+    }\n+\n+    private static class NetUtilLocalhost6Accessor {\n+        static Inet6Address get() {\n+            // using https://en.wikipedia.org/wiki/Initialization-on-demand_holder_idiom\n+            return NetUtilLocalhost6LazyHolder.LOCALHOST6;\n+        }\n+    }\n+\n+    private static class NetUtilLocalhost6LazyHolder {\n+        private static final Inet6Address LOCALHOST6 = NetUtilInitializations.createLocalhost6();\n+    }\n+\n+    private static class NetUtilLocalhostAccessor {\n+        static InetAddress get() {\n+            // using https://en.wikipedia.org/wiki/Initialization-on-demand_holder_idiom\n+            return NetUtilLocalhostLazyHolder.LOCALHOST;\n+        }\n+    }\n+\n+    private static class NetUtilLocalhostLazyHolder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd5022d6e6664f43fce2790b0d6b7d571f5c4a6"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0MTYzNg==", "bodyText": "2020", "url": "https://github.com/netty/netty/pull/10630#discussion_r498441636", "createdAt": "2020-10-01T18:34:58Z", "author": {"login": "normanmaurer"}, "path": "testsuite-native-image-client/pom.xml", "diffHunk": "@@ -0,0 +1,106 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright 2017 The Netty Project", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd5022d6e6664f43fce2790b0d6b7d571f5c4a6"}, "originalPosition": 3}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcd5022d6e6664f43fce2790b0d6b7d571f5c4a6", "author": {"user": {"login": "rpuch", "name": "Roman Puchkovskiy"}}, "url": "https://github.com/netty/netty/commit/fcd5022d6e6664f43fce2790b0d6b7d571f5c4a6", "committedDate": "2020-10-01T17:18:37Z", "message": "Fix native image build on modern GraalVM versions for the cases when the program uses netty-dns\n\nMotivation:\n\nSince GraalVM version 19.3.0, instances of java.net.InetAddress (and its subclasses Inet4Address and Inet6Address) are not allowed in native image heap (that is, they cannot be stored in static fields of classes initialized at build time or be reachable through static fields of such classes). When building a native image, it makes sense to initialize at build time as many classes as possible.\nBut some fields of some classes in Netty (for example, NetUtil.LOCALHOST4) contain InetAddress instances. If a program is using code path that makes it possible to reach such fields at build time initialization, it becomes impossible to build a native image initializing core Netty classes initialized at runtime. An example of such a program is a client that uses netty-dns.\n\nModifications:\n\n- Update GraalVM version to the recent 20.2.0\n- Add netty-testsuite-native-image-client Maven module to test that such an example program can be built after the corresponding fixes\n- Add native-image.properties to resolver-dns module to move initialization of some classes to runtime (some of them are parsing configuration during initialization, so it makes no sense to initialize them at build time; for others, it's needed to avoid InetAddress reachability at build time)\n- Add substitutions for NetUtil.LOCALHOST4, NetUtil.LOCALHOST6 and NetUtil.LOCALHOST to overcome the InetAddress-related prohibition\n- Extract some initialization code from NetUtil to NetUtilInitializations to allow it to be used by the substitutions\n\nResult:\n\nA client program using netty-dns with --initialize-at-build-time=io.netty builds successfully"}, "afterCommit": {"oid": "1fc353405e8c61fd5c64b2dca50aa491e1449b87", "author": {"user": {"login": "rpuch", "name": "Roman Puchkovskiy"}}, "url": "https://github.com/netty/netty/commit/1fc353405e8c61fd5c64b2dca50aa491e1449b87", "committedDate": "2020-10-02T16:27:36Z", "message": "Fix native image build on modern GraalVM versions for the cases when the program uses netty-dns\n\nMotivation:\n\nSince GraalVM version 19.3.0, instances of java.net.InetAddress (and its subclasses Inet4Address and Inet6Address) are not allowed in native image heap (that is, they cannot be stored in static fields of classes initialized at build time or be reachable through static fields of such classes). When building a native image, it makes sense to initialize at build time as many classes as possible.\nBut some fields of some classes in Netty (for example, NetUtil.LOCALHOST4) contain InetAddress instances. If a program is using code path that makes it possible to reach such fields at build time initialization, it becomes impossible to build a native image initializing core Netty classes initialized at runtime. An example of such a program is a client that uses netty-dns.\n\nModifications:\n\n- Update GraalVM version to the recent 20.2.0\n- Add netty-testsuite-native-image-client Maven module to test that such an example program can be built after the corresponding fixes\n- Add native-image.properties to resolver-dns module to move initialization of some classes to runtime (some of them are parsing configuration during initialization, so it makes no sense to initialize them at build time; for others, it's needed to avoid InetAddress reachability at build time)\n- Add substitutions for NetUtil.LOCALHOST4, NetUtil.LOCALHOST6 and NetUtil.LOCALHOST to overcome the InetAddress-related prohibition\n- Extract some initialization code from NetUtil to NetUtilInitializations to allow it to be used by the substitutions\n\nResult:\n\nA client program using netty-dns with --initialize-at-build-time=io.netty builds successfully"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1fc353405e8c61fd5c64b2dca50aa491e1449b87", "author": {"user": {"login": "rpuch", "name": "Roman Puchkovskiy"}}, "url": "https://github.com/netty/netty/commit/1fc353405e8c61fd5c64b2dca50aa491e1449b87", "committedDate": "2020-10-02T16:27:36Z", "message": "Fix native image build on modern GraalVM versions for the cases when the program uses netty-dns\n\nMotivation:\n\nSince GraalVM version 19.3.0, instances of java.net.InetAddress (and its subclasses Inet4Address and Inet6Address) are not allowed in native image heap (that is, they cannot be stored in static fields of classes initialized at build time or be reachable through static fields of such classes). When building a native image, it makes sense to initialize at build time as many classes as possible.\nBut some fields of some classes in Netty (for example, NetUtil.LOCALHOST4) contain InetAddress instances. If a program is using code path that makes it possible to reach such fields at build time initialization, it becomes impossible to build a native image initializing core Netty classes initialized at runtime. An example of such a program is a client that uses netty-dns.\n\nModifications:\n\n- Update GraalVM version to the recent 20.2.0\n- Add netty-testsuite-native-image-client Maven module to test that such an example program can be built after the corresponding fixes\n- Add native-image.properties to resolver-dns module to move initialization of some classes to runtime (some of them are parsing configuration during initialization, so it makes no sense to initialize them at build time; for others, it's needed to avoid InetAddress reachability at build time)\n- Add substitutions for NetUtil.LOCALHOST4, NetUtil.LOCALHOST6 and NetUtil.LOCALHOST to overcome the InetAddress-related prohibition\n- Extract some initialization code from NetUtil to NetUtilInitializations to allow it to be used by the substitutions\n\nResult:\n\nA client program using netty-dns with --initialize-at-build-time=io.netty builds successfully"}, "afterCommit": {"oid": "30dadca96013c735ac0ad8b82196f0d7667d161e", "author": {"user": {"login": "rpuch", "name": "Roman Puchkovskiy"}}, "url": "https://github.com/netty/netty/commit/30dadca96013c735ac0ad8b82196f0d7667d161e", "committedDate": "2020-10-18T10:25:40Z", "message": "Fix native image build on modern GraalVM versions for the cases when the program uses netty-dns\n\nMotivation:\n\nSince GraalVM version 19.3.0, instances of java.net.InetAddress (and its subclasses Inet4Address and Inet6Address) are not allowed in native image heap (that is, they cannot be stored in static fields of classes initialized at build time or be reachable through static fields of such classes). When building a native image, it makes sense to initialize at build time as many classes as possible.\nBut some fields of some classes in Netty (for example, NetUtil.LOCALHOST4) contain InetAddress instances. If a program is using code path that makes it possible to reach such fields at build time initialization, it becomes impossible to build a native image initializing core Netty classes initialized at runtime. An example of such a program is a client that uses netty-dns.\n\nModifications:\n\n- Add netty-testsuite-native-image-client Maven module to test that such an example program can be built after the corresponding fixes\n- Add native-image.properties to resolver-dns module to move initialization of some classes to runtime (some of them are parsing configuration during initialization, so it makes no sense to initialize them at build time; for others, it's needed to avoid InetAddress reachability at build time)\n- Add substitutions for NetUtil.LOCALHOST4, NetUtil.LOCALHOST6 and NetUtil.LOCALHOST to overcome the InetAddress-related prohibition\n- Extract some initialization code from NetUtil to NetUtilInitializations to allow it to be used by the substitutions\n\nResult:\n\nA client program using netty-dns with --initialize-at-build-time=io.netty builds successfully"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30dadca96013c735ac0ad8b82196f0d7667d161e", "author": {"user": {"login": "rpuch", "name": "Roman Puchkovskiy"}}, "url": "https://github.com/netty/netty/commit/30dadca96013c735ac0ad8b82196f0d7667d161e", "committedDate": "2020-10-18T10:25:40Z", "message": "Fix native image build on modern GraalVM versions for the cases when the program uses netty-dns\n\nMotivation:\n\nSince GraalVM version 19.3.0, instances of java.net.InetAddress (and its subclasses Inet4Address and Inet6Address) are not allowed in native image heap (that is, they cannot be stored in static fields of classes initialized at build time or be reachable through static fields of such classes). When building a native image, it makes sense to initialize at build time as many classes as possible.\nBut some fields of some classes in Netty (for example, NetUtil.LOCALHOST4) contain InetAddress instances. If a program is using code path that makes it possible to reach such fields at build time initialization, it becomes impossible to build a native image initializing core Netty classes initialized at runtime. An example of such a program is a client that uses netty-dns.\n\nModifications:\n\n- Add netty-testsuite-native-image-client Maven module to test that such an example program can be built after the corresponding fixes\n- Add native-image.properties to resolver-dns module to move initialization of some classes to runtime (some of them are parsing configuration during initialization, so it makes no sense to initialize them at build time; for others, it's needed to avoid InetAddress reachability at build time)\n- Add substitutions for NetUtil.LOCALHOST4, NetUtil.LOCALHOST6 and NetUtil.LOCALHOST to overcome the InetAddress-related prohibition\n- Extract some initialization code from NetUtil to NetUtilInitializations to allow it to be used by the substitutions\n\nResult:\n\nA client program using netty-dns with --initialize-at-build-time=io.netty builds successfully"}, "afterCommit": {"oid": "c604775bcf7e227c99ee75aee39e14fde3a419e9", "author": {"user": {"login": "rpuch", "name": "Roman Puchkovskiy"}}, "url": "https://github.com/netty/netty/commit/c604775bcf7e227c99ee75aee39e14fde3a419e9", "committedDate": "2020-10-18T12:15:06Z", "message": "Fix native image build on modern GraalVM versions for the cases when the program uses netty-dns\n\nMotivation:\n\nSince GraalVM version 19.3.0, instances of java.net.InetAddress (and its subclasses Inet4Address and Inet6Address) are not allowed in native image heap (that is, they cannot be stored in static fields of classes initialized at build time or be reachable through static fields of such classes). When building a native image, it makes sense to initialize at build time as many classes as possible.\nBut some fields of some classes in Netty (for example, NetUtil.LOCALHOST4) contain InetAddress instances. If a program is using code path that makes it possible to reach such fields at build time initialization, it becomes impossible to build a native image initializing core Netty classes initialized at runtime. An example of such a program is a client that uses netty-dns.\n\nModifications:\n\n- Add netty-testsuite-native-image-client Maven module to test that such an example program can be built after the corresponding fixes\n- Add native-image.properties to resolver-dns module to move initialization of some classes to runtime (some of them are parsing configuration during initialization, so it makes no sense to initialize them at build time; for others, it's needed to avoid InetAddress reachability at build time)\n- Add substitutions for NetUtil.LOCALHOST4, NetUtil.LOCALHOST6 and NetUtil.LOCALHOST to overcome the InetAddress-related prohibition\n- Extract some initialization code from NetUtil to NetUtilInitializations to allow it to be used by the substitutions\n\nResult:\n\nA client program using netty-dns with --initialize-at-build-time=io.netty builds successfully"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c604775bcf7e227c99ee75aee39e14fde3a419e9", "author": {"user": {"login": "rpuch", "name": "Roman Puchkovskiy"}}, "url": "https://github.com/netty/netty/commit/c604775bcf7e227c99ee75aee39e14fde3a419e9", "committedDate": "2020-10-18T12:15:06Z", "message": "Fix native image build on modern GraalVM versions for the cases when the program uses netty-dns\n\nMotivation:\n\nSince GraalVM version 19.3.0, instances of java.net.InetAddress (and its subclasses Inet4Address and Inet6Address) are not allowed in native image heap (that is, they cannot be stored in static fields of classes initialized at build time or be reachable through static fields of such classes). When building a native image, it makes sense to initialize at build time as many classes as possible.\nBut some fields of some classes in Netty (for example, NetUtil.LOCALHOST4) contain InetAddress instances. If a program is using code path that makes it possible to reach such fields at build time initialization, it becomes impossible to build a native image initializing core Netty classes initialized at runtime. An example of such a program is a client that uses netty-dns.\n\nModifications:\n\n- Add netty-testsuite-native-image-client Maven module to test that such an example program can be built after the corresponding fixes\n- Add native-image.properties to resolver-dns module to move initialization of some classes to runtime (some of them are parsing configuration during initialization, so it makes no sense to initialize them at build time; for others, it's needed to avoid InetAddress reachability at build time)\n- Add substitutions for NetUtil.LOCALHOST4, NetUtil.LOCALHOST6 and NetUtil.LOCALHOST to overcome the InetAddress-related prohibition\n- Extract some initialization code from NetUtil to NetUtilInitializations to allow it to be used by the substitutions\n\nResult:\n\nA client program using netty-dns with --initialize-at-build-time=io.netty builds successfully"}, "afterCommit": {"oid": "4332452a1d552c46a89ae3f6966bd9d322611a02", "author": {"user": {"login": "rpuch", "name": "Roman Puchkovskiy"}}, "url": "https://github.com/netty/netty/commit/4332452a1d552c46a89ae3f6966bd9d322611a02", "committedDate": "2020-10-18T12:18:59Z", "message": "Fix native image build on modern GraalVM versions for the cases when the program uses netty-dns\n\nMotivation:\n\nSince GraalVM version 19.3.0, instances of java.net.InetAddress (and its subclasses Inet4Address and Inet6Address) are not allowed in native image heap (that is, they cannot be stored in static fields of classes initialized at build time or be reachable through static fields of such classes). When building a native image, it makes sense to initialize at build time as many classes as possible.\nBut some fields of some classes in Netty (for example, NetUtil.LOCALHOST4) contain InetAddress instances. If a program is using code path that makes it possible to reach such fields at build time initialization, it becomes impossible to build a native image initializing core Netty classes initialized at runtime. An example of such a program is a client that uses netty-dns.\n\nModifications:\n\n- Add netty-testsuite-native-image-client Maven module to test that such an example program can be built after the corresponding fixes\n- Add native-image.properties to resolver-dns module to move initialization of some classes to runtime (some of them are parsing configuration during initialization, so it makes no sense to initialize them at build time; for others, it's needed to avoid InetAddress reachability at build time)\n- Add substitutions for NetUtil.LOCALHOST4, NetUtil.LOCALHOST6 and NetUtil.LOCALHOST to overcome the InetAddress-related prohibition\n- Extract some initialization code from NetUtil to NetUtilInitializations to allow it to be used by the substitutions\n\nResult:\n\nA client program using netty-dns with --initialize-at-build-time=io.netty builds successfully"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MzQwNzA3", "url": "https://github.com/netty/netty/pull/10630#pullrequestreview-516340707", "createdAt": "2020-10-25T09:39:10Z", "commit": {"oid": "4332452a1d552c46a89ae3f6966bd9d322611a02"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNVQwOTozOToxMFrOHn343A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNVQwOTo0Mjo0OFrOHn36eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTU3MjE4OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #   http://www.apache.org/licenses/LICENSE-2.0\n          \n          \n            \n            #   https://www.apache.org/licenses/LICENSE-2.0", "url": "https://github.com/netty/netty/pull/10630#discussion_r511572188", "createdAt": "2020-10-25T09:39:10Z", "author": {"login": "normanmaurer"}, "path": "resolver-dns/src/main/resources/META-INF/native-image/io.netty/resolver-dns/native-image.properties", "diffHunk": "@@ -0,0 +1,18 @@\n+# Copyright 2020 The Netty Project\n+#\n+# The Netty Project licenses this file to you under the Apache License,\n+# version 2.0 (the \"License\"); you may not use this file except in compliance\n+# with the License. You may obtain a copy of the License at:\n+#\n+#   http://www.apache.org/licenses/LICENSE-2.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4332452a1d552c46a89ae3f6966bd9d322611a02"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTU3MjIwOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              ~   http://www.apache.org/licenses/LICENSE-2.0\n          \n          \n            \n              ~   https://www.apache.org/licenses/LICENSE-2.0", "url": "https://github.com/netty/netty/pull/10630#discussion_r511572209", "createdAt": "2020-10-25T09:39:24Z", "author": {"login": "normanmaurer"}, "path": "testsuite-native-image-client/pom.xml", "diffHunk": "@@ -0,0 +1,106 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright 2020 The Netty Project\n+  ~\n+  ~ The Netty Project licenses this file to you under the Apache License,\n+  ~ version 2.0 (the \"License\"); you may not use this file except in compliance\n+  ~ with the License. You may obtain a copy of the License at:\n+  ~\n+  ~   http://www.apache.org/licenses/LICENSE-2.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4332452a1d552c46a89ae3f6966bd9d322611a02"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTU3MjIyNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *   http://www.apache.org/licenses/LICENSE-2.0\n          \n          \n            \n             *   https://www.apache.org/licenses/LICENSE-2.0", "url": "https://github.com/netty/netty/pull/10630#discussion_r511572227", "createdAt": "2020-10-25T09:39:39Z", "author": {"login": "normanmaurer"}, "path": "testsuite-native-image-client/src/main/java/io/netty/testsuite/svm/client/DnsNativeClient.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4332452a1d552c46a89ae3f6966bd9d322611a02"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTU3MjI2NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *   http://www.apache.org/licenses/LICENSE-2.0\n          \n          \n            \n             *   https://www.apache.org/licenses/LICENSE-2.0", "url": "https://github.com/netty/netty/pull/10630#discussion_r511572265", "createdAt": "2020-10-25T09:39:58Z", "author": {"login": "normanmaurer"}, "path": "testsuite-native-image-client/src/main/java/io/netty/testsuite/svm/client/package-info.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4332452a1d552c46a89ae3f6966bd9d322611a02"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTU3MjMxNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *   http://www.apache.org/licenses/LICENSE-2.0\n          \n          \n            \n             *   https://www.apache.org/licenses/LICENSE-2.0", "url": "https://github.com/netty/netty/pull/10630#discussion_r511572317", "createdAt": "2020-10-25T09:40:19Z", "author": {"login": "normanmaurer"}, "path": "transport/src/test/java/io/netty/channel/socket/InternetProtocolFamilyTest.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4332452a1d552c46a89ae3f6966bd9d322611a02"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTU3MjUyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import static org.junit.Assert.assertThat;\n          \n          \n            \n            import static org.hamcrest.MatcherAssert.assertThat;", "url": "https://github.com/netty/netty/pull/10630#discussion_r511572526", "createdAt": "2020-10-25T09:41:56Z", "author": {"login": "normanmaurer"}, "path": "transport/src/test/java/io/netty/channel/socket/InternetProtocolFamilyTest.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package io.netty.channel.socket;\n+\n+import io.netty.util.NetUtil;\n+import org.junit.Test;\n+\n+import java.net.InetAddress;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4332452a1d552c46a89ae3f6966bd9d322611a02"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTU3MjU1OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            <project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd\">\n          \n          \n            \n            <project xmlns=\"https://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"https://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"https://maven.apache.org/POM/4.0.0 https://maven.apache.org/maven-v4_0_0.xsd\">", "url": "https://github.com/netty/netty/pull/10630#discussion_r511572558", "createdAt": "2020-10-25T09:42:22Z", "author": {"login": "normanmaurer"}, "path": "testsuite-native-image-client/pom.xml", "diffHunk": "@@ -0,0 +1,106 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright 2020 The Netty Project\n+  ~\n+  ~ The Netty Project licenses this file to you under the Apache License,\n+  ~ version 2.0 (the \"License\"); you may not use this file except in compliance\n+  ~ with the License. You may obtain a copy of the License at:\n+  ~\n+  ~   http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+  ~ WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+  ~ License for the specific language governing permissions and limitations\n+  ~ under the License.\n+  -->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4332452a1d552c46a89ae3f6966bd9d322611a02"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTU3MjU4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *   http://www.apache.org/licenses/LICENSE-2.0\n          \n          \n            \n             *   https://www.apache.org/licenses/LICENSE-2.0", "url": "https://github.com/netty/netty/pull/10630#discussion_r511572582", "createdAt": "2020-10-25T09:42:36Z", "author": {"login": "normanmaurer"}, "path": "common/src/main/java/io/netty/util/NetUtilSubstitutions.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4332452a1d552c46a89ae3f6966bd9d322611a02"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTU3MjYwMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *   http://www.apache.org/licenses/LICENSE-2.0\n          \n          \n            \n             *   https://www.apache.org/licenses/LICENSE-2.0", "url": "https://github.com/netty/netty/pull/10630#discussion_r511572602", "createdAt": "2020-10-25T09:42:48Z", "author": {"login": "normanmaurer"}, "path": "common/src/main/java/io/netty/util/NetUtilInitializations.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4332452a1d552c46a89ae3f6966bd9d322611a02"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1d4adb6944417d6f27e61fb9d4eeeadde36d82e", "author": {"user": {"login": "rpuch", "name": "Roman Puchkovskiy"}}, "url": "https://github.com/netty/netty/commit/a1d4adb6944417d6f27e61fb9d4eeeadde36d82e", "committedDate": "2020-10-25T11:01:17Z", "message": "Fix native image build on modern GraalVM versions for the cases when the program uses netty-dns\n\nMotivation:\n\nSince GraalVM version 19.3.0, instances of java.net.InetAddress (and its subclasses Inet4Address and Inet6Address) are not allowed in native image heap (that is, they cannot be stored in static fields of classes initialized at build time or be reachable through static fields of such classes). When building a native image, it makes sense to initialize at build time as many classes as possible.\nBut some fields of some classes in Netty (for example, NetUtil.LOCALHOST4) contain InetAddress instances. If a program is using code path that makes it possible to reach such fields at build time initialization, it becomes impossible to build a native image initializing core Netty classes initialized at runtime. An example of such a program is a client that uses netty-dns.\n\nModifications:\n\n- Add netty-testsuite-native-image-client Maven module to test that such an example program can be built after the corresponding fixes\n- Add native-image.properties to resolver-dns module to move initialization of some classes to runtime (some of them are parsing configuration during initialization, so it makes no sense to initialize them at build time; for others, it's needed to avoid InetAddress reachability at build time)\n- Add substitutions for NetUtil.LOCALHOST4, NetUtil.LOCALHOST6 and NetUtil.LOCALHOST to overcome the InetAddress-related prohibition\n- Extract some initialization code from NetUtil to NetUtilInitializations to allow it to be used by the substitutions\n\nResult:\n\nA client program using netty-dns with --initialize-at-build-time=io.netty builds successfully"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4332452a1d552c46a89ae3f6966bd9d322611a02", "author": {"user": {"login": "rpuch", "name": "Roman Puchkovskiy"}}, "url": "https://github.com/netty/netty/commit/4332452a1d552c46a89ae3f6966bd9d322611a02", "committedDate": "2020-10-18T12:18:59Z", "message": "Fix native image build on modern GraalVM versions for the cases when the program uses netty-dns\n\nMotivation:\n\nSince GraalVM version 19.3.0, instances of java.net.InetAddress (and its subclasses Inet4Address and Inet6Address) are not allowed in native image heap (that is, they cannot be stored in static fields of classes initialized at build time or be reachable through static fields of such classes). When building a native image, it makes sense to initialize at build time as many classes as possible.\nBut some fields of some classes in Netty (for example, NetUtil.LOCALHOST4) contain InetAddress instances. If a program is using code path that makes it possible to reach such fields at build time initialization, it becomes impossible to build a native image initializing core Netty classes initialized at runtime. An example of such a program is a client that uses netty-dns.\n\nModifications:\n\n- Add netty-testsuite-native-image-client Maven module to test that such an example program can be built after the corresponding fixes\n- Add native-image.properties to resolver-dns module to move initialization of some classes to runtime (some of them are parsing configuration during initialization, so it makes no sense to initialize them at build time; for others, it's needed to avoid InetAddress reachability at build time)\n- Add substitutions for NetUtil.LOCALHOST4, NetUtil.LOCALHOST6 and NetUtil.LOCALHOST to overcome the InetAddress-related prohibition\n- Extract some initialization code from NetUtil to NetUtilInitializations to allow it to be used by the substitutions\n\nResult:\n\nA client program using netty-dns with --initialize-at-build-time=io.netty builds successfully"}, "afterCommit": {"oid": "a1d4adb6944417d6f27e61fb9d4eeeadde36d82e", "author": {"user": {"login": "rpuch", "name": "Roman Puchkovskiy"}}, "url": "https://github.com/netty/netty/commit/a1d4adb6944417d6f27e61fb9d4eeeadde36d82e", "committedDate": "2020-10-25T11:01:17Z", "message": "Fix native image build on modern GraalVM versions for the cases when the program uses netty-dns\n\nMotivation:\n\nSince GraalVM version 19.3.0, instances of java.net.InetAddress (and its subclasses Inet4Address and Inet6Address) are not allowed in native image heap (that is, they cannot be stored in static fields of classes initialized at build time or be reachable through static fields of such classes). When building a native image, it makes sense to initialize at build time as many classes as possible.\nBut some fields of some classes in Netty (for example, NetUtil.LOCALHOST4) contain InetAddress instances. If a program is using code path that makes it possible to reach such fields at build time initialization, it becomes impossible to build a native image initializing core Netty classes initialized at runtime. An example of such a program is a client that uses netty-dns.\n\nModifications:\n\n- Add netty-testsuite-native-image-client Maven module to test that such an example program can be built after the corresponding fixes\n- Add native-image.properties to resolver-dns module to move initialization of some classes to runtime (some of them are parsing configuration during initialization, so it makes no sense to initialize them at build time; for others, it's needed to avoid InetAddress reachability at build time)\n- Add substitutions for NetUtil.LOCALHOST4, NetUtil.LOCALHOST6 and NetUtil.LOCALHOST to overcome the InetAddress-related prohibition\n- Extract some initialization code from NetUtil to NetUtilInitializations to allow it to be used by the substitutions\n\nResult:\n\nA client program using netty-dns with --initialize-at-build-time=io.netty builds successfully"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 93, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}