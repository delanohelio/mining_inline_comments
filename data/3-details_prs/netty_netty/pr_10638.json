{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3NjEwNzM0", "number": 10638, "title": "Add Close method for closing OutputStream and PcapWriteHandler", "bodyText": "Motivation:\nWe should implement the Closeable method to properly close OutputStream and PcapWriteHandler. So whenever handlerRemoved(ChannelHandlerContext) is called or the user wants to stop the Pcap writes into OutputStream, we have a proper method to close it otherwise writing data to close OutputStream will result in IOException.\nModification:\nImplemented Closeable in PcapWriteHandler which calls PcapWriter#close and closes OutputStream and stops Pcap writes.\nResult:\nBetter handling of Pcap writes.", "createdAt": "2020-10-05T06:12:44Z", "url": "https://github.com/netty/netty/pull/10638", "merged": true, "mergeCommit": {"oid": "461b6e0f7b3277fe980b7293a6ab644340af1d7c"}, "closed": true, "closedAt": "2020-10-08T09:52:18Z", "author": {"login": "hyperxpro"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPdfXEAH2gAyNDk3NjEwNzM0OmVlMTU0OTc0ODc4OGYzNWExYTIyNWVlY2VmY2FlNmQ3NGExODJiYTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPoGTNgH2gAyNDk3NjEwNzM0OjA3MTZiODQ5YTFiMTA1ODYzNmJmZTRlNmE1NDdjMTNmYjRkODBhOWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ee1549748788f35a1a225eecefcae6d74a182ba0", "author": {"user": {"login": "hyperxpro", "name": "Aayush Atharva"}}, "url": "https://github.com/netty/netty/commit/ee1549748788f35a1a225eecefcae6d74a182ba0", "committedDate": "2020-10-05T06:07:36Z", "message": "add close method for closing outputstream and pcapwritehandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9", "author": {"user": {"login": "hyperxpro", "name": "Aayush Atharva"}}, "url": "https://github.com/netty/netty/commit/3a94a987d0bdfed6b3baf96780dcedeec66c0fd9", "committedDate": "2020-10-05T07:05:21Z", "message": "Add close flag in PcapWriter and fix timestamp bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDM1MzA1", "url": "https://github.com/netty/netty/pull/10638#pullrequestreview-502035305", "createdAt": "2020-10-05T13:06:43Z", "commit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzowNjo0NFrOHccLBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDowMjowOVrOHcef2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4Mzc1MQ==", "bodyText": "No need to explicitly initialise this to false.", "url": "https://github.com/netty/netty/pull/10638#discussion_r499583751", "createdAt": "2020-10-05T13:06:44Z", "author": {"login": "chrisvest"}, "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriteHandler.java", "diffHunk": "@@ -108,12 +112,18 @@\n      */\n     private InetSocketAddress dstAddr;\n \n+    /**\n+     * Set to {@code true} if {@link #close()} is called and we should stop writing Pcap.\n+     */\n+    private boolean isClosed = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4Mzk2NQ==", "bodyText": "No need to explicitly initialise this to false.", "url": "https://github.com/netty/netty/pull/10638#discussion_r499583965", "createdAt": "2020-10-05T13:07:07Z", "author": {"login": "chrisvest"}, "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriter.java", "diffHunk": "@@ -29,6 +28,11 @@\n      */\n     private final OutputStream outputStream;\n \n+    /**\n+     * Set to {@code true} if {@link #outputStream} is closed.\n+     */\n+    private boolean isClosed = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNTcxNA==", "bodyText": "What's the meaning of this comment? The handler is not closed, but we called close on the handler?", "url": "https://github.com/netty/netty/pull/10638#discussion_r499615714", "createdAt": "2020-10-05T13:53:22Z", "author": {"login": "chrisvest"}, "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriteHandler.java", "diffHunk": "@@ -517,7 +532,21 @@ public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws E\n             logger.debug(\"Sent Fake TCP RST to close connection\");\n         }\n \n-        this.pCapWriter.close();\n+        close();\n         ctx.fireExceptionCaught(cause);\n     }\n+\n+    /**\n+     * <p> Close {@code PcapWriter} and {@link OutputStream}. </p>\n+     * <p> Note: Calling this method does not close {@link PcapWriteHandler}.\n+     * Only Pcap Writes are closed. </p>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNjI0NQ==", "bodyText": "Should this method be idempotent, i.e. a no-op when isClosed is already true?", "url": "https://github.com/netty/netty/pull/10638#discussion_r499616245", "createdAt": "2020-10-05T13:54:10Z", "author": {"login": "chrisvest"}, "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriteHandler.java", "diffHunk": "@@ -517,7 +532,21 @@ public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws E\n             logger.debug(\"Sent Fake TCP RST to close connection\");\n         }\n \n-        this.pCapWriter.close();\n+        close();\n         ctx.fireExceptionCaught(cause);\n     }\n+\n+    /**\n+     * <p> Close {@code PcapWriter} and {@link OutputStream}. </p>\n+     * <p> Note: Calling this method does not close {@link PcapWriteHandler}.\n+     * Only Pcap Writes are closed. </p>\n+     *\n+     * @throws IOException If {@link OutputStream#close()} throws an exception\n+     */\n+    @Override\n+    public void close() throws IOException {\n+        isClosed = true;\n+        pCapWriter.close();\n+        logger.debug(\"PcapWriterHandler is Closed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYyMDkzNg==", "bodyText": "This method should ideally be idempotent, such that closing an already closed PcapWriter does nothing. Relying on the flush call on a closed OutputStream not throwing seems a bit shaky.", "url": "https://github.com/netty/netty/pull/10638#discussion_r499620936", "createdAt": "2020-10-05T14:00:48Z", "author": {"login": "chrisvest"}, "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriter.java", "diffHunk": "@@ -58,22 +62,25 @@\n      * @throws IOException If {@link OutputStream#write(byte[])} throws an exception\n      */\n     void writePacket(ByteBuf packetHeaderBuf, ByteBuf packet) throws IOException {\n-        long currentTime = System.currentTimeMillis();\n+        long timestamp = System.currentTimeMillis();\n \n         PcapHeaders.writePacketHeader(\n                 packetHeaderBuf,\n-                (int) TimeUnit.MILLISECONDS.toSeconds(currentTime),\n-                (int) TimeUnit.MILLISECONDS.toMicros(currentTime) % 1000000,\n+                (int) (timestamp / 1000L),\n+                (int) (timestamp % 1000L * 1000L),\n                 packet.readableBytes(),\n                 packet.readableBytes()\n         );\n \n-        packetHeaderBuf.readBytes(outputStream, packetHeaderBuf.readableBytes());\n-        packet.readBytes(outputStream, packet.readableBytes());\n+        if (!isClosed) {\n+            packetHeaderBuf.readBytes(outputStream, packetHeaderBuf.readableBytes());\n+            packet.readBytes(outputStream, packet.readableBytes());\n+        }\n     }\n \n     @Override\n     public void close() throws IOException {\n+        isClosed = true;\n         outputStream.flush();\n         outputStream.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYyMTg0OQ==", "bodyText": "Would be better to hoist this condition to the start of the method and return early if the writer is closed, no?", "url": "https://github.com/netty/netty/pull/10638#discussion_r499621849", "createdAt": "2020-10-05T14:02:09Z", "author": {"login": "chrisvest"}, "path": "handler/src/main/java/io/netty/handler/pcap/PcapWriter.java", "diffHunk": "@@ -58,22 +62,25 @@\n      * @throws IOException If {@link OutputStream#write(byte[])} throws an exception\n      */\n     void writePacket(ByteBuf packetHeaderBuf, ByteBuf packet) throws IOException {\n-        long currentTime = System.currentTimeMillis();\n+        long timestamp = System.currentTimeMillis();\n \n         PcapHeaders.writePacketHeader(\n                 packetHeaderBuf,\n-                (int) TimeUnit.MILLISECONDS.toSeconds(currentTime),\n-                (int) TimeUnit.MILLISECONDS.toMicros(currentTime) % 1000000,\n+                (int) (timestamp / 1000L),\n+                (int) (timestamp % 1000L * 1000L),\n                 packet.readableBytes(),\n                 packet.readableBytes()\n         );\n \n-        packetHeaderBuf.readBytes(outputStream, packetHeaderBuf.readableBytes());\n-        packet.readBytes(outputStream, packet.readableBytes());\n+        if (!isClosed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a94a987d0bdfed6b3baf96780dcedeec66c0fd9"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0716b849a1b1058636bfe4e6a547c13fb4d80a9f", "author": {"user": {"login": "hyperxpro", "name": "Aayush Atharva"}}, "url": "https://github.com/netty/netty/commit/0716b849a1b1058636bfe4e6a547c13fb4d80a9f", "committedDate": "2020-10-05T18:29:11Z", "message": "improve code and address @chrisvest comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4891, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}