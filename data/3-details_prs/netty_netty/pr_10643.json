{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NDkxMjAz", "number": 10643, "title": "Enable HTTP header validation in HttpServerUpgradeHandler", "bodyText": "Motivation:\nHttpServerUpgradeHandler takes a list of protocols from an incoming request and uses them for building a response. Although the class does some validation while parsing the list, it then disables HTTP header validation when it builds a response. The disabled validation may potentially allow HTTP response splitting attacks.\nModifications:\nEnabled HTTP header validation in HttpServerUpgradeHandler as a defense-in-depth measure to prevent possible HTTP response splitting attacks.\nResult:\nHttpServerUpgradeHandler validates incoming protocols before including them into a response. That should prevent possible HTTP response splitting attacks.\nNotes:\nThe issue was reported by LGTM\nhttps://lgtm.com/projects/g/netty/netty/snapshot/090bf3d107cb3099317e1cd9e0d661ac0797c126/files/codec-http/src/main/java/io/netty/handler/codec/http/HttpServerUpgradeHandler.java?sort=name&dir=ASC&mode=heatmap#x3246e2156ce648dd:1\nI am not sure how exactly the handler may be used, and therefore I am not sure if and when the attack may be implemented. As I mentioned above, the handler does some checks on the list of protocols. For example, it skips whitespaces. I would consider this update as a defense-in-depth measure rather than a real issue.\nThe update should not cause problems for applications since a valid Upgrade header should not contains any special characters.\nIf there is a strong reason, which I am not aware of, for not enabling the validation, please let me know. I'll then suppress the warning.", "createdAt": "2020-10-06T12:11:30Z", "url": "https://github.com/netty/netty/pull/10643", "merged": true, "mergeCommit": {"oid": "26976310d26e11a850cf3cb0b9aa38287aefc1f8"}, "closed": true, "closedAt": "2020-10-30T10:23:42Z", "author": {"login": "artem-smotrakov"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP4MyYgFqTUwMjkzNDI2Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXkHlzAFqTUyMDUzNzA2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyOTM0MjYz", "url": "https://github.com/netty/netty/pull/10643#pullrequestreview-502934263", "createdAt": "2020-10-06T13:14:30Z", "commit": {"oid": "8c0fd7485a91059ae88d0dfcc3b48a67095b1303"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzoxNDozMVrOHdFxig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzoxNDozMVrOHdFxig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI2NTM1NA==", "bodyText": "How about adding a constructor with boolean and set the default value to true for enabling Header verification? It'll give the user ability to turn off Header verification if needed.", "url": "https://github.com/netty/netty/pull/10643#discussion_r500265354", "createdAt": "2020-10-06T13:14:31Z", "author": {"login": "hyperxpro"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/HttpServerUpgradeHandler.java", "diffHunk": "@@ -353,8 +353,7 @@ private boolean upgrade(final ChannelHandlerContext ctx, final FullHttpRequest r\n      * Creates the 101 Switching Protocols response message.\n      */\n     private static FullHttpResponse createUpgradeResponse(CharSequence upgradeProtocol) {\n-        DefaultFullHttpResponse res = new DefaultFullHttpResponse(HTTP_1_1, SWITCHING_PROTOCOLS,\n-                Unpooled.EMPTY_BUFFER, false);\n+        DefaultFullHttpResponse res = new DefaultFullHttpResponse(HTTP_1_1, SWITCHING_PROTOCOLS, Unpooled.EMPTY_BUFFER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c0fd7485a91059ae88d0dfcc3b48a67095b1303"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c0fd7485a91059ae88d0dfcc3b48a67095b1303", "author": {"user": {"login": "artem-smotrakov", "name": "Artem Smotrakov"}}, "url": "https://github.com/netty/netty/commit/8c0fd7485a91059ae88d0dfcc3b48a67095b1303", "committedDate": "2020-10-06T11:52:42Z", "message": "Enable header valication in HttpServerUpgradeHandler\n\nMotivation:\n\nHttpServerUpgradeHandler takes a list of protocols from an incoming\nrequest and uses them for building a response.\nAlthough the class does some validation while parsing the list,\nit then disables HTTP header validation when it builds a response.\nThe disabled validation may potentially allow\nHTTP response splitting attacks.\n\nModifications:\n\nEnabled HTTP header validation in HttpServerUpgradeHandler\nas a defense-in-depth measure to prevent possible\nHTTP response splitting attacks.\n\nResult:\n\nHttpServerUpgradeHandler validates incoming protocols\nbefore including them into a response.\nThat should prevent possible HTTP response splitting attacks."}, "afterCommit": {"oid": "ecb45dc452481cab8d09871633ee3a008caf5a0b", "author": {"user": {"login": "artem-smotrakov", "name": "Artem Smotrakov"}}, "url": "https://github.com/netty/netty/commit/ecb45dc452481cab8d09871633ee3a008caf5a0b", "committedDate": "2020-10-26T12:45:36Z", "message": "Enable header valication in HttpServerUpgradeHandler\n\nMotivation:\n\nHttpServerUpgradeHandler takes a list of protocols from an incoming\nrequest and uses them for building a response.\nAlthough the class does some validation while parsing the list,\nit then disables HTTP header validation when it builds a responst.\nThe disabled validation may potentially allow\nHTTP response splitting attacks.\n\nModifications:\n\n- Enabled HTTP header validation in HttpServerUpgradeHandler\n  as a defense-in-depth measure to prevent possible\n  HTTP response splitting attacks.\n- Added a new constructor that allows disabling the validation.\n\nResult:\n\nHttpServerUpgradeHandler validates incoming protocols\nbefore including them into a response.\nThat should prevent possible HTTP response splitting attacks."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MTI0NTEy", "url": "https://github.com/netty/netty/pull/10643#pullrequestreview-517124512", "createdAt": "2020-10-26T19:52:29Z", "commit": {"oid": "ecb45dc452481cab8d09871633ee3a008caf5a0b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxOTo1MjoyOVrOHof7Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxOTo1MjoyOVrOHof7Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIyODEwMg==", "bodyText": "nit: please add that this is for the response.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param validateHeaders validate the header names and values\n          \n          \n            \n                 * @param validateHeaders validate the header names and values of the upgrade response.", "url": "https://github.com/netty/netty/pull/10643#discussion_r512228102", "createdAt": "2020-10-26T19:52:29Z", "author": {"login": "normanmaurer"}, "path": "codec-http/src/main/java/io/netty/handler/codec/http/HttpServerUpgradeHandler.java", "diffHunk": "@@ -199,10 +200,25 @@ public HttpServerUpgradeHandler(SourceCodec sourceCodec, UpgradeCodecFactory upg\n      */\n     public HttpServerUpgradeHandler(\n             SourceCodec sourceCodec, UpgradeCodecFactory upgradeCodecFactory, int maxContentLength) {\n+        this(sourceCodec, upgradeCodecFactory, maxContentLength, true);\n+    }\n+\n+    /**\n+     * Constructs the upgrader with the supported codecs.\n+     *\n+     * @param sourceCodec the codec that is being used initially\n+     * @param upgradeCodecFactory the factory that creates a new upgrade codec\n+     *                            for one of the requested upgrade protocols\n+     * @param maxContentLength the maximum length of the content of an upgrade request\n+     * @param validateHeaders validate the header names and values", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecb45dc452481cab8d09871633ee3a008caf5a0b"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11724f28304a9dc8916dfb8d194edf531c916fd5", "author": {"user": {"login": "artem-smotrakov", "name": "Artem Smotrakov"}}, "url": "https://github.com/netty/netty/commit/11724f28304a9dc8916dfb8d194edf531c916fd5", "committedDate": "2020-10-27T07:51:23Z", "message": "Enable header valication in HttpServerUpgradeHandler\n\nMotivation:\n\nHttpServerUpgradeHandler takes a list of protocols from an incoming\nrequest and uses them for building a response.\nAlthough the class does some validation while parsing the list,\nit then disables HTTP header validation when it builds a responst.\nThe disabled validation may potentially allow\nHTTP response splitting attacks.\n\nModifications:\n\n- Enabled HTTP header validation in HttpServerUpgradeHandler\n  as a defense-in-depth measure to prevent possible\n  HTTP response splitting attacks.\n- Added a new constructor that allows disabling the validation.\n\nResult:\n\nHttpServerUpgradeHandler validates incoming protocols\nbefore including them into a response.\nThat should prevent possible HTTP response splitting attacks."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ecb45dc452481cab8d09871633ee3a008caf5a0b", "author": {"user": {"login": "artem-smotrakov", "name": "Artem Smotrakov"}}, "url": "https://github.com/netty/netty/commit/ecb45dc452481cab8d09871633ee3a008caf5a0b", "committedDate": "2020-10-26T12:45:36Z", "message": "Enable header valication in HttpServerUpgradeHandler\n\nMotivation:\n\nHttpServerUpgradeHandler takes a list of protocols from an incoming\nrequest and uses them for building a response.\nAlthough the class does some validation while parsing the list,\nit then disables HTTP header validation when it builds a responst.\nThe disabled validation may potentially allow\nHTTP response splitting attacks.\n\nModifications:\n\n- Enabled HTTP header validation in HttpServerUpgradeHandler\n  as a defense-in-depth measure to prevent possible\n  HTTP response splitting attacks.\n- Added a new constructor that allows disabling the validation.\n\nResult:\n\nHttpServerUpgradeHandler validates incoming protocols\nbefore including them into a response.\nThat should prevent possible HTTP response splitting attacks."}, "afterCommit": {"oid": "11724f28304a9dc8916dfb8d194edf531c916fd5", "author": {"user": {"login": "artem-smotrakov", "name": "Artem Smotrakov"}}, "url": "https://github.com/netty/netty/commit/11724f28304a9dc8916dfb8d194edf531c916fd5", "committedDate": "2020-10-27T07:51:23Z", "message": "Enable header valication in HttpServerUpgradeHandler\n\nMotivation:\n\nHttpServerUpgradeHandler takes a list of protocols from an incoming\nrequest and uses them for building a response.\nAlthough the class does some validation while parsing the list,\nit then disables HTTP header validation when it builds a responst.\nThe disabled validation may potentially allow\nHTTP response splitting attacks.\n\nModifications:\n\n- Enabled HTTP header validation in HttpServerUpgradeHandler\n  as a defense-in-depth measure to prevent possible\n  HTTP response splitting attacks.\n- Added a new constructor that allows disabling the validation.\n\nResult:\n\nHttpServerUpgradeHandler validates incoming protocols\nbefore including them into a response.\nThat should prevent possible HTTP response splitting attacks."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNTM3MDY5", "url": "https://github.com/netty/netty/pull/10643#pullrequestreview-520537069", "createdAt": "2020-10-30T10:22:22Z", "commit": {"oid": "11724f28304a9dc8916dfb8d194edf531c916fd5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4899, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}