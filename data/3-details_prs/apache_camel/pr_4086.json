{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2NjA2Mjc3", "number": 4086, "title": "Inprove PropertyBindingSupport", "bodyText": "This PR adds support for arrays in PropertyBindingSupport and fix issues when binding to list when properties have gaps.\nSee tests in:\n\nPropertyBindingSupportArrayTest\nPropertyBindingSupportListTest\n\nsee:\n\nhttps://issues.apache.org/jira/browse/CAMEL-15396\nhttps://issues.apache.org/jira/browse/CAMEL-15397", "createdAt": "2020-08-12T08:22:13Z", "url": "https://github.com/apache/camel/pull/4086", "merged": true, "mergeCommit": {"oid": "ab54bed173977fa8d386a330002f2119b3441a3b"}, "closed": true, "closedAt": "2020-08-12T10:36:00Z", "author": {"login": "lburgazzoli"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-HOBJABqjM2NDY2MDU5NjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-I7NbAFqTQ2NTc4OTk4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a108bb1b6a62b7cc8efe1287e39186b6f1bcb3f", "author": {"user": {"login": "lburgazzoli", "name": "Luca Burgazzoli"}}, "url": "https://github.com/apache/camel/commit/4a108bb1b6a62b7cc8efe1287e39186b6f1bcb3f", "committedDate": "2020-08-12T08:21:51Z", "message": "Inprove PropertyBindingSupport\n\nThis PR adds support for arrays in PropertyBindingSupport and fix issues when binding to list when properties have gaps.\n\nSee tests in:\n- PropertyBindingSupport\n- PropertyBindingSupport"}, "afterCommit": {"oid": "5623af6a5b447e6da714b3a4907d8cc692231dea", "author": {"user": {"login": "lburgazzoli", "name": "Luca Burgazzoli"}}, "url": "https://github.com/apache/camel/commit/5623af6a5b447e6da714b3a4907d8cc692231dea", "committedDate": "2020-08-12T08:32:23Z", "message": "Inprove PropertyBindingSupport (CAMEL-15396, CAMEL-15397)\n\nThis PR adds support for arrays in PropertyBindingSupport and fix issues when binding to list when properties have gaps.\n\nSee tests in:\n- PropertyBindingSupportArrayTest\n- PropertyBindingSupportListTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NzA0NDM3", "url": "https://github.com/apache/camel/pull/4086#pullrequestreview-465704437", "createdAt": "2020-08-12T08:34:25Z", "commit": {"oid": "5623af6a5b447e6da714b3a4907d8cc692231dea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NzA1MjM2", "url": "https://github.com/apache/camel/pull/4086#pullrequestreview-465705236", "createdAt": "2020-08-12T08:35:29Z", "commit": {"oid": "4a108bb1b6a62b7cc8efe1287e39186b6f1bcb3f"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwODozNTo1NVrOG_XdKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwODo0MDowNFrOG_XmSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA5Nzc2OA==", "bodyText": "Looks a bit copy/paste mistake, as this is Array and not Map", "url": "https://github.com/apache/camel/pull/4086#discussion_r469097768", "createdAt": "2020-08-12T08:35:55Z", "author": {"login": "davsclaus"}, "path": "core/camel-support/src/main/java/org/apache/camel/support/PropertyBindingSupport.java", "diffHunk": "@@ -804,6 +826,38 @@ private static Object getOrElseProperty(CamelContext context, Object target, Str\n                     answer = list.get(list.size() - 1);\n                 }\n             }\n+        } else if (type != null && type.isArray() && lookupKey != null) {\n+            int idx = Integer.parseInt(lookupKey);\n+            int size = answer != null ? Array.getLength(answer) : 0;\n+            if (idx >= size) {\n+                answer = answer != null ? Arrays.copyOf((Object[]) answer, idx + 1) : Array.newInstance(Object.class, idx + 1);\n+            }\n+\n+            Object result = Array.get(answer, idx);\n+            if (result == null) {\n+                result = context.getInjector().newInstance(type.getComponentType());\n+                Array.set(answer, idx, result);\n+            }\n+\n+            if (idx >= size) {\n+                // replace array\n+                if (configurer != null) {\n+                    configurer.configure(context, target, key, answer, true);\n+                } else {\n+                    // fallback to reflection\n+                    boolean hit;\n+                    try {\n+                        hit = IntrospectionSupport.setProperty(context.getTypeConverter(), target, key, answer);\n+                    } catch (Exception e) {\n+                        throw new IllegalArgumentException(\"Cannot set property: \" + key + \" as a Map because target bean has no setter method for the Map\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5623af6a5b447e6da714b3a4907d8cc692231dea"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA5NzgyNQ==", "bodyText": "Looks a bit copy/paste mistake, as this is Array and not Map", "url": "https://github.com/apache/camel/pull/4086#discussion_r469097825", "createdAt": "2020-08-12T08:36:02Z", "author": {"login": "davsclaus"}, "path": "core/camel-support/src/main/java/org/apache/camel/support/PropertyBindingSupport.java", "diffHunk": "@@ -804,6 +826,38 @@ private static Object getOrElseProperty(CamelContext context, Object target, Str\n                     answer = list.get(list.size() - 1);\n                 }\n             }\n+        } else if (type != null && type.isArray() && lookupKey != null) {\n+            int idx = Integer.parseInt(lookupKey);\n+            int size = answer != null ? Array.getLength(answer) : 0;\n+            if (idx >= size) {\n+                answer = answer != null ? Arrays.copyOf((Object[]) answer, idx + 1) : Array.newInstance(Object.class, idx + 1);\n+            }\n+\n+            Object result = Array.get(answer, idx);\n+            if (result == null) {\n+                result = context.getInjector().newInstance(type.getComponentType());\n+                Array.set(answer, idx, result);\n+            }\n+\n+            if (idx >= size) {\n+                // replace array\n+                if (configurer != null) {\n+                    configurer.configure(context, target, key, answer, true);\n+                } else {\n+                    // fallback to reflection\n+                    boolean hit;\n+                    try {\n+                        hit = IntrospectionSupport.setProperty(context.getTypeConverter(), target, key, answer);\n+                    } catch (Exception e) {\n+                        throw new IllegalArgumentException(\"Cannot set property: \" + key + \" as a Map because target bean has no setter method for the Map\");\n+                    }\n+                    if (!hit) {\n+                        throw new IllegalArgumentException(\"Cannot set property: \" + key + \" as a Map because target bean has no setter method for the Map\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5623af6a5b447e6da714b3a4907d8cc692231dea"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA5OTE0Mw==", "bodyText": "Maybe this can be done later as you override type in case answer != null and other bits. So wonder if this can be moved down, and to get the type only if you have not computed it", "url": "https://github.com/apache/camel/pull/4086#discussion_r469099143", "createdAt": "2020-08-12T08:38:22Z", "author": {"login": "davsclaus"}, "path": "core/camel-support/src/main/java/org/apache/camel/support/PropertyBindingSupport.java", "diffHunk": "@@ -778,17 +781,36 @@ private static Object getOrElseProperty(CamelContext context, Object target, Str\n \n         // use configurer if possible\n         Object answer = null;\n-        GeneratedPropertyConfigurer configurer = context.adapt(ExtendedCamelContext.class).getConfigurerResolver().resolvePropertyConfigurer(target.getClass().getSimpleName(), context);\n+        Class<?> type = null;\n+\n+        GeneratedPropertyConfigurer configurer = PropertyConfigurerHelper.resolvePropertyConfigurer(context, target);\n         if (configurer instanceof PropertyConfigurerGetter) {\n-            answer = ((PropertyConfigurerGetter) configurer).getOptionValue(target, key, ignoreCase);\n+            type = (Class<?>)((PropertyConfigurerGetter)configurer).getAllOptions(target).get(key);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5623af6a5b447e6da714b3a4907d8cc692231dea"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA5OTc1MA==", "bodyText": "Wrong exception message Map -> Array", "url": "https://github.com/apache/camel/pull/4086#discussion_r469099750", "createdAt": "2020-08-12T08:39:31Z", "author": {"login": "davsclaus"}, "path": "core/camel-support/src/main/java/org/apache/camel/support/IntrospectionSupport.java", "diffHunk": "@@ -646,11 +649,43 @@ public static boolean setProperty(CamelContext context, TypeConverter typeConver\n                     value = CamelContextHelper.lookup(context, s);\n                 }\n                 if (isNotEmpty(lookupKey)) {\n-                    int idx = Integer.valueOf(lookupKey);\n-                    list.add(idx, value);\n+                    int idx = Integer.parseInt(lookupKey);\n+                    if (idx < list.size()) {\n+                        list.set(idx, value);\n+                    } else if (idx == list.size()) {\n+                        list.add(value);\n+                    } else {\n+                        if (list instanceof ArrayList) {\n+                            ((ArrayList) list).ensureCapacity(idx + 1);\n+                        }\n+                        while (list.size() < idx) {\n+                            list.add(null);\n+                        }\n+                        list.add(idx, value);\n+                    }\n                 } else {\n                     list.add(value);\n                 }\n+                return true;\n+            } else if (obj.getClass().isArray() && lookupKey != null) {\n+                if (context != null && refName != null && value == null) {\n+                    String s = StringHelper.replaceAll(refName, \"#\", \"\");\n+                    value = CamelContextHelper.lookup(context, s);\n+                }\n+                int idx = Integer.parseInt(lookupKey);\n+                int size = Array.getLength(obj);\n+                if (idx >= size) {\n+                    obj = Arrays.copyOf((Object[])obj, idx + 1);\n+\n+                    // replace array\n+                    boolean hit = IntrospectionSupport.setProperty(context, target, key, obj);\n+                    if (!hit) {\n+                        throw new IllegalArgumentException(\"Cannot set property: \" + name + \" as a Map because target bean has no setter method for the Map\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5623af6a5b447e6da714b3a4907d8cc692231dea"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTEwMDEwNw==", "bodyText": "Maybe add a code comment why you do this, eg to expand the array when there is gaps in the index", "url": "https://github.com/apache/camel/pull/4086#discussion_r469100107", "createdAt": "2020-08-12T08:40:04Z", "author": {"login": "davsclaus"}, "path": "core/camel-support/src/main/java/org/apache/camel/support/IntrospectionSupport.java", "diffHunk": "@@ -646,11 +649,43 @@ public static boolean setProperty(CamelContext context, TypeConverter typeConver\n                     value = CamelContextHelper.lookup(context, s);\n                 }\n                 if (isNotEmpty(lookupKey)) {\n-                    int idx = Integer.valueOf(lookupKey);\n-                    list.add(idx, value);\n+                    int idx = Integer.parseInt(lookupKey);\n+                    if (idx < list.size()) {\n+                        list.set(idx, value);\n+                    } else if (idx == list.size()) {\n+                        list.add(value);\n+                    } else {\n+                        if (list instanceof ArrayList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5623af6a5b447e6da714b3a4907d8cc692231dea"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e784dd5c5d2a44e6141c731442dceb7fc4c0b082", "author": {"user": {"login": "lburgazzoli", "name": "Luca Burgazzoli"}}, "url": "https://github.com/apache/camel/commit/e784dd5c5d2a44e6141c731442dceb7fc4c0b082", "committedDate": "2020-08-12T09:01:27Z", "message": "Inprove PropertyBindingSupport (CAMEL-15396, CAMEL-15397)\n\nThis PR adds support for arrays in PropertyBindingSupport and fix issues when binding to list when properties have gaps.\n\nSee tests in:\n- PropertyBindingSupportArrayTest\n- PropertyBindingSupportListTest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5623af6a5b447e6da714b3a4907d8cc692231dea", "author": {"user": {"login": "lburgazzoli", "name": "Luca Burgazzoli"}}, "url": "https://github.com/apache/camel/commit/5623af6a5b447e6da714b3a4907d8cc692231dea", "committedDate": "2020-08-12T08:32:23Z", "message": "Inprove PropertyBindingSupport (CAMEL-15396, CAMEL-15397)\n\nThis PR adds support for arrays in PropertyBindingSupport and fix issues when binding to list when properties have gaps.\n\nSee tests in:\n- PropertyBindingSupportArrayTest\n- PropertyBindingSupportListTest"}, "afterCommit": {"oid": "e784dd5c5d2a44e6141c731442dceb7fc4c0b082", "author": {"user": {"login": "lburgazzoli", "name": "Luca Burgazzoli"}}, "url": "https://github.com/apache/camel/commit/e784dd5c5d2a44e6141c731442dceb7fc4c0b082", "committedDate": "2020-08-12T09:01:27Z", "message": "Inprove PropertyBindingSupport (CAMEL-15396, CAMEL-15397)\n\nThis PR adds support for arrays in PropertyBindingSupport and fix issues when binding to list when properties have gaps.\n\nSee tests in:\n- PropertyBindingSupportArrayTest\n- PropertyBindingSupportListTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1Nzg5OTg0", "url": "https://github.com/apache/camel/pull/4086#pullrequestreview-465789984", "createdAt": "2020-08-12T10:33:18Z", "commit": {"oid": "e784dd5c5d2a44e6141c731442dceb7fc4c0b082"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2917, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}