{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1NTU3MDcw", "number": 3877, "title": "Camel 14935 kafka exception", "bodyText": "In KafkaConsumer, clear lastProcessedOffset if Exception on partition Revoked", "createdAt": "2020-05-31T04:01:47Z", "url": "https://github.com/apache/camel/pull/3877", "merged": true, "mergeCommit": {"oid": "711ab31c29615deffe5b7fe3dc4ba1235cbd9979"}, "closed": true, "closedAt": "2020-06-03T04:14:33Z", "author": {"login": "DariusX"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcmExUxAH2gAyNDI1NTU3MDcwOjlkZjYzNzY5ZDRlZDlmZmNjMGYyZDdhYTZiZDA0OTU1Y2NmMTVlMmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnhjLOgFqTQyMzIwNTk5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9df63769d4ed9ffcc0f2d7aa6bd04955ccf15e2f", "author": {"user": {"login": "DariusX", "name": "Darius"}}, "url": "https://github.com/apache/camel/commit/9df63769d4ed9ffcc0f2d7aa6bd04955ccf15e2f", "committedDate": "2020-05-29T16:08:42Z", "message": "CAMEL-14935: Fix issue with failing commits on rebalance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b8d7464360a2c9598225e5d3f85508c082eff6b", "author": {"user": {"login": "DariusX", "name": "Darius"}}, "url": "https://github.com/apache/camel/commit/2b8d7464360a2c9598225e5d3f85508c082eff6b", "committedDate": "2020-05-31T03:44:58Z", "message": "Log the exception on partion revoked, and rethrow"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNDYyODE3", "url": "https://github.com/apache/camel/pull/3877#pullrequestreview-421462817", "createdAt": "2020-05-31T05:30:04Z", "commit": {"oid": "2b8d7464360a2c9598225e5d3f85508c082eff6b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMVQwNTozMDowNFrOGc20Cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMVQwNTozMDowNFrOGc20Cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkxMTM3MQ==", "bodyText": "This finally block code is always exectued also for success. Is this really intended?", "url": "https://github.com/apache/camel/pull/3877#discussion_r432911371", "createdAt": "2020-05-31T05:30:04Z", "author": {"login": "davsclaus"}, "path": "components/camel-kafka/src/main/java/org/apache/camel/component/kafka/KafkaConsumer.java", "diffHunk": "@@ -460,7 +460,14 @@ public void onPartitionsRevoked(Collection<TopicPartition> partitions) {\n                     offset = -1L;\n                 }\n                 LOG.debug(\"Saving offset repository state {} from offsetKey {} with offset: {}\", threadId, offsetKey, offset);\n-                commitOffset(offsetRepository, partition, offset, true);\n+                try {\n+                    commitOffset(offsetRepository, partition, offset, true);\n+                } catch (java.lang.Exception e) {\n+                    LOG.error(\"Error saving offset repository state {} from offsetKey {} with offset: {}\", threadId, offsetKey, offset);\n+                    throw e;\n+                } finally {\n+                    lastProcessedOffset.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b8d7464360a2c9598225e5d3f85508c082eff6b"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNDYyODI5", "url": "https://github.com/apache/camel/pull/3877#pullrequestreview-421462829", "createdAt": "2020-05-31T05:30:22Z", "commit": {"oid": "2b8d7464360a2c9598225e5d3f85508c082eff6b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNjE5NTg1", "url": "https://github.com/apache/camel/pull/3877#pullrequestreview-421619585", "createdAt": "2020-06-01T06:28:59Z", "commit": {"oid": "2b8d7464360a2c9598225e5d3f85508c082eff6b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNDAyNTk5", "url": "https://github.com/apache/camel/pull/3877#pullrequestreview-422402599", "createdAt": "2020-06-02T07:16:30Z", "commit": {"oid": "2b8d7464360a2c9598225e5d3f85508c082eff6b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwNzoxNjozMFrOGdk_ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwNzoxNjozMFrOGdk_ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY2ODAzNQ==", "bodyText": "What if you move the clear up here, and remove it from finally. Then its only cleared when there is an exception. And on success then the code below will only remove the current offset key, which seems correct to me.", "url": "https://github.com/apache/camel/pull/3877#discussion_r433668035", "createdAt": "2020-06-02T07:16:30Z", "author": {"login": "davsclaus"}, "path": "components/camel-kafka/src/main/java/org/apache/camel/component/kafka/KafkaConsumer.java", "diffHunk": "@@ -460,7 +460,14 @@ public void onPartitionsRevoked(Collection<TopicPartition> partitions) {\n                     offset = -1L;\n                 }\n                 LOG.debug(\"Saving offset repository state {} from offsetKey {} with offset: {}\", threadId, offsetKey, offset);\n-                commitOffset(offsetRepository, partition, offset, true);\n+                try {\n+                    commitOffset(offsetRepository, partition, offset, true);\n+                } catch (java.lang.Exception e) {\n+                    LOG.error(\"Error saving offset repository state {} from offsetKey {} with offset: {}\", threadId, offsetKey, offset);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b8d7464360a2c9598225e5d3f85508c082eff6b"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cf1efe5e11d3160cd7ef8bbe0b74a03d9adbe62", "author": {"user": {"login": "DariusX", "name": "Darius"}}, "url": "https://github.com/apache/camel/commit/3cf1efe5e11d3160cd7ef8bbe0b74a03d9adbe62", "committedDate": "2020-06-03T00:29:25Z", "message": "Fixed, based on pull request feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMjA1OTkx", "url": "https://github.com/apache/camel/pull/3877#pullrequestreview-423205991", "createdAt": "2020-06-03T04:14:25Z", "commit": {"oid": "3cf1efe5e11d3160cd7ef8bbe0b74a03d9adbe62"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2981, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}