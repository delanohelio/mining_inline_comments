{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MjcxNDI2", "number": 276, "title": "ShardedIntegrityChecksSparkJob RDD Union Removal", "bodyText": "Description:\nIn earlier designs of the ShardedIntegrityChecksSparkJob it was necessary to gather all UniqueCheckFlagContainers together into a single RDD. This was required to perform a sorting and reduction process to countrify the results. Now that the tasks are parallelized in a countrified manor this is no longer necessary, and causes spark to perform a very large, unnecessary shuffle operation.\nThis removes the RDD union in favor of running the flag reduction and file writing operations as part of each countrified stream. This should increase performance for the job on clusters by reducing the amount of communication necessary between executors.\nWith the removal of the union it is no longer necessary to persist any RDDs. As such, the spark storage option is no longer needed, and has been removed.\nPotential Impact:\nShould improve performance and stability when running on a cluster.\nUnit Test Approach:\nNo changes to unit tests.\nTest Results:\nTested locally on 5 small countries. Results were identical to those produced before the enhancement.", "createdAt": "2020-04-03T16:31:27Z", "url": "https://github.com/osmlab/atlas-checks/pull/276", "merged": true, "mergeCommit": {"oid": "5833fd20df2672c0162cf7fa789c2c87e74673b1"}, "closed": true, "closedAt": "2020-04-07T22:01:49Z", "author": {"login": "Bentleysb"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcT0d6pgH2gAyMzk4MjcxNDI2Ojk4NWNmOGE5YzBiNjJjMTYyNThiMWU5MDU5YTYyMTQ5MWE3YjZkNjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVZrIpAH2gAyMzk4MjcxNDI2OjYyOTQ4ZDQ4MDVhZTcyZDg4NWM0ZWM2NzA2NTVhMTQ1M2E2NzgxN2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "985cf8a9c0b62c16258b1e9059a621491a7b6d63", "author": {"user": {"login": "Bentleysb", "name": "Bentley Breithaupt"}}, "url": "https://github.com/osmlab/atlas-checks/commit/985cf8a9c0b62c16258b1e9059a621491a7b6d63", "committedDate": "2020-04-02T22:58:23Z", "message": "no union"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9ea1d0aa2841b0eec7a7231c2efd3a02fbef90b", "author": {"user": {"login": "Bentleysb", "name": "Bentley Breithaupt"}}, "url": "https://github.com/osmlab/atlas-checks/commit/f9ea1d0aa2841b0eec7a7231c2efd3a02fbef90b", "committedDate": "2020-04-03T16:30:26Z", "message": "update doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NTQ3OTY1", "url": "https://github.com/osmlab/atlas-checks/pull/276#pullrequestreview-387547965", "createdAt": "2020-04-03T20:07:26Z", "commit": {"oid": "f9ea1d0aa2841b0eec7a7231c2efd3a02fbef90b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMDowNzoyN1rOGAnFog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMDowNzoyN1rOGAnFog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI5MzYwMg==", "bodyText": "What is callSite.short ?", "url": "https://github.com/osmlab/atlas-checks/pull/276#discussion_r403293602", "createdAt": "2020-04-03T20:07:27Z", "author": {"login": "danielduhh"}, "path": "src/main/java/org/openstreetmap/atlas/checks/distributed/ShardedIntegrityChecksSparkJob.java", "diffHunk": "@@ -219,46 +204,27 @@ public void start(final CommandMap commandMap)\n                             .collect(Collectors.toList());\n \n                     // Set spark UI job title\n-                    this.getContext().setJobGroup(\"0\",\n-                            String.format(\"Running checks on %s\",\n-                                    tasksForCountry.get(0).getCountry()));\n-                    // Run each task in spark, producing UniqueCheckFlagContainers\n-                    final JavaPairRDD<String, UniqueCheckFlagContainer> rdd = this.getContext()\n-                            .parallelize(tasksForCountry, tasksForCountry.size())\n+                    this.getContext().setLocalProperty(\"callSite.short\", String", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9ea1d0aa2841b0eec7a7231c2efd3a02fbef90b"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e33cb5e74744d07750ba7dda74b348eebc8b7ae2", "author": {"user": null}, "url": "https://github.com/osmlab/atlas-checks/commit/e33cb5e74744d07750ba7dda74b348eebc8b7ae2", "committedDate": "2020-04-07T01:55:41Z", "message": "Merge branch 'dev' into dev-shardedChecksNoUnion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzQyNDk0", "url": "https://github.com/osmlab/atlas-checks/pull/276#pullrequestreview-389342494", "createdAt": "2020-04-07T17:35:55Z", "commit": {"oid": "e33cb5e74744d07750ba7dda74b348eebc8b7ae2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzozNTo1NVrOGCOr-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzozNTo1NVrOGCOr-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5MDk3MA==", "bodyText": "What are we combining here, if not by country?", "url": "https://github.com/osmlab/atlas-checks/pull/276#discussion_r404990970", "createdAt": "2020-04-07T17:35:55Z", "author": {"login": "seancoulter"}, "path": "src/main/java/org/openstreetmap/atlas/checks/distributed/ShardedIntegrityChecksSparkJob.java", "diffHunk": "@@ -219,46 +204,27 @@ public void start(final CommandMap commandMap)\n                             .collect(Collectors.toList());\n \n                     // Set spark UI job title\n-                    this.getContext().setJobGroup(\"0\",\n-                            String.format(\"Running checks on %s\",\n-                                    tasksForCountry.get(0).getCountry()));\n-                    // Run each task in spark, producing UniqueCheckFlagContainers\n-                    final JavaPairRDD<String, UniqueCheckFlagContainer> rdd = this.getContext()\n-                            .parallelize(tasksForCountry, tasksForCountry.size())\n+                    this.getContext().setLocalProperty(\"callSite.short\", String\n+                            .format(\"Running checks on %s\", tasksForCountry.get(0).getCountry()));\n+\n+                    this.getContext().parallelize(tasksForCountry, tasksForCountry.size())\n                             .mapToPair(produceFlags(input, output, this.configurationMap(),\n                                     fileHelper, shardingBroadcast, distanceToLoadShards,\n-                                    (Boolean) commandMap.get(MULTI_ATLAS)));\n-                    // Save the RDD\n-                    rdd.persist(storageLevel);\n-                    // Use a fast spark action to overcome spark lazy elocution. This is necessary\n-                    // to get the UI title to appear in the right spot.\n-                    rdd.count();\n-                    // Add the RDDs to the list\n-                    countryRdds.add(rdd);\n+                                    (Boolean) commandMap.get(MULTI_ATLAS)))\n+                            .reduceByKey(UniqueCheckFlagContainer::combine)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e33cb5e74744d07750ba7dda74b348eebc8b7ae2"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzkyMDkx", "url": "https://github.com/osmlab/atlas-checks/pull/276#pullrequestreview-389392091", "createdAt": "2020-04-07T18:42:41Z", "commit": {"oid": "e33cb5e74744d07750ba7dda74b348eebc8b7ae2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f00323326a052e08e92ccc44cbc98f4adba1ab5c", "author": {"user": null}, "url": "https://github.com/osmlab/atlas-checks/commit/f00323326a052e08e92ccc44cbc98f4adba1ab5c", "committedDate": "2020-04-07T18:43:00Z", "message": "Merge branch 'dev' into dev-shardedChecksNoUnion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62948d4805ae72d885c4ec670655a1453a67817e", "author": {"user": null}, "url": "https://github.com/osmlab/atlas-checks/commit/62948d4805ae72d885c4ec670655a1453a67817e", "committedDate": "2020-04-07T20:53:14Z", "message": "Merge branch 'dev' into dev-shardedChecksNoUnion"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3301, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}