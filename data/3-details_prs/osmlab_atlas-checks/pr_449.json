{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNDU2OTkz", "number": 449, "title": "Add AutoFix suggestion to \"wrong direction\" cases only.", "bodyText": "Description:\nAutoFix suggestion to \"wrong roundabout direction\" cases only. Please refer #387\nPotential Impact:\nRoundabouts with wrong direction will be suggested with AutoFix\nUnit Test Approach:\n\nModify all existent cases for precise error handling\nAdd AutoFix verifier to \"wrong direction\" test cases\n\nTest Results:\nPassed", "createdAt": "2020-12-16T21:44:20Z", "url": "https://github.com/osmlab/atlas-checks/pull/449", "merged": true, "mergeCommit": {"oid": "8d1a5b632ce73be550b1c418f2b6981ce7ef1c90"}, "closed": true, "closedAt": "2021-01-11T23:50:19Z", "author": {"login": "vladlemberg"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm19oxgH2gAyNTQxNDU2OTkzOjI0ODI0ZTNkMjg3Y2U4YWQ4YWNkYjI4YzkzZTVlZjI5NjExOWNmYzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvNbTkAFqTU2NTc1Mzg4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "24824e3d287ce8ad8acdb28c93e5ef296119cfc2", "author": {"user": {"login": "vladlemberg", "name": "Vladimir Lemberg"}}, "url": "https://github.com/osmlab/atlas-checks/commit/24824e3d287ce8ad8acdb28c93e5ef296119cfc2", "committedDate": "2020-12-16T21:38:39Z", "message": "Add AutoFix suggestion to \"wrong direction\" cases only. https://github.com/osmlab/atlas-checks/issues/387\nAdd more granular error checking in unittest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "691114a5d646d6e396f256fc3bc5ebf46762dcc9", "author": {"user": {"login": "vladlemberg", "name": "Vladimir Lemberg"}}, "url": "https://github.com/osmlab/atlas-checks/commit/691114a5d646d6e396f256fc3bc5ebf46762dcc9", "committedDate": "2020-12-16T22:42:05Z", "message": "spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MTY0MTk1", "url": "https://github.com/osmlab/atlas-checks/pull/449#pullrequestreview-554164195", "createdAt": "2020-12-16T23:20:07Z", "commit": {"oid": "691114a5d646d6e396f256fc3bc5ebf46762dcc9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMzoyMDowOFrOIHdfVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMzoyMDowOFrOIHdfVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY5NDEwMA==", "bodyText": "A roundabout can be made up of multiple Ways, so to would be better to use the roundaboutEdgeSet here.", "url": "https://github.com/osmlab/atlas-checks/pull/449#discussion_r544694100", "createdAt": "2020-12-16T23:20:08Z", "author": {"login": "Bentleysb"}, "path": "src/main/java/org/openstreetmap/atlas/checks/validation/linear/edges/MalformedRoundaboutCheck.java", "diffHunk": "@@ -99,17 +104,43 @@ public boolean validCheckForObject(final AtlasObject object)\n         // Create a ComplexRoundabout based on object\n         final ComplexRoundabout complexRoundabout = new ComplexRoundabout((Edge) object,\n                 this.leftDrivingCountries);\n-        // If the ComplexRoundbaout is invalid add the reasons why to the instructions, so that it\n-        // will be flagged\n-        if (!complexRoundabout.isValid())\n-        {\n-            instructions.addAll(complexRoundabout.getAllInvalidations().stream()\n-                    .map(ComplexEntity.ComplexEntityError::getReason).collect(Collectors.toSet()));\n-        }\n         // Get the roundabout Edges\n         final Set<Edge> roundaboutEdgeSet = complexRoundabout.getRoundaboutEdgeSet();\n         // Get the roundabout Route\n         final Route roundaboutEdges = complexRoundabout.getRoundaboutRoute();\n+\n+        // If the ComplexRoundabout is invalid add the reasons why to the instructions, so that it\n+        // will be flagged\n+        if (!complexRoundabout.isValid())\n+        {\n+            // AutoFix candidate only for wrong direction case.\n+            if (complexRoundabout.getAllInvalidations().size() == 1 && complexRoundabout\n+                    .getAllInvalidations().get(0).getReason().equals(WRONG_WAY_INVALIDATION))\n+            {\n+                // Mark that the Edges have been processed\n+                roundaboutEdgeSet.forEach(\n+                        roundaboutEdge -> this.markAsFlagged(roundaboutEdge.getIdentifier()));\n+\n+                return Optional.of(this\n+                        .createFlag(new OsmWayWalker((Edge) object).collectEdges(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "691114a5d646d6e396f256fc3bc5ebf46762dcc9"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be9fe583fdc230a2576db3322f5be4907450ff3a", "author": {"user": {"login": "vladlemberg", "name": "Vladimir Lemberg"}}, "url": "https://github.com/osmlab/atlas-checks/commit/be9fe583fdc230a2576db3322f5be4907450ff3a", "committedDate": "2020-12-16T23:44:59Z", "message": "handling case when ComplexRoundabout has multiple Edge Set potentially with different OSM IDs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55a560d840a4b0bd3d9ab047abda8767ae4780e1", "author": {"user": {"login": "vladlemberg", "name": "Vladimir Lemberg"}}, "url": "https://github.com/osmlab/atlas-checks/commit/55a560d840a4b0bd3d9ab047abda8767ae4780e1", "committedDate": "2020-12-16T23:52:01Z", "message": "cosmetic change for Instruction Message consistency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MTgxMDEz", "url": "https://github.com/osmlab/atlas-checks/pull/449#pullrequestreview-554181013", "createdAt": "2020-12-16T23:59:58Z", "commit": {"oid": "55a560d840a4b0bd3d9ab047abda8767ae4780e1"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MTg0MTU4", "url": "https://github.com/osmlab/atlas-checks/pull/449#pullrequestreview-554184158", "createdAt": "2020-12-17T00:07:51Z", "commit": {"oid": "55a560d840a4b0bd3d9ab047abda8767ae4780e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMDowNzo1MlrOIHep1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMDowNzo1MlrOIHep1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcxMzE3NA==", "bodyText": "Sorry, I misread this slightly the first time. As well as flagging each edge in roundaboutEdgeSet, as you have now done, each of those edges also needs its own fix suggestion to reverse the geometry.", "url": "https://github.com/osmlab/atlas-checks/pull/449#discussion_r544713174", "createdAt": "2020-12-17T00:07:52Z", "author": {"login": "Bentleysb"}, "path": "src/main/java/org/openstreetmap/atlas/checks/validation/linear/edges/MalformedRoundaboutCheck.java", "diffHunk": "@@ -99,17 +103,43 @@ public boolean validCheckForObject(final AtlasObject object)\n         // Create a ComplexRoundabout based on object\n         final ComplexRoundabout complexRoundabout = new ComplexRoundabout((Edge) object,\n                 this.leftDrivingCountries);\n-        // If the ComplexRoundbaout is invalid add the reasons why to the instructions, so that it\n-        // will be flagged\n-        if (!complexRoundabout.isValid())\n-        {\n-            instructions.addAll(complexRoundabout.getAllInvalidations().stream()\n-                    .map(ComplexEntity.ComplexEntityError::getReason).collect(Collectors.toSet()));\n-        }\n         // Get the roundabout Edges\n         final Set<Edge> roundaboutEdgeSet = complexRoundabout.getRoundaboutEdgeSet();\n         // Get the roundabout Route\n         final Route roundaboutEdges = complexRoundabout.getRoundaboutRoute();\n+\n+        // If the ComplexRoundabout is invalid add the reasons why to the instructions, so that it\n+        // will be flagged\n+        if (!complexRoundabout.isValid())\n+        {\n+            // AutoFix candidate only for wrong direction case.\n+            if (complexRoundabout.getAllInvalidations().size() == 1 && complexRoundabout\n+                    .getAllInvalidations().get(0).getReason().equals(WRONG_WAY_INSTRUCTIONS))\n+            {\n+                // Mark that the Edges have been processed\n+                roundaboutEdgeSet.forEach(\n+                        roundaboutEdge -> this.markAsFlagged(roundaboutEdge.getIdentifier()));\n+\n+                return Optional.of(this\n+                        .createFlag(roundaboutEdgeSet,\n+                                this.getLocalizedInstruction(1, object.getOsmIdentifier()))\n+                        .addFixSuggestion(FeatureChange.add(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55a560d840a4b0bd3d9ab047abda8767ae4780e1"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc2f9f7b2c0b4b818f8e4b70e996d49b82916e8e", "author": {"user": {"login": "vladlemberg", "name": "Vladimir Lemberg"}}, "url": "https://github.com/osmlab/atlas-checks/commit/bc2f9f7b2c0b4b818f8e4b70e996d49b82916e8e", "committedDate": "2021-01-05T23:01:21Z", "message": "Removed Multi Way Roundabout from AutoFix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "691def65458b42770d8b7eeab20a4609f74662ee", "author": {"user": {"login": "vladlemberg", "name": "Vladimir Lemberg"}}, "url": "https://github.com/osmlab/atlas-checks/commit/691def65458b42770d8b7eeab20a4609f74662ee", "committedDate": "2021-01-05T23:08:35Z", "message": "arrangement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abd51f93eaa8f4358e04ae5875ac3755d81137fe", "author": {"user": {"login": "vladlemberg", "name": "Vladimir Lemberg"}}, "url": "https://github.com/osmlab/atlas-checks/commit/abd51f93eaa8f4358e04ae5875ac3755d81137fe", "committedDate": "2021-01-05T23:12:42Z", "message": "arrangement 2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMDc2MDUx", "url": "https://github.com/osmlab/atlas-checks/pull/449#pullrequestreview-563076051", "createdAt": "2021-01-06T22:17:39Z", "commit": {"oid": "bc2f9f7b2c0b4b818f8e4b70e996d49b82916e8e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQyMjoxNzozOVrOIPX-Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQyMjoxNzozOVrOIPX-Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk5MjI5OA==", "bodyText": "This is an interesting way to combine the edges into a single fix suggestion. It could result in some nondeterminism due to taking on the atlas id of the starting object, but I think that is ok in this instance.", "url": "https://github.com/osmlab/atlas-checks/pull/449#discussion_r552992298", "createdAt": "2021-01-06T22:17:39Z", "author": {"login": "Bentleysb"}, "path": "src/main/java/org/openstreetmap/atlas/checks/validation/linear/edges/MalformedRoundaboutCheck.java", "diffHunk": "@@ -112,28 +114,32 @@ public boolean validCheckForObject(final AtlasObject object)\n         // will be flagged\n         if (!complexRoundabout.isValid())\n         {\n-            // AutoFix candidate only for wrong direction case.\n-            if (complexRoundabout.getAllInvalidations().size() == 1 && complexRoundabout\n-                    .getAllInvalidations().get(0).getReason().equals(WRONG_WAY_INSTRUCTIONS))\n+            // AutoFix candidate only for Single Way Roundabout with wrong direction.\n+            if (complexRoundabout.getAllInvalidations().size() == 1\n+                    && complexRoundabout.getAllInvalidations().get(0).getReason()\n+                            .equals(WRONG_WAY_INSTRUCTIONS)\n+                    && !this.isMultiWayRoundabout(roundaboutEdgeSet))\n             {\n                 // Mark that the Edges have been processed\n                 roundaboutEdgeSet.forEach(\n                         roundaboutEdge -> this.markAsFlagged(roundaboutEdge.getIdentifier()));\n \n                 return Optional.of(this\n-                        .createFlag(roundaboutEdgeSet,\n+                        .createFlag(new OsmWayWalker((Edge) object).collectEdges(),\n                                 this.getLocalizedInstruction(1, object.getOsmIdentifier()))\n-                        .addFixSuggestion(FeatureChange.add(\n-                                (AtlasEntity) ((CompleteEntity) CompleteEntity\n-                                        .from((AtlasEntity) object)).withGeometry(\n-                                                ((Edge) object).asPolyLine().reversed()),\n-                                object.getAtlas())));\n+                        .addFixSuggestion(\n+                                FeatureChange.add(\n+                                        (AtlasEntity) ((CompleteEntity) CompleteEntity\n+                                                .from((AtlasEntity) object)).withGeometry(\n+                                                        CommonMethods.buildOriginalOsmWayGeometry(\n+                                                                (Edge) object).reversed()),\n+                                        object.getAtlas())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc2f9f7b2c0b4b818f8e4b70e996d49b82916e8e"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1NzUzODg4", "url": "https://github.com/osmlab/atlas-checks/pull/449#pullrequestreview-565753888", "createdAt": "2021-01-11T21:30:16Z", "commit": {"oid": "abd51f93eaa8f4358e04ae5875ac3755d81137fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3242, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}