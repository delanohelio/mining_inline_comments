{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2ODk5NzI3", "number": 1232, "title": "gRPC compression compatibility tests", "bodyText": "Motivation:\nInclude compression support for compatibility tests of grpc-java and ServiceTalk\nModifications:\nModified existing test-suite to use compression logic too.\nResult:\nVerify compatibility between the two libraries.", "createdAt": "2020-11-25T00:39:40Z", "url": "https://github.com/apple/servicetalk/pull/1232", "merged": true, "mergeCommit": {"oid": "de179dd287acfa68b47700c6792c5f1952a4a636"}, "closed": true, "closedAt": "2020-12-04T11:27:22Z", "author": {"login": "tkountis"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgAmq5gBqjQwMzg4MTYwNjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdisKorABqjQwNzAzNTE4ODI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "caeb65fb284274fdb00941002c6cbeec7ec9153c", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/caeb65fb284274fdb00941002c6cbeec7ec9153c", "committedDate": "2020-11-25T00:16:20Z", "message": "Include compression for compat checks"}, "afterCommit": {"oid": "0f9da074061a032b2583088d598487cf21912030", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/0f9da074061a032b2583088d598487cf21912030", "committedDate": "2020-11-25T16:04:43Z", "message": "Include compression for compat checks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f9da074061a032b2583088d598487cf21912030", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/0f9da074061a032b2583088d598487cf21912030", "committedDate": "2020-11-25T16:04:43Z", "message": "Include compression for compat checks"}, "afterCommit": {"oid": "3e832ecb23d685dab815bb82dece070cb417458d", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/3e832ecb23d685dab815bb82dece070cb417458d", "committedDate": "2020-11-25T16:09:11Z", "message": "Include compression for compat checks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e832ecb23d685dab815bb82dece070cb417458d", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/3e832ecb23d685dab815bb82dece070cb417458d", "committedDate": "2020-11-25T16:09:11Z", "message": "Include compression for compat checks"}, "afterCommit": {"oid": "f459d7d15295683ecc83469bc4f453dc3f2cac13", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/f459d7d15295683ecc83469bc4f453dc3f2cac13", "committedDate": "2020-11-25T17:19:01Z", "message": "Include compression for compat checks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNDY0NjM4", "url": "https://github.com/apple/servicetalk/pull/1232#pullrequestreview-541464638", "createdAt": "2020-12-01T03:33:01Z", "commit": {"oid": "f459d7d15295683ecc83469bc4f453dc3f2cac13"}, "state": "APPROVED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMzozMzowMVrOH8W2Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMzo1MjoyMlrOH8XKhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1MDkyMw==", "bodyText": "We do not need to explicitly add @Nonnull annotation, it's always added via @ElementsAreNonnullByDefault.", "url": "https://github.com/apple/servicetalk/pull/1232#discussion_r533050923", "createdAt": "2020-12-01T03:33:01Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/netty/ProtocolCompatibilityTest.java", "diffHunk": "@@ -758,10 +896,38 @@ public void serverStreamingCall(final GrpcServiceContext ctx, final CompatReques\n                             responseWriter.write(computeResponse(i));\n                         }\n                     }\n-                }));\n+                }, codings));\n         return TestServerContext.fromServiceTalkServerContext(serverContext);\n     }\n \n+    @Nonnull", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f459d7d15295683ecc83469bc4f453dc3f2cac13"}, "originalPosition": 819}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1MDk0OQ==", "bodyText": "Same", "url": "https://github.com/apple/servicetalk/pull/1232#discussion_r533050949", "createdAt": "2020-12-01T03:33:07Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/netty/ProtocolCompatibilityTest.java", "diffHunk": "@@ -758,10 +896,38 @@ public void serverStreamingCall(final GrpcServiceContext ctx, final CompatReques\n                             responseWriter.write(computeResponse(i));\n                         }\n                     }\n-                }));\n+                }, codings));\n         return TestServerContext.fromServiceTalkServerContext(serverContext);\n     }\n \n+    @Nonnull\n+    private static ContentCodec serviceTalkCodingFor(@Nullable final String compression) {\n+        if (compression == null || compression.contentEquals(identity().name())) {\n+            return identity();\n+        }\n+\n+        if (compression.contentEquals(gzipDefault().name())) {\n+            return gzipDefault();\n+        }\n+\n+        throw new UnsupportedOperationException(\"Unsupported compression \" + compression);\n+    }\n+\n+    @Nonnull", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f459d7d15295683ecc83469bc4f453dc3f2cac13"}, "originalPosition": 832}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1MTIwOA==", "bodyText": "The value of compression is always gzip. Consider removing it.", "url": "https://github.com/apple/servicetalk/pull/1232#discussion_r533051208", "createdAt": "2020-12-01T03:34:13Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/netty/ProtocolCompatibilityTest.java", "diffHunk": "@@ -546,88 +643,122 @@ private static void testStreamResetOnUnexpectedErrorOnServiceTalkServer(final Co\n         }\n     }\n \n+    private static void testGrpcCompressionError(final CompatClient client, final TestServerContext server,\n+                                                 final boolean streaming,\n+                                                 @Nullable final String compression) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f459d7d15295683ecc83469bc4f453dc3f2cac13"}, "originalPosition": 617}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1MjEwMA==", "bodyText": "Why did you add o? It's unused.", "url": "https://github.com/apple/servicetalk/pull/1232#discussion_r533052100", "createdAt": "2020-12-01T03:37:06Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/netty/ProtocolCompatibilityTest.java", "diffHunk": "@@ -546,88 +643,122 @@ private static void testStreamResetOnUnexpectedErrorOnServiceTalkServer(final Co\n         }\n     }\n \n+    private static void testGrpcCompressionError(final CompatClient client, final TestServerContext server,\n+                                                 final boolean streaming,\n+                                                 @Nullable final String compression) throws Exception {\n+        if (streaming) {\n+            testGrpcErrorStreaming(client, server, false, compression);\n+        } else {\n+            testGrpcErrorScalar(client, server, false, compression);\n+        }\n+    }\n+\n+\n     private static void testGrpcError(final CompatClient client, final TestServerContext server,\n                                       final boolean withStatus, final boolean streaming)\n             throws Exception {\n         if (streaming) {\n-            testGrpcErrorStreaming(client, server, withStatus);\n+            testGrpcErrorStreaming(client, server, withStatus, null);\n         } else {\n-            testGrpcErrorScalar(client, server, withStatus);\n+            testGrpcErrorScalar(client, server, withStatus, null);\n         }\n     }\n \n     private static void testGrpcErrorStreaming(final CompatClient client, final TestServerContext server,\n-                                               final boolean withStatus)\n+                                               final boolean withStatus, @Nullable final String compression)\n             throws Exception {\n         try {\n-            final Publisher<CompatResponse> streamingResponse = client.bidirectionalStreamingCall(Publisher.from(\n-                    CompatRequest.newBuilder().setId(3).build(),\n-                    CompatRequest.newBuilder().setId(4).build(),\n-                    CompatRequest.newBuilder().setId(5).build()\n-            ));\n-            validateGrpcErrorInResponse(streamingResponse.toFuture(), withStatus);\n+            BidirectionalStreamingCallMetadata metadata = BidirectionalStreamingCallMetadata.INSTANCE;\n+            if (compression != null) {\n+                metadata = new BidirectionalStreamingCallMetadata(serviceTalkCodingFor(compression));\n+            }\n+\n+            final Publisher<CompatResponse> streamingResponse = client.bidirectionalStreamingCall(metadata,\n+                    Publisher.from(CompatRequest.newBuilder().setId(3).build(),\n+                            CompatRequest.newBuilder().setId(4).build(),\n+                            CompatRequest.newBuilder().setId(5).build()\n+                    ));\n+\n+            validateGrpcErrorInResponse(streamingResponse.toFuture(), withStatus, compression != null);\n         } finally {\n             closeAll(client, server);\n         }\n     }\n \n     private static void testGrpcErrorScalar(final CompatClient client, final TestServerContext server,\n-                                            final boolean withStatus)\n+                                            final boolean withStatus, @Nullable final String compression)\n             throws Exception {\n         try {\n+            ScalarCallMetadata metadata = ScalarCallMetadata.INSTANCE;\n+            if (compression != null) {\n+                metadata = new ScalarCallMetadata(serviceTalkCodingFor(compression));\n+            }\n+\n             final Single<CompatResponse> scalarResponse =\n-                    client.scalarCall(CompatRequest.newBuilder().setId(1).build());\n+                    client.scalarCall(metadata, CompatRequest.newBuilder().setId(1).build());\n \n-            validateGrpcErrorInResponse(scalarResponse.toFuture(), withStatus);\n+            validateGrpcErrorInResponse(scalarResponse.toFuture(), withStatus, compression != null);\n         } finally {\n             closeAll(client, server);\n         }\n     }\n \n-    private static void validateGrpcErrorInResponse(final Future<?> future, final boolean withStatus)\n+    private static void validateGrpcErrorInResponse(final Future<?> future, final boolean withStatus,\n+                                                    final boolean withCompressionError)\n             throws InvalidProtocolBufferException {\n         try {\n-            future.get();\n+            final Object o = future.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f459d7d15295683ecc83469bc4f453dc3f2cac13"}, "originalPosition": 693}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1MjMwOQ==", "bodyText": "While you are here, please remove throws Exception, it's never thrown from this test.", "url": "https://github.com/apple/servicetalk/pull/1232#discussion_r533052309", "createdAt": "2020-12-01T03:38:01Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/netty/ProtocolCompatibilityTest.java", "diffHunk": "@@ -480,42 +565,54 @@ private static void testBlockingRequestResponse(final BlockingCompatClient clien\n     }\n \n     private static void testRequestResponse(final CompatClient client, final TestServerContext server,\n-                                            final boolean streaming) throws Exception {\n+                                            final boolean streaming,\n+                                            @Nullable final String compression) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f459d7d15295683ecc83469bc4f453dc3f2cac13"}, "originalPosition": 552}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1Mzk0OA==", "bodyText": "The serviceTalkCodingFor method returns identity() when compresion == null. Can we return null in this case and use ScalarCallMetadata.INSTANCE later? It will verify a case when compression is not specified, similar to client.scalarCall(request) (without meta-data param).\nSame for the streaming variant, we can use ClientStreamingCallMetadata.INSTANCE.", "url": "https://github.com/apple/servicetalk/pull/1232#discussion_r533053948", "createdAt": "2020-12-01T03:44:16Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/netty/ProtocolCompatibilityTest.java", "diffHunk": "@@ -165,295 +174,369 @@ public SocketAddress listenAddress() {\n     @DataPoints(\"streaming\")\n     public static boolean[] streaming = {false, true};\n \n+    @DataPoints(\"compression\")\n+    public static String[] compression = {\"gzip\", \"identity\", null};\n+\n     @Rule\n     public final Timeout timeout = new ServiceTalkTestTimeout();\n \n     @Theory\n     public void grpcJavaToGrpcJava(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                   @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = grpcJavaServer(ErrorMode.NONE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n-        testRequestResponse(client, server, streaming);\n+                                   @FromDataPoints(\"streaming\") final boolean streaming,\n+                                   @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = grpcJavaServer(ErrorMode.NONE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n+        testRequestResponse(client, server, streaming, compression);\n     }\n \n     @Theory\n     public void serviceTalkToGrpcJava(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                      @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = grpcJavaServer(ErrorMode.NONE, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n-        testRequestResponse(client, server, streaming);\n+                                      @FromDataPoints(\"streaming\") final boolean streaming,\n+                                      @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = grpcJavaServer(ErrorMode.NONE, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n+        testRequestResponse(client, server, streaming, compression);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalk(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                      @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.NONE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n-        testRequestResponse(client, server, streaming);\n+                                      @FromDataPoints(\"streaming\") final boolean streaming,\n+                                      @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = serviceTalkServer(ErrorMode.NONE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n+        testRequestResponse(client, server, streaming, compression);\n+    }\n+\n+    @Theory\n+    public void serviceTalkToServiceTalk(@FromDataPoints(\"ssl\") final boolean ssl,\n+                                         @FromDataPoints(\"streaming\") final boolean streaming,\n+                                         @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = serviceTalkServer(ErrorMode.NONE, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n+        testRequestResponse(client, server, streaming, compression);\n     }\n \n-    @Ignore(\"gRPC compression not supported by ServiceTalk yet\")\n     @Theory\n-    public void grpcJavaToServiceTalkCompressedGzip(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                    @FromDataPoints(\"streaming\") final boolean streaming)\n+    public void serviceTalkBlockingToServiceTalkBlocking(@FromDataPoints(\"ssl\") final boolean ssl,\n+                                                         @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                         @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.NONE, ssl);\n-        // Only gzip is supported by GRPC out of the box atm.\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), \"gzip\", ssl);\n-        testRequestResponse(client, server, streaming);\n+        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.NONE, ssl, compression);\n+        final BlockingCompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression)\n+                .asBlockingClient();\n+        testBlockingRequestResponse(client, server, streaming, compression);\n     }\n \n     @Theory\n-    public void serviceTalkToServiceTalk(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                         @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.NONE, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n-        testRequestResponse(client, server, streaming);\n+    public void grpcJavaToGrpcJavaCompressionError(@FromDataPoints(\"ssl\") final boolean ssl,\n+                                                   @FromDataPoints(\"streaming\") final boolean streaming)\n+            throws Exception {\n+        final String clientCompression = \"gzip\";\n+        final TestServerContext server = grpcJavaServer(ErrorMode.NONE, ssl, null);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), clientCompression, ssl);\n+        testGrpcCompressionError(client, server, streaming, clientCompression);\n     }\n \n     @Theory\n-    public void serviceTalkBlockingToServiceTalkBlocking(@FromDataPoints(\"ssl\") final boolean ssl,\n+    public void grpcJavaToServiceTalkCompressionError(@FromDataPoints(\"ssl\") final boolean ssl,\n+                                                      @FromDataPoints(\"streaming\") final boolean streaming)\n+            throws Exception {\n+        final String clientCompression = \"gzip\";\n+        final TestServerContext server = serviceTalkServer(ErrorMode.NONE, ssl, null);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), clientCompression, ssl);\n+        testGrpcCompressionError(client, server, streaming, clientCompression);\n+    }\n+\n+    @Theory\n+    public void serviceTalkToGrpcJavaCompressionError(@FromDataPoints(\"ssl\") final boolean ssl,\n+                                                      @FromDataPoints(\"streaming\") final boolean streaming)\n+            throws Exception {\n+        final String clientCompression = \"gzip\";\n+        final TestServerContext server = grpcJavaServer(ErrorMode.NONE, ssl, null);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, clientCompression);\n+        testGrpcCompressionError(client, server, streaming, clientCompression);\n+    }\n+\n+    @Theory\n+    public void serviceTalkToServiceTalkCompressionError(@FromDataPoints(\"ssl\") final boolean ssl,\n                                                          @FromDataPoints(\"streaming\") final boolean streaming)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.NONE, ssl);\n-        final BlockingCompatClient client = serviceTalkClient(server.listenAddress(), ssl).asBlockingClient();\n-        testBlockingRequestResponse(client, server, streaming);\n+        final String clientCompression = \"gzip\";\n+        final TestServerContext server = serviceTalkServer(ErrorMode.NONE, ssl, null);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, clientCompression);\n+        testGrpcCompressionError(client, server, streaming, clientCompression);\n     }\n \n     @Theory\n     public void grpcJavaToGrpcJavaError(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                        @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = grpcJavaServer(ErrorMode.SIMPLE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+                                        @FromDataPoints(\"streaming\") final boolean streaming,\n+                                        @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = grpcJavaServer(ErrorMode.SIMPLE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToGrpcJavaErrorWithStatus(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                  @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                  @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                  @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = grpcJavaServer(ErrorMode.STATUS, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = grpcJavaServer(ErrorMode.STATUS, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToGrpcJavaError(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                           @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = grpcJavaServer(ErrorMode.SIMPLE, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+                                           @FromDataPoints(\"streaming\") final boolean streaming,\n+                                           @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = grpcJavaServer(ErrorMode.SIMPLE, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToGrpcJavaErrorWithStatus(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                     @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                     @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                     @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = grpcJavaServer(ErrorMode.STATUS, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+        final TestServerContext server = grpcJavaServer(ErrorMode.STATUS, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkError(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                           @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+                                           @FromDataPoints(\"streaming\") final boolean streaming,\n+                                           @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n-    public void grpcJavaToServiceTalkErrorInScalarResponse(@FromDataPoints(\"ssl\") final boolean ssl)\n+    public void grpcJavaToServiceTalkErrorInScalarResponse(@FromDataPoints(\"ssl\") final boolean ssl,\n+                                                           @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_RESPONSE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_RESPONSE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, false, false);\n     }\n \n     @Theory\n-    public void grpcJavaToServiceTalkErrorInStreamingResponse(@FromDataPoints(\"ssl\") final boolean ssl)\n+    public void grpcJavaToServiceTalkErrorInStreamingResponse(@FromDataPoints(\"ssl\") final boolean ssl,\n+                                                              @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_RESPONSE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_RESPONSE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testStreamResetOnUnexpectedErrorOnServiceTalkServer(client, server);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkErrorInResponseNoOffload(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                              @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                              @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                              @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_RESPONSE, ssl, noOffloadsStrategy());\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_RESPONSE, ssl,\n+                noOffloadsStrategy(), compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkErrorViaServiceFilter(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                           @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                           @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                           @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVICE_FILTER, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVICE_FILTER, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkErrorViaServerFilter(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                          @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                          @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                          @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVER_FILTER, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVER_FILTER, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkErrorWithStatus(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                     @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                     @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                     @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n-    public void grpcJavaToServiceTalkErrorWithStatusInScalarResponse(@FromDataPoints(\"ssl\") final boolean ssl)\n+    public void grpcJavaToServiceTalkErrorWithStatusInScalarResponse(\n+            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_RESPONSE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_RESPONSE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, true, false);\n     }\n \n     @Theory\n-    public void grpcJavaToServiceTalkErrorWithStatusInStreamingResponse(@FromDataPoints(\"ssl\") final boolean ssl)\n+    public void grpcJavaToServiceTalkErrorWithStatusInStreamingResponse(\n+            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_RESPONSE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_RESPONSE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testStreamResetOnUnexpectedErrorOnServiceTalkServer(client, server);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkErrorWithStatusInResponseNoOffloads(\n             @FromDataPoints(\"ssl\") final boolean ssl,\n-            @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_RESPONSE, ssl, noOffloadsStrategy());\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+            @FromDataPoints(\"streaming\") final boolean streaming,\n+            @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_RESPONSE, ssl,\n+                noOffloadsStrategy(), compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkErrorWithStatusViaServiceFilter(\n-            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming)\n+            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming,\n+            @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVICE_FILTER, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVICE_FILTER, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkErrorWithStatusViaServerFilter(\n-            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming)\n+            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming,\n+            @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVER_FILTER, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVER_FILTER, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n-    public void grpcJavaToServiceTalkBlocking(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                              @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.NONE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n-        testRequestResponse(client, server, streaming);\n+    public void grpcJavaToServiceTalkBlocking(\n+            @FromDataPoints(\"ssl\") final boolean ssl,\n+            @FromDataPoints(\"streaming\") final boolean streaming,\n+            @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.NONE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n+        testRequestResponse(client, server, streaming, compression);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkBlockingError(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                   @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                   @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                   @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.SIMPLE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.SIMPLE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkBlockingErrorWithStatus(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                             @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                             @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                             @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.STATUS, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.STATUS, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToServiceTalkError(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                              @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+                                              @FromDataPoints(\"streaming\") final boolean streaming,\n+                                              @FromDataPoints(\"compression\") final String compression)\n+            throws Exception {\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToServiceTalkErrorViaServiceFilter(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                              @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                              @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                              @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVICE_FILTER, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVICE_FILTER, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToServiceTalkErrorViaServerFilter(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                             @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                             @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                             @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVER_FILTER, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVER_FILTER, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToServiceTalkErrorWithStatus(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                        @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                        @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                        @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToServiceTalkErrorWithStatusViaServiceFilter(\n-            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming)\n+            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming,\n+            @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVICE_FILTER, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVICE_FILTER, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToServiceTalkErrorWithStatusViaServerFilter(\n-            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming)\n+            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming,\n+            @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVER_FILTER, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVER_FILTER, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     private static void testBlockingRequestResponse(final BlockingCompatClient client, final TestServerContext server,\n-                                                    final boolean streaming) throws Exception {\n+                                                    final boolean streaming,\n+                                                    @Nullable final String compresion) throws Exception {\n         try {\n+            final ContentCodec codec = serviceTalkCodingFor(compresion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f459d7d15295683ecc83469bc4f453dc3f2cac13"}, "originalPosition": 500}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1NDYzMQ==", "bodyText": "Consider renaming to serverMetadata", "url": "https://github.com/apple/servicetalk/pull/1232#discussion_r533054631", "createdAt": "2020-12-01T03:46:50Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/netty/ProtocolCompatibilityTest.java", "diffHunk": "@@ -165,295 +174,369 @@ public SocketAddress listenAddress() {\n     @DataPoints(\"streaming\")\n     public static boolean[] streaming = {false, true};\n \n+    @DataPoints(\"compression\")\n+    public static String[] compression = {\"gzip\", \"identity\", null};\n+\n     @Rule\n     public final Timeout timeout = new ServiceTalkTestTimeout();\n \n     @Theory\n     public void grpcJavaToGrpcJava(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                   @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = grpcJavaServer(ErrorMode.NONE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n-        testRequestResponse(client, server, streaming);\n+                                   @FromDataPoints(\"streaming\") final boolean streaming,\n+                                   @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = grpcJavaServer(ErrorMode.NONE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n+        testRequestResponse(client, server, streaming, compression);\n     }\n \n     @Theory\n     public void serviceTalkToGrpcJava(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                      @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = grpcJavaServer(ErrorMode.NONE, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n-        testRequestResponse(client, server, streaming);\n+                                      @FromDataPoints(\"streaming\") final boolean streaming,\n+                                      @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = grpcJavaServer(ErrorMode.NONE, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n+        testRequestResponse(client, server, streaming, compression);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalk(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                      @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.NONE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n-        testRequestResponse(client, server, streaming);\n+                                      @FromDataPoints(\"streaming\") final boolean streaming,\n+                                      @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = serviceTalkServer(ErrorMode.NONE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n+        testRequestResponse(client, server, streaming, compression);\n+    }\n+\n+    @Theory\n+    public void serviceTalkToServiceTalk(@FromDataPoints(\"ssl\") final boolean ssl,\n+                                         @FromDataPoints(\"streaming\") final boolean streaming,\n+                                         @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = serviceTalkServer(ErrorMode.NONE, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n+        testRequestResponse(client, server, streaming, compression);\n     }\n \n-    @Ignore(\"gRPC compression not supported by ServiceTalk yet\")\n     @Theory\n-    public void grpcJavaToServiceTalkCompressedGzip(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                    @FromDataPoints(\"streaming\") final boolean streaming)\n+    public void serviceTalkBlockingToServiceTalkBlocking(@FromDataPoints(\"ssl\") final boolean ssl,\n+                                                         @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                         @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.NONE, ssl);\n-        // Only gzip is supported by GRPC out of the box atm.\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), \"gzip\", ssl);\n-        testRequestResponse(client, server, streaming);\n+        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.NONE, ssl, compression);\n+        final BlockingCompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression)\n+                .asBlockingClient();\n+        testBlockingRequestResponse(client, server, streaming, compression);\n     }\n \n     @Theory\n-    public void serviceTalkToServiceTalk(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                         @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.NONE, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n-        testRequestResponse(client, server, streaming);\n+    public void grpcJavaToGrpcJavaCompressionError(@FromDataPoints(\"ssl\") final boolean ssl,\n+                                                   @FromDataPoints(\"streaming\") final boolean streaming)\n+            throws Exception {\n+        final String clientCompression = \"gzip\";\n+        final TestServerContext server = grpcJavaServer(ErrorMode.NONE, ssl, null);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), clientCompression, ssl);\n+        testGrpcCompressionError(client, server, streaming, clientCompression);\n     }\n \n     @Theory\n-    public void serviceTalkBlockingToServiceTalkBlocking(@FromDataPoints(\"ssl\") final boolean ssl,\n+    public void grpcJavaToServiceTalkCompressionError(@FromDataPoints(\"ssl\") final boolean ssl,\n+                                                      @FromDataPoints(\"streaming\") final boolean streaming)\n+            throws Exception {\n+        final String clientCompression = \"gzip\";\n+        final TestServerContext server = serviceTalkServer(ErrorMode.NONE, ssl, null);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), clientCompression, ssl);\n+        testGrpcCompressionError(client, server, streaming, clientCompression);\n+    }\n+\n+    @Theory\n+    public void serviceTalkToGrpcJavaCompressionError(@FromDataPoints(\"ssl\") final boolean ssl,\n+                                                      @FromDataPoints(\"streaming\") final boolean streaming)\n+            throws Exception {\n+        final String clientCompression = \"gzip\";\n+        final TestServerContext server = grpcJavaServer(ErrorMode.NONE, ssl, null);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, clientCompression);\n+        testGrpcCompressionError(client, server, streaming, clientCompression);\n+    }\n+\n+    @Theory\n+    public void serviceTalkToServiceTalkCompressionError(@FromDataPoints(\"ssl\") final boolean ssl,\n                                                          @FromDataPoints(\"streaming\") final boolean streaming)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.NONE, ssl);\n-        final BlockingCompatClient client = serviceTalkClient(server.listenAddress(), ssl).asBlockingClient();\n-        testBlockingRequestResponse(client, server, streaming);\n+        final String clientCompression = \"gzip\";\n+        final TestServerContext server = serviceTalkServer(ErrorMode.NONE, ssl, null);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, clientCompression);\n+        testGrpcCompressionError(client, server, streaming, clientCompression);\n     }\n \n     @Theory\n     public void grpcJavaToGrpcJavaError(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                        @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = grpcJavaServer(ErrorMode.SIMPLE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+                                        @FromDataPoints(\"streaming\") final boolean streaming,\n+                                        @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = grpcJavaServer(ErrorMode.SIMPLE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToGrpcJavaErrorWithStatus(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                  @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                  @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                  @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = grpcJavaServer(ErrorMode.STATUS, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = grpcJavaServer(ErrorMode.STATUS, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToGrpcJavaError(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                           @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = grpcJavaServer(ErrorMode.SIMPLE, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+                                           @FromDataPoints(\"streaming\") final boolean streaming,\n+                                           @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = grpcJavaServer(ErrorMode.SIMPLE, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToGrpcJavaErrorWithStatus(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                     @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                     @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                     @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = grpcJavaServer(ErrorMode.STATUS, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+        final TestServerContext server = grpcJavaServer(ErrorMode.STATUS, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkError(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                           @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+                                           @FromDataPoints(\"streaming\") final boolean streaming,\n+                                           @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n-    public void grpcJavaToServiceTalkErrorInScalarResponse(@FromDataPoints(\"ssl\") final boolean ssl)\n+    public void grpcJavaToServiceTalkErrorInScalarResponse(@FromDataPoints(\"ssl\") final boolean ssl,\n+                                                           @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_RESPONSE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_RESPONSE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, false, false);\n     }\n \n     @Theory\n-    public void grpcJavaToServiceTalkErrorInStreamingResponse(@FromDataPoints(\"ssl\") final boolean ssl)\n+    public void grpcJavaToServiceTalkErrorInStreamingResponse(@FromDataPoints(\"ssl\") final boolean ssl,\n+                                                              @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_RESPONSE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_RESPONSE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testStreamResetOnUnexpectedErrorOnServiceTalkServer(client, server);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkErrorInResponseNoOffload(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                              @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                              @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                              @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_RESPONSE, ssl, noOffloadsStrategy());\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_RESPONSE, ssl,\n+                noOffloadsStrategy(), compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkErrorViaServiceFilter(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                           @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                           @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                           @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVICE_FILTER, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVICE_FILTER, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkErrorViaServerFilter(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                          @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                          @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                          @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVER_FILTER, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVER_FILTER, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkErrorWithStatus(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                     @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                     @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                     @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n-    public void grpcJavaToServiceTalkErrorWithStatusInScalarResponse(@FromDataPoints(\"ssl\") final boolean ssl)\n+    public void grpcJavaToServiceTalkErrorWithStatusInScalarResponse(\n+            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_RESPONSE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_RESPONSE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, true, false);\n     }\n \n     @Theory\n-    public void grpcJavaToServiceTalkErrorWithStatusInStreamingResponse(@FromDataPoints(\"ssl\") final boolean ssl)\n+    public void grpcJavaToServiceTalkErrorWithStatusInStreamingResponse(\n+            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_RESPONSE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_RESPONSE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testStreamResetOnUnexpectedErrorOnServiceTalkServer(client, server);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkErrorWithStatusInResponseNoOffloads(\n             @FromDataPoints(\"ssl\") final boolean ssl,\n-            @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_RESPONSE, ssl, noOffloadsStrategy());\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+            @FromDataPoints(\"streaming\") final boolean streaming,\n+            @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_RESPONSE, ssl,\n+                noOffloadsStrategy(), compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkErrorWithStatusViaServiceFilter(\n-            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming)\n+            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming,\n+            @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVICE_FILTER, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVICE_FILTER, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkErrorWithStatusViaServerFilter(\n-            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming)\n+            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming,\n+            @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVER_FILTER, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVER_FILTER, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n-    public void grpcJavaToServiceTalkBlocking(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                              @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.NONE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n-        testRequestResponse(client, server, streaming);\n+    public void grpcJavaToServiceTalkBlocking(\n+            @FromDataPoints(\"ssl\") final boolean ssl,\n+            @FromDataPoints(\"streaming\") final boolean streaming,\n+            @FromDataPoints(\"compression\") final String compression) throws Exception {\n+        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.NONE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n+        testRequestResponse(client, server, streaming, compression);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkBlockingError(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                   @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                   @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                   @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.SIMPLE, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.SIMPLE, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void grpcJavaToServiceTalkBlockingErrorWithStatus(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                             @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                             @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                             @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.STATUS, ssl);\n-        final CompatClient client = grpcJavaClient(server.listenAddress(), null, ssl);\n+        final TestServerContext server = serviceTalkServerBlocking(ErrorMode.STATUS, ssl, compression);\n+        final CompatClient client = grpcJavaClient(server.listenAddress(), compression, ssl);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToServiceTalkError(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                              @FromDataPoints(\"streaming\") final boolean streaming) throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+                                              @FromDataPoints(\"streaming\") final boolean streaming,\n+                                              @FromDataPoints(\"compression\") final String compression)\n+            throws Exception {\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToServiceTalkErrorViaServiceFilter(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                              @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                              @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                              @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVICE_FILTER, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVICE_FILTER, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToServiceTalkErrorViaServerFilter(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                             @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                             @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                             @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVER_FILTER, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.SIMPLE_IN_SERVER_FILTER, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, false, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToServiceTalkErrorWithStatus(@FromDataPoints(\"ssl\") final boolean ssl,\n-                                                        @FromDataPoints(\"streaming\") final boolean streaming)\n+                                                        @FromDataPoints(\"streaming\") final boolean streaming,\n+                                                        @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToServiceTalkErrorWithStatusViaServiceFilter(\n-            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming)\n+            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming,\n+            @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVICE_FILTER, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVICE_FILTER, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     @Theory\n     public void serviceTalkToServiceTalkErrorWithStatusViaServerFilter(\n-            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming)\n+            @FromDataPoints(\"ssl\") final boolean ssl, @FromDataPoints(\"streaming\") final boolean streaming,\n+            @FromDataPoints(\"compression\") final String compression)\n             throws Exception {\n-        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVER_FILTER, ssl);\n-        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl);\n+        final TestServerContext server = serviceTalkServer(ErrorMode.STATUS_IN_SERVER_FILTER, ssl, compression);\n+        final CompatClient client = serviceTalkClient(server.listenAddress(), ssl, compression);\n         testGrpcError(client, server, true, streaming);\n     }\n \n     private static void testBlockingRequestResponse(final BlockingCompatClient client, final TestServerContext server,\n-                                                    final boolean streaming) throws Exception {\n+                                                    final boolean streaming,\n+                                                    @Nullable final String compresion) throws Exception {\n         try {\n+            final ContentCodec codec = serviceTalkCodingFor(compresion);\n+\n             if (!streaming) {\n-                final CompatResponse response1 = client.scalarCall(CompatRequest.newBuilder().setId(1).build());\n+                final ScalarCallMetadata metadata = new ScalarCallMetadata(codec);\n+                final CompatResponse response1 = client.scalarCall(metadata,\n+                        CompatRequest.newBuilder().setId(1).build());\n                 assertEquals(1000001, response1.getSize());\n             } else {\n                 // clientStreamingCall returns the \"sum\"\n-                final CompatResponse response2 = client.clientStreamingCall(asList(\n+                final ClientStreamingCallMetadata metadata = new ClientStreamingCallMetadata(codec);\n+                final CompatResponse response2 = client.clientStreamingCall(metadata, asList(\n                         CompatRequest.newBuilder().setId(1).build(),\n                         CompatRequest.newBuilder().setId(2).build(),\n                         CompatRequest.newBuilder().setId(3).build()\n                 ));\n                 assertEquals(1000006, response2.getSize());\n \n                 // serverStreamingCall returns a stream from 0 to N-1\n+                final ServerStreamingCallMetadata metadata1 = new ServerStreamingCallMetadata(codec);\n                 final BlockingIterable<CompatResponse> response3 =\n-                        client.serverStreamingCall(CompatRequest.newBuilder().setId(3).build());\n+                        client.serverStreamingCall(metadata1, CompatRequest.newBuilder().setId(3).build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f459d7d15295683ecc83469bc4f453dc3f2cac13"}, "originalPosition": 523}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1NDgwNw==", "bodyText": "Same here", "url": "https://github.com/apple/servicetalk/pull/1232#discussion_r533054807", "createdAt": "2020-12-01T03:47:24Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/netty/ProtocolCompatibilityTest.java", "diffHunk": "@@ -480,42 +565,54 @@ private static void testBlockingRequestResponse(final BlockingCompatClient clien\n     }\n \n     private static void testRequestResponse(final CompatClient client, final TestServerContext server,\n-                                            final boolean streaming) throws Exception {\n+                                            final boolean streaming,\n+                                            @Nullable final String compression) throws Exception {\n         try {\n+            final ContentCodec codec = serviceTalkCodingFor(compression);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f459d7d15295683ecc83469bc4f453dc3f2cac13"}, "originalPosition": 554}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1NjEzNA==", "bodyText": "Why is this always null here?", "url": "https://github.com/apple/servicetalk/pull/1232#discussion_r533056134", "createdAt": "2020-12-01T03:52:22Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/netty/ProtocolCompatibilityTest.java", "diffHunk": "@@ -546,88 +643,122 @@ private static void testStreamResetOnUnexpectedErrorOnServiceTalkServer(final Co\n         }\n     }\n \n+    private static void testGrpcCompressionError(final CompatClient client, final TestServerContext server,\n+                                                 final boolean streaming,\n+                                                 @Nullable final String compression) throws Exception {\n+        if (streaming) {\n+            testGrpcErrorStreaming(client, server, false, compression);\n+        } else {\n+            testGrpcErrorScalar(client, server, false, compression);\n+        }\n+    }\n+\n+\n     private static void testGrpcError(final CompatClient client, final TestServerContext server,\n                                       final boolean withStatus, final boolean streaming)\n             throws Exception {\n         if (streaming) {\n-            testGrpcErrorStreaming(client, server, withStatus);\n+            testGrpcErrorStreaming(client, server, withStatus, null);\n         } else {\n-            testGrpcErrorScalar(client, server, withStatus);\n+            testGrpcErrorScalar(client, server, withStatus, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f459d7d15295683ecc83469bc4f453dc3f2cac13"}, "originalPosition": 634}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b829b5ef769f8134bc42fb423fc8041eac91897", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/5b829b5ef769f8134bc42fb423fc8041eac91897", "committedDate": "2020-12-03T23:57:01Z", "message": "Include compression for compat checks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac14dfabfffb6866756683f817f319396afa0b66", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/ac14dfabfffb6866756683f817f319396afa0b66", "committedDate": "2020-12-03T22:20:07Z", "message": "Comments"}, "afterCommit": {"oid": "5b829b5ef769f8134bc42fb423fc8041eac91897", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/5b829b5ef769f8134bc42fb423fc8041eac91897", "committedDate": "2020-12-03T23:57:01Z", "message": "Include compression for compat checks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3358, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}