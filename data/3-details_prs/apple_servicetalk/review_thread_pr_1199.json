{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2NTEzMzIx", "number": 1199, "reviewThreads": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMzowMjoxM1rOE2RCkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMDoyMDoyN1rOE3AZhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MzM3NzQ1OnYy", "diffSide": "RIGHT", "path": "servicetalk-logging-api/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMzowMjoxM1rOHvAIcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMzowMjoxM1rOHvAIcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA0NzI4Mw==", "bodyText": "2020", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r519047283", "createdAt": "2020-11-06T23:02:13Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-logging-api/build.gradle", "diffHunk": "@@ -0,0 +1,21 @@\n+/*\n+ * Copyright \u00a9 2018-2019 Apple Inc. and the ServiceTalk project authors", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6e0d1a2e55d08c7e476ed04bc11faf17628308c"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MzQ0Njc5OnYy", "diffSide": "RIGHT", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/H2ProtocolConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMzo0MzoxNFrOHvAwtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMjo0NDoyNVrOHwEk_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA1NzU5MA==", "bodyText": "IIUC, this is the only place that exposes FixedLevelLogger at public API. I worry that people will use the FixedLevelLogger interface in their apps.\nWDYT if we will move FixedLevelLogger to servicetalk-logging-slf4j-internal module and instead will just provide something like LoggerConfig interface/class (LoggerConfig.of(...)?) that will have a name and level (maybe even \"userData\" flag)?\nBenefits:\n\nIt will simplify H2ProtocolConfig API. Users who decided to have their own implementation won't need to implement FixedLevelLogger interface.\nThere are cases when we do not need FixedLevelLogger at all. For example, netty's LoggingHandler can be configured based on LoggerConfig.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r519057590", "createdAt": "2020-11-06T23:43:14Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/H2ProtocolConfig.java", "diffHunk": "@@ -46,14 +45,20 @@ default String alpnId() {\n     BiPredicate<CharSequence, CharSequence> headersSensitivityDetector();\n \n     /**\n-     * Logger name for HTTP/2 frames.\n-     * <p>\n-     * All frames will be logged at {@link Level#TRACE TRACE} level.\n+     * Logger for HTTP/2 frames.\n      *\n-     * @return the name of the logger to log HTTP/2 frames or {@code null} to disable it\n+     * @return the logger to use for HTTP/2 frames or {@code null} to disable it\n      */\n     @Nullable\n-    String frameLoggerName();\n+    FixedLevelLogger frameLogger();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE2ODcwMg==", "bodyText": "I agree the visibility of FixedLevelLogger should be reduced out of API.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520168702", "createdAt": "2020-11-09T22:44:25Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/H2ProtocolConfig.java", "diffHunk": "@@ -46,14 +45,20 @@ default String alpnId() {\n     BiPredicate<CharSequence, CharSequence> headersSensitivityDetector();\n \n     /**\n-     * Logger name for HTTP/2 frames.\n-     * <p>\n-     * All frames will be logged at {@link Level#TRACE TRACE} level.\n+     * Logger for HTTP/2 frames.\n      *\n-     * @return the name of the logger to log HTTP/2 frames or {@code null} to disable it\n+     * @return the logger to use for HTTP/2 frames or {@code null} to disable it\n      */\n     @Nullable\n-    String frameLoggerName();\n+    FixedLevelLogger frameLogger();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA1NzU5MA=="}, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MzQ1NzAwOnYy", "diffSide": "RIGHT", "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/HttpServerBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMzo0OToyM1rOHvA2aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMzo0OToyM1rOHvA2aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA1OTA0OQ==", "bodyText": "Then we can reuse LoggerConfig here as well to make configuration consistent.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r519059049", "createdAt": "2020-11-06T23:49:23Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/HttpServerBuilder.java", "diffHunk": "@@ -116,14 +115,23 @@\n \n     /**\n      * Enables wire-logging for this server.\n-     * <p>\n-     * All wire events will be logged at {@link Level#TRACE TRACE} level.\n      *\n      * @param loggerName The name of the logger to log wire events.\n      * @return {@code this}.\n      */\n     public abstract HttpServerBuilder enableWireLogging(String loggerName);\n \n+    /**\n+     * Enables wire-logging for this server.\n+     *\n+     * @param loggerName The name of the logger to log wire events.\n+     * @param logLevel The level to log at.\n+     * @param logUserData {@code true} to include user data (e.g. data, headers, etc.). {@code false} to exclude this\n+     * data.\n+     * @return {@code this}.\n+     */\n+    public abstract HttpServerBuilder enableWireLogging(String loggerName, LogLevel logLevel, boolean logUserData);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MzQ2MjM5OnYy", "diffSide": "RIGHT", "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/BaseHttpBuilder.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMzo1MjozOFrOHvA5Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMDoyODoyNlrOHwG9Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA1OTgwMw==", "bodyText": "Thinking about enabling logging at runtime... It seems useful to be able to contol ability to log user data via logger configuration as well.\nWe may consider configuring 2 wire logging handlers internally with different names: one that includes user data and one without user data. Then users can reload log4j2 configuration to enable one of these 2 loggers, depending on the issue they need to debug.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r519059803", "createdAt": "2020-11-06T23:52:38Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/BaseHttpBuilder.java", "diffHunk": "@@ -73,14 +72,25 @@\n \n     /**\n      * Enables wire-logging for connections created by this builder.\n-     * <p>\n-     * All wire events will be logged at {@link Level#TRACE TRACE} level.\n      *\n      * @param loggerName The name of the logger to log wire events.\n      * @return {@code this}.\n      */\n     public abstract BaseHttpBuilder<ResolvedAddress> enableWireLogging(String loggerName);\n \n+    /**\n+     * Enables wire-logging for connections created by this builder.\n+     *\n+     * @param loggerName The name of the logger to log wire events.\n+     * @param logLevel The level to log at.\n+     * @param logUserData {@code true} to include user data (e.g. data, headers, etc.). {@code false} to exclude this\n+     * data.\n+     * @return {@code this}.\n+     */\n+    public abstract BaseHttpBuilder<ResolvedAddress> enableWireLogging(String loggerName,\n+                                                                       LogLevel logLevel,\n+                                                                       boolean logUserData);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MTg1Mg==", "bodyText": "I'm not sure this level of dynamic switching is necessary but it can be accomplished with minimal overhead by using a BooleanSupplier.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520171852", "createdAt": "2020-11-09T22:51:13Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/BaseHttpBuilder.java", "diffHunk": "@@ -73,14 +72,25 @@\n \n     /**\n      * Enables wire-logging for connections created by this builder.\n-     * <p>\n-     * All wire events will be logged at {@link Level#TRACE TRACE} level.\n      *\n      * @param loggerName The name of the logger to log wire events.\n      * @return {@code this}.\n      */\n     public abstract BaseHttpBuilder<ResolvedAddress> enableWireLogging(String loggerName);\n \n+    /**\n+     * Enables wire-logging for connections created by this builder.\n+     *\n+     * @param loggerName The name of the logger to log wire events.\n+     * @param logLevel The level to log at.\n+     * @param logUserData {@code true} to include user data (e.g. data, headers, etc.). {@code false} to exclude this\n+     * data.\n+     * @return {@code this}.\n+     */\n+    public abstract BaseHttpBuilder<ResolvedAddress> enableWireLogging(String loggerName,\n+                                                                       LogLevel logLevel,\n+                                                                       boolean logUserData);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA1OTgwMw=="}, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwNzY1MA==", "bodyText": "Good idea with BooleanSupplier \ud83c\udf96\ufe0f", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520207650", "createdAt": "2020-11-10T00:28:26Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/BaseHttpBuilder.java", "diffHunk": "@@ -73,14 +72,25 @@\n \n     /**\n      * Enables wire-logging for connections created by this builder.\n-     * <p>\n-     * All wire events will be logged at {@link Level#TRACE TRACE} level.\n      *\n      * @param loggerName The name of the logger to log wire events.\n      * @return {@code this}.\n      */\n     public abstract BaseHttpBuilder<ResolvedAddress> enableWireLogging(String loggerName);\n \n+    /**\n+     * Enables wire-logging for connections created by this builder.\n+     *\n+     * @param loggerName The name of the logger to log wire events.\n+     * @param logLevel The level to log at.\n+     * @param logUserData {@code true} to include user data (e.g. data, headers, etc.). {@code false} to exclude this\n+     * data.\n+     * @return {@code this}.\n+     */\n+    public abstract BaseHttpBuilder<ResolvedAddress> enableWireLogging(String loggerName,\n+                                                                       LogLevel logLevel,\n+                                                                       boolean logUserData);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA1OTgwMw=="}, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MzQ3ODM4OnYy", "diffSide": "RIGHT", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/H2ServerParentChannelInitializer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMDowMjowNVrOHvBCFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMDowMjowNVrOHvBCFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2MjAzNg==", "bodyText": "This code duplicates what we do in H2ClientParentChannelInitializer. Consider moving it to a utility method and reusing. It can be in one of these h2-initializers or in ServiceTalkHttp2FrameLogger.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r519062036", "createdAt": "2020-11-07T00:02:05Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/H2ServerParentChannelInitializer.java", "diffHunk": "@@ -54,12 +52,10 @@ public void init(final Channel channel) {\n                 config.headersSensitivityDetector();\n         multiplexCodecBuilder.headerSensitivityDetector(headersSensitivityDetector::test);\n \n-        final String frameLoggerName = config.frameLoggerName();\n-        if (frameLoggerName != null) {\n-            LogLevel logLevel = getNettyLogLevel(frameLoggerName);\n-            if (logLevel != null) {\n-                multiplexCodecBuilder.frameLogger(new Http2FrameLogger(logLevel, frameLoggerName));\n-            }\n+        final FixedLevelLogger frameLogger = config.frameLogger();\n+        if (frameLogger != null) {\n+            multiplexCodecBuilder.frameLogger(\n+                    new ServiceTalkHttp2FrameLogger(frameLogger, config.frameLoggerUserData()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MzQ4MDUwOnYy", "diffSide": "RIGHT", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/ServiceTalkHttp2FrameLogger.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMDowMzozMVrOHvBDWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMjowODoyM1rOHvCPZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2MjM2MQ==", "bodyText": "Will be great to enhance Http2FrameLogger in netty to support \"logUserData\" option in future. Looks like a useful feature for all netty users.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r519062361", "createdAt": "2020-11-07T00:03:31Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/ServiceTalkHttp2FrameLogger.java", "diffHunk": "@@ -0,0 +1,185 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.http.netty;\n+\n+import io.servicetalk.logging.api.FixedLevelLogger;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufUtil;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.handler.codec.http2.Http2Flags;\n+import io.netty.handler.codec.http2.Http2FrameLogger;\n+import io.netty.handler.codec.http2.Http2Headers;\n+import io.netty.handler.codec.http2.Http2Settings;\n+import io.netty.handler.logging.LogLevel;\n+\n+final class ServiceTalkHttp2FrameLogger extends Http2FrameLogger {\n+    private static final int BUFFER_LENGTH_THRESHOLD = 64;\n+    private final FixedLevelLogger logger;\n+    private final boolean logUserData;\n+\n+    ServiceTalkHttp2FrameLogger(final FixedLevelLogger logger, final boolean logUserData) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4MTgyOQ==", "bodyText": "agreed this is a candidate to upstream", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r519081829", "createdAt": "2020-11-07T02:08:23Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/ServiceTalkHttp2FrameLogger.java", "diffHunk": "@@ -0,0 +1,185 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.http.netty;\n+\n+import io.servicetalk.logging.api.FixedLevelLogger;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufUtil;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.handler.codec.http2.Http2Flags;\n+import io.netty.handler.codec.http2.Http2FrameLogger;\n+import io.netty.handler.codec.http2.Http2Headers;\n+import io.netty.handler.codec.http2.Http2Settings;\n+import io.netty.handler.logging.LogLevel;\n+\n+final class ServiceTalkHttp2FrameLogger extends Http2FrameLogger {\n+    private static final int BUFFER_LENGTH_THRESHOLD = 64;\n+    private final FixedLevelLogger logger;\n+    private final boolean logUserData;\n+\n+    ServiceTalkHttp2FrameLogger(final FixedLevelLogger logger, final boolean logUserData) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2MjM2MQ=="}, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MzQ4NTA1OnYy", "diffSide": "RIGHT", "path": "servicetalk-logging-slf4j-internal/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMDowNjozMVrOHvBF4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMDowNjozMVrOHvBF4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2MzAxMA==", "bodyText": "2020", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r519063010", "createdAt": "2020-11-07T00:06:31Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-logging-slf4j-internal/build.gradle", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ * Copyright \u00a9 2018-2019 Apple Inc. and the ServiceTalk project authors", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MzQ4OTI0OnYy", "diffSide": "LEFT", "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/BaseHttpBuilder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMDowOToyNlrOHvBIPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzoxMzoxNVrOHwFUWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2MzYxMw==", "bodyText": "Comment for all occurances of enableWireLogging method:\nShould we mark the existing enableWireLogging methods as deprecated? If not and you prefer to keep both, it's better to keep this info in javadoc, add desciption that this method logs all user data, and reference another overload if users need more customization.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r519063613", "createdAt": "2020-11-07T00:09:26Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/BaseHttpBuilder.java", "diffHunk": "@@ -73,14 +72,25 @@\n \n     /**\n      * Enables wire-logging for connections created by this builder.\n-     * <p>\n-     * All wire events will be logged at {@link Level#TRACE TRACE} level.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4MDgyNw==", "bodyText": "I'll just deprecate the methods and remove the logs for now, we can remove them in the next release.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520180827", "createdAt": "2020-11-09T23:13:15Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/BaseHttpBuilder.java", "diffHunk": "@@ -73,14 +72,25 @@\n \n     /**\n      * Enables wire-logging for connections created by this builder.\n-     * <p>\n-     * All wire events will be logged at {@link Level#TRACE TRACE} level.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2MzYxMw=="}, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MzQ5MzQ4OnYy", "diffSide": "RIGHT", "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/BaseHttpBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMDoxMjoyMFrOHvBKhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMDoxMjoyMFrOHvBKhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2NDE5OA==", "bodyText": "\"to exclude this data\" is a bit confusing because you do not know what to expect in this case. Consider clarifying: {@code false} to exclude this data and log only network events", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r519064198", "createdAt": "2020-11-07T00:12:20Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/BaseHttpBuilder.java", "diffHunk": "@@ -73,14 +72,25 @@\n \n     /**\n      * Enables wire-logging for connections created by this builder.\n-     * <p>\n-     * All wire events will be logged at {@link Level#TRACE TRACE} level.\n      *\n      * @param loggerName The name of the logger to log wire events.\n      * @return {@code this}.\n      */\n     public abstract BaseHttpBuilder<ResolvedAddress> enableWireLogging(String loggerName);\n \n+    /**\n+     * Enables wire-logging for connections created by this builder.\n+     *\n+     * @param loggerName The name of the logger to log wire events.\n+     * @param logLevel The level to log at.\n+     * @param logUserData {@code true} to include user data (e.g. data, headers, etc.). {@code false} to exclude this\n+     * data.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MzUwMDc5OnYy", "diffSide": "RIGHT", "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/WireLoggingInitializer.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMDoxNzowOVrOHvBOig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzoyOToyNlrOHwFsHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2NTIyNg==", "bodyText": "Instead of introducing a custom ServiceTalkWireLogger can we use LoggingHandler(name, level, logUserData ? ByteBufFormat.HEX_DUMP : ByteBufFormat.SIMPLE) from netty?", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r519065226", "createdAt": "2020-11-07T00:17:09Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/WireLoggingInitializer.java", "diffHunk": "@@ -15,36 +15,30 @@\n  */\n package io.servicetalk.transport.netty.internal;\n \n-import io.netty.channel.Channel;\n-import io.netty.handler.logging.LogLevel;\n-import io.netty.handler.logging.LoggingHandler;\n-\n-import javax.annotation.Nullable;\n+import io.servicetalk.logging.api.FixedLevelLogger;\n \n-import static io.servicetalk.transport.netty.internal.NettyLoggerUtils.getNettyLogLevel;\n+import io.netty.channel.Channel;\n \n /**\n  * A {@link ChannelInitializer} that enables wire-logging for all channels.\n  * All wire events will be logged at trace level.\n  */\n public class WireLoggingInitializer implements ChannelInitializer {\n-    @Nullable\n-    private final LoggingHandler loggingHandler;\n+    private final ServiceTalkWireLogger loggingHandler;\n \n     /**\n-     * Create an instance that logs at trace level.\n+     * Create an instance.\n      *\n-     * @param loggerName The name of the logger to log wire events.\n+     * @param logger The logger to use for log wire events.\n+     * @param logUserData {@code true} to log user data. {@code false} to not log user data.\n      */\n-    public WireLoggingInitializer(final String loggerName) {\n-        LogLevel logLevel = getNettyLogLevel(loggerName);\n-        loggingHandler = logLevel != null ? new LoggingHandler(loggerName, logLevel) : null;\n+    public WireLoggingInitializer(final FixedLevelLogger logger,\n+                                  final boolean logUserData) {\n+        loggingHandler = new ServiceTalkWireLogger(logger, logUserData);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4MTc0Ng==", "bodyText": "Netty's LoggingHandler will use toString() on messages, so depending upon what types are in the pipeline this may log user data (e.g. headers, full http message, etc.).", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r519081746", "createdAt": "2020-11-07T02:07:23Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/WireLoggingInitializer.java", "diffHunk": "@@ -15,36 +15,30 @@\n  */\n package io.servicetalk.transport.netty.internal;\n \n-import io.netty.channel.Channel;\n-import io.netty.handler.logging.LogLevel;\n-import io.netty.handler.logging.LoggingHandler;\n-\n-import javax.annotation.Nullable;\n+import io.servicetalk.logging.api.FixedLevelLogger;\n \n-import static io.servicetalk.transport.netty.internal.NettyLoggerUtils.getNettyLogLevel;\n+import io.netty.channel.Channel;\n \n /**\n  * A {@link ChannelInitializer} that enables wire-logging for all channels.\n  * All wire events will be logged at trace level.\n  */\n public class WireLoggingInitializer implements ChannelInitializer {\n-    @Nullable\n-    private final LoggingHandler loggingHandler;\n+    private final ServiceTalkWireLogger loggingHandler;\n \n     /**\n-     * Create an instance that logs at trace level.\n+     * Create an instance.\n      *\n-     * @param loggerName The name of the logger to log wire events.\n+     * @param logger The logger to use for log wire events.\n+     * @param logUserData {@code true} to log user data. {@code false} to not log user data.\n      */\n-    public WireLoggingInitializer(final String loggerName) {\n-        LogLevel logLevel = getNettyLogLevel(loggerName);\n-        loggingHandler = logLevel != null ? new LoggingHandler(loggerName, logLevel) : null;\n+    public WireLoggingInitializer(final FixedLevelLogger logger,\n+                                  final boolean logUserData) {\n+        loggingHandler = new ServiceTalkWireLogger(logger, logUserData);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2NTIyNg=="}, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NzM3NA==", "bodyText": "We insert it as the first handler at tcp level where only buffers are expected. If something will change for our tcp initializer in future, we can reconsider approach.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r519087374", "createdAt": "2020-11-07T03:06:51Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/WireLoggingInitializer.java", "diffHunk": "@@ -15,36 +15,30 @@\n  */\n package io.servicetalk.transport.netty.internal;\n \n-import io.netty.channel.Channel;\n-import io.netty.handler.logging.LogLevel;\n-import io.netty.handler.logging.LoggingHandler;\n-\n-import javax.annotation.Nullable;\n+import io.servicetalk.logging.api.FixedLevelLogger;\n \n-import static io.servicetalk.transport.netty.internal.NettyLoggerUtils.getNettyLogLevel;\n+import io.netty.channel.Channel;\n \n /**\n  * A {@link ChannelInitializer} that enables wire-logging for all channels.\n  * All wire events will be logged at trace level.\n  */\n public class WireLoggingInitializer implements ChannelInitializer {\n-    @Nullable\n-    private final LoggingHandler loggingHandler;\n+    private final ServiceTalkWireLogger loggingHandler;\n \n     /**\n-     * Create an instance that logs at trace level.\n+     * Create an instance.\n      *\n-     * @param loggerName The name of the logger to log wire events.\n+     * @param logger The logger to use for log wire events.\n+     * @param logUserData {@code true} to log user data. {@code false} to not log user data.\n      */\n-    public WireLoggingInitializer(final String loggerName) {\n-        LogLevel logLevel = getNettyLogLevel(loggerName);\n-        loggingHandler = logLevel != null ? new LoggingHandler(loggerName, logLevel) : null;\n+    public WireLoggingInitializer(final FixedLevelLogger logger,\n+                                  final boolean logUserData) {\n+        loggingHandler = new ServiceTalkWireLogger(logger, logUserData);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2NTIyNg=="}, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NjkwOA==", "bodyText": "latest round of review changes introduces BoolenSupplier to dynamically include/exclude data. there is some duplication but I think its simpler just to keep this for now. it is internal so we can consolidate later if we enhance upstream or find a better way.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520186908", "createdAt": "2020-11-09T23:29:26Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/WireLoggingInitializer.java", "diffHunk": "@@ -15,36 +15,30 @@\n  */\n package io.servicetalk.transport.netty.internal;\n \n-import io.netty.channel.Channel;\n-import io.netty.handler.logging.LogLevel;\n-import io.netty.handler.logging.LoggingHandler;\n-\n-import javax.annotation.Nullable;\n+import io.servicetalk.logging.api.FixedLevelLogger;\n \n-import static io.servicetalk.transport.netty.internal.NettyLoggerUtils.getNettyLogLevel;\n+import io.netty.channel.Channel;\n \n /**\n  * A {@link ChannelInitializer} that enables wire-logging for all channels.\n  * All wire events will be logged at trace level.\n  */\n public class WireLoggingInitializer implements ChannelInitializer {\n-    @Nullable\n-    private final LoggingHandler loggingHandler;\n+    private final ServiceTalkWireLogger loggingHandler;\n \n     /**\n-     * Create an instance that logs at trace level.\n+     * Create an instance.\n      *\n-     * @param loggerName The name of the logger to log wire events.\n+     * @param logger The logger to use for log wire events.\n+     * @param logUserData {@code true} to log user data. {@code false} to not log user data.\n      */\n-    public WireLoggingInitializer(final String loggerName) {\n-        LogLevel logLevel = getNettyLogLevel(loggerName);\n-        loggingHandler = logLevel != null ? new LoggingHandler(loggerName, logLevel) : null;\n+    public WireLoggingInitializer(final FixedLevelLogger logger,\n+                                  final boolean logUserData) {\n+        loggingHandler = new ServiceTalkWireLogger(logger, logUserData);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2NTIyNg=="}, "originalCommit": {"oid": "7044adb6196472e913261f7e9f40fa9a36246d79"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MTA0OTU3OnYy", "diffSide": "RIGHT", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/H2ServerParentChannelInitializer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzo0MzoxM1rOHwGAOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzo0MzoxM1rOHwGAOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5MjA1Ng==", "bodyText": "nit: shifted indentation", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520192056", "createdAt": "2020-11-09T23:43:13Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/H2ServerParentChannelInitializer.java", "diffHunk": "@@ -52,14 +54,19 @@ public void init(final Channel channel) {\n                 config.headersSensitivityDetector();\n         multiplexCodecBuilder.headerSensitivityDetector(headersSensitivityDetector::test);\n \n-        final FixedLevelLogger frameLogger = config.frameLogger();\n-        if (frameLogger != null) {\n-            multiplexCodecBuilder.frameLogger(\n-                    new ServiceTalkHttp2FrameLogger(frameLogger, config.frameLoggerUserData()));\n-        }\n+        initFrameLogger(multiplexCodecBuilder, config.frameLoggerConfig());\n \n         // TODO(scott): more configuration. header validation, settings stream, etc...\n \n         channel.pipeline().addLast(multiplexCodecBuilder.build(), new Http2MultiplexHandler(streamChannelInitializer));\n     }\n+\n+    static void initFrameLogger(final Http2FrameCodecBuilder multiplexCodecBuilder,\n+                                        @Nullable final UserDataLoggerConfig frameLoggerConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1921d581b0a0c701a87ee6f9d9ee06521e53c335"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MTA2NjEzOnYy", "diffSide": "RIGHT", "path": "servicetalk-logging-slf4j-internal/src/main/java/io/servicetalk/logging/slf4j/internal/DefaultUserDataLoggerConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzo1MDowMlrOHwGJ2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzo1MDowMlrOHwGJ2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5NDUyMw==", "bodyText": "requireNonNull for all fields?", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520194523", "createdAt": "2020-11-09T23:50:02Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-logging-slf4j-internal/src/main/java/io/servicetalk/logging/slf4j/internal/DefaultUserDataLoggerConfig.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.logging.slf4j.internal;\n+\n+import io.servicetalk.logging.api.LogLevel;\n+import io.servicetalk.logging.api.LoggerConfig;\n+import io.servicetalk.logging.api.UserDataLoggerConfig;\n+\n+import java.util.function.BooleanSupplier;\n+\n+/**\n+ * Default implementation of {@link LoggerConfig}.\n+ */\n+public final class DefaultUserDataLoggerConfig implements UserDataLoggerConfig {\n+    private final String loggerName;\n+    private final LogLevel logLevel;\n+    private final BooleanSupplier logUserData;\n+\n+    /**\n+     * Create a new instance.\n+     * @param loggerName the name of the logger to use.\n+     * @param logLevel the level to log at.\n+     * @param logUserData if user data (e.g. data, headers, etc.) should be included in logs.\n+     */\n+    public DefaultUserDataLoggerConfig(final String loggerName, final LogLevel logLevel,\n+                                       final BooleanSupplier logUserData) {\n+        this.loggerName = loggerName;\n+        this.logLevel = logLevel;\n+        this.logUserData = logUserData;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1921d581b0a0c701a87ee6f9d9ee06521e53c335"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MTA3MDI0OnYy", "diffSide": "RIGHT", "path": "servicetalk-logging-slf4j-internal/src/main/java/io/servicetalk/logging/slf4j/internal/DefaultUserDataLoggerConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzo1MTo0NlrOHwGMTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxODo1ODoxMFrOHwrLJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5NTE0OQ==", "bodyText": "We do not use them, but it does not hurt to generate equals/hashCode methods for this class in case users will somehow need it.\nAlso, consider implementing toString() method for better logging if necessary.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520195149", "createdAt": "2020-11-09T23:51:46Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-logging-slf4j-internal/src/main/java/io/servicetalk/logging/slf4j/internal/DefaultUserDataLoggerConfig.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.logging.slf4j.internal;\n+\n+import io.servicetalk.logging.api.LogLevel;\n+import io.servicetalk.logging.api.LoggerConfig;\n+import io.servicetalk.logging.api.UserDataLoggerConfig;\n+\n+import java.util.function.BooleanSupplier;\n+\n+/**\n+ * Default implementation of {@link LoggerConfig}.\n+ */\n+public final class DefaultUserDataLoggerConfig implements UserDataLoggerConfig {\n+    private final String loggerName;\n+    private final LogLevel logLevel;\n+    private final BooleanSupplier logUserData;\n+\n+    /**\n+     * Create a new instance.\n+     * @param loggerName the name of the logger to use.\n+     * @param logLevel the level to log at.\n+     * @param logUserData if user data (e.g. data, headers, etc.) should be included in logs.\n+     */\n+    public DefaultUserDataLoggerConfig(final String loggerName, final LogLevel logLevel,\n+                                       final BooleanSupplier logUserData) {\n+        this.loggerName = loggerName;\n+        this.logLevel = logLevel;\n+        this.logUserData = logUserData;\n+    }\n+\n+    @Override\n+    public String loggerName() {\n+        return loggerName;\n+    }\n+\n+    @Override\n+    public LogLevel logLevel() {\n+        return logLevel;\n+    }\n+\n+    @Override\n+    public BooleanSupplier logUserData() {\n+        return logUserData;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1921d581b0a0c701a87ee6f9d9ee06521e53c335"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwMTA2MA==", "bodyText": "done", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520801060", "createdAt": "2020-11-10T18:58:10Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-logging-slf4j-internal/src/main/java/io/servicetalk/logging/slf4j/internal/DefaultUserDataLoggerConfig.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.logging.slf4j.internal;\n+\n+import io.servicetalk.logging.api.LogLevel;\n+import io.servicetalk.logging.api.LoggerConfig;\n+import io.servicetalk.logging.api.UserDataLoggerConfig;\n+\n+import java.util.function.BooleanSupplier;\n+\n+/**\n+ * Default implementation of {@link LoggerConfig}.\n+ */\n+public final class DefaultUserDataLoggerConfig implements UserDataLoggerConfig {\n+    private final String loggerName;\n+    private final LogLevel logLevel;\n+    private final BooleanSupplier logUserData;\n+\n+    /**\n+     * Create a new instance.\n+     * @param loggerName the name of the logger to use.\n+     * @param logLevel the level to log at.\n+     * @param logUserData if user data (e.g. data, headers, etc.) should be included in logs.\n+     */\n+    public DefaultUserDataLoggerConfig(final String loggerName, final LogLevel logLevel,\n+                                       final BooleanSupplier logUserData) {\n+        this.loggerName = loggerName;\n+        this.logLevel = logLevel;\n+        this.logUserData = logUserData;\n+    }\n+\n+    @Override\n+    public String loggerName() {\n+        return loggerName;\n+    }\n+\n+    @Override\n+    public LogLevel logLevel() {\n+        return logLevel;\n+    }\n+\n+    @Override\n+    public BooleanSupplier logUserData() {\n+        return logUserData;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5NTE0OQ=="}, "originalCommit": {"oid": "1921d581b0a0c701a87ee6f9d9ee06521e53c335"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MTA3ODc1OnYy", "diffSide": "RIGHT", "path": "servicetalk-tcp-netty-internal/src/main/java/io/servicetalk/tcp/netty/internal/AbstractTcpConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzo1NDo1NFrOHwGROg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMTo1MDo1NVrOHwImyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5NjQxMA==", "bodyText": "Consider keeping it true to preserve the existing behavior of the method.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520196410", "createdAt": "2020-11-09T23:54:54Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-tcp-netty-internal/src/main/java/io/servicetalk/tcp/netty/internal/AbstractTcpConfig.java", "diffHunk": "@@ -135,22 +130,21 @@ public final void flushStrategy(final FlushStrategy flushStrategy) {\n      * @param loggerName The name of the logger to log wire events\n      */\n     public final void enableWireLogging(final String loggerName) {\n-        enableWireLogging(loggerName, TRACE, true);\n+        enableWireLogging(loggerName, TRACE, () -> false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1921d581b0a0c701a87ee6f9d9ee06521e53c335"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIzNDY5OQ==", "bodyText": "I think it is worth breaking behavior here now that we have the option. by default it is safer to not log user data, and if users opt-in then they accept the risk.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520234699", "createdAt": "2020-11-10T01:50:55Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-tcp-netty-internal/src/main/java/io/servicetalk/tcp/netty/internal/AbstractTcpConfig.java", "diffHunk": "@@ -135,22 +130,21 @@ public final void flushStrategy(final FlushStrategy flushStrategy) {\n      * @param loggerName The name of the logger to log wire events\n      */\n     public final void enableWireLogging(final String loggerName) {\n-        enableWireLogging(loggerName, TRACE, true);\n+        enableWireLogging(loggerName, TRACE, () -> false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5NjQxMA=="}, "originalCommit": {"oid": "1921d581b0a0c701a87ee6f9d9ee06521e53c335"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MTA4NTM4OnYy", "diffSide": "RIGHT", "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/ServiceTalkWireLogger.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzo1NzozOFrOHwGVBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzo1NzozOFrOHwGVBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5NzM4MA==", "bodyText": "Consider also implementing public void read(final ChannelHandlerContext ctx) throws Exception method.\nNetty's LoggingHandler does not have it, but I think it's a useful event for debugging.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520197380", "createdAt": "2020-11-09T23:57:38Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/ServiceTalkWireLogger.java", "diffHunk": "@@ -35,11 +36,11 @@\n \n final class ServiceTalkWireLogger extends ChannelDuplexHandler {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1921d581b0a0c701a87ee6f9d9ee06521e53c335"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MTExODUxOnYy", "diffSide": "RIGHT", "path": "servicetalk-tcp-netty-internal/src/main/java/io/servicetalk/tcp/netty/internal/AbstractReadOnlyTcpConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMDoxMjoyMFrOHwGoXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMDoxMjoyMFrOHwGoXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwMjMzMg==", "bodyText": "No idea why it was pre-existing, but it looks like we need just a UserDataLoggerConfig on the AbstractReadOnlyTcpConfig API. We should create WireLoggingInitializer inside Tcp[Client|Server]ChannelInitializer to make it consistent with all the other initializers we create there. AbstractReadOnlyTcpConfig should be just a config object without knowledge of initializers.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520202332", "createdAt": "2020-11-10T00:12:20Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-tcp-netty-internal/src/main/java/io/servicetalk/tcp/netty/internal/AbstractReadOnlyTcpConfig.java", "diffHunk": "@@ -51,8 +52,10 @@ protected AbstractReadOnlyTcpConfig(final AbstractTcpConfig<SecurityConfig, Read\n         options = from.options() == null ? emptyMap() : unmodifiableMap(new HashMap<>(from.options()));\n         idleTimeoutMs = from.idleTimeoutMs();\n         flushStrategy = from.flushStrategy();\n-        final String wireLoggerName = from.wireLoggerName();\n-        wireLoggingInitializer = wireLoggerName != null ? new WireLoggingInitializer(wireLoggerName) : null;\n+        final UserDataLoggerConfig wireLoggerConfig = from.wireLoggerConfig();\n+        wireLoggingInitializer = wireLoggerConfig != null ?\n+                new WireLoggingInitializer(wireLoggerConfig.loggerName(),\n+                        wireLoggerConfig.logLevel(), wireLoggerConfig.logUserData()) : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1921d581b0a0c701a87ee6f9d9ee06521e53c335"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MTEzNjcwOnYy", "diffSide": "RIGHT", "path": "servicetalk-logging-slf4j-internal/src/main/java/io/servicetalk/logging/slf4j/internal/Slf4jFixedLevelLoggers.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMDoyMDoyN1rOHwGy_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxOTowMDo0MFrOHwrUqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwNTA1NQ==", "bodyText": "requireNonNull(loggerName)?", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520205055", "createdAt": "2020-11-10T00:20:27Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-logging-slf4j-internal/src/main/java/io/servicetalk/logging/slf4j/internal/Slf4jFixedLevelLoggers.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.logging.slf4j.internal;\n+\n+import io.servicetalk.logging.api.LogLevel;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * SLF4J implementations of {@link FixedLevelLogger}.\n+ */\n+public final class Slf4jFixedLevelLoggers {\n+    private Slf4jFixedLevelLoggers() {\n+    }\n+\n+    /**\n+     * Create a {@link FixedLevelLogger}.\n+     * @param loggerName the name of the logger to use.\n+     * @param level the level to log at.\n+     * @return a {@link FixedLevelLogger}.\n+     */\n+    public static FixedLevelLogger newLogger(final String loggerName, final LogLevel level) {\n+        final Logger logger = LoggerFactory.getLogger(loggerName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1921d581b0a0c701a87ee6f9d9ee06521e53c335"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwMzQ5OQ==", "bodyText": "I'll let LoggerFactory.getLogger enforce this.", "url": "https://github.com/apple/servicetalk/pull/1199#discussion_r520803499", "createdAt": "2020-11-10T19:00:40Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-logging-slf4j-internal/src/main/java/io/servicetalk/logging/slf4j/internal/Slf4jFixedLevelLoggers.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.logging.slf4j.internal;\n+\n+import io.servicetalk.logging.api.LogLevel;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * SLF4J implementations of {@link FixedLevelLogger}.\n+ */\n+public final class Slf4jFixedLevelLoggers {\n+    private Slf4jFixedLevelLoggers() {\n+    }\n+\n+    /**\n+     * Create a {@link FixedLevelLogger}.\n+     * @param loggerName the name of the logger to use.\n+     * @param level the level to log at.\n+     * @return a {@link FixedLevelLogger}.\n+     */\n+    public static FixedLevelLogger newLogger(final String loggerName, final LogLevel level) {\n+        final Logger logger = LoggerFactory.getLogger(loggerName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwNTA1NQ=="}, "originalCommit": {"oid": "1921d581b0a0c701a87ee6f9d9ee06521e53c335"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2621, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}