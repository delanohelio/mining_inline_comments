{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5OTc3NjI4", "number": 1004, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMDo1MjoxNlrODvW48Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzowMDo1MFrODvbG0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwOTg0Njg5OnYy", "diffSide": "RIGHT", "path": "servicetalk-opentracing-http/src/main/java/io/servicetalk/opentracing/http/TracingHttpServiceFilter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMDo1MjoxNlrOGBvIIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMToyODoyOFrOGBvuig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ3Mzg5MA==", "bodyText": "discussed with @NiteshKant offline on possibility of splitting this filter into two:\n\nTracerExtractor\nTracerCloser\n\nhowever the complexity of implementation would be high to hand-off ownership between filters. Also I will come up with a PR to change when* operators to default to before* (instead of after*) to reduce the risk of filters inadvertently applying an \"after\" operator which would mean their filter response processing may run without trace info.", "url": "https://github.com/apple/servicetalk/pull/1004#discussion_r404473890", "createdAt": "2020-04-07T00:52:16Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-opentracing-http/src/main/java/io/servicetalk/opentracing/http/TracingHttpServiceFilter.java", "diffHunk": "@@ -40,6 +43,12 @@\n \n /**\n  * A {@link StreamingHttpService} that supports open tracing.\n+ * <p>\n+ * Append this filter before others that are expected to see {@link Scope} for this request/response. Filters appended", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9632b529e5cc5dc005794a75a5571086997f7bab"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ4MzcyMg==", "bodyText": "Yes agreed!\nIt seems logical to define the scope of an operation within the context of a filter. After* operators seem to extend that scope after everything else outside that scope. Drawing an analogy to an imperative programming model:\npublic Result someMethod(Caller caller) {\n\n    State state;\n    try {\n        state = new State();\n        Result result = doWork();\n        return result;\n    } finally {\n         // Code here is analogous to beforeFinally async operators.\n         state.cleanup(); \n        // In order to demonstrate cleanup from the code that is calling this method. \n        // Assume caller is passed to this method.\n        caller.cleanup();\n    }\n// Code below this is analogous to async afterFinally operators.\n}", "url": "https://github.com/apple/servicetalk/pull/1004#discussion_r404483722", "createdAt": "2020-04-07T01:28:28Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-opentracing-http/src/main/java/io/servicetalk/opentracing/http/TracingHttpServiceFilter.java", "diffHunk": "@@ -40,6 +43,12 @@\n \n /**\n  * A {@link StreamingHttpService} that supports open tracing.\n+ * <p>\n+ * Append this filter before others that are expected to see {@link Scope} for this request/response. Filters appended", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ3Mzg5MA=="}, "originalCommit": {"oid": "9632b529e5cc5dc005794a75a5571086997f7bab"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwOTg5MDQzOnYy", "diffSide": "RIGHT", "path": "servicetalk-opentracing-asynccontext/src/main/java/io/servicetalk/opentracing/asynccontext/AsyncContextInMemoryScopeManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMToxNjozMFrOGBvh8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMToxNjozMFrOGBvh8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ4MDQ5OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final AsyncContextMap.Key<AsyncContextInMemoryScope> SCOPE_KEY = newKey(\"opentracing\");\n          \n          \n            \n                private static final AsyncContextMap.Key<InMemoryScope> SCOPE_KEY = newKey(\"opentracing\");", "url": "https://github.com/apple/servicetalk/pull/1004#discussion_r404480499", "createdAt": "2020-04-07T01:16:30Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-opentracing-asynccontext/src/main/java/io/servicetalk/opentracing/asynccontext/AsyncContextInMemoryScopeManager.java", "diffHunk": "@@ -31,62 +31,53 @@\n  */\n public final class AsyncContextInMemoryScopeManager implements InMemoryScopeManager {\n     private static final AsyncContextMap.Key<AsyncContextInMemoryScope> SCOPE_KEY = newKey(\"opentracing\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9632b529e5cc5dc005794a75a5571086997f7bab"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwOTg5NTMxOnYy", "diffSide": "RIGHT", "path": "servicetalk-opentracing-http/src/main/java/io/servicetalk/opentracing/http/TracingHttpRequesterFilter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMToxOToyMFrOGBvkzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMToxOToyMFrOGBvkzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ4MTIyOQ==", "bodyText": "This disclaimer also applied for metadata in case of error, you may want to add that.", "url": "https://github.com/apple/servicetalk/pull/1004#discussion_r404481229", "createdAt": "2020-04-07T01:19:20Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-opentracing-http/src/main/java/io/servicetalk/opentracing/http/TracingHttpRequesterFilter.java", "diffHunk": "@@ -34,13 +35,21 @@\n import io.opentracing.Tracer;\n import io.opentracing.Tracer.SpanBuilder;\n \n+import java.util.function.UnaryOperator;\n+\n import static io.opentracing.tag.Tags.HTTP_METHOD;\n import static io.opentracing.tag.Tags.HTTP_URL;\n import static io.opentracing.tag.Tags.SPAN_KIND;\n import static io.opentracing.tag.Tags.SPAN_KIND_CLIENT;\n \n /**\n  * An HTTP filter that supports open tracing.\n+ * <p>\n+ * Append this filter before others that are expected to to see {@link Scope} for this request/response. Filters\n+ * appended after this filter that use operators with the <strong>after*</strong> prefix on the\n+ * {@link StreamingHttpResponse#transformRawPayloadBody(UnaryOperator) response payload body} (e.g.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9632b529e5cc5dc005794a75a5571086997f7bab"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMDUyNTQ1OnYy", "diffSide": "RIGHT", "path": "servicetalk-log4j2-mdc-utils/src/testFixtures/java/io/servicetalk/log4j2/mdc/utils/LoggerStringWriter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNjo1Njo1OFrOGB1atQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMzozODowOFrOGCZ7_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU3Njk0OQ==", "bodyText": "nit: the method body could be just moved to remove.", "url": "https://github.com/apple/servicetalk/pull/1004#discussion_r404576949", "createdAt": "2020-04-07T06:56:58Z", "author": {"login": "normanmaurer"}, "path": "servicetalk-log4j2-mdc-utils/src/testFixtures/java/io/servicetalk/log4j2/mdc/utils/LoggerStringWriter.java", "diffHunk": "@@ -157,21 +165,41 @@ private static synchronized StringWriter getStringWriter() {\n         return logStringWriter;\n     }\n \n+    private static synchronized void removeStringWriter() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ff9dccfcd2b9b4f1ce81697bafaa4e42679d396"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3NTI5NQ==", "bodyText": "I'll leave this as is to avoid exposing the static synchronized on the public method and for consistency with the reset() method structure.", "url": "https://github.com/apple/servicetalk/pull/1004#discussion_r405175295", "createdAt": "2020-04-07T23:38:08Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-log4j2-mdc-utils/src/testFixtures/java/io/servicetalk/log4j2/mdc/utils/LoggerStringWriter.java", "diffHunk": "@@ -157,21 +165,41 @@ private static synchronized StringWriter getStringWriter() {\n         return logStringWriter;\n     }\n \n+    private static synchronized void removeStringWriter() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU3Njk0OQ=="}, "originalCommit": {"oid": "7ff9dccfcd2b9b4f1ce81697bafaa4e42679d396"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMDUzMTc0OnYy", "diffSide": "RIGHT", "path": "servicetalk-opentracing-http/src/test/java/io/servicetalk/opentracing/http/TestUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNjo1OTowMVrOGB1ebQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMzozODoxOFrOGCZ8Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU3NzkwMQ==", "bodyText": "nit: you could just use assertTrue(foundMatch, \"....\");", "url": "https://github.com/apple/servicetalk/pull/1004#discussion_r404577901", "createdAt": "2020-04-07T06:59:01Z", "author": {"login": "normanmaurer"}, "path": "servicetalk-opentracing-http/src/test/java/io/servicetalk/opentracing/http/TestUtils.java", "diffHunk": "@@ -43,6 +54,36 @@ private static String getRandomHexString(int numchars) {\n         return sb.toString().substring(0, numchars);\n     }\n \n+    static void verifyTraceIdPresentInLogs(String logs, String requestPath, String traceId, String spanId,\n+                                           @Nullable String parentSpanId, String[] logLinePrefix) {\n+        if (parentSpanId == null) {\n+            parentSpanId = TracingConstants.NO_PARENT_ID;\n+        }\n+        String[] lines = logs.split(\"\\\\r?\\\\n\");\n+        for (final String linePrefix : logLinePrefix) {\n+            String prefix = linePrefix.replaceFirst(\"\\\\{}\", requestPath);\n+            boolean foundMatch = false;\n+            for (String line : lines) {\n+                int matchIndex = line.indexOf(prefix);\n+                if (matchIndex != -1) {\n+                    foundMatch = true;\n+                    try {\n+                        assertContainsMdcPair(line, \"traceId=\", traceId);\n+                        assertContainsMdcPair(line, \"spanId=\", spanId);\n+                        assertContainsMdcPair(line, \"parentSpanId=\", parentSpanId);\n+                    } catch (Throwable cause) {\n+                        cause.addSuppressed(new AssertionError(\"failed on prefix: \" + prefix));\n+                        throw cause;\n+                    }\n+                    break;\n+                }\n+            }\n+            if (!foundMatch) {\n+                throw new AssertionError(\"could not find log line with prefix: \" + prefix);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ff9dccfcd2b9b4f1ce81697bafaa4e42679d396"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3NTMyNg==", "bodyText": "follow-up PR #1009", "url": "https://github.com/apple/servicetalk/pull/1004#discussion_r405175326", "createdAt": "2020-04-07T23:38:18Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-opentracing-http/src/test/java/io/servicetalk/opentracing/http/TestUtils.java", "diffHunk": "@@ -43,6 +54,36 @@ private static String getRandomHexString(int numchars) {\n         return sb.toString().substring(0, numchars);\n     }\n \n+    static void verifyTraceIdPresentInLogs(String logs, String requestPath, String traceId, String spanId,\n+                                           @Nullable String parentSpanId, String[] logLinePrefix) {\n+        if (parentSpanId == null) {\n+            parentSpanId = TracingConstants.NO_PARENT_ID;\n+        }\n+        String[] lines = logs.split(\"\\\\r?\\\\n\");\n+        for (final String linePrefix : logLinePrefix) {\n+            String prefix = linePrefix.replaceFirst(\"\\\\{}\", requestPath);\n+            boolean foundMatch = false;\n+            for (String line : lines) {\n+                int matchIndex = line.indexOf(prefix);\n+                if (matchIndex != -1) {\n+                    foundMatch = true;\n+                    try {\n+                        assertContainsMdcPair(line, \"traceId=\", traceId);\n+                        assertContainsMdcPair(line, \"spanId=\", spanId);\n+                        assertContainsMdcPair(line, \"parentSpanId=\", parentSpanId);\n+                    } catch (Throwable cause) {\n+                        cause.addSuppressed(new AssertionError(\"failed on prefix: \" + prefix));\n+                        throw cause;\n+                    }\n+                    break;\n+                }\n+            }\n+            if (!foundMatch) {\n+                throw new AssertionError(\"could not find log line with prefix: \" + prefix);\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU3NzkwMQ=="}, "originalCommit": {"oid": "7ff9dccfcd2b9b4f1ce81697bafaa4e42679d396"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMDUzNTcxOnYy", "diffSide": "RIGHT", "path": "servicetalk-opentracing-http/src/test/java/io/servicetalk/opentracing/http/TracingHttpRequesterFilterTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzowMDoxOFrOGB1g1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzowMDoxOFrOGB1g1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU3ODUxNg==", "bodyText": "I guess it doesn't matter as its just used in the test but usually you should call .clone() on an array when it is passed via the constructor to ensure it can't be modified later on.", "url": "https://github.com/apple/servicetalk/pull/1004#discussion_r404578516", "createdAt": "2020-04-07T07:00:18Z", "author": {"login": "normanmaurer"}, "path": "servicetalk-opentracing-http/src/test/java/io/servicetalk/opentracing/http/TracingHttpRequesterFilterTest.java", "diffHunk": "@@ -189,4 +221,54 @@ private static ServerContext buildServer() throws Exception {\n     private static String toStringOrNull(@Nullable CharSequence cs) {\n         return cs == null ? null : cs.toString();\n     }\n+\n+    private static final class TestTracingLoggerFilter implements StreamingHttpClientFilterFactory {\n+        private final String[] logLinePrefix;\n+\n+        TestTracingLoggerFilter(final String[] logLinePrefix) {\n+            this.logLinePrefix = requireNonNull(logLinePrefix);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ff9dccfcd2b9b4f1ce81697bafaa4e42679d396"}, "originalPosition": 137}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMDUzNzEyOnYy", "diffSide": "RIGHT", "path": "servicetalk-opentracing-http/src/test/java/io/servicetalk/opentracing/http/TracingHttpServiceFilterTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzowMDozOVrOGB1hoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzowMDozOVrOGB1hoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU3ODcyMQ==", "bodyText": "same comment as above", "url": "https://github.com/apple/servicetalk/pull/1004#discussion_r404578721", "createdAt": "2020-04-07T07:00:39Z", "author": {"login": "normanmaurer"}, "path": "servicetalk-opentracing-http/src/test/java/io/servicetalk/opentracing/http/TracingHttpServiceFilterTest.java", "diffHunk": "@@ -176,4 +210,54 @@ public void tracerThrowsReturnsErrorResponse() throws Exception {\n             }\n         }\n     }\n+\n+    private static final class TestTracingLoggerFilter implements StreamingHttpServiceFilterFactory {\n+        private final String[] logLinePrefix;\n+\n+        private TestTracingLoggerFilter(final String[] logLinePrefix) {\n+            this.logLinePrefix = requireNonNull(logLinePrefix);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ff9dccfcd2b9b4f1ce81697bafaa4e42679d396"}, "originalPosition": 136}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMDUzNzc3OnYy", "diffSide": "RIGHT", "path": "servicetalk-opentracing-http/src/test/resources/log4j2-test.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzowMDo1MFrOGB1iBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNzowMDo1MFrOGB1iBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU3ODgyMg==", "bodyText": "2020 ?", "url": "https://github.com/apple/servicetalk/pull/1004#discussion_r404578822", "createdAt": "2020-04-07T07:00:50Z", "author": {"login": "normanmaurer"}, "path": "servicetalk-opentracing-http/src/test/resources/log4j2-test.xml", "diffHunk": "@@ -0,0 +1,29 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright \u00a9 2018 Apple Inc. and the ServiceTalk project authors", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ff9dccfcd2b9b4f1ce81697bafaa4e42679d396"}, "originalPosition": 3}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2667, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}