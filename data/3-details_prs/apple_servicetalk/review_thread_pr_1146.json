{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzMDg3NTU4", "number": 1146, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwMTowMzo0MFrOEh6Ojg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwMTozOToyNFrOEh6nPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTkyNDYyOnYy", "diffSide": "RIGHT", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/ServiceDiscoverer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwMTowMzo0MFrOHPfP5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMDoxOTo1OFrOHQEThQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwMjY2MA==", "bodyText": "Do we need a List? Will Collection be enough?", "url": "https://github.com/apple/servicetalk/pull/1146#discussion_r486002660", "createdAt": "2020-09-10T01:03:40Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/ServiceDiscoverer.java", "diffHunk": "@@ -47,5 +49,5 @@\n      * </ul>\n      * @return a {@link Publisher} that represents a stream of events from the service discovery system.\n      */\n-    Publisher<E> discover(UnresolvedAddress address);\n+    Publisher<List<E>> discover(UnresolvedAddress address);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37798bd3e914a990f7a283cbe395fe3960078df"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwOTc5Nw==", "bodyText": "Good call, Collection is enough", "url": "https://github.com/apple/servicetalk/pull/1146#discussion_r486609797", "createdAt": "2020-09-10T20:19:58Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/ServiceDiscoverer.java", "diffHunk": "@@ -47,5 +49,5 @@\n      * </ul>\n      * @return a {@link Publisher} that represents a stream of events from the service discovery system.\n      */\n-    Publisher<E> discover(UnresolvedAddress address);\n+    Publisher<List<E>> discover(UnresolvedAddress address);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwMjY2MA=="}, "originalCommit": {"oid": "f37798bd3e914a990f7a283cbe395fe3960078df"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTk4NzgyOnYy", "diffSide": "RIGHT", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwMTozOToyNFrOHPf0Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMDozMDowNlrOHQEosA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAxMTk5OA==", "bodyText": "If we change public API of SD to emit List of addresses, should we also change LB factory API to use the same API for eventPublisher? Looks a bit weird do have these API different.", "url": "https://github.com/apple/servicetalk/pull/1146#discussion_r486011998", "createdAt": "2020-09-10T01:39:24Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -263,8 +255,9 @@ public StreamingHttpClient buildStreaming() {\n         // Track resources that potentially need to be closed when an exception is thrown during buildStreaming\n         final CompositeCloseable closeOnException = newCompositeCloseable();\n         try {\n-            final SdStatusCompletable sdStatus = new SdStatusCompletable();\n-            final Publisher<? extends ServiceDiscovererEvent<R>> sdEvents = ctx.discover(sdStatus);\n+\n+            final Publisher<ServiceDiscovererEvent<R>> sdEvents =\n+                    ctx.serviceDiscoverer.discover(ctx.address()).flatMapConcatIterable(identity());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37798bd3e914a990f7a283cbe395fe3960078df"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxNTIxNg==", "bodyText": "I think sending the List to load balancer does not have any value as LBs are not expected to cache, batch SD updates. Passing the List makes the API more complex, so I decided not to propagate the changes to the LB layer. If we see a need in the future, it should be straight forward to change.", "url": "https://github.com/apple/servicetalk/pull/1146#discussion_r486615216", "createdAt": "2020-09-10T20:30:06Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -263,8 +255,9 @@ public StreamingHttpClient buildStreaming() {\n         // Track resources that potentially need to be closed when an exception is thrown during buildStreaming\n         final CompositeCloseable closeOnException = newCompositeCloseable();\n         try {\n-            final SdStatusCompletable sdStatus = new SdStatusCompletable();\n-            final Publisher<? extends ServiceDiscovererEvent<R>> sdEvents = ctx.discover(sdStatus);\n+\n+            final Publisher<ServiceDiscovererEvent<R>> sdEvents =\n+                    ctx.serviceDiscoverer.discover(ctx.address()).flatMapConcatIterable(identity());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAxMTk5OA=="}, "originalCommit": {"oid": "f37798bd3e914a990f7a283cbe395fe3960078df"}, "originalPosition": 113}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2567, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}