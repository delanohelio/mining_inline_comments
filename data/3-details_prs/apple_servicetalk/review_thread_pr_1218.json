{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNTAxMDU3", "number": 1218, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzo1NTowOVrOE60L9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzo1NTowOVrOE60L9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTA3ODkzOnYy", "diffSide": "RIGHT", "path": "servicetalk-concurrent-api/src/test/java/io/servicetalk/concurrent/api/PublisherFlatMapMergeTest.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzo1NTowOVrOH2HD5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDoxMDoyNVrOH2HZHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMDgzOA==", "bodyText": "The ordering of events in this test is a bit confusing. results queue already has 21 before processor.onError(DELIBERATE_EXCEPTION) is invoked. Consider moving this check up if this is expected.\nWhy the concatenated cause is not delivered to mockSubscriber?", "url": "https://github.com/apple/servicetalk/pull/1218#discussion_r526500838", "createdAt": "2020-11-18T23:55:09Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-concurrent-api/src/test/java/io/servicetalk/concurrent/api/PublisherFlatMapMergeTest.java", "diffHunk": "@@ -96,6 +105,43 @@ public static void afterClass() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void mappedRecoverMakesProgress() throws Exception {\n+        @SuppressWarnings(\"unchecked\")\n+        Subscriber<Integer> mockSubscriber = mock(Subscriber.class);\n+        CountDownLatch latchOnSubscribe = new CountDownLatch(1);\n+        CountDownLatch latchOnError = new CountDownLatch(1);\n+        AtomicReference<Throwable> causeRef = new AtomicReference<>();\n+        BlockingQueue<Integer> results = new ArrayBlockingQueue<>(10);\n+        doAnswer(a -> {\n+            Subscription s = a.getArgument(0);\n+            s.request(4);\n+            latchOnSubscribe.countDown();\n+            return null;\n+        }).when(mockSubscriber).onSubscribe(any(Subscription.class));\n+        doAnswer(a -> {\n+            causeRef.set(a.getArgument(0));\n+            latchOnError.countDown();\n+            return null;\n+        }).when(mockSubscriber).onError(any());\n+        doAnswer(a -> {\n+            results.add(a.getArgument(0));\n+            throw new DeliberateException();\n+        }).when(mockSubscriber).onNext(any());\n+\n+        Processor<Integer, Integer> processor = newPublisherProcessor();\n+        toSource(fromSource(processor).flatMapMergeDelayError(i -> from(i + 10).recoverWith(cause ->\n+                from(i + 20).concat(failed(cause))))).subscribe(mockSubscriber);\n+\n+        latchOnSubscribe.await();\n+        processor.onNext(1);\n+        assertThat(results.take(), is(11));\n+        processor.onError(DELIBERATE_EXCEPTION);\n+        assertThat(results.take(), is(21));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6070af98f107fc45dfd548925c6241dc2449459"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMTU0Ng==", "bodyText": "oh, bcz we delay error.", "url": "https://github.com/apple/servicetalk/pull/1218#discussion_r526501546", "createdAt": "2020-11-18T23:57:00Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-concurrent-api/src/test/java/io/servicetalk/concurrent/api/PublisherFlatMapMergeTest.java", "diffHunk": "@@ -96,6 +105,43 @@ public static void afterClass() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void mappedRecoverMakesProgress() throws Exception {\n+        @SuppressWarnings(\"unchecked\")\n+        Subscriber<Integer> mockSubscriber = mock(Subscriber.class);\n+        CountDownLatch latchOnSubscribe = new CountDownLatch(1);\n+        CountDownLatch latchOnError = new CountDownLatch(1);\n+        AtomicReference<Throwable> causeRef = new AtomicReference<>();\n+        BlockingQueue<Integer> results = new ArrayBlockingQueue<>(10);\n+        doAnswer(a -> {\n+            Subscription s = a.getArgument(0);\n+            s.request(4);\n+            latchOnSubscribe.countDown();\n+            return null;\n+        }).when(mockSubscriber).onSubscribe(any(Subscription.class));\n+        doAnswer(a -> {\n+            causeRef.set(a.getArgument(0));\n+            latchOnError.countDown();\n+            return null;\n+        }).when(mockSubscriber).onError(any());\n+        doAnswer(a -> {\n+            results.add(a.getArgument(0));\n+            throw new DeliberateException();\n+        }).when(mockSubscriber).onNext(any());\n+\n+        Processor<Integer, Integer> processor = newPublisherProcessor();\n+        toSource(fromSource(processor).flatMapMergeDelayError(i -> from(i + 10).recoverWith(cause ->\n+                from(i + 20).concat(failed(cause))))).subscribe(mockSubscriber);\n+\n+        latchOnSubscribe.await();\n+        processor.onNext(1);\n+        assertThat(results.take(), is(11));\n+        processor.onError(DELIBERATE_EXCEPTION);\n+        assertThat(results.take(), is(21));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMDgzOA=="}, "originalCommit": {"oid": "b6070af98f107fc45dfd548925c6241dc2449459"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMzAwMw==", "bodyText": "WDYT about this ordering of events?\n        latchOnSubscribe.await();\n        processor.onNext(1);\n        assertThat(results.take(), is(11));\n        assertThat(results.take(), is(21));\n        assertThat(causeRef.get(), is(nullValue()));\n        processor.onComplete();\n        latchOnError.await();\n        final Throwable t = causeRef.get();\n        assertThat(t, is(instanceOf(CompositeException.class)));\n        assertThat(t.getCause(), is(DELIBERATE_EXCEPTION));", "url": "https://github.com/apple/servicetalk/pull/1218#discussion_r526503003", "createdAt": "2020-11-19T00:01:00Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-concurrent-api/src/test/java/io/servicetalk/concurrent/api/PublisherFlatMapMergeTest.java", "diffHunk": "@@ -96,6 +105,43 @@ public static void afterClass() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void mappedRecoverMakesProgress() throws Exception {\n+        @SuppressWarnings(\"unchecked\")\n+        Subscriber<Integer> mockSubscriber = mock(Subscriber.class);\n+        CountDownLatch latchOnSubscribe = new CountDownLatch(1);\n+        CountDownLatch latchOnError = new CountDownLatch(1);\n+        AtomicReference<Throwable> causeRef = new AtomicReference<>();\n+        BlockingQueue<Integer> results = new ArrayBlockingQueue<>(10);\n+        doAnswer(a -> {\n+            Subscription s = a.getArgument(0);\n+            s.request(4);\n+            latchOnSubscribe.countDown();\n+            return null;\n+        }).when(mockSubscriber).onSubscribe(any(Subscription.class));\n+        doAnswer(a -> {\n+            causeRef.set(a.getArgument(0));\n+            latchOnError.countDown();\n+            return null;\n+        }).when(mockSubscriber).onError(any());\n+        doAnswer(a -> {\n+            results.add(a.getArgument(0));\n+            throw new DeliberateException();\n+        }).when(mockSubscriber).onNext(any());\n+\n+        Processor<Integer, Integer> processor = newPublisherProcessor();\n+        toSource(fromSource(processor).flatMapMergeDelayError(i -> from(i + 10).recoverWith(cause ->\n+                from(i + 20).concat(failed(cause))))).subscribe(mockSubscriber);\n+\n+        latchOnSubscribe.await();\n+        processor.onNext(1);\n+        assertThat(results.take(), is(11));\n+        processor.onError(DELIBERATE_EXCEPTION);\n+        assertThat(results.take(), is(21));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMDgzOA=="}, "originalCommit": {"oid": "b6070af98f107fc45dfd548925c6241dc2449459"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwNjI3MA==", "bodyText": "I adjusted slightly but sgtm!", "url": "https://github.com/apple/servicetalk/pull/1218#discussion_r526506270", "createdAt": "2020-11-19T00:10:25Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-concurrent-api/src/test/java/io/servicetalk/concurrent/api/PublisherFlatMapMergeTest.java", "diffHunk": "@@ -96,6 +105,43 @@ public static void afterClass() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void mappedRecoverMakesProgress() throws Exception {\n+        @SuppressWarnings(\"unchecked\")\n+        Subscriber<Integer> mockSubscriber = mock(Subscriber.class);\n+        CountDownLatch latchOnSubscribe = new CountDownLatch(1);\n+        CountDownLatch latchOnError = new CountDownLatch(1);\n+        AtomicReference<Throwable> causeRef = new AtomicReference<>();\n+        BlockingQueue<Integer> results = new ArrayBlockingQueue<>(10);\n+        doAnswer(a -> {\n+            Subscription s = a.getArgument(0);\n+            s.request(4);\n+            latchOnSubscribe.countDown();\n+            return null;\n+        }).when(mockSubscriber).onSubscribe(any(Subscription.class));\n+        doAnswer(a -> {\n+            causeRef.set(a.getArgument(0));\n+            latchOnError.countDown();\n+            return null;\n+        }).when(mockSubscriber).onError(any());\n+        doAnswer(a -> {\n+            results.add(a.getArgument(0));\n+            throw new DeliberateException();\n+        }).when(mockSubscriber).onNext(any());\n+\n+        Processor<Integer, Integer> processor = newPublisherProcessor();\n+        toSource(fromSource(processor).flatMapMergeDelayError(i -> from(i + 10).recoverWith(cause ->\n+                from(i + 20).concat(failed(cause))))).subscribe(mockSubscriber);\n+\n+        latchOnSubscribe.await();\n+        processor.onNext(1);\n+        assertThat(results.take(), is(11));\n+        processor.onError(DELIBERATE_EXCEPTION);\n+        assertThat(results.take(), is(21));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMDgzOA=="}, "originalCommit": {"oid": "b6070af98f107fc45dfd548925c6241dc2449459"}, "originalPosition": 76}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2433, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}