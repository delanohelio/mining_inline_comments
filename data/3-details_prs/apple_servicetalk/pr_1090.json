{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNzc3OTM2", "number": 1090, "title": "Do not shutdown output channel until client receives the full response", "bodyText": "Motivation:\nWhen client observes \"Connection: close\" header it shutdowns the output\nchannel as soon as request is written. Some servers interpret FIN from\nthe client as an indicator that it lost interest in their data and\ntherefore, server just closes the second half of the connection asap.\nAs the result, connection may be closed before client receives the full\nresponse from the server.\nModifications:\n\nReproduce this scenario using a simple proxy tunnel that is not aware\nof HTTP protocol semantics;\nDefer connection closure on the client side until it completes the\nfull request-response iteration;\nFail all subsequent or pipelined requests on the connection that moves\nto the \"closing\" state;\nAdjust RequestResponseCloseHandlerTest to not expecting outbound\nhalf-closure on the client side;\nAdd more tests to verify that client handles \"Connection: close\" header\ncorrectly;\n\nResult:\nResponse is not aborted when client observes \"Connection: close\" header.", "createdAt": "2020-06-26T20:40:56Z", "url": "https://github.com/apple/servicetalk/pull/1090", "merged": true, "mergeCommit": {"oid": "39fab8014fb9a5dd03a9dc45486b459c765e3309"}, "closed": true, "closedAt": "2020-07-01T18:25:18Z", "author": {"login": "idelpivnitskiy"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvJacSgH2gAyNDQwNzc3OTM2OjRmMGM3ODFkZDg3NzQzNDMyNzlkODBiZGUxMjhkZWE1ZWM3MTMyYTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwtOlHAFqTQ0MTA0NDA0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4f0c781dd8774343279d80bde128dea5ec7132a1", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/4f0c781dd8774343279d80bde128dea5ec7132a1", "committedDate": "2020-06-26T20:38:33Z", "message": "Do not shutdown output channel until client receives the full response\n\nMotivation:\n\nWhen client observes \"Connection: close\" header it shutdowns the output\nchannel as soon as request is written. Some servers interpret FIN from\nthe client as an indicator that it lost interest in their data and\ntherefore, server just closes the second half of the connection asap.\nAs the result, connection may be closed before client receives the full\nresponse from the server.\n\nModifications:\n\n- Reproduce this scenario using a simple proxy tunnel that is not aware\nof HTTP protocol semantics;\n- Defer connection closure on the client side until it completes the\nfull request-response iteration;\n- Fail all subsequent or pipelined requests on the connection that moves\nto the \"closing\" state;\n- Adjust `RequestResponseCloseHandlerTest` to not expecting outbound\nhalf-closure on the client side;\n- Add more tests to verify that client handles \"Connection: close\" header\ncorrectly;\n\nResult:\n\nResponse is not aborted when client observes \"Connection: close\" header."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5Mjc3ODU5", "url": "https://github.com/apple/servicetalk/pull/1090#pullrequestreview-439277859", "createdAt": "2020-06-29T15:47:59Z", "commit": {"oid": "4f0c781dd8774343279d80bde128dea5ec7132a1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzozMjoyOFrOGqbGvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxODozMjozN1rOGqdLcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEzNzQ2OQ==", "bodyText": "If pending > 0 then we are not writing the current request.\nPlz add an explanation about the subtle meaning of this condition:\n\"Protocol inbound closing for a client is when a response is read, which decrements the pending count before reading the inbound closure signal. This means if pending > 0 there are more requests pending responses but the peer has signalled close. We need to abort write for pending requests\"", "url": "https://github.com/apple/servicetalk/pull/1090#discussion_r447137469", "createdAt": "2020-06-29T17:32:28Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/RequestResponseCloseHandler.java", "diffHunk": "@@ -255,15 +253,14 @@ private void maybeCloseChannelHalfOrFullyOnClosing(final Channel channel, final\n             closeChannel(channel, evt);\n         } else if (isClient) {\n             if (evt == PROTOCOL_CLOSING_INBOUND) {\n-                if (pending != 0 || !has(state, WRITE)) {\n-                    // eagerly close the outbound channel unless we are still writing the current request\n+                if (pending != 0) {\n+                    // Abort the current and all following pipelined requests", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f0c781dd8774343279d80bde128dea5ec7132a1"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE1MzA3Mg==", "bodyText": "This name and comment isn't indicating the intent of this event.\nAbortWritesEvent is a better name that correctly indicates what we are doing at the moment.", "url": "https://github.com/apple/servicetalk/pull/1090#discussion_r447153072", "createdAt": "2020-06-29T17:59:57Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/CloseHandler.java", "diffHunk": "@@ -355,4 +355,15 @@ private ProtocolPayloadEndEvent() {\n             // No instances.\n         }\n     }\n+\n+    /**\n+     * Netty UserEvent to indicate the output channel is closing.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f0c781dd8774343279d80bde128dea5ec7132a1"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MjkyOA==", "bodyText": "Till now these events represented things that happened on the socket or what is exposed on the Close handler APIs. ChannelOutputClosingEvent is an event generated by the CloseHandler itself. Can we avoid expanding scope of events here? Instead validate/simulate things that will happen on the socket, like aborting writes.", "url": "https://github.com/apple/servicetalk/pull/1090#discussion_r447162928", "createdAt": "2020-06-29T18:17:58Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/test/java/io/servicetalk/transport/netty/internal/RequestResponseCloseHandlerTest.java", "diffHunk": "@@ -175,6 +178,7 @@ public Scenarios(final Mode mode, final List<Events> events, final ExpectEvent e\n             SR,         // validate Socket TCP RST -> SO_LINGER=0\n             UC,         // emit User Closing\n             IH, OH, FC, // validate Input/Output Half-close, Full-Close\n+            CE,         // emit ChannelOutputClosingEvent", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f0c781dd8774343279d80bde128dea5ec7132a1"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE3MTQ0Mw==", "bodyText": "closeReason isn't volatile so this may never see the closeReason.\nInstead of using closeReason here use the new pipeline event to replace writableListener with a \"poison value\" that indicates abort writes and also aborts the current write if present.", "url": "https://github.com/apple/servicetalk/pull/1090#discussion_r447171443", "createdAt": "2020-06-29T18:32:37Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/DefaultNettyConnection.java", "diffHunk": "@@ -408,7 +409,8 @@ private boolean failIfWriteActive(ChannelOutboundListener newChannelOutboundList\n             // It is possible that we have set the writeSubscriber, then the channel becomes inactive, and we will\n             // never notify the write writeSubscriber of the inactive event. So if the channel is inactive we notify\n             // the writeSubscriber.\n-            if (!channel().isActive()) {\n+            // It is also possible that Channel is in closing state, so we need to prevent sending more requests.\n+            if (!channel().isActive() || closeReason != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f0c781dd8774343279d80bde128dea5ec7132a1"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa70b2ebed49b8807d0c8e840c46224938b3c878", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/aa70b2ebed49b8807d0c8e840c46224938b3c878", "committedDate": "2020-06-30T17:02:55Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a74c80704b9d2296f80377a852a221d4331412ef", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/a74c80704b9d2296f80377a852a221d4331412ef", "committedDate": "2020-07-01T00:04:13Z", "message": "Remove volatile boolean and make closeReason volatile"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDQ0MDQ3", "url": "https://github.com/apple/servicetalk/pull/1090#pullrequestreview-441044047", "createdAt": "2020-07-01T16:56:06Z", "commit": {"oid": "a74c80704b9d2296f80377a852a221d4331412ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3744, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}