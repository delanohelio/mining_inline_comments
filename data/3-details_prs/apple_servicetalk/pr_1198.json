{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2Mzc2MjIw", "number": 1198, "title": "Consolidation of HTTP codecs with gRPC", "bodyText": "Motivation:\nConsolidate HTTP codec work with gRPC codecs for a unified API and implementation.\nModifications:\nRe-use HTTP codecs for the non streaming version of HTTP.\nAdhere to the same changes applied for HTTP, to allow for codec ordering.\nResult:\nUnified API & implementation between HTTP. & gRPC.", "createdAt": "2020-11-05T22:25:24Z", "url": "https://github.com/apple/servicetalk/pull/1198", "merged": true, "mergeCommit": {"oid": "bb2a77c57101c959b87bb2348511e61f92b173f2"}, "closed": true, "closedAt": "2020-12-03T23:41:46Z", "author": {"login": "tkountis"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZqFfSgFqTUyNDcyMTgzNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdirwXCAH2gAyNTE2Mzc2MjIwOjk0MDgxYmVkMzg3N2YyNmJjMDkxNTM0OTI4NWZkMDhkNWRhMTYxODk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NzIxODM1", "url": "https://github.com/apple/servicetalk/pull/1198#pullrequestreview-524721835", "createdAt": "2020-11-05T22:27:21Z", "commit": {"oid": "a16637fb4f2d6244d8152b15842eb6070a74e4b7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjoyNzoyMVrOHuZHNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjoyNzoyMVrOHuZHNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQwNzk4OA==", "bodyText": "I am on the fence about removing this. I guess we could keep this around and use this interface for gRPC (delegating to the HTTP codec), allowing for logic separation if we need it in the future. @idelpivnitskiy thoughts?", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r518407988", "createdAt": "2020-11-05T22:27:21Z", "author": {"login": "tkountis"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcMessageEncoding.java", "diffHunk": "@@ -1,37 +0,0 @@\n-/*\n- * Copyright \u00a9 2019 Apple Inc. and the ServiceTalk project authors\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package io.servicetalk.grpc.api;\n-\n-/**\n- * API for <a href=\"https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md#message-encoding\"> message\n- * coding schemes</a>.\n- */\n-public interface GrpcMessageEncoding {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a16637fb4f2d6244d8152b15842eb6070a74e4b7"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NzU1Njc4", "url": "https://github.com/apple/servicetalk/pull/1198#pullrequestreview-524755678", "createdAt": "2020-11-05T23:36:36Z", "commit": {"oid": "a16637fb4f2d6244d8152b15842eb6070a74e4b7"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMzozNjozNlrOHuaySQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwNDoyMzoxMlrOHufrmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQzNTQwMQ==", "bodyText": "This method is used only in tests and internal utility, can we make it pkg-private for now?", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r518435401", "createdAt": "2020-11-05T23:36:36Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcMessageEncodings.java", "diffHunk": "@@ -91,21 +100,21 @@ public static GrpcMessageEncoding deflate() {\n      *          otherwise {@code null} if {@code name} is {@code null} or empty\n      */\n     @Nullable\n-    public static GrpcMessageEncoding encodingFor(final Collection<GrpcMessageEncoding> allowedList,\n-                                                  @Nullable final String name) {\n+    public static ContentCodec encodingFor(final Collection<ContentCodec> allowedList,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a16637fb4f2d6244d8152b15842eb6070a74e4b7"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ1NTU4Mw==", "bodyText": "Do we need to always add it here? IIRC we always fallback to identity if nothing else was negotiated. With List API there is a risk of adding identity() twice.", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r518455583", "createdAt": "2020-11-06T00:39:23Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-protobuf/src/main/java/io/servicetalk/grpc/protobuf/ProtoBufSerializationProviderBuilder.java", "diffHunk": "@@ -72,7 +72,7 @@\n      * @return {@code this}\n      */\n     public <T extends MessageLite> ProtoBufSerializationProviderBuilder\n-    supportedMessageEncodings(final Set<GrpcMessageEncoding> supportedEncodings) {\n+    supportedMessageEncodings(final List<ContentCodec> supportedEncodings) {\n         this.supportedEncodings.clear();\n         this.supportedEncodings.addAll(supportedEncodings);\n         this.supportedEncodings.add(identity()); // Always supported", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a16637fb4f2d6244d8152b15842eb6070a74e4b7"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUxNDM1MQ==", "bodyText": "Can users use a factory from http-api?", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r518514351", "createdAt": "2020-11-06T04:17:33Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcMessageEncodings.java", "diffHunk": "@@ -15,72 +15,81 @@\n  */\n package io.servicetalk.grpc.api;\n \n+import io.servicetalk.http.api.ContentCodec;\n+import io.servicetalk.http.api.ContentCodecBuilder;\n+import io.servicetalk.http.api.DefaultStreamingContentCodecBuilder.DeflateStreamingContentCodecBuilder;\n+import io.servicetalk.http.api.DefaultStreamingContentCodecBuilder.GzipStreamingContentCodecBuilder;\n+import io.servicetalk.http.api.IdentityContentCodec;\n+\n import java.util.Collection;\n-import java.util.HashSet;\n-import java.util.Set;\n import javax.annotation.Nullable;\n \n-import static java.util.Arrays.asList;\n-import static java.util.Collections.unmodifiableSet;\n+import static io.servicetalk.http.api.CharSequences.contentEqualsIgnoreCase;\n+import static io.servicetalk.http.api.CharSequences.isEmpty;\n+import static io.servicetalk.http.api.CharSequences.startsWith;\n import static java.util.Objects.requireNonNull;\n \n /**\n  * Default available encoding implementations.\n  * Encoding {@link #identity()} is always supported regardless of the client or server settings.\n- *\n- * {@link #all()} is a set that includes all default encodings {@link #deflate()} and {@link #gzip()}.\n  */\n public final class GrpcMessageEncodings {\n \n-    private static final GrpcMessageEncoding IDENTITY =\n-            new DefaultGrpcMessageEncoding(\"identity\", new IdentityMessageCodec());\n-\n-    private static final GrpcMessageEncoding GZIP =\n-            new DefaultGrpcMessageEncoding(\"gzip\", new GzipMessageCodec());\n+    private static final ContentCodec IDENTITY = new IdentityContentCodec();\n \n-    private static final GrpcMessageEncoding DEFLATE =\n-            new DefaultGrpcMessageEncoding(\"deflate\", new DeflateMessageCodec());\n+    private static final ContentCodec GZIP = new GzipStreamingContentCodecBuilder().build();\n \n-    private static final Set<GrpcMessageEncoding> ALL =\n-            unmodifiableSet(new HashSet<>(asList(IDENTITY, GZIP, DEFLATE)));\n+    private static final ContentCodec DEFLATE = new DeflateStreamingContentCodecBuilder().build();\n \n     private GrpcMessageEncodings() {\n     }\n \n     /**\n-     * Returns the default, always supported 'identity' {@link GrpcMessageEncoding}.\n-     * @return the default, always supported 'identity' {@link GrpcMessageEncoding}\n+     * Returns the default, always supported 'identity' {@link ContentCodec}.\n+     * @return the default, always supported 'identity' {@link ContentCodec}\n      */\n-    public static GrpcMessageEncoding identity() {\n+    public static ContentCodec identity() {\n         return IDENTITY;\n     }\n \n     /**\n-     * Returns a GZIP based {@link GrpcMessageEncoding} backed by {@link java.util.zip.Inflater}.\n-     * @return a GZIP based {@link GrpcMessageEncoding} backed by {@link java.util.zip.Inflater}\n+     * Returns a GZIP based {@link ContentCodec} backed by {@link java.util.zip.Inflater}.\n+     * The max allowed payload size for this codec is 2Mib.\n+     *\n+     * @return a GZIP based {@link ContentCodec} backed by {@link java.util.zip.Inflater}\n      */\n-    public static GrpcMessageEncoding gzip() {\n+    public static ContentCodec gzipDefault() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a16637fb4f2d6244d8152b15842eb6070a74e4b7"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUxNTI0Mw==", "bodyText": "Can you please clarify why you expect the need for gRPC-specific type?", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r518515243", "createdAt": "2020-11-06T04:21:33Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcMessageEncoding.java", "diffHunk": "@@ -1,37 +0,0 @@\n-/*\n- * Copyright \u00a9 2019 Apple Inc. and the ServiceTalk project authors\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package io.servicetalk.grpc.api;\n-\n-/**\n- * API for <a href=\"https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md#message-encoding\"> message\n- * coding schemes</a>.\n- */\n-public interface GrpcMessageEncoding {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQwNzk4OA=="}, "originalCommit": {"oid": "a16637fb4f2d6244d8152b15842eb6070a74e4b7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUxNTYwOQ==", "bodyText": "Sad that we need to duplicate these logic in HTTP and gRPC :(\nHope we can have a better way to share it in the future.", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r518515609", "createdAt": "2020-11-06T04:23:12Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -241,14 +239,14 @@ private static void ensureGrpcStatusReceived(final HttpHeaders headers) {\n         }\n     }\n \n-    static GrpcMessageEncoding readGrpcMessageEncoding(final HttpMetaData httpMetaData,\n-                                                       final Set<GrpcMessageEncoding> allowedEncodings) {\n+    static ContentCodec readGrpcMessageEncoding(final HttpMetaData httpMetaData,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a16637fb4f2d6244d8152b15842eb6070a74e4b7"}, "originalPosition": 59}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a16637fb4f2d6244d8152b15842eb6070a74e4b7", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/a16637fb4f2d6244d8152b15842eb6070a74e4b7", "committedDate": "2020-11-05T22:21:42Z", "message": "Replace Set with List to allow for ordering of codecs."}, "afterCommit": {"oid": "fe79c1f71f8d710eff342f269a40cc7d0b1ba8ed", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/fe79c1f71f8d710eff342f269a40cc7d0b1ba8ed", "committedDate": "2020-11-23T10:40:52Z", "message": "Consolidate Http codecs with gRPC"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe79c1f71f8d710eff342f269a40cc7d0b1ba8ed", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/fe79c1f71f8d710eff342f269a40cc7d0b1ba8ed", "committedDate": "2020-11-23T10:40:52Z", "message": "Consolidate Http codecs with gRPC"}, "afterCommit": {"oid": "6701c4ab0efbcbe9fa506dec5314931ce1176329", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/6701c4ab0efbcbe9fa506dec5314931ce1176329", "committedDate": "2020-11-23T12:47:45Z", "message": "Consolidate Http codecs with gRPC"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6701c4ab0efbcbe9fa506dec5314931ce1176329", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/6701c4ab0efbcbe9fa506dec5314931ce1176329", "committedDate": "2020-11-23T12:47:45Z", "message": "Consolidate Http codecs with gRPC"}, "afterCommit": {"oid": "28b12ddabbe2beb3dd8e36711061aaf93112a509", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/28b12ddabbe2beb3dd8e36711061aaf93112a509", "committedDate": "2020-11-23T13:04:05Z", "message": "Consolidate Http codecs with gRPC"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a", "committedDate": "2020-11-23T15:40:52Z", "message": "Consolidate Http codecs with gRPC"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "28b12ddabbe2beb3dd8e36711061aaf93112a509", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/28b12ddabbe2beb3dd8e36711061aaf93112a509", "committedDate": "2020-11-23T13:04:05Z", "message": "Consolidate Http codecs with gRPC"}, "afterCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a", "committedDate": "2020-11-23T15:40:52Z", "message": "Consolidate Http codecs with gRPC"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MTY2Mjg5", "url": "https://github.com/apple/servicetalk/pull/1198#pullrequestreview-537166289", "createdAt": "2020-11-24T08:06:20Z", "commit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwODowNjoyMVrOH4wU8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwODo1OTo0NlrOH4yblw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI3NDA5Ng==", "bodyText": "buffer.readableBytes() is int. Can we simplify this to (int) min(buffer.readableBytes(), n)?\nWe should also account for negative n. The original skip method from the superclass does:\nif (n <= 0) {\n    return 0;\n}", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529274096", "createdAt": "2020-11-24T08:06:21Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-encoding-api/src/main/java/io/servicetalk/encoding/api/AbstractZipContentCodec.java", "diffHunk": "@@ -579,4 +580,55 @@ public void write(byte[] b, int off, int len) {\n             buffer.writeBytes(b, off, len);\n         }\n     }\n+\n+    static final class BufferBoundedInputStream extends InputStream {\n+        private final Buffer buffer;\n+        private final int limit;\n+        private int count;\n+\n+        BufferBoundedInputStream(Buffer buffer, int limit) {\n+            this.buffer = requireNonNull(buffer);\n+            this.limit = limit;\n+        }\n+\n+        @Override\n+        public int read() {\n+            if (buffer.readableBytes() == 0) {\n+                return -1;\n+            }\n+            if (++count > limit) {\n+                throw new IndexOutOfBoundsException(\"Buffer limit has been reached: \" +\n+                        count + \" (expected <= \" + limit + \") bytes\");\n+            }\n+            return buffer.readByte() & 0xff;\n+        }\n+\n+        @Override\n+        public int read(byte[] b, int off, int len) {\n+            int readableBytes = buffer.readableBytes();\n+            if (readableBytes == 0) {\n+                return -1;\n+            }\n+            int bytes = min(readableBytes, len);\n+            if (count + bytes > limit) {\n+                throw new IndexOutOfBoundsException(\"Buffer limit has been reached: \" +\n+                        count + \" (expected <= \" + limit + \") bytes\");\n+            }\n+            count += bytes;\n+            buffer.readBytes(b, off, bytes);\n+            return bytes;\n+        }\n+\n+        @Override\n+        public long skip(long n) {\n+            int skipped = min(buffer.readableBytes(), (int) min(Integer.MAX_VALUE, n));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI3NDczMg==", "bodyText": "We should count skipped bytes. Otherwise, we can go over the limit.", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529274732", "createdAt": "2020-11-24T08:07:32Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-encoding-api/src/main/java/io/servicetalk/encoding/api/AbstractZipContentCodec.java", "diffHunk": "@@ -579,4 +580,55 @@ public void write(byte[] b, int off, int len) {\n             buffer.writeBytes(b, off, len);\n         }\n     }\n+\n+    static final class BufferBoundedInputStream extends InputStream {\n+        private final Buffer buffer;\n+        private final int limit;\n+        private int count;\n+\n+        BufferBoundedInputStream(Buffer buffer, int limit) {\n+            this.buffer = requireNonNull(buffer);\n+            this.limit = limit;\n+        }\n+\n+        @Override\n+        public int read() {\n+            if (buffer.readableBytes() == 0) {\n+                return -1;\n+            }\n+            if (++count > limit) {\n+                throw new IndexOutOfBoundsException(\"Buffer limit has been reached: \" +\n+                        count + \" (expected <= \" + limit + \") bytes\");\n+            }\n+            return buffer.readByte() & 0xff;\n+        }\n+\n+        @Override\n+        public int read(byte[] b, int off, int len) {\n+            int readableBytes = buffer.readableBytes();\n+            if (readableBytes == 0) {\n+                return -1;\n+            }\n+            int bytes = min(readableBytes, len);\n+            if (count + bytes > limit) {\n+                throw new IndexOutOfBoundsException(\"Buffer limit has been reached: \" +\n+                        count + \" (expected <= \" + limit + \") bytes\");\n+            }\n+            count += bytes;\n+            buffer.readBytes(b, off, bytes);\n+            return bytes;\n+        }\n+\n+        @Override\n+        public long skip(long n) {\n+            int skipped = min(buffer.readableBytes(), (int) min(Integer.MAX_VALUE, n));\n+            buffer.skipBytes(skipped);\n+            return skipped;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI3NzQ0MA==", "bodyText": "We should verify that len is not negative. buffer.readBytes will do the check but it will be too late, because you do count += bytes before that and bytes can be negative.", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529277440", "createdAt": "2020-11-24T08:12:11Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-encoding-api/src/main/java/io/servicetalk/encoding/api/AbstractZipContentCodec.java", "diffHunk": "@@ -579,4 +580,55 @@ public void write(byte[] b, int off, int len) {\n             buffer.writeBytes(b, off, len);\n         }\n     }\n+\n+    static final class BufferBoundedInputStream extends InputStream {\n+        private final Buffer buffer;\n+        private final int limit;\n+        private int count;\n+\n+        BufferBoundedInputStream(Buffer buffer, int limit) {\n+            this.buffer = requireNonNull(buffer);\n+            this.limit = limit;\n+        }\n+\n+        @Override\n+        public int read() {\n+            if (buffer.readableBytes() == 0) {\n+                return -1;\n+            }\n+            if (++count > limit) {\n+                throw new IndexOutOfBoundsException(\"Buffer limit has been reached: \" +\n+                        count + \" (expected <= \" + limit + \") bytes\");\n+            }\n+            return buffer.readByte() & 0xff;\n+        }\n+\n+        @Override\n+        public int read(byte[] b, int off, int len) {\n+            int readableBytes = buffer.readableBytes();\n+            if (readableBytes == 0) {\n+                return -1;\n+            }\n+            int bytes = min(readableBytes, len);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI3OTcyNQ==", "bodyText": "Discussed offline and confirmed that we actually need the variant with length for gRPC because the received Buffer may contain more data that we want to encode/decode. In this case, the offset, limit is more standard API approach. Can you please reverth the offset? Sorry for back and forth.", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529279725", "createdAt": "2020-11-24T08:16:22Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-encoding-api/src/main/java/io/servicetalk/encoding/api/ContentCodec.java", "diffHunk": "@@ -41,19 +41,18 @@\n      * @return {@link Buffer} the result buffer with the content encoded\n      */\n     default Buffer encode(Buffer src, BufferAllocator allocator) {\n-        return encode(src, src.readerIndex(), src.readableBytes(), allocator);\n+        return encode(src, src.readableBytes(), allocator);\n     }\n \n     /**\n      * Take a {@link Buffer} and encode its contents resulting in a {@link Buffer} with the encoded contents.\n      *\n      * @param src the {@link Buffer} to encode\n-     * @param offset the offset of the source to start reading from\n      * @param length the total length available for reading\n      * @param allocator the {@link BufferAllocator} to use for allocating auxiliary buffers or the returned buffer\n      * @return {@link Buffer} the result buffer with the content encoded\n      */\n-    Buffer encode(Buffer src, int offset, int length, BufferAllocator allocator);\n+    Buffer encode(Buffer src, int length, BufferAllocator allocator);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI4Mjg3NQ==", "bodyText": "It can be private", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529282875", "createdAt": "2020-11-24T08:21:39Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/DefaultGrpcServiceContext.java", "diffHunk": "@@ -16,33 +16,36 @@\n package io.servicetalk.grpc.api;\n \n import io.servicetalk.concurrent.api.Completable;\n+import io.servicetalk.encoding.api.ContentCodec;\n import io.servicetalk.http.api.HttpConnectionContext.HttpProtocol;\n import io.servicetalk.http.api.HttpServiceContext;\n import io.servicetalk.transport.api.ConnectionContext;\n \n import java.net.SocketAddress;\n import java.net.SocketOption;\n-import java.util.Set;\n+import java.util.ArrayList;\n+import java.util.List;\n import javax.annotation.Nullable;\n import javax.net.ssl.SSLSession;\n \n-import static java.util.Collections.unmodifiableSet;\n+import static java.util.Collections.unmodifiableList;\n import static java.util.Objects.requireNonNull;\n \n final class DefaultGrpcServiceContext extends DefaultGrpcMetadata implements GrpcServiceContext {\n \n     private final ConnectionContext connectionContext;\n     private final GrpcExecutionContext executionContext;\n     private final GrpcProtocol protocol;\n-    final Set<GrpcMessageEncoding> supportedEncodings;\n+\n+    final List<ContentCodec> supportedMessageCodings;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI4NDM1Nw==", "bodyText": "It's not a set anymore. Consider avoiding a collection name. {@link ContentCodec} codings available ... should be enough.", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529284357", "createdAt": "2020-11-24T08:24:00Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcServiceContext.java", "diffHunk": "@@ -32,13 +33,13 @@\n     GrpcProtocol protocol();\n \n     /**\n-     * The set of {@link GrpcMessageEncoding} encoding used for this\n+     * The set of {@link ContentCodec} codings available for this", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI4NDQ4Mg==", "bodyText": "same", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529284482", "createdAt": "2020-11-24T08:24:14Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcServiceContext.java", "diffHunk": "@@ -32,13 +33,13 @@\n     GrpcProtocol protocol();\n \n     /**\n-     * The set of {@link GrpcMessageEncoding} encoding used for this\n+     * The set of {@link ContentCodec} codings available for this\n      * <a href=\"https://www.grpc.io\">gRPC</a> call.\n      *\n-     * @return the set of {@link GrpcMessageEncoding} encoding used for this\n+     * @return the set of {@link ContentCodec} codings available for this", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI4NTcyMQ==", "bodyText": "Consider avoiding clarifying a type of the collection", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529285721", "createdAt": "2020-11-24T08:26:12Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcClientFactory.java", "diffHunk": "@@ -107,23 +110,23 @@ final BlockingClient newBlockingClientForCallFactory(GrpcClientCallFactory clien\n \n     /**\n      * Sets the supported message encodings for this client factory.\n-     * By default only {@link GrpcMessageEncodings#identity()} is supported\n+     * By default only {@link io.servicetalk.encoding.api.ContentCodings#identity()} is supported\n      *\n-     * @param supportedEncodings {@link GrpcMessageEncoding} supported encodings for this client.\n+     * @param codings {@link ContentCodec} supported encodings for this client.\n      * @return {@code this}\n      */\n     public GrpcClientFactory<Client, BlockingClient, Filter, FilterableClient, FilterFactory>\n-    supportedEncodings(final Set<GrpcMessageEncoding> supportedEncodings) {\n-        this.supportedEncodings = unmodifiableSet(supportedEncodings);\n+    supportedMessageCodings(List<ContentCodec> codings) {\n+        this.supportedCodings = unmodifiableList(new ArrayList<>(codings));\n         return this;\n     }\n \n     /**\n-     * Return the list of supported {@link GrpcMessageEncoding}s for this client factory.\n-     * @return the list of supported {@link GrpcMessageEncoding}s for this client factory\n+     * Return the list of supported {@link ContentCodec}s for this client factory.\n+     * @return the list of supported {@link ContentCodec}s for this client factory", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI4Njg4MA==", "bodyText": "Consider saying that without mentioning the type of the collection: supported {@link ContentCodec}s ....\nFor the first line and @return tag.", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529286880", "createdAt": "2020-11-24T08:27:54Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcSerializationProvider.java", "diffHunk": "@@ -15,36 +15,43 @@\n  */\n package io.servicetalk.grpc.api;\n \n+import io.servicetalk.encoding.api.ContentCodec;\n import io.servicetalk.http.api.HttpDeserializer;\n import io.servicetalk.http.api.HttpSerializer;\n \n-import java.util.Set;\n+import java.util.List;\n \n /**\n  * A provider for <a href=\"https://www.grpc.io\">gRPC</a> serialization/deserialization.\n  */\n public interface GrpcSerializationProvider {\n \n-    Set<GrpcMessageEncoding> supportedEncodings();\n+    /**\n+     * List of supported {@link ContentCodec}s for this {@link GrpcSerializationProvider}.\n+     * Content codings will be used to encoded and decode gRPC messages according to configuration of client and server.\n+     *\n+     * @return list of supported {@link ContentCodec}s for this {@link GrpcSerializationProvider}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI5MTc3Ng==", "bodyText": "Should we allocate a new ArrayList with allowedCodings.size() as an initial capacity?", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529291776", "createdAt": "2020-11-24T08:35:44Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -241,34 +247,33 @@ private static void ensureGrpcStatusReceived(final HttpHeaders headers) {\n         }\n     }\n \n-    static GrpcMessageEncoding readGrpcMessageEncoding(final HttpMetaData httpMetaData,\n-                                                       final Set<GrpcMessageEncoding> allowedEncodings) {\n+    static ContentCodec readGrpcMessageEncoding(final HttpMetaData httpMetaData,\n+                                                final List<ContentCodec> allowedEncodings) {\n         final CharSequence encoding = httpMetaData.headers().get(GRPC_MESSAGE_ENCODING_KEY);\n         if (encoding == null) {\n             return identity();\n         }\n \n-        GrpcMessageEncoding enc = encodingFor(allowedEncodings, encoding.toString());\n+        ContentCodec enc = encodingFor(allowedEncodings, encoding);\n         if (enc == null) {\n-            final String lowercaseEncoding = encoding.toString().toLowerCase();\n-            throw new MessageEncodingException(lowercaseEncoding);\n+            throw new MessageEncodingException(encoding.toString());\n         }\n \n         return enc;\n     }\n \n-    static Set<GrpcMessageEncoding> readGrpcAcceptMessageEncoding(final HttpMetaData httpMetaData,\n-                                                                  final Set<GrpcMessageEncoding> acceptedEncodings) {\n+    static List<ContentCodec> readGrpcAcceptMessageEncoding(final HttpMetaData httpMetaData,\n+                                                            final List<ContentCodec> allowedCodings) {\n         final CharSequence acceptEncodingsHeaderVal = httpMetaData.headers().get(GRPC_ACCEPT_ENCODING_KEY);\n \n         if (acceptEncodingsHeaderVal == null || acceptEncodingsHeaderVal.length() == 0) {\n             return GRPC_ACCEPT_ENCODING_NONE;\n         }\n \n-        Set<GrpcMessageEncoding> knownEncodings = new HashSet<>();\n+        List<ContentCodec> knownEncodings = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI5MzY4NA==", "bodyText": "IIUC, allowedList is always a non-null object. We can remove this check. Worst case, the for loop below will generate NPE.", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529293684", "createdAt": "2020-11-24T08:38:46Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -315,13 +329,51 @@ static GrpcMessageEncoding firstMatchingEncodingOrNone(final Set<GrpcMessageEnco\n         return identity();\n     }\n \n+    /**\n+     * Returns the {@link ContentCodec} that matches the {@code name} within the {@code allowedList}.\n+     * if {@code name} is {@code null} or empty it results in {@code null} .\n+     * If {@code name} is {@code 'identity'} this will always result in\n+     * {@link ContentCodings#identity()} regardless of its presence in the {@code allowedList}.\n+     *\n+     * @param allowedList the source list to find a matching codec from.\n+     * @param name the codec name used for the equality predicate.\n+     * @return a codec from the allowed-list that name matches the {@code name}.\n+     */\n+    @Nullable\n+    static ContentCodec encodingFor(final Collection<ContentCodec> allowedList,\n+                                    @Nullable final CharSequence name) {\n+        requireNonNull(allowedList);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 206}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMwMDk1OA==", "bodyText": "Here and in all other places where you use negotiateAcceptedEncoding: it can return null and Intellij IDEA complains that you later use serializationProvider.serializerFor(responseEncoding, ...) because serizlizerFor does not expect null here.", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529300958", "createdAt": "2020-11-24T08:50:09Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java", "diffHunk": "@@ -313,17 +314,17 @@ public Completable closeAsyncGracefully() {\n                     public Single<StreamingHttpResponse> handle(final HttpServiceContext ctx,\n                                                                 final StreamingHttpRequest request,\n                                                                 final StreamingHttpResponseFactory responseFactory) {\n-                        GrpcMessageEncoding responseEncoding;\n+                        ContentCodec responseEncoding;\n                         GrpcServiceContext serviceContext = null;\n \n                         try {\n-                            final Set<GrpcMessageEncoding> supportedEncodings =\n-                                    serializationProvider.supportedEncodings();\n-                            responseEncoding = firstMatchingEncodingOrNone(request, supportedEncodings);\n-                            serviceContext = new DefaultGrpcServiceContext(request.path(), ctx, supportedEncodings);\n+                            final List<ContentCodec> supportedCodings =\n+                                    serializationProvider.supportedMessageCodings();\n+                            responseEncoding = negotiateAcceptedEncoding(request, supportedCodings);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMwMTk0NA==", "bodyText": "This method never returns null", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529301944", "createdAt": "2020-11-24T08:51:42Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -277,36 +282,45 @@ static GrpcMessageEncoding readGrpcMessageEncoding(final HttpMetaData httpMetaDa\n         return knownEncodings;\n     }\n \n-    static GrpcMessageEncoding firstMatchingEncodingOrNone(final HttpMetaData httpMetaData,\n-                                                           final Set<GrpcMessageEncoding> serverSupportedEncodings) {\n-        // Fast path, server has no encodings configured or has only None configured as encoding\n-        if (serverSupportedEncodings.isEmpty() ||\n-                (serverSupportedEncodings.size() == 1 && serverSupportedEncodings.contains(identity()))) {\n+    /**\n+     * Establish a commonly accepted encoding between server and client, according to the supported-codings\n+     * on the server side and the {@code 'Accepted-Encoding'} incoming header on the request.\n+     * <p>\n+     * If no supported codings are configured then the result is always {@code identity}\n+     * If no accepted codings are present in the request then the result is always {@code identity}\n+     * In all other cases, the first matching encoding (that is NOT {@link ContentCodings#identity()}) is preferred,\n+     * otherwise {@code identity} is returned.\n+     *\n+     * @param httpMetaData The client metadata to extract relevant headers from.\n+     * @param allowedCodings The server supported codings as configured.\n+     * @return The {@link ContentCodec} that satisfies both client and server needs, identity otherwise.\n+     */\n+    @Nullable\n+    static ContentCodec negotiateAcceptedEncoding(\n+            final HttpMetaData httpMetaData,\n+            final List<ContentCodec> allowedCodings) {\n+\n+        // Fast path, server has no codings configured or has only identity configured as encoding\n+        if (allowedCodings.isEmpty() ||\n+                (allowedCodings.size() == 1 && allowedCodings.contains(identity()))) {\n             return identity();\n         }\n \n-        Set<GrpcMessageEncoding> clientSupportedEncodings =\n-                readGrpcAcceptMessageEncoding(httpMetaData, serverSupportedEncodings);\n-        return firstMatchingEncodingOrNone(clientSupportedEncodings, serverSupportedEncodings);\n+        List<ContentCodec> clientSupportedEncodings =\n+                readGrpcAcceptMessageEncoding(httpMetaData, allowedCodings);\n+        return negotiateAcceptedEncoding(clientSupportedEncodings, allowedCodings);\n     }\n \n-    static GrpcMessageEncoding firstMatchingEncodingOrNone(final Set<GrpcMessageEncoding> clientSupportedEncodings,\n-                                                           final Set<GrpcMessageEncoding> serverSupportedEncodings) {\n-        // Fast path, Client has no encodings configured, or has None as the only encoding configured\n+    @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 167}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMwMjAyNA==", "bodyText": "This method never returns null", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529302024", "createdAt": "2020-11-24T08:51:50Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -277,36 +282,45 @@ static GrpcMessageEncoding readGrpcMessageEncoding(final HttpMetaData httpMetaDa\n         return knownEncodings;\n     }\n \n-    static GrpcMessageEncoding firstMatchingEncodingOrNone(final HttpMetaData httpMetaData,\n-                                                           final Set<GrpcMessageEncoding> serverSupportedEncodings) {\n-        // Fast path, server has no encodings configured or has only None configured as encoding\n-        if (serverSupportedEncodings.isEmpty() ||\n-                (serverSupportedEncodings.size() == 1 && serverSupportedEncodings.contains(identity()))) {\n+    /**\n+     * Establish a commonly accepted encoding between server and client, according to the supported-codings\n+     * on the server side and the {@code 'Accepted-Encoding'} incoming header on the request.\n+     * <p>\n+     * If no supported codings are configured then the result is always {@code identity}\n+     * If no accepted codings are present in the request then the result is always {@code identity}\n+     * In all other cases, the first matching encoding (that is NOT {@link ContentCodings#identity()}) is preferred,\n+     * otherwise {@code identity} is returned.\n+     *\n+     * @param httpMetaData The client metadata to extract relevant headers from.\n+     * @param allowedCodings The server supported codings as configured.\n+     * @return The {@link ContentCodec} that satisfies both client and server needs, identity otherwise.\n+     */\n+    @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMwNTg4OQ==", "bodyText": "Consider assigning a new ArrayList<>(supportedCodings). Otherwise, it will modify the existing list which could be already passed to ProtoSerializationProvider ctor. Users can invoke build() multiple times.", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529305889", "createdAt": "2020-11-24T08:57:24Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-protobuf/src/main/java/io/servicetalk/grpc/protobuf/ProtoBufSerializationProviderBuilder.java", "diffHunk": "@@ -57,25 +56,27 @@\n     private static final CharSequence GRPC_MESSAGE_ENCODING_KEY = newAsciiString(\"grpc-encoding\");\n     private static final CharSequence APPLICATION_GRPC_PROTO = newAsciiString(\"application/grpc+proto\");\n \n-    private final Map<Class, Map<GrpcMessageEncoding, HttpSerializer>> serializers = new HashMap<>();\n-    private final Map<Class, Map<GrpcMessageEncoding, HttpDeserializer>> deserializers = new HashMap<>();\n+    private final Map<Class, Map<ContentCodec, HttpSerializer>> serializers = new HashMap<>();\n+    private final Map<Class, Map<ContentCodec, HttpDeserializer>> deserializers = new HashMap<>();\n \n-    private final Set<GrpcMessageEncoding> supportedEncodings = new HashSet<>(asList(identity()));\n+    private final List<ContentCodec> supportedCodings = new ArrayList<>(singletonList(identity()));\n \n     /**\n      * Set the supported message encodings for the serializers and deserializers.\n      * The encodings will be advertised on the endpoint's headers and also used to validate each encoded message\n-     * {@link GrpcMessageEncodings#identity()} is always supported regardless of the config passed\n+     * {@link io.servicetalk.encoding.api.ContentCodings#identity()} is always supported regardless of the config passed\n      *\n-     * @param supportedEncodings the set of allowed encodings\n+     * @param supportedCodings the set of allowed encodings\n      * @param <T> Type of {@link MessageLite} to register.\n      * @return {@code this}\n      */\n     public <T extends MessageLite> ProtoBufSerializationProviderBuilder\n-    supportedMessageEncodings(final Set<GrpcMessageEncoding> supportedEncodings) {\n-        this.supportedEncodings.clear();\n-        this.supportedEncodings.addAll(supportedEncodings);\n-        this.supportedEncodings.add(identity()); // Always supported\n+    supportedMessageCodings(final List<ContentCodec> supportedCodings) {\n+        this.supportedCodings.clear();\n+        this.supportedCodings.addAll(supportedCodings);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMwNjU5NQ==", "bodyText": "Then we don't need new ArrayList here.", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529306595", "createdAt": "2020-11-24T08:58:19Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-protobuf/src/main/java/io/servicetalk/grpc/protobuf/ProtoBufSerializationProviderBuilder.java", "diffHunk": "@@ -57,25 +56,27 @@\n     private static final CharSequence GRPC_MESSAGE_ENCODING_KEY = newAsciiString(\"grpc-encoding\");\n     private static final CharSequence APPLICATION_GRPC_PROTO = newAsciiString(\"application/grpc+proto\");\n \n-    private final Map<Class, Map<GrpcMessageEncoding, HttpSerializer>> serializers = new HashMap<>();\n-    private final Map<Class, Map<GrpcMessageEncoding, HttpDeserializer>> deserializers = new HashMap<>();\n+    private final Map<Class, Map<ContentCodec, HttpSerializer>> serializers = new HashMap<>();\n+    private final Map<Class, Map<ContentCodec, HttpDeserializer>> deserializers = new HashMap<>();\n \n-    private final Set<GrpcMessageEncoding> supportedEncodings = new HashSet<>(asList(identity()));\n+    private final List<ContentCodec> supportedCodings = new ArrayList<>(singletonList(identity()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMwODU2Nw==", "bodyText": "supportedCodings can be configured after registerMessageType. As the result, both maps will be incorrect.", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r529308567", "createdAt": "2020-11-24T08:59:46Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-protobuf/src/main/java/io/servicetalk/grpc/protobuf/ProtoBufSerializationProviderBuilder.java", "diffHunk": "@@ -89,14 +90,14 @@\n      */\n     public <T extends MessageLite> ProtoBufSerializationProviderBuilder\n     registerMessageType(Class<T> messageType, Parser<T> parser) {\n-        Map<GrpcMessageEncoding, HttpSerializer> serializersForType = new HashMap<>();\n-        Map<GrpcMessageEncoding, HttpDeserializer> deserializersForType = new HashMap<>();\n-        for (GrpcMessageEncoding grpcMessageEncoding : supportedEncodings) {\n+        Map<ContentCodec, HttpSerializer> serializersForType = new HashMap<>();\n+        Map<ContentCodec, HttpDeserializer> deserializersForType = new HashMap<>();\n+        for (ContentCodec codec : supportedCodings) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 79}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "257b5451a686c488c2753153b553c17a1c2b6fdb", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/257b5451a686c488c2753153b553c17a1c2b6fdb", "committedDate": "2020-11-25T00:04:22Z", "message": "Fix comments & other improvements"}, "afterCommit": {"oid": "c49ceb4060d64b854db56753e5e1383515578b60", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/c49ceb4060d64b854db56753e5e1383515578b60", "committedDate": "2020-11-25T16:05:41Z", "message": "Fix comments & other improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad3c67e938f58c328a04244978ccba8ca26730f6", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/ad3c67e938f58c328a04244978ccba8ca26730f6", "committedDate": "2020-11-25T17:13:08Z", "message": "Fix comments & other improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c49ceb4060d64b854db56753e5e1383515578b60", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/c49ceb4060d64b854db56753e5e1383515578b60", "committedDate": "2020-11-25T16:05:41Z", "message": "Fix comments & other improvements"}, "afterCommit": {"oid": "ad3c67e938f58c328a04244978ccba8ca26730f6", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/ad3c67e938f58c328a04244978ccba8ca26730f6", "committedDate": "2020-11-25T17:13:08Z", "message": "Fix comments & other improvements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMjk4NjA3", "url": "https://github.com/apple/servicetalk/pull/1198#pullrequestreview-541298607", "createdAt": "2020-11-30T21:12:55Z", "commit": {"oid": "ad3c67e938f58c328a04244978ccba8ca26730f6"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMToxMjo1NlrOH8OCxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMjowNDoxMlrOH8VOuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkwNjY5NA==", "bodyText": "We should not override the year, we can append or change a region. Examples:\n2018 -> 2018, 2020\n2019 -> 2019-2020\n2018-2019 -> 2018-2020", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r532906694", "createdAt": "2020-11-30T21:12:56Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-buffer-api/src/main/java/io/servicetalk/buffer/api/BufferInputStream.java", "diffHunk": "@@ -1,5 +1,5 @@\n /*\n- * Copyright \u00a9 2018 Apple Inc. and the ServiceTalk project authors\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad3c67e938f58c328a04244978ccba8ca26730f6"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwNjk4NA==", "bodyText": "Good catch to make both paths consistent \ud83c\udf96\ufe0f", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r533006984", "createdAt": "2020-12-01T01:10:13Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-encoding-api/src/main/java/io/servicetalk/encoding/api/AbstractZipContentCodec.java", "diffHunk": "@@ -64,28 +64,29 @@\n     abstract InflaterInputStream newInflaterInputStream(InputStream in) throws IOException;\n \n     @Override\n-    public final Buffer encode(final Buffer src, final int length,\n-                               final BufferAllocator allocator) {\n+    public final Buffer encode(final Buffer src, final int length, final BufferAllocator allocator) {\n         final Buffer dst = allocator.newBuffer(chunkSize);\n         DeflaterOutputStream output = null;\n         try {\n             output = newDeflaterOutputStream(Buffer.asOutputStream(dst));\n \n             if (src.hasArray()) {\n                 output.write(src.array(), src.arrayOffset() + src.readerIndex(), length);\n+                src.readerIndex(src.readerIndex() + length);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad3c67e938f58c328a04244978ccba8ca26730f6"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwNzY5Mg==", "bodyText": "Here and in all other places: consider using logger API to build a String instead of concatenating manually:\nLOGGER.error(\"Error while decoding with {}\", name(), e);", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r533007692", "createdAt": "2020-12-01T01:12:26Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-encoding-api/src/main/java/io/servicetalk/encoding/api/AbstractZipContentCodec.java", "diffHunk": "@@ -246,6 +262,7 @@ public void onNext(@Nullable final Buffer src) {\n                     // Not enough data to decompress, ask for more\n                     subscription.request(1);\n                 } catch (Exception e) {\n+                    LOGGER.error(\"Error while decoding with \" + name(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad3c67e938f58c328a04244978ccba8ca26730f6"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAxOTM2Mg==", "bodyText": "You don't need to cast the input, min(buffer.readableBytes(), n) will cast readableBytes to long. Because readableBytes is int, it can not be more than Integer.MAX_VALUE. Then the long result of the min function can safely be cast back to int: (int) min(buffer.readableBytes(), n).", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r533019362", "createdAt": "2020-12-01T01:48:32Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-encoding-api/src/main/java/io/servicetalk/encoding/api/AbstractZipContentCodec.java", "diffHunk": "@@ -579,4 +580,55 @@ public void write(byte[] b, int off, int len) {\n             buffer.writeBytes(b, off, len);\n         }\n     }\n+\n+    static final class BufferBoundedInputStream extends InputStream {\n+        private final Buffer buffer;\n+        private final int limit;\n+        private int count;\n+\n+        BufferBoundedInputStream(Buffer buffer, int limit) {\n+            this.buffer = requireNonNull(buffer);\n+            this.limit = limit;\n+        }\n+\n+        @Override\n+        public int read() {\n+            if (buffer.readableBytes() == 0) {\n+                return -1;\n+            }\n+            if (++count > limit) {\n+                throw new IndexOutOfBoundsException(\"Buffer limit has been reached: \" +\n+                        count + \" (expected <= \" + limit + \") bytes\");\n+            }\n+            return buffer.readByte() & 0xff;\n+        }\n+\n+        @Override\n+        public int read(byte[] b, int off, int len) {\n+            int readableBytes = buffer.readableBytes();\n+            if (readableBytes == 0) {\n+                return -1;\n+            }\n+            int bytes = min(readableBytes, len);\n+            if (count + bytes > limit) {\n+                throw new IndexOutOfBoundsException(\"Buffer limit has been reached: \" +\n+                        count + \" (expected <= \" + limit + \") bytes\");\n+            }\n+            count += bytes;\n+            buffer.readBytes(b, off, bytes);\n+            return bytes;\n+        }\n+\n+        @Override\n+        public long skip(long n) {\n+            int skipped = min(buffer.readableBytes(), (int) min(Integer.MAX_VALUE, n));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI3NDA5Ng=="}, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyMDQ2MQ==", "bodyText": "Let's defer adding these details in javadoc?", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r533020461", "createdAt": "2020-12-01T01:51:51Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-encoding-api/src/main/java/io/servicetalk/encoding/api/ContentCodec.java", "diffHunk": "@@ -67,6 +72,7 @@ default Buffer decode(Buffer src, BufferAllocator allocator) {\n \n     /**\n      * Take a {@link Buffer} and decode its contents resulting in a {@link Buffer} with the decoded content.\n+     * This call increases the {@code readerIndex} of the {@code src} with the number of bytes read {@code length}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad3c67e938f58c328a04244978ccba8ca26730f6"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyNDIyNQ==", "bodyText": "Good point. Let's discuss offline what should be the default behavior of all codecs and deserializers. We are currently inconsistent. If we will decide to move indexes everywhere, then having only length here is reasonable. If we decide not to move indexes, then offset may be important.", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r533024225", "createdAt": "2020-12-01T02:03:24Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-encoding-api/src/main/java/io/servicetalk/encoding/api/ContentCodec.java", "diffHunk": "@@ -41,19 +41,18 @@\n      * @return {@link Buffer} the result buffer with the content encoded\n      */\n     default Buffer encode(Buffer src, BufferAllocator allocator) {\n-        return encode(src, src.readerIndex(), src.readableBytes(), allocator);\n+        return encode(src, src.readableBytes(), allocator);\n     }\n \n     /**\n      * Take a {@link Buffer} and encode its contents resulting in a {@link Buffer} with the encoded contents.\n      *\n      * @param src the {@link Buffer} to encode\n-     * @param offset the offset of the source to start reading from\n      * @param length the total length available for reading\n      * @param allocator the {@link BufferAllocator} to use for allocating auxiliary buffers or the returned buffer\n      * @return {@link Buffer} the result buffer with the content encoded\n      */\n-    Buffer encode(Buffer src, int offset, int length, BufferAllocator allocator);\n+    Buffer encode(Buffer src, int length, BufferAllocator allocator);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI3OTcyNQ=="}, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyNDQ0MQ==", "bodyText": "This is not fixed, reminder :)", "url": "https://github.com/apple/servicetalk/pull/1198#discussion_r533024441", "createdAt": "2020-12-01T02:04:12Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcSerializationProvider.java", "diffHunk": "@@ -15,36 +15,43 @@\n  */\n package io.servicetalk.grpc.api;\n \n+import io.servicetalk.encoding.api.ContentCodec;\n import io.servicetalk.http.api.HttpDeserializer;\n import io.servicetalk.http.api.HttpSerializer;\n \n-import java.util.Set;\n+import java.util.List;\n \n /**\n  * A provider for <a href=\"https://www.grpc.io\">gRPC</a> serialization/deserialization.\n  */\n public interface GrpcSerializationProvider {\n \n-    Set<GrpcMessageEncoding> supportedEncodings();\n+    /**\n+     * List of supported {@link ContentCodec}s for this {@link GrpcSerializationProvider}.\n+     * Content codings will be used to encoded and decode gRPC messages according to configuration of client and server.\n+     *\n+     * @return list of supported {@link ContentCodec}s for this {@link GrpcSerializationProvider}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI4Njg4MA=="}, "originalCommit": {"oid": "c50b348928dbb6bd4ee0eff1e0a53939a7ddbe4a"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94081bed3877f26bc0915349285fd08d5da16189", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/94081bed3877f26bc0915349285fd08d5da16189", "committedDate": "2020-12-03T23:29:24Z", "message": "Comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3537, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}