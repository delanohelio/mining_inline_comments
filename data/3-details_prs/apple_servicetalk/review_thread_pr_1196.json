{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MDQ5NzM0", "number": 1196, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzo0MDozN1rOE1BUpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMDoyMTo0N1rOE1Bz1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MDMxNjU0OnYy", "diffSide": "RIGHT", "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/DefaultHttpRequestMetaData.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzo0MDozN1rOHtEUqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzo0MDozN1rOHtEUqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAxODc5NQ==", "bodyText": "the null check and method name setQueryParams -> query are the only changes in this method.", "url": "https://github.com/apple/servicetalk/pull/1196#discussion_r517018795", "createdAt": "2020-11-03T23:40:37Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/DefaultHttpRequestMetaData.java", "diffHunk": "@@ -356,6 +366,79 @@ private Uri lazyParseRequestTarget() {\n         return requestTargetUri;\n     }\n \n+    private void query(final Map<String, List<String>> params) {\n+        Uri httpUri = lazyParseRequestTarget();\n+        StringBuilder sb = new StringBuilder(httpUri.uri().length() + params.size() * 8);\n+\n+        appendScheme(sb, httpUri);\n+        appendAuthority(sb, httpUri);\n+        sb.append(httpUri.path());\n+\n+        // Append query params\n+        Iterator<Entry<String, List<String>>> itr = params.entrySet().iterator();\n+        char prefixChar = '?';\n+        while (itr.hasNext()) {\n+            Entry<String, List<String>> next = itr.next();\n+            String encodedKey = encodeComponent(QUERY, next.getKey(), REQUEST_TARGET_CHARSET, true);\n+            sb.append(prefixChar).append(encodedKey);\n+            List<String> values = next.getValue();\n+            if (values != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a27d8b30107e3f455b80816d825b9c3de36dc6cc"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MDM0NzYzOnYy", "diffSide": "RIGHT", "path": "servicetalk-benchmarks/src/jmh/java/io/servicetalk/http/api/QueryStringEncodingBenchmark.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzo1NjozN1rOHtEnIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxOTozMzo1MFrOHtmzLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyMzUyMQ==", "bodyText": "uri is always an empty string, can we remove it?\nthe query is always a non-null", "url": "https://github.com/apple/servicetalk/pull/1196#discussion_r517023521", "createdAt": "2020-11-03T23:56:37Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-benchmarks/src/jmh/java/io/servicetalk/http/api/QueryStringEncodingBenchmark.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.http.api;\n+\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.BenchmarkMode;\n+import org.openjdk.jmh.annotations.Fork;\n+import org.openjdk.jmh.annotations.Level;\n+import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Mode;\n+import org.openjdk.jmh.annotations.Param;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+import org.openjdk.jmh.annotations.Warmup;\n+\n+import java.io.UnsupportedEncodingException;\n+import java.net.URLEncoder;\n+import javax.annotation.Nullable;\n+\n+import static io.servicetalk.http.api.HttpProtocolVersion.HTTP_1_1;\n+import static io.servicetalk.http.api.HttpRequestMethod.GET;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+@Fork(value = 1)\n+@State(Scope.Benchmark)\n+@Warmup(iterations = 5, time = 5)\n+@Measurement(iterations = 5, time = 5)\n+@BenchmarkMode(Mode.Throughput)\n+public class QueryStringEncodingBenchmark {\n+    private String value;\n+    @Param({\"100\", \"1000\", \"10000\"})\n+    private int length;\n+    @Param({\"false\", \"true\"})\n+    private boolean needsEncoding;\n+    private DefaultHttpRequestMetaData stMetaData;\n+    private final HttpHeaders headers = new DefaultHttpHeadersFactory(false, false).newHeaders();\n+\n+    @Setup(Level.Trial)\n+    public void setup() {\n+        StringBuilder sb = new StringBuilder(length);\n+        if (needsEncoding) {\n+            final int halfLength = length >>> 1;\n+            int i = 0;\n+            for (; i < halfLength; ++i) {\n+                sb.append('a');\n+            }\n+            sb.append(' ');\n+            for (; i < length; ++i) {\n+                sb.append('b');\n+            }\n+        } else {\n+            for (int i = 0; i < length; ++i) {\n+                sb.append('a');\n+            }\n+        }\n+        value = sb.toString();\n+        stMetaData = new DefaultHttpRequestMetaData(GET, \"\", HTTP_1_1, headers);\n+    }\n+\n+    @Benchmark\n+    public HttpRequestMetaData stEncoding() {\n+        return stMetaData.query(value);\n+    }\n+\n+    @Benchmark\n+    public String jdkURLEncoder() throws UnsupportedEncodingException {\n+        return jdkBuildURL(\"\", URLEncoder.encode(value, UTF_8.name()));\n+    }\n+\n+    private static String jdkBuildURL(final String uri, @Nullable String query) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "256e4462feaebc491c21f7d9859fbf791808f8a0"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU4MzY2MQ==", "bodyText": "this code is meant to replicate the copying done in DefaultHttpRequestMetaData which would be required to apply the URI. It doesn't include all the components (e.g. scheme, host, etc.) but the goal is to keep them similar and representative of what needs to be done in either case (e.g. build the URI as a single String).", "url": "https://github.com/apple/servicetalk/pull/1196#discussion_r517583661", "createdAt": "2020-11-04T19:33:50Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-benchmarks/src/jmh/java/io/servicetalk/http/api/QueryStringEncodingBenchmark.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.http.api;\n+\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.BenchmarkMode;\n+import org.openjdk.jmh.annotations.Fork;\n+import org.openjdk.jmh.annotations.Level;\n+import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Mode;\n+import org.openjdk.jmh.annotations.Param;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+import org.openjdk.jmh.annotations.Warmup;\n+\n+import java.io.UnsupportedEncodingException;\n+import java.net.URLEncoder;\n+import javax.annotation.Nullable;\n+\n+import static io.servicetalk.http.api.HttpProtocolVersion.HTTP_1_1;\n+import static io.servicetalk.http.api.HttpRequestMethod.GET;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+@Fork(value = 1)\n+@State(Scope.Benchmark)\n+@Warmup(iterations = 5, time = 5)\n+@Measurement(iterations = 5, time = 5)\n+@BenchmarkMode(Mode.Throughput)\n+public class QueryStringEncodingBenchmark {\n+    private String value;\n+    @Param({\"100\", \"1000\", \"10000\"})\n+    private int length;\n+    @Param({\"false\", \"true\"})\n+    private boolean needsEncoding;\n+    private DefaultHttpRequestMetaData stMetaData;\n+    private final HttpHeaders headers = new DefaultHttpHeadersFactory(false, false).newHeaders();\n+\n+    @Setup(Level.Trial)\n+    public void setup() {\n+        StringBuilder sb = new StringBuilder(length);\n+        if (needsEncoding) {\n+            final int halfLength = length >>> 1;\n+            int i = 0;\n+            for (; i < halfLength; ++i) {\n+                sb.append('a');\n+            }\n+            sb.append(' ');\n+            for (; i < length; ++i) {\n+                sb.append('b');\n+            }\n+        } else {\n+            for (int i = 0; i < length; ++i) {\n+                sb.append('a');\n+            }\n+        }\n+        value = sb.toString();\n+        stMetaData = new DefaultHttpRequestMetaData(GET, \"\", HTTP_1_1, headers);\n+    }\n+\n+    @Benchmark\n+    public HttpRequestMetaData stEncoding() {\n+        return stMetaData.query(value);\n+    }\n+\n+    @Benchmark\n+    public String jdkURLEncoder() throws UnsupportedEncodingException {\n+        return jdkBuildURL(\"\", URLEncoder.encode(value, UTF_8.name()));\n+    }\n+\n+    private static String jdkBuildURL(final String uri, @Nullable String query) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyMzUyMQ=="}, "originalCommit": {"oid": "256e4462feaebc491c21f7d9859fbf791808f8a0"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MDM0OTc2OnYy", "diffSide": "RIGHT", "path": "servicetalk-benchmarks/src/jmh/java/io/servicetalk/http/api/QueryStringEncodingBenchmark.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzo1Nzo0MlrOHtEoXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxOTozMzo1OFrOHtmzcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyMzgzOA==", "bodyText": "The ? will always trigger resize of the internal array, which is impacting numbers", "url": "https://github.com/apple/servicetalk/pull/1196#discussion_r517023838", "createdAt": "2020-11-03T23:57:42Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-benchmarks/src/jmh/java/io/servicetalk/http/api/QueryStringEncodingBenchmark.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.http.api;\n+\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.BenchmarkMode;\n+import org.openjdk.jmh.annotations.Fork;\n+import org.openjdk.jmh.annotations.Level;\n+import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Mode;\n+import org.openjdk.jmh.annotations.Param;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+import org.openjdk.jmh.annotations.Warmup;\n+\n+import java.io.UnsupportedEncodingException;\n+import java.net.URLEncoder;\n+import javax.annotation.Nullable;\n+\n+import static io.servicetalk.http.api.HttpProtocolVersion.HTTP_1_1;\n+import static io.servicetalk.http.api.HttpRequestMethod.GET;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+@Fork(value = 1)\n+@State(Scope.Benchmark)\n+@Warmup(iterations = 5, time = 5)\n+@Measurement(iterations = 5, time = 5)\n+@BenchmarkMode(Mode.Throughput)\n+public class QueryStringEncodingBenchmark {\n+    private String value;\n+    @Param({\"100\", \"1000\", \"10000\"})\n+    private int length;\n+    @Param({\"false\", \"true\"})\n+    private boolean needsEncoding;\n+    private DefaultHttpRequestMetaData stMetaData;\n+    private final HttpHeaders headers = new DefaultHttpHeadersFactory(false, false).newHeaders();\n+\n+    @Setup(Level.Trial)\n+    public void setup() {\n+        StringBuilder sb = new StringBuilder(length);\n+        if (needsEncoding) {\n+            final int halfLength = length >>> 1;\n+            int i = 0;\n+            for (; i < halfLength; ++i) {\n+                sb.append('a');\n+            }\n+            sb.append(' ');\n+            for (; i < length; ++i) {\n+                sb.append('b');\n+            }\n+        } else {\n+            for (int i = 0; i < length; ++i) {\n+                sb.append('a');\n+            }\n+        }\n+        value = sb.toString();\n+        stMetaData = new DefaultHttpRequestMetaData(GET, \"\", HTTP_1_1, headers);\n+    }\n+\n+    @Benchmark\n+    public HttpRequestMetaData stEncoding() {\n+        return stMetaData.query(value);\n+    }\n+\n+    @Benchmark\n+    public String jdkURLEncoder() throws UnsupportedEncodingException {\n+        return jdkBuildURL(\"\", URLEncoder.encode(value, UTF_8.name()));\n+    }\n+\n+    private static String jdkBuildURL(final String uri, @Nullable String query) {\n+        // replicating what is done in DefaultHttpHeadersFactory to build the URI\n+        StringBuilder sb = query != null ? new StringBuilder(uri.length() + query.length()) :", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "256e4462feaebc491c21f7d9859fbf791808f8a0"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU4MzczMA==", "bodyText": "good catch, I'll fix in real code too", "url": "https://github.com/apple/servicetalk/pull/1196#discussion_r517583730", "createdAt": "2020-11-04T19:33:58Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-benchmarks/src/jmh/java/io/servicetalk/http/api/QueryStringEncodingBenchmark.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.http.api;\n+\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.BenchmarkMode;\n+import org.openjdk.jmh.annotations.Fork;\n+import org.openjdk.jmh.annotations.Level;\n+import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Mode;\n+import org.openjdk.jmh.annotations.Param;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+import org.openjdk.jmh.annotations.Warmup;\n+\n+import java.io.UnsupportedEncodingException;\n+import java.net.URLEncoder;\n+import javax.annotation.Nullable;\n+\n+import static io.servicetalk.http.api.HttpProtocolVersion.HTTP_1_1;\n+import static io.servicetalk.http.api.HttpRequestMethod.GET;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+@Fork(value = 1)\n+@State(Scope.Benchmark)\n+@Warmup(iterations = 5, time = 5)\n+@Measurement(iterations = 5, time = 5)\n+@BenchmarkMode(Mode.Throughput)\n+public class QueryStringEncodingBenchmark {\n+    private String value;\n+    @Param({\"100\", \"1000\", \"10000\"})\n+    private int length;\n+    @Param({\"false\", \"true\"})\n+    private boolean needsEncoding;\n+    private DefaultHttpRequestMetaData stMetaData;\n+    private final HttpHeaders headers = new DefaultHttpHeadersFactory(false, false).newHeaders();\n+\n+    @Setup(Level.Trial)\n+    public void setup() {\n+        StringBuilder sb = new StringBuilder(length);\n+        if (needsEncoding) {\n+            final int halfLength = length >>> 1;\n+            int i = 0;\n+            for (; i < halfLength; ++i) {\n+                sb.append('a');\n+            }\n+            sb.append(' ');\n+            for (; i < length; ++i) {\n+                sb.append('b');\n+            }\n+        } else {\n+            for (int i = 0; i < length; ++i) {\n+                sb.append('a');\n+            }\n+        }\n+        value = sb.toString();\n+        stMetaData = new DefaultHttpRequestMetaData(GET, \"\", HTTP_1_1, headers);\n+    }\n+\n+    @Benchmark\n+    public HttpRequestMetaData stEncoding() {\n+        return stMetaData.query(value);\n+    }\n+\n+    @Benchmark\n+    public String jdkURLEncoder() throws UnsupportedEncodingException {\n+        return jdkBuildURL(\"\", URLEncoder.encode(value, UTF_8.name()));\n+    }\n+\n+    private static String jdkBuildURL(final String uri, @Nullable String query) {\n+        // replicating what is done in DefaultHttpHeadersFactory to build the URI\n+        StringBuilder sb = query != null ? new StringBuilder(uri.length() + query.length()) :", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyMzgzOA=="}, "originalCommit": {"oid": "256e4462feaebc491c21f7d9859fbf791808f8a0"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MDM1MTUzOnYy", "diffSide": "RIGHT", "path": "servicetalk-benchmarks/src/jmh/java/io/servicetalk/http/api/QueryStringEncodingBenchmark.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzo1ODo0N1rOHtEphA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzo1ODo0N1rOHtEphA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyNDEzMg==", "bodyText": "Headers are not plain a role in these 2 benchmarks, DefaultHttpHeadersFactory.INSTANCE can be used", "url": "https://github.com/apple/servicetalk/pull/1196#discussion_r517024132", "createdAt": "2020-11-03T23:58:47Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-benchmarks/src/jmh/java/io/servicetalk/http/api/QueryStringEncodingBenchmark.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.http.api;\n+\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.BenchmarkMode;\n+import org.openjdk.jmh.annotations.Fork;\n+import org.openjdk.jmh.annotations.Level;\n+import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Mode;\n+import org.openjdk.jmh.annotations.Param;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+import org.openjdk.jmh.annotations.Warmup;\n+\n+import java.io.UnsupportedEncodingException;\n+import java.net.URLEncoder;\n+import javax.annotation.Nullable;\n+\n+import static io.servicetalk.http.api.HttpProtocolVersion.HTTP_1_1;\n+import static io.servicetalk.http.api.HttpRequestMethod.GET;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+@Fork(value = 1)\n+@State(Scope.Benchmark)\n+@Warmup(iterations = 5, time = 5)\n+@Measurement(iterations = 5, time = 5)\n+@BenchmarkMode(Mode.Throughput)\n+public class QueryStringEncodingBenchmark {\n+    private String value;\n+    @Param({\"100\", \"1000\", \"10000\"})\n+    private int length;\n+    @Param({\"false\", \"true\"})\n+    private boolean needsEncoding;\n+    private DefaultHttpRequestMetaData stMetaData;\n+    private final HttpHeaders headers = new DefaultHttpHeadersFactory(false, false).newHeaders();\n+\n+    @Setup(Level.Trial)\n+    public void setup() {\n+        StringBuilder sb = new StringBuilder(length);\n+        if (needsEncoding) {\n+            final int halfLength = length >>> 1;\n+            int i = 0;\n+            for (; i < halfLength; ++i) {\n+                sb.append('a');\n+            }\n+            sb.append(' ');\n+            for (; i < length; ++i) {\n+                sb.append('b');\n+            }\n+        } else {\n+            for (int i = 0; i < length; ++i) {\n+                sb.append('a');\n+            }\n+        }\n+        value = sb.toString();\n+        stMetaData = new DefaultHttpRequestMetaData(GET, \"\", HTTP_1_1, headers);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "256e4462feaebc491c21f7d9859fbf791808f8a0"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MDM5NjM2OnYy", "diffSide": "RIGHT", "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/HttpQuery.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMDoyMTo0N1rOHtFC-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxOTo0Njo1MFrOHtnOQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAzMDY1MQ==", "bodyText": "Consider using markDirty() everywhere", "url": "https://github.com/apple/servicetalk/pull/1196#discussion_r517030651", "createdAt": "2020-11-04T00:21:47Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/HttpQuery.java", "diffHunk": "@@ -179,7 +162,7 @@ public boolean remove(final String key, final String value) {\n         while (values.hasNext()) {\n             if (value.equals(values.next())) {\n                 values.remove();\n-                updateQueryParams();\n+                dirty = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "256e4462feaebc491c21f7d9859fbf791808f8a0"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU5MDU5Mw==", "bodyText": "done", "url": "https://github.com/apple/servicetalk/pull/1196#discussion_r517590593", "createdAt": "2020-11-04T19:46:50Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/HttpQuery.java", "diffHunk": "@@ -179,7 +162,7 @@ public boolean remove(final String key, final String value) {\n         while (values.hasNext()) {\n             if (value.equals(values.next())) {\n                 values.remove();\n-                updateQueryParams();\n+                dirty = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAzMDY1MQ=="}, "originalCommit": {"oid": "256e4462feaebc491c21f7d9859fbf791808f8a0"}, "originalPosition": 125}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2614, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}