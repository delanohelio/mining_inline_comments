{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4Mzc3NTEz", "number": 1095, "title": "Observability for connection level events", "bodyText": "Motivation:\nUsers should be able to get visibility into connection-level events.\nModifications:\n\nIntroduce new TransportObserver and ConnectionObserver interfaces;\nSupport TransportObserver for client and server side;\nTests to verify new functionality;\n\nResult:\nVisibility into connection-level events.", "createdAt": "2020-07-13T16:59:14Z", "url": "https://github.com/apple/servicetalk/pull/1095", "merged": true, "mergeCommit": {"oid": "9b858cb3185115fb9621f47d69f44e2724176a1e"}, "closed": true, "closedAt": "2020-07-16T01:53:31Z", "author": {"login": "idelpivnitskiy"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0kahrAH2gAyNDQ4Mzc3NTEzOmUyN2Y3YTVmYjc2ZDNiZWY0YjFiMjllM2Y0ZDE5Y2UyOTRjYzViMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1VFIogH2gAyNDQ4Mzc3NTEzOmNlOTZjYjE5ZjIwYTkzNzA4ZDc5ZDVmZGI3MjUzOWRiMTlkOTBhYzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e27f7a5fb76d3bef4b1b29e3f4d19ce294cc5b06", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/e27f7a5fb76d3bef4b1b29e3f4d19ce294cc5b06", "committedDate": "2020-07-13T16:55:42Z", "message": "TransportObserver API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f49706ef02f86c272dc4ec26077d703e9cb2fad", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/0f49706ef02f86c272dc4ec26077d703e9cb2fad", "committedDate": "2020-07-13T16:55:42Z", "message": "Support TransportObserver API for server-side"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ada69342a78b34a4542027cb22fdefdda2877cd1", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/ada69342a78b34a4542027cb22fdefdda2877cd1", "committedDate": "2020-07-13T16:55:42Z", "message": "Test TransportObserver API on the server-side"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d71fc9161148c4ec137e702c215f5b09b12d71ff", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/d71fc9161148c4ec137e702c215f5b09b12d71ff", "committedDate": "2020-07-13T16:55:42Z", "message": "Support TransportObserver API for client-side"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/0c582ed93798eec00efc90f9c15112801b1dc17d", "committedDate": "2020-07-13T16:55:42Z", "message": "Test TransportObserver API for client-side"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NDM0NTcy", "url": "https://github.com/apple/servicetalk/pull/1095#pullrequestreview-447434572", "createdAt": "2020-07-13T17:00:53Z", "commit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzowMDo1NFrOGwxe1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzowMjoxMlrOGwxhvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5NTU0MA==", "bodyText": "Started with the client builder approach for now. Will investigate impact of moving to ConnectionFactory in a follow-up PR.", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453795540", "createdAt": "2020-07-13T17:00:54Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/BaseGrpcClientBuilder.java", "diffHunk": "@@ -73,6 +74,14 @@\n      */\n     BaseGrpcClientBuilder<U, R> enableWireLogging(String loggerName);\n \n+    /**\n+     * Sets a {@link TransportObserver} that provides visibility into transport events.\n+     *\n+     * @param transportObserver A {@link TransportObserver} that provides visibility into transport events.\n+     * @return {@code this}.\n+     */\n+    BaseGrpcClientBuilder<U, R> transportObserver(TransportObserver transportObserver);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5NjI4NQ==", "bodyText": "I will start using channel attributes for now and reconsider approach when all events will be implemented. Don't want to change the internal API to propagate it correctly until I see the whole picture. For now, this PR focuses on behavior correctness for notified events.", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453796285", "createdAt": "2020-07-13T17:02:12Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/TransportObserverUtils.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.transport.netty.internal;\n+\n+import io.servicetalk.transport.api.ConnectionObserver;\n+import io.servicetalk.transport.api.TransportObserver;\n+\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelFutureListener;\n+import io.netty.util.AttributeKey;\n+\n+import javax.annotation.Nullable;\n+\n+import static io.netty.util.AttributeKey.newInstance;\n+\n+/**\n+ * Utilities for {@link TransportObserver}.\n+ */\n+public final class TransportObserverUtils {\n+\n+    private static final AttributeKey<ConnectionObserver> CONNECTION_OBSERVER = newInstance(\"ConnectionObserver\");\n+    private static final AttributeKey<Throwable> CONNECTION_ERROR = newInstance(\"ConnectionError\");\n+\n+    private TransportObserverUtils() {\n+        // No instances\n+    }\n+\n+    /**\n+     * Assigns a {@link ConnectionObserver} to the passed {@link Channel}.\n+     *\n+     * @param channel a {@link Channel} to assign a {@link ConnectionObserver} to\n+     * @param observer a {@link ConnectionObserver}\n+     */\n+    public static void assignConnectionObserver(final Channel channel, @Nullable final ConnectionObserver observer) {\n+        if (observer == null) {\n+            return;\n+        }\n+        channel.attr(CONNECTION_OBSERVER).set(observer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NDc1NzA1", "url": "https://github.com/apple/servicetalk/pull/1095#pullrequestreview-447475705", "createdAt": "2020-07-13T17:57:51Z", "commit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzo1Nzo1MlrOGwzi4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODo1Mzo0OVrOGw1hwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgyOTM0NA==", "bodyText": "Generally for all builders; should this be a Supplier<TransportObserver>?\nSpecifically for multi-address client; we should have a way to provide per host observer", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453829344", "createdAt": "2020-07-13T17:57:52Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/MultiAddressHttpClientBuilder.java", "diffHunk": "@@ -62,6 +63,9 @@\n     @Override\n     public abstract MultiAddressHttpClientBuilder<U, R> enableWireLogging(String loggerName);\n \n+    @Override\n+    public abstract MultiAddressHttpClientBuilder<U, R> transportObserver(TransportObserver transportObserver);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgzNDQ2OQ==", "bodyText": "I am generally concerned about creating such publicly accessible, broadly scoped utilities prematurely.", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453834469", "createdAt": "2020-07-13T18:06:41Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/TransportObserverUtils.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.transport.netty.internal;\n+\n+import io.servicetalk.transport.api.ConnectionObserver;\n+import io.servicetalk.transport.api.TransportObserver;\n+\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelFutureListener;\n+import io.netty.util.AttributeKey;\n+\n+import javax.annotation.Nullable;\n+\n+import static io.netty.util.AttributeKey.newInstance;\n+\n+/**\n+ * Utilities for {@link TransportObserver}.\n+ */\n+public final class TransportObserverUtils {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgzNTc3OA==", "bodyText": "Can we do this assignment in TcpServerBinder? ChannelSet is just a means to have a collection of channels for a server; adding this functionality here seems incorrect. Additionally it increases the scope of TransportObserverUtils outside the tcp-netty-internal module", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453835778", "createdAt": "2020-07-13T18:09:05Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/ChannelSet.java", "diffHunk": "@@ -87,14 +97,17 @@ public ChannelSet(Executor offloadingExecutor) {\n      */\n     public boolean addIfAbsent(final Channel channel) {\n         final boolean added = channelMap.putIfAbsent(channel.id(), channel) == null;\n+        if (added) {\n+            final ConnectionObserver observer = this.connectionObserverFactory != null ?\n+                    this.connectionObserverFactory.get() : null;\n+            if (observer != null) {\n+                assignConnectionObserver(channel, observer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgzNzk1MA==", "bodyText": "In which cases does the closeFuture() complete with an error?\nI think this usage does not map to your intent of connectionClosed(Throwable) contract, does it?", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453837950", "createdAt": "2020-07-13T18:13:01Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/TransportObserverUtils.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.transport.netty.internal;\n+\n+import io.servicetalk.transport.api.ConnectionObserver;\n+import io.servicetalk.transport.api.TransportObserver;\n+\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelFutureListener;\n+import io.netty.util.AttributeKey;\n+\n+import javax.annotation.Nullable;\n+\n+import static io.netty.util.AttributeKey.newInstance;\n+\n+/**\n+ * Utilities for {@link TransportObserver}.\n+ */\n+public final class TransportObserverUtils {\n+\n+    private static final AttributeKey<ConnectionObserver> CONNECTION_OBSERVER = newInstance(\"ConnectionObserver\");\n+    private static final AttributeKey<Throwable> CONNECTION_ERROR = newInstance(\"ConnectionError\");\n+\n+    private TransportObserverUtils() {\n+        // No instances\n+    }\n+\n+    /**\n+     * Assigns a {@link ConnectionObserver} to the passed {@link Channel}.\n+     *\n+     * @param channel a {@link Channel} to assign a {@link ConnectionObserver} to\n+     * @param observer a {@link ConnectionObserver}\n+     */\n+    public static void assignConnectionObserver(final Channel channel, @Nullable final ConnectionObserver observer) {\n+        if (observer == null) {\n+            return;\n+        }\n+        channel.attr(CONNECTION_OBSERVER).set(observer);\n+        channel.closeFuture().addListener((ChannelFutureListener) future -> {\n+            Throwable t = connectionError(channel);\n+            if (t == null) {\n+                observer.connectionClosed();\n+            } else {\n+                observer.connectionClosed(t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0MTY1NA==", "bodyText": "You are decoupling observer creation from channel initialization. Is the intent here to account for time delta between start of connect and call to init() here?\nThe init sequence of creating an observer and adding the transport handler seems convoluted. Have you thought about creating the observer in this method?", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453841654", "createdAt": "2020-07-13T18:19:27Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/TransportObserverInitializer.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.transport.netty.internal;\n+\n+import io.servicetalk.transport.api.ConnectionObserver;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufHolder;\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelDuplexHandler;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelPromise;\n+\n+import static io.servicetalk.transport.netty.internal.TransportObserverUtils.connectionObserver;\n+\n+/**\n+ * A {@link ChannelInitializer} that registers a {@link ConnectionObserver} for all channels.\n+ */\n+public final class TransportObserverInitializer implements ChannelInitializer {\n+\n+    public static final ChannelInitializer TRANSPORT_OBSERVER_INITIALIZER = new TransportObserverInitializer();\n+\n+    private TransportObserverInitializer() {\n+        // Singleton\n+    }\n+\n+    @Override\n+    public void init(final Channel channel) {\n+        final ConnectionObserver observer = connectionObserver(channel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0MjI3Mw==", "bodyText": "Can we also hook in close events to the observer using this handler instead of the close future?", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453842273", "createdAt": "2020-07-13T18:20:32Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/TransportObserverInitializer.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.transport.netty.internal;\n+\n+import io.servicetalk.transport.api.ConnectionObserver;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufHolder;\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelDuplexHandler;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelPromise;\n+\n+import static io.servicetalk.transport.netty.internal.TransportObserverUtils.connectionObserver;\n+\n+/**\n+ * A {@link ChannelInitializer} that registers a {@link ConnectionObserver} for all channels.\n+ */\n+public final class TransportObserverInitializer implements ChannelInitializer {\n+\n+    public static final ChannelInitializer TRANSPORT_OBSERVER_INITIALIZER = new TransportObserverInitializer();\n+\n+    private TransportObserverInitializer() {\n+        // Singleton\n+    }\n+\n+    @Override\n+    public void init(final Channel channel) {\n+        final ConnectionObserver observer = connectionObserver(channel);\n+        if (observer != null) {\n+            channel.pipeline().addLast(new TransportObserverChannelHandler(observer));\n+        }\n+    }\n+\n+    private static final class TransportObserverChannelHandler extends ChannelDuplexHandler {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1MjIyMQ==", "bodyText": "a single network => a network", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453852221", "createdAt": "2020-07-13T18:37:02Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/ConnectionObserver.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.transport.api;\n+\n+/**\n+ * An observer interface that provides visibility into events associated with a single network connection.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1NTk4NQ==", "bodyText": "The method names here are in past tense \"dataWritten\", \"flushed\", etc. Is this intentional that they are associated with timing? While invoking these callbacks we are not consistent; dataRead() is after we have read from socket, dataWritten() is before we have written to the socket.\nAn alternate is to use onDataRead, onDataWrite, onFlush ... etc or whenDataRead, whenFlushed which hides the timing (before/after) and are also similar to the callbacks on our async primitives.", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453855985", "createdAt": "2020-07-13T18:43:44Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/ConnectionObserver.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.transport.api;\n+\n+/**\n+ * An observer interface that provides visibility into events associated with a single network connection.\n+ */\n+public interface ConnectionObserver {\n+\n+    /**\n+     * Notifies when the connection reads a chunk of data.\n+     *\n+     * @param size size of the data chunk read\n+     */\n+    void dataRead(int size);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1Njc3Ng==", "bodyText": "Suggestion: A callback when {@code size} bytes are read from the connection.", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453856776", "createdAt": "2020-07-13T18:45:07Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/ConnectionObserver.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.transport.api;\n+\n+/**\n+ * An observer interface that provides visibility into events associated with a single network connection.\n+ */\n+public interface ConnectionObserver {\n+\n+    /**\n+     * Notifies when the connection reads a chunk of data.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1NzAyNg==", "bodyText": "Suggestion: A callback when {@code size} bytes are written to the connection.", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453857026", "createdAt": "2020-07-13T18:45:33Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/ConnectionObserver.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.transport.api;\n+\n+/**\n+ * An observer interface that provides visibility into events associated with a single network connection.\n+ */\n+public interface ConnectionObserver {\n+\n+    /**\n+     * Notifies when the connection reads a chunk of data.\n+     *\n+     * @param size size of the data chunk read\n+     */\n+    void dataRead(int size);\n+\n+    /**\n+     * Notifies when the connection writes a chunk of data.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1NzUwMQ==", "bodyText": "Suggestion: Callback when previously written data is flushed to the connection.", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453857501", "createdAt": "2020-07-13T18:46:19Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-api/src/main/java/io/servicetalk/transport/api/ConnectionObserver.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.transport.api;\n+\n+/**\n+ * An observer interface that provides visibility into events associated with a single network connection.\n+ */\n+public interface ConnectionObserver {\n+\n+    /**\n+     * Notifies when the connection reads a chunk of data.\n+     *\n+     * @param size size of the data chunk read\n+     */\n+    void dataRead(int size);\n+\n+    /**\n+     * Notifies when the connection writes a chunk of data.\n+     *\n+     * @param size size of the data chunk written\n+     */\n+    void dataWritten(int size);\n+\n+    /**\n+     * Notifies when flush operation is made on the connection. The flush operation will try to flush out all previous", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg2MTgyNg==", "bodyText": "IIUC, the current code paths registering an error is a subset of things you would want to cover eventually.\nLooks like we need to have some association with the close-handler to determine which error should be the cause of closure instead of this \"first-writer-wins\" semantics?", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453861826", "createdAt": "2020-07-13T18:53:49Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/TransportObserverUtils.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.transport.netty.internal;\n+\n+import io.servicetalk.transport.api.ConnectionObserver;\n+import io.servicetalk.transport.api.TransportObserver;\n+\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelFutureListener;\n+import io.netty.util.AttributeKey;\n+\n+import javax.annotation.Nullable;\n+\n+import static io.netty.util.AttributeKey.newInstance;\n+\n+/**\n+ * Utilities for {@link TransportObserver}.\n+ */\n+public final class TransportObserverUtils {\n+\n+    private static final AttributeKey<ConnectionObserver> CONNECTION_OBSERVER = newInstance(\"ConnectionObserver\");\n+    private static final AttributeKey<Throwable> CONNECTION_ERROR = newInstance(\"ConnectionError\");\n+\n+    private TransportObserverUtils() {\n+        // No instances\n+    }\n+\n+    /**\n+     * Assigns a {@link ConnectionObserver} to the passed {@link Channel}.\n+     *\n+     * @param channel a {@link Channel} to assign a {@link ConnectionObserver} to\n+     * @param observer a {@link ConnectionObserver}\n+     */\n+    public static void assignConnectionObserver(final Channel channel, @Nullable final ConnectionObserver observer) {\n+        if (observer == null) {\n+            return;\n+        }\n+        channel.attr(CONNECTION_OBSERVER).set(observer);\n+        channel.closeFuture().addListener((ChannelFutureListener) future -> {\n+            Throwable t = connectionError(channel);\n+            if (t == null) {\n+                observer.connectionClosed();\n+            } else {\n+                observer.connectionClosed(t);\n+            }\n+            channel.attr(CONNECTION_OBSERVER).set(null);\n+        });\n+    }\n+\n+    /**\n+     * Returns {@link ConnectionObserver} associated with the passed {@link Channel}.\n+     *\n+     * @param channel {@link Channel} that may have assigned {@link ConnectionObserver}\n+     * @return {@link ConnectionObserver} associated with the passed {@link Channel}\n+     */\n+    @Nullable\n+    public static ConnectionObserver connectionObserver(final Channel channel) {\n+        return channel.attr(CONNECTION_OBSERVER).get();\n+    }\n+\n+    /**\n+     * Assigns a {@link Throwable} to the passed {@link Channel}.\n+     *\n+     * @param channel a {@link Channel} to assign a {@link Throwable} to\n+     * @param error a {@link Throwable}\n+     */\n+    public static void assignConnectionError(final Channel channel, final Throwable error) {\n+        if (connectionObserver(channel) != null) {\n+            channel.attr(CONNECTION_ERROR).setIfAbsent(error);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 82}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NDcyODgw", "url": "https://github.com/apple/servicetalk/pull/1095#pullrequestreview-447472880", "createdAt": "2020-07-13T17:53:55Z", "commit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzo1Mzo1NVrOGwzZtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxOTowMzozMlrOGw13aA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgyNjk5OA==", "bodyText": "can you provide a summary for ConnectionFactory vs builder trade-offs and what needs to change to enable that?", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453826998", "createdAt": "2020-07-13T17:53:55Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/BaseGrpcClientBuilder.java", "diffHunk": "@@ -73,6 +74,14 @@\n      */\n     BaseGrpcClientBuilder<U, R> enableWireLogging(String loggerName);\n \n+    /**\n+     * Sets a {@link TransportObserver} that provides visibility into transport events.\n+     *\n+     * @param transportObserver A {@link TransportObserver} that provides visibility into transport events.\n+     * @return {@code this}.\n+     */\n+    BaseGrpcClientBuilder<U, R> transportObserver(TransportObserver transportObserver);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5NTU0MA=="}, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1ODI0NQ==", "bodyText": "nit: since null doesn't have a special meaning internally you can avoid double null check on every addIfAbsent and do one of the null checks here:\nthis.connectionObserverFactory = connectionObserverFactory == null ? () -> null : connectionObserverFactory;\nwhich could simplify the usage in addIfAbsent to:\nfinal ConnectionObserver observer = connectionObserverFactory.get();", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453858245", "createdAt": "2020-07-13T18:47:28Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/ChannelSet.java", "diffHunk": "@@ -68,14 +72,20 @@ public void operationComplete(final ChannelFuture future) {\n     private final Completable onClose;\n     @SuppressWarnings(\"unused\")\n     private volatile int state;\n+    @Nullable\n+    private final Supplier<ConnectionObserver> connectionObserverFactory;\n \n     /**\n      * New instance.\n      *\n      * @param offloadingExecutor {@link Executor} to use for offloading close signals.\n+     * @param connectionObserverFactory a factory that creates a {@link ConnectionObserver} when a new {@link Channel}\n+     * is added\n      */\n-    public ChannelSet(Executor offloadingExecutor) {\n+    public ChannelSet(final Executor offloadingExecutor,\n+                      @Nullable final Supplier<ConnectionObserver> connectionObserverFactory) {\n         onClose = fromSource(onCloseProcessor).publishOn(offloadingExecutor);\n+        this.connectionObserverFactory = connectionObserverFactory;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg2NzM2OA==", "bodyText": "its somewhat awkward to handle the ConnectionObserver in the ChannelSet on the server, and directly in the transport code for the client. did you consider moving this into the transport as well?", "url": "https://github.com/apple/servicetalk/pull/1095#discussion_r453867368", "createdAt": "2020-07-13T19:03:32Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/ChannelSet.java", "diffHunk": "@@ -87,14 +97,17 @@ public ChannelSet(Executor offloadingExecutor) {\n      */\n     public boolean addIfAbsent(final Channel channel) {\n         final boolean added = channelMap.putIfAbsent(channel.id(), channel) == null;\n+        if (added) {\n+            final ConnectionObserver observer = this.connectionObserverFactory != null ?\n+                    this.connectionObserverFactory.get() : null;\n+            if (observer != null) {\n+                assignConnectionObserver(channel, observer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c582ed93798eec00efc90f9c15112801b1dc17d"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29f12f9f781ea12c915a6f9cb652fcfe9e5ea338", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/29f12f9f781ea12c915a6f9cb652fcfe9e5ea338", "committedDate": "2020-07-14T21:50:49Z", "message": "Move observer initialization from ChannelSet to TcpServerBinder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a7307012d89d4ab1e5e3d7084214df672378543", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/5a7307012d89d4ab1e5e3d7084214df672378543", "committedDate": "2020-07-14T22:20:27Z", "message": "Rename interface methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c936f7032e90ded07b9047ca92caf6d2983cf44e", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/c936f7032e90ded07b9047ca92caf6d2983cf44e", "committedDate": "2020-07-14T22:39:26Z", "message": "Move ConnectionObserver creation to TransportObserverInitializer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e362473038f05250b8375c37f913f0d291f1907", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/8e362473038f05250b8375c37f913f0d291f1907", "committedDate": "2020-07-14T22:47:53Z", "message": "Minor fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8478921d4601268336450283abcc2cfff1596f07", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/8478921d4601268336450283abcc2cfff1596f07", "committedDate": "2020-07-16T01:33:24Z", "message": "Build TransportObserver per HostAndPort for MultiAddressHttpClient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce96cb19f20a93708d79d5fdb72539db19d90ac4", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/ce96cb19f20a93708d79d5fdb72539db19d90ac4", "committedDate": "2020-07-16T01:37:41Z", "message": "Make TransportObserverUtils pkg-private"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3415, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}