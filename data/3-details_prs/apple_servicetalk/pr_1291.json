{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNTI0Mzg0", "number": 1291, "title": "Completable#merge concurrency fix, new Completable#merge single arg o\u2026", "bodyText": "\u2026verride\nMotivation:\nCompletable#merge(Iterable) must iterate before it knows how many\nCompletables to wait for. The implementation uses two independent\nvolatile variables for the expected value and current count, which may\nresult in visibility issues.\nModifications:\n\nCompletable#merge(Iterable) should use the same volatile variable to\nmanage the count, and avoid data races/visibility issues.\nAdd Compleable#merge(Completable) and\nCompletable#mergeDelayError(Completable) overrides to avoid array\nallocation.\nClean up Compleable#merge implementations to remove unused methods,\nand create the optimized implementation depending upon array\ncardinality.\n\nResult:\nLess data races in Completable#merge(Iterable) and operator overload for\nsingle Completable merge operations.", "createdAt": "2020-12-18T12:49:27Z", "url": "https://github.com/apple/servicetalk/pull/1291", "merged": true, "mergeCommit": {"oid": "0311cc9898d4afd023f59ad462fe931bcca6e4db"}, "closed": true, "closedAt": "2021-01-12T18:15:30Z", "author": {"login": "Scottmitch"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnjZsAgFqTU1NTkwNTYyOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnlqnZgBqjQxMzIxNTM4Nzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1OTA1NjI4", "url": "https://github.com/apple/servicetalk/pull/1291#pullrequestreview-555905628", "createdAt": "2020-12-19T01:57:34Z", "commit": {"oid": "315029c1f6020692be9558025fadb10394f5b211"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOVQwMTo1NzozNVrOII310A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOVQwMjozMzo0NlrOII4Fmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3NDQxNg==", "bodyText": "I thought about cases like this. Currently, we allow Completable.completed().merge() which doesn't make any sense. I think we should change all API that use varargs but require at least one element to merge(Completable first, Completable... others).  Then merge(Completable) will be not necessary or may be used to avoid extra allocation because merging with one is the most common case.", "url": "https://github.com/apple/servicetalk/pull/1291#discussion_r546174416", "createdAt": "2020-12-19T01:57:35Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-concurrent-api/src/main/java/io/servicetalk/concurrent/api/Completable.java", "diffHunk": "@@ -437,7 +461,7 @@ public final Completable concat(Completable next) {\n      * complete or terminates with an error when any one terminates with an error.\n      */\n     public final Completable merge(Completable... other) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315029c1f6020692be9558025fadb10394f5b211"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3NTc3Ng==", "bodyText": "If other is empty we can return this here and in mergeDelayError.", "url": "https://github.com/apple/servicetalk/pull/1291#discussion_r546175776", "createdAt": "2020-12-19T02:09:08Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-concurrent-api/src/main/java/io/servicetalk/concurrent/api/Completable.java", "diffHunk": "@@ -437,7 +461,7 @@ public final Completable concat(Completable next) {\n      * complete or terminates with an error when any one terminates with an error.\n      */\n     public final Completable merge(Completable... other) {\n-        return new MergeCompletable(false, this, executor, other);\n+        return MergeCompletable.newInstance(false, this, executor, other);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315029c1f6020692be9558025fadb10394f5b211"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3NjU1NA==", "bodyText": "Consider reverting this check until we fix API as described above.", "url": "https://github.com/apple/servicetalk/pull/1291#discussion_r546176554", "createdAt": "2020-12-19T02:16:15Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-concurrent-api/src/main/java/io/servicetalk/concurrent/api/MergeCompletable.java", "diffHunk": "@@ -15,77 +15,54 @@\n  */\n package io.servicetalk.concurrent.api;\n \n-import javax.annotation.Nullable;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n \n import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.atomic.AtomicIntegerFieldUpdater.newUpdater;\n \n-/**\n- * A {@link Completable} implementation for merging {@link Completable}s.\n- */\n final class MergeCompletable extends AbstractMergeCompletableOperator {\n-\n-    @Nullable\n     private final Completable[] others;\n-    @Nullable\n-    private final Completable onlyOther;\n     private final boolean delayError;\n \n-    /**\n-     * New instance.\n-     * @param delayError {@code true} to wait until all {@code others} complete before propagating an error.\n-     *                   {@code false} to fail fast and propagate an error on the first\n-     *                   {@link Subscriber#onError(Throwable)} observed.\n-     * @param original {@link Completable} to merge with {@code others}.\n-     * @param others {@link Completable}s to merge with {@code original}.\n-     */\n-    MergeCompletable(boolean delayError, Completable original, Executor executor, Completable... others) {\n+    private MergeCompletable(boolean delayError, Completable original, Executor executor, Completable... others) {\n         super(original, executor);\n         this.delayError = delayError;\n-        switch (others.length) {\n-            case 0:\n-                throw new IllegalArgumentException(\"At least one Completable required to merge\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315029c1f6020692be9558025fadb10394f5b211"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3NzA0Mw==", "bodyText": "It's actually not a counter of remaining items, it's a counter of terminated items. Consider renaming to something like terminatedCount or doneCount.\nAlternatively, you can initialize remainingCount = expectedCount and decrement until 0. This way we will save a few bytes in this object by removing expectedCount.", "url": "https://github.com/apple/servicetalk/pull/1291#discussion_r546177043", "createdAt": "2020-12-19T02:20:44Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-concurrent-api/src/main/java/io/servicetalk/concurrent/api/MergeCompletable.java", "diffHunk": "@@ -15,77 +15,54 @@\n  */\n package io.servicetalk.concurrent.api;\n \n-import javax.annotation.Nullable;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n \n import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.atomic.AtomicIntegerFieldUpdater.newUpdater;\n \n-/**\n- * A {@link Completable} implementation for merging {@link Completable}s.\n- */\n final class MergeCompletable extends AbstractMergeCompletableOperator {\n-\n-    @Nullable\n     private final Completable[] others;\n-    @Nullable\n-    private final Completable onlyOther;\n     private final boolean delayError;\n \n-    /**\n-     * New instance.\n-     * @param delayError {@code true} to wait until all {@code others} complete before propagating an error.\n-     *                   {@code false} to fail fast and propagate an error on the first\n-     *                   {@link Subscriber#onError(Throwable)} observed.\n-     * @param original {@link Completable} to merge with {@code others}.\n-     * @param others {@link Completable}s to merge with {@code original}.\n-     */\n-    MergeCompletable(boolean delayError, Completable original, Executor executor, Completable... others) {\n+    private MergeCompletable(boolean delayError, Completable original, Executor executor, Completable... others) {\n         super(original, executor);\n         this.delayError = delayError;\n-        switch (others.length) {\n-            case 0:\n-                throw new IllegalArgumentException(\"At least one Completable required to merge\");\n-            case 1:\n-                onlyOther = requireNonNull(others[0]);\n-                this.others = null;\n-                break;\n-            default:\n-                this.others = others;\n-                onlyOther = null;\n-        }\n+        this.others = requireNonNull(others);\n+    }\n+\n+    static AbstractMergeCompletableOperator newInstance(boolean delayError, Completable original, Executor executor,\n+                                                        Completable... others) {\n+        return others.length == 1 ?\n+                new MergeOneCompletable(delayError, original, executor, others[0]) :\n+                new MergeCompletable(delayError, original, executor, others);\n     }\n \n     @Override\n     public MergeSubscriber apply(final Subscriber subscriber) {\n-        assert onlyOther != null || others != null;\n-        return new FixedCountMergeSubscriber(subscriber, 1 + (onlyOther == null ? others.length : 1),\n-                delayError);\n+        return new FixedCountMergeSubscriber(subscriber, 1 + others.length, delayError);\n     }\n \n     @Override\n     void doMerge(final MergeSubscriber subscriber) {\n-        if (onlyOther == null) {\n-            assert others != null;\n-            for (Completable itr : others) {\n-                itr.subscribeInternal(subscriber);\n-            }\n-        } else {\n-            onlyOther.subscribeInternal(subscriber);\n+        for (Completable itr : others) {\n+            itr.subscribeInternal(subscriber);\n         }\n     }\n \n     static final class FixedCountMergeSubscriber extends MergeSubscriber {\n-        FixedCountMergeSubscriber(Subscriber subscriber, int completedCount, boolean delayError) {\n-            super(subscriber, completedCount, delayError);\n-        }\n+        private static final AtomicIntegerFieldUpdater<FixedCountMergeSubscriber> remainingCountUpdater =\n+                newUpdater(FixedCountMergeSubscriber.class, \"remainingCount\");\n+        private final int expectedCount;\n+        private volatile int remainingCount;\n \n-        @Override\n-        boolean onTerminate() {\n-            return completedCountUpdater.decrementAndGet(this) == 0;\n+        FixedCountMergeSubscriber(Subscriber subscriber, int expectedCount, boolean delayError) {\n+            super(subscriber, delayError);\n+            this.expectedCount = expectedCount;\n         }\n \n         @Override\n-        boolean isDone() {\n-            return completedCount == 0;\n+        boolean onTerminate() {\n+            return remainingCountUpdater.incrementAndGet(this) == expectedCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315029c1f6020692be9558025fadb10394f5b211"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3ODMyMA==", "bodyText": "Why not to keep pre-existing check for Collection?", "url": "https://github.com/apple/servicetalk/pull/1291#discussion_r546178320", "createdAt": "2020-12-19T02:32:25Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-concurrent-api/src/main/java/io/servicetalk/concurrent/api/IterableMergeCompletable.java", "diffHunk": "@@ -37,49 +35,37 @@\n \n     @Override\n     public MergeSubscriber apply(final Subscriber subscriber) {\n-        if (others instanceof Collection) {\n-            return new FixedCountMergeSubscriber(subscriber, 1 + ((Collection) others).size(), delayError);\n-        } else {\n-            return new DynamicCountSubscriber(subscriber, delayError);\n-        }\n+        return new DynamicCountSubscriber(subscriber, delayError);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315029c1f6020692be9558025fadb10394f5b211"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3ODQ1OQ==", "bodyText": "If you prefer to keep only DynamicCountSubscriber, consider adding a generic type for AbstractMergeCompletableOperator to avoid cast here.", "url": "https://github.com/apple/servicetalk/pull/1291#discussion_r546178459", "createdAt": "2020-12-19T02:33:46Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-concurrent-api/src/main/java/io/servicetalk/concurrent/api/IterableMergeCompletable.java", "diffHunk": "@@ -37,49 +35,37 @@\n \n     @Override\n     public MergeSubscriber apply(final Subscriber subscriber) {\n-        if (others instanceof Collection) {\n-            return new FixedCountMergeSubscriber(subscriber, 1 + ((Collection) others).size(), delayError);\n-        } else {\n-            return new DynamicCountSubscriber(subscriber, delayError);\n-        }\n+        return new DynamicCountSubscriber(subscriber, delayError);\n     }\n \n     @Override\n     void doMerge(final MergeSubscriber subscriber) {\n-        if (subscriber instanceof DynamicCountSubscriber) {\n-            int count = 1;\n-            for (Completable itr : others) {\n-                ++count;\n-                itr.subscribeInternal(subscriber);\n-            }\n-            ((DynamicCountSubscriber) subscriber).setExpectedCount(count);\n-        } else {\n-            for (Completable itr : others) {\n-                itr.subscribeInternal(subscriber);\n-            }\n+        long count = 1;\n+        for (Completable itr : others) {\n+            ++count;\n+            itr.subscribeInternal(subscriber);\n         }\n+        ((DynamicCountSubscriber) subscriber).setExpectedCount(count);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315029c1f6020692be9558025fadb10394f5b211"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46da2f4f848438da9b6032a60c8d469d16c25932", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/46da2f4f848438da9b6032a60c8d469d16c25932", "committedDate": "2020-12-19T05:10:04Z", "message": "Completable#merge concurrency fix, new Completable#merge single arg override\n\nMotivation:\nCompletable#merge(Iterable) must iterate before it knows how many\nCompletables to wait for. The implementation uses two independent\nvolatile variables for the expected value and current count, which may\nresult in visibility issues.\n\nModifications:\n- Completable#merge(Iterable) should use the same volatile variable to\nmanage the count, and avoid data races/visibility issues.\n- Add Compleable#merge(Completable) and\nCompletable#mergeDelayError(Completable) overrides to avoid array\nallocation.\n- Clean up Compleable#merge implementations to remove unused methods,\nand create the optimized implementation depending upon array\ncardinality.\n\nResult:\nLess data races in Completable#merge(Iterable) and operator overload for\nsingle Completable merge operations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d20cc86061aea631f6b825ba11b2933661bb070a", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/d20cc86061aea631f6b825ba11b2933661bb070a", "committedDate": "2020-12-19T05:10:06Z", "message": "use final variable to simplify concurrency, rely less on RS correctness"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d535d428ca9d555816da2a8a03160194b5de1a84", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/d535d428ca9d555816da2a8a03160194b5de1a84", "committedDate": "2020-12-19T05:12:46Z", "message": "review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd81ea625e67ba5dd32e5f9e94c8664ee3515261", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/fd81ea625e67ba5dd32e5f9e94c8664ee3515261", "committedDate": "2020-12-19T05:08:39Z", "message": "review comments"}, "afterCommit": {"oid": "d535d428ca9d555816da2a8a03160194b5de1a84", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/d535d428ca9d555816da2a8a03160194b5de1a84", "committedDate": "2020-12-19T05:12:46Z", "message": "review comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3410, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}