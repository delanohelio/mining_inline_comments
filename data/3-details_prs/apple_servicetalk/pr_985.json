{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0NDY2NzQw", "number": 985, "title": "Follow-up enhancements for `servicetalk-grpc-gradle-plugin`", "bodyText": "Motivation:\nThere are a few issues with servicetalk-grpc-gradle-plugin.\nModifications:\n\nFix incorrect plugin name in exception message;\nCorrectly verify that serviceTalkVersion has correct value as\nit's always not empty, but may have unprocessed value;\nDo not add serviceTalkVersion to the scriptExecutableFile\nname as it's not necessary;\nGenerate script only for projects that use\nservicetalk-grpc-gradle-plugin instead of the root project;\nDo not looks for serviceTalkGrpcProtocGenerateScript task\nbefore creating it;\nDelete generated script file when users run clean task;\nRecreate executable script file on every run to avoid having\nan outdated file (for example if gradle changes the hash for\ncached artifacts or if users run another project with and\nwithout --include-build);\n\nResult:\nservicetalk-grpc-gradle-plugin behaves correctly.", "createdAt": "2020-03-26T23:06:49Z", "url": "https://github.com/apple/servicetalk/pull/985", "merged": true, "mergeCommit": {"oid": "2217f9d41b53183cfa598f3d82ed535c872dd8fd"}, "closed": true, "closedAt": "2020-03-27T19:51:14Z", "author": {"login": "idelpivnitskiy"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRkXOsgH2gAyMzk0NDY2NzQwOjg4MmUyZWFiNDdkOTE4ZGZiOGEyZTg0ZDE2ZTkzNGI5ZDQ2NTg5MmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcR1ldqgH2gAyMzk0NDY2NzQwOmY0NDcwMTlhYWI4NTBhYjI0NGEyMzkwOGNlZTg3NjdiODNmMmIwZDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "882e2eab47d918dfb8a2e84d16e934b9d465892d", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/882e2eab47d918dfb8a2e84d16e934b9d465892d", "committedDate": "2020-03-26T23:04:45Z", "message": "Follow-up enhancements for `servicetalk-grpc-gradle-plugin`\n\nMotivation:\n\nThere are a few issues with `servicetalk-grpc-gradle-plugin`.\n\nModifications:\n\n- Fix incorrect plugin name in exception message;\n- Fix `serviceTalkVersion` extraction that could use a version\nof a project that compiles with `--include-build`;\n- Delete generated script file when users run `clean` task;\n- Recreate executable script file on every run to avoid having\nan outdated file (for example if gradle changes the hash for\ncached artifacts or if users run another project with and\nwithout `--include-build`);\n\nResult:\n\n`servicetalk-grpc-gradle-plugin` behaves correctly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd5e2eb2a58dc8d01236ca46dc25da653d81fecd", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/cd5e2eb2a58dc8d01236ca46dc25da653d81fecd", "committedDate": "2020-03-26T23:30:30Z", "message": "Do not add version for scriptExecutableFile name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzIzODc3", "url": "https://github.com/apple/servicetalk/pull/985#pullrequestreview-382723877", "createdAt": "2020-03-27T10:07:12Z", "commit": {"oid": "cd5e2eb2a58dc8d01236ca46dc25da653d81fecd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyOTk2Nzc5", "url": "https://github.com/apple/servicetalk/pull/985#pullrequestreview-382996779", "createdAt": "2020-03-27T16:06:52Z", "commit": {"oid": "cd5e2eb2a58dc8d01236ca46dc25da653d81fecd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNjowNjo1M1rOF836IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNjowNjo1M1rOF836IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3NDg4MQ==", "bodyText": "serviceTalkVersion is always not empty. But it could have ${projectVersion} as a value instead of the actual version (e.g. 0.26.0-SNAPSHOT) when this code executes before processResources (happens with --include-build).", "url": "https://github.com/apple/servicetalk/pull/985#discussion_r399374881", "createdAt": "2020-03-27T16:06:53Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-gradle-plugin/src/main/groovy/io/servicetalk/grpc/gradle/plugin/ServiceTalkGrpcPlugin.groovy", "diffHunk": "@@ -54,7 +54,7 @@ class ServiceTalkGrpcPlugin implements Plugin<Project> {\n       def serviceTalkGrpcProtoc = \"servicetalk-grpc-protoc\"\n       def serviceTalkVersion = pluginProperties.\"implementation-version\"\n       def serviceTalkProtocPluginPath = extension.serviceTalkProtocPluginPath\n-      if (!serviceTalkVersion && !serviceTalkProtocPluginPath) {\n+      if (!isVersion(serviceTalkVersion) && !serviceTalkProtocPluginPath) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd5e2eb2a58dc8d01236ca46dc25da653d81fecd"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyOTkzNTcz", "url": "https://github.com/apple/servicetalk/pull/985#pullrequestreview-382993573", "createdAt": "2020-03-27T16:03:09Z", "commit": {"oid": "cd5e2eb2a58dc8d01236ca46dc25da653d81fecd"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNjowMzowOVrOF83woQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNjowNzowNVrOF836rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3MjQ0OQ==", "bodyText": "the intention with rootProject is that we only need to have a single task which generates the executable script, and have a single script generated in the root project (regardless of how many subprojects apply the plugin). can you clarify why this changed?", "url": "https://github.com/apple/servicetalk/pull/985#discussion_r399372449", "createdAt": "2020-03-27T16:03:09Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-grpc-gradle-plugin/src/main/groovy/io/servicetalk/grpc/gradle/plugin/ServiceTalkGrpcPlugin.groovy", "diffHunk": "@@ -64,12 +64,11 @@ class ServiceTalkGrpcPlugin implements Plugin<Project> {\n         throw new InvalidUserDataException(\"Please set `serviceTalkGrpc.protobufVersion`.\")\n       }\n \n-      Project rootProject = project.rootProject != null ? project.rootProject : project\n       String serviceTalkGrpcProtocGenerateScriptTaskName = \"serviceTalkGrpcProtocGenerateScript\"\n-      if (rootProject.getTasksByName(serviceTalkGrpcProtocGenerateScriptTaskName, false).isEmpty()) {\n-        rootProject.task(serviceTalkGrpcProtocGenerateScriptTaskName, {\n+      if (project.getTasksByName(serviceTalkGrpcProtocGenerateScriptTaskName, false).isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd5e2eb2a58dc8d01236ca46dc25da653d81fecd"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3MzUxMw==", "bodyText": "the rational for putting the version suffix was that if folks update their version of ServiceTalk and the script generation changes, they won't have to clean their build in order to get the updates (it will be confusing if folks update their version and don't see new behavior without a clean build). Can you clarify the motivation for this change?", "url": "https://github.com/apple/servicetalk/pull/985#discussion_r399373513", "createdAt": "2020-03-27T16:04:47Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-grpc-gradle-plugin/src/main/groovy/io/servicetalk/grpc/gradle/plugin/ServiceTalkGrpcPlugin.groovy", "diffHunk": "@@ -80,26 +79,23 @@ class ServiceTalkGrpcPlugin implements Plugin<Project> {\n           // uber jar which contains the protoc logic, as otherwise the grpc-gradle-plugin will only add a dependency\n           // on the executable script\n           File uberJarFile\n-          String scriptNamePrefix", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd5e2eb2a58dc8d01236ca46dc25da653d81fecd"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3NTAyMQ==", "bodyText": "can you clarify the motivation for this change? if the file already exists the assumption is we don't need to try to re-write the file. The script files are (or were before this PR) versioned so no need to re-write. If folks are using SNAPSHOT it is possible the contents have changed, but this will mostly be just for us during development and we can force a clean if we are working on the scripts.", "url": "https://github.com/apple/servicetalk/pull/985#discussion_r399375021", "createdAt": "2020-03-27T16:07:05Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-grpc-gradle-plugin/src/main/groovy/io/servicetalk/grpc/gradle/plugin/ServiceTalkGrpcPlugin.groovy", "diffHunk": "@@ -224,9 +220,6 @@ class ServiceTalkGrpcPlugin implements Plugin<Project> {\n   }\n \n   private static boolean createNewScriptFile(File outputFile) throws IOException {\n-    if (outputFile.exists()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd5e2eb2a58dc8d01236ca46dc25da653d81fecd"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMDY2NzMw", "url": "https://github.com/apple/servicetalk/pull/985#pullrequestreview-383066730", "createdAt": "2020-03-27T17:33:47Z", "commit": {"oid": "cd5e2eb2a58dc8d01236ca46dc25da653d81fecd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cec23c69b31a8a4ec07403ba85166bf63152330f", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/cec23c69b31a8a4ec07403ba85166bf63152330f", "committedDate": "2020-03-27T19:06:56Z", "message": "Do not check if `serviceTalkGrpcProtocGenerateScript` already exists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f447019aab850ab244a23908cee8767b83f2b0d6", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/f447019aab850ab244a23908cee8767b83f2b0d6", "committedDate": "2020-03-27T19:08:41Z", "message": "Allow to build projects that use `serviceTalkProtocPluginPath` independently\n\nCurrently, `./gradlew clean :servicetalk-examples:grpc:servicetalk-examples-grpc-helloworld:assemble` fails because there is no executable. `buildExecutable` task was not part of the task dependency graph in this case"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3551, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}