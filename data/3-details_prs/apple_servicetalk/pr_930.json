{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5OTMxOTc3", "number": 930, "title": "Prevent misconfigurations for gRPC router", "bodyText": "Motivation:\ngRPC server allows users to register routes in different ways:\n\nusing multiple instances of ServiceFactory;\nusing ServiceFactory.Builder with different\nGrpcExecutionStrategy configuration;\nusing ServiceFactory.Builder with different API variants;\n\nUsers can accidentally misconfigure the router by registering\nthe same RPC more than once. Currently, gRPC server silently\noverrides the old RPC with the new one. It may lead to\nunexpected behavior in production and hard to diagnose issues.\nModifications:\n\nThrow IllegalStateException when users register an RPC for\nthe same path more than one time;\nAdd tests to verify that exceptions will be thrown;\n\nResult:\nUsers will be notified at the build time if they registered\nmultiple RPC implementations for the same path.", "createdAt": "2020-02-01T19:41:12Z", "url": "https://github.com/apple/servicetalk/pull/930", "merged": true, "mergeCommit": {"oid": "8005373f60bdd0950e46e8f95d24f1adb459715b"}, "closed": true, "closedAt": "2020-02-04T01:00:26Z", "author": {"login": "idelpivnitskiy"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcAJEcggH2gAyMzY5OTMxOTc3OmFhMjI2ZDRkNzlhZmJlZmVhNjk1ZGQ4YzczNzY2YTNjMzFmNWEyMDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcA2X1DgH2gAyMzY5OTMxOTc3OmMyZGQzYTcwNGVjODg3MTk3YTg0OWViMjE3ZmI3ZDdjMTc2NTc3NTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aa226d4d79afbefea695dd8c73766a3c31f5a200", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/aa226d4d79afbefea695dd8c73766a3c31f5a200", "committedDate": "2020-02-01T19:40:05Z", "message": "Prevent misconfigurations for gRPC router\n\nMotivation:\n\ngRPC server allows users to register routes in different ways:\n- using multiple instances of `ServiceFactory`;\n- using `ServiceFactory.Builder` with different\n`GrpcExecutionStrategy` configuration;\n- using `ServiceFactory.Builder` with different API variants;\n\nUsers can accidentally misconfigure the router by registering\nthe same RPC more than once. Currently, gRPC server silently\noverrides the old RPC with the new one. It may lead to\nunexpected behavior in production and hard to diagnose issues.\n\nModifications:\n\n- Throw `IllegalStateException` when users register an RPC for\nthe same path more than one time;\n\nResult:\n\nUsers will be notified at the build time if they registered\nmultiple RPC implementations for the same path."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNjE4Nzg3", "url": "https://github.com/apple/servicetalk/pull/930#pullrequestreview-352618787", "createdAt": "2020-02-03T22:48:33Z", "commit": {"oid": "aa226d4d79afbefea695dd8c73766a3c31f5a200"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMjo0ODozNFrOFlCtBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMjo1ODozNVrOFlC79w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM4NTkyNA==", "bodyText": "nit: rename to mergeRoutes()?", "url": "https://github.com/apple/servicetalk/pull/930#discussion_r374385924", "createdAt": "2020-02-03T22:48:34Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java", "diffHunk": "@@ -199,19 +201,26 @@ RouteProviders drainRoutes() {\n             final Map<String, RouteProvider> blockingRoutes = new HashMap<>();\n             final Map<String, RouteProvider> blockingStreamingRoutes = new HashMap<>();\n             for (Builder builder : builders) {\n-                routes.putAll(builder.routes);\n-                streamingRoutes.putAll(builder.streamingRoutes);\n-                blockingRoutes.putAll(builder.blockingRoutes);\n-                blockingStreamingRoutes.putAll(builder.blockingStreamingRoutes);\n+                mergeMaps(routes, builder.routes);\n+                mergeMaps(streamingRoutes, builder.streamingRoutes);\n+                mergeMaps(blockingRoutes, builder.blockingRoutes);\n+                mergeMaps(blockingStreamingRoutes, builder.blockingStreamingRoutes);\n             }\n             return new Builder(routes, streamingRoutes, blockingRoutes, blockingStreamingRoutes);\n         }\n \n+        private static void mergeMaps(final Map<String, RouteProvider> first, final Map<String, RouteProvider> second) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa226d4d79afbefea695dd8c73766a3c31f5a200"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM4OTc1MQ==", "bodyText": "It is somewhat non-intuitive that we are only checking for one alternative Map when we have 3 more Maps of routes.\nConsider adding a comment to explain that we only assume duplication across blocking and async variant of the same API and not between scalar and streaming.", "url": "https://github.com/apple/servicetalk/pull/930#discussion_r374389751", "createdAt": "2020-02-03T22:58:35Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java", "diffHunk": "@@ -247,15 +256,15 @@ public Completable closeAsyncGracefully() {\n                         }\n                     }, strategy -> executionStrategy == null ? strategy : executionStrategy),\n                     () -> toStreaming(route), () -> toRequestStreamingRoute(route),\n-                    () -> toResponseStreamingRoute(route), () -> route, route));\n+                    () -> toResponseStreamingRoute(route), () -> route, route)), path, blockingRoutes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa226d4d79afbefea695dd8c73766a3c31f5a200"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2dd3a704ec887197a849eb217fb7d7c17657756", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/c2dd3a704ec887197a849eb217fb7d7c17657756", "committedDate": "2020-02-04T00:26:59Z", "message": "Address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3260, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}