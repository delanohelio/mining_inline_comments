{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxOTA5NDQ5", "number": 1134, "title": "Avoid using nullable fields for observers", "bodyText": "Motivation:\n@Nullable fields make the internal control flow more complex,\nas we always have to checks for null before using the field.\nModifications:\n\nUse NOOP implementation of observers instead of handling null\neverywhere;\n\nResult:\nSimplified internal control flow.", "createdAt": "2020-08-22T00:50:05Z", "url": "https://github.com/apple/servicetalk/pull/1134", "merged": true, "mergeCommit": {"oid": "63e95ee2ff478afb4e20f1ee38802add5476a661"}, "closed": true, "closedAt": "2020-08-25T17:18:35Z", "author": {"login": "idelpivnitskiy"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBNkM4AH2gAyNDcxOTA5NDQ5OjFmMzkwZmY5YWQ5ZDBlNWQ5N2Q1YTdjMjI5YmEzNTI0ZWYyZDQ4Y2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCZw5RgFqTQ3NDY0OTg2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1f390ff9ad9d0e5d97d5a7c229ba3524ef2d48cc", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/1f390ff9ad9d0e5d97d5a7c229ba3524ef2d48cc", "committedDate": "2020-08-21T23:39:28Z", "message": "Avoid using nullable fields for observers\n\nMotivation:\n\n`@Nullable` fields make the internal control flow more complex,\nas we always have to checks for `null` before using the field.\n\nModifications:\n\n- Use NOOP implementation of observers instead of handling `null`\neverywhere;\n\nResult:\n\nSimplified internal control flow."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjg5MDAz", "url": "https://github.com/apple/servicetalk/pull/1134#pullrequestreview-473689003", "createdAt": "2020-08-24T17:02:27Z", "commit": {"oid": "1f390ff9ad9d0e5d97d5a7c229ba3524ef2d48cc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNzowMjoyOFrOHFuOxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNzoyNDoxMlrOHFvHTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc2MjM3NA==", "bodyText": "We should avoid failing the normal operations due to issues with observability. Doing this make the observability failures non-recoverable which isn't desirable as opposed to continuing with degraded observability.", "url": "https://github.com/apple/servicetalk/pull/1134#discussion_r475762374", "createdAt": "2020-08-24T17:02:28Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/NettyPipelineSslUtils.java", "diffHunk": "@@ -60,7 +60,21 @@ public static SSLSession extractSslSessionAndReport(ChannelPipeline pipeline,\n                                                         SslHandshakeCompletionEvent sslEvent,\n                                                         Consumer<Throwable> failureConsumer,\n                                                         boolean shouldReport) {\n-        final SecurityHandshakeObserver observer = shouldReport ? handshakeObserver(pipeline) : null;\n+        final SecurityHandshakeObserver observer;\n+        if (shouldReport) {\n+            try {\n+                observer = handshakeObserver(pipeline);\n+            } catch (Exception e) {\n+                if (!sslEvent.isSuccess()) {\n+                    e.addSuppressed(sslEvent.cause());\n+                }\n+                deliverFailureCause(failureConsumer, e, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f390ff9ad9d0e5d97d5a7c229ba3524ef2d48cc"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc3Njg0Nw==", "bodyText": "I was hoping shouldReport to go away. AFAIU, it is required because we are adding the ConnectionObserverHandler conditionally. Can we add the handler unconditionally?\nMy motivation here is to remove conditional code based on instance checks which assumes that an observer is homogeneous => an observer can not be partially NOOP.", "url": "https://github.com/apple/servicetalk/pull/1134#discussion_r475776847", "createdAt": "2020-08-24T17:24:12Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/DefaultNettyConnection.java", "diffHunk": "@@ -641,7 +640,7 @@ public void userEventTriggered(ChannelHandlerContext ctx, Object evt) {\n                 connection.nettyChannelPublisher.channelInboundClosed();\n             } else if (evt instanceof SslHandshakeCompletionEvent) {\n                 connection.sslSession = extractSslSessionAndReport(ctx.pipeline(), (SslHandshakeCompletionEvent) evt,\n-                        this::tryFailSubscriber, observer != null);\n+                        this::tryFailSubscriber, observer != NoopConnectionObserver.INSTANCE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f390ff9ad9d0e5d97d5a7c229ba3524ef2d48cc"}, "originalPosition": 112}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fecc32d2b50c96b5ae75c8f7ac55a296191ba86", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/6fecc32d2b50c96b5ae75c8f7ac55a296191ba86", "committedDate": "2020-08-24T23:58:08Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3511393dfa917fa0bbab91b83042fb899a75fb2", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/c3511393dfa917fa0bbab91b83042fb899a75fb2", "committedDate": "2020-08-25T00:10:01Z", "message": "Suppress false positive spotbugs warnings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff97d58cd511ed05a4185620a658564d160311af", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/ff97d58cd511ed05a4185620a658564d160311af", "committedDate": "2020-08-25T00:39:51Z", "message": "Improve HttpTransportObserverTest.echoRequestResponse"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7c6ae41c3c73770e48341389b2b946a756e5039", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/d7c6ae41c3c73770e48341389b2b946a756e5039", "committedDate": "2020-08-25T01:59:04Z", "message": "Revert \"Address comments\"\n\nThis reverts commit 6fecc32d2b50c96b5ae75c8f7ac55a296191ba86."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dee935a1281d9a1e918a1efc943d770a3450ecaf", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/dee935a1281d9a1e918a1efc943d770a3450ecaf", "committedDate": "2020-08-25T02:07:50Z", "message": "Log errors during handshake observer look up instead of failing the subscriber"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NjQ5ODY5", "url": "https://github.com/apple/servicetalk/pull/1134#pullrequestreview-474649869", "createdAt": "2020-08-25T16:26:07Z", "commit": {"oid": "dee935a1281d9a1e918a1efc943d770a3450ecaf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3464, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}