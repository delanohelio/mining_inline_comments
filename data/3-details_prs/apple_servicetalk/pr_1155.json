{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MDYzMDU4", "number": 1155, "title": "Do not complete server write if there are still pending requests", "bodyText": "Motivation:\nRequestResponseCloseHandler.protocolPayloadEndOutbound callback triggers\nProtocolPayloadEndEvent when server is in closing state without accounting\nfor pending requests. As the result, server will not send a response for the\nsecond pipelined request, will not transition to the idle state, and will never\ncomplete close the connection.\nModifications:\n\nAccount for pending value before emitting ProtocolPayloadEndEvent;\nRenamve ProtocolPayloadEndEvent -> OutboundDataEndEvent;\nAdd a test to verify server does not trigger OutboundDataEndEvent\nwhile requests are pending;\nAdd more tests to verify that PROTOCOL_CLOSING_INBOUND,\nPROTOCOL_CLOSING_OUTBOUND, and USER_CLOSING events are\ncorrectly handled for pipelined server connection;\n\nResult:\nServer responds to pending requests and closes the connection if it's already\nin closing state while 2+ pipelined requests are in process.", "createdAt": "2020-09-18T04:31:35Z", "url": "https://github.com/apple/servicetalk/pull/1155", "merged": true, "mergeCommit": {"oid": "2301ec6b5acf868d75a954c940d37f13d864d7f8"}, "closed": true, "closedAt": "2020-10-01T19:14:16Z", "author": {"login": "idelpivnitskiy"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJ42DugH2gAyNDg5MDYzMDU4OmZhNjFjNWJjNjZmYzc3YTNlMmIwNzM1MWE4YWNjNzdhNzcwMDYwYmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOT81SgFqTUwMDUyMDQ4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fa61c5bc66fc77a3e2b07351a8acc77a770060ba", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/fa61c5bc66fc77a3e2b07351a8acc77a770060ba", "committedDate": "2020-09-17T22:36:17Z", "message": "Do not complete server write if there are still pending requests\n\nMotivation:\n\n`RequestResponseCloseHandler.protocolPayloadEndOutbound` callback triggers\n`ProtocolPayloadEndEvent` when server is in closing state without accounting\nfor pending requests. As the result, server will not send a response for the\nsecond pipelined request, will not transition to idle state, and will never\ncomplete graceful closure.\n\nModifications:\n\n- Account for `pending` value before emitting `ProtocolPayloadEndEvent`;\n- Add a test to verify server does not trigger `ProtocolPayloadEndEvent`\nwhile requests are pending;\n\nResult:\n\nServer closes gracefully if graceful closure was initiated while it was\nprocessing 2+ pipelined requests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNTAxNTE3", "url": "https://github.com/apple/servicetalk/pull/1155#pullrequestreview-491501517", "createdAt": "2020-09-18T14:10:18Z", "commit": {"oid": "fa61c5bc66fc77a3e2b07351a8acc77a770060ba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxODQxMTIy", "url": "https://github.com/apple/servicetalk/pull/1155#pullrequestreview-491841122", "createdAt": "2020-09-19T00:33:44Z", "commit": {"oid": "fa61c5bc66fc77a3e2b07351a8acc77a770060ba"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwMDozMzo0NFrOHUfMkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwMDozMzo0NFrOHUfMkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI0NDY4OQ==", "bodyText": "I think the real problem is that we are not cancelling the Subscription when we are prematurely completing the write source in WriteStreamSubscriber.\nThis event is meant to indicate payload end so I don't think we should further override it to mean \"last\" payload end.", "url": "https://github.com/apple/servicetalk/pull/1155#discussion_r491244689", "createdAt": "2020-09-19T00:33:44Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/RequestResponseCloseHandler.java", "diffHunk": "@@ -164,7 +164,7 @@ public void protocolPayloadBeginOutbound(final ChannelHandlerContext ctx) {\n \n     @Override\n     public void protocolPayloadEndOutbound(final ChannelHandlerContext ctx) {\n-        if (isClient || has(state, CLOSING)) {\n+        if (isClient || (has(state, CLOSING) && pending == 0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa61c5bc66fc77a3e2b07351a8acc77a770060ba"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92a78e7ea3b39fbfabf59b341a3686502ff75610", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/92a78e7ea3b39fbfabf59b341a3686502ff75610", "committedDate": "2020-09-29T19:03:22Z", "message": "Improve ConnectionCloseHeaderHandlingTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "923a90f4cf8ab6e7d23208e763125b281f6afdd7", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/923a90f4cf8ab6e7d23208e763125b281f6afdd7", "committedDate": "2020-09-29T19:13:03Z", "message": "Rename ProtocolPayloadEndEvent -> OutboundDataEndEvent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3c25afff79d48c64277c89f4ca354f7bdd90f9c", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/f3c25afff79d48c64277c89f4ca354f7bdd90f9c", "committedDate": "2020-09-29T21:21:23Z", "message": "Add ServerRespondsOnClosingTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70700bee32aabfa86ff1183e2437cd94b33c4339", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/70700bee32aabfa86ff1183e2437cd94b33c4339", "committedDate": "2020-09-29T21:49:34Z", "message": "Use TLSv1.2 to workaround #1156"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d60b79dcd6e7fcb1a05d1e1360f29c13ca4f1d61", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/d60b79dcd6e7fcb1a05d1e1360f29c13ca4f1d61", "committedDate": "2020-09-30T05:36:09Z", "message": "Temporary relax some tests until #1141 is merged"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNTIwNDg5", "url": "https://github.com/apple/servicetalk/pull/1155#pullrequestreview-500520489", "createdAt": "2020-10-01T16:26:49Z", "commit": {"oid": "d60b79dcd6e7fcb1a05d1e1360f29c13ca4f1d61"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3490, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}