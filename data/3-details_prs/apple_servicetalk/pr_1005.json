{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5OTk4Mzg0", "number": 1005, "title": "Change when* operators to before* instead of after*", "bodyText": "Motivation:\nThe when* operators provide call backs to take action when that action\nisn't sensitive to execution order. The current implementation of the\nwhen* operators uses after* semantics, despite the order being explicitly\nundefiend by the API. The after* semantics may result in user code\nexecuting in unexpected times, espeically when local state is involved.\nFor example tracing filters utilize AsyncContext and trigger the state\ncleanup on the response payload Publisher termination. This filter must\nbe appended first in order for the trace information to be initialized\ncorrectly and if any subsequent filters apply a payload Publisher\ntransformation with after* semantics the terminal methods will be\ninvoked after the tracing Scope has been closed. If subsequent operators\nuse before* semantics they will not be subject to this ordering issue.\nModifications:\n\nChange Publisher, Single, Completable when* operators to use before*\nsemantics instead of after* semantics.\n\nResult:\nwhen* operators use before* semantics to reduce the risk that local\nstate managed outside the scope of the operator flow is cleaned up when\nuser code executes.", "createdAt": "2020-04-07T02:17:27Z", "url": "https://github.com/apple/servicetalk/pull/1005", "merged": true, "mergeCommit": {"oid": "289f9081c7d761ed83ac56ce05257f68021600e7"}, "closed": true, "closedAt": "2020-04-07T17:33:36Z", "author": {"login": "Scottmitch"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVMrm3gFqTM4ODc5ODc0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVWuYkAFqTM4OTMzNTQ3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4Nzk4NzQw", "url": "https://github.com/apple/servicetalk/pull/1005#pullrequestreview-388798740", "createdAt": "2020-04-07T05:43:41Z", "commit": {"oid": "866181bbf7d57e55f1f52d806c28ce518bbef1f9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNTo0Mzo0MlrOGBzrSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwNTo0Mzo0MlrOGBzrSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU0ODQyNQ==", "bodyText": "Is before not appropriate here as we are sending an error and hence the channel will not be usable?", "url": "https://github.com/apple/servicetalk/pull/1005#discussion_r404548425", "createdAt": "2020-04-07T05:43:42Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-tcp-netty-internal/src/main/java/io/servicetalk/tcp/netty/internal/TcpServerBinder.java", "diffHunk": "@@ -122,7 +122,7 @@ protected void initChannel(Channel channel) {\n                                     // subscribeOn is required to offload calls to connectionAcceptor#accept\n                                     .subscribeOn(executionContext.executor()));\n                 }\n-                connectionSingle.whenOnError(cause -> {\n+                connectionSingle.afterOnError(cause -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "866181bbf7d57e55f1f52d806c28ce518bbef1f9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d80a23bc211e0e240c6f352f1b3d0f20423ac8d3", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/d80a23bc211e0e240c6f352f1b3d0f20423ac8d3", "committedDate": "2020-04-07T17:10:23Z", "message": "Change when* operators to before* instead of after*\n\nMotivation:\nThe when* operators provide call backs to take action when that action\nisn't sensitive to execution order. The current implementation of the\nwhen* operators uses after* semantics, despite the order being explicitly\nundefiend by the API. The after* semantics may result in user code\nexecuting in unexpected times, espeically when local state is involved.\nFor example tracing filters utilize AsyncContext and trigger the state\ncleanup on the response payload Publisher termination. This filter must\nbe appended first in order for the trace information to be initialized\ncorrectly and if any subsequent filters apply a payload Publisher\ntransformation with after* semantics the terminal methods will be\ninvoked after the tracing Scope has been closed. If subsequent operators\nuse before* semantics they will not be subject to this ordering issue.\n\nModifications:\n- Change Publisher, Single, Completable when* operators to use before*\nsemantics instead of after* semantics.\n\nResult:\nwhen* operators use before* semantics to reduce the risk that local\nstate managed outside the scope of the operator flow is cleaned up when\nuser code executes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a59afc69a3473d2a298583930866ee1ff4d91e1b", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/a59afc69a3473d2a298583930866ee1ff4d91e1b", "committedDate": "2020-04-07T17:17:03Z", "message": "review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "866181bbf7d57e55f1f52d806c28ce518bbef1f9", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/866181bbf7d57e55f1f52d806c28ce518bbef1f9", "committedDate": "2020-04-07T02:12:27Z", "message": "Change when* operators to before* instead of after*\n\nMotivation:\nThe when* operators provide call backs to take action when that action\nisn't sensitive to execution order. The current implementation of the\nwhen* operators uses after* semantics, despite the order being explicitly\nundefiend by the API. The after* semantics may result in user code\nexecuting in unexpected times, espeically when local state is involved.\nFor example tracing filters utilize AsyncContext and trigger the state\ncleanup on the response payload Publisher termination. This filter must\nbe appended first in order for the trace information to be initialized\ncorrectly and if any subsequent filters apply a payload Publisher\ntransformation with after* semantics the terminal methods will be\ninvoked after the tracing Scope has been closed. If subsequent operators\nuse before* semantics they will not be subject to this ordering issue.\n\nModifications:\n- Change Publisher, Single, Completable when* operators to use before*\nsemantics instead of after* semantics.\n\nResult:\nwhen* operators use before* semantics to reduce the risk that local\nstate managed outside the scope of the operator flow is cleaned up when\nuser code executes."}, "afterCommit": {"oid": "a59afc69a3473d2a298583930866ee1ff4d91e1b", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/a59afc69a3473d2a298583930866ee1ff4d91e1b", "committedDate": "2020-04-07T17:17:03Z", "message": "review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzM1NDc0", "url": "https://github.com/apple/servicetalk/pull/1005#pullrequestreview-389335474", "createdAt": "2020-04-07T17:27:04Z", "commit": {"oid": "a59afc69a3473d2a298583930866ee1ff4d91e1b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3597, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}