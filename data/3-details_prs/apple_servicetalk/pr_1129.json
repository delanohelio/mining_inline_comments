{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5ODUxNTg1", "number": 1129, "title": "Propagate `SecurityHandshakeObserver` without channel attribute", "bodyText": "Motivation:\nUsage of Channel's attributes increase a shared state of the Channel.\nSecurityHandshakeObserver can be propagated without using it.\nModifications:\n\nWhen SslHandshakeCompletionEvent arrives, look up for\nConnectionObserverHandler to access previously initialized\nSecurityHandshakeObserver;\nAdd SecurityHandshakeObserverTest to verify that\nSecurityHandshakeObserver is working with different configurations:\nHTTP/1.1, HTTP/2, ALPN, secure proxy tunnel;\nImprove TestServiceStreaming to echo content-type header;\n\nResult:\nLess state on the Channel instance.", "createdAt": "2020-08-19T00:31:34Z", "url": "https://github.com/apple/servicetalk/pull/1129", "merged": true, "mergeCommit": {"oid": "d4a869a256f97209a4846c8c7fe4df1d3607b4e3"}, "closed": true, "closedAt": "2020-08-21T04:03:37Z", "author": {"login": "idelpivnitskiy"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAzlUEgFqTQ3MTgwNjYzNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdA7-UPAH2gAyNDY5ODUxNTg1Ojc2YjBkZjEwOTE2ODQ5OTNjZjVlYzhmYzZkYWU0MzA1NWJmMzc2Y2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODA2NjM3", "url": "https://github.com/apple/servicetalk/pull/1129#pullrequestreview-471806637", "createdAt": "2020-08-20T16:49:47Z", "commit": {"oid": "f1d53b46509f53b4ba82b7bae07e604991fbb924"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNjo0OTo0OFrOHEKzPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzoyMjoxNlrOHEL5mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzMzMxMA==", "bodyText": "Debugging leftover?", "url": "https://github.com/apple/servicetalk/pull/1129#discussion_r474133310", "createdAt": "2020-08-20T16:49:48Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-http-netty/src/test/java/io/servicetalk/http/netty/HttpsProxyTest.java", "diffHunk": "@@ -84,7 +83,11 @@ public void tearDown() throws Exception {\n \n     static void safeClose(@Nullable AutoCloseable closeable) {\n         if (closeable != null) {\n-            closeAndReThrowUnchecked(closeable);\n+            try {\n+                closeable.close();\n+            } catch (Exception e) {\n+                e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1d53b46509f53b4ba82b7bae07e604991fbb924"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE1MTMyMw==", "bodyText": "A negative of sending an event is that there is no acknowledgment of receipt which makes debugging harder.\nAn alternative is to follow what we do for DeferSslHandler => lookup the handler and register interest for receiving the observer. The negative is more public API (internal so arguably low) but gives a more determinsitic behavior.", "url": "https://github.com/apple/servicetalk/pull/1129#discussion_r474151323", "createdAt": "2020-08-20T17:22:16Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/DefaultNettyConnection.java", "diffHunk": "@@ -672,7 +680,16 @@ public void channelInactive(ChannelHandlerContext ctx) {\n         }\n \n         private void doChannelActive(ChannelHandlerContext ctx) {\n+            if (active) {\n+                return;\n+            }\n+            active = true;\n+\n             if (waitForSslHandshake) {\n+                if (observer != null) {\n+                    // Notify ConnectionObserverHandler that we are ready to receive SecurityHandshakeObserver instance\n+                    ctx.pipeline().fireUserEventTriggered(WaitingForHandshakeCompletionEvent.INSTANCE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1d53b46509f53b4ba82b7bae07e604991fbb924"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02f9d22817ac2d7cbf20edda762c14db66a465a8", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/02f9d22817ac2d7cbf20edda762c14db66a465a8", "committedDate": "2020-08-20T21:06:01Z", "message": "Propagate `SecurityHandshakeObserver` without channel attribute\n\nMotivation:\n\nUsage of Channel's attributes increase a shared state of the `Channel`.\n`SecurityHandshakeObserver` can be propagated without using it.\n\nModifications:\n\n- Introduce `WaitingForHandshakeCompletionEvent` that is used to notify\n`ConnectionObserverHandler` that the last handler is initialized and\nready to receive `SecurityHandshakeObserver` instance;\n- Propagate `SecurityHandshakeObserver` as user event through the pipeline;\n- Add `SecurityHandshakeObserverTest` to verify that\n`SecurityHandshakeObserver` is working with different configurations:\nHTTP/1.1, HTTP/2, ALPN, secure proxy tunnel;\n- Improve `TestServiceStreaming` to echo content-type header;\n\nResult:\n\nLess state on the `Channel` instance."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28901703beecf24bac3f66161bb803ad8a2c9664", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/28901703beecf24bac3f66161bb803ad8a2c9664", "committedDate": "2020-08-20T21:06:01Z", "message": "Uncomment timeout rule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d2d15ea9d20e48b47c336ff99176ea0431eabf2", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/2d2d15ea9d20e48b47c336ff99176ea0431eabf2", "committedDate": "2020-08-20T22:11:05Z", "message": "Look up for a handler to get access to SecurityHandshakeObserver"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1d53b46509f53b4ba82b7bae07e604991fbb924", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/f1d53b46509f53b4ba82b7bae07e604991fbb924", "committedDate": "2020-08-18T22:59:54Z", "message": "Uncomment timeout rule"}, "afterCommit": {"oid": "2d2d15ea9d20e48b47c336ff99176ea0431eabf2", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/2d2d15ea9d20e48b47c336ff99176ea0431eabf2", "committedDate": "2020-08-20T22:11:05Z", "message": "Look up for a handler to get access to SecurityHandshakeObserver"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMDU4Nzgx", "url": "https://github.com/apple/servicetalk/pull/1129#pullrequestreview-472058781", "createdAt": "2020-08-20T23:54:23Z", "commit": {"oid": "2d2d15ea9d20e48b47c336ff99176ea0431eabf2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMzo1NDoyM1rOHEW_2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMzo1NDoyM1rOHEW_2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzMzE0NA==", "bodyText": "Log at warn if shouldReport is true?", "url": "https://github.com/apple/servicetalk/pull/1129#discussion_r474333144", "createdAt": "2020-08-20T23:54:23Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/NettyPipelineSslUtils.java", "diffHunk": "@@ -54,28 +52,29 @@ public static boolean isSslEnabled(ChannelPipeline pipeline) {\n      * @param pipeline the {@link ChannelPipeline} which contains handler containing the {@link SSLSession}.\n      * @param sslEvent the event indicating a SSL/TLS handshake completed.\n      * @param failureConsumer invoked if a failure is encountered.\n+     * @param shouldReport {@code true} if the handshake status should be reported to {@link SecurityHandshakeObserver}.\n      * @return The {@link SSLSession} or {@code null} if none can be found.\n      */\n     @Nullable\n     public static SSLSession extractSslSessionAndReport(ChannelPipeline pipeline,\n                                                         SslHandshakeCompletionEvent sslEvent,\n-                                                        Consumer<Throwable> failureConsumer) {\n-        final Channel channel = pipeline.channel();\n-        final SecurityHandshakeObserver securityObserver = channel.attr(SECURITY_HANDSHAKE_OBSERVER).get();\n+                                                        Consumer<Throwable> failureConsumer,\n+                                                        boolean shouldReport) {\n+        final SecurityHandshakeObserver observer = shouldReport ? handshakeObserver(pipeline) : null;\n         if (sslEvent.isSuccess()) {\n             final SslHandler sslHandler = pipeline.get(SslHandler.class);\n             if (sslHandler != null) {\n                 final SSLSession session = sslHandler.engine().getSession();\n-                if (securityObserver != null) {\n-                    securityObserver.handshakeComplete(session);\n+                if (observer != null) {\n+                    observer.handshakeComplete(session);\n                 }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d2d15ea9d20e48b47c336ff99176ea0431eabf2"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76b0df1091684993cf5ec8fc6dae43055bf376cc", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/76b0df1091684993cf5ec8fc6dae43055bf376cc", "committedDate": "2020-08-21T03:09:42Z", "message": "fix javadoc issue"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3458, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}