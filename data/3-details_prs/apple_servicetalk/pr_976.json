{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNDg3Mzk4", "number": 976, "title": "NettyChannelPublisher cancel active subscriber should terminate", "bodyText": "Motivation:\nNettyChannelPublisher allows for resubscribes, and delivers queued data to the new Subscriber. If the previous Subscriber consumed some data and cancelled this may lead to the new Subscriber receiveing partial data from the last request.\nModifications:\n\nNettyChannelPublisher should discard any pending data, and deliver an error to new Subscribers if a previously active Subscriber cancels.\n\nResult:\nResubscribes to NettyChannelPublisher won't get partial data for previous requests, like in the case of client pipelinining.", "createdAt": "2020-03-23T16:20:11Z", "url": "https://github.com/apple/servicetalk/pull/976", "merged": true, "mergeCommit": {"oid": "afe0a23af2bf9e12754a6c90bf63a3da1b87ed17"}, "closed": true, "closedAt": "2020-03-26T05:02:10Z", "author": {"login": "Scottmitch"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQgwtPAH2gAyMzkyNDg3Mzk4OjNjZjBhMWM5NzExMWI5NTdmNmMyNjYzNGVmZGEyZmE5NmVkNDBiMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRMBnMgFqTM4MTQzNjYyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3cf0a1c97111b957f6c26634efda2fa96ed40b26", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/3cf0a1c97111b957f6c26634efda2fa96ed40b26", "committedDate": "2020-03-23T16:19:02Z", "message": "NettyChannelPublisher cancel active subscriber should terminate\n\nMotivation:\nNettyChannelPublisher allows for resubscribes, and delivers queued data to the new Subscriber. If the previous Subscriber consumed some data and cancelled this may lead to the new Subscriber receiveing partial data from the last request.\n\nModifications:\n- NettyChannelPublisher should discard any pending data, and deliver an error to new Subscribers if a previously active Subscriber cancels.\n\nResult:\nResubscribes to NettyChannelPublisher won't get partial data for previous requests, like in the case of client pipelinining."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NzAwMzcz", "url": "https://github.com/apple/servicetalk/pull/976#pullrequestreview-379700373", "createdAt": "2020-03-23T18:18:20Z", "commit": {"oid": "3cf0a1c97111b957f6c26634efda2fa96ed40b26"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxODoxODoyMFrOF6SOcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxODoxODoyMFrOF6SOcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY2MDMzNw==", "bodyText": "Can you also add a test that does a channelRead() between cancel() and re-subscribe? That will re-initialize the pending queue.", "url": "https://github.com/apple/servicetalk/pull/976#discussion_r396660337", "createdAt": "2020-03-23T18:18:20Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-transport-netty-internal/src/test/java/io/servicetalk/transport/netty/internal/NettyChannelPublisherTest.java", "diffHunk": "@@ -111,6 +113,27 @@ public void tearDown() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testCancelThenResubscribeDeliversErrorAndNotQueuedData() throws InterruptedException {\n+        TestCollectingPublisherSubscriber<Integer> subscriber1 = new TestCollectingPublisherSubscriber<>();\n+        TestCollectingPublisherSubscriber<Integer> subscriber2 = new TestCollectingPublisherSubscriber<>();\n+        toSource(publisher).subscribe(subscriber1);\n+        Subscription subscription1 = subscriber1.awaitSubscription();\n+        subscription1.request(1);\n+\n+        assertFalse(channel.writeInbound(1));\n+        Integer next = subscriber1.takeOnNext();\n+        assertThat(next, is(1));\n+        assertFalse(channel.writeInbound(2)); // this write should be queued, because there isn't any requestN demand.\n+\n+        subscription1.cancel(); // cancel of active subscription should clear the queue and fail future Subscribers.\n+\n+        toSource(publisher).subscribe(subscriber2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cf0a1c97111b957f6c26634efda2fa96ed40b26"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ebb001e0311bfa10888e2f97eee931cdc12015b", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/5ebb001e0311bfa10888e2f97eee931cdc12015b", "committedDate": "2020-03-23T23:45:47Z", "message": "review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d9adb884a250affef291f438324732f6f79920a", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/1d9adb884a250affef291f438324732f6f79920a", "committedDate": "2020-03-23T23:44:40Z", "message": "review comments"}, "afterCommit": {"oid": "5ebb001e0311bfa10888e2f97eee931cdc12015b", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/5ebb001e0311bfa10888e2f97eee931cdc12015b", "committedDate": "2020-03-23T23:45:47Z", "message": "review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzcwMjg0", "url": "https://github.com/apple/servicetalk/pull/976#pullrequestreview-380770284", "createdAt": "2020-03-24T23:37:45Z", "commit": {"oid": "5ebb001e0311bfa10888e2f97eee931cdc12015b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9b9d85852e388fdccb43e58dbb64559f7be47f8", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/b9b9d85852e388fdccb43e58dbb64559f7be47f8", "committedDate": "2020-03-25T02:56:32Z", "message": "more robust handling of fatalError and queuing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ad4912e9344eb326009e5908f7cd2d9a472e583", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/1ad4912e9344eb326009e5908f7cd2d9a472e583", "committedDate": "2020-03-25T03:47:53Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNDM2NjIx", "url": "https://github.com/apple/servicetalk/pull/976#pullrequestreview-381436621", "createdAt": "2020-03-25T18:43:25Z", "commit": {"oid": "1ad4912e9344eb326009e5908f7cd2d9a472e583"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3752, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}