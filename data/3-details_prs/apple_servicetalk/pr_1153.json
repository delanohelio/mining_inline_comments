{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3NjgxMzQz", "number": 1153, "title": "Unix Domain Sockets HttpClientBuilder fixes", "bodyText": "Motivation:\nUDS is supported by ServicetTalk by passing in a DomainSocketAddress\naddress. However the HttpClientBuilder had some restrictions/assumptions\nabout the address type which prevented its use.\nModifications:\n\nRelax assumptions/restrictions in the HttpClientBuilder to allow for\nDomainSocketAddress\nAdd unit test to demonstrate UDS\nAdd example for UDS\n\nResult:\nUDS client is now working and tested.", "createdAt": "2020-09-16T02:25:35Z", "url": "https://github.com/apple/servicetalk/pull/1153", "merged": true, "mergeCommit": {"oid": "3fba2fe4c125d2c9a5396158891f296b64457f10"}, "closed": true, "closedAt": "2020-09-16T16:46:49Z", "author": {"login": "Scottmitch"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJS4sPAH2gAyNDg3NjgxMzQzOmNjMDVhMmYyYTEzZmEzNjIzNTQ5Nzg2YjRkNDNmYWRmZjEyNDY5NmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJfObNAFqTQ4OTgxMjE1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cc05a2f2a13fa3623549786b4d43fadff124696f", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/cc05a2f2a13fa3623549786b4d43fadff124696f", "committedDate": "2020-09-16T02:22:46Z", "message": "Unix Domain Sockets HttpClientBuilder fixes\n\nMotivation:\nUDS is supported by ServicetTalk by passing in a DomainSocketAddress\naddress. However the HttpClientBuilder had some restrictions/assumptions\nabout the address type which prevented its use.\n\nModifications:\n- Relax assumptions/restrictions in the HttpClientBuilder to allow for\nDomainSocketAddress\n- Add unit test to demonstrate UDS\n- Add example for UDS\n\nResult:\nUDS client is now working and tested."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5Mjc3NTA0", "url": "https://github.com/apple/servicetalk/pull/1153#pullrequestreview-489277504", "createdAt": "2020-09-16T05:06:37Z", "commit": {"oid": "cc05a2f2a13fa3623549786b4d43fadff124696f"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwNTowNjozN1rOHSgSfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwNTo0NDoxM1rOHSg9gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE2NTQzNw==", "bodyText": "Please update the copyright year in all files to 2020.", "url": "https://github.com/apple/servicetalk/pull/1153#discussion_r489165437", "createdAt": "2020-09-16T05:06:37Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-examples/http/uds/build.gradle", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ * Copyright \u00a9 2019 Apple Inc. and the ServiceTalk project authors", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc05a2f2a13fa3623549786b4d43fadff124696f"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE2ODUyOQ==", "bodyText": "May be in a separate PR: can you please remove get prefix from DomainSocketAddress#getPath() method for consistency with other API?", "url": "https://github.com/apple/servicetalk/pull/1153#discussion_r489168529", "createdAt": "2020-09-16T05:17:59Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-examples/http/uds/src/main/java/io/servicetalk/examples/http/uds/blocking/BlockingUdsServer.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright \u00a9 2018 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.examples.http.uds.blocking;\n+\n+import io.servicetalk.http.netty.HttpServers;\n+import io.servicetalk.transport.api.DomainSocketAddress;\n+\n+import java.io.File;\n+\n+import static io.servicetalk.examples.http.uds.blocking.UdsUtils.udsAddress;\n+import static io.servicetalk.http.api.HttpSerializationProviders.textSerializer;\n+\n+/**\n+ * <a href=\"http://man7.org/linux/man-pages/man7/unix.7.html\">AF_UNIX socket</a> server example.\n+ */\n+public final class BlockingUdsServer {\n+    public static void main(String[] args) throws Exception {\n+        DomainSocketAddress udsAddress = udsAddress();\n+        try {\n+            HttpServers.forAddress(udsAddress)\n+                    .listenBlockingAndAwait((ctx, request, responseFactory) ->\n+                            responseFactory.ok().payloadBody(\"Hello World!\", textSerializer()))\n+                    .awaitShutdown();\n+        } finally {\n+            new File(udsAddress.getPath()).delete(); // After the server is done, clean up the file.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc05a2f2a13fa3623549786b4d43fadff124696f"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE3MTMxOQ==", "bodyText": "Consider using File#createTempFile instead of requiring a system property to simplify the example.", "url": "https://github.com/apple/servicetalk/pull/1153#discussion_r489171319", "createdAt": "2020-09-16T05:27:19Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-examples/http/uds/src/main/java/io/servicetalk/examples/http/uds/blocking/UdsUtils.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright \u00a9 2018 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.examples.http.uds.blocking;\n+\n+import io.servicetalk.transport.api.DomainSocketAddress;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+public final class UdsUtils {\n+    /**\n+     * Create a {@link DomainSocketAddress} that is backed by a fixed file such that different JVMs\n+     * can use it to communicate via UDS.\n+     * @return a {@link DomainSocketAddress} that is backed by a fixed file such that different JVMs\n+     * can use it to communicate via UDS.\n+     */\n+    public static DomainSocketAddress udsAddress() {\n+        final String tempDirProp = \"java.io.tmpdir\";\n+        final String tempDir = System.getProperty(tempDirProp);\n+        if (tempDir == null) {\n+            throw new IllegalStateException(\"unable to find \" + tempDirProp + \" in System properties\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc05a2f2a13fa3623549786b4d43fadff124696f"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE3MzMyNw==", "bodyText": "Why the @Nullable required now?", "url": "https://github.com/apple/servicetalk/pull/1153#discussion_r489173327", "createdAt": "2020-09-16T05:34:16Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -495,6 +495,7 @@ HttpExecutionStrategyInfluencer buildStrategyInfluencerForClient(HttpExecutionSt\n         return influencerChainBuilder.buildForClient(strategy);\n     }\n \n+    @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc05a2f2a13fa3623549786b4d43fadff124696f"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE3NjQ1MQ==", "bodyText": "Should R extend SocketAddress?", "url": "https://github.com/apple/servicetalk/pull/1153#discussion_r489176451", "createdAt": "2020-09-16T05:44:13Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -179,9 +179,9 @@ private DefaultSingleAddressHttpClientBuilder(@Nullable final U address,\n                 globalDnsServiceDiscoverer());\n     }\n \n-    static <U> DefaultSingleAddressHttpClientBuilder<U, InetSocketAddress> forResolvedAddress(\n-            final U u, final InetSocketAddress address) {\n-        ServiceDiscoverer<U, InetSocketAddress, ServiceDiscovererEvent<InetSocketAddress>> sd =\n+    static <U, R> DefaultSingleAddressHttpClientBuilder<U, R> forResolvedAddress(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc05a2f2a13fa3623549786b4d43fadff124696f"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bfc17ef16b821306565b59cbead401d0a0cdd2e", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/7bfc17ef16b821306565b59cbead401d0a0cdd2e", "committedDate": "2020-09-16T16:00:48Z", "message": "review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5ODEyMTUx", "url": "https://github.com/apple/servicetalk/pull/1153#pullrequestreview-489812151", "createdAt": "2020-09-16T16:45:22Z", "commit": {"oid": "7bfc17ef16b821306565b59cbead401d0a0cdd2e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3486, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}