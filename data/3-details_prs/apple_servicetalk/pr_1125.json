{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3NjY3Mzc5", "number": 1125, "title": "Remove servicetalk-grpc-gradle-plugin", "bodyText": "Motivation:\nservicetalk-grpc-gradle-plugin currently depends upon\nprotobuf-gradle-plugin. However protobuf-gradle-plugin was not designed\nto be included in other plugins and may result in\nsequencing/initialization issues if it is manually included or included\nby other plugins. protobuf-gradle-plugin\nrecently added support for java protoc plugins\nso we can remove servicetalk-grpc-gradle-plugin and have users directly\nconsume protobuf-gradle-plugin.\nModifications:\n\nRemove servicetalk-grpc-gradle-plugin\nAdjust all usages of servicetalk-grpc-gradle-plugin to directly\nleverage protobuf-gradle-plugin.\n\nResult:\nLess duplicate code, and users directly use\nprotobuf-gradle-plugin to configure all protobuf related items in a\nsingle gradle extension.", "createdAt": "2020-08-13T22:39:42Z", "url": "https://github.com/apple/servicetalk/pull/1125", "merged": true, "mergeCommit": {"oid": "13ee468e39cfecae346a9421d757a321639e8f49"}, "closed": true, "closedAt": "2020-08-25T18:39:14Z", "author": {"login": "Scottmitch"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-n7CRAFqTQ2NzE3Nzk0Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCbhWigH2gAyNDY3NjY3Mzc5OmI2Mjk2ZjE5M2VmMTEwNmY5OTczMmY0YjkwZWQ1Y2QxMTBiOTIyZTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTc3OTQ2", "url": "https://github.com/apple/servicetalk/pull/1125#pullrequestreview-467177946", "createdAt": "2020-08-13T22:40:09Z", "commit": {"oid": "2f24aa2b1419851514d33ab2f8b5ab200e85c3f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMjo0MDoxMFrOHAgE_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMjo0MDoxMFrOHAgE_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI4NzYxMg==", "bodyText": "the build is expected to fail until google/protobuf-gradle-plugin#423 is released", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r470287612", "createdAt": "2020-08-13T22:40:10Z", "author": {"login": "Scottmitch"}, "path": "gradle.properties", "diffHunk": "@@ -52,7 +52,7 @@ apacheDirectoryServerVersion=1.5.7\n commonsLangVersion=2.6\n \n # gRPC\n-protobufGradlePluginVersion=0.8.12\n+protobufGradlePluginVersion=0.8.13", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f24aa2b1419851514d33ab2f8b5ab200e85c3f4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTc4MTYz", "url": "https://github.com/apple/servicetalk/pull/1125#pullrequestreview-467178163", "createdAt": "2020-08-13T22:40:40Z", "commit": {"oid": "2f24aa2b1419851514d33ab2f8b5ab200e85c3f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMjo0MDo0MFrOHAgFwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMjo0MDo0MFrOHAgFwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI4NzgwOQ==", "bodyText": "using file() normalizes the paths for unix/windows (tested locally on macOS / windows)", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r470287809", "createdAt": "2020-08-13T22:40:40Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-examples/grpc/helloworld/build.gradle", "diffHunk": "@@ -14,27 +14,51 @@\n  * limitations under the License.\n  */\n \n+buildscript {\n+  dependencies {\n+    classpath \"com.google.protobuf:protobuf-gradle-plugin:$protobufGradlePluginVersion\"\n+  }\n+}\n+\n apply plugin: \"java\"\n-apply plugin: \"io.servicetalk.servicetalk-grpc-gradle-plugin\"\n+apply plugin: \"com.google.protobuf\"\n apply from: \"../../gradle/idea.gradle\"\n \n dependencies {\n   implementation project(\":servicetalk-annotations\")\n   implementation project(\":servicetalk-grpc-netty\")\n+  implementation project(\":servicetalk-grpc-protoc\")\n   implementation project(\":servicetalk-grpc-protobuf\")\n \n   implementation \"org.slf4j:slf4j-api:$slf4jVersion\"\n   runtimeOnly \"org.apache.logging.log4j:log4j-slf4j-impl:$log4jVersion\"\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"\n+protobuf {\n+  protoc {\n+    artifact = \"com.google.protobuf:protoc:$protobufVersion\"\n+  }\n+  plugins {\n+    servicetalk_grpc {\n+      //// Users are expected to use \"artifact\" instead of \"path\". we use \"path\"\n+      //// only because we want to use the gradle project local version of the plugin\n+      // artifact = \"io.servicetalk:servicetalk-grpc-proto\"$serviceTalkVersion\"\n+      path = file(\"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f24aa2b1419851514d33ab2f8b5ab200e85c3f4"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5030570b6234a974de887d1cd7359286448e5f38", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/5030570b6234a974de887d1cd7359286448e5f38", "committedDate": "2020-08-21T00:11:40Z", "message": "Remove servicetalk-grpc-gradle-plugin\n\nMotivation:\nservicetalk-grpc-gradle-plugin currently depends upon\nprotobuf-gradle-plugin. However protobuf-gradle-plugin was not designed\nto be included in other plugins and may result in\nsequencing/initialization issues if it is manually included or included\nby other plugins. protobuf-gradle-plugin\n[recently added support for java protoc plugins](https://github.com/google/protobuf-gradle-plugin/pull/423)\nso we can remove servicetalk-grpc-gradle-plugin and have users directly\nconsume protobuf-gradle-plugin.\n\nModifications:\n- Remove servicetalk-grpc-gradle-plugin\n- Adjust all usages of servicetalk-grpc-gradle-plugin to directly\nleverage protobuf-gradle-plugin.\n\nResult:\nLess duplicate code, and users directly use\nprotobuf-gradle-plugin to configure all protobuf related items in a\nsingle gradle extension."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f24aa2b1419851514d33ab2f8b5ab200e85c3f4", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/2f24aa2b1419851514d33ab2f8b5ab200e85c3f4", "committedDate": "2020-08-13T22:38:24Z", "message": "Remove servicetalk-grpc-gradle-plugin\n\nMotivation:\nservicetalk-grpc-gradle-plugin currently depends upon\nprotobuf-gradle-plugin. However protobuf-gradle-plugin was not designed\nto be included in other plugins and may result in\nsequencing/initialization issues if it is manually included or included\nby other plugins. protobuf-gradle-plugin\n[recently added support for java protoc plugins](https://github.com/google/protobuf-gradle-plugin/pull/423)\nso we can remove servicetalk-grpc-gradle-plugin and have users directly\nconsume protobuf-gradle-plugin.\n\nModifications:\n- Remove servicetalk-grpc-gradle-plugin\n- Adjust all usages of servicetalk-grpc-gradle-plugin to directly\nleverage protobuf-gradle-plugin.\n\nResult:\nLess duplicate code, and users directly use\nprotobuf-gradle-plugin to configure all protobuf related items in a\nsingle gradle extension."}, "afterCommit": {"oid": "5030570b6234a974de887d1cd7359286448e5f38", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/5030570b6234a974de887d1cd7359286448e5f38", "committedDate": "2020-08-21T00:11:40Z", "message": "Remove servicetalk-grpc-gradle-plugin\n\nMotivation:\nservicetalk-grpc-gradle-plugin currently depends upon\nprotobuf-gradle-plugin. However protobuf-gradle-plugin was not designed\nto be included in other plugins and may result in\nsequencing/initialization issues if it is manually included or included\nby other plugins. protobuf-gradle-plugin\n[recently added support for java protoc plugins](https://github.com/google/protobuf-gradle-plugin/pull/423)\nso we can remove servicetalk-grpc-gradle-plugin and have users directly\nconsume protobuf-gradle-plugin.\n\nModifications:\n- Remove servicetalk-grpc-gradle-plugin\n- Adjust all usages of servicetalk-grpc-gradle-plugin to directly\nleverage protobuf-gradle-plugin.\n\nResult:\nLess duplicate code, and users directly use\nprotobuf-gradle-plugin to configure all protobuf related items in a\nsingle gradle extension."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyODc2ODc4", "url": "https://github.com/apple/servicetalk/pull/1125#pullrequestreview-472876878", "createdAt": "2020-08-22T00:29:06Z", "commit": {"oid": "5030570b6234a974de887d1cd7359286448e5f38"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwMDoyOTowNlrOHFA99w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwMDo0ODowMFrOHFBHxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMDc5MQ==", "bodyText": "We currently generate into $buildDir/generated/source/proto, consider preserving the pre-existing path everywhere.", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r475020791", "createdAt": "2020-08-22T00:29:06Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-examples/grpc/helloworld/build.gradle", "diffHunk": "@@ -14,27 +14,51 @@\n  * limitations under the License.\n  */\n \n+buildscript {\n+  dependencies {\n+    classpath \"com.google.protobuf:protobuf-gradle-plugin:$protobufGradlePluginVersion\"\n+  }\n+}\n+\n apply plugin: \"java\"\n-apply plugin: \"io.servicetalk.servicetalk-grpc-gradle-plugin\"\n+apply plugin: \"com.google.protobuf\"\n apply from: \"../../gradle/idea.gradle\"\n \n dependencies {\n   implementation project(\":servicetalk-annotations\")\n   implementation project(\":servicetalk-grpc-netty\")\n+  implementation project(\":servicetalk-grpc-protoc\")\n   implementation project(\":servicetalk-grpc-protobuf\")\n \n   implementation \"org.slf4j:slf4j-api:$slf4jVersion\"\n   runtimeOnly \"org.apache.logging.log4j:log4j-slf4j-impl:$log4jVersion\"\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"\n+protobuf {\n+  protoc {\n+    artifact = \"com.google.protobuf:protoc:$protobufVersion\"\n+  }\n+  plugins {\n+    servicetalk_grpc {\n+      //// Users are expected to use \"artifact\" instead of \"path\". we use \"path\"\n+      //// only because we want to use the gradle project local version of the plugin\n+      // artifact = \"io.servicetalk:servicetalk-grpc-proto\"$serviceTalkVersion\"\n+      path = file(\"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build\" +\n+                  \"/buildExecutable/servicetalk-grpc-protoc-${project.version}-all.jar\").path\n+    }\n+  }\n+  generateProtoTasks {\n+    all().each { task ->\n+      task.plugins {\n+        servicetalk_grpc {\n+          // Need to tell protobuf-gradle-plugin to output in the correct directory if all generated\n+          // code for a single proto goes to a single file (e.g. \"java_multiple_files = false\" in the .proto).\n+          outputSubDir = \"java\"\n+        }\n+      }\n+    }\n+  }\n+  generatedFilesBaseDir = \"$buildDir/generated/sources\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5030570b6234a974de887d1cd7359286448e5f38"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMTE4NQ==", "bodyText": "Shouldn't block this PR, but would be nice to provide documentation for the new approach in our docs website.", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r475021185", "createdAt": "2020-08-22T00:31:41Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-gradle-plugin/README.adoc", "diffHunk": "@@ -1,74 +0,0 @@\n-= ServiceTalk gRPC Gradle Plugin\n-\n-Gradle plugin for configuring gRPC client and server code generation.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5030570b6234a974de887d1cd7359286448e5f38"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMjc0MQ==", "bodyText": "Why the path is not used for this module anymore?", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r475022741", "createdAt": "2020-08-22T00:43:29Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-protoc/build.gradle", "diffHunk": "@@ -73,14 +72,11 @@ publishing {\n   }\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5030570b6234a974de887d1cd7359286448e5f38"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMzMwMw==", "bodyText": "Looks like protobuf-gradle-plugin does this magic for us, we do not need it anymore. Tried to test ./gradlew idea and it worked fine without this section.", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r475023303", "createdAt": "2020-08-22T00:48:00Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-netty/build.gradle", "diffHunk": "@@ -49,44 +55,42 @@ dependencies {\n   testImplementation \"org.mockito:mockito-core:$mockitoCoreVersion\"\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"\n-}\n-\n-// The following setting must be omitted in users projects and is necessary here\n-// only because we want to use the locally built version of the plugin\n-afterEvaluate {\n-  generateTestProto.dependsOn(\":servicetalk-grpc-protoc:buildExecutable\")\n-}\n-\n-// Configure grpc-java as required by ProtocolCompatibilityTest\n-def generatedBaseDir = \"$projectDir/generated\"\n-\n protobuf {\n+  protoc {\n+    artifact = \"com.google.protobuf:protoc:$protobufVersion\"\n+  }\n   plugins {\n     grpc {\n       artifact = \"io.grpc:protoc-gen-grpc-java:$grpcVersion\"\n     }\n+    servicetalk_grpc {\n+      //// Users are expected to use \"artifact\" instead of \"path\". we use \"path\"\n+      //// only because we want to use the gradle project local version of the plugin\n+      path = file(\"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build\" +\n+                  \"/buildExecutable/servicetalk-grpc-protoc-${project.version}-all.jar\").path\n+    }\n   }\n   generateProtoTasks {\n-    configure(all()) {\n-      project.tasks.ideaModule.dependsOn(it)\n-      plugins {\n+    all().each { task ->\n+      task.plugins {\n         grpc {}\n+        servicetalk_grpc {\n+          outputSubDir = \"java\"\n+        }\n       }\n     }\n   }\n-  generatedFilesBaseDir = generatedBaseDir\n+  generatedFilesBaseDir = \"$buildDir/generated/sources\"\n+}\n+\n+//// The following setting must be omitted in users projects and is necessary here\n+//// only because we want to use the gradle project local version of the plugin\n+afterEvaluate {\n+  generateTestProto.dependsOn(\":servicetalk-grpc-protoc:buildExecutable\")\n }\n \n idea {\n   module {\n-    testSourceDirs += files(\"$generatedBaseDir/source/proto/test/grpc\")\n+    testSourceDirs += files(\"${protobuf.generatedFilesBaseDir}/source/proto/test/grpc\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5030570b6234a974de887d1cd7359286448e5f38"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6296f193ef1106f99732f4b90ed5cd110b922e5", "author": {"user": {"login": "Scottmitch", "name": "Scott Mitchell"}}, "url": "https://github.com/apple/servicetalk/commit/b6296f193ef1106f99732f4b90ed5cd110b922e5", "committedDate": "2020-08-25T18:28:57Z", "message": "review comments and cleanup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3452, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}