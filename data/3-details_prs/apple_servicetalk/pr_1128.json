{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5Nzg5MjY2", "number": 1128, "title": "Improve tests for ALPN", "bodyText": "Motivation:\nAssertions from non-main thread (e.g. inside the service handle method)\ndo not fail the test.\nAlso, existing tests do not verify that SSLSession is set on the client\nside.\nModifications:\n\nAssert server-side state in the main thread;\nAssert that ConnectionContext is set correctly on the client-side;\nAvoid using deprecated jUnit API;\n\nResult:\nBetter test coverage for ALPN use cases.", "createdAt": "2020-08-18T23:06:16Z", "url": "https://github.com/apple/servicetalk/pull/1128", "merged": true, "mergeCommit": {"oid": "dfe9aadbccfce3aa85693a08908cbfdf011cd64e"}, "closed": true, "closedAt": "2020-08-19T00:30:18Z", "author": {"login": "idelpivnitskiy"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAPRM6AH2gAyNDY5Nzg5MjY2OmQxM2U1ZDk4NTdjYWVmZjAzMmI0OGVjNmEzMDhjMzQ2Y2VkMzRjNWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAQUtOAH2gAyNDY5Nzg5MjY2OjJiZGVmMGQ2YTVlYjkwNzUyMTM2OTRmYzFmNDBmMmIxY2M0N2E2MDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d13e5d9857caeff032b48ec6a308c346ced34c5d", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/d13e5d9857caeff032b48ec6a308c346ced34c5d", "committedDate": "2020-08-18T23:04:36Z", "message": "Improve tests for ALPN\n\nMotivation:\n\nAssertions from non-main thread (e.g. inside the service handle method)\ndo not fail the test.\nAlso, existing tests do not verify that `SSLSession` is set on the client\nside.\n\nModifications:\n\n- Assert server-side state in the main thread;\n- Assert that `ConnectionContext` is set correctly on the client-side;\n- Avoid using deprecated jUnit API;\n\nResult:\n\nBetter test coverage for ALPN use cases."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5OTA2OTQy", "url": "https://github.com/apple/servicetalk/pull/1128#pullrequestreview-469906942", "createdAt": "2020-08-18T23:58:46Z", "commit": {"oid": "d13e5d9857caeff032b48ec6a308c346ced34c5d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMzo1ODo0NlrOHCqo-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMzo1ODo0NlrOHCqo-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1NzgxNg==", "bodyText": "Overwrites like this causes debugging pain if inadvertently multiple requests are sent to the service.\nI find it useful to instead use a BlockingQueue to track requests which gives an additional benefit of being able to wait for a request to be received by the server. However, YMMV", "url": "https://github.com/apple/servicetalk/pull/1128#discussion_r472557816", "createdAt": "2020-08-18T23:58:46Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-http-netty/src/test/java/io/servicetalk/http/netty/AlpnClientAndServerTest.java", "diffHunk": "@@ -110,19 +112,16 @@ public AlpnClientAndServerTest(List<String> serverSideProtocols,\n         });\n     }\n \n-    private static ServerContext startServer(List<String> supportedProtocols,\n-                                             @Nullable HttpProtocolVersion expectedProtocol) throws Exception {\n+    private ServerContext startServer(List<String> supportedProtocols,\n+                                      @Nullable HttpProtocolVersion expectedProtocol) throws Exception {\n         return HttpServers.forAddress(localAddress(0))\n                 .protocols(toProtocolConfigs(supportedProtocols))\n                 .secure()\n                 .provider(OPENSSL)\n                 .commit(DefaultTestCerts::loadServerPem, DefaultTestCerts::loadServerKey)\n                 .listenBlocking((ctx, request, responseFactory) -> {\n-                    if (\"PRI\".equals(request.method().name()) && expectedProtocol == null) {\n-                        return responseFactory.badRequest();\n-                    }\n-                    assertThat(request.version(), is(expectedProtocol));\n-                    assertThat(ctx.sslSession(), is(notNullValue()));\n+                    serviceContext.set(ctx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d13e5d9857caeff032b48ec6a308c346ced34c5d"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bdef0d6a5eb9075213694fc1f40f2b1cc47a608", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/2bdef0d6a5eb9075213694fc1f40f2b1cc47a608", "committedDate": "2020-08-19T00:18:20Z", "message": "Use BlockingQueue instead of AtomicReference"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3455, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}