{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3NjY3Mzc5", "number": 1125, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMjo0MDowOVrOEYQqtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwMDo0ODowMFrOEbKhjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzODc0MzU5OnYy", "diffSide": "RIGHT", "path": "gradle.properties", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMjo0MDoxMFrOHAgE_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMjo0MDoxMFrOHAgE_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI4NzYxMg==", "bodyText": "the build is expected to fail until google/protobuf-gradle-plugin#423 is released", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r470287612", "createdAt": "2020-08-13T22:40:10Z", "author": {"login": "Scottmitch"}, "path": "gradle.properties", "diffHunk": "@@ -52,7 +52,7 @@ apacheDirectoryServerVersion=1.5.7\n commonsLangVersion=2.6\n \n # gRPC\n-protobufGradlePluginVersion=0.8.12\n+protobufGradlePluginVersion=0.8.13", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f24aa2b1419851514d33ab2f8b5ab200e85c3f4"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzODc0NTAwOnYy", "diffSide": "RIGHT", "path": "servicetalk-examples/grpc/helloworld/build.gradle", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMjo0MDo0MFrOHAgFwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMjo0MDo0MFrOHAgFwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI4NzgwOQ==", "bodyText": "using file() normalizes the paths for unix/windows (tested locally on macOS / windows)", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r470287809", "createdAt": "2020-08-13T22:40:40Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-examples/grpc/helloworld/build.gradle", "diffHunk": "@@ -14,27 +14,51 @@\n  * limitations under the License.\n  */\n \n+buildscript {\n+  dependencies {\n+    classpath \"com.google.protobuf:protobuf-gradle-plugin:$protobufGradlePluginVersion\"\n+  }\n+}\n+\n apply plugin: \"java\"\n-apply plugin: \"io.servicetalk.servicetalk-grpc-gradle-plugin\"\n+apply plugin: \"com.google.protobuf\"\n apply from: \"../../gradle/idea.gradle\"\n \n dependencies {\n   implementation project(\":servicetalk-annotations\")\n   implementation project(\":servicetalk-grpc-netty\")\n+  implementation project(\":servicetalk-grpc-protoc\")\n   implementation project(\":servicetalk-grpc-protobuf\")\n \n   implementation \"org.slf4j:slf4j-api:$slf4jVersion\"\n   runtimeOnly \"org.apache.logging.log4j:log4j-slf4j-impl:$log4jVersion\"\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"\n+protobuf {\n+  protoc {\n+    artifact = \"com.google.protobuf:protoc:$protobufVersion\"\n+  }\n+  plugins {\n+    servicetalk_grpc {\n+      //// Users are expected to use \"artifact\" instead of \"path\". we use \"path\"\n+      //// only because we want to use the gradle project local version of the plugin\n+      // artifact = \"io.servicetalk:servicetalk-grpc-proto\"$serviceTalkVersion\"\n+      path = file(\"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f24aa2b1419851514d33ab2f8b5ab200e85c3f4"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2OTE3NTMzOnYy", "diffSide": "RIGHT", "path": "servicetalk-examples/grpc/helloworld/build.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwMDoyOTowNlrOHFA99w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxODoyODo0NlrOHGknXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMDc5MQ==", "bodyText": "We currently generate into $buildDir/generated/source/proto, consider preserving the pre-existing path everywhere.", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r475020791", "createdAt": "2020-08-22T00:29:06Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-examples/grpc/helloworld/build.gradle", "diffHunk": "@@ -14,27 +14,51 @@\n  * limitations under the License.\n  */\n \n+buildscript {\n+  dependencies {\n+    classpath \"com.google.protobuf:protobuf-gradle-plugin:$protobufGradlePluginVersion\"\n+  }\n+}\n+\n apply plugin: \"java\"\n-apply plugin: \"io.servicetalk.servicetalk-grpc-gradle-plugin\"\n+apply plugin: \"com.google.protobuf\"\n apply from: \"../../gradle/idea.gradle\"\n \n dependencies {\n   implementation project(\":servicetalk-annotations\")\n   implementation project(\":servicetalk-grpc-netty\")\n+  implementation project(\":servicetalk-grpc-protoc\")\n   implementation project(\":servicetalk-grpc-protobuf\")\n \n   implementation \"org.slf4j:slf4j-api:$slf4jVersion\"\n   runtimeOnly \"org.apache.logging.log4j:log4j-slf4j-impl:$log4jVersion\"\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"\n+protobuf {\n+  protoc {\n+    artifact = \"com.google.protobuf:protoc:$protobufVersion\"\n+  }\n+  plugins {\n+    servicetalk_grpc {\n+      //// Users are expected to use \"artifact\" instead of \"path\". we use \"path\"\n+      //// only because we want to use the gradle project local version of the plugin\n+      // artifact = \"io.servicetalk:servicetalk-grpc-proto\"$serviceTalkVersion\"\n+      path = file(\"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build\" +\n+                  \"/buildExecutable/servicetalk-grpc-protoc-${project.version}-all.jar\").path\n+    }\n+  }\n+  generateProtoTasks {\n+    all().each { task ->\n+      task.plugins {\n+        servicetalk_grpc {\n+          // Need to tell protobuf-gradle-plugin to output in the correct directory if all generated\n+          // code for a single proto goes to a single file (e.g. \"java_multiple_files = false\" in the .proto).\n+          outputSubDir = \"java\"\n+        }\n+      }\n+    }\n+  }\n+  generatedFilesBaseDir = \"$buildDir/generated/sources\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5030570b6234a974de887d1cd7359286448e5f38"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY1MzQwNQ==", "bodyText": "I'll target sources (the plural form) as there is other tooling that also targets this directory, but adding proto to de-dup sounds good.", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r476653405", "createdAt": "2020-08-25T18:28:46Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-examples/grpc/helloworld/build.gradle", "diffHunk": "@@ -14,27 +14,51 @@\n  * limitations under the License.\n  */\n \n+buildscript {\n+  dependencies {\n+    classpath \"com.google.protobuf:protobuf-gradle-plugin:$protobufGradlePluginVersion\"\n+  }\n+}\n+\n apply plugin: \"java\"\n-apply plugin: \"io.servicetalk.servicetalk-grpc-gradle-plugin\"\n+apply plugin: \"com.google.protobuf\"\n apply from: \"../../gradle/idea.gradle\"\n \n dependencies {\n   implementation project(\":servicetalk-annotations\")\n   implementation project(\":servicetalk-grpc-netty\")\n+  implementation project(\":servicetalk-grpc-protoc\")\n   implementation project(\":servicetalk-grpc-protobuf\")\n \n   implementation \"org.slf4j:slf4j-api:$slf4jVersion\"\n   runtimeOnly \"org.apache.logging.log4j:log4j-slf4j-impl:$log4jVersion\"\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"\n+protobuf {\n+  protoc {\n+    artifact = \"com.google.protobuf:protoc:$protobufVersion\"\n+  }\n+  plugins {\n+    servicetalk_grpc {\n+      //// Users are expected to use \"artifact\" instead of \"path\". we use \"path\"\n+      //// only because we want to use the gradle project local version of the plugin\n+      // artifact = \"io.servicetalk:servicetalk-grpc-proto\"$serviceTalkVersion\"\n+      path = file(\"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build\" +\n+                  \"/buildExecutable/servicetalk-grpc-protoc-${project.version}-all.jar\").path\n+    }\n+  }\n+  generateProtoTasks {\n+    all().each { task ->\n+      task.plugins {\n+        servicetalk_grpc {\n+          // Need to tell protobuf-gradle-plugin to output in the correct directory if all generated\n+          // code for a single proto goes to a single file (e.g. \"java_multiple_files = false\" in the .proto).\n+          outputSubDir = \"java\"\n+        }\n+      }\n+    }\n+  }\n+  generatedFilesBaseDir = \"$buildDir/generated/sources\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMDc5MQ=="}, "originalCommit": {"oid": "5030570b6234a974de887d1cd7359286448e5f38"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2OTE3ODM3OnYy", "diffSide": "LEFT", "path": "servicetalk-grpc-gradle-plugin/README.adoc", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwMDozMTo0MVrOHFA_gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwMDozMTo0MVrOHFA_gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMTE4NQ==", "bodyText": "Shouldn't block this PR, but would be nice to provide documentation for the new approach in our docs website.", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r475021185", "createdAt": "2020-08-22T00:31:41Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-gradle-plugin/README.adoc", "diffHunk": "@@ -1,74 +0,0 @@\n-= ServiceTalk gRPC Gradle Plugin\n-\n-Gradle plugin for configuring gRPC client and server code generation.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5030570b6234a974de887d1cd7359286448e5f38"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2OTE5MDE4OnYy", "diffSide": "LEFT", "path": "servicetalk-grpc-protoc/build.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwMDo0MzoyOVrOHFBFlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzo1Njo0MFrOHGjibA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMjc0MQ==", "bodyText": "Why the path is not used for this module anymore?", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r475022741", "createdAt": "2020-08-22T00:43:29Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-protoc/build.gradle", "diffHunk": "@@ -73,14 +72,11 @@ publishing {\n   }\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5030570b6234a974de887d1cd7359286448e5f38"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYzNTc1Ng==", "bodyText": "good question. there were no tests to validate the results of the generated code so the build passes without this. I will add some tests.", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r476635756", "createdAt": "2020-08-25T17:56:40Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-grpc-protoc/build.gradle", "diffHunk": "@@ -73,14 +72,11 @@ publishing {\n   }\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMjc0MQ=="}, "originalCommit": {"oid": "5030570b6234a974de887d1cd7359286448e5f38"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2OTE5NDM4OnYy", "diffSide": "RIGHT", "path": "servicetalk-grpc-netty/build.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwMDo0ODowMFrOHFBHxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxODowNTo0NVrOHGj2ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMzMwMw==", "bodyText": "Looks like protobuf-gradle-plugin does this magic for us, we do not need it anymore. Tried to test ./gradlew idea and it worked fine without this section.", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r475023303", "createdAt": "2020-08-22T00:48:00Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-netty/build.gradle", "diffHunk": "@@ -49,44 +55,42 @@ dependencies {\n   testImplementation \"org.mockito:mockito-core:$mockitoCoreVersion\"\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"\n-}\n-\n-// The following setting must be omitted in users projects and is necessary here\n-// only because we want to use the locally built version of the plugin\n-afterEvaluate {\n-  generateTestProto.dependsOn(\":servicetalk-grpc-protoc:buildExecutable\")\n-}\n-\n-// Configure grpc-java as required by ProtocolCompatibilityTest\n-def generatedBaseDir = \"$projectDir/generated\"\n-\n protobuf {\n+  protoc {\n+    artifact = \"com.google.protobuf:protoc:$protobufVersion\"\n+  }\n   plugins {\n     grpc {\n       artifact = \"io.grpc:protoc-gen-grpc-java:$grpcVersion\"\n     }\n+    servicetalk_grpc {\n+      //// Users are expected to use \"artifact\" instead of \"path\". we use \"path\"\n+      //// only because we want to use the gradle project local version of the plugin\n+      path = file(\"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build\" +\n+                  \"/buildExecutable/servicetalk-grpc-protoc-${project.version}-all.jar\").path\n+    }\n   }\n   generateProtoTasks {\n-    configure(all()) {\n-      project.tasks.ideaModule.dependsOn(it)\n-      plugins {\n+    all().each { task ->\n+      task.plugins {\n         grpc {}\n+        servicetalk_grpc {\n+          outputSubDir = \"java\"\n+        }\n       }\n     }\n   }\n-  generatedFilesBaseDir = generatedBaseDir\n+  generatedFilesBaseDir = \"$buildDir/generated/sources\"\n+}\n+\n+//// The following setting must be omitted in users projects and is necessary here\n+//// only because we want to use the gradle project local version of the plugin\n+afterEvaluate {\n+  generateTestProto.dependsOn(\":servicetalk-grpc-protoc:buildExecutable\")\n }\n \n idea {\n   module {\n-    testSourceDirs += files(\"$generatedBaseDir/source/proto/test/grpc\")\n+    testSourceDirs += files(\"${protobuf.generatedFilesBaseDir}/source/proto/test/grpc\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5030570b6234a974de887d1cd7359286448e5f38"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0MDkyNg==", "bodyText": "sounds good \u2702\ufe0f", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r476640926", "createdAt": "2020-08-25T18:05:45Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-grpc-netty/build.gradle", "diffHunk": "@@ -49,44 +55,42 @@ dependencies {\n   testImplementation \"org.mockito:mockito-core:$mockitoCoreVersion\"\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"\n-}\n-\n-// The following setting must be omitted in users projects and is necessary here\n-// only because we want to use the locally built version of the plugin\n-afterEvaluate {\n-  generateTestProto.dependsOn(\":servicetalk-grpc-protoc:buildExecutable\")\n-}\n-\n-// Configure grpc-java as required by ProtocolCompatibilityTest\n-def generatedBaseDir = \"$projectDir/generated\"\n-\n protobuf {\n+  protoc {\n+    artifact = \"com.google.protobuf:protoc:$protobufVersion\"\n+  }\n   plugins {\n     grpc {\n       artifact = \"io.grpc:protoc-gen-grpc-java:$grpcVersion\"\n     }\n+    servicetalk_grpc {\n+      //// Users are expected to use \"artifact\" instead of \"path\". we use \"path\"\n+      //// only because we want to use the gradle project local version of the plugin\n+      path = file(\"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build\" +\n+                  \"/buildExecutable/servicetalk-grpc-protoc-${project.version}-all.jar\").path\n+    }\n   }\n   generateProtoTasks {\n-    configure(all()) {\n-      project.tasks.ideaModule.dependsOn(it)\n-      plugins {\n+    all().each { task ->\n+      task.plugins {\n         grpc {}\n+        servicetalk_grpc {\n+          outputSubDir = \"java\"\n+        }\n       }\n     }\n   }\n-  generatedFilesBaseDir = generatedBaseDir\n+  generatedFilesBaseDir = \"$buildDir/generated/sources\"\n+}\n+\n+//// The following setting must be omitted in users projects and is necessary here\n+//// only because we want to use the gradle project local version of the plugin\n+afterEvaluate {\n+  generateTestProto.dependsOn(\":servicetalk-grpc-protoc:buildExecutable\")\n }\n \n idea {\n   module {\n-    testSourceDirs += files(\"$generatedBaseDir/source/proto/test/grpc\")\n+    testSourceDirs += files(\"${protobuf.generatedFilesBaseDir}/source/proto/test/grpc\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMzMwMw=="}, "originalCommit": {"oid": "5030570b6234a974de887d1cd7359286448e5f38"}, "originalPosition": 80}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2541, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}