{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzMDg3NTU4", "number": 1146, "title": "Support batched service discoverer updates", "bodyText": "Motivation\nServiceDiscoverer#discover() returns a Publisher<ServiceDiscovererEvent> where each ServiceDiscovererEvent contains the state of a single address. Clients always retry service discovery failures assuming transient failures but try to hold on to the last known addresses till a subsequent successful discover() call.  Upon a subsequent successful call; the client then has to decide after how many addresses should the old cache be disposed to reduce churn associated by deactivating an address and then subsequently activating again. Today this is done with heuristics around percentage address received between failed and successful discover call.\nIf we implement batch service discoverer events where a ServiceDiscoverer implementation can send all known addresses in one batch then the above mentioned heuristics can be removed.\nModification\n\nModify ServiceDiscoverer#discover() to return a Publisher<List<ServiceDiscovererEvent<ResolvedAddress>>>\nModify DefaultServiceDiscoveryRetryStrategy to enable/disable retention of addresses between retries as opposed to the percent based heuristics.\n\nResult\nDeterministic caching of addresses on service discoverer failures.", "createdAt": "2020-09-09T19:36:46Z", "url": "https://github.com/apple/servicetalk/pull/1146", "merged": true, "mergeCommit": {"oid": "fd873e8c5340d0394d43df56a7d9e7c4d3bd2f28"}, "closed": true, "closedAt": "2020-09-17T23:01:59Z", "author": {"login": "NiteshKant"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFuPqkAH2gAyNDgzMDg3NTU4OjlmZjA3YTFkNzVhMTQ5MDM1YjAzOWEzZGUxMzQyM2U0ZDQwN2M0ODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJ0birAFqTQ5MDgzMDMyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9ff07a1d75a149035b039a3de13423e4d407c488", "author": {"user": {"login": "NiteshKant", "name": "Nitesh Kant"}}, "url": "https://github.com/apple/servicetalk/commit/9ff07a1d75a149035b039a3de13423e4d407c488", "committedDate": "2020-09-04T23:59:36Z", "message": "Simplify ServiceDiscoverer generics in client builders\n\n__Motivation__\n\n`SingleAddressHttpClientBuilder` is used as a template for partitioned and multi-address builders for which SD event types is different. Although, users are not expected to use a ServiceDiscoverer with different event type, we accommodate this usage in our public APIs. Accomodating this usage further trickles down to builder implementation and the external facing `ServiceDiscoveryRetryStrategy`. It also complicates generic handling whenever we change `ServiceDiscoverer` APIs.\nFurther the partitioned builder uncheck casts the service discovery stream while using which hides type issues.\n\n__Modification__\n\n - Remove the `? extends` in the `ServiceDiscoverer` event type while accepting a `ServiceDiscoverer` in the builders. When a different event type is required (partitioned builder), store the `ServiceDiscoverer` locally.\n - Simplify `ServiceDiscoveryRetryStrategy` generics.\n\n __Result__\n\n Less generics clutter in public APIs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f37798bd3e914a990f7a283cbe395fe3960078df", "author": {"user": {"login": "NiteshKant", "name": "Nitesh Kant"}}, "url": "https://github.com/apple/servicetalk/commit/f37798bd3e914a990f7a283cbe395fe3960078df", "committedDate": "2020-09-09T19:34:35Z", "message": "Support batched service discoverer updates\n\n__Motivation__\n\n`ServiceDiscoverer#discover()` returns a `Publisher<ServiceDiscovererEvent>` where each `ServiceDiscovererEvent` contains the state of a single address. Clients always retry service discovery failures assuming transient failures but try to hold on to the last known addresses till a subsequent successful `discover()` call.  Upon a subsequent successful call; the client then has to decide after how many addresses should the old cache be disposed to reduce churn associated by deactivating an address and then subsequently activating again. Today this is done with heuristics around percentage address received between failed and successful discover call.\n\nIf we implement batch service discoverer events where a ServiceDiscoverer implementation can send all known addresses in one batch then the above mentioned heuristics can be removed.\n\n__Modification__\n\n- Modify `ServiceDiscoverer#discover()` to return a `Publisher<List<ServiceDiscovererEvent<ResolvedAddress>>>`\n- Modify `DefaultServiceDiscoveryRetryStrategy` to enable/disable retention of addresses between retries as opposed to the percent based heuristics.\n\n__Result__\n\nDeterministic caching of addresses on service discoverer failures."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NDk3OTU3", "url": "https://github.com/apple/servicetalk/pull/1146#pullrequestreview-485497957", "createdAt": "2020-09-10T01:03:39Z", "commit": {"oid": "f37798bd3e914a990f7a283cbe395fe3960078df"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwMTowMzo0MFrOHPfP5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwMTozOToyNFrOHPf0Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwMjY2MA==", "bodyText": "Do we need a List? Will Collection be enough?", "url": "https://github.com/apple/servicetalk/pull/1146#discussion_r486002660", "createdAt": "2020-09-10T01:03:40Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/ServiceDiscoverer.java", "diffHunk": "@@ -47,5 +49,5 @@\n      * </ul>\n      * @return a {@link Publisher} that represents a stream of events from the service discovery system.\n      */\n-    Publisher<E> discover(UnresolvedAddress address);\n+    Publisher<List<E>> discover(UnresolvedAddress address);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37798bd3e914a990f7a283cbe395fe3960078df"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAxMTk5OA==", "bodyText": "If we change public API of SD to emit List of addresses, should we also change LB factory API to use the same API for eventPublisher? Looks a bit weird do have these API different.", "url": "https://github.com/apple/servicetalk/pull/1146#discussion_r486011998", "createdAt": "2020-09-10T01:39:24Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -263,8 +255,9 @@ public StreamingHttpClient buildStreaming() {\n         // Track resources that potentially need to be closed when an exception is thrown during buildStreaming\n         final CompositeCloseable closeOnException = newCompositeCloseable();\n         try {\n-            final SdStatusCompletable sdStatus = new SdStatusCompletable();\n-            final Publisher<? extends ServiceDiscovererEvent<R>> sdEvents = ctx.discover(sdStatus);\n+\n+            final Publisher<ServiceDiscovererEvent<R>> sdEvents =\n+                    ctx.serviceDiscoverer.discover(ctx.address()).flatMapConcatIterable(identity());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37798bd3e914a990f7a283cbe395fe3960078df"}, "originalPosition": 113}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93e9d4f7ea89a773c5adfec708c04bc398bba44d", "author": {"user": {"login": "NiteshKant", "name": "Nitesh Kant"}}, "url": "https://github.com/apple/servicetalk/commit/93e9d4f7ea89a773c5adfec708c04bc398bba44d", "committedDate": "2020-09-10T20:19:29Z", "message": "Review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb2a165bb6e1a252937f0d9152e2cd9205a4f3c6", "author": {"user": {"login": "NiteshKant", "name": "Nitesh Kant"}}, "url": "https://github.com/apple/servicetalk/commit/bb2a165bb6e1a252937f0d9152e2cd9205a4f3c6", "committedDate": "2020-09-10T20:41:57Z", "message": "Merge remote-tracking branch 'upstream/main' into sd-batch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b025acbace78bd17b2ff04d37e81ce0387964552", "author": {"user": {"login": "NiteshKant", "name": "Nitesh Kant"}}, "url": "https://github.com/apple/servicetalk/commit/b025acbace78bd17b2ff04d37e81ce0387964552", "committedDate": "2020-09-10T20:52:14Z", "message": "Review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "272968e72d8afdba76865daa82af92c23b4b8dc8", "author": {"user": {"login": "NiteshKant", "name": "Nitesh Kant"}}, "url": "https://github.com/apple/servicetalk/commit/272968e72d8afdba76865daa82af92c23b4b8dc8", "committedDate": "2020-09-17T02:14:01Z", "message": "Merge remote-tracking branch 'upstream/main' into sd-batch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "787c512a3f39ec28607a1af19817b39633fd8930", "author": {"user": {"login": "NiteshKant", "name": "Nitesh Kant"}}, "url": "https://github.com/apple/servicetalk/commit/787c512a3f39ec28607a1af19817b39633fd8930", "committedDate": "2020-09-17T02:29:34Z", "message": "Rebase to main"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwODMwMzIy", "url": "https://github.com/apple/servicetalk/pull/1146#pullrequestreview-490830322", "createdAt": "2020-09-17T17:27:42Z", "commit": {"oid": "787c512a3f39ec28607a1af19817b39633fd8930"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3476, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}