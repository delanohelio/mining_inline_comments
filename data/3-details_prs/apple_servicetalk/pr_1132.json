{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxNTMzNDUz", "number": 1132, "title": "Provide informative exceptions upon gRPC calls when plain h2/h1 resp", "bodyText": "Motivation:\nWhen an h1/h2 response comes back, not following the gRPC protocol (eg. due to proxy error), the exception thrown to the client is not informative. It only mentions that a grpc-status wasn't found.\nWe can improve this to include the HTTP status code along side the header names to help identify what went wrong.\nModifications:\nIntroduced a new function that validates the content type. If an HTML type is found (text/plain or text/html) we throw the new more informative error. The check happens both for headers & trailers.\nResult:\nBefore\nio.servicetalk.grpc.api.GrpcStatusException: INTERNAL: Response does not contain grpc-status header or trailer\n\nAfter\nio.servicetalk.grpc.api.GrpcStatusException: INTERNAL: HTTP  status code: 400 Bad Request\n\tinvalid content-type: text/plain; charset=UTF-8\n\theaders: NettyH2HeadersToHttpHeaders[content-type: <filtered>\ncontent-length: <filtered>\ntransfer-encoding: <filtered>]\n\nFixes: #1119", "createdAt": "2020-08-21T09:52:28Z", "url": "https://github.com/apple/servicetalk/pull/1132", "merged": true, "mergeCommit": {"oid": "bed2706f8808e1cba46e008879f77d08df657f37"}, "closed": true, "closedAt": "2020-09-09T19:26:17Z", "author": {"login": "tkountis"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBBTLqgH2gAyNDcxNTMzNDUzOmM3MGVmMzBjMDdkNjY1ZjcyODNjZjlkNGI3NWIyMjc3N2FlNWQ0N2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHQka5AFqTQ4NTI5MTQ2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/c70ef30c07d665f7283cf9d4b75b22777ae5d47b", "committedDate": "2020-08-21T09:22:01Z", "message": "Provide informative exceptions upon gRPC calls when plain h2/h1 resp"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMzU5NzQ2", "url": "https://github.com/apple/servicetalk/pull/1132#pullrequestreview-472359746", "createdAt": "2020-08-21T09:53:57Z", "commit": {"oid": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwOTo1Mzo1OFrOHEnGWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwOTo1NToxOVrOHEnKlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU5Njk1Mw==", "bodyText": "nit: final", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r474596953", "createdAt": "2020-08-21T09:53:58Z", "author": {"login": "normanmaurer"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -347,4 +356,37 @@ protected HttpHeaders payloadComplete(final HttpHeaders trailers) {\n             return trailers;\n         }\n     }\n+\n+    static class EnsureValidGrpcResponseTransformer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU5ODAzOA==", "bodyText": "seems like this field is never used which means you could most likely just make this implementation a singleton and so reduce GC ?", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r474598038", "createdAt": "2020-08-21T09:55:19Z", "author": {"login": "normanmaurer"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -347,4 +356,37 @@ protected HttpHeaders payloadComplete(final HttpHeaders trailers) {\n             return trailers;\n         }\n     }\n+\n+    static class EnsureValidGrpcResponseTransformer\n+            implements TrailersTransformer<Object, Object> {\n+\n+        private final HttpResponseStatus status;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNjYxMjA0", "url": "https://github.com/apple/servicetalk/pull/1132#pullrequestreview-472661204", "createdAt": "2020-08-21T17:20:36Z", "commit": {"oid": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNzoyMDozNlrOHE1L6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNzoyNDo1N1rOHE1Udg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyNzc1NQ==", "bodyText": "I think this change isn't needed anymore, the new transformer also does the same thing.", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r474827755", "createdAt": "2020-08-21T17:20:36Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -63,14 +65,6 @@\n     private static final CharSequence IDENTITY = newAsciiString(None.encoding());\n     private static final CharSequence GRPC_MESSAGE_ENCODING_KEY = newAsciiString(\"grpc-encoding\");\n     private static final GrpcStatus STATUS_OK = GrpcStatus.fromCodeValue(GrpcStatusCode.OK.value());\n-    private static final TrailersTransformer<Object, Object> ENSURE_GRPC_STATUS_RECEIVED =\n-            new StatelessTrailersTransformer<Object>() {\n-        @Override\n-        protected HttpHeaders payloadComplete(final HttpHeaders trailers) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyODI1NQ==", "bodyText": "rename to ensureGrpcContentType?", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r474828255", "createdAt": "2020-08-21T17:21:36Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -185,16 +183,27 @@ static void setStatus(final HttpHeaders trailers, final Throwable cause, final B\n         }\n \n         // There was no grpc-status in the trailers, so it must be in headers.\n-        ensureGrpcStatusReceived(response.headers());\n+        ensureGrpcStatusReceived(headers);\n         return response.payloadBody(deserializer);\n     }\n \n+    private static void ensureNotPlainHtmlResponse(final HttpResponseStatus status,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyOTk0Mg==", "bodyText": "We should also add some positive tests when the content type is correct with and without the charset.", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r474829942", "createdAt": "2020-08-21T17:24:57Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/netty/HtmlResponseUponGrpcRequestTest.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.grpc.netty;\n+\n+import io.servicetalk.grpc.api.GrpcStatusCode;\n+import io.servicetalk.grpc.api.GrpcStatusException;\n+import io.servicetalk.grpc.netty.TesterProto.TestRequest;\n+import io.servicetalk.http.netty.HttpServers;\n+import io.servicetalk.transport.api.ServerContext;\n+\n+import org.junit.Test;\n+import org.junit.function.ThrowingRunnable;\n+\n+import java.util.concurrent.ExecutionException;\n+\n+import static io.servicetalk.concurrent.api.Publisher.from;\n+import static io.servicetalk.concurrent.api.Single.succeeded;\n+import static io.servicetalk.grpc.api.GrpcExecutionStrategies.noOffloadsStrategy;\n+import static io.servicetalk.http.api.HttpSerializationProviders.textSerializer;\n+import static io.servicetalk.http.netty.HttpProtocolConfigs.h2Default;\n+import static io.servicetalk.transport.netty.internal.AddressUtils.localAddress;\n+import static io.servicetalk.transport.netty.internal.AddressUtils.serverHostAndPort;\n+import static java.util.Collections.singletonList;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.instanceOf;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.notNullValue;\n+import static org.junit.Assert.assertThrows;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class HtmlResponseUponGrpcRequestTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyODcxNDUy", "url": "https://github.com/apple/servicetalk/pull/1132#pullrequestreview-472871452", "createdAt": "2020-08-22T00:00:43Z", "commit": {"oid": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwMDowMDo0M1rOHFAp6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwMDoxMjozOVrOHFA0lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAxNTY1OA==", "bodyText": "nit: shifted indentation", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r475015658", "createdAt": "2020-08-22T00:00:43Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/HeaderUtils.java", "diffHunk": "@@ -647,7 +647,7 @@ private HttpCookiePair findNext(CharSequence cookieHeaderValue) {\n      * the provided charset has been found, {@code false} otherwise.\n      * @see <a href=\"https://tools.ietf.org/html/rfc2045#section-5.1\">Syntax of the Content-Type Header Field</a>\n      */\n-    static boolean hasContentType(final HttpHeaders headers,\n+    public static boolean hasContentType(final HttpHeaders headers,\n                                   final CharSequence expectedContentType,\n                                   @Nullable final Charset expectedCharset) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAxNTk0OQ==", "bodyText": "If we don't have a need for noOffloadsStrategy() we should use the default strategy.", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r475015949", "createdAt": "2020-08-22T00:02:25Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/netty/HtmlResponseUponGrpcRequestTest.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.grpc.netty;\n+\n+import io.servicetalk.grpc.api.GrpcStatusCode;\n+import io.servicetalk.grpc.api.GrpcStatusException;\n+import io.servicetalk.grpc.netty.TesterProto.TestRequest;\n+import io.servicetalk.http.netty.HttpServers;\n+import io.servicetalk.transport.api.ServerContext;\n+\n+import org.junit.Test;\n+import org.junit.function.ThrowingRunnable;\n+\n+import java.util.concurrent.ExecutionException;\n+\n+import static io.servicetalk.concurrent.api.Publisher.from;\n+import static io.servicetalk.concurrent.api.Single.succeeded;\n+import static io.servicetalk.grpc.api.GrpcExecutionStrategies.noOffloadsStrategy;\n+import static io.servicetalk.http.api.HttpSerializationProviders.textSerializer;\n+import static io.servicetalk.http.netty.HttpProtocolConfigs.h2Default;\n+import static io.servicetalk.transport.netty.internal.AddressUtils.localAddress;\n+import static io.servicetalk.transport.netty.internal.AddressUtils.serverHostAndPort;\n+import static java.util.Collections.singletonList;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.instanceOf;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.notNullValue;\n+import static org.junit.Assert.assertThrows;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class HtmlResponseUponGrpcRequestTest {\n+\n+    private ServerContext serverContext;\n+    private TesterProto.Tester.BlockingTesterClient client;\n+\n+    public HtmlResponseUponGrpcRequestTest() throws Exception {\n+        final String responsePayload = \"non-grpc error!\";\n+        serverContext = HttpServers.forAddress(localAddress(0))\n+                .protocols(h2Default())\n+                .listenAndAwait((ctx, request, responseFactory) ->\n+                        succeeded(responseFactory.badRequest().payloadBody(responsePayload, textSerializer())));\n+\n+        client = GrpcClients.forAddress(serverHostAndPort(serverContext))\n+                .executionStrategy(noOffloadsStrategy())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAxODM5MQ==", "bodyText": "nit: extra space between \"HTTP\" and \"status\"", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r475018391", "createdAt": "2020-08-22T00:12:39Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -185,16 +183,27 @@ static void setStatus(final HttpHeaders trailers, final Throwable cause, final B\n         }\n \n         // There was no grpc-status in the trailers, so it must be in headers.\n-        ensureGrpcStatusReceived(response.headers());\n+        ensureGrpcStatusReceived(headers);\n         return response.payloadBody(deserializer);\n     }\n \n+    private static void ensureNotPlainHtmlResponse(final HttpResponseStatus status,\n+                                                      final HttpHeaders headers) {\n+        final CharSequence contentTypeHeader = headers.get(CONTENT_TYPE);\n+        if (!hasContentType(headers, GRPC_CONTENT_TYPE, null)) {\n+            throw new GrpcStatus(INTERNAL, null,\n+                    \"HTTP  status code: \" + status + \"\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "984bc448e856697a22b72e3b29f9b4bc7c5a772d", "author": {"user": {"login": "tkountis", "name": "Thomas Kountis"}}, "url": "https://github.com/apple/servicetalk/commit/984bc448e856697a22b72e3b29f9b4bc7c5a772d", "committedDate": "2020-09-09T18:06:48Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1Mjg0MjQy", "url": "https://github.com/apple/servicetalk/pull/1132#pullrequestreview-485284242", "createdAt": "2020-09-09T18:22:50Z", "commit": {"oid": "984bc448e856697a22b72e3b29f9b4bc7c5a772d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MjkxNDY5", "url": "https://github.com/apple/servicetalk/pull/1132#pullrequestreview-485291469", "createdAt": "2020-09-09T18:32:58Z", "commit": {"oid": "984bc448e856697a22b72e3b29f9b4bc7c5a772d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3461, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}