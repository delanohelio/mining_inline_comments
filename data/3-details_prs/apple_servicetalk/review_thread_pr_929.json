{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MzI5NzEy", "number": 929, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNzoxNTowNFrODbpyyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNzoxNTowNFrODbpyyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMzIyODkxOnYy", "diffSide": "RIGHT", "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNzoxNTowNFrOFjQqOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxODozNDo1MFrOFjTJHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNzQzMw==", "bodyText": "Did you consider setting a status in grpcPayloadWriter.close() if it is not set?", "url": "https://github.com/apple/servicetalk/pull/929#discussion_r372517433", "createdAt": "2020-01-29T17:15:04Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java", "diffHunk": "@@ -444,8 +445,12 @@ public void handle(final HttpServiceContext ctx, final BlockingStreamingHttpRequ\n                             final DefaultGrpcPayloadWriter<Resp> grpcPayloadWriter =\n                                     new DefaultGrpcPayloadWriter<>(response.sendMetaData(serializer));\n                             try {\n+                                // Set status OK before invoking handle methods because users can close PayloadWriter\n+                                final HttpPayloadWriter<Resp> payloadWriter = grpcPayloadWriter.payloadWriter();\n+                                setStatusOk(payloadWriter.trailers(), ctx.executionContext().bufferAllocator());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a494e36564f7a96765ebc953bbfbc3a355bbc628"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1MTMyMg==", "bodyText": "Yes, I considered that approach, but then we have to store the ref for BufferAllocator inside DefaultGrpcPayloadWriter and do a look up for the header before setting OK.\nBecause OK is the most common case and we do not expose trailers in handle method (users can't change them), this approach is good enough.", "url": "https://github.com/apple/servicetalk/pull/929#discussion_r372551322", "createdAt": "2020-01-29T18:21:34Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java", "diffHunk": "@@ -444,8 +445,12 @@ public void handle(final HttpServiceContext ctx, final BlockingStreamingHttpRequ\n                             final DefaultGrpcPayloadWriter<Resp> grpcPayloadWriter =\n                                     new DefaultGrpcPayloadWriter<>(response.sendMetaData(serializer));\n                             try {\n+                                // Set status OK before invoking handle methods because users can close PayloadWriter\n+                                final HttpPayloadWriter<Resp> payloadWriter = grpcPayloadWriter.payloadWriter();\n+                                setStatusOk(payloadWriter.trailers(), ctx.executionContext().bufferAllocator());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNzQzMw=="}, "originalCommit": {"oid": "a494e36564f7a96765ebc953bbfbc3a355bbc628"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1ODEwOA==", "bodyText": "this approach is good enough.\n\n\nAgreed, thanks for the explanation", "url": "https://github.com/apple/servicetalk/pull/929#discussion_r372558108", "createdAt": "2020-01-29T18:34:50Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcRouter.java", "diffHunk": "@@ -444,8 +445,12 @@ public void handle(final HttpServiceContext ctx, final BlockingStreamingHttpRequ\n                             final DefaultGrpcPayloadWriter<Resp> grpcPayloadWriter =\n                                     new DefaultGrpcPayloadWriter<>(response.sendMetaData(serializer));\n                             try {\n+                                // Set status OK before invoking handle methods because users can close PayloadWriter\n+                                final HttpPayloadWriter<Resp> payloadWriter = grpcPayloadWriter.payloadWriter();\n+                                setStatusOk(payloadWriter.trailers(), ctx.executionContext().bufferAllocator());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNzQzMw=="}, "originalCommit": {"oid": "a494e36564f7a96765ebc953bbfbc3a355bbc628"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2833, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}