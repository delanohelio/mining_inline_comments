{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzODc3NjE5", "number": 983, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMzoyOTowNVrODrb8Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMTo0NjoxNFrODrdgmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODczMTc1OnYy", "diffSide": "RIGHT", "path": "servicetalk-grpc-gradle-plugin/src/main/groovy/io/servicetalk/grpc/gradle/plugin/ServiceTalkGrpcPlugin.groovy", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMzoyOTowNVrOF7yJXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMjoxMTowM1rOF707Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIzMTkwMQ==", "bodyText": "generation of temp files is not ideal ... but a reliable way to make sure we use the jar file that is actually resolved for each build. I'm open to alternatives @idelpivnitskiy", "url": "https://github.com/apple/servicetalk/pull/983#discussion_r398231901", "createdAt": "2020-03-25T23:29:05Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-grpc-gradle-plugin/src/main/groovy/io/servicetalk/grpc/gradle/plugin/ServiceTalkGrpcPlugin.groovy", "diffHunk": "@@ -67,6 +62,49 @@ class ServiceTalkGrpcPlugin implements Plugin<Project> {\n         throw new InvalidUserDataException(\"Please set `serviceTalkGrpc.protobufVersion`.\")\n       }\n \n+      // If this project is outside of ServiceTalk's gradle build we need to add an explicit dependency on the\n+      // uber jar which contains the protoc logic, as otherwise the grpc-gradle-plugin will only add a dependency\n+      // on the executable script\n+      File uberJarFile\n+      String scriptNamePrefix\n+      if (serviceTalkProtocPluginPath) {\n+        scriptNamePrefix = \"servicetalk-grpc-protoc-\" + project.version\n+        uberJarFile = new File(serviceTalkProtocPluginPath)\n+      } else {\n+        scriptNamePrefix = \"servicetalk-grpc-protoc-$serviceTalkVersion\"\n+        def stGrpcProtocDep =\n+            project.getDependencies().create(\"io.servicetalk:servicetalk-grpc-protoc:$serviceTalkVersion:all\")\n+        compileOnlyDeps.add(stGrpcProtocDep)\n+        testCompileOnlyDeps.add(stGrpcProtocDep)\n+\n+        uberJarFile = project.configurations.compileOnly.find { it.name.startsWith(\"servicetalk-grpc-protoc\") }\n+        if (uberJarFile == null) {\n+          throw new IllegalStateException(\"failed to find the servicetalk-grpc-protoc:$serviceTalkVersion:all\")\n+        }\n+      }\n+\n+      File scriptExecutableFile\n+      try {\n+        if (org.gradle.internal.os.OperatingSystem.current().isWindows()) {\n+          scriptExecutableFile = File.createTempFile(scriptNamePrefix, \".bat\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cb7da209ad3d85059e859ad6e39e66d5f79fa90"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI3MTI2Ng==", "bodyText": "how grpc-java solves this issue?", "url": "https://github.com/apple/servicetalk/pull/983#discussion_r398271266", "createdAt": "2020-03-26T01:47:50Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-gradle-plugin/src/main/groovy/io/servicetalk/grpc/gradle/plugin/ServiceTalkGrpcPlugin.groovy", "diffHunk": "@@ -67,6 +62,49 @@ class ServiceTalkGrpcPlugin implements Plugin<Project> {\n         throw new InvalidUserDataException(\"Please set `serviceTalkGrpc.protobufVersion`.\")\n       }\n \n+      // If this project is outside of ServiceTalk's gradle build we need to add an explicit dependency on the\n+      // uber jar which contains the protoc logic, as otherwise the grpc-gradle-plugin will only add a dependency\n+      // on the executable script\n+      File uberJarFile\n+      String scriptNamePrefix\n+      if (serviceTalkProtocPluginPath) {\n+        scriptNamePrefix = \"servicetalk-grpc-protoc-\" + project.version\n+        uberJarFile = new File(serviceTalkProtocPluginPath)\n+      } else {\n+        scriptNamePrefix = \"servicetalk-grpc-protoc-$serviceTalkVersion\"\n+        def stGrpcProtocDep =\n+            project.getDependencies().create(\"io.servicetalk:servicetalk-grpc-protoc:$serviceTalkVersion:all\")\n+        compileOnlyDeps.add(stGrpcProtocDep)\n+        testCompileOnlyDeps.add(stGrpcProtocDep)\n+\n+        uberJarFile = project.configurations.compileOnly.find { it.name.startsWith(\"servicetalk-grpc-protoc\") }\n+        if (uberJarFile == null) {\n+          throw new IllegalStateException(\"failed to find the servicetalk-grpc-protoc:$serviceTalkVersion:all\")\n+        }\n+      }\n+\n+      File scriptExecutableFile\n+      try {\n+        if (org.gradle.internal.os.OperatingSystem.current().isWindows()) {\n+          scriptExecutableFile = File.createTempFile(scriptNamePrefix, \".bat\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIzMTkwMQ=="}, "originalCommit": {"oid": "0cb7da209ad3d85059e859ad6e39e66d5f79fa90"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI3NzQyNg==", "bodyText": "they don't have to deal with this because they write their plugin in c++ and publish a single executable for each platform.", "url": "https://github.com/apple/servicetalk/pull/983#discussion_r398277426", "createdAt": "2020-03-26T02:11:03Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-grpc-gradle-plugin/src/main/groovy/io/servicetalk/grpc/gradle/plugin/ServiceTalkGrpcPlugin.groovy", "diffHunk": "@@ -67,6 +62,49 @@ class ServiceTalkGrpcPlugin implements Plugin<Project> {\n         throw new InvalidUserDataException(\"Please set `serviceTalkGrpc.protobufVersion`.\")\n       }\n \n+      // If this project is outside of ServiceTalk's gradle build we need to add an explicit dependency on the\n+      // uber jar which contains the protoc logic, as otherwise the grpc-gradle-plugin will only add a dependency\n+      // on the executable script\n+      File uberJarFile\n+      String scriptNamePrefix\n+      if (serviceTalkProtocPluginPath) {\n+        scriptNamePrefix = \"servicetalk-grpc-protoc-\" + project.version\n+        uberJarFile = new File(serviceTalkProtocPluginPath)\n+      } else {\n+        scriptNamePrefix = \"servicetalk-grpc-protoc-$serviceTalkVersion\"\n+        def stGrpcProtocDep =\n+            project.getDependencies().create(\"io.servicetalk:servicetalk-grpc-protoc:$serviceTalkVersion:all\")\n+        compileOnlyDeps.add(stGrpcProtocDep)\n+        testCompileOnlyDeps.add(stGrpcProtocDep)\n+\n+        uberJarFile = project.configurations.compileOnly.find { it.name.startsWith(\"servicetalk-grpc-protoc\") }\n+        if (uberJarFile == null) {\n+          throw new IllegalStateException(\"failed to find the servicetalk-grpc-protoc:$serviceTalkVersion:all\")\n+        }\n+      }\n+\n+      File scriptExecutableFile\n+      try {\n+        if (org.gradle.internal.os.OperatingSystem.current().isWindows()) {\n+          scriptExecutableFile = File.createTempFile(scriptNamePrefix, \".bat\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIzMTkwMQ=="}, "originalCommit": {"oid": "0cb7da209ad3d85059e859ad6e39e66d5f79fa90"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODk3NzM3OnYy", "diffSide": "RIGHT", "path": "servicetalk-examples/grpc/helloworld/build.gradle", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMTozOTo0N1rOF70bFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMTo1MjowMVrOF70nUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI2OTIwNg==", "bodyText": "nit (here and in other places): You can avoid concatenation in this way: \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-${project.version}-all.jar\"", "url": "https://github.com/apple/servicetalk/pull/983#discussion_r398269206", "createdAt": "2020-03-26T01:39:47Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-examples/grpc/helloworld/build.gradle", "diffHunk": "@@ -33,7 +33,7 @@ serviceTalkGrpc {\n \n   // The following setting must be omitted in users projects and is necessary here\n   // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath = \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/\" +\n-      io.servicetalk.internal.build.ExecutableBuilder.addExecutablePostFix(\"protoc-gen-servicetalk_grpc\",\n-          org.gradle.internal.os.OperatingSystem.current().isWindows())\n+  serviceTalkProtocPluginPath =\n+      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n+          project.version + \"-all.jar\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf58a812b42435e61a302420a852722a67723e8c"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI3MTY3NQ==", "bodyText": "I was getting a check style error in some cases bcz the line was too long so I'll just break it up for now.", "url": "https://github.com/apple/servicetalk/pull/983#discussion_r398271675", "createdAt": "2020-03-26T01:49:30Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-examples/grpc/helloworld/build.gradle", "diffHunk": "@@ -33,7 +33,7 @@ serviceTalkGrpc {\n \n   // The following setting must be omitted in users projects and is necessary here\n   // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath = \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/\" +\n-      io.servicetalk.internal.build.ExecutableBuilder.addExecutablePostFix(\"protoc-gen-servicetalk_grpc\",\n-          org.gradle.internal.os.OperatingSystem.current().isWindows())\n+  serviceTalkProtocPluginPath =\n+      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n+          project.version + \"-all.jar\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI2OTIwNg=="}, "originalCommit": {"oid": "bf58a812b42435e61a302420a852722a67723e8c"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI3MjMzNg==", "bodyText": "ok, np", "url": "https://github.com/apple/servicetalk/pull/983#discussion_r398272336", "createdAt": "2020-03-26T01:52:01Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-examples/grpc/helloworld/build.gradle", "diffHunk": "@@ -33,7 +33,7 @@ serviceTalkGrpc {\n \n   // The following setting must be omitted in users projects and is necessary here\n   // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath = \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/\" +\n-      io.servicetalk.internal.build.ExecutableBuilder.addExecutablePostFix(\"protoc-gen-servicetalk_grpc\",\n-          org.gradle.internal.os.OperatingSystem.current().isWindows())\n+  serviceTalkProtocPluginPath =\n+      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n+          project.version + \"-all.jar\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI2OTIwNg=="}, "originalCommit": {"oid": "bf58a812b42435e61a302420a852722a67723e8c"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODk4NDU5OnYy", "diffSide": "RIGHT", "path": "servicetalk-grpc-gradle-plugin/src/main/groovy/io/servicetalk/grpc/gradle/plugin/ServiceTalkGrpcPlugin.groovy", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMTo0NDowNVrOF70fPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMjowNzoxOFrOF703CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI3MDI3MA==", "bodyText": "Why if branch should use project.version but else branch uses $serviceTalkVersion? Are they different?", "url": "https://github.com/apple/servicetalk/pull/983#discussion_r398270270", "createdAt": "2020-03-26T01:44:05Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-gradle-plugin/src/main/groovy/io/servicetalk/grpc/gradle/plugin/ServiceTalkGrpcPlugin.groovy", "diffHunk": "@@ -67,6 +62,49 @@ class ServiceTalkGrpcPlugin implements Plugin<Project> {\n         throw new InvalidUserDataException(\"Please set `serviceTalkGrpc.protobufVersion`.\")\n       }\n \n+      // If this project is outside of ServiceTalk's gradle build we need to add an explicit dependency on the\n+      // uber jar which contains the protoc logic, as otherwise the grpc-gradle-plugin will only add a dependency\n+      // on the executable script\n+      File uberJarFile\n+      String scriptNamePrefix\n+      if (serviceTalkProtocPluginPath) {\n+        scriptNamePrefix = \"servicetalk-grpc-protoc-\" + project.version\n+        uberJarFile = new File(serviceTalkProtocPluginPath)\n+      } else {\n+        scriptNamePrefix = \"servicetalk-grpc-protoc-$serviceTalkVersion\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf58a812b42435e61a302420a852722a67723e8c"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI3NjM2MQ==", "bodyText": "Are they different?\n\nYes. if serviceTalkProtocPluginPath is set then serviceTalkVersion == ${serviceTalkVersion} (or something similar). Basically if serviceTalkProtocPluginPath is set the variable isn't reliably available and instead we use the current project version (because you are assumed to be building in the same project anyways ... IIUC this should be true even if using --include-build)", "url": "https://github.com/apple/servicetalk/pull/983#discussion_r398276361", "createdAt": "2020-03-26T02:07:18Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-grpc-gradle-plugin/src/main/groovy/io/servicetalk/grpc/gradle/plugin/ServiceTalkGrpcPlugin.groovy", "diffHunk": "@@ -67,6 +62,49 @@ class ServiceTalkGrpcPlugin implements Plugin<Project> {\n         throw new InvalidUserDataException(\"Please set `serviceTalkGrpc.protobufVersion`.\")\n       }\n \n+      // If this project is outside of ServiceTalk's gradle build we need to add an explicit dependency on the\n+      // uber jar which contains the protoc logic, as otherwise the grpc-gradle-plugin will only add a dependency\n+      // on the executable script\n+      File uberJarFile\n+      String scriptNamePrefix\n+      if (serviceTalkProtocPluginPath) {\n+        scriptNamePrefix = \"servicetalk-grpc-protoc-\" + project.version\n+        uberJarFile = new File(serviceTalkProtocPluginPath)\n+      } else {\n+        scriptNamePrefix = \"servicetalk-grpc-protoc-$serviceTalkVersion\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI3MDI3MA=="}, "originalCommit": {"oid": "bf58a812b42435e61a302420a852722a67723e8c"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODk4ODQzOnYy", "diffSide": "RIGHT", "path": "servicetalk-grpc-gradle-plugin/src/main/groovy/io/servicetalk/grpc/gradle/plugin/ServiceTalkGrpcPlugin.groovy", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMTo0NjoxNFrOF70hfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMTo0NjoxNFrOF70hfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI3MDg0NA==", "bodyText": "servicetalk-grpc-protoc string is used multiple times in this class, consider using a constant", "url": "https://github.com/apple/servicetalk/pull/983#discussion_r398270844", "createdAt": "2020-03-26T01:46:14Z", "author": {"login": "idelpivnitskiy"}, "path": "servicetalk-grpc-gradle-plugin/src/main/groovy/io/servicetalk/grpc/gradle/plugin/ServiceTalkGrpcPlugin.groovy", "diffHunk": "@@ -67,6 +62,49 @@ class ServiceTalkGrpcPlugin implements Plugin<Project> {\n         throw new InvalidUserDataException(\"Please set `serviceTalkGrpc.protobufVersion`.\")\n       }\n \n+      // If this project is outside of ServiceTalk's gradle build we need to add an explicit dependency on the\n+      // uber jar which contains the protoc logic, as otherwise the grpc-gradle-plugin will only add a dependency\n+      // on the executable script\n+      File uberJarFile\n+      String scriptNamePrefix\n+      if (serviceTalkProtocPluginPath) {\n+        scriptNamePrefix = \"servicetalk-grpc-protoc-\" + project.version\n+        uberJarFile = new File(serviceTalkProtocPluginPath)\n+      } else {\n+        scriptNamePrefix = \"servicetalk-grpc-protoc-$serviceTalkVersion\"\n+        def stGrpcProtocDep =\n+            project.getDependencies().create(\"io.servicetalk:servicetalk-grpc-protoc:$serviceTalkVersion:all\")\n+        compileOnlyDeps.add(stGrpcProtocDep)\n+        testCompileOnlyDeps.add(stGrpcProtocDep)\n+\n+        uberJarFile = project.configurations.compileOnly.find { it.name.startsWith(\"servicetalk-grpc-protoc\") }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf58a812b42435e61a302420a852722a67723e8c"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2811, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}