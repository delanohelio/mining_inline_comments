{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMTIzODEx", "number": 969, "title": "More strict decoding of HTTP/1.x start-line", "bodyText": "Motivation:\nRFC7230 allows only a single SP between start-line components:\nhttps://tools.ietf.org/html/rfc7230#section-3.1\nAnd it adds additional restrictions for which characters are\nallowed for each individual component.\nModifications:\n\nSkip only limited number of prefacing control characters;\nDo not allow leading/trailing WS for start-line;\nExpect only a single SP/HTAB as a delimiter between start-line\ncomponents;\nVerify that request-target and reason-phrase has only allowed\ncharacters;\nAllow only upper-case letters for HTTP-method;\nSimplify header field-name/field-value parsing;\nImproved parsing for HTTP version;\nShare common code between HttpRequestDecoderTest and\nHttpResponseDecoderTest;\nAddress issues with existing tests and add more tests\nfor decoders;\n\nResult:\nMore strict decoding of HTTP/1.x start-line.", "createdAt": "2020-03-17T23:08:58Z", "url": "https://github.com/apple/servicetalk/pull/969", "merged": true, "mergeCommit": {"oid": "429f12d14032e31c68daefdd00cd4750a63c1d56"}, "closed": true, "closedAt": "2020-03-18T04:55:15Z", "author": {"login": "idelpivnitskiy"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMCbCdgH2gAyMzkwMTIzODExOjJmYzE0YTZjYzRhZjM2ODg4NmJiYzZhZmQ4MGUyOWU3ZDAxNTUwMjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOvzZdAH2gAyMzkwMTIzODExOjE2ZDA1ZTUxZDk2MzYwMTYwMWUxYzk3MjUyY2RiMTIyYWE4MmM0MGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2fc14a6cc4af368886bbc6afd80e29e7d0155029", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/2fc14a6cc4af368886bbc6afd80e29e7d0155029", "committedDate": "2020-03-09T18:42:31Z", "message": "More strict decoding of HTTP/1.x start-line\n\nMotivation:\n\nRFC7230 allows only a single SP between start-line components:\nhttps://tools.ietf.org/html/rfc7230#section-3.1\nAnd it adds additional restrictions for which characters are\nallowed for each individual component.\n\nModifications:\n\n- Skip only limited number of prefacing control characters;\n- Do not allow leading/trailing WS for start-line;\n- Expect only a single SP/HTAB as a delimiter between start-line\ncomponents;\n- Verify that request-target and reason-phrase has only allowed\ncharacters;\n- Allow only upper-case letters for HTTP-method;\n- Simplify header field-name/field-value parsing;\n- Improved parsing for HTTP version;\n- Share common code between `HttpRequestDecoderTest` and\n`HttpResponseDecoderTest`;\n- Address issues with existing tests and add more tests\nfor decoders;\n\nResult:\n\nMore strict decoding of HTTP/1.x start-line."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48a177c804e656532cae2dd96b6a1844b1562dd5", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/48a177c804e656532cae2dd96b6a1844b1562dd5", "committedDate": "2020-03-12T00:09:18Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acbc88af1e1dac2e3929c71e78922450921bcdb7", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/acbc88af1e1dac2e3929c71e78922450921bcdb7", "committedDate": "2020-03-12T23:07:28Z", "message": "unroll loop in handlePartialInitialLine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7baef07ac9ab92495dd17f5fb51a84c023eb84b7", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/7baef07ac9ab92495dd17f5fb51a84c023eb84b7", "committedDate": "2020-03-14T01:17:49Z", "message": "Merge remote-tracking branch 'upstream/master' into strict-http-parsing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a9f80489bd40ec93b810d3ca66fc728c06d8c2d", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/3a9f80489bd40ec93b810d3ca66fc728c06d8c2d", "committedDate": "2020-03-14T01:24:51Z", "message": "handlePartialInitialLine: ensure there is at least one byte"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27edd1890693f0a8f8d604513eda43a53b1d833d", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/27edd1890693f0a8f8d604513eda43a53b1d833d", "committedDate": "2020-03-17T23:07:11Z", "message": "Merge remote-tracking branch 'upstream/master' into strict-http-parsing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTMxMTEy", "url": "https://github.com/apple/servicetalk/pull/969#pullrequestreview-376531112", "createdAt": "2020-03-18T02:49:43Z", "commit": {"oid": "27edd1890693f0a8f8d604513eda43a53b1d833d"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMjo0OTo0M1rOF30o1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMjo1NToyM1rOF30uZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA3ODQyMw==", "bodyText": "any reason not to use a ByteProcessor here to reduce calls to getByte?", "url": "https://github.com/apple/servicetalk/pull/969#discussion_r394078423", "createdAt": "2020-03-18T02:49:43Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/HttpRequestDecoder.java", "diffHunk": "@@ -58,19 +62,27 @@ protected boolean isDecodingRequest() {\n \n     @Override\n     protected void handlePartialInitialLine(final ChannelHandlerContext ctx, final ByteBuf buffer) {\n-        final int len = min(3, buffer.readableBytes());\n-        for (int i = 0; i < len; ++i) {\n-            byte b = buffer.getByte(buffer.readerIndex() + i);\n-            if (b == ' ' && i > 0) {\n-                // If we find a space after at least one capital letter, accept this as valid.\n+        final int writerIndex = buffer.writerIndex();\n+        int readerIndex = buffer.readerIndex();\n+        if (readerIndex == writerIndex) {   // ByteBuf is not readable\n+            return;\n+        }\n+        byte b = buffer.getByte(readerIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27edd1890693f0a8f8d604513eda43a53b1d833d"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA3ODc1OA==", "bodyText": "consider doing validation only for custom header names, most of the time we shouldn't have to do the validation because it is handled in the lookup (e.g. if it matches a cached entry it is upper case). It is worth paying the string conversion costs assuming most of the time we will get a valid string.", "url": "https://github.com/apple/servicetalk/pull/969#discussion_r394078758", "createdAt": "2020-03-18T02:51:06Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/HttpRequestDecoder.java", "diffHunk": "@@ -79,17 +91,15 @@ protected HttpRequestMetaData createMessage(final ByteBuf buffer,\n                                                 final int firstStart, final int firstLength,\n                                                 final int secondStart, final int secondLength,\n                                                 final int thirdStart, final int thirdLength) {\n-        if (thirdLength < 0) {\n-            splitInitialLineError();\n-        }\n-\n         return newRequestMetaData(nettyBufferToHttpVersion(buffer, thirdStart, thirdLength),\n-                decodeHttpMethod(buffer.toString(firstStart, firstLength, US_ASCII)),\n+                decodeHttpMethod(buffer, firstStart, firstLength),\n                 buffer.toString(secondStart, secondLength, US_ASCII),\n                 headersFactory().newHeaders());\n     }\n \n-    private static HttpRequestMethod decodeHttpMethod(final String methodName) {\n+    private static HttpRequestMethod decodeHttpMethod(final ByteBuf buffer, final int start, final int length) {\n+        buffer.forEachByte(start, length, ENSURE_UPPER_CASE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27edd1890693f0a8f8d604513eda43a53b1d833d"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA3OTQ1Nw==", "bodyText": "nit: consider combining conditionals:\nif (value != HT && isISOControl(value) {\n  throw ...\n}\nreturn true;", "url": "https://github.com/apple/servicetalk/pull/969#discussion_r394079457", "createdAt": "2020-03-18T02:53:47Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/HttpResponseDecoder.java", "diffHunk": "@@ -38,13 +41,23 @@\n import static io.servicetalk.http.api.HttpResponseStatus.SWITCHING_PROTOCOLS;\n import static io.servicetalk.http.api.HttpResponseStatus.StatusClass.INFORMATIONAL_1XX;\n import static io.servicetalk.transport.netty.internal.CloseHandler.UNSUPPORTED_PROTOCOL_CLOSE_HANDLER;\n+import static java.lang.Character.isISOControl;\n import static java.lang.Math.min;\n import static java.nio.charset.StandardCharsets.US_ASCII;\n import static java.util.Objects.requireNonNull;\n \n final class HttpResponseDecoder extends HttpObjectDecoder<HttpResponseMetaData> {\n \n     private static final byte[] FIRST_BYTES = \"HTTP\".getBytes(US_ASCII);\n+    private static final ByteProcessor ENSURE_NO_CONTROL_CHARS = value -> {\n+        if (value == HT) {\n+            return true;    // allow HTAB\n+        }\n+        if (isISOControl(value)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27edd1890693f0a8f8d604513eda43a53b1d833d"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA3OTg0Ng==", "bodyText": "https://tools.ietf.org/html/rfc7230#section-3.1.2\n\nA client SHOULD ignore the reason-phrase content.\n\nsad to waste cycles validating something that should be ignored \ud83d\ude22", "url": "https://github.com/apple/servicetalk/pull/969#discussion_r394079846", "createdAt": "2020-03-18T02:55:23Z", "author": {"login": "Scottmitch"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/HttpResponseDecoder.java", "diffHunk": "@@ -84,10 +97,19 @@ protected HttpResponseMetaData createMessage(final ByteBuf buffer, final int fir\n                                                  final int thirdStart, final int thirdLength) {\n         return newResponseMetaData(nettyBufferToHttpVersion(buffer, firstStart, firstLength),\n                 HttpResponseStatus.of(nettyBufferToStatusCode(buffer, secondStart, secondLength),\n-                        thirdLength >= 0 ? buffer.toString(thirdStart, thirdLength, US_ASCII) : \"\"),\n+                        reasonPhrase(buffer, thirdStart, thirdLength)),\n                 headersFactory().newHeaders());\n     }\n \n+    private static String reasonPhrase(final ByteBuf buffer, final int start, final int length) {\n+        if (length <= 0) {\n+            return EMPTY_STRING;\n+        }\n+        // Verify reason-phrase = *( HTAB / SP / VCHAR / obs-text )\n+        buffer.forEachByte(start, length, ENSURE_NO_CONTROL_CHARS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27edd1890693f0a8f8d604513eda43a53b1d833d"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16d05e51d963601601e1c97252cdb122aa82c40f", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/16d05e51d963601601e1c97252cdb122aa82c40f", "committedDate": "2020-03-18T04:42:42Z", "message": "Address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3325, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}