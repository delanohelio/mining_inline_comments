{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MjM4MjI1", "number": 940, "title": "H2 client should send `ENABLE_PUSH=false` setting for new connections", "bodyText": "Motivation:\nTo notify server-side that ST client currently does not support\nserver push, client should send ENABLE_PUSH=false setting when it\nconnects to the server.\nIf server sends a PUSH_PROMISE frame, client should send GO_AWAY\nbefore closing the connection.\nModifications:\n\nAdd ENABLE_PUSH=false and MAX_CONCURRENT_STREAMS=0 to\nthe set of initial h2 settings;\nSend GO_AWAY frame with PROTOCOL_ERROR if client receives a\nPUSH_PROMISE frame from server;\n\nResult:\nH2 client notifies server that it does not support server push and\nsends GO_AWAY frame before closing the connection, if server sends\na push.", "createdAt": "2020-02-17T16:59:39Z", "url": "https://github.com/apple/servicetalk/pull/940", "merged": true, "mergeCommit": {"oid": "9433208046a5056f1f91ac4f0e0c2b82d8c16998"}, "closed": true, "closedAt": "2020-02-18T22:42:21Z", "author": {"login": "idelpivnitskiy"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEasHlAH2gAyMzc2MjM4MjI1OjllMTQyM2U4NzcwMGJlODE5NzZiODRhYjNjOTExM2Q1N2QxYjRhZGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFpglSAFqTM2MDcxNDkwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9e1423e87700be81976b84ab3c9113d57d1b4adc", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/9e1423e87700be81976b84ab3c9113d57d1b4adc", "committedDate": "2020-02-15T02:27:30Z", "message": "H2 client should send `ENABLE_PUSH=false` setting for new connections\n\nMotivation:\n\nTo notify server side that ST client currently does not support\nserver push, client should send `ENABLE_PUSH=false` setting when it\nconnects to the server.\nIf server sends a `PUSH_PROMISE` frame, client should send `GO_AWAY`\nbefore closing the connection.\n\nModifications:\n\n- Add `ENABLE_PUSH=false` to the set of initial h2 settings;\n- Send `GO_AWAY` frame with `PROTOCOL_ERROR` if server sends a push;\n\nResult:\n\nH2 client notifies server that it does not support server push and\nsends `GO_AWAY` frame before closing the connection, if server sends\na push."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db34d8db357d4eb811326704d9a94992a123512e", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/db34d8db357d4eb811326704d9a94992a123512e", "committedDate": "2020-02-17T16:56:16Z", "message": "Close connection when GO_AWAY is flushed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ee4245ebdfc58b8aea5a5215b61f4e34a3821e7", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/9ee4245ebdfc58b8aea5a5215b61f4e34a3821e7", "committedDate": "2020-02-17T16:58:57Z", "message": "Update copyright year"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "466f641f76c0f564ffe0d9e0535448e1a9a2b97d", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/466f641f76c0f564ffe0d9e0535448e1a9a2b97d", "committedDate": "2020-02-17T17:01:11Z", "message": "Move logger to H2PushStreamHandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a33754cdf0da622db476713c469bd1c6ac2e68f2", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/a33754cdf0da622db476713c469bd1c6ac2e68f2", "committedDate": "2020-02-18T18:33:05Z", "message": "Add maxConcurrentStreams(0)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNTg0MDAy", "url": "https://github.com/apple/servicetalk/pull/940#pullrequestreview-360584002", "createdAt": "2020-02-18T18:47:36Z", "commit": {"oid": "a33754cdf0da622db476713c469bd1c6ac2e68f2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODo0NzozN1rOFrOI4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODo0NzozN1rOFrOI4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2NDczOQ==", "bodyText": "Netty should be closing the channel and log appropriately:\nhttps://github.com/netty/netty/blob/4.1/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2ConnectionHandler.java#L905-L929\nI do not think we need to add a listener here", "url": "https://github.com/apple/servicetalk/pull/940#discussion_r380864739", "createdAt": "2020-02-18T18:47:37Z", "author": {"login": "NiteshKant"}, "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/H2ClientParentChannelInitializer.java", "diffHunk": "@@ -72,7 +84,14 @@ private H2PushStreamHandler() {\n \n         @Override\n         public void channelRegistered(final ChannelHandlerContext ctx) {\n-            ctx.close(); // push streams are not supported\n+            // See SETTINGS_ENABLE_PUSH in https://tools.ietf.org/html/rfc7540#section-6.5.2\n+            ctx.writeAndFlush(new DefaultHttp2GoAwayFrame(PROTOCOL_ERROR))\n+                    .addListener((ChannelFutureListener) future -> {\n+                if (!future.isSuccess()) {\n+                    LOGGER.debug(\"Failed to send a GO_AWAY frame for received PUSH_PROMISE frame\", future.cause());\n+                }\n+                ctx.close(); // push streams are not supported", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a33754cdf0da622db476713c469bd1c6ac2e68f2"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7d473167681700a71dc9a2901bda8f2f47673b6", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/f7d473167681700a71dc9a2901bda8f2f47673b6", "committedDate": "2020-02-18T19:50:42Z", "message": "remove listener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dbc8bbbb3073979e26b63d42ff0e17442d844c7", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/8dbc8bbbb3073979e26b63d42ff0e17442d844c7", "committedDate": "2020-02-18T21:08:07Z", "message": "remove unused logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df3cf25ab6b1cbbe9d234216fd778ae4089b60e0", "author": {"user": {"login": "idelpivnitskiy", "name": "Idel Pivnitskiy"}}, "url": "https://github.com/apple/servicetalk/commit/df3cf25ab6b1cbbe9d234216fd778ae4089b60e0", "committedDate": "2020-02-18T21:32:13Z", "message": "do not create a new settings storage object"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNzE0OTAy", "url": "https://github.com/apple/servicetalk/pull/940#pullrequestreview-360714902", "createdAt": "2020-02-18T22:17:24Z", "commit": {"oid": "df3cf25ab6b1cbbe9d234216fd778ae4089b60e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3282, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}