{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzNDczNTcw", "number": 3571, "title": "Local lock improvements", "bodyText": "Various local improvements.", "createdAt": "2020-09-10T07:18:53Z", "url": "https://github.com/eclipse-vertx/vert.x/pull/3571", "merged": true, "mergeCommit": {"oid": "d0a1ba7793295573416cbc7b7a1bff955c801c4f"}, "closed": true, "closedAt": "2020-09-11T07:53:38Z", "author": {"login": "vietj"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHbtKIABqjM3NDk0Mzc0MDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHwTytABqjM3NTQ3NjgzMTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5979b021363c3e5884e7af9a3578065043be5648", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/5979b021363c3e5884e7af9a3578065043be5648", "committedDate": "2020-09-10T07:16:49Z", "message": "Use ContextInternal#setTimer to have a timer firing on the context thread"}, "afterCommit": {"oid": "2bdec393355814a5831329a04b12fe1bfefbd3a0", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/2bdec393355814a5831329a04b12fe1bfefbd3a0", "committedDate": "2020-09-10T07:31:13Z", "message": "Use ContextInternal#setTimer to have a timer firing on the context thread"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NzU0OTEz", "url": "https://github.com/eclipse-vertx/vert.x/pull/3571#pullrequestreview-485754913", "createdAt": "2020-09-10T09:33:50Z", "commit": {"oid": "e9c7361867e9e0b61b169c01aa7393faf0a647a4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwOTozMzo1MFrOHPrVBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwOTozNjoyMFrOHPrbHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIwMDU4Mw==", "bodyText": "Shouldn't the list be returned instead?", "url": "https://github.com/eclipse-vertx/vert.x/pull/3571#discussion_r486200583", "createdAt": "2020-09-10T09:33:50Z", "author": {"login": "tsegismont"}, "path": "src/main/java/io/vertx/core/shareddata/impl/LocalAsyncLocks.java", "diffHunk": "@@ -49,12 +47,30 @@\n       timerId = timeout != Long.MAX_VALUE ? context.owner().setTimer(timeout, tid -> timeout()) : null;\n     }\n \n-    boolean isWaiting() {\n-      return status.get() == Status.WAITING;\n-    }\n-\n     void timeout() {\n       if (status.compareAndSet(Status.WAITING, Status.TIMED_OUT)) {\n+        // Cleanup\n+        waitersMap.compute(lockName, (s, list) -> {\n+          if (list == null) {\n+            // Already removed by nextWaiter\n+            return null;\n+          } else {\n+            int idx = list.indexOf(LockWaiter.this);\n+            if (idx == -1) {\n+              // Already removed by nextWaiter\n+              return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9c7361867e9e0b61b169c01aa7393faf0a647a4"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIwMjE0Mw==", "bodyText": "Could we be more aggressive and check if we can return null when there's no other waiter or a SingletonList when there's just one?", "url": "https://github.com/eclipse-vertx/vert.x/pull/3571#discussion_r486202143", "createdAt": "2020-09-10T09:36:20Z", "author": {"login": "tsegismont"}, "path": "src/main/java/io/vertx/core/shareddata/impl/LocalAsyncLocks.java", "diffHunk": "@@ -49,12 +47,30 @@\n       timerId = timeout != Long.MAX_VALUE ? context.owner().setTimer(timeout, tid -> timeout()) : null;\n     }\n \n-    boolean isWaiting() {\n-      return status.get() == Status.WAITING;\n-    }\n-\n     void timeout() {\n       if (status.compareAndSet(Status.WAITING, Status.TIMED_OUT)) {\n+        // Cleanup\n+        waitersMap.compute(lockName, (s, list) -> {\n+          if (list == null) {\n+            // Already removed by nextWaiter\n+            return null;\n+          } else {\n+            int idx = list.indexOf(LockWaiter.this);\n+            if (idx == -1) {\n+              // Already removed by nextWaiter\n+              return null;\n+            }\n+            int size = list.size();\n+            ArrayList<LockWaiter> n = new ArrayList<>(size - 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9c7361867e9e0b61b169c01aa7393faf0a647a4"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bdec393355814a5831329a04b12fe1bfefbd3a0", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/2bdec393355814a5831329a04b12fe1bfefbd3a0", "committedDate": "2020-09-10T07:31:13Z", "message": "Use ContextInternal#setTimer to have a timer firing on the context thread"}, "afterCommit": {"oid": "0af7ed61a2524de1aa54b549d2629fc960c947be", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/0af7ed61a2524de1aa54b549d2629fc960c947be", "committedDate": "2020-09-10T14:01:43Z", "message": "Use ContextInternal#setTimer to have a timer firing on the context thread"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0af7ed61a2524de1aa54b549d2629fc960c947be", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/0af7ed61a2524de1aa54b549d2629fc960c947be", "committedDate": "2020-09-10T14:01:43Z", "message": "Use ContextInternal#setTimer to have a timer firing on the context thread"}, "afterCommit": {"oid": "b17901c037360435e70164bca1f5d4240fd2212d", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/b17901c037360435e70164bca1f5d4240fd2212d", "committedDate": "2020-09-10T14:35:27Z", "message": "Use ContextInternal#setTimer to have a timer firing on the context thread"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MDc3NzM2", "url": "https://github.com/eclipse-vertx/vert.x/pull/3571#pullrequestreview-486077736", "createdAt": "2020-09-10T15:50:56Z", "commit": {"oid": "b17901c037360435e70164bca1f5d4240fd2212d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7ee4074ff7fbbda5d49b5434f5830e50686e5f1", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/d7ee4074ff7fbbda5d49b5434f5830e50686e5f1", "committedDate": "2020-09-11T07:31:36Z", "message": "Local lock timeout now tries to remove the lock from the waiters list instead of relying on the lazy removal performed by the lock release operations - see #3570"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cba85b1c28348367821af054544b1795cb838691", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/cba85b1c28348367821af054544b1795cb838691", "committedDate": "2020-09-11T07:31:36Z", "message": "Simplify a bit LockWaiter that is using an atomic value to handle concurrent acquire/timeout of a waiter. Instead we can use the timer information to achieve the same, on acquire if the timer can be cancelled then we can grant the owner the lock, on timeout we can try to evict the timeout from the list."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bb37902da50c9f5fdf41a754aea7f91369445f4", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/6bb37902da50c9f5fdf41a754aea7f91369445f4", "committedDate": "2020-09-11T07:31:36Z", "message": "Use ContextInternal#setTimer to have a timer firing on the context thread"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b17901c037360435e70164bca1f5d4240fd2212d", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/b17901c037360435e70164bca1f5d4240fd2212d", "committedDate": "2020-09-10T14:35:27Z", "message": "Use ContextInternal#setTimer to have a timer firing on the context thread"}, "afterCommit": {"oid": "6bb37902da50c9f5fdf41a754aea7f91369445f4", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/6bb37902da50c9f5fdf41a754aea7f91369445f4", "committedDate": "2020-09-11T07:31:36Z", "message": "Use ContextInternal#setTimer to have a timer firing on the context thread"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1700, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}