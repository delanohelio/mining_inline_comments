{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyNzIwNDg5", "number": 3425, "title": "The shutdown hook wasn't starting the right thread and leaking the ca\u2026", "bodyText": "\u2026cheDir to null while still in use\nSigned-off-by: Paulo Lopes pmlopes@gmail.com\nMotivation:\nThe delete cache dir shutdown hook isn't starting a thread properly, this means that the delete code set's the cache dir to null while still on the eventloop and may leak (like it happens on vertx-web unit tests). In this case cache files are written to the CWD when they shouldn't.", "createdAt": "2020-05-25T12:14:04Z", "url": "https://github.com/eclipse-vertx/vert.x/pull/3425", "merged": true, "mergeCommit": {"oid": "ed7aae11e531d945e3d2e48ce65b8bc9aa06f59d"}, "closed": true, "closedAt": "2020-05-25T14:08:42Z", "author": {"login": "pmlopes"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcku_SdgH2gAyNDIyNzIwNDg5OjI0YWI4NGExMTlhMWEyN2U5MmNhNGIxZjZlYTY3OThjMjI3M2NlZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABckvjXDgFqTQxNzY5MDAwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "24ab84a119a1a27e92ca4b1f6ea6798c2273cede", "author": {"user": {"login": "pmlopes", "name": "Paulo Lopes"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/24ab84a119a1a27e92ca4b1f6ea6798c2273cede", "committedDate": "2020-05-25T12:12:07Z", "message": "The shutdown hook wasn't starting the right thread and leaking the cacheDir to null while still in use\n\nSigned-off-by: Paulo Lopes <pmlopes@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NjcxMjYy", "url": "https://github.com/eclipse-vertx/vert.x/pull/3425#pullrequestreview-417671262", "createdAt": "2020-05-25T12:16:28Z", "commit": {"oid": "24ab84a119a1a27e92ca4b1f6ea6798c2273cede"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxMjoxNjoyOFrOGZ_P4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxMjoxNjoyOFrOGZ_P4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMzg0Mg==", "bodyText": "instead of a Latch use thread.join on the thread that was started", "url": "https://github.com/eclipse-vertx/vert.x/pull/3425#discussion_r429903842", "createdAt": "2020-05-25T12:16:28Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -377,31 +377,29 @@ private ClassLoader getClassLoader() {\n     return cl;\n   }\n \n-  private void setupCacheDir() {\n-    String cacheDirName = fileCacheDir + \"/file-cache-\" + UUID.randomUUID().toString();\n+  private synchronized void setupCacheDir(String id) {\n+    String cacheDirName = fileCacheDir + \"/file-cache-\" + id;\n     cacheDir = new File(cacheDirName);\n     if (!cacheDir.mkdirs()) {\n       throw new IllegalStateException(\"Failed to create cache dir: \" + cacheDirName);\n     }\n     // Add shutdown hook to delete on exit\n-    synchronized (this) {\n-      shutdownHook = new Thread(() -> {\n-        CountDownLatch latch = new CountDownLatch(1);\n-        new Thread(() -> {\n-          try {\n-            deleteCacheDir();\n-          } catch (IOException ignore) {\n-          }\n-          latch.countDown();\n-        }).run();\n+    shutdownHook = new Thread(() -> {\n+      CountDownLatch latch = new CountDownLatch(1);\n+      new Thread(() -> {\n         try {\n-          latch.await(10, TimeUnit.SECONDS);\n-        } catch (InterruptedException e) {\n-          Thread.currentThread().interrupt();\n+          deleteCacheDir();\n+        } catch (IOException ignore) {\n         }\n-      });\n-      Runtime.getRuntime().addShutdownHook(shutdownHook);\n-    }\n+        latch.countDown();\n+      }).start();\n+      try {\n+        latch.await(10, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24ab84a119a1a27e92ca4b1f6ea6798c2273cede"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9176eba74dcb538f9e12ce2e6c69806110e9807c", "author": {"user": {"login": "pmlopes", "name": "Paulo Lopes"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/9176eba74dcb538f9e12ce2e6c69806110e9807c", "committedDate": "2020-05-25T12:48:55Z", "message": "Avoid using latch, use the Thread join method instead\n\nSigned-off-by: Paulo Lopes <pmlopes@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NjkwMDA1", "url": "https://github.com/eclipse-vertx/vert.x/pull/3425#pullrequestreview-417690005", "createdAt": "2020-05-25T12:51:31Z", "commit": {"oid": "9176eba74dcb538f9e12ce2e6c69806110e9807c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1668, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}