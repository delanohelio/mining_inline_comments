{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxNjU3MDk2", "number": 3581, "title": "Fixes Resolver delete race against file resolve", "bodyText": "Signed-off-by: Paulo Lopes pmlopes@gmail.com\nMotivation:\nCleaning the FileSystem cache happens usually on a shutdown thread, outside the resolver monitor. It also changes the resolver state to set the cache dir object to null.\nThis has a couple of side effects:\n\nA call to resolve while the delete is happening will use the \"to be deleted directory\" as root.\nA resolve call during clear cache will see that the cacheDir object is null which will lead to resolved file to be written to the ${user.dir}.\nAs cacheDir shared the same directory for all instances (by default) a clear for instance A will wipe the cache for instance B\n\nThe last item was also reported by #3510\nThis PR addresses the issue in the following way:\n\ncacheDir is final and computed at <ctor> time.\nclearCache will be synchronized on the resolver iif the is cacheDir\ncaches are suffixed with an UUID instead of sharing a common directory.\n\nThe last item only addresses the uniqueness and independence of caches not the full discussion on #3510 . As a note the mentioned issue warns about potential collisions, however wikipedia tells us that the change of a collision is 1 in a billion: https://en.wikipedia.org/wiki/Universally_unique_identifier#Version_4_(random) . Given that most unices can handle a few million processes:\ncat /proc/sys/kernel/pid_max\n4194304\n\nI'm not attempting to change the current use of UUIDs + on regular operations caches are deleted on VM shutdown, which means the probability will be even smaller.", "createdAt": "2020-09-23T09:55:44Z", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581", "merged": true, "mergeCommit": {"oid": "4744506e7ec4bc64487e394f395dfec3cb9da077"}, "closed": true, "closedAt": "2020-10-02T09:13:43Z", "author": {"login": "pmlopes"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLpXUlgH2gAyNDkxNjU3MDk2OjQwZmQwZDBhMmU3NjFlYmIxM2I0NmE2Y2E4NGZlYzRiNmYzNmNlYWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOh1NvAFqTUwMDk1NDQxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "40fd0d0a2e761ebb13b46a6ca84fec4b6f36cead", "author": {"user": {"login": "pmlopes", "name": "Paulo Lopes"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/40fd0d0a2e761ebb13b46a6ca84fec4b6f36cead", "committedDate": "2020-09-23T09:41:59Z", "message": "Fixes Resolver delete race against file resolve\n\nSigned-off-by: Paulo Lopes <pmlopes@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e1a9d88eff2a8905f0d02b9eb1ef87b2a998e5d", "author": {"user": {"login": "pmlopes", "name": "Paulo Lopes"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/6e1a9d88eff2a8905f0d02b9eb1ef87b2a998e5d", "committedDate": "2020-09-23T09:57:14Z", "message": "Added a comment\n\nSigned-off-by: Paulo Lopes <pmlopes@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NjQ2ODA2", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#pullrequestreview-494646806", "createdAt": "2020-09-23T13:15:48Z", "commit": {"oid": "6e1a9d88eff2a8905f0d02b9eb1ef87b2a998e5d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1OTI5NjU0", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#pullrequestreview-495929654", "createdAt": "2020-09-24T20:32:46Z", "commit": {"oid": "6e1a9d88eff2a8905f0d02b9eb1ef87b2a998e5d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMDozMjo0NlrOHXrmgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMDozMjo0NlrOHXrmgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5MzY2NA==", "bodyText": "this is called from the constructor so it does not need to be synchronized", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r494593664", "createdAt": "2020-09-24T20:32:46Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -375,9 +370,24 @@ private ClassLoader getClassLoader() {\n     return cl;\n   }\n \n-  private synchronized void setupCacheDir(String id) {\n-    String cacheDirName = fileCacheDir + \"/file-cache-\" + id;\n-    cacheDir = new File(cacheDirName);\n+  /**\n+   * Will prepare the cache directory to be used in the application or return null if classpath resolving is disabled.\n+   */\n+  private synchronized File setupCacheDir(String fileCacheDir) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e1a9d88eff2a8905f0d02b9eb1ef87b2a998e5d"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1OTMxNzg0", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#pullrequestreview-495931784", "createdAt": "2020-09-24T20:36:00Z", "commit": {"oid": "6e1a9d88eff2a8905f0d02b9eb1ef87b2a998e5d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMDozNjowMFrOHXrtKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMDozNjowMFrOHXrtKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5NTM3MA==", "bodyText": "instead here we should have something that will not block other threads when deleting the dir and just return, something like\nFile dir;\nsynchronized(this) {\n  if (cacheDir == null) {\n    return;\n  }\n  dir = cacheDir;\n  cacheDir = null;\n}\nif (dir.exists()) {\n  FileSystemImpl.delete(dir.toPath(), true);\n}", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r494595370", "createdAt": "2020-09-24T20:36:00Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -398,18 +408,20 @@ private synchronized void setupCacheDir(String id) {\n       }\n     });\n     Runtime.getRuntime().addShutdownHook(shutdownHook);\n+    return cacheDir;\n   }\n \n   private void deleteCacheDir() throws IOException {\n-    Path path;\n+    if (cacheDir == null || !cacheDir.exists()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e1a9d88eff2a8905f0d02b9eb1ef87b2a998e5d"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1OTMyMDYy", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#pullrequestreview-495932062", "createdAt": "2020-09-24T20:36:27Z", "commit": {"oid": "6e1a9d88eff2a8905f0d02b9eb1ef87b2a998e5d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05e70fe98166aa2962aeb58b5a2dea3ba0668e12", "author": {"user": {"login": "pmlopes", "name": "Paulo Lopes"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/05e70fe98166aa2962aeb58b5a2dea3ba0668e12", "committedDate": "2020-09-25T14:46:29Z", "message": "Refactor based on review + more checks\n\nSigned-off-by: Paulo Lopes <pmlopes@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2OTk3MTMx", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#pullrequestreview-496997131", "createdAt": "2020-09-26T10:59:41Z", "commit": {"oid": "05e70fe98166aa2962aeb58b5a2dea3ba0668e12"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxMDo1OTo0MVrOHYfkqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxMDo1OTo0MVrOHYfkqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTE2Mw==", "bodyText": "shouldn't we rather log this instead of throwing ?", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r495445163", "createdAt": "2020-09-26T10:59:41Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -236,10 +242,15 @@ private synchronized File unpackFromFileURL(URL url, String fileName, ClassLoade\n     } else {\n       cacheFile.mkdirs();\n       String[] listing = resource.list();\n-      for (String file: listing) {\n-        String subResource = fileName + \"/\" + file;\n-        URL url2 = getValidClassLoaderResource(cl, subResource);\n-        unpackFromFileURL(url2, subResource, cl);\n+      if (listing != null) {\n+        for (String file: listing) {\n+          String subResource = fileName + \"/\" + file;\n+          URL url2 = getValidClassLoaderResource(cl, subResource);\n+          if (url2 == null) {\n+            throw new VertxException(\"Invalid resource: \" + subResource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05e70fe98166aa2962aeb58b5a2dea3ba0668e12"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2OTk3MTYw", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#pullrequestreview-496997160", "createdAt": "2020-09-26T11:00:13Z", "commit": {"oid": "05e70fe98166aa2962aeb58b5a2dea3ba0668e12"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxMTowMDoxM1rOHYfk4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxMTowMDoxM1rOHYfk4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTIxNg==", "bodyText": "should read under synchronized", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r495445216", "createdAt": "2020-09-26T11:00:13Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -375,14 +386,34 @@ private ClassLoader getClassLoader() {\n     return cl;\n   }\n \n-  private synchronized void setupCacheDir(String id) {\n-    String cacheDirName = fileCacheDir + \"/file-cache-\" + id;\n-    cacheDir = new File(cacheDirName);\n+  /**\n+   * Will prepare the cache directory to be used in the application or return null if classpath resolving is disabled.\n+   */\n+  private File setupCacheDir(String fileCacheDir) {\n+    if (!this.enableCpResolving) {\n+      return null;\n+    }\n+\n+    // ensure that the argument doesn't end with separator\n+    if (fileCacheDir.endsWith(File.separator)) {\n+      fileCacheDir = fileCacheDir.substring(0, fileCacheDir.length() - File.separator.length());\n+    }\n+\n+    // the cachedir will be prefixed a unique id to avoid eavesdroping from other processes\n+    // also this ensures that if process A deletes cacheDir, it won't affect process B\n+    String cacheDirName = fileCacheDir + \"-\" + UUID.randomUUID().toString();\n+    File cacheDir = new File(cacheDirName);\n+\n     if (!cacheDir.mkdirs()) {\n       throw new IllegalStateException(\"Failed to create cache dir: \" + cacheDirName);\n     }\n     // Add shutdown hook to delete on exit\n     shutdownHook = new Thread(() -> {\n+      // no-op if cache dir has been set to null\n+      if (this.cacheDir == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05e70fe98166aa2962aeb58b5a2dea3ba0668e12"}, "originalPosition": 128}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2OTk3MjE3", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#pullrequestreview-496997217", "createdAt": "2020-09-26T11:01:21Z", "commit": {"oid": "05e70fe98166aa2962aeb58b5a2dea3ba0668e12"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxMTowMToyMVrOHYflSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxMTowMToyMVrOHYflSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTMyMg==", "bodyText": "this should be done under synchronization", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r495445322", "createdAt": "2020-09-26T11:01:21Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -398,18 +429,26 @@ private synchronized void setupCacheDir(String id) {\n       }\n     });\n     Runtime.getRuntime().addShutdownHook(shutdownHook);\n+    return cacheDir;\n   }\n \n   private void deleteCacheDir() throws IOException {\n-    Path path;\n+    if (cacheDir == null || !cacheDir.exists()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05e70fe98166aa2962aeb58b5a2dea3ba0668e12"}, "originalPosition": 144}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2OTk3MjQ5", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#pullrequestreview-496997249", "createdAt": "2020-09-26T11:01:53Z", "commit": {"oid": "05e70fe98166aa2962aeb58b5a2dea3ba0668e12"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6196934b5971e89755ceb8b15e07f4dd3860c786", "author": {"user": {"login": "pmlopes", "name": "Paulo Lopes"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/6196934b5971e89755ceb8b15e07f4dd3860c786", "committedDate": "2020-09-28T10:01:37Z", "message": "Updates based on review feedback\n\nSigned-off-by: Paulo Lopes <pmlopes@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwOTA3MzI1", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#pullrequestreview-500907325", "createdAt": "2020-10-02T07:20:02Z", "commit": {"oid": "6196934b5971e89755ceb8b15e07f4dd3860c786"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzoyMDowMlrOHbjX-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzoyMDowMlrOHbjX-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1MzE3OQ==", "bodyText": "you can remove this check as it is not synchronized and only check within the synchronized block.", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r498653179", "createdAt": "2020-10-02T07:20:02Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -101,29 +100,32 @@ public FileResolver() {\n   public FileResolver(FileSystemOptions fileSystemOptions) {\n     this.enableCaching = fileSystemOptions.isFileCachingEnabled();\n     this.enableCpResolving = fileSystemOptions.isClassPathResolvingEnabled();\n-    this.fileCacheDir = fileSystemOptions.getFileCacheDir();\n \n     String cwdOverride = System.getProperty(\"vertx.cwd\");\n     if (cwdOverride != null) {\n       cwd = new File(cwdOverride).getAbsoluteFile();\n     } else {\n       cwd = null;\n     }\n-    if (this.enableCpResolving) {\n-      setupCacheDir(UUID.randomUUID().toString());\n-    }\n+    cacheDir = setupCacheDir(fileSystemOptions.getFileCacheDir());\n   }\n \n   /**\n    * Close this file resolver, this is a blocking operation.\n    */\n   public void close() throws IOException {\n-    synchronized (this) {\n-      if (shutdownHook != null) {\n-        // May throw IllegalStateException if called from other shutdown hook so ignore that\n-        try {\n-          Runtime.getRuntime().removeShutdownHook(shutdownHook);\n-        } catch (IllegalStateException ignore) {\n+    // avoid monitor, if already disabled\n+    if (shutdownHook != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6196934b5971e89755ceb8b15e07f4dd3860c786"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwOTA4NzY5", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#pullrequestreview-500908769", "createdAt": "2020-10-02T07:22:47Z", "commit": {"oid": "6196934b5971e89755ceb8b15e07f4dd3860c786"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzoyMjo0OFrOHbjb7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzoyMjo0OFrOHbjb7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1NDE5MA==", "bodyText": "what you can do is\nThread hook;\nsynchronized (this) {\n  hook =  shutdownHook;\n  shutdownHook = null;\n}\nif (hook != null) {\n  // Remove hook\n}", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r498654190", "createdAt": "2020-10-02T07:22:48Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -101,29 +100,32 @@ public FileResolver() {\n   public FileResolver(FileSystemOptions fileSystemOptions) {\n     this.enableCaching = fileSystemOptions.isFileCachingEnabled();\n     this.enableCpResolving = fileSystemOptions.isClassPathResolvingEnabled();\n-    this.fileCacheDir = fileSystemOptions.getFileCacheDir();\n \n     String cwdOverride = System.getProperty(\"vertx.cwd\");\n     if (cwdOverride != null) {\n       cwd = new File(cwdOverride).getAbsoluteFile();\n     } else {\n       cwd = null;\n     }\n-    if (this.enableCpResolving) {\n-      setupCacheDir(UUID.randomUUID().toString());\n-    }\n+    cacheDir = setupCacheDir(fileSystemOptions.getFileCacheDir());\n   }\n \n   /**\n    * Close this file resolver, this is a blocking operation.\n    */\n   public void close() throws IOException {\n-    synchronized (this) {\n-      if (shutdownHook != null) {\n-        // May throw IllegalStateException if called from other shutdown hook so ignore that\n-        try {\n-          Runtime.getRuntime().removeShutdownHook(shutdownHook);\n-        } catch (IllegalStateException ignore) {\n+    // avoid monitor, if already disabled\n+    if (shutdownHook != null) {\n+      synchronized (this) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6196934b5971e89755ceb8b15e07f4dd3860c786"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a888a15cba05a7ea4bbba829a7caa71630dd5a3", "author": {"user": {"login": "pmlopes", "name": "Paulo Lopes"}}, "url": "https://github.com/eclipse-vertx/vert.x/commit/0a888a15cba05a7ea4bbba829a7caa71630dd5a3", "committedDate": "2020-10-02T08:08:17Z", "message": "less locking\n\nSigned-off-by: Paulo Lopes <pmlopes@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwOTU0NDEw", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#pullrequestreview-500954410", "createdAt": "2020-10-02T08:37:10Z", "commit": {"oid": "0a888a15cba05a7ea4bbba829a7caa71630dd5a3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1702, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}