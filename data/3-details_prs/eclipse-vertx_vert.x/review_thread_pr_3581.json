{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxNjU3MDk2", "number": 3581, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMDozMjo0NlrOEnNX9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzoyMjo0OFrOEpttuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTQ5MDQ2OnYy", "diffSide": "RIGHT", "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMDozMjo0NlrOHXrmgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMDozMjo0NlrOHXrmgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5MzY2NA==", "bodyText": "this is called from the constructor so it does not need to be synchronized", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r494593664", "createdAt": "2020-09-24T20:32:46Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -375,9 +370,24 @@ private ClassLoader getClassLoader() {\n     return cl;\n   }\n \n-  private synchronized void setupCacheDir(String id) {\n-    String cacheDirName = fileCacheDir + \"/file-cache-\" + id;\n-    cacheDir = new File(cacheDirName);\n+  /**\n+   * Will prepare the cache directory to be used in the application or return null if classpath resolving is disabled.\n+   */\n+  private synchronized File setupCacheDir(String fileCacheDir) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e1a9d88eff2a8905f0d02b9eb1ef87b2a998e5d"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTUwMTYxOnYy", "diffSide": "RIGHT", "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMDozNjowMFrOHXrtKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMDozNjowMFrOHXrtKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5NTM3MA==", "bodyText": "instead here we should have something that will not block other threads when deleting the dir and just return, something like\nFile dir;\nsynchronized(this) {\n  if (cacheDir == null) {\n    return;\n  }\n  dir = cacheDir;\n  cacheDir = null;\n}\nif (dir.exists()) {\n  FileSystemImpl.delete(dir.toPath(), true);\n}", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r494595370", "createdAt": "2020-09-24T20:36:00Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -398,18 +408,20 @@ private synchronized void setupCacheDir(String id) {\n       }\n     });\n     Runtime.getRuntime().addShutdownHook(shutdownHook);\n+    return cacheDir;\n   }\n \n   private void deleteCacheDir() throws IOException {\n-    Path path;\n+    if (cacheDir == null || !cacheDir.exists()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e1a9d88eff2a8905f0d02b9eb1ef87b2a998e5d"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTAxNzQ0OnYy", "diffSide": "RIGHT", "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxMDo1OTo0MVrOHYfkqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwNToxMjowNFrOHYkvgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTE2Mw==", "bodyText": "shouldn't we rather log this instead of throwing ?", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r495445163", "createdAt": "2020-09-26T10:59:41Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -236,10 +242,15 @@ private synchronized File unpackFromFileURL(URL url, String fileName, ClassLoade\n     } else {\n       cacheFile.mkdirs();\n       String[] listing = resource.list();\n-      for (String file: listing) {\n-        String subResource = fileName + \"/\" + file;\n-        URL url2 = getValidClassLoaderResource(cl, subResource);\n-        unpackFromFileURL(url2, subResource, cl);\n+      if (listing != null) {\n+        for (String file: listing) {\n+          String subResource = fileName + \"/\" + file;\n+          URL url2 = getValidClassLoaderResource(cl, subResource);\n+          if (url2 == null) {\n+            throw new VertxException(\"Invalid resource: \" + subResource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05e70fe98166aa2962aeb58b5a2dea3ba0668e12"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyOTg1Nw==", "bodyText": "Currently we throw npe, without a clear message on which resource caused it. I kept the behavior but you also see which resource triggered it.", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r495529857", "createdAt": "2020-09-27T05:12:04Z", "author": {"login": "pmlopes"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -236,10 +242,15 @@ private synchronized File unpackFromFileURL(URL url, String fileName, ClassLoade\n     } else {\n       cacheFile.mkdirs();\n       String[] listing = resource.list();\n-      for (String file: listing) {\n-        String subResource = fileName + \"/\" + file;\n-        URL url2 = getValidClassLoaderResource(cl, subResource);\n-        unpackFromFileURL(url2, subResource, cl);\n+      if (listing != null) {\n+        for (String file: listing) {\n+          String subResource = fileName + \"/\" + file;\n+          URL url2 = getValidClassLoaderResource(cl, subResource);\n+          if (url2 == null) {\n+            throw new VertxException(\"Invalid resource: \" + subResource);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTE2Mw=="}, "originalCommit": {"oid": "05e70fe98166aa2962aeb58b5a2dea3ba0668e12"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTAxNzkxOnYy", "diffSide": "RIGHT", "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxMTowMDoxM1rOHYfk4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxMTowMDoxM1rOHYfk4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTIxNg==", "bodyText": "should read under synchronized", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r495445216", "createdAt": "2020-09-26T11:00:13Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -375,14 +386,34 @@ private ClassLoader getClassLoader() {\n     return cl;\n   }\n \n-  private synchronized void setupCacheDir(String id) {\n-    String cacheDirName = fileCacheDir + \"/file-cache-\" + id;\n-    cacheDir = new File(cacheDirName);\n+  /**\n+   * Will prepare the cache directory to be used in the application or return null if classpath resolving is disabled.\n+   */\n+  private File setupCacheDir(String fileCacheDir) {\n+    if (!this.enableCpResolving) {\n+      return null;\n+    }\n+\n+    // ensure that the argument doesn't end with separator\n+    if (fileCacheDir.endsWith(File.separator)) {\n+      fileCacheDir = fileCacheDir.substring(0, fileCacheDir.length() - File.separator.length());\n+    }\n+\n+    // the cachedir will be prefixed a unique id to avoid eavesdroping from other processes\n+    // also this ensures that if process A deletes cacheDir, it won't affect process B\n+    String cacheDirName = fileCacheDir + \"-\" + UUID.randomUUID().toString();\n+    File cacheDir = new File(cacheDirName);\n+\n     if (!cacheDir.mkdirs()) {\n       throw new IllegalStateException(\"Failed to create cache dir: \" + cacheDirName);\n     }\n     // Add shutdown hook to delete on exit\n     shutdownHook = new Thread(() -> {\n+      // no-op if cache dir has been set to null\n+      if (this.cacheDir == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05e70fe98166aa2962aeb58b5a2dea3ba0668e12"}, "originalPosition": 128}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTAxODgyOnYy", "diffSide": "RIGHT", "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxMTowMToyMVrOHYflSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxMTowMToyMVrOHYflSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTMyMg==", "bodyText": "this should be done under synchronization", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r495445322", "createdAt": "2020-09-26T11:01:21Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -398,18 +429,26 @@ private synchronized void setupCacheDir(String id) {\n       }\n     });\n     Runtime.getRuntime().addShutdownHook(shutdownHook);\n+    return cacheDir;\n   }\n \n   private void deleteCacheDir() throws IOException {\n-    Path path;\n+    if (cacheDir == null || !cacheDir.exists()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05e70fe98166aa2962aeb58b5a2dea3ba0668e12"}, "originalPosition": 144}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTc1NDAzOnYy", "diffSide": "RIGHT", "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzoyMDowMlrOHbjX-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzoyMDowMlrOHbjX-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1MzE3OQ==", "bodyText": "you can remove this check as it is not synchronized and only check within the synchronized block.", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r498653179", "createdAt": "2020-10-02T07:20:02Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -101,29 +100,32 @@ public FileResolver() {\n   public FileResolver(FileSystemOptions fileSystemOptions) {\n     this.enableCaching = fileSystemOptions.isFileCachingEnabled();\n     this.enableCpResolving = fileSystemOptions.isClassPathResolvingEnabled();\n-    this.fileCacheDir = fileSystemOptions.getFileCacheDir();\n \n     String cwdOverride = System.getProperty(\"vertx.cwd\");\n     if (cwdOverride != null) {\n       cwd = new File(cwdOverride).getAbsoluteFile();\n     } else {\n       cwd = null;\n     }\n-    if (this.enableCpResolving) {\n-      setupCacheDir(UUID.randomUUID().toString());\n-    }\n+    cacheDir = setupCacheDir(fileSystemOptions.getFileCacheDir());\n   }\n \n   /**\n    * Close this file resolver, this is a blocking operation.\n    */\n   public void close() throws IOException {\n-    synchronized (this) {\n-      if (shutdownHook != null) {\n-        // May throw IllegalStateException if called from other shutdown hook so ignore that\n-        try {\n-          Runtime.getRuntime().removeShutdownHook(shutdownHook);\n-        } catch (IllegalStateException ignore) {\n+    // avoid monitor, if already disabled\n+    if (shutdownHook != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6196934b5971e89755ceb8b15e07f4dd3860c786"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTc2MDU2OnYy", "diffSide": "RIGHT", "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzoyMjo0OFrOHbjb7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzoyMzo0M1rOHbjdWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1NDE5MA==", "bodyText": "what you can do is\nThread hook;\nsynchronized (this) {\n  hook =  shutdownHook;\n  shutdownHook = null;\n}\nif (hook != null) {\n  // Remove hook\n}", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r498654190", "createdAt": "2020-10-02T07:22:48Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -101,29 +100,32 @@ public FileResolver() {\n   public FileResolver(FileSystemOptions fileSystemOptions) {\n     this.enableCaching = fileSystemOptions.isFileCachingEnabled();\n     this.enableCpResolving = fileSystemOptions.isClassPathResolvingEnabled();\n-    this.fileCacheDir = fileSystemOptions.getFileCacheDir();\n \n     String cwdOverride = System.getProperty(\"vertx.cwd\");\n     if (cwdOverride != null) {\n       cwd = new File(cwdOverride).getAbsoluteFile();\n     } else {\n       cwd = null;\n     }\n-    if (this.enableCpResolving) {\n-      setupCacheDir(UUID.randomUUID().toString());\n-    }\n+    cacheDir = setupCacheDir(fileSystemOptions.getFileCacheDir());\n   }\n \n   /**\n    * Close this file resolver, this is a blocking operation.\n    */\n   public void close() throws IOException {\n-    synchronized (this) {\n-      if (shutdownHook != null) {\n-        // May throw IllegalStateException if called from other shutdown hook so ignore that\n-        try {\n-          Runtime.getRuntime().removeShutdownHook(shutdownHook);\n-        } catch (IllegalStateException ignore) {\n+    // avoid monitor, if already disabled\n+    if (shutdownHook != null) {\n+      synchronized (this) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6196934b5971e89755ceb8b15e07f4dd3860c786"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1NDU1NA==", "bodyText": "Like you did in deleteCacheDir", "url": "https://github.com/eclipse-vertx/vert.x/pull/3581#discussion_r498654554", "createdAt": "2020-10-02T07:23:43Z", "author": {"login": "vietj"}, "path": "src/main/java/io/vertx/core/file/impl/FileResolver.java", "diffHunk": "@@ -101,29 +100,32 @@ public FileResolver() {\n   public FileResolver(FileSystemOptions fileSystemOptions) {\n     this.enableCaching = fileSystemOptions.isFileCachingEnabled();\n     this.enableCpResolving = fileSystemOptions.isClassPathResolvingEnabled();\n-    this.fileCacheDir = fileSystemOptions.getFileCacheDir();\n \n     String cwdOverride = System.getProperty(\"vertx.cwd\");\n     if (cwdOverride != null) {\n       cwd = new File(cwdOverride).getAbsoluteFile();\n     } else {\n       cwd = null;\n     }\n-    if (this.enableCpResolving) {\n-      setupCacheDir(UUID.randomUUID().toString());\n-    }\n+    cacheDir = setupCacheDir(fileSystemOptions.getFileCacheDir());\n   }\n \n   /**\n    * Close this file resolver, this is a blocking operation.\n    */\n   public void close() throws IOException {\n-    synchronized (this) {\n-      if (shutdownHook != null) {\n-        // May throw IllegalStateException if called from other shutdown hook so ignore that\n-        try {\n-          Runtime.getRuntime().removeShutdownHook(shutdownHook);\n-        } catch (IllegalStateException ignore) {\n+    // avoid monitor, if already disabled\n+    if (shutdownHook != null) {\n+      synchronized (this) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1NDE5MA=="}, "originalCommit": {"oid": "6196934b5971e89755ceb8b15e07f4dd3860c786"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4524, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}