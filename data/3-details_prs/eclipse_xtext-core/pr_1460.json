{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNTMzOTQ0", "number": 1460, "title": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.", "bodyText": "Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n\nSigned-off-by: Tamas Miklossy miklossy@itemis.de", "createdAt": "2020-04-29T07:17:57Z", "url": "https://github.com/eclipse/xtext-core/pull/1460", "merged": true, "mergeCommit": {"oid": "dfdceddc5cc4ff11b3605c4d88b787c4c591cf1f"}, "closed": true, "closedAt": "2020-05-12T15:54:35Z", "author": {"login": "miklossy"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccTnyagFqTQwMjQyOTMyMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgmXIZgBqjMzMjgxNzI5NzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNDI5MzIw", "url": "https://github.com/eclipse/xtext-core/pull/1460#pullrequestreview-402429320", "createdAt": "2020-04-29T07:42:21Z", "commit": {"oid": "456963cc6d1207a94b021921afd2f2dba6d36293"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNzo0MjoyMVrOGNzPFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNzo0NjoyN1rOGNzXfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyNDExNw==", "bodyText": "Unfortunately this is not generally applicable, e.g. languages with synthetic tokens or semantic whitespace will break. This method must at least be protected", "url": "https://github.com/eclipse/xtext-core/pull/1460#discussion_r417124117", "createdAt": "2020-04-29T07:42:21Z", "author": {"login": "szarnekow"}, "path": "org.eclipse.xtext/src/org/eclipse/xtext/serializer/impl/Serializer.java", "diffHunk": "@@ -210,7 +211,28 @@ public ReplaceRegion serializeReplacement(EObject obj, SaveOptions options) {\n \t\t\tthrow new IllegalStateException(\"Cannot replace an obj that has no associated node\");\n \t\t}\n \t\tString text = serialize(obj, options);\n-\t\treturn new ReplaceRegion(node.getTotalOffset(), node.getTotalLength(), text);\n+\t\tint replaceRegionLength = calculateReplaceRegionLength(node, text);\n+\t\treturn new ReplaceRegion(node.getTotalOffset(), replaceRegionLength, text);\n \t}\n \n+\tprivate int calculateReplaceRegionLength(ICompositeNode node, String text) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456963cc6d1207a94b021921afd2f2dba6d36293"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyNDQ4NQ==", "bodyText": "Checks against implementation classes of the node model must be avoided. Please use instanceof ILeafNode && node.isHidden() instead.", "url": "https://github.com/eclipse/xtext-core/pull/1460#discussion_r417124485", "createdAt": "2020-04-29T07:43:00Z", "author": {"login": "szarnekow"}, "path": "org.eclipse.xtext/src/org/eclipse/xtext/serializer/impl/Serializer.java", "diffHunk": "@@ -210,7 +211,28 @@ public ReplaceRegion serializeReplacement(EObject obj, SaveOptions options) {\n \t\t\tthrow new IllegalStateException(\"Cannot replace an obj that has no associated node\");\n \t\t}\n \t\tString text = serialize(obj, options);\n-\t\treturn new ReplaceRegion(node.getTotalOffset(), node.getTotalLength(), text);\n+\t\tint replaceRegionLength = calculateReplaceRegionLength(node, text);\n+\t\treturn new ReplaceRegion(node.getTotalOffset(), replaceRegionLength, text);\n \t}\n \n+\tprivate int calculateReplaceRegionLength(ICompositeNode node, String text) {\n+\t\tint oldTextLength = node.getTotalLength();\n+\t\tint newTextLength = text.length();\n+\n+\t\tif (newTextLength > oldTextLength) {\n+\t\t\tString remainingText = text.substring(oldTextLength);\n+\t\t\tif (containsOnlyWhiteSpaces(remainingText) && whiteSpaceFollows(node)) {\n+\t\t\t\treturn newTextLength;\n+\t\t\t}\n+\t\t}\n+\t\treturn oldTextLength;\n+\t}\n+\n+\tprivate boolean whiteSpaceFollows(ICompositeNode node) {\n+\t\treturn node.hasNextSibling() && node.getNextSibling() instanceof HiddenLeafNode;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456963cc6d1207a94b021921afd2f2dba6d36293"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyNDk2Ng==", "bodyText": "Could be CharMatcher.whitespac().matchesAllOf(text)", "url": "https://github.com/eclipse/xtext-core/pull/1460#discussion_r417124966", "createdAt": "2020-04-29T07:43:58Z", "author": {"login": "szarnekow"}, "path": "org.eclipse.xtext/src/org/eclipse/xtext/serializer/impl/Serializer.java", "diffHunk": "@@ -210,7 +211,28 @@ public ReplaceRegion serializeReplacement(EObject obj, SaveOptions options) {\n \t\t\tthrow new IllegalStateException(\"Cannot replace an obj that has no associated node\");\n \t\t}\n \t\tString text = serialize(obj, options);\n-\t\treturn new ReplaceRegion(node.getTotalOffset(), node.getTotalLength(), text);\n+\t\tint replaceRegionLength = calculateReplaceRegionLength(node, text);\n+\t\treturn new ReplaceRegion(node.getTotalOffset(), replaceRegionLength, text);\n \t}\n \n+\tprivate int calculateReplaceRegionLength(ICompositeNode node, String text) {\n+\t\tint oldTextLength = node.getTotalLength();\n+\t\tint newTextLength = text.length();\n+\n+\t\tif (newTextLength > oldTextLength) {\n+\t\t\tString remainingText = text.substring(oldTextLength);\n+\t\t\tif (containsOnlyWhiteSpaces(remainingText) && whiteSpaceFollows(node)) {\n+\t\t\t\treturn newTextLength;\n+\t\t\t}\n+\t\t}\n+\t\treturn oldTextLength;\n+\t}\n+\n+\tprivate boolean whiteSpaceFollows(ICompositeNode node) {\n+\t\treturn node.hasNextSibling() && node.getNextSibling() instanceof HiddenLeafNode;\n+\t}\n+\n+\tprivate boolean containsOnlyWhiteSpaces(String text) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456963cc6d1207a94b021921afd2f2dba6d36293"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyNjAyOQ==", "bodyText": "In any case, the logic here is unfortunately flawed. If I understand the intention behind this code correctly, it must be something like node.getLeadNodes().head().isHidden() - though the name whiteSpaceFollows is misleading given that comment nodes are also hidden.", "url": "https://github.com/eclipse/xtext-core/pull/1460#discussion_r417126029", "createdAt": "2020-04-29T07:46:03Z", "author": {"login": "szarnekow"}, "path": "org.eclipse.xtext/src/org/eclipse/xtext/serializer/impl/Serializer.java", "diffHunk": "@@ -210,7 +211,28 @@ public ReplaceRegion serializeReplacement(EObject obj, SaveOptions options) {\n \t\t\tthrow new IllegalStateException(\"Cannot replace an obj that has no associated node\");\n \t\t}\n \t\tString text = serialize(obj, options);\n-\t\treturn new ReplaceRegion(node.getTotalOffset(), node.getTotalLength(), text);\n+\t\tint replaceRegionLength = calculateReplaceRegionLength(node, text);\n+\t\treturn new ReplaceRegion(node.getTotalOffset(), replaceRegionLength, text);\n \t}\n \n+\tprivate int calculateReplaceRegionLength(ICompositeNode node, String text) {\n+\t\tint oldTextLength = node.getTotalLength();\n+\t\tint newTextLength = text.length();\n+\n+\t\tif (newTextLength > oldTextLength) {\n+\t\t\tString remainingText = text.substring(oldTextLength);\n+\t\t\tif (containsOnlyWhiteSpaces(remainingText) && whiteSpaceFollows(node)) {\n+\t\t\t\treturn newTextLength;\n+\t\t\t}\n+\t\t}\n+\t\treturn oldTextLength;\n+\t}\n+\n+\tprivate boolean whiteSpaceFollows(ICompositeNode node) {\n+\t\treturn node.hasNextSibling() && node.getNextSibling() instanceof HiddenLeafNode;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyNDQ4NQ=="}, "originalCommit": {"oid": "456963cc6d1207a94b021921afd2f2dba6d36293"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyNjA5Nw==", "bodyText": "whiteSpace -> whitespace", "url": "https://github.com/eclipse/xtext-core/pull/1460#discussion_r417126097", "createdAt": "2020-04-29T07:46:11Z", "author": {"login": "szarnekow"}, "path": "org.eclipse.xtext/src/org/eclipse/xtext/serializer/impl/Serializer.java", "diffHunk": "@@ -210,7 +211,28 @@ public ReplaceRegion serializeReplacement(EObject obj, SaveOptions options) {\n \t\t\tthrow new IllegalStateException(\"Cannot replace an obj that has no associated node\");\n \t\t}\n \t\tString text = serialize(obj, options);\n-\t\treturn new ReplaceRegion(node.getTotalOffset(), node.getTotalLength(), text);\n+\t\tint replaceRegionLength = calculateReplaceRegionLength(node, text);\n+\t\treturn new ReplaceRegion(node.getTotalOffset(), replaceRegionLength, text);\n \t}\n \n+\tprivate int calculateReplaceRegionLength(ICompositeNode node, String text) {\n+\t\tint oldTextLength = node.getTotalLength();\n+\t\tint newTextLength = text.length();\n+\n+\t\tif (newTextLength > oldTextLength) {\n+\t\t\tString remainingText = text.substring(oldTextLength);\n+\t\t\tif (containsOnlyWhiteSpaces(remainingText) && whiteSpaceFollows(node)) {\n+\t\t\t\treturn newTextLength;\n+\t\t\t}\n+\t\t}\n+\t\treturn oldTextLength;\n+\t}\n+\n+\tprivate boolean whiteSpaceFollows(ICompositeNode node) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456963cc6d1207a94b021921afd2f2dba6d36293"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyNjI2OQ==", "bodyText": "containsOnlyWhiteSpaces -> isWhitespace", "url": "https://github.com/eclipse/xtext-core/pull/1460#discussion_r417126269", "createdAt": "2020-04-29T07:46:27Z", "author": {"login": "szarnekow"}, "path": "org.eclipse.xtext/src/org/eclipse/xtext/serializer/impl/Serializer.java", "diffHunk": "@@ -210,7 +211,28 @@ public ReplaceRegion serializeReplacement(EObject obj, SaveOptions options) {\n \t\t\tthrow new IllegalStateException(\"Cannot replace an obj that has no associated node\");\n \t\t}\n \t\tString text = serialize(obj, options);\n-\t\treturn new ReplaceRegion(node.getTotalOffset(), node.getTotalLength(), text);\n+\t\tint replaceRegionLength = calculateReplaceRegionLength(node, text);\n+\t\treturn new ReplaceRegion(node.getTotalOffset(), replaceRegionLength, text);\n \t}\n \n+\tprivate int calculateReplaceRegionLength(ICompositeNode node, String text) {\n+\t\tint oldTextLength = node.getTotalLength();\n+\t\tint newTextLength = text.length();\n+\n+\t\tif (newTextLength > oldTextLength) {\n+\t\t\tString remainingText = text.substring(oldTextLength);\n+\t\t\tif (containsOnlyWhiteSpaces(remainingText) && whiteSpaceFollows(node)) {\n+\t\t\t\treturn newTextLength;\n+\t\t\t}\n+\t\t}\n+\t\treturn oldTextLength;\n+\t}\n+\n+\tprivate boolean whiteSpaceFollows(ICompositeNode node) {\n+\t\treturn node.hasNextSibling() && node.getNextSibling() instanceof HiddenLeafNode;\n+\t}\n+\n+\tprivate boolean containsOnlyWhiteSpaces(String text) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456963cc6d1207a94b021921afd2f2dba6d36293"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "456963cc6d1207a94b021921afd2f2dba6d36293", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/456963cc6d1207a94b021921afd2f2dba6d36293", "committedDate": "2020-04-29T07:16:14Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}, "afterCommit": {"oid": "2c23e10032880969563362918717f99f212c9e40", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/2c23e10032880969563362918717f99f212c9e40", "committedDate": "2020-04-29T08:14:59Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c23e10032880969563362918717f99f212c9e40", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/2c23e10032880969563362918717f99f212c9e40", "committedDate": "2020-04-29T08:14:59Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}, "afterCommit": {"oid": "9f7f2ee80fb1073d2319ed179d3e029606660e48", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/9f7f2ee80fb1073d2319ed179d3e029606660e48", "committedDate": "2020-05-08T07:32:28Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f7f2ee80fb1073d2319ed179d3e029606660e48", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/9f7f2ee80fb1073d2319ed179d3e029606660e48", "committedDate": "2020-05-08T07:32:28Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}, "afterCommit": {"oid": "fcb8e929483ef4aa46cf7c51ed91233dacdcb2d6", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/fcb8e929483ef4aa46cf7c51ed91233dacdcb2d6", "committedDate": "2020-05-08T14:55:01Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n- Implement corresponding SerializerReplacementCalculationTest test case\nbased on the NoJdtTestLanguage.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MDAyODcw", "url": "https://github.com/eclipse/xtext-core/pull/1460#pullrequestreview-409002870", "createdAt": "2020-05-11T09:21:26Z", "commit": {"oid": "fcb8e929483ef4aa46cf7c51ed91233dacdcb2d6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwOToyMToyNlrOGTT9rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwOToyMToyNlrOGTT9rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkwMzIxNA==", "bodyText": "If the next sibling is a composite node, it's first child may still be a hidden node.\nIf you want to catch those, too, I recommend to use something like nextSibling.getLeafNodes() and check the first node in that list.", "url": "https://github.com/eclipse/xtext-core/pull/1460#discussion_r422903214", "createdAt": "2020-05-11T09:21:26Z", "author": {"login": "szarnekow"}, "path": "org.eclipse.xtext/src/org/eclipse/xtext/serializer/impl/Serializer.java", "diffHunk": "@@ -210,7 +213,35 @@ public ReplaceRegion serializeReplacement(EObject obj, SaveOptions options) {\n \t\t\tthrow new IllegalStateException(\"Cannot replace an obj that has no associated node\");\n \t\t}\n \t\tString text = serialize(obj, options);\n-\t\treturn new ReplaceRegion(node.getTotalOffset(), node.getTotalLength(), text);\n+\t\tint replaceRegionLength = calculateReplaceRegionLength(node, text);\n+\t\treturn new ReplaceRegion(node.getTotalOffset(), replaceRegionLength, text);\n \t}\n \n+\tprotected int calculateReplaceRegionLength(ICompositeNode node, String text) {\n+\t\tint oldTextLength = node.getTotalLength();\n+\t\tint newTextLength = text.length();\n+\n+\t\tif (newTextLength > oldTextLength) {\n+\t\t\tString remainingText = text.substring(oldTextLength);\n+\t\t\tif (isWhitespace(remainingText) && hiddenNodeFollows(node)) {\n+\t\t\t\treturn newTextLength;\n+\t\t\t}\n+\t\t}\n+\t\treturn oldTextLength;\n+\t}\n+\n+\tprotected boolean hiddenNodeFollows(ICompositeNode node) {\n+\t\tif (node.hasNextSibling()) {\n+\t\t\tINode nextSibling = node.getNextSibling();\n+\t\t\tif (nextSibling instanceof ILeafNode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcb8e929483ef4aa46cf7c51ed91233dacdcb2d6"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MDA1MDU2", "url": "https://github.com/eclipse/xtext-core/pull/1460#pullrequestreview-409005056", "createdAt": "2020-05-11T09:24:21Z", "commit": {"oid": "fcb8e929483ef4aa46cf7c51ed91233dacdcb2d6"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcb8e929483ef4aa46cf7c51ed91233dacdcb2d6", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/fcb8e929483ef4aa46cf7c51ed91233dacdcb2d6", "committedDate": "2020-05-08T14:55:01Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n- Implement corresponding SerializerReplacementCalculationTest test case\nbased on the NoJdtTestLanguage.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}, "afterCommit": {"oid": "95dd60c60df32202f48c867c971a4a91d846baf6", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/95dd60c60df32202f48c867c971a4a91d846baf6", "committedDate": "2020-05-11T09:52:08Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n- Implement corresponding SerializerReplacementCalculationTest test case\nbased on the NoJdtTestLanguage.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "95dd60c60df32202f48c867c971a4a91d846baf6", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/95dd60c60df32202f48c867c971a4a91d846baf6", "committedDate": "2020-05-11T09:52:08Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n- Implement corresponding SerializerReplacementCalculationTest test case\nbased on the NoJdtTestLanguage.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}, "afterCommit": {"oid": "b3be053f97b9ff61033fdd7d37c481086a13f64f", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/b3be053f97b9ff61033fdd7d37c481086a13f64f", "committedDate": "2020-05-11T16:17:34Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n- Implement corresponding SerializerReplacementCalculationTest test case\nbased on the NoJdtTestLanguage.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMDQzMDU2", "url": "https://github.com/eclipse/xtext-core/pull/1460#pullrequestreview-410043056", "createdAt": "2020-05-12T13:31:20Z", "commit": {"oid": "b3be053f97b9ff61033fdd7d37c481086a13f64f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMzozMToyMFrOGUGs1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMzozMToyMFrOGUGs1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzczNDQ4Ng==", "bodyText": "Please also add @Since tags to the new methods.", "url": "https://github.com/eclipse/xtext-core/pull/1460#discussion_r423734486", "createdAt": "2020-05-12T13:31:20Z", "author": {"login": "szarnekow"}, "path": "org.eclipse.xtext/src/org/eclipse/xtext/serializer/impl/Serializer.java", "diffHunk": "@@ -210,7 +213,50 @@ public ReplaceRegion serializeReplacement(EObject obj, SaveOptions options) {\n \t\t\tthrow new IllegalStateException(\"Cannot replace an obj that has no associated node\");\n \t\t}\n \t\tString text = serialize(obj, options);\n-\t\treturn new ReplaceRegion(node.getTotalOffset(), node.getTotalLength(), text);\n+\t\tint replaceRegionLength = calculateReplaceRegionLength(node, text);\n+\t\treturn new ReplaceRegion(node.getTotalOffset(), replaceRegionLength, text);\n \t}\n \n+\tprotected int calculateReplaceRegionLength(ICompositeNode node, String text) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3be053f97b9ff61033fdd7d37c481086a13f64f"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3be053f97b9ff61033fdd7d37c481086a13f64f", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/b3be053f97b9ff61033fdd7d37c481086a13f64f", "committedDate": "2020-05-11T16:17:34Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n- Implement corresponding SerializerReplacementCalculationTest test case\nbased on the NoJdtTestLanguage.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}, "afterCommit": {"oid": "a9461115cff650e12320d22ba6f63d09ea8e8a91", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/a9461115cff650e12320d22ba6f63d09ea8e8a91", "committedDate": "2020-05-12T14:07:31Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n- Implement corresponding SerializerReplacementCalculationTest test case\nbased on the NoJdtTestLanguage.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMTgxOTk4", "url": "https://github.com/eclipse/xtext-core/pull/1460#pullrequestreview-410181998", "createdAt": "2020-05-12T15:50:05Z", "commit": {"oid": "a9461115cff650e12320d22ba6f63d09ea8e8a91"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNTo1MDowNVrOGUNUQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNTo1MDowNVrOGUNUQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0Mjg4Mg==", "bodyText": "Last thing that slipped through: This method should either be protected or the since tag is unnecessary.", "url": "https://github.com/eclipse/xtext-core/pull/1460#discussion_r423842882", "createdAt": "2020-05-12T15:50:05Z", "author": {"login": "szarnekow"}, "path": "org.eclipse.xtext/src/org/eclipse/xtext/serializer/impl/Serializer.java", "diffHunk": "@@ -210,7 +213,60 @@ public ReplaceRegion serializeReplacement(EObject obj, SaveOptions options) {\n \t\t\tthrow new IllegalStateException(\"Cannot replace an obj that has no associated node\");\n \t\t}\n \t\tString text = serialize(obj, options);\n-\t\treturn new ReplaceRegion(node.getTotalOffset(), node.getTotalLength(), text);\n+\t\tint replaceRegionLength = calculateReplaceRegionLength(node, text);\n+\t\treturn new ReplaceRegion(node.getTotalOffset(), replaceRegionLength, text);\n \t}\n \n+\t/**\n+\t * @since 2.22\n+\t */\n+\tprotected int calculateReplaceRegionLength(ICompositeNode node, String text) {\n+\t\tint oldTextLength = node.getTotalLength();\n+\t\tint newTextLength = text.length();\n+\n+\t\tif (newTextLength > oldTextLength) {\n+\t\t\tString remainingText = text.substring(oldTextLength);\n+\t\t\tif (isWhitespace(remainingText) && hiddenNodeFollows(node)) {\n+\t\t\t\treturn newTextLength;\n+\t\t\t}\n+\t\t}\n+\t\treturn oldTextLength;\n+\t}\n+\n+\t/**\n+\t * @since 2.22\n+\t */\n+\tprotected boolean hiddenNodeFollows(ICompositeNode node) {\n+\t\tINode followingNode = getFollowingNode(node);\n+\t\tif (followingNode instanceof ILeafNode) {\n+\t\t\treturn ((ILeafNode)followingNode).isHidden();\n+\t\t}\n+\t\treturn false;\n+\t}\n+\t\n+\t/**\n+\t * Returns the node that follows the <i>node</i>, independently, if they have the same parent.\n+\t * @since 2.22\n+\t */\n+\tprotected INode getFollowingNode(ICompositeNode node) {\n+\t\tif (node != null) {\n+\t\t\tif (node.hasNextSibling()) {\n+\t\t\t\tINode nextSibling = node.getNextSibling();\n+\t\t\t\tIterator<ILeafNode> nextSiblingLeafNodes = nextSibling.getLeafNodes().iterator();\n+\t\t\t\tif (nextSiblingLeafNodes.hasNext()) {\n+\t\t\t\t\treturn nextSiblingLeafNodes.next();\n+\t\t\t\t} else {\n+\t\t\t\t\treturn getFollowingNode(node.getParent());\n+\t\t\t\t}\t\n+\t\t\t}\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\t/**\n+\t * @since 2.22\n+\t */\n+\tprivate boolean isWhitespace(String text) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9461115cff650e12320d22ba6f63d09ea8e8a91"}, "originalPosition": 82}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMTgyMTI1", "url": "https://github.com/eclipse/xtext-core/pull/1460#pullrequestreview-410182125", "createdAt": "2020-05-12T15:50:11Z", "commit": {"oid": "a9461115cff650e12320d22ba6f63d09ea8e8a91"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "101baa8f82931865599a44c26b5e5fcbcafacda4", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/101baa8f82931865599a44c26b5e5fcbcafacda4", "committedDate": "2020-05-12T15:53:03Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n- Implement corresponding SerializerReplacementCalculationTest test case\nbased on the NoJdtTestLanguage.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9461115cff650e12320d22ba6f63d09ea8e8a91", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/a9461115cff650e12320d22ba6f63d09ea8e8a91", "committedDate": "2020-05-12T14:07:31Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n- Implement corresponding SerializerReplacementCalculationTest test case\nbased on the NoJdtTestLanguage.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}, "afterCommit": {"oid": "101baa8f82931865599a44c26b5e5fcbcafacda4", "author": {"user": {"login": "miklossy", "name": "Tamas Miklossy"}}, "url": "https://github.com/eclipse/xtext-core/commit/101baa8f82931865599a44c26b5e5fcbcafacda4", "committedDate": "2020-05-12T15:53:03Z", "message": "[https://github.com/eclipse/xtext-eclipse/issues/1221] Serializer.\n\n- Improve the serializeReplacement implementation by modifying the\nReplaceRegion length calculation so that it takes not only the\nICompositeNode.getTotalLength() into account, but considers if the new\ntext contains additional whitespaces and the old text is also followed\nby white spaces, than the whitespaces contained by the original document\nis also consumed by the quickfix.\n- Implement corresponding SerializerReplacementCalculationTest test case\nbased on the NoJdtTestLanguage.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4772, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}