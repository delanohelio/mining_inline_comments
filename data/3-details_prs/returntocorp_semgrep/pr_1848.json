{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0OTM2MjI4", "number": 1848, "title": "Spacegrep integration in Python layer", "bodyText": "This PR integrates spacegrep into the Python layer. It can be invoked using the language \"generic\".\n$ semgrep -l generic -e '## $X' README.md\nREADME.md\n63:## Getting\n98:## Examples\n112:## Try\n146:## Resources\n160:## Usage\n162:## Command\n166:## Exit\n174:## Upgrading\n189:## Contributing\n204:## Commercial\nran 1 rules on 1 files: 10 findings\n\nA few things of note:\n\nThe spacegrep offsets are bit off; the function _patch_lines fixes that for now.\nSemgrep needs the extra['lines'] key which is a list of matched lines. _patch_lines handles this for now.\nThis integration assumes spacegrep was installed somewhere that is on the system PATH.\nAn observation: Semgrep metavariables include the dollar sign '$' in front of them in the JSON output; spacegrep excludes the dollar sign at the moment.", "createdAt": "2020-10-16T15:42:01Z", "url": "https://github.com/returntocorp/semgrep/pull/1848", "merged": true, "mergeCommit": {"oid": "dcea455e1fe468ed5d4f94fb998a1f2f8644b6fa"}, "closed": true, "closedAt": "2020-10-21T05:19:47Z", "author": {"login": "minusworld"}, "timelineItems": {"totalCount": 33, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLwvz2AH2gAyNTA0OTM2MjI4OmJmMmFhMzcyMWQxM2E4MTJiMDlhMThiZThmYTM3NzQ0NzNhZTA3OTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUlXUsgH2gAyNTA0OTM2MjI4OjY5ZjNlNDg5ZWNlZDAyYTk2ZmFkN2UxMWNjN2U3MGM0MGJkODQyM2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bf2aa3721d13a812b09a18be8fa3774473ae0799", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/bf2aa3721d13a812b09a18be8fa3774473ae0799", "committedDate": "2020-09-23T18:18:04Z", "message": "Added 0.25.0 release date to CHANGELOG"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "769a651afe914ff1fd433373abcc92c72a04c86b", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/769a651afe914ff1fd433373abcc92c72a04c86b", "committedDate": "2020-09-29T17:55:11Z", "message": "Merge branch 'develop' of https://github.com/returntocorp/semgrep into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2329e8a5144fff82bec01ffe22d921034c958d7c", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/2329e8a5144fff82bec01ffe22d921034c958d7c", "committedDate": "2020-09-29T18:08:52Z", "message": "Replace 'pack' with 'set' in README"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4f61a09c250b68f1542f688bb3eaf41eb01287d", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/f4f61a09c250b68f1542f688bb3eaf41eb01287d", "committedDate": "2020-09-30T19:39:28Z", "message": "Merge branch 'develop' of https://github.com/returntocorp/semgrep into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb49f65075283ec2851cbd92e5caff94307c0f24", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/fb49f65075283ec2851cbd92e5caff94307c0f24", "committedDate": "2020-10-12T17:44:00Z", "message": "Merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a33817b43c9f3607e91cbf93ed3a1fa28c22cad", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/6a33817b43c9f3607e91cbf93ed3a1fa28c22cad", "committedDate": "2020-10-15T15:46:33Z", "message": "Merge branch 'develop' of https://github.com/returntocorp/semgrep into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c450fcbdd9de2cc8919a3cbc88481736765d3cfd", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/c450fcbdd9de2cc8919a3cbc88481736765d3cfd", "committedDate": "2020-10-15T16:29:36Z", "message": "Merge branch 'develop' of https://github.com/returntocorp/semgrep into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44c9647d0d529f76a40f48dde8c0099d932fec2d", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/44c9647d0d529f76a40f48dde8c0099d932fec2d", "committedDate": "2020-10-16T14:30:41Z", "message": "Merge branch 'develop' of https://github.com/returntocorp/semgrep into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24e167ac02488aab7ca448e11482581bf4fcc937", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/24e167ac02488aab7ca448e11482581bf4fcc937", "committedDate": "2020-10-16T15:42:21Z", "message": "wip: integrate spacegrep command"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d51e46ad1406b350a8e658ab3f1eff443af41eee", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/d51e46ad1406b350a8e658ab3f1eff443af41eee", "committedDate": "2020-10-16T15:42:21Z", "message": "add self"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a96eb0c5f3bc35e3f279e0a38a3a1d677f6a9759", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/a96eb0c5f3bc35e3f279e0a38a3a1d677f6a9759", "committedDate": "2020-10-16T15:42:21Z", "message": "spacegrep is invoked now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cabe8288058f2de75eca1b47416d510ea45f887e", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/cabe8288058f2de75eca1b47416d510ea45f887e", "committedDate": "2020-10-16T15:42:21Z", "message": "Add 'generic' to languages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a320e41bb48da76c5c55c429ae1126545eac2f89", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/a320e41bb48da76c5c55c429ae1126545eac2f89", "committedDate": "2020-10-16T15:42:21Z", "message": "Working spacegrep implementation, assuming spacegrep is on PATH. Refactored spacegrep integration code into spacegrep.py"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15dcaf999e285879558e6285399d6ace8d31a585", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/15dcaf999e285879558e6285399d6ace8d31a585", "committedDate": "2020-10-16T15:42:21Z", "message": "Support rule file compositions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2779e1411477147bccab6accc1c45ce810f4e748", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/2779e1411477147bccab6accc1c45ce810f4e748", "committedDate": "2020-10-16T15:42:21Z", "message": "Add tests for spacegrep"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3230ddd500a616e168c4cb5dede88ad72e0a09c8", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/3230ddd500a616e168c4cb5dede88ad72e0a09c8", "committedDate": "2020-10-16T15:42:21Z", "message": "Fix offset issue by using bol from spacegrep instead of cnum"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85192acd131ab14d90c6e2c6bd099681ffbf517a", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/85192acd131ab14d90c6e2c6bd099681ffbf517a", "committedDate": "2020-10-16T15:42:21Z", "message": "Add new test for spacegrep using raw HTTP response for funsies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fedf0277198505571dc8a9dfe85aadc857de79f", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/4fedf0277198505571dc8a9dfe85aadc857de79f", "committedDate": "2020-10-16T15:42:21Z", "message": "Find spacegrep binary on system rather than hardcode it; use new spacegrep output JSON format; patch in correct offsets, to be fixed in the future"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50cb9da318b7a9a2abdf95ec6c69a2a29cebd349", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/50cb9da318b7a9a2abdf95ec6c69a2a29cebd349", "committedDate": "2020-10-16T15:35:35Z", "message": "Find spacegrep binary on system rather than hardcode it; use new spacegrep output JSON format; patch in correct offsets, to be fixed in the future"}, "afterCommit": {"oid": "4fedf0277198505571dc8a9dfe85aadc857de79f", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/4fedf0277198505571dc8a9dfe85aadc857de79f", "committedDate": "2020-10-16T15:42:21Z", "message": "Find spacegrep binary on system rather than hardcode it; use new spacegrep output JSON format; patch in correct offsets, to be fixed in the future"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNjQ1MjI4", "url": "https://github.com/returntocorp/semgrep/pull/1848#pullrequestreview-510645228", "createdAt": "2020-10-16T16:57:23Z", "commit": {"oid": "4fedf0277198505571dc8a9dfe85aadc857de79f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNjo1NzoyM1rOHjIl1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNjo1NzoyM1rOHjIl1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYwMjk2Nw==", "bodyText": "ok, I'll look into this. I specifically added 1 here and there before exporting to json because a comment I found in the ocaml code said so.", "url": "https://github.com/returntocorp/semgrep/pull/1848#discussion_r506602967", "createdAt": "2020-10-16T16:57:23Z", "author": {"login": "mjambon"}, "path": "semgrep/semgrep/spacegrep.py", "diffHunk": "@@ -0,0 +1,93 @@\n+import json\n+import logging\n+import re\n+import subprocess\n+from pathlib import Path\n+from typing import Any\n+from typing import cast\n+from typing import Dict\n+from typing import List\n+from typing import Optional\n+\n+logger = logging.getLogger(__name__)\n+\n+from semgrep.constants import PLEASE_FILE_ISSUE_TEXT\n+from semgrep.constants import SPACEGREP_PATH\n+from semgrep.core_exception import CoreException\n+from semgrep.error import InvalidPatternError\n+from semgrep.pattern import Pattern\n+from semgrep.pattern_match import PatternMatch\n+from semgrep.util import sub_run\n+\n+\n+def run_spacegrep(patterns: List[Pattern], targets: List[Path]) -> dict:\n+    matches: List[dict] = []\n+    errors: List[dict] = []\n+    for pattern in patterns:\n+        if not isinstance(pattern._pattern, str):\n+            raise NotImplementedError(\n+                f\"Support for {type(pattern._pattern)} has not been implemented yet.\"\n+            )\n+        pattern_str = pattern._pattern  # TODO: Handle pattern Dict\n+        for target in targets:\n+            cmd = [\n+                SPACEGREP_PATH,\n+                \"--output-format\",\n+                \"semgrep\",\n+                \"-d\",\n+                str(target),\n+                pattern_str,\n+            ]\n+            p = sub_run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)\n+            raw_output = p.stdout\n+            raw_error = p.stderr\n+\n+            output_json = _parse_spacegrep_output(raw_output)\n+            output_json[\"matches\"] = _patch_id(pattern, output_json.get(\"matches\", []))\n+            output_json[\"matches\"] = _patch_lines(output_json.get(\"matches\", []))\n+\n+            matches.extend(output_json[\"matches\"])\n+            errors.extend(output_json[\"errors\"])\n+\n+    return {\n+        \"matches\": matches,\n+        \"errors\": errors,\n+    }\n+\n+\n+def _parse_spacegrep_output(raw_output: bytes) -> dict:\n+    try:\n+        output = raw_output.decode(\"utf-8\")\n+        data = json.loads(output)\n+        return cast(dict, data)\n+    except Exception:\n+        logger.error(\"spacegrep output could not be parsed as JSON.\")\n+        return {}\n+\n+\n+def _patch_id(pattern: Pattern, matches: List[dict]) -> List[dict]:\n+    patched = []\n+    for match in matches:\n+        match[\"check_id\"] = pattern._id\n+        patched.append(match)\n+    return patched\n+\n+\n+def _patch_lines(matches: List[dict]) -> List[dict]:\n+    patched = []\n+    for match in matches:\n+        with open(match[\"path\"], \"r\") as fin:\n+            data = fin.readlines()\n+        start_l = match.get(\"start\", {}).get(\"line\", 0)\n+        start_c = match.get(\"start\", {}).get(\"col\", 0)\n+        end_l = match.get(\"end\", {}).get(\"line\", 0)\n+        end_c = match.get(\"end\", {}).get(\"col\", 0)\n+\n+        lines = data[start_l - 2 : end_l - 1]\n+        lines[0] = lines[0][start_c - 1 :]\n+        lines[-1] = lines[-1][: end_c - 1]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fedf0277198505571dc8a9dfe85aadc857de79f"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNjQ1MzQz", "url": "https://github.com/returntocorp/semgrep/pull/1848#pullrequestreview-510645343", "createdAt": "2020-10-16T16:57:32Z", "commit": {"oid": "4fedf0277198505571dc8a9dfe85aadc857de79f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "366e9ae325fcebf4341484cacbab2911a8776d6a", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/366e9ae325fcebf4341484cacbab2911a8776d6a", "committedDate": "2020-10-16T17:13:42Z", "message": "Update test snapshots"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNjkxMDY2", "url": "https://github.com/returntocorp/semgrep/pull/1848#pullrequestreview-510691066", "createdAt": "2020-10-16T17:59:40Z", "commit": {"oid": "366e9ae325fcebf4341484cacbab2911a8776d6a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9be6190338099bc3a01e0432a1c188e84a7b9b4", "author": {"user": {"login": "mjambon", "name": "Martin Jambon"}}, "url": "https://github.com/returntocorp/semgrep/commit/e9be6190338099bc3a01e0432a1c188e84a7b9b4", "committedDate": "2020-10-17T02:34:25Z", "message": "WIP Trying to fix spacegrep problems in CI (#1854)\n\nAdd missing option for static linking spacegrep in CI."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a31dd35dd7ccd9b133f961181852070b408e62c", "author": {"user": null}, "url": "https://github.com/returntocorp/semgrep/commit/4a31dd35dd7ccd9b133f961181852070b408e62c", "committedDate": "2020-10-17T03:28:12Z", "message": "Fix permissions on osx artifacts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "596654e0142b51600e7a1cb33fb23086fbf2d7e5", "author": {"user": {"login": "mjambon", "name": "Martin Jambon"}}, "url": "https://github.com/returntocorp/semgrep/commit/596654e0142b51600e7a1cb33fb23086fbf2d7e5", "committedDate": "2020-10-19T21:32:00Z", "message": "Fix location bug and missing metavariable '$' in spacegrep's json output (#1853)\n\n* Fix location bug and missing metavariable '$' in spacegrep's json output\r\n\r\n* Clarify documentation about locations\r\n\r\n* Fix documentation\r\n\r\n* Remove compatibility crutch\r\n\r\n* Tentatively fix off-by-one line numbering\r\n\r\n* Update test snapshots\r\n\r\n* Update test snapshots.... again\r\n\r\nCo-authored-by: Martin Jambon <Martin Jambon>\r\nCo-authored-by: grayson <grayson@returntocorp.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3bb65148286fed464d4738c3decaee57ef49d9d", "author": {"user": null}, "url": "https://github.com/returntocorp/semgrep/commit/d3bb65148286fed464d4738c3decaee57ef49d9d", "committedDate": "2020-10-20T04:41:30Z", "message": "See what happens when we don't copy executables to /usr/bin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6079ad47b2e568772a62fcc4a278340c71ba6fe", "author": {"user": null}, "url": "https://github.com/returntocorp/semgrep/commit/b6079ad47b2e568772a62fcc4a278340c71ba6fe", "committedDate": "2020-10-21T00:26:23Z", "message": "Fail early if semgrep-core doesn't exist. Same thing for spacegrep."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daea78d405c3335bb63842775e2397af44b96e85", "author": {"user": null}, "url": "https://github.com/returntocorp/semgrep/commit/daea78d405c3335bb63842775e2397af44b96e85", "committedDate": "2020-10-21T02:03:50Z", "message": "Re-enable install into /usr/bin for testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6ee8881b88ed63fcae78658bc86fb918f96d0cc", "author": {"user": null}, "url": "https://github.com/returntocorp/semgrep/commit/e6ee8881b88ed63fcae78658bc86fb918f96d0cc", "committedDate": "2020-10-21T02:04:49Z", "message": "Copy spacegrep and spacecat into the wheel package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f415e8fa7792c579e9f30e3d2677c29013a2d77", "author": {"user": null}, "url": "https://github.com/returntocorp/semgrep/commit/8f415e8fa7792c579e9f30e3d2677c29013a2d77", "committedDate": "2020-10-21T03:15:35Z", "message": "Remove space before newline in expected test output."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMjc4MjQz", "url": "https://github.com/returntocorp/semgrep/pull/1848#pullrequestreview-513278243", "createdAt": "2020-10-21T03:20:02Z", "commit": {"oid": "8f415e8fa7792c579e9f30e3d2677c29013a2d77"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69f3e489eced02a96fad7e11cc7e70c40bd8423f", "author": {"user": null}, "url": "https://github.com/returntocorp/semgrep/commit/69f3e489eced02a96fad7e11cc7e70c40bd8423f", "committedDate": "2020-10-21T04:07:41Z", "message": "Remove trailing newline from expected output (introduced by accident by\nwell-intended text editor)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1200, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}