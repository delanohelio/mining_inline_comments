{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1Nzc3OTc1", "number": 1481, "title": "Match against destructured parameters with metavariables in js", "bodyText": "Previously, we could not match these, as we could not reuse the symbol\nin\nlet $FOO = arg.$FOO\nwhen matching\nlet foo = arg.foo\nHere we add the ability to match pure identifier nodes against\nidentifier expressions, allowing this match.\nFixes #1005.", "createdAt": "2020-08-10T23:18:07Z", "url": "https://github.com/returntocorp/semgrep/pull/1481", "merged": true, "mergeCommit": {"oid": "f5a5b0df585a2a3df61ee02496602259bd45f316"}, "closed": true, "closedAt": "2020-08-17T17:54:38Z", "author": {"login": "nbrahms"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9qpyTgH2gAyNDY1Nzc3OTc1OjA3N2I3OTlmMDM3NTNkODIyMWYwYzFkNmY2NjIxMDVhYTAyZWYwNDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_1hnmAH2gAyNDY1Nzc3OTc1Ojc1NzAyYWU4ZjVkNDlmOTRkNTA1YzIzMzRhYTRkZmRiNTlmMTFkODQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "077b799f03753d8221f0c1d6f662105aa02ef049", "author": {"user": {"login": "nbrahms", "name": "Nathaniel Brahms"}}, "url": "https://github.com/returntocorp/semgrep/commit/077b799f03753d8221f0c1d6f662105aa02ef049", "committedDate": "2020-08-10T23:17:07Z", "message": "Match against destructured parameters with metavariables in js\n\nPreviously, we could not match these, as we could not reuse the symbol\nin\n\n  let $FOO = arg.$FOO\n\nwhen matching\n\n  let foo = arg.foo\n\nHere we add the ability to match pure identifier nodes against\nidentifier expressions, allowing this match.\n\nFixes #1005."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NjQ5NzY1", "url": "https://github.com/returntocorp/semgrep/pull/1481#pullrequestreview-464649765", "createdAt": "2020-08-10T23:18:56Z", "commit": {"oid": "077b799f03753d8221f0c1d6f662105aa02ef049"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMzoxODo1N1rOG-i8XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMzoxODo1N1rOG-i8XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzNzQwNQ==", "bodyText": "Note that I also print debugging information even when the two node types differ.", "url": "https://github.com/returntocorp/semgrep/pull/1481#discussion_r468237405", "createdAt": "2020-08-10T23:18:57Z", "author": {"login": "nbrahms"}, "path": "semgrep-core/matching/Matching_generic.ml", "diffHunk": "@@ -218,16 +218,22 @@ let equal_ast_binded_code (a: AST.any) (b: AST.any) : bool =\n        *)\n       let a = Lib.abstract_position_info_any a in\n       let b = Lib.abstract_position_info_any b in\n-      let res = a =*= b in\n-      if !Flag.debug_matching && not res\n-      then begin\n-        pr2 (spf \"A = %s\" (str_of_any a));\n-        pr2 (spf \"B = %s\" (str_of_any b));\n-      end;\n-      res\n-\n+      a =*= b\n+  | A.I _, A.E (A.Id (b_id, _)) ->\n+    (* Allow identifier nodes to match pure identifier expressions *)\n+      equal_ast_binded_code a (A.I b_id)\n   | _, _ ->\n       false\n+  ) in\n+\n+  if !Flag.debug_matching && not res\n+  then begin", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "077b799f03753d8221f0c1d6f662105aa02ef049"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NjUwNzYw", "url": "https://github.com/returntocorp/semgrep/pull/1481#pullrequestreview-464650760", "createdAt": "2020-08-10T23:21:47Z", "commit": {"oid": "077b799f03753d8221f0c1d6f662105aa02ef049"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMzoyMTo0N1rOG-i_yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMzoyMTo0N1rOG-i_yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzODI4Mw==", "bodyText": "This isn't tail recursive, but it only ever gets to a stack depth of 2, so \ud83e\udd37", "url": "https://github.com/returntocorp/semgrep/pull/1481#discussion_r468238283", "createdAt": "2020-08-10T23:21:47Z", "author": {"login": "nbrahms"}, "path": "semgrep-core/matching/Matching_generic.ml", "diffHunk": "@@ -198,8 +198,8 @@ let (fail : tin -> tout) = fun _tin ->\n (* pre: both 'a' and 'b' contains only regular code; there are no\n  * metavariables inside them.\n  *)\n-let equal_ast_binded_code (a: AST.any) (b: AST.any) : bool =\n-  match a, b with\n+let rec equal_ast_binded_code (a: AST.any) (b: AST.any) : bool = (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "077b799f03753d8221f0c1d6f662105aa02ef049"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f21873269c36ed0b2fdb78893d056724ffcb9125", "author": {"user": {"login": "nbrahms", "name": "Nathaniel Brahms"}}, "url": "https://github.com/returntocorp/semgrep/commit/f21873269c36ed0b2fdb78893d056724ffcb9125", "committedDate": "2020-08-10T23:23:34Z", "message": "fixup! Match against destructured parameters with metavariables in js"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MjA2NzM1", "url": "https://github.com/returntocorp/semgrep/pull/1481#pullrequestreview-465206735", "createdAt": "2020-08-11T15:56:26Z", "commit": {"oid": "f21873269c36ed0b2fdb78893d056724ffcb9125"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNTo1NjoyNlrOG--ghA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNTo1NjoyNlrOG--ghA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY4OTAyOA==", "bodyText": "@aryx @mjambon I'm open to suggestions on how to do this better :)", "url": "https://github.com/returntocorp/semgrep/pull/1481#discussion_r468689028", "createdAt": "2020-08-11T15:56:26Z", "author": {"login": "nbrahms"}, "path": "semgrep-core/matching/Matching_generic.ml", "diffHunk": "@@ -218,16 +218,22 @@ let equal_ast_binded_code (a: AST.any) (b: AST.any) : bool =\n        *)\n       let a = Lib.abstract_position_info_any a in\n       let b = Lib.abstract_position_info_any b in\n-      let res = a =*= b in\n-      if !Flag.debug_matching && not res\n-      then begin\n-        pr2 (spf \"A = %s\" (str_of_any a));\n-        pr2 (spf \"B = %s\" (str_of_any b));\n-      end;\n-      res\n-\n+      a =*= b\n+  | A.I _, A.E (A.Id (b_id, _)) ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f21873269c36ed0b2fdb78893d056724ffcb9125"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NDI0NzQ5", "url": "https://github.com/returntocorp/semgrep/pull/1481#pullrequestreview-468424749", "createdAt": "2020-08-17T12:39:27Z", "commit": {"oid": "f21873269c36ed0b2fdb78893d056724ffcb9125"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMjozOToyN1rOHBnAwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMjo0NDozOVrOHBnLwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ0OTc5Mw==", "bodyText": "We might need also to handle the symetric pattern\nA.E (A.ID (a_id, _)), A.I _", "url": "https://github.com/returntocorp/semgrep/pull/1481#discussion_r471449793", "createdAt": "2020-08-17T12:39:27Z", "author": {"login": "aryx"}, "path": "semgrep-core/matching/Matching_generic.ml", "diffHunk": "@@ -218,16 +218,22 @@ let equal_ast_binded_code (a: AST.any) (b: AST.any) : bool =\n        *)\n       let a = Lib.abstract_position_info_any a in\n       let b = Lib.abstract_position_info_any b in\n-      let res = a =*= b in\n-      if !Flag.debug_matching && not res\n-      then begin\n-        pr2 (spf \"A = %s\" (str_of_any a));\n-        pr2 (spf \"B = %s\" (str_of_any b));\n-      end;\n-      res\n-\n+      a =*= b\n+  | A.I _, A.E (A.Id (b_id, _)) ->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY4OTAyOA=="}, "originalCommit": {"oid": "f21873269c36ed0b2fdb78893d056724ffcb9125"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ1MDI2OA==", "bodyText": "I would also add the simpler  const $X = foo.$X; more obvious testcase.", "url": "https://github.com/returntocorp/semgrep/pull/1481#discussion_r471450268", "createdAt": "2020-08-17T12:40:19Z", "author": {"login": "aryx"}, "path": "semgrep-core/tests/js/misc_destructuring_2.sgrep", "diffHunk": "@@ -0,0 +1,3 @@\n+function $F ({$FOO}, ...) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f21873269c36ed0b2fdb78893d056724ffcb9125"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ1MjYxMA==", "bodyText": "Maybe add a comment such as\n\"you should prefer to add metavar as expression (A.E), not id (A.I), see Generic_vs_generic.m_ident_and_id_info_add_in_env_Expr  but in some cases you have no choice\nand you need to match an expression metavar with an id metavar.\nFor example, we want the pattern 'const $X = foo.$X'  to match 'const bar = foo.bar' (this is useful in the Javascript transpilation context of complex pattern parameter).\"", "url": "https://github.com/returntocorp/semgrep/pull/1481#discussion_r471452610", "createdAt": "2020-08-17T12:44:39Z", "author": {"login": "aryx"}, "path": "semgrep-core/matching/Matching_generic.ml", "diffHunk": "@@ -218,16 +218,22 @@ let equal_ast_binded_code (a: AST.any) (b: AST.any) : bool =\n        *)\n       let a = Lib.abstract_position_info_any a in\n       let b = Lib.abstract_position_info_any b in\n-      let res = a =*= b in\n-      if !Flag.debug_matching && not res\n-      then begin\n-        pr2 (spf \"A = %s\" (str_of_any a));\n-        pr2 (spf \"B = %s\" (str_of_any b));\n-      end;\n-      res\n-\n+      a =*= b\n+  | A.I _, A.E (A.Id (b_id, _)) ->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY4OTAyOA=="}, "originalCommit": {"oid": "f21873269c36ed0b2fdb78893d056724ffcb9125"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75702ae8f5d49f94d505c2334aa4dfdb59f11d84", "author": {"user": {"login": "nbrahms", "name": "Nathaniel Brahms"}}, "url": "https://github.com/returntocorp/semgrep/commit/75702ae8f5d49f94d505c2334aa4dfdb59f11d84", "committedDate": "2020-08-17T17:05:00Z", "message": "fixup! Match against destructured parameters with metavariables in js"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1292, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}