{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4Nzk2OTAx", "number": 937, "title": "Add a clone_github_repo fixture", "bodyText": "The fixture uses a cache dir (determined automatically, or settable with GITHUB_REPO_CACHE environment variable)\nOn CI, we will read & write to this cache to speed up builds.", "createdAt": "2020-06-05T21:56:32Z", "url": "https://github.com/returntocorp/semgrep/pull/937", "merged": true, "mergeCommit": {"oid": "b43792d9f0e0fd226a25ba346597de848382bf9c"}, "closed": true, "closedAt": "2020-06-08T21:43:31Z", "author": {"login": "rcoh"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoZ9ezAH2gAyNDI4Nzk2OTAxOjg0NTU2OTE0NWY1MjY2NTJjN2U3ZDJmNzRmZjM2ZTE0MWZkYWRlZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpXNdtAH2gAyNDI4Nzk2OTAxOjNjNzYzNGZhZmEwYmQ4ZTc2ZjM2ZGExNzRkZDkzYmIyNzMzZmZiM2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "845569145f526652c7e7d2f74ff36e141fdadee2", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/845569145f526652c7e7d2f74ff36e141fdadee2", "committedDate": "2020-06-05T21:57:50Z", "message": "Add a clone_github_repo fixture\n\nThe fixture uses a cache dir (determined automatically, or settable with GITHUB_REPO_CACHE environment variable)\n\nOn CI, we will read & write to this cache to speed up builds."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c846bab397be5814575f6c6f95f3642a906ddbaf", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/c846bab397be5814575f6c6f95f3642a906ddbaf", "committedDate": "2020-06-05T21:51:44Z", "message": "Add a clone_github_repo fixture\n\nThe fixture uses a cache dir (determined automatically, or settable with GITHUB_REPO_CACHE environment variable)\n\nOn CI, we will read & write to this cache to speed up builds."}, "afterCommit": {"oid": "845569145f526652c7e7d2f74ff36e141fdadee2", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/845569145f526652c7e7d2f74ff36e141fdadee2", "committedDate": "2020-06-05T21:57:50Z", "message": "Add a clone_github_repo fixture\n\nThe fixture uses a cache dir (determined automatically, or settable with GITHUB_REPO_CACHE environment variable)\n\nOn CI, we will read & write to this cache to speed up builds."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NjYwOTA0", "url": "https://github.com/returntocorp/semgrep/pull/937#pullrequestreview-425660904", "createdAt": "2020-06-05T22:23:22Z", "commit": {"oid": "845569145f526652c7e7d2f74ff36e141fdadee2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMjoyMzoyMlrOGf-9oQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMjoyMzoyMlrOGf-9oQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE5MDYyNQ==", "bodyText": "Add comment on what this function does", "url": "https://github.com/returntocorp/semgrep/pull/937#discussion_r436190625", "createdAt": "2020-06-05T22:23:22Z", "author": {"login": "brendongo"}, "path": "semgrep/tests/conftest.py", "diffHunk": "@@ -88,6 +92,86 @@ def _run_semgrep(\n     return output\n \n \n+REPO_CACHE = Path(\n+    os.path.expanduser(\n+        os.environ.get(\"GITHUB_REPO_CACHE\", appdirs.user_cache_dir(\"semgrep-tests\"))\n+    )\n+)\n+\n+\n+@pytest.fixture()\n+def clone_github_repo():\n+    yield _github_repo_retry_wrapper\n+\n+\n+@contextlib.contextmanager\n+def chdir(dirname=None):\n+    curdir = os.getcwd()\n+    try:\n+        if dirname is not None:\n+            os.chdir(dirname)\n+        yield\n+    finally:\n+        os.chdir(curdir)\n+\n+\n+def _github_repo_retry_wrapper(\n+    repo_url: str, sha: Optional[str] = None, retries: int = 3\n+):\n+    sha_str = sha or \"latest\"\n+    repo_dir = \"-\".join(repo_url.split(\"/\")[-2:]) + \"-\" + sha_str\n+    repo_destination = REPO_CACHE / repo_dir\n+    try:\n+        return _github_repo(repo_url, sha, repo_destination)\n+    except (GitError, subprocess.CalledProcessError) as ex:\n+        print(f\"Failed to clone github repo for tests {ex}\")\n+        if repo_destination.exists():\n+            shutil.rmtree(repo_destination)\n+        if retries == 0:\n+            raise\n+        else:\n+            return _github_repo_retry_wrapper(repo_url, sha, retries - 1)\n+\n+\n+class GitError(BaseException):\n+    pass\n+\n+\n+def _github_repo(repo_url: str, sha: Optional[str], repo_destination: Path):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "845569145f526652c7e7d2f74ff36e141fdadee2"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce4742e457d5a71746b8aafd60a8cc452f01029e", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/ce4742e457d5a71746b8aafd60a8cc452f01029e", "committedDate": "2020-06-06T00:11:59Z", "message": "Add docs, fix benchmark"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c5df0c0ad3f6402ffee8bd2a34305b810c0b24f", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/6c5df0c0ad3f6402ffee8bd2a34305b810c0b24f", "committedDate": "2020-06-08T20:33:35Z", "message": "Use a different cache key to unbreak things"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjA2MTkx", "url": "https://github.com/returntocorp/semgrep/pull/937#pullrequestreview-426606191", "createdAt": "2020-06-08T20:43:57Z", "commit": {"oid": "6c5df0c0ad3f6402ffee8bd2a34305b810c0b24f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98428d21c79bdf6bb88ce68afb94dd60c23fee0c", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/98428d21c79bdf6bb88ce68afb94dd60c23fee0c", "committedDate": "2020-06-08T21:02:52Z", "message": "sgrep-build image having problems with cache"}, "afterCommit": {"oid": "cd5b8679239d1faca08c625400e2fd72ccdf8610", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/cd5b8679239d1faca08c625400e2fd72ccdf8610", "committedDate": "2020-06-08T21:10:53Z", "message": "sgrep-build image having problems with cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f3516806dc7ac51ed381e1a907060c64799968a", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/7f3516806dc7ac51ed381e1a907060c64799968a", "committedDate": "2020-06-08T21:15:31Z", "message": "sgrep-build image having problems with cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd5b8679239d1faca08c625400e2fd72ccdf8610", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/cd5b8679239d1faca08c625400e2fd72ccdf8610", "committedDate": "2020-06-08T21:10:53Z", "message": "sgrep-build image having problems with cache"}, "afterCommit": {"oid": "7f3516806dc7ac51ed381e1a907060c64799968a", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/7f3516806dc7ac51ed381e1a907060c64799968a", "committedDate": "2020-06-08T21:15:31Z", "message": "sgrep-build image having problems with cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c7634fafa0bd8e76f36da174dd93bb2733ffb3a", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/3c7634fafa0bd8e76f36da174dd93bb2733ffb3a", "committedDate": "2020-06-08T21:19:30Z", "message": "Re-enable the test job"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1502, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}