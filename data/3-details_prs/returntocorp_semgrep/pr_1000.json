{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzOTM3ODM0", "number": 1000, "title": "Respect .gitignore by default and add flag to ignore", "bodyText": "Closes #878", "createdAt": "2020-06-13T01:06:07Z", "url": "https://github.com/returntocorp/semgrep/pull/1000", "merged": true, "mergeCommit": {"oid": "dac81c77cc9ec02dfc332dba8551f2a3c7a3506e"}, "closed": true, "closedAt": "2020-06-16T16:42:32Z", "author": {"login": "brendongo"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqtzhHABqjM0NDAzNjEyNzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr00WQAFqTQzMTQ3MzI4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e6bc67d160e5b446633ba692c50e5886930ae43", "author": {"user": {"login": "brendongo", "name": "Brendon Go"}}, "url": "https://github.com/returntocorp/semgrep/commit/8e6bc67d160e5b446633ba692c50e5886930ae43", "committedDate": "2020-06-13T01:05:05Z", "message": "Respect .gitignore by default and add flag to ignore"}, "afterCommit": {"oid": "64e1e747cdfc11665c9ae51a9d7b219616561cda", "author": {"user": {"login": "brendongo", "name": "Brendon Go"}}, "url": "https://github.com/returntocorp/semgrep/commit/64e1e747cdfc11665c9ae51a9d7b219616561cda", "committedDate": "2020-06-13T02:12:47Z", "message": "Respect .gitignore by default and add flag to ignore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a4d5c518438fb17303c51392f4df3df58de52ae", "author": {"user": {"login": "brendongo", "name": "Brendon Go"}}, "url": "https://github.com/returntocorp/semgrep/commit/2a4d5c518438fb17303c51392f4df3df58de52ae", "committedDate": "2020-06-15T20:11:49Z", "message": "Respect .gitignore by default and add flag to ignore"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "64e1e747cdfc11665c9ae51a9d7b219616561cda", "author": {"user": {"login": "brendongo", "name": "Brendon Go"}}, "url": "https://github.com/returntocorp/semgrep/commit/64e1e747cdfc11665c9ae51a9d7b219616561cda", "committedDate": "2020-06-13T02:12:47Z", "message": "Respect .gitignore by default and add flag to ignore"}, "afterCommit": {"oid": "2a4d5c518438fb17303c51392f4df3df58de52ae", "author": {"user": {"login": "brendongo", "name": "Brendon Go"}}, "url": "https://github.com/returntocorp/semgrep/commit/2a4d5c518438fb17303c51392f4df3df58de52ae", "committedDate": "2020-06-15T20:11:49Z", "message": "Respect .gitignore by default and add flag to ignore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTg2MTc4", "url": "https://github.com/returntocorp/semgrep/pull/1000#pullrequestreview-430986178", "createdAt": "2020-06-15T20:54:47Z", "commit": {"oid": "2a4d5c518438fb17303c51392f4df3df58de52ae"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDo1NDo0N1rOGkCZUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDo1ODoxMFrOGkCgIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0MTE3MA==", "bodyText": "Can we do something like [p for p in curr_dir.rglob(f\"*.{ext}\") if p.is_file()]? subprocess will come with a lot of overhead and potential headaches (what if find doesn't exist on this system? is that possible?).", "url": "https://github.com/returntocorp/semgrep/pull/1000#discussion_r440441170", "createdAt": "2020-06-15T20:54:47Z", "author": {"login": "mschwager"}, "path": "semgrep/semgrep/target_manager.py", "diffHunk": "@@ -65,32 +64,48 @@ def resolve_targets(targets: List[str]) -> Set[Path]:\n             for target in targets\n         )\n \n-    @staticmethod\n-    def _parse_output(output: str, curr_dir: Path) -> Set[Path]:\n-        \"\"\"\n-            Convert a newline delimited list of files to a set of path objects\n-            prepends curr_dir to all paths in said list\n-\n-            If list is empty then returns an empty set\n-        \"\"\"\n-        files: Set[Path] = set()\n-        if output:\n-            files = set(Path(curr_dir) / elem for elem in output.strip().split(\"\\n\"))\n-        return files\n-\n     @staticmethod\n     def _expand_dir(\n-        curr_dir: Path, language: str, visible_to_git_only: bool\n+        curr_dir: Path, language: str, respect_git_ignore: bool\n     ) -> Set[Path]:\n         \"\"\"\n             Recursively go through a directory and return list of all files with\n             default file extention of language\n         \"\"\"\n+\n+        def _parse_output(output: str, curr_dir: Path) -> Set[Path]:\n+            \"\"\"\n+                Convert a newline delimited list of files to a set of path objects\n+                prepends curr_dir to all paths in said list\n+\n+                If list is empty then returns an empty set\n+            \"\"\"\n+            files: Set[Path] = set()\n+            if output:\n+                files = set(\n+                    Path(curr_dir) / elem for elem in output.strip().split(\"\\n\")\n+                )\n+            return files\n+\n+        def run_find(curr_dir: Path, extention: str) -> Set[Path]:\n+            \"\"\"\n+                Use 'find' to return set of files with given extension in a directory\n+            \"\"\"\n+            output = subprocess.run(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a4d5c518438fb17303c51392f4df3df58de52ae"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0MjkxNA==", "bodyText": "We should put these in the try's else block to minimize the exception catching surface. That way we don't catch exceptions we didn't mean to, and it's clear where the exception is expected to come from. Not that I would expect that to happen here, but I think it's good practice to minimize the amount of code in a try block.", "url": "https://github.com/returntocorp/semgrep/pull/1000#discussion_r440442914", "createdAt": "2020-06-15T20:58:10Z", "author": {"login": "mschwager"}, "path": "semgrep/semgrep/target_manager.py", "diffHunk": "@@ -113,36 +128,26 @@ def _expand_dir(\n                         encoding=\"utf-8\",\n                         stderr=subprocess.DEVNULL,\n                     )\n-                except subprocess.CalledProcessError:\n-                    raise NotGitProjectError(\n-                        f\"{curr_dir.resolve()} is not a git repository.\"\n-                    )\n \n-                tracked = TargetManager._parse_output(tracked_output, curr_dir)\n-                untracked_unignored = TargetManager._parse_output(\n-                    untracked_output, curr_dir\n-                )\n+                    tracked = _parse_output(tracked_output, curr_dir)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a4d5c518438fb17303c51392f4df3df58de52ae"}, "originalPosition": 107}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTkxNjA4", "url": "https://github.com/returntocorp/semgrep/pull/1000#pullrequestreview-430991608", "createdAt": "2020-06-15T21:02:56Z", "commit": {"oid": "2a4d5c518438fb17303c51392f4df3df58de52ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMTowMjo1NlrOGkCqCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMTowMjo1NlrOGkCqCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0NTQ1MQ==", "bodyText": "I think we'll need to catch a separate exception if git doesn't exist on their system:\nIn [45]: try: \n    ...:     subprocess.check_output('ladida') \n    ...: except subprocess.CalledProcessError: \n    ...:     print(\"CAUGHT\") \n    ...:\n\n...\n\nFileNotFoundError: [Errno 2] No such file or directory: 'ladida': 'ladida'", "url": "https://github.com/returntocorp/semgrep/pull/1000#discussion_r440445451", "createdAt": "2020-06-15T21:02:56Z", "author": {"login": "mschwager"}, "path": "semgrep/semgrep/target_manager.py", "diffHunk": "@@ -113,36 +128,26 @@ def _expand_dir(\n                         encoding=\"utf-8\",\n                         stderr=subprocess.DEVNULL,\n                     )\n-                except subprocess.CalledProcessError:\n-                    raise NotGitProjectError(\n-                        f\"{curr_dir.resolve()} is not a git repository.\"\n-                    )\n \n-                tracked = TargetManager._parse_output(tracked_output, curr_dir)\n-                untracked_unignored = TargetManager._parse_output(\n-                    untracked_output, curr_dir\n-                )\n+                    tracked = _parse_output(tracked_output, curr_dir)\n+                    untracked_unignored = _parse_output(untracked_output, curr_dir)\n \n-                expanded = expanded.union(tracked)\n-                expanded = expanded.union(untracked_unignored)\n+                    expanded = expanded.union(tracked)\n+                    expanded = expanded.union(untracked_unignored)\n+                except subprocess.CalledProcessError:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a4d5c518438fb17303c51392f4df3df58de52ae"}, "originalPosition": 114}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae889131a606616d714b513ef8431325a21a03ff", "author": {"user": {"login": "brendongo", "name": "Brendon Go"}}, "url": "https://github.com/returntocorp/semgrep/commit/ae889131a606616d714b513ef8431325a21a03ff", "committedDate": "2020-06-15T21:49:39Z", "message": "fixup! Respect .gitignore by default and add flag to ignore"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ebe93d567773e9947aba344a13f5042e8c2638c8", "author": {"user": {"login": "brendongo", "name": "Brendon Go"}}, "url": "https://github.com/returntocorp/semgrep/commit/ebe93d567773e9947aba344a13f5042e8c2638c8", "committedDate": "2020-06-15T23:24:28Z", "message": "fixup! Respect .gitignore by default and add flag to ignore"}, "afterCommit": {"oid": "ae889131a606616d714b513ef8431325a21a03ff", "author": {"user": {"login": "brendongo", "name": "Brendon Go"}}, "url": "https://github.com/returntocorp/semgrep/commit/ae889131a606616d714b513ef8431325a21a03ff", "committedDate": "2020-06-15T21:49:39Z", "message": "fixup! Respect .gitignore by default and add flag to ignore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a569467b4ca1165b3eca7abb63f5634340725f1e", "author": {"user": {"login": "brendongo", "name": "Brendon Go"}}, "url": "https://github.com/returntocorp/semgrep/commit/a569467b4ca1165b3eca7abb63f5634340725f1e", "committedDate": "2020-06-16T00:50:29Z", "message": "Use clone fixture"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNDczMjgz", "url": "https://github.com/returntocorp/semgrep/pull/1000#pullrequestreview-431473283", "createdAt": "2020-06-16T12:56:52Z", "commit": {"oid": "a569467b4ca1165b3eca7abb63f5634340725f1e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjo1Njo1MlrOGkZ_fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjo1Njo1MlrOGkZ_fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyNzc3NA==", "bodyText": "Let's add a line to the CHANGELOG mentioning this flag", "url": "https://github.com/returntocorp/semgrep/pull/1000#discussion_r440827774", "createdAt": "2020-06-16T12:56:52Z", "author": {"login": "mschwager"}, "path": "semgrep/semgrep/cli.py", "diffHunk": "@@ -108,6 +108,11 @@ def cli() -> None:\n         default=[],\n         help=\"Scan only directories with this name; --include-dir=doc will include doc/ as well as src/doc. Can add multiple times.\",\n     )\n+    parser.add_argument(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a569467b4ca1165b3eca7abb63f5634340725f1e"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1547, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}