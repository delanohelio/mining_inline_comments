{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0MTk5Njky", "number": 698, "title": "Build release wheels", "bodyText": "", "createdAt": "2020-05-06T16:22:32Z", "url": "https://github.com/returntocorp/semgrep/pull/698", "merged": true, "mergeCommit": {"oid": "ef96f0dede289eafd739d68915c4b9458119125e"}, "closed": true, "closedAt": "2020-05-08T02:38:05Z", "author": {"login": "rcoh"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcerNqVgBqjMzMDkyNzk4MzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfIXxAAH2gAyNDE0MTk5NjkyOjRkZGM3OGQ2YzgzZmVlOTY2MzJlZDgxZjIwNzRhYzU4MDcxNWEwNmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bdca689d0111793e9afd3a6ba8abc61b0c7a7a52", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/bdca689d0111793e9afd3a6ba8abc61b0c7a7a52", "committedDate": "2020-05-06T16:22:07Z", "message": "Build release wheels"}, "afterCommit": {"oid": "0d5b56b88c176166c3a7252232fafa75fbfbb2ae", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/0d5b56b88c176166c3a7252232fafa75fbfbb2ae", "committedDate": "2020-05-06T16:24:32Z", "message": "Build release wheels"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d5680da9534210145494c4d6bba400d848016ac", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/3d5680da9534210145494c4d6bba400d848016ac", "committedDate": "2020-05-06T16:46:10Z", "message": "Build release wheels"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d5b56b88c176166c3a7252232fafa75fbfbb2ae", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/0d5b56b88c176166c3a7252232fafa75fbfbb2ae", "committedDate": "2020-05-06T16:24:32Z", "message": "Build release wheels"}, "afterCommit": {"oid": "3d5680da9534210145494c4d6bba400d848016ac", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/3d5680da9534210145494c4d6bba400d848016ac", "committedDate": "2020-05-06T16:46:10Z", "message": "Build release wheels"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ec7494e210b95d724444b40bd348cf011fd42cf", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/1ec7494e210b95d724444b40bd348cf011fd42cf", "committedDate": "2020-05-06T18:25:35Z", "message": "Produce a wheel with the correct versions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34d5ed57966c6823575b1d808f4e61d68226b6d3", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/34d5ed57966c6823575b1d808f4e61d68226b6d3", "committedDate": "2020-05-06T18:30:50Z", "message": "Try again for matrix builds"}, "afterCommit": {"oid": "f32f59c5c20bc6625a2e5a5c3ad04a7c96470e4d", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/f32f59c5c20bc6625a2e5a5c3ad04a7c96470e4d", "committedDate": "2020-05-06T18:33:51Z", "message": "Try again for matrix builds"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f32f59c5c20bc6625a2e5a5c3ad04a7c96470e4d", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/f32f59c5c20bc6625a2e5a5c3ad04a7c96470e4d", "committedDate": "2020-05-06T18:33:51Z", "message": "Try again for matrix builds"}, "afterCommit": {"oid": "6cfcbcaad088de9e69c1483d12a97710f0e4d19f", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/6cfcbcaad088de9e69c1483d12a97710f0e4d19f", "committedDate": "2020-05-06T18:35:00Z", "message": "Try again for matrix builds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6daf2ec1c79da418915eea05712df58ace00e2cd", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/6daf2ec1c79da418915eea05712df58ace00e2cd", "committedDate": "2020-05-06T18:37:44Z", "message": "Try again for matrix builds"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cfcbcaad088de9e69c1483d12a97710f0e4d19f", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/6cfcbcaad088de9e69c1483d12a97710f0e4d19f", "committedDate": "2020-05-06T18:35:00Z", "message": "Try again for matrix builds"}, "afterCommit": {"oid": "6daf2ec1c79da418915eea05712df58ace00e2cd", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/6daf2ec1c79da418915eea05712df58ace00e2cd", "committedDate": "2020-05-06T18:37:44Z", "message": "Try again for matrix builds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbb04a43ad6ef541f8bae3b3b6192f6023d0dd7a", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/cbb04a43ad6ef541f8bae3b3b6192f6023d0dd7a", "committedDate": "2020-05-06T18:51:29Z", "message": "Fix tox & install setuptools and wheel first"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6be93da420b2bfea254bca8e00b88accbd73bf7", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/a6be93da420b2bfea254bca8e00b88accbd73bf7", "committedDate": "2020-05-06T19:14:57Z", "message": "Working on ubuntu wheels"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e4b1a495768ff8f38d2b0da79e7877787226b59", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/7e4b1a495768ff8f38d2b0da79e7877787226b59", "committedDate": "2020-05-06T19:21:02Z", "message": "Upload wheels as artifacts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c718dd269dae0d5125fc66c795262b5632abec2", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/1c718dd269dae0d5125fc66c795262b5632abec2", "committedDate": "2020-05-06T19:26:17Z", "message": "Try again to fix tox tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7e4e2beb04d852a0abeb588916169adddbf9186", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/d7e4e2beb04d852a0abeb588916169adddbf9186", "committedDate": "2020-05-06T19:44:06Z", "message": "Don't both building a nuitka binary on ubuntu."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "668771b0683de696dcfcbc6e0ef358d1c95eefdb", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/668771b0683de696dcfcbc6e0ef358d1c95eefdb", "committedDate": "2020-05-06T19:51:40Z", "message": "Produce a wheel for a lower OSX version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50ebdb0854094195580007a3e76df4126eb94cd2", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/50ebdb0854094195580007a3e76df4126eb94cd2", "committedDate": "2020-05-06T20:24:58Z", "message": "Assorted fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2OTc5MjQ1", "url": "https://github.com/returntocorp/semgrep/pull/698#pullrequestreview-406979245", "createdAt": "2020-05-06T20:54:53Z", "commit": {"oid": "50ebdb0854094195580007a3e76df4126eb94cd2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDo1NDo1M1rOGRlC0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDo1NDo1M1rOGRlC0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4NTkwNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                author_email=\"support@returntocorp.com\",\n          \n          \n            \n                author_email=\"support@r2c.dev\",", "url": "https://github.com/returntocorp/semgrep/pull/698#discussion_r421085907", "createdAt": "2020-05-06T20:54:53Z", "author": {"login": "brendongo"}, "path": "semgrep/setup.py", "diffHunk": "@@ -1,15 +1,118 @@\n # type: ignore\n+import contextlib\n+import distutils.util\n+import os\n+import sys\n+\n import setuptools\n+from setuptools import setup\n+from setuptools.command.install import install\n+from wheel.bdist_wheel import bdist_wheel as _bdist_wheel\n+\n+\n+@contextlib.contextmanager\n+def chdir(dirname=None):\n+    curdir = os.getcwd()\n+    try:\n+        if dirname is not None:\n+            os.chdir(dirname)\n+        yield\n+    finally:\n+        os.chdir(curdir)\n+\n+\n+# TODO: what is the minimum OSX version?\n+MIN_OSX_VERSION = \"10_14\"\n+\n+# from https://stackoverflow.com/questions/45150304/how-to-force-a-python-wheel-to-be-platform-specific-when-building-it # noqa\n+class bdist_wheel(_bdist_wheel):\n+    def finalize_options(self):\n+        _bdist_wheel.finalize_options(self)\n+        # Mark us as not a pure python package (we have platform specific rust code)\n+        self.root_is_pure = False\n+\n+    def get_tag(self):\n+        # this set's us up to build generic wheels.\n+        # note: we're only doing this for windows right now (causes packaging issues\n+        # with osx)\n+        _, _, plat = _bdist_wheel.get_tag(self)\n+        # We don't need cPython\n+        python = \".\".join([\"py36\", \"py37\", \"py38\"])\n+        abi = \"none\"\n+\n+        if \"macosx\" in plat:\n+            plat = f\"macosx_{MIN_OSX_VERSION}_x86_64.whl\"\n+\n+        return python, abi, plat\n+\n+\n+try:\n+    with open(\"../README.md\") as f:\n+        long_description = f.read()\n+except FileNotFoundError:\n+    long_description = \"\"\n+\n+\n+class PostInstallCommand(install):\n+    \"\"\"Post-installation for installation mode.\"\"\"\n+\n+    def run(self):\n+        if \"TOX_ENV_NAME\" in os.environ:\n+            print(\"Not attempting to install binary while running under tox\")\n+            return\n+        # So ths builds the executable, and even installs it\n+        # but we can't install to the bin directory:\n+        #     https://github.com/pypa/setuptools/issues/210#issuecomment-216657975\n+        # take the advice from that comment, and move over after install\n+        source_dir = os.path.dirname(os.path.abspath(__file__))\n+\n+        if os.environ.get(\"PRECOMILED_LOCATION\"):\n+            source = os.environ[\"PRECOMPILED_LOCATION\"]\n+        else:\n+            repo_root = os.path.dirname(source_dir)\n+            if \"osx\" in distutils.util.get_platform():\n+                with chdir(repo_root):\n+                    os.system(os.path.join(repo_root, \"release-scripts/osx-release.sh\"))\n+                    source = os.path.join(repo_root, \"artifacts/semgrep-core\")\n+            else:\n+                with chdir(repo_root):\n+                    os.putenv(\"SKIP_NUITKA\", \"TRUE\")\n+                    os.system(\n+                        os.path.join(repo_root, \"release-scripts/ubuntu-release.sh\")\n+                    )\n+                    source = os.path.join(repo_root, \"semgrep-files/semgrep-core\")\n+\n+        ## setuptools_rust doesn't seem to let me specify a musl cross compilation target\n+        ## so instead just build ourselves here =(.\n+        # if os.system(\"cargo build --release %s\" % compile_args):\n+        #    raise ValueError(\"Failed to compile!\")\n+\n+        ## run this after trying to build with cargo (as otherwise this leaves\n+        ## venv in a bad state: https://github.com/benfred/py-spy/issues/69)\n+        install.run(self)\n+\n+        ## we're going to install the py-spy executable into the scripts directory\n+        ## but first make sure the scripts directory exists\n+        if not os.path.isdir(self.install_scripts):\n+            os.makedirs(self.install_scripts)\n+\n+        target = os.path.join(self.install_scripts, \"semgrep-core\")\n+        if os.path.isfile(target):\n+            os.remove(target)\n+\n+        self.copy_file(source, target)\n+\n \n-setuptools.setup(\n+setup(\n     name=\"semgrep\",  # Replace with your own username\n     version=\"0.6.0\",\n     author=\"Russell & Return 2 Corp\",\n-    author_email=\"author@example.com\",\n-    description=\"semgrep python wrapper\",\n-    long_description=\"bloop\",\n+    author_email=\"support@returntocorp.com\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50ebdb0854094195580007a3e76df4126eb94cd2"}, "originalPosition": 114}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2OTgwMzY2", "url": "https://github.com/returntocorp/semgrep/pull/698#pullrequestreview-406980366", "createdAt": "2020-05-06T20:56:36Z", "commit": {"oid": "50ebdb0854094195580007a3e76df4126eb94cd2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDo1NjozNlrOGRlGTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDo1NjozNlrOGRlGTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4Njc5OA==", "bodyText": "No version pinning?", "url": "https://github.com/returntocorp/semgrep/pull/698#discussion_r421086798", "createdAt": "2020-05-06T20:56:36Z", "author": {"login": "brendongo"}, "path": "semgrep/requirements.txt", "diffHunk": "@@ -3,3 +3,4 @@ pytest==5.3.5\n pyyaml==5.3\n requests==2.22.0\n tox==3.14.6\n+wheel", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50ebdb0854094195580007a3e76df4126eb94cd2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2OTg0NDE0", "url": "https://github.com/returntocorp/semgrep/pull/698#pullrequestreview-406984414", "createdAt": "2020-05-06T21:02:31Z", "commit": {"oid": "50ebdb0854094195580007a3e76df4126eb94cd2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMTowMjozMVrOGRlTTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMTowMjozMVrOGRlTTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA5MDEyNg==", "bodyText": "Can we leave this on and archive the relevant places this fires on this PR", "url": "https://github.com/returntocorp/semgrep/pull/698#discussion_r421090126", "createdAt": "2020-05-06T21:02:31Z", "author": {"login": "brendongo"}, "path": ".bento/config.yml", "diffHunk": "@@ -28,7 +28,7 @@ tools:\n     - subprocess-without-shell-equals-true\n     - try-except-continue\n     - urllib-urlopen\n-    run: true\n+    run: false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50ebdb0854094195580007a3e76df4126eb94cd2"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c003b5d715d98afcd73b76f20b716d126f7ba9ab", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/c003b5d715d98afcd73b76f20b716d126f7ba9ab", "committedDate": "2020-05-06T21:04:19Z", "message": "Update semgrep/setup.py\n\nCo-authored-by: Brendon Go <brendon.go@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04c9455d5081debf4e5a7ebfbd80fa51e0939554", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/04c9455d5081debf4e5a7ebfbd80fa51e0939554", "committedDate": "2020-05-06T21:18:34Z", "message": "Add pinned version for wheel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "695f512811587f4ca73689d64416907d9561b481", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/695f512811587f4ca73689d64416907d9561b481", "committedDate": "2020-05-06T21:19:05Z", "message": "Merge branch 'russell/build-wheels-test-release' of github.com:returntocorp/sgrep into russell/build-wheels-test-release"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5239c196eb133af192832aeaa826f9bff390d1e", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/a5239c196eb133af192832aeaa826f9bff390d1e", "committedDate": "2020-05-08T01:19:47Z", "message": "Re-enable bandit and silence specific checks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3OTQ2ODg2", "url": "https://github.com/returntocorp/semgrep/pull/698#pullrequestreview-407946886", "createdAt": "2020-05-08T01:52:02Z", "commit": {"oid": "a5239c196eb133af192832aeaa826f9bff390d1e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ddc78d6c83fee96632ed81f2074ac580715a06e", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/4ddc78d6c83fee96632ed81f2074ac580715a06e", "committedDate": "2020-05-08T02:22:56Z", "message": "Update setup.py description"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 953, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}