{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyOTgzNjIx", "number": 1185, "title": "Store whether we had a timeout on a file in the parsing cache", "bodyText": "This should help fix #1156\nSee the comment in the diff for more information.\nTest plan:\ndevelop/home/pad/semgrep/tests/PERF $ rm -rf /tmp/xxx/\ndevelop/home/pad/semgrep/tests/PERF $ time yy -use_parsing_cache /tmp/xxx -lang js -e '$X == $X' timeout.js\n\n/home/pad/github/semgrep/semgrep-core/_build/default/bin/Main.exe -use_parsing_cache /tmp/xxx -lang js -e $X == $X timeout.js\ntimeout.js:1:0: Timeout\n\nFatal error: exception Common.Timeout\n...\n5.528 secs\ndevelop/home/pad/semgrep/tests/PERF $ time yy -use_parsing_cache /tmp/xxx -lang js -e '$X == $X' timeout.js\n\n/home/pad/github/semgrep/semgrep-core/_build/default/bin/Main.exe -use_parsing_cache /tmp/xxx -lang js -e $X == $X timeout.js\ntimeout.js:1:0: Fatal Error: Common.Timeout\nFatal error: exception Common.Timeout\n...\n0.498 secs", "createdAt": "2020-07-01T20:53:55Z", "url": "https://github.com/returntocorp/semgrep/pull/1185", "merged": true, "mergeCommit": {"oid": "15b979cacb4018c83489dc055b7efac443a9e355"}, "closed": true, "closedAt": "2020-07-01T22:48:58Z", "author": {"login": "aryx"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwwnqqgH2gAyNDQyOTgzNjIxOjgzMmE1MzY1MDUyOGE0NzljMGViMDI0MjA2OGRiN2M1MTdiZWZmMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwxzp8gH2gAyNDQyOTgzNjIxOjQ5ZTVkZmUzNzNjOTNiMjIwNjAxM2U1MmNkMWQzMTIwZTQ5ODljNWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "832a53650528a479c0eb0242068db7c517beff06", "author": {"user": {"login": "aryx", "name": "Yoann Padioleau"}}, "url": "https://github.com/returntocorp/semgrep/commit/832a53650528a479c0eb0242068db7c517beff06", "committedDate": "2020-07-01T20:53:13Z", "message": "Store whether we had a timeout on a file in the parsing cache\n\nThis should help fix #1156\nSee the comment in the diff for more information.\n\nTest plan:\n\ndevelop/home/pad/semgrep/tests/PERF $ rm -rf /tmp/xxx/\ndevelop/home/pad/semgrep/tests/PERF $ time yy -use_parsing_cache /tmp/xxx -lang js -e '$X == $X' timeout.js\n+ /home/pad/github/semgrep/semgrep-core/_build/default/bin/Main.exe -use_parsing_cache /tmp/xxx -lang js -e $X == $X timeout.js\ntimeout.js:1:0: Timeout\n\nFatal error: exception Common.Timeout\n...\n5.528 secs\ndevelop/home/pad/semgrep/tests/PERF $ time yy -use_parsing_cache /tmp/xxx -lang js -e '$X == $X' timeout.js\n+ /home/pad/github/semgrep/semgrep-core/_build/default/bin/Main.exe -use_parsing_cache /tmp/xxx -lang js -e $X == $X timeout.js\ntimeout.js:1:0: Fatal Error: Common.Timeout\nFatal error: exception Common.Timeout\n...\n0.498 secs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTkwNjUw", "url": "https://github.com/returntocorp/semgrep/pull/1185#pullrequestreview-441190650", "createdAt": "2020-07-01T20:55:20Z", "commit": {"oid": "832a53650528a479c0eb0242068db7c517beff06"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDo1NToyMFrOGr1EQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDo1NToyMFrOGr1EQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxMTM5Mw==", "bodyText": "Should we store just timeouts or any parse error as well?", "url": "https://github.com/returntocorp/semgrep/pull/1185#discussion_r448611393", "createdAt": "2020-07-01T20:55:20Z", "author": {"login": "brendongo"}, "path": "semgrep-core/bin/Main.ml", "diffHunk": "@@ -380,8 +382,20 @@ let parse_generic lang file =\n   Naming_AST.resolve lang ast;\n   Constant_propagation.propagate lang ast;\n   (*e: [[Main_semgrep_core.parse_generic()]] resolve names in the AST *)\n-  ast\n+  Left ast\n+ (* This is a bit subtle, but we now store in the cache whether we had\n+  * a timeout on this file. Indeed, semgrep now calls semgrep-core\n+  * per rule, and if one file timeout during parsing, it would timeout\n+  * for each rule, but we don't want to wait each time 5sec for each rule.\n+  * So here we store the exn in the cache, and below we reraise it\n+  * after we got it back from the cache.\n+  *)\n+ with Timeout -> Right Timeout", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "832a53650528a479c0eb0242068db7c517beff06"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTkyNzYw", "url": "https://github.com/returntocorp/semgrep/pull/1185#pullrequestreview-441192760", "createdAt": "2020-07-01T20:58:59Z", "commit": {"oid": "832a53650528a479c0eb0242068db7c517beff06"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDo1ODo1OVrOGr1KuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDo1ODo1OVrOGr1KuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxMzA0OQ==", "bodyText": "What does Left and Right do?", "url": "https://github.com/returntocorp/semgrep/pull/1185#discussion_r448613049", "createdAt": "2020-07-01T20:58:59Z", "author": {"login": "brendongo"}, "path": "semgrep-core/bin/Main.ml", "diffHunk": "@@ -380,8 +382,20 @@ let parse_generic lang file =\n   Naming_AST.resolve lang ast;\n   Constant_propagation.propagate lang ast;\n   (*e: [[Main_semgrep_core.parse_generic()]] resolve names in the AST *)\n-  ast\n+  Left ast", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "832a53650528a479c0eb0242068db7c517beff06"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTkzMDA1", "url": "https://github.com/returntocorp/semgrep/pull/1185#pullrequestreview-441193005", "createdAt": "2020-07-01T20:59:25Z", "commit": {"oid": "832a53650528a479c0eb0242068db7c517beff06"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c70c469d93bf4bab18f85b9c1acae17c37204f4", "author": {"user": {"login": "aryx", "name": "Yoann Padioleau"}}, "url": "https://github.com/returntocorp/semgrep/commit/0c70c469d93bf4bab18f85b9c1acae17c37204f4", "committedDate": "2020-07-01T21:02:29Z", "message": "* semgrep-core/bin/Main.ml: brendon's comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49e5dfe373c93b2206013e52cd1d3120e4989c5f", "author": {"user": {"login": "aryx", "name": "Yoann Padioleau"}}, "url": "https://github.com/returntocorp/semgrep/commit/49e5dfe373c93b2206013e52cd1d3120e4989c5f", "committedDate": "2020-07-01T22:16:13Z", "message": "* semgrep-core/bin/Main.ml: revert back to just Timeout because\nof some weird regressions otherwise"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1453, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}