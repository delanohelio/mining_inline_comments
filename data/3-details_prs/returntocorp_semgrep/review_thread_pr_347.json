{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1ODg2Mjcz", "number": 347, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMTo0NjozM1rODs3aDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMTozMzozNVrODtS-LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MzcxNzI3OnYy", "diffSide": "RIGHT", "path": "sgrep/tests/python/equivalence_f_string.py", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMTo0NjozM1rOF99cHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxOTo1ODo0MFrOF-l7lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxNDA3OA==", "bodyText": "Shouldn't this match your pattern?", "url": "https://github.com/returntocorp/semgrep/pull/347#discussion_r400514078", "createdAt": "2020-03-30T21:46:33Z", "author": {"login": "nbrahms"}, "path": "sgrep/tests/python/equivalence_f_string.py", "diffHunk": "@@ -0,0 +1,30 @@\n+def foo1():\n+  # ERROR:\n+  w = \"foo\"\n+  query = f\"hello {w} hel\"\n+\n+def foo2():\n+  # ERROR:\n+  ww = \"bar\"\n+  query = f\"ASD{ww}ASASD\"\n+\n+def foo3():\n+  # OK:\n+  www = \"bar\"\n+  query = f\"SELECT {www}\"\n+\n+def foo4():\n+  # OK:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62369000d104e041be230b91388add96872e0a81"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyMDg3NA==", "bodyText": "... is matching more than 0 characters and for {ww} it fumbles. Something like\n$M = \"...\"\n$N = \"...\"\n...\n$Q = f\"...{$M}...{$N}\"\n``` matches though!", "url": "https://github.com/returntocorp/semgrep/pull/347#discussion_r400520874", "createdAt": "2020-03-30T22:01:25Z", "author": {"login": "ulziibay"}, "path": "sgrep/tests/python/equivalence_f_string.py", "diffHunk": "@@ -0,0 +1,30 @@\n+def foo1():\n+  # ERROR:\n+  w = \"foo\"\n+  query = f\"hello {w} hel\"\n+\n+def foo2():\n+  # ERROR:\n+  ww = \"bar\"\n+  query = f\"ASD{ww}ASASD\"\n+\n+def foo3():\n+  # OK:\n+  www = \"bar\"\n+  query = f\"SELECT {www}\"\n+\n+def foo4():\n+  # OK:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxNDA3OA=="}, "originalCommit": {"oid": "62369000d104e041be230b91388add96872e0a81"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyNDIxOA==", "bodyText": "Hmm, I'd think constant propagation should treat these as equivalent. Maybe a bug to file?", "url": "https://github.com/returntocorp/semgrep/pull/347#discussion_r400524218", "createdAt": "2020-03-30T22:09:00Z", "author": {"login": "nbrahms"}, "path": "sgrep/tests/python/equivalence_f_string.py", "diffHunk": "@@ -0,0 +1,30 @@\n+def foo1():\n+  # ERROR:\n+  w = \"foo\"\n+  query = f\"hello {w} hel\"\n+\n+def foo2():\n+  # ERROR:\n+  ww = \"bar\"\n+  query = f\"ASD{ww}ASASD\"\n+\n+def foo3():\n+  # OK:\n+  www = \"bar\"\n+  query = f\"SELECT {www}\"\n+\n+def foo4():\n+  # OK:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxNDA3OA=="}, "originalCommit": {"oid": "62369000d104e041be230b91388add96872e0a81"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyNDY4NQ==", "bodyText": "Honestly I think ... should match 0 characters.", "url": "https://github.com/returntocorp/semgrep/pull/347#discussion_r400524685", "createdAt": "2020-03-30T22:10:08Z", "author": {"login": "nbrahms"}, "path": "sgrep/tests/python/equivalence_f_string.py", "diffHunk": "@@ -0,0 +1,30 @@\n+def foo1():\n+  # ERROR:\n+  w = \"foo\"\n+  query = f\"hello {w} hel\"\n+\n+def foo2():\n+  # ERROR:\n+  ww = \"bar\"\n+  query = f\"ASD{ww}ASASD\"\n+\n+def foo3():\n+  # OK:\n+  www = \"bar\"\n+  query = f\"SELECT {www}\"\n+\n+def foo4():\n+  # OK:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxNDA3OA=="}, "originalCommit": {"oid": "62369000d104e041be230b91388add96872e0a81"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0NDUzMg==", "bodyText": "\"...\" matches 0 characters.\nThe issue here is that f\"...{$M}\"...\" is internally rewritten as\nspecial_concat(\"...\", $M, \"...\")\nand a string like f\"foo{a}\" is internally rewritten as\nspecial_concat(\"foo\", a)\nand the issue here is that the number of arguments are different so the engine will say \"no match\".\nWe need to handle specially calls to special_concat and accept that \"...\" matches not only a string, or an empty string, or nothing at all.\nIn fact we probably want f\"...{$X}...\" to match any interpolated expression, not just the first one, so you also don't have to write another pattern when an f-string use 2 interpolated expressions as in f\"one {a} other stuff {b}\"", "url": "https://github.com/returntocorp/semgrep/pull/347#discussion_r400744532", "createdAt": "2020-03-31T08:48:31Z", "author": {"login": "aryx"}, "path": "sgrep/tests/python/equivalence_f_string.py", "diffHunk": "@@ -0,0 +1,30 @@\n+def foo1():\n+  # ERROR:\n+  w = \"foo\"\n+  query = f\"hello {w} hel\"\n+\n+def foo2():\n+  # ERROR:\n+  ww = \"bar\"\n+  query = f\"ASD{ww}ASASD\"\n+\n+def foo3():\n+  # OK:\n+  www = \"bar\"\n+  query = f\"SELECT {www}\"\n+\n+def foo4():\n+  # OK:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxNDA3OA=="}, "originalCommit": {"oid": "62369000d104e041be230b91388add96872e0a81"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE3NzQ5Mg==", "bodyText": "@aryx: I have update the generic matcher such that  \"...\" could match many more arguments, thus taking care of the case  where  the number of arguments are different.\nHowever, I use constant_propagation_and_evaluate_literal to determine if variable www is a literal.  As the moment, the constant propagation in python does not seem to keep track of www as a literal", "url": "https://github.com/returntocorp/semgrep/pull/347#discussion_r401177492", "createdAt": "2020-03-31T19:58:40Z", "author": {"login": "ulziibay"}, "path": "sgrep/tests/python/equivalence_f_string.py", "diffHunk": "@@ -0,0 +1,30 @@\n+def foo1():\n+  # ERROR:\n+  w = \"foo\"\n+  query = f\"hello {w} hel\"\n+\n+def foo2():\n+  # ERROR:\n+  ww = \"bar\"\n+  query = f\"ASD{ww}ASASD\"\n+\n+def foo3():\n+  # OK:\n+  www = \"bar\"\n+  query = f\"SELECT {www}\"\n+\n+def foo4():\n+  # OK:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxNDA3OA=="}, "originalCommit": {"oid": "62369000d104e041be230b91388add96872e0a81"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4ODA5NTE2OnYy", "diffSide": "RIGHT", "path": "sgrep/lib/generic_vs_generic.ml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDo0OToxM1rOF-nrVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDo1NzozOVrOF-n9fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIwNjEwMg==", "bodyText": "maybe add a comment here saying interpolated strings are transformed in Call(Spedial(Concat, ...)\nand we want patterns like f\"...{$X}...\", which are expanded to Call(Special(Concat, [L\"...\"; Id \"$X\"; L\"...\"])) to\nmatch concrete code like f\"foo{a}\"", "url": "https://github.com/returntocorp/semgrep/pull/347#discussion_r401206102", "createdAt": "2020-03-31T20:49:13Z", "author": {"login": "aryx"}, "path": "sgrep/lib/generic_vs_generic.ml", "diffHunk": "@@ -1033,6 +1032,21 @@ and m_list__m_argument (xsa: A.argument list) (xsb: A.argument list) =\n       (* can match more *)\n       (m_list__m_argument ((A.Arg (A.Ellipsis i))::xsa) xsb)\n \n+  (* dots: '...', can also match no argument *)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1aa7a8957c2102ef28c6ca1e851db758b64b17a6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIxMDc0OA==", "bodyText": "Ok", "url": "https://github.com/returntocorp/semgrep/pull/347#discussion_r401210748", "createdAt": "2020-03-31T20:57:39Z", "author": {"login": "ulziibay"}, "path": "sgrep/lib/generic_vs_generic.ml", "diffHunk": "@@ -1033,6 +1032,21 @@ and m_list__m_argument (xsa: A.argument list) (xsb: A.argument list) =\n       (* can match more *)\n       (m_list__m_argument ((A.Arg (A.Ellipsis i))::xsa) xsb)\n \n+  (* dots: '...', can also match no argument *)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIwNjEwMg=="}, "originalCommit": {"oid": "1aa7a8957c2102ef28c6ca1e851db758b64b17a6"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4ODIzMDEzOnYy", "diffSide": "RIGHT", "path": "sgrep/tests/python/equivalence_f_string.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMTozMjoyOVrOF-pBEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMjoxMTozM1rOF-qGmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyODA1MQ==", "bodyText": "do we still need # TODO here?", "url": "https://github.com/returntocorp/semgrep/pull/347#discussion_r401228051", "createdAt": "2020-03-31T21:32:29Z", "author": {"login": "nbrahms"}, "path": "sgrep/tests/python/equivalence_f_string.py", "diffHunk": "@@ -0,0 +1,32 @@\n+def foo1():\n+  # ERROR:\n+  w = \"foo\"\n+  query = f\"hello {w}\"\n+\n+def foo2():\n+  # ERROR:\n+  ww = \"bar\"\n+  query = f\"ASD{ww}\"\n+\n+def foo3():\n+  # ERROR:\n+  www = \"bar\"\n+  query = f\"SELECT {www}\"\n+\n+def foo4():\n+  # TODO:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b2beff75f77db60f771352d9f5a3eeade2abb14"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NTg0OA==", "bodyText": "Yes we still need TODO: From #347 (comment), I use constant_propagation_and_evaluate_literal to determine if variable name is a literal. As the moment, the constant propagation in python does not seem to keep track of name as a literal", "url": "https://github.com/returntocorp/semgrep/pull/347#discussion_r401245848", "createdAt": "2020-03-31T22:11:33Z", "author": {"login": "ulziibay"}, "path": "sgrep/tests/python/equivalence_f_string.py", "diffHunk": "@@ -0,0 +1,32 @@\n+def foo1():\n+  # ERROR:\n+  w = \"foo\"\n+  query = f\"hello {w}\"\n+\n+def foo2():\n+  # ERROR:\n+  ww = \"bar\"\n+  query = f\"ASD{ww}\"\n+\n+def foo3():\n+  # ERROR:\n+  www = \"bar\"\n+  query = f\"SELECT {www}\"\n+\n+def foo4():\n+  # TODO:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyODA1MQ=="}, "originalCommit": {"oid": "2b2beff75f77db60f771352d9f5a3eeade2abb14"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4ODIzMzQwOnYy", "diffSide": "RIGHT", "path": "sgrep/tests/python/equivalence_f_string_2.py", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMTozMzozNVrOF-pDJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMTozNzowN1rOF-pJoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyODU4Mw==", "bodyText": "Also it seems like this should match", "url": "https://github.com/returntocorp/semgrep/pull/347#discussion_r401228583", "createdAt": "2020-03-31T21:33:35Z", "author": {"login": "nbrahms"}, "path": "sgrep/tests/python/equivalence_f_string_2.py", "diffHunk": "@@ -0,0 +1,27 @@\n+def foo1():\n+  # ERROR:\n+  select = \"select * \"\n+  query = f\"{select} from foo\"\n+\n+def foo2():\n+  # ERROR:\n+  select = \"select * \"\n+  name = \"foo\"\n+  query = f\"{select} from foo \" + f\"where name={name}\"\n+\n+def foo2a():\n+  # TODO:\n+  # OK:\n+  select = \"select * \"\n+  name = \"foo\"\n+  query = f\"{select} from foo where name={name}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b2beff75f77db60f771352d9f5a3eeade2abb14"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyODczNA==", "bodyText": "NM I'm silly", "url": "https://github.com/returntocorp/semgrep/pull/347#discussion_r401228734", "createdAt": "2020-03-31T21:33:53Z", "author": {"login": "nbrahms"}, "path": "sgrep/tests/python/equivalence_f_string_2.py", "diffHunk": "@@ -0,0 +1,27 @@\n+def foo1():\n+  # ERROR:\n+  select = \"select * \"\n+  query = f\"{select} from foo\"\n+\n+def foo2():\n+  # ERROR:\n+  select = \"select * \"\n+  name = \"foo\"\n+  query = f\"{select} from foo \" + f\"where name={name}\"\n+\n+def foo2a():\n+  # TODO:\n+  # OK:\n+  select = \"select * \"\n+  name = \"foo\"\n+  query = f\"{select} from foo where name={name}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyODU4Mw=="}, "originalCommit": {"oid": "2b2beff75f77db60f771352d9f5a3eeade2abb14"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIzMDI0MQ==", "bodyText": "From #347 (comment),  I use constant_propagation_and_evaluate_literal to determine if variable name is a literal. As the moment, the constant propagation in python does not seem to keep track of name as a literal", "url": "https://github.com/returntocorp/semgrep/pull/347#discussion_r401230241", "createdAt": "2020-03-31T21:37:07Z", "author": {"login": "ulziibay"}, "path": "sgrep/tests/python/equivalence_f_string_2.py", "diffHunk": "@@ -0,0 +1,27 @@\n+def foo1():\n+  # ERROR:\n+  select = \"select * \"\n+  query = f\"{select} from foo\"\n+\n+def foo2():\n+  # ERROR:\n+  select = \"select * \"\n+  name = \"foo\"\n+  query = f\"{select} from foo \" + f\"where name={name}\"\n+\n+def foo2a():\n+  # TODO:\n+  # OK:\n+  select = \"select * \"\n+  name = \"foo\"\n+  query = f\"{select} from foo where name={name}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyODU4Mw=="}, "originalCommit": {"oid": "2b2beff75f77db60f771352d9f5a3eeade2abb14"}, "originalPosition": 17}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4799, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}