{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNTgwMjY5", "number": 426, "title": "Add automated release job", "bodyText": "Creates a draft release when tags are pushed with OSX and ubuntu 16.04 assets.\nWaiting the OSX & ubuntu build refactoring to finish on my repo before merging.", "createdAt": "2020-04-09T18:33:04Z", "url": "https://github.com/returntocorp/semgrep/pull/426", "merged": true, "mergeCommit": {"oid": "25294c487a10eb0b74cd0b1445b50668583da4e3"}, "closed": true, "closedAt": "2020-04-16T18:58:12Z", "author": {"login": "rcoh"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWC6uPAFqTM5MTEyNjMzNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYRau5gFqTM5NDkxNTE1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTI2MzM1", "url": "https://github.com/returntocorp/semgrep/pull/426#pullrequestreview-391126335", "createdAt": "2020-04-09T20:56:21Z", "commit": {"oid": "9f99f75d8685f29b0b733bd17ed0d99fb72cd9ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDo1NjoyMlrOGDpG2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDo1NjoyMlrOGDpG2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3MjQwOA==", "bodyText": "Does this match the release name to be the semver tag?", "url": "https://github.com/returntocorp/semgrep/pull/426#discussion_r406472408", "createdAt": "2020-04-09T20:56:22Z", "author": {"login": "brendongo"}, "path": ".github/workflows/do-release.yml", "diffHunk": "@@ -0,0 +1,158 @@\n+on:\n+  push:\n+    # Sequence of patterns matched against refs/tags\n+    tags:\n+    - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10\n+\n+name: Create draft release\n+\n+jobs:\n+  create_release:\n+    name: Create the Github Release\n+    runs-on: ubuntu-latest\n+    needs: [release-osx, release-ubuntu-16-04]\n+    steps:\n+      - name: Create Release\n+        id: create_release\n+        uses: actions/create-release@v1\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+        with:\n+          tag_name: ${{ github.ref }}\n+          release_name: Release ${{ github.ref }}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f99f75d8685f29b0b733bd17ed0d99fb72cd9ce"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTI2Nzk5", "url": "https://github.com/returntocorp/semgrep/pull/426#pullrequestreview-391126799", "createdAt": "2020-04-09T20:57:05Z", "commit": {"oid": "9f99f75d8685f29b0b733bd17ed0d99fb72cd9ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDo1NzowNVrOGDpIPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDo1NzowNVrOGDpIPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3Mjc2NA==", "bodyText": "If this is a release probably better to have the release semver in the filename instead of the shahash?", "url": "https://github.com/returntocorp/semgrep/pull/426#discussion_r406472764", "createdAt": "2020-04-09T20:57:05Z", "author": {"login": "brendongo"}, "path": ".github/workflows/do-release.yml", "diffHunk": "@@ -0,0 +1,158 @@\n+on:\n+  push:\n+    # Sequence of patterns matched against refs/tags\n+    tags:\n+    - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10\n+\n+name: Create draft release\n+\n+jobs:\n+  create_release:\n+    name: Create the Github Release\n+    runs-on: ubuntu-latest\n+    needs: [release-osx, release-ubuntu-16-04]\n+    steps:\n+      - name: Create Release\n+        id: create_release\n+        uses: actions/create-release@v1\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+        with:\n+          tag_name: ${{ github.ref }}\n+          release_name: Release ${{ github.ref }}\n+          draft: true\n+          prerelease: false\n+      - uses: actions/download-artifact@v1\n+        with:\n+          name: sgrep-osx-${{ github.sha }}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f99f75d8685f29b0b733bd17ed0d99fb72cd9ce"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTI3MzI0", "url": "https://github.com/returntocorp/semgrep/pull/426#pullrequestreview-391127324", "createdAt": "2020-04-09T20:57:57Z", "commit": {"oid": "9f99f75d8685f29b0b733bd17ed0d99fb72cd9ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDo1Nzo1N1rOGDpJ6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDo1Nzo1N1rOGDpJ6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3MzE5NA==", "bodyText": "the convention we've had with past releases has been sgrep-SEMVER-ubuntu-16.04.tgz", "url": "https://github.com/returntocorp/semgrep/pull/426#discussion_r406473194", "createdAt": "2020-04-09T20:57:57Z", "author": {"login": "brendongo"}, "path": ".github/workflows/do-release.yml", "diffHunk": "@@ -0,0 +1,158 @@\n+on:\n+  push:\n+    # Sequence of patterns matched against refs/tags\n+    tags:\n+    - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10\n+\n+name: Create draft release\n+\n+jobs:\n+  create_release:\n+    name: Create the Github Release\n+    runs-on: ubuntu-latest\n+    needs: [release-osx, release-ubuntu-16-04]\n+    steps:\n+      - name: Create Release\n+        id: create_release\n+        uses: actions/create-release@v1\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+        with:\n+          tag_name: ${{ github.ref }}\n+          release_name: Release ${{ github.ref }}\n+          draft: true\n+          prerelease: false\n+      - uses: actions/download-artifact@v1\n+        with:\n+          name: sgrep-osx-${{ github.sha }}\n+          path: sgrep-osx\n+      - name: Get the version\n+        id: get_version\n+        run: echo ::set-output name=VERSION::${GITHUB_REF/refs\\/tags\\//}\n+      - name: help\n+        run: |\n+          pwd;\n+          ls;\n+          find .;\n+      - name: Upload Release Asset\n+        id: upload-release-asset-osx\n+        uses: actions/upload-release-asset@v1\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+        with:\n+          upload_url: ${{ steps.create_release.outputs.upload_url }}\n+          asset_path: ./sgrep-osx/artifacts.zip\n+          asset_name: sgrep-osx-${{ steps.get_version.outputs.VERSION }}.zip\n+          asset_content_type: application/zip\n+      - uses: actions/download-artifact@v1\n+        with:\n+          name: sgrep-ubuntu-16.04-${{ github.sha }}\n+          path: sgrep-ubuntu\n+      - name: Upload Release Asset\n+        id: upload-release-asset-ubuntu\n+        uses: actions/upload-release-asset@v1\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+        with:\n+          upload_url: ${{ steps.create_release.outputs.upload_url }}\n+          asset_path: ./sgrep-ubuntu/artifacts.tar.gz\n+          asset_name: sgrep-ubuntu-1604-${{ steps.get_version.outputs.VERSION }}.tar.gz", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f99f75d8685f29b0b733bd17ed0d99fb72cd9ce"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTI4NDk5", "url": "https://github.com/returntocorp/semgrep/pull/426#pullrequestreview-391128499", "createdAt": "2020-04-09T20:59:50Z", "commit": {"oid": "9f99f75d8685f29b0b733bd17ed0d99fb72cd9ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDo1OTo1MFrOGDpN3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDo1OTo1MFrOGDpN3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3NDIwNQ==", "bodyText": "How much work is it to DRY in this PR instead of a follow up PR?", "url": "https://github.com/returntocorp/semgrep/pull/426#discussion_r406474205", "createdAt": "2020-04-09T20:59:50Z", "author": {"login": "brendongo"}, "path": ".github/workflows/do-release.yml", "diffHunk": "@@ -0,0 +1,158 @@\n+on:\n+  push:\n+    # Sequence of patterns matched against refs/tags\n+    tags:\n+    - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10\n+\n+name: Create draft release\n+\n+jobs:\n+  create_release:\n+    name: Create the Github Release\n+    runs-on: ubuntu-latest\n+    needs: [release-osx, release-ubuntu-16-04]\n+    steps:\n+      - name: Create Release\n+        id: create_release\n+        uses: actions/create-release@v1\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+        with:\n+          tag_name: ${{ github.ref }}\n+          release_name: Release ${{ github.ref }}\n+          draft: true\n+          prerelease: false\n+      - uses: actions/download-artifact@v1\n+        with:\n+          name: sgrep-osx-${{ github.sha }}\n+          path: sgrep-osx\n+      - name: Get the version\n+        id: get_version\n+        run: echo ::set-output name=VERSION::${GITHUB_REF/refs\\/tags\\//}\n+      - name: help\n+        run: |\n+          pwd;\n+          ls;\n+          find .;\n+      - name: Upload Release Asset\n+        id: upload-release-asset-osx\n+        uses: actions/upload-release-asset@v1\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+        with:\n+          upload_url: ${{ steps.create_release.outputs.upload_url }}\n+          asset_path: ./sgrep-osx/artifacts.zip\n+          asset_name: sgrep-osx-${{ steps.get_version.outputs.VERSION }}.zip\n+          asset_content_type: application/zip\n+      - uses: actions/download-artifact@v1\n+        with:\n+          name: sgrep-ubuntu-16.04-${{ github.sha }}\n+          path: sgrep-ubuntu\n+      - name: Upload Release Asset\n+        id: upload-release-asset-ubuntu\n+        uses: actions/upload-release-asset@v1\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+        with:\n+          upload_url: ${{ steps.create_release.outputs.upload_url }}\n+          asset_path: ./sgrep-ubuntu/artifacts.tar.gz\n+          asset_name: sgrep-ubuntu-1604-${{ steps.get_version.outputs.VERSION }}.tar.gz\n+          asset_content_type: application/gzip\n+  release-osx:\n+    name: Build the OSX binaries\n+    runs-on: macos-latest\n+    # TODO: this is very similar to the mac-build workflow. Convert to an action\n+    steps:\n+      - name: Install System Deps\n+        run: brew install opam pkg-config coreutils\n+      - name: Checkout\n+        uses: actions/checkout@v2\n+      - name: OPAM setup\n+        run: |\n+          opam init --no-setup --bare;\n+          opam switch create 4.07.1;\n+          opam switch 4.07.1;\n+      - name: OPAM install Deps\n+        run: eval $(opam env); opam install -y reason dune ocamlfind camlp4 num ocamlgraph json-wheel conf-perl yaml\n+      - name: Install submodules\n+        run: git submodule update --init --recursive\n+      - name: Install pfff\n+        run: eval $(opam env) && opam install -y ./pfff\n+      - name: Install and test sgrep\n+        run: eval $(opam env) && cd sgrep && make all && make test && make install\n+      - name: Prepare artifacts\n+        run: |\n+          mkdir -p artifacts;\n+          cp ./sgrep/_build/default/bin/main_sgrep.exe artifacts/sgrep;\n+          zip -r artifacts.zip artifacts\n+\n+      - name: Upload artifacts\n+        uses: actions/upload-artifact@v1\n+        with:\n+          name: sgrep-osx-${{ github.sha }}\n+          path: artifacts.zip\n+  release-ubuntu-16-04:\n+    # TODO: this is very similar to the ubuntu-build workflow.\n+    # convert to github action to DRY", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f99f75d8685f29b0b733bd17ed0d99fb72cd9ce"}, "originalPosition": 96}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "77273abbf166eee61867af3ff6ce22d8c72ec959", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/77273abbf166eee61867af3ff6ce22d8c72ec959", "committedDate": "2020-04-13T17:30:21Z", "message": "Move everything to semgrep that's possible to move. Probably missed something"}, "afterCommit": {"oid": "cabd4bfdbbef4e58f60f504a65d460773e53c3f0", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/cabd4bfdbbef4e58f60f504a65d460773e53c3f0", "committedDate": "2020-04-13T17:50:05Z", "message": "Move everything to semgrep that's possible to move. Probably missed something"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5aaed2fee3e48367c90ab5fc539aac122cc7e32", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/e5aaed2fee3e48367c90ab5fc539aac122cc7e32", "committedDate": "2020-04-16T15:27:39Z", "message": "Add automated release job"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d228acad9070a15e1a9918eab68d40fbbbd495c", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/0d228acad9070a15e1a9918eab68d40fbbbd495c", "committedDate": "2020-04-16T15:27:39Z", "message": "Cleanup trailing whitespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ee38e8dd9fbb50275397c1566e3b6efab609f52", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/7ee38e8dd9fbb50275397c1566e3b6efab609f52", "committedDate": "2020-04-16T15:27:39Z", "message": "Move everything to semgrep that's possible to move. Probably missed something"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0dc171c89771018c6d591d42e28e6927dd0f549", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/c0dc171c89771018c6d591d42e28e6927dd0f549", "committedDate": "2020-04-16T15:27:39Z", "message": "Fix directory name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f0773302afbdfbd353ee5f4fb2e74b259694bd5", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/1f0773302afbdfbd353ee5f4fb2e74b259694bd5", "committedDate": "2020-04-16T15:31:38Z", "message": "Factor out OSX release script"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3bdef017a126e091da3d7428205a840edfde436c", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/3bdef017a126e091da3d7428205a840edfde436c", "committedDate": "2020-04-16T15:26:47Z", "message": "Factor out OSX release script"}, "afterCommit": {"oid": "1f0773302afbdfbd353ee5f4fb2e74b259694bd5", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/1f0773302afbdfbd353ee5f4fb2e74b259694bd5", "committedDate": "2020-04-16T15:31:38Z", "message": "Factor out OSX release script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccacea686a62c9ef91771524cbd058c560bd8131", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/ccacea686a62c9ef91771524cbd058c560bd8131", "committedDate": "2020-04-16T15:38:11Z", "message": "Quote opam env for shellcheck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8787807910924b5f407c86aeba78a4600592ba73", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/8787807910924b5f407c86aeba78a4600592ba73", "committedDate": "2020-04-16T15:57:38Z", "message": "Factor out ubuntu release"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b141defd1585d4568072f6cb33eee8fce05a9cc9", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/b141defd1585d4568072f6cb33eee8fce05a9cc9", "committedDate": "2020-04-16T16:01:57Z", "message": "Fix release script opam invocation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44d73eb44d03d1b85bc62abf476ef019cd5e5c39", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/44d73eb44d03d1b85bc62abf476ef019cd5e5c39", "committedDate": "2020-04-16T16:14:19Z", "message": "Adjust permissions before checkout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f33658a505d41c4c679e7c976ef0ed2c6bdc07ac", "author": {"user": {"login": "rcoh", "name": "Russell Cohen"}}, "url": "https://github.com/returntocorp/semgrep/commit/f33658a505d41c4c679e7c976ef0ed2c6bdc07ac", "committedDate": "2020-04-16T16:20:31Z", "message": "Tweaks because we aren't inside the GH runner anymore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0OTEzMzA2", "url": "https://github.com/returntocorp/semgrep/pull/426#pullrequestreview-394913306", "createdAt": "2020-04-16T18:55:10Z", "commit": {"oid": "f33658a505d41c4c679e7c976ef0ed2c6bdc07ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0OTE1MTU4", "url": "https://github.com/returntocorp/semgrep/pull/426#pullrequestreview-394915158", "createdAt": "2020-04-16T18:57:51Z", "commit": {"oid": "f33658a505d41c4c679e7c976ef0ed2c6bdc07ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1110, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}