{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMTYzMjgy", "number": 680, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDoxOTo0NFrOD5Jkgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxODoyOToyOFrOD5hw-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMjUyMjI2OnYy", "diffSide": "RIGHT", "path": "semgrep/Makefile", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDoxOTo0NFrOGQQo5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDoxOTo0NFrOGQQo5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwMzAxMg==", "bodyText": "Once semgrep is pip installable, I'd prefer to make sure everyone has it installed as editable in their environment instead of setting PYTHONPATH.", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r419703012", "createdAt": "2020-05-04T20:19:44Z", "author": {"login": "underyx"}, "path": "semgrep/Makefile", "diffHunk": "@@ -3,7 +3,7 @@ all:\n clean:\n \trm -rf ./build/\n test:\n-\t./tests/run-lint-tests.sh\n+\tPYTHONPATH=. pytest tests/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMjUyOTA0OnYy", "diffSide": "RIGHT", "path": "semgrep/tests/e2e/snapshots/test_json_output/test_default_rule__file/results.json", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDoyMTo0NVrOGQQtIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxODoxNTo0NFrOGQ1x9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNDA5OA==", "bodyText": "Note to self, find out why this printed message changed compared to the previous committed JSON.", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r419704098", "createdAt": "2020-05-04T20:21:45Z", "author": {"login": "underyx"}, "path": "semgrep/tests/e2e/snapshots/test_json_output/test_default_rule__file/results.json", "diffHunk": "@@ -0,0 +1 @@\n+{\"results\": [{\"check_id\": \"eqeq-is-bad\", \"path\": \"targets/basic/stupid.py\", \"start\": {\"line\": 3, \"col\": 12}, \"end\": {\"line\": 3, \"col\": 26}, \"extra\": {\"message\": \"useless comparison operation `a+b == a+b` or `a+b != a+b`; possible bug?\", \"metavars\": {\"$X\": {\"start\": {\"line\": 3, \"col\": 12, \"offset\": 55}, \"end\": {\"line\": 3, \"col\": 17, \"offset\": 60}, \"abstract_content\": \"a+b\", \"unique_id\": {\"type\": \"AST\", \"md5sum\": \"07d71d85769e594dba9d7ae3d295c01f\"}}}, \"metadata\": {}, \"severity\": \"ERROR\"}}, {\"check_id\": \"javascript-basic-eqeq-bad\", \"path\": \"targets/basic/stupid.js\", \"start\": {\"line\": 3, \"col\": 13}, \"end\": {\"line\": 3, \"col\": 19}, \"extra\": {\"message\": \"useless comparison\", \"metavars\": {\"$X\": {\"start\": {\"line\": 3, \"col\": 13, \"offset\": 24}, \"end\": {\"line\": 3, \"col\": 14, \"offset\": 25}, \"abstract_content\": \"x\", \"unique_id\": {\"type\": \"id\", \"value\": \"x\", \"kind\": \"Global\", \"sid\": 1}}}, \"metadata\": {}, \"severity\": \"ERROR\"}}], \"errors\": []}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMxMTU0Mw==", "bodyText": "Ah of course! I changed this test to just test whether the default semgrep rules location is picked up correctly, and split the --generate-config test to a separate file. So this now uses eqeq.yml instead of the semgrep-rules template.", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420311543", "createdAt": "2020-05-05T18:15:44Z", "author": {"login": "underyx"}, "path": "semgrep/tests/e2e/snapshots/test_json_output/test_default_rule__file/results.json", "diffHunk": "@@ -0,0 +1 @@\n+{\"results\": [{\"check_id\": \"eqeq-is-bad\", \"path\": \"targets/basic/stupid.py\", \"start\": {\"line\": 3, \"col\": 12}, \"end\": {\"line\": 3, \"col\": 26}, \"extra\": {\"message\": \"useless comparison operation `a+b == a+b` or `a+b != a+b`; possible bug?\", \"metavars\": {\"$X\": {\"start\": {\"line\": 3, \"col\": 12, \"offset\": 55}, \"end\": {\"line\": 3, \"col\": 17, \"offset\": 60}, \"abstract_content\": \"a+b\", \"unique_id\": {\"type\": \"AST\", \"md5sum\": \"07d71d85769e594dba9d7ae3d295c01f\"}}}, \"metadata\": {}, \"severity\": \"ERROR\"}}, {\"check_id\": \"javascript-basic-eqeq-bad\", \"path\": \"targets/basic/stupid.js\", \"start\": {\"line\": 3, \"col\": 13}, \"end\": {\"line\": 3, \"col\": 19}, \"extra\": {\"message\": \"useless comparison\", \"metavars\": {\"$X\": {\"start\": {\"line\": 3, \"col\": 13, \"offset\": 24}, \"end\": {\"line\": 3, \"col\": 14, \"offset\": 25}, \"abstract_content\": \"x\", \"unique_id\": {\"type\": \"id\", \"value\": \"x\", \"kind\": \"Global\", \"sid\": 1}}}, \"metadata\": {}, \"severity\": \"ERROR\"}}], \"errors\": []}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNDA5OA=="}, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMjUzMjc4OnYy", "diffSide": "RIGHT", "path": "semgrep/tests/e2e/snapshots/test_rule_parser/test_rule_parser__failure__error_messages/bad1/error.txt", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDoyMjo0NVrOGQQvYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDoyMjo0NVrOGQQvYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNDY3NQ==", "bodyText": "Note that my paths being snapshotted here are okay, as this is marked as an expected failure and this issue is linked: #678", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r419704675", "createdAt": "2020-05-04T20:22:45Z", "author": {"login": "underyx"}, "path": "semgrep/tests/e2e/snapshots/test_rule_parser/test_rule_parser__failure__error_messages/bad1/error.txt", "diffHunk": "@@ -0,0 +1,26 @@\n+Traceback (most recent call last):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMjUzNTQwOnYy", "diffSide": "RIGHT", "path": "semgrep/tests/e2e/test_semgrep_rules_repo.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDoyMzozNlrOGQQxFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTowMzo0OVrOGRXhUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNTExMQ==", "bodyText": "I'm not fully sure what this does, @DrewDennison could you explain these commands and what they test?", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r419705111", "createdAt": "2020-05-04T20:23:36Z", "author": {"login": "underyx"}, "path": "semgrep/tests/e2e/test_semgrep_rules_repo.py", "diffHunk": "@@ -0,0 +1,22 @@\n+import subprocess\n+from pathlib import Path\n+\n+\n+def test_semgrep_rules_repo(run_semgrep):\n+    subprocess.check_output(\n+        [\"git\", \"clone\", \"--depth=1\", \"https://github.com/returntocorp/semgrep-rules\"]\n+    )\n+    subprocess.check_output([\"python\", \"-m\", \"semgrep\", \"--generate-config\"])\n+    subprocess.check_output(\n+        [\n+            \"python\",\n+            \"-m\",\n+            \"semgrep\",\n+            \"--dangerously-allow-arbitrary-code-execution-from-rules\",\n+            \"--strict\",\n+            \"--test\",\n+            \"--test-ignore-todo\",\n+            \"semgrep-rules\",\n+        ]\n+    )\n+    subprocess.check_output([\"python\", \"-m\", \"semgrep\", \"--validate\", \"semgrep-rules\"])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg2NDMzOA==", "bodyText": "i'm pretty sure this test makes sure that the entire semgrep-rules repo has validating config files", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420864338", "createdAt": "2020-05-06T15:03:49Z", "author": {"login": "nbrahms"}, "path": "semgrep/tests/e2e/test_semgrep_rules_repo.py", "diffHunk": "@@ -0,0 +1,22 @@\n+import subprocess\n+from pathlib import Path\n+\n+\n+def test_semgrep_rules_repo(run_semgrep):\n+    subprocess.check_output(\n+        [\"git\", \"clone\", \"--depth=1\", \"https://github.com/returntocorp/semgrep-rules\"]\n+    )\n+    subprocess.check_output([\"python\", \"-m\", \"semgrep\", \"--generate-config\"])\n+    subprocess.check_output(\n+        [\n+            \"python\",\n+            \"-m\",\n+            \"semgrep\",\n+            \"--dangerously-allow-arbitrary-code-execution-from-rules\",\n+            \"--strict\",\n+            \"--test\",\n+            \"--test-ignore-todo\",\n+            \"semgrep-rules\",\n+        ]\n+    )\n+    subprocess.check_output([\"python\", \"-m\", \"semgrep\", \"--validate\", \"semgrep-rules\"])", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNTExMQ=="}, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNTYxMjU2OnYy", "diffSide": "RIGHT", "path": "semgrep/requirements.txt", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNTowMjowM1rOGQttcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNDoxMDo0OVrOGRU9-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3OTMxMw==", "bodyText": "Is there any way we can achieve the same level of testing without snapshotting? If I'm understanding snapshots correctly, they seem very difficult to reason about. I can never tell why a huge JSON blob is no longer the same as a previous huge JSON blob. IMO we should be testing small amounts of functionality and return values instead of dumping everything to a file and essentially performing a diff.", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420179313", "createdAt": "2020-05-05T15:02:03Z", "author": {"login": "mschwager"}, "path": "semgrep/requirements.txt", "diffHunk": "@@ -1,5 +1,6 @@\n colorama==0.4.3\n pytest==5.3.5\n+pytest-snapshot==0.4.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMxNTg5MQ==", "bodyText": "This seems like the age-old debate about end-to-end vs. unit tests. IMO, in general you need both: end-to-end tests (using snapshots here) guarantee behavior, while unit tests allow you to debug regressions.\nBut end-to-end tests would usually be primary, as without them, you can't guarantee your system works. So we want those most urgently.", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420315891", "createdAt": "2020-05-05T18:22:55Z", "author": {"login": "nbrahms"}, "path": "semgrep/requirements.txt", "diffHunk": "@@ -1,5 +1,6 @@\n colorama==0.4.3\n pytest==5.3.5\n+pytest-snapshot==0.4.0", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3OTMxMw=="}, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMxNjI0OQ==", "bodyText": "cf. https://blog.colinbreck.com/should-we-write-a-unit-test-or-an-end-to-end-test/", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420316249", "createdAt": "2020-05-05T18:23:33Z", "author": {"login": "nbrahms"}, "path": "semgrep/requirements.txt", "diffHunk": "@@ -1,5 +1,6 @@\n colorama==0.4.3\n pytest==5.3.5\n+pytest-snapshot==0.4.0", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3OTMxMw=="}, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMyMDM4Nw==", "bodyText": "Thanks! I had similar thoughts and had just documented that philosophy here: https://github.com/returntocorp/semgrep/blob/bence/pytest/semgrep/tests/README.md", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420320387", "createdAt": "2020-05-05T18:30:13Z", "author": {"login": "underyx"}, "path": "semgrep/requirements.txt", "diffHunk": "@@ -1,5 +1,6 @@\n colorama==0.4.3\n pytest==5.3.5\n+pytest-snapshot==0.4.0", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3OTMxMw=="}, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMyNjgxNg==", "bodyText": "FWIW, pretty-printing the JSON blobs might make debugging e2e failures much easier. Food for thought.", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420326816", "createdAt": "2020-05-05T18:41:07Z", "author": {"login": "nbrahms"}, "path": "semgrep/requirements.txt", "diffHunk": "@@ -1,5 +1,6 @@\n colorama==0.4.3\n pytest==5.3.5\n+pytest-snapshot==0.4.0", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3OTMxMw=="}, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM0MzI1Nw==", "bodyText": "Yeah. I was considering that too but felt like it would be too unclean to mess with the stdout \ud83e\udd14\nAdded this change now though!", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420343257", "createdAt": "2020-05-05T19:09:48Z", "author": {"login": "underyx"}, "path": "semgrep/requirements.txt", "diffHunk": "@@ -1,5 +1,6 @@\n colorama==0.4.3\n pytest==5.3.5\n+pytest-snapshot==0.4.0", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3OTMxMw=="}, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgyMjUyMw==", "bodyText": "When I think about testing I tend to use unit tests to test a single component, integration tests to test the interaction of two (or a few) components, and e2e tests to test many components or the system as a whole. Since semgrep is really only one component, or two if you count the core separately, I would lean toward unit tests.\n\n... end-to-end tests (using snapshots here) guarantee behavior, while unit tests allow you to debug regressions ... But end-to-end tests would usually be primary, as without them, you can't guarantee your system works.\n\nI'm not sure I agree here. In my opinion unit tests can also guarantee behavior, and e2e tests can be used to debug regressions. I've seen highly stable systems that use nothing but unit tests, and very fragile systems that use all e2e tests, or a mix of all three.\nRegardless, I won't harp on the issue too much since it seems the decision's been made to go with this approach \ud83d\udc4d", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420822523", "createdAt": "2020-05-06T14:10:49Z", "author": {"login": "mschwager"}, "path": "semgrep/requirements.txt", "diffHunk": "@@ -1,5 +1,6 @@\n colorama==0.4.3\n pytest==5.3.5\n+pytest-snapshot==0.4.0", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3OTMxMw=="}, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNTYxODkyOnYy", "diffSide": "RIGHT", "path": "semgrep/tests/e2e/conftest.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNTowMzozM1rOGQtxwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxOToxMjoyMVrOGQ3zbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE4MDQxOA==", "bodyText": "This is calling Python code from Python code. Is there any way we can just call this library directly instead of subprocessing out?", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420180418", "createdAt": "2020-05-05T15:03:33Z", "author": {"login": "mschwager"}, "path": "semgrep/tests/e2e/conftest.py", "diffHunk": "@@ -0,0 +1,45 @@\n+import subprocess\n+from pathlib import Path\n+from typing import Optional\n+from typing import Sequence\n+from typing import Union\n+\n+import pytest\n+\n+\n+E2E_TESTS_PATH = Path(__file__).parent\n+\n+\n+def _run_semgrep(\n+    config: Optional[Union[str, Path]] = None,\n+    *,\n+    target_name: str = \"basic\",\n+    stderr: bool = False\n+) -> str:\n+    config_opts = [\"--config\", config] if config is not None else []\n+\n+    return subprocess.check_output(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM0NDY4NA==", "bodyText": "I think it fits with the end-to-end philosophy to test whether commands run as expected. In tests/unit/ we definitely shouldn't have a single usage of subprocess though. Does that sound okay?", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420344684", "createdAt": "2020-05-05T19:12:21Z", "author": {"login": "underyx"}, "path": "semgrep/tests/e2e/conftest.py", "diffHunk": "@@ -0,0 +1,45 @@\n+import subprocess\n+from pathlib import Path\n+from typing import Optional\n+from typing import Sequence\n+from typing import Union\n+\n+import pytest\n+\n+\n+E2E_TESTS_PATH = Path(__file__).parent\n+\n+\n+def _run_semgrep(\n+    config: Optional[Union[str, Path]] = None,\n+    *,\n+    target_name: str = \"basic\",\n+    stderr: bool = False\n+) -> str:\n+    config_opts = [\"--config\", config] if config is not None else []\n+\n+    return subprocess.check_output(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE4MDQxOA=="}, "originalCommit": {"oid": "62539570a6325a86a2d1866c57bb6e9465354291"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNjQ3MzY2OnYy", "diffSide": "RIGHT", "path": "semgrep/tests/conftest.py", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxODoyNjoyMFrOGQ2KuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxODo0MDowMVrOGQ2rIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMxNzg4MA==", "bodyText": "At some point in the future, we probably want to be able to assert non-0 return codes", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420317880", "createdAt": "2020-05-05T18:26:20Z", "author": {"login": "nbrahms"}, "path": "semgrep/tests/conftest.py", "diffHunk": "@@ -0,0 +1,64 @@\n+import subprocess\n+from pathlib import Path\n+from typing import Optional\n+from typing import Sequence\n+from typing import Union\n+\n+import pytest\n+\n+\n+TESTS_PATH = Path(__file__).parent\n+\n+\n+def _run_semgrep(\n+    config: Optional[Union[str, Path]] = None,\n+    *,\n+    target_name: str = \"basic\",\n+    stderr: bool = False\n+) -> str:\n+    config_opts = [\"--config\", config] if config is not None else []\n+\n+    return subprocess.check_output(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac0eb3257d12b67104da1bcc6d94d2d2971f6626"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMyMjQxMw==", "bodyText": "This is already possible! Check test_rule_parser.py.\nSample snippet:\n    with pytest.raises(CalledProcessError) as excinfo:\n        run_semgrep(f\"rules/syntax/{filename}.yaml\")\n    assert excinfo.value.returncode != 0", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420322413", "createdAt": "2020-05-05T18:33:37Z", "author": {"login": "underyx"}, "path": "semgrep/tests/conftest.py", "diffHunk": "@@ -0,0 +1,64 @@\n+import subprocess\n+from pathlib import Path\n+from typing import Optional\n+from typing import Sequence\n+from typing import Union\n+\n+import pytest\n+\n+\n+TESTS_PATH = Path(__file__).parent\n+\n+\n+def _run_semgrep(\n+    config: Optional[Union[str, Path]] = None,\n+    *,\n+    target_name: str = \"basic\",\n+    stderr: bool = False\n+) -> str:\n+    config_opts = [\"--config\", config] if config is not None else []\n+\n+    return subprocess.check_output(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMxNzg4MA=="}, "originalCommit": {"oid": "ac0eb3257d12b67104da1bcc6d94d2d2971f6626"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMyNjE3OA==", "bodyText": "ah right, because we throw a CalledProcessError. cool cool.", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420326178", "createdAt": "2020-05-05T18:40:01Z", "author": {"login": "nbrahms"}, "path": "semgrep/tests/conftest.py", "diffHunk": "@@ -0,0 +1,64 @@\n+import subprocess\n+from pathlib import Path\n+from typing import Optional\n+from typing import Sequence\n+from typing import Union\n+\n+import pytest\n+\n+\n+TESTS_PATH = Path(__file__).parent\n+\n+\n+def _run_semgrep(\n+    config: Optional[Union[str, Path]] = None,\n+    *,\n+    target_name: str = \"basic\",\n+    stderr: bool = False\n+) -> str:\n+    config_opts = [\"--config\", config] if config is not None else []\n+\n+    return subprocess.check_output(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMxNzg4MA=="}, "originalCommit": {"oid": "ac0eb3257d12b67104da1bcc6d94d2d2971f6626"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNjQ4NjMyOnYy", "diffSide": "RIGHT", "path": "semgrep/tests/qa/test_public_repos.py", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxODoyOToyOFrOGQ2Shw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxOTowMzoyM1rOGQ3fUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMxOTg3OQ==", "bodyText": "Can this run from a temporary path?", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420319879", "createdAt": "2020-05-05T18:29:28Z", "author": {"login": "nbrahms"}, "path": "semgrep/tests/qa/test_public_repos.py", "diffHunk": "@@ -0,0 +1,99 @@\n+import json\n+import subprocess\n+from pathlib import Path\n+\n+import pytest\n+\n+pytestmark = pytest.mark.qa\n+\n+\n+def xfail_repo(url, *, reason=None):\n+    return pytest.param(url, marks=pytest.mark.xfail(reason=reason))\n+\n+\n+@pytest.mark.parametrize(\n+    \"repo_url\",\n+    [\n+        \"https://github.com/Airtable/airtable.js\",\n+        \"https://github.com/seemoo-lab/opendrop\",\n+        \"https://github.com/lightstep/lightstep-tracer-python\",\n+        \"https://github.com/draios/sysdig-inspect\",\n+        \"https://github.com/getsentry/sentry-python\",\n+        \"https://github.com/signalapp/signal-webrtc-ios\",\n+        \"https://github.com/secdev/scapy\",\n+        \"https://github.com/apache/airflow\",\n+        \"https://github.com/preset-io/elasticsearch-dbapi\",\n+        \"https://github.com/apache/libcloud\",\n+        \"https://github.com/keybase/pykeybasebot\",\n+        \"https://gitbox.apache.org/repos/asf/cassandra\",\n+        \"https://github.com/coinbase/coinbase-commerce-python\",\n+        \"https://github.com/keybase/python-triplesec\",\n+        \"https://github.com/psycopg/psycopg2\",\n+        \"https://github.com/preset-io/flask-jwt-extended\",\n+        \"https://github.com/vstinner/pyperf\",\n+        \"https://github.com/mysql/mysql-connector-python\",\n+        \"https://github.com/Netflix/lemur\",\n+        xfail_repo(\"https://github.com/highcharts/highcharts\"),\n+        xfail_repo(\n+            \"https://github.com/lodash/lodash\",\n+            reason=\"https://github.com/returntocorp/semgrep/issues/580\",\n+        ),\n+        xfail_repo(\"https://github.com/signalapp/Signal-Desktop\"),\n+        xfail_repo(\"https://github.com/opensourceactivismtech/call-power\"),\n+        xfail_repo(\"https://github.com/zulip/zulip\"),\n+        xfail_repo(\n+            \"https://github.com/home-assistant/home-assistant\",\n+            reason=(\n+                \"https://github.com/returntocorp/semgrep/issues/599, \"\n+                \"https://github.com/returntocorp/semgrep/issues/600, \"\n+                \"https://github.com/returntocorp/semgrep/issues/601, \"\n+                \"https://github.com/returntocorp/semgrep/issues/602\"\n+            ),\n+        ),\n+        xfail_repo(\n+            \"https://github.com/apache/incubator-superset\",\n+            reason=(\n+                \"https://github.com/returntocorp/semgrep/issues/581, \"\n+                \"https://github.com/returntocorp/semgrep/issues/582\"\n+            ),\n+        ),\n+    ],\n+)\n+def test_semgrep_on_repo(run_semgrep, repo_url):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac0eb3257d12b67104da1bcc6d94d2d2971f6626"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMyMTM2NQ==", "bodyText": "It actually does, see behavior of https://github.com/returntocorp/semgrep/blob/bence/pytest/semgrep/tests/README.md#run_semgrep \u2014 the fixture prepares a temporary workspace with rules and target files.\nThis was one of the bits I was worried might be too magical \ud83d\ude05", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420321365", "createdAt": "2020-05-05T18:31:50Z", "author": {"login": "underyx"}, "path": "semgrep/tests/qa/test_public_repos.py", "diffHunk": "@@ -0,0 +1,99 @@\n+import json\n+import subprocess\n+from pathlib import Path\n+\n+import pytest\n+\n+pytestmark = pytest.mark.qa\n+\n+\n+def xfail_repo(url, *, reason=None):\n+    return pytest.param(url, marks=pytest.mark.xfail(reason=reason))\n+\n+\n+@pytest.mark.parametrize(\n+    \"repo_url\",\n+    [\n+        \"https://github.com/Airtable/airtable.js\",\n+        \"https://github.com/seemoo-lab/opendrop\",\n+        \"https://github.com/lightstep/lightstep-tracer-python\",\n+        \"https://github.com/draios/sysdig-inspect\",\n+        \"https://github.com/getsentry/sentry-python\",\n+        \"https://github.com/signalapp/signal-webrtc-ios\",\n+        \"https://github.com/secdev/scapy\",\n+        \"https://github.com/apache/airflow\",\n+        \"https://github.com/preset-io/elasticsearch-dbapi\",\n+        \"https://github.com/apache/libcloud\",\n+        \"https://github.com/keybase/pykeybasebot\",\n+        \"https://gitbox.apache.org/repos/asf/cassandra\",\n+        \"https://github.com/coinbase/coinbase-commerce-python\",\n+        \"https://github.com/keybase/python-triplesec\",\n+        \"https://github.com/psycopg/psycopg2\",\n+        \"https://github.com/preset-io/flask-jwt-extended\",\n+        \"https://github.com/vstinner/pyperf\",\n+        \"https://github.com/mysql/mysql-connector-python\",\n+        \"https://github.com/Netflix/lemur\",\n+        xfail_repo(\"https://github.com/highcharts/highcharts\"),\n+        xfail_repo(\n+            \"https://github.com/lodash/lodash\",\n+            reason=\"https://github.com/returntocorp/semgrep/issues/580\",\n+        ),\n+        xfail_repo(\"https://github.com/signalapp/Signal-Desktop\"),\n+        xfail_repo(\"https://github.com/opensourceactivismtech/call-power\"),\n+        xfail_repo(\"https://github.com/zulip/zulip\"),\n+        xfail_repo(\n+            \"https://github.com/home-assistant/home-assistant\",\n+            reason=(\n+                \"https://github.com/returntocorp/semgrep/issues/599, \"\n+                \"https://github.com/returntocorp/semgrep/issues/600, \"\n+                \"https://github.com/returntocorp/semgrep/issues/601, \"\n+                \"https://github.com/returntocorp/semgrep/issues/602\"\n+            ),\n+        ),\n+        xfail_repo(\n+            \"https://github.com/apache/incubator-superset\",\n+            reason=(\n+                \"https://github.com/returntocorp/semgrep/issues/581, \"\n+                \"https://github.com/returntocorp/semgrep/issues/582\"\n+            ),\n+        ),\n+    ],\n+)\n+def test_semgrep_on_repo(run_semgrep, repo_url):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMxOTg3OQ=="}, "originalCommit": {"oid": "ac0eb3257d12b67104da1bcc6d94d2d2971f6626"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMyNTc5MA==", "bodyText": "ah... maybe can we rename run_semgrep to run_semgrep_in_tmp?", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420325790", "createdAt": "2020-05-05T18:39:23Z", "author": {"login": "nbrahms"}, "path": "semgrep/tests/qa/test_public_repos.py", "diffHunk": "@@ -0,0 +1,99 @@\n+import json\n+import subprocess\n+from pathlib import Path\n+\n+import pytest\n+\n+pytestmark = pytest.mark.qa\n+\n+\n+def xfail_repo(url, *, reason=None):\n+    return pytest.param(url, marks=pytest.mark.xfail(reason=reason))\n+\n+\n+@pytest.mark.parametrize(\n+    \"repo_url\",\n+    [\n+        \"https://github.com/Airtable/airtable.js\",\n+        \"https://github.com/seemoo-lab/opendrop\",\n+        \"https://github.com/lightstep/lightstep-tracer-python\",\n+        \"https://github.com/draios/sysdig-inspect\",\n+        \"https://github.com/getsentry/sentry-python\",\n+        \"https://github.com/signalapp/signal-webrtc-ios\",\n+        \"https://github.com/secdev/scapy\",\n+        \"https://github.com/apache/airflow\",\n+        \"https://github.com/preset-io/elasticsearch-dbapi\",\n+        \"https://github.com/apache/libcloud\",\n+        \"https://github.com/keybase/pykeybasebot\",\n+        \"https://gitbox.apache.org/repos/asf/cassandra\",\n+        \"https://github.com/coinbase/coinbase-commerce-python\",\n+        \"https://github.com/keybase/python-triplesec\",\n+        \"https://github.com/psycopg/psycopg2\",\n+        \"https://github.com/preset-io/flask-jwt-extended\",\n+        \"https://github.com/vstinner/pyperf\",\n+        \"https://github.com/mysql/mysql-connector-python\",\n+        \"https://github.com/Netflix/lemur\",\n+        xfail_repo(\"https://github.com/highcharts/highcharts\"),\n+        xfail_repo(\n+            \"https://github.com/lodash/lodash\",\n+            reason=\"https://github.com/returntocorp/semgrep/issues/580\",\n+        ),\n+        xfail_repo(\"https://github.com/signalapp/Signal-Desktop\"),\n+        xfail_repo(\"https://github.com/opensourceactivismtech/call-power\"),\n+        xfail_repo(\"https://github.com/zulip/zulip\"),\n+        xfail_repo(\n+            \"https://github.com/home-assistant/home-assistant\",\n+            reason=(\n+                \"https://github.com/returntocorp/semgrep/issues/599, \"\n+                \"https://github.com/returntocorp/semgrep/issues/600, \"\n+                \"https://github.com/returntocorp/semgrep/issues/601, \"\n+                \"https://github.com/returntocorp/semgrep/issues/602\"\n+            ),\n+        ),\n+        xfail_repo(\n+            \"https://github.com/apache/incubator-superset\",\n+            reason=(\n+                \"https://github.com/returntocorp/semgrep/issues/581, \"\n+                \"https://github.com/returntocorp/semgrep/issues/582\"\n+            ),\n+        ),\n+    ],\n+)\n+def test_semgrep_on_repo(run_semgrep, repo_url):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMxOTg3OQ=="}, "originalCommit": {"oid": "ac0eb3257d12b67104da1bcc6d94d2d2971f6626"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMzOTUzOA==", "bodyText": "Yeah! Renamed.", "url": "https://github.com/returntocorp/semgrep/pull/680#discussion_r420339538", "createdAt": "2020-05-05T19:03:23Z", "author": {"login": "underyx"}, "path": "semgrep/tests/qa/test_public_repos.py", "diffHunk": "@@ -0,0 +1,99 @@\n+import json\n+import subprocess\n+from pathlib import Path\n+\n+import pytest\n+\n+pytestmark = pytest.mark.qa\n+\n+\n+def xfail_repo(url, *, reason=None):\n+    return pytest.param(url, marks=pytest.mark.xfail(reason=reason))\n+\n+\n+@pytest.mark.parametrize(\n+    \"repo_url\",\n+    [\n+        \"https://github.com/Airtable/airtable.js\",\n+        \"https://github.com/seemoo-lab/opendrop\",\n+        \"https://github.com/lightstep/lightstep-tracer-python\",\n+        \"https://github.com/draios/sysdig-inspect\",\n+        \"https://github.com/getsentry/sentry-python\",\n+        \"https://github.com/signalapp/signal-webrtc-ios\",\n+        \"https://github.com/secdev/scapy\",\n+        \"https://github.com/apache/airflow\",\n+        \"https://github.com/preset-io/elasticsearch-dbapi\",\n+        \"https://github.com/apache/libcloud\",\n+        \"https://github.com/keybase/pykeybasebot\",\n+        \"https://gitbox.apache.org/repos/asf/cassandra\",\n+        \"https://github.com/coinbase/coinbase-commerce-python\",\n+        \"https://github.com/keybase/python-triplesec\",\n+        \"https://github.com/psycopg/psycopg2\",\n+        \"https://github.com/preset-io/flask-jwt-extended\",\n+        \"https://github.com/vstinner/pyperf\",\n+        \"https://github.com/mysql/mysql-connector-python\",\n+        \"https://github.com/Netflix/lemur\",\n+        xfail_repo(\"https://github.com/highcharts/highcharts\"),\n+        xfail_repo(\n+            \"https://github.com/lodash/lodash\",\n+            reason=\"https://github.com/returntocorp/semgrep/issues/580\",\n+        ),\n+        xfail_repo(\"https://github.com/signalapp/Signal-Desktop\"),\n+        xfail_repo(\"https://github.com/opensourceactivismtech/call-power\"),\n+        xfail_repo(\"https://github.com/zulip/zulip\"),\n+        xfail_repo(\n+            \"https://github.com/home-assistant/home-assistant\",\n+            reason=(\n+                \"https://github.com/returntocorp/semgrep/issues/599, \"\n+                \"https://github.com/returntocorp/semgrep/issues/600, \"\n+                \"https://github.com/returntocorp/semgrep/issues/601, \"\n+                \"https://github.com/returntocorp/semgrep/issues/602\"\n+            ),\n+        ),\n+        xfail_repo(\n+            \"https://github.com/apache/incubator-superset\",\n+            reason=(\n+                \"https://github.com/returntocorp/semgrep/issues/581, \"\n+                \"https://github.com/returntocorp/semgrep/issues/582\"\n+            ),\n+        ),\n+    ],\n+)\n+def test_semgrep_on_repo(run_semgrep, repo_url):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMxOTg3OQ=="}, "originalCommit": {"oid": "ac0eb3257d12b67104da1bcc6d94d2d2971f6626"}, "originalPosition": 62}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4673, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}