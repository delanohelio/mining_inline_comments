{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExMDYzOTgz", "number": 619, "title": "Specify Equivalence Patterns in rule file", "bodyText": "This is DEFINTELY A WORK IN PROGRESS, but it's sufficient enough to get started.\nFuture issues that will need to be worked on:\n\n(semgrep-core) Equivalences don't quite work like I would expect. I sort of thought it would replace the subtree when it found that pattern in parsed code. However, I have been running into the following issues:\n1a. Only the first equivalence matches. If I specify several equivalences that should resolve to the same thing, only the first one works. Example:\n\n- equivalence: request.$W(...) <==> request.$W.get(...)\n- equivalence: request.$W <==> request.$W.get(...)\n- pattern: django.shortcuts.redirect(..., request.$W.get(...), ...)\nand given this file:\nfrom django.http import HttpResponseRedirect\nfrom django.shortcuts import redirect\n\ndef arg(request):\n    # ruleid: open-redirect\n    return redirect(request.POST.get(\"next\"))\n\n\ndef argh(request):\n    # ruleid: open-redirect\n    return redirect(request.get_host())\n\n\ndef arghh(request):\n    # ruleid: open-redirect\n    return redirect(request.method)\nwill only match:\n$ python3 -m semgrep -f tests/equivalence-tests/open-redirect.equiv.yml tests/equivalence-tests/open-redirect.py\ntests/equivalence-tests/open-redirect.py\nrule:tests.equivalence-tests.open-redirect: \n9:    return redirect(request.POST.get(\"next\"))\n14:    return redirect(request.get_host())\n\n1b. Equivalences don't seem to resolve in bigger patterns. For example, doing:\n  - equivalence: request.$W.get(...) <==> request.$W[...]\n  - pattern: |\n      $DATA = request.$W.get(...)\n      ...\n      return redirect(..., $DATA, ...)\nwill not match:\n  url = request[\"url\"]\n  ...\n  return redirect(url)\n1c. Equivalences seem to break some pattern logic. For example:\n- equivalence: django.shortcuts.redirect(...) <==> django.http.HttpResponseRedirect(...)\n- pattern: django.shortcuts.redirect(..., request.$W.get(...), ...)\nand given this file:\nfrom django.http import HttpResponseRedirect\nfrom django.shortcuts import redirect\ndef arg(request):\n    # ruleid: open-redirect\n    return redirect(request.POST.get(\"next\"))\n\ndef argh(request):\n    # ruleid: open-redirect\n    return redirect(request.get_host())\n\ndef fine(request):\n    # ok\n    return HttpResponseRedirect(\"https://google.com\")\n\ndef unsafe2(request):\n    # ruleid: open-redirect\n    url = request.POST.get(\"url\")\n    return HttpResponseRedirect(url)\n\ndef legit(request):\n    # ok\n    return HttpResponseRedirect(request.get_full_path())\nwill match extra locations:\n$ python3 -m semgrep -f tests/equivalence-tests/open-redirect.equiv.yml tests/equivalence-tests/open-redirect.py\ntests/equivalence-tests/open-redirect.py\nrule:tests.equivalence-tests.open-redirect: \n9:    return redirect(request.POST.get(\"next\"))\n44:    return HttpResponseRedirect(\"https://google.com\")\n50:    return HttpResponseRedirect(url)\n55:    return HttpResponseRedirect(request.get_full_path())\n\n\n(semgrep) Because all the patterns get flattened, currently all the equivalences have to be flattened, too. This means we aggregate all the equivalences across all the rules and feed them to semgrep-core. This is fine for smaller rule sets but will no doubt cause issues when equivalences start stomping on each other accidentally...", "createdAt": "2020-04-30T01:38:36Z", "url": "https://github.com/returntocorp/semgrep/pull/619", "merged": true, "mergeCommit": {"oid": "dd6128e69f8119d000e49ca1c21622fd30c8f138"}, "closed": true, "closedAt": "2020-05-01T21:02:43Z", "author": {"login": "minusworld"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcchkbUgH2gAyNDExMDYzOTgzOmUzODExMjFjN2ZkZDBmZGVlMzNiMWU2Mzk1MTFlNzI0NmJhOGVlNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcdH8MRAFqTQwNDM5MTQwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e381121c7fdd0fdee33b1e639511e7246ba8ee77", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/e381121c7fdd0fdee33b1e639511e7246ba8ee77", "committedDate": "2020-04-30T00:02:37Z", "message": "WIP: Work in progress for wiring up equivalences in rule files to semgrep-core.\nThis is DEFINTELY A WORK IN PROGRESS, but it's sufficient enough to get started.\nFuture issues that will need to be worked on:\n1. (semgrep-core) Equivalences don't quite work like I would expect. I sort of thought it would replace the subtree when it found that pattern in parsed code. However, I have been running into the following issues:\n  1a. Only the first equivalence matches. If I specify several equivalences that should resolve to the same thing, only the first one works.\n  1b. Equivalences don't seem to resolve in bigger patterns. For example, doing:\n  '''\n  - equivalence: request.$W.get(...) <==> request.$W[...]\n  - pattern: |\n      $DATA = request.$W.get(...)\n      ...\n      return redirect(..., $DATA, ...)\n  '''\n  will not match:\n  '''\n  url = request[\"url\"]\n  ...\n  return redirect(url)\n  '''\n2. (semgrep) Because all the patterns get flattened, currently all the equivalences have to be flattened, too. This means we aggregate all the equivalences across all the rules and feed them to semgrep-core. This is fine for smaller rule sets but will no doubt cause issues when equivalences start stomping on each other accidentally..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a29db56a194ff43051cf1de3ae5f3aefe54389d", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/2a29db56a194ff43051cf1de3ae5f3aefe54389d", "committedDate": "2020-04-30T01:03:54Z", "message": "Remove stray print statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf2398d5564371b33af5733cdd49acaee8fef5a2", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/cf2398d5564371b33af5733cdd49acaee8fef5a2", "committedDate": "2020-04-30T01:16:23Z", "message": "Added a test for equivalences"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb2f4be622b2e2534f6e52e0bb2fa2a90c74112d", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/eb2f4be622b2e2534f6e52e0bb2fa2a90c74112d", "committedDate": "2020-04-30T21:32:38Z", "message": "Merge branch 'develop' into grh/wire-up-equivalences"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5d195ee72a457df0d70669d551a7b76069c5a4c", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/b5d195ee72a457df0d70669d551a7b76069c5a4c", "committedDate": "2020-04-30T21:46:25Z", "message": "Fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d78f21bf10e98af271b5e10dcab5a5712ac10e8b", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/d78f21bf10e98af271b5e10dcab5a5712ac10e8b", "committedDate": "2020-04-30T21:59:04Z", "message": "Fix expected.txt for equivalence tests, probably due to auto-formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzOTYxMDcw", "url": "https://github.com/returntocorp/semgrep/pull/619#pullrequestreview-403961070", "createdAt": "2020-05-01T00:20:54Z", "commit": {"oid": "d78f21bf10e98af271b5e10dcab5a5712ac10e8b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMDoyMDo1NVrOGO-p3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMDoyMDo1NVrOGO-p3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM1OTc3NA==", "bodyText": "Do we want this to be in a separate file from the config?", "url": "https://github.com/returntocorp/semgrep/pull/619#discussion_r418359774", "createdAt": "2020-05-01T00:20:55Z", "author": {"login": "brendongo"}, "path": "semgrep/semgrep/cli.py", "diffHunk": "@@ -134,6 +134,9 @@ def cli() -> None:\n         help=\"Apply the autofix patches. WARNING: data loss can occur with this flag. Make sure your files are stored in a version control system.\",\n         action=\"store_true\",\n     )\n+    output.add_argument(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78f21bf10e98af271b5e10dcab5a5712ac10e8b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzOTYyMDcy", "url": "https://github.com/returntocorp/semgrep/pull/619#pullrequestreview-403962072", "createdAt": "2020-05-01T00:24:22Z", "commit": {"oid": "d78f21bf10e98af271b5e10dcab5a5712ac10e8b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMDoyNDoyMlrOGO-tQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMDoyNDoyMlrOGO-tQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM2MDY0MA==", "bodyText": "Can we use with context similar to line 143 below? So we dont have to remember to close.", "url": "https://github.com/returntocorp/semgrep/pull/619#discussion_r418360640", "createdAt": "2020-05-01T00:24:22Z", "author": {"login": "brendongo"}, "path": "semgrep/semgrep/core_runner.py", "diffHunk": "@@ -95,6 +118,25 @@ def _run_rules(\n         outputs: List[PatternMatch] = []  # multiple invocations per language\n         errors: List[Any] = []\n \n+        # This will need to be addressed in the future. Since we flatten all the patterns,\n+        # there's no way to tell semgrep which equivalences apply to which rules.\n+        # So, my approach here is a naive implementation which likewise flattens all equivalences...\n+        # Here there be dragons.... :-(\n+        #  .>   )\\;`a__\n+        # (  _ _)/ /-.\" ~~\n+        #  `( )_ )/\n+        #   <_  <_ sb/dwb\n+        equivalences = self._flatten_all_equivalences(rules)\n+        if equivalences:\n+            equiv_fout = tempfile.NamedTemporaryFile(\"w\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78f21bf10e98af271b5e10dcab5a5712ac10e8b"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzOTYyODYx", "url": "https://github.com/returntocorp/semgrep/pull/619#pullrequestreview-403962861", "createdAt": "2020-05-01T00:27:09Z", "commit": {"oid": "d78f21bf10e98af271b5e10dcab5a5712ac10e8b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMDoyNzowOVrOGO-v6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMDoyNzowOVrOGO-v6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM2MTMyMQ==", "bodyText": "Would it make more sense for this to return a list of Equivalence objects?", "url": "https://github.com/returntocorp/semgrep/pull/619#discussion_r418361321", "createdAt": "2020-05-01T00:27:09Z", "author": {"login": "brendongo"}, "path": "semgrep/semgrep/rule.py", "diffHunk": "@@ -129,6 +129,10 @@ def expression(self) -> BooleanRuleExpression:\n     def fix(self) -> Optional[str]:\n         return self._raw.get(\"fix\")\n \n+    @property\n+    def equivalences(self) -> Dict[str, str]:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78f21bf10e98af271b5e10dcab5a5712ac10e8b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "843c00db10daf6014e69bf94d13f901e14761bc5", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/843c00db10daf6014e69bf94d13f901e14761bc5", "committedDate": "2020-05-01T17:24:51Z", "message": "Removed --equivalences command line option, since they are specified in the rule file themselves now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "817a451fc4d486c5f16be5352810d0f6258a98eb", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/817a451fc4d486c5f16be5352810d0f6258a98eb", "committedDate": "2020-05-01T17:45:04Z", "message": "Switching from using open/close pattern for equivalences file to with context. Switched equivalences property in Rule to return List[Equivalence] and moved the logic for transforming the raw data into this list into the Rule class."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MzkxNDA3", "url": "https://github.com/returntocorp/semgrep/pull/619#pullrequestreview-404391407", "createdAt": "2020-05-01T20:44:58Z", "commit": {"oid": "817a451fc4d486c5f16be5352810d0f6258a98eb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1071, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}