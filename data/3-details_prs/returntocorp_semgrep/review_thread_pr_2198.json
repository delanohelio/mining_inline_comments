{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzMjgzNTc2", "number": 2198, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwOTo1NDoyMFrOFBsRjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwOTo1NDoyMFrOFBsRjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MzE4Mjg3OnYy", "diffSide": "RIGHT", "path": "spacegrep/src/bin/Spacegrep_main.ml", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwOTo1NDoyMFrOIAeizg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDo0Nzo0MlrOIA6AxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM3MTM0Mg==", "bodyText": "Shoudn't this be put later when you know you're not in the Minified or Binary case? Otherwise\nit defeats the purpose of the optimization no? Looks like you gonna read the whole doc in every paths,\nwhatever the result of the classify on the peek_length read doc.", "url": "https://github.com/returntocorp/semgrep/pull/2198#discussion_r537371342", "createdAt": "2020-12-07T09:54:20Z", "author": {"login": "aryx"}, "path": "spacegrep/src/bin/Spacegrep_main.ml", "diffHunk": "@@ -43,9 +43,22 @@ let run_all\n     ~case_sensitive ~debug ~force ~output_format ~highlight ~warn\n     patterns docs =\n   let matches =\n-    List.map (fun get_doc_src ->\n-      let doc_src = get_doc_src () in\n-      let doc_type = File_type.classify doc_src in\n+    List.filter_map (fun (get_doc_src : ?max_len:int -> unit -> Src_file.t) ->\n+      (*\n+         We inspect the first 4096 bytes to guess whether the file type.\n+         This saves time on large files, by reading typically just one\n+         block from the file system.\n+      *)\n+      let peek_length = 4096 in\n+      let partial_doc_src = get_doc_src ~max_len:peek_length () in\n+      let doc_type = File_type.classify partial_doc_src in\n+      let doc_src =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d563a4d6e9d5e456570d3c88b2363ae634f87929"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcyMzA0OA==", "bodyText": "oh, I really rushed this. Thanks for taking a look.", "url": "https://github.com/returntocorp/semgrep/pull/2198#discussion_r537723048", "createdAt": "2020-12-07T18:16:14Z", "author": {"login": "mjambon"}, "path": "spacegrep/src/bin/Spacegrep_main.ml", "diffHunk": "@@ -43,9 +43,22 @@ let run_all\n     ~case_sensitive ~debug ~force ~output_format ~highlight ~warn\n     patterns docs =\n   let matches =\n-    List.map (fun get_doc_src ->\n-      let doc_src = get_doc_src () in\n-      let doc_type = File_type.classify doc_src in\n+    List.filter_map (fun (get_doc_src : ?max_len:int -> unit -> Src_file.t) ->\n+      (*\n+         We inspect the first 4096 bytes to guess whether the file type.\n+         This saves time on large files, by reading typically just one\n+         block from the file system.\n+      *)\n+      let peek_length = 4096 in\n+      let partial_doc_src = get_doc_src ~max_len:peek_length () in\n+      let doc_type = File_type.classify partial_doc_src in\n+      let doc_src =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM3MTM0Mg=="}, "originalCommit": {"oid": "d563a4d6e9d5e456570d3c88b2363ae634f87929"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzczNjg0Ng==", "bodyText": "weird that you got better performance ... it should have been the same amount of time than before.", "url": "https://github.com/returntocorp/semgrep/pull/2198#discussion_r537736846", "createdAt": "2020-12-07T18:37:32Z", "author": {"login": "aryx"}, "path": "spacegrep/src/bin/Spacegrep_main.ml", "diffHunk": "@@ -43,9 +43,22 @@ let run_all\n     ~case_sensitive ~debug ~force ~output_format ~highlight ~warn\n     patterns docs =\n   let matches =\n-    List.map (fun get_doc_src ->\n-      let doc_src = get_doc_src () in\n-      let doc_type = File_type.classify doc_src in\n+    List.filter_map (fun (get_doc_src : ?max_len:int -> unit -> Src_file.t) ->\n+      (*\n+         We inspect the first 4096 bytes to guess whether the file type.\n+         This saves time on large files, by reading typically just one\n+         block from the file system.\n+      *)\n+      let peek_length = 4096 in\n+      let partial_doc_src = get_doc_src ~max_len:peek_length () in\n+      let doc_type = File_type.classify partial_doc_src in\n+      let doc_src =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM3MTM0Mg=="}, "originalCommit": {"oid": "d563a4d6e9d5e456570d3c88b2363ae634f87929"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgyMTM4MQ==", "bodyText": "I fixed this, which seems to improves the performance overall and on a single big binary file, but otherwise it's slower on a repo with mostly small source files. I don't understand why. I'll try to get to the bottom of this before merging. I might also postpone this task since it's fun but not urgent.", "url": "https://github.com/returntocorp/semgrep/pull/2198#discussion_r537821381", "createdAt": "2020-12-07T20:47:42Z", "author": {"login": "mjambon"}, "path": "spacegrep/src/bin/Spacegrep_main.ml", "diffHunk": "@@ -43,9 +43,22 @@ let run_all\n     ~case_sensitive ~debug ~force ~output_format ~highlight ~warn\n     patterns docs =\n   let matches =\n-    List.map (fun get_doc_src ->\n-      let doc_src = get_doc_src () in\n-      let doc_type = File_type.classify doc_src in\n+    List.filter_map (fun (get_doc_src : ?max_len:int -> unit -> Src_file.t) ->\n+      (*\n+         We inspect the first 4096 bytes to guess whether the file type.\n+         This saves time on large files, by reading typically just one\n+         block from the file system.\n+      *)\n+      let peek_length = 4096 in\n+      let partial_doc_src = get_doc_src ~max_len:peek_length () in\n+      let doc_type = File_type.classify partial_doc_src in\n+      let doc_src =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM3MTM0Mg=="}, "originalCommit": {"oid": "d563a4d6e9d5e456570d3c88b2363ae634f87929"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4697, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}