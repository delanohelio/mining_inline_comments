{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNzIzMTI2", "number": 1150, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxNzo1NFrOEJOVew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNzoxOTozNlrOEKMzEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA3NTE1OnYy", "diffSide": "LEFT", "path": ".bento/config.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxNzo1NFrOGpqaIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxNzo1NFrOGpqaIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzOTYxNw==", "bodyText": "semgrep-rules now includes Dlint \ud83d\udc4d", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r446339617", "createdAt": "2020-06-26T18:17:54Z", "author": {"login": "mschwager"}, "path": ".bento/config.yml", "diffHunk": "@@ -29,20 +29,7 @@ tools:\n     - try-except-continue\n     - urllib-urlopen\n     run: true\n-  dlint:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47901f692c1d21d222927d1f9de658abdeb5c02b"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA3NzAxOnYy", "diffSide": "LEFT", "path": ".bento/config.yml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxODozN1rOGpqbXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxODozN1rOGpqbXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzOTkzNQ==", "bodyText": "This is running https://r2c.dev/default-r2c-checks, which should be covered by our semgrep-run-r2c-config job.", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r446339935", "createdAt": "2020-06-26T18:18:37Z", "author": {"login": "mschwager"}, "path": ".bento/config.yml", "diffHunk": "@@ -29,20 +29,7 @@ tools:\n     - try-except-continue\n     - urllib-urlopen\n     run: true\n-  dlint:\n-    ignore: []\n-    run: true\n   flake8:\n     ignore:\n     - bare-except-bugbear\n     run: true\n-  r2c.registry.latest:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47901f692c1d21d222927d1f9de658abdeb5c02b"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA3ODIxOnYy", "diffSide": "LEFT", "path": ".bento/config.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxOTowMVrOGpqcIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxOTowMVrOGpqcIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MDEzMA==", "bodyText": "Talked with @minusworld and semgrep-rules should cover this now.", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r446340130", "createdAt": "2020-06-26T18:19:01Z", "author": {"login": "mschwager"}, "path": ".bento/config.yml", "diffHunk": "@@ -29,20 +29,7 @@ tools:\n     - try-except-continue\n     - urllib-urlopen\n     run: true\n-  dlint:\n-    ignore: []\n-    run: true\n   flake8:\n     ignore:\n     - bare-except-bugbear\n     run: true\n-  r2c.registry.latest:\n-    ignore: []\n-    run: true\n-  r2c.requests:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47901f692c1d21d222927d1f9de658abdeb5c02b"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA3ODg3OnYy", "diffSide": "LEFT", "path": ".bento/config.yml", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxOToxNlrOGpqchQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDozMDo0N1rOGq_PAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MDIyOQ==", "bodyText": "Covered by semgrep-run-r2c-config.", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r446340229", "createdAt": "2020-06-26T18:19:16Z", "author": {"login": "mschwager"}, "path": ".bento/config.yml", "diffHunk": "@@ -29,20 +29,7 @@ tools:\n     - try-except-continue\n     - urllib-urlopen\n     run: true\n-  dlint:\n-    ignore: []\n-    run: true\n   flake8:\n     ignore:\n     - bare-except-bugbear\n     run: true\n-  r2c.registry.latest:\n-    ignore: []\n-    run: true\n-  r2c.requests:\n-    ignore:\n-    - use-timeout\n-    run: true\n-  semgrep:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47901f692c1d21d222927d1f9de658abdeb5c02b"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM1MDI3MQ==", "bodyText": "This does let semgrep run automatically as a pre-commit hook. Should we add semgrep to .pre-commit.yaml first?", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r446350271", "createdAt": "2020-06-26T18:42:00Z", "author": {"login": "brendongo"}, "path": ".bento/config.yml", "diffHunk": "@@ -29,20 +29,7 @@ tools:\n     - try-except-continue\n     - urllib-urlopen\n     run: true\n-  dlint:\n-    ignore: []\n-    run: true\n   flake8:\n     ignore:\n     - bare-except-bugbear\n     run: true\n-  r2c.registry.latest:\n-    ignore: []\n-    run: true\n-  r2c.requests:\n-    ignore:\n-    - use-timeout\n-    run: true\n-  semgrep:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MDIyOQ=="}, "originalCommit": {"oid": "47901f692c1d21d222927d1f9de658abdeb5c02b"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcyOTQwOA==", "bodyText": "Required a bit more work, but I updated the pre-commit configuration as well.", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r447729408", "createdAt": "2020-06-30T14:30:47Z", "author": {"login": "mschwager"}, "path": ".bento/config.yml", "diffHunk": "@@ -29,20 +29,7 @@ tools:\n     - try-except-continue\n     - urllib-urlopen\n     run: true\n-  dlint:\n-    ignore: []\n-    run: true\n   flake8:\n     ignore:\n     - bare-except-bugbear\n     run: true\n-  r2c.registry.latest:\n-    ignore: []\n-    run: true\n-  r2c.requests:\n-    ignore:\n-    - use-timeout\n-    run: true\n-  semgrep:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MDIyOQ=="}, "originalCommit": {"oid": "47901f692c1d21d222927d1f9de658abdeb5c02b"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MDUzNDQ0OnYy", "diffSide": "RIGHT", "path": ".pre-commit-config.yaml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDozMjowMVrOGq_S3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDozMjowMVrOGq_S3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczMDM5OA==", "bodyText": "Trying this with something like /p/r2c was really slow and produced lots of parse errors. Using /p/python and --include *.py sped things up.", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r447730398", "createdAt": "2020-06-30T14:32:01Z", "author": {"login": "mschwager"}, "path": ".pre-commit-config.yaml", "diffHunk": "@@ -39,6 +39,18 @@ repos:\n       - id: flake8\n         args: [\"--select=E9,F63,F7,F82\"]\n \n+  - repo: https://github.com/returntocorp/semgrep\n+    rev: 'v0.12.0'\n+    hooks:\n+      - id: semgrep\n+        args: ['--config', 'https://semgrep.live/p/python', '--include', '*.py', '--precommit', '--error']", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ddf9b9798bebd98f02233ea4090f322982a648f"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MDU0MzkxOnYy", "diffSide": "LEFT", "path": "Dockerfile", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDozMzo1MVrOGq_YrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDozMzo1MVrOGq_YrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczMTg4NQ==", "bodyText": "A lot of this is no longer necessary now that we're not burning the commit hash into the package build/install. I.e. the .git directory is no longer necessary, and we can greatly simplify the install process (a simple pip install should do the trick).", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r447731885", "createdAt": "2020-06-30T14:33:51Z", "author": {"login": "mschwager"}, "path": "Dockerfile", "diffHunk": "@@ -1,52 +1,39 @@\n-## semgrep build\n-\n-FROM python:3.7.7-alpine3.11 as build-semgrep", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ddf9b9798bebd98f02233ea4090f322982a648f"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MDU2MjUyOnYy", "diffSide": "LEFT", "path": "Dockerfile", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDozNzo1M1rOGq_kfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDozNzo1M1rOGq_kfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczNDkwOQ==", "bodyText": "COPYing everything in significantly slows down the build process because the Docker context is huge. I.e. if anything changes in the working directory we have to rebuild semgrep-core from scratch, which takes a long time. Now we only rebuild if anything in .git, pfff, semgrep-core, or .gitmodules changes, which helpfully avoids the rebuild if semgrep/ changes.", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r447734909", "createdAt": "2020-06-30T14:37:53Z", "author": {"login": "mschwager"}, "path": "Dockerfile", "diffHunk": "@@ -1,52 +1,39 @@\n-## semgrep build\n-\n-FROM python:3.7.7-alpine3.11 as build-semgrep\n-RUN apk add --no-cache git\n-COPY .git /home/pythonbuild/.git\n-COPY semgrep /home/pythonbuild/semgrep/\n-WORKDIR /home/pythonbuild/semgrep\n-# downgrade to 20.1 since 20.1.1 reverts building in place\n-# https://github.com/pypa/pip/issues/7555\n-RUN pip install pip==20.1\n-RUN HOMEBREW_SYSTEM='NOCORE' pip install --user .\n-RUN /root/.local/bin/semgrep --version\n-\n-## semgrep-core build\n+# semgrep-core build\n \n FROM ocaml/opam2:alpine@sha256:4c2ce9a181b4b12442a68fc221d0b753959ec80e24eae3bf788eeca4dcb9a293 as build-semgrep-core\n+\n USER root\n RUN apk add --no-cache perl m4\n-\n USER opam\n \n WORKDIR /home/opam/opam-repository\n RUN git pull && opam update && opam switch create 4.10.0+musl+static+flambda\n \n-COPY --chown=opam . /home/opam/semgrep/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ddf9b9798bebd98f02233ea4090f322982a648f"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MDU2ODgyOnYy", "diffSide": "RIGHT", "path": "Dockerfile", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDozOTowMVrOGq_oQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDozOTowMVrOGq_oQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczNTg3NQ==", "bodyText": "HOMEBREW_SYSTEM='NOCORE' is now a misnomer referencing an env variable used in setup.py, but we can change that in a separate PR.", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r447735875", "createdAt": "2020-06-30T14:39:01Z", "author": {"login": "mschwager"}, "path": "Dockerfile", "diffHunk": "@@ -1,52 +1,39 @@\n-## semgrep build\n-\n-FROM python:3.7.7-alpine3.11 as build-semgrep\n-RUN apk add --no-cache git\n-COPY .git /home/pythonbuild/.git\n-COPY semgrep /home/pythonbuild/semgrep/\n-WORKDIR /home/pythonbuild/semgrep\n-# downgrade to 20.1 since 20.1.1 reverts building in place\n-# https://github.com/pypa/pip/issues/7555\n-RUN pip install pip==20.1\n-RUN HOMEBREW_SYSTEM='NOCORE' pip install --user .\n-RUN /root/.local/bin/semgrep --version\n-\n-## semgrep-core build\n+# semgrep-core build\n \n FROM ocaml/opam2:alpine@sha256:4c2ce9a181b4b12442a68fc221d0b753959ec80e24eae3bf788eeca4dcb9a293 as build-semgrep-core\n+\n USER root\n RUN apk add --no-cache perl m4\n-\n USER opam\n \n WORKDIR /home/opam/opam-repository\n RUN git pull && opam update && opam switch create 4.10.0+musl+static+flambda\n \n-COPY --chown=opam . /home/opam/semgrep/\n-WORKDIR /home/opam/semgrep\n+COPY --chown=opam .gitmodules /semgrep/.gitmodules\n+COPY --chown=opam .git/ /semgrep/.git/\n+COPY --chown=opam pfff/ /semgrep/pfff/\n+COPY --chown=opam semgrep-core/ /semgrep/semgrep-core/\n \n+WORKDIR /semgrep\n RUN git submodule update --init --recursive\n-RUN eval \"$(opam env)\" && opam install -y ./pfff\n-WORKDIR /home/opam/semgrep/semgrep-core\n-RUN eval \"$(opam env)\" && opam install --deps-only -y . && make all\n-RUN _build/default/bin/Main.exe -version\n+RUN eval \"$(opam env)\" && opam install -y pfff/\n+RUN eval \"$(opam env)\" && opam install --deps-only -y semgrep-core/ && make -C semgrep-core/ all\n \n-\n-## final output, combining both\n+# final output\n \n FROM python:3.7.7-alpine3.11\n LABEL maintainer=\"support@r2c.dev\"\n \n-ENV PYTHONUNBUFFERED=1\n-\n-COPY --from=build-semgrep /root/.local /root/.local\n-# Make sure scripts in .local are usable:\n-ENV PATH=/root/.local/bin:$PATH\n+COPY --from=build-semgrep-core /semgrep/semgrep-core/_build/default/bin/Main.exe /bin/semgrep-core\n+RUN semgrep-core -version\n \n-RUN semgrep --help\n-COPY --from=build-semgrep-core /home/opam/semgrep/semgrep-core/_build/default/bin/Main.exe /bin/semgrep-core\n-RUN semgrep-core --help\n+COPY semgrep /semgrep\n+RUN HOMEBREW_SYSTEM='NOCORE' python -m pip install /semgrep", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ddf9b9798bebd98f02233ea4090f322982a648f"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MDU3NDEwOnYy", "diffSide": "RIGHT", "path": "Dockerfile", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDozOTo1NVrOGq_rPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDozOTo1NVrOGq_rPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczNjYzNw==", "bodyText": "If no args are passed to docker run print the --help.", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r447736637", "createdAt": "2020-06-30T14:39:55Z", "author": {"login": "mschwager"}, "path": "Dockerfile", "diffHunk": "@@ -1,52 +1,39 @@\n-## semgrep build\n-\n-FROM python:3.7.7-alpine3.11 as build-semgrep\n-RUN apk add --no-cache git\n-COPY .git /home/pythonbuild/.git\n-COPY semgrep /home/pythonbuild/semgrep/\n-WORKDIR /home/pythonbuild/semgrep\n-# downgrade to 20.1 since 20.1.1 reverts building in place\n-# https://github.com/pypa/pip/issues/7555\n-RUN pip install pip==20.1\n-RUN HOMEBREW_SYSTEM='NOCORE' pip install --user .\n-RUN /root/.local/bin/semgrep --version\n-\n-## semgrep-core build\n+# semgrep-core build\n \n FROM ocaml/opam2:alpine@sha256:4c2ce9a181b4b12442a68fc221d0b753959ec80e24eae3bf788eeca4dcb9a293 as build-semgrep-core\n+\n USER root\n RUN apk add --no-cache perl m4\n-\n USER opam\n \n WORKDIR /home/opam/opam-repository\n RUN git pull && opam update && opam switch create 4.10.0+musl+static+flambda\n \n-COPY --chown=opam . /home/opam/semgrep/\n-WORKDIR /home/opam/semgrep\n+COPY --chown=opam .gitmodules /semgrep/.gitmodules\n+COPY --chown=opam .git/ /semgrep/.git/\n+COPY --chown=opam pfff/ /semgrep/pfff/\n+COPY --chown=opam semgrep-core/ /semgrep/semgrep-core/\n \n+WORKDIR /semgrep\n RUN git submodule update --init --recursive\n-RUN eval \"$(opam env)\" && opam install -y ./pfff\n-WORKDIR /home/opam/semgrep/semgrep-core\n-RUN eval \"$(opam env)\" && opam install --deps-only -y . && make all\n-RUN _build/default/bin/Main.exe -version\n+RUN eval \"$(opam env)\" && opam install -y pfff/\n+RUN eval \"$(opam env)\" && opam install --deps-only -y semgrep-core/ && make -C semgrep-core/ all\n \n-\n-## final output, combining both\n+# final output\n \n FROM python:3.7.7-alpine3.11\n LABEL maintainer=\"support@r2c.dev\"\n \n-ENV PYTHONUNBUFFERED=1\n-\n-COPY --from=build-semgrep /root/.local /root/.local\n-# Make sure scripts in .local are usable:\n-ENV PATH=/root/.local/bin:$PATH\n+COPY --from=build-semgrep-core /semgrep/semgrep-core/_build/default/bin/Main.exe /bin/semgrep-core\n+RUN semgrep-core -version\n \n-RUN semgrep --help\n-COPY --from=build-semgrep-core /home/opam/semgrep/semgrep-core/_build/default/bin/Main.exe /bin/semgrep-core\n-RUN semgrep-core --help\n+COPY semgrep /semgrep\n+RUN HOMEBREW_SYSTEM='NOCORE' python -m pip install /semgrep\n+RUN semgrep --version\n \n ENV SEMGREP_IN_DOCKER=1\n+ENV SEMGREP_VERSION_CACHE_PATH=/tmp/.cache/semgrep_version\n ENV PYTHONIOENCODING=utf8\n-ENTRYPOINT [ \"/root/.local/bin/semgrep\" ]\n+ENV PYTHONUNBUFFERED=1\n+ENTRYPOINT [\"semgrep\"]\n+CMD [\"--help\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ddf9b9798bebd98f02233ea4090f322982a648f"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MDU4MDk1OnYy", "diffSide": "RIGHT", "path": "semgrep/semgrep/config_resolver.py", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDo0MTowOVrOGq_vVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDo0MTowOVrOGq_vVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczNzY4Nw==", "bodyText": "Here was the big blocker that was breaking pre-commit - it mounts the code at /src/. We can re-purpose the --precommit flag to handle this case.", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r447737687", "createdAt": "2020-06-30T14:41:09Z", "author": {"login": "mschwager"}, "path": "semgrep/semgrep/config_resolver.py", "diffHunk": "@@ -27,6 +27,7 @@\n IN_DOCKER = \"SEMGREP_IN_DOCKER\" in os.environ\n IN_GH_ACTION = \"GITHUB_WORKSPACE\" in os.environ\n REPO_HOME_DOCKER = \"/home/repo/\"\n+REPO_HOME_DOCKER_PRECOMMIT = \"/src/\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ddf9b9798bebd98f02233ea4090f322982a648f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MDU4Nzc0OnYy", "diffSide": "RIGHT", "path": "semgrep/semgrep/output.py", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDo0MjozNVrOGq_zgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDo0MjozNVrOGq_zgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczODc1Mw==", "bodyText": "The --error flag wasn't doing anything prior to this. It's functionality got lost somewhere along the line in a refactor.", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r447738753", "createdAt": "2020-06-30T14:42:35Z", "author": {"login": "mschwager"}, "path": "semgrep/semgrep/output.py", "diffHunk": "@@ -305,6 +306,10 @@ def close(self) -> None:\n \n         if self.final_error:\n             raise self.final_error\n+        elif self.rule_matches and self.settings.error_on_findings:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ddf9b9798bebd98f02233ea4090f322982a648f"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MDY0MDAzOnYy", "diffSide": "LEFT", "path": "Dockerfile", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDo1Mjo1OVrOGrATnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDo1Mjo1OVrOGrATnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc0Njk3NQ==", "bodyText": "This was another issue with running semgrep via pre-commit. pre-commit runs Docker containers with the UID and GID of the host user. This was breaking this entrypoint because an unprivileged user was trying to run something from /root/.... Now that we simply pip install semgrep we can access the script as an unprivileged user \ud83d\udc4d", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r447746975", "createdAt": "2020-06-30T14:52:59Z", "author": {"login": "mschwager"}, "path": "Dockerfile", "diffHunk": "@@ -1,52 +1,39 @@\n-## semgrep build\n-\n-FROM python:3.7.7-alpine3.11 as build-semgrep\n-RUN apk add --no-cache git\n-COPY .git /home/pythonbuild/.git\n-COPY semgrep /home/pythonbuild/semgrep/\n-WORKDIR /home/pythonbuild/semgrep\n-# downgrade to 20.1 since 20.1.1 reverts building in place\n-# https://github.com/pypa/pip/issues/7555\n-RUN pip install pip==20.1\n-RUN HOMEBREW_SYSTEM='NOCORE' pip install --user .\n-RUN /root/.local/bin/semgrep --version\n-\n-## semgrep-core build\n+# semgrep-core build\n \n FROM ocaml/opam2:alpine@sha256:4c2ce9a181b4b12442a68fc221d0b753959ec80e24eae3bf788eeca4dcb9a293 as build-semgrep-core\n+\n USER root\n RUN apk add --no-cache perl m4\n-\n USER opam\n \n WORKDIR /home/opam/opam-repository\n RUN git pull && opam update && opam switch create 4.10.0+musl+static+flambda\n \n-COPY --chown=opam . /home/opam/semgrep/\n-WORKDIR /home/opam/semgrep\n+COPY --chown=opam .gitmodules /semgrep/.gitmodules\n+COPY --chown=opam .git/ /semgrep/.git/\n+COPY --chown=opam pfff/ /semgrep/pfff/\n+COPY --chown=opam semgrep-core/ /semgrep/semgrep-core/\n \n+WORKDIR /semgrep\n RUN git submodule update --init --recursive\n-RUN eval \"$(opam env)\" && opam install -y ./pfff\n-WORKDIR /home/opam/semgrep/semgrep-core\n-RUN eval \"$(opam env)\" && opam install --deps-only -y . && make all\n-RUN _build/default/bin/Main.exe -version\n+RUN eval \"$(opam env)\" && opam install -y pfff/\n+RUN eval \"$(opam env)\" && opam install --deps-only -y semgrep-core/ && make -C semgrep-core/ all\n \n-\n-## final output, combining both\n+# final output\n \n FROM python:3.7.7-alpine3.11\n LABEL maintainer=\"support@r2c.dev\"\n \n-ENV PYTHONUNBUFFERED=1\n-\n-COPY --from=build-semgrep /root/.local /root/.local\n-# Make sure scripts in .local are usable:\n-ENV PATH=/root/.local/bin:$PATH\n+COPY --from=build-semgrep-core /semgrep/semgrep-core/_build/default/bin/Main.exe /bin/semgrep-core\n+RUN semgrep-core -version\n \n-RUN semgrep --help\n-COPY --from=build-semgrep-core /home/opam/semgrep/semgrep-core/_build/default/bin/Main.exe /bin/semgrep-core\n-RUN semgrep-core --help\n+COPY semgrep /semgrep\n+RUN HOMEBREW_SYSTEM='NOCORE' python -m pip install /semgrep\n+RUN semgrep --version\n \n ENV SEMGREP_IN_DOCKER=1\n+ENV SEMGREP_VERSION_CACHE_PATH=/tmp/.cache/semgrep_version\n ENV PYTHONIOENCODING=utf8\n-ENTRYPOINT [ \"/root/.local/bin/semgrep\" ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3b0604d9df4900fff723a7a64f02d685e49135a"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MTMwODk2OnYy", "diffSide": "LEFT", "path": "Dockerfile", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNzoxOTozNlrOGrGuDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxODowMDo1M1rOGrITng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1MjA0NQ==", "bodyText": "Need to keep this pinned https://github.com/docker-library/python/blob/7dc395a6b9fabce8685009dc385fa98f8a944d5c/3.7/alpine3.11/Dockerfile#L148 base image changed the pip version it uses", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r447852045", "createdAt": "2020-06-30T17:19:36Z", "author": {"login": "brendongo"}, "path": "Dockerfile", "diffHunk": "@@ -1,52 +1,39 @@\n-## semgrep build\n-\n-FROM python:3.7.7-alpine3.11 as build-semgrep\n-RUN apk add --no-cache git\n-COPY .git /home/pythonbuild/.git\n-COPY semgrep /home/pythonbuild/semgrep/\n-WORKDIR /home/pythonbuild/semgrep\n-# downgrade to 20.1 since 20.1.1 reverts building in place\n-# https://github.com/pypa/pip/issues/7555\n-RUN pip install pip==20.1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3b0604d9df4900fff723a7a64f02d685e49135a"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3NzE2NQ==", "bodyText": "No longer needed cause of comment above re: no longer needing .git directory", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r447877165", "createdAt": "2020-06-30T17:59:32Z", "author": {"login": "brendongo"}, "path": "Dockerfile", "diffHunk": "@@ -1,52 +1,39 @@\n-## semgrep build\n-\n-FROM python:3.7.7-alpine3.11 as build-semgrep\n-RUN apk add --no-cache git\n-COPY .git /home/pythonbuild/.git\n-COPY semgrep /home/pythonbuild/semgrep/\n-WORKDIR /home/pythonbuild/semgrep\n-# downgrade to 20.1 since 20.1.1 reverts building in place\n-# https://github.com/pypa/pip/issues/7555\n-RUN pip install pip==20.1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1MjA0NQ=="}, "originalCommit": {"oid": "e3b0604d9df4900fff723a7a64f02d685e49135a"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3ODA0Ng==", "bodyText": "We shouldn't need to pin the version anymore since we're no longer using that functionality to burn in SCM information.", "url": "https://github.com/returntocorp/semgrep/pull/1150#discussion_r447878046", "createdAt": "2020-06-30T18:00:53Z", "author": {"login": "mschwager"}, "path": "Dockerfile", "diffHunk": "@@ -1,52 +1,39 @@\n-## semgrep build\n-\n-FROM python:3.7.7-alpine3.11 as build-semgrep\n-RUN apk add --no-cache git\n-COPY .git /home/pythonbuild/.git\n-COPY semgrep /home/pythonbuild/semgrep/\n-WORKDIR /home/pythonbuild/semgrep\n-# downgrade to 20.1 since 20.1.1 reverts building in place\n-# https://github.com/pypa/pip/issues/7555\n-RUN pip install pip==20.1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1MjA0NQ=="}, "originalCommit": {"oid": "e3b0604d9df4900fff723a7a64f02d685e49135a"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4490, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}