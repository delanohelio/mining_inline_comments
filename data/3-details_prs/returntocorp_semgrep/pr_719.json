{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MTEyNDA5", "number": 719, "title": "Add support for SARIF format with --sarif", "bodyText": "Closes returntocorp/enterprise#140", "createdAt": "2020-05-08T08:19:10Z", "url": "https://github.com/returntocorp/semgrep/pull/719", "merged": true, "mergeCommit": {"oid": "1add524837d029cf874b23e846192e700e0379a8"}, "closed": true, "closedAt": "2020-05-12T19:41:43Z", "author": {"login": "underyx"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfOIxNgFqTQwODA4MTQwNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgpnWkgFqTQxMDM2NDk4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MDgxNDA1", "url": "https://github.com/returntocorp/semgrep/pull/719#pullrequestreview-408081405", "createdAt": "2020-05-08T08:20:52Z", "commit": {"oid": "12f5c31bf846b525920e7c0df2ac3fd295f53881"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODoyMDo1MlrOGSdo0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODoyMDo1MlrOGSdo0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAxMzEzOA==", "bodyText": "This is to satisfy the type hints. Should never happen as we control the output_format value in our code.", "url": "https://github.com/returntocorp/semgrep/pull/719#discussion_r422013138", "createdAt": "2020-05-08T08:20:52Z", "author": {"login": "underyx"}, "path": "semgrep/semgrep/output.py", "diffHunk": "@@ -105,15 +109,48 @@ def build_output_json(rule_matches: List[RuleMatch], semgrep_errors: List[Any])\n     return json.dumps(output_json)\n \n \n+def _sarif_tool_info() -> Dict[str, Any]:\n+    return {\"name\": \"semgrep\", \"semanticVersion\": __VERSION__}\n+\n+\n+def build_sarif_output(\n+    rule_matches: List[RuleMatch], rules: FrozenSet[Rule], semgrep_errors: List[Any]\n+) -> str:\n+    \"\"\"\n+    Format matches in SARIF v2.1.0 formatted JSON.\n+\n+    - written based on https://help.github.com/en/github/finding-security-vulnerabilities-and-errors-in-your-code/about-sarif-support-for-code-scanning\n+    - which links to this schema https://github.com/oasis-tcs/sarif-spec/blob/master/Schemata/sarif-schema-2.1.0.json\n+    - full spec is at https://docs.oasis-open.org/sarif/sarif/v2.1.0/cs01/sarif-v2.1.0-cs01.html\n+    \"\"\"\n+    output_dict = {\n+        \"$schema\": \"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json\",\n+        \"version\": \"2.1.0\",\n+        \"tool\": {\n+            \"driver\": {\n+                **_sarif_tool_info(),\n+                \"rules\": [rule.to_sarif() for rule in rules],\n+            }\n+        },\n+        \"results\": [match.to_sarif() for match in rule_matches],\n+    }\n+    return json.dumps(output_dict)\n+\n+\n def build_output(\n     rule_matches: List[RuleMatch],\n+    rules: FrozenSet[Rule],\n     semgrep_errors: List[Any],\n-    json_format: bool,\n+    output_format: str,\n     color_output: bool,\n ) -> str:\n-    if json_format:\n+    if output_format == \"json\":\n         return build_output_json(rule_matches, semgrep_errors)\n-    else:\n+    elif output_format == \"sarif\":\n+        return build_sarif_output(rule_matches, rules, semgrep_errors)\n+    elif output_format == \"normal\":\n         return \"\\n\".join(\n             build_normal_output(rule_matches, semgrep_errors, color_output)\n         )\n+    else:\n+        raise RuntimeError(f\"Not sure how to format as '{output_format}'\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12f5c31bf846b525920e7c0df2ac3fd295f53881"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MjkzOTE3", "url": "https://github.com/returntocorp/semgrep/pull/719#pullrequestreview-408293917", "createdAt": "2020-05-08T14:49:39Z", "commit": {"oid": "67ddb272585b549e076f232e99d6912f49c1439f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NTgwNDc2", "url": "https://github.com/returntocorp/semgrep/pull/719#pullrequestreview-408580476", "createdAt": "2020-05-08T23:40:03Z", "commit": {"oid": "67ddb272585b549e076f232e99d6912f49c1439f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e41ff742769f0812f7920a1fbc37637fedd56b75", "author": {"user": {"login": "underyx", "name": "Bence Nagy"}}, "url": "https://github.com/returntocorp/semgrep/commit/e41ff742769f0812f7920a1fbc37637fedd56b75", "committedDate": "2020-05-11T12:53:52Z", "message": "Add support for SARIF format with --sarif\n\nCloses https://github.com/returntocorp/enterprise/issues/140"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6e3e8aa661f3e91e2a22b03295ab8dfbeb21353", "author": {"user": {"login": "underyx", "name": "Bence Nagy"}}, "url": "https://github.com/returntocorp/semgrep/commit/c6e3e8aa661f3e91e2a22b03295ab8dfbeb21353", "committedDate": "2020-05-11T12:53:53Z", "message": "test_sarif_output: Make snapshots deterministic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9220e2cf625fe908d809abd3d00d71c0773272b", "author": {"user": {"login": "underyx", "name": "Bence Nagy"}}, "url": "https://github.com/returntocorp/semgrep/commit/e9220e2cf625fe908d809abd3d00d71c0773272b", "committedDate": "2020-05-11T12:53:53Z", "message": "output: Use an enum for format options"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "920032be445aa2bb1d721073f26a042484d891d2", "author": {"user": {"login": "underyx", "name": "Bence Nagy"}}, "url": "https://github.com/returntocorp/semgrep/commit/920032be445aa2bb1d721073f26a042484d891d2", "committedDate": "2020-05-11T12:53:53Z", "message": "fixup! Add support for SARIF format with --sarif"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "beeea09adfe3d1c93182bb9d967536e3b0655fd6", "author": {"user": {"login": "underyx", "name": "Bence Nagy"}}, "url": "https://github.com/returntocorp/semgrep/commit/beeea09adfe3d1c93182bb9d967536e3b0655fd6", "committedDate": "2020-05-11T12:57:19Z", "message": "CHANGELOG: Add SARIF entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99b111927cc4a0b17134b7c88744206c0c8b429f", "author": {"user": {"login": "underyx", "name": "Bence Nagy"}}, "url": "https://github.com/returntocorp/semgrep/commit/99b111927cc4a0b17134b7c88744206c0c8b429f", "committedDate": "2020-05-11T13:07:50Z", "message": "output.md: Document SARIF format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c683140739e54d0c190f67b6e652f46d8e9605e", "author": {"user": {"login": "underyx", "name": "Bence Nagy"}}, "url": "https://github.com/returntocorp/semgrep/commit/1c683140739e54d0c190f67b6e652f46d8e9605e", "committedDate": "2020-05-11T13:09:00Z", "message": "output.md: Reformat JSON examples"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c7ff99ac832da2bd0ab53d679fe3cf337601aef", "author": {"user": {"login": "underyx", "name": "Bence Nagy"}}, "url": "https://github.com/returntocorp/semgrep/commit/5c7ff99ac832da2bd0ab53d679fe3cf337601aef", "committedDate": "2020-05-11T13:15:52Z", "message": "README: Add note on output options"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67ddb272585b549e076f232e99d6912f49c1439f", "author": {"user": {"login": "underyx", "name": "Bence Nagy"}}, "url": "https://github.com/returntocorp/semgrep/commit/67ddb272585b549e076f232e99d6912f49c1439f", "committedDate": "2020-05-08T09:05:15Z", "message": "fixup! Add support for SARIF format with --sarif"}, "afterCommit": {"oid": "5c7ff99ac832da2bd0ab53d679fe3cf337601aef", "author": {"user": {"login": "underyx", "name": "Bence Nagy"}}, "url": "https://github.com/returntocorp/semgrep/commit/5c7ff99ac832da2bd0ab53d679fe3cf337601aef", "committedDate": "2020-05-11T13:15:52Z", "message": "README: Add note on output options"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMzY0OTg0", "url": "https://github.com/returntocorp/semgrep/pull/719#pullrequestreview-410364984", "createdAt": "2020-05-12T19:40:45Z", "commit": {"oid": "5c7ff99ac832da2bd0ab53d679fe3cf337601aef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 973, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}