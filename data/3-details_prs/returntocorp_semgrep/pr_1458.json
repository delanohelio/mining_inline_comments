{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzNjQ4NzM3", "number": 1458, "title": "timeout threshold flag", "bodyText": "Set max-timeouts to 3 for now, but open to suggestions on that (and everything else, including the flag name).", "createdAt": "2020-08-05T21:20:11Z", "url": "https://github.com/returntocorp/semgrep/pull/1458", "merged": true, "mergeCommit": {"oid": "0314f0cd6424c63be787dcedc82a2bfae52cde35"}, "closed": true, "closedAt": "2020-08-11T14:12:23Z", "author": {"login": "sabrinabrogren"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8B5MjgH2gAyNDYzNjQ4NzM3OmY2ZjhmNjQyMGYxNWZjM2VhOThjNjhkMzA4MjdmMGVlYTE1ZWNiMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9oJoTgFqTQ2NDU2MDMxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f6f8f6420f15fc3ea98c68d30827f0eea15ecb04", "author": {"user": {"login": "sabrinabrogren", "name": "Sabrina Brogren"}}, "url": "https://github.com/returntocorp/semgrep/commit/f6f8f6420f15fc3ea98c68d30827f0eea15ecb04", "committedDate": "2020-08-05T21:13:55Z", "message": "added flag and tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMDM2Njc2", "url": "https://github.com/returntocorp/semgrep/pull/1458#pullrequestreview-462036676", "createdAt": "2020-08-05T21:27:48Z", "commit": {"oid": "f6f8f6420f15fc3ea98c68d30827f0eea15ecb04"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMToyNzo0OFrOG8bQsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMToyNzo0OFrOG8bQsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAxNDM4Nw==", "bodyText": "Probably worth adding a test that has max-timeouts > 1 and checking that it doesn't stop running rules until it hits max-timeouts. Can probably just create another rule file that duplicates the rule in long.yaml a bunch of times.", "url": "https://github.com/returntocorp/semgrep/pull/1458#discussion_r466014387", "createdAt": "2020-08-05T21:27:48Z", "author": {"login": "brendongo"}, "path": "semgrep/tests/e2e/test_check.py", "diffHunk": "@@ -209,3 +209,29 @@ def test_max_memory(run_semgrep_in_tmp, snapshot):\n         ),\n         \"error.txt\",\n     )\n+\n+\n+def test_max_timeouts(run_semgrep_in_tmp, snapshot):\n+    # Check that semgrep-core timeouts are properly handled\n+\n+    snapshot.assert_match(\n+        run_semgrep_in_tmp(\n+            \"rules/long.yaml\",\n+            options=[\"--timeout\", \"1\", \"--max-timeouts\", \"1\"],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6f8f6420f15fc3ea98c68d30827f0eea15ecb04"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71cf9858c0a8c9db983c5d9b7e788c89f57cde58", "author": {"user": {"login": "sabrinabrogren", "name": "Sabrina Brogren"}}, "url": "https://github.com/returntocorp/semgrep/commit/71cf9858c0a8c9db983c5d9b7e788c89f57cde58", "committedDate": "2020-08-07T16:20:58Z", "message": "More tests and changing flag name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e087afeaeabec2c3305fc145ec1bbc7e53f7c2a5", "author": {"user": {"login": "sabrinabrogren", "name": "Sabrina Brogren"}}, "url": "https://github.com/returntocorp/semgrep/commit/e087afeaeabec2c3305fc145ec1bbc7e53f7c2a5", "committedDate": "2020-08-07T21:15:36Z", "message": "renamed flag, default now 0, print helpful hint message if there are many timeouts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MzYwNzQ1", "url": "https://github.com/returntocorp/semgrep/pull/1458#pullrequestreview-464360745", "createdAt": "2020-08-10T15:53:45Z", "commit": {"oid": "e087afeaeabec2c3305fc145ec1bbc7e53f7c2a5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNTo1Mzo0NVrOG-U9Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNTo1NzowN1rOG-VFxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAwODE5NA==", "bodyText": "We can be slightly more defensive here by using >=, which could prevent an infinite loop in the future.", "url": "https://github.com/returntocorp/semgrep/pull/1458#discussion_r468008194", "createdAt": "2020-08-10T15:53:45Z", "author": {"login": "mschwager"}, "path": "semgrep/semgrep/core_runner.py", "diffHunk": "@@ -441,11 +457,19 @@ def _run_rules(\n             ):\n                 debug_tqdm_write(f\"Running rule {rule._raw.get('id')}\")\n                 rule_matches, debugging_steps, errors = self._run_rule(\n-                    rule, target_manager, semgrep_core_ast_cache_dir\n+                    rule, target_manager, semgrep_core_ast_cache_dir, max_timeout_files\n                 )\n                 findings_by_rule[rule] = rule_matches\n                 debugging_steps_by_rule[rule] = debugging_steps\n                 all_errors.extend(errors)\n+                for err in errors:\n+                    if isinstance(err, MatchTimeoutError):\n+                        file_timeouts[err.path] += 1\n+                        if (\n+                            self._timeout_threshold != 0\n+                            and file_timeouts[err.path] == self._timeout_threshold", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e087afeaeabec2c3305fc145ec1bbc7e53f7c2a5"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAxMDQzNg==", "bodyText": "Do we typically use with_color with our loggers? I see it's only currently used in semgrep/error.py and not in any logger calls. I'll defer to @brendongo here.", "url": "https://github.com/returntocorp/semgrep/pull/1458#discussion_r468010436", "createdAt": "2020-08-10T15:57:07Z", "author": {"login": "mschwager"}, "path": "semgrep/semgrep/output.py", "diffHunk": "@@ -243,9 +245,24 @@ def handle_semgrep_errors(self, errors: List[SemgrepError]) -> None:\n     def handle_semgrep_timeout_errors(self, errors: Dict[Path, List[str]]) -> None:\n         self.has_output = True\n         separator = \", \"\n+        print_threshold_hint = False\n         for path in errors.keys():\n+            num_errs = len(errors[path])\n+            errors[path].sort()\n+            error_msg = f\"Warning: {num_errs} timeout error(s) in {path} when running the following rules: [{separator.join(errors[path])}]\"\n+            if num_errs == self.settings.timeout_threshold:\n+                error_msg += f\"\\nSemgrep stopped running rules on {path} after {num_errs} timeout error(s). See `--timeout-threshold` for more info.\"\n+            print_threshold_hint = print_threshold_hint or (\n+                num_errs > 5 and not self.settings.timeout_threshold\n+            )\n+            logger.error(with_color(colorama.Fore.RED, error_msg))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e087afeaeabec2c3305fc145ec1bbc7e53f7c2a5"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "813248594c48afadfa3be14e909a9f461463afeb", "author": {"user": {"login": "sabrinabrogren", "name": "Sabrina Brogren"}}, "url": "https://github.com/returntocorp/semgrep/commit/813248594c48afadfa3be14e909a9f461463afeb", "committedDate": "2020-08-10T16:21:43Z", "message": "small fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NTYwMzEz", "url": "https://github.com/returntocorp/semgrep/pull/1458#pullrequestreview-464560313", "createdAt": "2020-08-10T20:22:11Z", "commit": {"oid": "813248594c48afadfa3be14e909a9f461463afeb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1287, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}