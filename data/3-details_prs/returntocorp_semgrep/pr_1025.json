{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0OTIyMDM3", "number": 1025, "title": "Add capability to use regexes in autofix.", "bodyText": "Supports returntocorp/semgrep-rules#596.\nThis PR introduces the ability to use a regular expression as your autofix using a sed-like syntax. For example:\ns/DefaultHttpClient/SystemDefaultHttpClient/\n\nThis will only apply the regex replace on the matched lines returned by the rule. Currently, columns are ignored.", "createdAt": "2020-06-16T01:41:09Z", "url": "https://github.com/returntocorp/semgrep/pull/1025", "merged": true, "mergeCommit": {"oid": "82ef60e4b968e235399008eb0730b51bf09211ed"}, "closed": true, "closedAt": "2020-06-18T20:52:40Z", "author": {"login": "minusworld"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcr5fY7AFqTQzMTc4MDMxMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcskvWVgFqTQzMzYzNDkwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzgwMzEw", "url": "https://github.com/returntocorp/semgrep/pull/1025#pullrequestreview-431780310", "createdAt": "2020-06-16T18:23:42Z", "commit": {"oid": "bad4009445361b33055a9c74f9b75ed09051af78"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODoyMzo0MlrOGkn53Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODoyMzo0MlrOGkn53Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1NTcwOQ==", "bodyText": "Double raise", "url": "https://github.com/returntocorp/semgrep/pull/1025#discussion_r441055709", "createdAt": "2020-06-16T18:23:42Z", "author": {"login": "brendongo"}, "path": "semgrep/semgrep/autofix.py", "diffHunk": "@@ -45,8 +95,18 @@ def apply_fixes(rule_matches_by_rule: Dict[Rule, List[RuleMatch]]) -> None:\n     for _, rule_matches in rule_matches_by_rule.items():\n         for rule_match in rule_matches:\n             fix = rule_match.fix\n-            if fix:\n-                filepath = rule_match.path\n+            filepath = rule_match.path\n+            if fix and fix.startswith(\"s/\"):  # Regex-style fix\n+                try:\n+                    from_str, to_str = _parse_regex_fix(fix)\n+                    _regex_replace(rule_match, from_str, to_str)\n+                    modified_files.add(filepath)\n+                except Exception as e:\n+                    raise e", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bad4009445361b33055a9c74f9b75ed09051af78"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzgwNzQx", "url": "https://github.com/returntocorp/semgrep/pull/1025#pullrequestreview-431780741", "createdAt": "2020-06-16T18:24:16Z", "commit": {"oid": "bad4009445361b33055a9c74f9b75ed09051af78"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODoyNDoxNlrOGkn7Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODoyNDoxNlrOGkn7Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1NjA0Ng==", "bodyText": "Might be useful to print out fix string", "url": "https://github.com/returntocorp/semgrep/pull/1025#discussion_r441056046", "createdAt": "2020-06-16T18:24:16Z", "author": {"login": "brendongo"}, "path": "semgrep/semgrep/autofix.py", "diffHunk": "@@ -45,8 +95,18 @@ def apply_fixes(rule_matches_by_rule: Dict[Rule, List[RuleMatch]]) -> None:\n     for _, rule_matches in rule_matches_by_rule.items():\n         for rule_match in rule_matches:\n             fix = rule_match.fix\n-            if fix:\n-                filepath = rule_match.path\n+            filepath = rule_match.path\n+            if fix and fix.startswith(\"s/\"):  # Regex-style fix\n+                try:\n+                    from_str, to_str = _parse_regex_fix(fix)\n+                    _regex_replace(rule_match, from_str, to_str)\n+                    modified_files.add(filepath)\n+                except Exception as e:\n+                    raise e\n+                    raise SemgrepError(\n+                        f\"unable to use regex to modify file {filepath}: {e}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bad4009445361b33055a9c74f9b75ed09051af78"}, "originalPosition": 95}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzgxOTY0", "url": "https://github.com/returntocorp/semgrep/pull/1025#pullrequestreview-431781964", "createdAt": "2020-06-16T18:25:49Z", "commit": {"oid": "bad4009445361b33055a9c74f9b75ed09051af78"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODoyNTo0OVrOGkn-1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODoyNTo0OVrOGkn-1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1Njk4MA==", "bodyText": "Add comment that it replaces the first instance of from_str to to_str", "url": "https://github.com/returntocorp/semgrep/pull/1025#discussion_r441056980", "createdAt": "2020-06-16T18:25:49Z", "author": {"login": "brendongo"}, "path": "semgrep/semgrep/autofix.py", "diffHunk": "@@ -35,6 +53,38 @@ def _modify_file(rule_match: RuleMatch, fix: str) -> None:\n     p.write_text(contents_after_fix_str)\n \n \n+def _parse_regex_fix(sed_string: str) -> Tuple[str, str]:\n+    \"\"\"\n+    Return the second and third elements of a sed-like string:\n+    E.g., s/one/two/g returns (one, two)\n+    \"\"\"\n+    splitstr = sed_string.split(\"/\")  # Do it this way to satisfy mypy\n+    return splitstr[1], splitstr[2]\n+\n+\n+def _regex_replace(rule_match: RuleMatch, from_str: str, to_str: str) -> None:\n+    \"\"\"\n+    Use a regular expression to autofix.\n+    Replaces from_str to to_str.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bad4009445361b33055a9c74f9b75ed09051af78"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzgyODY1", "url": "https://github.com/returntocorp/semgrep/pull/1025#pullrequestreview-431782865", "createdAt": "2020-06-16T18:27:02Z", "commit": {"oid": "bad4009445361b33055a9c74f9b75ed09051af78"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODoyNzowMlrOGkoBfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODoyNzowMlrOGkoBfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1NzY2Mg==", "bodyText": "This probably doesn't play well if there are any close parenthesis in an argument to csv writer. The code will replace the first close parent encountered.", "url": "https://github.com/returntocorp/semgrep/pull/1025#discussion_r441057662", "createdAt": "2020-06-16T18:27:02Z", "author": {"login": "brendongo"}, "path": "semgrep/tests/e2e/rules/autofix/csv-writer.yaml", "diffHunk": "@@ -0,0 +1,14 @@\n+rules:\n+- id: python.lang.security.unquoted-csv-writer.unquoted-csv-writer\n+  patterns:\n+  - pattern-not: csv.writer(..., quoting=csv.QUOTE_ALL, ...)\n+  - pattern: csv.writer(...)\n+  fix: s/\\)/, quoting=csv.QUOTE_ALL)/g", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bad4009445361b33055a9c74f9b75ed09051af78"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afad1c7391fec34f45a58d0b56acc70b8989b2af", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/afad1c7391fec34f45a58d0b56acc70b8989b2af", "committedDate": "2020-06-18T17:03:31Z", "message": "Add in capability for regex autofixes on the matched area of a file. Uses a sed-like syntax for familiarity."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99a95f75c1743a8ac0f708d86beca3e16811816b", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/99a95f75c1743a8ac0f708d86beca3e16811816b", "committedDate": "2020-06-18T17:03:31Z", "message": "Fix a boo-boo: accidentally left the string slicing on in _parse_regex_fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b988d00a110068c87e279ac71c0c6d7d75de8cb0", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/b988d00a110068c87e279ac71c0c6d7d75de8cb0", "committedDate": "2020-06-18T17:03:31Z", "message": "Added e2e tests for regex autofix.\n\nBefore this commit, tests for regex autofix did not exist.\nThis commit introduces four rules with regex autofixes and their\ncorresponding test files. The tests use snapshots to determine\nif the autofix was applied to a source file correctly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f224d163f810def191242a9f922e6ce431eae99", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/5f224d163f810def191242a9f922e6ce431eae99", "committedDate": "2020-06-18T17:03:31Z", "message": "Fixed a bug that was removing a line in multiline contexts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9ffecf1dc8ce675f11c977afbb0094c96673ee0", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/f9ffecf1dc8ce675f11c977afbb0094c96673ee0", "committedDate": "2020-06-18T17:03:31Z", "message": "Regenerate snapshots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c14d39f8ca4bc7aa66a055d399311a6c10ee7848", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/c14d39f8ca4bc7aa66a055d399311a6c10ee7848", "committedDate": "2020-06-18T17:03:31Z", "message": "Regenerate snapshots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25658b9fe84f24f5a446072fc2ba48d6d97ad44f", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/25658b9fe84f24f5a446072fc2ba48d6d97ad44f", "committedDate": "2020-06-18T17:03:31Z", "message": "Remove prints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "574f3b40f9b56f00d161ccc6d0388b7b7f5f47c6", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/574f3b40f9b56f00d161ccc6d0388b7b7f5f47c6", "committedDate": "2020-06-18T17:03:31Z", "message": "Regex autofix now only uses line context, ignoring columns."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "639e6aa652f67dea5bda1e5fe2726142bbdd4ddf", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/639e6aa652f67dea5bda1e5fe2726142bbdd4ddf", "committedDate": "2020-06-18T17:03:31Z", "message": "Fix django none password autofix. Update snapshots."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d0e791b50eb794d5987c666a0ae4c56b222605e", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/6d0e791b50eb794d5987c666a0ae4c56b222605e", "committedDate": "2020-06-18T17:03:31Z", "message": "Remove debugging 'raise'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b609489e003a44c83c4cf24558f62d641f6ae28a", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/b609489e003a44c83c4cf24558f62d641f6ae28a", "committedDate": "2020-06-18T17:03:31Z", "message": "Add parsing for the /N flag at the end of a 'sed' command. 'g' means replace all, N means replace N times. Default is 1."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b86885a6ea9ce72e0d5d9491eef76d2211d3aee8", "author": {"user": {"login": "minusworld", "name": "Grayson H"}}, "url": "https://github.com/returntocorp/semgrep/commit/b86885a6ea9ce72e0d5d9491eef76d2211d3aee8", "committedDate": "2020-06-18T17:03:31Z", "message": "Modified tests to include variants of the flag at the end of the sed-like command. Also updated rules that depend on the last parenthesis to greedily search for the last parenthesis. Added test cases based on PR comments to make sure internal parentheses are not modified."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac37c1ef2b592e8b1d4c9d4004527504c474ac3d", "author": {"user": {"login": "mschwager", "name": null}}, "url": "https://github.com/returntocorp/semgrep/commit/ac37c1ef2b592e8b1d4c9d4004527504c474ac3d", "committedDate": "2020-06-18T17:03:31Z", "message": "Use structured YAML instead of 'sed' syntax"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43c9c10a3ed906951bc2231dc8428bbd0d28529b", "author": {"user": {"login": "mschwager", "name": null}}, "url": "https://github.com/returntocorp/semgrep/commit/43c9c10a3ed906951bc2231dc8428bbd0d28529b", "committedDate": "2020-06-18T17:03:31Z", "message": "Update rule parser snapshots"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0fdbc346fa84a568ce64528c02aefcd7af9af6e3", "author": {"user": {"login": "mschwager", "name": null}}, "url": "https://github.com/returntocorp/semgrep/commit/0fdbc346fa84a568ce64528c02aefcd7af9af6e3", "committedDate": "2020-06-18T15:26:00Z", "message": "Update rule parser snapshots"}, "afterCommit": {"oid": "43c9c10a3ed906951bc2231dc8428bbd0d28529b", "author": {"user": {"login": "mschwager", "name": null}}, "url": "https://github.com/returntocorp/semgrep/commit/43c9c10a3ed906951bc2231dc8428bbd0d28529b", "committedDate": "2020-06-18T17:03:31Z", "message": "Update rule parser snapshots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9f46b867843100a04866d443d4ab92d7bc965b4", "author": {"user": {"login": "mschwager", "name": null}}, "url": "https://github.com/returntocorp/semgrep/commit/a9f46b867843100a04866d443d4ab92d7bc965b4", "committedDate": "2020-06-18T17:10:52Z", "message": "Update rule parser snapshots again"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNjM0OTA4", "url": "https://github.com/returntocorp/semgrep/pull/1025#pullrequestreview-433634908", "createdAt": "2020-06-18T20:47:03Z", "commit": {"oid": "a9f46b867843100a04866d443d4ab92d7bc965b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1558, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}