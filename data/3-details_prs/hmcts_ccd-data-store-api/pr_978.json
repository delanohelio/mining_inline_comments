{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MTkxOTk0", "number": 978, "title": "RDM-8669: Assign a default value for a nested complex subfield", "bodyText": "JIRA link (if applicable)\nhttps://tools.hmcts.net/jira/browse/RDM-8669\nChange description\nIntroduce \"DefaultValue\" for complex to complex collections\nDoes this PR introduce a breaking change? (check one with \"x\")\n[ ] Yes\n[X ] No", "createdAt": "2020-06-16T12:49:41Z", "url": "https://github.com/hmcts/ccd-data-store-api/pull/978", "merged": true, "mergeCommit": {"oid": "beb146aeb000cebe632aa9b564feff34bd39b4d5"}, "closed": true, "closedAt": "2020-06-23T08:57:37Z", "author": {"login": "kiran-yenigala-hmcts"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqTTHxgH2gAyNDM1MTkxOTk0OjVmYWJlYzkyZmEyNGZjNDNkY2RmMTg2MDkwMDg5MDY3ZWJhNWM5ZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABctzHGJgH2gAyNDM1MTkxOTk0OjJlM2ZjOWQxNGIwYzU3ODdiZmQ3OTE3MzMyNTI3ODA4OWI4NDAxODY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5fabec92fa24fc43dcdf186090089067eba5c9e2", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/5fabec92fa24fc43dcdf186090089067eba5c9e2", "committedDate": "2020-06-11T19:19:59Z", "message": "RDM-8669: Assign a default value for a nested complex subfield"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b1b655fabd7b5848ec99121682448b31205db8a", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/8b1b655fabd7b5848ec99121682448b31205db8a", "committedDate": "2020-06-16T12:46:48Z", "message": "RDM-8669: Assign a default value for a nested complex subfield"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6e074a41f3dc2732a9f4c265bc432649de13f7b", "author": {"user": {"login": "MSancaktutar", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/b6e074a41f3dc2732a9f4c265bc432649de13f7b", "committedDate": "2020-06-16T17:32:41Z", "message": "Merge branch 'develop' into RDM-8669"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15ffe0961f9f0950f82dbacaca2476eeffad25cb", "author": {"user": {"login": "MSancaktutar", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/15ffe0961f9f0950f82dbacaca2476eeffad25cb", "committedDate": "2020-06-16T18:23:39Z", "message": "Merge branch 'develop' into RDM-8669"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47595e55a6199c526dd2d1ef597f74180dcf7c7c", "author": {"user": {"login": "MSancaktutar", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/47595e55a6199c526dd2d1ef597f74180dcf7c7c", "committedDate": "2020-06-16T22:42:04Z", "message": "Merge branch 'develop' into RDM-8669"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd27f1b814e2b71b79b8510d7085c98083333271", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/dd27f1b814e2b71b79b8510d7085c98083333271", "committedDate": "2020-06-17T11:30:00Z", "message": "RDM-8669: fix code coverage issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fdeb79c224de07646d18fc7525f680f88b0736c", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/3fdeb79c224de07646d18fc7525f680f88b0736c", "committedDate": "2020-06-17T12:07:30Z", "message": "RDM-8669: fix checkstyle issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0Nzg2Mjg3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/978#pullrequestreview-434786287", "createdAt": "2020-06-22T10:12:15Z", "commit": {"oid": "3fdeb79c224de07646d18fc7525f680f88b0736c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMDoxMjoxNVrOGm6ZOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMDoxNzo0NVrOGm6kFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ1NTgwMQ==", "bodyText": "may be it would be better adding other cases complex to complex 3 levels aa.aaa.aaa  and see how the  componet .  componet . componet works", "url": "https://github.com/hmcts/ccd-data-store-api/pull/978#discussion_r443455801", "createdAt": "2020-06-22T10:12:15Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/test/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperationTest.java", "diffHunk": "@@ -107,6 +110,37 @@ void shouldValidate_when_organisation_has_correct_roles() throws Exception {\n         );\n     }\n \n+    @Test\n+    void shouldValidate_when_organisation_has_correct_roles_complex() throws Exception {\n+\n+        String orgPolicyReference1 = ORGANISATIONPOLICYFIELD_1 + \".\" + ORGANISATION_POLICY_ROLE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fdeb79c224de07646d18fc7525f680f88b0736c"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ1ODU4MA==", "bodyText": "Do we always execute ORGANISATION_POLICY_ROLE validations. There could be submit cases  where there is  ORGANISATION_POLICY_ROLE logic is not present .  It is easier just return it .", "url": "https://github.com/hmcts/ccd-data-store-api/pull/978#discussion_r443458580", "createdAt": "2020-06-22T10:17:45Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -61,68 +59,64 @@\n \n     private void validateOrganisationPolicy(String caseTypeId, CaseDataContent content) {\n         final List<String> errorList = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fdeb79c224de07646d18fc7525f680f88b0736c"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0ODI5NDY4", "url": "https://github.com/hmcts/ccd-data-store-api/pull/978#pullrequestreview-434829468", "createdAt": "2020-06-22T11:19:52Z", "commit": {"oid": "3fdeb79c224de07646d18fc7525f680f88b0736c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0ODIwOTE3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/978#pullrequestreview-434820917", "createdAt": "2020-06-22T11:05:54Z", "commit": {"oid": "3fdeb79c224de07646d18fc7525f680f88b0736c"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMToxMjowMVrOGm8MSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMToyNToxNFrOGm8kAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ4NTI1Nw==", "bodyText": "CaseTypeDefinition has a findCaseEvent() method returning Optional<CaseEventDefinition>.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    caseDefinitionRepository.getCaseType(caseTypeId).getEvents().stream()\n          \n          \n            \n                        .filter(event -> event.getId().equals(content.getEventId()))\n          \n          \n            \n                        .forEach(caseEventDefinition -> caseEventDefinition.getCaseFields()\n          \n          \n            \n                    caseDefinitionRepository.getCaseType(caseTypeId).findCaseEvent(content.getEventId())\n          \n          \n            \n                        .ifPresent(caseEventDefinition -> caseEventDefinition.getCaseFields()", "url": "https://github.com/hmcts/ccd-data-store-api/pull/978#discussion_r443485257", "createdAt": "2020-06-22T11:12:01Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -61,68 +59,64 @@\n \n     private void validateOrganisationPolicy(String caseTypeId, CaseDataContent content) {\n         final List<String> errorList = new ArrayList<>();\n-        // if there is not a default value. it means that there will not be organisation policy validation.\n-        // hence if there is at least one ORGANISATION_POLICY_ROLE all default value logic will be executed.\n-        if (!isOrganisationPolicyLogicInTheContent(content)) {\n-            return;\n-        }\n-        caseDefinitionRepository.getCaseType(caseTypeId).getEvents().stream().filter(\n-            event -> event.getId().equals(content.getEventId())\n-        ).forEach(\n-            caseEventDefinition -> caseEventDefinition.getCaseFields().stream().forEach(\n-                caseField -> caseField.getCaseEventFieldComplexDefinitions().stream().filter(\n-                    caseEventFieldComplexDefinition -> {\n-                        if (caseEventFieldComplexDefinition.getReference().equals(ORGANISATION_POLICY_ROLE)) {\n-                            //get extract the default value  from the content for the current caseField\n-                            final Optional<String> caseFieldDefaultValue = getDefaultValueFromContentByCaseFieldID(content, caseField.getCaseFieldId());\n-                            validateOrgPolicyCaseAssignedRole(\n-                                caseEventFieldComplexDefinition,\n-                                caseFieldDefaultValue,\n-                                caseField.getCaseFieldId(),\n-                                errorList);\n-                            return true;\n-                        } else {\n-                            return false;\n-                        }\n-                    }\n-                ).collect(Collectors.toList()))\n-        );\n+        caseDefinitionRepository.getCaseType(caseTypeId).getEvents().stream()\n+            .filter(event -> event.getId().equals(content.getEventId()))\n+            .forEach(caseEventDefinition -> caseEventDefinition.getCaseFields()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fdeb79c224de07646d18fc7525f680f88b0736c"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ4ODEyOQ==", "bodyText": "This comment doesn't seem to match with what is happening next? validateContent", "url": "https://github.com/hmcts/ccd-data-store-api/pull/978#discussion_r443488129", "createdAt": "2020-06-22T11:18:14Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -61,68 +59,64 @@\n \n     private void validateOrganisationPolicy(String caseTypeId, CaseDataContent content) {\n         final List<String> errorList = new ArrayList<>();\n-        // if there is not a default value. it means that there will not be organisation policy validation.\n-        // hence if there is at least one ORGANISATION_POLICY_ROLE all default value logic will be executed.\n-        if (!isOrganisationPolicyLogicInTheContent(content)) {\n-            return;\n-        }\n-        caseDefinitionRepository.getCaseType(caseTypeId).getEvents().stream().filter(\n-            event -> event.getId().equals(content.getEventId())\n-        ).forEach(\n-            caseEventDefinition -> caseEventDefinition.getCaseFields().stream().forEach(\n-                caseField -> caseField.getCaseEventFieldComplexDefinitions().stream().filter(\n-                    caseEventFieldComplexDefinition -> {\n-                        if (caseEventFieldComplexDefinition.getReference().equals(ORGANISATION_POLICY_ROLE)) {\n-                            //get extract the default value  from the content for the current caseField\n-                            final Optional<String> caseFieldDefaultValue = getDefaultValueFromContentByCaseFieldID(content, caseField.getCaseFieldId());\n-                            validateOrgPolicyCaseAssignedRole(\n-                                caseEventFieldComplexDefinition,\n-                                caseFieldDefaultValue,\n-                                caseField.getCaseFieldId(),\n-                                errorList);\n-                            return true;\n-                        } else {\n-                            return false;\n-                        }\n-                    }\n-                ).collect(Collectors.toList()))\n-        );\n+        caseDefinitionRepository.getCaseType(caseTypeId).getEvents().stream()\n+            .filter(event -> event.getId().equals(content.getEventId()))\n+            .forEach(caseEventDefinition -> caseEventDefinition.getCaseFields()\n+                .stream()\n+                .forEach(eventFieldDefinition -> eventFieldDefinition.getCaseEventFieldComplexDefinitions().stream()\n+                    .filter(cefcDefinition -> isOrgPolicyCaseAssignedRole(cefcDefinition.getReference()))\n+                    .forEach(cefcDefinition -> {\n+                        //get extract the default value  from the content for the current eventFieldDefinition", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fdeb79c224de07646d18fc7525f680f88b0736c"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5MDAyMQ==", "bodyText": "Overcomplicating by wrapping in an Optional rather than just checking not null?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/978#discussion_r443490021", "createdAt": "2020-06-22T11:22:20Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -61,68 +59,64 @@\n \n     private void validateOrganisationPolicy(String caseTypeId, CaseDataContent content) {\n         final List<String> errorList = new ArrayList<>();\n-        // if there is not a default value. it means that there will not be organisation policy validation.\n-        // hence if there is at least one ORGANISATION_POLICY_ROLE all default value logic will be executed.\n-        if (!isOrganisationPolicyLogicInTheContent(content)) {\n-            return;\n-        }\n-        caseDefinitionRepository.getCaseType(caseTypeId).getEvents().stream().filter(\n-            event -> event.getId().equals(content.getEventId())\n-        ).forEach(\n-            caseEventDefinition -> caseEventDefinition.getCaseFields().stream().forEach(\n-                caseField -> caseField.getCaseEventFieldComplexDefinitions().stream().filter(\n-                    caseEventFieldComplexDefinition -> {\n-                        if (caseEventFieldComplexDefinition.getReference().equals(ORGANISATION_POLICY_ROLE)) {\n-                            //get extract the default value  from the content for the current caseField\n-                            final Optional<String> caseFieldDefaultValue = getDefaultValueFromContentByCaseFieldID(content, caseField.getCaseFieldId());\n-                            validateOrgPolicyCaseAssignedRole(\n-                                caseEventFieldComplexDefinition,\n-                                caseFieldDefaultValue,\n-                                caseField.getCaseFieldId(),\n-                                errorList);\n-                            return true;\n-                        } else {\n-                            return false;\n-                        }\n-                    }\n-                ).collect(Collectors.toList()))\n-        );\n+        caseDefinitionRepository.getCaseType(caseTypeId).getEvents().stream()\n+            .filter(event -> event.getId().equals(content.getEventId()))\n+            .forEach(caseEventDefinition -> caseEventDefinition.getCaseFields()\n+                .stream()\n+                .forEach(eventFieldDefinition -> eventFieldDefinition.getCaseEventFieldComplexDefinitions().stream()\n+                    .filter(cefcDefinition -> isOrgPolicyCaseAssignedRole(cefcDefinition.getReference()))\n+                    .forEach(cefcDefinition -> {\n+                        //get extract the default value  from the content for the current eventFieldDefinition\n+                        String reference = cefcDefinition.getReference();\n+                        validateContent(content, eventFieldDefinition.getCaseFieldId(),\n+                            reference,\n+                            cefcDefinition.getDefaultValue(),\n+                            errorList);\n+                    })));\n         if (errorList.size() != 0) {\n             throw new ValidationException(\"Roles validation error: \" + String.join(\", \", errorList));\n         }\n     }\n \n-    private boolean isOrganisationPolicyLogicInTheContent(final CaseDataContent content) {\n-        final JsonNode existingData = new ObjectMapper().convertValue(content.getData(), JsonNode.class);\n-        final List<JsonNode> jsonNode = existingData.findParents(ORGANISATION_POLICY_ROLE);\n-        final Optional<JsonNode> node = jsonNode.stream().findFirst();\n-        return  node.isPresent();\n+    private boolean isOrgPolicyCaseAssignedRole(String reference) {\n+        String[] referenceArray = reference.split(Pattern.quote(\".\"));\n+        return ORGANISATION_POLICY_ROLE.equals(referenceArray[referenceArray.length - 1]);\n     }\n \n-    private Optional<String> getDefaultValueFromContentByCaseFieldID(final CaseDataContent content, final String caseFiledID) {\n+    private void validateContent(final CaseDataContent content,\n+                                 final String caseFiledID,\n+                                 final String reference,\n+                                 final String defaultValue,\n+                                 final List<String> errorList) {\n         final JsonNode existingData = new ObjectMapper().convertValue(content.getData(), JsonNode.class);\n-        final Optional<JsonNode> caseFieldNode = Optional.ofNullable(existingData.get(caseFiledID));\n-\n+        Optional<JsonNode> caseFieldNode = Optional.of(existingData.findPath(caseFiledID));\n         if (caseFieldNode.isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fdeb79c224de07646d18fc7525f680f88b0736c"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5MDgwMA==", "bodyText": "Could extract since used elsewhere (e.g. L#82).", "url": "https://github.com/hmcts/ccd-data-store-api/pull/978#discussion_r443490800", "createdAt": "2020-06-22T11:24:05Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -61,68 +59,64 @@\n \n     private void validateOrganisationPolicy(String caseTypeId, CaseDataContent content) {\n         final List<String> errorList = new ArrayList<>();\n-        // if there is not a default value. it means that there will not be organisation policy validation.\n-        // hence if there is at least one ORGANISATION_POLICY_ROLE all default value logic will be executed.\n-        if (!isOrganisationPolicyLogicInTheContent(content)) {\n-            return;\n-        }\n-        caseDefinitionRepository.getCaseType(caseTypeId).getEvents().stream().filter(\n-            event -> event.getId().equals(content.getEventId())\n-        ).forEach(\n-            caseEventDefinition -> caseEventDefinition.getCaseFields().stream().forEach(\n-                caseField -> caseField.getCaseEventFieldComplexDefinitions().stream().filter(\n-                    caseEventFieldComplexDefinition -> {\n-                        if (caseEventFieldComplexDefinition.getReference().equals(ORGANISATION_POLICY_ROLE)) {\n-                            //get extract the default value  from the content for the current caseField\n-                            final Optional<String> caseFieldDefaultValue = getDefaultValueFromContentByCaseFieldID(content, caseField.getCaseFieldId());\n-                            validateOrgPolicyCaseAssignedRole(\n-                                caseEventFieldComplexDefinition,\n-                                caseFieldDefaultValue,\n-                                caseField.getCaseFieldId(),\n-                                errorList);\n-                            return true;\n-                        } else {\n-                            return false;\n-                        }\n-                    }\n-                ).collect(Collectors.toList()))\n-        );\n+        caseDefinitionRepository.getCaseType(caseTypeId).getEvents().stream()\n+            .filter(event -> event.getId().equals(content.getEventId()))\n+            .forEach(caseEventDefinition -> caseEventDefinition.getCaseFields()\n+                .stream()\n+                .forEach(eventFieldDefinition -> eventFieldDefinition.getCaseEventFieldComplexDefinitions().stream()\n+                    .filter(cefcDefinition -> isOrgPolicyCaseAssignedRole(cefcDefinition.getReference()))\n+                    .forEach(cefcDefinition -> {\n+                        //get extract the default value  from the content for the current eventFieldDefinition\n+                        String reference = cefcDefinition.getReference();\n+                        validateContent(content, eventFieldDefinition.getCaseFieldId(),\n+                            reference,\n+                            cefcDefinition.getDefaultValue(),\n+                            errorList);\n+                    })));\n         if (errorList.size() != 0) {\n             throw new ValidationException(\"Roles validation error: \" + String.join(\", \", errorList));\n         }\n     }\n \n-    private boolean isOrganisationPolicyLogicInTheContent(final CaseDataContent content) {\n-        final JsonNode existingData = new ObjectMapper().convertValue(content.getData(), JsonNode.class);\n-        final List<JsonNode> jsonNode = existingData.findParents(ORGANISATION_POLICY_ROLE);\n-        final Optional<JsonNode> node = jsonNode.stream().findFirst();\n-        return  node.isPresent();\n+    private boolean isOrgPolicyCaseAssignedRole(String reference) {\n+        String[] referenceArray = reference.split(Pattern.quote(\".\"));\n+        return ORGANISATION_POLICY_ROLE.equals(referenceArray[referenceArray.length - 1]);\n     }\n \n-    private Optional<String> getDefaultValueFromContentByCaseFieldID(final CaseDataContent content, final String caseFiledID) {\n+    private void validateContent(final CaseDataContent content,\n+                                 final String caseFiledID,\n+                                 final String reference,\n+                                 final String defaultValue,\n+                                 final List<String> errorList) {\n         final JsonNode existingData = new ObjectMapper().convertValue(content.getData(), JsonNode.class);\n-        final Optional<JsonNode> caseFieldNode = Optional.ofNullable(existingData.get(caseFiledID));\n-\n+        Optional<JsonNode> caseFieldNode = Optional.of(existingData.findPath(caseFiledID));\n         if (caseFieldNode.isPresent()) {\n-            if (caseFieldNode.get().get(ORGANISATION_POLICY_ROLE).isNull()) {\n-                return Optional.ofNullable(null);\n-            }\n-            return Optional.of(caseFieldNode.get().get(ORGANISATION_POLICY_ROLE).textValue());\n+            String[] referenceArray = reference.split(Pattern.quote(\".\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fdeb79c224de07646d18fc7525f680f88b0736c"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5MTMyOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                             final String caseFiledID,\n          \n          \n            \n                                             final String caseFieldId,", "url": "https://github.com/hmcts/ccd-data-store-api/pull/978#discussion_r443491328", "createdAt": "2020-06-22T11:25:14Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -61,68 +59,64 @@\n \n     private void validateOrganisationPolicy(String caseTypeId, CaseDataContent content) {\n         final List<String> errorList = new ArrayList<>();\n-        // if there is not a default value. it means that there will not be organisation policy validation.\n-        // hence if there is at least one ORGANISATION_POLICY_ROLE all default value logic will be executed.\n-        if (!isOrganisationPolicyLogicInTheContent(content)) {\n-            return;\n-        }\n-        caseDefinitionRepository.getCaseType(caseTypeId).getEvents().stream().filter(\n-            event -> event.getId().equals(content.getEventId())\n-        ).forEach(\n-            caseEventDefinition -> caseEventDefinition.getCaseFields().stream().forEach(\n-                caseField -> caseField.getCaseEventFieldComplexDefinitions().stream().filter(\n-                    caseEventFieldComplexDefinition -> {\n-                        if (caseEventFieldComplexDefinition.getReference().equals(ORGANISATION_POLICY_ROLE)) {\n-                            //get extract the default value  from the content for the current caseField\n-                            final Optional<String> caseFieldDefaultValue = getDefaultValueFromContentByCaseFieldID(content, caseField.getCaseFieldId());\n-                            validateOrgPolicyCaseAssignedRole(\n-                                caseEventFieldComplexDefinition,\n-                                caseFieldDefaultValue,\n-                                caseField.getCaseFieldId(),\n-                                errorList);\n-                            return true;\n-                        } else {\n-                            return false;\n-                        }\n-                    }\n-                ).collect(Collectors.toList()))\n-        );\n+        caseDefinitionRepository.getCaseType(caseTypeId).getEvents().stream()\n+            .filter(event -> event.getId().equals(content.getEventId()))\n+            .forEach(caseEventDefinition -> caseEventDefinition.getCaseFields()\n+                .stream()\n+                .forEach(eventFieldDefinition -> eventFieldDefinition.getCaseEventFieldComplexDefinitions().stream()\n+                    .filter(cefcDefinition -> isOrgPolicyCaseAssignedRole(cefcDefinition.getReference()))\n+                    .forEach(cefcDefinition -> {\n+                        //get extract the default value  from the content for the current eventFieldDefinition\n+                        String reference = cefcDefinition.getReference();\n+                        validateContent(content, eventFieldDefinition.getCaseFieldId(),\n+                            reference,\n+                            cefcDefinition.getDefaultValue(),\n+                            errorList);\n+                    })));\n         if (errorList.size() != 0) {\n             throw new ValidationException(\"Roles validation error: \" + String.join(\", \", errorList));\n         }\n     }\n \n-    private boolean isOrganisationPolicyLogicInTheContent(final CaseDataContent content) {\n-        final JsonNode existingData = new ObjectMapper().convertValue(content.getData(), JsonNode.class);\n-        final List<JsonNode> jsonNode = existingData.findParents(ORGANISATION_POLICY_ROLE);\n-        final Optional<JsonNode> node = jsonNode.stream().findFirst();\n-        return  node.isPresent();\n+    private boolean isOrgPolicyCaseAssignedRole(String reference) {\n+        String[] referenceArray = reference.split(Pattern.quote(\".\"));\n+        return ORGANISATION_POLICY_ROLE.equals(referenceArray[referenceArray.length - 1]);\n     }\n \n-    private Optional<String> getDefaultValueFromContentByCaseFieldID(final CaseDataContent content, final String caseFiledID) {\n+    private void validateContent(final CaseDataContent content,\n+                                 final String caseFiledID,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fdeb79c224de07646d18fc7525f680f88b0736c"}, "originalPosition": 92}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "672a4a627cbb6f7da3e01dc501e7ff049d34fa75", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/672a4a627cbb6f7da3e01dc501e7ff049d34fa75", "committedDate": "2020-06-22T12:34:18Z", "message": "RDM-8669: fix code review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0ODkyMDkw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/978#pullrequestreview-434892090", "createdAt": "2020-06-22T12:52:40Z", "commit": {"oid": "49b8a325426d6797a3d03d011a6f601c97c2f7e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49b8a325426d6797a3d03d011a6f601c97c2f7e8", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/49b8a325426d6797a3d03d011a6f601c97c2f7e8", "committedDate": "2020-06-22T12:56:01Z", "message": "RDM-8669: fix code review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e3fc9d14b0c5787bfd79173325278089b840186", "author": {"user": {"login": "MSancaktutar", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/2e3fc9d14b0c5787bfd79173325278089b840186", "committedDate": "2020-06-22T16:05:35Z", "message": "Merge branch 'develop' into RDM-8669"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2548, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}