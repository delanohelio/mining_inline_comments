{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5Mzg2NTIz", "number": 1157, "title": "RDM-9556: Data Store Changes for Conditional Event Post State", "bodyText": "JIRA link (if applicable)\nhttps://tools.hmcts.net/jira/browse/RDM-9556\nChange description\nPost State Condition changes\nDoes this PR introduce a breaking change? (check one with \"x\")\n[X ] Yes\n[ ] No", "createdAt": "2020-10-07T16:51:40Z", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157", "merged": true, "mergeCommit": {"oid": "115fe3dd2b0741dd565aa5317815231e19c47928"}, "closed": true, "closedAt": "2020-10-14T08:12:53Z", "author": {"login": "kiran-yenigala-hmcts"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQP2caAH2gAyNDk5Mzg2NTIzOmQzMDA2YTk5YWYxOGE2MTU2Nzc4YjRkNjE1YmZjZTU4MmU2ZTQ4OTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSYqvugFqTUwODA5Nzc4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d3006a99af18a6156778b4d615bfce582e6e4895", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/d3006a99af18a6156778b4d615bfce582e6e4895", "committedDate": "2020-10-07T16:48:04Z", "message": "RDM-9556: code review comments addressed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3226487a3cbbe9be0c52064613c5f570db811da2", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/3226487a3cbbe9be0c52064613c5f570db811da2", "committedDate": "2020-10-07T16:48:22Z", "message": "RDM-9556: code review comments addressed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTU4NTM5", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157#pullrequestreview-504558539", "createdAt": "2020-10-08T08:46:05Z", "commit": {"oid": "3226487a3cbbe9be0c52064613c5f570db811da2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODo0NjowNVrOHeUL0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODo0NjowNVrOHeUL0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU1MDAzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class CaseStateUpdateService {\n          \n          \n            \n            public class CasePostStateService {\n          \n      \n    \n    \n  \n\nthis class is not really doing any case update itself right?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157#discussion_r501550033", "createdAt": "2020-10-08T08:46:05Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/CaseStateUpdateService.java", "diffHunk": "@@ -3,34 +3,43 @@\n import com.fasterxml.jackson.databind.JsonNode;\n import java.util.List;\n import java.util.Map;\n-import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n import javax.inject.Inject;\n import org.springframework.stereotype.Service;\n-import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionSorter;\n+import uk.gov.hmcts.ccd.domain.enablingcondition.PrioritiseEnablingCondition;\n import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n import uk.gov.hmcts.ccd.domain.model.definition.CaseEventDefinition;\n import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n \n @Service\n public class CaseStateUpdateService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3226487a3cbbe9be0c52064613c5f570db811da2"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTU5MTUz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157#pullrequestreview-504559153", "createdAt": "2020-10-08T08:46:49Z", "commit": {"oid": "3226487a3cbbe9be0c52064613c5f570db811da2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODo0Njo0OVrOHeUNlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODo0Njo0OVrOHeUNlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU1MDQ4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public String retrieveCaseState(CaseEventDefinition caseEventDefinition, CaseDetails caseDetails) {\n          \n          \n            \n                public String determineCaseState(CaseEventDefinition caseEventDefinition, CaseDetails caseDetails) {", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157#discussion_r501550486", "createdAt": "2020-10-08T08:46:49Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/CaseStateUpdateService.java", "diffHunk": "@@ -3,34 +3,43 @@\n import com.fasterxml.jackson.databind.JsonNode;\n import java.util.List;\n import java.util.Map;\n-import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n import javax.inject.Inject;\n import org.springframework.stereotype.Service;\n-import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionSorter;\n+import uk.gov.hmcts.ccd.domain.enablingcondition.PrioritiseEnablingCondition;\n import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n import uk.gov.hmcts.ccd.domain.model.definition.CaseEventDefinition;\n import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n \n @Service\n public class CaseStateUpdateService {\n \n-    private final EnablingConditionSorter enablingConditionSorter;\n-    private StateReferenceService stateReferenceService;\n+    private final PrioritiseEnablingCondition prioritiseEnablingCondition;\n+    private CasePostStateEvaluationService casePostStateEvaluationService;\n \n     @Inject\n-    public CaseStateUpdateService(EnablingConditionSorter enablingConditionSorter,\n-                                  StateReferenceService stateReferenceService) {\n-        this.enablingConditionSorter = enablingConditionSorter;\n-        this.stateReferenceService = stateReferenceService;\n+    public CaseStateUpdateService(PrioritiseEnablingCondition prioritiseEnablingCondition,\n+                                  CasePostStateEvaluationService casePostStateEvaluationService) {\n+        this.prioritiseEnablingCondition = prioritiseEnablingCondition;\n+        this.casePostStateEvaluationService = casePostStateEvaluationService;\n     }\n \n-    public Optional<String> retrieveCaseState(CaseEventDefinition caseEventDefinition, CaseDetails caseDetails) {\n-        List<EventPostStateDefinition> eventPostStateDefinitions = caseEventDefinition.getPostStates();\n-        this.enablingConditionSorter.sortEventPostStates(eventPostStateDefinitions);\n-        Map<String, JsonNode> caseEventData = caseDetails.getCaseEventData(caseEventDefinition);\n-        Optional<String> postStateReference = this.stateReferenceService\n+    public String retrieveCaseState(CaseEventDefinition caseEventDefinition, CaseDetails caseDetails) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3226487a3cbbe9be0c52064613c5f570db811da2"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTY3NTk2", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157#pullrequestreview-504567596", "createdAt": "2020-10-08T08:56:12Z", "commit": {"oid": "3226487a3cbbe9be0c52064613c5f570db811da2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODo1NjoxMlrOHeUlEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODo1NjoxMlrOHeUlEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU1NjQ5Ng==", "bodyText": "if(!shouldRemainOnCurrentState(postState)){\nwhere shouldRemainOnCurrentState(String state) is a private method containing equalsIgnoreCase(CaseStateDefinition.ANY, postState)", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157#discussion_r501556496", "createdAt": "2020-10-08T08:56:12Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/createevent/CreateCaseEventService.java", "diffHunk": "@@ -234,9 +234,9 @@ private void mergeUpdatedFieldsToCaseDetails(final Map<String, JsonNode> data,\n     }\n \n     private void updateCaseState(CaseDetails caseDetails, CaseEventDefinition caseEventDefinition) {\n-        Optional<String> postState = caseStateUpdateService.retrieveCaseState(caseEventDefinition, caseDetails);\n-        if (postState.isPresent() && !equalsIgnoreCase(CaseStateDefinition.ANY, postState.get())) {\n-            caseDetails.setState(postState.get());\n+        String postState = caseStateUpdateService.retrieveCaseState(caseEventDefinition, caseDetails);\n+        if (!equalsIgnoreCase(CaseStateDefinition.ANY, postState)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3226487a3cbbe9be0c52064613c5f570db811da2"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTcwMjYz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157#pullrequestreview-504570263", "createdAt": "2020-10-08T08:59:13Z", "commit": {"oid": "3226487a3cbbe9be0c52064613c5f570db811da2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODo1OToxM1rOHeUtAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODo1OToxM1rOHeUtAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU1ODUzMQ==", "bodyText": "are we able to support enabling condition on null fields? And on blank String fields? what is the notation that we need to use? same for both?\nfor example something like this what would match:\nclaimantIndType.claimant_title1 =\"\"", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157#discussion_r501558531", "createdAt": "2020-10-08T08:59:13Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/enablingcondition/jexl/JexlEnablingConditionParser.java", "diffHunk": "@@ -1,4 +1,4 @@\n-package uk.gov.hmcts.ccd.domain.casestate.jexl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3226487a3cbbe9be0c52064613c5f570db811da2"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTg2NTEx", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157#pullrequestreview-504586511", "createdAt": "2020-10-08T09:18:40Z", "commit": {"oid": "3226487a3cbbe9be0c52064613c5f570db811da2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwOToxODo0MFrOHeVdNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwOToxODo0MFrOHeVdNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU3MDg3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public interface EnablingConditionFormatter {\n          \n          \n            \n            public interface EnablingConditionConverter {\n          \n      \n    \n    \n  \n\nalso can you add a small Javadoc explaining this is converting our internal enabling condition syntax to the Jexl one?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157#discussion_r501570871", "createdAt": "2020-10-08T09:18:40Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/enablingcondition/EnablingConditionFormatter.java", "diffHunk": "@@ -1,4 +1,4 @@\n-package uk.gov.hmcts.ccd.domain.casestate;\n+package uk.gov.hmcts.ccd.domain.enablingcondition;\n \n public interface EnablingConditionFormatter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3226487a3cbbe9be0c52064613c5f570db811da2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NjA0MTU2", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157#pullrequestreview-504604156", "createdAt": "2020-10-08T09:40:07Z", "commit": {"oid": "3226487a3cbbe9be0c52064613c5f570db811da2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwOTo0MDowOFrOHeWSRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwOTo0MDowOFrOHeWSRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU4NDQ1NQ==", "bodyText": "shall we rename to JexlEnablingConditionConverter ?\nand add a small Javadoc describing what the class is doing", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157#discussion_r501584455", "createdAt": "2020-10-08T09:40:08Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/enablingcondition/jexl/JexlEnablingConditionFormatter.java", "diffHunk": "@@ -1,4 +1,4 @@\n-package uk.gov.hmcts.ccd.domain.casestate.jexl;\n+package uk.gov.hmcts.ccd.domain.enablingcondition.jexl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3226487a3cbbe9be0c52064613c5f570db811da2"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2093dff6ea2ecf4638b7a8c435f117b9e0404a4", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/b2093dff6ea2ecf4638b7a8c435f117b9e0404a4", "committedDate": "2020-10-08T19:36:01Z", "message": "RDM-9556: code review comments addressed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDU0Njc3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157#pullrequestreview-505454677", "createdAt": "2020-10-09T08:12:25Z", "commit": {"oid": "b2093dff6ea2ecf4638b7a8c435f117b9e0404a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MDk3Nzg4", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1157#pullrequestreview-508097788", "createdAt": "2020-10-14T08:12:17Z", "commit": {"oid": "b2093dff6ea2ecf4638b7a8c435f117b9e0404a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2768, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}