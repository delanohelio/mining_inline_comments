{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4MTM4MzYy", "number": 968, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoyNjoxOVrOEC2Jdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzo1NDowN1rOED5Eiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDE5NzY2OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CaseAssignedUserRolesKey.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoyNjoxOVrOGfjR9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoyNjoxOVrOGfjR9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTczNzA3OQ==", "bodyText": "But even if we do, a set equivalence should be used for this kind of a key design. What if the a list contains a duplicate entry while all others being the same as the other? I suspect we need a caching and therefore a key design like this.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435737079", "createdAt": "2020-06-05T07:26:19Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CaseAssignedUserRolesKey.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package uk.gov.hmcts.ccd.data.caseaccess;\n+\n+import java.util.List;\n+import org.apache.commons.collections.ListUtils;\n+\n+public class CaseAssignedUserRolesKey {\n+\n+    private final List<Long> caseIds;\n+\n+    private final List<String> userIds;\n+\n+    public CaseAssignedUserRolesKey(List<Long> caseIds, List<String> userIds) {\n+        this.caseIds = caseIds;\n+        this.userIds = userIds;\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+        CaseAssignedUserRolesKey that = (CaseAssignedUserRolesKey) o;\n+        if (caseIds == null || that.caseIds == null || caseIds.size() != that.caseIds.size()) {\n+            return false;\n+        }\n+\n+        if (userIds == null || that.userIds == null || userIds.size() != that.userIds.size()) {\n+            return false;\n+        }\n+        return caseIds.containsAll(that.caseIds) && userIds.containsAll(that.userIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDE5NzgxOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CachedCaseUserRepository.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoyNjoyM1rOGfjSDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoyNjoyM1rOGfjSDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTczNzEwMg==", "bodyText": "This caching doesn't seem to be ok. What if the case-user-role assignments change? And what if the list of user ids and case ids are provided in a different order? And, what is the eviction policy of this cache?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435737102", "createdAt": "2020-06-05T07:26:23Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CachedCaseUserRepository.java", "diffHunk": "@@ -43,4 +44,11 @@ public void revokeAccess(Long caseId, String userId, String caseRole) {\n     public List<String> findCaseRoles(final Long caseId, final String userId) {\n         return caseUserRoles.computeIfAbsent(caseId + userId, e -> caseUserRepository.findCaseRoles(caseId, userId));\n     }\n+\n+    @Override\n+    public List<CaseUserEntity> findCaseUserRoles(List<Long> caseIds, List<String> userIds) {\n+        return caseAssignedUserRoles.computeIfAbsent(\n+            new CaseAssignedUserRolesKey(caseIds, userIds),\n+            e -> caseUserRepository.findCaseUserRoles(caseIds, userIds));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDIwNDE0OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/caseaccess/DefaultCaseUserRepository.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoyODoyN1rOGfjWDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoyODoyN1rOGfjWDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTczODEyNw==", "bodyText": "this could be written nicer with less or no repeated lines.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435738127", "createdAt": "2020-06-05T07:28:27Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/caseaccess/DefaultCaseUserRepository.java", "diffHunk": "@@ -53,4 +53,17 @@ public void revokeAccess(Long caseId, String userId, String caseRole) {\n \n         return namedQuery.getResultList();\n     }\n+\n+    public List<CaseUserEntity> findCaseUserRoles(final List<Long> caseIds, final List<String> userIds) {\n+        if (userIds.size() == 0) {\n+            TypedQuery<CaseUserEntity> namedQuery = em.createNamedQuery(CaseUserEntity.GET_ALL_CASE_ROLES_BY_CASE_IDS, CaseUserEntity.class);\n+            namedQuery.setParameter(CaseUserEntity.PARAM_CASE_DATA_IDS, caseIds);\n+            return namedQuery.getResultList();\n+        } else {\n+            TypedQuery<CaseUserEntity> namedQuery = em.createNamedQuery(CaseUserEntity.GET_ALL_CASE_ROLES_USERS_HAS_ACCESS_TO_CASES, CaseUserEntity.class);\n+            namedQuery.setParameter(CaseUserEntity.PARAM_CASE_DATA_IDS, caseIds);\n+            namedQuery.setParameter(CaseUserEntity.PARAM_USER_IDS, userIds);\n+            return namedQuery.getResultList();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDIzNzMzOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzozOToyM1rOGfjqgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMDo0MzoyNlrOGfplIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0MzM2MQ==", "bodyText": "could id (reference) is a String / (varchar 255) elsewhere in CCD.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435743361", "createdAt": "2020-06-05T07:39:23Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package uk.gov.hmcts.ccd.domain.model.std;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.AllArgsConstructor;\n+import lombok.NoArgsConstructor;\n+import lombok.ToString;\n+\n+@ToString\n+@AllArgsConstructor\n+@NoArgsConstructor\n+public class CaseAssignedUserRole {\n+\n+    @JsonProperty(\"case_data_id\")\n+    private Long caseDataId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg0MDI4OA==", "bodyText": "changed to String!!", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435840288", "createdAt": "2020-06-05T10:43:26Z", "author": {"login": "kiran-yenigala-hmcts"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package uk.gov.hmcts.ccd.domain.model.std;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.AllArgsConstructor;\n+import lombok.NoArgsConstructor;\n+import lombok.ToString;\n+\n+@ToString\n+@AllArgsConstructor\n+@NoArgsConstructor\n+public class CaseAssignedUserRole {\n+\n+    @JsonProperty(\"case_data_id\")\n+    private Long caseDataId;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0MzM2MQ=="}, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDIzOTg0OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo0MDowN1rOGfjsDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMDozNzoyMlrOGfpalQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0Mzc1OQ==", "bodyText": "case_id is used in LLD and other references", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435743759", "createdAt": "2020-06-05T07:40:07Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package uk.gov.hmcts.ccd.domain.model.std;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.AllArgsConstructor;\n+import lombok.NoArgsConstructor;\n+import lombok.ToString;\n+\n+@ToString\n+@AllArgsConstructor\n+@NoArgsConstructor\n+public class CaseAssignedUserRole {\n+\n+    @JsonProperty(\"case_data_id\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgzNzU4OQ==", "bodyText": "Done", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435837589", "createdAt": "2020-06-05T10:37:22Z", "author": {"login": "kiran-yenigala-hmcts"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package uk.gov.hmcts.ccd.domain.model.std;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.AllArgsConstructor;\n+import lombok.NoArgsConstructor;\n+import lombok.ToString;\n+\n+@ToString\n+@AllArgsConstructor\n+@NoArgsConstructor\n+public class CaseAssignedUserRole {\n+\n+    @JsonProperty(\"case_data_id\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0Mzc1OQ=="}, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDI0OTQ4OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/v2/V2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo0MzoyM1rOGfjyUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMDo0MjozMFrOGfpjhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0NTM2MA==", "bodyText": "We wouldn't use a new media type for the initial version of this operation.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435745360", "createdAt": "2020-06-05T07:43:23Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/v2/V2.java", "diffHunk": "@@ -43,6 +43,8 @@ private MediaType() {}\n \n         public static final String CASE_EVENTS = \"application/vnd.uk.gov.hmcts.ccd-data-store-api.case-events.v2+json;charset=UTF-8\";\n \n+        public static final String CASE_USER_ROLES = \"application/vnd.uk.gov.hmcts.ccd-data-store-api.case-user-roles.v2+json;charset=UTF-8\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgzOTg3Ng==", "bodyText": "Not using any media type for now!!!", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435839876", "createdAt": "2020-06-05T10:42:30Z", "author": {"login": "kiran-yenigala-hmcts"}, "path": "src/main/java/uk/gov/hmcts/ccd/v2/V2.java", "diffHunk": "@@ -43,6 +43,8 @@ private MediaType() {}\n \n         public static final String CASE_EVENTS = \"application/vnd.uk.gov.hmcts.ccd-data-store-api.case-events.v2+json;charset=UTF-8\";\n \n+        public static final String CASE_USER_ROLES = \"application/vnd.uk.gov.hmcts.ccd-data-store-api.case-user-roles.v2+json;charset=UTF-8\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0NTM2MA=="}, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDI2MjY2OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo0Nzo0MVrOGfj6jA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMDo0Mjo1OVrOGfpkVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0NzQ2OA==", "bodyText": "This could have been done by Spring automatatically. Just use type List", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435747468", "createdAt": "2020-06-05T07:47:41Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package uk.gov.hmcts.ccd.v2.external.controller;\n+\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiResponse;\n+import io.swagger.annotations.ApiResponses;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.domain.service.cauroles.CaseAssignedUserRolesOperation;\n+import uk.gov.hmcts.ccd.domain.service.common.UIDService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.BadRequestException;\n+import uk.gov.hmcts.ccd.v2.V2;\n+import uk.gov.hmcts.ccd.v2.external.resource.CaseAssignedUserRolesResource;\n+\n+@RestController\n+@RequestMapping(path = \"/\")\n+public class CaseAssignedUserRolesController {\n+\n+    private final UIDService caseReferenceService;\n+    private final CaseAssignedUserRolesOperation caseAssignedUserRolesOperation;\n+\n+    @Autowired\n+    public CaseAssignedUserRolesController(UIDService caseReferenceService,\n+                                           @Qualifier(\"authorised\") CaseAssignedUserRolesOperation caseAssignedUserRolesOperation) {\n+        this.caseReferenceService = caseReferenceService;\n+        this.caseAssignedUserRolesOperation = caseAssignedUserRolesOperation;\n+    }\n+\n+    @GetMapping(\n+        path = \"/case-users\",\n+        produces = {\n+            V2.MediaType.CASE_USER_ROLES\n+        }\n+    )\n+    @ApiOperation(\n+        value = \"Retrieve Case user roles by Case ID and User ID\"\n+    )\n+    @ApiResponses({\n+        @ApiResponse(\n+            code = 200,\n+            message = \"Case-User-Role assignments returned successfully\",\n+            response = CaseAssignedUserRolesResource.class\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.CASE_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.EMPTY_CASE_ID_LIST\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.USER_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 403,\n+            message = V2.Error.OTHER_USER_CASE_ROLE_ACCESS_NOT_GRANTED\n+        )\n+    })\n+    // TODO: 01/06/2020  add LogAudit\n+    public ResponseEntity<CaseAssignedUserRolesResource> getCaseUserRoles(@RequestParam(\"case_ids\") String caseIds,\n+                                                                          @RequestParam(value = \"user_ids\", required = false) String userIds) {\n+        List<String> listUserIds = convertToList(userIds);\n+        List<String> listCaseIds = convertToList(caseIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg0MDA4NA==", "bodyText": "done!!!!", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435840084", "createdAt": "2020-06-05T10:42:59Z", "author": {"login": "kiran-yenigala-hmcts"}, "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package uk.gov.hmcts.ccd.v2.external.controller;\n+\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiResponse;\n+import io.swagger.annotations.ApiResponses;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.domain.service.cauroles.CaseAssignedUserRolesOperation;\n+import uk.gov.hmcts.ccd.domain.service.common.UIDService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.BadRequestException;\n+import uk.gov.hmcts.ccd.v2.V2;\n+import uk.gov.hmcts.ccd.v2.external.resource.CaseAssignedUserRolesResource;\n+\n+@RestController\n+@RequestMapping(path = \"/\")\n+public class CaseAssignedUserRolesController {\n+\n+    private final UIDService caseReferenceService;\n+    private final CaseAssignedUserRolesOperation caseAssignedUserRolesOperation;\n+\n+    @Autowired\n+    public CaseAssignedUserRolesController(UIDService caseReferenceService,\n+                                           @Qualifier(\"authorised\") CaseAssignedUserRolesOperation caseAssignedUserRolesOperation) {\n+        this.caseReferenceService = caseReferenceService;\n+        this.caseAssignedUserRolesOperation = caseAssignedUserRolesOperation;\n+    }\n+\n+    @GetMapping(\n+        path = \"/case-users\",\n+        produces = {\n+            V2.MediaType.CASE_USER_ROLES\n+        }\n+    )\n+    @ApiOperation(\n+        value = \"Retrieve Case user roles by Case ID and User ID\"\n+    )\n+    @ApiResponses({\n+        @ApiResponse(\n+            code = 200,\n+            message = \"Case-User-Role assignments returned successfully\",\n+            response = CaseAssignedUserRolesResource.class\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.CASE_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.EMPTY_CASE_ID_LIST\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.USER_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 403,\n+            message = V2.Error.OTHER_USER_CASE_ROLE_ACCESS_NOT_GRANTED\n+        )\n+    })\n+    // TODO: 01/06/2020  add LogAudit\n+    public ResponseEntity<CaseAssignedUserRolesResource> getCaseUserRoles(@RequestParam(\"case_ids\") String caseIds,\n+                                                                          @RequestParam(value = \"user_ids\", required = false) String userIds) {\n+        List<String> listUserIds = convertToList(userIds);\n+        List<String> listCaseIds = convertToList(caseIds);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0NzQ2OA=="}, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDI3MjQ1OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo1MDoxMlrOGfkAcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo1MDoxMlrOGfkAcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0ODk3OQ==", "bodyText": "This throws an Exception upon the first issue it encounters. However, all validation issues should be reported at once.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435748979", "createdAt": "2020-06-05T07:50:12Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package uk.gov.hmcts.ccd.v2.external.controller;\n+\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiResponse;\n+import io.swagger.annotations.ApiResponses;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.domain.service.cauroles.CaseAssignedUserRolesOperation;\n+import uk.gov.hmcts.ccd.domain.service.common.UIDService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.BadRequestException;\n+import uk.gov.hmcts.ccd.v2.V2;\n+import uk.gov.hmcts.ccd.v2.external.resource.CaseAssignedUserRolesResource;\n+\n+@RestController\n+@RequestMapping(path = \"/\")\n+public class CaseAssignedUserRolesController {\n+\n+    private final UIDService caseReferenceService;\n+    private final CaseAssignedUserRolesOperation caseAssignedUserRolesOperation;\n+\n+    @Autowired\n+    public CaseAssignedUserRolesController(UIDService caseReferenceService,\n+                                           @Qualifier(\"authorised\") CaseAssignedUserRolesOperation caseAssignedUserRolesOperation) {\n+        this.caseReferenceService = caseReferenceService;\n+        this.caseAssignedUserRolesOperation = caseAssignedUserRolesOperation;\n+    }\n+\n+    @GetMapping(\n+        path = \"/case-users\",\n+        produces = {\n+            V2.MediaType.CASE_USER_ROLES\n+        }\n+    )\n+    @ApiOperation(\n+        value = \"Retrieve Case user roles by Case ID and User ID\"\n+    )\n+    @ApiResponses({\n+        @ApiResponse(\n+            code = 200,\n+            message = \"Case-User-Role assignments returned successfully\",\n+            response = CaseAssignedUserRolesResource.class\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.CASE_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.EMPTY_CASE_ID_LIST\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.USER_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 403,\n+            message = V2.Error.OTHER_USER_CASE_ROLE_ACCESS_NOT_GRANTED\n+        )\n+    })\n+    // TODO: 01/06/2020  add LogAudit\n+    public ResponseEntity<CaseAssignedUserRolesResource> getCaseUserRoles(@RequestParam(\"case_ids\") String caseIds,\n+                                                                          @RequestParam(value = \"user_ids\", required = false) String userIds) {\n+        List<String> listUserIds = convertToList(userIds);\n+        List<String> listCaseIds = convertToList(caseIds);\n+        validateRequestParams(listCaseIds, listUserIds);\n+\n+        List<CaseAssignedUserRole> caseAssignedUserRoles = this.caseAssignedUserRolesOperation.findCaseUserRoles(listCaseIds\n+            .stream()\n+            .map(caseId -> Long.valueOf(caseId))\n+            .collect(Collectors.toCollection(ArrayList::new)), listUserIds);\n+        return ResponseEntity.ok(new CaseAssignedUserRolesResource(caseIds, userIds, caseAssignedUserRoles));\n+    }\n+\n+    private List<String> convertToList(String ids) {\n+        return ids == null ? Collections.EMPTY_LIST : Arrays.asList(ids.split(\",\"));\n+    }\n+\n+    private void validateRequestParams(List<String> caseIds, List<String> userIds) {\n+        if (caseIds.isEmpty()) {\n+            throw new BadRequestException(V2.Error.EMPTY_CASE_ID_LIST);\n+        }\n+\n+        caseIds.forEach(caseId -> {\n+            if (!caseReferenceService.validateUID(caseId)) {\n+                throw new BadRequestException(V2.Error.CASE_ID_INVALID);\n+            }\n+        });\n+\n+        userIds.forEach(userId -> {\n+            if (StringUtils.isAllBlank(userId)) {\n+                throw new BadRequestException(V2.Error.USER_ID_INVALID);\n+            }\n+        });\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 106}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDI3NjI2OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/resource/CaseAssignedUserRolesResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo1MToyOFrOGfkC1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMDo0Mjo0NlrOGfpj7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0OTU4OA==", "bodyText": "no hateoas links for now, pls.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435749588", "createdAt": "2020-06-05T07:51:28Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/resource/CaseAssignedUserRolesResource.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package uk.gov.hmcts.ccd.v2.external.resource;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import java.util.List;\n+import lombok.Data;\n+import lombok.EqualsAndHashCode;\n+import lombok.NoArgsConstructor;\n+import lombok.NonNull;\n+import org.springframework.hateoas.RepresentationModel;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.v2.external.controller.CaseAssignedUserRolesController;\n+\n+import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.linkTo;\n+import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.methodOn;\n+\n+@Data\n+@EqualsAndHashCode(callSuper = true)\n+@NoArgsConstructor\n+public class CaseAssignedUserRolesResource extends RepresentationModel {\n+\n+    @JsonProperty(\"case-users\")\n+    private List<CaseAssignedUserRole> caseAssignedUserRoles;\n+\n+    public CaseAssignedUserRolesResource(@NonNull String caseIds, String userIds, List<CaseAssignedUserRole> caseAssignedUserRoles) {\n+        this.caseAssignedUserRoles = caseAssignedUserRoles;\n+        add(linkTo(methodOn(CaseAssignedUserRolesController.class).getCaseUserRoles(caseIds, userIds)).withSelfRel());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgzOTk4MA==", "bodyText": "removed", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435839980", "createdAt": "2020-06-05T10:42:46Z", "author": {"login": "kiran-yenigala-hmcts"}, "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/resource/CaseAssignedUserRolesResource.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package uk.gov.hmcts.ccd.v2.external.resource;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import java.util.List;\n+import lombok.Data;\n+import lombok.EqualsAndHashCode;\n+import lombok.NoArgsConstructor;\n+import lombok.NonNull;\n+import org.springframework.hateoas.RepresentationModel;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.v2.external.controller.CaseAssignedUserRolesController;\n+\n+import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.linkTo;\n+import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.methodOn;\n+\n+@Data\n+@EqualsAndHashCode(callSuper = true)\n+@NoArgsConstructor\n+public class CaseAssignedUserRolesResource extends RepresentationModel {\n+\n+    @JsonProperty(\"case-users\")\n+    private List<CaseAssignedUserRole> caseAssignedUserRoles;\n+\n+    public CaseAssignedUserRolesResource(@NonNull String caseIds, String userIds, List<CaseAssignedUserRole> caseAssignedUserRoles) {\n+        this.caseAssignedUserRoles = caseAssignedUserRoles;\n+        add(linkTo(methodOn(CaseAssignedUserRolesController.class).getCaseUserRoles(caseIds, userIds)).withSelfRel());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0OTU4OA=="}, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNTE1MTg1OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/cauroles/rolevalidator/DefaultCaseAssignedUserRoleValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzo1MjozOFrOGhLGHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzo1MjozOFrOGhLGHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzNzk4Mw==", "bodyText": "what is the user's own id is repeated twice?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r437437983", "createdAt": "2020-06-09T13:52:38Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/cauroles/rolevalidator/DefaultCaseAssignedUserRoleValidator.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package uk.gov.hmcts.ccd.domain.service.cauroles.rolevalidator;\n+\n+import java.util.List;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.data.user.CachedUserRepository;\n+import uk.gov.hmcts.ccd.data.user.UserRepository;\n+\n+@Service\n+@Qualifier(\"default\")\n+public class DefaultCaseAssignedUserRoleValidator implements CaseAssignedUserRoleValidator {\n+\n+    private final String roleCaseWorkerCaa = \"caseworker-caa\";\n+\n+    private UserRepository userRepository;\n+\n+    @Autowired\n+    public DefaultCaseAssignedUserRoleValidator(@Qualifier(CachedUserRepository.QUALIFIER) final UserRepository userRepository) {\n+        this.userRepository = userRepository;\n+    }\n+\n+    public boolean canAccessUserCaseRoles(List<String> userIds) {\n+        boolean canAccess = this.userRepository.getUserRoles().contains(roleCaseWorkerCaa);\n+        if (!canAccess) {\n+            canAccess = userIds.size() == 1 && userIds.contains(this.userRepository.getUserId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08277234d2515d9588ce47195eb01aa9db4250be"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNTE2MjM1OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzo1NDowN1rOGhLMyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNDowMDo1MlrOGhLk4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzOTY5MA==", "bodyText": "This should be Get Case-Assigned Users and Roles. That is the operation's well-known name in all other references.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r437439690", "createdAt": "2020-06-09T13:54:07Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package uk.gov.hmcts.ccd.v2.external.controller;\n+\n+import com.google.common.collect.Lists;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiResponse;\n+import io.swagger.annotations.ApiResponses;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.domain.service.cauroles.CaseAssignedUserRolesOperation;\n+import uk.gov.hmcts.ccd.domain.service.common.UIDService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.BadRequestException;\n+import uk.gov.hmcts.ccd.v2.V2;\n+import uk.gov.hmcts.ccd.v2.external.resource.CaseAssignedUserRolesResource;\n+\n+@RestController\n+@RequestMapping(path = \"/\")\n+public class CaseAssignedUserRolesController {\n+\n+    private final UIDService caseReferenceService;\n+    private final CaseAssignedUserRolesOperation caseAssignedUserRolesOperation;\n+\n+    @Autowired\n+    public CaseAssignedUserRolesController(UIDService caseReferenceService,\n+                                           @Qualifier(\"authorised\") CaseAssignedUserRolesOperation caseAssignedUserRolesOperation) {\n+        this.caseReferenceService = caseReferenceService;\n+        this.caseAssignedUserRolesOperation = caseAssignedUserRolesOperation;\n+    }\n+\n+    @GetMapping(\n+        path = \"/case-users\"\n+    )\n+    @ApiOperation(\n+        value = \"Retrieve Case user roles by Case ID and User ID\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08277234d2515d9588ce47195eb01aa9db4250be"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0NTg1OQ==", "bodyText": "Changed this", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r437445859", "createdAt": "2020-06-09T14:00:52Z", "author": {"login": "kiran-yenigala-hmcts"}, "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package uk.gov.hmcts.ccd.v2.external.controller;\n+\n+import com.google.common.collect.Lists;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiResponse;\n+import io.swagger.annotations.ApiResponses;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.domain.service.cauroles.CaseAssignedUserRolesOperation;\n+import uk.gov.hmcts.ccd.domain.service.common.UIDService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.BadRequestException;\n+import uk.gov.hmcts.ccd.v2.V2;\n+import uk.gov.hmcts.ccd.v2.external.resource.CaseAssignedUserRolesResource;\n+\n+@RestController\n+@RequestMapping(path = \"/\")\n+public class CaseAssignedUserRolesController {\n+\n+    private final UIDService caseReferenceService;\n+    private final CaseAssignedUserRolesOperation caseAssignedUserRolesOperation;\n+\n+    @Autowired\n+    public CaseAssignedUserRolesController(UIDService caseReferenceService,\n+                                           @Qualifier(\"authorised\") CaseAssignedUserRolesOperation caseAssignedUserRolesOperation) {\n+        this.caseReferenceService = caseReferenceService;\n+        this.caseAssignedUserRolesOperation = caseAssignedUserRolesOperation;\n+    }\n+\n+    @GetMapping(\n+        path = \"/case-users\"\n+    )\n+    @ApiOperation(\n+        value = \"Retrieve Case user roles by Case ID and User ID\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzOTY5MA=="}, "originalCommit": {"oid": "08277234d2515d9588ce47195eb01aa9db4250be"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3854, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}