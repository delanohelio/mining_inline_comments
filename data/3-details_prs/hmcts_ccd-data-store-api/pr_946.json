{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NTI4OTQ0", "number": 946, "title": "RDM-8382: Allow configuring an event specific default value for a com\u2026", "bodyText": "RDM-8382: Allow configuring an event specific default value for a complex type subfield\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8382] (https://tools.hmcts.net/jira/browse/RDM-8382).\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 Allow configuring an event specific default value for a complex type subfield", "createdAt": "2020-05-18T14:11:42Z", "url": "https://github.com/hmcts/ccd-data-store-api/pull/946", "merged": true, "mergeCommit": {"oid": "11969496f9c21607e69c235e17b3f2e857026377"}, "closed": true, "closedAt": "2020-06-16T15:03:31Z", "author": {"login": "Thor-tech-of-metal"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcigeeCgH2gAyNDE5NTI4OTQ0OjNjMDA5NmJkMzhkYTMxZDFlODRhNGY5NTE0NGZjNmUzMzVjNTM5YjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr1nZ1AH2gAyNDE5NTI4OTQ0OmNjYjQwODdiZTQyODA5ODhlYjg0YmE4NDc5ZGM2YzYwMjhlOGJjY2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3c0096bd38da31d1e84a4f95144fc6e335c539b1", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/3c0096bd38da31d1e84a4f95144fc6e335c539b1", "committedDate": "2020-05-18T14:09:45Z", "message": "RDM-8382: Allow configuring an event specific default value for a complex type subfield\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8382] (https://tools.hmcts.net/jira/browse/RDM-8382).\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 Allow configuring an event specific default value for a complex type subfield"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f23ed374a5abfe4440cb51519f05b95fc727ec1", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/1f23ed374a5abfe4440cb51519f05b95fc727ec1", "committedDate": "2020-05-27T15:33:13Z", "message": "RDM-8382: Allow configuring an event specific default value for a complex type subfield\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8382] (https://tools.hmcts.net/jira/browse/RDM-8382).\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 Allow configuring an event specific default value for a complex type subfield"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e145cd8ef54e58c1650e86f74297d87094db174", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/8e145cd8ef54e58c1650e86f74297d87094db174", "committedDate": "2020-06-01T09:52:28Z", "message": "Merge branch 'develop' of https://github.com/hmcts/ccd-data-store-api into RDM-8382"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "761ceaf5c8ce1c94c92cc3093aade831583801e4", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/761ceaf5c8ce1c94c92cc3093aade831583801e4", "committedDate": "2020-06-01T13:25:50Z", "message": "Merge branch 'develop' of https://github.com/hmcts/ccd-data-store-api into RDM-8382"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b2c21b6669f71719425886743de481960857054", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/9b2c21b6669f71719425886743de481960857054", "committedDate": "2020-06-01T14:00:27Z", "message": "RDM-8001: CCD-data-Store -Fix CVEs general and straight forward changes\n\n    \u00a0\u00a0[RDM-8001] (https://tools.hmcts.net/jira/browse/RDM-8001).\n    CCD-data-Store -Fix CVEs general and straight forward changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMzgyNzIy", "url": "https://github.com/hmcts/ccd-data-store-api/pull/946#pullrequestreview-423382722", "createdAt": "2020-06-03T09:35:04Z", "commit": {"oid": "9b2c21b6669f71719425886743de481960857054"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOTozNTowNFrOGeT8Pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOTozNTowNFrOGeT8Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQzNzE4Mw==", "bodyText": "better use the standard object mapper in the related utils class", "url": "https://github.com/hmcts/ccd-data-store-api/pull/946#discussion_r434437183", "createdAt": "2020-06-03T09:35:04Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -43,9 +53,54 @@\n         }\n         content.setData(fieldProcessorService.processData(content.getData(), caseTypeDefinition, content.getEventId()));\n         caseTypeService.validateData(content.getData(), caseTypeDefinition);\n+\n+        validateOrganisationPolicy(caseTypeId, content);\n         return content.getData();\n     }\n \n+    private void validateOrganisationPolicy(String caseTypeId, CaseDataContent content) {\n+        final Optional<String> defaultValue = getOrganisationPolicyDefaultRoleValue(content);\n+        // if there is not a default value. it means that there will not be organisation policy validation.\n+        if (!defaultValue.isPresent()) {\n+            return;\n+        }\n+\n+        caseDefinitionRepository.getCaseType(caseTypeId).getEvents().stream().filter(\n+            event -> event.getId().equals(content.getEventId())\n+        ).forEach(\n+            caseEventDefinition ->  caseEventDefinition.getCaseFields().stream().forEach(\n+                caseField -> caseField.getCaseEventFieldComplexDefinitions().stream().filter(\n+                    caseEventFieldComplexDefinition -> {\n+                        if (caseEventFieldComplexDefinition.getReference().equals(ORGANISATION_POLICY_ROLE)) {\n+                            return validateOrgPolicyCaseAssignedRole(caseEventFieldComplexDefinition, defaultValue.get());\n+                        } else {\n+                            return false;\n+                        }\n+                    }\n+                ).collect(Collectors.toList()))\n+        );\n+    }\n+\n+    private Optional<String> getOrganisationPolicyDefaultRoleValue(final CaseDataContent content) {\n+\n+        final JsonNode existingDat  = new ObjectMapper().convertValue(content.getData(), JsonNode.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b2c21b6669f71719425886743de481960857054"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMzgzOTUw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/946#pullrequestreview-423383950", "createdAt": "2020-06-03T09:36:37Z", "commit": {"oid": "9b2c21b6669f71719425886743de481960857054"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOTozNjozN1rOGeUACg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOTozNjozN1rOGeUACg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQzODE1NA==", "bodyText": "there may be many default values!", "url": "https://github.com/hmcts/ccd-data-store-api/pull/946#discussion_r434438154", "createdAt": "2020-06-03T09:36:37Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -43,9 +53,54 @@\n         }\n         content.setData(fieldProcessorService.processData(content.getData(), caseTypeDefinition, content.getEventId()));\n         caseTypeService.validateData(content.getData(), caseTypeDefinition);\n+\n+        validateOrganisationPolicy(caseTypeId, content);\n         return content.getData();\n     }\n \n+    private void validateOrganisationPolicy(String caseTypeId, CaseDataContent content) {\n+        final Optional<String> defaultValue = getOrganisationPolicyDefaultRoleValue(content);\n+        // if there is not a default value. it means that there will not be organisation policy validation.\n+        if (!defaultValue.isPresent()) {\n+            return;\n+        }\n+\n+        caseDefinitionRepository.getCaseType(caseTypeId).getEvents().stream().filter(\n+            event -> event.getId().equals(content.getEventId())\n+        ).forEach(\n+            caseEventDefinition ->  caseEventDefinition.getCaseFields().stream().forEach(\n+                caseField -> caseField.getCaseEventFieldComplexDefinitions().stream().filter(\n+                    caseEventFieldComplexDefinition -> {\n+                        if (caseEventFieldComplexDefinition.getReference().equals(ORGANISATION_POLICY_ROLE)) {\n+                            return validateOrgPolicyCaseAssignedRole(caseEventFieldComplexDefinition, defaultValue.get());\n+                        } else {\n+                            return false;\n+                        }\n+                    }\n+                ).collect(Collectors.toList()))\n+        );\n+    }\n+\n+    private Optional<String> getOrganisationPolicyDefaultRoleValue(final CaseDataContent content) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b2c21b6669f71719425886743de481960857054"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMzg0NDQx", "url": "https://github.com/hmcts/ccd-data-store-api/pull/946#pullrequestreview-423384441", "createdAt": "2020-06-03T09:37:14Z", "commit": {"oid": "9b2c21b6669f71719425886743de481960857054"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOTozNzoxNFrOGeUBlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOTozNzoxNFrOGeUBlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQzODU0OQ==", "bodyText": "what is multiple node are there?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/946#discussion_r434438549", "createdAt": "2020-06-03T09:37:14Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -43,9 +53,54 @@\n         }\n         content.setData(fieldProcessorService.processData(content.getData(), caseTypeDefinition, content.getEventId()));\n         caseTypeService.validateData(content.getData(), caseTypeDefinition);\n+\n+        validateOrganisationPolicy(caseTypeId, content);\n         return content.getData();\n     }\n \n+    private void validateOrganisationPolicy(String caseTypeId, CaseDataContent content) {\n+        final Optional<String> defaultValue = getOrganisationPolicyDefaultRoleValue(content);\n+        // if there is not a default value. it means that there will not be organisation policy validation.\n+        if (!defaultValue.isPresent()) {\n+            return;\n+        }\n+\n+        caseDefinitionRepository.getCaseType(caseTypeId).getEvents().stream().filter(\n+            event -> event.getId().equals(content.getEventId())\n+        ).forEach(\n+            caseEventDefinition ->  caseEventDefinition.getCaseFields().stream().forEach(\n+                caseField -> caseField.getCaseEventFieldComplexDefinitions().stream().filter(\n+                    caseEventFieldComplexDefinition -> {\n+                        if (caseEventFieldComplexDefinition.getReference().equals(ORGANISATION_POLICY_ROLE)) {\n+                            return validateOrgPolicyCaseAssignedRole(caseEventFieldComplexDefinition, defaultValue.get());\n+                        } else {\n+                            return false;\n+                        }\n+                    }\n+                ).collect(Collectors.toList()))\n+        );\n+    }\n+\n+    private Optional<String> getOrganisationPolicyDefaultRoleValue(final CaseDataContent content) {\n+\n+        final JsonNode existingDat  = new ObjectMapper().convertValue(content.getData(), JsonNode.class);\n+        final List<JsonNode> jsonNode = existingDat.findParents(ORGANISATION_POLICY_ROLE);\n+        final  Optional<JsonNode> node = jsonNode.stream().findFirst();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b2c21b6669f71719425886743de481960857054"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMzg1NTY3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/946#pullrequestreview-423385567", "createdAt": "2020-06-03T09:38:35Z", "commit": {"oid": "9b2c21b6669f71719425886743de481960857054"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5301486dc4ceb47f55292bccc87fd8a1251f26ae", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/5301486dc4ceb47f55292bccc87fd8a1251f26ae", "committedDate": "2020-06-05T10:38:14Z", "message": "RDM-8382: Allow configuring an event specific default value for a complex type subfield\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8382] (https://tools.hmcts.net/jira/browse/RDM-8382).\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 Allow configuring an event specific default value for a complex type subfield"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db6312d3fc14ac75b9bdf2c087b781e698c569a1", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/db6312d3fc14ac75b9bdf2c087b781e698c569a1", "committedDate": "2020-06-05T13:26:23Z", "message": "RDM-8382: Allow configuring an event specific default value for a complex type subfield\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8382] (https://tools.hmcts.net/jira/browse/RDM-8382).\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 Allow configuring an event specific default value for a complex type subfield"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fb3760aa3200006c16452838b2d07a733cd2697", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/7fb3760aa3200006c16452838b2d07a733cd2697", "committedDate": "2020-06-05T13:35:24Z", "message": "Merge branch 'develop' of https://github.com/hmcts/ccd-data-store-api into RDM-8382"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1267168daaac49574dfbd278447de09f04f34fc", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/a1267168daaac49574dfbd278447de09f04f34fc", "committedDate": "2020-06-05T15:16:51Z", "message": "RDM-8001: CCD-data-Store -Fix CVEs general and straight forward changes\n\n    \u00a0\u00a0[RDM-8001] (https://tools.hmcts.net/jira/browse/RDM-8001).\n    CCD-data-Store -Fix CVEs general and straight forward changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6be44934118c6529a8f40a9ab700927447bf6421", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/6be44934118c6529a8f40a9ab700927447bf6421", "committedDate": "2020-06-05T15:18:19Z", "message": "RDM-8382: Allow configuring an event specific default value for a complex type subfield\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8382] (https://tools.hmcts.net/jira/browse/RDM-8382).\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 Allow configuring an event specific default value for a complex type subfield"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MDQyNzYx", "url": "https://github.com/hmcts/ccd-data-store-api/pull/946#pullrequestreview-427042761", "createdAt": "2020-06-09T11:25:44Z", "commit": {"oid": "6be44934118c6529a8f40a9ab700927447bf6421"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0236bfc50d4b00fbf81048b6480f2ea3edfa0f6d", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/0236bfc50d4b00fbf81048b6480f2ea3edfa0f6d", "committedDate": "2020-06-09T14:55:52Z", "message": "RDM-8382: Allow configuring an event specific default value for a complex type subfield\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8382] (https://tools.hmcts.net/jira/browse/RDM-8382).\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 Allow configuring an event specific default value for a complex type subfield"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44133bdc7a4d8bb9e1a2ebb844a8d944011a7eb8", "author": {"user": {"login": "Olawale", "name": "Olawale Olanrewaju"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/44133bdc7a4d8bb9e1a2ebb844a8d944011a7eb8", "committedDate": "2020-06-12T15:39:31Z", "message": "Fixed scenario test data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ccfe0c16f1ed8244f235d01687404381a4ee3d7", "author": {"user": {"login": "MSancaktutar", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/4ccfe0c16f1ed8244f235d01687404381a4ee3d7", "committedDate": "2020-06-16T11:02:09Z", "message": "Update dependency-check-suppressions.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "534ff89d6b4356a6aa0f71e093e1bb0f00d9bfdf", "author": {"user": {"login": "MSancaktutar", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/534ff89d6b4356a6aa0f71e093e1bb0f00d9bfdf", "committedDate": "2020-06-16T11:05:48Z", "message": "Merge branch 'develop' into RDM-8382"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9d79061157208555491d20fcd0fd63d05adfe99", "author": {"user": {"login": "MSancaktutar", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/c9d79061157208555491d20fcd0fd63d05adfe99", "committedDate": "2020-06-16T12:11:04Z", "message": "introduce use of composite keys for unordered equivalence checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a25fb335eb90060f624e6337c06f5a54da93299f", "author": {"user": {"login": "MSancaktutar", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/a25fb335eb90060f624e6337c06f5a54da93299f", "committedDate": "2020-06-16T12:39:00Z", "message": "Merge pull request #977 from hmcts/RDM-8759\n\nintroduce use of composite keys for unordered equivalence checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccb4087be4280988eb84ba8479dc6c6028e8bccb", "author": {"user": {"login": "MSancaktutar", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/ccb4087be4280988eb84ba8479dc6c6028e8bccb", "committedDate": "2020-06-16T13:52:50Z", "message": "tell the fw the collection is not ordered"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2968, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}