{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwMjQxMzQy", "number": 827, "title": "RDM-7667 fix NPE when hidden field in a collection", "bodyText": "JIRA link (if applicable)\nRDM-7667\nChange description\nFix NullPointerException when a complex type is used inside a collection which contains a hidden field that is either a complex type or a collection.\nFix NullPointerException when a nested complex type is used inside a collection and the child complex type data is being hidden.\nSolution: Adjust delete permission check on complex type so it verifies delete permission on current node prior to checking children (i.e. so it can safely skip children if data is legitimately null).\nSolution: Adjust delete permission check on complex type to filter nulls in the same way it currently filters empty nodes.\nDoes this PR introduce a breaking change? (check one with \"x\")\n[ ] Yes\n[x] No", "createdAt": "2020-02-26T13:05:56Z", "url": "https://github.com/hmcts/ccd-data-store-api/pull/827", "merged": true, "mergeCommit": {"oid": "f5e04b60fb2adb2f5b9c1445e6a25c944b99fa93"}, "closed": true, "closedAt": "2020-03-06T09:06:43Z", "author": {"login": "mattnayler"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIGWBxAH2gAyMzgwMjQxMzQyOmNmNjBiODg0NzEyYTQ2ZjhmNmVjNWRiOWUwZDZlMTdkZmY5M2RiMjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKoPWxAH2gAyMzgwMjQxMzQyOjJkNjJiNjdlNTE1YjAwYzA3M2VmODRhMDY2OTI1MTQ2YTVkODJmODM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cf60b884712a46f8f6ec5db9e0d6e17dff93db21", "author": {"user": {"login": "mattnayler", "name": "Matt Nayler"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/cf60b884712a46f8f6ec5db9e0d6e17dff93db21", "committedDate": "2020-02-26T13:00:58Z", "message": "RDM-7667 fix NPE when hidden field in a collection\n\n   [RDM-7667](https://tools.hmcts.net/jira/browse/RDM-7667)\n\nFix NullPointerException when a complex type is used inside a collection\nwhich contains a hidden field that is either a complex type or a\ncollecton."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0ODk1NTc4", "url": "https://github.com/hmcts/ccd-data-store-api/pull/827#pullrequestreview-364895578", "createdAt": "2020-02-26T13:28:48Z", "commit": {"oid": "cf60b884712a46f8f6ec5db9e0d6e17dff93db21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMzoyODo0OVrOFurdXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMzoyODo0OVrOFurdXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ5MDg0NA==", "bodyText": "This if getting too complicated. Let's move these null checks into a separate private method:\nif (field.isCompoundFieldType() && notNulls(existingNode, newNode, field.getId()) && ....)", "url": "https://github.com/hmcts/ccd-data-store-api/pull/827#discussion_r384490844", "createdAt": "2020-02-26T13:28:49Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/CompoundAccessControlService.java", "diffHunk": "@@ -133,7 +133,9 @@ private boolean isCurrentNodeOrAnyChildNodeDeletedWithoutAccess(final JsonNode n\n         if (correspondingNewNode.isPresent()) {\n             JsonNode newNode = correspondingNewNode.get();\n             for (CaseField field : caseField.getFieldType().getCollectionFieldType().getComplexFields()) {\n-                if (field.isCompoundFieldType() && existingNode.get(VALUE) != null && existingNode.get(VALUE).get(field.getId()) != null\n+                if (field.isCompoundFieldType()\n+                    && existingNode.get(VALUE) != null && existingNode.get(VALUE).get(field.getId()) != null\n+                    && newNode.get(VALUE) != null && newNode.get(VALUE).get(field.getId()) != null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf60b884712a46f8f6ec5db9e0d6e17dff93db21"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0ODk1Nzky", "url": "https://github.com/hmcts/ccd-data-store-api/pull/827#pullrequestreview-364895792", "createdAt": "2020-02-26T13:29:07Z", "commit": {"oid": "cf60b884712a46f8f6ec5db9e0d6e17dff93db21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMzoyOTowN1rOFurd8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMzoyOTowN1rOFurd8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ5MDk5NA==", "bodyText": "Unit Tests?\nIntegration Tests?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/827#discussion_r384490994", "createdAt": "2020-02-26T13:29:07Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/CompoundAccessControlService.java", "diffHunk": "@@ -133,7 +133,9 @@ private boolean isCurrentNodeOrAnyChildNodeDeletedWithoutAccess(final JsonNode n\n         if (correspondingNewNode.isPresent()) {\n             JsonNode newNode = correspondingNewNode.get();\n             for (CaseField field : caseField.getFieldType().getCollectionFieldType().getComplexFields()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf60b884712a46f8f6ec5db9e0d6e17dff93db21"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a8ae2715065c4977cd9dd94848e9206a8fdf649", "author": {"user": {"login": "mattnayler", "name": "Matt Nayler"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/9a8ae2715065c4977cd9dd94848e9206a8fdf649", "committedDate": "2020-02-27T11:44:55Z", "message": "Revert \"RDM-7667 fix NPE when hidden field in a collection\"\n\nThis reverts commit cf60b884712a46f8f6ec5db9e0d6e17dff93db21."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "615339ef52802b83b64761686e1e690879dba357", "author": {"user": {"login": "mattnayler", "name": "Matt Nayler"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/615339ef52802b83b64761686e1e690879dba357", "committedDate": "2020-02-27T12:44:23Z", "message": "RDM-7667 fix NPE when hidden complex in collection\n\n   [RDM-7667](https://tools.hmcts.net/jira/browse/RDM-7667)\n\nFix NullPointerException when a nested complex type is used inside a\ncollection and the child complex type data is being hidden.\n\nSolution: Adjust delete permission check on complex type so it verifies\ndelete permission on current node prior to checking children (i.e. so it\ncan safely skip children if data is legitimately null)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b49979c93959c6f6cabe5be624f5f237961c6404", "author": {"user": {"login": "mattnayler", "name": "Matt Nayler"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/b49979c93959c6f6cabe5be624f5f237961c6404", "committedDate": "2020-02-27T14:11:14Z", "message": "Revert \"RDM-7667 fix NPE when hidden complex in collection\"\n\nThis reverts commit 615339ef52802b83b64761686e1e690879dba357."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6274a4b9da18dc75b689f4027515ef849231d38d", "author": {"user": {"login": "mattnayler", "name": "Matt Nayler"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/6274a4b9da18dc75b689f4027515ef849231d38d", "committedDate": "2020-02-27T15:00:17Z", "message": "RDM-7667 fix NPE when hidden complex in collection\n\n   [RDM-7667](https://tools.hmcts.net/jira/browse/RDM-7667)\n\nFix NullPointerException when a nested complex type is used inside a\ncollection and the child complex type data is being hidden.\n\nSolution: Adjust delete permission check on complex type to filter nulls\nin the same way it currently filters empty nodes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b15957ec344cd9a34170d9093e203ecd22095f9", "author": {"user": {"login": "mattnayler", "name": "Matt Nayler"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/8b15957ec344cd9a34170d9093e203ecd22095f9", "committedDate": "2020-02-27T17:10:13Z", "message": "RDM-7667 add tests to improve Condition Coverage\n\n   [RDM-7667](https://tools.hmcts.net/jira/browse/RDM-7667)\n\nAdd extra tests to improve Condition Coverage on updated code to allow\npass of SonarQube gateway."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MjM4MzM5", "url": "https://github.com/hmcts/ccd-data-store-api/pull/827#pullrequestreview-366238339", "createdAt": "2020-02-28T08:50:04Z", "commit": {"oid": "8b15957ec344cd9a34170d9093e203ecd22095f9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5732bf13313bb5b1daded8f434c6dbf82c11c42", "author": {"user": {"login": "veeresha-hmcts", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/e5732bf13313bb5b1daded8f434c6dbf82c11c42", "committedDate": "2020-03-02T09:46:51Z", "message": "Merge branch 'master' into RDM-7667"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cd1586b22640615d46fb7475d0a6b1f739ad4a5", "author": {"user": {"login": "veeresha-hmcts", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/8cd1586b22640615d46fb7475d0a6b1f739ad4a5", "committedDate": "2020-03-03T11:18:36Z", "message": "Merge branch 'master' into RDM-7667"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d62b67e515b00c073ef84a066925146a5d82f83", "author": {"user": {"login": "veeresha-hmcts", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/2d62b67e515b00c073ef84a066925146a5d82f83", "committedDate": "2020-03-05T09:38:18Z", "message": "Merge branch 'master' into RDM-7667"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2605, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}