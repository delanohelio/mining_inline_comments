{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5Mzg4ODMz", "number": 1014, "reviewThreads": {"totalCount": 44, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxMDoyMVrOEOs_Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzoyOTo1NFrOEQTREg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODUyNjQyOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxMDoyMVrOGx_-yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxMDoyMVrOGx_-yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4MTY3Mg==", "bodyText": "Let's move this method into the existing class CaseTypeService. And have the controller delegate to it\nThe method could be called: getCaseTypesAccordingToIDAMRoles", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455081672", "createdAt": "2020-07-15T14:10:21Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;\n+    }\n+\n+    private List<String> getCaseTypes() {\n+        final List<String> roles = userService.getUserRolesJurisdictions();\n+        return caseDefinitionRepository.getAllCaseTypesByJurisdictions(roles).get();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODUzODMxOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxMzowOFrOGyAGbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxMzowOFrOGyAGbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4MzYzMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean isAConsolidationQuery(List<String> caseTypeIds) {\n          \n          \n            \n                private boolean isAllCaseTypeRequest(List<String> caseTypeIds) {", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455083631", "createdAt": "2020-07-15T14:13:08Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;\n+    }\n+\n+    private List<String> getCaseTypes() {\n+        final List<String> roles = userService.getUserRolesJurisdictions();\n+        return caseDefinitionRepository.getAllCaseTypesByJurisdictions(roles).get();\n+    }\n+\n+    private boolean isAConsolidationQuery(List<String> caseTypeIds) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODU0OTc0OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxNTozNlrOGyANdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxNTozNlrOGyANdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4NTQzMA==", "bodyText": "wonder whether it's a good practice leaving the parameter type as a List now that * is a possible value.\nWonder whether it's more correct to change it to a String and then parse the string.\nUndecided. Let's discuss about it", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455085430", "createdAt": "2020-07-15T14:15:36Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODU1MzU3OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxNjoyNlrOGyAP2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwOTo0ODozMlrOGzMxdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4NjA0MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final List<String> roles = userService.getUserRolesJurisdictions();\n          \n          \n            \n                    final List<String> jurisdictions = userService.getUserRolesJurisdictions();", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455086041", "createdAt": "2020-07-15T14:16:26Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;\n+    }\n+\n+    private List<String> getCaseTypes() {\n+        final List<String> roles = userService.getUserRolesJurisdictions();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMzOTgzMQ==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456339831", "createdAt": "2020-07-17T09:48:32Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;\n+    }\n+\n+    private List<String> getCaseTypes() {\n+        final List<String> roles = userService.getUserRolesJurisdictions();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4NjA0MQ=="}, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODU2NDAzOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxODozMlrOGyAWPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwOTo1MDoyNFrOGzM1Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4NzY3Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return ElasticsearchRequest.SOURCE_WILDCARD.equals(caseTypeIds.get(0));\n          \n          \n            \n                    return ElasticsearchRequest.ANY_CASE_TYPE.equals(caseTypeIds.get(0));", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455087677", "createdAt": "2020-07-15T14:18:32Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;\n+    }\n+\n+    private List<String> getCaseTypes() {\n+        final List<String> roles = userService.getUserRolesJurisdictions();\n+        return caseDefinitionRepository.getAllCaseTypesByJurisdictions(roles).get();\n+    }\n+\n+    private boolean isAConsolidationQuery(List<String> caseTypeIds) {\n+        return ElasticsearchRequest.SOURCE_WILDCARD.equals(caseTypeIds.get(0));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY4NzM5OQ==", "bodyText": "I think some other name would be better - maybe just WILDCARD? The constant was already being used as a possible value that can be used inside _source, so it now has two completely separate uses.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455687399", "createdAt": "2020-07-16T10:30:05Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;\n+    }\n+\n+    private List<String> getCaseTypes() {\n+        final List<String> roles = userService.getUserRolesJurisdictions();\n+        return caseDefinitionRepository.getAllCaseTypesByJurisdictions(roles).get();\n+    }\n+\n+    private boolean isAConsolidationQuery(List<String> caseTypeIds) {\n+        return ElasticsearchRequest.SOURCE_WILDCARD.equals(caseTypeIds.get(0));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4NzY3Nw=="}, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc3MzA0MQ==", "bodyText": "ok for me", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455773041", "createdAt": "2020-07-16T13:10:05Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;\n+    }\n+\n+    private List<String> getCaseTypes() {\n+        final List<String> roles = userService.getUserRolesJurisdictions();\n+        return caseDefinitionRepository.getAllCaseTypesByJurisdictions(roles).get();\n+    }\n+\n+    private boolean isAConsolidationQuery(List<String> caseTypeIds) {\n+        return ElasticsearchRequest.SOURCE_WILDCARD.equals(caseTypeIds.get(0));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4NzY3Nw=="}, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM0MDgwNw==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456340807", "createdAt": "2020-07-17T09:50:24Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;\n+    }\n+\n+    private List<String> getCaseTypes() {\n+        final List<String> roles = userService.getUserRolesJurisdictions();\n+        return caseDefinitionRepository.getAllCaseTypesByJurisdictions(roles).get();\n+    }\n+\n+    private boolean isAConsolidationQuery(List<String> caseTypeIds) {\n+        return ElasticsearchRequest.SOURCE_WILDCARD.equals(caseTypeIds.get(0));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4NzY3Nw=="}, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODU3MjYwOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMDoyNFrOGyAbyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwOTo1MjowMVrOGzM4cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4OTA5OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .withConsolidationQuery(isAConsolidationQuery(caseTypeIds))\n          \n          \n            \n                        .withAnyCaseTypeRequest(isAllCaseTypeRequest(caseTypeIds))", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455089098", "createdAt": "2020-07-15T14:20:24Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -67,8 +86,9 @@ public CaseSearchResult searchCases(\n         ElasticsearchRequest elasticsearchRequest = elasticsearchQueryHelper.validateAndConvertRequest(jsonSearchRequest);\n \n         CrossCaseTypeSearchRequest request = new CrossCaseTypeSearchRequest.Builder()\n-            .withCaseTypes(caseTypeIds)\n+            .withCaseTypes(getCaseTypeIds(caseTypeIds))\n             .withSearchRequest(elasticsearchRequest)\n+            .withConsolidationQuery(isAConsolidationQuery(caseTypeIds))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM0MTYxNw==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456341617", "createdAt": "2020-07-17T09:52:01Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -67,8 +86,9 @@ public CaseSearchResult searchCases(\n         ElasticsearchRequest elasticsearchRequest = elasticsearchQueryHelper.validateAndConvertRequest(jsonSearchRequest);\n \n         CrossCaseTypeSearchRequest request = new CrossCaseTypeSearchRequest.Builder()\n-            .withCaseTypes(caseTypeIds)\n+            .withCaseTypes(getCaseTypeIds(caseTypeIds))\n             .withSearchRequest(elasticsearchRequest)\n+            .withConsolidationQuery(isAConsolidationQuery(caseTypeIds))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4OTA5OA=="}, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODU4MDM3OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CachedCaseDefinitionRepository.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMjowNVrOGyAgow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwOTo1Mjo0OVrOGzM6FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MDMzOQ==", "bodyText": "please remove", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455090339", "createdAt": "2020-07-15T14:22:05Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CachedCaseDefinitionRepository.java", "diffHunk": "@@ -91,11 +92,17 @@ public JurisdictionDefinition getJurisdiction(String jurisdictionId) {\n         return caseDefinitionRepository.getJurisdiction(jurisdictionId);\n     }\n \n+    @Override\n+    public Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds) {\n+        return caseDefinitionRepository.getAllCaseTypesByJurisdictions(jurisdictionIds);\n+    }\n+\n     @Override\n     public List<FieldTypeDefinition> getBaseTypes() {\n         return baseTypes.computeIfAbsent(\"baseTypes\", e -> caseDefinitionRepository.getBaseTypes());\n     }\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM0MjAzNg==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456342036", "createdAt": "2020-07-17T09:52:49Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CachedCaseDefinitionRepository.java", "diffHunk": "@@ -91,11 +92,17 @@ public JurisdictionDefinition getJurisdiction(String jurisdictionId) {\n         return caseDefinitionRepository.getJurisdiction(jurisdictionId);\n     }\n \n+    @Override\n+    public Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds) {\n+        return caseDefinitionRepository.getAllCaseTypesByJurisdictions(jurisdictionIds);\n+    }\n+\n     @Override\n     public List<FieldTypeDefinition> getBaseTypes() {\n         return baseTypes.computeIfAbsent(\"baseTypes\", e -> caseDefinitionRepository.getBaseTypes());\n     }\n \n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MDMzOQ=="}, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODU4MjUyOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CaseDefinitionRepository.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMjozM1rOGyAiEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwOTo1NDo0N1rOGzM92Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MDcwNg==", "bodyText": "No need to use Optional with lists. Just have it return an empty list in case of no results. The client code is going to be much simpler.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455090706", "createdAt": "2020-07-15T14:22:33Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CaseDefinitionRepository.java", "diffHunk": "@@ -24,4 +25,6 @@\n \n     JurisdictionDefinition getJurisdiction(String jurisdictionId);\n \n+    Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM0MzAwMQ==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456343001", "createdAt": "2020-07-17T09:54:47Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CaseDefinitionRepository.java", "diffHunk": "@@ -24,4 +25,6 @@\n \n     JurisdictionDefinition getJurisdiction(String jurisdictionId);\n \n+    Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MDcwNg=="}, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODU4MzU1OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CaseDefinitionRepository.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMjo0OFrOGyAiug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwOTo1NjoxNVrOGzNA5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MDg3NA==", "bodyText": "please remove this blank line", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455090874", "createdAt": "2020-07-15T14:22:48Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CaseDefinitionRepository.java", "diffHunk": "@@ -24,4 +25,6 @@\n \n     JurisdictionDefinition getJurisdiction(String jurisdictionId);\n \n+    Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM0Mzc4Mw==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456343783", "createdAt": "2020-07-17T09:56:15Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CaseDefinitionRepository.java", "diffHunk": "@@ -24,4 +25,6 @@\n \n     JurisdictionDefinition getJurisdiction(String jurisdictionId);\n \n+    Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds);\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MDg3NA=="}, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODU4NzA4OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CaseDefinitionRepository.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMzozNlrOGyAlAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMDowNzo1N1rOGzNYhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MTQ1Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds);\n          \n          \n            \n                Optional<List<String>> getCaseTypesIDsByJurisdictions(List<String> jurisdictionIds);", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455091456", "createdAt": "2020-07-15T14:23:36Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CaseDefinitionRepository.java", "diffHunk": "@@ -24,4 +25,6 @@\n \n     JurisdictionDefinition getJurisdiction(String jurisdictionId);\n \n+    Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM0OTgyOA==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456349828", "createdAt": "2020-07-17T10:07:57Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CaseDefinitionRepository.java", "diffHunk": "@@ -24,4 +25,6 @@\n \n     JurisdictionDefinition getJurisdiction(String jurisdictionId);\n \n+    Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MTQ1Ng=="}, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODYyMTc3OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozMDoyMlrOGyA6nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMDowODo1NVrOGzNaKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5Njk4OA==", "bodyText": "can you change you IDE to remove automatic adding final please and remove it here and the other places", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455096988", "createdAt": "2020-07-15T14:30:22Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +216,24 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds) {\n+\n+        final List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1MDI1MA==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456350250", "createdAt": "2020-07-17T10:08:55Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +216,24 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds) {\n+\n+        final List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5Njk4OA=="}, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODYzMTIzOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozMjoxMlrOGyBAcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMDoxMzoxOFrOGzNiMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5ODQ4MA==", "bodyText": "why just not return the empty list?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455098480", "createdAt": "2020-07-15T14:32:12Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +216,24 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds) {\n+\n+        final List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"No values found Retrieving jurisdiction object(s) from definition store for all Jurisdiction.\");\n+            Optional.of(Arrays.asList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1MjMwNQ==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456352305", "createdAt": "2020-07-17T10:13:18Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +216,24 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds) {\n+\n+        final List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"No values found Retrieving jurisdiction object(s) from definition store for all Jurisdiction.\");\n+            Optional.of(Arrays.asList());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5ODQ4MA=="}, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODYzODk3OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozMzo1NlrOGyBFVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMDoxMzo1M1rOGzNjJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5OTczMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOG.warn(\"No values found Retrieving jurisdiction object(s) from definition store for all Jurisdiction.\");\n          \n          \n            \n                        LOG.warn(\"Definitions not found for requested jurisdictions {}\", jurisdictionIds);", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455099733", "createdAt": "2020-07-15T14:33:56Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +216,24 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds) {\n+\n+        final List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"No values found Retrieving jurisdiction object(s) from definition store for all Jurisdiction.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1MjU0OA==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456352548", "createdAt": "2020-07-17T10:13:53Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +216,24 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds) {\n+\n+        final List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"No values found Retrieving jurisdiction object(s) from definition store for all Jurisdiction.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5OTczMw=="}, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODY0OTk1OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseTypesResults.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozNjoxNlrOGyBMIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMDoxNTowMVrOGzNlNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwMTQ3Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @JsonProperty(\"case_field_id\")\n          \n          \n            \n                @JsonProperty(\"case_type_id\")", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455101472", "createdAt": "2020-07-15T14:36:16Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseTypesResults.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package uk.gov.hmcts.ccd.domain.model.search;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class CaseTypesResults {\n+\n+    @JsonProperty(\"case_field_id\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1MzA3Nw==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456353077", "createdAt": "2020-07-17T10:15:01Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseTypesResults.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package uk.gov.hmcts.ccd.domain.model.search;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class CaseTypesResults {\n+\n+    @JsonProperty(\"case_field_id\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwMTQ3Mg=="}, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODY1MTYzOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseTypesResults.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozNjozOVrOGyBNIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMDoxNTo1NFrOGzNm6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwMTczMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public CaseTypesResults(String caseFieldId, long numberOfMatchedCases) {\n          \n          \n            \n                public CaseTypesResults(String caseTypeId, long total) {", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455101731", "createdAt": "2020-07-15T14:36:39Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseTypesResults.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package uk.gov.hmcts.ccd.domain.model.search;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class CaseTypesResults {\n+\n+    @JsonProperty(\"case_field_id\")\n+    private final String caseTypeId;\n+    private final long total;\n+\n+    public CaseTypesResults(String caseFieldId, long numberOfMatchedCases) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1MzUxMw==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456353513", "createdAt": "2020-07-17T10:15:54Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseTypesResults.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package uk.gov.hmcts.ccd.domain.model.search;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class CaseTypesResults {\n+\n+    @JsonProperty(\"case_field_id\")\n+    private final String caseTypeId;\n+    private final long total;\n+\n+    public CaseTypesResults(String caseFieldId, long numberOfMatchedCases) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwMTczMQ=="}, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODY1NjUwOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/CrossCaseTypeSearchRequest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozNzo0NFrOGyBQQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMzowODo1MVrOGzSU0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwMjUzMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean consolidationQuery;\n          \n          \n            \n                private boolean isAnyCaseRequest;\n          \n      \n    \n    \n  \n\nplease also update in other parts of the class accordingly", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455102531", "createdAt": "2020-07-15T14:37:44Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/CrossCaseTypeSearchRequest.java", "diffHunk": "@@ -43,13 +44,15 @@\n     private final ElasticsearchRequest elasticsearchRequest;\n     private final boolean multiCaseTypeSearch;\n     private final List<String> aliasFields = new ArrayList<>();\n+    private boolean consolidationQuery;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc3MjA1Mw==", "bodyText": "Furthermore, is this new property still needed? I can't see it used", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455772053", "createdAt": "2020-07-16T13:08:38Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/CrossCaseTypeSearchRequest.java", "diffHunk": "@@ -43,13 +44,15 @@\n     private final ElasticsearchRequest elasticsearchRequest;\n     private final boolean multiCaseTypeSearch;\n     private final List<String> aliasFields = new ArrayList<>();\n+    private boolean consolidationQuery;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwMjUzMQ=="}, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMDgwMw==", "bodyText": "DONE removed.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456430803", "createdAt": "2020-07-17T13:08:51Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/CrossCaseTypeSearchRequest.java", "diffHunk": "@@ -43,13 +44,15 @@\n     private final ElasticsearchRequest elasticsearchRequest;\n     private final boolean multiCaseTypeSearch;\n     private final List<String> aliasFields = new ArrayList<>();\n+    private boolean consolidationQuery;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwMjUzMQ=="}, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODY3ODA3OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/CrossCaseTypeSearchRequest.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo0MjozMFrOGyBd4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNDozMzoxM1rOGzVYig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwNjAxNg==", "bodyText": "not sure I understand this. When _source is not false we want to addMetadataSourceFields right?\nBut with these changes the current code is not doing that", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455106016", "createdAt": "2020-07-15T14:42:30Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/CrossCaseTypeSearchRequest.java", "diffHunk": "@@ -84,8 +87,15 @@ public boolean hasAliasField(SearchAliasField searchAliasField) {\n         return aliasFields.stream().anyMatch(aliasField -> aliasField.equalsIgnoreCase(searchAliasField.getId()));\n     }\n \n+    public boolean isConsolidationQuery() {\n+        return consolidationQuery;\n+    }\n+\n     private void addMetadataSourceFields() {\n         if (elasticsearchRequest.hasSource()) {\n+            if (elasticsearchRequest.getSource() instanceof BooleanNode) {\n+                return;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwOTI2NQ==", "bodyText": "I think this logic (once corrected) could be better placed inside the elasticsearchRequest.hasSource() method. And rename that method to something more suitable, perhaps\nelasticsearchRequest.hasSourceFields()\nthe method hasSourceFields() will then check if _source=false and in that case return false. This way the metadata fields will not be added when _source=false", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455109265", "createdAt": "2020-07-15T14:46:53Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/CrossCaseTypeSearchRequest.java", "diffHunk": "@@ -84,8 +87,15 @@ public boolean hasAliasField(SearchAliasField searchAliasField) {\n         return aliasFields.stream().anyMatch(aliasField -> aliasField.equalsIgnoreCase(searchAliasField.getId()));\n     }\n \n+    public boolean isConsolidationQuery() {\n+        return consolidationQuery;\n+    }\n+\n     private void addMetadataSourceFields() {\n         if (elasticsearchRequest.hasSource()) {\n+            if (elasticsearchRequest.getSource() instanceof BooleanNode) {\n+                return;\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwNjAxNg=="}, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1NjgwOA==", "bodyText": "The original code is doing custom manipulation on source assuming that source is always an Array[].  If the source = false (valid elastic query) will generate a Runtime Exception.    Bug in dev.    The if statement allows the current implementation to accept source = false and let elasticsearch to processes it . Nicer implementation can be done. we will discuss later.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456356808", "createdAt": "2020-07-17T10:23:02Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/CrossCaseTypeSearchRequest.java", "diffHunk": "@@ -84,8 +87,15 @@ public boolean hasAliasField(SearchAliasField searchAliasField) {\n         return aliasFields.stream().anyMatch(aliasField -> aliasField.equalsIgnoreCase(searchAliasField.getId()));\n     }\n \n+    public boolean isConsolidationQuery() {\n+        return consolidationQuery;\n+    }\n+\n     private void addMetadataSourceFields() {\n         if (elasticsearchRequest.hasSource()) {\n+            if (elasticsearchRequest.getSource() instanceof BooleanNode) {\n+                return;\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwNjAxNg=="}, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ4MDkwNg==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456480906", "createdAt": "2020-07-17T14:33:13Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/CrossCaseTypeSearchRequest.java", "diffHunk": "@@ -84,8 +87,15 @@ public boolean hasAliasField(SearchAliasField searchAliasField) {\n         return aliasFields.stream().anyMatch(aliasField -> aliasField.equalsIgnoreCase(searchAliasField.getId()));\n     }\n \n+    public boolean isConsolidationQuery() {\n+        return consolidationQuery;\n+    }\n+\n     private void addMetadataSourceFields() {\n         if (elasticsearchRequest.hasSource()) {\n+            if (elasticsearchRequest.getSource() instanceof BooleanNode) {\n+                return;\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwNjAxNg=="}, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODcxNTAwOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo1MDoxM1rOGyB1AA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMDoyNTo0NVrOGzN4fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTExMTkzNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final List<CaseTypesResults> caseFieldsAggregations = new ArrayList<>();\n          \n          \n            \n                    final List<CaseTypesResults> caseTypesResults = new ArrayList<>();", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455111936", "createdAt": "2020-07-15T14:50:13Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -95,8 +96,10 @@ private Search createSecuredSearch(String caseTypeId, JsonNode searchRequestJson\n             .build();\n     }\n \n-    private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearchResult) {\n-        List<CaseDetails> caseDetails = new ArrayList<>();\n+    private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearchResult,\n+                                                       CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+        final List<CaseDetails> caseDetails = new ArrayList<>();\n+        final List<CaseTypesResults> caseFieldsAggregations = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1ODAxNQ==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456358015", "createdAt": "2020-07-17T10:25:45Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -95,8 +96,10 @@ private Search createSecuredSearch(String caseTypeId, JsonNode searchRequestJson\n             .build();\n     }\n \n-    private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearchResult) {\n-        List<CaseDetails> caseDetails = new ArrayList<>();\n+    private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearchResult,\n+                                                       CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+        final List<CaseDetails> caseDetails = new ArrayList<>();\n+        final List<CaseTypesResults> caseFieldsAggregations = new ArrayList<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTExMTkzNg=="}, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODcyNTQxOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo1MjowMlrOGyB7YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMDoyNzoxNVrOGzN7MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTExMzU2OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n          \n          \n            \n                            buildCaseTypesResults(response, caseTypesResults, crossCaseTypeSearchRequest);", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455113568", "createdAt": "2020-07-15T14:52:02Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1ODcwNA==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456358704", "createdAt": "2020-07-17T10:27:15Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTExMzU2OA=="}, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODgzNDgyOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNToxNTowMFrOGyC_wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNToxNTowMFrOGyC_wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEzMTA3Mw==", "bodyText": "Important, but only If we have time now to do this\nI'm afraid this class has reached the max size limit. We can't keep adding more code to it it's already way too complex.\nCan you please introduce a new class ElasticsearchCaseSearchResponseGenerator with a method buildCaseDetailsSearchResult and move all the response generation code in there", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455131073", "createdAt": "2020-07-15T15:15:00Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -62,7 +63,7 @@ public ElasticsearchCaseSearchOperation(JestClient jestClient,\n     public CaseSearchResult execute(CrossCaseTypeSearchRequest request) {\n         MultiSearchResult result = search(request);\n         if (result.isSucceeded()) {\n-            return toCaseDetailsSearchResult(result);\n+            return toCaseDetailsSearchResult(result, request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MTk0NDMxOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODozNToyNVrOGygybw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMDoyODo0OFrOGzN-Wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxOTE4Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private String getNameFromIndex(final String index, List<String> caseTypeIds) {\n          \n          \n            \n                private String getCaseTypeIDFromIndex(final String index, List<String> caseTypeIds) {", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455619183", "createdAt": "2020-07-16T08:35:25Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseFieldsAggregations, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseFieldsAggregations(\n+        final MultiSearchResult.MultiSearchResponse response,\n+        final List<CaseTypesResults> caseFieldsAggregations,\n+        final CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0) {\n+\n+            final String indexName = response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+                .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+\n+            caseFieldsAggregations.add(new CaseTypesResults(getNameFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getNameFromIndex(final String index, List<String> caseTypeIds) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1OTUxNA==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456359514", "createdAt": "2020-07-17T10:28:48Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseFieldsAggregations, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseFieldsAggregations(\n+        final MultiSearchResult.MultiSearchResponse response,\n+        final List<CaseTypesResults> caseFieldsAggregations,\n+        final CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0) {\n+\n+            final String indexName = response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+                .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+\n+            caseFieldsAggregations.add(new CaseTypesResults(getNameFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getNameFromIndex(final String index, List<String> caseTypeIds) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxOTE4Mw=="}, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MTk1Mjk0OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODozNzo0OFrOGyg3ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMDoyOToyMVrOGzN_MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyMDUzOA==", "bodyText": "what about if the client has IDAM role caseworker-caa and request is ctid=*?\nIn that case the search needs to happen on any existing case type, because caseworker-caa can access all the case types", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455620538", "createdAt": "2020-07-16T08:37:48Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1OTcyOQ==", "bodyText": "This feature has been implemented now.  DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456359729", "createdAt": "2020-07-17T10:29:21Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyMDUzOA=="}, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MjMxMDU3OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseTypesResults.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMDoxMDoyM1rOGykTdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMDozMDozOVrOGzOBeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY3Njc4OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class CaseTypesResults {\n          \n          \n            \n            public class CaseTypeResults {\n          \n      \n    \n    \n  \n\nsingular", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455676789", "createdAt": "2020-07-16T10:10:23Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseTypesResults.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package uk.gov.hmcts.ccd.domain.model.search;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class CaseTypesResults {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2MDMxMw==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456360313", "createdAt": "2020-07-17T10:30:39Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseTypesResults.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package uk.gov.hmcts.ccd.domain.model.search;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class CaseTypesResults {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY3Njc4OQ=="}, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MjM4NzA0OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMDozMjo0NVrOGylCkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMzo1MDo0MFrOGzTz2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY4ODg0OQ==", "bodyText": "Maybe we should use the search.cases.index.name.format property to determine what to remove instead, since technically it is configurable.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455688849", "createdAt": "2020-07-16T10:32:45Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseFieldsAggregations, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseFieldsAggregations(\n+        final MultiSearchResult.MultiSearchResponse response,\n+        final List<CaseTypesResults> caseFieldsAggregations,\n+        final CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0) {\n+\n+            final String indexName = response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+                .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+\n+            caseFieldsAggregations.add(new CaseTypesResults(getNameFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getNameFromIndex(final String index, List<String> caseTypeIds) {\n+        final String caseTypeIdFromIndex = index.substring(0, index.indexOf(\"_cases\")).replaceAll(\"\\\"\", \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b02d66b501bddb7014098eac2de46cd5e83ed770"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ1NTEyOA==", "bodyText": "DONE : search.cases.index.name.format=${ELASTIC_SEARCH_CASE_INDEX_NAME_FORMAT:%s_cases}  does not give me _case directly. But I will remove the % .", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456455128", "createdAt": "2020-07-17T13:50:40Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseFieldsAggregations, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseFieldsAggregations(\n+        final MultiSearchResult.MultiSearchResponse response,\n+        final List<CaseTypesResults> caseFieldsAggregations,\n+        final CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0) {\n+\n+            final String indexName = response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+                .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+\n+            caseFieldsAggregations.add(new CaseTypesResults(getNameFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getNameFromIndex(final String index, List<String> caseTypeIds) {\n+        final String caseTypeIdFromIndex = index.substring(0, index.indexOf(\"_cases\")).replaceAll(\"\\\"\", \"\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY4ODg0OQ=="}, "originalCommit": {"oid": "b02d66b501bddb7014098eac2de46cd5e83ed770"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0Mjg0OTQ2OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMjo1MDo1OVrOGypc3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMDozNzo0MVrOGzON9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc2MTExOA==", "bodyText": "this code is difficult to read and quickly understand. Please add an utility method with a nice name in MultiSearchResult.MultiSearchResponse", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455761118", "createdAt": "2020-07-16T12:50:59Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseFieldsAggregations, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseFieldsAggregations(\n+        final MultiSearchResult.MultiSearchResponse response,\n+        final List<CaseTypesResults> caseFieldsAggregations,\n+        final CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0) {\n+\n+            final String indexName = response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+                .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b02d66b501bddb7014098eac2de46cd5e83ed770"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2MzUwOA==", "bodyText": "As per conversation MultiSearchResult.MultiSearchResponse is part of the framework. However getIndexName() method has been created.  DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456363508", "createdAt": "2020-07-17T10:37:41Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseFieldsAggregations, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseFieldsAggregations(\n+        final MultiSearchResult.MultiSearchResponse response,\n+        final List<CaseTypesResults> caseFieldsAggregations,\n+        final CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0) {\n+\n+            final String indexName = response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+                .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc2MTExOA=="}, "originalCommit": {"oid": "b02d66b501bddb7014098eac2de46cd5e83ed770"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0Mjg1MzQ5OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMjo1MjowM1rOGypfSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMDozODoyMFrOGzOPBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc2MTczOA==", "bodyText": "this code is difficult to read and quickly understand. Please add an utility method with a nice name in MultiSearchResult.MultiSearchResponse", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455761738", "createdAt": "2020-07-16T12:52:03Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseFieldsAggregations, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseFieldsAggregations(\n+        final MultiSearchResult.MultiSearchResponse response,\n+        final List<CaseTypesResults> caseFieldsAggregations,\n+        final CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b02d66b501bddb7014098eac2de46cd5e83ed770"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMxNTMyOA==", "bodyText": "can we call it hitsIsNotEmpty please", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456315328", "createdAt": "2020-07-17T09:00:56Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseFieldsAggregations, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseFieldsAggregations(\n+        final MultiSearchResult.MultiSearchResponse response,\n+        final List<CaseTypesResults> caseFieldsAggregations,\n+        final CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc2MTczOA=="}, "originalCommit": {"oid": "b02d66b501bddb7014098eac2de46cd5e83ed770"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2Mzc4MQ==", "bodyText": "As per conversation MultiSearchResult.MultiSearchResponse is part of the framework. However hitsIsNotEmpty() method has been created.  DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456363781", "createdAt": "2020-07-17T10:38:20Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseFieldsAggregations, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseFieldsAggregations(\n+        final MultiSearchResult.MultiSearchResponse response,\n+        final List<CaseTypesResults> caseFieldsAggregations,\n+        final CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc2MTczOA=="}, "originalCommit": {"oid": "b02d66b501bddb7014098eac2de46cd5e83ed770"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0Njk5MjI2OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMjoxMzowOFrOGzQoCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMzozNDoyMlrOGzTNzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwMjk1Mw==", "bodyText": "can you update the Swagger documentation as well with:\n@ApiParam(value = \"Comma separated list of case type ID(s) or '*' if the search should be applied on any existing case type. Note that using '*' is an expensive operation and might have low response times so always prefer explicitly listing the case types when known in advance\", required = true)", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456402953", "createdAt": "2020-07-17T12:13:08Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -36,12 +51,21 @@\n \n     private final CaseSearchOperation caseSearchOperation;\n     private final ElasticsearchQueryHelper elasticsearchQueryHelper;\n+    private final CaseDefinitionRepository caseDefinitionRepository;\n+    private final UserRepository userRepository;\n+    private final ApplicationParams applicationParams;\n \n     @Autowired\n     public CaseSearchEndpoint(@Qualifier(AuthorisedCaseSearchOperation.QUALIFIER) CaseSearchOperation caseSearchOperation,\n-                              ElasticsearchQueryHelper elasticsearchQueryHelper) {\n+                              @Qualifier(CachedCaseDefinitionRepository.QUALIFIER) CaseDefinitionRepository caseDefinitionRepository,\n+                              @Qualifier(DefaultUserRepository.QUALIFIER)  UserRepository userRepository,\n+                              ElasticsearchQueryHelper elasticsearchQueryHelper,\n+                              ApplicationParams applicationParams) {\n         this.caseSearchOperation = caseSearchOperation;\n         this.elasticsearchQueryHelper = elasticsearchQueryHelper;\n+        this.caseDefinitionRepository = caseDefinitionRepository;\n+        this.userRepository = userRepository;\n+        this.applicationParams = applicationParams;\n     }\n \n     @PostMapping(value = \"/searchCases\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a99094e23177c34cf70c086bfc1e7bc46ae3f524"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0NTM4OQ==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456445389", "createdAt": "2020-07-17T13:34:22Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -36,12 +51,21 @@\n \n     private final CaseSearchOperation caseSearchOperation;\n     private final ElasticsearchQueryHelper elasticsearchQueryHelper;\n+    private final CaseDefinitionRepository caseDefinitionRepository;\n+    private final UserRepository userRepository;\n+    private final ApplicationParams applicationParams;\n \n     @Autowired\n     public CaseSearchEndpoint(@Qualifier(AuthorisedCaseSearchOperation.QUALIFIER) CaseSearchOperation caseSearchOperation,\n-                              ElasticsearchQueryHelper elasticsearchQueryHelper) {\n+                              @Qualifier(CachedCaseDefinitionRepository.QUALIFIER) CaseDefinitionRepository caseDefinitionRepository,\n+                              @Qualifier(DefaultUserRepository.QUALIFIER)  UserRepository userRepository,\n+                              ElasticsearchQueryHelper elasticsearchQueryHelper,\n+                              ApplicationParams applicationParams) {\n         this.caseSearchOperation = caseSearchOperation;\n         this.elasticsearchQueryHelper = elasticsearchQueryHelper;\n+        this.caseDefinitionRepository = caseDefinitionRepository;\n+        this.userRepository = userRepository;\n+        this.applicationParams = applicationParams;\n     }\n \n     @PostMapping(value = \"/searchCases\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwMjk1Mw=="}, "originalCommit": {"oid": "a99094e23177c34cf70c086bfc1e7bc46ae3f524"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NzQ5NDY5OnYy", "diffSide": "RIGHT", "path": "build.gradle", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNDozMjoyM1rOGzVWZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNDozMjoyM1rOGzVWZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ4MDM1Ng==", "bodyText": "This should be removed from this PR  swagger2Version = '2.10.0' i should be on dev", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456480356", "createdAt": "2020-07-17T14:32:23Z", "author": {"login": "Thor-tech-of-metal"}, "path": "build.gradle", "diffHunk": "@@ -103,7 +103,7 @@ ext {\n     junitVintageVersion = '5.5.2'\n     powermockVersion = '2.0.0-beta.5'\n     reformLogging = '5.1.0'\n-    swagger2Version = '3.0.0-SNAPSHOT'\n+    swagger2Version = '2.10.0'\n     limits = [", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9caffd4ca9b32d1686e5960981f035b1c6fe844a"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MjQ1NDU4OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODowODowN1rOGz-phw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODowODowN1rOGz-phw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE1Njk5OQ==", "bodyText": "is this needed?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457156999", "createdAt": "2020-07-20T08:08:07Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +215,32 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public List<String> getCaseTypesIDsByJurisdictions(List<String> jurisdictionIds) {\n+\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"Definitions not found for requested jurisdictions {}\", jurisdictionIds);\n+            Arrays.asList();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5f99327ee20454393e44dd0c22ec9dfe90fc0a3"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MjQ4ODU4OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODoxNDo0MFrOGz-8Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODoyMDoxMlrOGz_MFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE2MTgyNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<String> caseTypes = getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);\n          \n          \n            \n                    return caseTypes;\n          \n          \n            \n                    return getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457161826", "createdAt": "2020-07-20T08:14:40Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +215,32 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public List<String> getCaseTypesIDsByJurisdictions(List<String> jurisdictionIds) {\n+\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"Definitions not found for requested jurisdictions {}\", jurisdictionIds);\n+            Arrays.asList();\n+        }\n+        List<String> caseTypes = getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);\n+        return caseTypes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5f99327ee20454393e44dd0c22ec9dfe90fc0a3"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE2NTg0Nw==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457165847", "createdAt": "2020-07-20T08:20:12Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +215,32 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public List<String> getCaseTypesIDsByJurisdictions(List<String> jurisdictionIds) {\n+\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"Definitions not found for requested jurisdictions {}\", jurisdictionIds);\n+            Arrays.asList();\n+        }\n+        List<String> caseTypes = getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);\n+        return caseTypes;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE2MTgyNg=="}, "originalCommit": {"oid": "e5f99327ee20454393e44dd0c22ec9dfe90fc0a3"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MjQ5ODU1OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODoxNjoyNlrOGz_B1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODoyMDoxNVrOGz_MPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE2MzIyMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(Arrays.asList());\n          \n          \n            \n                    List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(Collections.emptyList());", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457163222", "createdAt": "2020-07-20T08:16:26Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +215,32 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public List<String> getCaseTypesIDsByJurisdictions(List<String> jurisdictionIds) {\n+\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"Definitions not found for requested jurisdictions {}\", jurisdictionIds);\n+            return Collections.emptyList();\n+        }\n+        List<String> caseTypes = getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);\n+        return caseTypes;\n+    }\n+\n+    @Override\n+    public List<String> getAllCaseTypesIDs() {\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(Arrays.asList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "def4eee0ac7a536d85c8a23e10991568db9265cb"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE2NTg4NA==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457165884", "createdAt": "2020-07-20T08:20:15Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +215,32 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public List<String> getCaseTypesIDsByJurisdictions(List<String> jurisdictionIds) {\n+\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"Definitions not found for requested jurisdictions {}\", jurisdictionIds);\n+            return Collections.emptyList();\n+        }\n+        List<String> caseTypes = getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);\n+        return caseTypes;\n+    }\n+\n+    @Override\n+    public List<String> getAllCaseTypesIDs() {\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(Arrays.asList());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE2MzIyMg=="}, "originalCommit": {"oid": "def4eee0ac7a536d85c8a23e10991568db9265cb"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MzM5NjY2OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/CrossCaseTypeSearchRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMToyMjo1MlrOG0HBwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMToyMjo1MlrOG0HBwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzI5NDI3Mw==", "bodyText": "can you put back the formatting please", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457294273", "createdAt": "2020-07-20T11:22:52Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/CrossCaseTypeSearchRequest.java", "diffHunk": "@@ -10,29 +19,20 @@\n import static uk.gov.hmcts.ccd.data.casedetails.CaseDetailsEntity.DATA_CLASSIFICATION_COL;\n import static uk.gov.hmcts.ccd.domain.model.search.elasticsearch.ElasticsearchRequest.SOURCE;\n \n-import com.fasterxml.jackson.databind.JsonNode;\n-import com.fasterxml.jackson.databind.node.ArrayNode;\n-import com.fasterxml.jackson.databind.node.ObjectNode;\n-import com.fasterxml.jackson.databind.node.TextNode;\n-import uk.gov.hmcts.ccd.data.casedetails.search.MetaData;\n-import uk.gov.hmcts.ccd.domain.model.definition.SearchAliasField;\n-import uk.gov.hmcts.ccd.domain.model.search.elasticsearch.ElasticsearchRequest;\n-import uk.gov.hmcts.ccd.endpoint.exceptions.BadSearchRequest;\n-\n /**\n  * Sample ES json search request.\n  * {\n- *   \"_source\": [\"alias.searchField1\", \"alias.searchField2\"],\n- *   \"query\": {\n- *     \"bool\": {\n- *       \"filter\": {\n- *         \"match\": { \"state\": \"AwaitingPayment\"}\n- *       }\n- *     }\n- *   },\n- *  \"sort\": {\n- *     \"id\": { \"order\":\"asc\" }\n- *   }\n+ * \"_source\": [\"alias.searchField1\", \"alias.searchField2\"],\n+ * \"query\": {\n+ * \"bool\": {\n+ * \"filter\": {\n+ * \"match\": { \"state\": \"AwaitingPayment\"}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20cc6cc2e209d9194fa255c33c33e2590b826458"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MzQ1NzM3OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/security/AuthorisedCaseSearchOperation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMTozNzozMVrOG0HkiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMTozNzozMVrOG0HkiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMwMzE3Nw==", "bodyText": "no changes in this class other than the imports can you undo please", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457303177", "createdAt": "2020-07-20T11:37:31Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/security/AuthorisedCaseSearchOperation.java", "diffHunk": "@@ -36,6 +23,19 @@\n import uk.gov.hmcts.ccd.domain.service.search.elasticsearch.ElasticsearchCaseSearchOperation;\n import uk.gov.hmcts.ccd.domain.service.security.AuthorisedCaseDefinitionDataService;\n \n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.Set;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f68c936180e7835a6b8b86a571c3463ed556d49e"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MzQ3NjY3OnYy", "diffSide": "LEFT", "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMTo0MTo0OFrOG0Hvfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMTo0MTo0OFrOG0Hvfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMwNTk4Mg==", "bodyText": "replaced the wrong @ApiParam. Please put this back and replace the one at line 79 i.e.\n@ApiParam(value = \"Case type ID(s)\", required = true)", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457305982", "createdAt": "2020-07-20T11:41:48Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -54,20 +78,17 @@ public CaseSearchEndpoint(@Qualifier(AuthorisedCaseSearchOperation.QUALIFIER) Ca\n     public CaseSearchResult searchCases(\n         @ApiParam(value = \"Case type ID(s)\", required = true)\n         @RequestParam(\"ctid\") List<String> caseTypeIds,\n-        @ApiParam(value = \"Native ElasticSearch Search API request. Please refer to the ElasticSearch official \"\n-            + \"documentation. For cross case type search, \"\n-            + \"the search results will contain only metadata by default (no case field data). To get case data in the \"\n-            + \"search results, please state the alias fields to be returned in the _source property for e.g.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f68c936180e7835a6b8b86a571c3463ed556d49e"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MzYwMzc3OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMjowODo0MFrOG0I1Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwOToyOTo1N1rOG0v2-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMyMzg2Mw==", "bodyText": "Minor: We could add a getAllCaseTypes() into JurisdictionDefinition", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457323863", "createdAt": "2020-07-20T12:08:40Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,24 +215,50 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public List<String> getCaseTypesIDsByJurisdictions(List<String> jurisdictionIds) {\n+\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"Definitions not found for requested jurisdictions {}\", jurisdictionIds);\n+            return Collections.emptyList();\n+        }\n+        List<String> caseTypes = getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);\n+        return caseTypes;\n+    }\n+\n+    @Override\n+    public List<String> getAllCaseTypesIDs() {\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(Collections.emptyList());\n+        return getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);\n+    }\n+\n+    private List<String> getCaseTypeIdFromJurisdictionDefinition(List<JurisdictionDefinition> jurisdictionDefinitions) {\n+        return jurisdictionDefinitions.stream().flatMap(\n+            jurisdictionDefinition -> jurisdictionDefinition.getCaseTypeDefinitions().stream().map(\n+                caseTypeDefinition -> caseTypeDefinition.getId()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk2MzI1Nw==", "bodyText": "done", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457963257", "createdAt": "2020-07-21T09:29:57Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,24 +215,50 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public List<String> getCaseTypesIDsByJurisdictions(List<String> jurisdictionIds) {\n+\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"Definitions not found for requested jurisdictions {}\", jurisdictionIds);\n+            return Collections.emptyList();\n+        }\n+        List<String> caseTypes = getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);\n+        return caseTypes;\n+    }\n+\n+    @Override\n+    public List<String> getAllCaseTypesIDs() {\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(Collections.emptyList());\n+        return getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);\n+    }\n+\n+    private List<String> getCaseTypeIdFromJurisdictionDefinition(List<JurisdictionDefinition> jurisdictionDefinitions) {\n+        return jurisdictionDefinitions.stream().flatMap(\n+            jurisdictionDefinition -> jurisdictionDefinition.getCaseTypeDefinitions().stream().map(\n+                caseTypeDefinition -> caseTypeDefinition.getId()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMyMzg2Mw=="}, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 122}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MzYxNDc2OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseSearchResult.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMjoxMTowOVrOG0I7yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwOTo1MTowM1rOG1bOfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMyNTUxMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @JsonProperty(\"case_types_results\")\n          \n          \n            \n                @JsonProperty(\"case_type_results\")\n          \n      \n    \n    \n  \n\nOr change variable name to caseTypesResults (whichever is more appropriate for the meaning of this!)", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457325513", "createdAt": "2020-07-20T12:11:09Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseSearchResult.java", "diffHunk": "@@ -1,25 +1,38 @@\n package uk.gov.hmcts.ccd.domain.model.search;\n \n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+\n+import java.util.ArrayList;\n import java.util.List;\n \n import static java.util.Collections.emptyList;\n import static java.util.stream.Collectors.toList;\n \n-import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n-\n public class CaseSearchResult {\n-\n     public static final CaseSearchResult EMPTY = new CaseSearchResult(0L, emptyList());\n \n     private Long total;\n     private List<CaseDetails> cases;\n+    @JsonProperty(\"case_types_results\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ0MzMzOQ==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457443339", "createdAt": "2020-07-20T14:34:05Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseSearchResult.java", "diffHunk": "@@ -1,25 +1,38 @@\n package uk.gov.hmcts.ccd.domain.model.search;\n \n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+\n+import java.util.ArrayList;\n import java.util.List;\n \n import static java.util.Collections.emptyList;\n import static java.util.stream.Collectors.toList;\n \n-import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n-\n public class CaseSearchResult {\n-\n     public static final CaseSearchResult EMPTY = new CaseSearchResult(0L, emptyList());\n \n     private Long total;\n     private List<CaseDetails> cases;\n+    @JsonProperty(\"case_types_results\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMyNTUxMw=="}, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY3Mzc5MQ==", "bodyText": "we changed the variable name to caseTypesResults and we will keep case_types_results", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r458673791", "createdAt": "2020-07-22T09:51:03Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseSearchResult.java", "diffHunk": "@@ -1,25 +1,38 @@\n package uk.gov.hmcts.ccd.domain.model.search;\n \n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+\n+import java.util.ArrayList;\n import java.util.List;\n \n import static java.util.Collections.emptyList;\n import static java.util.stream.Collectors.toList;\n \n-import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n-\n public class CaseSearchResult {\n-\n     public static final CaseSearchResult EMPTY = new CaseSearchResult(0L, emptyList());\n \n     private Long total;\n     private List<CaseDetails> cases;\n+    @JsonProperty(\"case_types_results\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMyNTUxMw=="}, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MzYyNTcyOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseSearchResult.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMjoxMzozOVrOG0JCZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzo0MTozNFrOG0NKIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMyNzIwNQ==", "bodyText": "Can we remove this constructor? It looks like the same as the one on L23 except with arguments in a different order?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457327205", "createdAt": "2020-07-20T12:13:39Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseSearchResult.java", "diffHunk": "@@ -1,25 +1,38 @@\n package uk.gov.hmcts.ccd.domain.model.search;\n \n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+\n+import java.util.ArrayList;\n import java.util.List;\n \n import static java.util.Collections.emptyList;\n import static java.util.stream.Collectors.toList;\n \n-import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n-\n public class CaseSearchResult {\n-\n     public static final CaseSearchResult EMPTY = new CaseSearchResult(0L, emptyList());\n \n     private Long total;\n     private List<CaseDetails> cases;\n+    @JsonProperty(\"case_types_results\")\n+    private List<CaseTypeResults> caseTypeResults;\n \n     public CaseSearchResult() {\n     }\n \n-    public CaseSearchResult(Long total, List<CaseDetails> cases) {\n+    public CaseSearchResult(Long total, List<CaseDetails> cases, List<CaseTypeResults> caseTypeResults) {\n         this.cases = cases;\n         this.total = total;\n+        this.caseTypeResults = caseTypeResults;\n+    }\n+\n+    public CaseSearchResult(Long total, List<CaseDetails> cases) {\n+        this(total, cases, new ArrayList<>());\n+    }\n+\n+\n+    public CaseSearchResult(List<CaseTypeResults> caseTypeResults, Long total, List<CaseDetails> cases) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM5NDcyMQ==", "bodyText": "DONE.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457394721", "createdAt": "2020-07-20T13:41:34Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseSearchResult.java", "diffHunk": "@@ -1,25 +1,38 @@\n package uk.gov.hmcts.ccd.domain.model.search;\n \n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+\n+import java.util.ArrayList;\n import java.util.List;\n \n import static java.util.Collections.emptyList;\n import static java.util.stream.Collectors.toList;\n \n-import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n-\n public class CaseSearchResult {\n-\n     public static final CaseSearchResult EMPTY = new CaseSearchResult(0L, emptyList());\n \n     private Long total;\n     private List<CaseDetails> cases;\n+    @JsonProperty(\"case_types_results\")\n+    private List<CaseTypeResults> caseTypeResults;\n \n     public CaseSearchResult() {\n     }\n \n-    public CaseSearchResult(Long total, List<CaseDetails> cases) {\n+    public CaseSearchResult(Long total, List<CaseDetails> cases, List<CaseTypeResults> caseTypeResults) {\n         this.cases = cases;\n         this.total = total;\n+        this.caseTypeResults = caseTypeResults;\n+    }\n+\n+    public CaseSearchResult(Long total, List<CaseDetails> cases) {\n+        this(total, cases, new ArrayList<>());\n+    }\n+\n+\n+    public CaseSearchResult(List<CaseTypeResults> caseTypeResults, Long total, List<CaseDetails> cases) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMyNzIwNQ=="}, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MzY4ODA5OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMjoyNzoyMFrOG0JmUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNDo0MTozMVrOG0QkRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMzNjQwMg==", "bodyText": "In some places it is called caseTypeResults, others caseFieldsAggregations - not sure if there is a different meaning or just needs to be updated?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457336402", "createdAt": "2020-07-20T12:27:20Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,49 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseTypeResults, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseFieldsAggregations,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ1MDU2Ng==", "bodyText": "D O N E", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457450566", "createdAt": "2020-07-20T14:41:31Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,49 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseTypeResults, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseFieldsAggregations,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMzNjQwMg=="}, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MzY5MjAyOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMjoyODoxMlrOG0Jodg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNDozNzo0N1rOG0QWGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMzNjk1MA==", "bodyText": "hits is being used quite a lot at least in this class - introduce a constant.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457336950", "createdAt": "2020-07-20T12:28:12Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,49 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseTypeResults, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseFieldsAggregations,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);\n+            caseFieldsAggregations.add(new CaseTypeResults(getCaseTypeIDFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getIndexName(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ0NjkzNw==", "bodyText": "DONE", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457446937", "createdAt": "2020-07-20T14:37:47Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,49 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseTypeResults, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseFieldsAggregations,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);\n+            caseFieldsAggregations.add(new CaseTypeResults(getCaseTypeIDFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getIndexName(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMzNjk1MA=="}, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MzcwOTQ0OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMjozMjowM1rOG0JywQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNDoyMTozN1rOG0PY1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMzOTU4NQ==", "bodyText": "Sorry I know I suggested using the property value! I think if doing so we need to be a bit smarter though e.g. what if the property were changed to new_%s_cases, then substring wouldn't work. Something to consider!", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457339585", "createdAt": "2020-07-20T12:32:03Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,49 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseTypeResults, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseFieldsAggregations,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);\n+            caseFieldsAggregations.add(new CaseTypeResults(getCaseTypeIDFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getIndexName(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+            .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+    }\n+\n+    private boolean hitsIsNotEmpty(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0;\n+    }\n+\n+    private String getCaseTypeIDFromIndex(final String index, List<String> caseTypeIds) {\n+        String pureIndexFormat = applicationParams.getCasesIndexNameFormat().substring(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM5NjIwNg==", "bodyText": "Yes good point , but if we create a new index rule  (new_%s_cases)  that can lead in changing all indexes in CCD.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457396206", "createdAt": "2020-07-20T13:43:15Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,49 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseTypeResults, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseFieldsAggregations,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);\n+            caseFieldsAggregations.add(new CaseTypeResults(getCaseTypeIDFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getIndexName(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+            .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+    }\n+\n+    private boolean hitsIsNotEmpty(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0;\n+    }\n+\n+    private String getCaseTypeIDFromIndex(final String index, List<String> caseTypeIds) {\n+        String pureIndexFormat = applicationParams.getCasesIndexNameFormat().substring(2);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMzOTU4NQ=="}, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQzMTI1Mg==", "bodyText": "I thought the same. I'll fix this", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457431252", "createdAt": "2020-07-20T14:21:37Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,49 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseTypeResults, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseFieldsAggregations,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);\n+            caseFieldsAggregations.add(new CaseTypeResults(getCaseTypeIDFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getIndexName(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+            .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+    }\n+\n+    private boolean hitsIsNotEmpty(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0;\n+    }\n+\n+    private String getCaseTypeIDFromIndex(final String index, List<String> caseTypeIds) {\n+        String pureIndexFormat = applicationParams.getCasesIndexNameFormat().substring(2);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMzOTU4NQ=="}, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NTA3MzYyOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNjozMzowNlrOG0WLZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwOTozMDoxMVrOG0v3iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0MjUwMA==", "bodyText": "@danlysiak improved the logic to extract the case type ID. Now is basically no longer in the code, but it's in the 2 new config properties I've introduced. Those 2 properties tell where the case type id is in the index name, by using regex groups.\nLet me know if it's better now", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457542500", "createdAt": "2020-07-20T16:33:06Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +116,56 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(totalHits,caseDetails,caseTypeResults);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseTypeResults,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);\n+            caseTypeResults.add(new CaseTypeResults(getCaseTypeIDFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getIndexName(MultiSearchResult.MultiSearchResponse response) {\n+        String quotedIndexName =  response.searchResult.getJsonObject().getAsJsonObject(HITS).get(HITS)\n+            .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+        String unquotedIndexName = quotedIndexName.replaceAll(\"\\\"\", \"\");\n+        return unquotedIndexName;\n+    }\n+\n+    private boolean hitsIsNotEmpty(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(HITS).get(HITS).getAsJsonArray().size() != 0;\n+    }\n+\n+    private String getCaseTypeIDFromIndex(final String index, List<String> caseTypeIds) {\n+        String caseTypeIdGroupRegex = applicationParams.getCasesIndexNameCaseTypeIdGroup();\n+        int caseTypeIdGroupPosition = applicationParams.getCasesIndexNameCaseTypeIdGroupPosition();\n+        Pattern pattern = Pattern.compile(caseTypeIdGroupRegex);\n+        Matcher m = pattern.matcher(index);\n+        if (m.matches() && m.groupCount() > 1) {\n+            return caseTypeIds.stream().filter(\n+                caseTypeId -> caseTypeId.equalsIgnoreCase(m.group(caseTypeIdGroupPosition))\n+            ).findFirst().orElseThrow(() -> {\n+                log.error(\"Cannot match any known case type id from index '{}' extracted case type id : {}\", index, m.group(1));\n+                throw new ServiceException(\"Cannot determine case type id from ES index name - unknown extracted case type id\");\n+            });\n+        } else {\n+            log.error(\"Cannot determine case type id from index name: '{}'. No capturing group configured or capturing group not matching: '{}'.\",\n+                index, caseTypeIdGroupRegex);\n+            throw new ServiceException(\"Cannot determine case type id from ES index name - cannot extract case type id\");\n+        }\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31ec63fb2c38cbe3330625a267f3fede42118359"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU2NTg4OA==", "bodyText": "Looks good! Just a couple of small comments further below.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457565888", "createdAt": "2020-07-20T17:12:54Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +116,56 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(totalHits,caseDetails,caseTypeResults);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseTypeResults,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);\n+            caseTypeResults.add(new CaseTypeResults(getCaseTypeIDFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getIndexName(MultiSearchResult.MultiSearchResponse response) {\n+        String quotedIndexName =  response.searchResult.getJsonObject().getAsJsonObject(HITS).get(HITS)\n+            .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+        String unquotedIndexName = quotedIndexName.replaceAll(\"\\\"\", \"\");\n+        return unquotedIndexName;\n+    }\n+\n+    private boolean hitsIsNotEmpty(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(HITS).get(HITS).getAsJsonArray().size() != 0;\n+    }\n+\n+    private String getCaseTypeIDFromIndex(final String index, List<String> caseTypeIds) {\n+        String caseTypeIdGroupRegex = applicationParams.getCasesIndexNameCaseTypeIdGroup();\n+        int caseTypeIdGroupPosition = applicationParams.getCasesIndexNameCaseTypeIdGroupPosition();\n+        Pattern pattern = Pattern.compile(caseTypeIdGroupRegex);\n+        Matcher m = pattern.matcher(index);\n+        if (m.matches() && m.groupCount() > 1) {\n+            return caseTypeIds.stream().filter(\n+                caseTypeId -> caseTypeId.equalsIgnoreCase(m.group(caseTypeIdGroupPosition))\n+            ).findFirst().orElseThrow(() -> {\n+                log.error(\"Cannot match any known case type id from index '{}' extracted case type id : {}\", index, m.group(1));\n+                throw new ServiceException(\"Cannot determine case type id from ES index name - unknown extracted case type id\");\n+            });\n+        } else {\n+            log.error(\"Cannot determine case type id from index name: '{}'. No capturing group configured or capturing group not matching: '{}'.\",\n+                index, caseTypeIdGroupRegex);\n+            throw new ServiceException(\"Cannot determine case type id from ES index name - cannot extract case type id\");\n+        }\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0MjUwMA=="}, "originalCommit": {"oid": "31ec63fb2c38cbe3330625a267f3fede42118359"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk2MzQwMw==", "bodyText": "done", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457963403", "createdAt": "2020-07-21T09:30:11Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +116,56 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(totalHits,caseDetails,caseTypeResults);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseTypeResults,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);\n+            caseTypeResults.add(new CaseTypeResults(getCaseTypeIDFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getIndexName(MultiSearchResult.MultiSearchResponse response) {\n+        String quotedIndexName =  response.searchResult.getJsonObject().getAsJsonObject(HITS).get(HITS)\n+            .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+        String unquotedIndexName = quotedIndexName.replaceAll(\"\\\"\", \"\");\n+        return unquotedIndexName;\n+    }\n+\n+    private boolean hitsIsNotEmpty(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(HITS).get(HITS).getAsJsonArray().size() != 0;\n+    }\n+\n+    private String getCaseTypeIDFromIndex(final String index, List<String> caseTypeIds) {\n+        String caseTypeIdGroupRegex = applicationParams.getCasesIndexNameCaseTypeIdGroup();\n+        int caseTypeIdGroupPosition = applicationParams.getCasesIndexNameCaseTypeIdGroupPosition();\n+        Pattern pattern = Pattern.compile(caseTypeIdGroupRegex);\n+        Matcher m = pattern.matcher(index);\n+        if (m.matches() && m.groupCount() > 1) {\n+            return caseTypeIds.stream().filter(\n+                caseTypeId -> caseTypeId.equalsIgnoreCase(m.group(caseTypeIdGroupPosition))\n+            ).findFirst().orElseThrow(() -> {\n+                log.error(\"Cannot match any known case type id from index '{}' extracted case type id : {}\", index, m.group(1));\n+                throw new ServiceException(\"Cannot determine case type id from ES index name - unknown extracted case type id\");\n+            });\n+        } else {\n+            log.error(\"Cannot determine case type id from index name: '{}'. No capturing group configured or capturing group not matching: '{}'.\",\n+                index, caseTypeIdGroupRegex);\n+            throw new ServiceException(\"Cannot determine case type id from ES index name - cannot extract case type id\");\n+        }\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0MjUwMA=="}, "originalCommit": {"oid": "31ec63fb2c38cbe3330625a267f3fede42118359"}, "originalPosition": 124}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NTE4MzMwOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzowMjowM1rOG0XPRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwODoxODozM1rOG0tPOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU1OTg3OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            log.error(\"Cannot match any known case type id from index '{}' extracted case type id : {}\", index, m.group(1));\n          \n          \n            \n                            log.error(\"Cannot match any known case type id from index '{}' extracted case type id : {}\", index, m.group(caseTypeIdGroupPosition));", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457559879", "createdAt": "2020-07-20T17:02:03Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -137,25 +139,33 @@ private void buildCaseTypesResults(\n     }\n \n     private String getIndexName(MultiSearchResult.MultiSearchResponse response) {\n-        return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+        String quotedIndexName = response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n             .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+        String unquotedIndexName = quotedIndexName.replaceAll(\"\\\"\", \"\");\n+        return unquotedIndexName;\n     }\n \n     private boolean hitsIsNotEmpty(MultiSearchResult.MultiSearchResponse response) {\n         return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0;\n     }\n \n     private String getCaseTypeIDFromIndex(final String index, List<String> caseTypeIds) {\n-        String pureIndexFormat = applicationParams.getCasesIndexNameFormat().substring(2);\n-        final String caseTypeIdFromIndex = index.substring(0, index.indexOf(pureIndexFormat))\n-            .replaceAll(\"\\\"\", \"\");\n-\n-        return caseTypeIds.stream().filter(\n-            caseTypeId -> caseTypeId.equalsIgnoreCase(caseTypeIdFromIndex)\n-        ).findFirst().orElseGet(() -> {\n-            log.error(\"The Case type id could be found using the following index name: {}\", caseTypeIdFromIndex);\n-            return \"index-error\";\n-        });\n+        String caseTypeIdGroupRegex = applicationParams.getCasesIndexNameCaseTypeIdGroup();\n+        int caseTypeIdGroupPosition = applicationParams.getCasesIndexNameCaseTypeIdGroupPosition();\n+        Pattern pattern = Pattern.compile(caseTypeIdGroupRegex);\n+        Matcher m = pattern.matcher(index);\n+        if (m.matches() && m.groupCount() > 1) {\n+            return caseTypeIds.stream().filter(\n+                caseTypeId -> caseTypeId.equalsIgnoreCase(m.group(caseTypeIdGroupPosition))\n+            ).findFirst().orElseThrow(() -> {\n+                log.error(\"Cannot match any known case type id from index '{}' extracted case type id : {}\", index, m.group(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1353e4f131a94d2a9bad5535f3e3a33a409bfcb"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzkyMDMxNQ==", "bodyText": "done", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457920315", "createdAt": "2020-07-21T08:18:33Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -137,25 +139,33 @@ private void buildCaseTypesResults(\n     }\n \n     private String getIndexName(MultiSearchResult.MultiSearchResponse response) {\n-        return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+        String quotedIndexName = response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n             .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+        String unquotedIndexName = quotedIndexName.replaceAll(\"\\\"\", \"\");\n+        return unquotedIndexName;\n     }\n \n     private boolean hitsIsNotEmpty(MultiSearchResult.MultiSearchResponse response) {\n         return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0;\n     }\n \n     private String getCaseTypeIDFromIndex(final String index, List<String> caseTypeIds) {\n-        String pureIndexFormat = applicationParams.getCasesIndexNameFormat().substring(2);\n-        final String caseTypeIdFromIndex = index.substring(0, index.indexOf(pureIndexFormat))\n-            .replaceAll(\"\\\"\", \"\");\n-\n-        return caseTypeIds.stream().filter(\n-            caseTypeId -> caseTypeId.equalsIgnoreCase(caseTypeIdFromIndex)\n-        ).findFirst().orElseGet(() -> {\n-            log.error(\"The Case type id could be found using the following index name: {}\", caseTypeIdFromIndex);\n-            return \"index-error\";\n-        });\n+        String caseTypeIdGroupRegex = applicationParams.getCasesIndexNameCaseTypeIdGroup();\n+        int caseTypeIdGroupPosition = applicationParams.getCasesIndexNameCaseTypeIdGroupPosition();\n+        Pattern pattern = Pattern.compile(caseTypeIdGroupRegex);\n+        Matcher m = pattern.matcher(index);\n+        if (m.matches() && m.groupCount() > 1) {\n+            return caseTypeIds.stream().filter(\n+                caseTypeId -> caseTypeId.equalsIgnoreCase(m.group(caseTypeIdGroupPosition))\n+            ).findFirst().orElseThrow(() -> {\n+                log.error(\"Cannot match any known case type id from index '{}' extracted case type id : {}\", index, m.group(1));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU1OTg3OQ=="}, "originalCommit": {"oid": "c1353e4f131a94d2a9bad5535f3e3a33a409bfcb"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NTE5NzYzOnYy", "diffSide": "RIGHT", "path": "src/main/resources/application.properties", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzowNjoxNlrOG0XYOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwOTozMDozMlrOG0v4Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU2MjE2OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            search.cases.index.name.case-type-id.group=(.+?)(_cases.*)\n          \n          \n            \n            search.cases.index.name.case-type-id.group=(.+)(_cases.*)\n          \n      \n    \n    \n  \n\nThink we may need to let it be greedy? At the moment if any services were to use a case type such as ENGLISH_CASES then the index would be english_cases_cases... and the first capturing group would only be english.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457562168", "createdAt": "2020-07-20T17:06:16Z", "author": {"login": "danlysiak"}, "path": "src/main/resources/application.properties", "diffHunk": "@@ -141,6 +141,10 @@ search.elastic.hosts=${ELASTIC_SEARCH_HOSTS:http://localhost:9200}\n search.elastic.data.hosts=${ELASTIC_SEARCH_DATA_NODES_HOSTS:\"http://localhost:9200\"}\n search.blacklist=${ELASTIC_SEARCH_BLACKLIST:query_string}\n search.cases.index.name.format=${ELASTIC_SEARCH_CASE_INDEX_NAME_FORMAT:%s_cases}\n+#regex with a group used to identify and extract the case id from the index name\n+search.cases.index.name.case-type-id.group=(.+?)(_cases.*)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1353e4f131a94d2a9bad5535f3e3a33a409bfcb"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY0Mjc1MA==", "bodyText": "ehhhhh ... lest discuss tomorrow this one", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457642750", "createdAt": "2020-07-20T19:30:56Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/resources/application.properties", "diffHunk": "@@ -141,6 +141,10 @@ search.elastic.hosts=${ELASTIC_SEARCH_HOSTS:http://localhost:9200}\n search.elastic.data.hosts=${ELASTIC_SEARCH_DATA_NODES_HOSTS:\"http://localhost:9200\"}\n search.blacklist=${ELASTIC_SEARCH_BLACKLIST:query_string}\n search.cases.index.name.format=${ELASTIC_SEARCH_CASE_INDEX_NAME_FORMAT:%s_cases}\n+#regex with a group used to identify and extract the case id from the index name\n+search.cases.index.name.case-type-id.group=(.+?)(_cases.*)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU2MjE2OA=="}, "originalCommit": {"oid": "c1353e4f131a94d2a9bad5535f3e3a33a409bfcb"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk2MzYwNw==", "bodyText": "good catch @danlysiak . Done", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457963607", "createdAt": "2020-07-21T09:30:32Z", "author": {"login": "mario-paniccia"}, "path": "src/main/resources/application.properties", "diffHunk": "@@ -141,6 +141,10 @@ search.elastic.hosts=${ELASTIC_SEARCH_HOSTS:http://localhost:9200}\n search.elastic.data.hosts=${ELASTIC_SEARCH_DATA_NODES_HOSTS:\"http://localhost:9200\"}\n search.blacklist=${ELASTIC_SEARCH_BLACKLIST:query_string}\n search.cases.index.name.format=${ELASTIC_SEARCH_CASE_INDEX_NAME_FORMAT:%s_cases}\n+#regex with a group used to identify and extract the case id from the index name\n+search.cases.index.name.case-type-id.group=(.+?)(_cases.*)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU2MjE2OA=="}, "originalCommit": {"oid": "c1353e4f131a94d2a9bad5535f3e3a33a409bfcb"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NTI4MzM4OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzoyOTo1NFrOG0YM0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNDowMDo1OFrOG05bkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU3NTYzNQ==", "bodyText": "Been wondering about making hitsIsNotEmpty() and getIndexName() a bit more readable rather than having to search through JSON objects..\nWe could potentially use List<SearchResult.Hit<ElasticSearchCaseDetailsDTO, Void>> hits = response.searchResult.getHits(ElasticSearchCaseDetailsDTO.class); here - I think our DTO should already be suitable for that usage? Then it's much simpler:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (hitsIsNotEmpty(response)) {\n          \n          \n            \n                        String indexName = getIndexName(response);\n          \n          \n            \n                    List<SearchResult.Hit<ElasticSearchCaseDetailsDTO, Void>> hits = response.searchResult.getHits(ElasticSearchCaseDetailsDTO.class);\n          \n          \n            \n                    if (!hits.isEmpty()) {\n          \n          \n            \n                        String indexName = hits.get(0).index;\n          \n      \n    \n    \n  \n\nNot tried this out, but looks like a good alternative if it works?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457575635", "createdAt": "2020-07-20T17:29:54Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +116,56 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(totalHits,caseDetails,caseTypeResults);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseTypeResults,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31ec63fb2c38cbe3330625a267f3fede42118359"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU4NDI0Mw==", "bodyText": "Also - we are currently (and with my suggestion too) getting the index name from the first hit. If a service passes an ES query with \"size\": 0 then there won't be any hits but it can still have a total - do we always expect/are we telling services that they should always pass a size for these kinds of queries but _source = false?\nSorry if repeating things that have already been covered! I can see we'll be using _source = false in the ticket for the original business scenario, but may need to document in known limitations so services know too?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457584243", "createdAt": "2020-07-20T17:44:45Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +116,56 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(totalHits,caseDetails,caseTypeResults);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseTypeResults,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU3NTYzNQ=="}, "originalCommit": {"oid": "31ec63fb2c38cbe3330625a267f3fede42118359"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYzNjA3Mw==", "bodyText": "mmm, This is a nice  one.    May be response.searchResult.getFirstHit(SearchResult.Hit.class); will be better. As we only need  to get  1) the index 2) the size and also expect empty results . Hence its is better not force a conversion to ElasticSearchCaseDetailsDTO to evaluate attributes  from hits only.      I can test it tomorrow.  I looks possible.   Hopefully it does not break our test . As far I am remember not all our elastic  test mocks does have hits-->hits--> _source structure", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457636073", "createdAt": "2020-07-20T19:18:16Z", "author": {"login": "Thor-tech-of-metal"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +116,56 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(totalHits,caseDetails,caseTypeResults);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseTypeResults,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU3NTYzNQ=="}, "originalCommit": {"oid": "31ec63fb2c38cbe3330625a267f3fede42118359"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyMDA4Mw==", "bodyText": "Also - we are currently (and with my suggestion too) getting the index name from the first hit. If a service passes an ES query with \"size\": 0 then there won't be any hits but it can still have a total - do we always expect/are we telling services that they should always pass a size for these kinds of queries but _source = false?\nSorry if repeating things that have already been covered! I can see we'll be using _source = false in the ticket for the original business scenario, but may need to document in known limitations so services know too?\n\n@danlysiak this is a good catch. We did some testing and we found no way to overcome this. I think it's not a big deal because if they don't want case data to be returned, they can just use _source:false rather than size:0. I will document this limitation, cheers", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r458120083", "createdAt": "2020-07-21T14:00:58Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +116,56 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(totalHits,caseDetails,caseTypeResults);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseTypeResults,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU3NTYzNQ=="}, "originalCommit": {"oid": "31ec63fb2c38cbe3330625a267f3fede42118359"}, "originalPosition": 88}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3762, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}