{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3OTYzODI2", "number": 1151, "title": "RDM-9556: Data Store Changes for Conditional Event Post State", "bodyText": "JIRA link (if applicable)\nhttps://tools.hmcts.net/jira/browse/RDM-9556\nChange description\nData Store Changes for Conditional Event Post State\nDoes this PR introduce a breaking change? (check one with \"x\")\n[ X] Yes\n[ ] No", "createdAt": "2020-10-05T16:11:02Z", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151", "merged": true, "mergeCommit": {"oid": "1f93eaeb91b948ec062bc79a3ed20fe2b94fefd8"}, "closed": true, "closedAt": "2020-10-06T15:30:26Z", "author": {"login": "kiran-yenigala-hmcts"}, "timelineItems": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPljXegH2gAyNDk3OTYzODI2OjRmMzY4YmJjZmFkZDBjYmVlODViMzhhYmM4MTMxMjYxYTZlNzMyNGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQOv_ngFqTUwNDAwNzYxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4f368bbcfadd0cbee85b38abc8131261a6e7324b", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/4f368bbcfadd0cbee85b38abc8131261a6e7324b", "committedDate": "2020-10-05T15:31:13Z", "message": "RDM-9556: Post State event changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4e4b1b6920b5b5bfeb518e0f382ee62cc68de7d", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/d4e4b1b6920b5b5bfeb518e0f382ee62cc68de7d", "committedDate": "2020-10-05T15:35:23Z", "message": "Merge branch 'develop' into RDM-9556"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83086a052158ee0fbdea966d6b0c87a82fd61e40", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/83086a052158ee0fbdea966d6b0c87a82fd61e40", "committedDate": "2020-10-05T15:55:51Z", "message": "RDM-9556: Post State event changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53bf2a292df1578be6c67b0cac47ebb2e8cc8a4e", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/53bf2a292df1578be6c67b0cac47ebb2e8cc8a4e", "committedDate": "2020-10-05T22:32:16Z", "message": "RDM-9556: Post State event changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e2307622584e64cbee65f3ba66b61395426e262", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/9e2307622584e64cbee65f3ba66b61395426e262", "committedDate": "2020-10-05T22:36:19Z", "message": "RDM-9556: Post State event changes, Code Refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/8517bea5262948f518e3dc945fdb6d9b8f3d558f", "committedDate": "2020-10-06T08:10:36Z", "message": "RDM-9556: Check Style issues fixed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNzg1MDU0", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-502785054", "createdAt": "2020-10-06T10:11:28Z", "commit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMDoxMToyOFrOHc_WAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMToxNzoyMVrOHdBerQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE2MDAwMQ==", "bodyText": "Not covered by tests. 'return 0' as well.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500160001", "createdAt": "2020-10-06T10:11:28Z", "author": {"login": "rafalkalita"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/casestate/EnablingConditionSorter.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package uk.gov.hmcts.ccd.domain.casestate;\n+\n+import java.util.Comparator;\n+import java.util.List;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Component\n+public class EnablingConditionSorter {\n+\n+    public void sortEventPostStates(List<EventPostStateDefinition> eventPostStates) {\n+        if (eventPostStates != null) {\n+            eventPostStates.sort(new PostStateComparator());\n+        }\n+    }\n+\n+    private class PostStateComparator implements Comparator<EventPostStateDefinition> {\n+\n+        @Override\n+        public int compare(EventPostStateDefinition first, EventPostStateDefinition second) {\n+            if (first.getPriority() != null) {\n+                return first.getPriority().compareTo(second.getPriority());\n+            } else if (second.getPriority() != null) {\n+                return second.getPriority().compareTo(first.getPriority());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE2NDMxNg==", "bodyText": "'this' word not needed", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500164316", "createdAt": "2020-10-06T10:19:19Z", "author": {"login": "rafalkalita"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/createevent/CreateCaseEventService.java", "diffHunk": "@@ -222,8 +230,13 @@ private void mergeUpdatedFieldsToCaseDetails(final Map<String, JsonNode> data,\n                 caseDetails.getDataClassification()));\n         }\n         caseDetails.setLastModified(now());\n-        if (!StringUtils.equalsAnyIgnoreCase(CaseStateDefinition.ANY, caseEventDefinition.getPostState())) {\n-            caseDetails.setState(caseEventDefinition.getPostState());\n+        updateCaseState(caseDetails, caseEventDefinition);\n+    }\n+\n+    private void updateCaseState(CaseDetails caseDetails, CaseEventDefinition caseEventDefinition) {\n+        Optional<String> postState = this.caseStateUpdateService.retrieveCaseState(caseEventDefinition, caseDetails);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE2NDg1Mg==", "bodyText": "'this' word not needed", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500164852", "createdAt": "2020-10-06T10:20:19Z", "author": {"login": "rafalkalita"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/createevent/CreateCaseEventService.java", "diffHunk": "@@ -194,8 +201,9 @@ private CaseDetails getCaseDetails(final String caseReference) {\n     private CaseDetails saveCaseDetails(CaseDetails caseDetailsBefore, final CaseDetails caseDetails,\n                                         final CaseEventDefinition caseEventDefinition,\n                                         final Optional<String> state, LocalDateTime timeNow) {\n-        if (!state.isPresent() && !equalsIgnoreCase(CaseStateDefinition.ANY, caseEventDefinition.getPostState())) {\n-            caseDetails.setState(caseEventDefinition.getPostState());\n+\n+        if (!state.isPresent()) {\n+            this.updateCaseState(caseDetails, caseEventDefinition);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE3MzAzNQ==", "bodyText": "IDE tell me it can be simplified to: .map(list -> String.join(\".\", list))", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500173035", "createdAt": "2020-10-06T10:35:48Z", "author": {"login": "rafalkalita"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/casestate/jexl/JexlEnablingConditionParser.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package uk.gov.hmcts.ccd.domain.casestate.jexl;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.jayway.jsonpath.DocumentContext;\n+import com.jayway.jsonpath.JsonPath;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import javax.inject.Inject;\n+import org.apache.commons.jexl3.JexlBuilder;\n+import org.apache.commons.jexl3.JexlEngine;\n+import org.apache.commons.jexl3.JexlScript;\n+import org.apache.commons.jexl3.MapContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionFormatter;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionParser;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.ServiceException;\n+\n+@Component\n+@Qualifier(\"jexl\")\n+public class JexlEnablingConditionParser implements EnablingConditionParser {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(JexlEnablingConditionParser.class);\n+\n+    private final JexlEngine engine;\n+\n+    private final ObjectMapper objectMapper;\n+\n+    private EnablingConditionFormatter enablingConditionFormatter;\n+\n+    @Inject\n+    public JexlEnablingConditionParser(EnablingConditionFormatter enablingConditionFormatter) {\n+        this.enablingConditionFormatter = enablingConditionFormatter;\n+        this.engine = new JexlBuilder().create();\n+        this.objectMapper = new ObjectMapper();\n+    }\n+\n+    @Override\n+    public Boolean evaluate(String enablingCondition, Map<String, JsonNode> caseEventData) {\n+        try {\n+            String expression = this.enablingConditionFormatter.format(enablingCondition);\n+            if (expression != null) {\n+                JexlScript expressionScript = engine.createScript(expression);\n+                Map<String, Object> data = retrieveContextData(caseEventData, expressionScript.getVariables());\n+                return (Boolean) expressionScript.execute(new MapContext(data));\n+            }\n+        } catch (Exception e) {\n+            LOG.error(e.getMessage(), e);\n+        }\n+        return false;\n+    }\n+\n+    private Map<String, Object> retrieveContextData(Map<String, JsonNode> caseEventData,\n+                                                    Set<List<String>> variableLists) {\n+        Set<String> variables = getVariableNames(variableLists);\n+        Map<String, Object> contextData = new HashMap<>();\n+        DocumentContext context = JsonPath.parse(caseDataToJsonString(caseEventData));\n+        for (String variable : variables) {\n+            Optional<Object> value = getValueFromContext(context, variable);\n+            if (value.isPresent()) {\n+                contextData.put(variable, value.get());\n+            }\n+        }\n+        return contextData;\n+    }\n+\n+    private Set<String> getVariableNames(Set<List<String>> variableLists) {\n+        return variableLists\n+            .stream()\n+            .map(list -> list", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE3MzIwMw==", "bodyText": "Not covered by a test", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500173203", "createdAt": "2020-10-06T10:36:07Z", "author": {"login": "rafalkalita"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/casestate/jexl/JexlEnablingConditionParser.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package uk.gov.hmcts.ccd.domain.casestate.jexl;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.jayway.jsonpath.DocumentContext;\n+import com.jayway.jsonpath.JsonPath;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import javax.inject.Inject;\n+import org.apache.commons.jexl3.JexlBuilder;\n+import org.apache.commons.jexl3.JexlEngine;\n+import org.apache.commons.jexl3.JexlScript;\n+import org.apache.commons.jexl3.MapContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionFormatter;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionParser;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.ServiceException;\n+\n+@Component\n+@Qualifier(\"jexl\")\n+public class JexlEnablingConditionParser implements EnablingConditionParser {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(JexlEnablingConditionParser.class);\n+\n+    private final JexlEngine engine;\n+\n+    private final ObjectMapper objectMapper;\n+\n+    private EnablingConditionFormatter enablingConditionFormatter;\n+\n+    @Inject\n+    public JexlEnablingConditionParser(EnablingConditionFormatter enablingConditionFormatter) {\n+        this.enablingConditionFormatter = enablingConditionFormatter;\n+        this.engine = new JexlBuilder().create();\n+        this.objectMapper = new ObjectMapper();\n+    }\n+\n+    @Override\n+    public Boolean evaluate(String enablingCondition, Map<String, JsonNode> caseEventData) {\n+        try {\n+            String expression = this.enablingConditionFormatter.format(enablingCondition);\n+            if (expression != null) {\n+                JexlScript expressionScript = engine.createScript(expression);\n+                Map<String, Object> data = retrieveContextData(caseEventData, expressionScript.getVariables());\n+                return (Boolean) expressionScript.execute(new MapContext(data));\n+            }\n+        } catch (Exception e) {\n+            LOG.error(e.getMessage(), e);\n+        }\n+        return false;\n+    }\n+\n+    private Map<String, Object> retrieveContextData(Map<String, JsonNode> caseEventData,\n+                                                    Set<List<String>> variableLists) {\n+        Set<String> variables = getVariableNames(variableLists);\n+        Map<String, Object> contextData = new HashMap<>();\n+        DocumentContext context = JsonPath.parse(caseDataToJsonString(caseEventData));\n+        for (String variable : variables) {\n+            Optional<Object> value = getValueFromContext(context, variable);\n+            if (value.isPresent()) {\n+                contextData.put(variable, value.get());\n+            }\n+        }\n+        return contextData;\n+    }\n+\n+    private Set<String> getVariableNames(Set<List<String>> variableLists) {\n+        return variableLists\n+            .stream()\n+            .map(list -> list\n+                .stream()\n+                .collect(Collectors.joining(\".\")))\n+            .collect(Collectors.toSet());\n+    }\n+\n+    private String caseDataToJsonString(Map<String, JsonNode> caseData) {\n+        try {\n+            return this.objectMapper.writeValueAsString(caseData);\n+        } catch (JsonProcessingException e) {\n+            throw new ServiceException(\"Unable to convert case data to JSON string\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE3MzMyOQ==", "bodyText": "Could be final", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500173329", "createdAt": "2020-10-06T10:36:23Z", "author": {"login": "rafalkalita"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/casestate/jexl/JexlEnablingConditionParser.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package uk.gov.hmcts.ccd.domain.casestate.jexl;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.jayway.jsonpath.DocumentContext;\n+import com.jayway.jsonpath.JsonPath;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import javax.inject.Inject;\n+import org.apache.commons.jexl3.JexlBuilder;\n+import org.apache.commons.jexl3.JexlEngine;\n+import org.apache.commons.jexl3.JexlScript;\n+import org.apache.commons.jexl3.MapContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionFormatter;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionParser;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.ServiceException;\n+\n+@Component\n+@Qualifier(\"jexl\")\n+public class JexlEnablingConditionParser implements EnablingConditionParser {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(JexlEnablingConditionParser.class);\n+\n+    private final JexlEngine engine;\n+\n+    private final ObjectMapper objectMapper;\n+\n+    private EnablingConditionFormatter enablingConditionFormatter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE3ODM3Mg==", "bodyText": "Trailing ')' not relevant. No starting '(' present.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500178372", "createdAt": "2020-10-06T10:46:27Z", "author": {"login": "rafalkalita"}, "path": "src/test/java/uk/gov/hmcts/ccd/domain/casestate/jexl/JexlEnablingConditionParserTest.java", "diffHunk": "@@ -0,0 +1,90 @@\n+package uk.gov.hmcts.ccd.domain.casestate.jexl;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.JsonNodeFactory;\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+class JexlEnablingConditionParserTest {\n+\n+    private static final JsonNodeFactory JSON_NODE_FACTORY = new JsonNodeFactory(false);\n+\n+    private JexlEnablingConditionParser enablingConditionParser;\n+\n+    @BeforeEach\n+    void setUp() {\n+        this.enablingConditionParser = new JexlEnablingConditionParser(new JexlEnablingConditionFormatter());\n+    }\n+\n+    @Test\n+    void evaluateEnablingConditionWhenValidDataPresent() {\n+        String enablingCondition = \"FieldA!=\\\"\\\" AND FieldB=\\\"I'm innocent\\\")\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE3ODUzNQ==", "bodyText": "Trailing ')' not relevant. No starting '(' present. Same below.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500178535", "createdAt": "2020-10-06T10:46:45Z", "author": {"login": "rafalkalita"}, "path": "src/test/java/uk/gov/hmcts/ccd/domain/casestate/jexl/JexlEnablingConditionParserTest.java", "diffHunk": "@@ -0,0 +1,90 @@\n+package uk.gov.hmcts.ccd.domain.casestate.jexl;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.JsonNodeFactory;\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+class JexlEnablingConditionParserTest {\n+\n+    private static final JsonNodeFactory JSON_NODE_FACTORY = new JsonNodeFactory(false);\n+\n+    private JexlEnablingConditionParser enablingConditionParser;\n+\n+    @BeforeEach\n+    void setUp() {\n+        this.enablingConditionParser = new JexlEnablingConditionParser(new JexlEnablingConditionFormatter());\n+    }\n+\n+    @Test\n+    void evaluateEnablingConditionWhenValidDataPresent() {\n+        String enablingCondition = \"FieldA!=\\\"\\\" AND FieldB=\\\"I'm innocent\\\")\";\n+        Boolean isValid = this.enablingConditionParser.evaluate(enablingCondition, createCaseData(\n+            \"Test\",\n+            \"I'm innocent\"\n+        ));\n+\n+        assertNotNull(isValid);\n+        assertEquals(true, isValid);\n+    }\n+\n+    @Test\n+    void evaluateEnablingConditionWhenValidDataNotPresent() {\n+        String enablingCondition = \"FieldA!=\\\"\\\" AND FieldB=\\\"I'm innocent\\\")\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE3OTQ2Ng==", "bodyText": "Is there any use case for FieldA!=\"*\" ? Always resolves to false, for any string, empty string and null.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500179466", "createdAt": "2020-10-06T10:48:28Z", "author": {"login": "rafalkalita"}, "path": "src/test/java/uk/gov/hmcts/ccd/domain/casestate/jexl/JexlEnablingConditionParserTest.java", "diffHunk": "@@ -0,0 +1,90 @@\n+package uk.gov.hmcts.ccd.domain.casestate.jexl;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.JsonNodeFactory;\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+class JexlEnablingConditionParserTest {\n+\n+    private static final JsonNodeFactory JSON_NODE_FACTORY = new JsonNodeFactory(false);\n+\n+    private JexlEnablingConditionParser enablingConditionParser;\n+\n+    @BeforeEach\n+    void setUp() {\n+        this.enablingConditionParser = new JexlEnablingConditionParser(new JexlEnablingConditionFormatter());\n+    }\n+\n+    @Test\n+    void evaluateEnablingConditionWhenValidDataPresent() {\n+        String enablingCondition = \"FieldA!=\\\"\\\" AND FieldB=\\\"I'm innocent\\\")\";\n+        Boolean isValid = this.enablingConditionParser.evaluate(enablingCondition, createCaseData(\n+            \"Test\",\n+            \"I'm innocent\"\n+        ));\n+\n+        assertNotNull(isValid);\n+        assertEquals(true, isValid);\n+    }\n+\n+    @Test\n+    void evaluateEnablingConditionWhenValidDataNotPresent() {\n+        String enablingCondition = \"FieldA!=\\\"\\\" AND FieldB=\\\"I'm innocent\\\")\";\n+        Boolean isValid = this.enablingConditionParser.evaluate(enablingCondition, createCaseData(\n+            \"\",\n+            \"I'm innocent\"\n+        ));\n+\n+        assertNotNull(isValid);\n+        assertEquals(false, isValid);\n+    }\n+\n+    @Test\n+    void evaluateEnablingConditionWhenConditionContainsRegularExpression() {\n+        String enablingCondition = \"FieldA=\\\"*\\\" AND FieldB=\\\"I'm innocent\\\")\";\n+        Boolean isValid = this.enablingConditionParser.evaluate(enablingCondition, createCaseData(\n+            \"Test\",\n+            \"I'm innocent\"\n+        ));\n+\n+        assertNotNull(isValid);\n+        assertEquals(true, isValid);\n+    }\n+\n+    @Test\n+    void evaluateEnablingConditionWhenConditionContainsNotEqualityRegularExpression() {\n+        String enablingCondition = \"FieldA!=\\\"*\\\" AND FieldB=\\\"I'm innocent\\\")\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4MDc4NA==", "bodyText": "This line not needed. List implements Iterable", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500180784", "createdAt": "2020-10-06T10:50:50Z", "author": {"login": "rafalkalita"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/CaseStateUpdateService.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package uk.gov.hmcts.ccd.domain.service.common;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import javax.inject.Inject;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionSorter;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseEventDefinition;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Service\n+public class CaseStateUpdateService {\n+\n+    private final EnablingConditionSorter enablingConditionSorter;\n+    private StateReferenceService stateReferenceService;\n+\n+    @Inject\n+    public CaseStateUpdateService(EnablingConditionSorter enablingConditionSorter,\n+                                  StateReferenceService stateReferenceService) {\n+        this.enablingConditionSorter = enablingConditionSorter;\n+        this.stateReferenceService = stateReferenceService;\n+    }\n+\n+    public Optional<String> retrieveCaseState(CaseEventDefinition caseEventDefinition, CaseDetails caseDetails) {\n+        List<EventPostStateDefinition> eventPostStateDefinitions = caseEventDefinition.getPostStates();\n+        this.enablingConditionSorter.sortEventPostStates(eventPostStateDefinitions);\n+        Map<String, JsonNode> caseEventData = caseEventData(caseEventDefinition, caseDetails.getData());\n+        Optional<String> postStateReference = this.stateReferenceService\n+            .evaluatePostStateCondition(eventPostStateDefinitions, caseEventData);\n+        return postStateReference;\n+    }\n+\n+    private Map<String, JsonNode> caseEventData(CaseEventDefinition caseEventDefinition,\n+                                                Map<String, JsonNode> caseData) {\n+        Map<String, JsonNode> caseEventData = new HashMap<>();\n+        if (caseData != null) {\n+            caseEventDefinition\n+                .getCaseFields()\n+                .stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4MjIyNA==", "bodyText": "Could be inlined in the setUp method", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500182224", "createdAt": "2020-10-06T10:53:20Z", "author": {"login": "rafalkalita"}, "path": "src/test/java/uk/gov/hmcts/ccd/domain/service/common/CaseStateUpdateServiceTest.java", "diffHunk": "@@ -0,0 +1,94 @@\n+package uk.gov.hmcts.ccd.domain.service.common;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.MockitoAnnotations;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionSorter;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseEventDefinition;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.mockito.ArgumentMatchers.anyList;\n+import static org.mockito.ArgumentMatchers.anyMap;\n+import static org.mockito.Mockito.doReturn;\n+\n+class CaseStateUpdateServiceTest extends BaseStateReferenceTest {\n+\n+    private EnablingConditionSorter enablingConditionSorter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4Mjc1NA==", "bodyText": "'this' not needed line 35, 37 and 38", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500182754", "createdAt": "2020-10-06T10:54:12Z", "author": {"login": "rafalkalita"}, "path": "src/test/java/uk/gov/hmcts/ccd/domain/service/common/CaseStateUpdateServiceTest.java", "diffHunk": "@@ -0,0 +1,94 @@\n+package uk.gov.hmcts.ccd.domain.service.common;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.MockitoAnnotations;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionSorter;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseEventDefinition;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.mockito.ArgumentMatchers.anyList;\n+import static org.mockito.ArgumentMatchers.anyMap;\n+import static org.mockito.Mockito.doReturn;\n+\n+class CaseStateUpdateServiceTest extends BaseStateReferenceTest {\n+\n+    private EnablingConditionSorter enablingConditionSorter;\n+\n+    @Mock\n+    private StateReferenceService stateReferenceService;\n+\n+    private CaseStateUpdateService caseStateUpdateService;\n+\n+    @BeforeEach\n+    void setUp() {\n+        MockitoAnnotations.initMocks(this);\n+        this.enablingConditionSorter = new EnablingConditionSorter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE5NDk4OQ==", "bodyText": "No need to store the result. mvcResult not used later in the code.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500194989", "createdAt": "2020-10-06T11:17:21Z", "author": {"login": "rafalkalita"}, "path": "src/test/java/uk/gov/hmcts/ccd/endpoint/std/CaseDetailsEndpointPostStateIT.java", "diffHunk": "@@ -0,0 +1,127 @@\n+package uk.gov.hmcts.ccd.endpoint.std;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.List;\n+import javax.inject.Inject;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.test.context.jdbc.Sql;\n+import org.springframework.test.web.servlet.MockMvc;\n+import org.springframework.test.web.servlet.MvcResult;\n+import org.springframework.test.web.servlet.setup.MockMvcBuilders;\n+import org.springframework.web.context.WebApplicationContext;\n+import uk.gov.hmcts.ccd.MockUtils;\n+import uk.gov.hmcts.ccd.WireMockBaseTest;\n+import uk.gov.hmcts.ccd.config.JacksonUtils;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseDataContent;\n+import uk.gov.hmcts.ccd.domain.model.std.Event;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+import static uk.gov.hmcts.ccd.domain.model.std.EventBuilder.anEvent;\n+import static uk.gov.hmcts.ccd.domain.service.common.TestBuildersUtil.CaseDataContentBuilder.newCaseDataContent;\n+\n+public class CaseDetailsEndpointPostStateIT extends WireMockBaseTest {\n+    private static final String JURISDICTION = \"PROBATE\";\n+    private static final String TEST_EVENT_ID = \"TEST_EVENT\";\n+    private static final String NO_PRE_STATES_EVENT = \"NO_PRE_STATES_EVENT\";\n+    private static final String HAS_PRE_STATES_EVENT = \"HAS_PRE_STATES_EVENT\";\n+    private static final String UID = \"123\";\n+    private static final String CASE_TYPE_POST_STATE = \"TestAddressBookPostState\";\n+\n+    @Inject\n+    private WebApplicationContext wac;\n+    private MockMvc mockMvc;\n+    private JdbcTemplate template;\n+\n+    @Before\n+    public void setUp() {\n+        MockUtils.setSecurityAuthorities(authentication, MockUtils.ROLE_CASEWORKER_PUBLIC);\n+        mockMvc = MockMvcBuilders.webAppContextSetup(wac).build();\n+        template = new JdbcTemplate(db);\n+    }\n+\n+    @Test\n+    @Sql(executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD,\n+        scripts = {\"classpath:sql/insert_cases.sql\"})\n+    public void shouldChangeCaseStateWhenPostStateConditionMatches() throws Exception {\n+        final JsonNode data = createData();\n+        performRequestAndValidate(data, TEST_EVENT_ID, \"state4\");\n+    }\n+\n+    @Test\n+    @Sql(executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD,\n+        scripts = {\"classpath:sql/insert_cases.sql\"})\n+    public void shouldChangeCaseStateBasedOnPriorityWhenPostStateConditionMatches() throws Exception {\n+        final JsonNode data = createData();\n+        performRequestAndValidate(data, NO_PRE_STATES_EVENT, \"CaseEnteredIntoLegacy\");\n+    }\n+\n+    @Test\n+    @Sql(executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD,\n+        scripts = {\"classpath:sql/insert_cases.sql\"})\n+    public void shouldChangeToDefaultWhenPostStateConditionNotMatches() throws Exception {\n+        final JsonNode data = mapper.readTree(\"{\"\n+            + \"\\\"PersonLastName\\\":\\\"Test Last1\\\",\"\n+            + \"\\\"PersonFirstName\\\":\\\"Test First\\\"}\");\n+        performRequestAndValidate(data, NO_PRE_STATES_EVENT, \"state4\");\n+    }\n+\n+    @Test\n+    @Sql(executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD,\n+        scripts = {\"classpath:sql/insert_cases.sql\"})\n+    public void shouldStayInThePreviousStateWhenWildcardUsedInPostConditionState() throws Exception {\n+        final JsonNode data = createData();\n+        performRequestAndValidate(data, HAS_PRE_STATES_EVENT, \"CaseCreated\");\n+    }\n+\n+    @Test\n+    @Sql(executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD,\n+        scripts = {\"classpath:sql/insert_cases.sql\"})\n+    public void shouldIgnorePostStateConditionWhenFieldNotAssignedToEvent() throws Exception {\n+        final JsonNode data = createData();\n+        performRequestAndValidate(data, \"Goodness\", \"CaseEnteredIntoLegacy\");\n+    }\n+\n+    private JsonNode createData() throws com.fasterxml.jackson.core.JsonProcessingException {\n+        return mapper.readTree(\"{\"\n+            + \"\\\"PersonLastName\\\":\\\"Test Last\\\",\"\n+            + \"\\\"PersonFirstName\\\":\\\"Test First\\\"}\");\n+    }\n+\n+    private void performRequestAndValidate(JsonNode data, String eventId, String expectedCaseState) throws Exception {\n+        final String caseReference = \"1601933818308168\";\n+        final String URL = \"/citizens/\" + UID + \"/jurisdictions/\" + JURISDICTION + \"/case-types/\"\n+            + CASE_TYPE_POST_STATE + \"/cases/\" + caseReference + \"/events\";\n+\n+        final CaseDataContent caseDetailsToSave = newCaseDataContent().build();\n+        final Event triggeringEvent = anEvent().build();\n+        triggeringEvent.setEventId(eventId);\n+        caseDetailsToSave.setEvent(triggeringEvent);\n+        final String token = generateEventTokenNewCase(UID, JURISDICTION, CASE_TYPE_POST_STATE, eventId);\n+        caseDetailsToSave.setToken(token);\n+        caseDetailsToSave.setData(JacksonUtils.convertValue(data));\n+\n+        final MvcResult mvcResult = mockMvc.perform(post(URL)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517bea5262948f518e3dc945fdb6d9b8f3d558f"}, "originalPosition": 109}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e230618cab98321bb1a9a43a769a418ed513771", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/7e230618cab98321bb1a9a43a769a418ed513771", "committedDate": "2020-10-06T13:00:50Z", "message": "RDM-9556: code review comments addressed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyOTczODYy", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-502973862", "createdAt": "2020-10-06T13:40:37Z", "commit": {"oid": "7e230618cab98321bb1a9a43a769a418ed513771"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzo0MDozN1rOHdHElA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzo0MDozN1rOHdHElA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI4NjYxMg==", "bodyText": "Maybe we could we change it to FieldC=\"\" ? The opposite always resolves to false and how do we know test targets FieldC or !=\"\"", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500286612", "createdAt": "2020-10-06T13:40:37Z", "author": {"login": "rafalkalita"}, "path": "src/test/java/uk/gov/hmcts/ccd/domain/casestate/jexl/JexlEnablingConditionParserTest.java", "diffHunk": "@@ -71,7 +76,35 @@ void evaluateEnablingConditionWhenConditionContainsNotEqualityRegularExpression(\n \n     @Test\n     void evaluateEnablingConditionWhenConditionIsNull() {\n-        Boolean isValid = this.enablingConditionParser.evaluate(null, createCaseData(\n+        Boolean isValid = enablingConditionParser.evaluate(null, createCaseData(\n+            \"Test\",\n+            \"I'm innocent\"\n+        ));\n+\n+        assertNotNull(isValid);\n+        assertEquals(false, isValid);\n+    }\n+\n+    @Test\n+    void shouldReturnFalseWhenConditionHasUnKnownField() {\n+        String enablingCondition = \"FieldC!=\\\"*\\\" AND FieldB=\\\"I'm innocent\\\")\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e230618cab98321bb1a9a43a769a418ed513771"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1834e5438ba7e66c5e351f9d2e9ca5391a36bf1d", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/1834e5438ba7e66c5e351f9d2e9ca5391a36bf1d", "committedDate": "2020-10-06T13:43:04Z", "message": "RDM-9556: code review comments addressed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyOTc3MDk2", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-502977096", "createdAt": "2020-10-06T13:43:29Z", "commit": {"oid": "1834e5438ba7e66c5e351f9d2e9ca5391a36bf1d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMDMwMjM5", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503030239", "createdAt": "2020-10-06T14:31:35Z", "commit": {"oid": "1834e5438ba7e66c5e351f9d2e9ca5391a36bf1d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDozMTozNVrOHdKGQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDozMTozNVrOHdKGQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMzNjE5NQ==", "bodyText": "I think we could replace this method with a new method in CaseDetails that returns the data for a list of provided field ids", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500336195", "createdAt": "2020-10-06T14:31:35Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/CaseStateUpdateService.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package uk.gov.hmcts.ccd.domain.service.common;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import javax.inject.Inject;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionSorter;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseEventDefinition;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Service\n+public class CaseStateUpdateService {\n+\n+    private final EnablingConditionSorter enablingConditionSorter;\n+    private StateReferenceService stateReferenceService;\n+\n+    @Inject\n+    public CaseStateUpdateService(EnablingConditionSorter enablingConditionSorter,\n+                                  StateReferenceService stateReferenceService) {\n+        this.enablingConditionSorter = enablingConditionSorter;\n+        this.stateReferenceService = stateReferenceService;\n+    }\n+\n+    public Optional<String> retrieveCaseState(CaseEventDefinition caseEventDefinition, CaseDetails caseDetails) {\n+        List<EventPostStateDefinition> eventPostStateDefinitions = caseEventDefinition.getPostStates();\n+        this.enablingConditionSorter.sortEventPostStates(eventPostStateDefinitions);\n+        Map<String, JsonNode> caseEventData = caseEventData(caseEventDefinition, caseDetails.getData());\n+        Optional<String> postStateReference = this.stateReferenceService\n+            .evaluatePostStateCondition(eventPostStateDefinitions, caseEventData);\n+        return postStateReference;\n+    }\n+\n+    private Map<String, JsonNode> caseEventData(CaseEventDefinition caseEventDefinition,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1834e5438ba7e66c5e351f9d2e9ca5391a36bf1d"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMDMwNjc2", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503030676", "createdAt": "2020-10-06T14:32:00Z", "commit": {"oid": "1834e5438ba7e66c5e351f9d2e9ca5391a36bf1d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDozMjowMFrOHdKHoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDozMjowMFrOHdKHoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMzNjU0NQ==", "bodyText": "why we need to wrap in an Optional here? I'd just go for a simpler null check", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500336545", "createdAt": "2020-10-06T14:32:00Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/CaseStateUpdateService.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package uk.gov.hmcts.ccd.domain.service.common;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import javax.inject.Inject;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionSorter;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseEventDefinition;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Service\n+public class CaseStateUpdateService {\n+\n+    private final EnablingConditionSorter enablingConditionSorter;\n+    private StateReferenceService stateReferenceService;\n+\n+    @Inject\n+    public CaseStateUpdateService(EnablingConditionSorter enablingConditionSorter,\n+                                  StateReferenceService stateReferenceService) {\n+        this.enablingConditionSorter = enablingConditionSorter;\n+        this.stateReferenceService = stateReferenceService;\n+    }\n+\n+    public Optional<String> retrieveCaseState(CaseEventDefinition caseEventDefinition, CaseDetails caseDetails) {\n+        List<EventPostStateDefinition> eventPostStateDefinitions = caseEventDefinition.getPostStates();\n+        this.enablingConditionSorter.sortEventPostStates(eventPostStateDefinitions);\n+        Map<String, JsonNode> caseEventData = caseEventData(caseEventDefinition, caseDetails.getData());\n+        Optional<String> postStateReference = this.stateReferenceService\n+            .evaluatePostStateCondition(eventPostStateDefinitions, caseEventData);\n+        return postStateReference;\n+    }\n+\n+    private Map<String, JsonNode> caseEventData(CaseEventDefinition caseEventDefinition,\n+                                                Map<String, JsonNode> caseData) {\n+        Map<String, JsonNode> caseEventData = new HashMap<>();\n+        if (caseData != null) {\n+            caseEventDefinition\n+                .getCaseFields()\n+                .forEach(caseEventFieldDefinition -> {\n+                    String key = caseEventFieldDefinition.getCaseFieldId();\n+                    Optional<JsonNode> value = Optional.ofNullable(caseData.get(key));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1834e5438ba7e66c5e351f9d2e9ca5391a36bf1d"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMDMwOTgx", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503030981", "createdAt": "2020-10-06T14:32:18Z", "commit": {"oid": "1834e5438ba7e66c5e351f9d2e9ca5391a36bf1d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDozMjoxOFrOHdKImQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDozMjoxOFrOHdKImQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMzNjc5Mw==", "bodyText": "let's make sure we thoroughly unit test this class", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500336793", "createdAt": "2020-10-06T14:32:18Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/casestate/jexl/JexlEnablingConditionParser.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package uk.gov.hmcts.ccd.domain.casestate.jexl;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.jayway.jsonpath.DocumentContext;\n+import com.jayway.jsonpath.JsonPath;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import javax.inject.Inject;\n+import org.apache.commons.jexl3.JexlBuilder;\n+import org.apache.commons.jexl3.JexlEngine;\n+import org.apache.commons.jexl3.JexlScript;\n+import org.apache.commons.jexl3.MapContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionFormatter;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionParser;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.ServiceException;\n+\n+@Component\n+@Qualifier(\"jexl\")\n+public class JexlEnablingConditionParser implements EnablingConditionParser {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1834e5438ba7e66c5e351f9d2e9ca5391a36bf1d"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMDMxNTcw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503031570", "createdAt": "2020-10-06T14:32:52Z", "commit": {"oid": "1834e5438ba7e66c5e351f9d2e9ca5391a36bf1d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDozMjo1MlrOHdKKqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDozMjo1MlrOHdKKqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMzNzMyMw==", "bodyText": "let's make sure we thoroughly unit test this class", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r500337323", "createdAt": "2020-10-06T14:32:52Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/casestate/jexl/JexlEnablingConditionFormatter.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package uk.gov.hmcts.ccd.domain.casestate.jexl;\n+\n+import java.util.LinkedList;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1834e5438ba7e66c5e351f9d2e9ca5391a36bf1d"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/1547cdaaae80f6c3cd6e5982baa720f59a4312bb", "committedDate": "2020-10-06T14:57:40Z", "message": "RDM-9556: code review comments addressed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzODkxNTky", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503891592", "createdAt": "2020-10-07T13:42:04Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzo0MjowNVrOHdz88g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzo0MjowNVrOHdz88g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAyMTkzOA==", "bodyText": "the endpoint /caseworkers/{uid}/profile is used by the UI. Will this change break the UI? Or more in general, do we have verified this feature does not break the UI? (I'm sure we have just to double check)", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501021938", "createdAt": "2020-10-07T13:42:05Z", "author": {"login": "mario-paniccia"}, "path": "src/aat/resources/features/F-051/S-109.td.json", "diffHunk": "@@ -79,7 +79,7 @@\n \t\t\t\t\t\t\t\t\t\"pre_states\": [\n \t\t\t\t\t\t\t\t\t\t\"*\"\n \t\t\t\t\t\t\t\t\t],\n-\t\t\t\t\t\t\t\t\t\"post_state\": null,\n+\t\t\t\t\t\t\t\t\t\"post_states\": [],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTAzMTMw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503903130", "createdAt": "2020-10-07T13:52:57Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzo1Mjo1N1rOHd0evQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzo1Mjo1N1rOHd0evQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAzMDU4OQ==", "bodyText": "shouldn't we pass the whole case data here? In theory an enabling condition can refer to fields on the whole case right?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501030589", "createdAt": "2020-10-07T13:52:57Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/casestate/EnablingConditionParser.java", "diffHunk": "@@ -0,0 +1,8 @@\n+package uk.gov.hmcts.ccd.domain.casestate;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.Map;\n+\n+public interface EnablingConditionParser {\n+    Boolean evaluate(String enablingCondition, Map<String, JsonNode> caseEventData);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTE1MDU2", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503915056", "createdAt": "2020-10-07T14:03:50Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNDowMzo1MFrOHd1Aew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNDowMzo1MFrOHd1Aew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAzOTIyNw==", "bodyText": "if these new classes are meant to be generic, i.e. for working with enabling conditions on state, or in the future on events (we have a ticket for this feature proposal already) then better moving them outside the casestate package?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501039227", "createdAt": "2020-10-07T14:03:50Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/casestate/EnablingConditionFormatter.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package uk.gov.hmcts.ccd.domain.casestate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTE3NTcx", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503917571", "createdAt": "2020-10-07T14:06:13Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNDowNjoxM1rOHd1H4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNDowNjoxM1rOHd1H4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA0MTEyMg==", "bodyText": "for my knowledge do we have validation rules on the definition import mandating the priority to be mandatory for a condition? or it can be not specified?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501041122", "createdAt": "2020-10-07T14:06:13Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/casestate/EnablingConditionSorter.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package uk.gov.hmcts.ccd.domain.casestate;\n+\n+import java.util.Comparator;\n+import java.util.List;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Component\n+public class EnablingConditionSorter {\n+\n+    public void sortEventPostStates(List<EventPostStateDefinition> eventPostStates) {\n+        if (eventPostStates != null) {\n+            eventPostStates.sort(new PostStateComparator());\n+        }\n+    }\n+\n+    private class PostStateComparator implements Comparator<EventPostStateDefinition> {\n+\n+        @Override\n+        public int compare(EventPostStateDefinition first, EventPostStateDefinition second) {\n+            if (first.getPriority() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTE5NDQw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503919440", "createdAt": "2020-10-07T14:07:58Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNDowNzo1OFrOHd1NFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNDowNzo1OFrOHd1NFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA0MjQ1Mg==", "bodyText": "do we really need to add this null check here? is there any real chance eventPostStates can be null?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501042452", "createdAt": "2020-10-07T14:07:58Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/casestate/EnablingConditionSorter.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package uk.gov.hmcts.ccd.domain.casestate;\n+\n+import java.util.Comparator;\n+import java.util.List;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Component\n+public class EnablingConditionSorter {\n+\n+    public void sortEventPostStates(List<EventPostStateDefinition> eventPostStates) {\n+        if (eventPostStates != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTM3OTg0", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503937984", "createdAt": "2020-10-07T14:25:18Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNDoyNToxOFrOHd2ClA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNDoyNToxOFrOHd2ClA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA1NjE0OA==", "bodyText": "if you notice the previous version of CaseDetails it knows nothing about event, event definition, event field definitions, it is not tied to event classes like CaseEventDefinition. I think it would be better that way and make this method more generic, reusable and easily testable in isolation, e.g.\npublic Map<String, JsonNode> getFields(String... ids) {}\nThis way we can use to get field values even when the fields do not come from an event...", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501056148", "createdAt": "2020-10-07T14:25:18Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/definition/CaseDetails.java", "diffHunk": "@@ -356,4 +355,21 @@ public boolean hasCaseReference() {\n         return getReference() != null;\n     }\n \n+    @JsonIgnore\n+    public Map<String, JsonNode> getCaseEventData(CaseEventDefinition caseEventDefinition) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTgzNjQ1", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503983645", "createdAt": "2020-10-07T15:07:33Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNTowNzozM1rOHd4GHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNTowNzozM1rOHd4GHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA4OTgyMQ==", "bodyText": "EnablingConditionPrioritiser?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501089821", "createdAt": "2020-10-07T15:07:33Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/casestate/EnablingConditionSorter.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package uk.gov.hmcts.ccd.domain.casestate;\n+\n+import java.util.Comparator;\n+import java.util.List;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Component\n+public class EnablingConditionSorter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTg0MDM5", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503984039", "createdAt": "2020-10-07T15:07:54Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNTowNzo1NVrOHd4HLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNTowNzo1NVrOHd4HLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA5MDA5NQ==", "bodyText": "prioritiseEventPostStates?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501090095", "createdAt": "2020-10-07T15:07:55Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/casestate/EnablingConditionSorter.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package uk.gov.hmcts.ccd.domain.casestate;\n+\n+import java.util.Comparator;\n+import java.util.List;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Component\n+public class EnablingConditionSorter {\n+\n+    public void sortEventPostStates(List<EventPostStateDefinition> eventPostStates) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTg3NDIx", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503987421", "createdAt": "2020-10-07T15:11:14Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToxMToxNVrOHd4Q4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToxMToxNVrOHd4Q4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA5MjU3Ng==", "bodyText": "beware here you are sorting the list you are receiving in input as parameter rather than creating and returning a copy.\nLooking at the method invocation, this means you are changing the original list stored in the CaseEventDefinition object?\nSometimes these type of in place modifications can cause nasty bugs... always safer to create and return difensive copies", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501092576", "createdAt": "2020-10-07T15:11:15Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/casestate/EnablingConditionSorter.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package uk.gov.hmcts.ccd.domain.casestate;\n+\n+import java.util.Comparator;\n+import java.util.List;\n+import org.springframework.stereotype.Component;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Component\n+public class EnablingConditionSorter {\n+\n+    public void sortEventPostStates(List<EventPostStateDefinition> eventPostStates) {\n+        if (eventPostStates != null) {\n+            eventPostStates.sort(new PostStateComparator());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTkwNTM2", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503990536", "createdAt": "2020-10-07T15:14:18Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToxNDoxOFrOHd4aKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToxNDoxOFrOHd4aKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA5NDk1Mw==", "bodyText": "CasePostStateEvaluationService?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501094953", "createdAt": "2020-10-07T15:14:18Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/StateReferenceService.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package uk.gov.hmcts.ccd.domain.service.common;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import javax.inject.Inject;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionParser;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Service\n+public class StateReferenceService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTkxNzI0", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503991724", "createdAt": "2020-10-07T15:15:32Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToxNTozMlrOHd4dyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToxNTozMlrOHd4dyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA5NTg4MA==", "bodyText": "should get the whole case data in input since enabling conditions can use any case field", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501095880", "createdAt": "2020-10-07T15:15:32Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/StateReferenceService.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package uk.gov.hmcts.ccd.domain.service.common;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import javax.inject.Inject;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionParser;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Service\n+public class StateReferenceService {\n+\n+    private final EnablingConditionParser enablingConditionParser;\n+\n+    @Inject\n+    public StateReferenceService(EnablingConditionParser enablingConditionParser) {\n+        this.enablingConditionParser = enablingConditionParser;\n+    }\n+\n+    public Optional<String> evaluatePostStateCondition(List<EventPostStateDefinition> eventPostStateDefinitions,\n+                                                       Map<String, JsonNode> caseEventData) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTk0MjA4", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503994208", "createdAt": "2020-10-07T15:18:02Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToxODowMlrOHd4lAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToxODowMlrOHd4lAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA5NzczMA==", "bodyText": "don't think it's possible in CCD to not have a post state right? maybe we can get rid of this? seems unnecessary boilerplate code", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501097730", "createdAt": "2020-10-07T15:18:02Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/StateReferenceService.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package uk.gov.hmcts.ccd.domain.service.common;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import javax.inject.Inject;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionParser;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Service\n+public class StateReferenceService {\n+\n+    private final EnablingConditionParser enablingConditionParser;\n+\n+    @Inject\n+    public StateReferenceService(EnablingConditionParser enablingConditionParser) {\n+        this.enablingConditionParser = enablingConditionParser;\n+    }\n+\n+    public Optional<String> evaluatePostStateCondition(List<EventPostStateDefinition> eventPostStateDefinitions,\n+                                                       Map<String, JsonNode> caseEventData) {\n+        List<EventPostStateDefinition> postStateDefinitions = Optional\n+            .ofNullable(eventPostStateDefinitions)\n+            .orElse(new ArrayList<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTk5MTY5", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-503999169", "createdAt": "2020-10-07T15:22:48Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToyMjo0OFrOHd4zrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToyMjo0OFrOHd4zrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEwMTQ4Ng==", "bodyText": "you can use the variable enablingCondition", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501101486", "createdAt": "2020-10-07T15:22:48Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/StateReferenceService.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package uk.gov.hmcts.ccd.domain.service.common;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import javax.inject.Inject;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionParser;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Service\n+public class StateReferenceService {\n+\n+    private final EnablingConditionParser enablingConditionParser;\n+\n+    @Inject\n+    public StateReferenceService(EnablingConditionParser enablingConditionParser) {\n+        this.enablingConditionParser = enablingConditionParser;\n+    }\n+\n+    public Optional<String> evaluatePostStateCondition(List<EventPostStateDefinition> eventPostStateDefinitions,\n+                                                       Map<String, JsonNode> caseEventData) {\n+        List<EventPostStateDefinition> postStateDefinitions = Optional\n+            .ofNullable(eventPostStateDefinitions)\n+            .orElse(new ArrayList<>());\n+\n+        for (EventPostStateDefinition eventPostStateDefinition : postStateDefinitions) {\n+            String enablingCondition = eventPostStateDefinition.getEnablingCondition();\n+            if (enablingCondition != null) {\n+                Boolean conditionMatched = this.enablingConditionParser.evaluate(\n+                    eventPostStateDefinition.getEnablingCondition(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MDA0MjI3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-504004227", "createdAt": "2020-10-07T15:27:43Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToyNzo0NFrOHd5DDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToyNzo0NFrOHd5DDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEwNTQyMQ==", "bodyText": "mmm why Optional? There must always be a post state for a case, from a business point of view is not optional. So modelling this in the API as Optional it feels to me a bit confusing. I'd just define this as String, also considering that we already have import validation that mandates specifying a default case right?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501105421", "createdAt": "2020-10-07T15:27:44Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/StateReferenceService.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package uk.gov.hmcts.ccd.domain.service.common;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import javax.inject.Inject;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionParser;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Service\n+public class StateReferenceService {\n+\n+    private final EnablingConditionParser enablingConditionParser;\n+\n+    @Inject\n+    public StateReferenceService(EnablingConditionParser enablingConditionParser) {\n+        this.enablingConditionParser = enablingConditionParser;\n+    }\n+\n+    public Optional<String> evaluatePostStateCondition(List<EventPostStateDefinition> eventPostStateDefinitions,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MDA1NDI0", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-504005424", "createdAt": "2020-10-07T15:28:58Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToyODo1OFrOHd5Ghg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNToyODo1OFrOHd5Ghg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEwNjMxMA==", "bodyText": "I'd change this to String, and throw exception if we can't resolve a state since this is really something that should never happen and be prevented via config. It's not something we can recover from", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501106310", "createdAt": "2020-10-07T15:28:58Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/StateReferenceService.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package uk.gov.hmcts.ccd.domain.service.common;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import javax.inject.Inject;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionParser;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Service\n+public class StateReferenceService {\n+\n+    private final EnablingConditionParser enablingConditionParser;\n+\n+    @Inject\n+    public StateReferenceService(EnablingConditionParser enablingConditionParser) {\n+        this.enablingConditionParser = enablingConditionParser;\n+    }\n+\n+    public Optional<String> evaluatePostStateCondition(List<EventPostStateDefinition> eventPostStateDefinitions,\n+                                                       Map<String, JsonNode> caseEventData) {\n+        List<EventPostStateDefinition> postStateDefinitions = Optional\n+            .ofNullable(eventPostStateDefinitions)\n+            .orElse(new ArrayList<>());\n+\n+        for (EventPostStateDefinition eventPostStateDefinition : postStateDefinitions) {\n+            String enablingCondition = eventPostStateDefinition.getEnablingCondition();\n+            if (enablingCondition != null) {\n+                Boolean conditionMatched = this.enablingConditionParser.evaluate(\n+                    eventPostStateDefinition.getEnablingCondition(),\n+                    caseEventData);\n+                if (conditionMatched) {\n+                    return Optional.of(eventPostStateDefinition.getPostStateReference());\n+                }\n+            }\n+        }\n+        return getDefaultPostStateReference(postStateDefinitions);\n+    }\n+\n+    private Optional<String> getDefaultPostStateReference(List<EventPostStateDefinition> eventPostStateDefinitions) {\n+        return eventPostStateDefinitions\n+            .stream()\n+            .filter(postState -> postState.getEnablingCondition() == null)\n+            .map(postState -> postState.getPostStateReference())\n+            .findAny();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MDA3NjE5", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#pullrequestreview-504007619", "createdAt": "2020-10-07T15:31:07Z", "commit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNTozMTowN1rOHd5NJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNTozMTowN1rOHd5NJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEwODAwNg==", "bodyText": "I would add a method isDefault() to EventPostStateDefinition which itself checks whether enablingCondition == null. This way the rule about when a condition is a default condition is encapsulated in one place rather than scattered around and potentially duplicated all over the places.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1151#discussion_r501108006", "createdAt": "2020-10-07T15:31:07Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/StateReferenceService.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package uk.gov.hmcts.ccd.domain.service.common;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import javax.inject.Inject;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.domain.casestate.EnablingConditionParser;\n+import uk.gov.hmcts.ccd.domain.model.definition.EventPostStateDefinition;\n+\n+@Service\n+public class StateReferenceService {\n+\n+    private final EnablingConditionParser enablingConditionParser;\n+\n+    @Inject\n+    public StateReferenceService(EnablingConditionParser enablingConditionParser) {\n+        this.enablingConditionParser = enablingConditionParser;\n+    }\n+\n+    public Optional<String> evaluatePostStateCondition(List<EventPostStateDefinition> eventPostStateDefinitions,\n+                                                       Map<String, JsonNode> caseEventData) {\n+        List<EventPostStateDefinition> postStateDefinitions = Optional\n+            .ofNullable(eventPostStateDefinitions)\n+            .orElse(new ArrayList<>());\n+\n+        for (EventPostStateDefinition eventPostStateDefinition : postStateDefinitions) {\n+            String enablingCondition = eventPostStateDefinition.getEnablingCondition();\n+            if (enablingCondition != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1547cdaaae80f6c3cd6e5982baa720f59a4312bb"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2751, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}