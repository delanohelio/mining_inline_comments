{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4MTM4MzYy", "number": 968, "title": "RDM-8344: Implement 'Get Case-Assigned Users and Roles'", "bodyText": "JIRA link (if applicable)\nhttps://tools.hmcts.net/jira/browse/RDM-8344\nChange description\nimplement Get Case Assigned Users and Roles end point\nDoes this PR introduce a breaking change? (check one with \"x\")\n[ ] Yes\n[ X] No", "createdAt": "2020-06-04T23:20:22Z", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968", "merged": true, "mergeCommit": {"oid": "105a351e942baca73e34b18d680732195a1f0835"}, "closed": true, "closedAt": "2020-06-15T12:45:02Z", "author": {"login": "kiran-yenigala-hmcts"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoGkdBAH2gAyNDI4MTM4MzYyOjNiNzc1MmYyNmYzM2Q5YmY0NTlkMWIyNWIzMmNlZDk4N2FiNGZkNTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqlNg6gH2gAyNDI4MTM4MzYyOjVmYWExMDAyNTdkOGVhNWMwZDdiOGMyYjQyZWNiNWExNGQzZjc5NDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3b7752f26f33d9bf459d1b25b32ced987ab4fd59", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/3b7752f26f33d9bf459d1b25b32ced987ab4fd59", "committedDate": "2020-06-04T23:22:18Z", "message": "RDM-8344: Implement Get Case-Assigned Users and Roles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad", "committedDate": "2020-06-04T23:44:39Z", "message": "RDM-8344: Fixed Checkstyle issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDU2MTU3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#pullrequestreview-425056157", "createdAt": "2020-06-05T07:26:19Z", "commit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoyNjoxOVrOGfjR9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoyNjoxOVrOGfjR9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTczNzA3OQ==", "bodyText": "But even if we do, a set equivalence should be used for this kind of a key design. What if the a list contains a duplicate entry while all others being the same as the other? I suspect we need a caching and therefore a key design like this.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435737079", "createdAt": "2020-06-05T07:26:19Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CaseAssignedUserRolesKey.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package uk.gov.hmcts.ccd.data.caseaccess;\n+\n+import java.util.List;\n+import org.apache.commons.collections.ListUtils;\n+\n+public class CaseAssignedUserRolesKey {\n+\n+    private final List<Long> caseIds;\n+\n+    private final List<String> userIds;\n+\n+    public CaseAssignedUserRolesKey(List<Long> caseIds, List<String> userIds) {\n+        this.caseIds = caseIds;\n+        this.userIds = userIds;\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+        CaseAssignedUserRolesKey that = (CaseAssignedUserRolesKey) o;\n+        if (caseIds == null || that.caseIds == null || caseIds.size() != that.caseIds.size()) {\n+            return false;\n+        }\n+\n+        if (userIds == null || that.userIds == null || userIds.size() != that.userIds.size()) {\n+            return false;\n+        }\n+        return caseIds.containsAll(that.caseIds) && userIds.containsAll(that.userIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDU2MTk3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#pullrequestreview-425056197", "createdAt": "2020-06-05T07:26:23Z", "commit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoyNjoyM1rOGfjSDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoyNjoyM1rOGfjSDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTczNzEwMg==", "bodyText": "This caching doesn't seem to be ok. What if the case-user-role assignments change? And what if the list of user ids and case ids are provided in a different order? And, what is the eviction policy of this cache?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435737102", "createdAt": "2020-06-05T07:26:23Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/caseaccess/CachedCaseUserRepository.java", "diffHunk": "@@ -43,4 +44,11 @@ public void revokeAccess(Long caseId, String userId, String caseRole) {\n     public List<String> findCaseRoles(final Long caseId, final String userId) {\n         return caseUserRoles.computeIfAbsent(caseId + userId, e -> caseUserRepository.findCaseRoles(caseId, userId));\n     }\n+\n+    @Override\n+    public List<CaseUserEntity> findCaseUserRoles(List<Long> caseIds, List<String> userIds) {\n+        return caseAssignedUserRoles.computeIfAbsent(\n+            new CaseAssignedUserRolesKey(caseIds, userIds),\n+            e -> caseUserRepository.findCaseUserRoles(caseIds, userIds));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDU3NDkz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#pullrequestreview-425057493", "createdAt": "2020-06-05T07:28:27Z", "commit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoyODoyN1rOGfjWDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzoyODoyN1rOGfjWDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTczODEyNw==", "bodyText": "this could be written nicer with less or no repeated lines.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435738127", "createdAt": "2020-06-05T07:28:27Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/caseaccess/DefaultCaseUserRepository.java", "diffHunk": "@@ -53,4 +53,17 @@ public void revokeAccess(Long caseId, String userId, String caseRole) {\n \n         return namedQuery.getResultList();\n     }\n+\n+    public List<CaseUserEntity> findCaseUserRoles(final List<Long> caseIds, final List<String> userIds) {\n+        if (userIds.size() == 0) {\n+            TypedQuery<CaseUserEntity> namedQuery = em.createNamedQuery(CaseUserEntity.GET_ALL_CASE_ROLES_BY_CASE_IDS, CaseUserEntity.class);\n+            namedQuery.setParameter(CaseUserEntity.PARAM_CASE_DATA_IDS, caseIds);\n+            return namedQuery.getResultList();\n+        } else {\n+            TypedQuery<CaseUserEntity> namedQuery = em.createNamedQuery(CaseUserEntity.GET_ALL_CASE_ROLES_USERS_HAS_ACCESS_TO_CASES, CaseUserEntity.class);\n+            namedQuery.setParameter(CaseUserEntity.PARAM_CASE_DATA_IDS, caseIds);\n+            namedQuery.setParameter(CaseUserEntity.PARAM_USER_IDS, userIds);\n+            return namedQuery.getResultList();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDY0MTgx", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#pullrequestreview-425064181", "createdAt": "2020-06-05T07:39:23Z", "commit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzozOToyM1rOGfjqgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzozOToyM1rOGfjqgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0MzM2MQ==", "bodyText": "could id (reference) is a String / (varchar 255) elsewhere in CCD.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435743361", "createdAt": "2020-06-05T07:39:23Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package uk.gov.hmcts.ccd.domain.model.std;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.AllArgsConstructor;\n+import lombok.NoArgsConstructor;\n+import lombok.ToString;\n+\n+@ToString\n+@AllArgsConstructor\n+@NoArgsConstructor\n+public class CaseAssignedUserRole {\n+\n+    @JsonProperty(\"case_data_id\")\n+    private Long caseDataId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDY0NjQ2", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#pullrequestreview-425064646", "createdAt": "2020-06-05T07:40:07Z", "commit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo0MDowN1rOGfjsDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo0MDowN1rOGfjsDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0Mzc1OQ==", "bodyText": "case_id is used in LLD and other references", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435743759", "createdAt": "2020-06-05T07:40:07Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/std/CaseAssignedUserRole.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package uk.gov.hmcts.ccd.domain.model.std;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.AllArgsConstructor;\n+import lombok.NoArgsConstructor;\n+import lombok.ToString;\n+\n+@ToString\n+@AllArgsConstructor\n+@NoArgsConstructor\n+public class CaseAssignedUserRole {\n+\n+    @JsonProperty(\"case_data_id\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDY2NzU3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#pullrequestreview-425066757", "createdAt": "2020-06-05T07:43:23Z", "commit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo0MzoyM1rOGfjyUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo0MzoyM1rOGfjyUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0NTM2MA==", "bodyText": "We wouldn't use a new media type for the initial version of this operation.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435745360", "createdAt": "2020-06-05T07:43:23Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/v2/V2.java", "diffHunk": "@@ -43,6 +43,8 @@ private MediaType() {}\n \n         public static final String CASE_EVENTS = \"application/vnd.uk.gov.hmcts.ccd-data-store-api.case-events.v2+json;charset=UTF-8\";\n \n+        public static final String CASE_USER_ROLES = \"application/vnd.uk.gov.hmcts.ccd-data-store-api.case-user-roles.v2+json;charset=UTF-8\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDcwNzQ1", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#pullrequestreview-425070745", "createdAt": "2020-06-05T07:47:41Z", "commit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo0Nzo0MVrOGfj6jA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo0Nzo0MVrOGfj6jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0NzQ2OA==", "bodyText": "This could have been done by Spring automatatically. Just use type List", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435747468", "createdAt": "2020-06-05T07:47:41Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package uk.gov.hmcts.ccd.v2.external.controller;\n+\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiResponse;\n+import io.swagger.annotations.ApiResponses;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.domain.service.cauroles.CaseAssignedUserRolesOperation;\n+import uk.gov.hmcts.ccd.domain.service.common.UIDService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.BadRequestException;\n+import uk.gov.hmcts.ccd.v2.V2;\n+import uk.gov.hmcts.ccd.v2.external.resource.CaseAssignedUserRolesResource;\n+\n+@RestController\n+@RequestMapping(path = \"/\")\n+public class CaseAssignedUserRolesController {\n+\n+    private final UIDService caseReferenceService;\n+    private final CaseAssignedUserRolesOperation caseAssignedUserRolesOperation;\n+\n+    @Autowired\n+    public CaseAssignedUserRolesController(UIDService caseReferenceService,\n+                                           @Qualifier(\"authorised\") CaseAssignedUserRolesOperation caseAssignedUserRolesOperation) {\n+        this.caseReferenceService = caseReferenceService;\n+        this.caseAssignedUserRolesOperation = caseAssignedUserRolesOperation;\n+    }\n+\n+    @GetMapping(\n+        path = \"/case-users\",\n+        produces = {\n+            V2.MediaType.CASE_USER_ROLES\n+        }\n+    )\n+    @ApiOperation(\n+        value = \"Retrieve Case user roles by Case ID and User ID\"\n+    )\n+    @ApiResponses({\n+        @ApiResponse(\n+            code = 200,\n+            message = \"Case-User-Role assignments returned successfully\",\n+            response = CaseAssignedUserRolesResource.class\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.CASE_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.EMPTY_CASE_ID_LIST\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.USER_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 403,\n+            message = V2.Error.OTHER_USER_CASE_ROLE_ACCESS_NOT_GRANTED\n+        )\n+    })\n+    // TODO: 01/06/2020  add LogAudit\n+    public ResponseEntity<CaseAssignedUserRolesResource> getCaseUserRoles(@RequestParam(\"case_ids\") String caseIds,\n+                                                                          @RequestParam(value = \"user_ids\", required = false) String userIds) {\n+        List<String> listUserIds = convertToList(userIds);\n+        List<String> listCaseIds = convertToList(caseIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDcyOTYz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#pullrequestreview-425072963", "createdAt": "2020-06-05T07:50:12Z", "commit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo1MDoxMlrOGfkAcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo1MDoxMlrOGfkAcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0ODk3OQ==", "bodyText": "This throws an Exception upon the first issue it encounters. However, all validation issues should be reported at once.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435748979", "createdAt": "2020-06-05T07:50:12Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package uk.gov.hmcts.ccd.v2.external.controller;\n+\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiResponse;\n+import io.swagger.annotations.ApiResponses;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.domain.service.cauroles.CaseAssignedUserRolesOperation;\n+import uk.gov.hmcts.ccd.domain.service.common.UIDService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.BadRequestException;\n+import uk.gov.hmcts.ccd.v2.V2;\n+import uk.gov.hmcts.ccd.v2.external.resource.CaseAssignedUserRolesResource;\n+\n+@RestController\n+@RequestMapping(path = \"/\")\n+public class CaseAssignedUserRolesController {\n+\n+    private final UIDService caseReferenceService;\n+    private final CaseAssignedUserRolesOperation caseAssignedUserRolesOperation;\n+\n+    @Autowired\n+    public CaseAssignedUserRolesController(UIDService caseReferenceService,\n+                                           @Qualifier(\"authorised\") CaseAssignedUserRolesOperation caseAssignedUserRolesOperation) {\n+        this.caseReferenceService = caseReferenceService;\n+        this.caseAssignedUserRolesOperation = caseAssignedUserRolesOperation;\n+    }\n+\n+    @GetMapping(\n+        path = \"/case-users\",\n+        produces = {\n+            V2.MediaType.CASE_USER_ROLES\n+        }\n+    )\n+    @ApiOperation(\n+        value = \"Retrieve Case user roles by Case ID and User ID\"\n+    )\n+    @ApiResponses({\n+        @ApiResponse(\n+            code = 200,\n+            message = \"Case-User-Role assignments returned successfully\",\n+            response = CaseAssignedUserRolesResource.class\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.CASE_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.EMPTY_CASE_ID_LIST\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.USER_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 403,\n+            message = V2.Error.OTHER_USER_CASE_ROLE_ACCESS_NOT_GRANTED\n+        )\n+    })\n+    // TODO: 01/06/2020  add LogAudit\n+    public ResponseEntity<CaseAssignedUserRolesResource> getCaseUserRoles(@RequestParam(\"case_ids\") String caseIds,\n+                                                                          @RequestParam(value = \"user_ids\", required = false) String userIds) {\n+        List<String> listUserIds = convertToList(userIds);\n+        List<String> listCaseIds = convertToList(caseIds);\n+        validateRequestParams(listCaseIds, listUserIds);\n+\n+        List<CaseAssignedUserRole> caseAssignedUserRoles = this.caseAssignedUserRolesOperation.findCaseUserRoles(listCaseIds\n+            .stream()\n+            .map(caseId -> Long.valueOf(caseId))\n+            .collect(Collectors.toCollection(ArrayList::new)), listUserIds);\n+        return ResponseEntity.ok(new CaseAssignedUserRolesResource(caseIds, userIds, caseAssignedUserRoles));\n+    }\n+\n+    private List<String> convertToList(String ids) {\n+        return ids == null ? Collections.EMPTY_LIST : Arrays.asList(ids.split(\",\"));\n+    }\n+\n+    private void validateRequestParams(List<String> caseIds, List<String> userIds) {\n+        if (caseIds.isEmpty()) {\n+            throw new BadRequestException(V2.Error.EMPTY_CASE_ID_LIST);\n+        }\n+\n+        caseIds.forEach(caseId -> {\n+            if (!caseReferenceService.validateUID(caseId)) {\n+                throw new BadRequestException(V2.Error.CASE_ID_INVALID);\n+            }\n+        });\n+\n+        userIds.forEach(userId -> {\n+            if (StringUtils.isAllBlank(userId)) {\n+                throw new BadRequestException(V2.Error.USER_ID_INVALID);\n+            }\n+        });\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDczNzc1", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#pullrequestreview-425073775", "createdAt": "2020-06-05T07:51:28Z", "commit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo1MToyOFrOGfkC1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo1MToyOFrOGfkC1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0OTU4OA==", "bodyText": "no hateoas links for now, pls.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r435749588", "createdAt": "2020-06-05T07:51:28Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/resource/CaseAssignedUserRolesResource.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package uk.gov.hmcts.ccd.v2.external.resource;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import java.util.List;\n+import lombok.Data;\n+import lombok.EqualsAndHashCode;\n+import lombok.NoArgsConstructor;\n+import lombok.NonNull;\n+import org.springframework.hateoas.RepresentationModel;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.v2.external.controller.CaseAssignedUserRolesController;\n+\n+import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.linkTo;\n+import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.methodOn;\n+\n+@Data\n+@EqualsAndHashCode(callSuper = true)\n+@NoArgsConstructor\n+public class CaseAssignedUserRolesResource extends RepresentationModel {\n+\n+    @JsonProperty(\"case-users\")\n+    private List<CaseAssignedUserRole> caseAssignedUserRoles;\n+\n+    public CaseAssignedUserRolesResource(@NonNull String caseIds, String userIds, List<CaseAssignedUserRole> caseAssignedUserRoles) {\n+        this.caseAssignedUserRoles = caseAssignedUserRoles;\n+        add(linkTo(methodOn(CaseAssignedUserRolesController.class).getCaseUserRoles(caseIds, userIds)).withSelfRel());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce65e822d649c5fc7f8295c41ef5e2023c7b1ad"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50d834a4e85b24b88b69b5d70c5e949ddb87ac46", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/50d834a4e85b24b88b69b5d70c5e949ddb87ac46", "committedDate": "2020-06-05T10:51:46Z", "message": "RDM-8344: Addressed review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08277234d2515d9588ce47195eb01aa9db4250be", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/08277234d2515d9588ce47195eb01aa9db4250be", "committedDate": "2020-06-05T14:54:43Z", "message": "RDM-8344: Addressed review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MTcyODk3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#pullrequestreview-427172897", "createdAt": "2020-06-09T13:52:37Z", "commit": {"oid": "08277234d2515d9588ce47195eb01aa9db4250be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzo1MjozOFrOGhLGHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzo1MjozOFrOGhLGHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzNzk4Mw==", "bodyText": "what is the user's own id is repeated twice?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r437437983", "createdAt": "2020-06-09T13:52:38Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/cauroles/rolevalidator/DefaultCaseAssignedUserRoleValidator.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package uk.gov.hmcts.ccd.domain.service.cauroles.rolevalidator;\n+\n+import java.util.List;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.data.user.CachedUserRepository;\n+import uk.gov.hmcts.ccd.data.user.UserRepository;\n+\n+@Service\n+@Qualifier(\"default\")\n+public class DefaultCaseAssignedUserRoleValidator implements CaseAssignedUserRoleValidator {\n+\n+    private final String roleCaseWorkerCaa = \"caseworker-caa\";\n+\n+    private UserRepository userRepository;\n+\n+    @Autowired\n+    public DefaultCaseAssignedUserRoleValidator(@Qualifier(CachedUserRepository.QUALIFIER) final UserRepository userRepository) {\n+        this.userRepository = userRepository;\n+    }\n+\n+    public boolean canAccessUserCaseRoles(List<String> userIds) {\n+        boolean canAccess = this.userRepository.getUserRoles().contains(roleCaseWorkerCaa);\n+        if (!canAccess) {\n+            canAccess = userIds.size() == 1 && userIds.contains(this.userRepository.getUserId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08277234d2515d9588ce47195eb01aa9db4250be"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MTc0NDc4", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#pullrequestreview-427174478", "createdAt": "2020-06-09T13:54:07Z", "commit": {"oid": "08277234d2515d9588ce47195eb01aa9db4250be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzo1NDowN1rOGhLMyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzo1NDowN1rOGhLMyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzOTY5MA==", "bodyText": "This should be Get Case-Assigned Users and Roles. That is the operation's well-known name in all other references.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#discussion_r437439690", "createdAt": "2020-06-09T13:54:07Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseAssignedUserRolesController.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package uk.gov.hmcts.ccd.v2.external.controller;\n+\n+import com.google.common.collect.Lists;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiResponse;\n+import io.swagger.annotations.ApiResponses;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseAssignedUserRole;\n+import uk.gov.hmcts.ccd.domain.service.cauroles.CaseAssignedUserRolesOperation;\n+import uk.gov.hmcts.ccd.domain.service.common.UIDService;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.BadRequestException;\n+import uk.gov.hmcts.ccd.v2.V2;\n+import uk.gov.hmcts.ccd.v2.external.resource.CaseAssignedUserRolesResource;\n+\n+@RestController\n+@RequestMapping(path = \"/\")\n+public class CaseAssignedUserRolesController {\n+\n+    private final UIDService caseReferenceService;\n+    private final CaseAssignedUserRolesOperation caseAssignedUserRolesOperation;\n+\n+    @Autowired\n+    public CaseAssignedUserRolesController(UIDService caseReferenceService,\n+                                           @Qualifier(\"authorised\") CaseAssignedUserRolesOperation caseAssignedUserRolesOperation) {\n+        this.caseReferenceService = caseReferenceService;\n+        this.caseAssignedUserRolesOperation = caseAssignedUserRolesOperation;\n+    }\n+\n+    @GetMapping(\n+        path = \"/case-users\"\n+    )\n+    @ApiOperation(\n+        value = \"Retrieve Case user roles by Case ID and User ID\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08277234d2515d9588ce47195eb01aa9db4250be"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MTc1NzQy", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#pullrequestreview-427175742", "createdAt": "2020-06-09T13:55:23Z", "commit": {"oid": "08277234d2515d9588ce47195eb01aa9db4250be"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed83599fc8dfae3493f48c0794f19da45f2fbc18", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/ed83599fc8dfae3493f48c0794f19da45f2fbc18", "committedDate": "2020-06-09T14:09:50Z", "message": "RDM-8344: Addressed review Comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9f68a1f5df8b03e5c93b58aaf2a0785aa5432a6", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/d9f68a1f5df8b03e5c93b58aaf2a0785aa5432a6", "committedDate": "2020-06-09T14:12:25Z", "message": "RDM-8344: Added test cases for the new code added after review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MjAyMDMw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/968#pullrequestreview-427202030", "createdAt": "2020-06-09T14:20:57Z", "commit": {"oid": "d9f68a1f5df8b03e5c93b58aaf2a0785aa5432a6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "290d0514a6caed98f05e6e38531599be1e561131", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/290d0514a6caed98f05e6e38531599be1e561131", "committedDate": "2020-06-12T12:37:56Z", "message": "RDM-8344: Fixed issue with access to case_users table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f44945b3ad750e430187bc0f3b6b77fd64266c92", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/f44945b3ad750e430187bc0f3b6b77fd64266c92", "committedDate": "2020-06-12T12:48:36Z", "message": "RDM-8344: Fixed issue with access to case_users table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14a9617c06637224c6cfe46cc658a731809315b7", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/14a9617c06637224c6cfe46cc658a731809315b7", "committedDate": "2020-06-12T13:04:22Z", "message": "RDM-8344: Fixed issue with access to case_users table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68c9e06ebec56b0e33c149d787859edd7c80f169", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/68c9e06ebec56b0e33c149d787859edd7c80f169", "committedDate": "2020-06-12T14:26:24Z", "message": "RDM-8344: Fixed issue with access to case_users table and check style issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caddbc8d8358432da7fb1ac6a239926b110def0c", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/caddbc8d8358432da7fb1ac6a239926b110def0c", "committedDate": "2020-06-12T14:57:30Z", "message": "RDM-8344: fix CVE-2020-13692"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "145a855070aa1e41bd3a5806aad5d8ac45c792c7", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/145a855070aa1e41bd3a5806aad5d8ac45c792c7", "committedDate": "2020-06-12T15:12:08Z", "message": "RDM-8344: fix CVE-2017-18365"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca9cc83cb8a06e535d4c1a4e4d76f551d9eb3240", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/ca9cc83cb8a06e535d4c1a4e4d76f551d9eb3240", "committedDate": "2020-06-12T15:22:10Z", "message": "Suppress CVE-2017-18365"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0ce36bc77dde18dab94e427de0917c4d02f64d9", "author": {"user": {"login": "kiran-yenigala-hmcts", "name": "Kiran Kumar Yenigala"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/f0ce36bc77dde18dab94e427de0917c4d02f64d9", "committedDate": "2020-06-12T15:28:09Z", "message": "Merge branch 'develop' into RDM-8344"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18b9fe025e02841f27469b2f9a35f1804dd2d111", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/18b9fe025e02841f27469b2f9a35f1804dd2d111", "committedDate": "2020-06-12T15:56:21Z", "message": "Fixed failure tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a41f1871ad576cff54f30864a3202f702f9897c3", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/a41f1871ad576cff54f30864a3202f702f9897c3", "committedDate": "2020-06-12T15:56:32Z", "message": "Merge remote-tracking branch 'origin/RDM-8344' into RDM-8344"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5faa100257d8ea5c0d7b8c2b42ecb5a14d3f7947", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/5faa100257d8ea5c0d7b8c2b42ecb5a14d3f7947", "committedDate": "2020-06-12T16:12:09Z", "message": "fix failure tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2997, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}