{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzMTg4MDQ3", "number": 1018, "title": "RDM-9045 - Add configurable logging of roles for requests", "bodyText": "JIRA link (if applicable)\nhttps://tools.hmcts.net/jira/browse/RDM-9045\nChange description\nAdd configurable logging of roles for requests\nDoes this PR introduce a breaking change? (check one with \"x\")\n[ ] Yes\n[x] No", "createdAt": "2020-07-20T08:22:41Z", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018", "merged": true, "mergeCommit": {"oid": "59a1a4a3568eea29fddfe320de4dfee4c3162ac6"}, "closed": true, "closedAt": "2020-07-20T15:58:56Z", "author": {"login": "danlysiak"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc2tIAeAH2gAyNDUzMTg4MDQ3OmRjZmM4ZGRlNWVkZGVlNDg3NzBkZGIyNWE4ODVlNGEzNzhhNjNmMGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc2y64zAH2gAyNDUzMTg4MDQ3OjhlMDMwMWYwMWFhMTcwMGUyYWVhYTA1YWRiMjMyNWI1NjMzNTE1OTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dcfc8dde5eddee48770ddb25a885e4a378a63f0f", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/dcfc8dde5eddee48770ddb25a885e4a378a63f0f", "committedDate": "2020-07-20T08:12:28Z", "message": "RDM-9045 - Add configurable logging of roles for requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64c7a669a14ff5e152e76e18b3c5bb68c1263584", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/64c7a669a14ff5e152e76e18b3c5bb68c1263584", "committedDate": "2020-07-20T08:20:53Z", "message": "Suppressions/checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMzk0NjU5", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451394659", "createdAt": "2020-07-20T08:23:20Z", "commit": {"oid": "64c7a669a14ff5e152e76e18b3c5bb68c1263584"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODoyMzoyMVrOGz_U-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODoyMzoyMVrOGz_U-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE2ODEyMw==", "bodyText": "These can be overridden in Flux config when role logging is required.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#discussion_r457168123", "createdAt": "2020-07-20T08:23:21Z", "author": {"login": "danlysiak"}, "path": "charts/ccd-data-store-api/values.yaml", "diffHunk": "@@ -60,3 +60,6 @@ java:\n     HTTP_CLIENT_SECONDS_IDLE_CONNECTION: '120'\n     HTTP_CLIENT_MAX_CLIENT_PER_ROUTE: '20'\n     HTTP_CLIENT_VALIDATE_AFTER_INACTIVITY: '2000'\n+\n+    DATA_STORE_ROLE_LOGGING_ENABLED: 'false'\n+    DATA_STORE_ROLE_LOGGING_PATH_REGEX: '.*'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64c7a669a14ff5e152e76e18b3c5bb68c1263584"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMzk0OTIw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451394920", "createdAt": "2020-07-20T08:23:42Z", "commit": {"oid": "64c7a669a14ff5e152e76e18b3c5bb68c1263584"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODoyMzo0MlrOGz_V-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODoyMzo0MlrOGz_V-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE2ODM3Nw==", "bodyText": "Can be uncommented if desired for local dev.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#discussion_r457168377", "createdAt": "2020-07-20T08:23:42Z", "author": {"login": "danlysiak"}, "path": "src/main/resources/application.properties", "diffHunk": "@@ -116,6 +116,7 @@ logging.level.uk.gov.hmcts.ccd=${DATA_STORE_DEFAULT_LOG_LEVEL:INFO}\n # logging.level.org.springframework.web=DEBUG\n #logging.level.org.hibernate=INFO\n #logging.level.org.hibernate.type.descriptor.sql=trace\n+#logging.level.uk.gov.hmcts.ccd.security.filters.RoleLoggingFilter=DEBUG", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64c7a669a14ff5e152e76e18b3c5bb68c1263584"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNDAyMTY3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451402167", "createdAt": "2020-07-20T08:33:50Z", "commit": {"oid": "64c7a669a14ff5e152e76e18b3c5bb68c1263584"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODozMzo1MFrOGz_2ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODozMzo1MFrOGz_2ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE3NjcxNA==", "bodyText": "i guess it won't log in case of auth failures. Is that OK?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#discussion_r457176714", "createdAt": "2020-07-20T08:33:50Z", "author": {"login": "smathangi"}, "path": "src/main/java/uk/gov/hmcts/ccd/security/filters/RoleLoggingFilter.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package uk.gov.hmcts.ccd.security.filters;\n+\n+import com.microsoft.applicationinsights.telemetry.SeverityLevel;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.filter.OncePerRequestFilter;\n+import uk.gov.hmcts.ccd.AppInsights;\n+import uk.gov.hmcts.ccd.data.SecurityUtils;\n+import uk.gov.hmcts.reform.idam.client.models.UserInfo;\n+\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.util.regex.Pattern;\n+\n+@Component\n+@ConditionalOnProperty(value = \"role.logging.enabled\", havingValue = \"true\")\n+@Slf4j\n+public class RoleLoggingFilter extends OncePerRequestFilter {\n+\n+    private static final String LOG_MESSAGE_TEMPLATE = \"[ROLE LOG] Attempting to serve request %s %s for user with IDAM roles %s\";\n+\n+    private final AppInsights appInsights;\n+    private final SecurityUtils securityUtils;\n+    private final Pattern pathPattern;\n+\n+    @Autowired\n+    public RoleLoggingFilter(AppInsights appInsights, SecurityUtils securityUtils, @Value(\"${role.logging.path.regex}\") String pathRegex) {\n+        this.appInsights = appInsights;\n+        this.securityUtils = securityUtils;\n+        this.pathPattern = Pattern.compile(pathRegex);\n+    }\n+\n+    @Override\n+    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)\n+        throws ServletException, IOException {\n+        String message = buildLogMessage(request, securityUtils.getUserInfo());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64c7a669a14ff5e152e76e18b3c5bb68c1263584"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNDA4OTMw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451408930", "createdAt": "2020-07-20T08:42:56Z", "commit": {"oid": "64c7a669a14ff5e152e76e18b3c5bb68c1263584"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODo0Mjo1NlrOG0ASVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODo0Mjo1NlrOG0ASVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE4MzgyOQ==", "bodyText": "I think instead of switching the logging on and off, we should just change the logging level per package/class.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#discussion_r457183829", "createdAt": "2020-07-20T08:42:56Z", "author": {"login": "MSancaktutar"}, "path": "charts/ccd-data-store-api/values.yaml", "diffHunk": "@@ -60,3 +60,6 @@ java:\n     HTTP_CLIENT_SECONDS_IDLE_CONNECTION: '120'\n     HTTP_CLIENT_MAX_CLIENT_PER_ROUTE: '20'\n     HTTP_CLIENT_VALIDATE_AFTER_INACTIVITY: '2000'\n+\n+    DATA_STORE_ROLE_LOGGING_ENABLED: 'false'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64c7a669a14ff5e152e76e18b3c5bb68c1263584"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNDExNjQy", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451411642", "createdAt": "2020-07-20T08:46:39Z", "commit": {"oid": "64c7a669a14ff5e152e76e18b3c5bb68c1263584"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODo0Njo0MFrOG0Ac_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODo0Njo0MFrOG0Ac_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE4NjU1OQ==", "bodyText": "I was thinking to have only a log-level alignment, rather than a logical switch to enable/disable the related logging at all.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#discussion_r457186559", "createdAt": "2020-07-20T08:46:40Z", "author": {"login": "MSancaktutar"}, "path": "src/main/resources/application.properties", "diffHunk": "@@ -162,3 +163,7 @@ ccd.am.read.from_am=${CCD_AM_READ_FROM_AM:}\n # http statuses with comma separated to ignore audit logs\n audit.log.ignore.statues=404\n audit.log.enabled=true\n+\n+# Role logging\n+role.logging.enabled=${DATA_STORE_ROLE_LOGGING_ENABLED:false}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64c7a669a14ff5e152e76e18b3c5bb68c1263584"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dab81c865bf87859c2f46066fef3ec85e699b36a", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/dab81c865bf87859c2f46066fef3ec85e699b36a", "committedDate": "2020-07-20T10:09:24Z", "message": "RDM-9045 - Always include new filter in filter chain; use debug in AI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79fe1fe77a60650f17635789a60d347142f5da01", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/79fe1fe77a60650f17635789a60d347142f5da01", "committedDate": "2020-07-20T10:09:34Z", "message": "Missed changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/23ccbaeb5bb8c24ced929d3ec34c249937adf095", "committedDate": "2020-07-20T10:46:57Z", "message": "Typo in commented property"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNTk0Nzcz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451594773", "createdAt": "2020-07-20T13:16:57Z", "commit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzoxNjo1N1rOG0L0TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzoxNjo1N1rOG0L0TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3Mjc0OQ==", "bodyText": "I think this name is a bit too generic. We can't log everything with this filter. Maybe a bit more specific name would help", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#discussion_r457372749", "createdAt": "2020-07-20T13:16:57Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/security/filters/LoggingFilter.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package uk.gov.hmcts.ccd.security.filters;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.web.filter.OncePerRequestFilter;\n+import uk.gov.hmcts.ccd.data.SecurityUtils;\n+import uk.gov.hmcts.reform.idam.client.models.UserInfo;\n+\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.util.regex.Pattern;\n+\n+@Slf4j\n+public class LoggingFilter extends OncePerRequestFilter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNTk1MTA4", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451595108", "createdAt": "2020-07-20T13:17:22Z", "commit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzoxNzoyMlrOG0L1YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzoxNzoyMlrOG0L1YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3MzAyNA==", "bodyText": "can you add a short Javadoc description please", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#discussion_r457373024", "createdAt": "2020-07-20T13:17:22Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/security/filters/LoggingFilter.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package uk.gov.hmcts.ccd.security.filters;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.web.filter.OncePerRequestFilter;\n+import uk.gov.hmcts.ccd.data.SecurityUtils;\n+import uk.gov.hmcts.reform.idam.client.models.UserInfo;\n+\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.util.regex.Pattern;\n+\n+@Slf4j", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNTk2NzEy", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451596712", "createdAt": "2020-07-20T13:19:22Z", "commit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzoxOToyMlrOG0L7Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzoxOToyMlrOG0L7Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3NDU1OQ==", "bodyText": "this name is a bit too generic. Maybe a more specific name would help. Or you can add a small description", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#discussion_r457374559", "createdAt": "2020-07-20T13:19:22Z", "author": {"login": "mario-paniccia"}, "path": "charts/ccd-data-store-api/values.yaml", "diffHunk": "@@ -60,3 +60,5 @@ java:\n     HTTP_CLIENT_SECONDS_IDLE_CONNECTION: '120'\n     HTTP_CLIENT_MAX_CLIENT_PER_ROUTE: '20'\n     HTTP_CLIENT_VALIDATE_AFTER_INACTIVITY: '2000'\n+\n+    DATA_STORE_LOGGING_FILTER_PATH_REGEX: '.*'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNTk5NjUz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451599653", "createdAt": "2020-07-20T13:22:52Z", "commit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzoyMjo1MlrOG0MHng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzoyMjo1MlrOG0MHng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3NzY5NA==", "bodyText": "can we check with Platform Engineering to see that they are ok with this? not sure if there are any guidelines in place that would discourage not to send debug logs on app insights.\nAlso, keep in mind that in the past we always double checked that no sensible data is logged in INFO or above. Because we knew that would be visible in AppInsights to any user. But we never checked something similar for debug logs. Wonder whether there are existing debug log that would log sensible data\nWe need to be careful with sending DEBUG logs to AppInsights because it's more likely that a Dev can expose sensible data accidentally in a DEBUG log", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#discussion_r457377694", "createdAt": "2020-07-20T13:22:52Z", "author": {"login": "mario-paniccia"}, "path": "lib/AI-Agent.xml", "diffHunk": "@@ -1,6 +1,6 @@\n <?xml version=\"1.0\" encoding=\"utf-8\"?>\n <ApplicationInsightsAgent>\n-    <AgentLogger>INFO</AgentLogger>\n+    <AgentLogger>DEBUG</AgentLogger>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNjA5Njg3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451609687", "createdAt": "2020-07-20T13:34:19Z", "commit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzozNDoxOVrOG0Mveg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzozNDoxOVrOG0Mveg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM4Nzg5OA==", "bodyText": "isn't it simpler to just log on INFO? it's definitely an important type of information that can be logged as INFO.\nThis would be a safer approach as we wouldn't need to change the AppInsights log level", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#discussion_r457387898", "createdAt": "2020-07-20T13:34:19Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/security/filters/LoggingFilter.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package uk.gov.hmcts.ccd.security.filters;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.web.filter.OncePerRequestFilter;\n+import uk.gov.hmcts.ccd.data.SecurityUtils;\n+import uk.gov.hmcts.reform.idam.client.models.UserInfo;\n+\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.util.regex.Pattern;\n+\n+@Slf4j\n+public class LoggingFilter extends OncePerRequestFilter {\n+\n+    private static final String LOG_MESSAGE_TEMPLATE = \"[LOG FILTER] Attempting to serve request %s %s for user with IDAM roles %s\";\n+\n+    private final SecurityUtils securityUtils;\n+    private final Pattern pathPattern;\n+\n+    public LoggingFilter(SecurityUtils securityUtils, String pathRegex) {\n+        this.securityUtils = securityUtils;\n+        this.pathPattern = Pattern.compile(pathRegex);\n+    }\n+\n+    @Override\n+    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)\n+        throws ServletException, IOException {\n+        log.debug(buildLogMessage(request, securityUtils.getUserInfo()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNjExNjM0", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451611634", "createdAt": "2020-07-20T13:36:35Z", "commit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzozNjozNVrOG0M3yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzozNjozNVrOG0M3yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM5MDAyNA==", "bodyText": "doesn't LOG4J add the class name ([LOG FILTER]) already by default?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#discussion_r457390024", "createdAt": "2020-07-20T13:36:35Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/security/filters/LoggingFilter.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package uk.gov.hmcts.ccd.security.filters;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.web.filter.OncePerRequestFilter;\n+import uk.gov.hmcts.ccd.data.SecurityUtils;\n+import uk.gov.hmcts.reform.idam.client.models.UserInfo;\n+\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.util.regex.Pattern;\n+\n+@Slf4j\n+public class LoggingFilter extends OncePerRequestFilter {\n+\n+    private static final String LOG_MESSAGE_TEMPLATE = \"[LOG FILTER] Attempting to serve request %s %s for user with IDAM roles %s\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNjEyMzQz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451612343", "createdAt": "2020-07-20T13:37:21Z", "commit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNjE3MjA4", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451617208", "createdAt": "2020-07-20T13:42:50Z", "commit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzo0Mjo1MFrOG0NOeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzo0Mjo1MFrOG0NOeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM5NTgzMw==", "bodyText": "I know the AppInsights client library is async and performant but that would be much more logging we are sending so maybe we should verify the impact on DataStore performance?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#discussion_r457395833", "createdAt": "2020-07-20T13:42:50Z", "author": {"login": "mario-paniccia"}, "path": "lib/AI-Agent.xml", "diffHunk": "@@ -1,6 +1,6 @@\n <?xml version=\"1.0\" encoding=\"utf-8\"?>\n <ApplicationInsightsAgent>\n-    <AgentLogger>INFO</AgentLogger>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNjE5MjM1", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451619235", "createdAt": "2020-07-20T13:45:03Z", "commit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzo0NTowM1rOG0NWNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzo0NTowM1rOG0NWNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM5NzgxNA==", "bodyText": "was just wondering if it's simpler to just log the user info at INFO level. Less changes would be required.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#discussion_r457397814", "createdAt": "2020-07-20T13:45:03Z", "author": {"login": "mario-paniccia"}, "path": "lib/AI-Agent.xml", "diffHunk": "@@ -1,6 +1,6 @@\n <?xml version=\"1.0\" encoding=\"utf-8\"?>\n <ApplicationInsightsAgent>\n-    <AgentLogger>INFO</AgentLogger>\n+    <AgentLogger>DEBUG</AgentLogger>\n     <Instrumentation>\n         <BuiltIn enabled=\"true\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNjMzMDA3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1018#pullrequestreview-451633007", "createdAt": "2020-07-20T14:00:00Z", "commit": {"oid": "23ccbaeb5bb8c24ced929d3ec34c249937adf095"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e2c5068030060c89eecefc74d82fffd51c05cab", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/5e2c5068030060c89eecefc74d82fffd51c05cab", "committedDate": "2020-07-20T14:38:04Z", "message": "Review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac0f68c445f7a7bd0410dd8c5ec0648e253c8641", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/ac0f68c445f7a7bd0410dd8c5ec0648e253c8641", "committedDate": "2020-07-20T14:43:24Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e0301f01aa1700e2aeaa05adb2325b563351598", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/8e0301f01aa1700e2aeaa05adb2325b563351598", "committedDate": "2020-07-20T14:57:34Z", "message": "Revert AI agent"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2840, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}