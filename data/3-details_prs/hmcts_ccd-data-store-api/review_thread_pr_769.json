{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1NzgzMjYw", "number": 769, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMTowMjowOFrODZyqZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOTowODoyOFrODabA1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MzcxMDQ3OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMTowMjowOFrOFgYOIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMTowMjowOFrOFgYOIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ5NTU4Nw==", "bodyText": "this validation already occurs in definition-store. If we re-force it here then we should throw an error immediately rather than fallback to JSONB group.\nAlso VALID_FIELD_NAME_REGEX should in sync with fieldNames pattern of definition.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r369495587", "createdAt": "2020-01-22T11:02:08Z", "author": {"login": "smathangi"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -12,23 +21,39 @@\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n \n+    private static final Set<String> VALID_COLUMNS_FOR_ORDER_BY\n+        = Collections.unmodifiableSet((Set<? extends String>) Stream\n+                                          .of(CaseDetailsEntity.CREATED_DATE_FIELD_COL,\n+                                              CaseDetailsEntity.LAST_MODIFIED_FIELD_COL,\n+                                              CaseDetailsEntity.JURISDICTION_FIELD_COL,\n+                                              CaseDetailsEntity.CASE_TYPE_ID_FIELD_COL,\n+                                              CaseDetailsEntity.STATE_FIELD_COL,\n+                                              CaseDetailsEntity.REFERENCE_FIELD_COL,\n+                                              CaseDetailsEntity.SECURITY_CLASSIFICATION_FIELD_COL)\n+                                          .collect(Collectors.toCollection(HashSet::new)));\n+\n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n+            if (sortOrderField.isMetadata() && VALID_COLUMNS_FOR_ORDER_BY.contains(getMataFieldName(sortOrderField.getCaseFieldId()))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bde396fe6c71ead75cf699ab473d8522773c0dc9"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Mzc3NzY2OnYy", "diffSide": "LEFT", "path": "src/test/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilderTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMToyNzo0M1rOFgY3Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMToyNzo0M1rOFgY3Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUwNjE0Ng==", "bodyText": "Looks good overall, but couldn't grasp the reason to remove this test class at first sight.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r369506146", "createdAt": "2020-01-22T11:27:43Z", "author": {"login": "MSancaktutar"}, "path": "src/test/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilderTest.java", "diffHunk": "@@ -1,80 +0,0 @@\n-package uk.gov.hmcts.ccd.data.casedetails.search;\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bde396fe6c71ead75cf699ab473d8522773c0dc9"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MzgwNTgwOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMTozODoyMVrOFgZIPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMTo1NjowOFrOFgZnrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUxMDQ2Mg==", "bodyText": "I would put the validation here, at the exact point where the data is being converted to SQL, and throw an exception if the sort order is invalid. Otherwise I have to look around a bunch of different places to figure out if the validation always happens.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r369510462", "createdAt": "2020-01-22T11:38:21Z", "author": {"login": "banderous"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -12,23 +21,39 @@\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n \n+    private static final Set<String> VALID_COLUMNS_FOR_ORDER_BY\n+        = Collections.unmodifiableSet((Set<? extends String>) Stream\n+                                          .of(CaseDetailsEntity.CREATED_DATE_FIELD_COL,\n+                                              CaseDetailsEntity.LAST_MODIFIED_FIELD_COL,\n+                                              CaseDetailsEntity.JURISDICTION_FIELD_COL,\n+                                              CaseDetailsEntity.CASE_TYPE_ID_FIELD_COL,\n+                                              CaseDetailsEntity.STATE_FIELD_COL,\n+                                              CaseDetailsEntity.REFERENCE_FIELD_COL,\n+                                              CaseDetailsEntity.SECURITY_CLASSIFICATION_FIELD_COL)\n+                                          .collect(Collectors.toCollection(HashSet::new)));\n+\n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n+            if (sortOrderField.isMetadata() && VALID_COLUMNS_FOR_ORDER_BY.contains(getMataFieldName(sortOrderField.getCaseFieldId()))) {\n                 sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n+                appendOrder(sb, sortOrderField);\n+            } else if (sortOrderField.getCaseFieldId().matches(VALID_FIELD_NAME_REGEX)) {\n                 sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+                appendOrder(sb, sortOrderField);\n             }\n-            sb.append(SPACE);\n-            sb.append(sortOrderField.getDirection());\n-            sb.append(COMMA);\n-            sb.append(SPACE);\n         });\n         // always sort with creation_date as a last order so that it supports cases where no values at all for the configured fields and also default fallback.\n         return sb.append(CREATED_DATE + SPACE + SortDirection.fromOptionalString(metaData.getSortDirection())).toString();\n     }\n \n+    private void appendOrder(final StringBuilder sb, final SortOrderField sortOrderField) {\n+        sb.append(SPACE);\n+        sb.append(sortOrderField.getDirection());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bde396fe6c71ead75cf699ab473d8522773c0dc9"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUxNDg2NA==", "bodyText": "Not sure I understand - the appending happens in the if else as well?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r369514864", "createdAt": "2020-01-22T11:48:03Z", "author": {"login": "andrewfolga"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -12,23 +21,39 @@\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n \n+    private static final Set<String> VALID_COLUMNS_FOR_ORDER_BY\n+        = Collections.unmodifiableSet((Set<? extends String>) Stream\n+                                          .of(CaseDetailsEntity.CREATED_DATE_FIELD_COL,\n+                                              CaseDetailsEntity.LAST_MODIFIED_FIELD_COL,\n+                                              CaseDetailsEntity.JURISDICTION_FIELD_COL,\n+                                              CaseDetailsEntity.CASE_TYPE_ID_FIELD_COL,\n+                                              CaseDetailsEntity.STATE_FIELD_COL,\n+                                              CaseDetailsEntity.REFERENCE_FIELD_COL,\n+                                              CaseDetailsEntity.SECURITY_CLASSIFICATION_FIELD_COL)\n+                                          .collect(Collectors.toCollection(HashSet::new)));\n+\n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n+            if (sortOrderField.isMetadata() && VALID_COLUMNS_FOR_ORDER_BY.contains(getMataFieldName(sortOrderField.getCaseFieldId()))) {\n                 sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n+                appendOrder(sb, sortOrderField);\n+            } else if (sortOrderField.getCaseFieldId().matches(VALID_FIELD_NAME_REGEX)) {\n                 sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+                appendOrder(sb, sortOrderField);\n             }\n-            sb.append(SPACE);\n-            sb.append(sortOrderField.getDirection());\n-            sb.append(COMMA);\n-            sb.append(SPACE);\n         });\n         // always sort with creation_date as a last order so that it supports cases where no values at all for the configured fields and also default fallback.\n         return sb.append(CREATED_DATE + SPACE + SortDirection.fromOptionalString(metaData.getSortDirection())).toString();\n     }\n \n+    private void appendOrder(final StringBuilder sb, final SortOrderField sortOrderField) {\n+        sb.append(SPACE);\n+        sb.append(sortOrderField.getDirection());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUxMDQ2Mg=="}, "originalCommit": {"oid": "bde396fe6c71ead75cf699ab473d8522773c0dc9"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUxODUxMA==", "bodyText": "ok I will add a top level if block looking for special characters:\nmetaData.getSortOrderFields().forEach(sortOrderField -> {\n            if (!sortOrderField.getCaseFieldId().matches(SPECIAL_CHARS)) {\n                if (sortOrderField.isMetadata()) {\n                    sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n                } else {\n                    sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n                }\n                sb.append(SPACE);\n                sb.append(sortOrderField.getDirection());\n                sb.append(COMMA);\n                sb.append(SPACE);\n            }\n        });", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r369518510", "createdAt": "2020-01-22T11:56:08Z", "author": {"login": "andrewfolga"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -12,23 +21,39 @@\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n \n+    private static final Set<String> VALID_COLUMNS_FOR_ORDER_BY\n+        = Collections.unmodifiableSet((Set<? extends String>) Stream\n+                                          .of(CaseDetailsEntity.CREATED_DATE_FIELD_COL,\n+                                              CaseDetailsEntity.LAST_MODIFIED_FIELD_COL,\n+                                              CaseDetailsEntity.JURISDICTION_FIELD_COL,\n+                                              CaseDetailsEntity.CASE_TYPE_ID_FIELD_COL,\n+                                              CaseDetailsEntity.STATE_FIELD_COL,\n+                                              CaseDetailsEntity.REFERENCE_FIELD_COL,\n+                                              CaseDetailsEntity.SECURITY_CLASSIFICATION_FIELD_COL)\n+                                          .collect(Collectors.toCollection(HashSet::new)));\n+\n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n+            if (sortOrderField.isMetadata() && VALID_COLUMNS_FOR_ORDER_BY.contains(getMataFieldName(sortOrderField.getCaseFieldId()))) {\n                 sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n+                appendOrder(sb, sortOrderField);\n+            } else if (sortOrderField.getCaseFieldId().matches(VALID_FIELD_NAME_REGEX)) {\n                 sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+                appendOrder(sb, sortOrderField);\n             }\n-            sb.append(SPACE);\n-            sb.append(sortOrderField.getDirection());\n-            sb.append(COMMA);\n-            sb.append(SPACE);\n         });\n         // always sort with creation_date as a last order so that it supports cases where no values at all for the configured fields and also default fallback.\n         return sb.append(CREATED_DATE + SPACE + SortDirection.fromOptionalString(metaData.getSortDirection())).toString();\n     }\n \n+    private void appendOrder(final StringBuilder sb, final SortOrderField sortOrderField) {\n+        sb.append(SPACE);\n+        sb.append(sortOrderField.getDirection());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUxMDQ2Mg=="}, "originalCommit": {"oid": "bde396fe6c71ead75cf699ab473d8522773c0dc9"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MzkwMTg2OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "isResolved": false, "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMjoxMzowMlrOFgaBgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMTo0Nzo1MFrOFg7cuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUyNTEyMA==", "bodyText": "Based on the latest discussions around logic duplication between def store and data store, I think we can indeed remove this allowed-list approach as well. We can stay within the purpose of just SQL-i prevention by just rejecting a few special chars in case field ids, and indeed, case field IDs can reasonably be assumed to not contain such chars, no matter how their validity conventions change in the foreseeable future.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r369525120", "createdAt": "2020-01-22T12:13:02Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -12,23 +21,39 @@\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n \n+    private static final Set<String> VALID_COLUMNS_FOR_ORDER_BY\n+        = Collections.unmodifiableSet((Set<? extends String>) Stream\n+                                          .of(CaseDetailsEntity.CREATED_DATE_FIELD_COL,\n+                                              CaseDetailsEntity.LAST_MODIFIED_FIELD_COL,\n+                                              CaseDetailsEntity.JURISDICTION_FIELD_COL,\n+                                              CaseDetailsEntity.CASE_TYPE_ID_FIELD_COL,\n+                                              CaseDetailsEntity.STATE_FIELD_COL,\n+                                              CaseDetailsEntity.REFERENCE_FIELD_COL,\n+                                              CaseDetailsEntity.SECURITY_CLASSIFICATION_FIELD_COL)\n+                                          .collect(Collectors.toCollection(HashSet::new)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c2bbddbbc01039830a0e55b75a1e50064cc1a29"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0Mzk5OA==", "bodyText": "The OWASP guide recommends blacklisting only as a last resort:\n\nThis technique should only be used as a last resort, when none of the above are feasible. Input validation is probably a better choice as this methodology is frail compared to other defenses and we cannot guarantee it will prevent all SQL Injection in all situations.\n\nIf in this case we know the range of possible values then Andrew's original whitelisting would be my preference but either approach is an improvement.\nRegarding the duplication between definition and data stores, I see this as an indicator that these services should be merged together, which would also simplify testing (no wiremock or duplication of models, cannot commit breaking changes to data store into def store).", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r369543998", "createdAt": "2020-01-22T12:58:40Z", "author": {"login": "banderous"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -12,23 +21,39 @@\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n \n+    private static final Set<String> VALID_COLUMNS_FOR_ORDER_BY\n+        = Collections.unmodifiableSet((Set<? extends String>) Stream\n+                                          .of(CaseDetailsEntity.CREATED_DATE_FIELD_COL,\n+                                              CaseDetailsEntity.LAST_MODIFIED_FIELD_COL,\n+                                              CaseDetailsEntity.JURISDICTION_FIELD_COL,\n+                                              CaseDetailsEntity.CASE_TYPE_ID_FIELD_COL,\n+                                              CaseDetailsEntity.STATE_FIELD_COL,\n+                                              CaseDetailsEntity.REFERENCE_FIELD_COL,\n+                                              CaseDetailsEntity.SECURITY_CLASSIFICATION_FIELD_COL)\n+                                          .collect(Collectors.toCollection(HashSet::new)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUyNTEyMA=="}, "originalCommit": {"oid": "3c2bbddbbc01039830a0e55b75a1e50064cc1a29"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU4MTY0OA==", "bodyText": "Yes I was following the OWASP guide and initially tried to do white listing solution. The problem with that is it creates dependency on whatever change is introduced to case_data table's columns. I am ok with either solution here but the the common denominator between @MSancaktutar @smathangi and myself was blacklisting...\n@MSancaktutar let me know what you think?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r369581648", "createdAt": "2020-01-22T14:13:20Z", "author": {"login": "andrewfolga"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -12,23 +21,39 @@\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n \n+    private static final Set<String> VALID_COLUMNS_FOR_ORDER_BY\n+        = Collections.unmodifiableSet((Set<? extends String>) Stream\n+                                          .of(CaseDetailsEntity.CREATED_DATE_FIELD_COL,\n+                                              CaseDetailsEntity.LAST_MODIFIED_FIELD_COL,\n+                                              CaseDetailsEntity.JURISDICTION_FIELD_COL,\n+                                              CaseDetailsEntity.CASE_TYPE_ID_FIELD_COL,\n+                                              CaseDetailsEntity.STATE_FIELD_COL,\n+                                              CaseDetailsEntity.REFERENCE_FIELD_COL,\n+                                              CaseDetailsEntity.SECURITY_CLASSIFICATION_FIELD_COL)\n+                                          .collect(Collectors.toCollection(HashSet::new)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUyNTEyMA=="}, "originalCommit": {"oid": "3c2bbddbbc01039830a0e55b75a1e50064cc1a29"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4MTExMw==", "bodyText": "Sanitising input against a disallowed list is in this case more efficient and well-secure. It is an ORDER BY clause we're building and preventing those disallowed chars solves the same problem to the same effect with less coupling with other parts of CCD.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r369981113", "createdAt": "2020-01-23T08:23:52Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -12,23 +21,39 @@\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n \n+    private static final Set<String> VALID_COLUMNS_FOR_ORDER_BY\n+        = Collections.unmodifiableSet((Set<? extends String>) Stream\n+                                          .of(CaseDetailsEntity.CREATED_DATE_FIELD_COL,\n+                                              CaseDetailsEntity.LAST_MODIFIED_FIELD_COL,\n+                                              CaseDetailsEntity.JURISDICTION_FIELD_COL,\n+                                              CaseDetailsEntity.CASE_TYPE_ID_FIELD_COL,\n+                                              CaseDetailsEntity.STATE_FIELD_COL,\n+                                              CaseDetailsEntity.REFERENCE_FIELD_COL,\n+                                              CaseDetailsEntity.SECURITY_CLASSIFICATION_FIELD_COL)\n+                                          .collect(Collectors.toCollection(HashSet::new)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUyNTEyMA=="}, "originalCommit": {"oid": "3c2bbddbbc01039830a0e55b75a1e50064cc1a29"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAwNzExNg==", "bodyText": "The OWASP guide is explicit that blacklisting should be the last resort and only used for securing legacy code; there are issues such as Unicode smuggling where special characters can get past a blacklist and get converted to dangerous characters by the database.\nIn this case the range of valid input is known so whitelisting is the secure way to go; a switch statement that only outputs known valid constants.\nDatabase queries are inherently coupled to the schema they operate on, which is why it's problematic to split schema out of a database into its own service as we have done. If we are going to persist with the split then duplication is inevitable.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370007116", "createdAt": "2020-01-23T09:24:15Z", "author": {"login": "banderous"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -12,23 +21,39 @@\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n \n+    private static final Set<String> VALID_COLUMNS_FOR_ORDER_BY\n+        = Collections.unmodifiableSet((Set<? extends String>) Stream\n+                                          .of(CaseDetailsEntity.CREATED_DATE_FIELD_COL,\n+                                              CaseDetailsEntity.LAST_MODIFIED_FIELD_COL,\n+                                              CaseDetailsEntity.JURISDICTION_FIELD_COL,\n+                                              CaseDetailsEntity.CASE_TYPE_ID_FIELD_COL,\n+                                              CaseDetailsEntity.STATE_FIELD_COL,\n+                                              CaseDetailsEntity.REFERENCE_FIELD_COL,\n+                                              CaseDetailsEntity.SECURITY_CLASSIFICATION_FIELD_COL)\n+                                          .collect(Collectors.toCollection(HashSet::new)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUyNTEyMA=="}, "originalCommit": {"oid": "3c2bbddbbc01039830a0e55b75a1e50064cc1a29"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAyNjE2NA==", "bodyText": "I think this whitelist check for metadata fields are already happening against a ENUM. Is it not good enough?  \n  \n    \n      ccd-data-store-api/src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java\n    \n    \n         Line 42\n      in\n      75fbac7\n    \n    \n    \n    \n\n        \n          \n           return CaseField.valueOf(metaFieldName).getDbColumnName();", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370026164", "createdAt": "2020-01-23T10:02:14Z", "author": {"login": "smathangi"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -12,23 +21,39 @@\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n \n+    private static final Set<String> VALID_COLUMNS_FOR_ORDER_BY\n+        = Collections.unmodifiableSet((Set<? extends String>) Stream\n+                                          .of(CaseDetailsEntity.CREATED_DATE_FIELD_COL,\n+                                              CaseDetailsEntity.LAST_MODIFIED_FIELD_COL,\n+                                              CaseDetailsEntity.JURISDICTION_FIELD_COL,\n+                                              CaseDetailsEntity.CASE_TYPE_ID_FIELD_COL,\n+                                              CaseDetailsEntity.STATE_FIELD_COL,\n+                                              CaseDetailsEntity.REFERENCE_FIELD_COL,\n+                                              CaseDetailsEntity.SECURITY_CLASSIFICATION_FIELD_COL)\n+                                          .collect(Collectors.toCollection(HashSet::new)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUyNTEyMA=="}, "originalCommit": {"oid": "3c2bbddbbc01039830a0e55b75a1e50064cc1a29"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA2MDQwMw==", "bodyText": "Yes @smathangi this is the right approach, a couple more places where the same needs to be done.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370060403", "createdAt": "2020-01-23T11:16:14Z", "author": {"login": "banderous"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -12,23 +21,39 @@\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n \n+    private static final Set<String> VALID_COLUMNS_FOR_ORDER_BY\n+        = Collections.unmodifiableSet((Set<? extends String>) Stream\n+                                          .of(CaseDetailsEntity.CREATED_DATE_FIELD_COL,\n+                                              CaseDetailsEntity.LAST_MODIFIED_FIELD_COL,\n+                                              CaseDetailsEntity.JURISDICTION_FIELD_COL,\n+                                              CaseDetailsEntity.CASE_TYPE_ID_FIELD_COL,\n+                                              CaseDetailsEntity.STATE_FIELD_COL,\n+                                              CaseDetailsEntity.REFERENCE_FIELD_COL,\n+                                              CaseDetailsEntity.SECURITY_CLASSIFICATION_FIELD_COL)\n+                                          .collect(Collectors.toCollection(HashSet::new)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUyNTEyMA=="}, "originalCommit": {"oid": "3c2bbddbbc01039830a0e55b75a1e50064cc1a29"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA2NTcwMA==", "bodyText": "@banderous can you let me know which places do you mean?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370065700", "createdAt": "2020-01-23T11:29:29Z", "author": {"login": "andrewfolga"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -12,23 +21,39 @@\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n \n+    private static final Set<String> VALID_COLUMNS_FOR_ORDER_BY\n+        = Collections.unmodifiableSet((Set<? extends String>) Stream\n+                                          .of(CaseDetailsEntity.CREATED_DATE_FIELD_COL,\n+                                              CaseDetailsEntity.LAST_MODIFIED_FIELD_COL,\n+                                              CaseDetailsEntity.JURISDICTION_FIELD_COL,\n+                                              CaseDetailsEntity.CASE_TYPE_ID_FIELD_COL,\n+                                              CaseDetailsEntity.STATE_FIELD_COL,\n+                                              CaseDetailsEntity.REFERENCE_FIELD_COL,\n+                                              CaseDetailsEntity.SECURITY_CLASSIFICATION_FIELD_COL)\n+                                          .collect(Collectors.toCollection(HashSet::new)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUyNTEyMA=="}, "originalCommit": {"oid": "3c2bbddbbc01039830a0e55b75a1e50064cc1a29"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA3Mjc2MA==", "bodyText": "@andrewfolga individual comments are in the review I made requesting changes.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370072760", "createdAt": "2020-01-23T11:47:50Z", "author": {"login": "banderous"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -12,23 +21,39 @@\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n \n+    private static final Set<String> VALID_COLUMNS_FOR_ORDER_BY\n+        = Collections.unmodifiableSet((Set<? extends String>) Stream\n+                                          .of(CaseDetailsEntity.CREATED_DATE_FIELD_COL,\n+                                              CaseDetailsEntity.LAST_MODIFIED_FIELD_COL,\n+                                              CaseDetailsEntity.JURISDICTION_FIELD_COL,\n+                                              CaseDetailsEntity.CASE_TYPE_ID_FIELD_COL,\n+                                              CaseDetailsEntity.STATE_FIELD_COL,\n+                                              CaseDetailsEntity.REFERENCE_FIELD_COL,\n+                                              CaseDetailsEntity.SECURITY_CLASSIFICATION_FIELD_COL)\n+                                          .collect(Collectors.toCollection(HashSet::new)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUyNTEyMA=="}, "originalCommit": {"oid": "3c2bbddbbc01039830a0e55b75a1e50064cc1a29"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzAzODU3OnYy", "diffSide": "RIGHT", "path": "src/test/java/uk/gov/hmcts/ccd/data/casedetails/DefaultCaseDetailsRepositoryTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwOTo0OTowNVrOFg4MJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwOTo0OTowNVrOFg4MJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAxOTM2NQ==", "bodyText": "double check comment", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370019365", "createdAt": "2020-01-23T09:49:05Z", "author": {"login": "andrewfolga"}, "path": "src/test/java/uk/gov/hmcts/ccd/data/casedetails/DefaultCaseDetailsRepositoryTest.java", "diffHunk": "@@ -201,6 +222,35 @@ public void getFindByMetadataAndFieldDataSortDesc() {\n         assertThat(byMetaDataAndFieldData.get(1).getId(), is(\"1\"));\n     }\n \n+    @Test\n+    @Sql(executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD, scripts = { \"classpath:sql/insert_cases.sql\" })\n+    public void getFindByMetadataAndFieldDataSortByBothCaseAndMetadataFields() {\n+        assumeDataInitialised();\n+\n+        MetaData metadata = new MetaData(\"TestAddressBookCase\", \"PROBATE\");\n+        metadata.setSortDirection(Optional.of(\"Asc\"));\n+        metadata.addSortOrderField(SortOrderField.sortOrderWith()\n+                                       .caseFieldId(\"[LAST_MODIFIED_DATE]\")\n+                                       .metadata(true)\n+                                       .direction(\"ASC\")\n+                                       .build());\n+        metadata.addSortOrderField(SortOrderField.sortOrderWith()\n+                                       .caseFieldId(\"PersonLastName\")\n+                                       .metadata(false)\n+                                       .direction(\"DESC\")\n+                                       .build());\n+\n+        HashMap<String, String> searchParams = new HashMap<>();\n+        searchParams.put(\"PersonFirstName\", \"Janet\");\n+        final List<CaseDetails> byMetaDataAndFieldData = caseDetailsRepository.findByMetaDataAndFieldData(metadata,\n+            searchParams);\n+\n+        // See the timestamps in insert_cases.sql.\n+        // Should be ordered by person last name, last modified desc, creation date asc.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75fbac732d9e24f220afa20f4f56f487f5c5a03c"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzE3ODI1OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMDozMjowNVrOFg5gFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNDo0NjoyOVrOFhAwIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA0MDg1Mw==", "bodyText": "We are appending an arbitrary String here - this should be an Enum, or it looks like you could use SortDirection.fromOptionalString", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370040853", "createdAt": "2020-01-23T10:32:05Z", "author": {"login": "banderous"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -4,26 +4,34 @@\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n-                sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (!matcher.find()) {\n+                if (sortOrderField.isMetadata()) {\n+                    sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+                } else {\n+                    sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+                }\n+                sb.append(SPACE);\n+                sb.append(sortOrderField.getDirection());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e7a20cd927c8c6059af749b8247540ec14619a9"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE1OTY1MQ==", "bodyText": "Good point - done.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370159651", "createdAt": "2020-01-23T14:46:29Z", "author": {"login": "andrewfolga"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -4,26 +4,34 @@\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n-                sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (!matcher.find()) {\n+                if (sortOrderField.isMetadata()) {\n+                    sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+                } else {\n+                    sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+                }\n+                sb.append(SPACE);\n+                sb.append(sortOrderField.getDirection());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA0MDg1Mw=="}, "originalCommit": {"oid": "6e7a20cd927c8c6059af749b8247540ec14619a9"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzE5NTA3OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMDozNzo0NFrOFg5qSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNToxNzo1OVrOFhB9TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA0MzQ2Ng==", "bodyText": "convertFieldNameToJSONBsqlFormat is also vulnerable since it just passes through the input with some substitutions - can we apply a whitelist of known allowed characters to it?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370043466", "createdAt": "2020-01-23T10:37:44Z", "author": {"login": "banderous"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -4,26 +4,34 @@\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n-                sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (!matcher.find()) {\n+                if (sortOrderField.isMetadata()) {\n+                    sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+                } else {\n+                    sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e7a20cd927c8c6059af749b8247540ec14619a9"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE2ODI1OA==", "bodyText": "We already handle that input with blacklisting as per @MSancaktutar comments? See Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370168258", "createdAt": "2020-01-23T14:59:59Z", "author": {"login": "andrewfolga"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -4,26 +4,34 @@\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n-                sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (!matcher.find()) {\n+                if (sortOrderField.isMetadata()) {\n+                    sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+                } else {\n+                    sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA0MzQ2Ng=="}, "originalCommit": {"oid": "6e7a20cd927c8c6059af749b8247540ec14619a9"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE2ODU4Mg==", "bodyText": "This can be any field from within the dynamic case data json so not sure how we would do whitelisting here. Can you elaborate please?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370168582", "createdAt": "2020-01-23T15:00:31Z", "author": {"login": "andrewfolga"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -4,26 +4,34 @@\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n-                sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (!matcher.find()) {\n+                if (sortOrderField.isMetadata()) {\n+                    sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+                } else {\n+                    sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA0MzQ2Ng=="}, "originalCommit": {"oid": "6e7a20cd927c8c6059af749b8247540ec14619a9"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE3OTQwNA==", "bodyText": "Ah yes sorry, I think we are back to the whitelisting vs blacklisting thing again. Whitelisting would involve asserting that the column name only consists of the set of allowable characters in it but we've been over that one :)", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370179404", "createdAt": "2020-01-23T15:17:59Z", "author": {"login": "banderous"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -4,26 +4,34 @@\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n-                sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (!matcher.find()) {\n+                if (sortOrderField.isMetadata()) {\n+                    sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+                } else {\n+                    sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA0MzQ2Ng=="}, "originalCommit": {"oid": "6e7a20cd927c8c6059af749b8247540ec14619a9"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzIwMDMxOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMDozOToyN1rOFg5tfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNjoxMjo1OVrOFhECjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA0NDI4NA==", "bodyText": "You could let the exception propagate and not catch it, or rethrow it. Returning a null values will result in a more cryptic error later on.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370044284", "createdAt": "2020-01-23T10:39:27Z", "author": {"login": "banderous"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -1,37 +1,55 @@\n package uk.gov.hmcts.ccd.data.casedetails.search;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n+    private static final Logger LOG = LoggerFactory.getLogger(SortOrderQueryBuilder.class);\n+\n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n-                sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (!matcher.find()) {\n+                if (sortOrderField.isMetadata()) {\n+                    sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+                } else {\n+                    sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+                }\n+                sb.append(SPACE);\n+                sb.append(sortOrderField.getDirection());\n+                sb.append(COMMA);\n+                sb.append(SPACE);\n             }\n-            sb.append(SPACE);\n-            sb.append(sortOrderField.getDirection());\n-            sb.append(COMMA);\n-            sb.append(SPACE);\n         });\n         // always sort with creation_date as a last order so that it supports cases where no values at all for the configured fields and also default fallback.\n         return sb.append(CREATED_DATE + SPACE + SortDirection.fromOptionalString(metaData.getSortDirection())).toString();\n     }\n \n     private String getMataFieldName(String fieldName) {\n         String metaFieldName = fieldName.startsWith(\"[\") ? StringUtils.substringBetween(fieldName, \"[\", \"]\") : fieldName;\n-        return CaseField.valueOf(metaFieldName).getDbColumnName();\n+        String dbColumnName = null;\n+        try {\n+            dbColumnName = CaseField.valueOf(metaFieldName).getDbColumnName();\n+        } catch (IllegalArgumentException iae) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8dfcc8c016155377b26b05cf44088a96fa19079"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE2OTgwOA==", "bodyText": "I followed your approach where you also do not throw or propagate exception but do not append the section of sql query being built that contains a validation problem. See a test reflecting that here:\n    public void sanitisesInputsCountQuery() {\n        String evil = \"foo');insert into case users values(1,2,3);--\";\n        when(authorisedCaseDefinitionDataService.getUserAuthorisedCaseStateIds(\"PROBATE\", \"TestAddressBookCase\", CAN_READ))\n            .thenReturn(asList(evil));\n\n        when(userAuthorisation.getAccessLevel()).thenReturn(AccessLevel.GRANTED);\n        when(userAuthorisation.getUserId()).thenReturn(evil);\n\n        MetaData metadata = new MetaData(\"TestAddressBookCase\", \"PROBATE\");\n        final PaginatedSearchMetadata byMetaData = caseDetailsRepository.getPaginatedSearchMetadata(metadata, Maps.newHashMap());\n\n        // If any input is not correctly sanitized it will cause an exception since query result structure will not be as hibernate expects.\n        assertThat(byMetaData.getTotalResultsCount(), is(0));\n    }", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370169808", "createdAt": "2020-01-23T15:02:22Z", "author": {"login": "andrewfolga"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -1,37 +1,55 @@\n package uk.gov.hmcts.ccd.data.casedetails.search;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n+    private static final Logger LOG = LoggerFactory.getLogger(SortOrderQueryBuilder.class);\n+\n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n-                sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (!matcher.find()) {\n+                if (sortOrderField.isMetadata()) {\n+                    sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+                } else {\n+                    sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+                }\n+                sb.append(SPACE);\n+                sb.append(sortOrderField.getDirection());\n+                sb.append(COMMA);\n+                sb.append(SPACE);\n             }\n-            sb.append(SPACE);\n-            sb.append(sortOrderField.getDirection());\n-            sb.append(COMMA);\n-            sb.append(SPACE);\n         });\n         // always sort with creation_date as a last order so that it supports cases where no values at all for the configured fields and also default fallback.\n         return sb.append(CREATED_DATE + SPACE + SortDirection.fromOptionalString(metaData.getSortDirection())).toString();\n     }\n \n     private String getMataFieldName(String fieldName) {\n         String metaFieldName = fieldName.startsWith(\"[\") ? StringUtils.substringBetween(fieldName, \"[\", \"]\") : fieldName;\n-        return CaseField.valueOf(metaFieldName).getDbColumnName();\n+        String dbColumnName = null;\n+        try {\n+            dbColumnName = CaseField.valueOf(metaFieldName).getDbColumnName();\n+        } catch (IllegalArgumentException iae) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA0NDI4NA=="}, "originalCommit": {"oid": "a8dfcc8c016155377b26b05cf44088a96fa19079"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4NTg2NA==", "bodyText": "The fix in that case was using OWASP option 1 - parameterised queries. With a parameterised query it doesn't matter what the input is, it should still result in a valid query (that returns zero results).\nIn this case the column name is a parameter so we cannot use a parameterised query and must use OWASP option three - explicitly rejecting the bad input. So in this case I would design the test to expect that IllegalArgument exception and fail if it is not thrown.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370185864", "createdAt": "2020-01-23T15:27:28Z", "author": {"login": "banderous"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -1,37 +1,55 @@\n package uk.gov.hmcts.ccd.data.casedetails.search;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n+    private static final Logger LOG = LoggerFactory.getLogger(SortOrderQueryBuilder.class);\n+\n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n-                sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (!matcher.find()) {\n+                if (sortOrderField.isMetadata()) {\n+                    sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+                } else {\n+                    sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+                }\n+                sb.append(SPACE);\n+                sb.append(sortOrderField.getDirection());\n+                sb.append(COMMA);\n+                sb.append(SPACE);\n             }\n-            sb.append(SPACE);\n-            sb.append(sortOrderField.getDirection());\n-            sb.append(COMMA);\n-            sb.append(SPACE);\n         });\n         // always sort with creation_date as a last order so that it supports cases where no values at all for the configured fields and also default fallback.\n         return sb.append(CREATED_DATE + SPACE + SortDirection.fromOptionalString(metaData.getSortDirection())).toString();\n     }\n \n     private String getMataFieldName(String fieldName) {\n         String metaFieldName = fieldName.startsWith(\"[\") ? StringUtils.substringBetween(fieldName, \"[\", \"]\") : fieldName;\n-        return CaseField.valueOf(metaFieldName).getDbColumnName();\n+        String dbColumnName = null;\n+        try {\n+            dbColumnName = CaseField.valueOf(metaFieldName).getDbColumnName();\n+        } catch (IllegalArgumentException iae) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA0NDI4NA=="}, "originalCommit": {"oid": "a8dfcc8c016155377b26b05cf44088a96fa19079"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIxMzUxNw==", "bodyText": "I would remove this exception handler completely and assert that the illegalargumentexception is thrown in your test", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370213517", "createdAt": "2020-01-23T16:12:59Z", "author": {"login": "banderous"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -1,37 +1,55 @@\n package uk.gov.hmcts.ccd.data.casedetails.search;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n+    private static final Logger LOG = LoggerFactory.getLogger(SortOrderQueryBuilder.class);\n+\n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n     private static final String COMMA = \",\";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n-                sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (!matcher.find()) {\n+                if (sortOrderField.isMetadata()) {\n+                    sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+                } else {\n+                    sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+                }\n+                sb.append(SPACE);\n+                sb.append(sortOrderField.getDirection());\n+                sb.append(COMMA);\n+                sb.append(SPACE);\n             }\n-            sb.append(SPACE);\n-            sb.append(sortOrderField.getDirection());\n-            sb.append(COMMA);\n-            sb.append(SPACE);\n         });\n         // always sort with creation_date as a last order so that it supports cases where no values at all for the configured fields and also default fallback.\n         return sb.append(CREATED_DATE + SPACE + SortDirection.fromOptionalString(metaData.getSortDirection())).toString();\n     }\n \n     private String getMataFieldName(String fieldName) {\n         String metaFieldName = fieldName.startsWith(\"[\") ? StringUtils.substringBetween(fieldName, \"[\", \"]\") : fieldName;\n-        return CaseField.valueOf(metaFieldName).getDbColumnName();\n+        String dbColumnName = null;\n+        try {\n+            dbColumnName = CaseField.valueOf(metaFieldName).getDbColumnName();\n+        } catch (IllegalArgumentException iae) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA0NDI4NA=="}, "originalCommit": {"oid": "a8dfcc8c016155377b26b05cf44088a96fa19079"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzIwMjYyOnYy", "diffSide": "RIGHT", "path": "src/test/java/uk/gov/hmcts/ccd/data/casedetails/DefaultCaseDetailsRepositoryTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMDo0MDoxNlrOFg5u_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNTowMzoyN1rOFhBaXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA0NDY2OA==", "bodyText": "Test passing evil in to the direction too", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370044668", "createdAt": "2020-01-23T10:40:16Z", "author": {"login": "banderous"}, "path": "src/test/java/uk/gov/hmcts/ccd/data/casedetails/DefaultCaseDetailsRepositoryTest.java", "diffHunk": "@@ -153,6 +153,27 @@ public void sanitisesInputs() {\n         assertThat(byMetaData.getTotalResultsCount(), is(0));\n     }\n \n+    @Test\n+    public void sanitisesInputsMainQuery() {\n+        String evil = \"foo');insert into case users values(1,2,3);--\";\n+        when(authorisedCaseDefinitionDataService.getUserAuthorisedCaseStateIds(\"PROBATE\", \"TestAddressBookCase\", CAN_READ))\n+            .thenReturn(asList(evil));\n+\n+        when(userAuthorisation.getAccessLevel()).thenReturn(AccessLevel.GRANTED);\n+        when(userAuthorisation.getUserId()).thenReturn(evil);\n+\n+        MetaData metadata = new MetaData(\"TestAddressBookCase\", \"PROBATE\");\n+        metadata.addSortOrderField(SortOrderField.sortOrderWith()\n+                                       .caseFieldId(evil)\n+                                       .metadata(false)\n+                                       .direction(\"DESC\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8dfcc8c016155377b26b05cf44088a96fa19079"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE3MDQ2MQ==", "bodyText": "I've created an additional test now.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370170461", "createdAt": "2020-01-23T15:03:27Z", "author": {"login": "andrewfolga"}, "path": "src/test/java/uk/gov/hmcts/ccd/data/casedetails/DefaultCaseDetailsRepositoryTest.java", "diffHunk": "@@ -153,6 +153,27 @@ public void sanitisesInputs() {\n         assertThat(byMetaData.getTotalResultsCount(), is(0));\n     }\n \n+    @Test\n+    public void sanitisesInputsMainQuery() {\n+        String evil = \"foo');insert into case users values(1,2,3);--\";\n+        when(authorisedCaseDefinitionDataService.getUserAuthorisedCaseStateIds(\"PROBATE\", \"TestAddressBookCase\", CAN_READ))\n+            .thenReturn(asList(evil));\n+\n+        when(userAuthorisation.getAccessLevel()).thenReturn(AccessLevel.GRANTED);\n+        when(userAuthorisation.getUserId()).thenReturn(evil);\n+\n+        MetaData metadata = new MetaData(\"TestAddressBookCase\", \"PROBATE\");\n+        metadata.addSortOrderField(SortOrderField.sortOrderWith()\n+                                       .caseFieldId(evil)\n+                                       .metadata(false)\n+                                       .direction(\"DESC\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA0NDY2OA=="}, "originalCommit": {"oid": "a8dfcc8c016155377b26b05cf44088a96fa19079"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4ODI5MzYyOnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNjoxNToxNlrOFhEHqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNzozMzowM1rOFhGtRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIxNDgyNA==", "bodyText": "If we made SortDirection.fromOptionalString throw an exception could this cause an issue in production? Where does metaData.getSortDirection() come from? Could it contain null or some other value that would currently just result in an ASC sort order?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370214824", "createdAt": "2020-01-23T16:15:16Z", "author": {"login": "banderous"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -1,37 +1,55 @@\n package uk.gov.hmcts.ccd.data.casedetails.search;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static java.util.Optional.ofNullable;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n+    private static final Logger LOG = LoggerFactory.getLogger(SortOrderQueryBuilder.class);\n+\n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n-    private static final String COMMA = \",\";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n-                sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (!matcher.find()) {\n+                if (sortOrderField.isMetadata()) {\n+                    sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+                } else {\n+                    sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+                }\n+                sb.append(SPACE);\n+                sb.append(SortDirection.fromOptionalString(ofNullable(sortOrderField.getDirection())));\n+                sb.append(SPACE);\n             }\n-            sb.append(SPACE);\n-            sb.append(sortOrderField.getDirection());\n-            sb.append(COMMA);\n-            sb.append(SPACE);\n         });\n         // always sort with creation_date as a last order so that it supports cases where no values at all for the configured fields and also default fallback.\n         return sb.append(CREATED_DATE + SPACE + SortDirection.fromOptionalString(metaData.getSortDirection())).toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd87be182763f844d7503dcf641503c51fc21075"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI1NzIyMg==", "bodyText": "I left this out as I am unsure the answers to those questions.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370257222", "createdAt": "2020-01-23T17:33:03Z", "author": {"login": "andrewfolga"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -1,37 +1,55 @@\n package uk.gov.hmcts.ccd.data.casedetails.search;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static java.util.Optional.ofNullable;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n+    private static final Logger LOG = LoggerFactory.getLogger(SortOrderQueryBuilder.class);\n+\n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n-    private static final String COMMA = \",\";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n-            } else {\n-                sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (!matcher.find()) {\n+                if (sortOrderField.isMetadata()) {\n+                    sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+                } else {\n+                    sb.append(convertFieldNameToJSONBsqlFormat(sortOrderField.getCaseFieldId()));\n+                }\n+                sb.append(SPACE);\n+                sb.append(SortDirection.fromOptionalString(ofNullable(sortOrderField.getDirection())));\n+                sb.append(SPACE);\n             }\n-            sb.append(SPACE);\n-            sb.append(sortOrderField.getDirection());\n-            sb.append(COMMA);\n-            sb.append(SPACE);\n         });\n         // always sort with creation_date as a last order so that it supports cases where no values at all for the configured fields and also default fallback.\n         return sb.append(CREATED_DATE + SPACE + SortDirection.fromOptionalString(metaData.getSortDirection())).toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIxNDgyNA=="}, "originalCommit": {"oid": "bd87be182763f844d7503dcf641503c51fc21075"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDMyMTQ4OnYy", "diffSide": "RIGHT", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOTowODoyOFrOFhXcQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOToxMDoyNlrOFhXe2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzMTM5NQ==", "bodyText": "you could get rid of this else now that we're throwing an exception", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370531395", "createdAt": "2020-01-24T09:08:28Z", "author": {"login": "banderous"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -1,32 +1,50 @@\n package uk.gov.hmcts.ccd.data.casedetails.search;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static java.util.Optional.ofNullable;\n+import static uk.gov.hmcts.ccd.data.casedetails.search.SortDirection.fromOptionalString;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n+    private static final Logger LOG = LoggerFactory.getLogger(SortOrderQueryBuilder.class);\n+\n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n     private static final String COMMA = \",\";\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (matcher.find()) {\n+                LOG.error(\"Illegal sort order field id: {}\", sortOrderField.getCaseFieldId());\n+                throw new IllegalArgumentException(\"Illegal sortOrderField.caseFieldId=\" + sortOrderField.getCaseFieldId());\n             } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "274d66139e8c8f53bb80223fcd4d47295bd3529c"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzMTY1NQ==", "bodyText": "by which I mean the block and braces, not the code inside!", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370531655", "createdAt": "2020-01-24T09:09:10Z", "author": {"login": "banderous"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -1,32 +1,50 @@\n package uk.gov.hmcts.ccd.data.casedetails.search;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static java.util.Optional.ofNullable;\n+import static uk.gov.hmcts.ccd.data.casedetails.search.SortDirection.fromOptionalString;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n+    private static final Logger LOG = LoggerFactory.getLogger(SortOrderQueryBuilder.class);\n+\n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n     private static final String COMMA = \",\";\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (matcher.find()) {\n+                LOG.error(\"Illegal sort order field id: {}\", sortOrderField.getCaseFieldId());\n+                throw new IllegalArgumentException(\"Illegal sortOrderField.caseFieldId=\" + sortOrderField.getCaseFieldId());\n             } else {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzMTM5NQ=="}, "originalCommit": {"oid": "274d66139e8c8f53bb80223fcd4d47295bd3529c"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzMjA1OQ==", "bodyText": "Done", "url": "https://github.com/hmcts/ccd-data-store-api/pull/769#discussion_r370532059", "createdAt": "2020-01-24T09:10:26Z", "author": {"login": "andrewfolga"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/search/SortOrderQueryBuilder.java", "diffHunk": "@@ -1,32 +1,50 @@\n package uk.gov.hmcts.ccd.data.casedetails.search;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n import uk.gov.hmcts.ccd.data.casedetails.search.MetaData.CaseField;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static java.util.Optional.ofNullable;\n+import static uk.gov.hmcts.ccd.data.casedetails.search.SortDirection.fromOptionalString;\n+\n @Component\n public class SortOrderQueryBuilder {\n \n+    private static final Logger LOG = LoggerFactory.getLogger(SortOrderQueryBuilder.class);\n+\n     private static final String DATA_FIELD = \"data\";\n     private static final String CREATED_DATE = \"created_date\";\n     private static final String SPACE = \" \";\n+    private static final String SPECIAL_CHARS_REGEXP = \"[\\\\s\\\\\\\\\\\\/,;\\\\)\\\\('\\\"`]\";\n+    private static final Pattern SPECIAL_CHARS_PATTERN = Pattern.compile(SPECIAL_CHARS_REGEXP);\n     private static final String COMMA = \",\";\n \n     public String buildSortOrderClause(MetaData metaData) {\n         StringBuilder sb = new StringBuilder();\n         metaData.getSortOrderFields().forEach(sortOrderField -> {\n-            if (sortOrderField.isMetadata()) {\n-                sb.append(getMataFieldName(sortOrderField.getCaseFieldId()));\n+            Matcher matcher = SPECIAL_CHARS_PATTERN.matcher(sortOrderField.getCaseFieldId());\n+            if (matcher.find()) {\n+                LOG.error(\"Illegal sort order field id: {}\", sortOrderField.getCaseFieldId());\n+                throw new IllegalArgumentException(\"Illegal sortOrderField.caseFieldId=\" + sortOrderField.getCaseFieldId());\n             } else {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzMTM5NQ=="}, "originalCommit": {"oid": "274d66139e8c8f53bb80223fcd4d47295bd3529c"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3967, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}