{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5Mzg4ODMz", "number": 1014, "title": "Rdm 8751", "bodyText": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751).", "createdAt": "2020-07-15T10:22:37Z", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014", "merged": true, "mergeCommit": {"oid": "ba85650a3b009b2d0caf956647878a875f86106d"}, "closed": true, "closedAt": "2020-07-27T08:14:56Z", "author": {"login": "Thor-tech-of-metal"}, "timelineItems": {"totalCount": 134, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc2wHqGAFqTQ1MTUyODc4OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc49SIJgFqTQ1NTU2MzUwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNTI4Nzg5", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-451528789", "createdAt": "2020-07-20T11:41:47Z", "commit": {"oid": "f68c936180e7835a6b8b86a571c3463ed556d49e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMTo0MTo0OFrOG0Hvfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMTo0MTo0OFrOG0Hvfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMwNTk4Mg==", "bodyText": "replaced the wrong @ApiParam. Please put this back and replace the one at line 79 i.e.\n@ApiParam(value = \"Case type ID(s)\", required = true)", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457305982", "createdAt": "2020-07-20T11:41:48Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -54,20 +78,17 @@ public CaseSearchEndpoint(@Qualifier(AuthorisedCaseSearchOperation.QUALIFIER) Ca\n     public CaseSearchResult searchCases(\n         @ApiParam(value = \"Case type ID(s)\", required = true)\n         @RequestParam(\"ctid\") List<String> caseTypeIds,\n-        @ApiParam(value = \"Native ElasticSearch Search API request. Please refer to the ElasticSearch official \"\n-            + \"documentation. For cross case type search, \"\n-            + \"the search results will contain only metadata by default (no case field data). To get case data in the \"\n-            + \"search results, please state the alias fields to be returned in the _source property for e.g.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f68c936180e7835a6b8b86a571c3463ed556d49e"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ad5e2e3d2e63161c694ad46a49b35257ff52b0b", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/8ad5e2e3d2e63161c694ad46a49b35257ff52b0b", "committedDate": "2020-07-20T11:44:23Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ddb01a3fb0272d8dacb53921927b7cd1be6cd18", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/9ddb01a3fb0272d8dacb53921927b7cd1be6cd18", "committedDate": "2020-07-20T11:45:18Z", "message": "Merge branch 'RDM-8751' of github.com:hmcts/ccd-data-store-api into RDM-8751"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ada20bf67c9db3ea83ab54c47e2f7577f259d67c", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/ada20bf67c9db3ea83ab54c47e2f7577f259d67c", "committedDate": "2020-07-20T11:58:07Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e", "author": {"user": {"login": "mario-paniccia", "name": "Mario Paniccia"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/5708d958c7328508098c529f095929d4dc40a44e", "committedDate": "2020-07-20T12:01:03Z", "message": "updated comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f2e88e7367e0ed362f171a2e821bce055780782", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/0f2e88e7367e0ed362f171a2e821bce055780782", "committedDate": "2020-07-20T12:11:40Z", "message": "Merge branch 'RDM-8751' of github.com:hmcts/ccd-data-store-api into RDM-8751"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNTQ2MTYy", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-451546162", "createdAt": "2020-07-20T12:08:39Z", "commit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMjowODo0MFrOG0I1Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMjozMjowM1rOG0JywQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMyMzg2Mw==", "bodyText": "Minor: We could add a getAllCaseTypes() into JurisdictionDefinition", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457323863", "createdAt": "2020-07-20T12:08:40Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,24 +215,50 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public List<String> getCaseTypesIDsByJurisdictions(List<String> jurisdictionIds) {\n+\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"Definitions not found for requested jurisdictions {}\", jurisdictionIds);\n+            return Collections.emptyList();\n+        }\n+        List<String> caseTypes = getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);\n+        return caseTypes;\n+    }\n+\n+    @Override\n+    public List<String> getAllCaseTypesIDs() {\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(Collections.emptyList());\n+        return getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);\n+    }\n+\n+    private List<String> getCaseTypeIdFromJurisdictionDefinition(List<JurisdictionDefinition> jurisdictionDefinitions) {\n+        return jurisdictionDefinitions.stream().flatMap(\n+            jurisdictionDefinition -> jurisdictionDefinition.getCaseTypeDefinitions().stream().map(\n+                caseTypeDefinition -> caseTypeDefinition.getId()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMyNTUxMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @JsonProperty(\"case_types_results\")\n          \n          \n            \n                @JsonProperty(\"case_type_results\")\n          \n      \n    \n    \n  \n\nOr change variable name to caseTypesResults (whichever is more appropriate for the meaning of this!)", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457325513", "createdAt": "2020-07-20T12:11:09Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseSearchResult.java", "diffHunk": "@@ -1,25 +1,38 @@\n package uk.gov.hmcts.ccd.domain.model.search;\n \n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+\n+import java.util.ArrayList;\n import java.util.List;\n \n import static java.util.Collections.emptyList;\n import static java.util.stream.Collectors.toList;\n \n-import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n-\n public class CaseSearchResult {\n-\n     public static final CaseSearchResult EMPTY = new CaseSearchResult(0L, emptyList());\n \n     private Long total;\n     private List<CaseDetails> cases;\n+    @JsonProperty(\"case_types_results\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMyNzIwNQ==", "bodyText": "Can we remove this constructor? It looks like the same as the one on L23 except with arguments in a different order?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457327205", "createdAt": "2020-07-20T12:13:39Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseSearchResult.java", "diffHunk": "@@ -1,25 +1,38 @@\n package uk.gov.hmcts.ccd.domain.model.search;\n \n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+\n+import java.util.ArrayList;\n import java.util.List;\n \n import static java.util.Collections.emptyList;\n import static java.util.stream.Collectors.toList;\n \n-import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n-\n public class CaseSearchResult {\n-\n     public static final CaseSearchResult EMPTY = new CaseSearchResult(0L, emptyList());\n \n     private Long total;\n     private List<CaseDetails> cases;\n+    @JsonProperty(\"case_types_results\")\n+    private List<CaseTypeResults> caseTypeResults;\n \n     public CaseSearchResult() {\n     }\n \n-    public CaseSearchResult(Long total, List<CaseDetails> cases) {\n+    public CaseSearchResult(Long total, List<CaseDetails> cases, List<CaseTypeResults> caseTypeResults) {\n         this.cases = cases;\n         this.total = total;\n+        this.caseTypeResults = caseTypeResults;\n+    }\n+\n+    public CaseSearchResult(Long total, List<CaseDetails> cases) {\n+        this(total, cases, new ArrayList<>());\n+    }\n+\n+\n+    public CaseSearchResult(List<CaseTypeResults> caseTypeResults, Long total, List<CaseDetails> cases) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMzNjQwMg==", "bodyText": "In some places it is called caseTypeResults, others caseFieldsAggregations - not sure if there is a different meaning or just needs to be updated?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457336402", "createdAt": "2020-07-20T12:27:20Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,49 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseTypeResults, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseFieldsAggregations,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMzNjk1MA==", "bodyText": "hits is being used quite a lot at least in this class - introduce a constant.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457336950", "createdAt": "2020-07-20T12:28:12Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,49 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseTypeResults, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseFieldsAggregations,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);\n+            caseFieldsAggregations.add(new CaseTypeResults(getCaseTypeIDFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getIndexName(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMzOTU4NQ==", "bodyText": "Sorry I know I suggested using the property value! I think if doing so we need to be a bit smarter though e.g. what if the property were changed to new_%s_cases, then substring wouldn't work. Something to consider!", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457339585", "createdAt": "2020-07-20T12:32:03Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,49 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseTypeResults, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseFieldsAggregations,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);\n+            caseFieldsAggregations.add(new CaseTypeResults(getCaseTypeIDFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getIndexName(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+            .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+    }\n+\n+    private boolean hitsIsNotEmpty(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0;\n+    }\n+\n+    private String getCaseTypeIDFromIndex(final String index, List<String> caseTypeIds) {\n+        String pureIndexFormat = applicationParams.getCasesIndexNameFormat().substring(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5708d958c7328508098c529f095929d4dc40a44e"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "384e91cfbbb7bddb2940fd4cf51c95fc6888222d", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/384e91cfbbb7bddb2940fd4cf51c95fc6888222d", "committedDate": "2020-07-20T14:36:10Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86f1c4ce4b0cc1cd4641822ede0fe4be11db137f", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/86f1c4ce4b0cc1cd4641822ede0fe4be11db137f", "committedDate": "2020-07-20T14:40:13Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e65f8e4404f336b1511407d1ffb774ecc8b1cfe", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/1e65f8e4404f336b1511407d1ffb774ecc8b1cfe", "committedDate": "2020-07-20T14:43:05Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0491b4e6e458070c1d12e201d660ab445a390e4d", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/0491b4e6e458070c1d12e201d660ab445a390e4d", "committedDate": "2020-07-20T15:11:18Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "183d5f3bb8f355914351c8cd6b7ae59e28c3805a", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/183d5f3bb8f355914351c8cd6b7ae59e28c3805a", "committedDate": "2020-07-20T15:15:26Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1353e4f131a94d2a9bad5535f3e3a33a409bfcb", "author": {"user": {"login": "mario-paniccia", "name": "Mario Paniccia"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/c1353e4f131a94d2a9bad5535f3e3a33a409bfcb", "committedDate": "2020-07-20T16:28:54Z", "message": "improved code to detect case type id from the ES index name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31ec63fb2c38cbe3330625a267f3fede42118359", "author": {"user": {"login": "mario-paniccia", "name": "Mario Paniccia"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/31ec63fb2c38cbe3330625a267f3fede42118359", "committedDate": "2020-07-20T16:30:38Z", "message": "Merge remote-tracking branch 'origin/RDM-8751' into RDM-8751\n\n# Conflicts:\n#\tsrc/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNzcyMzk2", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-451772396", "createdAt": "2020-07-20T16:33:06Z", "commit": {"oid": "31ec63fb2c38cbe3330625a267f3fede42118359"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNjozMzowNlrOG0WLZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNjozMzowNlrOG0WLZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0MjUwMA==", "bodyText": "@danlysiak improved the logic to extract the case type ID. Now is basically no longer in the code, but it's in the 2 new config properties I've introduced. Those 2 properties tell where the case type id is in the index name, by using regex groups.\nLet me know if it's better now", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457542500", "createdAt": "2020-07-20T16:33:06Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +116,56 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(totalHits,caseDetails,caseTypeResults);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseTypeResults,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);\n+            caseTypeResults.add(new CaseTypeResults(getCaseTypeIDFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getIndexName(MultiSearchResult.MultiSearchResponse response) {\n+        String quotedIndexName =  response.searchResult.getJsonObject().getAsJsonObject(HITS).get(HITS)\n+            .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+        String unquotedIndexName = quotedIndexName.replaceAll(\"\\\"\", \"\");\n+        return unquotedIndexName;\n+    }\n+\n+    private boolean hitsIsNotEmpty(MultiSearchResult.MultiSearchResponse response) {\n+        return response.searchResult.getJsonObject().getAsJsonObject(HITS).get(HITS).getAsJsonArray().size() != 0;\n+    }\n+\n+    private String getCaseTypeIDFromIndex(final String index, List<String> caseTypeIds) {\n+        String caseTypeIdGroupRegex = applicationParams.getCasesIndexNameCaseTypeIdGroup();\n+        int caseTypeIdGroupPosition = applicationParams.getCasesIndexNameCaseTypeIdGroupPosition();\n+        Pattern pattern = Pattern.compile(caseTypeIdGroupRegex);\n+        Matcher m = pattern.matcher(index);\n+        if (m.matches() && m.groupCount() > 1) {\n+            return caseTypeIds.stream().filter(\n+                caseTypeId -> caseTypeId.equalsIgnoreCase(m.group(caseTypeIdGroupPosition))\n+            ).findFirst().orElseThrow(() -> {\n+                log.error(\"Cannot match any known case type id from index '{}' extracted case type id : {}\", index, m.group(1));\n+                throw new ServiceException(\"Cannot determine case type id from ES index name - unknown extracted case type id\");\n+            });\n+        } else {\n+            log.error(\"Cannot determine case type id from index name: '{}'. No capturing group configured or capturing group not matching: '{}'.\",\n+                index, caseTypeIdGroupRegex);\n+            throw new ServiceException(\"Cannot determine case type id from ES index name - cannot extract case type id\");\n+        }\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31ec63fb2c38cbe3330625a267f3fede42118359"}, "originalPosition": 124}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNzk0Mzg4", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-451794388", "createdAt": "2020-07-20T17:02:02Z", "commit": {"oid": "c1353e4f131a94d2a9bad5535f3e3a33a409bfcb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzowMjowM1rOG0XPRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzowNjoxNlrOG0XYOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU1OTg3OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            log.error(\"Cannot match any known case type id from index '{}' extracted case type id : {}\", index, m.group(1));\n          \n          \n            \n                            log.error(\"Cannot match any known case type id from index '{}' extracted case type id : {}\", index, m.group(caseTypeIdGroupPosition));", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457559879", "createdAt": "2020-07-20T17:02:03Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -137,25 +139,33 @@ private void buildCaseTypesResults(\n     }\n \n     private String getIndexName(MultiSearchResult.MultiSearchResponse response) {\n-        return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+        String quotedIndexName = response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n             .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+        String unquotedIndexName = quotedIndexName.replaceAll(\"\\\"\", \"\");\n+        return unquotedIndexName;\n     }\n \n     private boolean hitsIsNotEmpty(MultiSearchResult.MultiSearchResponse response) {\n         return response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0;\n     }\n \n     private String getCaseTypeIDFromIndex(final String index, List<String> caseTypeIds) {\n-        String pureIndexFormat = applicationParams.getCasesIndexNameFormat().substring(2);\n-        final String caseTypeIdFromIndex = index.substring(0, index.indexOf(pureIndexFormat))\n-            .replaceAll(\"\\\"\", \"\");\n-\n-        return caseTypeIds.stream().filter(\n-            caseTypeId -> caseTypeId.equalsIgnoreCase(caseTypeIdFromIndex)\n-        ).findFirst().orElseGet(() -> {\n-            log.error(\"The Case type id could be found using the following index name: {}\", caseTypeIdFromIndex);\n-            return \"index-error\";\n-        });\n+        String caseTypeIdGroupRegex = applicationParams.getCasesIndexNameCaseTypeIdGroup();\n+        int caseTypeIdGroupPosition = applicationParams.getCasesIndexNameCaseTypeIdGroupPosition();\n+        Pattern pattern = Pattern.compile(caseTypeIdGroupRegex);\n+        Matcher m = pattern.matcher(index);\n+        if (m.matches() && m.groupCount() > 1) {\n+            return caseTypeIds.stream().filter(\n+                caseTypeId -> caseTypeId.equalsIgnoreCase(m.group(caseTypeIdGroupPosition))\n+            ).findFirst().orElseThrow(() -> {\n+                log.error(\"Cannot match any known case type id from index '{}' extracted case type id : {}\", index, m.group(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1353e4f131a94d2a9bad5535f3e3a33a409bfcb"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU2MjE2OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            search.cases.index.name.case-type-id.group=(.+?)(_cases.*)\n          \n          \n            \n            search.cases.index.name.case-type-id.group=(.+)(_cases.*)\n          \n      \n    \n    \n  \n\nThink we may need to let it be greedy? At the moment if any services were to use a case type such as ENGLISH_CASES then the index would be english_cases_cases... and the first capturing group would only be english.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457562168", "createdAt": "2020-07-20T17:06:16Z", "author": {"login": "danlysiak"}, "path": "src/main/resources/application.properties", "diffHunk": "@@ -141,6 +141,10 @@ search.elastic.hosts=${ELASTIC_SEARCH_HOSTS:http://localhost:9200}\n search.elastic.data.hosts=${ELASTIC_SEARCH_DATA_NODES_HOSTS:\"http://localhost:9200\"}\n search.blacklist=${ELASTIC_SEARCH_BLACKLIST:query_string}\n search.cases.index.name.format=${ELASTIC_SEARCH_CASE_INDEX_NAME_FORMAT:%s_cases}\n+#regex with a group used to identify and extract the case id from the index name\n+search.cases.index.name.case-type-id.group=(.+?)(_cases.*)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1353e4f131a94d2a9bad5535f3e3a33a409bfcb"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxODE0NDAw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-451814400", "createdAt": "2020-07-20T17:29:54Z", "commit": {"oid": "31ec63fb2c38cbe3330625a267f3fede42118359"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzoyOTo1NFrOG0YM0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzo0NDo0NVrOG0Yucw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU3NTYzNQ==", "bodyText": "Been wondering about making hitsIsNotEmpty() and getIndexName() a bit more readable rather than having to search through JSON objects..\nWe could potentially use List<SearchResult.Hit<ElasticSearchCaseDetailsDTO, Void>> hits = response.searchResult.getHits(ElasticSearchCaseDetailsDTO.class); here - I think our DTO should already be suitable for that usage? Then it's much simpler:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (hitsIsNotEmpty(response)) {\n          \n          \n            \n                        String indexName = getIndexName(response);\n          \n          \n            \n                    List<SearchResult.Hit<ElasticSearchCaseDetailsDTO, Void>> hits = response.searchResult.getHits(ElasticSearchCaseDetailsDTO.class);\n          \n          \n            \n                    if (!hits.isEmpty()) {\n          \n          \n            \n                        String indexName = hits.get(0).index;\n          \n      \n    \n    \n  \n\nNot tried this out, but looks like a good alternative if it works?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457575635", "createdAt": "2020-07-20T17:29:54Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +116,56 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(totalHits,caseDetails,caseTypeResults);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseTypeResults,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31ec63fb2c38cbe3330625a267f3fede42118359"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU4NDI0Mw==", "bodyText": "Also - we are currently (and with my suggestion too) getting the index name from the first hit. If a service passes an ES query with \"size\": 0 then there won't be any hits but it can still have a total - do we always expect/are we telling services that they should always pass a size for these kinds of queries but _source = false?\nSorry if repeating things that have already been covered! I can see we'll be using _source = false in the ticket for the original business scenario, but may need to document in known limitations so services know too?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457584243", "createdAt": "2020-07-20T17:44:45Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +116,56 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseTypesResults(response, caseTypeResults, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(totalHits,caseDetails,caseTypeResults);\n+    }\n+\n+    private void buildCaseTypesResults(\n+        MultiSearchResult.MultiSearchResponse response,\n+        List<CaseTypeResults> caseTypeResults,\n+        CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+        if (hitsIsNotEmpty(response)) {\n+            String indexName = getIndexName(response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU3NTYzNQ=="}, "originalCommit": {"oid": "31ec63fb2c38cbe3330625a267f3fede42118359"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4583ed4ff8b5451583e691116a9c88656c194ea", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/c4583ed4ff8b5451583e691116a9c88656c194ea", "committedDate": "2020-07-21T08:17:57Z", "message": "Merge branch 'RDM-8751' of github.com:hmcts/ccd-data-store-api into RDM-8751"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28b91edd4a5aa9b1f054a25750b3e37c456edded", "author": {"user": {"login": "mario-paniccia", "name": "Mario Paniccia"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/28b91edd4a5aa9b1f054a25750b3e37c456edded", "committedDate": "2020-07-21T08:22:14Z", "message": "addressed some code review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4134950579aed0083b47b88c2c469a99a73ee79e", "author": {"user": {"login": "mario-paniccia", "name": "Mario Paniccia"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/4134950579aed0083b47b88c2c469a99a73ee79e", "committedDate": "2020-07-21T09:29:16Z", "message": "code review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "752bab02f9626d44468445c23b16e9641cbf6c48", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/752bab02f9626d44468445c23b16e9641cbf6c48", "committedDate": "2020-07-21T10:03:51Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a95f128704aeaad9996519c2934322ed46685f2", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/4a95f128704aeaad9996519c2934322ed46685f2", "committedDate": "2020-07-21T10:06:16Z", "message": "Merge branch 'RDM-8751' of github.com:hmcts/ccd-data-store-api into RDM-8751"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7adff7b5df42c2b115e2e0e3993d8e6dc170f34", "author": {"user": {"login": "mario-paniccia", "name": "Mario Paniccia"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/a7adff7b5df42c2b115e2e0e3993d8e6dc170f34", "committedDate": "2020-07-21T10:42:32Z", "message": "temporarily increasing max limit of PMD max failures to allow the build pass. Will raise a separate ticket to reduce the number"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5356abef9c1ab0435162f47f2dfedc39421f56b7", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/5356abef9c1ab0435162f47f2dfedc39421f56b7", "committedDate": "2020-07-21T11:25:19Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "103811a1f10f7588a1b294c414fab9241fb75ddb", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/103811a1f10f7588a1b294c414fab9241fb75ddb", "committedDate": "2020-07-21T13:07:25Z", "message": "Merge branch 'RDM-8751' of github.com:hmcts/ccd-data-store-api into RDM-8751"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2464ec3be320dd4c7796b6300835aa6eb62771fb", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/2464ec3be320dd4c7796b6300835aa6eb62771fb", "committedDate": "2020-07-21T14:01:44Z", "message": " RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e68a1a0f4a811770cd16d93bb2d004c6016f112", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/5e68a1a0f4a811770cd16d93bb2d004c6016f112", "committedDate": "2020-07-21T14:09:03Z", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-8751"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26af65a55634ca997a935db24ebd8f49de43b5c7", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/26af65a55634ca997a935db24ebd8f49de43b5c7", "committedDate": "2020-07-23T13:32:27Z", "message": " RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "476c5b547e3c4681363317a9543cee2ba703556b", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/476c5b547e3c4681363317a9543cee2ba703556b", "committedDate": "2020-07-23T13:49:13Z", "message": " RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f5d9a9a8279d711e5d1b9628cc01844e8d4160f", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/5f5d9a9a8279d711e5d1b9628cc01844e8d4160f", "committedDate": "2020-07-24T09:32:15Z", "message": " RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "749244bf52ef6161dec68c32e8fbae4f6c6978f4", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/749244bf52ef6161dec68c32e8fbae4f6c6978f4", "committedDate": "2020-07-24T11:03:32Z", "message": " RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a910973b80bb639bf61bb2a963a9d930c6955543", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/a910973b80bb639bf61bb2a963a9d930c6955543", "committedDate": "2020-07-24T14:00:27Z", "message": " RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n    \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0OTUzNjk3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-454953697", "createdAt": "2020-07-24T14:53:31Z", "commit": {"oid": "a910973b80bb639bf61bb2a963a9d930c6955543"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NTYzNTAz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-455563503", "createdAt": "2020-07-27T08:09:51Z", "commit": {"oid": "a910973b80bb639bf61bb2a963a9d930c6955543"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f15d8119beae6b0187a4d200031cba8123d95003", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/f15d8119beae6b0187a4d200031cba8123d95003", "committedDate": "2020-05-27T07:56:19Z", "message": "RDM-8325 - Initial changes for internal /searchCases API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be6a3b9a841fe48eb6b7733705e04a8644745273", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/be6a3b9a841fe48eb6b7733705e04a8644745273", "committedDate": "2020-05-27T08:13:13Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f3d06da04caacefa5cb24cce00957f1fdc29cbf", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/2f3d06da04caacefa5cb24cce00957f1fdc29cbf", "committedDate": "2020-05-27T11:41:49Z", "message": "Add data_classification to default _source; tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6a36541caf5a6cfef62ead5bb6dbb26fde759f6", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/a6a36541caf5a6cfef62ead5bb6dbb26fde759f6", "committedDate": "2020-05-27T12:21:50Z", "message": "Refactoring & tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "506ef4b771dc7eb6823f737f44d53642d32949a5", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/506ef4b771dc7eb6823f737f44d53642d32949a5", "committedDate": "2020-05-27T13:12:05Z", "message": "Add Log and Audit to internal /searchCases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fc75ab4364e95f78271f62bb04322f94b406a4f", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/0fc75ab4364e95f78271f62bb04322f94b406a4f", "committedDate": "2020-05-27T16:42:47Z", "message": "Further unit testing/minor refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c9ec6ace45d74bc194a5d80671f140f2b3b7284", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/5c9ec6ace45d74bc194a5d80671f140f2b3b7284", "committedDate": "2020-05-27T16:54:20Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1155c1691e0b026452aa675058c284faa5aee514", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/1155c1691e0b026452aa675058c284faa5aee514", "committedDate": "2020-05-28T11:31:28Z", "message": "Add usecase request param for def store"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97910d410515ba7eba9b75a2ee7e7682562b9773", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/97910d410515ba7eba9b75a2ee7e7682562b9773", "committedDate": "2020-05-28T11:35:34Z", "message": "Update log message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9a84505dd3e6b6a7e677b921b5e302da68a4531", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/f9a84505dd3e6b6a7e677b921b5e302da68a4531", "committedDate": "2020-05-28T11:55:23Z", "message": "Add query param to test data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad83f92fbcc9c7f0db7c189fa8d63e363e632acf", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/ad83f92fbcc9c7f0db7c189fa8d63e363e632acf", "committedDate": "2020-05-29T13:36:03Z", "message": "Swagger docs; add internal APIs to published docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8853f3907c7d99b64591744751ca0f8f5207d676", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/8853f3907c7d99b64591744751ca0f8f5207d676", "committedDate": "2020-05-29T13:50:30Z", "message": "Fix SwaggerGeneratorTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "110fed028a7d7d2802992692621cdd26ea264133", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/110fed028a7d7d2802992692621cdd26ea264133", "committedDate": "2020-06-01T12:08:53Z", "message": "Remove UseCase enum"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ac227e8fe062b29622927c0da5978dcfaae51b6", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/0ac227e8fe062b29622927c0da5978dcfaae51b6", "committedDate": "2020-06-01T12:24:59Z", "message": "Merge branch 'develop' into RDM-8325"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a41e9f7a2150ce4b238daafe792b4cdd43c0caaf", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/a41e9f7a2150ce4b238daafe792b4cdd43c0caaf", "committedDate": "2020-06-01T12:48:48Z", "message": "Update in line with RDM-8350"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6512ad914d73578e1daacbd7a9edd8ca78eb866d", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/6512ad914d73578e1daacbd7a9edd8ca78eb866d", "committedDate": "2020-06-01T12:59:18Z", "message": "Mimic test from RDM-8350"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffd687b296fdb876dfc6ddc42f01ca3585b58f7b", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/ffd687b296fdb876dfc6ddc42f01ca3585b58f7b", "committedDate": "2020-06-01T13:08:56Z", "message": "Checkstyle cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65432dc8cab3bbdc52586f35f385bd1b187fdac9", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/65432dc8cab3bbdc52586f35f385bd1b187fdac9", "committedDate": "2020-06-01T17:30:10Z", "message": "Preemptively add last_state_modified_date to case predefined mappings types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adf28caf0a6a23df380d2be462697fd214b437bd", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/adf28caf0a6a23df380d2be462697fd214b437bd", "committedDate": "2020-06-03T10:24:53Z", "message": "RDM-8325 - Make ctid query param mandatory; refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbfb563b54c3eaeaa06b5a1a5b67864c3b9a843b", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/cbfb563b54c3eaeaa06b5a1a5b67864c3b9a843b", "committedDate": "2020-06-03T13:11:54Z", "message": "RDM-8325 - Update ctid to single value; refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f95f00d03f8377abb1b4f9808a7d2b2ca0892e3", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/7f95f00d03f8377abb1b4f9808a7d2b2ca0892e3", "committedDate": "2020-06-03T13:32:27Z", "message": "RDM-8325 - Add usecase to response; refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b70e030ea094bcf80d4d634def0f7b00093b89ce", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/b70e030ea094bcf80d4d634def0f7b00093b89ce", "committedDate": "2020-06-03T13:40:20Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab325f02d6a0e2937399bb6cb023a8842e1dda9b", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/ab325f02d6a0e2937399bb6cb023a8842e1dda9b", "committedDate": "2020-06-03T13:55:35Z", "message": "Minor refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67676c8e6a6911f1d6f41465e49dda9bf24cae7b", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/67676c8e6a6911f1d6f41465e49dda9bf24cae7b", "committedDate": "2020-06-03T14:24:35Z", "message": "Revert previously edited files to originals following simplification"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "588918d0569aa6a39311bba157ce8459d3dd0b9e", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/588918d0569aa6a39311bba157ce8459d3dd0b9e", "committedDate": "2020-06-03T14:34:18Z", "message": "Method rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f41836564db97039a7c7d1eacb7a44e4763b6dbc", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/f41836564db97039a7c7d1eacb7a44e4763b6dbc", "committedDate": "2020-06-05T17:30:32Z", "message": "RDM-8325 - Review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d88a7069533e3aed2b0c53af5c0c9a453d29bd03", "author": {"user": null}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/d88a7069533e3aed2b0c53af5c0c9a453d29bd03", "committedDate": "2020-06-09T14:54:04Z", "message": "RDM-8685 - Add consumes to controller"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b2e034b3480c0d67e859294cd0d260b6fa2263e", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/2b2e034b3480c0d67e859294cd0d260b6fa2263e", "committedDate": "2020-07-06T09:58:35Z", "message": "RDM-8751 work in progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9df848768367d7c6ff8dbf9a414dad9200e937e3", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/9df848768367d7c6ff8dbf9a414dad9200e937e3", "committedDate": "2020-07-10T10:54:52Z", "message": "RDM-8751 work in progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "068a16228881817bd9d57aa2f448bb0b54915c77", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/068a16228881817bd9d57aa2f448bb0b54915c77", "committedDate": "2020-07-13T09:27:25Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a94b4b879afe8c8a2042c3dc30035ec0c624a5df", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/a94b4b879afe8c8a2042c3dc30035ec0c624a5df", "committedDate": "2020-07-13T09:29:25Z", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-8751-WORKING-MERGING-DEV"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35d7796a3c0c34746b43c6370bff145202034eb4", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/35d7796a3c0c34746b43c6370bff145202034eb4", "committedDate": "2020-07-13T11:46:40Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8918e2a7f97e5f76079e7f38f743d41aa3d4db3c", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/8918e2a7f97e5f76079e7f38f743d41aa3d4db3c", "committedDate": "2020-07-13T11:46:58Z", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-8751-WORKING-MERGING-DEV"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be96a06a4d59431d066fe68d1fe5ad0d286e6e1b", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/be96a06a4d59431d066fe68d1fe5ad0d286e6e1b", "committedDate": "2020-07-13T15:13:01Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13354383d69dfaf330b94af86879b88ca46dab04", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/13354383d69dfaf330b94af86879b88ca46dab04", "committedDate": "2020-07-14T14:23:41Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71dcc49df9a81bb2cc57d98577aa6e96246f9cc8", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/71dcc49df9a81bb2cc57d98577aa6e96246f9cc8", "committedDate": "2020-07-15T10:23:12Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/5a1234cdb4df11630c8abe46a3b3ce56a73e44d7", "committedDate": "2020-07-15T12:08:30Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/2581fb698fc6e1e4829e30f2248a5c621514da7a", "committedDate": "2020-07-15T14:01:40Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4OTkyODE2", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-448992816", "createdAt": "2020-07-15T14:10:21Z", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxMDoyMVrOGx_-yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxMDoyMVrOGx_-yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4MTY3Mg==", "bodyText": "Let's move this method into the existing class CaseTypeService. And have the controller delegate to it\nThe method could be called: getCaseTypesAccordingToIDAMRoles", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455081672", "createdAt": "2020-07-15T14:10:21Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;\n+    }\n+\n+    private List<String> getCaseTypes() {\n+        final List<String> roles = userService.getUserRolesJurisdictions();\n+        return caseDefinitionRepository.getAllCaseTypesByJurisdictions(roles).get();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4OTk1NDcx", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-448995471", "createdAt": "2020-07-15T14:13:08Z", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxMzowOFrOGyAGbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxMzowOFrOGyAGbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4MzYzMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean isAConsolidationQuery(List<String> caseTypeIds) {\n          \n          \n            \n                private boolean isAllCaseTypeRequest(List<String> caseTypeIds) {", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455083631", "createdAt": "2020-07-15T14:13:08Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;\n+    }\n+\n+    private List<String> getCaseTypes() {\n+        final List<String> roles = userService.getUserRolesJurisdictions();\n+        return caseDefinitionRepository.getAllCaseTypesByJurisdictions(roles).get();\n+    }\n+\n+    private boolean isAConsolidationQuery(List<String> caseTypeIds) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4OTk3ODM2", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-448997836", "createdAt": "2020-07-15T14:15:36Z", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxNTozNlrOGyANdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxNTozNlrOGyANdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4NTQzMA==", "bodyText": "wonder whether it's a good practice leaving the parameter type as a List now that * is a possible value.\nWonder whether it's more correct to change it to a String and then parse the string.\nUndecided. Let's discuss about it", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455085430", "createdAt": "2020-07-15T14:15:36Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4OTk4NjQ3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-448998647", "createdAt": "2020-07-15T14:16:25Z", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxNjoyNlrOGyAP2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxNjoyNlrOGyAP2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4NjA0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final List<String> roles = userService.getUserRolesJurisdictions();\n          \n          \n            \n                    final List<String> jurisdictions = userService.getUserRolesJurisdictions();", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455086041", "createdAt": "2020-07-15T14:16:26Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;\n+    }\n+\n+    private List<String> getCaseTypes() {\n+        final List<String> roles = userService.getUserRolesJurisdictions();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDAwNjYz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449000663", "createdAt": "2020-07-15T14:18:32Z", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxODozMlrOGyAWPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoxODozMlrOGyAWPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4NzY3Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return ElasticsearchRequest.SOURCE_WILDCARD.equals(caseTypeIds.get(0));\n          \n          \n            \n                    return ElasticsearchRequest.ANY_CASE_TYPE.equals(caseTypeIds.get(0));", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455087677", "createdAt": "2020-07-15T14:18:32Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;\n+    }\n+\n+    private List<String> getCaseTypes() {\n+        final List<String> roles = userService.getUserRolesJurisdictions();\n+        return caseDefinitionRepository.getAllCaseTypesByJurisdictions(roles).get();\n+    }\n+\n+    private boolean isAConsolidationQuery(List<String> caseTypeIds) {\n+        return ElasticsearchRequest.SOURCE_WILDCARD.equals(caseTypeIds.get(0));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDAyNTM5", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449002539", "createdAt": "2020-07-15T14:20:24Z", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMDoyNFrOGyAbyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMDoyNFrOGyAbyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4OTA5OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .withConsolidationQuery(isAConsolidationQuery(caseTypeIds))\n          \n          \n            \n                        .withAnyCaseTypeRequest(isAllCaseTypeRequest(caseTypeIds))", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455089098", "createdAt": "2020-07-15T14:20:24Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -67,8 +86,9 @@ public CaseSearchResult searchCases(\n         ElasticsearchRequest elasticsearchRequest = elasticsearchQueryHelper.validateAndConvertRequest(jsonSearchRequest);\n \n         CrossCaseTypeSearchRequest request = new CrossCaseTypeSearchRequest.Builder()\n-            .withCaseTypes(caseTypeIds)\n+            .withCaseTypes(getCaseTypeIds(caseTypeIds))\n             .withSearchRequest(elasticsearchRequest)\n+            .withConsolidationQuery(isAConsolidationQuery(caseTypeIds))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDA0MTc5", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449004179", "createdAt": "2020-07-15T14:22:04Z", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMjowNVrOGyAgow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMjowNVrOGyAgow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MDMzOQ==", "bodyText": "please remove", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455090339", "createdAt": "2020-07-15T14:22:05Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CachedCaseDefinitionRepository.java", "diffHunk": "@@ -91,11 +92,17 @@ public JurisdictionDefinition getJurisdiction(String jurisdictionId) {\n         return caseDefinitionRepository.getJurisdiction(jurisdictionId);\n     }\n \n+    @Override\n+    public Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds) {\n+        return caseDefinitionRepository.getAllCaseTypesByJurisdictions(jurisdictionIds);\n+    }\n+\n     @Override\n     public List<FieldTypeDefinition> getBaseTypes() {\n         return baseTypes.computeIfAbsent(\"baseTypes\", e -> caseDefinitionRepository.getBaseTypes());\n     }\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDA0NjUy", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449004652", "createdAt": "2020-07-15T14:22:33Z", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMjozM1rOGyAiEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMjozM1rOGyAiEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MDcwNg==", "bodyText": "No need to use Optional with lists. Just have it return an empty list in case of no results. The client code is going to be much simpler.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455090706", "createdAt": "2020-07-15T14:22:33Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CaseDefinitionRepository.java", "diffHunk": "@@ -24,4 +25,6 @@\n \n     JurisdictionDefinition getJurisdiction(String jurisdictionId);\n \n+    Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDA0ODg2", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449004886", "createdAt": "2020-07-15T14:22:48Z", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMjo0OFrOGyAiug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMjo0OFrOGyAiug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MDg3NA==", "bodyText": "please remove this blank line", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455090874", "createdAt": "2020-07-15T14:22:48Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CaseDefinitionRepository.java", "diffHunk": "@@ -24,4 +25,6 @@\n \n     JurisdictionDefinition getJurisdiction(String jurisdictionId);\n \n+    Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDA1Njkz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449005693", "createdAt": "2020-07-15T14:23:36Z", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMzozNlrOGyAlAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyMzozNlrOGyAlAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MTQ1Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds);\n          \n          \n            \n                Optional<List<String>> getCaseTypesIDsByJurisdictions(List<String> jurisdictionIds);", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455091456", "createdAt": "2020-07-15T14:23:36Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/CaseDefinitionRepository.java", "diffHunk": "@@ -24,4 +25,6 @@\n \n     JurisdictionDefinition getJurisdiction(String jurisdictionId);\n \n+    Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDEyODMx", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449012831", "createdAt": "2020-07-15T14:30:22Z", "commit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozMDoyMlrOGyA6nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozMDoyMlrOGyA6nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5Njk4OA==", "bodyText": "can you change you IDE to remove automatic adding final please and remove it here and the other places", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455096988", "createdAt": "2020-07-15T14:30:22Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +216,24 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds) {\n+\n+        final List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDE0NzYw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449014760", "createdAt": "2020-07-15T14:32:12Z", "commit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozMjoxMlrOGyBAcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozMjoxMlrOGyBAcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5ODQ4MA==", "bodyText": "why just not return the empty list?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455098480", "createdAt": "2020-07-15T14:32:12Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +216,24 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds) {\n+\n+        final List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"No values found Retrieving jurisdiction object(s) from definition store for all Jurisdiction.\");\n+            Optional.of(Arrays.asList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDE2NDI4", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449016428", "createdAt": "2020-07-15T14:33:56Z", "commit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozMzo1NlrOGyBFVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozMzo1NlrOGyBFVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5OTczMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOG.warn(\"No values found Retrieving jurisdiction object(s) from definition store for all Jurisdiction.\");\n          \n          \n            \n                        LOG.warn(\"Definitions not found for requested jurisdictions {}\", jurisdictionIds);", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455099733", "createdAt": "2020-07-15T14:33:56Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +216,24 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public Optional<List<String>> getAllCaseTypesByJurisdictions(List<String> jurisdictionIds) {\n+\n+        final List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"No values found Retrieving jurisdiction object(s) from definition store for all Jurisdiction.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDE4NjYy", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449018662", "createdAt": "2020-07-15T14:36:16Z", "commit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozNjoxNlrOGyBMIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozNjoxNlrOGyBMIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwMTQ3Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @JsonProperty(\"case_field_id\")\n          \n          \n            \n                @JsonProperty(\"case_type_id\")", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455101472", "createdAt": "2020-07-15T14:36:16Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseTypesResults.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package uk.gov.hmcts.ccd.domain.model.search;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class CaseTypesResults {\n+\n+    @JsonProperty(\"case_field_id\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDE5MDEz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449019013", "createdAt": "2020-07-15T14:36:38Z", "commit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozNjozOVrOGyBNIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozNjozOVrOGyBNIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwMTczMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public CaseTypesResults(String caseFieldId, long numberOfMatchedCases) {\n          \n          \n            \n                public CaseTypesResults(String caseTypeId, long total) {", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455101731", "createdAt": "2020-07-15T14:36:39Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseTypesResults.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package uk.gov.hmcts.ccd.domain.model.search;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class CaseTypesResults {\n+\n+    @JsonProperty(\"case_field_id\")\n+    private final String caseTypeId;\n+    private final long total;\n+\n+    public CaseTypesResults(String caseFieldId, long numberOfMatchedCases) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDIwMDky", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449020092", "createdAt": "2020-07-15T14:37:43Z", "commit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozNzo0NFrOGyBQQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDozNzo0NFrOGyBQQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwMjUzMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean consolidationQuery;\n          \n          \n            \n                private boolean isAnyCaseRequest;\n          \n      \n    \n    \n  \n\nplease also update in other parts of the class accordingly", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455102531", "createdAt": "2020-07-15T14:37:44Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/CrossCaseTypeSearchRequest.java", "diffHunk": "@@ -43,13 +44,15 @@\n     private final ElasticsearchRequest elasticsearchRequest;\n     private final boolean multiCaseTypeSearch;\n     private final List<String> aliasFields = new ArrayList<>();\n+    private boolean consolidationQuery;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDI2NjM3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449026637", "createdAt": "2020-07-15T14:42:29Z", "commit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo0MjozMFrOGyBd4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo0MjozMFrOGyBd4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwNjAxNg==", "bodyText": "not sure I understand this. When _source is not false we want to addMetadataSourceFields right?\nBut with these changes the current code is not doing that", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455106016", "createdAt": "2020-07-15T14:42:30Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/CrossCaseTypeSearchRequest.java", "diffHunk": "@@ -84,8 +87,15 @@ public boolean hasAliasField(SearchAliasField searchAliasField) {\n         return aliasFields.stream().anyMatch(aliasField -> aliasField.equalsIgnoreCase(searchAliasField.getId()));\n     }\n \n+    public boolean isConsolidationQuery() {\n+        return consolidationQuery;\n+    }\n+\n     private void addMetadataSourceFields() {\n         if (elasticsearchRequest.hasSource()) {\n+            if (elasticsearchRequest.getSource() instanceof BooleanNode) {\n+                return;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDM3NzUw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449037750", "createdAt": "2020-07-15T14:50:12Z", "commit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo1MDoxM1rOGyB1AA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo1MDoxM1rOGyB1AA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTExMTkzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final List<CaseTypesResults> caseFieldsAggregations = new ArrayList<>();\n          \n          \n            \n                    final List<CaseTypesResults> caseTypesResults = new ArrayList<>();", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455111936", "createdAt": "2020-07-15T14:50:13Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -95,8 +96,10 @@ private Search createSecuredSearch(String caseTypeId, JsonNode searchRequestJson\n             .build();\n     }\n \n-    private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearchResult) {\n-        List<CaseDetails> caseDetails = new ArrayList<>();\n+    private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearchResult,\n+                                                       CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+        final List<CaseDetails> caseDetails = new ArrayList<>();\n+        final List<CaseTypesResults> caseFieldsAggregations = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDQwMDAx", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449040001", "createdAt": "2020-07-15T14:52:02Z", "commit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo1MjowMlrOGyB7YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDo1MjowMlrOGyB7YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTExMzU2OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n          \n          \n            \n                            buildCaseTypesResults(response, caseTypesResults, crossCaseTypeSearchRequest);", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455113568", "createdAt": "2020-07-15T14:52:02Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1234cdb4df11630c8abe46a3b3ce56a73e44d7"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDYwOTM0", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449060934", "createdAt": "2020-07-15T15:15:00Z", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNToxNTowMFrOGyC_wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNToxNTowMFrOGyC_wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEzMTA3Mw==", "bodyText": "Important, but only If we have time now to do this\nI'm afraid this class has reached the max size limit. We can't keep adding more code to it it's already way too complex.\nCan you please introduce a new class ElasticsearchCaseSearchResponseGenerator with a method buildCaseDetailsSearchResult and move all the response generation code in there", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455131073", "createdAt": "2020-07-15T15:15:00Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -62,7 +63,7 @@ public ElasticsearchCaseSearchOperation(JestClient jestClient,\n     public CaseSearchResult execute(CrossCaseTypeSearchRequest request) {\n         MultiSearchResult result = search(request);\n         if (result.isSucceeded()) {\n-            return toCaseDetailsSearchResult(result);\n+            return toCaseDetailsSearchResult(result, request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NjM2MDQz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449636043", "createdAt": "2020-07-16T08:35:25Z", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODozNToyNVrOGygybw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODozNToyNVrOGygybw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxOTE4Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private String getNameFromIndex(final String index, List<String> caseTypeIds) {\n          \n          \n            \n                private String getCaseTypeIDFromIndex(final String index, List<String> caseTypeIds) {", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455619183", "createdAt": "2020-07-16T08:35:25Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseFieldsAggregations, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseFieldsAggregations(\n+        final MultiSearchResult.MultiSearchResponse response,\n+        final List<CaseTypesResults> caseFieldsAggregations,\n+        final CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0) {\n+\n+            final String indexName = response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+                .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+\n+            caseFieldsAggregations.add(new CaseTypesResults(getNameFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getNameFromIndex(final String index, List<String> caseTypeIds) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NjM3Nzk4", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449637798", "createdAt": "2020-07-16T08:37:48Z", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODozNzo0OFrOGyg3ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODozNzo0OFrOGyg3ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyMDUzOA==", "bodyText": "what about if the client has IDAM role caseworker-caa and request is ctid=*?\nIn that case the search needs to happen on any existing case type, because caseworker-caa can access all the case types", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455620538", "createdAt": "2020-07-16T08:37:48Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -79,6 +99,22 @@ public CaseSearchResult searchCases(\n         return result;\n     }\n \n+    private List<String> getCaseTypeIds(List<String> caseTypeIds) {\n+        if (isAConsolidationQuery(caseTypeIds)) {\n+            return getCaseTypes();\n+        }\n+        return caseTypeIds;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NzA4MTc2", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449708176", "createdAt": "2020-07-16T10:10:23Z", "commit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMDoxMDoyM1rOGykTdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMDoxMDoyM1rOGykTdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY3Njc4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class CaseTypesResults {\n          \n          \n            \n            public class CaseTypeResults {\n          \n      \n    \n    \n  \n\nsingular", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455676789", "createdAt": "2020-07-16T10:10:23Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/search/CaseTypesResults.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package uk.gov.hmcts.ccd.domain.model.search;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class CaseTypesResults {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2581fb698fc6e1e4829e30f2248a5c621514da7a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b02d66b501bddb7014098eac2de46cd5e83ed770", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/b02d66b501bddb7014098eac2de46cd5e83ed770", "committedDate": "2020-07-16T10:13:43Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NzIzMjE5", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449723219", "createdAt": "2020-07-16T10:32:45Z", "commit": {"oid": "b02d66b501bddb7014098eac2de46cd5e83ed770"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMDozMjo0NVrOGylCkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMDozMjo0NVrOGylCkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY4ODg0OQ==", "bodyText": "Maybe we should use the search.cases.index.name.format property to determine what to remove instead, since technically it is configurable.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455688849", "createdAt": "2020-07-16T10:32:45Z", "author": {"login": "danlysiak"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseFieldsAggregations, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseFieldsAggregations(\n+        final MultiSearchResult.MultiSearchResponse response,\n+        final List<CaseTypesResults> caseFieldsAggregations,\n+        final CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0) {\n+\n+            final String indexName = response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+                .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();\n+\n+            caseFieldsAggregations.add(new CaseTypesResults(getNameFromIndex(indexName,\n+                crossCaseTypeSearchRequest.getCaseTypeIds()),\n+                response.searchResult.getTotal())\n+            );\n+        }\n+    }\n+\n+    private String getNameFromIndex(final String index, List<String> caseTypeIds) {\n+        final String caseTypeIdFromIndex = index.substring(0, index.indexOf(\"_cases\")).replaceAll(\"\\\"\", \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b02d66b501bddb7014098eac2de46cd5e83ed770"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddce0a2d95f1dd21f6a96ad3a5b54090024c078c", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/ddce0a2d95f1dd21f6a96ad3a5b54090024c078c", "committedDate": "2020-07-16T12:06:41Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e14197f5256607574324a937667c0a7a7edde27d", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/e14197f5256607574324a937667c0a7a7edde27d", "committedDate": "2020-07-16T12:07:09Z", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-8751"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b33a9774f0d7665f1d612e42ed562a5bc78c4c42", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/b33a9774f0d7665f1d612e42ed562a5bc78c4c42", "committedDate": "2020-07-16T12:10:09Z", "message": "merge dev"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5ODE0ODE1", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449814815", "createdAt": "2020-07-16T12:50:59Z", "commit": {"oid": "b02d66b501bddb7014098eac2de46cd5e83ed770"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMjo1MDo1OVrOGypc3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMjo1MDo1OVrOGypc3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc2MTExOA==", "bodyText": "this code is difficult to read and quickly understand. Please add an utility method with a nice name in MultiSearchResult.MultiSearchResponse", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455761118", "createdAt": "2020-07-16T12:50:59Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseFieldsAggregations, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseFieldsAggregations(\n+        final MultiSearchResult.MultiSearchResponse response,\n+        final List<CaseTypesResults> caseFieldsAggregations,\n+        final CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0) {\n+\n+            final String indexName = response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\")\n+                .getAsJsonArray().get(0).getAsJsonObject().get(\"_index\").toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b02d66b501bddb7014098eac2de46cd5e83ed770"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5ODE1NjQx", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-449815641", "createdAt": "2020-07-16T12:52:03Z", "commit": {"oid": "b02d66b501bddb7014098eac2de46cd5e83ed770"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMjo1MjowM1rOGypfSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMjo1MjowM1rOGypfSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc2MTczOA==", "bodyText": "this code is difficult to read and quickly understand. Please add an utility method with a nice name in MultiSearchResult.MultiSearchResponse", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r455761738", "createdAt": "2020-07-16T12:52:03Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/ElasticsearchCaseSearchOperation.java", "diffHunk": "@@ -110,12 +113,35 @@ private CaseSearchResult toCaseDetailsSearchResult(MultiSearchResult multiSearch\n                 throw new BadSearchRequest(errMsg);\n             }\n             if (response.searchResult != null) {\n+                buildCaseFieldsAggregations(response, caseFieldsAggregations, crossCaseTypeSearchRequest);\n                 caseDetails.addAll(searchResultToCaseList(response.searchResult));\n                 totalHits += response.searchResult.getTotal();\n             }\n         }\n \n-        return new CaseSearchResult(totalHits, caseDetails);\n+        return new CaseSearchResult(caseFieldsAggregations, totalHits, caseDetails);\n+    }\n+\n+    private void buildCaseFieldsAggregations(\n+        final MultiSearchResult.MultiSearchResponse response,\n+        final List<CaseTypesResults> caseFieldsAggregations,\n+        final CrossCaseTypeSearchRequest crossCaseTypeSearchRequest) {\n+\n+        if (response.searchResult.getJsonObject().getAsJsonObject(\"hits\").get(\"hits\").getAsJsonArray().size() != 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b02d66b501bddb7014098eac2de46cd5e83ed770"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c4c0b6509ed257af21df3e9e37819bcd48b462d", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/2c4c0b6509ed257af21df3e9e37819bcd48b462d", "committedDate": "2020-07-17T08:36:47Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a0d2ac020083d4d45d4f905bde7101d5aca0821", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/5a0d2ac020083d4d45d4f905bde7101d5aca0821", "committedDate": "2020-07-17T09:48:43Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a99094e23177c34cf70c086bfc1e7bc46ae3f524", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/a99094e23177c34cf70c086bfc1e7bc46ae3f524", "committedDate": "2020-07-17T11:10:42Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNTc0MTc1", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-450574175", "createdAt": "2020-07-17T11:15:14Z", "commit": {"oid": "a99094e23177c34cf70c086bfc1e7bc46ae3f524"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNjA1MjE4", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-450605218", "createdAt": "2020-07-17T12:13:08Z", "commit": {"oid": "a99094e23177c34cf70c086bfc1e7bc46ae3f524"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMjoxMzowOFrOGzQoCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMjoxMzowOFrOGzQoCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwMjk1Mw==", "bodyText": "can you update the Swagger documentation as well with:\n@ApiParam(value = \"Comma separated list of case type ID(s) or '*' if the search should be applied on any existing case type. Note that using '*' is an expensive operation and might have low response times so always prefer explicitly listing the case types when known in advance\", required = true)", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456402953", "createdAt": "2020-07-17T12:13:08Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpoint.java", "diffHunk": "@@ -36,12 +51,21 @@\n \n     private final CaseSearchOperation caseSearchOperation;\n     private final ElasticsearchQueryHelper elasticsearchQueryHelper;\n+    private final CaseDefinitionRepository caseDefinitionRepository;\n+    private final UserRepository userRepository;\n+    private final ApplicationParams applicationParams;\n \n     @Autowired\n     public CaseSearchEndpoint(@Qualifier(AuthorisedCaseSearchOperation.QUALIFIER) CaseSearchOperation caseSearchOperation,\n-                              ElasticsearchQueryHelper elasticsearchQueryHelper) {\n+                              @Qualifier(CachedCaseDefinitionRepository.QUALIFIER) CaseDefinitionRepository caseDefinitionRepository,\n+                              @Qualifier(DefaultUserRepository.QUALIFIER)  UserRepository userRepository,\n+                              ElasticsearchQueryHelper elasticsearchQueryHelper,\n+                              ApplicationParams applicationParams) {\n         this.caseSearchOperation = caseSearchOperation;\n         this.elasticsearchQueryHelper = elasticsearchQueryHelper;\n+        this.caseDefinitionRepository = caseDefinitionRepository;\n+        this.userRepository = userRepository;\n+        this.applicationParams = applicationParams;\n     }\n \n     @PostMapping(value = \"/searchCases\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a99094e23177c34cf70c086bfc1e7bc46ae3f524"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dd0a29d52314e51db292f7e4a24696de5f46e4c", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/1dd0a29d52314e51db292f7e4a24696de5f46e4c", "committedDate": "2020-07-17T13:10:41Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08ed61919d82daf7a49f0f13af2e692244b51357", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/08ed61919d82daf7a49f0f13af2e692244b51357", "committedDate": "2020-07-17T13:42:41Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9caffd4ca9b32d1686e5960981f035b1c6fe844a", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/9caffd4ca9b32d1686e5960981f035b1c6fe844a", "committedDate": "2020-07-17T14:31:17Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNzA4NDcz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-450708473", "createdAt": "2020-07-17T14:32:22Z", "commit": {"oid": "9caffd4ca9b32d1686e5960981f035b1c6fe844a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNDozMjoyM1rOGzVWZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNDozMjoyM1rOGzVWZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ4MDM1Ng==", "bodyText": "This should be removed from this PR  swagger2Version = '2.10.0' i should be on dev", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r456480356", "createdAt": "2020-07-17T14:32:23Z", "author": {"login": "Thor-tech-of-metal"}, "path": "build.gradle", "diffHunk": "@@ -103,7 +103,7 @@ ext {\n     junitVintageVersion = '5.5.2'\n     powermockVersion = '2.0.0-beta.5'\n     reformLogging = '5.1.0'\n-    swagger2Version = '3.0.0-SNAPSHOT'\n+    swagger2Version = '2.10.0'\n     limits = [", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9caffd4ca9b32d1686e5960981f035b1c6fe844a"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNzA5NTky", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-450709592", "createdAt": "2020-07-17T14:33:44Z", "commit": {"oid": "9caffd4ca9b32d1686e5960981f035b1c6fe844a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c10372187307f6d4f7a32a8b917855406987dea", "author": {"user": {"login": "mario-paniccia", "name": "Mario Paniccia"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/6c10372187307f6d4f7a32a8b917855406987dea", "committedDate": "2020-07-17T15:03:20Z", "message": "rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8e1acc4ce006ef4c51363ef944c43d2a941522f", "author": {"user": {"login": "mario-paniccia", "name": "Mario Paniccia"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/c8e1acc4ce006ef4c51363ef944c43d2a941522f", "committedDate": "2020-07-17T15:03:45Z", "message": "rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1914340c68f636fd743431e12186cfaa3a91b2ca", "author": {"user": {"login": "mario-paniccia", "name": "Mario Paniccia"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/1914340c68f636fd743431e12186cfaa3a91b2ca", "committedDate": "2020-07-17T15:05:32Z", "message": "rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5f99327ee20454393e44dd0c22ec9dfe90fc0a3", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/e5f99327ee20454393e44dd0c22ec9dfe90fc0a3", "committedDate": "2020-07-20T07:59:40Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMzgzNzk0", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-451383794", "createdAt": "2020-07-20T08:08:07Z", "commit": {"oid": "e5f99327ee20454393e44dd0c22ec9dfe90fc0a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODowODowN1rOGz-phw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODowODowN1rOGz-phw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE1Njk5OQ==", "bodyText": "is this needed?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457156999", "createdAt": "2020-07-20T08:08:07Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +215,32 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public List<String> getCaseTypesIDsByJurisdictions(List<String> jurisdictionIds) {\n+\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"Definitions not found for requested jurisdictions {}\", jurisdictionIds);\n+            Arrays.asList();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5f99327ee20454393e44dd0c22ec9dfe90fc0a3"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMzg4NDI3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-451388427", "createdAt": "2020-07-20T08:14:39Z", "commit": {"oid": "e5f99327ee20454393e44dd0c22ec9dfe90fc0a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODoxNDo0MFrOGz-8Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODoxNDo0MFrOGz-8Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE2MTgyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<String> caseTypes = getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);\n          \n          \n            \n                    return caseTypes;\n          \n          \n            \n                    return getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457161826", "createdAt": "2020-07-20T08:14:40Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +215,32 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public List<String> getCaseTypesIDsByJurisdictions(List<String> jurisdictionIds) {\n+\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"Definitions not found for requested jurisdictions {}\", jurisdictionIds);\n+            Arrays.asList();\n+        }\n+        List<String> caseTypes = getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);\n+        return caseTypes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5f99327ee20454393e44dd0c22ec9dfe90fc0a3"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMzg5NzE3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-451389717", "createdAt": "2020-07-20T08:16:26Z", "commit": {"oid": "def4eee0ac7a536d85c8a23e10991568db9265cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODoxNjoyNlrOGz_B1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwODoxNjoyNlrOGz_B1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE2MzIyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(Arrays.asList());\n          \n          \n            \n                    List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(Collections.emptyList());", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457163222", "createdAt": "2020-07-20T08:16:26Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/data/definition/DefaultCaseDefinitionRepository.java", "diffHunk": "@@ -213,6 +215,32 @@ public JurisdictionDefinition getJurisdictionFromDefinitionStore(String jurisdic\n         return jurisdictionDefinitions.get(0);\n     }\n \n+    @Override\n+    public List<String> getCaseTypesIDsByJurisdictions(List<String> jurisdictionIds) {\n+\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(jurisdictionIds);\n+        if (jurisdictionDefinitions.isEmpty()) {\n+            LOG.warn(\"Definitions not found for requested jurisdictions {}\", jurisdictionIds);\n+            return Collections.emptyList();\n+        }\n+        List<String> caseTypes = getCaseTypeIdFromJurisdictionDefinition(jurisdictionDefinitions);\n+        return caseTypes;\n+    }\n+\n+    @Override\n+    public List<String> getAllCaseTypesIDs() {\n+        List<JurisdictionDefinition> jurisdictionDefinitions = getJurisdictionsFromDefinitionStore(Arrays.asList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "def4eee0ac7a536d85c8a23e10991568db9265cb"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "def4eee0ac7a536d85c8a23e10991568db9265cb", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/def4eee0ac7a536d85c8a23e10991568db9265cb", "committedDate": "2020-07-20T08:17:18Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMzkzMDc3", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-451393077", "createdAt": "2020-07-20T08:21:08Z", "commit": {"oid": "2d17c92f93c568cdcdda1039cc39ae4eb42d9329"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d17c92f93c568cdcdda1039cc39ae4eb42d9329", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/2d17c92f93c568cdcdda1039cc39ae4eb42d9329", "committedDate": "2020-07-20T08:22:48Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03b3f9fe95efee9e2c9f2d98b93f34c754e0a2c6", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/03b3f9fe95efee9e2c9f2d98b93f34c754e0a2c6", "committedDate": "2020-07-20T08:58:57Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c76b12089aea57126adba8d7332accfc1617686", "author": {"user": {"login": "mario-paniccia", "name": "Mario Paniccia"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/3c76b12089aea57126adba8d7332accfc1617686", "committedDate": "2020-07-20T09:39:35Z", "message": "simplified logic around returning metadata fields. Added missing unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ec7b5bd37dda695d2402701f6f012788c10ce72", "author": {"user": {"login": "mario-paniccia", "name": "Mario Paniccia"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/3ec7b5bd37dda695d2402701f6f012788c10ce72", "committedDate": "2020-07-20T09:39:46Z", "message": "Merge remote-tracking branch 'origin/RDM-8751' into RDM-8751"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89b60a205a1cdaac833400e6b20a75c2b2ee2333", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/89b60a205a1cdaac833400e6b20a75c2b2ee2333", "committedDate": "2020-07-20T09:44:04Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9591e9326ed13b7ecfd25b4501e5bf8ad69bd58", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/b9591e9326ed13b7ecfd25b4501e5bf8ad69bd58", "committedDate": "2020-07-20T09:44:34Z", "message": "Merge branch 'RDM-8751' of github.com:hmcts/ccd-data-store-api into RDM-8751"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20cc6cc2e209d9194fa255c33c33e2590b826458", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/20cc6cc2e209d9194fa255c33c33e2590b826458", "committedDate": "2020-07-20T09:53:40Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45769d151e863c6ed841fe9b34f1b0b65ebf390c", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/45769d151e863c6ed841fe9b34f1b0b65ebf390c", "committedDate": "2020-07-20T11:18:11Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNTE3ODY5", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-451517869", "createdAt": "2020-07-20T11:22:51Z", "commit": {"oid": "20cc6cc2e209d9194fa255c33c33e2590b826458"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMToyMjo1MlrOG0HBwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMToyMjo1MlrOG0HBwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzI5NDI3Mw==", "bodyText": "can you put back the formatting please", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457294273", "createdAt": "2020-07-20T11:22:52Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/CrossCaseTypeSearchRequest.java", "diffHunk": "@@ -10,29 +19,20 @@\n import static uk.gov.hmcts.ccd.data.casedetails.CaseDetailsEntity.DATA_CLASSIFICATION_COL;\n import static uk.gov.hmcts.ccd.domain.model.search.elasticsearch.ElasticsearchRequest.SOURCE;\n \n-import com.fasterxml.jackson.databind.JsonNode;\n-import com.fasterxml.jackson.databind.node.ArrayNode;\n-import com.fasterxml.jackson.databind.node.ObjectNode;\n-import com.fasterxml.jackson.databind.node.TextNode;\n-import uk.gov.hmcts.ccd.data.casedetails.search.MetaData;\n-import uk.gov.hmcts.ccd.domain.model.definition.SearchAliasField;\n-import uk.gov.hmcts.ccd.domain.model.search.elasticsearch.ElasticsearchRequest;\n-import uk.gov.hmcts.ccd.endpoint.exceptions.BadSearchRequest;\n-\n /**\n  * Sample ES json search request.\n  * {\n- *   \"_source\": [\"alias.searchField1\", \"alias.searchField2\"],\n- *   \"query\": {\n- *     \"bool\": {\n- *       \"filter\": {\n- *         \"match\": { \"state\": \"AwaitingPayment\"}\n- *       }\n- *     }\n- *   },\n- *  \"sort\": {\n- *     \"id\": { \"order\":\"asc\" }\n- *   }\n+ * \"_source\": [\"alias.searchField1\", \"alias.searchField2\"],\n+ * \"query\": {\n+ * \"bool\": {\n+ * \"filter\": {\n+ * \"match\": { \"state\": \"AwaitingPayment\"}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20cc6cc2e209d9194fa255c33c33e2590b826458"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "665e693f32fb6933692b153550b4f1455ca37358", "author": {"user": {"login": "mario-paniccia", "name": "Mario Paniccia"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/665e693f32fb6933692b153550b4f1455ca37358", "committedDate": "2020-07-20T11:28:28Z", "message": "added explanatory comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f68c936180e7835a6b8b86a571c3463ed556d49e", "author": {"user": {"login": "mario-paniccia", "name": "Mario Paniccia"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/f68c936180e7835a6b8b86a571c3463ed556d49e", "committedDate": "2020-07-20T11:28:36Z", "message": "Merge remote-tracking branch 'origin/RDM-8751' into RDM-8751"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a524f899c55373f63d1a464e039756450c46718d", "author": {"user": {"login": "Thor-tech-of-metal", "name": null}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/a524f899c55373f63d1a464e039756450c46718d", "committedDate": "2020-07-20T11:29:43Z", "message": "RDM-8751: Enhance external search API to retrieve summary information for cases of an organisation\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [RDM-8751] (https://tools.hmcts.net/jira/browse/RDM-8751)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNTI2MTY4", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#pullrequestreview-451526168", "createdAt": "2020-07-20T11:37:31Z", "commit": {"oid": "f68c936180e7835a6b8b86a571c3463ed556d49e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMTozNzozMVrOG0HkiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMTozNzozMVrOG0HkiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzMwMzE3Nw==", "bodyText": "no changes in this class other than the imports can you undo please", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1014#discussion_r457303177", "createdAt": "2020-07-20T11:37:31Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/search/elasticsearch/security/AuthorisedCaseSearchOperation.java", "diffHunk": "@@ -36,6 +23,19 @@\n import uk.gov.hmcts.ccd.domain.service.search.elasticsearch.ElasticsearchCaseSearchOperation;\n import uk.gov.hmcts.ccd.domain.service.security.AuthorisedCaseDefinitionDataService;\n \n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.Set;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f68c936180e7835a6b8b86a571c3463ed556d49e"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2826, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}