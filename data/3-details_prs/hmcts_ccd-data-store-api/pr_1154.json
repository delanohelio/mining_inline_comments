{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4Nzk3MDM0", "number": 1154, "title": "callbacks app-insights tracing", "bodyText": "JIRA link (if applicable)\nhttps://tools.hmcts.net/jira/browse/RDM-8787\nChange description\nDoes this PR introduce a breaking change? (check one with \"x\")\n[ ] Yes\n[ x] No", "createdAt": "2020-10-06T19:49:14Z", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154", "merged": true, "mergeCommit": {"oid": "89b4ce926f1b87d86c2363a7e045246294707698"}, "closed": true, "closedAt": "2020-10-15T09:22:06Z", "author": {"login": "smathangi"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP9ss2AH2gAyNDk4Nzk3MDM0OmFiMTgzYWM1MDZjYzc2MDUyOGUyYWU5NDg3OThkMmNhYWNiN2E0ZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQgap7AFqTUwNDcxMDgxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ab183ac506cc760528e2ae948798d2caacb7a4e8", "author": {"user": {"login": "smathangi", "name": "Sateesh Mathangi"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/ab183ac506cc760528e2ae948798d2caacb7a4e8", "committedDate": "2020-10-06T19:39:08Z", "message": "app-insights track event for callbacks with thread local and custom event"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d463706760ed3d7424f82edc79106798931dd0d9", "author": {"user": {"login": "smathangi", "name": "Sateesh Mathangi"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/d463706760ed3d7424f82edc79106798931dd0d9", "committedDate": "2020-10-06T20:16:00Z", "message": "checkstyle fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b729396c4b66ac326d0418b08d9c6b8c5e2bb6b", "author": {"user": {"login": "smathangi", "name": "Sateesh Mathangi"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/3b729396c4b66ac326d0418b08d9c6b8c5e2bb6b", "committedDate": "2020-10-07T08:33:57Z", "message": "RDM-8787 - minor clean up"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNjgzNDU2", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-503683456", "createdAt": "2020-10-07T09:18:52Z", "commit": {"oid": "3b729396c4b66ac326d0418b08d9c6b8c5e2bb6b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwOToxODo1MlrOHdqP8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwOToxODo1MlrOHdqP8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2Mjk2Mg==", "bodyText": "Testing purpose only (new test app-insights key). Will remove later.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#discussion_r500862962", "createdAt": "2020-10-07T09:18:52Z", "author": {"login": "smathangi"}, "path": "charts/ccd-data-store-api/values.preview.template.yaml", "diffHunk": "@@ -9,6 +9,7 @@ java:\n         - data-store-api-draft-key\n         - ccd-data-s2s-secret\n   environment:\n+    AZURE_APPLICATIONINSIGHTS_INSTRUMENTATIONKEY: \"2dcb834e-768e-4429-9050-ab15af959995\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b729396c4b66ac326d0418b08d9c6b8c5e2bb6b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNzA0MzYw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-503704360", "createdAt": "2020-10-07T09:44:15Z", "commit": {"oid": "3b729396c4b66ac326d0418b08d9c6b8c5e2bb6b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2f89f551d38ee817c11baa236d0756237f0b787", "author": {"user": {"login": "smathangi", "name": "Sateesh Mathangi"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/a2f89f551d38ee817c11baa236d0756237f0b787", "committedDate": "2020-10-07T09:48:20Z", "message": "RDM-8787 - test fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "165a2b43f84c07512132f1bce7fd3adc9f274f76", "author": {"user": {"login": "smathangi", "name": "Sateesh Mathangi"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/165a2b43f84c07512132f1bce7fd3adc9f274f76", "committedDate": "2020-10-07T10:17:25Z", "message": "RDM-8787 - unit tests for track event"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15f1b522106a37c470e6b507989acd8443c73070", "author": {"user": {"login": "smathangi", "name": "Sateesh Mathangi"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/15f1b522106a37c470e6b507989acd8443c73070", "committedDate": "2020-10-07T10:30:03Z", "message": "RDM-8787 - unit tests for track event"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f92365e151445e9979bbe1628c01caf2b00d8479", "author": {"user": {"login": "smathangi", "name": "Sateesh Mathangi"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/f92365e151445e9979bbe1628c01caf2b00d8479", "committedDate": "2020-10-07T10:39:57Z", "message": "RDM-8787 - checkstyle fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb5dc0d0fdd6d1339ae83820498c5161f9c4083f", "author": {"user": {"login": "smathangi", "name": "Sateesh Mathangi"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/cb5dc0d0fdd6d1339ae83820498c5161f9c4083f", "committedDate": "2020-10-07T10:57:54Z", "message": "RDM-8787 - checkstyle fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8382f9996eee2c2393b4ef032f0ecb6539609df5", "author": {"user": {"login": "smathangi", "name": "Sateesh Mathangi"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/8382f9996eee2c2393b4ef032f0ecb6539609df5", "committedDate": "2020-10-07T11:51:56Z", "message": "RDM-8787 - test fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7adbf361205d29cd4079520afb7a99884a5d720", "author": {"user": {"login": "smathangi", "name": "Sateesh Mathangi"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/a7adbf361205d29cd4079520afb7a99884a5d720", "committedDate": "2020-10-07T11:56:58Z", "message": "RDM-8787 - checkstyle fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzODc4OTA0", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-503878904", "createdAt": "2020-10-07T13:29:13Z", "commit": {"oid": "a7adbf361205d29cd4079520afb7a99884a5d720"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzoyOToxM1rOHdzXyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzoyOToxM1rOHdzXyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAxMjQyNw==", "bodyText": "shouldn't this be initialized at L 117?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#discussion_r501012427", "createdAt": "2020-10-07T13:29:13Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/callbacks/CallbackService.java", "diffHunk": "@@ -97,23 +110,42 @@ public CallbackService(final SecurityUtils securityUtils,\n     }\n \n     private <T> Optional<ResponseEntity<T>> sendRequest(final String url,\n+                                                        final String callbackType,\n                                                         final Class<T> clazz,\n+\n                                                         final CallbackRequest callbackRequest) {\n+        Instant startTime = null;\n+        int httpStatus = 0;\n         try {\n             LOG.debug(\"Invoking callback {}\", url);\n             final HttpHeaders httpHeaders = new HttpHeaders();\n             httpHeaders.add(\"Content-Type\", \"application/json\");\n+\n             final HttpHeaders securityHeaders = securityUtils.authorizationHeaders();\n             if (null != securityHeaders) {\n                 securityHeaders.forEach((key, values) -> httpHeaders.put(key, values));\n             }\n             final HttpEntity requestEntity = new HttpEntity(callbackRequest, httpHeaders);\n-            return Optional.ofNullable(restTemplate.exchange(url, HttpMethod.POST, requestEntity, clazz));\n+\n+            startTime = Instant.now();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7adbf361205d29cd4079520afb7a99884a5d720"}, "originalPosition": 115}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzODg0Njgw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-503884680", "createdAt": "2020-10-07T13:35:10Z", "commit": {"oid": "a7adbf361205d29cd4079520afb7a99884a5d720"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzozNToxMFrOHdzo9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzozNToxMFrOHdzo9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAxNjgyMA==", "bodyText": "better use an enumeration?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#discussion_r501016820", "createdAt": "2020-10-07T13:35:10Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/stdapi/CallbackInvoker.java", "diffHunk": "@@ -30,6 +30,11 @@\n public class CallbackInvoker {\n \n     private static final HashMap<String, JsonNode> EMPTY_DATA_CLASSIFICATION = Maps.newHashMap();\n+    public static final String ABOUT_TO_START = \"AboutToStart\";\n+    public static final String ABOUT_TO_SUBMIT = \"AboutToSubmit\";\n+    public static final String SUBMITTED = \"Submitted\";\n+    public static final String MID_EVENT = \"MidEvent\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7adbf361205d29cd4079520afb7a99884a5d720"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzODg1OTMx", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-503885931", "createdAt": "2020-10-07T13:36:23Z", "commit": {"oid": "a7adbf361205d29cd4079520afb7a99884a5d720"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzozNjoyM1rOHdzscg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzozNjoyM1rOHdzscg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAxNzcxNA==", "bodyText": "eol at eof", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#discussion_r501017714", "createdAt": "2020-10-07T13:36:23Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/stdapi/CallbackInvoker.java", "diffHunk": "@@ -218,10 +225,10 @@ private void validateAndSetData(final CaseTypeDefinition caseTypeDefinition,\n \n     private void deduceDataClassificationForNewFields(CaseTypeDefinition caseTypeDefinition, CaseDetails caseDetails) {\n         Map<String, JsonNode> defaultSecurityClassifications = caseDataService.getDefaultSecurityClassifications(\n-                caseTypeDefinition,\n+            caseTypeDefinition,\n             caseDetails.getData(),\n             ofNullable(caseDetails.getDataClassification()).orElse(\n                 newHashMap()));\n         caseDetails.setDataClassification(defaultSecurityClassifications);\n     }\n-}\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7adbf361205d29cd4079520afb7a99884a5d720"}, "originalPosition": 97}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzODg4MTgw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-503888180", "createdAt": "2020-10-07T13:38:36Z", "commit": {"oid": "a7adbf361205d29cd4079520afb7a99884a5d720"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzozODozNlrOHdzy2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzozODozNlrOHdzy2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAxOTM1NA==", "bodyText": "eol", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#discussion_r501019354", "createdAt": "2020-10-07T13:38:36Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/config/TracingConfiguration.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package uk.gov.hmcts.ccd.config;\n+\n+import com.microsoft.applicationinsights.extensibility.TelemetryProcessor;\n+import com.microsoft.applicationinsights.telemetry.RemoteDependencyTelemetry;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import uk.gov.hmcts.ccd.appinsights.CallbackTelemetryContext;\n+import uk.gov.hmcts.ccd.appinsights.CallbackTelemetryThreadContext;\n+\n+@Configuration\n+public class TracingConfiguration {\n+\n+    @Bean\n+    // Custom TelemetryProcessor which tags the type of {@link RemoteDependencyTelemetry} as callback before publishing.\n+    public TelemetryProcessor callbackRecognitionProcessor() {\n+        return telemetry -> {\n+            if (telemetry instanceof RemoteDependencyTelemetry) {\n+                RemoteDependencyTelemetry dependency = (RemoteDependencyTelemetry) telemetry;\n+                if (dependency.getType().startsWith(\"Http\")\n+                    && CallbackTelemetryThreadContext.getTelemetryContext() != null) {\n+\n+                    CallbackTelemetryContext telemetryContext = CallbackTelemetryThreadContext.getTelemetryContext();\n+                    dependency.getProperties().put(\"callback\", \"true\");\n+                    dependency.getProperties().put(\"callbackType\", telemetryContext.getCallbackType());\n+\n+                    // clean up after retrieval\n+                    CallbackTelemetryThreadContext.remove();\n+                }\n+            }\n+            return true;\n+        };\n+    }\n+\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7adbf361205d29cd4079520afb7a99884a5d720"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzODkxNjYz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-503891663", "createdAt": "2020-10-07T13:42:08Z", "commit": {"oid": "a7adbf361205d29cd4079520afb7a99884a5d720"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzo0MjowOFrOHdz9HQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzo0MjowOFrOHdz9HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAyMTk4MQ==", "bodyText": "better putting this on top of the method.", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#discussion_r501021981", "createdAt": "2020-10-07T13:42:08Z", "author": {"login": "MSancaktutar"}, "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/callbacks/CallbackService.java", "diffHunk": "@@ -97,23 +110,42 @@ public CallbackService(final SecurityUtils securityUtils,\n     }\n \n     private <T> Optional<ResponseEntity<T>> sendRequest(final String url,\n+                                                        final String callbackType,\n                                                         final Class<T> clazz,\n+\n                                                         final CallbackRequest callbackRequest) {\n+        Instant startTime = null;\n+        int httpStatus = 0;\n         try {\n             LOG.debug(\"Invoking callback {}\", url);\n             final HttpHeaders httpHeaders = new HttpHeaders();\n             httpHeaders.add(\"Content-Type\", \"application/json\");\n+\n             final HttpHeaders securityHeaders = securityUtils.authorizationHeaders();\n             if (null != securityHeaders) {\n                 securityHeaders.forEach((key, values) -> httpHeaders.put(key, values));\n             }\n             final HttpEntity requestEntity = new HttpEntity(callbackRequest, httpHeaders);\n-            return Optional.ofNullable(restTemplate.exchange(url, HttpMethod.POST, requestEntity, clazz));\n+\n+            startTime = Instant.now();\n+\n+            CallbackTelemetryThreadContext.setTelemetryContext(new CallbackTelemetryContext(callbackType));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7adbf361205d29cd4079520afb7a99884a5d720"}, "originalPosition": 117}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzODkyNjcw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-503892670", "createdAt": "2020-10-07T13:43:08Z", "commit": {"oid": "a7adbf361205d29cd4079520afb7a99884a5d720"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4794a166682e6a8809dca0360270b05062be68b", "author": {"user": {"login": "smathangi", "name": "Sateesh Mathangi"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/a4794a166682e6a8809dca0360270b05062be68b", "committedDate": "2020-10-07T14:29:17Z", "message": "RDM-8787 - eol fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38a4833bb1e8925fe38a95992864e946364d1120", "author": {"user": {"login": "smathangi", "name": "Sateesh Mathangi"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/38a4833bb1e8925fe38a95992864e946364d1120", "committedDate": "2020-10-08T08:16:55Z", "message": "RDM-8787 - review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NjMxNTE1", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-504631515", "createdAt": "2020-10-08T10:14:20Z", "commit": {"oid": "38a4833bb1e8925fe38a95992864e946364d1120"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoxNDoyMVrOHeXl5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoxNDoyMVrOHeXl5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYwNTg2Mw==", "bodyText": "can we add a Javadoc explaining the usage of this class", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#discussion_r501605863", "createdAt": "2020-10-08T10:14:21Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/appinsights/CallbackTelemetryContext.java", "diffHunk": "@@ -0,0 +1,14 @@\n+package uk.gov.hmcts.ccd.appinsights;\n+\n+public class CallbackTelemetryContext {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38a4833bb1e8925fe38a95992864e946364d1120"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NjMxNTc4", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-504631578", "createdAt": "2020-10-08T10:14:25Z", "commit": {"oid": "38a4833bb1e8925fe38a95992864e946364d1120"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoxNDoyNVrOHeXmKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoxNDoyNVrOHeXmKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYwNTkzMA==", "bodyText": "can we add a Javadoc explaining the usage of this class", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#discussion_r501605930", "createdAt": "2020-10-08T10:14:25Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/appinsights/CallbackTelemetryThreadContext.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package uk.gov.hmcts.ccd.appinsights;\n+\n+public class CallbackTelemetryThreadContext {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38a4833bb1e8925fe38a95992864e946364d1120"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NjMzMDQw", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-504633040", "createdAt": "2020-10-08T10:16:11Z", "commit": {"oid": "38a4833bb1e8925fe38a95992864e946364d1120"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoxNjoxMVrOHeXqxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoxNjoxMVrOHeXqxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYwNzEwOA==", "bodyText": "Maybe let's call it TelemetryContext so that in the future we can use it for other types of Azure dependency calls as well?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#discussion_r501607108", "createdAt": "2020-10-08T10:16:11Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/appinsights/CallbackTelemetryContext.java", "diffHunk": "@@ -0,0 +1,14 @@\n+package uk.gov.hmcts.ccd.appinsights;\n+\n+public class CallbackTelemetryContext {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38a4833bb1e8925fe38a95992864e946364d1120"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NjQwNTEy", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-504640512", "createdAt": "2020-10-08T10:26:06Z", "commit": {"oid": "38a4833bb1e8925fe38a95992864e946364d1120"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoyNjowNlrOHeYCBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoyNjowNlrOHeYCBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYxMzA2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class TracingConfiguration {\n          \n          \n            \n            public class AppInsightsTracingConfiguration {", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#discussion_r501613063", "createdAt": "2020-10-08T10:26:06Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/config/TracingConfiguration.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package uk.gov.hmcts.ccd.config;\n+\n+import com.microsoft.applicationinsights.extensibility.TelemetryProcessor;\n+import com.microsoft.applicationinsights.telemetry.RemoteDependencyTelemetry;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import uk.gov.hmcts.ccd.appinsights.CallbackTelemetryContext;\n+import uk.gov.hmcts.ccd.appinsights.CallbackTelemetryThreadContext;\n+\n+@Configuration\n+public class TracingConfiguration {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38a4833bb1e8925fe38a95992864e946364d1120"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NjQzMzEx", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-504643311", "createdAt": "2020-10-08T10:29:56Z", "commit": {"oid": "38a4833bb1e8925fe38a95992864e946364d1120"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoyOTo1NlrOHeYKdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoyOTo1NlrOHeYKdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYxNTIyMg==", "bodyText": "with this solution we assume if a telemetry context exists then the dependency is a callback. We could make this a bit more generic and reusable for non-callback dependencies by marking as callback if getCallbackType() is not blank?", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#discussion_r501615222", "createdAt": "2020-10-08T10:29:56Z", "author": {"login": "mario-paniccia"}, "path": "src/main/java/uk/gov/hmcts/ccd/config/TracingConfiguration.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package uk.gov.hmcts.ccd.config;\n+\n+import com.microsoft.applicationinsights.extensibility.TelemetryProcessor;\n+import com.microsoft.applicationinsights.telemetry.RemoteDependencyTelemetry;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import uk.gov.hmcts.ccd.appinsights.CallbackTelemetryContext;\n+import uk.gov.hmcts.ccd.appinsights.CallbackTelemetryThreadContext;\n+\n+@Configuration\n+public class TracingConfiguration {\n+\n+    @Bean\n+    // Custom TelemetryProcessor which tags the type of {@link RemoteDependencyTelemetry} as callback before publishing.\n+    public TelemetryProcessor callbackRecognitionProcessor() {\n+        return telemetry -> {\n+            if (telemetry instanceof RemoteDependencyTelemetry) {\n+                RemoteDependencyTelemetry dependency = (RemoteDependencyTelemetry) telemetry;\n+                if (dependency.getType().startsWith(\"Http\")\n+                    && CallbackTelemetryThreadContext.getTelemetryContext() != null) {\n+\n+                    CallbackTelemetryContext telemetryContext = CallbackTelemetryThreadContext.getTelemetryContext();\n+                    dependency.getProperties().put(\"callback\", \"true\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38a4833bb1e8925fe38a95992864e946364d1120"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NjQ2OTMy", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-504646932", "createdAt": "2020-10-08T10:35:02Z", "commit": {"oid": "38a4833bb1e8925fe38a95992864e946364d1120"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c13ae8ff531ac3893a48c7f6a8822d1dc2eae61", "author": {"user": {"login": "smathangi", "name": "Sateesh Mathangi"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/8c13ae8ff531ac3893a48c7f6a8822d1dc2eae61", "committedDate": "2020-10-08T10:46:00Z", "message": "Update src/main/java/uk/gov/hmcts/ccd/config/TracingConfiguration.java\n\nCo-authored-by: Mario Paniccia <mario.paniccia@hmcts.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3cbc9b30f2e61aefdeabbf9ad55ba48ea7be15d", "author": {"user": {"login": "smathangi", "name": "Sateesh Mathangi"}}, "url": "https://github.com/hmcts/ccd-data-store-api/commit/a3cbc9b30f2e61aefdeabbf9ad55ba48ea7be15d", "committedDate": "2020-10-08T11:25:46Z", "message": "RDM-8787 - CallbackType enum"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NzEwODEz", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1154#pullrequestreview-504710813", "createdAt": "2020-10-08T12:06:06Z", "commit": {"oid": "a3cbc9b30f2e61aefdeabbf9ad55ba48ea7be15d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2761, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}