{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzNDE5Mzg0", "number": 1110, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODo1Mjo0M1rOEFKMVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMjozMjoxMFrOEFt_mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczODQ1MzM1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODo1Mjo0M1rOGjOddw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QwMToxODo0OFrOGjU5dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU5MDI2Mw==", "bodyText": "We use the one from the new snapshot so that the timestamps all match. Do you think we should change that?", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r439590263", "createdAt": "2020-06-12T18:52:43Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -431,7 +446,10 @@ public TableMetadata addStagedSnapshot(Snapshot snapshot) {\n         .build();\n \n     return new TableMetadata(null, formatVersion, uuid, location,\n-        snapshot.sequenceNumber(), snapshot.timestampMillis(), lastColumnId, schema, defaultSpecId, specs, properties,\n+        snapshot.sequenceNumber(),\n+        //TODO: should this be System.currentTimeMillis()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "387c249e34d92daadd8f51fd41c4ef39e92dffa8"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3OTg2OA==", "bodyText": "I think it is ok.", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r439679868", "createdAt": "2020-06-12T23:34:09Z", "author": {"login": "rdsr"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -431,7 +446,10 @@ public TableMetadata addStagedSnapshot(Snapshot snapshot) {\n         .build();\n \n     return new TableMetadata(null, formatVersion, uuid, location,\n-        snapshot.sequenceNumber(), snapshot.timestampMillis(), lastColumnId, schema, defaultSpecId, specs, properties,\n+        snapshot.sequenceNumber(),\n+        //TODO: should this be System.currentTimeMillis()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU5MDI2Mw=="}, "originalCommit": {"oid": "387c249e34d92daadd8f51fd41c4ef39e92dffa8"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY5NTczNQ==", "bodyText": "If it's okay, can you remove this change?", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r439695735", "createdAt": "2020-06-13T01:18:48Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -431,7 +446,10 @@ public TableMetadata addStagedSnapshot(Snapshot snapshot) {\n         .build();\n \n     return new TableMetadata(null, formatVersion, uuid, location,\n-        snapshot.sequenceNumber(), snapshot.timestampMillis(), lastColumnId, schema, defaultSpecId, specs, properties,\n+        snapshot.sequenceNumber(),\n+        //TODO: should this be System.currentTimeMillis()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU5MDI2Mw=="}, "originalCommit": {"oid": "387c249e34d92daadd8f51fd41c4ef39e92dffa8"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczODU0Mzc0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxOToyODo0N1rOGjPX1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxOTo0Mjo1N1rOGjPs9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYwNTIwNA==", "bodyText": "@rdblue . Thoughts on this?", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r439605204", "createdAt": "2020-06-12T19:28:47Z", "author": {"login": "rdsr"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -257,14 +260,26 @@ public String toString() {\n     }\n \n     MetadataLogEntry previous = null;\n+    // TODO: this check seems redundant if we are checking lastUpdatedMillis below", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "387c249e34d92daadd8f51fd41c4ef39e92dffa8"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYxMDYxMw==", "bodyText": "You already answered this in the issue. Thanks!", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r439610613", "createdAt": "2020-06-12T19:42:57Z", "author": {"login": "rdsr"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -257,14 +260,26 @@ public String toString() {\n     }\n \n     MetadataLogEntry previous = null;\n+    // TODO: this check seems redundant if we are checking lastUpdatedMillis below", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYwNTIwNA=="}, "originalCommit": {"oid": "387c249e34d92daadd8f51fd41c4ef39e92dffa8"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTExMzQ1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QwMToxNjo0NFrOGjU4xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QwMToxNjo0NFrOGjU4xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY5NTU1OQ==", "bodyText": "I try to avoid variable names in log messages. Plain language is easier for users and tends to be more descriptive. How about \"Invalid update timestamp %s: before last snapshot log entry at %s\"?", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r439695559", "createdAt": "2020-06-13T01:16:44Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -253,14 +253,21 @@ public String toString() {\n     for (HistoryEntry logEntry : snapshotLog) {\n       if (last != null) {\n         Preconditions.checkArgument(\n-            (logEntry.timestampMillis() - last.timestampMillis()) >= 0,\n+            (logEntry.timestampMillis() - last.timestampMillis()) >= -ONE_MINUTE,\n             \"[BUG] Expected sorted snapshot log entries.\");\n       }\n       last = logEntry;\n     }\n+    if (last != null) {\n+      Preconditions.checkArgument(\n+          // commits can happen concurrently from different machines.\n+          // A tolerance helps us avoid failure for small clock skew\n+          lastUpdatedMillis - last.timestampMillis() >= -ONE_MINUTE,\n+          \"lastUpdatedMillis: %s should not be < than the latest snapshot log entry timestamp %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1519a7adbac3ed7ab62e20a3c130526677f83cfd"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTExNDA3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QwMToxNzo1MVrOGjU5LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMjozMToxMlrOGkE7zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY5NTY2MQ==", "bodyText": "Rather than wrapping a precondition in an if, it's shorter to add an or:\nPreconditions.checkArgument(last == null || lastUpdatedMillis - last.timestampMillis() >= -ONE_MINUTE, ...);", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r439695661", "createdAt": "2020-06-13T01:17:51Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -253,14 +253,21 @@ public String toString() {\n     for (HistoryEntry logEntry : snapshotLog) {\n       if (last != null) {\n         Preconditions.checkArgument(\n-            (logEntry.timestampMillis() - last.timestampMillis()) >= 0,\n+            (logEntry.timestampMillis() - last.timestampMillis()) >= -ONE_MINUTE,\n             \"[BUG] Expected sorted snapshot log entries.\");\n       }\n       last = logEntry;\n     }\n+    if (last != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1519a7adbac3ed7ab62e20a3c130526677f83cfd"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIzNjc1MQ==", "bodyText": "The issue is that the argument - last.timestampMillis() will be evaluated eagerly and may result in NPE", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r440236751", "createdAt": "2020-06-15T14:55:55Z", "author": {"login": "rdsr"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -253,14 +253,21 @@ public String toString() {\n     for (HistoryEntry logEntry : snapshotLog) {\n       if (last != null) {\n         Preconditions.checkArgument(\n-            (logEntry.timestampMillis() - last.timestampMillis()) >= 0,\n+            (logEntry.timestampMillis() - last.timestampMillis()) >= -ONE_MINUTE,\n             \"[BUG] Expected sorted snapshot log entries.\");\n       }\n       last = logEntry;\n     }\n+    if (last != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY5NTY2MQ=="}, "originalCommit": {"oid": "1519a7adbac3ed7ab62e20a3c130526677f83cfd"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4Mjc2NA==", "bodyText": "It shouldn't be evaluated eagerly. Are you sure about that? We use this pattern in other classes without a problem.", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r440482764", "createdAt": "2020-06-15T22:31:12Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -253,14 +253,21 @@ public String toString() {\n     for (HistoryEntry logEntry : snapshotLog) {\n       if (last != null) {\n         Preconditions.checkArgument(\n-            (logEntry.timestampMillis() - last.timestampMillis()) >= 0,\n+            (logEntry.timestampMillis() - last.timestampMillis()) >= -ONE_MINUTE,\n             \"[BUG] Expected sorted snapshot log entries.\");\n       }\n       last = logEntry;\n     }\n+    if (last != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY5NTY2MQ=="}, "originalCommit": {"oid": "1519a7adbac3ed7ab62e20a3c130526677f83cfd"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NDMxODk3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMjozMjoxMFrOGkE9EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMjozMjoxMFrOGkE9EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4MzA4OQ==", "bodyText": "Nit: indentation is off.", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r440483089", "createdAt": "2020-06-15T22:32:10Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -250,21 +253,40 @@ public String toString() {\n     for (HistoryEntry logEntry : snapshotLog) {\n       if (last != null) {\n         Preconditions.checkArgument(\n-            (logEntry.timestampMillis() - last.timestampMillis()) >= 0,\n+            (logEntry.timestampMillis() - last.timestampMillis()) >= -ONE_MINUTE,\n             \"[BUG] Expected sorted snapshot log entries.\");\n       }\n       last = logEntry;\n     }\n+    if (last != null) {\n+      Preconditions.checkArgument(\n+          // commits can happen concurrently from different machines.\n+          // A tolerance helps us avoid failure for small clock skew\n+          lastUpdatedMillis - last.timestampMillis() >= -ONE_MINUTE,\n+          \"Invalid update timestamp %s: before last snapshot log entry at %s\",\n+          lastUpdatedMillis, last.timestampMillis());\n+    }\n \n     MetadataLogEntry previous = null;\n     for (MetadataLogEntry metadataEntry : previousFiles) {\n       if (previous != null) {\n         Preconditions.checkArgument(\n-            (metadataEntry.timestampMillis() - previous.timestampMillis()) >= 0,\n+            // commits can happen concurrently from different machines.\n+            // A tolerance helps us avoid failure for small clock skew\n+            (metadataEntry.timestampMillis() - previous.timestampMillis()) >= -ONE_MINUTE,\n             \"[BUG] Expected sorted previous metadata log entries.\");\n       }\n       previous = metadataEntry;\n     }\n+      // Make sure that this update's lastUpdatedMillis is > max(previousFile's timestamp)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16bc39320f812d4563e677177412502b8ab1c47c"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3897, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}