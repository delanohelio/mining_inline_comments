{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3MTk5NTQy", "number": 1638, "title": "Fix Reading of Statistics from old Parquet CDH Versions", "bodyText": "The behvaior of hasNonNull in parquet statistics chagnes based on the\nversion of the file that the statistics are read from. For binary columns\ngenerated by CDH 1.5.0 to 1.7.0, the function returns hasNonNull as false\neven if there are nonNull values in the column. This not an issue for files\nwritten by OSS Parquet because of a seperate bug which prohibts reading these\nstatistics from Parquet earlier than 1.8.0. The fix for that bug (PARQUET-251)\nwas backported in to the CDH distribution so it correctly can return statistics\nbut not in a format that Iceberg is able to handle correctly.", "createdAt": "2020-10-21T02:11:54Z", "url": "https://github.com/apache/iceberg/pull/1638", "merged": true, "mergeCommit": {"oid": "997f571273509270904f4ce7490af0cbe9262190"}, "closed": true, "closedAt": "2020-10-22T00:07:37Z", "author": {"login": "RussellSpitzer"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUhdJ9AH2gAyNTA3MTk5NTQyOmQwNTQ3Y2I0OGIxODE0MzRmNzdlMGZjYWI3ZjUzY2YwYWNjMTU5M2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdU1fH2gH2gAyNTA3MTk5NTQyOmNlOGUyMjE4MWMwNjdhZjJjYWIzMjYxMDk3Njk2MzgwYzg3YjJmMmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d0547cb48b181434f77e0fcab7f53cf0acc1593a", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/d0547cb48b181434f77e0fcab7f53cf0acc1593a", "committedDate": "2020-10-20T23:34:26Z", "message": "Fix Reading of Statistics from old Parquet CDH Versions\n\nThe behvaior of hasNonNull in parquet statistics chagnes based on the\nversion of the file that the statistics are read from. For binary columns\ngenerated by CDH 1.5.0 to 1.7.0, the function returns hasNonNull as false\neven if there are nonNull values in the column. This not an issue for files\nwritten by OSS Parquet because of a seperate bug which prohibts reading these\nstatistics from Parquet earlier than 1.8.0. The fix for that bug (PARQUET-251)\nwas backported in to the CDH distribution so it correctly can return statistics\nbut not in a format that Iceberg is able to handle correctly."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MjE4NzU3", "url": "https://github.com/apache/iceberg/pull/1638#pullrequestreview-514218757", "createdAt": "2020-10-21T22:02:27Z", "commit": {"oid": "d0547cb48b181434f77e0fcab7f53cf0acc1593a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMjowMjoyOFrOHmIDKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMjowMjoyOFrOHmIDKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTczOTgxNg==", "bodyText": "Should we also test -1 for num nulls? I know we don't expect it, but the behavior should still be correct, I think.", "url": "https://github.com/apache/iceberg/pull/1638#discussion_r509739816", "createdAt": "2020-10-21T22:02:28Z", "author": {"login": "rdblue"}, "path": "parquet/src/test/java/org/apache/iceberg/parquet/TestCDHParquetStatistics.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.parquet;\n+\n+import org.apache.parquet.column.statistics.Statistics;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Tests for Parquet 1.5.0-Stats which cannot be evaluated like later versions of Parquet stats. They are intercepted\n+ * by the hasNonNullButNoMinMax function which always returns ROWS_MAY_MATCH\n+ */\n+public class TestCDHParquetStatistics {\n+\n+  @Test\n+  public void testCDHParquetStatistcs() {\n+    Statistics cdhBinaryColumnStats = mock(Statistics.class);\n+    when(cdhBinaryColumnStats.getMaxBytes()).thenReturn(null);\n+    when(cdhBinaryColumnStats.getMinBytes()).thenReturn(null);\n+    when(cdhBinaryColumnStats.getNumNulls()).thenReturn(0L);\n+    Assert.assertTrue(ParquetMetricsRowGroupFilter.hasNonNullButNoMinMax(cdhBinaryColumnStats, 50L));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0547cb48b181434f77e0fcab7f53cf0acc1593a"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MjE4OTEx", "url": "https://github.com/apache/iceberg/pull/1638#pullrequestreview-514218911", "createdAt": "2020-10-21T22:02:45Z", "commit": {"oid": "d0547cb48b181434f77e0fcab7f53cf0acc1593a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMjowMjo0NVrOHmIEFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMjowMjo0NVrOHmIEFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0MDA1Mw==", "bodyText": "Why is this bug limited to binary and strings?", "url": "https://github.com/apache/iceberg/pull/1638#discussion_r509740053", "createdAt": "2020-10-21T22:02:45Z", "author": {"login": "rdblue"}, "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetMetricsRowGroupFilter.java", "diffHunk": "@@ -423,4 +451,24 @@ public Boolean or(Boolean leftResult, Boolean rightResult) {\n       return (T) conversions.get(id).apply(statistics.genericGetMax());\n     }\n   }\n+\n+  /**\n+   * Checks against older versions of Parquet statistics which may have a null count but undefined min and max\n+   * statistics. Returns true if nonNull values exist in the row group but no further statistics are available.\n+   * <p>\n+   * We can't use {@code  statistics.hasNonNullValue()} because it is inaccurate with older files and will return\n+   * false if min and max are not set.\n+   * <p>\n+   * This is specifically for 1.5.0-CDH Parquet builds and later which contain the different unusual hasNonNull\n+   * behavior. OSS Parquet builds are not effected because PARQUET-251 prohibits the reading of these statistics", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0547cb48b181434f77e0fcab7f53cf0acc1593a"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce8e22181c067af2cab3261097696380c87b2f2a", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/ce8e22181c067af2cab3261097696380c87b2f2a", "committedDate": "2020-10-21T22:54:41Z", "message": "Adds tests for numNull not set"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4003, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}