{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwODU0NTE0", "number": 854, "title": "Fix ConcateCloseableIterable issue with starting empty iterables", "bodyText": "Guava has some APIs which will call next() before hasNext(), this will have an issue when using ConcatCloseableIterable with starting empty iterables.\nFor example, calling Iterables.getLast() on CloseableIterable.concat(Lists.newArrayList(empty, empty, iter)) will throw a NoSuchElementException, but obviously this ConcatCloseableIterable do has element. So here fixing this issue by exhausting the starting empty iterables.\nHere's the implementation of Iterables.getLast():\n  public static <T> T getLast(Iterator<T> iterator) {\n    while (true) {\n      T current = iterator.next();\n      if (!iterator.hasNext()) {\n        return current;\n      }\n    }\n  }", "createdAt": "2020-03-19T08:02:52Z", "url": "https://github.com/apache/iceberg/pull/854", "merged": true, "mergeCommit": {"oid": "a908d9c0d55621703797594a4f57cf3e95ea05dc"}, "closed": true, "closedAt": "2020-03-24T20:57:43Z", "author": {"login": "jerryshao"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPHFU7AH2gAyMzkwODU0NTE0OmY3MGIyNzI3NzVlYzQxZjEwZTUzN2Y3MzNhMjU0MjI4MzdjNDM3ZjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQ4QK6gFqTM4MDYzNzI1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f70b272775ec41f10e537f733a25422837c437f6", "author": {"user": {"login": "jerryshao", "name": "Saisai Shao"}}, "url": "https://github.com/apache/iceberg/commit/f70b272775ec41f10e537f733a25422837c437f6", "committedDate": "2020-03-19T07:50:06Z", "message": "Fix CloseableIterable issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3ODAwOTU1", "url": "https://github.com/apache/iceberg/pull/854#pullrequestreview-377800955", "createdAt": "2020-03-19T14:56:53Z", "commit": {"oid": "f70b272775ec41f10e537f733a25422837c437f6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNDo1Njo1M1rOF4yXRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNDo1Njo1M1rOF4yXRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA4OTczMg==", "bodyText": "Would it be simpler to call hasNext in next method instead? like so\n@Override\n      public E next() {\n        if (hasNext()) {\n          return currentIterator.next();\n        } else {\n          throw new NoSuchElementException();\n        }\n      }\n\nMy understanding is we can keep calling hasNext as many times as we want until we consume that element from the Iterator.", "url": "https://github.com/apache/iceberg/pull/854#discussion_r395089732", "createdAt": "2020-03-19T14:56:53Z", "author": {"login": "rdsr"}, "path": "api/src/main/java/org/apache/iceberg/io/CloseableIterable.java", "diffHunk": "@@ -130,6 +130,20 @@ public O next() {\n       private ConcatCloseableIterator(Iterable<CloseableIterable<E>> inputs) {\n         this.iterables = inputs.iterator();\n         this.currentIterable = iterables.next();\n+        // Exhaust the starting empty iterables.\n+        while (Iterables.isEmpty(currentIterable)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f70b272775ec41f10e537f733a25422837c437f6"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4be51d3f1de8f8a806e6afd283916a712b219e80", "author": {"user": {"login": "jerryshao", "name": "Saisai Shao"}}, "url": "https://github.com/apache/iceberg/commit/4be51d3f1de8f8a806e6afd283916a712b219e80", "committedDate": "2020-03-20T02:20:16Z", "message": "Address the comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODYwNTQ0", "url": "https://github.com/apache/iceberg/pull/854#pullrequestreview-378860544", "createdAt": "2020-03-20T23:24:52Z", "commit": {"oid": "4be51d3f1de8f8a806e6afd283916a712b219e80"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMzoyNDo1MlrOF5lqEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMzoyNDo1MlrOF5lqEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzMDEyOA==", "bodyText": "Sorry I missed this before. Can we use AssertHelpers.assertThrows api here validate that the exception is thrown. If we add it as an annotation at the method level, it can catch false positives.", "url": "https://github.com/apache/iceberg/pull/854#discussion_r395930128", "createdAt": "2020-03-20T23:24:52Z", "author": {"login": "rdsr"}, "path": "api/src/test/java/org/apache/iceberg/io/TestCloseableIterable.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.io;\n+\n+import com.google.common.collect.Iterables;\n+import com.google.common.collect.Lists;\n+import java.util.NoSuchElementException;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class TestCloseableIterable {\n+\n+  @Test(expected = NoSuchElementException.class)\n+  public void testConcateWithEmptyIterables() {\n+    CloseableIterable<Integer> iter = CloseableIterable.combine(Lists.newArrayList(1, 2, 3), () -> { });\n+    CloseableIterable<Integer> empty = CloseableIterable.empty();\n+\n+    CloseableIterable<Integer> concat1 = CloseableIterable.concat(Lists.newArrayList(iter, empty, empty));\n+    Assert.assertEquals(Iterables.getLast(concat1).intValue(), 3);\n+\n+    CloseableIterable<Integer> concat2 = CloseableIterable.concat(Lists.newArrayList(empty, empty, iter));\n+    Assert.assertEquals(Iterables.getLast(concat2).intValue(), 3);\n+\n+    CloseableIterable<Integer> concat3 = CloseableIterable.concat(Lists.newArrayList(empty, iter, empty));\n+    Assert.assertEquals(Iterables.getLast(concat3).intValue(), 3);\n+\n+    CloseableIterable<Integer> concat4 = CloseableIterable.concat(Lists.newArrayList(empty, iter, empty, empty, iter));\n+    Assert.assertEquals(Iterables.getLast(concat4).intValue(), 3);\n+\n+    // This will throw a NoSuchElementException\n+    CloseableIterable<Integer> concat5 = CloseableIterable.concat(Lists.newArrayList(empty, empty, empty));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4be51d3f1de8f8a806e6afd283916a712b219e80"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8c92dfc81150dff8f6742a88b49dba11031485e", "author": {"user": {"login": "jerryshao", "name": "Saisai Shao"}}, "url": "https://github.com/apache/iceberg/commit/e8c92dfc81150dff8f6742a88b49dba11031485e", "committedDate": "2020-03-23T03:14:54Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNjM3MjU0", "url": "https://github.com/apache/iceberg/pull/854#pullrequestreview-380637254", "createdAt": "2020-03-24T19:37:42Z", "commit": {"oid": "e8c92dfc81150dff8f6742a88b49dba11031485e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxOTozNzo0M1rOF7AIzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxOTozNzo0M1rOF7AIzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQxMjU1OQ==", "bodyText": "Seems like we could have avoided these methods if we throw NoSuchElementException with a message. But I guess I'm OK with these as well.", "url": "https://github.com/apache/iceberg/pull/854#discussion_r397412559", "createdAt": "2020-03-24T19:37:43Z", "author": {"login": "rdsr"}, "path": "api/src/test/java/org/apache/iceberg/AssertHelpers.java", "diffHunk": "@@ -68,17 +68,43 @@ public static void assertThrows(String message,\n     }\n   }\n \n+  /**\n+   * A convenience method to avoid a large number of @Test(expected=...) tests\n+   * @param message A String message to describe this assertion\n+   * @param expected An Exception class that the Runnable should throw\n+   * @param callable A Callable that is expected to throw the exception\n+   */\n+  public static void assertThrows(String message,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8c92dfc81150dff8f6742a88b49dba11031485e"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4731, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}