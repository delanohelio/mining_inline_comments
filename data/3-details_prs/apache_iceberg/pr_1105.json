{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxMzI1MDgw", "number": 1105, "title": "Support DeleteFile in MergingSnapshotProducer", "bodyText": "This adds support for DeleteFile to MergingSnapshotProducer, which is the base class used to implement most operations that update Iceberg table data.\nTo test the updates, this adds a new RowDelta operation to Table and Transaction that adds DeleteFile and DataFile instances to the table. The tests are in TestRowDelta and mainly test the behavior of operations when there are delete files in table metadata. This doesn't add new tests for DeleteFile compaction or cleanup because the same code is used for delete and data files. There is no need to duplicate the testing done for data files.", "createdAt": "2020-06-08T18:45:03Z", "url": "https://github.com/apache/iceberg/pull/1105", "merged": true, "mergeCommit": {"oid": "e0180f783f62f4cd0f30b13a62ef5fcd1cc6f3b9"}, "closed": true, "closedAt": "2020-06-16T15:27:46Z", "author": {"login": "rdblue"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpXFmxgBqjM0MjIwMzkyNzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr28ZSAFqTQzMTYyNzAzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76c757ad89f7fc68b0ffd1f9cb44b7b8e7672d96", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/76c757ad89f7fc68b0ffd1f9cb44b7b8e7672d96", "committedDate": "2020-06-08T18:40:03Z", "message": "Support DeleteFile in MergingSnapshotProducer."}, "afterCommit": {"oid": "80650b9ee9526a7adfc670b98117dc0bdc7b0d10", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/80650b9ee9526a7adfc670b98117dc0bdc7b0d10", "committedDate": "2020-06-08T21:10:41Z", "message": "Support DeleteFile in MergingSnapshotProducer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8c1d68f17f0965194517e79ca84b14c53af5b5c", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/c8c1d68f17f0965194517e79ca84b14c53af5b5c", "committedDate": "2020-06-10T15:53:13Z", "message": "Support DeleteFile in MergingSnapshotProducer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64f868fae120c076b0a3162de5200758134da330", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/64f868fae120c076b0a3162de5200758134da330", "committedDate": "2020-06-10T15:53:13Z", "message": "Add RowDelta operation to Tables and Transactions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb25080181da91d195d0e9fd401044ce75382c8f", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/eb25080181da91d195d0e9fd401044ce75382c8f", "committedDate": "2020-06-10T15:53:13Z", "message": "Add tests for DeleteFiles with data file operations."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "793b3b601ddf3b184e25ed46acfcd39f83cbf7f9", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/793b3b601ddf3b184e25ed46acfcd39f83cbf7f9", "committedDate": "2020-06-09T00:45:50Z", "message": "Add tests for DeleteFiles with data file operations."}, "afterCommit": {"oid": "eb25080181da91d195d0e9fd401044ce75382c8f", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/eb25080181da91d195d0e9fd401044ce75382c8f", "committedDate": "2020-06-10T15:53:13Z", "message": "Add tests for DeleteFiles with data file operations."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MjAwNTc4", "url": "https://github.com/apache/iceberg/pull/1105#pullrequestreview-428200578", "createdAt": "2020-06-10T15:55:43Z", "commit": {"oid": "eb25080181da91d195d0e9fd401044ce75382c8f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNTo1NTo0M1rOGh7nCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNTo1NTo0M1rOGh7nCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzMjg0Mw==", "bodyText": "This is named FileMetadata because DeleteFiles is the public API for deleting data files.", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r438232843", "createdAt": "2020-06-10T15:55:43Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/FileMetadata.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import java.nio.ByteBuffer;\n+import java.util.Locale;\n+import java.util.Map;\n+import org.apache.hadoop.fs.FileStatus;\n+import org.apache.iceberg.encryption.EncryptedOutputFile;\n+import org.apache.iceberg.encryption.EncryptionKeyMetadata;\n+import org.apache.iceberg.hadoop.HadoopInputFile;\n+import org.apache.iceberg.io.InputFile;\n+import org.apache.iceberg.relocated.com.google.common.base.Preconditions;\n+import org.apache.iceberg.util.ByteBuffers;\n+\n+class FileMetadata {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb25080181da91d195d0e9fd401044ce75382c8f"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MjA3NDE2", "url": "https://github.com/apache/iceberg/pull/1105#pullrequestreview-428207416", "createdAt": "2020-06-10T16:03:03Z", "commit": {"oid": "eb25080181da91d195d0e9fd401044ce75382c8f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjowMzowNFrOGh77MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNjowMzowNFrOGh77MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzODAwMA==", "bodyText": "Should we detect whether delete and data files are added and change this to append or delete if there are only delete or only data files?", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r438238000", "createdAt": "2020-06-10T16:03:04Z", "author": {"login": "rdblue"}, "path": "core/src/test/java/org/apache/iceberg/TestRowDelta.java", "diffHunk": "@@ -0,0 +1,306 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import org.apache.iceberg.ManifestEntry.Status;\n+import org.apache.iceberg.expressions.Expressions;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class TestRowDelta extends V2TableTestBase {\n+  @Test\n+  public void testAddDeleteFile() {\n+    table.newRowDelta()\n+        .addRows(FILE_A)\n+        .addDeletes(FILE_A_DELETES)\n+        .addDeletes(FILE_B_DELETES)\n+        .commit();\n+\n+    Snapshot snap = table.currentSnapshot();\n+    Assert.assertEquals(\"Commit should produce sequence number 1\", 1, snap.sequenceNumber());\n+    Assert.assertEquals(\"Last sequence number should be 1\", 1, table.ops().current().lastSequenceNumber());\n+    Assert.assertEquals(\"Delta commit should use operation 'overwrite'\", DataOperations.OVERWRITE, snap.operation());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb25080181da91d195d0e9fd401044ce75382c8f"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "effe279998c34e62f54dbbb5d1fb8e8df1bda373", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/effe279998c34e62f54dbbb5d1fb8e8df1bda373", "committedDate": "2020-06-10T16:35:52Z", "message": "Reorder methods to fix checkstyle."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNzQ5MDE2", "url": "https://github.com/apache/iceberg/pull/1105#pullrequestreview-430749016", "createdAt": "2020-06-15T15:21:25Z", "commit": {"oid": "effe279998c34e62f54dbbb5d1fb8e8df1bda373"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNToyMToyNVrOGj3CRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNToyMToyNVrOGj3CRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI1NTA0Ng==", "bodyText": "Does it mean I can use the DeleteFiles API to remove delete files now? Currently, that API accepts only data files and locations. Now, we can give a path and this will remove a delete file too. Removing a delete file means adding data back? If that's what we want, will we also allow passing DeleteFile for performance?", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r440255046", "createdAt": "2020-06-15T15:21:25Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java", "diffHunk": "@@ -166,41 +125,66 @@ protected void failMissingDeletePaths() {\n   protected void deleteByRowFilter(Expression expr) {\n     this.deleteExpression = expr;\n     filterManager.deleteByRowFilter(expr);\n+    // if a delete file matches the row filter, then it can be deleted because the rows will also be deleted\n+    deleteFilterManager.deleteByRowFilter(expr);\n   }\n \n   /**\n    * Add a partition tuple to drop from the table during the delete phase.\n    */\n   protected void dropPartition(StructLike partition) {\n+    // dropping the data in a partition also drops all deletes in the partition\n     filterManager.dropPartition(partition);\n+    deleteFilterManager.dropPartition(partition);\n   }\n \n   /**\n-   * Add a specific path to be deleted in the new snapshot.\n+   * Add a specific data file to be deleted in the new snapshot.\n    */\n   protected void delete(DataFile file) {\n     filterManager.delete(file);\n   }\n \n+  /**\n+   * Add a specific delete file to be deleted in the new snapshot.\n+   */\n+  protected void delete(DeleteFile file) {\n+    deleteFilterManager.delete(file);\n+  }\n+\n   /**\n    * Add a specific path to be deleted in the new snapshot.\n    */\n   protected void delete(CharSequence path) {\n+    // because this is a location, it may be a data file or a delete file and must be added to both filter managers\n     filterManager.delete(path);\n+    deleteFilterManager.delete(path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "effe279998c34e62f54dbbb5d1fb8e8df1bda373"}, "originalPosition": 148}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNzUyOTA0", "url": "https://github.com/apache/iceberg/pull/1105#pullrequestreview-430752904", "createdAt": "2020-06-15T15:25:36Z", "commit": {"oid": "effe279998c34e62f54dbbb5d1fb8e8df1bda373"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNToyNTozNlrOGj3N5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNToyNTozNlrOGj3N5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI1ODAyMA==", "bodyText": "Will it be useful to track the number of delete files separately? I find it extremely useful to look at snapshot summaries on large tables as it gives an overview of the current state. Knowing the number of delete files separately from the number of data files seems reasonable and can guide users to perform compactions.", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r440258020", "createdAt": "2020-06-15T15:25:36Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java", "diffHunk": "@@ -166,41 +125,66 @@ protected void failMissingDeletePaths() {\n   protected void deleteByRowFilter(Expression expr) {\n     this.deleteExpression = expr;\n     filterManager.deleteByRowFilter(expr);\n+    // if a delete file matches the row filter, then it can be deleted because the rows will also be deleted\n+    deleteFilterManager.deleteByRowFilter(expr);\n   }\n \n   /**\n    * Add a partition tuple to drop from the table during the delete phase.\n    */\n   protected void dropPartition(StructLike partition) {\n+    // dropping the data in a partition also drops all deletes in the partition\n     filterManager.dropPartition(partition);\n+    deleteFilterManager.dropPartition(partition);\n   }\n \n   /**\n-   * Add a specific path to be deleted in the new snapshot.\n+   * Add a specific data file to be deleted in the new snapshot.\n    */\n   protected void delete(DataFile file) {\n     filterManager.delete(file);\n   }\n \n+  /**\n+   * Add a specific delete file to be deleted in the new snapshot.\n+   */\n+  protected void delete(DeleteFile file) {\n+    deleteFilterManager.delete(file);\n+  }\n+\n   /**\n    * Add a specific path to be deleted in the new snapshot.\n    */\n   protected void delete(CharSequence path) {\n+    // because this is a location, it may be a data file or a delete file and must be added to both filter managers\n     filterManager.delete(path);\n+    deleteFilterManager.delete(path);\n   }\n \n   /**\n-   * Add a file to the new snapshot.\n+   * Add a data file to the new snapshot.\n    */\n   protected void add(DataFile file) {\n+    addedFilesSummary.addedFile(spec, file);\n     hasNewFiles = true;\n     newFiles.add(file);\n   }\n \n+  /**\n+   * Add a delete file to the new snapshot.\n+   */\n+  protected void add(DeleteFile file) {\n+    addedFilesSummary.addedFile(spec, file);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "effe279998c34e62f54dbbb5d1fb8e8df1bda373"}, "originalPosition": 165}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "489b6b9bdbcac4338fb9dfdcd5a6fc0fd4109218", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/489b6b9bdbcac4338fb9dfdcd5a6fc0fd4109218", "committedDate": "2020-06-15T23:45:13Z", "message": "Update MergingSnapshotProducer.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNjI3MDMy", "url": "https://github.com/apache/iceberg/pull/1105#pullrequestreview-431627032", "createdAt": "2020-06-16T15:25:40Z", "commit": {"oid": "489b6b9bdbcac4338fb9dfdcd5a6fc0fd4109218"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4511, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}