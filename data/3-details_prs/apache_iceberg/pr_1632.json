{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MDUxOTE2", "number": 1632, "title": "Select correct ObjectInspector based on Hive version on classpath", "bodyText": "To fix #1630, the ObjectInspector selection logic needs to depend on checking the presence of Hive3 classes on the classpath.\ncc @rdblue @massdosage @pvary - thanks for checking!", "createdAt": "2020-10-19T14:58:15Z", "url": "https://github.com/apache/iceberg/pull/1632", "merged": true, "mergeCommit": {"oid": "0311c2330e9568c96a6beb0306851266b3f5568f"}, "closed": true, "closedAt": "2020-10-19T19:33:52Z", "author": {"login": "marton-bod"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUFYzKAH2gAyNTA2MDUxOTE2OjMwZjYzZWEyMjdkN2NhYzgxY2ZhZTE4Nzc0MDFmNjkyMmZiNjkwYWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUHbO0AH2gAyNTA2MDUxOTE2OmQyZGI0MjQyZjNmNTBiM2RlNGNlMThiNjZjNDZlYzM4ODQ0ZTJmOGQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "30f63ea227d7cac81cfae1877401f6922fb690af", "author": {"user": {"login": "marton-bod", "name": "Marton Bod"}}, "url": "https://github.com/apache/iceberg/commit/30f63ea227d7cac81cfae1877401f6922fb690af", "committedDate": "2020-10-19T14:52:20Z", "message": "Select correct ObjectInspector based on Hive version on classpath"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExOTExODE2", "url": "https://github.com/apache/iceberg/pull/1632#pullrequestreview-511911816", "createdAt": "2020-10-19T15:51:13Z", "commit": {"oid": "30f63ea227d7cac81cfae1877401f6922fb690af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExOTUwNjIy", "url": "https://github.com/apache/iceberg/pull/1632#pullrequestreview-511950622", "createdAt": "2020-10-19T16:34:49Z", "commit": {"oid": "30f63ea227d7cac81cfae1877401f6922fb690af"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjozNDo1MFrOHkXW7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjozNDo1MFrOHkXW7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5MzQ4Ng==", "bodyText": "Nit: indentation is off now.", "url": "https://github.com/apache/iceberg/pull/1632#discussion_r507893486", "createdAt": "2020-10-19T16:34:50Z", "author": {"login": "rdblue"}, "path": "mr/src/main/java/org/apache/iceberg/mr/hive/serde/objectinspector/IcebergObjectInspector.java", "diffHunk": "@@ -36,23 +37,29 @@\n \n   // get the correct inspectors depending on whether we're working with Hive2 or Hive3 dependencies\n   // we need to do this because there is a breaking API change in Date/TimestampObjectInspector between Hive2 and Hive3\n-  private static final ObjectInspector DATE_INSPECTOR = DynMethods.builder(\"get\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergDateObjectInspectorHive3\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergDateObjectInspector\")\n-      .buildStatic()\n-      .invoke();\n-\n-  private static final ObjectInspector TIMESTAMP_INSPECTOR = DynMethods.builder(\"get\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\", boolean.class)\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\", boolean.class)\n-      .buildStatic()\n-      .invoke(false);\n-\n-  private static final ObjectInspector TIMESTAMP_INSPECTOR_WITH_TZ = DynMethods.builder(\"get\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\", boolean.class)\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\", boolean.class)\n-      .buildStatic()\n-      .invoke(true);\n+  private static final ObjectInspector DATE_INSPECTOR = getObjectInspectorBasedOnHiveVersion(\"get\",\n+          \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergDateObjectInspector\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30f63ea227d7cac81cfae1877401f6922fb690af"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExOTUyOTI0", "url": "https://github.com/apache/iceberg/pull/1632#pullrequestreview-511952924", "createdAt": "2020-10-19T16:37:41Z", "commit": {"oid": "30f63ea227d7cac81cfae1877401f6922fb690af"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjozNzo0MVrOHkXeDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjozNzo0MVrOHkXeDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NTMwOQ==", "bodyText": "It seems like it would be a bit easier to read if you didn't wrap the DynMethods call and instead just swapped out the class:\nprivate static final TIMESTAMP_INSPECTOR_CLASS = MetastoreUtil.hive3PresentOnClasspath() ?\n    \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\" :\n    \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\";\nprivate static final ObjectInspector TIMESTAMP_INSPECTOR = DynMethods.builder(\"get\")\n    .impl(TIMESTAMP_INSPECTOR_CLASS, boolean.class)\n    .buildStatic()\n    .invoke(false);\nThat way you don't need all of the inline array literals.", "url": "https://github.com/apache/iceberg/pull/1632#discussion_r507895309", "createdAt": "2020-10-19T16:37:41Z", "author": {"login": "rdblue"}, "path": "mr/src/main/java/org/apache/iceberg/mr/hive/serde/objectinspector/IcebergObjectInspector.java", "diffHunk": "@@ -36,23 +37,29 @@\n \n   // get the correct inspectors depending on whether we're working with Hive2 or Hive3 dependencies\n   // we need to do this because there is a breaking API change in Date/TimestampObjectInspector between Hive2 and Hive3\n-  private static final ObjectInspector DATE_INSPECTOR = DynMethods.builder(\"get\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergDateObjectInspectorHive3\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergDateObjectInspector\")\n-      .buildStatic()\n-      .invoke();\n-\n-  private static final ObjectInspector TIMESTAMP_INSPECTOR = DynMethods.builder(\"get\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\", boolean.class)\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\", boolean.class)\n-      .buildStatic()\n-      .invoke(false);\n-\n-  private static final ObjectInspector TIMESTAMP_INSPECTOR_WITH_TZ = DynMethods.builder(\"get\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\", boolean.class)\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\", boolean.class)\n-      .buildStatic()\n-      .invoke(true);\n+  private static final ObjectInspector DATE_INSPECTOR = getObjectInspectorBasedOnHiveVersion(\"get\",\n+          \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergDateObjectInspector\",\n+          \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergDateObjectInspectorHive3\",\n+          new Class[] {}, new Object[] {});\n+\n+  private static final ObjectInspector TIMESTAMP_INSPECTOR = getObjectInspectorBasedOnHiveVersion(\"get\",\n+          \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\",\n+          \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\",\n+          new Class[] { boolean.class }, new Object[] { false });\n+\n+  private static final ObjectInspector TIMESTAMP_INSPECTOR_WITH_TZ = getObjectInspectorBasedOnHiveVersion(\"get\",\n+          \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\",\n+          \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\",\n+          new Class[] { boolean.class }, new Object[] { true });\n+\n+  private static ObjectInspector getObjectInspectorBasedOnHiveVersion(\n+          String staticMethod, String hive2Class, String hive3Class, Class[] argTypes, Object[] args) {\n+    String classToUse = MetastoreUtil.hive3PresentOnClasspath() ? hive3Class : hive2Class;\n+    return DynMethods.builder(staticMethod)\n+            .impl(classToUse, argTypes)\n+            .buildStatic()\n+            .invoke(args);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30f63ea227d7cac81cfae1877401f6922fb690af"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2db4242f3f50b3de4ce18b66c46ec38844e2f8d", "author": {"user": {"login": "marton-bod", "name": "Marton Bod"}}, "url": "https://github.com/apache/iceberg/commit/d2db4242f3f50b3de4ce18b66c46ec38844e2f8d", "committedDate": "2020-10-19T17:14:48Z", "message": "Simplify object inspector selection logic"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3990, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}