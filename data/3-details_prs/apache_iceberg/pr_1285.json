{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYxNjQ4MzU4", "number": 1285, "title": "Core: fix serialization issue in BaseCombinedScanTask with Kyro (No refactor)", "bodyText": "This patch is spin-off version of #1280 which excludes refactoring, to be included in bugfix version release.", "createdAt": "2020-08-02T03:02:57Z", "url": "https://github.com/apache/iceberg/pull/1285", "merged": true, "mergeCommit": {"oid": "e682ca59129ab668f163924b030280c3787db8f6"}, "closed": true, "closedAt": "2020-08-05T16:37:39Z", "author": {"login": "HeartSaVioR"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc60dyEgH2gAyNDYxNjQ4MzU4OjJkMjgyYThkMTY3ODY0MmFkNTJjYTc4NzVhZGIyMTRmYjEwNzIwOTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7xuxbgH2gAyNDYxNjQ4MzU4OjZiYTFjOTZiYTNjNmVhYzYxMTA4NDcwMWE0ZDcxOTI2ZWQyNTIwZjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2d282a8d1678642ad52ca7875adb214fb1072096", "author": {"user": {"login": "HeartSaVioR", "name": "Jungtaek Lim"}}, "url": "https://github.com/apache/iceberg/commit/2d282a8d1678642ad52ca7875adb214fb1072096", "committedDate": "2020-08-02T03:01:17Z", "message": "Core: fix serialization issue in BaseCombinedScanTask with Kyro (No refactor)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMjAxNjAx", "url": "https://github.com/apache/iceberg/pull/1285#pullrequestreview-460201601", "createdAt": "2020-08-03T17:18:25Z", "commit": {"oid": "2d282a8d1678642ad52ca7875adb214fb1072096"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzoxODoyNVrOG7B6aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzoxODoyNVrOG7B6aA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU1MDUwNA==", "bodyText": "What about a slightly different approach?\nRight now, the main problem is that List can't be easily serialized. But we know that tasks are FileScanTask and never changes, so we could use private final FileScanTask[] tasks instead, which has no problems with serialization.\nThen this would just need to copy into the array, tasks.stream().toArray(FileScanTask[]::new), and we could update files to return ImmutableList.copyOf(tasks).\nBy making those changes, we still end up with an immutable list returned by files, but take care of the serialization issue and don't need to add copyList.", "url": "https://github.com/apache/iceberg/pull/1285#discussion_r464550504", "createdAt": "2020-08-03T17:18:25Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseCombinedScanTask.java", "diffHunk": "@@ -19,21 +19,22 @@\n \n package org.apache.iceberg;\n \n+import java.util.Arrays;\n import java.util.Collection;\n import java.util.List;\n import org.apache.iceberg.relocated.com.google.common.base.Joiner;\n import org.apache.iceberg.relocated.com.google.common.base.MoreObjects;\n-import org.apache.iceberg.relocated.com.google.common.collect.ImmutableList;\n+import org.apache.iceberg.relocated.com.google.common.collect.Lists;\n \n public class BaseCombinedScanTask implements CombinedScanTask {\n   private final List<FileScanTask> tasks;\n \n   public BaseCombinedScanTask(FileScanTask... tasks) {\n-    this.tasks = ImmutableList.copyOf(tasks);\n+    this.tasks = Arrays.asList(tasks);\n   }\n \n   public BaseCombinedScanTask(List<FileScanTask> tasks) {\n-    this.tasks = ImmutableList.copyOf(tasks);\n+    this.tasks = copyList(tasks);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d282a8d1678642ad52ca7875adb214fb1072096"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2a2c768f74f11f1689932ad7cee66146a56f4d1", "author": {"user": {"login": "HeartSaVioR", "name": "Jungtaek Lim"}}, "url": "https://github.com/apache/iceberg/commit/a2a2c768f74f11f1689932ad7cee66146a56f4d1", "committedDate": "2020-08-04T02:22:11Z", "message": "Reflect review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTU4NDYx", "url": "https://github.com/apache/iceberg/pull/1285#pullrequestreview-460558461", "createdAt": "2020-08-04T07:23:32Z", "commit": {"oid": "a2a2c768f74f11f1689932ad7cee66146a56f4d1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNzoyMzozM1rOG7URfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNzoyMzozM1rOG7URfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg1MTMyNg==", "bodyText": "In Guava, ImmutableList.copyOf() will throw on null input. That same behavior isn't mentioned here. Should we document it, either via a Preconditions check or via an annotation such as @ParametersAreNonNullByDefault which Guava uses.\nNote: I can't speak for all versions of Guava obviously (I doubt anybody could at this point), but I found this isue mentioning it google/guava#2470", "url": "https://github.com/apache/iceberg/pull/1285#discussion_r464851326", "createdAt": "2020-08-04T07:23:33Z", "author": {"login": "kbendick"}, "path": "core/src/main/java/org/apache/iceberg/BaseCombinedScanTask.java", "diffHunk": "@@ -26,19 +26,19 @@\n import org.apache.iceberg.relocated.com.google.common.collect.ImmutableList;\n \n public class BaseCombinedScanTask implements CombinedScanTask {\n-  private final List<FileScanTask> tasks;\n+  private final FileScanTask[] tasks;\n \n   public BaseCombinedScanTask(FileScanTask... tasks) {\n-    this.tasks = ImmutableList.copyOf(tasks);\n+    this.tasks = tasks;\n   }\n \n   public BaseCombinedScanTask(List<FileScanTask> tasks) {\n-    this.tasks = ImmutableList.copyOf(tasks);\n+    this.tasks = tasks.stream().toArray(FileScanTask[]::new);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2a2c768f74f11f1689932ad7cee66146a56f4d1"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1357c223638a46d35780157d7f3d78b4d2680556", "author": {"user": {"login": "HeartSaVioR", "name": "Jungtaek Lim"}}, "url": "https://github.com/apache/iceberg/commit/1357c223638a46d35780157d7f3d78b4d2680556", "committedDate": "2020-08-04T09:07:16Z", "message": "Reflect review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDA4Mzc4", "url": "https://github.com/apache/iceberg/pull/1285#pullrequestreview-461008378", "createdAt": "2020-08-04T17:09:31Z", "commit": {"oid": "1357c223638a46d35780157d7f3d78b4d2680556"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNzowOTozMVrOG7pqpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNzowOTozMVrOG7pqpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwMTgyOQ==", "bodyText": "Why add these tests to TestRewriteDataFilesAction? These aren't specific to that action and the code change is in core. I think it would be more better to add these tests to TestDataFileSerialization, since that is quite similar. That, or create a new test suite, TestScanTaskSerialization. Either one is fine with me.", "url": "https://github.com/apache/iceberg/pull/1285#discussion_r465201829", "createdAt": "2020-08-04T17:09:31Z", "author": {"login": "rdblue"}, "path": "spark/src/test/java/org/apache/iceberg/actions/TestRewriteDataFilesAction.java", "diffHunk": "@@ -311,6 +325,128 @@ public void testRewriteLargeTableHasResiduals() {\n     Assert.assertEquals(\"Rows must match\", records, actualRecords);\n   }\n \n+  @Test\n+  public void testBaseCombinedScanTaskKryoSerialization() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1357c223638a46d35780157d7f3d78b4d2680556"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDA5MDUy", "url": "https://github.com/apache/iceberg/pull/1285#pullrequestreview-461009052", "createdAt": "2020-08-04T17:10:30Z", "commit": {"oid": "1357c223638a46d35780157d7f3d78b4d2680556"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNzoxMDozMVrOG7pszw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNzoxMDozMVrOG7pszw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwMjM4Mw==", "bodyText": "Nit: We try to keep error messages small, so we avoid unnecessary punctuation and words. We can remove the . here.", "url": "https://github.com/apache/iceberg/pull/1285#discussion_r465202383", "createdAt": "2020-08-04T17:10:31Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseCombinedScanTask.java", "diffHunk": "@@ -23,22 +23,24 @@\n import java.util.List;\n import org.apache.iceberg.relocated.com.google.common.base.Joiner;\n import org.apache.iceberg.relocated.com.google.common.base.MoreObjects;\n+import org.apache.iceberg.relocated.com.google.common.base.Preconditions;\n import org.apache.iceberg.relocated.com.google.common.collect.ImmutableList;\n \n public class BaseCombinedScanTask implements CombinedScanTask {\n-  private final List<FileScanTask> tasks;\n+  private final FileScanTask[] tasks;\n \n   public BaseCombinedScanTask(FileScanTask... tasks) {\n-    this.tasks = ImmutableList.copyOf(tasks);\n+    this.tasks = tasks;\n   }\n \n   public BaseCombinedScanTask(List<FileScanTask> tasks) {\n-    this.tasks = ImmutableList.copyOf(tasks);\n+    Preconditions.checkNotNull(tasks, \"tasks cannot be null.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1357c223638a46d35780157d7f3d78b4d2680556"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f80cfb9d729686dd2298d394494408a94dfc038c", "author": {"user": {"login": "HeartSaVioR", "name": "Jungtaek Lim"}}, "url": "https://github.com/apache/iceberg/commit/f80cfb9d729686dd2298d394494408a94dfc038c", "committedDate": "2020-08-04T22:16:22Z", "message": "Reflect review comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aab694ed92afc8f72cce2306f2dd1690061950bc", "author": {"user": {"login": "HeartSaVioR", "name": "Jungtaek Lim"}}, "url": "https://github.com/apache/iceberg/commit/aab694ed92afc8f72cce2306f2dd1690061950bc", "committedDate": "2020-08-04T21:58:30Z", "message": "Reflect review comment"}, "afterCommit": {"oid": "f80cfb9d729686dd2298d394494408a94dfc038c", "author": {"user": {"login": "HeartSaVioR", "name": "Jungtaek Lim"}}, "url": "https://github.com/apache/iceberg/commit/f80cfb9d729686dd2298d394494408a94dfc038c", "committedDate": "2020-08-04T22:16:22Z", "message": "Reflect review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMjY3OTQ5", "url": "https://github.com/apache/iceberg/pull/1285#pullrequestreview-461267949", "createdAt": "2020-08-05T00:49:16Z", "commit": {"oid": "f80cfb9d729686dd2298d394494408a94dfc038c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwMDo0OToxNlrOG72ReQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwMDo0OToxNlrOG72ReQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQwODM3Nw==", "bodyText": "This file needs the Apache license header, which you can copy from another file.", "url": "https://github.com/apache/iceberg/pull/1285#discussion_r465408377", "createdAt": "2020-08-05T00:49:16Z", "author": {"login": "rdblue"}, "path": "spark/src/test/java/org/apache/iceberg/TestScanTaskSerialization.java", "diffHunk": "@@ -0,0 +1,191 @@\n+package org.apache.iceberg;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f80cfb9d729686dd2298d394494408a94dfc038c"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c42b59b05a251d5747510ac987fa4982e39e1fcc", "author": {"user": {"login": "HeartSaVioR", "name": "Jungtaek Lim"}}, "url": "https://github.com/apache/iceberg/commit/c42b59b05a251d5747510ac987fa4982e39e1fcc", "committedDate": "2020-08-05T01:10:07Z", "message": "license header & checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ba1c96ba3c6eac611084701a4d71926ed2520f2", "author": {"user": {"login": "HeartSaVioR", "name": "Jungtaek Lim"}}, "url": "https://github.com/apache/iceberg/commit/6ba1c96ba3c6eac611084701a4d71926ed2520f2", "committedDate": "2020-08-05T02:24:03Z", "message": "Fixing..."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4381, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}