{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2MTA3MzY4", "number": 1122, "title": "Move classes that depend on DSv2 in Spark 2.x to spark2", "bodyText": "This is the next step to integrate the spark-3 branch into master. This PR moves classes that depend on DSv2 in Spark 2.x into the spark2 module.\nThe RewriteDataFilesAction used Spark reader and writers in its implementation, so this needed to also refactor those classes. This moves writer implementations out of Writer to top-level classes, and removes the DSv2 interfaces so that the rewrite action can use the same reader and writer code without a dependency on a DSv2 API. This refactor is a good preparation step because this should be shared between the spark2 and spark3 modules.", "createdAt": "2020-06-17T21:32:40Z", "url": "https://github.com/apache/iceberg/pull/1122", "merged": true, "mergeCommit": {"oid": "845de7bfe78bc8ba3480aad219fcef9f71477023"}, "closed": true, "closedAt": "2020-06-20T01:02:24Z", "author": {"login": "rdblue"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsQ0YrgFqTQzMjc5MzI0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcs8ndKgH2gAyNDM2MTA3MzY4OmM2NzdmZWU4Y2Y4YjViYzhlNGY0OTM3ZWRlNmQ3YmIyNGIzYmU4NWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNzkzMjQ0", "url": "https://github.com/apache/iceberg/pull/1122#pullrequestreview-432793244", "createdAt": "2020-06-17T21:34:26Z", "commit": {"oid": "167867cabd547951ee4e9e26c6ee15fb1904f5de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMTozNDoyNlrOGlYOGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMTozNDoyNlrOGlYOGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0NzMyMQ==", "bodyText": "This class is not used, so I removed it.", "url": "https://github.com/apache/iceberg/pull/1122#discussion_r441847321", "createdAt": "2020-06-17T21:34:26Z", "author": {"login": "rdblue"}, "path": "spark2/src/main/java/org/apache/iceberg/spark/source/Reader.java", "diffHunk": "@@ -480,41 +479,21 @@ private InternalRowReaderFactory() {\n     public InputPartitionReader<ColumnarBatch> create(CombinedScanTask task, Schema tableSchema, Schema expectedSchema,\n                                                       String nameMapping, FileIO io,\n                                                       EncryptionManager encryptionManager, boolean caseSensitive) {\n-      return new BatchDataReader(task, expectedSchema, nameMapping, io, encryptionManager, caseSensitive, batchSize);\n+      return new BatchReader(task, expectedSchema, nameMapping, io, encryptionManager, caseSensitive, batchSize);\n     }\n   }\n \n-  private static class StructLikeInternalRow implements StructLike {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "167867cabd547951ee4e9e26c6ee15fb1904f5de"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNzkzNDY1", "url": "https://github.com/apache/iceberg/pull/1122#pullrequestreview-432793465", "createdAt": "2020-06-17T21:34:50Z", "commit": {"oid": "167867cabd547951ee4e9e26c6ee15fb1904f5de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMTozNDo1MFrOGlYOww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMTozNDo1MFrOGlYOww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0NzQ5MQ==", "bodyText": "This wasn't used. The name mapping string is passed instead.", "url": "https://github.com/apache/iceberg/pull/1122#discussion_r441847491", "createdAt": "2020-06-17T21:34:50Z", "author": {"login": "rdblue"}, "path": "spark2/src/main/java/org/apache/iceberg/spark/source/Reader.java", "diffHunk": "@@ -396,8 +396,7 @@ public String toString() {\n \n     private transient Schema tableSchema = null;\n     private transient Schema expectedSchema = null;\n-    private transient NameMapping nameMapping = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "167867cabd547951ee4e9e26c6ee15fb1904f5de"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "167867cabd547951ee4e9e26c6ee15fb1904f5de", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/167867cabd547951ee4e9e26c6ee15fb1904f5de", "committedDate": "2020-06-17T21:25:37Z", "message": "Move classes that depend on DSv2 in Spark 2.x to spark2."}, "afterCommit": {"oid": "ea0c9a124718a97895fcc1a2feebeea1377beec0", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/ea0c9a124718a97895fcc1a2feebeea1377beec0", "committedDate": "2020-06-17T23:47:18Z", "message": "Move classes that depend on DSv2 in Spark 2.x to spark2."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMjA1Mjk4", "url": "https://github.com/apache/iceberg/pull/1122#pullrequestreview-433205298", "createdAt": "2020-06-18T11:52:13Z", "commit": {"oid": "ea0c9a124718a97895fcc1a2feebeea1377beec0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMTo1MjoxM1rOGlr19Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMTo1MjoxM1rOGlr19Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE2ODgyMQ==", "bodyText": "IIUC, both spark2 and spark3 will rely on this code, and this code requires one specific Spark dependency about the InternalRow, will this potentially go into an issue that has two versions of spark dependencies in Spark3 module?\nAlso if the signature of InternalRow of Spark2 and Spark3 is different, will this lead to an issue?", "url": "https://github.com/apache/iceberg/pull/1122#discussion_r442168821", "createdAt": "2020-06-18T11:52:13Z", "author": {"login": "jerryshao"}, "path": "spark/src/main/java/org/apache/iceberg/spark/source/BaseWriter.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.spark.source;\n+\n+import java.io.Closeable;\n+import java.io.IOException;\n+import java.util.List;\n+import org.apache.iceberg.DataFile;\n+import org.apache.iceberg.DataFiles;\n+import org.apache.iceberg.FileFormat;\n+import org.apache.iceberg.Metrics;\n+import org.apache.iceberg.PartitionSpec;\n+import org.apache.iceberg.encryption.EncryptedOutputFile;\n+import org.apache.iceberg.io.FileAppender;\n+import org.apache.iceberg.io.FileIO;\n+import org.apache.iceberg.relocated.com.google.common.collect.Lists;\n+import org.apache.iceberg.util.Tasks;\n+import org.apache.spark.sql.catalyst.InternalRow;\n+\n+abstract class BaseWriter implements Closeable {\n+  protected static final int ROWS_DIVISOR = 1000;\n+\n+  private final List<DataFile> completedFiles = Lists.newArrayList();\n+  private final PartitionSpec spec;\n+  private final FileFormat format;\n+  private final SparkAppenderFactory appenderFactory;\n+  private final OutputFileFactory fileFactory;\n+  private final FileIO io;\n+  private final long targetFileSize;\n+  private PartitionKey currentKey = null;\n+  private FileAppender<InternalRow> currentAppender = null;\n+  private EncryptedOutputFile currentFile = null;\n+  private long currentRows = 0;\n+\n+  BaseWriter(PartitionSpec spec, FileFormat format, SparkAppenderFactory appenderFactory,\n+             OutputFileFactory fileFactory, FileIO io, long targetFileSize) {\n+    this.spec = spec;\n+    this.format = format;\n+    this.appenderFactory = appenderFactory;\n+    this.fileFactory = fileFactory;\n+    this.io = io;\n+    this.targetFileSize = targetFileSize;\n+  }\n+\n+  public abstract void write(InternalRow row) throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea0c9a124718a97895fcc1a2feebeea1377beec0"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MzMyNjI0", "url": "https://github.com/apache/iceberg/pull/1122#pullrequestreview-434332624", "createdAt": "2020-06-19T20:44:06Z", "commit": {"oid": "ea0c9a124718a97895fcc1a2feebeea1377beec0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "963538f3a7b43e65e7804ea7208b44dda6744f64", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/963538f3a7b43e65e7804ea7208b44dda6744f64", "committedDate": "2020-06-19T22:52:18Z", "message": "Move classes that depend on DSv2 in Spark 2.x to spark2."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b3d4b188e7dcf726d56b47b9a583f7373175880", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/4b3d4b188e7dcf726d56b47b9a583f7373175880", "committedDate": "2020-06-19T23:14:30Z", "message": "Move tests that depend on the Iceberg source."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ea0c9a124718a97895fcc1a2feebeea1377beec0", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/ea0c9a124718a97895fcc1a2feebeea1377beec0", "committedDate": "2020-06-17T23:47:18Z", "message": "Move classes that depend on DSv2 in Spark 2.x to spark2."}, "afterCommit": {"oid": "4b3d4b188e7dcf726d56b47b9a583f7373175880", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/4b3d4b188e7dcf726d56b47b9a583f7373175880", "committedDate": "2020-06-19T23:14:30Z", "message": "Move tests that depend on the Iceberg source."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fd43cf8bc7a4fd5a8baac9edc2687edf0a4129f", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/1fd43cf8bc7a4fd5a8baac9edc2687edf0a4129f", "committedDate": "2020-06-19T23:36:34Z", "message": "Fix checkstyle issues, undo accidental move."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c677fee8cf8b5bc8e4f4937ede6d7bb24b3be85e", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/c677fee8cf8b5bc8e4f4937ede6d7bb24b3be85e", "committedDate": "2020-06-20T00:36:09Z", "message": "Bump test memory for spark2."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4530, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}