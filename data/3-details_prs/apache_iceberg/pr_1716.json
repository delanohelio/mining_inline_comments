{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MTEwNDY3", "number": 1716, "title": "Read all row group metadata only when position column is projected", "bodyText": "This is used to avoid reading all row group metadata if the position metadata column is not projected.", "createdAt": "2020-11-04T03:28:32Z", "url": "https://github.com/apache/iceberg/pull/1716", "merged": true, "mergeCommit": {"oid": "a132372d59d212f45c6cfe532c271fcb5a1878a7"}, "closed": true, "closedAt": "2020-11-07T22:46:29Z", "author": {"login": "chenjunjiedada"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZFFyFgH2gAyNTE1MTEwNDY3OmYwZmFhNjEzYWU0YTZmYmMwOGI5ZWQ5MDFmODhhMmVmODVmZmQwNzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ_3MjgH2gAyNTE1MTEwNDY3OjU1YmIxODQyMjIzMjRmYTMzZmFlNDM1NDc3ODgzZGM5M2U3NGVhYTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f0faa613ae4a6fbc08b9ed901f88a2ef85ffd079", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/f0faa613ae4a6fbc08b9ed901f88a2ef85ffd079", "committedDate": "2020-11-04T03:21:11Z", "message": "Read all row group metadata only when position column is projected"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMDIxNzIz", "url": "https://github.com/apache/iceberg/pull/1716#pullrequestreview-523021723", "createdAt": "2020-11-04T03:30:45Z", "commit": {"oid": "f0faa613ae4a6fbc08b9ed901f88a2ef85ffd079"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMzozMDo0NVrOHtH_UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMzozMDo0NVrOHtH_UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA3ODg2NA==", "bodyText": "The rowPosition will be ignored if the position column is not projected.", "url": "https://github.com/apache/iceberg/pull/1716#discussion_r517078864", "createdAt": "2020-11-04T03:30:45Z", "author": {"login": "chenjunjiedada"}, "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetReader.java", "diffHunk": "@@ -135,11 +135,9 @@ private void advance() {\n         throw new RuntimeIOException(e);\n       }\n \n-      long rowPosition = rowGroupsStartRowPos[nextRowGroup];\n+      model.setPageSource(pages, rowGroupsStartRowPos == null ? 0 : rowGroupsStartRowPos[nextRowGroup]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0faa613ae4a6fbc08b9ed901f88a2ef85ffd079"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MzkzNjI1", "url": "https://github.com/apache/iceberg/pull/1716#pullrequestreview-525393625", "createdAt": "2020-11-06T18:25:58Z", "commit": {"oid": "f0faa613ae4a6fbc08b9ed901f88a2ef85ffd079"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxODoyNTo1OFrOHu43hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxODoyNTo1OFrOHu43hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyODI2Mg==", "bodyText": "I think this should use offsetToStartPos.getOrDefault(0L).", "url": "https://github.com/apache/iceberg/pull/1716#discussion_r518928262", "createdAt": "2020-11-06T18:25:58Z", "author": {"login": "rdblue"}, "path": "parquet/src/main/java/org/apache/iceberg/parquet/ReadConf.java", "diffHunk": "@@ -102,7 +107,9 @@\n     long computedTotalValues = 0L;\n     for (int i = 0; i < shouldSkip.length; i += 1) {\n       BlockMetaData rowGroup = rowGroups.get(i);\n-      startRowPositions[i] = offsetToStartPos.get(rowGroup.getStartingPos());\n+      if (offsetToStartPos != null) {\n+        startRowPositions[i] = offsetToStartPos.get(rowGroup.getStartingPos());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0faa613ae4a6fbc08b9ed901f88a2ef85ffd079"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1Mzk0NjU4", "url": "https://github.com/apache/iceberg/pull/1716#pullrequestreview-525394658", "createdAt": "2020-11-06T18:27:35Z", "commit": {"oid": "f0faa613ae4a6fbc08b9ed901f88a2ef85ffd079"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxODoyNzozNVrOHu46wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxODoyNzozNVrOHu46wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyOTA4OQ==", "bodyText": "I think this should be defined for all cases so that ParquetReader doesn't need to check whether it is defined. In that case, it should still be a final variable.\nThe only change for this PR should be whether offsetToStartPos is an empty map or the result of generateOffsetToStartPos(). We may also want to do the ROW_POSITION check in that method instead of here, depending on what is cleaner.", "url": "https://github.com/apache/iceberg/pull/1716#discussion_r518929089", "createdAt": "2020-11-06T18:27:35Z", "author": {"login": "rdblue"}, "path": "parquet/src/main/java/org/apache/iceberg/parquet/ReadConf.java", "diffHunk": "@@ -89,8 +91,11 @@\n     this.shouldSkip = new boolean[rowGroups.size()];\n \n     // Fetch all row groups starting positions to compute the row offsets of the filtered row groups\n-    Map<Long, Long> offsetToStartPos = generateOffsetToStartPos();\n-    this.startRowPositions = new long[rowGroups.size()];\n+    Map<Long, Long> offsetToStartPos = null;\n+    if (expectedSchema.findField(MetadataColumns.ROW_POSITION.fieldId()) != null) {\n+      offsetToStartPos = generateOffsetToStartPos();\n+      this.startRowPositions = new long[rowGroups.size()];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0faa613ae4a6fbc08b9ed901f88a2ef85ffd079"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55bb184222324fa33fae435477883dc93e74eaa3", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/55bb184222324fa33fae435477883dc93e74eaa3", "committedDate": "2020-11-06T23:49:39Z", "message": "address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3675, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}