{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2NDUxMzgy", "number": 1459, "title": "Use gitattributes file to detect archive list automatically and simplify release script", "bodyText": "This PR replaces #1227, as @rdblue and I spent quite some time on it yesterday trying to get it to work and it wound up becoming one of those somewhat overly complex shell scripts (mostly due to my suggestions).\nAs it turns out, git already has a feature to explicitly ignore certain files, directories, and the contents of those directories from the git archive process. This can be achieved via the .gitattributes file and the export-ignore label.\nIn order to achieve the same behavior of git ls-tree --name-only -r HEAD, which Ryan suggested as an alternative to automatically keeping the archives \"includes\" up to date, I've gone ahead and used HEAD as the tag that is passed to the git archive script. It still uses the release_hash, but it then no longer requires us to explicitly include anything (or to rely on possibly non-portable shell scripts that use a combination of several commands in a row to generate the list of things to include). Especially given that the script makes a commit prior to tagging the release, it seemed to make sense to use HEAD.\nI have tested this in my local fork and I can confirm that, once merging in the .gitattributes file, the resulting tarball does not hav any of the ignored files or top-level directories or their contents. Additionally, subdirectories that share the same name as top level directories we want to ignore are not ignored, which is the behavior we want. The examples I found were the build subdirectories from some of the spark modules that are needed for running tests and therefore need to be included in the release).\nThis PR should be merged in after #1457. This PR will close this issue #1458 and subsumes the original PR, #1227, as that PR dates back quite some time and this solution deviates pretty heavily from the original solution proposed Thanks to @waterlx for bringing this issue to our attention and working on the first patch.\nHowever, this patch has deviated quite a lot from that one, and I think it's arguable preferable given that it uses a standard tool built into git (the .gitattributes flle) to handle what we were attempting to do ourselves with a large amount of shell based munging.", "createdAt": "2020-09-14T08:49:49Z", "url": "https://github.com/apache/iceberg/pull/1459", "merged": true, "mergeCommit": {"oid": "4660f6bb7437aad1d8e684481709a153b5e94800"}, "closed": true, "closedAt": "2020-09-15T00:46:05Z", "author": {"login": "kbendick"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdIujTCgH2gAyNDg2NDUxMzgyOmYzOWRlZjVlOWU5MDNhYzEzZWFkZTdmZGQ5NDE3YmNiMTQ2Y2I5MzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdIvU_tAFqTQ4NzU1MjUzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f39def5e9e903ac13eade7fdd9417bcb146cb931", "author": {"user": {"login": "kbendick", "name": "Kyle Bendickson"}}, "url": "https://github.com/apache/iceberg/commit/f39def5e9e903ac13eade7fdd9417bcb146cb931", "committedDate": "2020-09-14T08:02:49Z", "message": "Add in a gitattributes file for simplifying excluding things from releases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7dcc95d4edae880dfccda4779050e8e084227e3", "author": {"user": {"login": "kbendick", "name": "Kyle Bendickson"}}, "url": "https://github.com/apache/iceberg/commit/d7dcc95d4edae880dfccda4779050e8e084227e3", "committedDate": "2020-09-14T08:35:29Z", "message": "Update the release script to use the gitattributes file for excludes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd7fb16419ca89e82c29c4c6161dcf32d8e31748", "author": {"user": {"login": "kbendick", "name": "Kyle Bendickson"}}, "url": "https://github.com/apache/iceberg/commit/fd7fb16419ca89e82c29c4c6161dcf32d8e31748", "committedDate": "2020-09-14T08:38:18Z", "message": "Use head with the release hash, as the script places HEAD as the current release"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NTQ3NTYx", "url": "https://github.com/apache/iceberg/pull/1459#pullrequestreview-487547561", "createdAt": "2020-09-14T08:51:06Z", "commit": {"oid": "fd7fb16419ca89e82c29c4c6161dcf32d8e31748"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwODo1MTowNlrOHRKEDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwODo1MTowNlrOHRKEDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc1MjcxOQ==", "bodyText": "This file will be merged in from #1457 (which should be merged in before this one) and then will not appear in this PR.", "url": "https://github.com/apache/iceberg/pull/1459#discussion_r487752719", "createdAt": "2020-09-14T08:51:06Z", "author": {"login": "kbendick"}, "path": ".gitattributes", "diffHunk": "@@ -0,0 +1,35 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+# \n+#   http://www.apache.org/licenses/LICENSE-2.0\n+# \n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+#\n+\n+# Files marked as export-ignore will be ignored from the release's\n+# built via `git archive`. This simplifies the release script and \n+# uses an industry standard as opposed to possibly hard to read\n+# shell scripts with many flags. Unfortunately, directories themselves\n+# won't recursively ignore, so we need the top level directories\n+# as well as their files.\n+/build         export-ignore\n+/build/**      export-ignore\n+/examples      export-ignore\n+/examples/**   export-ignore\n+jitpack.yml    export-ignore\n+/python        export-ignore\n+/python/**     export-ignore\n+/site          export-ignore\n+/site/**       export-ignore\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd7fb16419ca89e82c29c4c6161dcf32d8e31748"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NTQ4NTkz", "url": "https://github.com/apache/iceberg/pull/1459#pullrequestreview-487548593", "createdAt": "2020-09-14T08:52:18Z", "commit": {"oid": "fd7fb16419ca89e82c29c4c6161dcf32d8e31748"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwODo1MjoxOVrOHRKHPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwODo1MjoxOVrOHRKHPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc1MzUzNQ==", "bodyText": "I added version-num, as when running the release script, I occasionally found myself passing in ./dev/source-release.sh apache-iceberg-0.10.1 rc2. In the future, we might consider opening an issue to detect whether or not the passed in $1 and $2 are valid floats, but that's beyond the scope of this PR.", "url": "https://github.com/apache/iceberg/pull/1459#discussion_r487753535", "createdAt": "2020-09-14T08:52:19Z", "author": {"login": "kbendick"}, "path": "dev/source-release.sh", "diffHunk": "@@ -21,12 +21,12 @@\n set -e\n \n if [ -z \"$1\" ]; then\n-  echo \"Usage: $0 <version> <rc-num>\"\n+  echo \"Usage: $0 <version-num> <rc-num>\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd7fb16419ca89e82c29c4c6161dcf32d8e31748"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NTUxMDY3", "url": "https://github.com/apache/iceberg/pull/1459#pullrequestreview-487551067", "createdAt": "2020-09-14T08:55:17Z", "commit": {"oid": "fd7fb16419ca89e82c29c4c6161dcf32d8e31748"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwODo1NToxN1rOHRKOqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwODo1NToxN1rOHRKOqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc1NTQzMw==", "bodyText": "I don't think that this comment is really necessary now. We are using a release hash still, but we're also using HEAD. However, the results are correct and this isn't any different than the proposed working solution of using git ls-tree --name-only -r HEAD.\nPlease let me know if the above comment can be removed, as to me it no longer makes sense. We also have less need to be conservative as we're using HEAD, and the script even issues and pushes a commit with the version.txt file, so HEAD is absolutely the correct place to be working from in this case.", "url": "https://github.com/apache/iceberg/pull/1459#discussion_r487755433", "createdAt": "2020-09-14T08:55:17Z", "author": {"login": "kbendick"}, "path": "dev/source-release.sh", "diffHunk": "@@ -66,7 +66,7 @@ tarball=$tag.tar.gz\n \n # be conservative and use the release hash, even though git produces the same\n # archive (identical hashes) using the scm tag", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd7fb16419ca89e82c29c4c6161dcf32d8e31748"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NTUyNTMz", "url": "https://github.com/apache/iceberg/pull/1459#pullrequestreview-487552533", "createdAt": "2020-09-14T08:57:05Z", "commit": {"oid": "fd7fb16419ca89e82c29c4c6161dcf32d8e31748"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwODo1NzowNVrOHRKTGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwODo1NzowNVrOHRKTGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc1NjU3MQ==", "bodyText": "The --worktree-attributes is what tells git archive to check (all of) the .gitattribute files. We're keeping it simple and using one top level one, as it suit our needs.\nI tested this and the resulting tarball had none of the files we expected to be ignored in its contents and had all of the files we expected to be there (when comparing the output sorted list from the current script to this script via the uniq shell command.", "url": "https://github.com/apache/iceberg/pull/1459#discussion_r487756571", "createdAt": "2020-09-14T08:57:05Z", "author": {"login": "kbendick"}, "path": "dev/source-release.sh", "diffHunk": "@@ -66,7 +66,7 @@ tarball=$tag.tar.gz\n \n # be conservative and use the release hash, even though git produces the same\n # archive (identical hashes) using the scm tag\n-git archive $release_hash --prefix $tag/ -o $tarball .baseline api arrow bundled-guava common core data dev flink gradle gradlew hive mr orc parquet pig spark spark2 spark-runtime spark3 spark3-runtime LICENSE NOTICE README.md build.gradle baseline.gradle deploy.gradle tasks.gradle jmh.gradle gradle.properties settings.gradle versions.lock versions.props version.txt\n+git archive $release_hash --worktree-attributes --prefix $tag/ -o $tarball HEAD", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd7fb16419ca89e82c29c4c6161dcf32d8e31748"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4207, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}