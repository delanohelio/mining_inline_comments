{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3NjY1NDcz", "number": 1339, "title": "ORC: Use MetricsConfig", "bodyText": "Unlike Parquet metrics, ORC was not using MetricsConfig to let the user configure which metrics to collect or truncate string column metrics.\nThis PR fixes #1268 by adding MetricsConfig support in ORC metrics. I've also added unit tests to TestMetrics, which runs for both Parquet and ORC, to check the different MetricsModes and the truncation of string and binary (not supported in ORC) columns.\nPTAL @aokolnychyi @rdsr @shardulm94 Thanks!", "createdAt": "2020-08-13T22:33:30Z", "url": "https://github.com/apache/iceberg/pull/1339", "merged": true, "mergeCommit": {"oid": "6e2692c02bc79e1cfc40d03a9703776d9e92d2a0"}, "closed": true, "closedAt": "2020-08-25T00:36:32Z", "author": {"login": "edgarRd"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_4kWfABqjM2NjM1Mjc1MzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCLcPQgFqTQ3NDAwMDEwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1b81dde4101f2166fe731c138e2194956f41e35", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/d1b81dde4101f2166fe731c138e2194956f41e35", "committedDate": "2020-08-13T21:53:36Z", "message": "Add unit tests for MetricsConfig usage in Metrics"}, "afterCommit": {"oid": "690127cf535b05b34f2d47fa352fb51d3df62f86", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/690127cf535b05b34f2d47fa352fb51d3df62f86", "committedDate": "2020-08-17T20:37:33Z", "message": "Add unit tests for MetricsConfig usage in Metrics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMjAyMjM3", "url": "https://github.com/apache/iceberg/pull/1339#pullrequestreview-470202237", "createdAt": "2020-08-19T07:42:08Z", "commit": {"oid": "690127cf535b05b34f2d47fa352fb51d3df62f86"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNzo0MjowOFrOHC6YBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODowNDozNlrOHC7l8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjgxNTYyMw==", "bodyText": "Got confused for a second, I think what the comment wants to say is that out of the two types which require truncation (string/binary) ORC only supports string bounds. Can we rephrase the comment?", "url": "https://github.com/apache/iceberg/pull/1339#discussion_r472815623", "createdAt": "2020-08-19T07:42:08Z", "author": {"login": "shardulm94"}, "path": "orc/src/main/java/org/apache/iceberg/orc/OrcMetrics.java", "diffHunk": "@@ -203,7 +227,29 @@ private static Metrics buildOrcMetrics(final long numOfRows, final TypeDescripti\n       BooleanColumnStatistics booleanStats = (BooleanColumnStatistics) columnStats;\n       max = booleanStats.getTrueCount() > 0;\n     }\n-    return Optional.ofNullable(Conversions.toByteBuffer(column.type(), max));\n+    return Optional.ofNullable(Conversions.toByteBuffer(type, truncateIfNeeded(Bound.UPPER, type, max, metricsMode)));\n+  }\n+\n+  private static Object truncateIfNeeded(Bound bound, Type type, Object value, MetricsMode metricsMode) {\n+    // ORC only stores min/max for String columns", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "690127cf535b05b34f2d47fa352fb51d3df62f86"}, "originalPosition": 188}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjgzNTU2OA==", "bodyText": "Might be better to check if the Metrics mode != Truncate, seems easier to read that way. Also we have a Precondition later to assert the same, which may be unnecessary if we make the check here.", "url": "https://github.com/apache/iceberg/pull/1339#discussion_r472835568", "createdAt": "2020-08-19T08:04:36Z", "author": {"login": "shardulm94"}, "path": "orc/src/main/java/org/apache/iceberg/orc/OrcMetrics.java", "diffHunk": "@@ -203,7 +227,29 @@ private static Metrics buildOrcMetrics(final long numOfRows, final TypeDescripti\n       BooleanColumnStatistics booleanStats = (BooleanColumnStatistics) columnStats;\n       max = booleanStats.getTrueCount() > 0;\n     }\n-    return Optional.ofNullable(Conversions.toByteBuffer(column.type(), max));\n+    return Optional.ofNullable(Conversions.toByteBuffer(type, truncateIfNeeded(Bound.UPPER, type, max, metricsMode)));\n+  }\n+\n+  private static Object truncateIfNeeded(Bound bound, Type type, Object value, MetricsMode metricsMode) {\n+    // ORC only stores min/max for String columns\n+    if (value == null || metricsMode == MetricsModes.Full.get() || type.typeId() != Type.TypeID.STRING) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "690127cf535b05b34f2d47fa352fb51d3df62f86"}, "originalPosition": 189}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9aceada4f8e0fa9c0a0d9c2e02b5c91e9a58eed3", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/9aceada4f8e0fa9c0a0d9c2e02b5c91e9a58eed3", "committedDate": "2020-08-20T00:09:53Z", "message": "ORC: use MetricsConfig for ORC metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf662a4f1449bf7c10e0ffbb0456094b38fde9bb", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/bf662a4f1449bf7c10e0ffbb0456094b38fde9bb", "committedDate": "2020-08-20T00:09:59Z", "message": "Add unit tests for MetricsConfig usage in Metrics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "690127cf535b05b34f2d47fa352fb51d3df62f86", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/690127cf535b05b34f2d47fa352fb51d3df62f86", "committedDate": "2020-08-17T20:37:33Z", "message": "Add unit tests for MetricsConfig usage in Metrics"}, "afterCommit": {"oid": "d43ee8b90289b36cc2fed428f94f804acf66b88c", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/d43ee8b90289b36cc2fed428f94f804acf66b88c", "committedDate": "2020-08-20T01:02:33Z", "message": "PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb116fbee9a685158e677f41a4a51c23e6482a3c", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/eb116fbee9a685158e677f41a4a51c23e6482a3c", "committedDate": "2020-08-20T17:08:34Z", "message": "PR comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d43ee8b90289b36cc2fed428f94f804acf66b88c", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/d43ee8b90289b36cc2fed428f94f804acf66b88c", "committedDate": "2020-08-20T01:02:33Z", "message": "PR comments"}, "afterCommit": {"oid": "eb116fbee9a685158e677f41a4a51c23e6482a3c", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/eb116fbee9a685158e677f41a4a51c23e6482a3c", "committedDate": "2020-08-20T17:08:34Z", "message": "PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MDAwMTAz", "url": "https://github.com/apache/iceberg/pull/1339#pullrequestreview-474000103", "createdAt": "2020-08-24T23:44:53Z", "commit": {"oid": "eb116fbee9a685158e677f41a4a51c23e6482a3c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4044, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}