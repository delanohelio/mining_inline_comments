{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1Mzg1NTMx", "number": 1080, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwMDozNDozNVrOEBEnGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNjoyMTo0OFrOEB0oEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NTU5NTc5OnYy", "diffSide": "LEFT", "path": "core/src/main/java/org/apache/iceberg/FileHistory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwMDozNDozNVrOGcvhFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwMDozNDozNVrOGcvhFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5MTgzMA==", "bodyText": "This is no longer needed. It was used to find all manifest entries for a file to help debug changes. Now that can be handled in parallel by the all_entries metadata table.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r432791830", "createdAt": "2020-05-30T00:34:35Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/FileHistory.java", "diffHunk": "@@ -1,119 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.apache.iceberg;\n-\n-import java.io.IOException;\n-import java.util.List;\n-import java.util.Set;\n-import org.apache.iceberg.exceptions.RuntimeIOException;\n-import org.apache.iceberg.expressions.Literal;\n-import org.apache.iceberg.io.CloseableIterable;\n-import org.apache.iceberg.relocated.com.google.common.collect.ImmutableList;\n-import org.apache.iceberg.relocated.com.google.common.collect.Iterables;\n-import org.apache.iceberg.relocated.com.google.common.collect.Lists;\n-import org.apache.iceberg.relocated.com.google.common.collect.Sets;\n-import org.apache.iceberg.types.Types;\n-import org.apache.iceberg.util.CharSequenceWrapper;\n-\n-public class FileHistory {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "411bd27253cd707a1e92f2e58c382dd9558dadde"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NTU5ODE0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/FindFiles.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwMDozNjo0N1rOGcviRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwMDozNjo0N1rOGcviRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5MjEzNA==", "bodyText": "The contract for this class is to return matching data files, not splits. We use it in some cases to avoid newScan that will return either FileScanTask or CombinedScanTask and will emit a scan event. I think we may be able to remove it, or update it to return both data and delete files. For now, this uses dataManifests to mimic the current behavior.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r432792134", "createdAt": "2020-05-30T00:36:47Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/FindFiles.java", "diffHunk": "@@ -197,7 +197,7 @@ public Builder inPartitions(PartitionSpec spec, List<StructLike> partitions) {\n       }\n \n       // when snapshot is not null\n-      CloseableIterable<ManifestEntry<DataFile>> entries = new ManifestGroup(ops.io(), snapshot.manifests())\n+      CloseableIterable<ManifestEntry<DataFile>> entries = new ManifestGroup(ops.io(), snapshot.dataManifests())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "411bd27253cd707a1e92f2e58c382dd9558dadde"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NTU5ODUzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/IncrementalDataTableScan.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwMDozNzoxM1rOGcvifg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwMDozNzoxM1rOGcvifg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5MjE5MA==", "bodyText": "For now, scans continue to ignore delete manifests and delete files.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r432792190", "createdAt": "2020-05-30T00:37:13Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/IncrementalDataTableScan.java", "diffHunk": "@@ -84,7 +84,7 @@ public TableScan appendsAfter(long newFromSnapshotId) {\n     Set<Long> snapshotIds = Sets.newHashSet(Iterables.transform(snapshots, Snapshot::snapshotId));\n     Set<ManifestFile> manifests = FluentIterable\n         .from(snapshots)\n-        .transformAndConcat(s -> s.manifests())\n+        .transformAndConcat(s -> s.dataManifests())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "411bd27253cd707a1e92f2e58c382dd9558dadde"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NTU5OTg4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwMDozODoxN1rOGcvjLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzozNDoyNVrOGd8fQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5MjM2Ng==", "bodyText": "Carry forward delete manifests, if present.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r432792366", "createdAt": "2020-05-30T00:38:17Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java", "diffHunk": "@@ -297,6 +297,9 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n       Set<CharSequenceWrapper> deletedFiles = deletedFiles(unmergedManifests);\n \n       List<ManifestFile> manifests = Lists.newArrayList();\n+      if (current != null) {\n+        manifests.addAll(current.deleteManifests());\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "411bd27253cd707a1e92f2e58c382dd9558dadde"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA1MjkzMA==", "bodyText": "Moved to the end of the manifest list.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434052930", "createdAt": "2020-06-02T17:34:25Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java", "diffHunk": "@@ -297,6 +297,9 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n       Set<CharSequenceWrapper> deletedFiles = deletedFiles(unmergedManifests);\n \n       List<ManifestFile> manifests = Lists.newArrayList();\n+      if (current != null) {\n+        manifests.addAll(current.deleteManifests());\n+      }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5MjM2Ng=="}, "originalCommit": {"oid": "411bd27253cd707a1e92f2e58c382dd9558dadde"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMTg5MzI3OnYy", "diffSide": "RIGHT", "path": "core/src/test/java/org/apache/iceberg/TableTestBase.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwOTo0NDo0NlrOGdqLrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzozNzowN1rOGd8lSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1MzAwNg==", "bodyText": "This and two other tests use dataManifests() where all other tests have been changed to allManifests(). Is this intentional?\nOther tests:\nTestRemoveSnapshots\nRewriteManifestsAction", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r433753006", "createdAt": "2020-06-02T09:44:46Z", "author": {"login": "rymurr"}, "path": "core/src/test/java/org/apache/iceberg/TableTestBase.java", "diffHunk": "@@ -224,10 +224,10 @@ void validateSnapshot(Snapshot old, Snapshot snap, long sequenceNumber, DataFile\n   }\n \n   void validateSnapshot(Snapshot old, Snapshot snap, Long sequenceNumber, DataFile... newFiles) {\n-    List<ManifestFile> oldManifests = old != null ? old.manifests() : ImmutableList.of();\n+    List<ManifestFile> oldManifests = old != null ? old.dataManifests() : ImmutableList.of();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMDYzOQ==", "bodyText": "My reasoning was that the signature of this method is DataFile... newFiles, so callers can't pass DeleteFile. But, I could add an assertion that deleteManifests() is empty.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434000639", "createdAt": "2020-06-02T16:09:49Z", "author": {"login": "rdblue"}, "path": "core/src/test/java/org/apache/iceberg/TableTestBase.java", "diffHunk": "@@ -224,10 +224,10 @@ void validateSnapshot(Snapshot old, Snapshot snap, long sequenceNumber, DataFile\n   }\n \n   void validateSnapshot(Snapshot old, Snapshot snap, Long sequenceNumber, DataFile... newFiles) {\n-    List<ManifestFile> oldManifests = old != null ? old.manifests() : ImmutableList.of();\n+    List<ManifestFile> oldManifests = old != null ? old.dataManifests() : ImmutableList.of();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1MzAwNg=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMTI1OQ==", "bodyText": "I think adding an assertion is a good idea. Will it keep it safe for future use.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434011259", "createdAt": "2020-06-02T16:26:23Z", "author": {"login": "aokolnychyi"}, "path": "core/src/test/java/org/apache/iceberg/TableTestBase.java", "diffHunk": "@@ -224,10 +224,10 @@ void validateSnapshot(Snapshot old, Snapshot snap, long sequenceNumber, DataFile\n   }\n \n   void validateSnapshot(Snapshot old, Snapshot snap, Long sequenceNumber, DataFile... newFiles) {\n-    List<ManifestFile> oldManifests = old != null ? old.manifests() : ImmutableList.of();\n+    List<ManifestFile> oldManifests = old != null ? old.dataManifests() : ImmutableList.of();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1MzAwNg=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA1NDQ3NA==", "bodyText": "Adding an assertion that the set of delete manifests has not changed from old to new.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434054474", "createdAt": "2020-06-02T17:37:07Z", "author": {"login": "rdblue"}, "path": "core/src/test/java/org/apache/iceberg/TableTestBase.java", "diffHunk": "@@ -224,10 +224,10 @@ void validateSnapshot(Snapshot old, Snapshot snap, long sequenceNumber, DataFile\n   }\n \n   void validateSnapshot(Snapshot old, Snapshot snap, Long sequenceNumber, DataFile... newFiles) {\n-    List<ManifestFile> oldManifests = old != null ? old.manifests() : ImmutableList.of();\n+    List<ManifestFile> oldManifests = old != null ? old.dataManifests() : ImmutableList.of();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1MzAwNg=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMTkwOTA3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/ScanSummary.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwOTo0OToyM1rOGdqV-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNjoxMTozMlrOGd5Xiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1NTY0Mw==", "bodyText": "Is this explicitly ignoring the effect of deleted rows on partition metrics or is it just that you are short circuiting any delete files (as we can't use them anyways)", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r433755643", "createdAt": "2020-06-02T09:49:23Z", "author": {"login": "rymurr"}, "path": "core/src/main/java/org/apache/iceberg/ScanSummary.java", "diffHunk": "@@ -159,7 +159,7 @@ private void removeTimeFilters(List<Expression> expressions, Expression expressi\n       removeTimeFilters(filters, Expressions.rewriteNot(scan.filter()));\n       Expression rowFilter = joinFilters(filters);\n \n-      Iterable<ManifestFile> manifests = table.currentSnapshot().manifests();\n+      Iterable<ManifestFile> manifests = table.currentSnapshot().dataManifests();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMTgwMw==", "bodyText": "This whole class will need to be updated to support detecting changes in delete files, so I just did the minimum to update it safely. Since it uses ManifestFiles.read later instead of ManifestFiles.readDeletes, it made sense to only use data manifests. This is one that we should plan to update in a separate PR, if anyone is using it.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434001803", "createdAt": "2020-06-02T16:11:32Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/ScanSummary.java", "diffHunk": "@@ -159,7 +159,7 @@ private void removeTimeFilters(List<Expression> expressions, Expression expressi\n       removeTimeFilters(filters, Expressions.rewriteNot(scan.filter()));\n       Expression rowFilter = joinFilters(filters);\n \n-      Iterable<ManifestFile> manifests = table.currentSnapshot().manifests();\n+      Iterable<ManifestFile> manifests = table.currentSnapshot().dataManifests();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1NTY0Mw=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMTkyNjY5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/FastAppend.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwOTo1NDozNlrOGdqhcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzozMjoxMFrOGd8Zbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1ODU3OA==", "bodyText": "The addition of delete files in newManifests far above the addition of data files threw me a bit. Is it intentional to ensure the delete files are at the front of the list?", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r433758578", "createdAt": "2020-06-02T09:54:36Z", "author": {"login": "rymurr"}, "path": "core/src/main/java/org/apache/iceberg/FastAppend.java", "diffHunk": "@@ -122,6 +122,10 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n   public List<ManifestFile> apply(TableMetadata base) {\n     List<ManifestFile> newManifests = Lists.newArrayList();\n \n+    if (base.currentSnapshot() != null) {\n+      newManifests.addAll(base.currentSnapshot().deleteManifests());\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMjM5Ng==", "bodyText": "Yes, the idea is to keep delete manifests at the front of the list.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434002396", "createdAt": "2020-06-02T16:12:23Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/FastAppend.java", "diffHunk": "@@ -122,6 +122,10 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n   public List<ManifestFile> apply(TableMetadata base) {\n     List<ManifestFile> newManifests = Lists.newArrayList();\n \n+    if (base.currentSnapshot() != null) {\n+      newManifests.addAll(base.currentSnapshot().deleteManifests());\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1ODU3OA=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA1MTQzOA==", "bodyText": "Updated to move delete manifests to the end.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434051438", "createdAt": "2020-06-02T17:32:10Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/FastAppend.java", "diffHunk": "@@ -122,6 +122,10 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n   public List<ManifestFile> apply(TableMetadata base) {\n     List<ManifestFile> newManifests = Lists.newArrayList();\n \n+    if (base.currentSnapshot() != null) {\n+      newManifests.addAll(base.currentSnapshot().deleteManifests());\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1ODU3OA=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMTkzNjM1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/BaseRewriteManifests.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwOTo1NzoyM1rOGdqnkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzoyNToyOFrOGd8JLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDE0Ng==", "bodyText": "Here data manifests are (potentially) rewritten while keeping deletes the same. Again with deletes at the front. Do I understand correctly? The comment is a bit misleading as immediately below it old delete manifests are added to the list.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r433760146", "createdAt": "2020-06-02T09:57:23Z", "author": {"login": "rymurr"}, "path": "core/src/main/java/org/apache/iceberg/BaseRewriteManifests.java", "diffHunk": "@@ -174,13 +173,13 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n \n     validateFilesCounts();\n \n-    // TODO: add sequence numbers here\n     Iterable<ManifestFile> newManifestsWithMetadata = Iterables.transform(\n         Iterables.concat(newManifests, addedManifests, rewrittenAddedManifests),\n         manifest -> GenericManifestFile.copyOf(manifest).withSnapshotId(snapshotId()).build());\n \n     // put new manifests at the beginning\n-    List<ManifestFile> apply = new ArrayList<>();\n+    List<ManifestFile> apply = Lists.newArrayList();\n+    apply.addAll(base.currentSnapshot().deleteManifests());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNDU3OQ==", "bodyText": "We should probably update the comment to include delete handling. We put new manifests at the front of the list because those are the ones most likely to have data for a query when writes align with reads (recent hours are read more often than data that's months old).\nI guess we don't really need the delete manifests at the start of the list. We could put those at the end since they get split out into a separate list. The one that matters is scanning the recent manifests first when planning jobs to get data faster in engines like Presto that run the query and planning concurrently.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434004579", "createdAt": "2020-06-02T16:15:46Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseRewriteManifests.java", "diffHunk": "@@ -174,13 +173,13 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n \n     validateFilesCounts();\n \n-    // TODO: add sequence numbers here\n     Iterable<ManifestFile> newManifestsWithMetadata = Iterables.transform(\n         Iterables.concat(newManifests, addedManifests, rewrittenAddedManifests),\n         manifest -> GenericManifestFile.copyOf(manifest).withSnapshotId(snapshotId()).build());\n \n     // put new manifests at the beginning\n-    List<ManifestFile> apply = new ArrayList<>();\n+    List<ManifestFile> apply = Lists.newArrayList();\n+    apply.addAll(base.currentSnapshot().deleteManifests());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDE0Ng=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxNTIxMA==", "bodyText": "To me, putting delete manifests at the end would be more natural.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434015210", "createdAt": "2020-06-02T16:32:45Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/BaseRewriteManifests.java", "diffHunk": "@@ -174,13 +173,13 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n \n     validateFilesCounts();\n \n-    // TODO: add sequence numbers here\n     Iterable<ManifestFile> newManifestsWithMetadata = Iterables.transform(\n         Iterables.concat(newManifests, addedManifests, rewrittenAddedManifests),\n         manifest -> GenericManifestFile.copyOf(manifest).withSnapshotId(snapshotId()).build());\n \n     // put new manifests at the beginning\n-    List<ManifestFile> apply = new ArrayList<>();\n+    List<ManifestFile> apply = Lists.newArrayList();\n+    apply.addAll(base.currentSnapshot().deleteManifests());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDE0Ng=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA0NzI3OA==", "bodyText": "Moving manifests to the end.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434047278", "createdAt": "2020-06-02T17:25:28Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseRewriteManifests.java", "diffHunk": "@@ -174,13 +173,13 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n \n     validateFilesCounts();\n \n-    // TODO: add sequence numbers here\n     Iterable<ManifestFile> newManifestsWithMetadata = Iterables.transform(\n         Iterables.concat(newManifests, addedManifests, rewrittenAddedManifests),\n         manifest -> GenericManifestFile.copyOf(manifest).withSnapshotId(snapshotId()).build());\n \n     // put new manifests at the beginning\n-    List<ManifestFile> apply = new ArrayList<>();\n+    List<ManifestFile> apply = Lists.newArrayList();\n+    apply.addAll(base.currentSnapshot().deleteManifests());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDE0Ng=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMTkzODg2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/AllManifestsTable.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwOTo1ODowM1rOGdqpGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzoyNDoxN1rOGd8Ggw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDUzNg==", "bodyText": "I am not sure I understand the comment here or why dataManifests is used instead of allManifests", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r433760536", "createdAt": "2020-06-02T09:58:03Z", "author": {"login": "rymurr"}, "path": "core/src/main/java/org/apache/iceberg/AllManifestsTable.java", "diffHunk": "@@ -136,7 +136,7 @@ protected long targetSplitSize(TableOperations ops) {\n         } else {\n           return StaticDataTask.of(\n               ops.io().newInputFile(ops.current().file().location()),\n-              snap.manifests(),\n+              snap.dataManifests(), // if the manifest list is missing, the table must be v1 and has no delete manifests", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNTExOQ==", "bodyText": "Shouldn't this table return all manifests?", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434005119", "createdAt": "2020-06-02T16:16:38Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/AllManifestsTable.java", "diffHunk": "@@ -136,7 +136,7 @@ protected long targetSplitSize(TableOperations ops) {\n         } else {\n           return StaticDataTask.of(\n               ops.io().newInputFile(ops.current().file().location()),\n-              snap.manifests(),\n+              snap.dataManifests(), // if the manifest list is missing, the table must be v1 and has no delete manifests", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDUzNg=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNTU4MA==", "bodyText": "This else block is taken when manifests aren't kept in a file and are embedded in table metadata. That's not allowed in v2, so delete manifests and this code path will not happen at the same time.\nWe could be more explicit and use allManifests, so that this fails if a delete manifest is found. That's probably easier to understand and safer.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434005580", "createdAt": "2020-06-02T16:17:21Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/AllManifestsTable.java", "diffHunk": "@@ -136,7 +136,7 @@ protected long targetSplitSize(TableOperations ops) {\n         } else {\n           return StaticDataTask.of(\n               ops.io().newInputFile(ops.current().file().location()),\n-              snap.manifests(),\n+              snap.dataManifests(), // if the manifest list is missing, the table must be v1 and has no delete manifests", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDUzNg=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA0NjU5NQ==", "bodyText": "Updated to use allManifests.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434046595", "createdAt": "2020-06-02T17:24:17Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/AllManifestsTable.java", "diffHunk": "@@ -136,7 +136,7 @@ protected long targetSplitSize(TableOperations ops) {\n         } else {\n           return StaticDataTask.of(\n               ops.io().newInputFile(ops.current().file().location()),\n-              snap.manifests(),\n+              snap.dataManifests(), // if the manifest list is missing, the table must be v1 and has no delete manifests", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc2MDUzNg=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMzMzNTYwOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/apache/iceberg/Snapshot.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNTo1NTowOVrOGd4gnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNjoyMDoxOFrOGd5t5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4Nzc0MQ==", "bodyText": "This seem like a breaking change to the public API. Technically, the old description already assumed a list of all manifests. Do we think it is better to change it now to avoid confusion and misuse?", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r433987741", "createdAt": "2020-06-02T15:55:09Z", "author": {"login": "aokolnychyi"}, "path": "api/src/main/java/org/apache/iceberg/Snapshot.java", "diffHunk": "@@ -64,13 +64,25 @@\n   long timestampMillis();\n \n   /**\n-   * Return the location of all manifests in this snapshot.\n-   * <p>\n-   * The current table is made of the union of the data files in these manifests.\n+   * Return all {@link ManifestFile} instances for either data or delete manifests in this snapshot.\n+   *\n+   * @return a list of ManifestFile\n+   */\n+  List<ManifestFile> allManifests();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNzUyNQ==", "bodyText": "The question is where we want to make the breaking changes. The format can't be read correctly without support for deletes, so to support v2 we will be making some breaking changes. If we do it with API changes then clients will need to update.\nIf we just return manifest files for deletes through the old manifests method, then older clients will appear to work until they encounter a delete manifest.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434007525", "createdAt": "2020-06-02T16:20:18Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/Snapshot.java", "diffHunk": "@@ -64,13 +64,25 @@\n   long timestampMillis();\n \n   /**\n-   * Return the location of all manifests in this snapshot.\n-   * <p>\n-   * The current table is made of the union of the data files in these manifests.\n+   * Return all {@link ManifestFile} instances for either data or delete manifests in this snapshot.\n+   *\n+   * @return a list of ManifestFile\n+   */\n+  List<ManifestFile> allManifests();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4Nzc0MQ=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMzQ1MTY2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/BaseSnapshot.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNjoxOTowMFrOGd5qjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNjoyMDo1N1rOGd5vsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNjY3MQ==", "bodyText": "The list of manifests can contain 1-2k entries, will iterating through that list twice here have an impact on performance?", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434006671", "createdAt": "2020-06-02T16:19:00Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/BaseSnapshot.java", "diffHunk": "@@ -120,14 +122,42 @@ public String operation() {\n     return summary;\n   }\n \n-  @Override\n-  public List<ManifestFile> manifests() {\n-    if (manifests == null) {\n+  private void cacheManifests() {\n+    if (allManifests == null) {\n       // if manifests isn't set, then the snapshotFile is set and should be read to get the list\n-      this.manifests = ManifestLists.read(manifestList);\n+      this.allManifests = ManifestLists.read(manifestList);\n+    }\n+\n+    if (dataManifests == null) {\n+      this.dataManifests = ImmutableList.copyOf(Iterables.filter(allManifests,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNzk4Nw==", "bodyText": "No, this would be pretty quick.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434007987", "createdAt": "2020-06-02T16:20:57Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseSnapshot.java", "diffHunk": "@@ -120,14 +122,42 @@ public String operation() {\n     return summary;\n   }\n \n-  @Override\n-  public List<ManifestFile> manifests() {\n-    if (manifests == null) {\n+  private void cacheManifests() {\n+    if (allManifests == null) {\n       // if manifests isn't set, then the snapshotFile is set and should be read to get the list\n-      this.manifests = ManifestLists.read(manifestList);\n+      this.allManifests = ManifestLists.read(manifestList);\n+    }\n+\n+    if (dataManifests == null) {\n+      this.dataManifests = ImmutableList.copyOf(Iterables.filter(allManifests,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNjY3MQ=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMzQ2MjU5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/BaseSnapshot.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNjoyMTo0OFrOGd5xug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxOTozODo1NVrOGeBR6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwODUwNg==", "bodyText": "Do we have to reason about thread safety like we do in PartitionSpec, for example?", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434008506", "createdAt": "2020-06-02T16:21:48Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/BaseSnapshot.java", "diffHunk": "@@ -120,14 +122,42 @@ public String operation() {\n     return summary;\n   }\n \n-  @Override\n-  public List<ManifestFile> manifests() {\n-    if (manifests == null) {\n+  private void cacheManifests() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA1MTEyMA==", "bodyText": "No. The main problem in #219 was that the lazy value was set before it was completely initialized. Here, allManifests is set to a list that will not change.\nIn that PR, we also added double checking and a lock to prevent two threads from building the same value. We could do that here as well, but it doesn't affect correctness. There is just a race condition to produce the same sets of manifests.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434051120", "createdAt": "2020-06-02T17:31:41Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseSnapshot.java", "diffHunk": "@@ -120,14 +122,42 @@ public String operation() {\n     return summary;\n   }\n \n-  @Override\n-  public List<ManifestFile> manifests() {\n-    if (manifests == null) {\n+  private void cacheManifests() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwODUwNg=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEzMTQzNQ==", "bodyText": "I think it would make sense to prevent the race condition later on. I'll submit a PR.", "url": "https://github.com/apache/iceberg/pull/1080#discussion_r434131435", "createdAt": "2020-06-02T19:38:55Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/BaseSnapshot.java", "diffHunk": "@@ -120,14 +122,42 @@ public String operation() {\n     return summary;\n   }\n \n-  @Override\n-  public List<ManifestFile> manifests() {\n-    if (manifests == null) {\n+  private void cacheManifests() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwODUwNg=="}, "originalCommit": {"oid": "3b7f05c3a87c1bc4a5e31c4225a98cbacfd0c35b"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3867, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}