{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1ODc5NjIw", "number": 1321, "title": "Avro: Fix pruning columns when a logical-map array's value type is nested", "bodyText": "Added a unit test which fails without the change\n\nConsider type map(long, list<long>) (a logical-map array in Iceberg-Avro) and a full projection.\nIn GetProjectedIds::map, the key id and value id won't be added if the value type is nested.\n  public Set<Integer> map(Types.MapType map, Set<Integer> keyResult, Set<Integer> valueResult) {\n    if (valueResult == null) {\n      for (Types.NestedField field : map.fields()) {\n        fieldIds.add(field.fieldId());\n      }\n    }\n    return fieldIds;\n  }\nMissing the key id can pose a problem in PruneColumns::array, since the array's child record's key field will be omitted.", "createdAt": "2020-08-11T05:42:52Z", "url": "https://github.com/apache/iceberg/pull/1321", "merged": true, "mergeCommit": {"oid": "14ad4db0914763711a9e9dacd4a99a9bd53ff87c"}, "closed": true, "closedAt": "2020-08-14T20:22:55Z", "author": {"login": "lxynov"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9wLruABqjM2NDE1Mjc1NjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-5N4KABqjM2NTczMjQ4Mzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75033ef4d2e9865fdad18d73178a3fd22a2c8e8a", "author": {"user": {"login": "lxynov", "name": "Xingyuan Lin"}}, "url": "https://github.com/apache/iceberg/commit/75033ef4d2e9865fdad18d73178a3fd22a2c8e8a", "committedDate": "2020-08-11T05:21:29Z", "message": "Avro: Fix pruning columns when a logical-map array's value type is nested\n\nE.g., map(long, list<long>)"}, "afterCommit": {"oid": "66d42076801b26f2965959f8786938a2ee4121c4", "author": {"user": {"login": "lxynov", "name": "Xingyuan Lin"}}, "url": "https://github.com/apache/iceberg/commit/66d42076801b26f2965959f8786938a2ee4121c4", "committedDate": "2020-08-11T05:43:24Z", "message": "Avro: Fix pruning columns when a logical-map array's value type is nested\n\nE.g., map(long, list<long>)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NTc3Mzg5", "url": "https://github.com/apache/iceberg/pull/1321#pullrequestreview-465577389", "createdAt": "2020-08-12T04:08:19Z", "commit": {"oid": "66d42076801b26f2965959f8786938a2ee4121c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNDowODoxOVrOG_REvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNDowODoxOVrOG_REvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5MzIxMw==", "bodyText": "I wonder if we should solve this in a different way. The issue is that when complex value types are involved for logical maps the key is not projected. Then why don't we project the key field if the map's  value field is projected?\nWould it be better to change the map method in GetProjectedIds to always project the keyField if valueResult is not null instead of changing PruneColumns?\nWhat do you guys think @rdblue, @lxynov ?", "url": "https://github.com/apache/iceberg/pull/1321#discussion_r468993213", "createdAt": "2020-08-12T04:08:19Z", "author": {"login": "rdsr"}, "path": "core/src/main/java/org/apache/iceberg/avro/PruneColumns.java", "diffHunk": "@@ -144,16 +144,18 @@ public Schema array(Schema array, Schema element) {\n       if (selectedIds.contains(keyId) || selectedIds.contains(valueId)) {\n         return complexMapWithIds(array, keyId, valueId);\n       } else if (element != null) {\n-        Schema keyProjection = element.getField(\"key\").schema();\n+        Schema.Field keyProjectionField = element.getField(\"key\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66d42076801b26f2965959f8786938a2ee4121c4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NTAxNDUz", "url": "https://github.com/apache/iceberg/pull/1321#pullrequestreview-466501453", "createdAt": "2020-08-13T07:16:16Z", "commit": {"oid": "66d42076801b26f2965959f8786938a2ee4121c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MjMyMzQw", "url": "https://github.com/apache/iceberg/pull/1321#pullrequestreview-467232340", "createdAt": "2020-08-14T00:09:18Z", "commit": {"oid": "66d42076801b26f2965959f8786938a2ee4121c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMDowOToxOFrOHAh0Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMDowOToxOFrOHAh0Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDMxNjEwMw==", "bodyText": "Looks like indentation is off here. The project uses 2 spaces per indent, and 2 indents for continuation lines like this. Could you fix this method please?", "url": "https://github.com/apache/iceberg/pull/1321#discussion_r470316103", "createdAt": "2020-08-14T00:09:18Z", "author": {"login": "rdblue"}, "path": "core/src/test/java/org/apache/iceberg/avro/TestAvroReadProjection.java", "diffHunk": "@@ -49,4 +56,27 @@\n \n     return Iterables.getOnlyElement(records);\n   }\n+\n+  @Test\n+  public void testAvroArrayAsLogicalMap() throws IOException {\n+    Schema writeSchema = new Schema(\n+            Types.NestedField.optional(0, \"map\", Types.MapType.ofOptional(2, 3,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66d42076801b26f2965959f8786938a2ee4121c4"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66d42076801b26f2965959f8786938a2ee4121c4", "author": {"user": {"login": "lxynov", "name": "Xingyuan Lin"}}, "url": "https://github.com/apache/iceberg/commit/66d42076801b26f2965959f8786938a2ee4121c4", "committedDate": "2020-08-11T05:43:24Z", "message": "Avro: Fix pruning columns when a logical-map array's value type is nested\n\nE.g., map(long, list<long>)"}, "afterCommit": {"oid": "792050544be872c79a27ca0f1fabbe254cd22e73", "author": {"user": {"login": "lxynov", "name": "Xingyuan Lin"}}, "url": "https://github.com/apache/iceberg/commit/792050544be872c79a27ca0f1fabbe254cd22e73", "committedDate": "2020-08-14T02:53:40Z", "message": "Avro: Fix pruning columns when a logical-map array's value type is nested\n\nE.g., map(long, list<long>)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NzE0NTkw", "url": "https://github.com/apache/iceberg/pull/1321#pullrequestreview-467714590", "createdAt": "2020-08-14T16:34:40Z", "commit": {"oid": "792050544be872c79a27ca0f1fabbe254cd22e73"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNjozNDo0MFrOHA7LeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNjozNDo0MFrOHA7LeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDczMTY0MQ==", "bodyText": "Looks like this wasn't updated.", "url": "https://github.com/apache/iceberg/pull/1321#discussion_r470731641", "createdAt": "2020-08-14T16:34:40Z", "author": {"login": "rdblue"}, "path": "core/src/test/java/org/apache/iceberg/avro/TestAvroReadProjection.java", "diffHunk": "@@ -49,4 +56,27 @@\n \n     return Iterables.getOnlyElement(records);\n   }\n+\n+  @Test\n+  public void testAvroArrayAsLogicalMap() throws IOException {\n+    Schema writeSchema = new Schema(\n+        Types.NestedField.optional(0, \"map\", Types.MapType.ofOptional(2, 3,\n+            Types.LongType.get(),\n+            Types.ListType.ofRequired(1, Types.LongType.get())\n+        ))\n+    );\n+\n+    List<Long> values1 = ImmutableList.of(101L, 102L);\n+    List<Long> values2 = ImmutableList.of(201L, 202L, 203L);\n+    GenericData.Record record = new GenericData.Record(AvroSchemaUtil.convert(writeSchema, \"table\"));\n+    record.put(\"map\", ImmutableMap.of(100L, values1, 200L, values2));\n+\n+    GenericData.Record projected = writeAndRead(\"full_projection\", writeSchema, writeSchema, record);\n+    Assert.assertEquals(\"Should contain correct value list\",\n+            values1,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "792050544be872c79a27ca0f1fabbe254cd22e73"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f297d3f18d4d08004876370495a559f6eec522f", "author": {"user": {"login": "lxynov", "name": "Xingyuan Lin"}}, "url": "https://github.com/apache/iceberg/commit/4f297d3f18d4d08004876370495a559f6eec522f", "committedDate": "2020-08-14T18:48:53Z", "message": "Avro: Fix pruning columns when a logical-map array's value type is nested\n\nE.g., map(long, list<long>)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "792050544be872c79a27ca0f1fabbe254cd22e73", "author": {"user": {"login": "lxynov", "name": "Xingyuan Lin"}}, "url": "https://github.com/apache/iceberg/commit/792050544be872c79a27ca0f1fabbe254cd22e73", "committedDate": "2020-08-14T02:53:40Z", "message": "Avro: Fix pruning columns when a logical-map array's value type is nested\n\nE.g., map(long, list<long>)"}, "afterCommit": {"oid": "4f297d3f18d4d08004876370495a559f6eec522f", "author": {"user": {"login": "lxynov", "name": "Xingyuan Lin"}}, "url": "https://github.com/apache/iceberg/commit/4f297d3f18d4d08004876370495a559f6eec522f", "committedDate": "2020-08-14T18:48:53Z", "message": "Avro: Fix pruning columns when a logical-map array's value type is nested\n\nE.g., map(long, list<long>)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4013, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}