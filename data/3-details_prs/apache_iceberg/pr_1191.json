{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3MTczOTAy", "number": 1191, "title": "ORC: Use ConstantReader for identity partition columns", "bodyText": "Fixes #1056\ncc: @rdsr Since you had worked on this initially", "createdAt": "2020-07-10T01:35:25Z", "url": "https://github.com/apache/iceberg/pull/1191", "merged": true, "mergeCommit": {"oid": "a2796f0fd38e517d17462ebc7b0234282e976dd3"}, "closed": true, "closedAt": "2020-07-11T00:05:40Z", "author": {"login": "shardulm94"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczZb3agH2gAyNDQ3MTczOTAyOmM1NWMxNmUwYjBmN2QzNzc4YzNlMDRlZjc0N2Y5ZTU1N2YwNzE4YTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczsbwzAH2gAyNDQ3MTczOTAyOjE0MzkwOTQ3ODJjYTEzMTIxMDA3MGNhYmZhMDlkOGYwY2QwY2IxZjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c55c16e0b0f7d3778c3e04ef747f9e557f0718a7", "author": {"user": {"login": "shardulm94", "name": "Shardul Mahadik"}}, "url": "https://github.com/apache/iceberg/commit/c55c16e0b0f7d3778c3e04ef747f9e557f0718a7", "committedDate": "2020-07-10T01:34:17Z", "message": "ORC: Use ConstantReader for identity partition columns"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NTYxOTUy", "url": "https://github.com/apache/iceberg/pull/1191#pullrequestreview-446561952", "createdAt": "2020-07-10T17:08:04Z", "commit": {"oid": "c55c16e0b0f7d3778c3e04ef747f9e557f0718a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzowODowNVrOGv-8Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzowODowNVrOGv-8Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2NzQ0Nw==", "bodyText": "Is ColumnVector still materialized? Is it possible to avoid reading that entirely?", "url": "https://github.com/apache/iceberg/pull/1191#discussion_r452967447", "createdAt": "2020-07-10T17:08:05Z", "author": {"login": "rdblue"}, "path": "orc/src/main/java/org/apache/iceberg/orc/OrcValueReaders.java", "diffHunk": "@@ -181,12 +173,25 @@ private T readInternal(T struct, ColumnVector[] columnVectors, int row) {\n       for (int c = 0; c < readers.length; ++c) {\n         set(struct, c, reader(c).read(columnVectors[c], row));\n       }\n+      return struct;\n+    }\n+  }\n \n-      for (int i = 0; i < positions.length; i += 1) {\n-        set(struct, positions[i], constants[i]);\n-      }\n+  private static class ConstantReader<C> implements OrcValueReader<C> {\n+    private final C constant;\n \n-      return struct;\n+    private ConstantReader(C constant) {\n+      this.constant = constant;\n+    }\n+\n+    @Override\n+    public C read(ColumnVector ignored, int ignoredRow) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c55c16e0b0f7d3778c3e04ef747f9e557f0718a7"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26cbff7a236fd0a06d7b34f8e97d8d0c5631b873", "author": {"user": {"login": "shardulm94", "name": "Shardul Mahadik"}}, "url": "https://github.com/apache/iceberg/commit/26cbff7a236fd0a06d7b34f8e97d8d0c5631b873", "committedDate": "2020-07-10T23:13:27Z", "message": "Do not project constant columns from ORC reader"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzQ2NjQz", "url": "https://github.com/apache/iceberg/pull/1191#pullrequestreview-446746643", "createdAt": "2020-07-10T23:18:26Z", "commit": {"oid": "26cbff7a236fd0a06d7b34f8e97d8d0c5631b873"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMzoxODoyNlrOGwIHPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMzoxODoyNlrOGwIHPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzExNzc1Ng==", "bodyText": "Minor: we discourage using the return value of ++ expressions because it is error prone and makes code harder to read. Could you move the increment to a separate line?", "url": "https://github.com/apache/iceberg/pull/1191#discussion_r453117756", "createdAt": "2020-07-10T23:18:26Z", "author": {"login": "rdblue"}, "path": "orc/src/main/java/org/apache/iceberg/orc/OrcValueReaders.java", "diffHunk": "@@ -178,15 +171,29 @@ public T nonNullRead(ColumnVector vector, int row) {\n     }\n \n     private T readInternal(T struct, ColumnVector[] columnVectors, int row) {\n-      for (int c = 0; c < readers.length; ++c) {\n-        set(struct, c, reader(c).read(columnVectors[c], row));\n+      for (int c = 0, vectorIndex = 0; c < readers.length; ++c) {\n+        ColumnVector vector = isConstantField[c] ? null : columnVectors[vectorIndex++];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26cbff7a236fd0a06d7b34f8e97d8d0c5631b873"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1439094782ca131210070cabfa09d8f0cd0cb1f8", "author": {"user": {"login": "shardulm94", "name": "Shardul Mahadik"}}, "url": "https://github.com/apache/iceberg/commit/1439094782ca131210070cabfa09d8f0cd0cb1f8", "committedDate": "2020-07-10T23:42:22Z", "message": "Address PR comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4249, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}