{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5NTUxMzk4", "number": 1356, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwODoyNjowNFrOEibuUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxODoxNzozNVrOEor_xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NTQxMjY3OnYy", "diffSide": "RIGHT", "path": "arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorizedArrowReader.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwODoyNjowNFrOHQTWug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxMzoxMzoyMlrOHQ8W_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg1NjM3OA==", "bodyText": "I am unsure if returning a singleton instance for PostitionVectorReader is safe, since it contains a member variable rowStart which seems to differ for every row group created. Can there be a possibility of multiple tasks running on the same executor JVM and wanting to refer to different PostionVectorReaders at the same time?", "url": "https://github.com/apache/iceberg/pull/1356#discussion_r486856378", "createdAt": "2020-09-11T08:26:04Z", "author": {"login": "shardulm94"}, "path": "arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorizedArrowReader.java", "diffHunk": "@@ -332,6 +334,10 @@ public static VectorizedArrowReader nulls() {\n     return NullVectorReader.INSTANCE;\n   }\n \n+  public static VectorizedArrowReader positions() {\n+    return PositionVectorReader.INSTANCE;\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "036eb2228f860ec939c3505bac66d0280fe81a89"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg3OTcwMg==", "bodyText": "Thanks for your comment.\nThe INSTANCE is defined to return a new PosistionVectorReader. It doesn't have a class scope field such as instance and the null checking logic, so it is not a singleton.\nIIUC, spark will assign the number of spark.executor.cores of tasks per executor.", "url": "https://github.com/apache/iceberg/pull/1356#discussion_r486879702", "createdAt": "2020-09-11T09:01:00Z", "author": {"login": "chenjunjiedada"}, "path": "arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorizedArrowReader.java", "diffHunk": "@@ -332,6 +334,10 @@ public static VectorizedArrowReader nulls() {\n     return NullVectorReader.INSTANCE;\n   }\n \n+  public static VectorizedArrowReader positions() {\n+    return PositionVectorReader.INSTANCE;\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg1NjM3OA=="}, "originalCommit": {"oid": "036eb2228f860ec939c3505bac66d0280fe81a89"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzUwMjA2NQ==", "bodyText": "The INSTANCE field is defined is static, so I am guessing new PositionVectorReader() will only be called once when the class is being loaded by the JVM. This seems like mimicking a singleton to me, unless I am reading the things wrongly.", "url": "https://github.com/apache/iceberg/pull/1356#discussion_r487502065", "createdAt": "2020-09-13T08:55:14Z", "author": {"login": "shardulm94"}, "path": "arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorizedArrowReader.java", "diffHunk": "@@ -332,6 +334,10 @@ public static VectorizedArrowReader nulls() {\n     return NullVectorReader.INSTANCE;\n   }\n \n+  public static VectorizedArrowReader positions() {\n+    return PositionVectorReader.INSTANCE;\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg1NjM3OA=="}, "originalCommit": {"oid": "036eb2228f860ec939c3505bac66d0280fe81a89"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzUyODE5MA==", "bodyText": "You are right! I forgot the static keyword, it is an eager mode of the singleton. Just remove using singleton in 52f4468.", "url": "https://github.com/apache/iceberg/pull/1356#discussion_r487528190", "createdAt": "2020-09-13T13:13:22Z", "author": {"login": "chenjunjiedada"}, "path": "arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorizedArrowReader.java", "diffHunk": "@@ -332,6 +334,10 @@ public static VectorizedArrowReader nulls() {\n     return NullVectorReader.INSTANCE;\n   }\n \n+  public static VectorizedArrowReader positions() {\n+    return PositionVectorReader.INSTANCE;\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg1NjM3OA=="}, "originalCommit": {"oid": "036eb2228f860ec939c3505bac66d0280fe81a89"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NjExMDU3OnYy", "diffSide": "RIGHT", "path": "arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorHolder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwNzoxMToyN1rOHRz0-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMjoxNjo0OFrOHSuBRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQzNjk4Nw==", "bodyText": "Seems like technically this class is redundant since the user can use VectorHolder directly, but is probably good for readability?", "url": "https://github.com/apache/iceberg/pull/1356#discussion_r488436987", "createdAt": "2020-09-15T07:11:27Z", "author": {"login": "shardulm94"}, "path": "arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorHolder.java", "diffHunk": "@@ -131,4 +140,10 @@ public Object getConstant() {\n     }\n   }\n \n+  public static class PositionVectorHolder extends VectorHolder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52f44687a533f0d9b9895c9dc4326b7ef7785654"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM5MDQwNg==", "bodyText": "Yes, I added a private VectorHolder constructor for PositionVectionHolder which I don't want others to use it directly.", "url": "https://github.com/apache/iceberg/pull/1356#discussion_r489390406", "createdAt": "2020-09-16T12:16:48Z", "author": {"login": "chenjunjiedada"}, "path": "arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorHolder.java", "diffHunk": "@@ -131,4 +140,10 @@ public Object getConstant() {\n     }\n   }\n \n+  public static class PositionVectorHolder extends VectorHolder {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQzNjk4Nw=="}, "originalCommit": {"oid": "52f44687a533f0d9b9895c9dc4326b7ef7785654"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NjIxMDg0OnYy", "diffSide": "RIGHT", "path": "arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorizedArrowReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwNzozODoyOFrOHR0xZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMjoyMToyOFrOHSuL1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ1MjQ1NQ==", "bodyText": "Can this follow an approach similar to VectorizedArrowReader and not create a new FieldVector and NullabilityHolder for every invocation?\n\n  \n    \n      iceberg/arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorizedArrowReader.java\n    \n    \n        Lines 123 to 125\n      in\n      52f4468\n    \n    \n    \n    \n\n        \n          \n           } else { \n        \n\n        \n          \n             vec.setValueCount(0); \n        \n\n        \n          \n             nullabilityHolder.reset();", "url": "https://github.com/apache/iceberg/pull/1356#discussion_r488452455", "createdAt": "2020-09-15T07:38:28Z", "author": {"login": "shardulm94"}, "path": "arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorizedArrowReader.java", "diffHunk": "@@ -354,6 +360,40 @@ public void setBatchSize(int batchSize) {\n     }\n   }\n \n+  private static final class PositionVectorReader extends VectorizedArrowReader {\n+    private long rowStart;\n+\n+    @Override\n+    public VectorHolder read(VectorHolder reuse, int numValsToRead) {\n+      Field arrowField = ArrowSchemaUtil.convert(MetadataColumns.ROW_POSITION);\n+      FieldVector vec = arrowField.createVector(ArrowAllocation.rootAllocator());\n+      ((BigIntVector) vec).allocateNew(numValsToRead);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52f44687a533f0d9b9895c9dc4326b7ef7785654"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM5MzEwOA==", "bodyText": "Make sense to me, updated in 73de369", "url": "https://github.com/apache/iceberg/pull/1356#discussion_r489393108", "createdAt": "2020-09-16T12:21:28Z", "author": {"login": "chenjunjiedada"}, "path": "arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorizedArrowReader.java", "diffHunk": "@@ -354,6 +360,40 @@ public void setBatchSize(int batchSize) {\n     }\n   }\n \n+  private static final class PositionVectorReader extends VectorizedArrowReader {\n+    private long rowStart;\n+\n+    @Override\n+    public VectorHolder read(VectorHolder reuse, int numValsToRead) {\n+      Field arrowField = ArrowSchemaUtil.convert(MetadataColumns.ROW_POSITION);\n+      FieldVector vec = arrowField.createVector(ArrowAllocation.rootAllocator());\n+      ((BigIntVector) vec).allocateNew(numValsToRead);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ1MjQ1NQ=="}, "originalCommit": {"oid": "52f44687a533f0d9b9895c9dc4326b7ef7785654"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMDk5MzM1OnYy", "diffSide": "RIGHT", "path": "arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorizedArrowReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxODoxNzozNVrOHZ7Ffg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwMzo1OToxNFrOHaMfNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk0NDUxMA==", "bodyText": "Why are we setting this inside of the for loop?", "url": "https://github.com/apache/iceberg/pull/1356#discussion_r496944510", "createdAt": "2020-09-29T18:17:35Z", "author": {"login": "holdenk"}, "path": "arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorizedArrowReader.java", "diffHunk": "@@ -354,6 +360,47 @@ public void setBatchSize(int batchSize) {\n     }\n   }\n \n+  private static final class PositionVectorReader extends VectorizedArrowReader {\n+    private long rowStart;\n+    private NullabilityHolder nulls;\n+\n+    @Override\n+    public VectorHolder read(VectorHolder reuse, int numValsToRead) {\n+      Field arrowField = ArrowSchemaUtil.convert(MetadataColumns.ROW_POSITION);\n+      FieldVector vec = arrowField.createVector(ArrowAllocation.rootAllocator());\n+\n+      if (reuse != null) {\n+        vec.setValueCount(0);\n+        nulls.reset();\n+      } else {\n+        ((BigIntVector) vec).allocateNew(numValsToRead);\n+        for (int i = 0; i < numValsToRead; i += 1) {\n+          vec.getDataBuffer().setLong(i * Long.BYTES, rowStart + i);\n+          nulls = new NullabilityHolder(numValsToRead);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73de3696204c8fe1ed99cfddda2cf488c413f735"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIyOTYyMg==", "bodyText": "Thanks @holdenk, This is a problem. Let me move this out of the loop.", "url": "https://github.com/apache/iceberg/pull/1356#discussion_r497229622", "createdAt": "2020-09-30T03:59:14Z", "author": {"login": "chenjunjiedada"}, "path": "arrow/src/main/java/org/apache/iceberg/arrow/vectorized/VectorizedArrowReader.java", "diffHunk": "@@ -354,6 +360,47 @@ public void setBatchSize(int batchSize) {\n     }\n   }\n \n+  private static final class PositionVectorReader extends VectorizedArrowReader {\n+    private long rowStart;\n+    private NullabilityHolder nulls;\n+\n+    @Override\n+    public VectorHolder read(VectorHolder reuse, int numValsToRead) {\n+      Field arrowField = ArrowSchemaUtil.convert(MetadataColumns.ROW_POSITION);\n+      FieldVector vec = arrowField.createVector(ArrowAllocation.rootAllocator());\n+\n+      if (reuse != null) {\n+        vec.setValueCount(0);\n+        nulls.reset();\n+      } else {\n+        ((BigIntVector) vec).allocateNew(numValsToRead);\n+        for (int i = 0; i < numValsToRead; i += 1) {\n+          vec.getDataBuffer().setLong(i * Long.BYTES, rowStart + i);\n+          nulls = new NullabilityHolder(numValsToRead);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk0NDUxMA=="}, "originalCommit": {"oid": "73de3696204c8fe1ed99cfddda2cf488c413f735"}, "originalPosition": 58}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3666, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}