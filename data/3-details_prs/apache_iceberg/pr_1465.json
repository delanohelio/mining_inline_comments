{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3OTI1Mjc3", "number": 1465, "title": "Core: Enhance version-hint.txt recovery with file listing", "bodyText": "The patch enhances the recovery introduced in #1443 for missing/corrupted version-hint.txt by listing the files in the metadata directory and returning the highest possible version.", "createdAt": "2020-09-16T11:35:19Z", "url": "https://github.com/apache/iceberg/pull/1465", "merged": true, "mergeCommit": {"oid": "606b003272520034da9557b871aed379bf6aee9f"}, "closed": true, "closedAt": "2020-09-18T18:45:53Z", "author": {"login": "pvary"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJct_oABqjM3NzMzMDcxNDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKDAV5AH2gAyNDg3OTI1Mjc3OmNiYTE1N2NkMWI4Y2UyNDVjOGMyMmY4NTdjMTUzNGNiMDc4ZGRiM2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "117690a74c7dd2c06dbc07a233b72460fcc38b1f", "author": {"user": {"login": "kbendick", "name": "Kyle Bendickson"}}, "url": "https://github.com/apache/iceberg/commit/117690a74c7dd2c06dbc07a233b72460fcc38b1f", "committedDate": "2020-09-16T11:29:50Z", "message": "Core: Enhance version-hint.txt recovery with file listing"}, "afterCommit": {"oid": "292af8eb888b7df3db4472c37c47a66417845b93", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/292af8eb888b7df3db4472c37c47a66417845b93", "committedDate": "2020-09-16T13:49:19Z", "message": "Core: Enhance version-hint.txt recovery with file listing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5ODQ0NTQ4", "url": "https://github.com/apache/iceberg/pull/1465#pullrequestreview-489844548", "createdAt": "2020-09-16T17:29:10Z", "commit": {"oid": "292af8eb888b7df3db4472c37c47a66417845b93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNzoyOToxMFrOHS7E7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNzoyOToxMFrOHS7E7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwNDMzMg==", "bodyText": "Why make this debug instead of warn? I think it is still concerning that the version hint couldn't be found.", "url": "https://github.com/apache/iceberg/pull/1465#discussion_r489604332", "createdAt": "2020-09-16T17:29:10Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -289,19 +311,24 @@ int readVersionHint() {\n       return Integer.parseInt(in.readLine().replace(\"\\n\", \"\"));\n \n     } catch (Exception e) {\n-      LOG.warn(\"Error reading version hint file {}\", versionHintFile, e);\n+      LOG.debug(\"Error reading version hint file {}\", versionHintFile, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "292af8eb888b7df3db4472c37c47a66417845b93"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5ODQ1NzE2", "url": "https://github.com/apache/iceberg/pull/1465#pullrequestreview-489845716", "createdAt": "2020-09-16T17:30:49Z", "commit": {"oid": "292af8eb888b7df3db4472c37c47a66417845b93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNzozMDo0OVrOHS7Ijw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNzozMDo0OVrOHS7Ijw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwNTI2Mw==", "bodyText": "Nit: we like to have newlines after control flow statements/blocks.", "url": "https://github.com/apache/iceberg/pull/1465#discussion_r489605263", "createdAt": "2020-09-16T17:30:49Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -289,19 +311,24 @@ int readVersionHint() {\n       return Integer.parseInt(in.readLine().replace(\"\\n\", \"\"));\n \n     } catch (Exception e) {\n-      LOG.warn(\"Error reading version hint file {}\", versionHintFile, e);\n+      LOG.debug(\"Error reading version hint file {}\", versionHintFile, e);\n       try {\n-        if (getMetadataFile(1) != null) {\n-          // We just assume corrupted metadata and start to read from the first version file\n-          return 1;\n+        // List the metadata directory to find the version files, and try to recover the max available version\n+        FileStatus[] files = fs.listStatus(metadataRoot(), name -> VERSION_PATTERN.matcher(name.getName()).matches());\n+        int maxVersion = 0;\n+\n+        for (FileStatus file : files) {\n+          version = version(file.getPath().getName());\n+          if (version > maxVersion && getMetadataFile(version) != null) {\n+            maxVersion = version;\n+          }\n         }\n+        return maxVersion;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "292af8eb888b7df3db4472c37c47a66417845b93"}, "originalPosition": 94}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5ODQ2NDgw", "url": "https://github.com/apache/iceberg/pull/1465#pullrequestreview-489846480", "createdAt": "2020-09-16T17:31:54Z", "commit": {"oid": "292af8eb888b7df3db4472c37c47a66417845b93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNzozMTo1NFrOHS7K6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNzozMTo1NFrOHS7K6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYwNTg2Ng==", "bodyText": "Since this is a new feature, can you put it in its own test method?", "url": "https://github.com/apache/iceberg/pull/1465#discussion_r489605866", "createdAt": "2020-09-16T17:31:54Z", "author": {"login": "rdblue"}, "path": "core/src/test/java/org/apache/iceberg/hadoop/TestHadoopCatalog.java", "diffHunk": "@@ -494,23 +495,42 @@ public void testVersionHintFile() throws Exception {\n       stream.write(\"3\".getBytes(StandardCharsets.UTF_8));\n     }\n \n-    // Check the result of the readVersionHint(), and load the table and check the current snapshotId\n-    Assert.assertEquals(3, tableOperations.readVersionHint());\n+    // Check the result of the versionHint(), and load the table and check the current snapshotId\n+    Assert.assertEquals(3, tableOperations.versionHint());\n     Assert.assertEquals(secondSnapshotId, catalog.loadTable(tableId).currentSnapshot().snapshotId());\n \n     // Write an empty version hint file\n     io.deleteFile(versionHintLocation);\n     io.newOutputFile(versionHintLocation).create().close();\n \n-    // Check the result of the readVersionHint(), and load the table and check the current snapshotId\n-    Assert.assertEquals(1, tableOperations.readVersionHint());\n+    // Check the result of the versionHint(), and load the table and check the current snapshotId\n+    Assert.assertEquals(3, tableOperations.versionHint());\n     Assert.assertEquals(secondSnapshotId, catalog.loadTable(tableId).currentSnapshot().snapshotId());\n \n     // Just delete the file - double check that we have manipulated the correct file\n     io.deleteFile(versionHintLocation);\n \n-    // Check the result of the readVersionHint(), and load the table and check the current snapshotId\n-    Assert.assertEquals(1, tableOperations.readVersionHint());\n+    // Check the result of the versionHint(), and load the table and check the current snapshotId\n+    Assert.assertEquals(3, tableOperations.versionHint());\n     Assert.assertEquals(secondSnapshotId, catalog.loadTable(tableId).currentSnapshot().snapshotId());\n+\n+    // Remove the first version file, and see if we can recover\n+    io.deleteFile(tableOperations.getMetadataFile(1).toString());\n+\n+    // Check the result of the versionHint(), and load the table and check the current snapshotId\n+    Assert.assertEquals(3, tableOperations.versionHint());\n+    Assert.assertEquals(secondSnapshotId, catalog.loadTable(tableId).currentSnapshot().snapshotId());\n+\n+    // Remove all the version files, and see if we can recover. Hint... not :)\n+    io.deleteFile(tableOperations.getMetadataFile(2).toString());\n+    io.deleteFile(tableOperations.getMetadataFile(3).toString());\n+\n+    // Check that we got 0 versionHint, and a NoSuchTableException is thrown when trying to load the table\n+    Assert.assertEquals(0, tableOperations.versionHint());\n+    AssertHelpers.assertThrows(\n+        \"Should not be able to find the table\",\n+        NoSuchTableException.class,\n+        \"Table does not exist: tbl\",\n+        () -> catalog.loadTable(tableId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "292af8eb888b7df3db4472c37c47a66417845b93"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5OTY2MDQy", "url": "https://github.com/apache/iceberg/pull/1465#pullrequestreview-489966042", "createdAt": "2020-09-16T19:42:55Z", "commit": {"oid": "292af8eb888b7df3db4472c37c47a66417845b93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTo0Mjo1NVrOHTBpQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTo0Mjo1NVrOHTBpQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxMTkzOQ==", "bodyText": "This will list all the files in the metadata directory, right? It's just that we're filtering on the client for the files matching the version naming pattern.", "url": "https://github.com/apache/iceberg/pull/1465#discussion_r489711939", "createdAt": "2020-09-16T19:42:55Z", "author": {"login": "fbocse"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -289,19 +311,24 @@ int readVersionHint() {\n       return Integer.parseInt(in.readLine().replace(\"\\n\", \"\"));\n \n     } catch (Exception e) {\n-      LOG.warn(\"Error reading version hint file {}\", versionHintFile, e);\n+      LOG.debug(\"Error reading version hint file {}\", versionHintFile, e);\n       try {\n-        if (getMetadataFile(1) != null) {\n-          // We just assume corrupted metadata and start to read from the first version file\n-          return 1;\n+        // List the metadata directory to find the version files, and try to recover the max available version\n+        FileStatus[] files = fs.listStatus(metadataRoot(), name -> VERSION_PATTERN.matcher(name.getName()).matches());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "292af8eb888b7df3db4472c37c47a66417845b93"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMDYyMTMx", "url": "https://github.com/apache/iceberg/pull/1465#pullrequestreview-490062131", "createdAt": "2020-09-16T22:27:15Z", "commit": {"oid": "292af8eb888b7df3db4472c37c47a66417845b93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMjoyNzoxNVrOHTGUKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMjoyNzoxNVrOHTGUKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4ODQ1OQ==", "bodyText": "I didn't catch this at first, but this method should not have a side effect of setting version. It should return version and something else should set it.\nAlso, when we set instance fields, we use the prefix this. so that it is clear that an instance field and not a local variable is set. That's why I missed this in my first round of review.", "url": "https://github.com/apache/iceberg/pull/1465#discussion_r489788459", "createdAt": "2020-09-16T22:27:15Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -289,19 +311,24 @@ int readVersionHint() {\n       return Integer.parseInt(in.readLine().replace(\"\\n\", \"\"));\n \n     } catch (Exception e) {\n-      LOG.warn(\"Error reading version hint file {}\", versionHintFile, e);\n+      LOG.debug(\"Error reading version hint file {}\", versionHintFile, e);\n       try {\n-        if (getMetadataFile(1) != null) {\n-          // We just assume corrupted metadata and start to read from the first version file\n-          return 1;\n+        // List the metadata directory to find the version files, and try to recover the max available version\n+        FileStatus[] files = fs.listStatus(metadataRoot(), name -> VERSION_PATTERN.matcher(name.getName()).matches());\n+        int maxVersion = 0;\n+\n+        for (FileStatus file : files) {\n+          version = version(file.getPath().getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "292af8eb888b7df3db4472c37c47a66417845b93"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "602e01257219397ad1fca35e4fbb10216d433f52", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/602e01257219397ad1fca35e4fbb10216d433f52", "committedDate": "2020-09-17T08:39:35Z", "message": "Core: Enhance version-hint.txt recovery with file listing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b86ee4c2fd80928fb119cb2771a3284f8826b9f", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/1b86ee4c2fd80928fb119cb2771a3284f8826b9f", "committedDate": "2020-09-17T09:58:03Z", "message": "Separated the tests\nFixed version update during the reading\nFixed the error message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "292af8eb888b7df3db4472c37c47a66417845b93", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/292af8eb888b7df3db4472c37c47a66417845b93", "committedDate": "2020-09-16T13:49:19Z", "message": "Core: Enhance version-hint.txt recovery with file listing"}, "afterCommit": {"oid": "1b86ee4c2fd80928fb119cb2771a3284f8826b9f", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/1b86ee4c2fd80928fb119cb2771a3284f8826b9f", "committedDate": "2020-09-17T09:58:03Z", "message": "Separated the tests\nFixed version update during the reading\nFixed the error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97a84340684e89bbe0b89928583ac616010f2fcd", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/97a84340684e89bbe0b89928583ac616010f2fcd", "committedDate": "2020-09-17T11:14:03Z", "message": "Refactored the tests for fewer code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwODIzNTEx", "url": "https://github.com/apache/iceberg/pull/1465#pullrequestreview-490823511", "createdAt": "2020-09-17T17:20:06Z", "commit": {"oid": "97a84340684e89bbe0b89928583ac616010f2fcd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNzoyMDowNlrOHTtczg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNzoyMDowNlrOHTtczg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyOTY0Ng==", "bodyText": "Nit: This change isn't necessary?", "url": "https://github.com/apache/iceberg/pull/1465#discussion_r490429646", "createdAt": "2020-09-17T17:20:06Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -289,19 +311,28 @@ int readVersionHint() {\n       return Integer.parseInt(in.readLine().replace(\"\\n\", \"\"));\n \n     } catch (Exception e) {\n-      LOG.warn(\"Error reading version hint file {}\", versionHintFile, e);\n       try {\n-        if (getMetadataFile(1) != null) {\n-          // We just assume corrupted metadata and start to read from the first version file\n-          return 1;\n+        if (fs.exists(metadataRoot())) {\n+          LOG.warn(\"Error reading version hint file {}\", versionHintFile, e);\n+        }\n+\n+        // List the metadata directory to find the version files, and try to recover the max available version\n+        FileStatus[] files = fs.listStatus(metadataRoot(), name -> VERSION_PATTERN.matcher(name.getName()).matches());\n+        int maxVersion = 0;\n+\n+        for (FileStatus file : files) {\n+          int currentVersion = version(file.getPath().getName());\n+          if (currentVersion > maxVersion && getMetadataFile(currentVersion) != null) {\n+            maxVersion = currentVersion;\n+          }\n         }\n+\n+        return maxVersion;\n       } catch (IOException io) {\n         // We log this error only on debug level since this is just a problem in recovery path\n         LOG.debug(\"Error trying to recover version-hint.txt data for {}\", versionHintFile, e);\n+        return 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97a84340684e89bbe0b89928583ac616010f2fcd"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwODM0Mjgy", "url": "https://github.com/apache/iceberg/pull/1465#pullrequestreview-490834282", "createdAt": "2020-09-17T17:32:55Z", "commit": {"oid": "97a84340684e89bbe0b89928583ac616010f2fcd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNzozMjo1NlrOHTt86Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNzozMjo1NlrOHTt86Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQzNzg2NQ==", "bodyText": "I think a better name for this is findVersion because it will do listing now. It isn't really a hint because it handles the case where the hint is missing.", "url": "https://github.com/apache/iceberg/pull/1465#discussion_r490437865", "createdAt": "2020-09-17T17:32:56Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -280,7 +302,7 @@ private void writeVersionHint(int versionToWrite) {\n   }\n \n   @VisibleForTesting\n-  int readVersionHint() {\n+  int versionHint() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97a84340684e89bbe0b89928583ac616010f2fcd"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a158715756ee6471316fb54793722591d925815a", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/a158715756ee6471316fb54793722591d925815a", "committedDate": "2020-09-18T09:11:04Z", "message": "Renamed versionHint() to findVersion()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cba157cd1b8ce245c8c22f857c1534cb078ddb3c", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/cba157cd1b8ce245c8c22f857c1534cb078ddb3c", "committedDate": "2020-09-18T10:26:34Z", "message": "Error handling cleanup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4212, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}