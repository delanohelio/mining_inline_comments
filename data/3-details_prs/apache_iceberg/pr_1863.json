{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMTg4ODQ5", "number": 1863, "title": "AWS: support S3 strong consistency", "bodyText": "AWS released S3 strong consistency, and now all LIST and GET are strongly consistent. So we can use a LIST to force strong consistency before performing a HEAD for exists() check.\nMore details: https://aws.amazon.com/blogs/aws/amazon-s3-update-strong-read-after-write-consistency/", "createdAt": "2020-12-02T17:54:41Z", "url": "https://github.com/apache/iceberg/pull/1863", "merged": true, "mergeCommit": {"oid": "c882ac9249229078bf89caf48de688c399e858f9"}, "closed": true, "closedAt": "2020-12-03T16:48:40Z", "author": {"login": "jackye1995"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiSUsIgH2gAyNTMxMTg4ODQ5OjVlYWMxYzA5ZGExZjEzYjhmOWU2OWE2ZDAwNTEwZTM1M2UwMmVjYzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdimBXugFqTU0NDE2NzYwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5eac1c09da1f13b8f9e69a6d00510e353e02ecc5", "author": {"user": {"login": "jackye1995", "name": "Jack Ye"}}, "url": "https://github.com/apache/iceberg/commit/5eac1c09da1f13b8f9e69a6d00510e353e02ecc5", "committedDate": "2020-12-02T17:51:33Z", "message": "AWS: support S3 strong consistency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTM1OTM2", "url": "https://github.com/apache/iceberg/pull/1863#pullrequestreview-543135936", "createdAt": "2020-12-02T18:45:41Z", "commit": {"oid": "5eac1c09da1f13b8f9e69a6d00510e353e02ecc5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMjU4NjAw", "url": "https://github.com/apache/iceberg/pull/1863#pullrequestreview-543258600", "createdAt": "2020-12-02T21:38:59Z", "commit": {"oid": "5eac1c09da1f13b8f9e69a6d00510e353e02ecc5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMTozODo1OVrOH9vNNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMTozODo1OVrOH9vNNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ5ODYxNA==", "bodyText": "you might want to include maxKeys(1) as well since we only care about a single entry (and validate that it matches exactly)", "url": "https://github.com/apache/iceberg/pull/1863#discussion_r534498614", "createdAt": "2020-12-02T21:38:59Z", "author": {"login": "danielcweeks"}, "path": "aws/src/main/java/org/apache/iceberg/aws/s3/BaseS3File.java", "diffHunk": "@@ -77,6 +78,12 @@ public boolean exists() {\n \n   protected HeadObjectResponse getObjectMetadata() throws S3Exception {\n     if (metadata == null) {\n+      // list object to force strong consistency\n+      client().listObjectsV2(ListObjectsV2Request.builder()\n+          .bucket(uri().bucket())\n+          .prefix(uri().key())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5eac1c09da1f13b8f9e69a6d00510e353e02ecc5"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad7aacfb40f13202ccb9f20cad514d18075d5565", "author": {"user": {"login": "jackye1995", "name": "Jack Ye"}}, "url": "https://github.com/apache/iceberg/commit/ad7aacfb40f13202ccb9f20cad514d18075d5565", "committedDate": "2020-12-02T23:13:02Z", "message": "remove call to HEAD"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzIwODU0", "url": "https://github.com/apache/iceberg/pull/1863#pullrequestreview-543320854", "createdAt": "2020-12-02T23:22:35Z", "commit": {"oid": "ad7aacfb40f13202ccb9f20cad514d18075d5565"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMzoyMjozNVrOH9yWiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMzoyMjozNVrOH9yWiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU1MDE1NQ==", "bodyText": "I think this changes the exception behavior a little bit because now S3InputFile.getLength() will throw NPE as opposed to S3 NOT_FOUND in the event it does not exist and getLength() is called.  Not a huge issue, but we might consider improving that a little.", "url": "https://github.com/apache/iceberg/pull/1863#discussion_r534550155", "createdAt": "2020-12-02T23:22:35Z", "author": {"login": "danielcweeks"}, "path": "aws/src/main/java/org/apache/iceberg/aws/s3/BaseS3File.java", "diffHunk": "@@ -75,13 +76,14 @@ public boolean exists() {\n     }\n   }\n \n-  protected HeadObjectResponse getObjectMetadata() throws S3Exception {\n+  protected S3Object getObjectMetadata() throws S3Exception {\n     if (metadata == null) {\n-      HeadObjectRequest.Builder requestBuilder = HeadObjectRequest.builder()\n+      ListObjectsV2Response response = client().listObjectsV2(ListObjectsV2Request.builder()\n           .bucket(uri().bucket())\n-          .key(uri().key());\n-      S3RequestUtil.configureEncryption(awsProperties, requestBuilder);\n-      metadata = client().headObject(requestBuilder.build());\n+          .prefix(uri().key())\n+          .maxKeys(1)\n+          .build());\n+      metadata = response.hasContents() ? response.contents().get(0) : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad7aacfb40f13202ccb9f20cad514d18075d5565"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dc3f5d6c1b32adc3d6d08f14d3e8ec598aa9dc0", "author": {"user": {"login": "jackye1995", "name": "Jack Ye"}}, "url": "https://github.com/apache/iceberg/commit/8dc3f5d6c1b32adc3d6d08f14d3e8ec598aa9dc0", "committedDate": "2020-12-02T23:40:45Z", "message": "fix list wrong file with the same suffix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "903f6441fb358291492ded571cdd8cc7aa9df8cd", "author": {"user": {"login": "jackye1995", "name": "Jack Ye"}}, "url": "https://github.com/apache/iceberg/commit/903f6441fb358291492ded571cdd8cc7aa9df8cd", "committedDate": "2020-12-03T00:06:18Z", "message": "check file exists when getting length"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzcwMzI5", "url": "https://github.com/apache/iceberg/pull/1863#pullrequestreview-543370329", "createdAt": "2020-12-03T01:24:45Z", "commit": {"oid": "903f6441fb358291492ded571cdd8cc7aa9df8cd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MTY3NjA0", "url": "https://github.com/apache/iceberg/pull/1863#pullrequestreview-544167604", "createdAt": "2020-12-03T16:48:33Z", "commit": {"oid": "903f6441fb358291492ded571cdd8cc7aa9df8cd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3491, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}