{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMDQyMzA5", "number": 1367, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo0Mzo0MFrOEq2jng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1NDo0N1rOEq2z6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzY5NTAyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/SnapshotSummary.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo0Mzo0MFrOHdS_0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODowMDoyOVrOHdToXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4MjAwMw==", "bodyText": "Is this because we don't know how many records an equality delete removes?", "url": "https://github.com/apache/iceberg/pull/1367#discussion_r500482003", "createdAt": "2020-10-06T17:43:40Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/SnapshotSummary.java", "diffHunk": "@@ -161,27 +176,154 @@ public void merge(SnapshotSummary.Builder builder) {\n       // copy custom summary properties\n       builder.putAll(properties);\n \n+      metrics.addTo(builder);\n+      setIf(deletedDuplicateFiles > 0, builder, DELETED_DUPLICATE_FILES, deletedDuplicateFiles);\n+      Set<String> changedPartitions = partitionMetrics.keySet();\n+      setIf(trustPartitionMetrics, builder, CHANGED_PARTITION_COUNT_PROP, changedPartitions.size());\n+\n+      if (trustPartitionMetrics && changedPartitions.size() <= maxChangedPartitionsForSummaries) {\n+        setIf(changedPartitions.size() > 0, builder, PARTITION_SUMMARY_PROP, \"true\");\n+        for (String key : changedPartitions) {\n+          setIf(key != null, builder, CHANGED_PARTITION_PREFIX + key, partitionSummary(partitionMetrics.get(key)));\n+        }\n+      }\n+\n+      return builder.build();\n+    }\n+\n+    private static String partitionSummary(UpdateMetrics metrics) {\n+      ImmutableMap.Builder<String, String> partBuilder = ImmutableMap.builder();\n+      metrics.addTo(partBuilder);\n+      return MAP_JOINER.join(partBuilder.build());\n+    }\n+  }\n+\n+  private static class UpdateMetrics {\n+    private long addedSize = 0L;\n+    private long removedSize = 0L;\n+    private int addedFiles = 0;\n+    private int removedFiles = 0;\n+    private int addedDeleteFiles = 0;\n+    private int removedDeleteFiles = 0;\n+    private long addedRecords = 0L;\n+    private long deletedRecords = 0L;\n+    private long addedPosDeletes = 0L;\n+    private long removedPosDeletes = 0L;\n+    private long addedEqDeletes = 0L;\n+    private long removedEqDeletes = 0L;\n+    private boolean trustSizeAndDeleteCounts = true;\n+\n+    void clear() {\n+      this.addedSize = 0L;\n+      this.removedSize = 0L;\n+      this.addedFiles = 0;\n+      this.removedFiles = 0;\n+      this.addedDeleteFiles = 0;\n+      this.removedDeleteFiles = 0;\n+      this.addedRecords = 0L;\n+      this.deletedRecords = 0L;\n+      this.addedPosDeletes = 0L;\n+      this.removedPosDeletes = 0L;\n+      this.addedEqDeletes = 0L;\n+      this.removedEqDeletes = 0L;\n+      this.trustSizeAndDeleteCounts = true;\n+    }\n+\n+    void addTo(ImmutableMap.Builder<String, String> builder) {\n       setIf(addedFiles > 0, builder, ADDED_FILES_PROP, addedFiles);\n-      setIf(deletedFiles > 0, builder, DELETED_FILES_PROP, deletedFiles);\n+      setIf(removedFiles > 0, builder, DELETED_FILES_PROP, removedFiles);\n       setIf(addedDeleteFiles > 0, builder, ADDED_DELETE_FILES_PROP, addedDeleteFiles);\n       setIf(removedDeleteFiles > 0, builder, REMOVED_DELETE_FILES_PROP, removedDeleteFiles);\n-      setIf(deletedDuplicateFiles > 0, builder, DELETED_DUPLICATE_FILES, deletedDuplicateFiles);\n       setIf(addedRecords > 0, builder, ADDED_RECORDS_PROP, addedRecords);\n       setIf(deletedRecords > 0, builder, DELETED_RECORDS_PROP, deletedRecords);\n-      setIf(addedPosDeletes > 0, builder, ADDED_POS_DELETES_PROP, addedPosDeletes);\n-      setIf(removedPosDeletes > 0, builder, REMOVED_POS_DELETES_PROP, removedPosDeletes);\n-      setIf(addedEqDeletes > 0, builder, ADDED_EQ_DELETES_PROP, addedEqDeletes);\n-      setIf(removedEqDeletes > 0, builder, REMOVED_EQ_DELETES_PROP, removedEqDeletes);\n-      setIf(true, builder, CHANGED_PARTITION_COUNT_PROP, changedPartitions.size());\n \n-      return builder.build();\n+      if (trustSizeAndDeleteCounts) {\n+        setIf(addedSize > 0, builder, ADDED_FILE_SIZE_PROP, addedSize);\n+        setIf(removedSize > 0, builder, REMOVED_FILE_SIZE_PROP, removedSize);\n+        setIf(addedPosDeletes > 0, builder, ADDED_POS_DELETES_PROP, addedPosDeletes);\n+        setIf(removedPosDeletes > 0, builder, REMOVED_POS_DELETES_PROP, removedPosDeletes);\n+        setIf(addedEqDeletes > 0, builder, ADDED_EQ_DELETES_PROP, addedEqDeletes);\n+        setIf(removedEqDeletes > 0, builder, REMOVED_EQ_DELETES_PROP, removedEqDeletes);\n+      }\n     }\n \n-    private static void setIf(boolean expression, ImmutableMap.Builder<String, String> builder,\n-                              String property, Object value) {\n-      if (expression) {\n-        builder.put(property, String.valueOf(value));\n+    void addedFile(ContentFile<?> file) {\n+      this.addedSize += file.fileSizeInBytes();\n+      switch (file.content()) {\n+        case DATA:\n+          this.addedFiles += 1;\n+          this.addedRecords += file.recordCount();\n+          break;\n+        case POSITION_DELETES:\n+          this.addedDeleteFiles += 1;\n+          this.addedPosDeletes += file.recordCount();\n+          break;\n+        case EQUALITY_DELETES:\n+          this.addedDeleteFiles += 1;\n+          this.addedEqDeletes += file.recordCount();\n+          break;\n+        default:\n+          throw new UnsupportedOperationException(\"Unsupported file content type: \" + file.content());\n       }\n     }\n+\n+    void removedFile(ContentFile<?> file) {\n+      this.removedSize += file.fileSizeInBytes();\n+      switch (file.content()) {\n+        case DATA:\n+          this.removedFiles += 1;\n+          this.deletedRecords += file.recordCount();\n+          break;\n+        case POSITION_DELETES:\n+          this.removedDeleteFiles += 1;\n+          this.removedPosDeletes += file.recordCount();\n+          break;\n+        case EQUALITY_DELETES:\n+          this.removedDeleteFiles += 1;\n+          this.removedEqDeletes += file.recordCount();\n+          break;\n+        default:\n+          throw new UnsupportedOperationException(\"Unsupported file content type: \" + file.content());\n+      }\n+    }\n+\n+    void addedManifest(ManifestFile manifest) {\n+      switch (manifest.content()) {\n+        case DATA:\n+          this.addedFiles += manifest.addedFilesCount();\n+          this.addedRecords += manifest.addedRowsCount();\n+          this.removedFiles += manifest.deletedFilesCount();\n+          this.deletedRecords += manifest.deletedRowsCount();\n+          break;\n+        case DELETES:\n+          this.addedDeleteFiles += manifest.addedFilesCount();\n+          this.removedDeleteFiles += manifest.deletedFilesCount();\n+          this.trustSizeAndDeleteCounts = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d59d6b85d7d958b75112aafff68e94cba1a937"}, "originalPosition": 326}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ5MjM4Mw==", "bodyText": "Actually, no. It is because we don't have row counts for the number of equality and positional deletes in delete manifests.", "url": "https://github.com/apache/iceberg/pull/1367#discussion_r500492383", "createdAt": "2020-10-06T18:00:29Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/SnapshotSummary.java", "diffHunk": "@@ -161,27 +176,154 @@ public void merge(SnapshotSummary.Builder builder) {\n       // copy custom summary properties\n       builder.putAll(properties);\n \n+      metrics.addTo(builder);\n+      setIf(deletedDuplicateFiles > 0, builder, DELETED_DUPLICATE_FILES, deletedDuplicateFiles);\n+      Set<String> changedPartitions = partitionMetrics.keySet();\n+      setIf(trustPartitionMetrics, builder, CHANGED_PARTITION_COUNT_PROP, changedPartitions.size());\n+\n+      if (trustPartitionMetrics && changedPartitions.size() <= maxChangedPartitionsForSummaries) {\n+        setIf(changedPartitions.size() > 0, builder, PARTITION_SUMMARY_PROP, \"true\");\n+        for (String key : changedPartitions) {\n+          setIf(key != null, builder, CHANGED_PARTITION_PREFIX + key, partitionSummary(partitionMetrics.get(key)));\n+        }\n+      }\n+\n+      return builder.build();\n+    }\n+\n+    private static String partitionSummary(UpdateMetrics metrics) {\n+      ImmutableMap.Builder<String, String> partBuilder = ImmutableMap.builder();\n+      metrics.addTo(partBuilder);\n+      return MAP_JOINER.join(partBuilder.build());\n+    }\n+  }\n+\n+  private static class UpdateMetrics {\n+    private long addedSize = 0L;\n+    private long removedSize = 0L;\n+    private int addedFiles = 0;\n+    private int removedFiles = 0;\n+    private int addedDeleteFiles = 0;\n+    private int removedDeleteFiles = 0;\n+    private long addedRecords = 0L;\n+    private long deletedRecords = 0L;\n+    private long addedPosDeletes = 0L;\n+    private long removedPosDeletes = 0L;\n+    private long addedEqDeletes = 0L;\n+    private long removedEqDeletes = 0L;\n+    private boolean trustSizeAndDeleteCounts = true;\n+\n+    void clear() {\n+      this.addedSize = 0L;\n+      this.removedSize = 0L;\n+      this.addedFiles = 0;\n+      this.removedFiles = 0;\n+      this.addedDeleteFiles = 0;\n+      this.removedDeleteFiles = 0;\n+      this.addedRecords = 0L;\n+      this.deletedRecords = 0L;\n+      this.addedPosDeletes = 0L;\n+      this.removedPosDeletes = 0L;\n+      this.addedEqDeletes = 0L;\n+      this.removedEqDeletes = 0L;\n+      this.trustSizeAndDeleteCounts = true;\n+    }\n+\n+    void addTo(ImmutableMap.Builder<String, String> builder) {\n       setIf(addedFiles > 0, builder, ADDED_FILES_PROP, addedFiles);\n-      setIf(deletedFiles > 0, builder, DELETED_FILES_PROP, deletedFiles);\n+      setIf(removedFiles > 0, builder, DELETED_FILES_PROP, removedFiles);\n       setIf(addedDeleteFiles > 0, builder, ADDED_DELETE_FILES_PROP, addedDeleteFiles);\n       setIf(removedDeleteFiles > 0, builder, REMOVED_DELETE_FILES_PROP, removedDeleteFiles);\n-      setIf(deletedDuplicateFiles > 0, builder, DELETED_DUPLICATE_FILES, deletedDuplicateFiles);\n       setIf(addedRecords > 0, builder, ADDED_RECORDS_PROP, addedRecords);\n       setIf(deletedRecords > 0, builder, DELETED_RECORDS_PROP, deletedRecords);\n-      setIf(addedPosDeletes > 0, builder, ADDED_POS_DELETES_PROP, addedPosDeletes);\n-      setIf(removedPosDeletes > 0, builder, REMOVED_POS_DELETES_PROP, removedPosDeletes);\n-      setIf(addedEqDeletes > 0, builder, ADDED_EQ_DELETES_PROP, addedEqDeletes);\n-      setIf(removedEqDeletes > 0, builder, REMOVED_EQ_DELETES_PROP, removedEqDeletes);\n-      setIf(true, builder, CHANGED_PARTITION_COUNT_PROP, changedPartitions.size());\n \n-      return builder.build();\n+      if (trustSizeAndDeleteCounts) {\n+        setIf(addedSize > 0, builder, ADDED_FILE_SIZE_PROP, addedSize);\n+        setIf(removedSize > 0, builder, REMOVED_FILE_SIZE_PROP, removedSize);\n+        setIf(addedPosDeletes > 0, builder, ADDED_POS_DELETES_PROP, addedPosDeletes);\n+        setIf(removedPosDeletes > 0, builder, REMOVED_POS_DELETES_PROP, removedPosDeletes);\n+        setIf(addedEqDeletes > 0, builder, ADDED_EQ_DELETES_PROP, addedEqDeletes);\n+        setIf(removedEqDeletes > 0, builder, REMOVED_EQ_DELETES_PROP, removedEqDeletes);\n+      }\n     }\n \n-    private static void setIf(boolean expression, ImmutableMap.Builder<String, String> builder,\n-                              String property, Object value) {\n-      if (expression) {\n-        builder.put(property, String.valueOf(value));\n+    void addedFile(ContentFile<?> file) {\n+      this.addedSize += file.fileSizeInBytes();\n+      switch (file.content()) {\n+        case DATA:\n+          this.addedFiles += 1;\n+          this.addedRecords += file.recordCount();\n+          break;\n+        case POSITION_DELETES:\n+          this.addedDeleteFiles += 1;\n+          this.addedPosDeletes += file.recordCount();\n+          break;\n+        case EQUALITY_DELETES:\n+          this.addedDeleteFiles += 1;\n+          this.addedEqDeletes += file.recordCount();\n+          break;\n+        default:\n+          throw new UnsupportedOperationException(\"Unsupported file content type: \" + file.content());\n       }\n     }\n+\n+    void removedFile(ContentFile<?> file) {\n+      this.removedSize += file.fileSizeInBytes();\n+      switch (file.content()) {\n+        case DATA:\n+          this.removedFiles += 1;\n+          this.deletedRecords += file.recordCount();\n+          break;\n+        case POSITION_DELETES:\n+          this.removedDeleteFiles += 1;\n+          this.removedPosDeletes += file.recordCount();\n+          break;\n+        case EQUALITY_DELETES:\n+          this.removedDeleteFiles += 1;\n+          this.removedEqDeletes += file.recordCount();\n+          break;\n+        default:\n+          throw new UnsupportedOperationException(\"Unsupported file content type: \" + file.content());\n+      }\n+    }\n+\n+    void addedManifest(ManifestFile manifest) {\n+      switch (manifest.content()) {\n+        case DATA:\n+          this.addedFiles += manifest.addedFilesCount();\n+          this.addedRecords += manifest.addedRowsCount();\n+          this.removedFiles += manifest.deletedFilesCount();\n+          this.deletedRecords += manifest.deletedRowsCount();\n+          break;\n+        case DELETES:\n+          this.addedDeleteFiles += manifest.addedFilesCount();\n+          this.removedDeleteFiles += manifest.deletedFilesCount();\n+          this.trustSizeAndDeleteCounts = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4MjAwMw=="}, "originalCommit": {"oid": "36d59d6b85d7d958b75112aafff68e94cba1a937"}, "originalPosition": 326}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzczNjczOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/SnapshotSummary.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1NDo0N1rOHdTaUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1NDo0N1rOHdTaUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4ODc4NA==", "bodyText": "We still interpret this as the number of records in data files that were removed?", "url": "https://github.com/apache/iceberg/pull/1367#discussion_r500488784", "createdAt": "2020-10-06T17:54:47Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/SnapshotSummary.java", "diffHunk": "@@ -35,6 +36,8 @@\n   public static final String ADDED_RECORDS_PROP = \"added-records\";\n   public static final String DELETED_RECORDS_PROP = \"deleted-records\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d59d6b85d7d958b75112aafff68e94cba1a937"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3671, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}