{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5MTkzNTI0", "number": 1848, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzoyMDoxN1rOE-wddA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzoyMTo1NVrOE-wgNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MjQxMTQwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzoyMDoxN1rOH8Fb7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzoyMDoxN1rOH8Fb7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2NTY3Nw==", "bodyText": "How about \"default to timestamp\" or \"default to timestamp without time zone\"?", "url": "https://github.com/apache/iceberg/pull/1848#discussion_r532765677", "createdAt": "2020-11-30T17:20:17Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java", "diffHunk": "@@ -107,10 +107,14 @@ public static Schema buildAvroProjection(Schema schema, org.apache.iceberg.Schem\n \n   public static boolean isTimestamptz(Schema schema) {\n     LogicalType logicalType = schema.getLogicalType();\n-    if (logicalType != null && logicalType instanceof LogicalTypes.TimestampMicros) {\n+    if (logicalType instanceof LogicalTypes.TimestampMillis || logicalType instanceof LogicalTypes.TimestampMicros) {\n       // timestamptz is adjusted to UTC\n       Object value = schema.getObjectProp(ADJUST_TO_UTC_PROP);\n-      if (value instanceof Boolean) {\n+\n+      if (value == null) {\n+        // not all avro timestamp logical types will have the adjust_to_utc prop, default to not timestamptz", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a764afb8c2b00b9905f657054cbc9948829ce91"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MjQxODQ2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzoyMTo1NVrOH8FgNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozMDozNVrOH8IMrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2Njc3Mg==", "bodyText": "This is the same behavior as before because null would not pass either instanceof check. Do we need to update this other than to add instanceof TimestampMillis above?", "url": "https://github.com/apache/iceberg/pull/1848#discussion_r532766772", "createdAt": "2020-11-30T17:21:55Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java", "diffHunk": "@@ -107,10 +107,14 @@ public static Schema buildAvroProjection(Schema schema, org.apache.iceberg.Schem\n \n   public static boolean isTimestamptz(Schema schema) {\n     LogicalType logicalType = schema.getLogicalType();\n-    if (logicalType != null && logicalType instanceof LogicalTypes.TimestampMicros) {\n+    if (logicalType instanceof LogicalTypes.TimestampMillis || logicalType instanceof LogicalTypes.TimestampMicros) {\n       // timestamptz is adjusted to UTC\n       Object value = schema.getObjectProp(ADJUST_TO_UTC_PROP);\n-      if (value instanceof Boolean) {\n+\n+      if (value == null) {\n+        // not all avro timestamp logical types will have the adjust_to_utc prop, default to not timestamptz\n+        return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a764afb8c2b00b9905f657054cbc9948829ce91"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwNjcwNQ==", "bodyText": "WRT adding instanceof TimestampMillis that was an unrelated bug it seems.\nThere were two places a similar check was done AvroSchemaUtil.isTimestamptz (used by datareader/datawriters) and SchemaToType.primitive but the two places were not consistent. I am just making those two checks both use the same utility function.", "url": "https://github.com/apache/iceberg/pull/1848#discussion_r532806705", "createdAt": "2020-11-30T18:23:58Z", "author": {"login": "grantatspothero"}, "path": "core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java", "diffHunk": "@@ -107,10 +107,14 @@ public static Schema buildAvroProjection(Schema schema, org.apache.iceberg.Schem\n \n   public static boolean isTimestamptz(Schema schema) {\n     LogicalType logicalType = schema.getLogicalType();\n-    if (logicalType != null && logicalType instanceof LogicalTypes.TimestampMicros) {\n+    if (logicalType instanceof LogicalTypes.TimestampMillis || logicalType instanceof LogicalTypes.TimestampMicros) {\n       // timestamptz is adjusted to UTC\n       Object value = schema.getObjectProp(ADJUST_TO_UTC_PROP);\n-      if (value instanceof Boolean) {\n+\n+      if (value == null) {\n+        // not all avro timestamp logical types will have the adjust_to_utc prop, default to not timestamptz\n+        return false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2Njc3Mg=="}, "originalCommit": {"oid": "5a764afb8c2b00b9905f657054cbc9948829ce91"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMDkyNw==", "bodyText": "You are totally right this instanceof change is not strictly necessary, just makes it more explicit.\nThe bit that is important is the change in this file which before failed: core/src/main/java/org/apache/iceberg/avro/SchemaToType.java", "url": "https://github.com/apache/iceberg/pull/1848#discussion_r532810927", "createdAt": "2020-11-30T18:30:35Z", "author": {"login": "grantatspothero"}, "path": "core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java", "diffHunk": "@@ -107,10 +107,14 @@ public static Schema buildAvroProjection(Schema schema, org.apache.iceberg.Schem\n \n   public static boolean isTimestamptz(Schema schema) {\n     LogicalType logicalType = schema.getLogicalType();\n-    if (logicalType != null && logicalType instanceof LogicalTypes.TimestampMicros) {\n+    if (logicalType instanceof LogicalTypes.TimestampMillis || logicalType instanceof LogicalTypes.TimestampMicros) {\n       // timestamptz is adjusted to UTC\n       Object value = schema.getObjectProp(ADJUST_TO_UTC_PROP);\n-      if (value instanceof Boolean) {\n+\n+      if (value == null) {\n+        // not all avro timestamp logical types will have the adjust_to_utc prop, default to not timestamptz\n+        return false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2Njc3Mg=="}, "originalCommit": {"oid": "5a764afb8c2b00b9905f657054cbc9948829ce91"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3192, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}