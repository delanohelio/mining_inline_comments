{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4NDA3OTk1", "number": 891, "title": "Parquet: Use new logical type annotations", "bodyText": "Parquet 1.11.0 added logical type annotations that can be used to store Iceberg's adjustToUTC value like Avro, so that Parquet files correctly encode whether a value is a timestamp or a timestamptz.", "createdAt": "2020-04-03T22:09:13Z", "url": "https://github.com/apache/iceberg/pull/891", "merged": true, "mergeCommit": {"oid": "1d13a10d4c8a1174083eb81373310b8499f84f44"}, "closed": true, "closedAt": "2020-05-07T20:01:46Z", "author": {"login": "rdblue"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWflPagFqTM5MTc0MDYwMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfCgL5ABqjMzMTQzNTU3NTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzQwNjAy", "url": "https://github.com/apache/iceberg/pull/891#pullrequestreview-391740602", "createdAt": "2020-04-11T06:20:09Z", "commit": {"oid": "d173d283bcf321715c34f0c5953c7ad86ecfc6cb"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3ODQ3ODM5", "url": "https://github.com/apache/iceberg/pull/891#pullrequestreview-397847839", "createdAt": "2020-04-22T05:11:26Z", "commit": {"oid": "d173d283bcf321715c34f0c5953c7ad86ecfc6cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNToxMToyNlrOGJjpig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNToxMToyNlrOGJjpig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY3NDQ0Mg==", "bodyText": "In Parquet, LogicalTypeAnnotation.java, there is LogicalTypeAnnotation.IntLogicalTypeAnnotation. Do we need it here too?", "url": "https://github.com/apache/iceberg/pull/891#discussion_r412674442", "createdAt": "2020-04-22T05:11:26Z", "author": {"login": "wangmiao1981"}, "path": "data/src/main/java/org/apache/iceberg/data/parquet/GenericParquetWriter.java", "diffHunk": "@@ -200,6 +210,70 @@ private GenericParquetWriter() {\n     }\n   }\n \n+  private static class LogicalTypeWriterVisitor implements LogicalTypeAnnotationVisitor<PrimitiveWriter<?>> {\n+    private final ColumnDescriptor desc;\n+\n+    private LogicalTypeWriterVisitor(ColumnDescriptor desc) {\n+      this.desc = desc;\n+    }\n+\n+    @Override\n+    public Optional<PrimitiveWriter<?>> visit(LogicalTypeAnnotation.StringLogicalTypeAnnotation stringType) {\n+      return Optional.of(ParquetValueWriters.strings(desc));\n+    }\n+\n+    @Override\n+    public Optional<PrimitiveWriter<?>> visit(LogicalTypeAnnotation.EnumLogicalTypeAnnotation enumType) {\n+      return Optional.of(ParquetValueWriters.strings(desc));\n+    }\n+\n+    @Override\n+    public Optional<PrimitiveWriter<?>> visit(LogicalTypeAnnotation.DecimalLogicalTypeAnnotation decimalType) {\n+      switch (desc.getPrimitiveType().getPrimitiveTypeName()) {\n+        case INT32:\n+          return Optional.of(ParquetValueWriters.decimalAsInteger(\n+              desc, decimalType.getPrecision(), decimalType.getScale()));\n+        case INT64:\n+          return Optional.of(ParquetValueWriters.decimalAsLong(\n+              desc, decimalType.getPrecision(), decimalType.getScale()));\n+        case BINARY:\n+        case FIXED_LEN_BYTE_ARRAY:\n+          return Optional.of(ParquetValueWriters.decimalAsFixed(\n+              desc, decimalType.getPrecision(), decimalType.getScale()));\n+      }\n+      return Optional.empty();\n+    }\n+\n+    @Override\n+    public Optional<PrimitiveWriter<?>> visit(LogicalTypeAnnotation.DateLogicalTypeAnnotation dateType) {\n+      return Optional.of(new DateWriter(desc));\n+    }\n+\n+    @Override\n+    public Optional<PrimitiveWriter<?>> visit(LogicalTypeAnnotation.TimeLogicalTypeAnnotation timeType) {\n+      return Optional.of(new TimeWriter(desc));\n+    }\n+\n+    @Override\n+    public Optional<PrimitiveWriter<?>> visit(LogicalTypeAnnotation.TimestampLogicalTypeAnnotation timestampType) {\n+      if (timestampType.isAdjustedToUTC()) {\n+        return Optional.of(new TimestamptzWriter(desc));\n+      } else {\n+        return Optional.of(new TimestampWriter(desc));\n+      }\n+    }\n+\n+    @Override\n+    public Optional<PrimitiveWriter<?>> visit(LogicalTypeAnnotation.JsonLogicalTypeAnnotation jsonLogicalType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d173d283bcf321715c34f0c5953c7ad86ecfc6cb"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDcxNDA4", "url": "https://github.com/apache/iceberg/pull/891#pullrequestreview-400471408", "createdAt": "2020-04-26T07:48:06Z", "commit": {"oid": "d173d283bcf321715c34f0c5953c7ad86ecfc6cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQwNzo0ODowN1rOGMAivw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQwNzo0ODowN1rOGMAivw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI0NDk5MQ==", "bodyText": "When writer.isPresent() == false, we falls back to the previous logic, right?", "url": "https://github.com/apache/iceberg/pull/891#discussion_r415244991", "createdAt": "2020-04-26T07:48:07Z", "author": {"login": "waterlx"}, "path": "data/src/main/java/org/apache/iceberg/data/parquet/GenericParquetWriter.java", "diffHunk": "@@ -117,6 +120,13 @@ private GenericParquetWriter() {\n     @Override\n     public ParquetValueWriter<?> primitive(PrimitiveType primitive) {\n       ColumnDescriptor desc = type.getColumnDescription(currentPath());\n+      LogicalTypeAnnotation logicalType = primitive.getLogicalTypeAnnotation();\n+      if (logicalType != null) {\n+        Optional<PrimitiveWriter<?>> writer = logicalType.accept(new LogicalTypeWriterVisitor(desc));\n+        if (writer.isPresent()) {\n+          return writer.get();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d173d283bcf321715c34f0c5953c7ad86ecfc6cb"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d173d283bcf321715c34f0c5953c7ad86ecfc6cb", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/d173d283bcf321715c34f0c5953c7ad86ecfc6cb", "committedDate": "2020-04-03T22:05:20Z", "message": "Parquet: Use new logical type annotations."}, "afterCommit": {"oid": "286e69ac772015804d28c8459b8e48bda3a47729", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/286e69ac772015804d28c8459b8e48bda3a47729", "committedDate": "2020-05-05T17:21:19Z", "message": "Remove work-arounds for Parquet 1.10.x."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aa55b9d49b7d3f4bd7cb00f9152093607643735", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/8aa55b9d49b7d3f4bd7cb00f9152093607643735", "committedDate": "2020-05-07T19:23:24Z", "message": "Parquet: Use new logical type annotations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7651406d7d85f5ff6b58d4e274dac953534a4c33", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/7651406d7d85f5ff6b58d4e274dac953534a4c33", "committedDate": "2020-05-07T19:23:24Z", "message": "Remove work-arounds for Parquet 1.10.x."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b8b638a576a1ea6c4f4256b7dd4af1fe51a9c39", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/7b8b638a576a1ea6c4f4256b7dd4af1fe51a9c39", "committedDate": "2020-05-07T19:28:17Z", "message": "Remove originalType switch when using logical type visitor."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ff9cba9ae0e7a61ddae497159c49af8bcc24d0e", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/7ff9cba9ae0e7a61ddae497159c49af8bcc24d0e", "committedDate": "2020-05-05T17:38:11Z", "message": "Remove originalType switch when using logical type visitor."}, "afterCommit": {"oid": "7b8b638a576a1ea6c4f4256b7dd4af1fe51a9c39", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/7b8b638a576a1ea6c4f4256b7dd4af1fe51a9c39", "committedDate": "2020-05-07T19:28:17Z", "message": "Remove originalType switch when using logical type visitor."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4759, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}