{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NDMxMTg5", "number": 1241, "title": "Plumbing to add extra custom metadata to snapshot summary", "bodyText": "Plumbing to add extra custom metadata to snapshot summary via write options #1242\nContext: At Stripe we make use of airflow to run spark jobs, and want to pass a separate external ID and some versioning information linking an airflow run for each snapshot created. Currently to do this, we have to fork the Writer just to override the commitOperation.\nThe changes in this PR would allow custom metadata via write options which start with a particular prefix (extra-metadata.).\ncc? @rdblue", "createdAt": "2020-07-24T18:35:29Z", "url": "https://github.com/apache/iceberg/pull/1241", "merged": true, "mergeCommit": {"oid": "bf7edc4b325df6dd80d86fea0149d2be0ad09468"}, "closed": true, "closedAt": "2020-07-24T22:21:16Z", "author": {"login": "moulimukherjee"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4IT_ZgH2gAyNDU2NDMxMTg5OjEyMjM5YjljMWMxNjcwOWNjMGQ4ZTBkNDhiMTdmOWMwZTQzYzNkYTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4LMtqgH2gAyNDU2NDMxMTg5OjE5NjA1NjBhZTgwM2Y3ZjNkMDkyMDk5YzU2NjNjNDA2YWIwMDRmNmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "12239b9c1c16709cc0d8e0d48b17f9c0e43c3da4", "author": {"user": {"login": "mouli-stripe", "name": "Mouli Mukherjee"}}, "url": "https://github.com/apache/iceberg/commit/12239b9c1c16709cc0d8e0d48b17f9c0e43c3da4", "committedDate": "2020-07-24T18:26:55Z", "message": "Plumbing to add extra custom metadata to snapshot summary via write options"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTA0NzM2", "url": "https://github.com/apache/iceberg/pull/1241#pullrequestreview-455104736", "createdAt": "2020-07-24T18:36:25Z", "commit": {"oid": "12239b9c1c16709cc0d8e0d48b17f9c0e43c3da4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxODozNjoyNlrOG250fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxODozNjoyNlrOG250fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyMzYxMg==", "bodyText": "happy to change if a different prefix string would be more suitable", "url": "https://github.com/apache/iceberg/pull/1241#discussion_r460223612", "createdAt": "2020-07-24T18:36:26Z", "author": {"login": "moulimukherjee"}, "path": "core/src/main/java/org/apache/iceberg/SnapshotSummary.java", "diffHunk": "@@ -47,6 +47,7 @@\n   public static final String PUBLISHED_WAP_ID_PROP = \"published-wap-id\";\n   public static final String SOURCE_SNAPSHOT_ID_PROP = \"source-snapshot-id\";\n   public static final String REPLACE_PARTITIONS_PROP = \"replace-partitions\";\n+  public static final String EXTRA_METADATA_PREFIX = \"extra-metadata.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12239b9c1c16709cc0d8e0d48b17f9c0e43c3da4"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTE2MDc2", "url": "https://github.com/apache/iceberg/pull/1241#pullrequestreview-455116076", "createdAt": "2020-07-24T18:56:33Z", "commit": {"oid": "12239b9c1c16709cc0d8e0d48b17f9c0e43c3da4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxODo1NjozM1rOG26X8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxODo1NjozM1rOG26X8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzMjY5MQ==", "bodyText": "plumbing to pass extra information from write options", "url": "https://github.com/apache/iceberg/pull/1241#discussion_r460232691", "createdAt": "2020-07-24T18:56:33Z", "author": {"login": "moulimukherjee"}, "path": "spark/src/test/java/org/apache/iceberg/spark/source/TestDataSourceOptions.java", "diffHunk": "@@ -364,4 +364,28 @@ public void testDefaultMetadataSplitSize() throws IOException {\n     int partitionNum = metadataDf.javaRDD().getNumPartitions();\n     Assert.assertEquals(\"Spark partitions should match\", expectedSplits, partitionNum);\n   }\n+\n+  @Test\n+  public void testExtraSnapshotMetadata() throws IOException {\n+    String tableLocation = temp.newFolder(\"iceberg-table\").toString();\n+    HadoopTables tables = new HadoopTables(CONF);\n+    tables.create(SCHEMA, PartitionSpec.unpartitioned(), Maps.newHashMap(), tableLocation);\n+\n+    List<SimpleRecord> expectedRecords = Lists.newArrayList(\n+            new SimpleRecord(1, \"a\"),\n+            new SimpleRecord(2, \"b\")\n+    );\n+    Dataset<Row> originalDf = spark.createDataFrame(expectedRecords, SimpleRecord.class);\n+    originalDf.select(\"id\", \"data\").write()\n+            .format(\"iceberg\")\n+            .mode(\"append\")\n+            .option(\"extra-metadata.extra-key\", \"someValue\")\n+            .option(\"extra-metadata.another-key\", \"anotherValue\")\n+            .save(tableLocation);\n+\n+    Table table = tables.load(tableLocation);\n+\n+    Assert.assertTrue(table.currentSnapshot().summary().get(\"extra-key\").equals(\"someValue\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12239b9c1c16709cc0d8e0d48b17f9c0e43c3da4"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86c580f17d6f987ea761cf45c4e604f189138338", "author": {"user": {"login": "mouli-stripe", "name": "Mouli Mukherjee"}}, "url": "https://github.com/apache/iceberg/commit/86c580f17d6f987ea761cf45c4e604f189138338", "committedDate": "2020-07-24T19:12:17Z", "message": "Fix style issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ad56471c99dafc4e0db647e14ea287766ced98d", "author": {"user": {"login": "mouli-stripe", "name": "Mouli Mukherjee"}}, "url": "https://github.com/apache/iceberg/commit/7ad56471c99dafc4e0db647e14ea287766ced98d", "committedDate": "2020-07-24T21:15:18Z", "message": "Rename prefix string to snapshot.property."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "824b2d3ff0781bdcd3a3075179cb6b7583134fac", "author": {"user": {"login": "mouli-stripe", "name": "Mouli Mukherjee"}}, "url": "https://github.com/apache/iceberg/commit/824b2d3ff0781bdcd3a3075179cb6b7583134fac", "committedDate": "2020-07-24T21:39:22Z", "message": "Updating docs to mention snapshot-property."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1960560ae803f7f3d092099c5663c406ab004f6a", "author": {"user": {"login": "mouli-stripe", "name": "Mouli Mukherjee"}}, "url": "https://github.com/apache/iceberg/commit/1960560ae803f7f3d092099c5663c406ab004f6a", "committedDate": "2020-07-24T21:48:41Z", "message": "changing angle brackets to italics"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4327, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}