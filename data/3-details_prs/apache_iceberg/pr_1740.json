{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NjQ5OTAy", "number": 1740, "title": "Fix casting issues when joining two Iceberg tables together on Tez", "bodyText": "The following casting exceptions were observed when joining two Iceberg tables on Tez:\n\n\njava.math.BigDecimal cannot be cast to org.apache.hadoop.hive.common.type.HiveDecimal\n\n\njava.time.OffsetDateTime cannot be cast to org.apache.hadoop.hive.common.type.Timestamp\n\n\njava.nio.HeapByteBuffer cannot be cast to [B\n\n\njava.time.LocalDate cannot be cast to org.apache.hadoop.hive.common.type.Date\n\n\nDoesn't happen with Iceberg table - non-Iceberg table joins, or with order by queries on a single table.", "createdAt": "2020-11-09T10:17:56Z", "url": "https://github.com/apache/iceberg/pull/1740", "merged": true, "mergeCommit": {"oid": "d2a9add009a4fc0ae93b33a5523ca510c2227f25"}, "closed": true, "closedAt": "2020-11-11T00:40:18Z", "author": {"login": "lcspinter"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdayNwsgBqjM5NzMwMTQ4NzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbLLZuABqjM5Nzk1NDQ5Mjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f28983e31e641f2ed0de3fd6fe41e3d8b9d05b3d", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/f28983e31e641f2ed0de3fd6fe41e3d8b9d05b3d", "committedDate": "2020-11-09T10:14:07Z", "message": "Fix casting issues when joining two Iceberg tables together on Tez"}, "afterCommit": {"oid": "f15a7cc7f76c7affba3617198092dfb5a97bd6b6", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/f15a7cc7f76c7affba3617198092dfb5a97bd6b6", "committedDate": "2020-11-09T10:29:18Z", "message": "Fix casting issues when joining two Iceberg tables together on Tez"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzQxOTMw", "url": "https://github.com/apache/iceberg/pull/1740#pullrequestreview-526741930", "createdAt": "2020-11-09T23:40:45Z", "commit": {"oid": "f15a7cc7f76c7affba3617198092dfb5a97bd6b6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzo0MDo0NlrOHwF8pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzo0MDo0NlrOHwF8pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5MTE0MQ==", "bodyText": "Why would this be called to copy a non-Date object?", "url": "https://github.com/apache/iceberg/pull/1740#discussion_r520191141", "createdAt": "2020-11-09T23:40:46Z", "author": {"login": "rdblue"}, "path": "hive3/src/main/java/org/apache/iceberg/mr/hive/serde/objectinspector/IcebergDateObjectInspectorHive3.java", "diffHunk": "@@ -56,7 +56,15 @@ public DateWritableV2 getPrimitiveWritableObject(Object o) {\n \n   @Override\n   public Object copyObject(Object o) {\n-    return o == null ? null : new Date((Date) o);\n+    if (o == null) {\n+      return null;\n+    }\n+\n+    if (o instanceof Date) {\n+      return new Date((Date) o);\n+    } else {\n+      return o;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f15a7cc7f76c7affba3617198092dfb5a97bd6b6"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzQzNjgw", "url": "https://github.com/apache/iceberg/pull/1740#pullrequestreview-526743680", "createdAt": "2020-11-09T23:44:48Z", "commit": {"oid": "f15a7cc7f76c7affba3617198092dfb5a97bd6b6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzo0NDo0OFrOHwGCRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzo0NDo0OFrOHwGCRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5MjU4Mg==", "bodyText": "Could you rewrite this as a new test case with a list of types to test?\nWe consider it a best practice to start new test cases rather than adding to existing, complete cases. Each test method is run independently so you see more of the failures that way. By making longer test methods with more than one case, failures can prevent other tests from even running.\nI think it would be fine to use a loop over types in a single new case, since most of the code is the same for these.", "url": "https://github.com/apache/iceberg/pull/1740#discussion_r520192582", "createdAt": "2020-11-09T23:44:48Z", "author": {"login": "rdblue"}, "path": "mr/src/test/java/org/apache/iceberg/mr/hive/HiveIcebergStorageHandlerBaseTest.java", "diffHunk": "@@ -211,6 +212,11 @@ public void testJoinTables() throws IOException {\n     Assert.assertArrayEquals(new Object[] {0L, \"Alice\", 100L, 11.11d}, rows.get(0));\n     Assert.assertArrayEquals(new Object[] {0L, \"Alice\", 101L, 22.22d}, rows.get(1));\n     Assert.assertArrayEquals(new Object[] {1L, \"Bob\", 102L, 33.33d}, rows.get(2));\n+\n+    joinTables(\"decimaltable\", \"decimal_col\", Types.DecimalType.of(3, 1));\n+    joinTables(\"timestamptable\", \"timestamp_col\", Types.TimestampType.withZone());\n+    joinTables(\"binarytable\", \"binary_col\", Types.BinaryType.get());\n+    joinTables(\"datetable\", \"date_col\", Types.DateType.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f15a7cc7f76c7affba3617198092dfb5a97bd6b6"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9794035a6c4596bad77ce3aff121aef5aa13239", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/f9794035a6c4596bad77ce3aff121aef5aa13239", "committedDate": "2020-11-10T14:32:28Z", "message": "Fix casting issues when joining two Iceberg tables together on Tez"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d95aaafd85ddad90993d3aece067cb06efee648", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/9d95aaafd85ddad90993d3aece067cb06efee648", "committedDate": "2020-11-10T14:20:03Z", "message": "Review changes"}, "afterCommit": {"oid": "f41d5fa2680f79bf4d8b306fd6e41e031397d628", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/f41d5fa2680f79bf4d8b306fd6e41e031397d628", "committedDate": "2020-11-10T14:32:28Z", "message": "Review changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f41d5fa2680f79bf4d8b306fd6e41e031397d628", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/f41d5fa2680f79bf4d8b306fd6e41e031397d628", "committedDate": "2020-11-10T14:32:28Z", "message": "Review changes"}, "afterCommit": {"oid": "217b0b26c922439c3be84c956a2e2e52eb1bc7e1", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/217b0b26c922439c3be84c956a2e2e52eb1bc7e1", "committedDate": "2020-11-10T15:01:43Z", "message": "Review changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f667f640dcaa2a3a979f137655b475ecd208ff95", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/f667f640dcaa2a3a979f137655b475ecd208ff95", "committedDate": "2020-11-10T15:34:13Z", "message": "Review changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "217b0b26c922439c3be84c956a2e2e52eb1bc7e1", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/217b0b26c922439c3be84c956a2e2e52eb1bc7e1", "committedDate": "2020-11-10T15:01:43Z", "message": "Review changes"}, "afterCommit": {"oid": "f667f640dcaa2a3a979f137655b475ecd208ff95", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/f667f640dcaa2a3a979f137655b475ecd208ff95", "committedDate": "2020-11-10T15:34:13Z", "message": "Review changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3711, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}