{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNDMwNTk0", "number": 789, "title": "Fix race condition in SnapshotProducer", "bodyText": "This PR fixes a race condition in SnapshotProducer while generating a new snapshot id.\nAs it turns out,  we can use different snapshot ids in MergingSnapshotProducer while writing filtered manifests. That can lead to loosing certain manifests that contain only deleted files, which, in turn, will corrupt the table stats.\nTake a look at the last line of this snippet in MergingSnapshotProducer:\n// filter any existing manifests\nList<ManifestFile> filtered;\nif (current != null) {\n List<ManifestFile> manifests = current.manifests();\n filtered = Arrays.asList(filterManifests(metricsEvaluator, manifests));\n} else {\n filtered = ImmutableList.of();\n}\n\nIterable<ManifestFile> unmergedManifests = Iterables.filter(\n    Iterables.concat(newManifestsWithMetadata, filtered),\n    // only keep manifests that have live data files or that were written by this commit\n    manifest -> manifest.hasAddedFiles() || manifest.hasExistingFiles() || manifest.snapshotId() == snapshotId());\n\nWe need to ensure manifests written in filterManifests all have the same snapshot id.", "createdAt": "2020-02-11T01:08:23Z", "url": "https://github.com/apache/iceberg/pull/789", "merged": true, "mergeCommit": {"oid": "5bb8537223b02276af6eb30b8863b346fa055c37"}, "closed": true, "closedAt": "2020-02-11T19:45:36Z", "author": {"login": "aokolnychyi"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDHG68gH2gAyMzczNDMwNTk0OmZhNjM3MjQ2ZDY0M2VmZmY5NDU0NDI1ZGFkODJlYTk5OGRhZWNjMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDHL8PAFqTM1NjM3MzAwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fa637246d643efff9454425dad82ea998daecc30", "author": {"user": {"login": "aokolnychyi", "name": "Anton Okolnychyi"}}, "url": "https://github.com/apache/iceberg/commit/fa637246d643efff9454425dad82ea998daecc30", "committedDate": "2020-02-11T01:04:45Z", "message": "Fix race condition in SnapshotProducer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzczMDAx", "url": "https://github.com/apache/iceberg/pull/789#pullrequestreview-356373001", "createdAt": "2020-02-11T01:10:14Z", "commit": {"oid": "fa637246d643efff9454425dad82ea998daecc30"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMToxMDoxNFrOFn7Giw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMToxMDoxNFrOFn7Giw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwNzExNQ==", "bodyText": "The volatile keyword is needed as described here. Credits to @raptond for the link.", "url": "https://github.com/apache/iceberg/pull/789#discussion_r377407115", "createdAt": "2020-02-11T01:10:14Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/SnapshotProducer.java", "diffHunk": "@@ -77,7 +77,7 @@ public void accept(String file) {\n   private final String commitUUID = UUID.randomUUID().toString();\n   private final AtomicInteger attempt = new AtomicInteger(0);\n   private final List<String> manifestLists = Lists.newArrayList();\n-  private Long snapshotId = null;\n+  private volatile Long snapshotId = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa637246d643efff9454425dad82ea998daecc30"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4929, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}