{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0ODU2MDYx", "number": 1309, "title": "Add set-based equality and position filters", "bodyText": "This adds set-based filter implementations for equality and position deletes. Equality deletes use the StructLikeSet added in #1307.", "createdAt": "2020-08-07T22:23:06Z", "url": "https://github.com/apache/iceberg/pull/1309", "merged": true, "mergeCommit": {"oid": "914ea8ef8c5d5c911e7595bfad4b7c6b1433b4bc"}, "closed": true, "closedAt": "2020-08-12T00:47:22Z", "author": {"login": "rdblue"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8sGF-gBqjM2MzQ5MjQ2MDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-AC8SABqjM2NDU0NjgyNjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e29293b86c26d8e6b6c16859dd33e8a81f1d70a6", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/e29293b86c26d8e6b6c16859dd33e8a81f1d70a6", "committedDate": "2020-08-07T22:19:30Z", "message": "Add position and equality set delete filters."}, "afterCommit": {"oid": "57dcbd5a9794538bcf7a10722f217d024b9eb92c", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/57dcbd5a9794538bcf7a10722f217d024b9eb92c", "committedDate": "2020-08-07T22:23:41Z", "message": "Add set-based position and equality filters."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b63f42473b78f8f2b0d81f9bfad89ee16c38314d", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/b63f42473b78f8f2b0d81f9bfad89ee16c38314d", "committedDate": "2020-08-07T23:15:46Z", "message": "Fix checkstyle."}, "afterCommit": {"oid": "58c57a7fbac5edbeb49fdfb8526de4a89e3ba43b", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/58c57a7fbac5edbeb49fdfb8526de4a89e3ba43b", "committedDate": "2020-08-10T22:51:13Z", "message": "Add set-based position and equality filters."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0OTE5NDgw", "url": "https://github.com/apache/iceberg/pull/1309#pullrequestreview-464919480", "createdAt": "2020-08-11T09:56:33Z", "commit": {"oid": "58c57a7fbac5edbeb49fdfb8526de4a89e3ba43b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwOTo1NjozM1rOG-wzZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMDowNjoxNFrOG-xHkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ2NDQ4Ng==", "bodyText": "Can we have a static method toLongSet(We can optimize it to primitive long set in future) in CloseableIterable(Or some other places)?", "url": "https://github.com/apache/iceberg/pull/1309#discussion_r468464486", "createdAt": "2020-08-11T09:56:33Z", "author": {"login": "JingsongLi"}, "path": "core/src/main/java/org/apache/iceberg/deletes/Deletes.java", "diffHunk": "@@ -50,9 +54,47 @@\n   private Deletes() {\n   }\n \n-  public static <T> CloseableIterable<T> positionFilter(CloseableIterable<T> rows, Function<T, Long> rowToPosition,\n-                                                        CloseableIterable<Long> posDeletes) {\n-    return new PositionDeleteFilter<>(rows, rowToPosition, posDeletes);\n+  public static <T> CloseableIterable<T> equalitySetFilter(CloseableIterable<T> rows,\n+                                                           Function<T, StructLike> rowToDeleteKey,\n+                                                           Types.StructType eqType,\n+                                                           CloseableIterable<StructLike> eqDeletes) {\n+    try (CloseableIterable<StructLike> deletes = eqDeletes) {\n+      CloseableIterator<StructLike> eqDeleteIterator = deletes.iterator();\n+      if (eqDeleteIterator.hasNext()) {\n+        StructLikeSet deleteSet = StructLikeSet.create(eqType);\n+        Iterators.addAll(deleteSet, eqDeleteIterator);\n+        EqualitySetDeleteFilter<T> equalityFilter = new EqualitySetDeleteFilter<>(rowToDeleteKey, deleteSet);\n+        return equalityFilter.filter(rows);\n+      } else {\n+        return rows;\n+      }\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Failed to close equality delete source\", e);\n+    }\n+  }\n+\n+  public static <T> CloseableIterable<T> positionSetFilter(CloseableIterable<T> rows,\n+                                                           Function<T, Long> rowToPosition,\n+                                                           CloseableIterable<Long> posDeletes) {\n+    try (CloseableIterable<Long> deletes = posDeletes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58c57a7fbac5edbeb49fdfb8526de4a89e3ba43b"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ2OTY1MQ==", "bodyText": "Maybe this set can be reused? A set gets bigger and bigger in merging?\nSo can we have a method like addAll(CloseableIterable<StructLike>) in StructLikeSet?", "url": "https://github.com/apache/iceberg/pull/1309#discussion_r468469651", "createdAt": "2020-08-11T10:06:14Z", "author": {"login": "JingsongLi"}, "path": "core/src/main/java/org/apache/iceberg/deletes/Deletes.java", "diffHunk": "@@ -50,9 +54,47 @@\n   private Deletes() {\n   }\n \n-  public static <T> CloseableIterable<T> positionFilter(CloseableIterable<T> rows, Function<T, Long> rowToPosition,\n-                                                        CloseableIterable<Long> posDeletes) {\n-    return new PositionDeleteFilter<>(rows, rowToPosition, posDeletes);\n+  public static <T> CloseableIterable<T> equalitySetFilter(CloseableIterable<T> rows,\n+                                                           Function<T, StructLike> rowToDeleteKey,\n+                                                           Types.StructType eqType,\n+                                                           CloseableIterable<StructLike> eqDeletes) {\n+    try (CloseableIterable<StructLike> deletes = eqDeletes) {\n+      CloseableIterator<StructLike> eqDeleteIterator = deletes.iterator();\n+      if (eqDeleteIterator.hasNext()) {\n+        StructLikeSet deleteSet = StructLikeSet.create(eqType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58c57a7fbac5edbeb49fdfb8526de4a89e3ba43b"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MjAwNDAw", "url": "https://github.com/apache/iceberg/pull/1309#pullrequestreview-465200400", "createdAt": "2020-08-11T15:49:13Z", "commit": {"oid": "58c57a7fbac5edbeb49fdfb8526de4a89e3ba43b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNTo0OToxM1rOG--NbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNTo0OToxM1rOG--NbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY4NDE0MA==", "bodyText": "Good catch.", "url": "https://github.com/apache/iceberg/pull/1309#discussion_r468684140", "createdAt": "2020-08-11T15:49:13Z", "author": {"login": "aokolnychyi"}, "path": "api/src/main/java/org/apache/iceberg/types/Comparators.java", "diffHunk": "@@ -104,7 +104,10 @@ private Comparators() {}\n \n     private StructLikeComparator(Types.StructType struct) {\n       this.comparators = struct.fields().stream()\n-          .map(field -> internal(field.type()))\n+          .map(field -> field.isOptional() ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58c57a7fbac5edbeb49fdfb8526de4a89e3ba43b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MjEwMDAz", "url": "https://github.com/apache/iceberg/pull/1309#pullrequestreview-465210003", "createdAt": "2020-08-11T16:00:07Z", "commit": {"oid": "58c57a7fbac5edbeb49fdfb8526de4a89e3ba43b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNjowMDowN1rOG--p7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNjowMDowN1rOG--p7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY5MTQzNg==", "bodyText": "I am not sure I get this part. Do we create StructLikeSet for every entry in eqDeletes?", "url": "https://github.com/apache/iceberg/pull/1309#discussion_r468691436", "createdAt": "2020-08-11T16:00:07Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/deletes/Deletes.java", "diffHunk": "@@ -50,9 +54,47 @@\n   private Deletes() {\n   }\n \n-  public static <T> CloseableIterable<T> positionFilter(CloseableIterable<T> rows, Function<T, Long> rowToPosition,\n-                                                        CloseableIterable<Long> posDeletes) {\n-    return new PositionDeleteFilter<>(rows, rowToPosition, posDeletes);\n+  public static <T> CloseableIterable<T> equalitySetFilter(CloseableIterable<T> rows,\n+                                                           Function<T, StructLike> rowToDeleteKey,\n+                                                           Types.StructType eqType,\n+                                                           CloseableIterable<StructLike> eqDeletes) {\n+    try (CloseableIterable<StructLike> deletes = eqDeletes) {\n+      CloseableIterator<StructLike> eqDeleteIterator = deletes.iterator();\n+      if (eqDeleteIterator.hasNext()) {\n+        StructLikeSet deleteSet = StructLikeSet.create(eqType);\n+        Iterators.addAll(deleteSet, eqDeleteIterator);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58c57a7fbac5edbeb49fdfb8526de4a89e3ba43b"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MjE3NDYy", "url": "https://github.com/apache/iceberg/pull/1309#pullrequestreview-465217462", "createdAt": "2020-08-11T16:08:53Z", "commit": {"oid": "58c57a7fbac5edbeb49fdfb8526de4a89e3ba43b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d6d624cd36f42b6fc84893c0db6d1eee3d49da6", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/7d6d624cd36f42b6fc84893c0db6d1eee3d49da6", "committedDate": "2020-08-12T00:12:25Z", "message": "Add set-based position and equality filters."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58c57a7fbac5edbeb49fdfb8526de4a89e3ba43b", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/58c57a7fbac5edbeb49fdfb8526de4a89e3ba43b", "committedDate": "2020-08-10T22:51:13Z", "message": "Add set-based position and equality filters."}, "afterCommit": {"oid": "7d6d624cd36f42b6fc84893c0db6d1eee3d49da6", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/7d6d624cd36f42b6fc84893c0db6d1eee3d49da6", "committedDate": "2020-08-12T00:12:25Z", "message": "Add set-based position and equality filters."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4407, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}