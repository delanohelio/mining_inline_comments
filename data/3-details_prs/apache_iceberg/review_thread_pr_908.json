{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNjA2ODE0", "number": 908, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNjoxOTozN1rODwqLQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjozNDoyNlrODxum_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMzQ5MjQ4OnYy", "diffSide": "RIGHT", "path": "spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNjoxOTozN1rOGDyHNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNjoxOTozN1rOGDyHNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYxOTk1Nw==", "bodyText": "Why comment this out?", "url": "https://github.com/apache/iceberg/pull/908#discussion_r406619957", "createdAt": "2020-04-10T06:19:37Z", "author": {"login": "chenjunjiedada"}, "path": "spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java", "diffHunk": "@@ -342,7 +345,7 @@ public void testAllDataFilesTable() throws Exception {\n         .save(loadLocation(tableIdentifier));\n \n     // delete the first file to test that not only live files are listed\n-    table.newDelete().deleteFromRowFilter(Expressions.equal(\"id\", 1)).commit();\n+ //   table.newDelete().deleteFromRowFilter(Expressions.equal(\"id\", 1)).commit(); //\u8fd9\u91cc\u4f1a\u5f71\u54cdWAP \u8868", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6fae6ed5413c0472677b849257dde562b4e0eb2"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNTAyMTUyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/MetadataTableScan.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzowODo1N1rOGEAQDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzowODo1N1rOGEAQDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1MTU5OQ==", "bodyText": "Why do we need to duplicate these abstract methods here too?", "url": "https://github.com/apache/iceberg/pull/908#discussion_r406851599", "createdAt": "2020-04-10T17:08:57Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/MetadataTableScan.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class MetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(MetadataTableScan.class);\n+\n+  public MetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n+    super(ops, table, fileSchema);\n+  }\n+\n+  protected MetadataTableScan(\n+      TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter,\n+      boolean caseSensitive, boolean colStats, Collection<String> selectedColumns,\n+      ImmutableMap<String, String> options) {\n+    super(ops, table, snapshotId, schema, rowFilter, caseSensitive, colStats, selectedColumns, options);\n+  }\n+\n+  @Override\n+  protected abstract long targetSplitSize(TableOperations ops);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "574d0ad1896133a1a63211fdd3e576f60d123134"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNTAzNTE0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/MetadataTableScan.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzoxNDowN1rOGEAYjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzoxNDowN1rOGEAYjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1Mzc3NQ==", "bodyText": "The name MetadataTableScan is very generic but it is actually used only in aggregated metadata tables like all_data_files and all_manifests. I think we either need to change the naming or just override planFiles() in each individually. We can, for example, simply check if there is any snapshot at all and if yes, call an overloaded version of planFiles.", "url": "https://github.com/apache/iceberg/pull/908#discussion_r406853775", "createdAt": "2020-04-10T17:14:07Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/MetadataTableScan.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class MetadataTableScan extends BaseTableScan {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "574d0ad1896133a1a63211fdd3e576f60d123134"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNTA0Mjg3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/MetadataTableScan.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzoxNjo1MVrOGEAdKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzoxNjo1MVrOGEAdKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1NDk1NA==", "bodyText": "We don't have to analyze the current snapshot for all_data_files and all_manifests.", "url": "https://github.com/apache/iceberg/pull/908#discussion_r406854954", "createdAt": "2020-04-10T17:16:51Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/MetadataTableScan.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class MetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(MetadataTableScan.class);\n+\n+  public MetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n+    super(ops, table, fileSchema);\n+  }\n+\n+  protected MetadataTableScan(\n+      TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter,\n+      boolean caseSensitive, boolean colStats, Collection<String> selectedColumns,\n+      ImmutableMap<String, String> options) {\n+    super(ops, table, snapshotId, schema, rowFilter, caseSensitive, colStats, selectedColumns, options);\n+  }\n+\n+  @Override\n+  protected abstract long targetSplitSize(TableOperations ops);\n+\n+  @Override\n+  protected abstract TableScan newRefinedScan(\n+      TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter, boolean caseSensitive,\n+      boolean colStats, Collection<String> selectedColumns, ImmutableMap<String, String> options);\n+\n+  @Override\n+  protected abstract CloseableIterable<FileScanTask> planFiles(\n+      TableOperations ops, Snapshot snapshot, Expression rowFilter, boolean caseSensitive, boolean colStats);\n+\n+  @Override\n+  public CloseableIterable<FileScanTask> planFiles() {\n+    Snapshot snapshot = snapshot();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "574d0ad1896133a1a63211fdd3e576f60d123134"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMDE3NjAyOnYy", "diffSide": "RIGHT", "path": "spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNjoyMDo0MlrOGEr5kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjoyMDoyM1rOGE7wYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NjczOA==", "bodyText": "Tale -> Table?", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407566738", "createdAt": "2020-04-13T16:20:42Z", "author": {"login": "rdblue"}, "path": "spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java", "diffHunk": "@@ -326,6 +326,50 @@ public void testFilesUnpartitionedTable() throws Exception {\n     TestHelpers.assertEqualsSafe(filesTable.schema().asStruct(), expected.get(0), actual.get(0));\n   }\n \n+  @Test\n+  public void testAggregatedMetadataTaleInStage() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjUyOA==", "bodyText": "fixed", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407826528", "createdAt": "2020-04-14T02:20:23Z", "author": {"login": "XiaokunDing"}, "path": "spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java", "diffHunk": "@@ -326,6 +326,50 @@ public void testFilesUnpartitionedTable() throws Exception {\n     TestHelpers.assertEqualsSafe(filesTable.schema().asStruct(), expected.get(0), actual.get(0));\n   }\n \n+  @Test\n+  public void testAggregatedMetadataTaleInStage() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NjczOA=="}, "originalCommit": {"oid": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMDE3ODM3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNjoyMToyOFrOGEr7HA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjoyMDoxMlrOGE7wOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NzEzMg==", "bodyText": "Why is this public?", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407567132", "createdAt": "2020-04-13T16:21:28Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class AggregatedMetadataTableScan extends BaseTableScan {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2Nzg4NA==", "bodyText": "These tables aren't aggregates. In fact, some of them produce duplicates (like all_manifests) when a file appears twice. Can we use a better name here? What about BaseAllMetadataTableScan?", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407567884", "createdAt": "2020-04-13T16:22:53Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class AggregatedMetadataTableScan extends BaseTableScan {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NzEzMg=="}, "originalCommit": {"oid": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjQ4OQ==", "bodyText": "fixed", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407826489", "createdAt": "2020-04-14T02:20:12Z", "author": {"login": "XiaokunDing"}, "path": "core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class AggregatedMetadataTableScan extends BaseTableScan {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NzEzMg=="}, "originalCommit": {"oid": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMDE3ODg2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNjoyMTozNlrOGEr7ZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjoxOToxOFrOGE7vUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NzIwNA==", "bodyText": "This can be protected or package-private.", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407567204", "createdAt": "2020-04-13T16:21:36Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class AggregatedMetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(AggregatedMetadataTableScan.class);\n+\n+  public AggregatedMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjI1Ng==", "bodyText": "OK", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407826256", "createdAt": "2020-04-14T02:19:18Z", "author": {"login": "XiaokunDing"}, "path": "core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class AggregatedMetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(AggregatedMetadataTableScan.class);\n+\n+  public AggregatedMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2NzIwNA=="}, "originalCommit": {"oid": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMDE5MTIzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNjoyNToxN1rOGEsDDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjoxOTowMFrOGE7vAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2OTE2Ng==", "bodyText": "I don't think it's necessary to use \"in all snapshots\" because a snapshot doesn't make sense for these tables. It's not that this is scanning the manifests table across all snapshots, it is scanning the all_manifests table that is not specific to a snapshot by definition. Let's change this to Scanning metadata table {} with filter {}.", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407569166", "createdAt": "2020-04-13T16:25:17Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class AggregatedMetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(AggregatedMetadataTableScan.class);\n+\n+  public AggregatedMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n+    super(ops, table, fileSchema);\n+  }\n+\n+  protected AggregatedMetadataTableScan(\n+      TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter,\n+      boolean caseSensitive, boolean colStats, Collection<String> selectedColumns,\n+      ImmutableMap<String, String> options) {\n+    super(ops, table, snapshotId, schema, rowFilter, caseSensitive, colStats, selectedColumns, options);\n+  }\n+\n+  @Override\n+  public CloseableIterable<FileScanTask> planFiles() {\n+    LOG.info(\"Scanning table {} in all snapshots with filter {}\", table(), filter());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyNjE3OQ==", "bodyText": "fixed", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407826179", "createdAt": "2020-04-14T02:19:00Z", "author": {"login": "XiaokunDing"}, "path": "core/src/main/java/org/apache/iceberg/AggregatedMetadataTableScan.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Collection;\n+import org.apache.iceberg.events.Listeners;\n+import org.apache.iceberg.events.ScanEvent;\n+import org.apache.iceberg.expressions.Expression;\n+import org.apache.iceberg.io.CloseableIterable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class AggregatedMetadataTableScan extends BaseTableScan {\n+  private static final Logger LOG = LoggerFactory.getLogger(AggregatedMetadataTableScan.class);\n+\n+  public AggregatedMetadataTableScan(TableOperations ops, Table table, Schema fileSchema) {\n+    super(ops, table, fileSchema);\n+  }\n+\n+  protected AggregatedMetadataTableScan(\n+      TableOperations ops, Table table, Long snapshotId, Schema schema, Expression rowFilter,\n+      boolean caseSensitive, boolean colStats, Collection<String> selectedColumns,\n+      ImmutableMap<String, String> options) {\n+    super(ops, table, snapshotId, schema, rowFilter, caseSensitive, colStats, selectedColumns, options);\n+  }\n+\n+  @Override\n+  public CloseableIterable<FileScanTask> planFiles() {\n+    LOG.info(\"Scanning table {} in all snapshots with filter {}\", table(), filter());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2OTE2Ng=="}, "originalCommit": {"oid": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMDE5MzMxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/BaseTableScan.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNjoyNTo1NFrOGEsEXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjowNTo0NlrOGE7g0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2OTUwMQ==", "bodyText": "This isn't used. Could you revert this change?", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407569501", "createdAt": "2020-04-13T16:25:54Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseTableScan.java", "diffHunk": "@@ -318,7 +318,7 @@ private Schema lazyColumnProjection() {\n     return schema;\n   }\n \n-  private static String formatTimestampMillis(long millis) {\n+  protected static String formatTimestampMillis(long millis) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgyMjU0Nw==", "bodyText": "OK", "url": "https://github.com/apache/iceberg/pull/908#discussion_r407822547", "createdAt": "2020-04-14T02:05:46Z", "author": {"login": "XiaokunDing"}, "path": "core/src/main/java/org/apache/iceberg/BaseTableScan.java", "diffHunk": "@@ -318,7 +318,7 @@ private Schema lazyColumnProjection() {\n     return schema;\n   }\n \n-  private static String formatTimestampMillis(long millis) {\n+  protected static String formatTimestampMillis(long millis) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2OTUwMQ=="}, "originalCommit": {"oid": "859066a990d5dd77cd9f8a2c72ffd4cc7d1fd340"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNDcwNDYyOnYy", "diffSide": "RIGHT", "path": "spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjozNDoyNlrOGFXNgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwMTo1Nzo0OFrOGFnEWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3NjM1NQ==", "bodyText": "This test name is incorrect. Can you please update it to testAllMetadataTablesWithStagedCommits()?", "url": "https://github.com/apache/iceberg/pull/908#discussion_r408276355", "createdAt": "2020-04-14T16:34:26Z", "author": {"login": "rdblue"}, "path": "spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java", "diffHunk": "@@ -326,6 +326,50 @@ public void testFilesUnpartitionedTable() throws Exception {\n     TestHelpers.assertEqualsSafe(filesTable.schema().asStruct(), expected.get(0), actual.get(0));\n   }\n \n+  @Test\n+  public void testAggregatedMetadataTableInStage() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fbfed6b10cd477b4712da1f54bffc176bdd54a5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUzNjE1Mw==", "bodyText": "OK", "url": "https://github.com/apache/iceberg/pull/908#discussion_r408536153", "createdAt": "2020-04-15T01:57:48Z", "author": {"login": "XiaokunDing"}, "path": "spark/src/test/java/org/apache/iceberg/spark/source/TestIcebergSourceTablesBase.java", "diffHunk": "@@ -326,6 +326,50 @@ public void testFilesUnpartitionedTable() throws Exception {\n     TestHelpers.assertEqualsSafe(filesTable.schema().asStruct(), expected.get(0), actual.get(0));\n   }\n \n+  @Test\n+  public void testAggregatedMetadataTableInStage() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3NjM1NQ=="}, "originalCommit": {"oid": "1fbfed6b10cd477b4712da1f54bffc176bdd54a5"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2901, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}