{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxMDg2MjA2", "number": 1582, "title": "MR: Fix NPE when InputSplit.getLocations is called on mappers", "bodyText": "InputSplit.getLocations() can be called on mappers in some cases (Example). Since both locations and conf are transient, the current code produces an NPE as conf is null on the mappers.\nThe value of locations is not really relevant on the mappers since the tasks have already been distributed. So here we just return ANYWHERE when the conf is null. We can probably be more accurate by serializing the locations values if set, but I don't think its worth it.\njava.lang.Exception: java.lang.NullPointerException\n    at org.apache.hadoop.mapred.LocalJobRunner$Job.runTasks(LocalJobRunner.java:462)\n    at org.apache.hadoop.mapred.LocalJobRunner$Job.run(LocalJobRunner.java:522)\nCaused by: java.lang.NullPointerException\n    at org.apache.iceberg.mr.mapreduce.IcebergSplit.getLocations(IcebergSplit.java:69)\n    .\n    .\n    .\n    at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigSplit.toString(PigSplit.java:465)\n    at java.lang.String.valueOf(String.java:2994)\n    at java.lang.StringBuilder.append(StringBuilder.java:131)\n    at org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:756)\n    at org.apache.hadoop.mapred.MapTask.run(MapTask.java:341)\n    at org.apache.hadoop.mapred.LocalJobRunner$Job$MapTaskRunnable.run(LocalJobRunner.java:243)\n    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n    at java.util.concurrent.FutureTask.run(FutureTask.java:266)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n    at java.lang.Thread.run(Thread.java:748)\n\nI discovered this issue while testing our internal Pig LoadFunc implementation which works with multiple InputFormats. Iceberg's LoadFunc implementation in iceberg-pig does not have this issue as it contains its own InputSplit implementation which does not provide location information (as opposed to the InputSplit implementation in iceberg-mr).", "createdAt": "2020-10-11T06:08:20Z", "url": "https://github.com/apache/iceberg/pull/1582", "merged": true, "mergeCommit": {"oid": "1d5f52b712dd7eba5edcb85fec4e3f6bd2574f72"}, "closed": true, "closedAt": "2020-10-13T16:11:13Z", "author": {"login": "shardulm94"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRY7UuAH2gAyNTAxMDg2MjA2OjI5ZmZhNzExOGJmZjVlYTBhN2EzNjFlMzIyNGJlNmIwMGFiM2JiMjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR_S92gH2gAyNTAxMDg2MjA2Ojg2YTkyZDYyNzgzNzgyYjRiM2VhZjEwNTQ3NDQ1MDViNmU5YWViOTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "29ffa7118bff5ea0a7a361e3224be6b00ab3bb29", "author": {"user": {"login": "shardulm94", "name": "Shardul Mahadik"}}, "url": "https://github.com/apache/iceberg/commit/29ffa7118bff5ea0a7a361e3224be6b00ab3bb29", "committedDate": "2020-10-11T05:56:28Z", "message": "MR: Fix NPE when InputSplit.getLocations is called on mappers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MTQ4MjY0", "url": "https://github.com/apache/iceberg/pull/1582#pullrequestreview-506148264", "createdAt": "2020-10-11T06:36:09Z", "commit": {"oid": "29ffa7118bff5ea0a7a361e3224be6b00ab3bb29"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MTk2NDQw", "url": "https://github.com/apache/iceberg/pull/1582#pullrequestreview-506196440", "createdAt": "2020-10-11T16:40:20Z", "commit": {"oid": "29ffa7118bff5ea0a7a361e3224be6b00ab3bb29"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQxNjo0MDoyMFrOHfo6SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQxNjo0MDoyMFrOHfo6SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkzODE4NQ==", "bodyText": "I think a comment can help here saying implementation of getLocations is only meant to be used during splits computation.  getLocations won't be accurate when called on worker nodes", "url": "https://github.com/apache/iceberg/pull/1582#discussion_r502938185", "createdAt": "2020-10-11T16:40:20Z", "author": {"login": "rdsr"}, "path": "mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergSplit.java", "diffHunk": "@@ -74,9 +74,11 @@ public long getLength() {\n \n   @Override\n   public String[] getLocations() {\n-    if (locations == null) {\n+    if (locations == null && conf != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29ffa7118bff5ea0a7a361e3224be6b00ab3bb29"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2Nzk4Mzc3", "url": "https://github.com/apache/iceberg/pull/1582#pullrequestreview-506798377", "createdAt": "2020-10-12T17:27:23Z", "commit": {"oid": "29ffa7118bff5ea0a7a361e3224be6b00ab3bb29"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86a92d62783782b4b3eaf1054744505b6e9aeb91", "author": {"user": {"login": "shardulm94", "name": "Shardul Mahadik"}}, "url": "https://github.com/apache/iceberg/commit/86a92d62783782b4b3eaf1054744505b6e9aeb91", "committedDate": "2020-10-13T02:38:41Z", "message": "Add comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3934, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}