{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5MTkzNTI0", "number": 1848, "title": "Add support for converting avro schemas containing timestamps without the adjust-to-utc annotations", "bodyText": "Currently trying to convert avro schemas to iceberg schemas fails for avro schemas containing timestamps but without the adjust-to-utc annotations.\nval icebergSchema = AvroSchemaUtil.toIceberg(avroSchema)\nException in thread \"main\" java.lang.IllegalArgumentException: Invalid value for adjust-to-utc: null\n\tat org.apache.iceberg.relocated.com.google.common.base.Preconditions.checkArgument(Preconditions.java:217)\n\tat org.apache.iceberg.avro.SchemaToType.primitive(SchemaToType.java:185)\n\nThe avro spec says the timestamp-millis and timestamp-micros types represent an instant on the global timeline, and this aligns with the timestamp iceberg type. Thus, if adjust-to-utc is not configured then instead of failing we default to the timestamp iceberg type.\nSlack thread for context:\nhttps://the-asf.slack.com/archives/CF01LKV9S/p1605902467354000\nNote:  I did not add support for the new avro types (local-timestamp-millis/micros) in this PR, but that would be a good next pass.", "createdAt": "2020-11-29T22:43:59Z", "url": "https://github.com/apache/iceberg/pull/1848", "merged": true, "mergeCommit": {"oid": "191f314df2d86643d2f2f2b2f06e3ca09e2a3044"}, "closed": true, "closedAt": "2020-11-30T21:06:56Z", "author": {"login": "grantatspothero"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhYoZfgH2gAyNTI5MTkzNTI0OmFjZDhiMmMwNzZkNmE4OTE2NjYzZGJmMTgzY2RlNDlmYWE4ZTQ5MDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhppmegH2gAyNTI5MTkzNTI0OjA3ZWJhN2I2NzQwMmYzZmQzOTlkNjM3MzI5OGU4MmRmZjRiNjNmZjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "acd8b2c076d6a8916663dbf183cde49faa8e4909", "author": {"user": {"login": "grantatspothero", "name": "Grant Nicholas"}}, "url": "https://github.com/apache/iceberg/commit/acd8b2c076d6a8916663dbf183cde49faa8e4909", "committedDate": "2020-11-29T22:38:35Z", "message": "Add support for converting avro schemas containing timestamps without the adjust-to-utc property\n\nDefault avro timestamps to the timestamp iceberg type to follow avro timestamp semantics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a764afb8c2b00b9905f657054cbc9948829ce91", "author": {"user": {"login": "grantatspothero", "name": "Grant Nicholas"}}, "url": "https://github.com/apache/iceberg/commit/5a764afb8c2b00b9905f657054cbc9948829ce91", "committedDate": "2020-11-29T23:01:16Z", "message": "Fix checkstyle violations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTI2MzUw", "url": "https://github.com/apache/iceberg/pull/1848#pullrequestreview-541126350", "createdAt": "2020-11-30T17:20:17Z", "commit": {"oid": "5a764afb8c2b00b9905f657054cbc9948829ce91"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzoyMDoxN1rOH8Fb7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzoyMDoxN1rOH8Fb7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2NTY3Nw==", "bodyText": "How about \"default to timestamp\" or \"default to timestamp without time zone\"?", "url": "https://github.com/apache/iceberg/pull/1848#discussion_r532765677", "createdAt": "2020-11-30T17:20:17Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java", "diffHunk": "@@ -107,10 +107,14 @@ public static Schema buildAvroProjection(Schema schema, org.apache.iceberg.Schem\n \n   public static boolean isTimestamptz(Schema schema) {\n     LogicalType logicalType = schema.getLogicalType();\n-    if (logicalType != null && logicalType instanceof LogicalTypes.TimestampMicros) {\n+    if (logicalType instanceof LogicalTypes.TimestampMillis || logicalType instanceof LogicalTypes.TimestampMicros) {\n       // timestamptz is adjusted to UTC\n       Object value = schema.getObjectProp(ADJUST_TO_UTC_PROP);\n-      if (value instanceof Boolean) {\n+\n+      if (value == null) {\n+        // not all avro timestamp logical types will have the adjust_to_utc prop, default to not timestamptz", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a764afb8c2b00b9905f657054cbc9948829ce91"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTI3Njk0", "url": "https://github.com/apache/iceberg/pull/1848#pullrequestreview-541127694", "createdAt": "2020-11-30T17:21:55Z", "commit": {"oid": "5a764afb8c2b00b9905f657054cbc9948829ce91"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzoyMTo1NVrOH8FgNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzoyMTo1NVrOH8FgNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2Njc3Mg==", "bodyText": "This is the same behavior as before because null would not pass either instanceof check. Do we need to update this other than to add instanceof TimestampMillis above?", "url": "https://github.com/apache/iceberg/pull/1848#discussion_r532766772", "createdAt": "2020-11-30T17:21:55Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/avro/AvroSchemaUtil.java", "diffHunk": "@@ -107,10 +107,14 @@ public static Schema buildAvroProjection(Schema schema, org.apache.iceberg.Schem\n \n   public static boolean isTimestamptz(Schema schema) {\n     LogicalType logicalType = schema.getLogicalType();\n-    if (logicalType != null && logicalType instanceof LogicalTypes.TimestampMicros) {\n+    if (logicalType instanceof LogicalTypes.TimestampMillis || logicalType instanceof LogicalTypes.TimestampMicros) {\n       // timestamptz is adjusted to UTC\n       Object value = schema.getObjectProp(ADJUST_TO_UTC_PROP);\n-      if (value instanceof Boolean) {\n+\n+      if (value == null) {\n+        // not all avro timestamp logical types will have the adjust_to_utc prop, default to not timestamptz\n+        return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a764afb8c2b00b9905f657054cbc9948829ce91"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07eba7b67402f3fd399d6373298e82dff4b63ff1", "author": {"user": {"login": "grantatspothero", "name": "Grant Nicholas"}}, "url": "https://github.com/apache/iceberg/commit/07eba7b67402f3fd399d6373298e82dff4b63ff1", "committedDate": "2020-11-30T18:28:17Z", "message": "Better comment message"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3457, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}