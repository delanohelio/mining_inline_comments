{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MDU2MDE0", "number": 1559, "title": "Core: Update version-hint.txt atomically", "bodyText": "Under issue #1496 it was already discussed that we should find a way to update version-hint.txt atomically. At the moment, there is no know operation that would support atomic updates. Based on this I think our best solution would be:\n\nCreate a new file\nDelete old version-hint.txt\nMove the new file to version-hint.txt", "createdAt": "2020-10-07T07:52:27Z", "url": "https://github.com/apache/iceberg/pull/1559", "merged": true, "mergeCommit": {"oid": "2a371cf0be5dfeb66320163e02b606a129b3203a"}, "closed": true, "closedAt": "2020-10-29T16:30:11Z", "author": {"login": "lcspinter"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQIOVJgFqTUwMzYxNDA0Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXUuc-AH2gAyNDk5MDU2MDE0OjU5NWUzMWZkY2QxYjU4OTk0ZWU0NjEwNzY1MTdiZTg4MjQzNjEyYzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNjE0MDQz", "url": "https://github.com/apache/iceberg/pull/1559#pullrequestreview-503614043", "createdAt": "2020-10-07T07:54:55Z", "commit": {"oid": "5a09525b142ae249a2e4e75df0aae8eaf75a242f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NDo1NVrOHdm_eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NDo1NVrOHdm_eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgwOTU5Mg==", "bodyText": "I would go for an uniq name here so 2 concurrent commits will not interfere", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500809592", "createdAt": "2020-10-07T07:54:55Z", "author": {"login": "pvary"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,25 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      if (fs.exists(versionHintFile)) {\n+        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a09525b142ae249a2e4e75df0aae8eaf75a242f"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNjE1MjU5", "url": "https://github.com/apache/iceberg/pull/1559#pullrequestreview-503615259", "createdAt": "2020-10-07T07:56:28Z", "commit": {"oid": "5a09525b142ae249a2e4e75df0aae8eaf75a242f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NjoyOFrOHdnDWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NjoyOFrOHdnDWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgxMDU4NA==", "bodyText": "Formatting checks might fail here.\nI have learned that it is worth to run checkstyle checks before committing:\n./gradlew build -x test", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500810584", "createdAt": "2020-10-07T07:56:28Z", "author": {"login": "pvary"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,25 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      if (fs.exists(versionHintFile)) {\n+        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );\n+        writeFileToPath(fs, tempVersionHintFile);\n+        fs.delete(versionHintFile, false);\n+        fs.rename(tempVersionHintFile, versionHintFile);\n+      } else {\n+        writeFileToPath(fs, versionHintFile);\n+      }\n     } catch (IOException e) {\n       LOG.warn(\"Failed to update version hint\", e);\n     }\n   }\n \n+  private void writeFileToPath(FileSystem fs, Path path) throws IOException{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a09525b142ae249a2e4e75df0aae8eaf75a242f"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNjE2MDY1", "url": "https://github.com/apache/iceberg/pull/1559#pullrequestreview-503616065", "createdAt": "2020-10-07T07:57:30Z", "commit": {"oid": "5a09525b142ae249a2e4e75df0aae8eaf75a242f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NzozMFrOHdnFxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NzozMFrOHdnFxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgxMTIwNQ==", "bodyText": "We might want to close the stream here (try with resources block can help)", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500811205", "createdAt": "2020-10-07T07:57:30Z", "author": {"login": "pvary"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,25 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      if (fs.exists(versionHintFile)) {\n+        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );\n+        writeFileToPath(fs, tempVersionHintFile);\n+        fs.delete(versionHintFile, false);\n+        fs.rename(tempVersionHintFile, versionHintFile);\n+      } else {\n+        writeFileToPath(fs, versionHintFile);\n+      }\n     } catch (IOException e) {\n       LOG.warn(\"Failed to update version hint\", e);\n     }\n   }\n \n+  private void writeFileToPath(FileSystem fs, Path path) throws IOException{\n+    FSDataOutputStream out = fs.create(path, true /* overwrite */);\n+    out.write(String.valueOf(path).getBytes(StandardCharsets.UTF_8));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a09525b142ae249a2e4e75df0aae8eaf75a242f"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNjE2NDQw", "url": "https://github.com/apache/iceberg/pull/1559#pullrequestreview-503616440", "createdAt": "2020-10-07T07:58:01Z", "commit": {"oid": "5a09525b142ae249a2e4e75df0aae8eaf75a242f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1ODowMVrOHdnG9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1ODowMVrOHdnG9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgxMTUwOQ==", "bodyText": "Again concurrency can be problematic here", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500811509", "createdAt": "2020-10-07T07:58:01Z", "author": {"login": "pvary"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,25 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      if (fs.exists(versionHintFile)) {\n+        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );\n+        writeFileToPath(fs, tempVersionHintFile);\n+        fs.delete(versionHintFile, false);\n+        fs.rename(tempVersionHintFile, versionHintFile);\n+      } else {\n+        writeFileToPath(fs, versionHintFile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a09525b142ae249a2e4e75df0aae8eaf75a242f"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNjg3MDQ3", "url": "https://github.com/apache/iceberg/pull/1559#pullrequestreview-503687047", "createdAt": "2020-10-07T09:23:02Z", "commit": {"oid": "09fa44bf01463a36ae22ad384abe75c84809a3a1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwOToyMzowM1rOHdqaiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwOToyMzowM1rOHdqaiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2NTY3Mg==", "bodyText": "I wouldn't set overwrite to true to ensure this doesn't break anything. (In practice it won't, but it should be much clearer with overwrite = false.)", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500865672", "createdAt": "2020-10-07T09:23:03Z", "author": {"login": "HeartSaVioR"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -295,22 +295,19 @@ private void writeVersionHint(int versionToWrite) {\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n     try {\n-      if (fs.exists(versionHintFile)) {\n-        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );\n-        writeFileToPath(fs, tempVersionHintFile);\n-        fs.delete(versionHintFile, false);\n-        fs.rename(tempVersionHintFile, versionHintFile);\n-      } else {\n-        writeFileToPath(fs, versionHintFile);\n-      }\n+      Path tempVersionHintFile = metadataPath(UUID.randomUUID().toString() + \"-version-hint.temp\");\n+      writeVersionToPath(fs, tempVersionHintFile, versionToWrite);\n+      fs.delete(versionHintFile, false);\n+      fs.rename(tempVersionHintFile, versionHintFile);\n     } catch (IOException e) {\n       LOG.warn(\"Failed to update version hint\", e);\n     }\n   }\n \n-  private void writeFileToPath(FileSystem fs, Path path) throws IOException{\n-    FSDataOutputStream out = fs.create(path, true /* overwrite */);\n-    out.write(String.valueOf(path).getBytes(StandardCharsets.UTF_8));\n+  private void writeVersionToPath(FileSystem fs, Path path, int versionToWrite) throws IOException {\n+    try (FSDataOutputStream out = fs.create(path, true /* overwrite */)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09fa44bf01463a36ae22ad384abe75c84809a3a1"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTUzNTk1", "url": "https://github.com/apache/iceberg/pull/1559#pullrequestreview-503953595", "createdAt": "2020-10-07T14:39:41Z", "commit": {"oid": "f087434f602e8644353fc798369d11bd78387c29"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MDE0NDcy", "url": "https://github.com/apache/iceberg/pull/1559#pullrequestreview-516014472", "createdAt": "2020-10-23T21:14:56Z", "commit": {"oid": "f087434f602e8644353fc798369d11bd78387c29"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMToxNDo1NlrOHnepBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMToxNDo1NlrOHnepBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1ODUzNQ==", "bodyText": "Boolean parameters need inline comments to explain what they are. What does false here do?", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r511158535", "createdAt": "2020-10-23T21:14:56Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,22 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      Path tempVersionHintFile = metadataPath(UUID.randomUUID().toString() + \"-version-hint.temp\");\n+      writeVersionToPath(fs, tempVersionHintFile, versionToWrite);\n+      fs.delete(versionHintFile, false);\n+      fs.rename(tempVersionHintFile, versionHintFile);\n     } catch (IOException e) {\n       LOG.warn(\"Failed to update version hint\", e);\n     }\n   }\n \n+  private void writeVersionToPath(FileSystem fs, Path path, int versionToWrite) throws IOException {\n+    try (FSDataOutputStream out = fs.create(path, false)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f087434f602e8644353fc798369d11bd78387c29"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ecad5e13a3867531aeb40ae50bd86f6f6fa5762", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/2ecad5e13a3867531aeb40ae50bd86f6f6fa5762", "committedDate": "2020-10-29T10:02:08Z", "message": "Core: Update version-hint.txt atomically"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71cd1455fb70dda4f25133397998a53ee1c3f7f1", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/71cd1455fb70dda4f25133397998a53ee1c3f7f1", "committedDate": "2020-10-29T10:02:08Z", "message": "Generate unique temp version-hint file name and some minor changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3644929b1b1269d0bb08de6339868710ff1956e6", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/3644929b1b1269d0bb08de6339868710ff1956e6", "committedDate": "2020-10-29T10:02:09Z", "message": "Set overwrite=false"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "716e86b182abff566aeb7e032924627ec97c36d6", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/716e86b182abff566aeb7e032924627ec97c36d6", "committedDate": "2020-10-29T10:06:17Z", "message": "Add inline parameter comment for Filesystem.create() call"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f087434f602e8644353fc798369d11bd78387c29", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/f087434f602e8644353fc798369d11bd78387c29", "committedDate": "2020-10-07T11:26:01Z", "message": "Set overwrite=false"}, "afterCommit": {"oid": "716e86b182abff566aeb7e032924627ec97c36d6", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/716e86b182abff566aeb7e032924627ec97c36d6", "committedDate": "2020-10-29T10:06:17Z", "message": "Add inline parameter comment for Filesystem.create() call"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5ODQ3NjE0", "url": "https://github.com/apache/iceberg/pull/1559#pullrequestreview-519847614", "createdAt": "2020-10-29T16:23:08Z", "commit": {"oid": "716e86b182abff566aeb7e032924627ec97c36d6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNjoyMzowOFrOHqkC1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNjoyMzowOFrOHqkC1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM5Mjc5MQ==", "bodyText": "This one needs a comment to clarify false as well.", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r514392791", "createdAt": "2020-10-29T16:23:08Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,22 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      Path tempVersionHintFile = metadataPath(UUID.randomUUID().toString() + \"-version-hint.temp\");\n+      writeVersionToPath(fs, tempVersionHintFile, versionToWrite);\n+      fs.delete(versionHintFile, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "716e86b182abff566aeb7e032924627ec97c36d6"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "595e31fdcd1b58994ee461076517be88243612c4", "author": {"user": {"login": "lcspinter", "name": "L\u00e1szl\u00f3 Pint\u00e9r"}}, "url": "https://github.com/apache/iceberg/commit/595e31fdcd1b58994ee461076517be88243612c4", "committedDate": "2020-10-29T16:26:20Z", "message": "Add inline parameter comment for Filesystem.delete() call"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3908, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}