{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1NTA5ODc3", "number": 939, "title": "Support UpdateEvent for Update Operations", "bodyText": "#926 Want feedback on the approach\nTODO\n\nHaven't added all events, want to discuss approach.\nSome tests are failing, since snapshotOperation is null", "createdAt": "2020-04-18T14:47:04Z", "url": "https://github.com/apache/iceberg/pull/939", "merged": true, "mergeCommit": {"oid": "53d77075254b24b712b201912c01acf7ecf84c21"}, "closed": true, "closedAt": "2020-05-04T19:54:13Z", "author": {"login": "rdsr"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZiEQygFqTM5NjYzODcwNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABceCJ9fAFqTQwNTE1NDM4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjM4NzA2", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-396638706", "createdAt": "2020-04-20T16:55:36Z", "commit": {"oid": "532ccc60959be009f970b2de7a568e8e27ddedb0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjo1NTozN1rOGIeQWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjo1NTozN1rOGIeQWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzNzQ5OQ==", "bodyText": "Why not use table.location()? You can access that using ops.current().location().\nI'm really reluctant to add more methods to this interface since it is an important place where people can plug in their own customizations.", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411537499", "createdAt": "2020-04-20T16:55:37Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableOperations.java", "diffHunk": "@@ -30,6 +30,8 @@\n  */\n public interface TableOperations {\n \n+  String tablePath();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "532ccc60959be009f970b2de7a568e8e27ddedb0"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjQwNDQ3", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-396640447", "createdAt": "2020-04-20T16:57:44Z", "commit": {"oid": "532ccc60959be009f970b2de7a568e8e27ddedb0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjo1Nzo0NFrOGIeWIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjo1Nzo0NFrOGIeWIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzODk3Nw==", "bodyText": "Why use table path/location instead of name? I think we should send a name field with whatever was used to load the table. We might need to add name to the Table interface to do that, but adding that method is easier than adding something to TableOperations because all the implementations are internal.", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411538977", "createdAt": "2020-04-20T16:57:44Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/events/CreateSnapshotEvent.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.events;\n+\n+import java.util.Map;\n+\n+public final class CreateSnapshotEvent implements UpdateEvent {\n+  private final String operation;\n+  private final String tablePath;\n+  private final Map<String, String> summary;\n+  private final Iterable<String> addedFiles;\n+  private final Iterable<String> appendedManifests;\n+  private final Iterable<String> deletePaths;\n+\n+  public CreateSnapshotEvent(\n+      String operation, String tablePath, Map<String, String> summary,\n+      Iterable<String> addedFiles, Iterable<String> appendedManifests, Iterable<String> deletePaths) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "532ccc60959be009f970b2de7a568e8e27ddedb0"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjQzODg4", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-396643888", "createdAt": "2020-04-20T17:02:18Z", "commit": {"oid": "532ccc60959be009f970b2de7a568e8e27ddedb0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNzowMjoxOFrOGIeh9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNzowMjoxOFrOGIeh9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0MjAwNA==", "bodyText": "This needs to be in a try/catch block to ensure that no exceptions are thrown. It is important for correctness that this returns successfully if the commit was successful. If the commit succeeds, but this throws an exception, then higher-level retries will re-attempt the operation on the same data and produce duplicates.\nAlso, if this is sent after commit, then it should include the sequence number that was committed.", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411542004", "createdAt": "2020-04-20T17:02:18Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/SnapshotProducer.java", "diffHunk": "@@ -293,6 +294,8 @@ public void commit() {\n     } catch (RuntimeException e) {\n       LOG.warn(\"Failed to load committed table metadata, skipping manifest clean-up\", e);\n     }\n+\n+    Listeners.notifyAll(updateEvent());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "532ccc60959be009f970b2de7a568e8e27ddedb0"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjQ2ODM4", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-396646838", "createdAt": "2020-04-20T17:06:10Z", "commit": {"oid": "532ccc60959be009f970b2de7a568e8e27ddedb0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNzowNjoxMFrOGIersA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNzowNjoxMFrOGIersA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0NDQ5Ng==", "bodyText": "I think this should also include the snapshot ID and sequence number that were committed.", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411544496", "createdAt": "2020-04-20T17:06:10Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java", "diffHunk": "@@ -317,6 +319,18 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n     }\n   }\n \n+  @Override\n+  public UpdateEvent updateEvent() {\n+    return new CreateSnapshotEvent(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "532ccc60959be009f970b2de7a568e8e27ddedb0"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjQ3MDU1", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-396647055", "createdAt": "2020-04-20T17:06:30Z", "commit": {"oid": "532ccc60959be009f970b2de7a568e8e27ddedb0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNzowNjozMFrOGIeseQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNzowNjozMFrOGIeseQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0NDY5Nw==", "bodyText": "I think we can add update events individually.", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411544697", "createdAt": "2020-04-20T17:06:30Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/SchemaUpdate.java", "diffHunk": "@@ -476,4 +476,6 @@ public Type primitive(Type.PrimitiveType primitive) {\n     newFields.addAll(adds);\n     return Types.StructType.of(newFields);\n   }\n+\n+  //TODO: updateEvent", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "532ccc60959be009f970b2de7a568e8e27ddedb0"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjUwMDE0", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-396650014", "createdAt": "2020-04-20T17:10:27Z", "commit": {"oid": "532ccc60959be009f970b2de7a568e8e27ddedb0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNzoxMDoyN1rOGIe21w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNzoxMDoyN1rOGIe21w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0NzM1MQ==", "bodyText": "What is the value of having an interface for all types of updates with no methods?\nThe listener code routes these events using listeners.get(event.getClass()) so the interface doesn't help to subscribe to all events.", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411547351", "createdAt": "2020-04-20T17:10:27Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/events/UpdateEvent.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.events;\n+\n+public interface UpdateEvent {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "532ccc60959be009f970b2de7a568e8e27ddedb0"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "045648cb801b80f391da5fe21b1f2ee3cf16c98b", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/045648cb801b80f391da5fe21b1f2ee3cf16c98b", "committedDate": "2020-04-22T06:38:00Z", "message": "save"}, "afterCommit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/b04a180eac6244190ac995b8cc6239293e91925e", "committedDate": "2020-04-22T06:39:30Z", "message": "Support UpdateEvent for Update Operations\n\nsave"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NDM2Nzkz", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-398436793", "createdAt": "2020-04-22T17:53:16Z", "commit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1MzoxN1rOGKDXHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1MzoxN1rOGKDXHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5NDAxNA==", "bodyText": "Did you mean to use identifier.toString here as well?", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413194014", "createdAt": "2020-04-22T17:53:17Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseMetastoreCatalog.java", "diffHunk": "@@ -93,7 +93,7 @@ public Transaction newCreateTableTransaction(\n     String baseLocation = location != null ? location : defaultWarehouseLocation(identifier);\n     Map<String, String> tableProperties = properties != null ? properties : Maps.newHashMap();\n     TableMetadata metadata = TableMetadata.newTableMetadata(schema, spec, baseLocation, tableProperties);\n-    return Transactions.createTableTransaction(ops, metadata);\n+    return Transactions.createTableTransaction(identifier.name(), ops, metadata);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NDM3MTMw", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-398437130", "createdAt": "2020-04-22T17:53:43Z", "commit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1Mzo0M1rOGKDYNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1Mzo0M1rOGKDYNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5NDI5NA==", "bodyText": "Nit: Other places use name.", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413194294", "createdAt": "2020-04-22T17:53:43Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseReplacePartitions.java", "diffHunk": "@@ -25,8 +25,8 @@\n \n public class BaseReplacePartitions\n     extends MergingSnapshotProducer<ReplacePartitions> implements ReplacePartitions {\n-  BaseReplacePartitions(TableOperations ops) {\n-    super(ops);\n+  BaseReplacePartitions(String tableName, TableOperations ops) {\n+    super(tableName, ops);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NDM4MTI5", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-398438129", "createdAt": "2020-04-22T17:54:56Z", "commit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1NDo1NlrOGKDb0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1NDo1NlrOGKDb0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5NTIxNw==", "bodyText": "Couldn't this method be added in a separate commit?", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413195217", "createdAt": "2020-04-22T17:54:56Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseTable.java", "diffHunk": "@@ -39,6 +39,11 @@ public BaseTable(TableOperations ops, String name) {\n     this.name = name;\n   }\n \n+  @Override\n+  public String name() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NDM5Nzc1", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-398439775", "createdAt": "2020-04-22T17:56:56Z", "commit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1Njo1NlrOGKDhtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1Njo1NlrOGKDhtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5NjcyNg==", "bodyText": "Nit: this file doesn't need to change.", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413196726", "createdAt": "2020-04-22T17:56:56Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/PropertiesUpdate.java", "diffHunk": "@@ -37,6 +37,7 @@\n import static org.apache.iceberg.TableProperties.COMMIT_TOTAL_RETRY_TIME_MS_DEFAULT;\n \n class PropertiesUpdate implements UpdateProperties {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NDQxMzU5", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-398441359", "createdAt": "2020-04-22T17:58:56Z", "commit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1ODo1NlrOGKDnFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1ODo1NlrOGKDnFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5ODEwMg==", "bodyText": "I think the append event should be created in this PR if we are sending events from MergingSnapshotProducer. I don't think it is necessary to implement events for SnapshotManager yet, though.", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413198102", "createdAt": "2020-04-22T17:58:56Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/FastAppend.java", "diffHunk": "@@ -49,7 +49,8 @@\n   private ManifestFile newManifest = null;\n   private boolean hasNewFiles = false;\n \n-  FastAppend(TableOperations ops) {\n+  FastAppend(String tableName, TableOperations ops) {\n+    //TODO we use tableName to publish notification", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NDQxODg1", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-398441885", "createdAt": "2020-04-22T17:59:34Z", "commit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1OTozNFrOGKDo-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1OTozNFrOGKDo-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5ODU4Ng==", "bodyText": "Why comment this out? Looks correct to me.", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413198586", "createdAt": "2020-04-22T17:59:34Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java", "diffHunk": "@@ -317,6 +321,22 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n     }\n   }\n \n+  @Override\n+  public Object updateEvent() {\n+    long snapshotId = snapshotId();\n+    //long sequenceNumber = ops.refresh().snapshot(snapshotId).sequenceNumber();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NDQzMTYy", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-398443162", "createdAt": "2020-04-22T18:01:10Z", "commit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxODowMToxMFrOGKDtwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxODowMToxMFrOGKDtwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5OTgwOA==", "bodyText": "Minor: the other methods use past tense and refer to data files as \"files\", so this would be deletedFiles() right?", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413199808", "createdAt": "2020-04-22T18:01:10Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/events/CreateSnapshotEvent.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.events;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+public final class CreateSnapshotEvent {\n+  private final String tableName;\n+  private final String operation;\n+  private final long snapshotId;\n+  private final long sequenceNumber;\n+  private final Map<String, String> summary;\n+  private final List<String> addedFiles;\n+  private final List<String> appendedManifests;\n+  private final List<String> deletePaths;\n+\n+  public CreateSnapshotEvent(\n+      String tableName, String operation, long snapshotId, long sequenceNumber, Map<String, String> summary,\n+      List<String> addedFiles, List<String> appendedManifests, List<String> deletePaths) {\n+    this.tableName = tableName;\n+    this.operation = operation;\n+    this.snapshotId = snapshotId;\n+    this.sequenceNumber = sequenceNumber;\n+    this.summary = summary;\n+    this.addedFiles = addedFiles;\n+    this.appendedManifests = appendedManifests;\n+    this.deletePaths = deletePaths;\n+  }\n+\n+  public String tableName() {\n+    return tableName;\n+  }\n+\n+  public String operation() {\n+    return operation;\n+  }\n+\n+  public long snapshotId() {\n+    return snapshotId;\n+  }\n+\n+  public long sequenceNumber() {\n+    return sequenceNumber;\n+  }\n+\n+  public Map<String, String> summary() {\n+    return summary;\n+  }\n+\n+  public List<String> addedFiles() {\n+    return addedFiles;\n+  }\n+\n+  public List<String> appendedManifests() {\n+    return appendedManifests;\n+  }\n+\n+  public List<String> deletePaths() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NDQzODUz", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-398443853", "createdAt": "2020-04-22T18:02:05Z", "commit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxODowMjowNVrOGKDwUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxODowMjowNVrOGKDwUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIwMDQ2Ng==", "bodyText": "Is this the set of manifests that were added to the dataset, or the ones that were passed to appendManifest? I think we should be careful that we know exactly what is in these messages. If it isn't obvious what these should be, then we should remove the data. We can always add more information later.", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413200466", "createdAt": "2020-04-22T18:02:05Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/events/CreateSnapshotEvent.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.events;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+public final class CreateSnapshotEvent {\n+  private final String tableName;\n+  private final String operation;\n+  private final long snapshotId;\n+  private final long sequenceNumber;\n+  private final Map<String, String> summary;\n+  private final List<String> addedFiles;\n+  private final List<String> appendedManifests;\n+  private final List<String> deletePaths;\n+\n+  public CreateSnapshotEvent(\n+      String tableName, String operation, long snapshotId, long sequenceNumber, Map<String, String> summary,\n+      List<String> addedFiles, List<String> appendedManifests, List<String> deletePaths) {\n+    this.tableName = tableName;\n+    this.operation = operation;\n+    this.snapshotId = snapshotId;\n+    this.sequenceNumber = sequenceNumber;\n+    this.summary = summary;\n+    this.addedFiles = addedFiles;\n+    this.appendedManifests = appendedManifests;\n+    this.deletePaths = deletePaths;\n+  }\n+\n+  public String tableName() {\n+    return tableName;\n+  }\n+\n+  public String operation() {\n+    return operation;\n+  }\n+\n+  public long snapshotId() {\n+    return snapshotId;\n+  }\n+\n+  public long sequenceNumber() {\n+    return sequenceNumber;\n+  }\n+\n+  public Map<String, String> summary() {\n+    return summary;\n+  }\n+\n+  public List<String> addedFiles() {\n+    return addedFiles;\n+  }\n+\n+  public List<String> appendedManifests() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "370be6d3080a1d09ad3e8687d1b581f9b3988ca9", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/370be6d3080a1d09ad3e8687d1b581f9b3988ca9", "committedDate": "2020-04-27T15:12:32Z", "message": "Support UpdateEvent for Update Operations\n\nsave"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b04a180eac6244190ac995b8cc6239293e91925e", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/b04a180eac6244190ac995b8cc6239293e91925e", "committedDate": "2020-04-22T06:39:30Z", "message": "Support UpdateEvent for Update Operations\n\nsave"}, "afterCommit": {"oid": "905afc37ecc7d60d8f59e5532117a1153d48386a", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/905afc37ecc7d60d8f59e5532117a1153d48386a", "committedDate": "2020-04-27T15:12:32Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c43caaaf65e3c70d942296363865ec01627a05e", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/5c43caaaf65e3c70d942296363865ec01627a05e", "committedDate": "2020-04-27T15:35:26Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "905afc37ecc7d60d8f59e5532117a1153d48386a", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/905afc37ecc7d60d8f59e5532117a1153d48386a", "committedDate": "2020-04-27T15:12:32Z", "message": "Address comments"}, "afterCommit": {"oid": "5c43caaaf65e3c70d942296363865ec01627a05e", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/5c43caaaf65e3c70d942296363865ec01627a05e", "committedDate": "2020-04-27T15:35:26Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMTE4Mzc1", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-401118375", "createdAt": "2020-04-27T16:24:16Z", "commit": {"oid": "5c43caaaf65e3c70d942296363865ec01627a05e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoyNDoxN1rOGMsJ0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoyNDoxN1rOGMsJ0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1OTUwNg==", "bodyText": "Why did this change? Can we not return the interface?", "url": "https://github.com/apache/iceberg/pull/939#discussion_r415959506", "createdAt": "2020-04-27T16:24:17Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseTable.java", "diffHunk": "@@ -136,37 +136,37 @@ public RewriteManifests rewriteManifests() {\n \n   @Override\n   public OverwriteFiles newOverwrite() {\n-    return new BaseOverwriteFiles(ops);\n+    return new BaseOverwriteFiles(name, ops);\n   }\n \n   @Override\n   public ReplacePartitions newReplacePartitions() {\n-    return new BaseReplacePartitions(ops);\n+    return new BaseReplacePartitions(name, ops);\n   }\n \n   @Override\n   public DeleteFiles newDelete() {\n-    return new StreamingDelete(ops);\n+    return new StreamingDelete(name, ops);\n   }\n \n   @Override\n-  public ExpireSnapshots expireSnapshots() {\n+  public RemoveSnapshots expireSnapshots() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c43caaaf65e3c70d942296363865ec01627a05e"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMTIxMDQ3", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-401121047", "createdAt": "2020-04-27T16:27:26Z", "commit": {"oid": "5c43caaaf65e3c70d942296363865ec01627a05e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoyNzoyN1rOGMsTGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoyNzoyN1rOGMsTGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk2MTg4MA==", "bodyText": "What happens if manifests are added? Is this incomplete?", "url": "https://github.com/apache/iceberg/pull/939#discussion_r415961880", "createdAt": "2020-04-27T16:27:27Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/events/CreateSnapshotEvent.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.events;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+public final class CreateSnapshotEvent {\n+  private final String tableName;\n+  private final String operation;\n+  private final long snapshotId;\n+  private final long sequenceNumber;\n+  private final Map<String, String> summary;\n+  private final List<String> addedFiles;\n+  private final List<String> deleteFiles;\n+\n+  public CreateSnapshotEvent(\n+      String tableName, String operation, long snapshotId, long sequenceNumber,\n+      Map<String, String> summary, List<String> addedFiles, List<String> deleteFiles) {\n+    this.tableName = tableName;\n+    this.operation = operation;\n+    this.snapshotId = snapshotId;\n+    this.sequenceNumber = sequenceNumber;\n+    this.summary = summary;\n+    this.addedFiles = addedFiles;\n+    this.deleteFiles = deleteFiles;\n+  }\n+\n+  public String tableName() {\n+    return tableName;\n+  }\n+\n+  public String operation() {\n+    return operation;\n+  }\n+\n+  public long snapshotId() {\n+    return snapshotId;\n+  }\n+\n+  public long sequenceNumber() {\n+    return sequenceNumber;\n+  }\n+\n+  public Map<String, String> summary() {\n+    return summary;\n+  }\n+\n+  public List<String> addedFiles() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c43caaaf65e3c70d942296363865ec01627a05e"}, "originalPosition": 67}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f47b41ebd4cb682fef03a399a340736e029f65d7", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/f47b41ebd4cb682fef03a399a340736e029f65d7", "committedDate": "2020-04-28T03:14:59Z", "message": "Address comments"}, "afterCommit": {"oid": "0a631d024108fcd7f3717a80f9b29cefc62f44a6", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/0a631d024108fcd7f3717a80f9b29cefc62f44a6", "committedDate": "2020-04-28T03:23:36Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1a03ef4c97d2b3beecdf342ff6d5e0f00ae61df", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/a1a03ef4c97d2b3beecdf342ff6d5e0f00ae61df", "committedDate": "2020-04-28T03:27:38Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a631d024108fcd7f3717a80f9b29cefc62f44a6", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/0a631d024108fcd7f3717a80f9b29cefc62f44a6", "committedDate": "2020-04-28T03:23:36Z", "message": "Address comments"}, "afterCommit": {"oid": "a1a03ef4c97d2b3beecdf342ff6d5e0f00ae61df", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/a1a03ef4c97d2b3beecdf342ff6d5e0f00ae61df", "committedDate": "2020-04-28T03:27:38Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MTI4NTEw", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-405128510", "createdAt": "2020-05-04T16:03:35Z", "commit": {"oid": "a1a03ef4c97d2b3beecdf342ff6d5e0f00ae61df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNjowMzozNlrOGQHISw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNjowMzozNlrOGQHISw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU0NzIxMQ==", "bodyText": "The commit is going to update the current metadata, so there shouldn't be a need to refresh here. You'll get the correct information using current, with less chance of failure.", "url": "https://github.com/apache/iceberg/pull/939#discussion_r419547211", "createdAt": "2020-05-04T16:03:36Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/FastAppend.java", "diffHunk": "@@ -141,6 +144,18 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n     return newManifests;\n   }\n \n+  @Override\n+  public Object updateEvent() {\n+    long snapshotId = snapshotId();\n+    long sequenceNumber = ops.refresh().snapshot(snapshotId).sequenceNumber();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1a03ef4c97d2b3beecdf342ff6d5e0f00ae61df"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MTMwMzMw", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-405130330", "createdAt": "2020-05-04T16:05:46Z", "commit": {"oid": "a1a03ef4c97d2b3beecdf342ff6d5e0f00ae61df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNjowNTo0NlrOGQHOHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNjowNTo0NlrOGQHOHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU0ODcwMA==", "bodyText": "It doesn't create a new snapshot, but should it send an event? Maybe as a follow-up?", "url": "https://github.com/apache/iceberg/pull/939#discussion_r419548700", "createdAt": "2020-05-04T16:05:46Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/SnapshotManager.java", "diffHunk": "@@ -127,6 +127,32 @@ public ManageSnapshots rollbackTo(long snapshotId) {\n     return setCurrentSnapshot(snapshotId);\n   }\n \n+  @Override\n+  public Object updateEvent() {\n+    if (targetSnapshotId == null) {\n+      // NOOP operation, no snapshot created\n+      return null;\n+    }\n+\n+    switch (managerOperation) {\n+      case ROLLBACK:\n+        // rollback does not create a new snapshot", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1a03ef4c97d2b3beecdf342ff6d5e0f00ae61df"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85ef6281838017ba7c78214178b569b56667a068", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/85ef6281838017ba7c78214178b569b56667a068", "committedDate": "2020-05-04T16:25:25Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MTU0Mzg2", "url": "https://github.com/apache/iceberg/pull/939#pullrequestreview-405154386", "createdAt": "2020-05-04T16:34:30Z", "commit": {"oid": "85ef6281838017ba7c78214178b569b56667a068"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4833, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}