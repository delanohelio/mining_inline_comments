{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMjQ3ODU4", "number": 1002, "title": "Refactor IndexByName to use before and after", "bodyText": "This refactors the IndexByName schema visitor to be less confusing. This visitor previously used the CustomOrderSchemaVisitor, which is more complicated because it allows the visitor to control when children are traversed. This also required special handling to avoid errorprone errors, so the implementation was not easy to read.\nThis updates the visitor to use before and after callbacks to create names.", "createdAt": "2020-05-05T00:07:43Z", "url": "https://github.com/apache/iceberg/pull/1002", "merged": true, "mergeCommit": {"oid": "f1f5982535dba876960fb7c0c0c4397b75ad3e17"}, "closed": true, "closedAt": "2020-05-07T17:38:43Z", "author": {"login": "rdblue"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceIkEjgH2gAyNDEzMjQ3ODU4OjNiYjJmOGMxNjAxOGI5ZmIzZmUyM2U1MDJiNDZiMzE3MTBjNzFkYWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABce_XRfgH2gAyNDEzMjQ3ODU4OmVhMDI4ZjkzMTZlMzg5MTQ5NjdlZDhkMTg1YTNjYTQ1Nzg1MDIwNjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3bb2f8c16018b9fb3fe23e502b46b31710c71daa", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/3bb2f8c16018b9fb3fe23e502b46b31710c71daa", "committedDate": "2020-05-05T00:02:27Z", "message": "Refactor IndexByName to use before and after."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1ODg2MTM3", "url": "https://github.com/apache/iceberg/pull/1002#pullrequestreview-405886137", "createdAt": "2020-05-05T15:11:13Z", "commit": {"oid": "3bb2f8c16018b9fb3fe23e502b46b31710c71daa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNToxMToxNFrOGQuIYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNToxMToxNFrOGQuIYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE4NjIwOA==", "bodyText": "Do we need to add some description of why return directly when isStructType() is true? IIRC, that could lead to duplicate names.", "url": "https://github.com/apache/iceberg/pull/1002#discussion_r420186208", "createdAt": "2020-05-05T15:11:14Z", "author": {"login": "chenjunjiedada"}, "path": "api/src/main/java/org/apache/iceberg/types/IndexByName.java", "diffHunk": "@@ -23,84 +23,97 @@\n import com.google.common.collect.Lists;\n import com.google.common.collect.Maps;\n import java.util.Deque;\n+import java.util.List;\n import java.util.Map;\n-import java.util.concurrent.Callable;\n-import java.util.function.Supplier;\n import org.apache.iceberg.Schema;\n import org.apache.iceberg.exceptions.ValidationException;\n \n-public class IndexByName extends TypeUtil.CustomOrderSchemaVisitor<Map<String, Integer>> {\n+public class IndexByName extends TypeUtil.SchemaVisitor<Map<String, Integer>> {\n   private static final Joiner DOT = Joiner.on(\".\");\n \n   private final Deque<String> fieldNames = Lists.newLinkedList();\n   private final Map<String, Integer> nameToId = Maps.newHashMap();\n \n   @Override\n-  public Map<String, Integer> schema(Schema schema, Supplier<Map<String, Integer>> structResult) {\n-    return structResult.get();\n+  public void beforeField(Types.NestedField field) {\n+    fieldNames.push(field.name());\n   }\n \n   @Override\n-  public Map<String, Integer> struct(Types.StructType struct, Iterable<Map<String, Integer>> fieldResults) {\n-    // iterate through the fields to update the index for each one, use size to avoid errorprone failure\n-    Lists.newArrayList(fieldResults).size();\n-    return nameToId;\n+  public void afterField(Types.NestedField field) {\n+    fieldNames.pop();\n   }\n \n   @Override\n-  public Map<String, Integer> field(Types.NestedField field, Supplier<Map<String, Integer>> fieldResult) {\n-    withName(field.name(), fieldResult::get);\n-    addField(field.name(), field.fieldId());\n-    return null;\n+  public void beforeListElement(Types.NestedField elementField) {\n+    if (!elementField.type().isStructType()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bb2f8c16018b9fb3fe23e502b46b31710c71daa"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea028f9316e38914967ed8d185a3ca4578502069", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/ea028f9316e38914967ed8d185a3ca4578502069", "committedDate": "2020-05-07T15:53:15Z", "message": "Add comments."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4661, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}