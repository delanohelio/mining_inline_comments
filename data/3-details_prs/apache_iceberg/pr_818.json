{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NTYxNjc1", "number": 818, "title": "Refactor and improve BaseRewriteManifests", "bodyText": "Followup PR after #790 for the related issue: #726.\nHere, refactor the code to move the specId to the key of the writers and simplify WriterWrapper to make it clearer.\nAdditionally, use the Concurrent data structure instead of Collections.synchronized wrappers to improve the performance.", "createdAt": "2020-02-22T07:14:59Z", "url": "https://github.com/apache/iceberg/pull/818", "merged": true, "mergeCommit": {"oid": "cb18b0894ae7da305e89f76e2e91267d9e26649f"}, "closed": true, "closedAt": "2020-03-13T16:47:00Z", "author": {"login": "jun-he"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGu6clAH2gAyMzc4NTYxNjc1OjVmN2U1ZTQ5YTNiMzcyN2Y2Mzk0ZDc2YWFmMTliZTBiYmJiNjQ5MDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKSH81AH2gAyMzc4NTYxNjc1OjQ5ZDA3ODAwODM2YTAwMTdhYTI4MTdjZmUwMTIxNzVkYzhhNWUwOWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5f7e5e49a3b3727f6394d76aaf19be0bbbb64903", "author": {"user": {"login": "jun-he", "name": null}}, "url": "https://github.com/apache/iceberg/commit/5f7e5e49a3b3727f6394d76aaf19be0bbbb64903", "committedDate": "2020-02-22T07:09:06Z", "message": "refactor and improve BaseRewriteManifests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDE1MjY1", "url": "https://github.com/apache/iceberg/pull/818#pullrequestreview-363015265", "createdAt": "2020-02-22T07:18:45Z", "commit": {"oid": "5f7e5e49a3b3727f6394d76aaf19be0bbbb64903"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwNzoxODo0NlrOFtJ9kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwNzoxODo0NlrOFtJ9kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg5MzQ1Ng==", "bodyText": "I removed synchronized here because it seems unnecessary. close is either called in synchronized void addEntry() method, which is already synchronized. Or it is called in the finally blockto close all of them using thread pool. In this case,closemethod of eachWriterWrapper` will be called by different threads and no need to be synchronized.", "url": "https://github.com/apache/iceberg/pull/818#discussion_r382893456", "createdAt": "2020-02-22T07:18:46Z", "author": {"login": "jun-he"}, "path": "core/src/main/java/org/apache/iceberg/BaseRewriteManifests.java", "diffHunk": "@@ -325,59 +327,38 @@ long getManifestTargetSizeBytes() {\n   }\n \n   class WriterWrapper {\n-    private final Map<Integer, ManifestWriter> manifestWritersBySpecId = Maps.newConcurrentMap();\n+    private final PartitionSpec spec;\n+    private ManifestWriter writer;\n \n-    synchronized void addEntry(ManifestEntry entry, int partitionSpecId) {\n-      getWriter(partitionSpecId).existing(entry);\n+    WriterWrapper(PartitionSpec spec) {\n+      this.spec = spec;\n     }\n \n-    synchronized ManifestWriter getWriter(int partitionSpecId) {\n-      ManifestWriter writer = manifestWritersBySpecId.get(partitionSpecId);\n-      if (writer != null) {\n-        if (writer.length() < getManifestTargetSizeBytes()) {\n-          return writer;\n-        } else {\n-          close(partitionSpecId);\n-        }\n+    synchronized void addEntry(ManifestEntry entry) {\n+      if (writer == null) {\n+        writer = newWriter();\n+      } else if (writer.length() >= getManifestTargetSizeBytes()) {\n+        close();\n+        writer = newWriter();\n       }\n+      writer.existing(entry);\n+    }\n \n-      // create ManifestWriter with the correct partitionSpec\n-      PartitionSpec partitionSpec = specsById.get(partitionSpecId);\n-      OutputFile outputFile = manifestPath(manifestSuffix.getAndIncrement());\n-      writer = new ManifestWriter(partitionSpec, outputFile, snapshotId());\n-      manifestWritersBySpecId.put(partitionSpecId, writer);\n-      return writer;\n+    private ManifestWriter newWriter() {\n+      return new ManifestWriter(spec, manifestPath(manifestSuffix.getAndIncrement()), snapshotId());\n     }\n \n-    synchronized void close(int partitionSpecId) {\n-      if (manifestWritersBySpecId != null) {\n+    void close() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f7e5e49a3b3727f6394d76aaf19be0bbbb64903"}, "originalPosition": 98}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49d07800836a0017aa2817cfe012175dc8a5e09a", "author": {"user": {"login": "jun-he", "name": null}}, "url": "https://github.com/apache/iceberg/commit/49d07800836a0017aa2817cfe012175dc8a5e09a", "committedDate": "2020-03-04T07:52:18Z", "message": "address the review comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4678, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}