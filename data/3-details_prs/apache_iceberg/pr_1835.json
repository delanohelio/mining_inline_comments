{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3OTI1MDcz", "number": 1835, "title": "Hive: Only provide iceberg tables in HiveCatalog listTables", "bodyText": "this pr related to #1830", "createdAt": "2020-11-26T08:53:19Z", "url": "https://github.com/apache/iceberg/pull/1835", "merged": true, "mergeCommit": {"oid": "6e8aff3b8dd92008d4c039633bce6d5ea5c7f301"}, "closed": true, "closedAt": "2020-12-03T01:44:48Z", "author": {"login": "zhangjun0x01"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgzzdvgFqTU0MDMwNDg3Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiBwAWAFqTU0MjM1Mjc5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMzA0ODcz", "url": "https://github.com/apache/iceberg/pull/1835#pullrequestreview-540304873", "createdAt": "2020-11-28T03:39:11Z", "commit": {"oid": "fa4d880747891efdbbff891f35106882a666ca39"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQwMzozOToxMVrOH7MSuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQwMzo0NDowNVrOH7MUSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgyOTQzMg==", "bodyText": "nit: maybe use tableObjects or tables for this and use tableNames for prev.", "url": "https://github.com/apache/iceberg/pull/1835#discussion_r531829432", "createdAt": "2020-11-28T03:39:11Z", "author": {"login": "rdsr"}, "path": "hive-metastore/src/main/java/org/apache/iceberg/hive/HiveCatalog.java", "diffHunk": "@@ -118,8 +119,11 @@ public HiveCatalog(\n \n     try {\n       List<String> tables = clients.run(client -> client.getAllTables(database));\n-      List<TableIdentifier> tableIdentifiers = tables.stream()\n-          .map(t -> TableIdentifier.of(namespace, t))\n+      List<Table> tableObject = clients.run(client -> client.getTableObjectsByName(database, tables));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa4d880747891efdbbff891f35106882a666ca39"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgyOTY4Ng==", "bodyText": "in org.apache.hadoop.hive.metastore.api.Table class I do see internally to check for table.getParameters is null or not. Do you think that check makes sense here? I'm not completely certain whether table.getParameters won't be null", "url": "https://github.com/apache/iceberg/pull/1835#discussion_r531829686", "createdAt": "2020-11-28T03:41:51Z", "author": {"login": "rdsr"}, "path": "hive-metastore/src/main/java/org/apache/iceberg/hive/HiveCatalog.java", "diffHunk": "@@ -118,8 +119,11 @@ public HiveCatalog(\n \n     try {\n       List<String> tables = clients.run(client -> client.getAllTables(database));\n-      List<TableIdentifier> tableIdentifiers = tables.stream()\n-          .map(t -> TableIdentifier.of(namespace, t))\n+      List<Table> tableObject = clients.run(client -> client.getTableObjectsByName(database, tables));\n+      List<TableIdentifier> tableIdentifiers = tableObject.stream()\n+          .filter(table -> BaseMetastoreTableOperations.ICEBERG_TABLE_TYPE_VALUE\n+              .equalsIgnoreCase(table.getParameters().get(BaseMetastoreTableOperations.TABLE_TYPE_PROP)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa4d880747891efdbbff891f35106882a666ca39"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgyOTgzMg==", "bodyText": "a simpler way IMO could have been to use HiveCatalog and Iceberg apis  to create a table and then drop the iceberg metadata from Hive table properties. Though I guess this is fine too.", "url": "https://github.com/apache/iceberg/pull/1835#discussion_r531829832", "createdAt": "2020-11-28T03:44:05Z", "author": {"login": "rdsr"}, "path": "hive-metastore/src/test/java/org/apache/iceberg/hive/HiveTableTest.java", "diffHunk": "@@ -298,14 +308,43 @@ public void testFailure() throws TException {\n   }\n \n   @Test\n-  public void testListTables() {\n+  public void testListTables() throws TException, IOException {\n     List<TableIdentifier> tableIdents = catalog.listTables(TABLE_IDENTIFIER.namespace());\n     List<TableIdentifier> expectedIdents = tableIdents.stream()\n         .filter(t -> t.namespace().level(0).equals(DB_NAME) && t.name().equals(TABLE_NAME))\n         .collect(Collectors.toList());\n \n     Assert.assertEquals(1, expectedIdents.size());\n     Assert.assertTrue(catalog.tableExists(TABLE_IDENTIFIER));\n+\n+    // create a hive table\n+    String hiveTableName = \"test_hive_table\";\n+    org.apache.hadoop.hive.metastore.api.Table hiveTable = createHiveTable(hiveTableName);\n+    metastoreClient.createTable(hiveTable);\n+\n+    List<TableIdentifier> tableIdents1 = catalog.listTables(TABLE_IDENTIFIER.namespace());\n+    Assert.assertEquals(\"should only 1 iceberg table .\", 1, tableIdents1.size());\n+    Assert.assertTrue(catalog.tableExists(TABLE_IDENTIFIER));\n+    metastoreClient.dropTable(DB_NAME, hiveTableName);\n+  }\n+\n+  private org.apache.hadoop.hive.metastore.api.Table createHiveTable(String hiveTableName) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa4d880747891efdbbff891f35106882a666ca39"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c893a4c772d028566529c705d7beb77762e4b303", "author": {"user": null}, "url": "https://github.com/apache/iceberg/commit/c893a4c772d028566529c705d7beb77762e4b303", "committedDate": "2020-11-30T02:04:53Z", "message": "only list iceberg tables for hivecatalog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a57adf74dd2057649295fcdcb77d1716015b9725", "author": {"user": null}, "url": "https://github.com/apache/iceberg/commit/a57adf74dd2057649295fcdcb77d1716015b9725", "committedDate": "2020-11-30T02:04:53Z", "message": "check table.getParameters is null or not"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa4d880747891efdbbff891f35106882a666ca39", "author": {"user": null}, "url": "https://github.com/apache/iceberg/commit/fa4d880747891efdbbff891f35106882a666ca39", "committedDate": "2020-11-26T08:46:54Z", "message": "only list iceberg tables for hivecatalog"}, "afterCommit": {"oid": "a57adf74dd2057649295fcdcb77d1716015b9725", "author": {"user": null}, "url": "https://github.com/apache/iceberg/commit/a57adf74dd2057649295fcdcb77d1716015b9725", "committedDate": "2020-11-30T02:04:53Z", "message": "check table.getParameters is null or not"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzUyNzk1", "url": "https://github.com/apache/iceberg/pull/1835#pullrequestreview-542352795", "createdAt": "2020-12-01T22:33:00Z", "commit": {"oid": "a57adf74dd2057649295fcdcb77d1716015b9725"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3428, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}