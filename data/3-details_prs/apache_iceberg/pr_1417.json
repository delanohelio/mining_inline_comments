{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NDcxMzc2", "number": 1417, "title": "Hive: Add column projection", "bodyText": "Hello! This PR is to add column projection to the Hive-Iceberg integration. It follows a similar method to how I added the filter pushdown, by retrieving columns projected via Hive in the getSplits() method and adding them to the conf so they can be used in IcebergInputFormat when planning tasks.\nI haven't added a new test here as its a bit more difficult to test because its not changing any query results, but I did walk through in debug mode to see if the (correct) columns were projected for all our existing tests, and also checked that it didn't break all the HiveRunner tests...\ncc: @rdblue @massdosage @pvary @rdsr @guilload", "createdAt": "2020-09-03T08:53:59Z", "url": "https://github.com/apache/iceberg/pull/1417", "merged": true, "mergeCommit": {"oid": "e4521fd2670a6e4a81edf1ae938872cb8d3b9861"}, "closed": true, "closedAt": "2020-11-26T16:11:54Z", "author": {"login": "cmathiesen"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE9Ul5AH2gAyNDc4NDcxMzc2OmMxNjVkZDIyMGUzMTdjMDMwOGExM2RmM2FmY2IwM2Q1ZDJlNjVmMGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgUPcfgH2gAyNDc4NDcxMzc2OjNlMTY5OGIzMjRjYjFiMjU4NjZlMWJmYWUzNzUwMDJjYTZkZmM1MzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c165dd220e317c0308a13df3afcb03d5d2e65f0c", "author": {"user": {"login": "cmathiesen", "name": null}}, "url": "https://github.com/apache/iceberg/commit/c165dd220e317c0308a13df3afcb03d5d2e65f0c", "committedDate": "2020-09-02T14:59:38Z", "message": "Add column projection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxODc4MTUz", "url": "https://github.com/apache/iceberg/pull/1417#pullrequestreview-481878153", "createdAt": "2020-09-03T14:10:00Z", "commit": {"oid": "c165dd220e317c0308a13df3afcb03d5d2e65f0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNDoxMDowMFrOHMocOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNDoxMDowMFrOHMocOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwNzU0NQ==", "bodyText": "I have seen this in Hive code as a comment in ColumnProjectionUtils.getReadColumnIDs:\n      // NOTE: some code uses this list to correlate with column names, and yet these lists may\n      //       contain duplicates, which this call will remove and the other won't. As far as I can\n      //       tell, no code will actually use these two methods together; all is good if the code\n      //       gets the ID list without relying on this method. Or maybe it just works by magic.\n\nNot sure if this comment is still true or it is already fixed. If we might get duplicates I am not sure how Iceberg will behave in this case. Might worth to check. Maybe with some query with different UDFs around the same column?", "url": "https://github.com/apache/iceberg/pull/1417#discussion_r483007545", "createdAt": "2020-09-03T14:10:00Z", "author": {"login": "pvary"}, "path": "mr/src/main/java/org/apache/iceberg/mr/hive/HiveIcebergInputFormat.java", "diffHunk": "@@ -61,6 +62,9 @@\n       }\n     }\n \n+    String[] readColumns = ColumnProjectionUtils.getReadColumnNames(job);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c165dd220e317c0308a13df3afcb03d5d2e65f0c"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMDA3NTE0", "url": "https://github.com/apache/iceberg/pull/1417#pullrequestreview-482007514", "createdAt": "2020-09-03T16:24:39Z", "commit": {"oid": "c165dd220e317c0308a13df3afcb03d5d2e65f0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNjoyNDozOVrOHMuX3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNjoyNDozOVrOHMuX3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwNDczMg==", "bodyText": "The wording we've generally settled on is that project is used to set a requested schema and select is used to select columns like a SELECT statement in SQL. Following that convention, when we pass a schema we call it a \"projection\" and when we pass columns we call them \"selected columns\".\nI think it would be good to make this more clear, since this is passing columns to project and not a schema. How about SELECTED_COLUMNS = \"iceberg.mr.selected.columns\"?", "url": "https://github.com/apache/iceberg/pull/1417#discussion_r483104732", "createdAt": "2020-09-03T16:24:39Z", "author": {"login": "rdblue"}, "path": "mr/src/main/java/org/apache/iceberg/mr/InputFormatConfig.java", "diffHunk": "@@ -47,6 +47,7 @@ private InputFormatConfig() {\n   public static final String CATALOG = \"iceberg.mr.catalog\";\n   public static final String HADOOP_CATALOG_WAREHOUSE_LOCATION = \"iceberg.mr.catalog.hadoop.warehouse.location\";\n   public static final String CATALOG_LOADER_CLASS = \"iceberg.mr.catalog.loader.class\";\n+  public static final String COLUMN_PROJECTIONS = \"iceberg.mr.column.projections\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c165dd220e317c0308a13df3afcb03d5d2e65f0c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMDA4MDQw", "url": "https://github.com/apache/iceberg/pull/1417#pullrequestreview-482008040", "createdAt": "2020-09-03T16:25:18Z", "commit": {"oid": "c165dd220e317c0308a13df3afcb03d5d2e65f0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNjoyNToxOVrOHMuZfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNjoyNToxOVrOHMuZfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwNTE1MQ==", "bodyText": "Could we use a List instead of an array of strings here? It's usually easier if Iceberg converts to an array instead of expecting the caller to.", "url": "https://github.com/apache/iceberg/pull/1417#discussion_r483105151", "createdAt": "2020-09-03T16:25:19Z", "author": {"login": "rdblue"}, "path": "mr/src/main/java/org/apache/iceberg/mr/InputFormatConfig.java", "diffHunk": "@@ -93,6 +94,11 @@ public ConfigBuilder schema(Schema schema) {\n       return this;\n     }\n \n+    public ConfigBuilder select(String[] columns) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c165dd220e317c0308a13df3afcb03d5d2e65f0c"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMDQ1NjI3", "url": "https://github.com/apache/iceberg/pull/1417#pullrequestreview-483045627", "createdAt": "2020-09-05T10:06:34Z", "commit": {"oid": "c165dd220e317c0308a13df3afcb03d5d2e65f0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQxMDowNjozNVrOHNhEgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQxMDowNjozNVrOHNhEgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzNTM2Mg==", "bodyText": "In line with @rdblue's comment above, the usage of columnsToProject is potentially confusing given on the difference we've settled on for when to use project vs select. Additionally, there's a project call above on the parsed schema followed by this select, so the diffference between the two is especially noticeable here.\nIn addition to updating the added config's name to SELECTED_COLUMNS, can you possibly change columnsToProject to be columnsToSelect or even simpler, just selectedColumns?", "url": "https://github.com/apache/iceberg/pull/1417#discussion_r483935362", "createdAt": "2020-09-05T10:06:35Z", "author": {"login": "kbendick"}, "path": "mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java", "diffHunk": "@@ -111,6 +111,10 @@\n     if (schemaStr != null) {\n       scan.project(SchemaParser.fromJson(schemaStr));\n     }\n+    String[] columnsToProject = conf.getStrings(InputFormatConfig.COLUMN_PROJECTIONS, null);\n+    if (columnsToProject != null) {\n+      scan.select(columnsToProject);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c165dd220e317c0308a13df3afcb03d5d2e65f0c"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36d48bee358f0ee7ac47cd2a871aa2bf3c8fb080", "author": {"user": {"login": "cmathiesen", "name": null}}, "url": "https://github.com/apache/iceberg/commit/36d48bee358f0ee7ac47cd2a871aa2bf3c8fb080", "committedDate": "2020-09-16T13:28:12Z", "message": "Add projection to serde and recordreader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af369392010e44f0dc7533e9509d3617a25160aa", "author": {"user": {"login": "massdosage", "name": "Adrian Woodhead"}}, "url": "https://github.com/apache/iceberg/commit/af369392010e44f0dc7533e9509d3617a25160aa", "committedDate": "2020-11-02T17:20:57Z", "message": "merge and resolve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ee90b7f30952e83f6875c7ee12b726e87486f99", "author": {"user": {"login": "marton-bod", "name": "Marton Bod"}}, "url": "https://github.com/apache/iceberg/commit/1ee90b7f30952e83f6875c7ee12b726e87486f99", "committedDate": "2020-11-18T14:42:27Z", "message": "Projection pushdown changes (#18)\n\n* Always check the selected columns when getting a record reader\r\n* Hive: Run StorageHandler tests in both MR and Tez (#1695)\r\n* Disable vectorized Tez executions temporarily\r\nCo-authored-by: Marton Bod <mbod@cloudera.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d97f1b2e88331940fafc6545ce5e3d8081f6d71e", "author": {"user": {"login": "marton-bod", "name": "Marton Bod"}}, "url": "https://github.com/apache/iceberg/commit/d97f1b2e88331940fafc6545ce5e3d8081f6d71e", "committedDate": "2020-11-18T14:52:10Z", "message": "Merge branch 'master' into hive-column-projection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8310524fe3d4d15d86f54f628b14fab03de4098", "author": {"user": {"login": "marton-bod", "name": "Marton Bod"}}, "url": "https://github.com/apache/iceberg/commit/a8310524fe3d4d15d86f54f628b14fab03de4098", "committedDate": "2020-11-18T15:11:59Z", "message": "Fix checkstyle problem (#19)\n\n* Always check the selected columns when getting a record reader\r\n* Hive: Run StorageHandler tests in both MR and Tez (#1695)\r\n* fix checkstyle problem\r\n\r\nCo-authored-by: Marton Bod <mbod@cloudera.com>\r\nCo-authored-by: Adrian Woodhead <awoodhead@expediagroup.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4OTM4NTc1", "url": "https://github.com/apache/iceberg/pull/1417#pullrequestreview-538938575", "createdAt": "2020-11-26T01:36:49Z", "commit": {"oid": "a8310524fe3d4d15d86f54f628b14fab03de4098"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e1698b324cb1b25866e1bfae375002ca6dfc534", "author": {"user": {"login": "massdosage", "name": "Adrian Woodhead"}}, "url": "https://github.com/apache/iceberg/commit/3e1698b324cb1b25866e1bfae375002ca6dfc534", "committedDate": "2020-11-26T14:57:47Z", "message": "Merge branch 'master' into hive-column-projection"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4157, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}