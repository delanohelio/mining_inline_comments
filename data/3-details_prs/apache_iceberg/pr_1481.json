{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMzE5MzUy", "number": 1481, "title": "Core: Implement Catalogs.createTable and Catalogs.dropTable", "bodyText": "If tools want to implement drop and create table operations using the Catalogs they need a common interface to accessing the functionality.\nFor example these methods will be used by HiveMetaHook to allow Iceberg table creation through Hive SQL commands\nThe patch includes 2 commits:\n\nHadoopTables did not have the dropTable functionality. Refactored the code out from BaseCatalog to be accessible by HadoopTables, and implemented the method. Added some tests around the new function.\nCreated the corresponding Catalogs methods and added tests around that.", "createdAt": "2020-09-21T13:59:33Z", "url": "https://github.com/apache/iceberg/pull/1481", "merged": true, "mergeCommit": {"oid": "66a37c2793392e6ce9d5d2783b64488527f079fc"}, "closed": true, "closedAt": "2020-09-25T19:27:40Z", "author": {"login": "pvary"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLnPSiABqjM3OTY1OTY5NjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMTu0uAH2gAyNDkwMzE5MzUyOjY2YmIyZTg5OTljMTc0NTc5ZDdjNGU0OGYxZjRjZDVmN2RkNGQ5ODc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "893bfe21fa4839da6a72b77a86abe6e6e88dac72", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/893bfe21fa4839da6a72b77a86abe6e6e88dac72", "committedDate": "2020-09-22T12:45:16Z", "message": "Fixing comment formatting"}, "afterCommit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/c584198d44cfa3b49fe93e078b1be11b1e66b8f9", "committedDate": "2020-09-23T07:12:57Z", "message": "Javadoc warning fixed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTM2NTMy", "url": "https://github.com/apache/iceberg/pull/1481#pullrequestreview-495136532", "createdAt": "2020-09-24T00:07:29Z", "commit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDowNzozMFrOHXFRaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDowNzozMFrOHXFRaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2NTY3Mg==", "bodyText": "Because this was protected, I think we should keep it and just delegate to where the method moved. We can also deprecated it and set a version when it will be removed:\n  /**\n   * ...\n   * @deprecated will be removed in 0.11.0; use CatalogUtil.dropTableData instead.\n   */", "url": "https://github.com/apache/iceberg/pull/1481#discussion_r493965672", "createdAt": "2020-09-24T00:07:30Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseMetastoreCatalog.java", "diffHunk": "@@ -278,84 +268,6 @@ private Transaction newReplaceTableTransaction(boolean orCreate) {\n     }\n   }\n \n-  /**\n-   * Drops all data and metadata files referenced by TableMetadata.\n-   * <p>\n-   * This should be called by dropTable implementations to clean up table files once the table has been dropped in the\n-   * metastore.\n-   *\n-   * @param io a FileIO to use for deletes\n-   * @param metadata the last valid TableMetadata instance for a dropped table.\n-   */\n-  protected static void dropTableData(FileIO io, TableMetadata metadata) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTM2OTM0", "url": "https://github.com/apache/iceberg/pull/1481#pullrequestreview-495136934", "createdAt": "2020-09-24T00:08:46Z", "commit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDowODo0NlrOHXFSrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDowODo0NlrOHXFSrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2NTk5OA==", "bodyText": "Nit: accidentally duplicated line?", "url": "https://github.com/apache/iceberg/pull/1481#discussion_r493965998", "createdAt": "2020-09-24T00:08:46Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopCatalog.java", "diffHunk": "@@ -196,9 +197,10 @@ public boolean dropTable(TableIdentifier identifier, boolean purge) {\n \n     try {\n       if (purge && lastMetadata != null) {\n+        // Since the data files and the metadata files may store in different locations,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTM3Njk4", "url": "https://github.com/apache/iceberg/pull/1481#pullrequestreview-495137698", "createdAt": "2020-09-24T00:11:09Z", "commit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxMTowOVrOHXFVfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxMTowOVrOHXFVfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2NjcxOA==", "bodyText": "I think this wasn't implemented before because it is not part of the Tables API, but now that this is the only implementation, maybe we should consider just deprecating the Tables API and making HadoopTables a stand-alone class.", "url": "https://github.com/apache/iceberg/pull/1481#discussion_r493966718", "createdAt": "2020-09-24T00:11:09Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTables.java", "diffHunk": "@@ -144,6 +147,52 @@ public Table create(Schema schema, PartitionSpec spec, SortOrder order,\n     return new BaseTable(ops, location);\n   }\n \n+  /**\n+   * Drop a table and delete all data and metadata files. Throws NoSuchTableException if the table does not exists.\n+   *\n+   * @param location a path URI (e.g. hdfs:///warehouse/my_table)\n+   * @return true if the table was dropped\n+   */\n+  public boolean dropTable(String location) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTM3ODU2", "url": "https://github.com/apache/iceberg/pull/1481#pullrequestreview-495137856", "createdAt": "2020-09-24T00:11:33Z", "commit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxMTozM1rOHXFWDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxMTozM1rOHXFWDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2Njg2MA==", "bodyText": "I think this should be a @throws instead of text.", "url": "https://github.com/apache/iceberg/pull/1481#discussion_r493966860", "createdAt": "2020-09-24T00:11:33Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTables.java", "diffHunk": "@@ -144,6 +147,52 @@ public Table create(Schema schema, PartitionSpec spec, SortOrder order,\n     return new BaseTable(ops, location);\n   }\n \n+  /**\n+   * Drop a table and delete all data and metadata files. Throws NoSuchTableException if the table does not exists.\n+   *\n+   * @param location a path URI (e.g. hdfs:///warehouse/my_table)\n+   * @return true if the table was dropped\n+   */\n+  public boolean dropTable(String location) {\n+    return dropTable(location, true);\n+  }\n+\n+  /**\n+   * Drop a table; optionally delete data and metadata files.\n+   * <p>\n+   * If purge is set to true the implementation should delete all data and metadata files.\n+   * Throws NoSuchTableException if the table does not exists.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTM4NjAz", "url": "https://github.com/apache/iceberg/pull/1481#pullrequestreview-495138603", "createdAt": "2020-09-24T00:13:58Z", "commit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxMzo1OFrOHXFYpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxMzo1OFrOHXFYpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2NzUyNg==", "bodyText": "The TableOperations created just below can tell you the same information. I think this should use that instead to avoid creating two.", "url": "https://github.com/apache/iceberg/pull/1481#discussion_r493967526", "createdAt": "2020-09-24T00:13:58Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTables.java", "diffHunk": "@@ -144,6 +147,52 @@ public Table create(Schema schema, PartitionSpec spec, SortOrder order,\n     return new BaseTable(ops, location);\n   }\n \n+  /**\n+   * Drop a table and delete all data and metadata files. Throws NoSuchTableException if the table does not exists.\n+   *\n+   * @param location a path URI (e.g. hdfs:///warehouse/my_table)\n+   * @return true if the table was dropped\n+   */\n+  public boolean dropTable(String location) {\n+    return dropTable(location, true);\n+  }\n+\n+  /**\n+   * Drop a table; optionally delete data and metadata files.\n+   * <p>\n+   * If purge is set to true the implementation should delete all data and metadata files.\n+   * Throws NoSuchTableException if the table does not exists.\n+   *\n+   * @param location a path URI (e.g. hdfs:///warehouse/my_table)\n+   * @param purge if true, delete all data and metadata files in the table\n+   * @return true if the table was dropped\n+   */\n+  public boolean dropTable(String location, boolean purge) {\n+    // Just for checking if the table exists or not\n+    load(location);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTM4NzI4", "url": "https://github.com/apache/iceberg/pull/1481#pullrequestreview-495138728", "createdAt": "2020-09-24T00:14:23Z", "commit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxNDoyM1rOHXFZHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxNDoyM1rOHXFZHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2NzY0NQ==", "bodyText": "Since this is a new method, you can use UncheckedIOException directly.", "url": "https://github.com/apache/iceberg/pull/1481#discussion_r493967645", "createdAt": "2020-09-24T00:14:23Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTables.java", "diffHunk": "@@ -144,6 +147,52 @@ public Table create(Schema schema, PartitionSpec spec, SortOrder order,\n     return new BaseTable(ops, location);\n   }\n \n+  /**\n+   * Drop a table and delete all data and metadata files. Throws NoSuchTableException if the table does not exists.\n+   *\n+   * @param location a path URI (e.g. hdfs:///warehouse/my_table)\n+   * @return true if the table was dropped\n+   */\n+  public boolean dropTable(String location) {\n+    return dropTable(location, true);\n+  }\n+\n+  /**\n+   * Drop a table; optionally delete data and metadata files.\n+   * <p>\n+   * If purge is set to true the implementation should delete all data and metadata files.\n+   * Throws NoSuchTableException if the table does not exists.\n+   *\n+   * @param location a path URI (e.g. hdfs:///warehouse/my_table)\n+   * @param purge if true, delete all data and metadata files in the table\n+   * @return true if the table was dropped\n+   */\n+  public boolean dropTable(String location, boolean purge) {\n+    // Just for checking if the table exists or not\n+    load(location);\n+\n+    TableOperations ops = newTableOps(location);\n+    TableMetadata lastMetadata;\n+    if (purge && ops.current() != null) {\n+      lastMetadata = ops.current();\n+    } else {\n+      lastMetadata = null;\n+    }\n+\n+    try {\n+      if (purge && lastMetadata != null) {\n+        // Since the data files and the metadata files may store in different locations,\n+        // so it has to call dropTableData to force delete the data file.\n+        CatalogUtil.dropTableData(ops.io(), lastMetadata);\n+      }\n+      Path tablePath = new Path(location);\n+      Util.getFs(tablePath, conf).delete(tablePath, true /* recursive */);\n+      return true;\n+    } catch (IOException e) {\n+      throw new RuntimeIOException(e, \"Failed to delete file: %s\", location);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTM5MDAz", "url": "https://github.com/apache/iceberg/pull/1481#pullrequestreview-495139003", "createdAt": "2020-09-24T00:15:14Z", "commit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxNToxNFrOHXFaRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxNToxNFrOHXFaRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2Nzk0MQ==", "bodyText": "Would it be faster to call this instead of calling dropTableData? There seems to be no need to read files to find what to delete, only to delete the remaining files afterward.", "url": "https://github.com/apache/iceberg/pull/1481#discussion_r493967941", "createdAt": "2020-09-24T00:15:14Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTables.java", "diffHunk": "@@ -144,6 +147,52 @@ public Table create(Schema schema, PartitionSpec spec, SortOrder order,\n     return new BaseTable(ops, location);\n   }\n \n+  /**\n+   * Drop a table and delete all data and metadata files. Throws NoSuchTableException if the table does not exists.\n+   *\n+   * @param location a path URI (e.g. hdfs:///warehouse/my_table)\n+   * @return true if the table was dropped\n+   */\n+  public boolean dropTable(String location) {\n+    return dropTable(location, true);\n+  }\n+\n+  /**\n+   * Drop a table; optionally delete data and metadata files.\n+   * <p>\n+   * If purge is set to true the implementation should delete all data and metadata files.\n+   * Throws NoSuchTableException if the table does not exists.\n+   *\n+   * @param location a path URI (e.g. hdfs:///warehouse/my_table)\n+   * @param purge if true, delete all data and metadata files in the table\n+   * @return true if the table was dropped\n+   */\n+  public boolean dropTable(String location, boolean purge) {\n+    // Just for checking if the table exists or not\n+    load(location);\n+\n+    TableOperations ops = newTableOps(location);\n+    TableMetadata lastMetadata;\n+    if (purge && ops.current() != null) {\n+      lastMetadata = ops.current();\n+    } else {\n+      lastMetadata = null;\n+    }\n+\n+    try {\n+      if (purge && lastMetadata != null) {\n+        // Since the data files and the metadata files may store in different locations,\n+        // so it has to call dropTableData to force delete the data file.\n+        CatalogUtil.dropTableData(ops.io(), lastMetadata);\n+      }\n+      Path tablePath = new Path(location);\n+      Util.getFs(tablePath, conf).delete(tablePath, true /* recursive */);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTM5NzYw", "url": "https://github.com/apache/iceberg/pull/1481#pullrequestreview-495139760", "createdAt": "2020-09-24T00:17:41Z", "commit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxNzo0MVrOHXFdDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxNzo0MVrOHXFdDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2ODY1Mg==", "bodyText": "Normally, we would use ImmutableSet.of(...). That's simpler and creates a set that can't be modified.", "url": "https://github.com/apache/iceberg/pull/1481#discussion_r493968652", "createdAt": "2020-09-24T00:17:41Z", "author": {"login": "rdblue"}, "path": "mr/src/main/java/org/apache/iceberg/mr/Catalogs.java", "diffHunk": "@@ -44,23 +61,31 @@\n   private static final String NAME = \"name\";\n   private static final String LOCATION = \"location\";\n \n+  private static final Set<String> PROPERTIES_TO_REMOVE = Stream\n+      .of(InputFormatConfig.TABLE_SCHEMA, InputFormatConfig.PARTITION_SPEC, LOCATION, NAME)\n+      .collect(Collectors.toCollection(HashSet::new));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTQwNTcw", "url": "https://github.com/apache/iceberg/pull/1481#pullrequestreview-495140570", "createdAt": "2020-09-24T00:20:15Z", "commit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoyMDoxNlrOHXFf9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoyMDoxNlrOHXFf9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2OTM5OA==", "bodyText": "Minor: Javadoc won't automatically break paragraphs, so you have to use <p> between them.", "url": "https://github.com/apache/iceberg/pull/1481#discussion_r493969398", "createdAt": "2020-09-24T00:20:16Z", "author": {"login": "rdblue"}, "path": "mr/src/main/java/org/apache/iceberg/mr/Catalogs.java", "diffHunk": "@@ -44,23 +61,31 @@\n   private static final String NAME = \"name\";\n   private static final String LOCATION = \"location\";\n \n+  private static final Set<String> PROPERTIES_TO_REMOVE = Stream\n+      .of(InputFormatConfig.TABLE_SCHEMA, InputFormatConfig.PARTITION_SPEC, LOCATION, NAME)\n+      .collect(Collectors.toCollection(HashSet::new));\n+\n   private Catalogs() {\n   }\n \n   /**\n    * Load an Iceberg table using the catalog and table identifier (or table path) specified by the configuration.\n-   * Catalog resolution happens in this order:\n-   * 1. Custom catalog if specified by {@link InputFormatConfig#CATALOG_LOADER_CLASS}\n-   * 2. Hadoop or Hive catalog if specified by {@link InputFormatConfig#CATALOG}\n-   * 3. Hadoop Tables\n    * @param conf a Hadoop conf\n    * @return an Iceberg table\n    */\n   public static Table loadTable(Configuration conf) {\n     return loadTable(conf, conf.get(InputFormatConfig.TABLE_IDENTIFIER), conf.get(InputFormatConfig.TABLE_LOCATION));\n   }\n \n-  // For use in HiveIcebergSerDe and HiveIcebergStorageHandler\n+  /**\n+   * Load an Iceberg table using the catalog specified by the configuration.\n+   * The table identifier ({@link Catalogs#NAME}) or table path ({@link Catalogs#LOCATION}) should be specified by\n+   * the controlling properties.\n+   * Used by HiveIcebergSerDe and HiveIcebergStorageHandler", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTQxMjE5", "url": "https://github.com/apache/iceberg/pull/1481#pullrequestreview-495141219", "createdAt": "2020-09-24T00:22:15Z", "commit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoyMjoxNVrOHXFiYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoyMjoxNVrOHXFiYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MDAxNg==", "bodyText": "It looks like this is the reason why the examples specify a table property. Can we instead use Hive schema DDL and convert it to Iceberg? Similarly, can we get the identity partition fields that way to create a spec?", "url": "https://github.com/apache/iceberg/pull/1481#discussion_r493970016", "createdAt": "2020-09-24T00:22:15Z", "author": {"login": "rdblue"}, "path": "mr/src/main/java/org/apache/iceberg/mr/Catalogs.java", "diffHunk": "@@ -77,6 +102,77 @@ private static Table loadTable(Configuration conf, String tableIdentifier, Strin\n     return new HadoopTables(conf).load(tableLocation);\n   }\n \n+  /**\n+   * Creates an Iceberg table using the catalog specified by the configuration.\n+   * The properties should contain the following values:\n+   * <p><ul>\n+   * <li>Table identifier ({@link Catalogs#NAME}) or table path ({@link Catalogs#LOCATION}) is required\n+   * <li>Table schema ({@link InputFormatConfig#TABLE_SCHEMA}) is required\n+   * <li>Partition specification ({@link InputFormatConfig#PARTITION_SPEC}) is optional. Table will be unpartitioned if\n+   *  not provided\n+   * </ul><p>\n+   * Other properties will be handled over to the Table creation. The controlling properties above will not be\n+   * propagated.\n+   * @param conf a Hadoop conf\n+   * @param props the controlling properties\n+   * @return the created Iceberg table\n+   */\n+  public static Table createTable(Configuration conf, Properties props) {\n+    String schemaString = props.getProperty(InputFormatConfig.TABLE_SCHEMA);\n+    Preconditions.checkNotNull(schemaString, \"Table schema not set\");\n+    Schema schema = SchemaParser.fromJson(props.getProperty(InputFormatConfig.TABLE_SCHEMA));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTQxODcy", "url": "https://github.com/apache/iceberg/pull/1481#pullrequestreview-495141872", "createdAt": "2020-09-24T00:24:20Z", "commit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoyNDoyMFrOHXFkhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoyNDoyMFrOHXFkhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MDU2Ng==", "bodyText": "Somewhat out of scope: We might want to build a Catalog for this logic so that this class can avoid loading and checking the catalog in every method. The catalog would get created with the configuration and handle this delegation internally.", "url": "https://github.com/apache/iceberg/pull/1481#discussion_r493970566", "createdAt": "2020-09-24T00:24:20Z", "author": {"login": "rdblue"}, "path": "mr/src/main/java/org/apache/iceberg/mr/Catalogs.java", "diffHunk": "@@ -77,6 +102,77 @@ private static Table loadTable(Configuration conf, String tableIdentifier, Strin\n     return new HadoopTables(conf).load(tableLocation);\n   }\n \n+  /**\n+   * Creates an Iceberg table using the catalog specified by the configuration.\n+   * The properties should contain the following values:\n+   * <p><ul>\n+   * <li>Table identifier ({@link Catalogs#NAME}) or table path ({@link Catalogs#LOCATION}) is required\n+   * <li>Table schema ({@link InputFormatConfig#TABLE_SCHEMA}) is required\n+   * <li>Partition specification ({@link InputFormatConfig#PARTITION_SPEC}) is optional. Table will be unpartitioned if\n+   *  not provided\n+   * </ul><p>\n+   * Other properties will be handled over to the Table creation. The controlling properties above will not be\n+   * propagated.\n+   * @param conf a Hadoop conf\n+   * @param props the controlling properties\n+   * @return the created Iceberg table\n+   */\n+  public static Table createTable(Configuration conf, Properties props) {\n+    String schemaString = props.getProperty(InputFormatConfig.TABLE_SCHEMA);\n+    Preconditions.checkNotNull(schemaString, \"Table schema not set\");\n+    Schema schema = SchemaParser.fromJson(props.getProperty(InputFormatConfig.TABLE_SCHEMA));\n+\n+    String specString = props.getProperty(InputFormatConfig.PARTITION_SPEC);\n+    PartitionSpec spec = PartitionSpec.unpartitioned();\n+    if (specString != null) {\n+      spec = PartitionSpecParser.fromJson(schema, specString);\n+    }\n+\n+    String location = props.getProperty(LOCATION);\n+\n+    // Create a table property map without the controlling properties\n+    Map<String, String> map = new HashMap<>(props.size());\n+    for (Object key : props.keySet()) {\n+      if (!PROPERTIES_TO_REMOVE.contains(key)) {\n+        map.put(key.toString(), props.get(key).toString());\n+      }\n+    }\n+\n+    Optional<Catalog> catalog = loadCatalog(conf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9"}, "originalPosition": 111}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "514575eeed1ded9c4232462e568fbaf3b845fe49", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/514575eeed1ded9c4232462e568fbaf3b845fe49", "committedDate": "2020-09-24T10:07:56Z", "message": "Implement dropTable for HadoopTables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1207f1b2dfc78ede59bc41825aab4c6374d79f8", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/a1207f1b2dfc78ede59bc41825aab4c6374d79f8", "committedDate": "2020-09-24T10:07:56Z", "message": "Implement Catalogs.createTable, Catalogs.dropTable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e21ad740a497b209a4ae7fcb082ce77bb31857e2", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/e21ad740a497b209a4ae7fcb082ce77bb31857e2", "committedDate": "2020-09-24T10:07:56Z", "message": "Controlling properties should not be pushed to the actual table creation.\nJavadoc is revisited"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3df7efd418452c837ef566c39ecf17d40c9d1bcb", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/3df7efd418452c837ef566c39ecf17d40c9d1bcb", "committedDate": "2020-09-24T10:07:56Z", "message": "Fixing comment formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc28ebf41301e49939b571811645458152190dc8", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/fc28ebf41301e49939b571811645458152190dc8", "committedDate": "2020-09-24T10:07:56Z", "message": "Javadoc warning fixed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1960cde82595ac31d5c2beee5e806ae6bb9c5eb6", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/1960cde82595ac31d5c2beee5e806ae6bb9c5eb6", "committedDate": "2020-09-24T11:11:57Z", "message": "Addressed review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c584198d44cfa3b49fe93e078b1be11b1e66b8f9", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/c584198d44cfa3b49fe93e078b1be11b1e66b8f9", "committedDate": "2020-09-23T07:12:57Z", "message": "Javadoc warning fixed"}, "afterCommit": {"oid": "1960cde82595ac31d5c2beee5e806ae6bb9c5eb6", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/1960cde82595ac31d5c2beee5e806ae6bb9c5eb6", "committedDate": "2020-09-24T11:11:57Z", "message": "Addressed review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NzM3MjM3", "url": "https://github.com/apache/iceberg/pull/1481#pullrequestreview-495737237", "createdAt": "2020-09-24T16:14:55Z", "commit": {"oid": "1960cde82595ac31d5c2beee5e806ae6bb9c5eb6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjoxNDo1NVrOHXifEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjoxNDo1NVrOHXifEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ0NDMwNg==", "bodyText": "I should have caught this yesterday, but shouldn't this return false instead of throwing the exception? That's what all the other drop methods do. If the table doesn't exist, it isn't an exceptional case. It just returns false to signal that it nothing needed to be done.", "url": "https://github.com/apache/iceberg/pull/1481#discussion_r494444306", "createdAt": "2020-09-24T16:14:55Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTables.java", "diffHunk": "@@ -144,6 +147,52 @@ public Table create(Schema schema, PartitionSpec spec, SortOrder order,\n     return new BaseTable(ops, location);\n   }\n \n+  /**\n+   * Drop a table and delete all data and metadata files.\n+   *\n+   * @param location a path URI (e.g. hdfs:///warehouse/my_table)\n+   * @return true if the table was dropped\n+   * @throws NoSuchTableException if the table does not exists.\n+   */\n+  public boolean dropTable(String location) {\n+    return dropTable(location, true);\n+  }\n+\n+  /**\n+   * Drop a table; optionally delete data and metadata files.\n+   * <p>\n+   * If purge is set to true the implementation should delete all data and metadata files.\n+   *\n+   * @param location a path URI (e.g. hdfs:///warehouse/my_table)\n+   * @param purge if true, delete all data and metadata files in the table\n+   * @return true if the table was dropped\n+   * @throws NoSuchTableException if the table does not exists.\n+   */\n+  public boolean dropTable(String location, boolean purge) {\n+    TableOperations ops = newTableOps(location);\n+    TableMetadata lastMetadata = null;\n+    if (ops.current() != null) {\n+      if (purge) {\n+        lastMetadata = ops.current();\n+      }\n+    } else {\n+      throw new NoSuchTableException(\"Table does not exist at location: %s, so it can not be dropped\", location);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1960cde82595ac31d5c2beee5e806ae6bb9c5eb6"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66bb2e8999c174579d7c4e48f1f4cd5f7dd4d987", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/iceberg/commit/66bb2e8999c174579d7c4e48f1f4cd5f7dd4d987", "committedDate": "2020-09-25T11:03:40Z", "message": "Do not throw if the table did not exist"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3811, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}