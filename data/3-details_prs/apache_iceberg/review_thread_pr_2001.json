{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2Mjg2MDk5", "number": 2001, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNzo0NzoxN1rOFJ1K5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxODozNDo1NVrOFLZMFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1ODUyNjQ1OnYy", "diffSide": "RIGHT", "path": "parquet/src/test/java/org/apache/iceberg/parquet/ParquetWritingTestUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNzo0NzoxN1rOIMUrzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNzo0NzoxN1rOIMUrzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc5MjcxNw==", "bodyText": "This should still use try-with-resources. You just have to keep a reference to the writer outside of it:\n  FileAppender<Record> writer = Parquet.write(...);\n  try (Closeable toClose = writer) {\n    writer.addAll(records);\n  }\n\n  writer.length();", "url": "https://github.com/apache/iceberg/pull/2001#discussion_r549792717", "createdAt": "2020-12-29T17:47:17Z", "author": {"login": "rdblue"}, "path": "parquet/src/test/java/org/apache/iceberg/parquet/ParquetWritingTestUtils.java", "diffHunk": "@@ -53,20 +54,43 @@ static File writeRecords(TemporaryFolder temp, Schema schema,\n   }\n \n   static File writeRecords(\n-      TemporaryFolder temp,\n-      Schema schema, Map<String, String> properties,\n-      Function<MessageType, ParquetValueWriter<?>> createWriterFunc,\n-      GenericData.Record... records) throws IOException {\n+          TemporaryFolder temp,\n+          Schema schema, Map<String, String> properties,\n+          Function<MessageType, ParquetValueWriter<?>> createWriterFunc,\n+          GenericData.Record... records) throws IOException {\n+    File file = createTempFile(temp);\n+    write(file, schema, properties, createWriterFunc, records);\n+    return file;\n+  }\n+\n+  static long write(File file, Schema schema, Map<String, String> properties,\n+                    Function<MessageType, ParquetValueWriter<?>> createWriterFunc,\n+                    GenericData.Record... records) throws IOException {\n+    FileAppender<GenericData.Record> writer = Parquet.write(localOutput(file))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99b5d297dc331fd8bef660ae8aa6d4da270c4c0a"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1ODUyNzc4OnYy", "diffSide": "RIGHT", "path": "parquet/src/test/java/org/apache/iceberg/parquet/TestParquet.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNzo0ODowNVrOIMUsjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNzo0ODowNVrOIMUsjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc5MjkxMQ==", "bodyText": "Looks like a typo.", "url": "https://github.com/apache/iceberg/pull/2001#discussion_r549792911", "createdAt": "2020-12-29T17:48:05Z", "author": {"login": "rdblue"}, "path": "parquet/src/test/java/org/apache/iceberg/parquet/TestParquet.java", "diffHunk": "@@ -82,15 +114,17 @@ private File generateFileWithTwoRowGroups(Function<MessageType, ParquetValueWrit\n       records.add(record);\n     }\n \n-    // Force multiple row groups by making the byte size very small\n+    // Force multiple row groups by making the byte size vParquetWriteAdapterery small", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99b5d297dc331fd8bef660ae8aa6d4da270c4c0a"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1ODUzMjk1OnYy", "diffSide": "RIGHT", "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNzo1MDo0MlrOIMUvmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxOTozMTowM1rOIN-Nnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc5MzY5MQ==", "bodyText": "If this is going to track whether the writer is closed, then it should make the close idempotent by checking the flag:\n  if (!closed) {\n    this.closed = true;\n    flushRowGroup(true);\n    writeStore.close();\n    writer.end(metadata);\n  }\nI would also add a precondition in startRowGroup that checks that closed is false.", "url": "https://github.com/apache/iceberg/pull/2001#discussion_r549793691", "createdAt": "2020-12-29T17:50:42Z", "author": {"login": "rdblue"}, "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "diffHunk": "@@ -192,5 +203,6 @@ public void close() throws IOException {\n     flushRowGroup(true);\n     writeStore.close();\n     writer.end(metadata);\n+    this.closed = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99b5d297dc331fd8bef660ae8aa6d4da270c4c0a"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUyMTY5NQ==", "bodyText": "I'd also add :\nelse {\n  throw new IllegalStateException(\"writer is closed\");\n}\nbut note sure if it aligns with Iceberg's coding style", "url": "https://github.com/apache/iceberg/pull/2001#discussion_r551521695", "createdAt": "2021-01-04T19:31:03Z", "author": {"login": "dmgcodevil"}, "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "diffHunk": "@@ -192,5 +203,6 @@ public void close() throws IOException {\n     flushRowGroup(true);\n     writeStore.close();\n     writer.end(metadata);\n+    this.closed = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc5MzY5MQ=="}, "originalCommit": {"oid": "99b5d297dc331fd8bef660ae8aa6d4da270c4c0a"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3MTY2MDkzOnYy", "diffSide": "RIGHT", "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQyMzoxMjo0NFrOIOEa2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQyMzoxMjo0NFrOIOEa2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYyMzM4Ng==", "bodyText": "Error messages should begin with a capital letter.", "url": "https://github.com/apache/iceberg/pull/2001#discussion_r551623386", "createdAt": "2021-01-04T23:12:44Z", "author": {"login": "rdblue"}, "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "diffHunk": "@@ -170,6 +181,9 @@ private void flushRowGroup(boolean finished) {\n   }\n \n   private void startRowGroup() {\n+    if (this.closed) {\n+      throw new IllegalStateException(\"writer is closed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "739fee73dea04657ee38b922d5275b5061c4118e"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3MTY2MTMwOnYy", "diffSide": "RIGHT", "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQyMzoxMzowMVrOIOEbIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQyMzoxMzowMVrOIOEbIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYyMzQ1Nw==", "bodyText": "Can you add a blank line between control flow blocks?", "url": "https://github.com/apache/iceberg/pull/2001#discussion_r551623457", "createdAt": "2021-01-04T23:13:01Z", "author": {"login": "rdblue"}, "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "diffHunk": "@@ -170,6 +181,9 @@ private void flushRowGroup(boolean finished) {\n   }\n \n   private void startRowGroup() {\n+    if (this.closed) {\n+      throw new IllegalStateException(\"writer is closed\");\n+    }\n     try {\n       this.nextRowGroupSize = Math.min(writer.getNextRowGroupSize(), targetRowGroupSize);\n     } catch (IOException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "739fee73dea04657ee38b922d5275b5061c4118e"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3MTY2Njk2OnYy", "diffSide": "RIGHT", "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQyMzoxNToxN1rOIOEeUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQyMzoxNToxN1rOIOEeUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYyNDI3NA==", "bodyText": "This isn't quite accurate. It is the number of bytes written only after the writer is closed. How about @return length of the file produced by this writer, approximate until after closed", "url": "https://github.com/apache/iceberg/pull/2001#discussion_r551624274", "createdAt": "2021-01-04T23:15:17Z", "author": {"login": "rdblue"}, "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "diffHunk": "@@ -124,10 +125,20 @@ public Metrics metrics() {\n     return ParquetUtil.footerMetrics(writer.getFooter(), model.metrics(), metricsConfig);\n   }\n \n+  /**\n+   * Returns the number of bytes written by this writer.\n+   * NOTE: call {@link ParquetWriter#close()})} prior this method to get the exact number of bytes.\n+   *\n+   * @return the number of bytes written by this writer.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "739fee73dea04657ee38b922d5275b5061c4118e"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3MTY3MjkwOnYy", "diffSide": "RIGHT", "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQyMzoxNzo1MFrOIOEhtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQyMzozNTozOVrOIOE5BA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYyNTE0MQ==", "bodyText": "This is going to be wrapped into a single paragraph. Also, it is okay to describe the behavior without NOTE.\nHow about this?\n  /**\n   * Returns the approximate length of the output file produced by this writer.\n   * <p>\n   * Prior to calling {@link ParquetWriter#close}, the result is approximate. After calling close, the length is exact.\n   */", "url": "https://github.com/apache/iceberg/pull/2001#discussion_r551625141", "createdAt": "2021-01-04T23:17:50Z", "author": {"login": "rdblue"}, "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "diffHunk": "@@ -124,10 +125,20 @@ public Metrics metrics() {\n     return ParquetUtil.footerMetrics(writer.getFooter(), model.metrics(), metricsConfig);\n   }\n \n+  /**\n+   * Returns the number of bytes written by this writer.\n+   * NOTE: call {@link ParquetWriter#close()})} prior this method to get the exact number of bytes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "739fee73dea04657ee38b922d5275b5061c4118e"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzMTEwOA==", "bodyText": "sounds good", "url": "https://github.com/apache/iceberg/pull/2001#discussion_r551631108", "createdAt": "2021-01-04T23:35:39Z", "author": {"login": "dmgcodevil"}, "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "diffHunk": "@@ -124,10 +125,20 @@ public Metrics metrics() {\n     return ParquetUtil.footerMetrics(writer.getFooter(), model.metrics(), metricsConfig);\n   }\n \n+  /**\n+   * Returns the number of bytes written by this writer.\n+   * NOTE: call {@link ParquetWriter#close()})} prior this method to get the exact number of bytes.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYyNTE0MQ=="}, "originalCommit": {"oid": "739fee73dea04657ee38b922d5275b5061c4118e"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NDkxMDkxOnYy", "diffSide": "RIGHT", "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxODozNDowN1rOIOilTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxODozNDowN1rOIOilTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExNzU4MA==", "bodyText": "This needs a @return as well.", "url": "https://github.com/apache/iceberg/pull/2001#discussion_r552117580", "createdAt": "2021-01-05T18:34:07Z", "author": {"login": "rdblue"}, "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "diffHunk": "@@ -124,10 +125,20 @@ public Metrics metrics() {\n     return ParquetUtil.footerMetrics(writer.getFooter(), model.metrics(), metricsConfig);\n   }\n \n+  /**\n+   * Returns the approximate length of the output file produced by this writer.\n+   * <p>\n+   * Prior to calling {@link ParquetWriter#close}, the result is approximate. After calling close, the length is\n+   * exact.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ea135f1a44f87bc6426af59a7621f08311665b6"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NDkxMjAyOnYy", "diffSide": "RIGHT", "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxODozNDozMVrOIOimCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxODozNDozMVrOIOimCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExNzc2OQ==", "bodyText": "Nit: no need to use this. unless setting an instance variable.", "url": "https://github.com/apache/iceberg/pull/2001#discussion_r552117769", "createdAt": "2021-01-05T18:34:31Z", "author": {"login": "rdblue"}, "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "diffHunk": "@@ -124,10 +125,20 @@ public Metrics metrics() {\n     return ParquetUtil.footerMetrics(writer.getFooter(), model.metrics(), metricsConfig);\n   }\n \n+  /**\n+   * Returns the approximate length of the output file produced by this writer.\n+   * <p>\n+   * Prior to calling {@link ParquetWriter#close}, the result is approximate. After calling close, the length is\n+   * exact.\n+   */\n   @Override\n   public long length() {\n     try {\n-      return writer.getPos() + (writeStore.isColumnFlushNeeded() ? writeStore.getBufferedSize() : 0);\n+      if (this.closed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ea135f1a44f87bc6426af59a7621f08311665b6"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NDkxMzQ5OnYy", "diffSide": "RIGHT", "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxODozNDo1NVrOIOim6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxODozNDo1NVrOIOim6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExNzk5NQ==", "bodyText": "We would normally use Preconditions.checkState for this, but this is minor.", "url": "https://github.com/apache/iceberg/pull/2001#discussion_r552117995", "createdAt": "2021-01-05T18:34:55Z", "author": {"login": "rdblue"}, "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetWriter.java", "diffHunk": "@@ -170,6 +181,10 @@ private void flushRowGroup(boolean finished) {\n   }\n \n   private void startRowGroup() {\n+    if (this.closed) {\n+      throw new IllegalStateException(\"Writer is closed\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ea135f1a44f87bc6426af59a7621f08311665b6"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3109, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}