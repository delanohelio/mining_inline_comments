{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM3NjUyOTc1", "number": 1919, "title": "Add UpdatePartitionSpec implementation", "bodyText": "This adds a new API for partition spec evolution and an implementation to produce updated specs. This doesn't include adding the new API to table and transaction, adding a last assigned partition ID to metadata, or documentation for the new API. This is primarily the implementation and tests, to be followed with more integration and docs.", "createdAt": "2020-12-12T01:57:32Z", "url": "https://github.com/apache/iceberg/pull/1919", "merged": true, "mergeCommit": {"oid": "ab6a5e9ebf2f580fb7be21fb00f1f543726f43eb"}, "closed": true, "closedAt": "2020-12-16T01:52:19Z", "author": {"login": "rdblue"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlSrY5gFqTU1MDY3NzYxOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmj64egFqTU1MzE4NDgwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjc3NjE4", "url": "https://github.com/apache/iceberg/pull/1919#pullrequestreview-550677618", "createdAt": "2020-12-12T01:58:07Z", "commit": {"oid": "9d39ee11d4066100bb8d1cf9e5899dec2d37635d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMTo1ODowN1rOIEY-MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMTo1ODowN1rOIEY-MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3NDM1Mg==", "bodyText": "Needed to add fields using Transform, not a string.", "url": "https://github.com/apache/iceberg/pull/1919#discussion_r541474352", "createdAt": "2020-12-12T01:58:07Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/PartitionSpec.java", "diffHunk": "@@ -480,9 +481,13 @@ Builder add(int sourceId, String name, String transform) {\n \n     Builder add(int sourceId, int fieldId, String name, String transform) {\n       Types.NestedField column = schema.findField(sourceId);\n-      checkAndAddPartitionName(name, column.fieldId());\n       Preconditions.checkNotNull(column, \"Cannot find source column: %s\", sourceId);\n-      fields.add(new PartitionField(sourceId, fieldId, name, Transforms.fromString(column.type(), transform)));\n+      return add(sourceId, fieldId, name, Transforms.fromString(column.type(), transform));\n+    }\n+\n+    Builder add(int sourceId, int fieldId, String name, Transform<?, ?> transform) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d39ee11d4066100bb8d1cf9e5899dec2d37635d"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjc3NjU3", "url": "https://github.com/apache/iceberg/pull/1919#pullrequestreview-550677657", "createdAt": "2020-12-12T01:58:27Z", "commit": {"oid": "9d39ee11d4066100bb8d1cf9e5899dec2d37635d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMTo1ODoyN1rOIEY-Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMTo1ODoyN1rOIEY-Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3NDM5OQ==", "bodyText": "Needed to allow identity partitions that have been deleted.", "url": "https://github.com/apache/iceberg/pull/1919#discussion_r541474399", "createdAt": "2020-12-12T01:58:27Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/PartitionSpec.java", "diffHunk": "@@ -463,8 +464,8 @@ public Builder truncate(String sourceName, int width) {\n     }\n \n     public Builder alwaysNull(String sourceName, String targetName) {\n-      checkAndAddPartitionName(targetName);\n       Types.NestedField sourceColumn = findSourceColumn(sourceName);\n+      checkAndAddPartitionName(targetName, sourceColumn.fieldId()); // can duplicate a source column name", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d39ee11d4066100bb8d1cf9e5899dec2d37635d"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjc3Njgy", "url": "https://github.com/apache/iceberg/pull/1919#pullrequestreview-550677682", "createdAt": "2020-12-12T01:58:45Z", "commit": {"oid": "9d39ee11d4066100bb8d1cf9e5899dec2d37635d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMTo1ODo0NVrOIEY-kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMTo1ODo0NVrOIEY-kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3NDQ1MQ==", "bodyText": "Will add Javadoc for these methods after there is agreement on this API.", "url": "https://github.com/apache/iceberg/pull/1919#discussion_r541474451", "createdAt": "2020-12-12T01:58:45Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/UpdatePartitionSpec.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import org.apache.iceberg.exceptions.CommitFailedException;\n+import org.apache.iceberg.expressions.Term;\n+\n+/**\n+ * API for partition spec evolution.\n+ * <p>\n+ * When committing, these changes will be applied to the current table metadata. Commit conflicts\n+ * will not be resolved and will result in a {@link CommitFailedException}.\n+ */\n+public interface UpdatePartitionSpec extends PendingUpdate<PartitionSpec> {\n+  UpdatePartitionSpec addField(String sourceName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d39ee11d4066100bb8d1cf9e5899dec2d37635d"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjc3NzU0", "url": "https://github.com/apache/iceberg/pull/1919#pullrequestreview-550677754", "createdAt": "2020-12-12T01:59:31Z", "commit": {"oid": "9d39ee11d4066100bb8d1cf9e5899dec2d37635d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMTo1OTozMVrOIEY_Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMTo1OTozMVrOIEY_Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3NDU5OA==", "bodyText": "Refactored this out of the method above to visit individual fields, for setting default partition names based on the transform.", "url": "https://github.com/apache/iceberg/pull/1919#discussion_r541474598", "createdAt": "2020-12-12T01:59:31Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/transforms/PartitionSpecVisitor.java", "diffHunk": "@@ -113,37 +113,43 @@ default T unknown(int fieldId, String sourceName, int sourceId, String transform\n    * @deprecated this will be removed in 0.11.0; use {@link #visit(PartitionSpec, PartitionSpecVisitor)} instead.\n    */\n   @Deprecated\n-  @SuppressWarnings(\"checkstyle:CyclomaticComplexity\")\n   static <R> List<R> visit(Schema schema, PartitionSpec spec, PartitionSpecVisitor<R> visitor) {\n     List<R> results = Lists.newArrayListWithExpectedSize(spec.fields().size());\n \n     for (PartitionField field : spec.fields()) {\n-      String sourceName = schema.findColumnName(field.sourceId());\n-      Transform<?, ?> transform = field.transform();\n-\n-      if (transform instanceof Identity) {\n-        results.add(visitor.identity(field.fieldId(), sourceName, field.sourceId()));\n-      } else if (transform instanceof Bucket) {\n-        int numBuckets = ((Bucket<?>) transform).numBuckets();\n-        results.add(visitor.bucket(field.fieldId(), sourceName, field.sourceId(), numBuckets));\n-      } else if (transform instanceof Truncate) {\n-        int width = ((Truncate<?>) transform).width();\n-        results.add(visitor.truncate(field.fieldId(), sourceName, field.sourceId(), width));\n-      } else if (transform == Dates.YEAR || transform == Timestamps.YEAR) {\n-        results.add(visitor.year(field.fieldId(), sourceName, field.sourceId()));\n-      } else if (transform == Dates.MONTH || transform == Timestamps.MONTH) {\n-        results.add(visitor.month(field.fieldId(), sourceName, field.sourceId()));\n-      } else if (transform == Dates.DAY || transform == Timestamps.DAY) {\n-        results.add(visitor.day(field.fieldId(), sourceName, field.sourceId()));\n-      } else if (transform == Timestamps.HOUR) {\n-        results.add(visitor.hour(field.fieldId(), sourceName, field.sourceId()));\n-      } else if (transform instanceof VoidTransform) {\n-        results.add(visitor.alwaysNull(field.fieldId(), sourceName, field.sourceId()));\n-      } else if (transform instanceof UnknownTransform) {\n-        results.add(visitor.unknown(field.fieldId(), sourceName, field.sourceId(), transform.toString()));\n-      }\n+      results.add(visit(schema, field, visitor));\n     }\n \n     return results;\n   }\n+\n+  static <R> R visit(Schema schema, PartitionField field, PartitionSpecVisitor<R> visitor) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d39ee11d4066100bb8d1cf9e5899dec2d37635d"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d39ee11d4066100bb8d1cf9e5899dec2d37635d", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/9d39ee11d4066100bb8d1cf9e5899dec2d37635d", "committedDate": "2020-12-12T01:54:56Z", "message": "Add UpdatePartitionSpec implementation."}, "afterCommit": {"oid": "b14153359eb8513b32df74fb68dbc002ae505145", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/b14153359eb8513b32df74fb68dbc002ae505145", "committedDate": "2020-12-12T02:01:21Z", "message": "Add UpdatePartitionSpec implementation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1bd036b01c1a84548664cddc4e3fa395b8e7c14", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/d1bd036b01c1a84548664cddc4e3fa395b8e7c14", "committedDate": "2020-12-12T21:11:41Z", "message": "Add UpdatePartitionSpec implementation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b14153359eb8513b32df74fb68dbc002ae505145", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/b14153359eb8513b32df74fb68dbc002ae505145", "committedDate": "2020-12-12T02:01:21Z", "message": "Add UpdatePartitionSpec implementation."}, "afterCommit": {"oid": "d1bd036b01c1a84548664cddc4e3fa395b8e7c14", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/d1bd036b01c1a84548664cddc4e3fa395b8e7c14", "committedDate": "2020-12-12T21:11:41Z", "message": "Add UpdatePartitionSpec implementation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0e9dcd6aa9655619ff8855b377393ac7943bb1a", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/a0e9dcd6aa9655619ff8855b377393ac7943bb1a", "committedDate": "2020-12-12T21:21:02Z", "message": "Add tests and fix context messages."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwODcwMzk5", "url": "https://github.com/apache/iceberg/pull/1919#pullrequestreview-550870399", "createdAt": "2020-12-12T23:33:10Z", "commit": {"oid": "a0e9dcd6aa9655619ff8855b377393ac7943bb1a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQyMzozMzoxMFrOIEs-7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQyMzozMzoxMFrOIEs-7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTgwMjIyMw==", "bodyText": "Maybe add a test for .removeField(\"myField\").addField(\"myField\")? What's the expected outcome for that?", "url": "https://github.com/apache/iceberg/pull/1919#discussion_r541802223", "createdAt": "2020-12-12T23:33:10Z", "author": {"login": "johnclara"}, "path": "core/src/test/java/org/apache/iceberg/TestUpdatePartitionSpecV1.java", "diffHunk": "@@ -0,0 +1,444 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import org.apache.iceberg.relocated.com.google.common.collect.ImmutableList;\n+import org.apache.iceberg.transforms.Transforms;\n+import org.apache.iceberg.types.Types;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import static org.apache.iceberg.expressions.Expressions.bucket;\n+import static org.apache.iceberg.expressions.Expressions.day;\n+import static org.apache.iceberg.expressions.Expressions.hour;\n+import static org.apache.iceberg.expressions.Expressions.month;\n+import static org.apache.iceberg.expressions.Expressions.ref;\n+import static org.apache.iceberg.expressions.Expressions.truncate;\n+import static org.apache.iceberg.expressions.Expressions.year;\n+\n+public class TestUpdatePartitionSpecV1 {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0e9dcd6aa9655619ff8855b377393ac7943bb1a"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b1d1c8829b2dd53730b41aa12f0967fd24f854b", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/1b1d1c8829b2dd53730b41aa12f0967fd24f854b", "committedDate": "2020-12-15T01:37:21Z", "message": "Combine v1 and v2 tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdf03c979d516ef736888f82569fea4697afa597", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/cdf03c979d516ef736888f82569fea4697afa597", "committedDate": "2020-12-15T16:26:39Z", "message": "Add more test cases."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce56c319ce3403a6d4ae5f498257534d5ddc08ab", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/ce56c319ce3403a6d4ae5f498257534d5ddc08ab", "committedDate": "2020-12-15T16:45:23Z", "message": "Catch duplicate time partitions and improve error messages."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMTg0ODAw", "url": "https://github.com/apache/iceberg/pull/1919#pullrequestreview-553184800", "createdAt": "2020-12-16T00:37:21Z", "commit": {"oid": "ce56c319ce3403a6d4ae5f498257534d5ddc08ab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3601, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}