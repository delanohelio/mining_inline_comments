{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1MzUzNTQy", "number": 936, "title": "Update TableTestBase tests to run with formats v1 and v2", "bodyText": "This updates all of the tests that extend TableTestBase to run with a formatVersion parameter. This checks that operations work in both v1 and v2. This doesn't add any tests that run operations in v1 and upgrade the table to v2. Those will be added in another PR.", "createdAt": "2020-04-17T21:41:20Z", "url": "https://github.com/apache/iceberg/pull/936", "merged": true, "mergeCommit": {"oid": "a81d11e78fb447f68b2a3e8f98cf02b0c57c7f58"}, "closed": true, "closedAt": "2020-04-21T19:50:33Z", "author": {"login": "rdblue"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYouATgBqjMyNDYxMzYxMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZ4_n7AH2gAyNDA1MzUzNTQyOmM5YzQwYjEyMjMxYjA5YTc4NGIzNzE3ZDNmNzU1MDQ2MTBlZGM2ZTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "60501e24dc08988d1a0277c43bf2e09422ff515b", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/60501e24dc08988d1a0277c43bf2e09422ff515b", "committedDate": "2020-04-17T21:39:21Z", "message": "Update TableTestBase tests to run on v1 and v2."}, "afterCommit": {"oid": "5c08e31589895f1965efbf0bb0c793376a805541", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/5c08e31589895f1965efbf0bb0c793376a805541", "committedDate": "2020-04-17T22:06:29Z", "message": "Update TableTestBase tests to run on v1 and v2."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjU1NDkw", "url": "https://github.com/apache/iceberg/pull/936#pullrequestreview-396655490", "createdAt": "2020-04-20T17:17:43Z", "commit": {"oid": "5c08e31589895f1965efbf0bb0c793376a805541"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNzoxNzo0M1rOGIfJ3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNzoxNzo0M1rOGIfJ3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU1MjIyMQ==", "bodyText": "This needed to change because it isn't possible to write entries to a manifest that inherits a sequence number but not snapshot ID, unless the snapshot ID matches the commit.", "url": "https://github.com/apache/iceberg/pull/936#discussion_r411552221", "createdAt": "2020-04-20T17:17:43Z", "author": {"login": "rdblue"}, "path": "core/src/test/java/org/apache/iceberg/TestManifestWriter.java", "diffHunk": "@@ -24,22 +24,36 @@\n import org.apache.iceberg.ManifestEntry.Status;\n import org.junit.Assert;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n \n+@RunWith(Parameterized.class)\n public class TestManifestWriter extends TableTestBase {\n+  @Parameterized.Parameters\n+  public static Object[][] parameters() {\n+    return new Object[][] {\n+        new Object[] { 1 },\n+        new Object[] { 2 },\n+    };\n+  }\n+\n+  public TestManifestWriter(int formatVersion) {\n+    super(formatVersion);\n+  }\n \n   @Test\n   public void testManifestStats() throws IOException {\n     ManifestFile manifest = writeManifest(\n         \"manifest.avro\",\n-        manifestEntry(Status.ADDED, 100L, newFile(10)),\n-        manifestEntry(Status.ADDED, 100L, newFile(20)),\n-        manifestEntry(Status.ADDED, 100L, newFile(5)),\n-        manifestEntry(Status.ADDED, 100L, newFile(5)),\n-        manifestEntry(Status.EXISTING, 100L, newFile(15)),\n-        manifestEntry(Status.EXISTING, 100L, newFile(10)),\n-        manifestEntry(Status.EXISTING, 100L, newFile(1)),\n-        manifestEntry(Status.DELETED, 100L, newFile(5)),\n-        manifestEntry(Status.DELETED, 100L, newFile(2)));\n+        manifestEntry(Status.ADDED, null, newFile(10)),\n+        manifestEntry(Status.ADDED, null, newFile(20)),\n+        manifestEntry(Status.ADDED, null, newFile(5)),\n+        manifestEntry(Status.ADDED, null, newFile(5)),\n+        manifestEntry(Status.EXISTING, null, newFile(15)),\n+        manifestEntry(Status.EXISTING, null, newFile(10)),\n+        manifestEntry(Status.EXISTING, null, newFile(1)),\n+        manifestEntry(Status.DELETED, null, newFile(5)),\n+        manifestEntry(Status.DELETED, null, newFile(2)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c08e31589895f1965efbf0bb0c793376a805541"}, "originalPosition": 42}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c08e31589895f1965efbf0bb0c793376a805541", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/5c08e31589895f1965efbf0bb0c793376a805541", "committedDate": "2020-04-17T22:06:29Z", "message": "Update TableTestBase tests to run on v1 and v2."}, "afterCommit": {"oid": "ad15ff4b395d3220517f860e052edc19e1e493c2", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/ad15ff4b395d3220517f860e052edc19e1e493c2", "committedDate": "2020-04-20T21:05:31Z", "message": "Update TableTestBase tests to run on v1 and v2."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d8998073a3f9676eeca9a2fb09d91f695497874", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/9d8998073a3f9676eeca9a2fb09d91f695497874", "committedDate": "2020-04-20T21:20:18Z", "message": "Update TableTestBase tests to run on v1 and v2."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad15ff4b395d3220517f860e052edc19e1e493c2", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/ad15ff4b395d3220517f860e052edc19e1e493c2", "committedDate": "2020-04-20T21:05:31Z", "message": "Update TableTestBase tests to run on v1 and v2."}, "afterCommit": {"oid": "9d8998073a3f9676eeca9a2fb09d91f695497874", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/9d8998073a3f9676eeca9a2fb09d91f695497874", "committedDate": "2020-04-20T21:20:18Z", "message": "Update TableTestBase tests to run on v1 and v2."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2ODIyMjkx", "url": "https://github.com/apache/iceberg/pull/936#pullrequestreview-396822291", "createdAt": "2020-04-20T21:21:53Z", "commit": {"oid": "9d8998073a3f9676eeca9a2fb09d91f695497874"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMToyMTo1NFrOGIoOmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMToyMTo1NFrOGIoOmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTcwMDg4OQ==", "bodyText": "This is needed to create v2 tables in tests. It isn't public.", "url": "https://github.com/apache/iceberg/pull/936#discussion_r411700889", "createdAt": "2020-04-20T21:21:54Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -52,6 +52,14 @@ public static TableMetadata newTableMetadata(Schema schema,\n                                                PartitionSpec spec,\n                                                String location,\n                                                Map<String, String> properties) {\n+    return newTableMetadata(schema, spec, location, properties, DEFAULT_TABLE_FORMAT_VERSION);\n+  }\n+\n+  static TableMetadata newTableMetadata(Schema schema,\n+                                        PartitionSpec spec,\n+                                        String location,\n+                                        Map<String, String> properties,\n+                                        int formatVersion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d8998073a3f9676eeca9a2fb09d91f695497874"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2ODIyNzg0", "url": "https://github.com/apache/iceberg/pull/936#pullrequestreview-396822784", "createdAt": "2020-04-20T21:22:42Z", "commit": {"oid": "9d8998073a3f9676eeca9a2fb09d91f695497874"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMToyMjo0MlrOGIoQHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMToyMjo0MlrOGIoQHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTcwMTI3OQ==", "bodyText": "Copied manifests will use a null snapshot ID.", "url": "https://github.com/apache/iceberg/pull/936#discussion_r411701279", "createdAt": "2020-04-20T21:22:42Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/V2Metadata.java", "diffHunk": "@@ -243,11 +243,11 @@ static Schema wrapFileSchema(Types.StructType fileSchema) {\n \n   static class IndexedManifestEntry implements ManifestEntry, IndexedRecord {\n     private final org.apache.avro.Schema avroSchema;\n-    private final long commitSnapshotId;\n+    private final Long commitSnapshotId;\n     private final V1Metadata.IndexedDataFile fileWrapper;\n     private ManifestEntry wrapped = null;\n \n-    IndexedManifestEntry(long commitSnapshotId, Types.StructType partitionType) {\n+    IndexedManifestEntry(Long commitSnapshotId, Types.StructType partitionType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d8998073a3f9676eeca9a2fb09d91f695497874"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NTQzNzgx", "url": "https://github.com/apache/iceberg/pull/936#pullrequestreview-397543781", "createdAt": "2020-04-21T17:57:43Z", "commit": {"oid": "9d8998073a3f9676eeca9a2fb09d91f695497874"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzo1Nzo0M1rOGJRKdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzo1Nzo0M1rOGJRKdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3MTU3NQ==", "bodyText": "Does this mean manifests will be written with the v2 schema (i.e. with sequence numbers) even though TableMetadata is v1 and the manifest list is written with v1? And this should work because we do a projection on read and sequence number is optional?", "url": "https://github.com/apache/iceberg/pull/936#discussion_r412371575", "createdAt": "2020-04-21T17:57:43Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/ManifestFiles.java", "diffHunk": "@@ -73,8 +73,8 @@ public static ManifestReader read(ManifestFile manifest, FileIO io, Map<Integer,\n    * @return a manifest writer\n    */\n   public static ManifestWriter write(PartitionSpec spec, OutputFile outputFile) {\n-    // always use a v1 writer for appended manifests because sequence number must be inherited\n-    return write(1, spec, outputFile, null);\n+    // always use a v2 writer to preserve sequence numbers, but use null for sequence number so appends inherit", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d8998073a3f9676eeca9a2fb09d91f695497874"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NjA4MzMy", "url": "https://github.com/apache/iceberg/pull/936#pullrequestreview-397608332", "createdAt": "2020-04-21T19:26:17Z", "commit": {"oid": "9d8998073a3f9676eeca9a2fb09d91f695497874"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxOToyNjoxN1rOGJUx2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxOToyNjoxN1rOGJUx2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQzMDgwOA==", "bodyText": "I think we have to update the condition in get as commitSnapshotId is now Long and we cannot use ==.", "url": "https://github.com/apache/iceberg/pull/936#discussion_r412430808", "createdAt": "2020-04-21T19:26:17Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/V2Metadata.java", "diffHunk": "@@ -243,11 +243,11 @@ static Schema wrapFileSchema(Types.StructType fileSchema) {\n \n   static class IndexedManifestEntry implements ManifestEntry, IndexedRecord {\n     private final org.apache.avro.Schema avroSchema;\n-    private final long commitSnapshotId;\n+    private final Long commitSnapshotId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d8998073a3f9676eeca9a2fb09d91f695497874"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9c40b12231b09a784b3717d3f75504610edc6e5", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/c9c40b12231b09a784b3717d3f75504610edc6e5", "committedDate": "2020-04-21T19:38:22Z", "message": "Fix equality check."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4823, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}