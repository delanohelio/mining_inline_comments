{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMDUxNDA2", "number": 983, "title": "Convert date and timestamp values in generics", "bodyText": "This fixes #972.", "createdAt": "2020-04-28T11:16:57Z", "url": "https://github.com/apache/iceberg/pull/983", "merged": true, "mergeCommit": {"oid": "0ee6f120a475ee3a7026e689886195d4a9acbf51"}, "closed": true, "closedAt": "2020-05-26T16:42:37Z", "author": {"login": "chenjunjiedada"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccCGX6AFqTQwMTczOTM4Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABck-paNAH2gAyNDEwMDUxNDA2OmNjMTg5ZDg0ZjA3YmNjYTE2YjM2Y2FjZjYyNDlmOTczZWFlZTk2MzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNzM5Mzg2", "url": "https://github.com/apache/iceberg/pull/983#pullrequestreview-401739386", "createdAt": "2020-04-28T11:22:43Z", "commit": {"oid": "0a8207e635369efa3ccb091be7bb2e9bcb3e65b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMToyMjo0M1rOGNPRbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMToyMjo0M1rOGNPRbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjUzNDg5NQ==", "bodyText": "This is due to https://issues.apache.org/jira/browse/PARQUET-1851.", "url": "https://github.com/apache/iceberg/pull/983#discussion_r416534895", "createdAt": "2020-04-28T11:22:43Z", "author": {"login": "chenjunjiedada"}, "path": "data/src/test/java/org/apache/iceberg/data/TestLocalScan.java", "diffHunk": "@@ -449,6 +454,45 @@ private DataFile writeFile(String location, String filename, List<Record> record\n     }\n   }\n \n+  @Test\n+  public void testFilterWithComplexType() throws IOException {\n+    if (format == FileFormat.PARQUET) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a8207e635369efa3ccb091be7bb2e9bcb3e65b8"}, "originalPosition": 51}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d937e4f4b17d95604c179ebaf19ba94e6f9b5266", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/d937e4f4b17d95604c179ebaf19ba94e6f9b5266", "committedDate": "2020-04-29T12:38:24Z", "message": "Add DateAccessor, TimeAccessor, and TimestampAccessor"}, "afterCommit": {"oid": "cfd1bf6120ebd705ad24045b3d4744585b798282", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/cfd1bf6120ebd705ad24045b3d4744585b798282", "committedDate": "2020-04-29T12:40:56Z", "message": "Add DateAccessor, TimeAccessor, and TimestampAccessor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyODU5MDgx", "url": "https://github.com/apache/iceberg/pull/983#pullrequestreview-402859081", "createdAt": "2020-04-29T16:55:52Z", "commit": {"oid": "cfd1bf6120ebd705ad24045b3d4744585b798282"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNjo1NTo1MlrOGOIJug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNjo1NTo1MlrOGOIJug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ2NjgxMA==", "bodyText": "Why were these changes necessary?", "url": "https://github.com/apache/iceberg/pull/983#discussion_r417466810", "createdAt": "2020-04-29T16:55:52Z", "author": {"login": "rdblue"}, "path": "api/src/test/java/org/apache/iceberg/transforms/TestResiduals.java", "diffHunk": "@@ -191,26 +191,18 @@ public void testInTimestamp() {\n         Types.NestedField.optional(51, \"dateint\", Types.IntegerType.get())\n     );\n \n-    Long date20191201 = (Long) Literal.of(\"2019-12-01T00:00:00.00000\")\n-        .to(Types.TimestampType.withoutZone()).value();\n-    Long date20191202 = (Long) Literal.of(\"2019-12-02T00:00:00.00000\")\n-        .to(Types.TimestampType.withoutZone()).value();\n-\n     PartitionSpec spec = PartitionSpec.builderFor(schema)\n         .day(\"ts\")\n         .build();\n \n-    Transform day = spec.getFieldsBySourceId(50).get(0).transform();\n-    Integer tsDay = (Integer) day.apply(date20191201);\n-\n-    Predicate pred = in(\"ts\", date20191201, date20191202);\n+    Predicate pred = in(\"ts\", \"2019-12-01T00:00:00.00000\", \"2019-12-01T00:00:00.00000\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd1bf6120ebd705ad24045b3d4744585b798282"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyODYxMjQ5", "url": "https://github.com/apache/iceberg/pull/983#pullrequestreview-402861249", "createdAt": "2020-04-29T16:58:26Z", "commit": {"oid": "cfd1bf6120ebd705ad24045b3d4744585b798282"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNjo1ODoyNlrOGOIQqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNjo1ODoyNlrOGOIQqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ2ODU4NA==", "bodyText": "These accessors are for types used by Iceberg generics. I don't think that we want to make them part of the public API, and we need to be able to add them when using generics but not use them when binding to other rows. These should not be used with PartitionData instances, for example.", "url": "https://github.com/apache/iceberg/pull/983#discussion_r417468584", "createdAt": "2020-04-29T16:58:26Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/Accessors.java", "diffHunk": "@@ -187,6 +206,47 @@ public String toString() {\n     }\n   }\n \n+  private static class DateAccessor extends PositionAccessor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd1bf6120ebd705ad24045b3d4744585b798282"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyODY1MzEy", "url": "https://github.com/apache/iceberg/pull/983#pullrequestreview-402865312", "createdAt": "2020-04-29T17:03:42Z", "commit": {"oid": "cfd1bf6120ebd705ad24045b3d4744585b798282"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzowMzo0MlrOGOIdSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzowMzo0MlrOGOIdSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MTgxOQ==", "bodyText": "By moving these into iceberg-data, we can reuse the util class DateTimeUtil.", "url": "https://github.com/apache/iceberg/pull/983#discussion_r417471819", "createdAt": "2020-04-29T17:03:42Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/Accessors.java", "diffHunk": "@@ -187,6 +206,47 @@ public String toString() {\n     }\n   }\n \n+  private static class DateAccessor extends PositionAccessor {\n+    private DateAccessor(int pos, Type type) {\n+      super(pos, type);\n+    }\n+\n+    @Override\n+    public Object get(StructLike record) {\n+      LocalDate value = record.get(position(), LocalDate.class);\n+      return (int) ChronoUnit.DAYS.between(EPOCH_DAY, value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd1bf6120ebd705ad24045b3d4744585b798282"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "503755180b4f22f5e4dd484b607db4382f400f63", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/503755180b4f22f5e4dd484b607db4382f400f63", "committedDate": "2020-05-09T12:40:00Z", "message": "Convert date and timestamp values in generics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "174d1c8d2100cc24abfa8499fe37af3e584e20c0", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/174d1c8d2100cc24abfa8499fe37af3e584e20c0", "committedDate": "2020-05-09T12:40:00Z", "message": "Add DateAccessor, TimeAccessor, and TimestampAccessor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f7e29e83fe4d5791b28c0953176129d63efa75d", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/2f7e29e83fe4d5791b28c0953176129d63efa75d", "committedDate": "2020-05-09T12:40:00Z", "message": "revert unit test changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cfd1bf6120ebd705ad24045b3d4744585b798282", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/cfd1bf6120ebd705ad24045b3d4744585b798282", "committedDate": "2020-04-29T12:40:56Z", "message": "Add DateAccessor, TimeAccessor, and TimestampAccessor"}, "afterCommit": {"oid": "e8f94bf394e647bf2bced91ffbb3a7ec8b253cac", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/e8f94bf394e647bf2bced91ffbb3a7ec8b253cac", "committedDate": "2020-05-09T12:42:34Z", "message": "rebase and remove parquet work around"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7f3d5000df96bfa5d2d989e73a2edcc7d0f36b6", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/d7f3d5000df96bfa5d2d989e73a2edcc7d0f36b6", "committedDate": "2020-05-09T13:29:46Z", "message": "rebase and remove parquet work around"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8f94bf394e647bf2bced91ffbb3a7ec8b253cac", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/e8f94bf394e647bf2bced91ffbb3a7ec8b253cac", "committedDate": "2020-05-09T12:42:34Z", "message": "rebase and remove parquet work around"}, "afterCommit": {"oid": "d7f3d5000df96bfa5d2d989e73a2edcc7d0f36b6", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/d7f3d5000df96bfa5d2d989e73a2edcc7d0f36b6", "committedDate": "2020-05-09T13:29:46Z", "message": "rebase and remove parquet work around"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea42ccec9207ba69ea0d3fd0bccc73c142fb6207", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/ea42ccec9207ba69ea0d3fd0bccc73c142fb6207", "committedDate": "2020-05-10T06:36:58Z", "message": "alternative fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "257c5091a92efd744030905bb1da005916d812dc", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/257c5091a92efd744030905bb1da005916d812dc", "committedDate": "2020-05-09T13:34:29Z", "message": "alternative fix"}, "afterCommit": {"oid": "ea42ccec9207ba69ea0d3fd0bccc73c142fb6207", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/ea42ccec9207ba69ea0d3fd0bccc73c142fb6207", "committedDate": "2020-05-10T06:36:58Z", "message": "alternative fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f25ba39d91c5e4d3dd21c78a000cb1533f8545de", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/f25ba39d91c5e4d3dd21c78a000cb1533f8545de", "committedDate": "2020-05-10T06:45:08Z", "message": "Add comments and remove useless chagnes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00d5f9c9578a1a7825aeb6209c08dc108fe0b0a3", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/00d5f9c9578a1a7825aeb6209c08dc108fe0b0a3", "committedDate": "2020-05-18T03:44:42Z", "message": "refine code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6865f139e28c854206ecd154b541ef548a60d5ec", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/6865f139e28c854206ecd154b541ef548a60d5ec", "committedDate": "2020-05-23T00:37:30Z", "message": "update to use wrapped class"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3474c6d935f2f850575ff6fdd3497fbe220c3791", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/3474c6d935f2f850575ff6fdd3497fbe220c3791", "committedDate": "2020-05-23T00:35:31Z", "message": "update to use wrapped class"}, "afterCommit": {"oid": "6865f139e28c854206ecd154b541ef548a60d5ec", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/6865f139e28c854206ecd154b541ef548a60d5ec", "committedDate": "2020-05-23T00:37:30Z", "message": "update to use wrapped class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3ODEwMzIy", "url": "https://github.com/apache/iceberg/pull/983#pullrequestreview-417810322", "createdAt": "2020-05-25T16:49:41Z", "commit": {"oid": "6865f139e28c854206ecd154b541ef548a60d5ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNjo0OTo0MVrOGaGJbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNjo0OTo0MVrOGaGJbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAxNjg3OA==", "bodyText": "The wrapper can be reused so it should be moved outside the predicate. The predicate just needs to be this:\n  record -> filter.eval(wrapper.wrap(record))", "url": "https://github.com/apache/iceberg/pull/983#discussion_r430016878", "createdAt": "2020-05-25T16:49:41Z", "author": {"login": "rdblue"}, "path": "data/src/main/java/org/apache/iceberg/data/TableScanIterable.java", "diffHunk": "@@ -161,7 +161,10 @@ public boolean hasNext() {\n \n           if (task.residual() != null && task.residual() != Expressions.alwaysTrue()) {\n             Evaluator filter = new Evaluator(projection.asStruct(), task.residual(), caseSensitive);\n-            this.currentIterator = Iterables.filter(reader, filter::eval).iterator();\n+            this.currentIterator = Iterables.filter(reader, record -> {\n+              InternalRecordWrapper wrapperRecord = new InternalRecordWrapper(record.struct()).wrap(record);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6865f139e28c854206ecd154b541ef548a60d5ec"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34326405a11602cffa277cbd55f4228285ef6353", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/34326405a11602cffa277cbd55f4228285ef6353", "committedDate": "2020-05-26T01:56:16Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc189d84f07bcca16b36cacf6249f973eaee9634", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/cc189d84f07bcca16b36cacf6249f973eaee9634", "committedDate": "2020-05-26T06:26:42Z", "message": "Assume false for orc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4639, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}