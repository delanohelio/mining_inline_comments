{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyODI1Njkx", "number": 1509, "title": "Flink: Integrate Flink reader to SQL", "bodyText": "This is subtask of #1293\nAlso fix left comments in #1346", "createdAt": "2020-09-25T04:28:11Z", "url": "https://github.com/apache/iceberg/pull/1509", "merged": true, "mergeCommit": {"oid": "9d9f6775e0c0a5c6fe9334a65e82880d69adacf5"}, "closed": true, "closedAt": "2020-09-29T17:02:04Z", "author": {"login": "JingsongLi"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMa0OTAFqTQ5NjczMDI0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNfbMwgBqjM4MTcyNjA3ODA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NzMwMjQ0", "url": "https://github.com/apache/iceberg/pull/1509#pullrequestreview-496730244", "createdAt": "2020-09-25T19:18:54Z", "commit": {"oid": "9924db4dbd80d94ed97987e44671fa55d591f772"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxOToxODo1NFrOHYPt4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxOToxODo1NFrOHYPt4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NTM3Nw==", "bodyText": "Can you update the comment to state what Flink's default precision is?", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r495185377", "createdAt": "2020-09-25T19:18:54Z", "author": {"login": "rdblue"}, "path": "flink/src/main/java/org/apache/iceberg/flink/TypeToFlinkType.java", "diffHunk": "@@ -100,8 +100,8 @@ public LogicalType primitive(Type.PrimitiveType primitive) {\n       case DATE:\n         return new DateType();\n       case TIME:\n-        // MICROS\n-        return new TimeType(6);\n+        // Flink only support TimeType with default precision now.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9924db4dbd80d94ed97987e44671fa55d591f772"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NzMxNDA2", "url": "https://github.com/apache/iceberg/pull/1509#pullrequestreview-496731406", "createdAt": "2020-09-25T19:19:55Z", "commit": {"oid": "9924db4dbd80d94ed97987e44671fa55d591f772"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxOToxOTo1NlrOHYPvWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxOToxOTo1NlrOHYPvWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NTc1NQ==", "bodyText": "Are these related changes, or should the time changes go into a separate PR?", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r495185755", "createdAt": "2020-09-25T19:19:56Z", "author": {"login": "rdblue"}, "path": "flink/src/test/java/org/apache/iceberg/flink/TestFlinkSchemaUtil.java", "diffHunk": "@@ -252,7 +252,7 @@ public void testInconsistentTypes() {\n         Types.BinaryType.get(), new VarBinaryType(VarBinaryType.MAX_LENGTH),\n         new VarBinaryType(100), Types.BinaryType.get());\n     checkInconsistentType(\n-        Types.TimeType.get(), new TimeType(6),\n+        Types.TimeType.get(), new TimeType(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9924db4dbd80d94ed97987e44671fa55d591f772"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NzMyODAy", "url": "https://github.com/apache/iceberg/pull/1509#pullrequestreview-496732802", "createdAt": "2020-09-25T19:21:14Z", "commit": {"oid": "9924db4dbd80d94ed97987e44671fa55d591f772"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxOToyMToxNFrOHYPxsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxOToyMToxNFrOHYPxsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NjM1Mw==", "bodyText": "This should be called with timestampMillis because you want to wait until it is strictly after the current snapshot's timestamp.", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r495186353", "createdAt": "2020-09-25T19:21:14Z", "author": {"login": "rdblue"}, "path": "flink/src/test/java/org/apache/iceberg/flink/source/TestFlinkScan.java", "diffHunk": "@@ -230,7 +215,7 @@ public void testSnapshotReads() throws Exception {\n     long timestampMillis = table.currentSnapshot().timestampMillis();\n \n     // produce another timestamp\n-    Thread.sleep(10);\n+    waitUntilAfter(10);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9924db4dbd80d94ed97987e44671fa55d591f772"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3OTMyMjc5", "url": "https://github.com/apache/iceberg/pull/1509#pullrequestreview-497932279", "createdAt": "2020-09-28T22:04:46Z", "commit": {"oid": "a41dd8f8300bf16334dd5b7d9aab05f2851587de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMjowNDo0NlrOHZRcVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMjowNDo0NlrOHZRcVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2MjIzMA==", "bodyText": "Why is this waiting until 10ms from now? That's basically equivalent to Thread.sleep. The purpose of using waitUntilAfter is to ensure the next call to System.currentTimeMillis() will be after some point in time. In most cases, that's the last snapshot's timestamp.\nI think this should be waitUntilAfter(table.currentSnapshot().timestampMillis());. Then the next append will be strictly after that snapshot's timestamp, and the query with as-of-timestamp will read the older snapshot. There should be no need to wait as long as 10ms.", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r496262230", "createdAt": "2020-09-28T22:04:46Z", "author": {"login": "rdblue"}, "path": "flink/src/test/java/org/apache/iceberg/flink/source/TestFlinkScan.java", "diffHunk": "@@ -230,13 +246,16 @@ public void testSnapshotReads() throws Exception {\n     long timestampMillis = table.currentSnapshot().timestampMillis();\n \n     // produce another timestamp\n-    Thread.sleep(10);\n+    waitUntilAfter(System.currentTimeMillis() + 10);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a41dd8f8300bf16334dd5b7d9aab05f2851587de"}, "originalPosition": 151}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3OTM5MjQ4", "url": "https://github.com/apache/iceberg/pull/1509#pullrequestreview-497939248", "createdAt": "2020-09-28T22:20:18Z", "commit": {"oid": "a41dd8f8300bf16334dd5b7d9aab05f2851587de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMjoyMDoxOVrOHZRy9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMjoyMDoxOVrOHZRy9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2ODAyMA==", "bodyText": "We try to avoid using Hadoop classes in Iceberg APIs because they are hard to remove. Injecting a Hadoop Configuration is currently done in one place: to instantiate a catalog that requires it.\nThe catalog creates tables and tables are associated with a FileIO, so the configuration is passed down through that chain. The table's configuration should be used for any table configuration.\nMR also has a Hadoop Configuration, but that's required by the API so we can't remove it from the API there. But we still prefer using the table's Configuration when it is needed for components like HadoopFileIO.", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r496268020", "createdAt": "2020-09-28T22:20:19Z", "author": {"login": "rdblue"}, "path": "flink/src/main/java/org/apache/iceberg/flink/source/FlinkSource.java", "diffHunk": "@@ -89,8 +88,18 @@ public Builder table(Table newTable) {\n       return this;\n     }\n \n-    public Builder filters(List<Expression> newFilters) {\n-      this.filterExpressions = newFilters;\n+    public Builder hadoopConf(Configuration newConf) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a41dd8f8300bf16334dd5b7d9aab05f2851587de"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3OTM5MzQw", "url": "https://github.com/apache/iceberg/pull/1509#pullrequestreview-497939340", "createdAt": "2020-09-28T22:20:33Z", "commit": {"oid": "a41dd8f8300bf16334dd5b7d9aab05f2851587de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMjoyMDozNFrOHZRzSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMjoyMDozNFrOHZRzSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2ODEwNg==", "bodyText": "Why pass the conf here? I don't see it used.", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r496268106", "createdAt": "2020-09-28T22:20:34Z", "author": {"login": "rdblue"}, "path": "flink/src/main/java/org/apache/iceberg/flink/source/FlinkInputFormat.java", "diffHunk": "@@ -45,30 +43,25 @@\n   private static final long serialVersionUID = 1L;\n \n   private final TableLoader tableLoader;\n-  private final Schema projectedSchema;\n-  private final ScanOptions options;\n-  private final List<Expression> filterExpressions;\n+  private final SerializableConfiguration serializableConf;\n   private final FileIO io;\n   private final EncryptionManager encryption;\n-  private final SerializableConfiguration serializableConf;\n+  private final ScanContext context;\n \n   private transient RowDataIterator iterator;\n \n-  FlinkInputFormat(\n-      TableLoader tableLoader, Schema projectedSchema, FileIO io, EncryptionManager encryption,\n-      List<Expression> filterExpressions, ScanOptions options, SerializableConfiguration serializableConf) {\n+  FlinkInputFormat(TableLoader tableLoader, SerializableConfiguration serializableConf, FileIO io,\n+                   EncryptionManager encryption, ScanContext context) {\n     this.tableLoader = tableLoader;\n-    this.projectedSchema = projectedSchema;\n+    this.serializableConf = serializableConf;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a41dd8f8300bf16334dd5b7d9aab05f2851587de"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12a155d892b5d1003896a2a2510b60edfc1f8021", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/iceberg/commit/12a155d892b5d1003896a2a2510b60edfc1f8021", "committedDate": "2020-09-29T02:46:08Z", "message": "Flink: Integrate Flink reader to SQL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76363be50f1277c4168f42d984174b7bb67406e1", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/iceberg/commit/76363be50f1277c4168f42d984174b7bb67406e1", "committedDate": "2020-09-29T02:46:08Z", "message": "Fix isBounded"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb153545aba6d62af3adbe834672f09978942e99", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/iceberg/commit/eb153545aba6d62af3adbe834672f09978942e99", "committedDate": "2020-09-29T02:46:09Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e1b03f20113343331b0a722b40c57d3bfa50c8f", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/iceberg/commit/8e1b03f20113343331b0a722b40c57d3bfa50c8f", "committedDate": "2020-09-29T03:14:46Z", "message": "Address comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a41dd8f8300bf16334dd5b7d9aab05f2851587de", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/iceberg/commit/a41dd8f8300bf16334dd5b7d9aab05f2851587de", "committedDate": "2020-09-28T05:28:16Z", "message": "Address comments"}, "afterCommit": {"oid": "8e1b03f20113343331b0a722b40c57d3bfa50c8f", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/iceberg/commit/8e1b03f20113343331b0a722b40c57d3bfa50c8f", "committedDate": "2020-09-29T03:14:46Z", "message": "Address comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3846, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}