{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNDcwNTg3", "number": 1785, "title": "Core: Fix invalidation of metadata tables in CachingCatalog", "bodyText": "This PR fixes the invalidation of metadata tables when the main table is dropped from the catalog.", "createdAt": "2020-11-18T21:06:47Z", "url": "https://github.com/apache/iceberg/pull/1785", "merged": true, "mergeCommit": {"oid": "53cac10b25dbef9e25343de36856822466aad493"}, "closed": true, "closedAt": "2020-11-18T23:52:00Z", "author": {"login": "aokolnychyi"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdd0vMXgFqTUzMzg3NjgwMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdd3EurgFqTUzMzk3NDE3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODc2ODAx", "url": "https://github.com/apache/iceberg/pull/1785#pullrequestreview-533876801", "createdAt": "2020-11-18T21:07:39Z", "commit": {"oid": "7e7494760038f4669370f02e62c3c2c7f8e78532"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMTowNzozOVrOH2CMRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMTowNzozOVrOH2CMRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyMTA2MQ==", "bodyText": "Need to fix this.", "url": "https://github.com/apache/iceberg/pull/1785#discussion_r526421061", "createdAt": "2020-11-18T21:07:39Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/CachingCatalog.java", "diffHunk": "@@ -126,20 +127,36 @@ public Transaction newReplaceTableTransaction(TableIdentifier ident, Schema sche\n     // when the transaction commits, invalidate the table in the cache if it is present.\n     return CommitCallbackTransaction.addCallback(\n         catalog.newReplaceTableTransaction(ident, schema, spec, location, properties, orCreate),\n-        () -> tableCache.invalidate(canonicalizeIdentifier(ident)));\n+        () -> invalidate(canonicalizeIdentifier(ident)));\n   }\n \n   @Override\n   public boolean dropTable(TableIdentifier ident, boolean purge) {\n     boolean dropped = catalog.dropTable(ident, purge);\n-    tableCache.invalidate(canonicalizeIdentifier(ident));\n+    invalidate(canonicalizeIdentifier(ident));\n     return dropped;\n   }\n \n   @Override\n   public void renameTable(TableIdentifier from, TableIdentifier to) {\n     catalog.renameTable(from, to);\n-    tableCache.invalidate(canonicalizeIdentifier(from));\n+    invalidate(canonicalizeIdentifier(from));\n   }\n \n+  private void invalidate(TableIdentifier ident) {\n+    tableCache.invalidate(ident);\n+    tableCache.invalidateAll(metadataTableIdentifiers(ident));\n+  }\n+\n+  private Iterable<TableIdentifier> metadataTableIdentifiers(TableIdentifier ident) {\n+    ImmutableList.Builder<TableIdentifier> builder = ImmutableList.builder();\n+\n+    for (MetadataTableType type : MetadataTableType.values()) {\n+      // metadata table resolution is case insensitive right now\n+      builder.add(TableIdentifier.parse(ident + \".\" + type.name()));\n+      builder.add(TableIdentifier.parse(ident + \".\" + type.name().toLowerCase()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e7494760038f4669370f02e62c3c2c7f8e78532"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de6f8d445c062d7efc35b5985f123490fcec7e5f", "author": {"user": {"login": "aokolnychyi", "name": "Anton Okolnychyi"}}, "url": "https://github.com/apache/iceberg/commit/de6f8d445c062d7efc35b5985f123490fcec7e5f", "committedDate": "2020-11-18T21:07:57Z", "message": "Core: Fix invalidation of metadata tables in CachingCatalog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e7494760038f4669370f02e62c3c2c7f8e78532", "author": {"user": {"login": "aokolnychyi", "name": "Anton Okolnychyi"}}, "url": "https://github.com/apache/iceberg/commit/7e7494760038f4669370f02e62c3c2c7f8e78532", "committedDate": "2020-11-18T21:04:51Z", "message": "Core: Fix invalidation of metadata tables in CachingCatalog"}, "afterCommit": {"oid": "de6f8d445c062d7efc35b5985f123490fcec7e5f", "author": {"user": {"login": "aokolnychyi", "name": "Anton Okolnychyi"}}, "url": "https://github.com/apache/iceberg/commit/de6f8d445c062d7efc35b5985f123490fcec7e5f", "committedDate": "2020-11-18T21:07:57Z", "message": "Core: Fix invalidation of metadata tables in CachingCatalog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODc4NDA5", "url": "https://github.com/apache/iceberg/pull/1785#pullrequestreview-533878409", "createdAt": "2020-11-18T21:09:59Z", "commit": {"oid": "7e7494760038f4669370f02e62c3c2c7f8e78532"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMToxMDozM1rOH2CSSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMToxMDozM1rOH2CSSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyMjYwMA==", "bodyText": "If we alter table properties (to change metadata partitioning for example) do we want to invalidate in that case as well?", "url": "https://github.com/apache/iceberg/pull/1785#discussion_r526422600", "createdAt": "2020-11-18T21:10:33Z", "author": {"login": "RussellSpitzer"}, "path": "core/src/main/java/org/apache/iceberg/CachingCatalog.java", "diffHunk": "@@ -126,20 +128,36 @@ public Transaction newReplaceTableTransaction(TableIdentifier ident, Schema sche\n     // when the transaction commits, invalidate the table in the cache if it is present.\n     return CommitCallbackTransaction.addCallback(\n         catalog.newReplaceTableTransaction(ident, schema, spec, location, properties, orCreate),\n-        () -> tableCache.invalidate(canonicalizeIdentifier(ident)));\n+        () -> invalidate(canonicalizeIdentifier(ident)));\n   }\n \n   @Override\n   public boolean dropTable(TableIdentifier ident, boolean purge) {\n     boolean dropped = catalog.dropTable(ident, purge);\n-    tableCache.invalidate(canonicalizeIdentifier(ident));\n+    invalidate(canonicalizeIdentifier(ident));\n     return dropped;\n   }\n \n   @Override\n   public void renameTable(TableIdentifier from, TableIdentifier to) {\n     catalog.renameTable(from, to);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de6f8d445c062d7efc35b5985f123490fcec7e5f"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTc0MTc0", "url": "https://github.com/apache/iceberg/pull/1785#pullrequestreview-533974174", "createdAt": "2020-11-18T23:50:59Z", "commit": {"oid": "de6f8d445c062d7efc35b5985f123490fcec7e5f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3785, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}