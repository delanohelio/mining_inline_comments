{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MDU4Nzg1", "number": 845, "title": "Add persistent IDs to partition fields", "bodyText": "For issue #280.\nI took a different approach from the previous WIP PR (#499).\nInstead of adding additional states and logics into TableMetadata, I created PartitionSpecUpdate to handle that.\nAlso, it is unnecessary to keep lastAssignedPartitonFieldId in TableMetadata as it can be lazily derived from all specs (previous specs are still there) stored in TableMetadata.", "createdAt": "2020-03-16T08:11:45Z", "url": "https://github.com/apache/iceberg/pull/845", "merged": true, "mergeCommit": {"oid": "b6cdc694b6b5a1040d6a2ffb4e72446fe52309c4"}, "closed": true, "closedAt": "2020-04-15T20:13:36Z", "author": {"login": "jun-he"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcT_g01gFqTM4NzExMzgwNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcX9zg6gFqTM5NDA5NjYzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTEzODA3", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-387113807", "createdAt": "2020-04-03T09:52:25Z", "commit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwOTo1MjoyNlrOGAOg0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMTo0NToyMVrOGAR-qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg5MDk2MA==", "bodyText": "Do we want to use TypeUtil::NextID?", "url": "https://github.com/apache/iceberg/pull/845#discussion_r402890960", "createdAt": "2020-04-03T09:52:26Z", "author": {"login": "chenjunjiedada"}, "path": "api/src/main/java/org/apache/iceberg/PartitionSpec.java", "diffHunk": "@@ -58,14 +58,16 @@\n   private transient volatile ListMultimap<Integer, PartitionField> fieldsBySourceId = null;\n   private transient volatile Class<?>[] lazyJavaClasses = null;\n   private transient volatile List<PartitionField> fieldList = null;\n+  private final int lastAssignedFieldId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg5NTI1Mg==", "bodyText": "Do we need to check fieldId is larger than 1000?", "url": "https://github.com/apache/iceberg/pull/845#discussion_r402895252", "createdAt": "2020-04-03T09:59:32Z", "author": {"login": "chenjunjiedada"}, "path": "api/src/main/java/org/apache/iceberg/PartitionField.java", "diffHunk": "@@ -28,11 +28,13 @@\n  */\n public class PartitionField implements Serializable {\n   private final int sourceId;\n+  private final int fieldId;\n   private final String name;\n   private final Transform<?, ?> transform;\n \n-  PartitionField(int sourceId, String name, Transform<?, ?> transform) {\n+  PartitionField(int sourceId, int fieldId, String name, Transform<?, ?> transform) {\n     this.sourceId = sourceId;\n+    this.fieldId = fieldId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkyNTI5Mw==", "bodyText": "Can we add a unit test that has two manifests with the different specs of the same source field, and then check whether the partition field ids of manifest entries are different?", "url": "https://github.com/apache/iceberg/pull/845#discussion_r402925293", "createdAt": "2020-04-03T10:57:51Z", "author": {"login": "chenjunjiedada"}, "path": "core/src/test/java/org/apache/iceberg/TestMergeAppend.java", "diffHunk": "@@ -395,6 +396,47 @@ public void testChangedPartitionSpec() {\n         initialManifest, pending.manifests().get(1));\n   }\n \n+  @Test\n+  public void testUpdatePartitionSpecFieldIds() {\n+    TableMetadata base = readMetadata();\n+\n+    // build the new spec using the table's schema, which uses fresh IDs\n+    PartitionSpec newSpec = PartitionSpec.builderFor(base.schema())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk0Nzc1NA==", "bodyText": "How about the forward compatibility? Is it possible that an old reader reads the new spec? then it still parses the new spec field id start from 1000?", "url": "https://github.com/apache/iceberg/pull/845#discussion_r402947754", "createdAt": "2020-04-03T11:45:21Z", "author": {"login": "chenjunjiedada"}, "path": "core/src/main/java/org/apache/iceberg/PartitionSpecParser.java", "diffHunk": "@@ -147,7 +156,12 @@ private static void buildFromJsonFields(PartitionSpec.Builder builder, JsonNode\n       String transform = JsonUtil.getString(TRANSFORM, element);\n       int sourceId = JsonUtil.getInt(SOURCE_ID, element);\n \n-      builder.add(sourceId, name, transform);\n+      // partition field ids are missing in old PartitionSpec, they always auto-increment from PARTITION_DATA_ID_START\n+      if (!hasFieldId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NDU5MTI2", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-387459126", "createdAt": "2020-04-03T17:45:30Z", "commit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNzo0NTozMFrOGAgmeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNzo0NTozMFrOGAgmeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE4NzMyMg==", "bodyText": "Nit: schemas use the format 1000: ts_day. That would be a bit cleaner than two sets of parens.", "url": "https://github.com/apache/iceberg/pull/845#discussion_r403187322", "createdAt": "2020-04-03T17:45:30Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/PartitionField.java", "diffHunk": "@@ -60,7 +69,7 @@ public String name() {\n \n   @Override\n   public String toString() {\n-    return name + \": \" + transform + \"(\" + sourceId + \")\";\n+    return name + \" (\" + fieldId + \"): \" + transform + \"(\" + sourceId + \")\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NDg0ODYx", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-387484861", "createdAt": "2020-04-03T18:24:22Z", "commit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxODoyNDoyMlrOGAip6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxODoyNDoyMlrOGAip6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzIyMDk2OQ==", "bodyText": "We tend to prefer using AtomicInteger instead of an int field. That way it is more clear because the calls are incrementAndGet or getAndIncrement. That would also avoid the need to start at PARTITION_DATA_ID_START - 1. You could use the constant to initialize and assign using getAndIncrement.", "url": "https://github.com/apache/iceberg/pull/845#discussion_r403220969", "createdAt": "2020-04-03T18:24:22Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/PartitionSpec.java", "diffHunk": "@@ -307,11 +312,16 @@ public static Builder builderFor(Schema schema) {\n     private final Set<String> partitionNames = Sets.newHashSet();\n     private Map<Integer, PartitionField> timeFields = Maps.newHashMap();\n     private int specId = 0;\n+    private int lastAssignedFieldId = PARTITION_DATA_ID_START - 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NDg1NjQ0", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-387485644", "createdAt": "2020-04-03T18:25:28Z", "commit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxODoyNToyOVrOGAitzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxODoyNToyOVrOGAitzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzIyMTk2NA==", "bodyText": "Why rename this to append? What about addWithoutId or just overload add?", "url": "https://github.com/apache/iceberg/pull/845#discussion_r403221964", "createdAt": "2020-04-03T18:25:29Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/PartitionSpec.java", "diffHunk": "@@ -437,24 +447,30 @@ public Builder truncate(String sourceName, int width, String targetName) {\n       checkAndAddPartitionName(targetName);\n       Types.NestedField sourceColumn = findSourceColumn(sourceName);\n       fields.add(new PartitionField(\n-          sourceColumn.fieldId(), targetName, Transforms.truncate(sourceColumn.type(), width)));\n+          sourceColumn.fieldId(), nextFieldId(), targetName, Transforms.truncate(sourceColumn.type(), width)));\n       return this;\n     }\n \n     public Builder truncate(String sourceName, int width) {\n       return truncate(sourceName, width, sourceName + \"_trunc\");\n     }\n \n-    Builder add(int sourceId, String name, String transform) {\n+    // add a partition field with an auto-increment partition field id starting from PARTITION_DATA_ID_START\n+    Builder append(int sourceId, String name, String transform) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "originalPosition": 155}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NDkzOTgx", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-387493981", "createdAt": "2020-04-03T18:38:12Z", "commit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxODozODoxM1rOGAjX9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxODozODoxM1rOGAjX9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzIzMjc1Ng==", "bodyText": "I think it would be easier to follow and would result in a better error message if we put this logic inside the elements loop.\nHow about adding a counter for field IDs that are present and after the loop throwing an exception if the counter is not equal to the number of fields? Then each field would be handled independently (using has(FIELD_ID)).\nI like the idea of a check here that states there were missing field IDs.", "url": "https://github.com/apache/iceberg/pull/845#discussion_r403232756", "createdAt": "2020-04-03T18:38:13Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/PartitionSpecParser.java", "diffHunk": "@@ -138,6 +140,13 @@ private static void buildFromJsonFields(PartitionSpec.Builder builder, JsonNode\n         \"Cannot parse partition spec fields, not an array: %s\", json);\n \n     Iterator<JsonNode> elements = json.elements();\n+\n+    boolean hasFieldId = false;\n+    if (elements.hasNext() && elements.next().has(FIELD_ID)) {\n+      hasFieldId = true;\n+    }\n+    elements = json.elements();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NTIzOTUx", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-387523951", "createdAt": "2020-04-03T19:26:43Z", "commit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxOToyNjo0NFrOGAlLbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxOToyNjo0NFrOGAlLbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI2MjMxOQ==", "bodyText": "We typically validate arguments before assignments, to keep the code easier to read and maintain. Can you move the precondition above this section? Also, error messages should use sentence case so capitalize Specs. If you're referring to a variable name, then consider describing what it is instead (Partition specs instead of specs).", "url": "https://github.com/apache/iceberg/pull/845#discussion_r403262319", "createdAt": "2020-04-03T19:26:44Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -204,8 +205,11 @@ public String toString() {\n     this.lastUpdatedMillis = lastUpdatedMillis;\n     this.lastColumnId = lastColumnId;\n     this.schema = schema;\n-    this.specs = specs;\n     this.defaultSpecId = defaultSpecId;\n+\n+    Preconditions.checkArgument(specs != null && !specs.isEmpty(), \"specs cannot be null or empty\");\n+    this.specs = specs;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NTI3ODE3", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-387527817", "createdAt": "2020-04-03T19:33:16Z", "commit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxOTozMzoxN1rOGAleNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxOTozMzoxN1rOGAleNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI2NzEyNQ==", "bodyText": "Spec field IDs don't need to be refreshed. freshSpec is used for two things:\n\nIf schema IDs are reassigned, then it rebuilds the spec to with the new schema\nIt sets the spec's ID to the one assigned in this method", "url": "https://github.com/apache/iceberg/pull/845#discussion_r403267125", "createdAt": "2020-04-03T19:33:17Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -350,7 +354,8 @@ public TableMetadata updateSchema(Schema newSchema, int newLastColumnId) {\n         currentSnapshotId, snapshots, snapshotLog, addPreviousFile(file, lastUpdatedMillis));\n   }\n \n-  public TableMetadata updatePartitionSpec(PartitionSpec newPartitionSpec) {\n+  // newPartitionSpec's partition field IDs should have already been refreshed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NTI5MzQz", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-387529343", "createdAt": "2020-04-03T19:36:01Z", "commit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxOTozNjowMVrOGAlmcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxOTozNjowMVrOGAlmcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI2OTIzNQ==", "bodyText": "These should still be public like the other methods. Instead of making them private, they should sanity check the spec:\n\nFor a v1 table, field IDs should be assigned from 1000 and should have no gaps\nFor a v2 table or newer, all fields should have IDs", "url": "https://github.com/apache/iceberg/pull/845#discussion_r403269235", "createdAt": "2020-04-03T19:36:01Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -350,7 +354,8 @@ public TableMetadata updateSchema(Schema newSchema, int newLastColumnId) {\n         currentSnapshotId, snapshots, snapshotLog, addPreviousFile(file, lastUpdatedMillis));\n   }\n \n-  public TableMetadata updatePartitionSpec(PartitionSpec newPartitionSpec) {\n+  // newPartitionSpec's partition field IDs should have already been refreshed\n+  TableMetadata updatePartitionSpec(PartitionSpec newPartitionSpec) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NTMzNjA3", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-387533607", "createdAt": "2020-04-03T19:43:10Z", "commit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxOTo0MzoxMFrOGAl9EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxOTo0MzoxMFrOGAl9EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI3NTAyNQ==", "bodyText": "Can we remove the new interface and methods from this PR?\nI don't think this is needed for this PR, and I'd like to minimize the number of changes. In addition, I don't think we want to move to a model where users create a new spec and apply it to a table. I think we instead want to evolve the partition spec of a table. So this API will probably be different when we release that feature.", "url": "https://github.com/apache/iceberg/pull/845#discussion_r403275025", "createdAt": "2020-04-03T19:43:10Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/UpdatePartitionSpec.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import org.apache.iceberg.exceptions.CommitFailedException;\n+\n+/**\n+ * API for partition spec evolution.\n+ * <p>\n+ * When committing, these changes will be applied to the current table metadata. Commit conflicts\n+ * will not be resolved and will result in a {@link CommitFailedException}.\n+ */\n+public interface UpdatePartitionSpec extends PendingUpdate<PartitionSpec> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b702aff7da850d01bb7e965024ce81f61908ed65", "author": {"user": {"login": "jun-he", "name": null}}, "url": "https://github.com/apache/iceberg/commit/b702aff7da850d01bb7e965024ce81f61908ed65", "committedDate": "2020-04-10T07:20:00Z", "message": "Add persistent IDs to partition fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89d0fc62ccd9ee6e6ec51e297aed236d99addf63", "author": {"user": {"login": "jun-he", "name": null}}, "url": "https://github.com/apache/iceberg/commit/89d0fc62ccd9ee6e6ec51e297aed236d99addf63", "committedDate": "2020-04-10T07:34:41Z", "message": "add some unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdbd57d168a72275139dbc29a6345e3c1406b698", "author": {"user": {"login": "jun-he", "name": null}}, "url": "https://github.com/apache/iceberg/commit/fdbd57d168a72275139dbc29a6345e3c1406b698", "committedDate": "2020-04-10T07:34:41Z", "message": "add additional unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417", "author": {"user": {"login": "jun-he", "name": null}}, "url": "https://github.com/apache/iceberg/commit/cd75cbdb05461fe1051ba635a1cf389da61d5417", "committedDate": "2020-04-10T07:59:00Z", "message": "address the comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d804af9f2250d05010c33a41de69da1bdb32404", "author": {"user": {"login": "jun-he", "name": null}}, "url": "https://github.com/apache/iceberg/commit/6d804af9f2250d05010c33a41de69da1bdb32404", "committedDate": "2020-03-23T02:20:01Z", "message": "add additional unit tests"}, "afterCommit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417", "author": {"user": {"login": "jun-he", "name": null}}, "url": "https://github.com/apache/iceberg/commit/cd75cbdb05461fe1051ba635a1cf389da61d5417", "committedDate": "2020-04-10T07:59:00Z", "message": "address the comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTkyMTUw", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-391592150", "createdAt": "2020-04-10T18:27:30Z", "commit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODoyNzozMFrOGECPlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODoyNzozMFrOGECPlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg4NDI0NA==", "bodyText": "Nit: unnecessary newline.", "url": "https://github.com/apache/iceberg/pull/845#discussion_r406884244", "createdAt": "2020-04-10T18:27:30Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/Transaction.java", "diffHunk": "@@ -40,6 +40,14 @@\n    */\n   UpdateSchema updateSchema();\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTk0MDM1", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-391594035", "createdAt": "2020-04-10T18:31:26Z", "commit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODozMToyN1rOGECVtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODozMToyN1rOGECVtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg4NTgxMg==", "bodyText": "Nit: we like to avoid abbreviations that aren't readable. Saving a few chars isn't worth trading readability.", "url": "https://github.com/apache/iceberg/pull/845#discussion_r406885812", "createdAt": "2020-04-10T18:31:27Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/PartitionSpecParser.java", "diffHunk": "@@ -138,6 +140,7 @@ private static void buildFromJsonFields(PartitionSpec.Builder builder, JsonNode\n         \"Cannot parse partition spec fields, not an array: %s\", json);\n \n     Iterator<JsonNode> elements = json.elements();\n+    int fieldIdCnt = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTk0NTQ1", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-391594545", "createdAt": "2020-04-10T18:32:29Z", "commit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODozMjozMFrOGECXhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODozMjozMFrOGECXhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg4NjI3OA==", "bodyText": "How about \"Cannot parse spec with missing field IDs: %s missing of %s fields\"?", "url": "https://github.com/apache/iceberg/pull/845#discussion_r406886278", "createdAt": "2020-04-10T18:32:30Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/PartitionSpecParser.java", "diffHunk": "@@ -147,7 +150,17 @@ private static void buildFromJsonFields(PartitionSpec.Builder builder, JsonNode\n       String transform = JsonUtil.getString(TRANSFORM, element);\n       int sourceId = JsonUtil.getInt(SOURCE_ID, element);\n \n-      builder.add(sourceId, name, transform);\n+      // partition field ids are missing in old PartitionSpec, they always auto-increment from PARTITION_DATA_ID_START\n+      if (element.has(FIELD_ID)) {\n+        builder.add(sourceId, JsonUtil.getInt(FIELD_ID, element), name, transform);\n+        fieldIdCnt++;\n+      }  else {\n+        builder.add(sourceId, name, transform);\n+      }\n     }\n+\n+    Preconditions.checkArgument(fieldIdCnt == 0 || fieldIdCnt == json.size(),\n+        \"Parsed an invalid PartitionSpec Json. Some of its fields (%s/%s) miss field IDs.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTk1OTIw", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-391595920", "createdAt": "2020-04-10T18:35:18Z", "commit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODozNToxOFrOGECcFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODozNToxOFrOGECcFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg4NzQ0NQ==", "bodyText": "Can you revert these unnecessary changes? The order of assignments changed and there's an extra newline. These non-functional changes can cause git conflicts, so we try to avoid them.", "url": "https://github.com/apache/iceberg/pull/845#discussion_r406887445", "createdAt": "2020-04-10T18:35:18Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -208,8 +210,9 @@ public String toString() {\n     this.lastUpdatedMillis = lastUpdatedMillis;\n     this.lastColumnId = lastColumnId;\n     this.schema = schema;\n-    this.specs = specs;\n     this.defaultSpecId = defaultSpecId;\n+    this.specs = specs;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTk2MzI1", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-391596325", "createdAt": "2020-04-10T18:36:08Z", "commit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODozNjowOFrOGECdcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODozNjowOFrOGECdcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg4Nzc5NQ==", "bodyText": "Why is this no longer public?", "url": "https://github.com/apache/iceberg/pull/845#discussion_r406887795", "createdAt": "2020-04-10T18:36:08Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -487,8 +491,9 @@ public TableMetadata removeSnapshotLogEntries(Set<Long> snapshotIds) {\n         currentSnapshotId, snapshots, newSnapshotLog, addPreviousFile(file, lastUpdatedMillis));\n   }\n \n-  public TableMetadata buildReplacement(Schema updatedSchema, PartitionSpec updatedPartitionSpec,\n-                                        Map<String, String> updatedProperties) {\n+  // updatedPartitionSpec's partition field IDs should have already been refreshed\n+  TableMetadata buildReplacement(Schema updatedSchema, PartitionSpec updatedPartitionSpec,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTk3OTUx", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-391597951", "createdAt": "2020-04-10T18:39:38Z", "commit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODozOTozOVrOGECjBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODozOTozOVrOGECjBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg4OTIyMw==", "bodyText": "#903 added formatVersion to metadata, so now we can add a validation here when the table is v1 that the spec IDs are assigned as expected:\nValidationException.check(formatVersion > 1 || hasSequentialIds(spec),\n    \"Spec does not use sequential IDs that are required in v1: %s\", spec);", "url": "https://github.com/apache/iceberg/pull/845#discussion_r406889223", "createdAt": "2020-04-10T18:39:39Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -352,6 +355,7 @@ public TableMetadata updateSchema(Schema newSchema, int newLastColumnId) {\n         currentSnapshotId, snapshots, snapshotLog, addPreviousFile(file, lastUpdatedMillis));\n   }\n \n+  // Input newPartitionSpec's partition field IDs should have already been recomputed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTk4MjA3", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-391598207", "createdAt": "2020-04-10T18:40:08Z", "commit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODo0MDowOFrOGECkAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODo0MDowOFrOGECkAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg4OTQ3NA==", "bodyText": "We should add a validation for format v1 here as well.", "url": "https://github.com/apache/iceberg/pull/845#discussion_r406889474", "createdAt": "2020-04-10T18:40:08Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -487,8 +491,9 @@ public TableMetadata removeSnapshotLogEntries(Set<Long> snapshotIds) {\n         currentSnapshotId, snapshots, newSnapshotLog, addPreviousFile(file, lastUpdatedMillis));\n   }\n \n-  public TableMetadata buildReplacement(Schema updatedSchema, PartitionSpec updatedPartitionSpec,\n-                                        Map<String, String> updatedProperties) {\n+  // updatedPartitionSpec's partition field IDs should have already been refreshed\n+  TableMetadata buildReplacement(Schema updatedSchema, PartitionSpec updatedPartitionSpec,\n+                                 Map<String, String> updatedProperties) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTk4NjAx", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-391598601", "createdAt": "2020-04-10T18:40:58Z", "commit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODo0MDo1OFrOGEClVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODo0MDo1OFrOGEClVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg4OTgxNA==", "bodyText": "As I mentioned earlier, I think this should continue using the updatePartitionSpec method so that we can add a public API for this in a separate commit.", "url": "https://github.com/apache/iceberg/pull/845#discussion_r406889814", "createdAt": "2020-04-10T18:40:58Z", "author": {"login": "rdblue"}, "path": "core/src/test/java/org/apache/iceberg/TestMergeAppend.java", "diffHunk": "@@ -373,10 +374,10 @@ public void testChangedPartitionSpec() {\n         .bucket(\"id\", 4)\n         .build();\n \n-    // commit the new partition spec to the table manually\n-    table.ops().commit(base, base.updatePartitionSpec(newSpec));\n+    // commit the new partition spec to the table\n+    table.updatePartitionSpec().update(newSpec).commit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd75cbdb05461fe1051ba635a1cf389da61d5417"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a176d2d2a7120597da91a6afde66cae3e2f097d", "author": {"user": {"login": "jun-he", "name": null}}, "url": "https://github.com/apache/iceberg/commit/9a176d2d2a7120597da91a6afde66cae3e2f097d", "committedDate": "2020-04-15T05:23:55Z", "message": "address the comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5b2221ce3b811dcf4494cca57f7ad4aae46cd36", "author": {"user": {"login": "jun-he", "name": null}}, "url": "https://github.com/apache/iceberg/commit/c5b2221ce3b811dcf4494cca57f7ad4aae46cd36", "committedDate": "2020-04-15T06:55:06Z", "message": "Refactor the code and remove partition spec evolution logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MDk2NjMx", "url": "https://github.com/apache/iceberg/pull/845#pullrequestreview-394096631", "createdAt": "2020-04-15T20:06:48Z", "commit": {"oid": "c5b2221ce3b811dcf4494cca57f7ad4aae46cd36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMDowNjo0OFrOGGJplQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMDowNjo0OFrOGGJplQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwMjc0MQ==", "bodyText": "Nit: unnecessary newline.", "url": "https://github.com/apache/iceberg/pull/845#discussion_r409102741", "createdAt": "2020-04-15T20:06:48Z", "author": {"login": "rdblue"}, "path": "core/src/test/java/org/apache/iceberg/TestMergeAppend.java", "diffHunk": "@@ -648,4 +649,98 @@ public void testInvalidAppendManifest() throws IOException {\n             .appendManifest(manifestWithDeletedFiles)\n             .commit());\n   }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5b2221ce3b811dcf4494cca57f7ad4aae46cd36"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4726, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}