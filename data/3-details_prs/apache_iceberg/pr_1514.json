{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNDU1NTIw", "number": 1514, "title": "Issue-1511: Read errors out with multiple DeleteFile entries after UPSERT", "bodyText": "This dedups the DeleteFiles in ReadTask, because a single DeleteFile can be referred by multiple DataFile for filtering. Fixes issue #1511\ncc: @rdblue", "createdAt": "2020-09-26T01:00:08Z", "url": "https://github.com/apache/iceberg/pull/1514", "merged": true, "mergeCommit": {"oid": "c988753e66cbe52c1d9cb51cadb656ab98782ade"}, "closed": true, "closedAt": "2020-10-06T16:34:33Z", "author": {"login": "mehtaashish23"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNasvVgFqTQ5NzkyMjUxMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPoBwMgBqjM4NDE4NDMwMTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3OTIyNTEw", "url": "https://github.com/apache/iceberg/pull/1514#pullrequestreview-497922510", "createdAt": "2020-09-28T21:44:39Z", "commit": {"oid": "e2fa9ac689d8776526a0d754a09878f5a0b668bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMTo0NDozOVrOHZQwfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMTo0NDozOVrOHZQwfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI1MTAwNg==", "bodyText": "There is no equals and hashCode implementation for CharSequence, so it can't be used reliably as a map key to deduplicate.\nAlso, the only thing you need from the file instance is the key metadata, so you could keep a map of string path to key metadata, like this:\n    Map<String, ByteBuffer> keyMetadata = Maps.newHashMap();\n    task.files().stream()\n        .flatMap(fileScanTask -> Stream.concat(Stream.of(fileScanTask.file()), fileScanTask.deletes().stream()))\n        .forEach(file -> keyMetadata.put(file.path().toString(), file.keyMetadata()));\n    Stream<EncryptedInputFile> encrypted = keyMetadata.entrySet().stream()\n        .map(entry -> EncryptedFiles.encryptedInput(io.newInputFile(entry.getKey()), entry.getValue()));", "url": "https://github.com/apache/iceberg/pull/1514#discussion_r496251006", "createdAt": "2020-09-28T21:44:39Z", "author": {"login": "rdblue"}, "path": "spark/src/main/java/org/apache/iceberg/spark/source/BaseDataReader.java", "diffHunk": "@@ -58,9 +60,12 @@\n \n   BaseDataReader(CombinedScanTask task, FileIO io, EncryptionManager encryptionManager) {\n     this.tasks = task.files().iterator();\n-    Stream<EncryptedInputFile> encrypted = task.files().stream()\n-        .flatMap(fileScanTask -> Stream.concat(Stream.of(fileScanTask.file()), fileScanTask.deletes().stream()))\n-        .map(file -> EncryptedFiles.encryptedInput(io.newInputFile(file.path().toString()), file.keyMetadata()));\n+    Map<CharSequence, DeleteFile> uniqueDeleteFileMap = Maps.newHashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fa9ac689d8776526a0d754a09878f5a0b668bd"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d89f92d11d1268bc180916d10d762221966c793d", "author": {"user": {"login": "mehtaashish23", "name": "Ashish Mehta"}}, "url": "https://github.com/apache/iceberg/commit/d89f92d11d1268bc180916d10d762221966c793d", "committedDate": "2020-10-05T17:19:18Z", "message": "Issue-1511: Read errors out with multiple DeleteFile entries after UPSERT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e60d3ab2f7bbebd7f6632b5bf7f24c42170b3e6a", "author": {"user": {"login": "mehtaashish23", "name": "Ashish Mehta"}}, "url": "https://github.com/apache/iceberg/commit/e60d3ab2f7bbebd7f6632b5bf7f24c42170b3e6a", "committedDate": "2020-10-05T17:25:37Z", "message": "Issue-1511: Read errors out with multiple DeleteFile entries after UPSERT\n\nReview Feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8195893dc53ff2067b8da55fbc533a23dcb3224", "author": {"user": {"login": "mehtaashish23", "name": "Ashish Mehta"}}, "url": "https://github.com/apache/iceberg/commit/f8195893dc53ff2067b8da55fbc533a23dcb3224", "committedDate": "2020-10-05T18:23:23Z", "message": "Issue-1511: Read errors out with multiple DeleteFile entries after UPSERT\n\nResolving conflict"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "538ea89d859687b25914caf1a7193b8c98480c02", "author": {"user": {"login": "mehtaashish23", "name": "Ashish Mehta"}}, "url": "https://github.com/apache/iceberg/commit/538ea89d859687b25914caf1a7193b8c98480c02", "committedDate": "2020-09-30T05:46:04Z", "message": "Issue-1511: Read errors out with multiple DeleteFile entries after UPSERT\n\nReview Feedback"}, "afterCommit": {"oid": "f8195893dc53ff2067b8da55fbc533a23dcb3224", "author": {"user": {"login": "mehtaashish23", "name": "Ashish Mehta"}}, "url": "https://github.com/apache/iceberg/commit/f8195893dc53ff2067b8da55fbc533a23dcb3224", "committedDate": "2020-10-05T18:23:23Z", "message": "Issue-1511: Read errors out with multiple DeleteFile entries after UPSERT\n\nResolving conflict"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3851, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}