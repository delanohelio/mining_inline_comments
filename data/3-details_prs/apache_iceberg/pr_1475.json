{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MDA3ODcx", "number": 1475, "title": "Fix REPLACE TABLE by preserving existing field IDs", "bodyText": "REPLACE TABLE replaces the table schema and partition spec in addition to the table data. When the new schema is passed to Iceberg, its field IDs are reassigned to ensure they are consistent (for example, no duplicate IDs), just like when a table is created. This updates how the IDs are reassigned to fix time travel and partition specs.\nIceberg doesn't currently track what the table schema was at the time a snapshot was written. The current table schema is always used to read older snapshots. When a table is replaced and the ids are reassigned, this can lead to incompatible ID conflicts between an older schema and the current schema.\nTo fix incompatible IDs, this updates reassignment to use the current table schema's ids if possible. If the current schema is 1: id bigint, 2: data string and the new schema is data string, id int, then ids are reused by name: 2: data string, 1: id int. Any field that is not in the current table schema is assigned a new unique ID using lastColumnId.\nThis also fixes a bug where incompatible ID reassignment breaks old partition specs, resulting in errors like \"Cannot create identity partition sourced from different field in schema: partititon_col\".", "createdAt": "2020-09-18T01:06:56Z", "url": "https://github.com/apache/iceberg/pull/1475", "merged": true, "mergeCommit": {"oid": "2f2f461d5f280dff4de486fc54d0123591f0fe0a"}, "closed": true, "closedAt": "2020-09-23T16:20:35Z", "author": {"login": "rdblue"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJ600CAH2gAyNDg5MDA3ODcxOjM3MjYwMWRiODE4NjhmNDBmNTA1YjlkZTc5Nzg3MzNlNDdmMGY2Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLuwrIAFqTQ5NDgxNDYxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "372601db81868f40f505b9de7978733e47f0f638", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/372601db81868f40f505b9de7978733e47f0f638", "committedDate": "2020-09-18T00:54:44Z", "message": "Fix REPLACE TABLE transactions by preserving existing field IDs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9728825013844188eea8ec3d3924810b1596667b", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/9728825013844188eea8ec3d3924810b1596667b", "committedDate": "2020-09-18T17:04:13Z", "message": "Fix checkstyle in AssignFreshIds."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0ODEyODcx", "url": "https://github.com/apache/iceberg/pull/1475#pullrequestreview-494812871", "createdAt": "2020-09-23T15:57:25Z", "commit": {"oid": "9728825013844188eea8ec3d3924810b1596667b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNTo1NzoyNVrOHW1hvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNTo1NzoyNVrOHW1hvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcwNzcxMA==", "bodyText": "I don't think it matters but it seems the computations for nextSpecId and nextOrderId are a bit different now. Previously, if partition spec list was empty, we used  INITIAL_SPEC_ID and if sort order list was empty, we used INITIAL_SORT_ORDER_ID . Now we are going to use INITIAL_SPEC_ID + 1 in that case.", "url": "https://github.com/apache/iceberg/pull/1475#discussion_r493707710", "createdAt": "2020-09-23T15:57:25Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -622,32 +622,26 @@ public TableMetadata buildReplacement(Schema updatedSchema, PartitionSpec update\n     ValidationException.check(formatVersion > 1 || PartitionSpec.hasSequentialIds(updatedPartitionSpec),\n         \"Spec does not use sequential IDs that are required in v1: %s\", updatedPartitionSpec);\n \n-    AtomicInteger nextLastColumnId = new AtomicInteger(0);\n-    Schema freshSchema = TypeUtil.assignFreshIds(updatedSchema, nextLastColumnId::incrementAndGet);\n+    AtomicInteger newLastColumnId = new AtomicInteger(lastColumnId);\n+    Schema freshSchema = TypeUtil.assignFreshIds(updatedSchema, schema, newLastColumnId::incrementAndGet);\n \n-    int nextSpecId = TableMetadata.INITIAL_SPEC_ID;\n-    for (Integer specId : specsById.keySet()) {\n-      if (nextSpecId <= specId) {\n-        nextSpecId = specId + 1;\n-      }\n-    }\n+    // determine the next spec id\n+    OptionalInt maxSpecId = specs.stream().mapToInt(PartitionSpec::specId).max();\n+    int nextSpecId = maxSpecId.orElse(TableMetadata.INITIAL_SPEC_ID) + 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9728825013844188eea8ec3d3924810b1596667b"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0ODE0NjE4", "url": "https://github.com/apache/iceberg/pull/1475#pullrequestreview-494814618", "createdAt": "2020-09-23T15:59:12Z", "commit": {"oid": "9728825013844188eea8ec3d3924810b1596667b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3797, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}