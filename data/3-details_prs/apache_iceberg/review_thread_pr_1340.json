{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3ODA3Mzk0", "number": 1340, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMzowNzozOFrOEZSy8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMzozODoyMVrOEZTHNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0OTU3ODA4OnYy", "diffSide": "RIGHT", "path": "data/src/main/java/org/apache/iceberg/data/GenericAppenderFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMzowNzozOFrOHCBtgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMzowNzozOFrOHCBtgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg4NzIzMg==", "bodyText": "The name is usually a table name for the given schema.   not fileFormat.   we may need to remove this line, or set it with a reasonable table name.", "url": "https://github.com/apache/iceberg/pull/1340#discussion_r471887232", "createdAt": "2020-08-18T03:07:38Z", "author": {"login": "openinx"}, "path": "data/src/main/java/org/apache/iceberg/data/GenericAppenderFactory.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.data;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.util.Map;\n+import org.apache.iceberg.FileFormat;\n+import org.apache.iceberg.Schema;\n+import org.apache.iceberg.avro.Avro;\n+import org.apache.iceberg.data.avro.DataWriter;\n+import org.apache.iceberg.data.orc.GenericOrcWriter;\n+import org.apache.iceberg.data.parquet.GenericParquetWriter;\n+import org.apache.iceberg.io.FileAppender;\n+import org.apache.iceberg.io.FileAppenderFactory;\n+import org.apache.iceberg.io.OutputFile;\n+import org.apache.iceberg.orc.ORC;\n+import org.apache.iceberg.parquet.Parquet;\n+import org.apache.iceberg.relocated.com.google.common.collect.Maps;\n+\n+/**\n+ * Factory to create a new {@link FileAppender} to write {@link Record}s.\n+ */\n+public class GenericAppenderFactory implements FileAppenderFactory<Record> {\n+\n+  private final Schema schema;\n+  private final Map<String, String> config = Maps.newHashMap();\n+\n+  public GenericAppenderFactory(Schema schema) {\n+    this.schema = schema;\n+  }\n+\n+  public GenericAppenderFactory set(String property, String value) {\n+    config.put(property, value);\n+    return this;\n+  }\n+\n+  public GenericAppenderFactory setAll(Map<String, String> properties) {\n+    config.putAll(properties);\n+    return this;\n+  }\n+\n+  @Override\n+  public FileAppender<Record> newAppender(OutputFile outputFile, FileFormat fileFormat) {\n+    try {\n+      switch (fileFormat) {\n+        case AVRO:\n+          return Avro.write(outputFile)\n+              .schema(schema)\n+              .createWriterFunc(DataWriter::create)\n+              .named(fileFormat.name())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38e060571797e758c5562c3b0cedb76119008ffd"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0OTU3ODU2OnYy", "diffSide": "RIGHT", "path": "data/src/main/java/org/apache/iceberg/data/GenericAppenderFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMzowNzo1M1rOHCBtxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMzowNzo1M1rOHCBtxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg4NzMwMQ==", "bodyText": "ditto", "url": "https://github.com/apache/iceberg/pull/1340#discussion_r471887301", "createdAt": "2020-08-18T03:07:53Z", "author": {"login": "openinx"}, "path": "data/src/main/java/org/apache/iceberg/data/GenericAppenderFactory.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.data;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.util.Map;\n+import org.apache.iceberg.FileFormat;\n+import org.apache.iceberg.Schema;\n+import org.apache.iceberg.avro.Avro;\n+import org.apache.iceberg.data.avro.DataWriter;\n+import org.apache.iceberg.data.orc.GenericOrcWriter;\n+import org.apache.iceberg.data.parquet.GenericParquetWriter;\n+import org.apache.iceberg.io.FileAppender;\n+import org.apache.iceberg.io.FileAppenderFactory;\n+import org.apache.iceberg.io.OutputFile;\n+import org.apache.iceberg.orc.ORC;\n+import org.apache.iceberg.parquet.Parquet;\n+import org.apache.iceberg.relocated.com.google.common.collect.Maps;\n+\n+/**\n+ * Factory to create a new {@link FileAppender} to write {@link Record}s.\n+ */\n+public class GenericAppenderFactory implements FileAppenderFactory<Record> {\n+\n+  private final Schema schema;\n+  private final Map<String, String> config = Maps.newHashMap();\n+\n+  public GenericAppenderFactory(Schema schema) {\n+    this.schema = schema;\n+  }\n+\n+  public GenericAppenderFactory set(String property, String value) {\n+    config.put(property, value);\n+    return this;\n+  }\n+\n+  public GenericAppenderFactory setAll(Map<String, String> properties) {\n+    config.putAll(properties);\n+    return this;\n+  }\n+\n+  @Override\n+  public FileAppender<Record> newAppender(OutputFile outputFile, FileFormat fileFormat) {\n+    try {\n+      switch (fileFormat) {\n+        case AVRO:\n+          return Avro.write(outputFile)\n+              .schema(schema)\n+              .createWriterFunc(DataWriter::create)\n+              .named(fileFormat.name())\n+              .setAll(config)\n+              .build();\n+\n+        case PARQUET:\n+          return Parquet.write(outputFile)\n+              .schema(schema)\n+              .createWriterFunc(GenericParquetWriter::buildWriter)\n+              .named(fileFormat.name())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38e060571797e758c5562c3b0cedb76119008ffd"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0OTU4MjU1OnYy", "diffSide": "RIGHT", "path": "data/src/main/java/org/apache/iceberg/data/GenericAppenderFactory.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMzoxMDoxMlrOHCBwJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMDoyMToyNVrOHDiLgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg4NzkwOQ==", "bodyText": "To keep the consistent semantics,  I suggest to set overwrite=true. Both flink and spark's FileAppenderFactory have enabled the overwrite.", "url": "https://github.com/apache/iceberg/pull/1340#discussion_r471887909", "createdAt": "2020-08-18T03:10:12Z", "author": {"login": "openinx"}, "path": "data/src/main/java/org/apache/iceberg/data/GenericAppenderFactory.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.data;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.util.Map;\n+import org.apache.iceberg.FileFormat;\n+import org.apache.iceberg.Schema;\n+import org.apache.iceberg.avro.Avro;\n+import org.apache.iceberg.data.avro.DataWriter;\n+import org.apache.iceberg.data.orc.GenericOrcWriter;\n+import org.apache.iceberg.data.parquet.GenericParquetWriter;\n+import org.apache.iceberg.io.FileAppender;\n+import org.apache.iceberg.io.FileAppenderFactory;\n+import org.apache.iceberg.io.OutputFile;\n+import org.apache.iceberg.orc.ORC;\n+import org.apache.iceberg.parquet.Parquet;\n+import org.apache.iceberg.relocated.com.google.common.collect.Maps;\n+\n+/**\n+ * Factory to create a new {@link FileAppender} to write {@link Record}s.\n+ */\n+public class GenericAppenderFactory implements FileAppenderFactory<Record> {\n+\n+  private final Schema schema;\n+  private final Map<String, String> config = Maps.newHashMap();\n+\n+  public GenericAppenderFactory(Schema schema) {\n+    this.schema = schema;\n+  }\n+\n+  public GenericAppenderFactory set(String property, String value) {\n+    config.put(property, value);\n+    return this;\n+  }\n+\n+  public GenericAppenderFactory setAll(Map<String, String> properties) {\n+    config.putAll(properties);\n+    return this;\n+  }\n+\n+  @Override\n+  public FileAppender<Record> newAppender(OutputFile outputFile, FileFormat fileFormat) {\n+    try {\n+      switch (fileFormat) {\n+        case AVRO:\n+          return Avro.write(outputFile)\n+              .schema(schema)\n+              .createWriterFunc(DataWriter::create)\n+              .named(fileFormat.name())\n+              .setAll(config)\n+              .build();\n+\n+        case PARQUET:\n+          return Parquet.write(outputFile)\n+              .schema(schema)\n+              .createWriterFunc(GenericParquetWriter::buildWriter)\n+              .named(fileFormat.name())\n+              .setAll(config)\n+              .build();\n+\n+        case ORC:\n+          return ORC.write(outputFile)\n+              .schema(schema)\n+              .createWriterFunc(GenericOrcWriter::buildWriter)\n+              .setAll(config)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38e060571797e758c5562c3b0cedb76119008ffd"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ2Nzc3Nw==", "bodyText": "Yes, they do.", "url": "https://github.com/apache/iceberg/pull/1340#discussion_r473467777", "createdAt": "2020-08-20T00:21:25Z", "author": {"login": "rdblue"}, "path": "data/src/main/java/org/apache/iceberg/data/GenericAppenderFactory.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.data;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.util.Map;\n+import org.apache.iceberg.FileFormat;\n+import org.apache.iceberg.Schema;\n+import org.apache.iceberg.avro.Avro;\n+import org.apache.iceberg.data.avro.DataWriter;\n+import org.apache.iceberg.data.orc.GenericOrcWriter;\n+import org.apache.iceberg.data.parquet.GenericParquetWriter;\n+import org.apache.iceberg.io.FileAppender;\n+import org.apache.iceberg.io.FileAppenderFactory;\n+import org.apache.iceberg.io.OutputFile;\n+import org.apache.iceberg.orc.ORC;\n+import org.apache.iceberg.parquet.Parquet;\n+import org.apache.iceberg.relocated.com.google.common.collect.Maps;\n+\n+/**\n+ * Factory to create a new {@link FileAppender} to write {@link Record}s.\n+ */\n+public class GenericAppenderFactory implements FileAppenderFactory<Record> {\n+\n+  private final Schema schema;\n+  private final Map<String, String> config = Maps.newHashMap();\n+\n+  public GenericAppenderFactory(Schema schema) {\n+    this.schema = schema;\n+  }\n+\n+  public GenericAppenderFactory set(String property, String value) {\n+    config.put(property, value);\n+    return this;\n+  }\n+\n+  public GenericAppenderFactory setAll(Map<String, String> properties) {\n+    config.putAll(properties);\n+    return this;\n+  }\n+\n+  @Override\n+  public FileAppender<Record> newAppender(OutputFile outputFile, FileFormat fileFormat) {\n+    try {\n+      switch (fileFormat) {\n+        case AVRO:\n+          return Avro.write(outputFile)\n+              .schema(schema)\n+              .createWriterFunc(DataWriter::create)\n+              .named(fileFormat.name())\n+              .setAll(config)\n+              .build();\n+\n+        case PARQUET:\n+          return Parquet.write(outputFile)\n+              .schema(schema)\n+              .createWriterFunc(GenericParquetWriter::buildWriter)\n+              .named(fileFormat.name())\n+              .setAll(config)\n+              .build();\n+\n+        case ORC:\n+          return ORC.write(outputFile)\n+              .schema(schema)\n+              .createWriterFunc(GenericOrcWriter::buildWriter)\n+              .setAll(config)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg4NzkwOQ=="}, "originalCommit": {"oid": "38e060571797e758c5562c3b0cedb76119008ffd"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0OTYyOTk4OnYy", "diffSide": "RIGHT", "path": "data/src/test/java/org/apache/iceberg/data/GenericAppenderHelper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMzozODoyMVrOHCCKyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMzozODoyMVrOHCCKyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg5NDcyOQ==", "bodyText": "We could call the withPartition(partition) directly without this nullable check, because builder will handle  this inside it.", "url": "https://github.com/apache/iceberg/pull/1340#discussion_r471894729", "createdAt": "2020-08-18T03:38:21Z", "author": {"login": "openinx"}, "path": "data/src/test/java/org/apache/iceberg/data/GenericAppenderHelper.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.data;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import org.apache.iceberg.AppendFiles;\n+import org.apache.iceberg.DataFile;\n+import org.apache.iceberg.DataFiles;\n+import org.apache.iceberg.FileFormat;\n+import org.apache.iceberg.Files;\n+import org.apache.iceberg.StructLike;\n+import org.apache.iceberg.Table;\n+import org.apache.iceberg.io.FileAppender;\n+import org.apache.iceberg.relocated.com.google.common.base.Preconditions;\n+import org.junit.Assert;\n+import org.junit.rules.TemporaryFolder;\n+\n+/**\n+ * Helper for appending {@link DataFile} to a table or appending {@link Record}s to a table.\n+ */\n+public class GenericAppenderHelper {\n+\n+  private final Table table;\n+  private final FileFormat fileFormat;\n+  private final TemporaryFolder tmp;\n+\n+  public GenericAppenderHelper(Table table, FileFormat fileFormat, TemporaryFolder tmp) {\n+    this.table = table;\n+    this.fileFormat = fileFormat;\n+    this.tmp = tmp;\n+  }\n+\n+  public void appendToTable(DataFile... dataFiles) {\n+    Preconditions.checkNotNull(table, \"table not set\");\n+\n+    AppendFiles append = table.newAppend();\n+\n+    for (DataFile dataFile : dataFiles) {\n+      append = append.appendFile(dataFile);\n+    }\n+\n+    append.commit();\n+  }\n+\n+  public void appendToTable(List<Record> records) throws IOException {\n+    appendToTable(null, records);\n+  }\n+\n+  public void appendToTable(StructLike partition, List<Record> records) throws IOException {\n+    appendToTable(writeFile(partition, records));\n+  }\n+\n+  public DataFile writeFile(StructLike partition, List<Record> records) throws IOException {\n+    Preconditions.checkNotNull(table, \"table not set\");\n+    File file = tmp.newFile();\n+    Assert.assertTrue(file.delete());\n+    return appendToLocalFile(table, file, fileFormat, partition, records);\n+  }\n+\n+  private static DataFile appendToLocalFile(\n+      Table table, File file, FileFormat format, StructLike partition, List<Record> records)\n+      throws IOException {\n+    FileAppender<Record> appender = new GenericAppenderFactory(table.schema()).newAppender(\n+        Files.localOutput(file), format);\n+    try (FileAppender<Record> fileAppender = appender) {\n+      fileAppender.addAll(records);\n+    }\n+\n+    DataFiles.Builder builder = DataFiles.builder(table.spec())\n+        .withRecordCount(records.size())\n+        .withFileSizeInBytes(file.length())\n+        .withPath(file.toURI().toString())\n+        .withMetrics(appender.metrics())\n+        .withFormat(format);\n+    if (partition != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38e060571797e758c5562c3b0cedb76119008ffd"}, "originalPosition": 94}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3650, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}