{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNTkwNDc2", "number": 1786, "title": "AWS: centralize logic for setting encryption info", "bodyText": "Try to address issue in #1767 for different request types to set encryption information.", "createdAt": "2020-11-19T00:13:37Z", "url": "https://github.com/apache/iceberg/pull/1786", "merged": true, "mergeCommit": {"oid": "b64bac571f1d63b53c732a5786a1bd988009086d"}, "closed": true, "closedAt": "2020-11-24T01:42:27Z", "author": {"login": "jackye1995"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfaZ-8ABqjQwMjkzMTkwMDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfd1HWgBqjQwMzAwODUyODI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0533d09b91e67f4ecab0f62e8feb2ac9b9471e14", "author": {"user": {"login": "jackye1995", "name": "Jack Ye"}}, "url": "https://github.com/apache/iceberg/commit/0533d09b91e67f4ecab0f62e8feb2ac9b9471e14", "committedDate": "2020-11-19T00:10:52Z", "message": "centralize logic for setting encryption info"}, "afterCommit": {"oid": "ad7fd4134aea8e2ba877b4c2e59ec21a8e67dda9", "author": {"user": {"login": "jackye1995", "name": "Jack Ye"}}, "url": "https://github.com/apache/iceberg/commit/ad7fd4134aea8e2ba877b4c2e59ec21a8e67dda9", "committedDate": "2020-11-23T19:34:40Z", "message": "AWS: centralize logic for setting encryption info"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad7fd4134aea8e2ba877b4c2e59ec21a8e67dda9", "author": {"user": {"login": "jackye1995", "name": "Jack Ye"}}, "url": "https://github.com/apache/iceberg/commit/ad7fd4134aea8e2ba877b4c2e59ec21a8e67dda9", "committedDate": "2020-11-23T19:34:40Z", "message": "AWS: centralize logic for setting encryption info"}, "afterCommit": {"oid": "c436a33317ffff26d5aed015d9f714115ead2903", "author": {"user": {"login": "jackye1995", "name": "Jack Ye"}}, "url": "https://github.com/apache/iceberg/commit/c436a33317ffff26d5aed015d9f714115ead2903", "committedDate": "2020-11-23T19:41:35Z", "message": "AWS: centralize logic for setting encryption info"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2ODkyMjEz", "url": "https://github.com/apache/iceberg/pull/1786#pullrequestreview-536892213", "createdAt": "2020-11-23T22:23:44Z", "commit": {"oid": "c436a33317ffff26d5aed015d9f714115ead2903"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMjoyMzo0NFrOH4huAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMjoyMzo0NFrOH4huAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTAzNDc1NQ==", "bodyText": "The null checks as controls feel a little awkward.  Would it make sense to switch them out for noop functions like:\n  private static final Function<ServerSideEncryption, S3Request.Builder> noSse = s -> null;\n  private static final Function<String, S3Request.Builder> noKms = (s) -> null;\n\nI feel like that would be easier to reason about.", "url": "https://github.com/apache/iceberg/pull/1786#discussion_r529034755", "createdAt": "2020-11-23T22:23:44Z", "author": {"login": "danielcweeks"}, "path": "aws/src/main/java/org/apache/iceberg/aws/s3/S3RequestUtil.java", "diffHunk": "@@ -33,87 +36,66 @@ private S3RequestUtil() {\n   }\n \n   static void configureEncryption(AwsProperties awsProperties, PutObjectRequest.Builder requestBuilder) {\n-    switch (awsProperties.s3FileIoSseType().toLowerCase(Locale.ENGLISH)) {\n-      case AwsProperties.S3FILEIO_SSE_TYPE_NONE:\n-        break;\n+    configureEncryption(awsProperties, requestBuilder::serverSideEncryption, requestBuilder::ssekmsKeyId,\n+        requestBuilder::sseCustomerAlgorithm, requestBuilder::sseCustomerKey, requestBuilder::sseCustomerKeyMD5);\n+  }\n \n-      case AwsProperties.S3FILEIO_SSE_TYPE_KMS:\n-        requestBuilder.serverSideEncryption(ServerSideEncryption.AWS_KMS);\n-        requestBuilder.ssekmsKeyId(awsProperties.s3FileIoSseKey());\n-        break;\n+  static void configureEncryption(AwsProperties awsProperties, CreateMultipartUploadRequest.Builder requestBuilder) {\n+    configureEncryption(awsProperties, requestBuilder::serverSideEncryption, requestBuilder::ssekmsKeyId,\n+        requestBuilder::sseCustomerAlgorithm, requestBuilder::sseCustomerKey, requestBuilder::sseCustomerKeyMD5);\n+  }\n \n-      case AwsProperties.S3FILEIO_SSE_TYPE_S3:\n-        requestBuilder.serverSideEncryption(ServerSideEncryption.AES256);\n-        break;\n+  static void configureEncryption(AwsProperties awsProperties, UploadPartRequest.Builder requestBuilder) {\n+    configureEncryption(awsProperties, null, null,\n+        requestBuilder::sseCustomerAlgorithm, requestBuilder::sseCustomerKey, requestBuilder::sseCustomerKeyMD5);\n+  }\n \n-      case AwsProperties.S3FILEIO_SSE_TYPE_CUSTOM:\n-        requestBuilder.sseCustomerAlgorithm(ServerSideEncryption.AES256.name());\n-        requestBuilder.sseCustomerKey(awsProperties.s3FileIoSseKey());\n-        requestBuilder.sseCustomerKeyMD5(awsProperties.s3FileIoSseMd5());\n-        break;\n+  static void configureEncryption(AwsProperties awsProperties, GetObjectRequest.Builder requestBuilder) {\n+    configureEncryption(awsProperties, null, null,\n+        requestBuilder::sseCustomerAlgorithm, requestBuilder::sseCustomerKey, requestBuilder::sseCustomerKeyMD5);\n+  }\n \n-      default:\n-        throw new IllegalArgumentException(\n-            \"Cannot support given S3 encryption type: \" + awsProperties.s3FileIoSseType());\n-    }\n+  static void configureEncryption(AwsProperties awsProperties, HeadObjectRequest.Builder requestBuilder) {\n+    configureEncryption(awsProperties, null, null,\n+        requestBuilder::sseCustomerAlgorithm, requestBuilder::sseCustomerKey, requestBuilder::sseCustomerKeyMD5);\n   }\n \n-  static void configureEncryption(AwsProperties awsProperties, CreateMultipartUploadRequest.Builder requestBuilder) {\n+  @SuppressWarnings(\"ReturnValueIgnored\")\n+  static void configureEncryption(\n+      AwsProperties awsProperties,\n+      Function<ServerSideEncryption, S3Request.Builder> encryptionSetter,\n+      Function<String, S3Request.Builder> kmsKeySetter,\n+      Function<String, S3Request.Builder> customAlgorithmSetter,\n+      Function<String, S3Request.Builder> customKeySetter,\n+      Function<String, S3Request.Builder> customMd5Setter) {\n+\n     switch (awsProperties.s3FileIoSseType().toLowerCase(Locale.ENGLISH)) {\n       case AwsProperties.S3FILEIO_SSE_TYPE_NONE:\n         break;\n \n       case AwsProperties.S3FILEIO_SSE_TYPE_KMS:\n-        requestBuilder.serverSideEncryption(ServerSideEncryption.AWS_KMS);\n-        requestBuilder.ssekmsKeyId(awsProperties.s3FileIoSseKey());\n-        break;\n+        if (encryptionSetter != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c436a33317ffff26d5aed015d9f714115ead2903"}, "originalPosition": 79}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c436a33317ffff26d5aed015d9f714115ead2903", "author": {"user": {"login": "jackye1995", "name": "Jack Ye"}}, "url": "https://github.com/apache/iceberg/commit/c436a33317ffff26d5aed015d9f714115ead2903", "committedDate": "2020-11-23T19:41:35Z", "message": "AWS: centralize logic for setting encryption info"}, "afterCommit": {"oid": "bc679a631adeb333a8b604157feeba7139cb8d0b", "author": {"user": {"login": "jackye1995", "name": "Jack Ye"}}, "url": "https://github.com/apache/iceberg/commit/bc679a631adeb333a8b604157feeba7139cb8d0b", "committedDate": "2020-11-23T23:26:28Z", "message": "AWS: centralize logic for setting encryption info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c673cc19fa829ff9cb52a986b699fe057fa7f35", "author": {"user": {"login": "jackye1995", "name": "Jack Ye"}}, "url": "https://github.com/apache/iceberg/commit/4c673cc19fa829ff9cb52a986b699fe057fa7f35", "committedDate": "2020-11-23T23:34:02Z", "message": "AWS: centralize logic for setting encryption info"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc679a631adeb333a8b604157feeba7139cb8d0b", "author": {"user": {"login": "jackye1995", "name": "Jack Ye"}}, "url": "https://github.com/apache/iceberg/commit/bc679a631adeb333a8b604157feeba7139cb8d0b", "committedDate": "2020-11-23T23:26:28Z", "message": "AWS: centralize logic for setting encryption info"}, "afterCommit": {"oid": "4c673cc19fa829ff9cb52a986b699fe057fa7f35", "author": {"user": {"login": "jackye1995", "name": "Jack Ye"}}, "url": "https://github.com/apache/iceberg/commit/4c673cc19fa829ff9cb52a986b699fe057fa7f35", "committedDate": "2020-11-23T23:34:02Z", "message": "AWS: centralize logic for setting encryption info"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3788, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}