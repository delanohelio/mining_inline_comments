{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2ODMyNjQ5", "number": 1127, "title": "ORC: fix date metrics to adjust milliseconds to local timezone", "bodyText": "This PR attempts to solve issues #1116 and #1113 when running in different Time Zones.\nI've added a test to check for local scan on different timezones which surfaced an issue with the pushdown predicates with DATE columns, which seem to use incorrect incorrect TZ to read the metrics within the ORC reader. Due to this, disabling ORC lower/upper bound metrics for Date in Iceberg as well.\nI've tested by changing system TZ to other timezones and running the tests and they pass.\nPTAL @shardulm94 @chenjunjiedada if you have a chance, please pull this branch and run the test suite locally just to double check the build. Thanks!\n@rdblue", "createdAt": "2020-06-19T01:01:03Z", "url": "https://github.com/apache/iceberg/pull/1127", "merged": true, "mergeCommit": {"oid": "4e282c3d13936592e0d27a92356de1c57aa58ce1"}, "closed": true, "closedAt": "2020-06-27T20:42:11Z", "author": {"login": "edgarRd"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsoYzvgBqjM0NjA1NjAwMTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvNTJSAH2gAyNDM2ODMyNjQ5OmQ4NDQxZTJkYTcwNWFlM2MyMjVkY2Y4NGYyMTc4OTI3OWMxZTc5NTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "524e5cd5fd0200fb4057a65214a6be6eb4b80141", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/524e5cd5fd0200fb4057a65214a6be6eb4b80141", "committedDate": "2020-06-19T00:58:54Z", "message": "Disable ORC lower/upper bound metrics for Date"}, "afterCommit": {"oid": "30a5884ca2ac3d2189df93ebf6a2778d8f1a23db", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/30a5884ca2ac3d2189df93ebf6a2778d8f1a23db", "committedDate": "2020-06-19T01:01:54Z", "message": "Disable ORC lower/upper bound metrics for Date"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30a5884ca2ac3d2189df93ebf6a2778d8f1a23db", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/30a5884ca2ac3d2189df93ebf6a2778d8f1a23db", "committedDate": "2020-06-19T01:01:54Z", "message": "Disable ORC lower/upper bound metrics for Date"}, "afterCommit": {"oid": "dfa545bf409665ec12800ddc55b627632514b01c", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/dfa545bf409665ec12800ddc55b627632514b01c", "committedDate": "2020-06-19T18:21:55Z", "message": "Disable ORC lower/upper bound metrics for Date"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82d46d3c733914627ef89ae921788a60f2655f0a", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/82d46d3c733914627ef89ae921788a60f2655f0a", "committedDate": "2020-06-22T20:26:08Z", "message": "Add missing reset of current timezone in ORC tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6fc6885f4ee7f0b00b224510191e4f5a7c3a547", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/a6fc6885f4ee7f0b00b224510191e4f5a7c3a547", "committedDate": "2020-06-23T00:26:40Z", "message": "Use sql.Date.toLocalDate for lower/upper bounds to normalize TZ"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1fa8e6b3a636d434a46da360556fca100219ba0", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/b1fa8e6b3a636d434a46da360556fca100219ba0", "committedDate": "2020-06-23T00:34:44Z", "message": "Add comment on multiple TZ testing with ORC"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dfa545bf409665ec12800ddc55b627632514b01c", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/dfa545bf409665ec12800ddc55b627632514b01c", "committedDate": "2020-06-19T18:21:55Z", "message": "Disable ORC lower/upper bound metrics for Date"}, "afterCommit": {"oid": "b1fa8e6b3a636d434a46da360556fca100219ba0", "author": {"user": {"login": "edgarRd", "name": "Edgar Rodriguez"}}, "url": "https://github.com/apache/iceberg/commit/b1fa8e6b3a636d434a46da360556fca100219ba0", "committedDate": "2020-06-23T00:34:44Z", "message": "Add comment on multiple TZ testing with ORC"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjE0MDU5", "url": "https://github.com/apache/iceberg/pull/1127#pullrequestreview-438614059", "createdAt": "2020-06-26T21:47:28Z", "commit": {"oid": "b1fa8e6b3a636d434a46da360556fca100219ba0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMTo0NzoyOFrOGpvozQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMTo0NzoyOFrOGpvozQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQyNTI5Mw==", "bodyText": "Javadoc for Date.toLocalDate says that the LocalDate returned is \"in local time zone\". It is implemented like this:\nreturn LocalDate.of(getYear() + 1900, getMonth() + 1, getDate());\nAnd, those getter methods use the current zone. So this cannot be correct because the value is dependent on the local zone. I think your intent was to account for the adjustment made by ORC that you referenced by saying \"Getting the min/max stats for Date types in ORC are returned with milliseconds adjusted to the local timezone.\"\nI think the main problem is that this uses a path where the value is modified by ORC based on the JVM environment, which breaks a fundamental rule in Iceberg. I don't think that we should use a path where the value is modified. It's just too hard to guarantee that although the value was modified, we were able to correctly undo it.", "url": "https://github.com/apache/iceberg/pull/1127#discussion_r446425293", "createdAt": "2020-06-26T21:47:28Z", "author": {"login": "rdblue"}, "path": "orc/src/main/java/org/apache/iceberg/orc/OrcMetrics.java", "diffHunk": "@@ -158,8 +158,7 @@ private static Metrics buildOrcMetrics(final long numOfRows, final TypeDescripti\n           .orElse(null);\n     } else if (columnStats instanceof DateColumnStatistics) {\n       min = Optional.ofNullable(((DateColumnStatistics) columnStats).getMinimum())\n-          .map(minStats -> DateTimeUtil.daysFromDate(\n-              DateTimeUtil.EPOCH.plus(minStats.getTime(), ChronoUnit.MILLIS).toLocalDate()))\n+          .map(minStats -> DateTimeUtil.daysFromDate(((Date) minStats).toLocalDate()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1fa8e6b3a636d434a46da360556fca100219ba0"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8441e2da705ae3c225dcf84f21789279c1e7955", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/d8441e2da705ae3c225dcf84f21789279c1e7955", "committedDate": "2020-06-27T01:10:12Z", "message": "Use Java reflection to get ORC date stats. (#1)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4544, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}