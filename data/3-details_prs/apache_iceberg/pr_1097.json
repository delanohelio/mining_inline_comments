{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4MzU3ODQ0", "number": 1097, "title": "Add test case for deleting column in hive metastore ", "bodyText": "When deleting a table's column in Hive Metastore, which has different type against next column, it will fail  as METASTORE_DISALLOW_INCOMPATIBLE_COL_TYPE_CHANGES  is set to true by default.\nThis pull request adds a test case to cover this case with METASTORE_DISALLOW_INCOMPATIBLE_COL_TYPE_CHANGES set to false.\nRefer to issue #1092.", "createdAt": "2020-06-05T10:15:17Z", "url": "https://github.com/apache/iceberg/pull/1097", "merged": true, "mergeCommit": {"oid": "6194647c86eb60ff554ad49689c1ab3a89f73d2c"}, "closed": true, "closedAt": "2020-06-09T21:16:36Z", "author": {"login": "vanliu-tx"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpTNkwAFqTQyNjQyMDIyNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpnzM4AH2gAyNDI4MzU3ODQ0OjYxNGMzZmYwMmY0ZjE0YzU0ZmIxYTgyMDUyMjJjNTg1ZWQ4NDNmNTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDIwMjI0", "url": "https://github.com/apache/iceberg/pull/1097#pullrequestreview-426420224", "createdAt": "2020-06-08T16:40:00Z", "commit": {"oid": "eaa3bb0e123e063624eb774848ccc4d740c18243"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjo0MDowMFrOGgm2Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjo0MDowMFrOGgm2Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0NDAzNA==", "bodyText": "Tests for new cases should be in separate test methods instead of tacked on to existing tests. Also, can you change the assertions to check the full table schema instead of just sizes? It should be something like this:\nSchema expectedSchema = new Schema(...);\nicebergTable.updateSchema()\n    ...\n    .commit();\n\nAssert.assertEquals(\"Schema should match expected\", expected.asStruct(), icebergTable.schema().asStruct());", "url": "https://github.com/apache/iceberg/pull/1097#discussion_r436844034", "createdAt": "2020-06-08T16:40:00Z", "author": {"login": "rdblue"}, "path": "hive/src/test/java/org/apache/iceberg/hive/HiveTableTest.java", "diffHunk": "@@ -238,6 +238,19 @@ public void testExistingTableUpdate() throws TException {\n         .map(Types.NestedField::name)\n         .collect(Collectors.toList());\n     Assert.assertEquals(icebergColumns, hiveColumns);\n+\n+    // Add two columns with different types, then verify we could delete the first column in hive metastore\n+    // as hive conf METASTORE_DISALLOW_INCOMPATIBLE_COL_TYPE_CHANGES was set to false. If this was set to true,\n+    // an InvalidOperationException would thrown in method MetaStoreUtils#throwExceptionIfIncompatibleColTypeChange()\n+    int columnCount = icebergTable.schema().columns().size();\n+    icebergTable.updateSchema()\n+            .addColumn(\"str1\", Types.StringType.get())\n+            .addColumn(\"int1\", Types.IntegerType.get())\n+            .commit();\n+    Assert.assertEquals(\"2 columns added\", columnCount + 2, icebergTable.schema().columns().size());\n+\n+    icebergTable.updateSchema().deleteColumn(\"str1\").commit();\n+    Assert.assertEquals(\"1 column deleted\", columnCount + 1, icebergTable.schema().columns().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaa3bb0e123e063624eb774848ccc4d740c18243"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b6e09c73b15991bb8269267027b15899bd7a297", "author": {"user": {"login": "vanliu-tx", "name": "vanliu"}}, "url": "https://github.com/apache/iceberg/commit/7b6e09c73b15991bb8269267027b15899bd7a297", "committedDate": "2020-06-09T11:50:52Z", "message": "Add test case for deleting column in hive metastore with METASTORE_DISALLOW_INCOMPATIBLE_COL_TYPE_CHANGES set to false"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MzQ2NjAy", "url": "https://github.com/apache/iceberg/pull/1097#pullrequestreview-427346602", "createdAt": "2020-06-09T16:38:01Z", "commit": {"oid": "7b6e09c73b15991bb8269267027b15899bd7a297"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNjozODowMlrOGhTFuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNjozODowMlrOGhTFuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2ODk1NQ==", "bodyText": "It isn't necessary to reload the table. The one in memory is updated when an operation commits.", "url": "https://github.com/apache/iceberg/pull/1097#discussion_r437568955", "createdAt": "2020-06-09T16:38:02Z", "author": {"login": "rdblue"}, "path": "hive/src/test/java/org/apache/iceberg/hive/HiveTableTest.java", "diffHunk": "@@ -240,6 +243,37 @@ public void testExistingTableUpdate() throws TException {\n     Assert.assertEquals(icebergColumns, hiveColumns);\n   }\n \n+  @Test\n+  public void testColumnTypeChangeInMetastore() throws TException {\n+    Table icebergTable = catalog.loadTable(TABLE_IDENTIFIER);\n+\n+    Schema expectedSchema = new Schema(Types.StructType.of(\n+            required(1, \"id\", Types.LongType.get()),\n+            optional(2, \"data\", Types.LongType.get()),\n+            optional(3, \"string\", Types.StringType.get()),\n+            optional(4, \"int\", Types.IntegerType.get())).fields());\n+    // Add columns with different types, then verify we could delete one column in hive metastore\n+    // as hive conf METASTORE_DISALLOW_INCOMPATIBLE_COL_TYPE_CHANGES was set to false. If this was set to true,\n+    // an InvalidOperationException would thrown in method MetaStoreUtils#throwExceptionIfIncompatibleColTypeChange()\n+    icebergTable.updateSchema()\n+            .addColumn(\"data\", Types.LongType.get())\n+            .addColumn(\"string\", Types.StringType.get())\n+            .addColumn(\"int\", Types.IntegerType.get())\n+            .commit();\n+\n+    icebergTable = catalog.loadTable(TABLE_IDENTIFIER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b6e09c73b15991bb8269267027b15899bd7a297"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "614c3ff02f4f14c54fb1a8205222c585ed843f52", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/614c3ff02f4f14c54fb1a8205222c585ed843f52", "committedDate": "2020-06-09T16:39:12Z", "message": "Remove unnecessary load calls."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4487, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}