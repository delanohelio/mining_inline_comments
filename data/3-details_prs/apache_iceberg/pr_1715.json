{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MDkwMDQ4", "number": 1715, "title": "Fix Actions to be Compatible with V2 Catalogs", "bodyText": "Previously the Action code would use the table name when attempting to look\nup MetadataTable names. This is an issue in Spark3 with V2 catalogs because\nwe strip off the catalog information if the catalog is named \"hadoop\" or \"hive\"\nand include it in all other cases. When we include the catalog name this breaks\nthe lookup code which uses the DataSourceRegistry pathway and not the V2 Table\npathway. To fix this we introduce a method for using the V2 pathway when a catalog\nname is present.", "createdAt": "2020-11-04T02:11:04Z", "url": "https://github.com/apache/iceberg/pull/1715", "merged": true, "mergeCommit": {"oid": "e6fc424a4017e582051fcf9c4695843772f37424"}, "closed": true, "closedAt": "2020-11-18T19:12:48Z", "author": {"login": "RussellSpitzer"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZEyjngFqTUyMzAxMzI4NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABddzFTBgFqTUzMzc4OTk3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMDEzMjg0", "url": "https://github.com/apache/iceberg/pull/1715#pullrequestreview-523013284", "createdAt": "2020-11-04T03:00:11Z", "commit": {"oid": "9ab39c789cf014a8b27749e8736e914c4d882b15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMzowMDoxMVrOHtHirg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMzowMDoxMVrOHtHirg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA3MTUzNA==", "bodyText": "Maybe this method can not handle some corner cases.\nFor example, in the spark2 action, the file_path is very special (file://level1.level2.level3.level4/database/table).", "url": "https://github.com/apache/iceberg/pull/1715#discussion_r517071534", "createdAt": "2020-11-04T03:00:11Z", "author": {"login": "liukun4515"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "diffHunk": "@@ -144,6 +123,32 @@ protected String metadataTableName(String tableName, MetadataTableType type) {\n     return manifestDF.union(otherMetadataFileDF).union(manifestListDF);\n   }\n \n+  protected Dataset<Row> loadMetadataTable(SparkSession spark, String tableName, MetadataTableType type) {\n+    String metadataTableName = metadataTableName(tableName, type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ab39c789cf014a8b27749e8736e914c4d882b15"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMDE2MTEz", "url": "https://github.com/apache/iceberg/pull/1715#pullrequestreview-523016113", "createdAt": "2020-11-04T03:09:52Z", "commit": {"oid": "9ab39c789cf014a8b27749e8736e914c4d882b15"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMDIwNzEw", "url": "https://github.com/apache/iceberg/pull/1715#pullrequestreview-523020710", "createdAt": "2020-11-04T03:26:49Z", "commit": {"oid": "9ab39c789cf014a8b27749e8736e914c4d882b15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMzoyNjo0OVrOHtH7zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMzoyNjo0OVrOHtH7zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA3Nzk2NQ==", "bodyText": "can we add some examples for explaining the case?", "url": "https://github.com/apache/iceberg/pull/1715#discussion_r517077965", "createdAt": "2020-11-04T03:26:49Z", "author": {"login": "liukun4515"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "diffHunk": "@@ -144,6 +123,32 @@ protected String metadataTableName(String tableName, MetadataTableType type) {\n     return manifestDF.union(otherMetadataFileDF).union(manifestListDF);\n   }\n \n+  protected Dataset<Row> loadMetadataTable(SparkSession spark, String tableName, MetadataTableType type) {\n+    String metadataTableName = metadataTableName(tableName, type);\n+    if (metadataTableName.split(\"\\\\.\").length > 3) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ab39c789cf014a8b27749e8736e914c4d882b15"}, "originalPosition": 53}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ab39c789cf014a8b27749e8736e914c4d882b15", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/9ab39c789cf014a8b27749e8736e914c4d882b15", "committedDate": "2020-11-04T02:10:34Z", "message": "Fix Actions to be Compatible with V2 Catalogs\n\nPreviously the Action code would use the table name when attempting to look\nup MetadataTable names. This is an issue in Spark3 with V2 catalogs because\nwe strip off the catalog information if the catalog is named \"hadoop\" or \"hive\"\nand include it in all other cases. When we include the catalog name this breaks\nthe lookup code which uses the DataSourceRegistry pathway and not the V2 Table\npathway. To fix this we introduce a method for using the V2 pathway when a catalog\nname is present."}, "afterCommit": {"oid": "2d7acebf5da8c73d72caedebf6dfb94d36cb4534", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/2d7acebf5da8c73d72caedebf6dfb94d36cb4534", "committedDate": "2020-11-04T03:29:09Z", "message": "Fix Actions to be Compatible with V2 Catalogs\n\nPreviously the Action code would use the table name when attempting to look\nup MetadataTable names. This is an issue in Spark3 with V2 catalogs because\nwe strip off the catalog information if the catalog is named \"hadoop\" or \"hive\"\nand include it in all other cases. When we include the catalog name this breaks\nthe lookup code which uses the DataSourceRegistry pathway and not the V2 Table\npathway. To fix this we introduce a method for using the V2 pathway when a catalog\nname is present."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMDMyMjg4", "url": "https://github.com/apache/iceberg/pull/1715#pullrequestreview-523032288", "createdAt": "2020-11-04T04:12:54Z", "commit": {"oid": "2d7acebf5da8c73d72caedebf6dfb94d36cb4534"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwNDoxMjo1NFrOHtIiTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwNDoxMjo1NFrOHtIiTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA4NzgyMw==", "bodyText": "I only added this, (and the test inside orphan files) because we'll have additional coverage for the use cases once the SQL api is introduced and vectorizing the entire suite of actions was getting a bit onerous.", "url": "https://github.com/apache/iceberg/pull/1715#discussion_r517087823", "createdAt": "2020-11-04T04:12:54Z", "author": {"login": "RussellSpitzer"}, "path": "spark3/src/test/java/org/apache/iceberg/actions/TestRemoveOrphanFilesAction3.java", "diffHunk": "@@ -19,5 +19,46 @@\n \n package org.apache.iceberg.actions;\n \n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.iceberg.relocated.com.google.common.collect.Maps;\n+import org.apache.iceberg.spark.SparkCatalog;\n+import org.apache.iceberg.spark.SparkSchemaUtil;\n+import org.apache.iceberg.spark.source.SparkTable;\n+import org.apache.spark.sql.catalyst.analysis.NoSuchTableException;\n+import org.apache.spark.sql.catalyst.analysis.TableAlreadyExistsException;\n+import org.apache.spark.sql.connector.catalog.Identifier;\n+import org.apache.spark.sql.connector.expressions.Transform;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n public class TestRemoveOrphanFilesAction3 extends TestRemoveOrphanFilesAction {\n+  @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d7acebf5da8c73d72caedebf6dfb94d36cb4534"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMDMyNjMy", "url": "https://github.com/apache/iceberg/pull/1715#pullrequestreview-523032632", "createdAt": "2020-11-04T04:14:22Z", "commit": {"oid": "2d7acebf5da8c73d72caedebf6dfb94d36cb4534"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwNDoxNDoyMlrOHtIjhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwNDoxNDoyMlrOHtIjhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA4ODEzMw==", "bodyText": "I didn't want to make these static, but because two of the actions no longer extend BaseSparkActions they cannot access these methods anymore. I think in the future we should try our best to keep from having Actions implementing  \"BaseAction\" if we can help it so that the implementations of frame work specific code can use their shared methods.", "url": "https://github.com/apache/iceberg/pull/1715#discussion_r517088133", "createdAt": "2020-11-04T04:14:22Z", "author": {"login": "RussellSpitzer"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseSparkAction.java", "diffHunk": "@@ -86,6 +125,33 @@\n     return manifestDF.union(otherMetadataFileDF).union(manifestListDF);\n   }\n \n+  protected static Dataset<Row> loadMetadataTable(SparkSession spark, String tableName, String tableLocation,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d7acebf5da8c73d72caedebf6dfb94d36cb4534"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a788d9c002bf56d32e91e8a2ba6fad713eba45b", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/7a788d9c002bf56d32e91e8a2ba6fad713eba45b", "committedDate": "2020-11-04T04:50:58Z", "message": "Fix Actions to be Compatible with V2 Catalogs\n\nPreviously the Action code would use the table name when attempting to look\nup MetadataTable names. This is an issue in Spark3 with V2 catalogs because\nwe strip off the catalog information if the catalog is named \"hadoop\" or \"hive\"\nand include it in all other cases. When we include the catalog name this breaks\nthe lookup code which uses the DataSourceRegistry pathway and not the V2 Table\npathway. To fix this we introduce a method for using the V2 pathway when a catalog\nname is present."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d7acebf5da8c73d72caedebf6dfb94d36cb4534", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/2d7acebf5da8c73d72caedebf6dfb94d36cb4534", "committedDate": "2020-11-04T03:29:09Z", "message": "Fix Actions to be Compatible with V2 Catalogs\n\nPreviously the Action code would use the table name when attempting to look\nup MetadataTable names. This is an issue in Spark3 with V2 catalogs because\nwe strip off the catalog information if the catalog is named \"hadoop\" or \"hive\"\nand include it in all other cases. When we include the catalog name this breaks\nthe lookup code which uses the DataSourceRegistry pathway and not the V2 Table\npathway. To fix this we introduce a method for using the V2 pathway when a catalog\nname is present."}, "afterCommit": {"oid": "7a788d9c002bf56d32e91e8a2ba6fad713eba45b", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/7a788d9c002bf56d32e91e8a2ba6fad713eba45b", "committedDate": "2020-11-04T04:50:58Z", "message": "Fix Actions to be Compatible with V2 Catalogs\n\nPreviously the Action code would use the table name when attempting to look\nup MetadataTable names. This is an issue in Spark3 with V2 catalogs because\nwe strip off the catalog information if the catalog is named \"hadoop\" or \"hive\"\nand include it in all other cases. When we include the catalog name this breaks\nthe lookup code which uses the DataSourceRegistry pathway and not the V2 Table\npathway. To fix this we introduce a method for using the V2 pathway when a catalog\nname is present."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7594cc7d9bde91ccb2795b300960a927c648f83f", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/7594cc7d9bde91ccb2795b300960a927c648f83f", "committedDate": "2020-11-17T22:03:52Z", "message": "Fix Hadoop/Hive Catalog Naming Issue\n\nPreviously there was a conflict between manually non-Spark-catalogs\nand Spark Catalogs in the metadata table name resoultion code. Because\nof this ambiguity we will attempt to load all tables as if their catalog\nis a named SparkCatalog, if this fails we will fall back to the old\npath of removing the \"hadoop\" or \"hive\" catalog names and resolving."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODk5NjA1", "url": "https://github.com/apache/iceberg/pull/1715#pullrequestreview-532899605", "createdAt": "2020-11-17T23:33:13Z", "commit": {"oid": "7594cc7d9bde91ccb2795b300960a927c648f83f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzozMzoxM1rOH1PzYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzozMzoxM1rOH1PzYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5NTQ4OA==", "bodyText": "nit: It may not necessarily be a metadata location. It can be a valid Hadoop table location too.", "url": "https://github.com/apache/iceberg/pull/1715#discussion_r525595488", "createdAt": "2020-11-17T23:33:13Z", "author": {"login": "aokolnychyi"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseSparkAction.java", "diffHunk": "@@ -86,6 +126,32 @@\n     return manifestDF.union(otherMetadataFileDF).union(manifestListDF);\n   }\n \n+  protected static Dataset<Row> loadMetadataTable(SparkSession spark, String tableName, String tableLocation,\n+                                                  MetadataTableType type) {\n+    DataFrameReader noCatalogReader = spark.read().format(\"iceberg\");\n+    if (tableName.contains(\"/\")) {\n+      // Metadata location passed, load without a catalog", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7594cc7d9bde91ccb2795b300960a927c648f83f"}, "originalPosition": 94}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTAwOTAx", "url": "https://github.com/apache/iceberg/pull/1715#pullrequestreview-532900901", "createdAt": "2020-11-17T23:36:11Z", "commit": {"oid": "7594cc7d9bde91ccb2795b300960a927c648f83f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzozNjoxMVrOH1P3mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzozNjoxMVrOH1P3mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5NjU2OQ==", "bodyText": "nit: do we think this else helps clarity? We have a return statement anyway. Without this else, we could reduce the indentation of the block below.", "url": "https://github.com/apache/iceberg/pull/1715#discussion_r525596569", "createdAt": "2020-11-17T23:36:11Z", "author": {"login": "aokolnychyi"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseSparkAction.java", "diffHunk": "@@ -86,6 +126,32 @@\n     return manifestDF.union(otherMetadataFileDF).union(manifestListDF);\n   }\n \n+  protected static Dataset<Row> loadMetadataTable(SparkSession spark, String tableName, String tableLocation,\n+                                                  MetadataTableType type) {\n+    DataFrameReader noCatalogReader = spark.read().format(\"iceberg\");\n+    if (tableName.contains(\"/\")) {\n+      // Metadata location passed, load without a catalog\n+      return noCatalogReader.load(tableName + \"#\" + type);\n+    } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7594cc7d9bde91ccb2795b300960a927c648f83f"}, "originalPosition": 96}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTAzNTY0", "url": "https://github.com/apache/iceberg/pull/1715#pullrequestreview-532903564", "createdAt": "2020-11-17T23:42:23Z", "commit": {"oid": "7594cc7d9bde91ccb2795b300960a927c648f83f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzo0MjoyM1rOH1QAUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzo0MjoyM1rOH1QAUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5ODgwMw==", "bodyText": "If we do a static import for ALL_MANIFESTS, will it fit on one line?", "url": "https://github.com/apache/iceberg/pull/1715#discussion_r525598803", "createdAt": "2020-11-17T23:42:23Z", "author": {"login": "aokolnychyi"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseSparkAction.java", "diffHunk": "@@ -47,9 +87,9 @@\n   protected Dataset<Row> buildValidDataFileDF(SparkSession spark, String tableName) {\n     JavaSparkContext context = new JavaSparkContext(spark.sparkContext());\n     Broadcast<FileIO> ioBroadcast = context.broadcast(SparkUtil.serializableFileIO(table()));\n-    String allManifestsMetadataTable = metadataTableName(tableName, MetadataTableType.ALL_MANIFESTS);\n \n-    Dataset<ManifestFileBean> allManifests = spark.read().format(\"iceberg\").load(allManifestsMetadataTable)\n+    Dataset<ManifestFileBean> allManifests = loadMetadataTable(spark, tableName, table().location(),\n+        MetadataTableType.ALL_MANIFESTS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7594cc7d9bde91ccb2795b300960a927c648f83f"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTA0MzE3", "url": "https://github.com/apache/iceberg/pull/1715#pullrequestreview-532904317", "createdAt": "2020-11-17T23:44:04Z", "commit": {"oid": "7594cc7d9bde91ccb2795b300960a927c648f83f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzo0NDowNFrOH1QCpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzo0NDowNFrOH1QCpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5OTM5Nw==", "bodyText": "Same here. Any way to fit on one line?", "url": "https://github.com/apache/iceberg/pull/1715#discussion_r525599397", "createdAt": "2020-11-17T23:44:04Z", "author": {"login": "aokolnychyi"}, "path": "spark/src/main/java/org/apache/iceberg/actions/RewriteManifestsAction.java", "diffHunk": "@@ -202,9 +202,8 @@ public RewriteManifestsActionResult execute() {\n         .createDataset(Lists.transform(manifests, ManifestFile::path), Encoders.STRING())\n         .toDF(\"manifest\");\n \n-    String entriesMetadataTable = metadataTableName(MetadataTableType.ENTRIES);\n-    Dataset<Row> manifestEntryDF = spark.read().format(\"iceberg\")\n-        .load(entriesMetadataTable)\n+    Dataset<Row> manifestEntryDF = BaseSparkAction.loadMetadataTable(spark, table.name(), table().location(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7594cc7d9bde91ccb2795b300960a927c648f83f"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTI5MzQw", "url": "https://github.com/apache/iceberg/pull/1715#pullrequestreview-532929340", "createdAt": "2020-11-18T00:46:05Z", "commit": {"oid": "7594cc7d9bde91ccb2795b300960a927c648f83f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMDo0NjowNVrOH1RX2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMDo0NjowNVrOH1RX2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYyMTIxMQ==", "bodyText": "Can this be a more specific exception? Seems dangerous to catch 'em all.", "url": "https://github.com/apache/iceberg/pull/1715#discussion_r525621211", "createdAt": "2020-11-18T00:46:05Z", "author": {"login": "rdblue"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseSparkAction.java", "diffHunk": "@@ -86,6 +126,32 @@\n     return manifestDF.union(otherMetadataFileDF).union(manifestListDF);\n   }\n \n+  protected static Dataset<Row> loadMetadataTable(SparkSession spark, String tableName, String tableLocation,\n+                                                  MetadataTableType type) {\n+    DataFrameReader noCatalogReader = spark.read().format(\"iceberg\");\n+    if (tableName.contains(\"/\")) {\n+      // Metadata location passed, load without a catalog\n+      return noCatalogReader.load(tableName + \"#\" + type);\n+    } else {\n+      // Try catalog based name based resolution\n+      try {\n+        return spark.table(tableName + \".\" + type);\n+      } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7594cc7d9bde91ccb2795b300960a927c648f83f"}, "originalPosition": 100}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTMxMjA3", "url": "https://github.com/apache/iceberg/pull/1715#pullrequestreview-532931207", "createdAt": "2020-11-18T00:51:02Z", "commit": {"oid": "7594cc7d9bde91ccb2795b300960a927c648f83f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMDo1MTowM1rOH1Rejg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMDo1MTowM1rOH1Rejg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYyMjkyNg==", "bodyText": "This logic is just for Spark 2.x right? If so then maybe we can add a comment explaining it and noting when we can remove it.", "url": "https://github.com/apache/iceberg/pull/1715#discussion_r525622926", "createdAt": "2020-11-18T00:51:03Z", "author": {"login": "rdblue"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseSparkAction.java", "diffHunk": "@@ -86,6 +126,32 @@\n     return manifestDF.union(otherMetadataFileDF).union(manifestListDF);\n   }\n \n+  protected static Dataset<Row> loadMetadataTable(SparkSession spark, String tableName, String tableLocation,\n+                                                  MetadataTableType type) {\n+    DataFrameReader noCatalogReader = spark.read().format(\"iceberg\");\n+    if (tableName.contains(\"/\")) {\n+      // Metadata location passed, load without a catalog\n+      return noCatalogReader.load(tableName + \"#\" + type);\n+    } else {\n+      // Try catalog based name based resolution\n+      try {\n+        return spark.table(tableName + \".\" + type);\n+      } catch (Exception e) {\n+        // Catalog based resolution failed, our catalog may be a non-DatasourceV2 Catalog\n+        if (tableName.startsWith(\"hadoop.\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7594cc7d9bde91ccb2795b300960a927c648f83f"}, "originalPosition": 102}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e989b78a3f284415de9cacf8b95bb7e8da248e7", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/1e989b78a3f284415de9cacf8b95bb7e8da248e7", "committedDate": "2020-11-18T16:41:12Z", "message": "Minor changes based on reviewer comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNzE1Njc2", "url": "https://github.com/apache/iceberg/pull/1715#pullrequestreview-533715676", "createdAt": "2020-11-18T17:42:07Z", "commit": {"oid": "1e989b78a3f284415de9cacf8b95bb7e8da248e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNzo0MjowOFrOH16cLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNzo0MjowOFrOH16cLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI5NDA2MA==", "bodyText": "I think it should be fine to add it to our exceptions in checkstyle.xml. I thought it was already there.", "url": "https://github.com/apache/iceberg/pull/1715#discussion_r526294060", "createdAt": "2020-11-18T17:42:08Z", "author": {"login": "aokolnychyi"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseSparkAction.java", "diffHunk": "@@ -24,21 +24,67 @@\n import org.apache.iceberg.BaseTable;\n import org.apache.iceberg.ManifestFiles;\n import org.apache.iceberg.MetadataTableType;\n+import org.apache.iceberg.Snapshot;\n import org.apache.iceberg.StaticTableOperations;\n import org.apache.iceberg.Table;\n+import org.apache.iceberg.TableMetadata;\n import org.apache.iceberg.TableOperations;\n import org.apache.iceberg.io.ClosingIterator;\n import org.apache.iceberg.io.FileIO;\n+import org.apache.iceberg.relocated.com.google.common.collect.Lists;\n import org.apache.iceberg.spark.SparkUtil;\n import org.apache.spark.api.java.JavaSparkContext;\n import org.apache.spark.api.java.function.FlatMapFunction;\n import org.apache.spark.broadcast.Broadcast;\n+import org.apache.spark.sql.AnalysisException;\n+import org.apache.spark.sql.DataFrameReader;\n import org.apache.spark.sql.Dataset;\n import org.apache.spark.sql.Encoders;\n import org.apache.spark.sql.Row;\n import org.apache.spark.sql.SparkSession;\n+import org.apache.spark.sql.catalyst.parser.ParseException;\n+\n+// CHECKSTYLE:OFF\n+import static org.apache.iceberg.MetadataTableType.ALL_MANIFESTS;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e989b78a3f284415de9cacf8b95bb7e8da248e7"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNzE2NjA3", "url": "https://github.com/apache/iceberg/pull/1715#pullrequestreview-533716607", "createdAt": "2020-11-18T17:43:11Z", "commit": {"oid": "1e989b78a3f284415de9cacf8b95bb7e8da248e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNzo0MzoxMVrOH16e2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNzo0MzoxMVrOH16e2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI5NDc0NQ==", "bodyText": "same here", "url": "https://github.com/apache/iceberg/pull/1715#discussion_r526294745", "createdAt": "2020-11-18T17:43:11Z", "author": {"login": "aokolnychyi"}, "path": "spark/src/main/java/org/apache/iceberg/actions/RewriteManifestsAction.java", "diffHunk": "@@ -67,6 +66,10 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+// CHECKSTYLE:OFF\n+import static org.apache.iceberg.MetadataTableType.ENTRIES;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e989b78a3f284415de9cacf8b95bb7e8da248e7"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff4f8fb8e8d3cbfd7406e650f1b0a1ea4253e269", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/ff4f8fb8e8d3cbfd7406e650f1b0a1ea4253e269", "committedDate": "2020-11-18T18:05:59Z", "message": "Sort StaticImport Exclusions and Add MetadataTableType.*"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNzg5OTc2", "url": "https://github.com/apache/iceberg/pull/1715#pullrequestreview-533789976", "createdAt": "2020-11-18T19:11:59Z", "commit": {"oid": "ff4f8fb8e8d3cbfd7406e650f1b0a1ea4253e269"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3672, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}