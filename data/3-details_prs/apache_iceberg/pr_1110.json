{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzNDE5Mzg0", "number": 1110, "title": "Add a tolerance check of 1 minute to prevent small clock skews to break commits", "bodyText": "Fixes #1109", "createdAt": "2020-06-12T01:50:15Z", "url": "https://github.com/apache/iceberg/pull/1110", "merged": true, "mergeCommit": {"oid": "90d0a0e59fc146534b115f56dfe8d6d63156a198"}, "closed": true, "closedAt": "2020-06-15T22:33:11Z", "author": {"login": "rdsr"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqY142gH2gAyNDMzNDE5Mzg0OjM4N2MyNDllMzRkOTJkYWFkZDhmNTFmZDQxYzRlZjM5ZTkyZGZmYTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrocghAFqTQzMTAzNzgzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "387c249e34d92daadd8f51fd41c4ef39e92dffa8", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/387c249e34d92daadd8f51fd41c4ef39e92dffa8", "committedDate": "2020-06-12T01:47:29Z", "message": "Add a tolerance check of 1 minute to prevent small clock skews to break commits\n\nFixes 1109\n\nsquash! 1109 Add a tolerance check of 1 minute to prevent small clock skews to break commits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5OTY4NjY5", "url": "https://github.com/apache/iceberg/pull/1110#pullrequestreview-429968669", "createdAt": "2020-06-12T18:52:43Z", "commit": {"oid": "387c249e34d92daadd8f51fd41c4ef39e92dffa8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODo1Mjo0M1rOGjOddw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODo1Mjo0M1rOGjOddw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU5MDI2Mw==", "bodyText": "We use the one from the new snapshot so that the timestamps all match. Do you think we should change that?", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r439590263", "createdAt": "2020-06-12T18:52:43Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -431,7 +446,10 @@ public TableMetadata addStagedSnapshot(Snapshot snapshot) {\n         .build();\n \n     return new TableMetadata(null, formatVersion, uuid, location,\n-        snapshot.sequenceNumber(), snapshot.timestampMillis(), lastColumnId, schema, defaultSpecId, specs, properties,\n+        snapshot.sequenceNumber(),\n+        //TODO: should this be System.currentTimeMillis()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "387c249e34d92daadd8f51fd41c4ef39e92dffa8"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5OTg4NTg1", "url": "https://github.com/apache/iceberg/pull/1110#pullrequestreview-429988585", "createdAt": "2020-06-12T19:28:47Z", "commit": {"oid": "387c249e34d92daadd8f51fd41c4ef39e92dffa8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxOToyODo0N1rOGjPX1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxOToyODo0N1rOGjPX1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYwNTIwNA==", "bodyText": "@rdblue . Thoughts on this?", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r439605204", "createdAt": "2020-06-12T19:28:47Z", "author": {"login": "rdsr"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -257,14 +260,26 @@ public String toString() {\n     }\n \n     MetadataLogEntry previous = null;\n+    // TODO: this check seems redundant if we are checking lastUpdatedMillis below", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "387c249e34d92daadd8f51fd41c4ef39e92dffa8"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1519a7adbac3ed7ab62e20a3c130526677f83cfd", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/1519a7adbac3ed7ab62e20a3c130526677f83cfd", "committedDate": "2020-06-13T00:17:25Z", "message": "Add skew handling logic for snapshotlog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMTAxMDY4", "url": "https://github.com/apache/iceberg/pull/1110#pullrequestreview-430101068", "createdAt": "2020-06-13T01:16:44Z", "commit": {"oid": "1519a7adbac3ed7ab62e20a3c130526677f83cfd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QwMToxNjo0NFrOGjU4xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QwMToxNjo0NFrOGjU4xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY5NTU1OQ==", "bodyText": "I try to avoid variable names in log messages. Plain language is easier for users and tends to be more descriptive. How about \"Invalid update timestamp %s: before last snapshot log entry at %s\"?", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r439695559", "createdAt": "2020-06-13T01:16:44Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -253,14 +253,21 @@ public String toString() {\n     for (HistoryEntry logEntry : snapshotLog) {\n       if (last != null) {\n         Preconditions.checkArgument(\n-            (logEntry.timestampMillis() - last.timestampMillis()) >= 0,\n+            (logEntry.timestampMillis() - last.timestampMillis()) >= -ONE_MINUTE,\n             \"[BUG] Expected sorted snapshot log entries.\");\n       }\n       last = logEntry;\n     }\n+    if (last != null) {\n+      Preconditions.checkArgument(\n+          // commits can happen concurrently from different machines.\n+          // A tolerance helps us avoid failure for small clock skew\n+          lastUpdatedMillis - last.timestampMillis() >= -ONE_MINUTE,\n+          \"lastUpdatedMillis: %s should not be < than the latest snapshot log entry timestamp %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1519a7adbac3ed7ab62e20a3c130526677f83cfd"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMTAxMTYy", "url": "https://github.com/apache/iceberg/pull/1110#pullrequestreview-430101162", "createdAt": "2020-06-13T01:17:51Z", "commit": {"oid": "1519a7adbac3ed7ab62e20a3c130526677f83cfd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QwMToxNzo1MVrOGjU5LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QwMToxNzo1MVrOGjU5LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY5NTY2MQ==", "bodyText": "Rather than wrapping a precondition in an if, it's shorter to add an or:\nPreconditions.checkArgument(last == null || lastUpdatedMillis - last.timestampMillis() >= -ONE_MINUTE, ...);", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r439695661", "createdAt": "2020-06-13T01:17:51Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -253,14 +253,21 @@ public String toString() {\n     for (HistoryEntry logEntry : snapshotLog) {\n       if (last != null) {\n         Preconditions.checkArgument(\n-            (logEntry.timestampMillis() - last.timestampMillis()) >= 0,\n+            (logEntry.timestampMillis() - last.timestampMillis()) >= -ONE_MINUTE,\n             \"[BUG] Expected sorted snapshot log entries.\");\n       }\n       last = logEntry;\n     }\n+    if (last != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1519a7adbac3ed7ab62e20a3c130526677f83cfd"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16bc39320f812d4563e677177412502b8ab1c47c", "author": {"user": {"login": "rdsr", "name": "Ratandeep Ratti"}}, "url": "https://github.com/apache/iceberg/commit/16bc39320f812d4563e677177412502b8ab1c47c", "committedDate": "2020-06-15T14:52:36Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMDM3ODM0", "url": "https://github.com/apache/iceberg/pull/1110#pullrequestreview-431037834", "createdAt": "2020-06-15T22:32:10Z", "commit": {"oid": "16bc39320f812d4563e677177412502b8ab1c47c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMjozMjoxMFrOGkE9EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMjozMjoxMFrOGkE9EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4MzA4OQ==", "bodyText": "Nit: indentation is off.", "url": "https://github.com/apache/iceberg/pull/1110#discussion_r440483089", "createdAt": "2020-06-15T22:32:10Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -250,21 +253,40 @@ public String toString() {\n     for (HistoryEntry logEntry : snapshotLog) {\n       if (last != null) {\n         Preconditions.checkArgument(\n-            (logEntry.timestampMillis() - last.timestampMillis()) >= 0,\n+            (logEntry.timestampMillis() - last.timestampMillis()) >= -ONE_MINUTE,\n             \"[BUG] Expected sorted snapshot log entries.\");\n       }\n       last = logEntry;\n     }\n+    if (last != null) {\n+      Preconditions.checkArgument(\n+          // commits can happen concurrently from different machines.\n+          // A tolerance helps us avoid failure for small clock skew\n+          lastUpdatedMillis - last.timestampMillis() >= -ONE_MINUTE,\n+          \"Invalid update timestamp %s: before last snapshot log entry at %s\",\n+          lastUpdatedMillis, last.timestampMillis());\n+    }\n \n     MetadataLogEntry previous = null;\n     for (MetadataLogEntry metadataEntry : previousFiles) {\n       if (previous != null) {\n         Preconditions.checkArgument(\n-            (metadataEntry.timestampMillis() - previous.timestampMillis()) >= 0,\n+            // commits can happen concurrently from different machines.\n+            // A tolerance helps us avoid failure for small clock skew\n+            (metadataEntry.timestampMillis() - previous.timestampMillis()) >= -ONE_MINUTE,\n             \"[BUG] Expected sorted previous metadata log entries.\");\n       }\n       previous = metadataEntry;\n     }\n+      // Make sure that this update's lastUpdatedMillis is > max(previousFile's timestamp)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16bc39320f812d4563e677177412502b8ab1c47c"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4520, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}