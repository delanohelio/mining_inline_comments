{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3NTEzMTcx", "number": 1336, "title": "Fix schema name conflicts", "bodyText": "Iceberg indexes schemas by name to look up fields, but uses short names by omitting \"element\" and \"value\" names when a list or map has a struct element or value. For example, a list, locations, of structs struct<lat: double, long: double> will use names locations.lat instead of locations.element.lat.\nThis works most of the time, but can lead to conflicts when a map value contains a field name key. In that case, the schema is rejected with a failure message like this: ValidationException: Invalid schema: multiple fields for name some_map.key: 146 and 144\nIn addition, Spark passes names through alterTable that include the value and element names that are omitted.\nThis PR fixes the problem by keeping track of two names, the full name with element and value, and secondary \"short\" names that omit them. Indexing now uses all of the full names and adds any short names that are not ambiguous.\nThis change also requires indexing IDs separately rather than using a BiMap because IDs can have multiple names, which is not valid when inverting the BiMap.", "createdAt": "2020-08-13T16:49:53Z", "url": "https://github.com/apache/iceberg/pull/1336", "merged": true, "mergeCommit": {"oid": "d98224a82b104888281d4e901ccf948f9642590b"}, "closed": true, "closedAt": "2020-09-02T22:57:19Z", "author": {"login": "rdblue"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-s29BAFqTQ2NzI5ODk4OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFDfz1gFqTQ4MTMzNjI1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3Mjk4OTg5", "url": "https://github.com/apache/iceberg/pull/1336#pullrequestreview-467298989", "createdAt": "2020-08-14T04:25:13Z", "commit": {"oid": "fb01c5557736616a275e099688040fed4c84bcc8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNDoyNToxNFrOHAnG7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNDoyNToxNFrOHAnG7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQwMjc5Nw==", "bodyText": "unfinished comment?", "url": "https://github.com/apache/iceberg/pull/1336#discussion_r470402797", "createdAt": "2020-08-14T04:25:14Z", "author": {"login": "RussellSpitzer"}, "path": "api/src/main/java/org/apache/iceberg/types/IndexByName.java", "diffHunk": "@@ -128,9 +157,15 @@ private void addField(String name, int fieldId) {\n     }\n \n     Integer existingFieldId = nameToId.put(fullName, fieldId);\n-    if (existingFieldId != null && !\"element\".equals(name) && !\"value\".equals(name)) {\n-      throw new ValidationException(\n-          \"Invalid schema: multiple fields for name %s: %s and %s\", fullName, existingFieldId, fieldId);\n+    ValidationException.check(existingFieldId == null,\n+        \"Invalid schema: multiple fields for name %s: %s and %s\", fullName, existingFieldId, fieldId);\n+\n+    // if the short name is not", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb01c5557736616a275e099688040fed4c84bcc8"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MzAxMjE3", "url": "https://github.com/apache/iceberg/pull/1336#pullrequestreview-467301217", "createdAt": "2020-08-14T04:34:21Z", "commit": {"oid": "fb01c5557736616a275e099688040fed4c84bcc8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNDozNDoyMVrOHAnPIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNDozNDoyMVrOHAnPIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQwNDg5OQ==", "bodyText": "I think it would be helpful to have a little comment here explaining the mapping of both Long and Short Names in the returned map but mostly because I don't understand the short names yet. They may be more obvious to a more experienced reader of this code.", "url": "https://github.com/apache/iceberg/pull/1336#discussion_r470404899", "createdAt": "2020-08-14T04:34:21Z", "author": {"login": "RussellSpitzer"}, "path": "api/src/main/java/org/apache/iceberg/types/IndexByName.java", "diffHunk": "@@ -25,39 +25,64 @@\n import org.apache.iceberg.Schema;\n import org.apache.iceberg.exceptions.ValidationException;\n import org.apache.iceberg.relocated.com.google.common.base.Joiner;\n+import org.apache.iceberg.relocated.com.google.common.collect.ImmutableMap;\n import org.apache.iceberg.relocated.com.google.common.collect.Lists;\n import org.apache.iceberg.relocated.com.google.common.collect.Maps;\n \n public class IndexByName extends TypeUtil.SchemaVisitor<Map<String, Integer>> {\n   private static final Joiner DOT = Joiner.on(\".\");\n \n   private final Deque<String> fieldNames = Lists.newLinkedList();\n+  private final Deque<String> shortFieldNames = Lists.newLinkedList();\n   private final Map<String, Integer> nameToId = Maps.newHashMap();\n+  private final Map<String, Integer> shortNameToId = Maps.newHashMap();\n+\n+  public Map<String, Integer> byName() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb01c5557736616a275e099688040fed4c84bcc8"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MzAxMzQ2", "url": "https://github.com/apache/iceberg/pull/1336#pullrequestreview-467301346", "createdAt": "2020-08-14T04:34:53Z", "commit": {"oid": "fb01c5557736616a275e099688040fed4c84bcc8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNDozNDo1M1rOHAnPmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNDozNDo1M1rOHAnPmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQwNTAxNg==", "bodyText": "I think here it may also be good to note this isn't a bijection anymore and short names will not be returned by this function, only long names.", "url": "https://github.com/apache/iceberg/pull/1336#discussion_r470405016", "createdAt": "2020-08-14T04:34:53Z", "author": {"login": "RussellSpitzer"}, "path": "api/src/main/java/org/apache/iceberg/types/IndexByName.java", "diffHunk": "@@ -25,39 +25,64 @@\n import org.apache.iceberg.Schema;\n import org.apache.iceberg.exceptions.ValidationException;\n import org.apache.iceberg.relocated.com.google.common.base.Joiner;\n+import org.apache.iceberg.relocated.com.google.common.collect.ImmutableMap;\n import org.apache.iceberg.relocated.com.google.common.collect.Lists;\n import org.apache.iceberg.relocated.com.google.common.collect.Maps;\n \n public class IndexByName extends TypeUtil.SchemaVisitor<Map<String, Integer>> {\n   private static final Joiner DOT = Joiner.on(\".\");\n \n   private final Deque<String> fieldNames = Lists.newLinkedList();\n+  private final Deque<String> shortFieldNames = Lists.newLinkedList();\n   private final Map<String, Integer> nameToId = Maps.newHashMap();\n+  private final Map<String, Integer> shortNameToId = Maps.newHashMap();\n+\n+  public Map<String, Integer> byName() {\n+    ImmutableMap.Builder<String, Integer> builder = ImmutableMap.builder();\n+    builder.putAll(nameToId);\n+    // add all short names that do not conflict with canonical names\n+    shortNameToId.entrySet().stream()\n+        .filter(entry -> !nameToId.containsKey(entry.getKey()))\n+        .forEach(builder::put);\n+    return builder.build();\n+  }\n+\n+  public Map<Integer, String> byId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb01c5557736616a275e099688040fed4c84bcc8"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bec6afe9f2234781c6d5ec8512e901aa4162e9d0", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/bec6afe9f2234781c6d5ec8512e901aa4162e9d0", "committedDate": "2020-08-21T20:11:12Z", "message": "Fix schema name conflicts."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "feaad204a9d4d451582c3634ce0d819b730dc463", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/feaad204a9d4d451582c3634ce0d819b730dc463", "committedDate": "2020-08-21T20:25:41Z", "message": "Add more docs and comments for review."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb01c5557736616a275e099688040fed4c84bcc8", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/fb01c5557736616a275e099688040fed4c84bcc8", "committedDate": "2020-08-13T16:39:30Z", "message": "Fix schema name conflicts."}, "afterCommit": {"oid": "feaad204a9d4d451582c3634ce0d819b730dc463", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/feaad204a9d4d451582c3634ce0d819b730dc463", "committedDate": "2020-08-21T20:25:41Z", "message": "Add more docs and comments for review."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMTY2Mzkx", "url": "https://github.com/apache/iceberg/pull/1336#pullrequestreview-481166391", "createdAt": "2020-09-02T18:41:36Z", "commit": {"oid": "feaad204a9d4d451582c3634ce0d819b730dc463"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxODo0MTozNlrOHL86zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxODo0MTozNlrOHL86zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI5NDQ3Nw==", "bodyText": "a list, 'l', with of structs... or just a list, 'l', of structs ...?", "url": "https://github.com/apache/iceberg/pull/1336#discussion_r482294477", "createdAt": "2020-09-02T18:41:36Z", "author": {"login": "fbocse"}, "path": "api/src/main/java/org/apache/iceberg/types/IndexByName.java", "diffHunk": "@@ -25,39 +25,79 @@\n import org.apache.iceberg.Schema;\n import org.apache.iceberg.exceptions.ValidationException;\n import org.apache.iceberg.relocated.com.google.common.base.Joiner;\n+import org.apache.iceberg.relocated.com.google.common.collect.ImmutableMap;\n import org.apache.iceberg.relocated.com.google.common.collect.Lists;\n import org.apache.iceberg.relocated.com.google.common.collect.Maps;\n \n public class IndexByName extends TypeUtil.SchemaVisitor<Map<String, Integer>> {\n   private static final Joiner DOT = Joiner.on(\".\");\n \n   private final Deque<String> fieldNames = Lists.newLinkedList();\n+  private final Deque<String> shortFieldNames = Lists.newLinkedList();\n   private final Map<String, Integer> nameToId = Maps.newHashMap();\n+  private final Map<String, Integer> shortNameToId = Maps.newHashMap();\n+\n+  /**\n+   * Returns a mapping from full field name to ID.\n+   * <p>\n+   * Short names for maps and lists are included for any name that does not conflict with a canonical name. For example,\n+   * a list, 'l', with of structs with field 'x' will produce short name 'l.x' in addition to 'l.element.x'.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "feaad204a9d4d451582c3634ce0d819b730dc463"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "304358a630ddc9e9336e0e350e11ad6e8c19190c", "author": {"user": {"login": "rdblue", "name": "Ryan Blue"}}, "url": "https://github.com/apache/iceberg/commit/304358a630ddc9e9336e0e350e11ad6e8c19190c", "committedDate": "2020-09-02T22:06:51Z", "message": "Fixup Javadoc."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMzM2MjUw", "url": "https://github.com/apache/iceberg/pull/1336#pullrequestreview-481336250", "createdAt": "2020-09-02T22:11:19Z", "commit": {"oid": "304358a630ddc9e9336e0e350e11ad6e8c19190c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4038, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}