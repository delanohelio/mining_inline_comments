{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0MjAxNjgy", "number": 931, "title": "Add residual evaluation for MR reader", "bodyText": "This is for #866.", "createdAt": "2020-04-16T08:34:49Z", "url": "https://github.com/apache/iceberg/pull/931", "merged": true, "mergeCommit": {"oid": "af25cbedac34c09633a66a2c73d68f3f4822d64a"}, "closed": true, "closedAt": "2020-04-20T18:33:05Z", "author": {"login": "chenjunjiedada"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYIfI3gH2gAyNDA0MjAxNjgyOjM0ODU1ZWNjMmFiMGMxZTcxN2E2YmRkNTgwNmY5MzQ4Y2VjNzJkZDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYr-HpAFqTM5NTg3MDEyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "34855ecc2ab0c1e717a6bdd5806f9348cec72dd5", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/34855ecc2ab0c1e717a6bdd5806f9348cec72dd5", "committedDate": "2020-04-16T08:33:31Z", "message": "Add residual evaluation for MR reader"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NzczMDk5", "url": "https://github.com/apache/iceberg/pull/931#pullrequestreview-394773099", "createdAt": "2020-04-16T15:53:48Z", "commit": {"oid": "34855ecc2ab0c1e717a6bdd5806f9348cec72dd5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTo1Mzo0OVrOGGsDxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTo1Mzo0OVrOGGsDxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY2NjUwMg==", "bodyText": "Can you assign the result of currentTask.residual() to a local variable to reduce method call?", "url": "https://github.com/apache/iceberg/pull/931#discussion_r409666502", "createdAt": "2020-04-16T15:53:49Z", "author": {"login": "leoluan2009"}, "path": "mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java", "diffHunk": "@@ -394,8 +378,14 @@ public void close() throws IOException {\n               String.format(\"Cannot read %s file: %s\", file.format().name(), file.path()));\n       }\n       currentCloseable = iterable;\n-      //TODO: Apply residual filtering before returning the iterator\n-      return iterable.iterator();\n+      boolean applyResidualFiltering = !context.getConfiguration().getBoolean(SKIP_RESIDUAL_FILTERING, false);\n+      if (applyResidualFiltering && currentTask.residual() != null &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34855ecc2ab0c1e717a6bdd5806f9348cec72dd5"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0ODczNDAz", "url": "https://github.com/apache/iceberg/pull/931#pullrequestreview-394873403", "createdAt": "2020-04-16T17:59:46Z", "commit": {"oid": "34855ecc2ab0c1e717a6bdd5806f9348cec72dd5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzo1OTo0NlrOGGw-Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxODowMzo0NlrOGGxHvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc0NzAwMg==", "bodyText": "seems like we should also take into account that ICEBERG_GENERICS is the data model before applying residuals. Should this be done inside each of the method e.g newAvroIterable , newOrcIterable etc where we  dispatch on the data model. I think, the actual application of the residual maybe be a function for Iceberg_generics which can be called from each of the newAvro|Orc|ParquetIterable methods.\nThoughts?", "url": "https://github.com/apache/iceberg/pull/931#discussion_r409747002", "createdAt": "2020-04-16T17:59:46Z", "author": {"login": "rdsr"}, "path": "mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java", "diffHunk": "@@ -394,8 +378,14 @@ public void close() throws IOException {\n               String.format(\"Cannot read %s file: %s\", file.format().name(), file.path()));\n       }\n       currentCloseable = iterable;\n-      //TODO: Apply residual filtering before returning the iterator\n-      return iterable.iterator();\n+      boolean applyResidualFiltering = !context.getConfiguration().getBoolean(SKIP_RESIDUAL_FILTERING, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34855ecc2ab0c1e717a6bdd5806f9348cec72dd5"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc0OTQzOA==", "bodyText": "Seems like we should still do this check for Pig and Hive as we don't have residual evaluators for these. If IcebergInputFormat.ConfigBuilder#skipResidualFiltering is true then this check should be there for Pig and Hive rows", "url": "https://github.com/apache/iceberg/pull/931#discussion_r409749438", "createdAt": "2020-04-16T18:03:46Z", "author": {"login": "rdsr"}, "path": "mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java", "diffHunk": "@@ -259,18 +255,6 @@ public ConfigBuilder skipResidualFiltering() {\n     return splits;\n   }\n \n-  private static void checkResiduals(CombinedScanTask task) {\n-    task.files().forEach(fileScanTask -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34855ecc2ab0c1e717a6bdd5806f9348cec72dd5"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "338773d4f33a6548370dc7a52dc897b028866b3f", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/338773d4f33a6548370dc7a52dc897b028866b3f", "committedDate": "2020-04-17T13:42:07Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd8953d3ff2913de214f76fb1c63e30fdc1b5967", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/bd8953d3ff2913de214f76fb1c63e30fdc1b5967", "committedDate": "2020-04-17T13:49:50Z", "message": "update doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzg0MDMw", "url": "https://github.com/apache/iceberg/pull/931#pullrequestreview-395784030", "createdAt": "2020-04-17T21:29:44Z", "commit": {"oid": "bd8953d3ff2913de214f76fb1c63e30fdc1b5967"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMToyOTo0NFrOGHdqQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMToyOTo0NFrOGHdqQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ3OTE3MA==", "bodyText": "This should not change.", "url": "https://github.com/apache/iceberg/pull/931#discussion_r410479170", "createdAt": "2020-04-17T21:29:44Z", "author": {"login": "rdblue"}, "path": "mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java", "diffHunk": "@@ -124,7 +125,7 @@ public ConfigBuilder(Configuration conf) {\n       this.conf = conf;\n       // defaults\n       conf.setEnum(IN_MEMORY_DATA_MODEL, InMemoryDataModel.GENERIC);\n-      conf.setBoolean(SKIP_RESIDUAL_FILTERING, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd8953d3ff2913de214f76fb1c63e30fdc1b5967"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzg0NTE3", "url": "https://github.com/apache/iceberg/pull/931#pullrequestreview-395784517", "createdAt": "2020-04-17T21:30:49Z", "commit": {"oid": "bd8953d3ff2913de214f76fb1c63e30fdc1b5967"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTozMDo0OVrOGHdr1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTozMDo0OVrOGHdr1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ3OTU3NA==", "bodyText": "-1 until this is reverted.\nThe InputFormat should default to applying residuals because that is what users expect.", "url": "https://github.com/apache/iceberg/pull/931#discussion_r410479574", "createdAt": "2020-04-17T21:30:49Z", "author": {"login": "rdblue"}, "path": "mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java", "diffHunk": "@@ -199,11 +200,10 @@ public ConfigBuilder usePigTuples() {\n     /**\n      * Compute platforms pass down filters to data sources. If the data source cannot apply some filters, or only\n      * partially applies the filter, it will return the residual filter back. If the platform can correctly apply\n-     * the residual filters, then it should call this api. Otherwise the current api will throw an exception if the\n-     * passed in filter is not completely satisfied.\n+     * the residual filters, then it should call this api to enable the residual filtering.\n      */\n-    public ConfigBuilder skipResidualFiltering() {\n-      conf.setBoolean(SKIP_RESIDUAL_FILTERING, true);\n+    public ConfigBuilder enableResidualFiltering() {\n+      conf.setBoolean(SKIP_RESIDUAL_FILTERING, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd8953d3ff2913de214f76fb1c63e30fdc1b5967"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bba77a31ca941c6197e6181c2ff9ef5dc9db420", "author": {"user": {"login": "chenjunjiedada", "name": "Chen, Junjie"}}, "url": "https://github.com/apache/iceberg/commit/7bba77a31ca941c6197e6181c2ff9ef5dc9db420", "committedDate": "2020-04-18T01:34:52Z", "message": "check residual for when using HIVE and PIG data model"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1ODcwMTI0", "url": "https://github.com/apache/iceberg/pull/931#pullrequestreview-395870124", "createdAt": "2020-04-18T01:54:02Z", "commit": {"oid": "7bba77a31ca941c6197e6181c2ff9ef5dc9db420"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwMTo1NDowMlrOGHh85A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwMTo1NDowMlrOGHh85A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDU0OTQ3Ng==", "bodyText": "It causes unclosed input stream issue if we don't close here, looks like mr framework doesn't call the final close method.", "url": "https://github.com/apache/iceberg/pull/931#discussion_r410549476", "createdAt": "2020-04-18T01:54:02Z", "author": {"login": "chenjunjiedada"}, "path": "mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java", "diffHunk": "@@ -316,6 +318,7 @@ public boolean nextKeyValue() throws IOException {\n           currentCloseable.close();\n           currentIterator = open(tasks.next());\n         } else {\n+          currentCloseable.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bba77a31ca941c6197e6181c2ff9ef5dc9db420"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4812, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}