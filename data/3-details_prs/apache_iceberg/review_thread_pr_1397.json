{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0OTQwOTkx", "number": 1397, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMDo1NjoyNFrOEdYo_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjowMDo0N1rOEdZzBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5MjQ3ODcwOnYy", "diffSide": "RIGHT", "path": "spark/src/main/java/org/apache/iceberg/actions/ManifestFileBean.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMDo1NjoyNFrOHIg9ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMDo1NjoyNFrOHIg9ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY5MDc0Ng==", "bodyText": "The Datafile Equivalent of this is named SparkDataFile, although it isn't written as a Bean as uses a \"wrap(Row row)\" method fo applying. I think this naming more sense to me, just wanted to note.", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478690746", "createdAt": "2020-08-27T20:56:24Z", "author": {"login": "RussellSpitzer"}, "path": "spark/src/main/java/org/apache/iceberg/actions/ManifestFileBean.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.actions;\n+\n+import java.util.List;\n+import org.apache.iceberg.ManifestContent;\n+import org.apache.iceberg.ManifestFile;\n+\n+public class ManifestFileBean implements ManifestFile {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5MjQ4NTYzOnYy", "diffSide": "RIGHT", "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMDo1ODoyN1rOHIhB8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMDo1ODoyN1rOHIhB8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY5MTgyNA==", "bodyText": "I forgot about this when I refactored before! Good catch", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478691824", "createdAt": "2020-08-27T20:58:27Z", "author": {"login": "RussellSpitzer"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "diffHunk": "@@ -57,8 +65,8 @@ protected String metadataTableName(String tableName, MetadataTableType type) {\n   }\n \n   /**\n-   * Returns all the path locations of all Manifest Lists for a given table\n-   * @param table the table\n+   * Returns all the path locations of all Manifest Lists for a given list of snapshots\n+   * @param snapshots snapshots", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5MjU2MDQxOnYy", "diffSide": "RIGHT", "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMToyMzoxMVrOHIhv_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjowOTo0MlrOHIi9xA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcwMzYxMg==", "bodyText": "As we discussed a bit, it may make sense to log a warning here for users with \"adaptive query on\" that they will lose the ability to control the parallelism of the manifest read stage with that parameter enabled. I'm a little torn on whether that is too technical a detail or whether it will trip up lots of real users ...", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478703612", "createdAt": "2020-08-27T21:23:11Z", "author": {"login": "RussellSpitzer"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "diffHunk": "@@ -94,9 +102,30 @@ protected String metadataTableName(String tableName, MetadataTableType type) {\n     return buildValidDataFileDF(spark, table().toString());\n   }\n \n+  private static class ReadManifest implements FlatMapFunction<ManifestFileBean, String> {\n+    private final Broadcast<FileIO> io;\n+\n+    ReadManifest(Broadcast<FileIO> io) {\n+      this.io = io;\n+    }\n+\n+    @Override\n+    public Iterator<String> call(ManifestFileBean manifest) {\n+      return new ClosingIterator<>(ManifestFiles.readPaths(manifest, io.getValue()).iterator());\n+    }\n+  }\n+\n   protected Dataset<Row> buildValidDataFileDF(SparkSession spark, String tableName) {\n-    String allDataFilesMetadataTable = metadataTableName(tableName, MetadataTableType.ALL_DATA_FILES);\n-    return spark.read().format(\"iceberg\").load(allDataFilesMetadataTable).select(\"file_path\");\n+    JavaSparkContext context = new JavaSparkContext(spark.sparkContext());\n+    Broadcast<FileIO> ioBroadcast = context.broadcast(SparkUtil.serializableFileIO(table()));\n+    String allManifestsMetadataTable = metadataTableName(tableName, MetadataTableType.ALL_MANIFESTS);\n+\n+    Dataset<ManifestFileBean> allManifests = spark.read().format(\"iceberg\").load(allManifestsMetadataTable)\n+        .selectExpr(\"path\", \"length\", \"partition_spec_id as partitionSpecId\", \"added_snapshot_id as addedSnapshotId\")\n+        .dropDuplicates(\"path\")\n+        .as(Encoders.bean(ManifestFileBean.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyMzUyNA==", "bodyText": "Fixed by adding a repartition.", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478723524", "createdAt": "2020-08-27T22:09:42Z", "author": {"login": "rdblue"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "diffHunk": "@@ -94,9 +102,30 @@ protected String metadataTableName(String tableName, MetadataTableType type) {\n     return buildValidDataFileDF(spark, table().toString());\n   }\n \n+  private static class ReadManifest implements FlatMapFunction<ManifestFileBean, String> {\n+    private final Broadcast<FileIO> io;\n+\n+    ReadManifest(Broadcast<FileIO> io) {\n+      this.io = io;\n+    }\n+\n+    @Override\n+    public Iterator<String> call(ManifestFileBean manifest) {\n+      return new ClosingIterator<>(ManifestFiles.readPaths(manifest, io.getValue()).iterator());\n+    }\n+  }\n+\n   protected Dataset<Row> buildValidDataFileDF(SparkSession spark, String tableName) {\n-    String allDataFilesMetadataTable = metadataTableName(tableName, MetadataTableType.ALL_DATA_FILES);\n-    return spark.read().format(\"iceberg\").load(allDataFilesMetadataTable).select(\"file_path\");\n+    JavaSparkContext context = new JavaSparkContext(spark.sparkContext());\n+    Broadcast<FileIO> ioBroadcast = context.broadcast(SparkUtil.serializableFileIO(table()));\n+    String allManifestsMetadataTable = metadataTableName(tableName, MetadataTableType.ALL_MANIFESTS);\n+\n+    Dataset<ManifestFileBean> allManifests = spark.read().format(\"iceberg\").load(allManifestsMetadataTable)\n+        .selectExpr(\"path\", \"length\", \"partition_spec_id as partitionSpecId\", \"added_snapshot_id as addedSnapshotId\")\n+        .dropDuplicates(\"path\")\n+        .as(Encoders.bean(ManifestFileBean.class));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcwMzYxMg=="}, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5MjU3MDAwOnYy", "diffSide": "RIGHT", "path": "spark/src/main/java/org/apache/iceberg/actions/ManifestFileBean.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMToyNjowOVrOHIh1mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMTozMDo0NFrOHIh9fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcwNTA0OA==", "bodyText": "For these and the other ones like it, should we throw unsupported? Since these values are not actually populated?", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478705048", "createdAt": "2020-08-27T21:26:09Z", "author": {"login": "RussellSpitzer"}, "path": "spark/src/main/java/org/apache/iceberg/actions/ManifestFileBean.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.actions;\n+\n+import java.util.List;\n+import org.apache.iceberg.ManifestContent;\n+import org.apache.iceberg.ManifestFile;\n+\n+public class ManifestFileBean implements ManifestFile {\n+  private String path = null;\n+  private Long length = null;\n+  private Integer partitionSpecId = null;\n+  private Long addedSnapshotId = null;\n+\n+  public String getPath() {\n+    return path;\n+  }\n+\n+  public void setPath(String path) {\n+    this.path = path;\n+  }\n+\n+  public Long getLength() {\n+    return length;\n+  }\n+\n+  public void setLength(Long length) {\n+    this.length = length;\n+  }\n+\n+  public Integer getPartitionSpecId() {\n+    return partitionSpecId;\n+  }\n+\n+  public void setPartitionSpecId(Integer partitionSpecId) {\n+    this.partitionSpecId = partitionSpecId;\n+  }\n+\n+  public Long getAddedSnapshotId() {\n+    return addedSnapshotId;\n+  }\n+\n+  public void setAddedSnapshotId(Long addedSnapshotId) {\n+    this.addedSnapshotId = addedSnapshotId;\n+  }\n+\n+  @Override\n+  public String path() {\n+    return path;\n+  }\n+\n+  @Override\n+  public long length() {\n+    return length;\n+  }\n+\n+  @Override\n+  public int partitionSpecId() {\n+    return partitionSpecId;\n+  }\n+\n+  @Override\n+  public ManifestContent content() {\n+    return ManifestContent.DATA;\n+  }\n+\n+  @Override\n+  public long sequenceNumber() {\n+    return 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcwNjY0MQ==", "bodyText": "This is actually used by the reader to construct inherited metadata. I think we should just make this class package-private since it is only intended to be used by the action.", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478706641", "createdAt": "2020-08-27T21:29:49Z", "author": {"login": "rdblue"}, "path": "spark/src/main/java/org/apache/iceberg/actions/ManifestFileBean.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.actions;\n+\n+import java.util.List;\n+import org.apache.iceberg.ManifestContent;\n+import org.apache.iceberg.ManifestFile;\n+\n+public class ManifestFileBean implements ManifestFile {\n+  private String path = null;\n+  private Long length = null;\n+  private Integer partitionSpecId = null;\n+  private Long addedSnapshotId = null;\n+\n+  public String getPath() {\n+    return path;\n+  }\n+\n+  public void setPath(String path) {\n+    this.path = path;\n+  }\n+\n+  public Long getLength() {\n+    return length;\n+  }\n+\n+  public void setLength(Long length) {\n+    this.length = length;\n+  }\n+\n+  public Integer getPartitionSpecId() {\n+    return partitionSpecId;\n+  }\n+\n+  public void setPartitionSpecId(Integer partitionSpecId) {\n+    this.partitionSpecId = partitionSpecId;\n+  }\n+\n+  public Long getAddedSnapshotId() {\n+    return addedSnapshotId;\n+  }\n+\n+  public void setAddedSnapshotId(Long addedSnapshotId) {\n+    this.addedSnapshotId = addedSnapshotId;\n+  }\n+\n+  @Override\n+  public String path() {\n+    return path;\n+  }\n+\n+  @Override\n+  public long length() {\n+    return length;\n+  }\n+\n+  @Override\n+  public int partitionSpecId() {\n+    return partitionSpecId;\n+  }\n+\n+  @Override\n+  public ManifestContent content() {\n+    return ManifestContent.DATA;\n+  }\n+\n+  @Override\n+  public long sequenceNumber() {\n+    return 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcwNTA0OA=="}, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcwNzA2OA==", "bodyText": "Sorry, I just remembered that it can't be or else Spark can't use it.", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478707068", "createdAt": "2020-08-27T21:30:44Z", "author": {"login": "rdblue"}, "path": "spark/src/main/java/org/apache/iceberg/actions/ManifestFileBean.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.actions;\n+\n+import java.util.List;\n+import org.apache.iceberg.ManifestContent;\n+import org.apache.iceberg.ManifestFile;\n+\n+public class ManifestFileBean implements ManifestFile {\n+  private String path = null;\n+  private Long length = null;\n+  private Integer partitionSpecId = null;\n+  private Long addedSnapshotId = null;\n+\n+  public String getPath() {\n+    return path;\n+  }\n+\n+  public void setPath(String path) {\n+    this.path = path;\n+  }\n+\n+  public Long getLength() {\n+    return length;\n+  }\n+\n+  public void setLength(Long length) {\n+    this.length = length;\n+  }\n+\n+  public Integer getPartitionSpecId() {\n+    return partitionSpecId;\n+  }\n+\n+  public void setPartitionSpecId(Integer partitionSpecId) {\n+    this.partitionSpecId = partitionSpecId;\n+  }\n+\n+  public Long getAddedSnapshotId() {\n+    return addedSnapshotId;\n+  }\n+\n+  public void setAddedSnapshotId(Long addedSnapshotId) {\n+    this.addedSnapshotId = addedSnapshotId;\n+  }\n+\n+  @Override\n+  public String path() {\n+    return path;\n+  }\n+\n+  @Override\n+  public long length() {\n+    return length;\n+  }\n+\n+  @Override\n+  public int partitionSpecId() {\n+    return partitionSpecId;\n+  }\n+\n+  @Override\n+  public ManifestContent content() {\n+    return ManifestContent.DATA;\n+  }\n+\n+  @Override\n+  public long sequenceNumber() {\n+    return 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcwNTA0OA=="}, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5MjU5NzQzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/ManifestFiles.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMTozNTo1NlrOHIiGJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjowOToxNlrOHIi9Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcwOTI4NA==", "bodyText": "Do we want to document or reflect in the name that we return paths for liveEntries only?", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478709284", "createdAt": "2020-08-27T21:35:56Z", "author": {"login": "aokolnychyi"}, "path": "core/src/main/java/org/apache/iceberg/ManifestFiles.java", "diffHunk": "@@ -23,15 +23,30 @@\n import java.util.Map;\n import org.apache.iceberg.ManifestReader.FileType;\n import org.apache.iceberg.exceptions.RuntimeIOException;\n+import org.apache.iceberg.io.CloseableIterable;\n import org.apache.iceberg.io.FileIO;\n import org.apache.iceberg.io.InputFile;\n import org.apache.iceberg.io.OutputFile;\n import org.apache.iceberg.relocated.com.google.common.base.Preconditions;\n+import org.apache.iceberg.relocated.com.google.common.collect.ImmutableList;\n \n public class ManifestFiles {\n   private ManifestFiles() {\n   }\n \n+  /**\n+   * Returns a {@link CloseableIterable} of file paths in the {@link ManifestFile}.\n+   *\n+   * @param manifest a ManifestFile\n+   * @param io a FileIO\n+   * @return a manifest reader\n+   */\n+  public static CloseableIterable<String> readPaths(ManifestFile manifest, FileIO io) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyMzM1NA==", "bodyText": "No, because the live entries are the expected case in the API. That's why readers are Iterable<DataFile>. Entries and deleted files are hidden through the API.", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478723354", "createdAt": "2020-08-27T22:09:16Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/ManifestFiles.java", "diffHunk": "@@ -23,15 +23,30 @@\n import java.util.Map;\n import org.apache.iceberg.ManifestReader.FileType;\n import org.apache.iceberg.exceptions.RuntimeIOException;\n+import org.apache.iceberg.io.CloseableIterable;\n import org.apache.iceberg.io.FileIO;\n import org.apache.iceberg.io.InputFile;\n import org.apache.iceberg.io.OutputFile;\n import org.apache.iceberg.relocated.com.google.common.base.Preconditions;\n+import org.apache.iceberg.relocated.com.google.common.collect.ImmutableList;\n \n public class ManifestFiles {\n   private ManifestFiles() {\n   }\n \n+  /**\n+   * Returns a {@link CloseableIterable} of file paths in the {@link ManifestFile}.\n+   *\n+   * @param manifest a ManifestFile\n+   * @param io a FileIO\n+   * @return a manifest reader\n+   */\n+  public static CloseableIterable<String> readPaths(ManifestFile manifest, FileIO io) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcwOTI4NA=="}, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5MjYwODE1OnYy", "diffSide": "RIGHT", "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMTozOToyNlrOHIiMPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMTozOToyNlrOHIiMPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcxMDg0Ng==", "bodyText": "Let's add a manual repartition step to avoid surprises with adaptive execution.", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478710846", "createdAt": "2020-08-27T21:39:26Z", "author": {"login": "aokolnychyi"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "diffHunk": "@@ -94,9 +102,30 @@ protected String metadataTableName(String tableName, MetadataTableType type) {\n     return buildValidDataFileDF(spark, table().toString());\n   }\n \n+  private static class ReadManifest implements FlatMapFunction<ManifestFileBean, String> {\n+    private final Broadcast<FileIO> io;\n+\n+    ReadManifest(Broadcast<FileIO> io) {\n+      this.io = io;\n+    }\n+\n+    @Override\n+    public Iterator<String> call(ManifestFileBean manifest) {\n+      return new ClosingIterator<>(ManifestFiles.readPaths(manifest, io.getValue()).iterator());\n+    }\n+  }\n+\n   protected Dataset<Row> buildValidDataFileDF(SparkSession spark, String tableName) {\n-    String allDataFilesMetadataTable = metadataTableName(tableName, MetadataTableType.ALL_DATA_FILES);\n-    return spark.read().format(\"iceberg\").load(allDataFilesMetadataTable).select(\"file_path\");\n+    JavaSparkContext context = new JavaSparkContext(spark.sparkContext());\n+    Broadcast<FileIO> ioBroadcast = context.broadcast(SparkUtil.serializableFileIO(table()));\n+    String allManifestsMetadataTable = metadataTableName(tableName, MetadataTableType.ALL_MANIFESTS);\n+\n+    Dataset<ManifestFileBean> allManifests = spark.read().format(\"iceberg\").load(allManifestsMetadataTable)\n+        .selectExpr(\"path\", \"length\", \"partition_spec_id as partitionSpecId\", \"added_snapshot_id as addedSnapshotId\")\n+        .dropDuplicates(\"path\")\n+        .as(Encoders.bean(ManifestFileBean.class));\n+\n+    return allManifests.flatMap(new ReadManifest(ioBroadcast), Encoders.STRING()).toDF(\"file_path\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5MjYyMDA3OnYy", "diffSide": "RIGHT", "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMTo0MzozOFrOHIiTRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjowODowMVrOHIi7NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcxMjY0Nw==", "bodyText": "In other actions, we have private static methods at the end of the classes like below:\nprivate static FlatMapFunction<Iterator<String>, String> listDirsRecursively(\n      Broadcast<SerializableConfiguration> conf,\n      long olderThanTimestamp) {\n\n    return (FlatMapFunction<Iterator<String>, String>) dirs -> {\n      // logic\n    };\n  }\n\nI am OK with this approach too but may make sense to align it with other places.", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478712647", "createdAt": "2020-08-27T21:43:38Z", "author": {"login": "aokolnychyi"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "diffHunk": "@@ -94,9 +102,30 @@ protected String metadataTableName(String tableName, MetadataTableType type) {\n     return buildValidDataFileDF(spark, table().toString());\n   }\n \n+  private static class ReadManifest implements FlatMapFunction<ManifestFileBean, String> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyMjg2OQ==", "bodyText": "Moved.", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478722869", "createdAt": "2020-08-27T22:08:01Z", "author": {"login": "rdblue"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "diffHunk": "@@ -94,9 +102,30 @@ protected String metadataTableName(String tableName, MetadataTableType type) {\n     return buildValidDataFileDF(spark, table().toString());\n   }\n \n+  private static class ReadManifest implements FlatMapFunction<ManifestFileBean, String> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcxMjY0Nw=="}, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5MjYyMzM0OnYy", "diffSide": "RIGHT", "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMTo0NDo0OVrOHIiVPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMzoxMDo1OVrOHIkQdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcxMzE0OQ==", "bodyText": "nit: We use Broadcast<FileIO> io in all other places.", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478713149", "createdAt": "2020-08-27T21:44:49Z", "author": {"login": "aokolnychyi"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "diffHunk": "@@ -94,9 +102,30 @@ protected String metadataTableName(String tableName, MetadataTableType type) {\n     return buildValidDataFileDF(spark, table().toString());\n   }\n \n+  private static class ReadManifest implements FlatMapFunction<ManifestFileBean, String> {\n+    private final Broadcast<FileIO> io;\n+\n+    ReadManifest(Broadcast<FileIO> io) {\n+      this.io = io;\n+    }\n+\n+    @Override\n+    public Iterator<String> call(ManifestFileBean manifest) {\n+      return new ClosingIterator<>(ManifestFiles.readPaths(manifest, io.getValue()).iterator());\n+    }\n+  }\n+\n   protected Dataset<Row> buildValidDataFileDF(SparkSession spark, String tableName) {\n-    String allDataFilesMetadataTable = metadataTableName(tableName, MetadataTableType.ALL_DATA_FILES);\n-    return spark.read().format(\"iceberg\").load(allDataFilesMetadataTable).select(\"file_path\");\n+    JavaSparkContext context = new JavaSparkContext(spark.sparkContext());\n+    Broadcast<FileIO> ioBroadcast = context.broadcast(SparkUtil.serializableFileIO(table()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc0NDY5Mg==", "bodyText": "Sorry I missed fixing this. We can update it next time we touch this code.", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478744692", "createdAt": "2020-08-27T23:10:59Z", "author": {"login": "rdblue"}, "path": "spark/src/main/java/org/apache/iceberg/actions/BaseAction.java", "diffHunk": "@@ -94,9 +102,30 @@ protected String metadataTableName(String tableName, MetadataTableType type) {\n     return buildValidDataFileDF(spark, table().toString());\n   }\n \n+  private static class ReadManifest implements FlatMapFunction<ManifestFileBean, String> {\n+    private final Broadcast<FileIO> io;\n+\n+    ReadManifest(Broadcast<FileIO> io) {\n+      this.io = io;\n+    }\n+\n+    @Override\n+    public Iterator<String> call(ManifestFileBean manifest) {\n+      return new ClosingIterator<>(ManifestFiles.readPaths(manifest, io.getValue()).iterator());\n+    }\n+  }\n+\n   protected Dataset<Row> buildValidDataFileDF(SparkSession spark, String tableName) {\n-    String allDataFilesMetadataTable = metadataTableName(tableName, MetadataTableType.ALL_DATA_FILES);\n-    return spark.read().format(\"iceberg\").load(allDataFilesMetadataTable).select(\"file_path\");\n+    JavaSparkContext context = new JavaSparkContext(spark.sparkContext());\n+    Broadcast<FileIO> ioBroadcast = context.broadcast(SparkUtil.serializableFileIO(table()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcxMzE0OQ=="}, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5MjY2ODIzOnYy", "diffSide": "RIGHT", "path": "spark/src/main/java/org/apache/iceberg/actions/ManifestFileBean.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjowMDo0N1rOHIiwDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjoxMDozMlrOHIi-9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyMDAxMw==", "bodyText": "SparkDataFile is in org.apache.iceberg.spark. Do we want to have these next to each other?", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478720013", "createdAt": "2020-08-27T22:00:47Z", "author": {"login": "aokolnychyi"}, "path": "spark/src/main/java/org/apache/iceberg/actions/ManifestFileBean.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.actions;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyMzgzMA==", "bodyText": "Since this is just a partial implementation, I think we should keep it hidden/private for now.", "url": "https://github.com/apache/iceberg/pull/1397#discussion_r478723830", "createdAt": "2020-08-27T22:10:32Z", "author": {"login": "rdblue"}, "path": "spark/src/main/java/org/apache/iceberg/actions/ManifestFileBean.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.actions;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyMDAxMw=="}, "originalCommit": {"oid": "da38878e37447bf4f40dbcce2fd10ebda872d7d1"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3703, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}