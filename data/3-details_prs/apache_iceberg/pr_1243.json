{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NDk5ODU4", "number": 1243, "title": "Hive: Add support for custom catalog to Iceberg StorageHandler (#1155)", "bodyText": "This PR adds support for custom catalog to Iceberg StorageHandler as well as Hadoop and Hive catalogs and removes the duplicated logic in mapreduce.IcebergInputFormat.findTable and mapred.TableResolver.\nIdeally, I'd like to run the Hive test suite against all the catalog implementations, but I didn't find a way to combine the HiveRunner and Parameterized test runners together. Suggestions?\n@cmathiesen @massdosage @rdsr", "createdAt": "2020-07-24T21:33:09Z", "url": "https://github.com/apache/iceberg/pull/1243", "merged": true, "mergeCommit": {"oid": "7a686d2c9047590a189228b84a5195db254dc101"}, "closed": true, "closedAt": "2020-08-18T13:52:07Z", "author": {"login": "guilload"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4LCmNAFqTQ1NTE5ODkyNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAFCvKgFqTQ2OTIyNjUxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTk4OTI2", "url": "https://github.com/apache/iceberg/pull/1243#pullrequestreview-455198926", "createdAt": "2020-07-24T21:37:37Z", "commit": {"oid": "04b276d726da7621619e090a52bd90bcf8a504c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMTozNzozOFrOG2-bhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMTozNzozOFrOG2-bhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI5OTE0Mg==", "bodyText": "I have decided to remove readFrom(String ...) since the string can be ambiguously an identifier or a location.", "url": "https://github.com/apache/iceberg/pull/1243#discussion_r460299142", "createdAt": "2020-07-24T21:37:38Z", "author": {"login": "guilload"}, "path": "mr/src/main/java/org/apache/iceberg/mr/InputFormatConfig.java", "diffHunk": "@@ -95,15 +93,12 @@ public ConfigBuilder schema(Schema schema) {\n     }\n \n     public ConfigBuilder readFrom(TableIdentifier identifier) {\n-      return readFrom(identifier.toString());\n-    }\n-\n-    public ConfigBuilder readFrom(File path) {\n-      return readFrom(path.toString());\n+      conf.set(TABLE_IDENTIFIER, identifier.toString());\n+      return this;\n     }\n \n-    public ConfigBuilder readFrom(String path) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b276d726da7621619e090a52bd90bcf8a504c7"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NDAzMzI4", "url": "https://github.com/apache/iceberg/pull/1243#pullrequestreview-455403328", "createdAt": "2020-07-26T23:11:52Z", "commit": {"oid": "04b276d726da7621619e090a52bd90bcf8a504c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNlQyMzoxMTo1MlrOG3P4jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNlQyMzoxMTo1MlrOG3P4jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDU4NTEwMg==", "bodyText": "nit: blank line. Also javadoc on this method", "url": "https://github.com/apache/iceberg/pull/1243#discussion_r460585102", "createdAt": "2020-07-26T23:11:52Z", "author": {"login": "rdsr"}, "path": "mr/src/main/java/org/apache/iceberg/mr/CatalogLoader.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.mr;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.iceberg.catalog.Catalog;\n+\n+public interface CatalogLoader {\n+\n+  Catalog load(Configuration conf);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b276d726da7621619e090a52bd90bcf8a504c7"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NDA0MDkx", "url": "https://github.com/apache/iceberg/pull/1243#pullrequestreview-455404091", "createdAt": "2020-07-26T23:21:45Z", "commit": {"oid": "04b276d726da7621619e090a52bd90bcf8a504c7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNlQyMzoyMTo0NVrOG3P8aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNlQyMzoyNDoxMFrOG3P9Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDU4NjA4OA==", "bodyText": "How's the name property used to specify a table ?", "url": "https://github.com/apache/iceberg/pull/1243#discussion_r460586088", "createdAt": "2020-07-26T23:21:45Z", "author": {"login": "rdsr"}, "path": "mr/src/main/java/org/apache/iceberg/mr/Catalogs.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.mr;\n+\n+import java.util.Optional;\n+import java.util.Properties;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.iceberg.Table;\n+import org.apache.iceberg.catalog.Catalog;\n+import org.apache.iceberg.catalog.TableIdentifier;\n+import org.apache.iceberg.common.DynConstructors;\n+import org.apache.iceberg.exceptions.NoSuchNamespaceException;\n+import org.apache.iceberg.hadoop.HadoopCatalog;\n+import org.apache.iceberg.hadoop.HadoopTables;\n+import org.apache.iceberg.hive.HiveCatalogs;\n+import org.apache.iceberg.relocated.com.google.common.annotations.VisibleForTesting;\n+import org.apache.iceberg.relocated.com.google.common.base.Preconditions;\n+\n+public final class Catalogs {\n+\n+  private static final String HADOOP = \"hadoop\";\n+  private static final String HIVE = \"hive\";\n+\n+  private static final String NAME = \"name\";\n+  private static final String LOCATION = \"location\";\n+\n+  private Catalogs() {}\n+\n+  /**\n+   * Load an Iceberg table using the catalog and table identifier (or table path) specified by the configuration.\n+   * Catalog resolution happens in this order:\n+   * 1. Custom catalog if specified by {@link InputFormatConfig#CATALOG_LOADER_CLASS}\n+   * 2. Hadoop or Hive catalog if specified by {@link InputFormatConfig#CATALOG}\n+   * 3. Hadoop Tables\n+   * @param conf a Hadoop conf\n+   * @return an Iceberg table\n+   */\n+  public static Table loadTable(Configuration conf) {\n+    // A bit of a hack to make this function work transparently with Hive without having to remap the \"name\" and\n+    // \"location\" properties.\n+    if (HiveConf.getVar(conf, HiveConf.ConfVars.HIVEQUERYID).length() > 0) {\n+      return loadTable(conf, conf.get(NAME), conf.get(LOCATION));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b276d726da7621619e090a52bd90bcf8a504c7"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDU4NjMzNQ==", "bodyText": "Shouldn't this be InputFile?", "url": "https://github.com/apache/iceberg/pull/1243#discussion_r460586335", "createdAt": "2020-07-26T23:24:10Z", "author": {"login": "rdsr"}, "path": "mr/src/main/java/org/apache/iceberg/mr/InputFormatConfig.java", "diffHunk": "@@ -95,15 +93,12 @@ public ConfigBuilder schema(Schema schema) {\n     }\n \n     public ConfigBuilder readFrom(TableIdentifier identifier) {\n-      return readFrom(identifier.toString());\n-    }\n-\n-    public ConfigBuilder readFrom(File path) {\n-      return readFrom(path.toString());\n+      conf.set(TABLE_IDENTIFIER, identifier.toString());\n+      return this;\n     }\n \n-    public ConfigBuilder readFrom(String path) {\n-      conf.set(TABLE_PATH, path);\n+    public ConfigBuilder readFrom(File location) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b276d726da7621619e090a52bd90bcf8a504c7"}, "originalPosition": 50}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "04b276d726da7621619e090a52bd90bcf8a504c7", "author": {"user": {"login": "guilload", "name": "Adrien Guillo"}}, "url": "https://github.com/apache/iceberg/commit/04b276d726da7621619e090a52bd90bcf8a504c7", "committedDate": "2020-07-24T21:19:19Z", "message": "Add support for custom catalog to Iceberg StorageHandler (closes #1155)"}, "afterCommit": {"oid": "78ca70c450ebf2d976a2981f3bb1ac38dd2dafde", "author": {"user": {"login": "guilload", "name": "Adrien Guillo"}}, "url": "https://github.com/apache/iceberg/commit/78ca70c450ebf2d976a2981f3bb1ac38dd2dafde", "committedDate": "2020-07-30T21:06:52Z", "message": "Forward conf properties in HiveIcebergStorageHandler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5Mzk3MTU5", "url": "https://github.com/apache/iceberg/pull/1243#pullrequestreview-459397159", "createdAt": "2020-07-31T19:04:35Z", "commit": {"oid": "78ca70c450ebf2d976a2981f3bb1ac38dd2dafde"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxOTowNDozNVrOG6S-HA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxOTowNDozNVrOG6S-HA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc4MTQwNA==", "bodyText": "can't we replace TABLE_LOCATION, TABLE_IDENTIFIER and TABLE_PATH with just TABLE_PATH?\ne.g see org.apache.iceberg.spark.source.IcebergSource#findTable", "url": "https://github.com/apache/iceberg/pull/1243#discussion_r463781404", "createdAt": "2020-07-31T19:04:35Z", "author": {"login": "rdsr"}, "path": "mr/src/main/java/org/apache/iceberg/mr/Catalogs.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.mr;\n+\n+import java.util.Optional;\n+import java.util.Properties;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.iceberg.Table;\n+import org.apache.iceberg.catalog.Catalog;\n+import org.apache.iceberg.catalog.TableIdentifier;\n+import org.apache.iceberg.common.DynConstructors;\n+import org.apache.iceberg.exceptions.NoSuchNamespaceException;\n+import org.apache.iceberg.hadoop.HadoopCatalog;\n+import org.apache.iceberg.hadoop.HadoopTables;\n+import org.apache.iceberg.hive.HiveCatalogs;\n+import org.apache.iceberg.relocated.com.google.common.annotations.VisibleForTesting;\n+import org.apache.iceberg.relocated.com.google.common.base.Preconditions;\n+\n+public final class Catalogs {\n+\n+  private static final String HADOOP = \"hadoop\";\n+  private static final String HIVE = \"hive\";\n+\n+  private static final String NAME = \"name\";\n+  private static final String LOCATION = \"location\";\n+\n+  private Catalogs() {}\n+\n+  /**\n+   * Load an Iceberg table using the catalog and table identifier (or table path) specified by the configuration.\n+   * Catalog resolution happens in this order:\n+   * 1. Custom catalog if specified by {@link InputFormatConfig#CATALOG_LOADER_CLASS}\n+   * 2. Hadoop or Hive catalog if specified by {@link InputFormatConfig#CATALOG}\n+   * 3. Hadoop Tables\n+   * @param conf a Hadoop conf\n+   * @return an Iceberg table\n+   */\n+  public static Table loadTable(Configuration conf) {\n+    return loadTable(conf, conf.get(InputFormatConfig.TABLE_IDENTIFIER), conf.get(InputFormatConfig.TABLE_LOCATION));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78ca70c450ebf2d976a2981f3bb1ac38dd2dafde"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NDAwOTA1", "url": "https://github.com/apache/iceberg/pull/1243#pullrequestreview-459400905", "createdAt": "2020-07-31T19:11:20Z", "commit": {"oid": "78ca70c450ebf2d976a2981f3bb1ac38dd2dafde"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxOToxMToyMVrOG6TJeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxOToxMToyMVrOG6TJeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc4NDMxMw==", "bodyText": "Does it make sense to do something similar to what spark does?\nprotected Table findTable(Map<String, String> options, Configuration conf) {\n    Preconditions.checkArgument(options.containsKey(\"path\"), \"Cannot open table: path is not set\");\n    String path = options.get(\"path\");\n\n    if (path.contains(\"/\")) {\n      HadoopTables tables = new HadoopTables(conf);\n      return tables.load(path);\n    } else {\n      HiveCatalog hiveCatalog = HiveCatalogs.loadCatalog(conf);\n      TableIdentifier tableIdentifier = TableIdentifier.parse(path);\n      return hiveCatalog.loadTable(tableIdentifier);\n    }\n  }\n\nuse TABLE_PATH to determine whether we need to use Hadoop or Hive catalog first and only then try custom catalog in the end. Seems like custom catalog would be used very rarely, if at all.", "url": "https://github.com/apache/iceberg/pull/1243#discussion_r463784313", "createdAt": "2020-07-31T19:11:21Z", "author": {"login": "rdsr"}, "path": "mr/src/main/java/org/apache/iceberg/mr/Catalogs.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.mr;\n+\n+import java.util.Optional;\n+import java.util.Properties;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.iceberg.Table;\n+import org.apache.iceberg.catalog.Catalog;\n+import org.apache.iceberg.catalog.TableIdentifier;\n+import org.apache.iceberg.common.DynConstructors;\n+import org.apache.iceberg.exceptions.NoSuchNamespaceException;\n+import org.apache.iceberg.hadoop.HadoopCatalog;\n+import org.apache.iceberg.hadoop.HadoopTables;\n+import org.apache.iceberg.hive.HiveCatalogs;\n+import org.apache.iceberg.relocated.com.google.common.annotations.VisibleForTesting;\n+import org.apache.iceberg.relocated.com.google.common.base.Preconditions;\n+\n+public final class Catalogs {\n+\n+  private static final String HADOOP = \"hadoop\";\n+  private static final String HIVE = \"hive\";\n+\n+  private static final String NAME = \"name\";\n+  private static final String LOCATION = \"location\";\n+\n+  private Catalogs() {}\n+\n+  /**\n+   * Load an Iceberg table using the catalog and table identifier (or table path) specified by the configuration.\n+   * Catalog resolution happens in this order:\n+   * 1. Custom catalog if specified by {@link InputFormatConfig#CATALOG_LOADER_CLASS}\n+   * 2. Hadoop or Hive catalog if specified by {@link InputFormatConfig#CATALOG}\n+   * 3. Hadoop Tables\n+   * @param conf a Hadoop conf\n+   * @return an Iceberg table\n+   */\n+  public static Table loadTable(Configuration conf) {\n+    return loadTable(conf, conf.get(InputFormatConfig.TABLE_IDENTIFIER), conf.get(InputFormatConfig.TABLE_LOCATION));\n+  }\n+\n+  // For use in HiveIcebergSerDe and HiveIcebergStorageHandler\n+  public static Table loadTable(Configuration conf, Properties props) {\n+    return loadTable(conf, props.getProperty(NAME), props.getProperty(LOCATION));\n+  }\n+\n+  private static Table loadTable(Configuration conf, String tableIdentifier, String tableLocation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78ca70c450ebf2d976a2981f3bb1ac38dd2dafde"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NDAyMTE2", "url": "https://github.com/apache/iceberg/pull/1243#pullrequestreview-459402116", "createdAt": "2020-07-31T19:13:33Z", "commit": {"oid": "78ca70c450ebf2d976a2981f3bb1ac38dd2dafde"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxOToxMzozM1rOG6TNJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxOToxMzozM1rOG6TNJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc4NTI1NQ==", "bodyText": "might require a rebase", "url": "https://github.com/apache/iceberg/pull/1243#discussion_r463785255", "createdAt": "2020-07-31T19:13:33Z", "author": {"login": "rdsr"}, "path": "mr/src/main/java/org/apache/iceberg/mr/hive/HiveIcebergSerDe.java", "diffHunk": "@@ -39,13 +38,7 @@\n \n   @Override\n   public void initialize(@Nullable Configuration configuration, Properties serDeProperties) throws SerDeException {\n-    final Table table;\n-\n-    try {\n-      table = TableResolver.resolveTableFromConfiguration(configuration, serDeProperties);\n-    } catch (IOException e) {\n-      throw new UncheckedIOException(\"Unable to resolve table from configuration: \", e);\n-    }\n+    Table table = Catalogs.loadTable(configuration, serDeProperties);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78ca70c450ebf2d976a2981f3bb1ac38dd2dafde"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NDAzNDEy", "url": "https://github.com/apache/iceberg/pull/1243#pullrequestreview-459403412", "createdAt": "2020-07-31T19:16:02Z", "commit": {"oid": "78ca70c450ebf2d976a2981f3bb1ac38dd2dafde"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NDc0NDI2", "url": "https://github.com/apache/iceberg/pull/1243#pullrequestreview-459474426", "createdAt": "2020-07-31T20:58:56Z", "commit": {"oid": "78ca70c450ebf2d976a2981f3bb1ac38dd2dafde"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMDo1ODo1NlrOG6WVBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMDo1ODo1NlrOG6WVBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgzNjQyMw==", "bodyText": "There are two relevant configs in addition to the type: uri for Hive and warehouse for Hadoop. Hive defaults to the value in configuration of hive.metastore.uris from hive-site.xml, so it makes sense to not pass it explicitly here.\nBut, the Hadoop catalog doesn't really have a standard warehouse path. It just has a default. Should we add a configuration option to set up the warehouse when using a HadoopCatalog?", "url": "https://github.com/apache/iceberg/pull/1243#discussion_r463836423", "createdAt": "2020-07-31T20:58:56Z", "author": {"login": "rdblue"}, "path": "mr/src/main/java/org/apache/iceberg/mr/Catalogs.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.mr;\n+\n+import java.util.Optional;\n+import java.util.Properties;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.iceberg.Table;\n+import org.apache.iceberg.catalog.Catalog;\n+import org.apache.iceberg.catalog.TableIdentifier;\n+import org.apache.iceberg.common.DynConstructors;\n+import org.apache.iceberg.exceptions.NoSuchNamespaceException;\n+import org.apache.iceberg.hadoop.HadoopCatalog;\n+import org.apache.iceberg.hadoop.HadoopTables;\n+import org.apache.iceberg.hive.HiveCatalogs;\n+import org.apache.iceberg.relocated.com.google.common.annotations.VisibleForTesting;\n+import org.apache.iceberg.relocated.com.google.common.base.Preconditions;\n+\n+public final class Catalogs {\n+\n+  private static final String HADOOP = \"hadoop\";\n+  private static final String HIVE = \"hive\";\n+\n+  private static final String NAME = \"name\";\n+  private static final String LOCATION = \"location\";\n+\n+  private Catalogs() {}\n+\n+  /**\n+   * Load an Iceberg table using the catalog and table identifier (or table path) specified by the configuration.\n+   * Catalog resolution happens in this order:\n+   * 1. Custom catalog if specified by {@link InputFormatConfig#CATALOG_LOADER_CLASS}\n+   * 2. Hadoop or Hive catalog if specified by {@link InputFormatConfig#CATALOG}\n+   * 3. Hadoop Tables\n+   * @param conf a Hadoop conf\n+   * @return an Iceberg table\n+   */\n+  public static Table loadTable(Configuration conf) {\n+    return loadTable(conf, conf.get(InputFormatConfig.TABLE_IDENTIFIER), conf.get(InputFormatConfig.TABLE_LOCATION));\n+  }\n+\n+  // For use in HiveIcebergSerDe and HiveIcebergStorageHandler\n+  public static Table loadTable(Configuration conf, Properties props) {\n+    return loadTable(conf, props.getProperty(NAME), props.getProperty(LOCATION));\n+  }\n+\n+  private static Table loadTable(Configuration conf, String tableIdentifier, String tableLocation) {\n+    Optional<Catalog> catalog = loadCatalog(conf);\n+\n+    if (catalog.isPresent()) {\n+      Preconditions.checkArgument(tableIdentifier != null, \"Table identifier not set\");\n+      return catalog.get().loadTable(TableIdentifier.parse(tableIdentifier));\n+    }\n+\n+    Preconditions.checkArgument(tableLocation != null, \"Table location not set\");\n+    return new HadoopTables(conf).load(tableLocation);\n+  }\n+\n+  @VisibleForTesting\n+  static Optional<Catalog> loadCatalog(Configuration conf) {\n+    String catalogLoaderClass = conf.get(InputFormatConfig.CATALOG_LOADER_CLASS);\n+\n+    if (catalogLoaderClass != null) {\n+      CatalogLoader loader = (CatalogLoader) DynConstructors.builder(CatalogLoader.class)\n+              .impl(catalogLoaderClass)\n+              .build()\n+              .newInstance();\n+      return Optional.of(loader.load(conf));\n+    }\n+\n+    String catalogName = conf.get(InputFormatConfig.CATALOG);\n+\n+    if (catalogName != null) {\n+      switch (catalogName.toLowerCase()) {\n+        case HADOOP:\n+          return Optional.of(new HadoopCatalog(conf));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78ca70c450ebf2d976a2981f3bb1ac38dd2dafde"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NDc1NDU5", "url": "https://github.com/apache/iceberg/pull/1243#pullrequestreview-459475459", "createdAt": "2020-07-31T21:01:05Z", "commit": {"oid": "78ca70c450ebf2d976a2981f3bb1ac38dd2dafde"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMTowMTowNVrOG6WbMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMTowMTowNVrOG6WbMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgzODAwMA==", "bodyText": "Doesn't this also need to forward the catalog loader class?", "url": "https://github.com/apache/iceberg/pull/1243#discussion_r463838000", "createdAt": "2020-07-31T21:01:05Z", "author": {"login": "rdblue"}, "path": "mr/src/main/java/org/apache/iceberg/mr/hive/HiveIcebergStorageHandler.java", "diffHunk": "@@ -66,7 +73,12 @@ public HiveAuthorizationProvider getAuthorizationProvider() throws HiveException\n \n   @Override\n   public void configureInputJobProperties(TableDesc tableDesc, Map<String, String> map) {\n+    Properties props = tableDesc.getProperties();\n+    Table table = Catalogs.loadTable(conf, props);\n \n+    map.put(InputFormatConfig.TABLE_IDENTIFIER, props.getProperty(NAME));\n+    map.put(InputFormatConfig.TABLE_LOCATION, table.location());\n+    map.put(InputFormatConfig.TABLE_SCHEMA, SchemaParser.toJson(table.schema()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78ca70c450ebf2d976a2981f3bb1ac38dd2dafde"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0380666d4eb5bf8131cf856d5014e852b656e893", "author": {"user": {"login": "guilload", "name": "Adrien Guillo"}}, "url": "https://github.com/apache/iceberg/commit/0380666d4eb5bf8131cf856d5014e852b656e893", "committedDate": "2020-08-10T20:06:06Z", "message": "Add support for custom catalog to Iceberg StorageHandler (closes #1155)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0947ed76f9fc557277411f7ea231c68095d5cfc", "author": {"user": {"login": "guilload", "name": "Adrien Guillo"}}, "url": "https://github.com/apache/iceberg/commit/a0947ed76f9fc557277411f7ea231c68095d5cfc", "committedDate": "2020-08-10T20:06:06Z", "message": "Forward conf properties in HiveIcebergStorageHandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90ccd39b8e349b3506c9866e179112a408447bfa", "author": {"user": {"login": "guilload", "name": "Adrien Guillo"}}, "url": "https://github.com/apache/iceberg/commit/90ccd39b8e349b3506c9866e179112a408447bfa", "committedDate": "2020-08-10T20:06:41Z", "message": "Add warehouse location configuration setting for Hadoop catalog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "78ca70c450ebf2d976a2981f3bb1ac38dd2dafde", "author": {"user": {"login": "guilload", "name": "Adrien Guillo"}}, "url": "https://github.com/apache/iceberg/commit/78ca70c450ebf2d976a2981f3bb1ac38dd2dafde", "committedDate": "2020-07-30T21:06:52Z", "message": "Forward conf properties in HiveIcebergStorageHandler"}, "afterCommit": {"oid": "90ccd39b8e349b3506c9866e179112a408447bfa", "author": {"user": {"login": "guilload", "name": "Adrien Guillo"}}, "url": "https://github.com/apache/iceberg/commit/90ccd39b8e349b3506c9866e179112a408447bfa", "committedDate": "2020-08-10T20:06:41Z", "message": "Add warehouse location configuration setting for Hadoop catalog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2500efb57f3aa2385409a0894e144b5da9348846", "author": {"user": {"login": "guilload", "name": "Adrien Guillo"}}, "url": "https://github.com/apache/iceberg/commit/2500efb57f3aa2385409a0894e144b5da9348846", "committedDate": "2020-08-11T22:15:15Z", "message": "Run Hive test suite against multiple catalog implementations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MjU5NzMx", "url": "https://github.com/apache/iceberg/pull/1243#pullrequestreview-467259731", "createdAt": "2020-08-14T01:51:44Z", "commit": {"oid": "2500efb57f3aa2385409a0894e144b5da9348846"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMTo1MTo0NFrOHAk8zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMTo1MTo0NFrOHAk8zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2NzQzNw==", "bodyText": "it is kinda weird that we are calling this class TestHiveIcebergInputFormat instead of say TestHiveStorageHandler or something similar.", "url": "https://github.com/apache/iceberg/pull/1243#discussion_r470367437", "createdAt": "2020-08-14T01:51:44Z", "author": {"login": "rdsr"}, "path": "mr/src/test/java/org/apache/iceberg/mr/hive/TestHiveIcebergInputFormat.java", "diffHunk": "@@ -45,9 +47,9 @@\n import static org.apache.iceberg.types.Types.NestedField.required;\n \n @RunWith(StandaloneHiveRunner.class)\n-public class TestHiveIcebergInputFormat {\n+public abstract class TestHiveIcebergInputFormat {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2500efb57f3aa2385409a0894e144b5da9348846"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MjYyNzky", "url": "https://github.com/apache/iceberg/pull/1243#pullrequestreview-467262792", "createdAt": "2020-08-14T02:03:23Z", "commit": {"oid": "2500efb57f3aa2385409a0894e144b5da9348846"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMjowMzoyM1rOHAlHUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMjowMzoyM1rOHAlHUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3MDEzMQ==", "bodyText": "shouldn't we set the  custom catalog loader  by setting a table property catalog.loader.class here?", "url": "https://github.com/apache/iceberg/pull/1243#discussion_r470370131", "createdAt": "2020-08-14T02:03:23Z", "author": {"login": "rdsr"}, "path": "mr/src/test/java/org/apache/iceberg/mr/hive/TestHiveIcebergInputFormat.java", "diffHunk": "@@ -155,11 +157,31 @@ public void testJoinTables() {\n     Assert.assertArrayEquals(new Object[] {1L, \"Bob\", 102L, 33.33d}, rows.get(2));\n   }\n \n-  private void createHiveTable(String table, String location) {\n+  protected void createTable(String tableName, Schema schema, List<Record> records)\n+          throws IOException {\n+    Table table = createIcebergTable(tableName, schema, records);\n+    createHiveTable(tableName, table.location());\n+  }\n+\n+  protected Table createIcebergTable(String tableName, Schema schema, List<Record> records)\n+          throws IOException {\n+    String identifier = testTables.identifier(\"default.\" + tableName);\n+    TestHelper helper = new TestHelper(\n+            metastore.hiveConf(), testTables.tables(), identifier, schema, SPEC, FileFormat.PARQUET, temp);\n+    Table table = helper.createTable();\n+\n+    if (!records.isEmpty()) {\n+      helper.appendToTable(helper.writeFile(null, records));\n+    }\n+\n+    return table;\n+  }\n+\n+  protected void createHiveTable(String tableName, String location) {\n     shell.execute(String.format(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2500efb57f3aa2385409a0894e144b5da9348846"}, "originalPosition": 154}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d1e3fb78fecd388ff9a544e9a9e086c207f156a", "author": {"user": {"login": "guilload", "name": "Adrien Guillo"}}, "url": "https://github.com/apache/iceberg/commit/1d1e3fb78fecd388ff9a544e9a9e086c207f156a", "committedDate": "2020-08-14T17:59:19Z", "message": "Rename Hive storage handler test classes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3ODAyOTQ3", "url": "https://github.com/apache/iceberg/pull/1243#pullrequestreview-467802947", "createdAt": "2020-08-14T18:46:09Z", "commit": {"oid": "1d1e3fb78fecd388ff9a544e9a9e086c207f156a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MjI2NTE5", "url": "https://github.com/apache/iceberg/pull/1243#pullrequestreview-469226519", "createdAt": "2020-08-18T11:09:45Z", "commit": {"oid": "1d1e3fb78fecd388ff9a544e9a9e086c207f156a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4330, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}