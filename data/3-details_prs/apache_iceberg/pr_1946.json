{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNDc5Mjc4", "number": 1946, "title": "Avro metrics support: create MetricsAwareDatumWriter and some refactors for Avro", "bodyText": "This change is a smaller PR broken down from #1935. There is no change in behavior from this PR. It covers the following:\n\nadd comparator for byte array\nupdated field metrics bound type to allow object to byte buffer translation to occur later\nadd metrics() method to ValueWriter for Avro, currently default to empty stream\ncreate MetricsAwareDatumWriter that exposes writer metrics, and replace DatumWriter with it in various classes\nadd metrics config to avro writer and builder\ncreate a AvroMetrics class that resembles current behavior for producing metrics for avro writer", "createdAt": "2020-12-16T22:34:50Z", "url": "https://github.com/apache/iceberg/pull/1946", "merged": true, "mergeCommit": {"oid": "6cc5d997998ad818354c2d6a86c54ebc613890ae"}, "closed": true, "closedAt": "2021-02-03T02:00:37Z", "author": {"login": "yyanyy"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnP1jSgFqTU1NTE1NDY2Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABd2WeKQAFqTU4MTk0NDI1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MTU0NjYz", "url": "https://github.com/apache/iceberg/pull/1946#pullrequestreview-555154663", "createdAt": "2020-12-18T03:47:21Z", "commit": {"oid": "394a34c4aeaa090a701b241592d168fb4e869958"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMzo0NzoyMVrOIISC5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMzo0NzoyMVrOIISC5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1NTE3Mg==", "bodyText": "Does Schema need to be fully qualified?", "url": "https://github.com/apache/iceberg/pull/1946#discussion_r545555172", "createdAt": "2020-12-18T03:47:21Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/avro/AvroFileAppender.java", "diffHunk": "@@ -27,22 +27,31 @@\n import org.apache.avro.file.DataFileWriter;\n import org.apache.avro.io.DatumWriter;\n import org.apache.iceberg.Metrics;\n+import org.apache.iceberg.MetricsConfig;\n import org.apache.iceberg.exceptions.RuntimeIOException;\n import org.apache.iceberg.io.FileAppender;\n import org.apache.iceberg.io.OutputFile;\n import org.apache.iceberg.io.PositionOutputStream;\n+import org.apache.iceberg.relocated.com.google.common.base.Preconditions;\n \n class AvroFileAppender<D> implements FileAppender<D> {\n   private PositionOutputStream stream = null;\n   private DataFileWriter<D> writer = null;\n+  private MetricsAwareDatumWriter<?> metricsAwareDatumWriter = null;\n+  private org.apache.iceberg.Schema icebergSchema;\n+  private MetricsConfig metricsConfig;\n   private long numRecords = 0L;\n+  private boolean isClosed = false;\n \n-  AvroFileAppender(Schema schema, OutputFile file,\n-                   Function<Schema, DatumWriter<?>> createWriterFunc,\n+  AvroFileAppender(org.apache.iceberg.Schema icebergSchema, Schema schema, OutputFile file,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "394a34c4aeaa090a701b241592d168fb4e869958"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MTU1MjQ5", "url": "https://github.com/apache/iceberg/pull/1946#pullrequestreview-555155249", "createdAt": "2020-12-18T03:49:32Z", "commit": {"oid": "394a34c4aeaa090a701b241592d168fb4e869958"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMzo0OTozM1rOIISFRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMzo0OTozM1rOIISFRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1NTc4MQ==", "bodyText": "Why change this to Object rather than ByteBuffer? Seems like conversion to ByteBuffer would be cleaner if this was done in each writer because the writer already has its type because it is going to call the right method on the encoder.", "url": "https://github.com/apache/iceberg/pull/1946#discussion_r545555781", "createdAt": "2020-12-18T03:49:33Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/FieldMetrics.java", "diffHunk": "@@ -30,15 +28,15 @@\n   private final long valueCount;\n   private final long nullValueCount;\n   private final long nanValueCount;\n-  private final ByteBuffer lowerBound;\n-  private final ByteBuffer upperBound;\n+  private final Object lowerBound;\n+  private final Object upperBound;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "394a34c4aeaa090a701b241592d168fb4e869958"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MTU1Mzg0", "url": "https://github.com/apache/iceberg/pull/1946#pullrequestreview-555155384", "createdAt": "2020-12-18T03:49:59Z", "commit": {"oid": "394a34c4aeaa090a701b241592d168fb4e869958"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMzo1MDowMFrOIISFvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMzo1MDowMFrOIISFvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1NTkwMA==", "bodyText": "Other method names are plural. Could we use unsignedByteArrays()?", "url": "https://github.com/apache/iceberg/pull/1946#discussion_r545555900", "createdAt": "2020-12-18T03:50:00Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/types/Comparators.java", "diffHunk": "@@ -157,6 +157,10 @@ public int compare(List<T> o1, List<T> o2) {\n     return UnsignedByteBufComparator.INSTANCE;\n   }\n \n+  public static Comparator<byte[]> unsignedByteArray() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "394a34c4aeaa090a701b241592d168fb4e869958"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MTU2MDA0", "url": "https://github.com/apache/iceberg/pull/1946#pullrequestreview-555156004", "createdAt": "2020-12-18T03:52:21Z", "commit": {"oid": "394a34c4aeaa090a701b241592d168fb4e869958"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMzo1MjoyMVrOIISIJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMzo1MjoyMVrOIISIJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU1NjUxOQ==", "bodyText": "This is going to break existing uses of createWriterFunc in projects that build on Iceberg. I think this should keep the old parameter and just check whether the implementation is MetricsAwareDatumWriter in the appender to return metrics.", "url": "https://github.com/apache/iceberg/pull/1946#discussion_r545556519", "createdAt": "2020-12-18T03:52:21Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/avro/Avro.java", "diffHunk": "@@ -123,7 +127,7 @@ public WriteBuilder named(String newName) {\n       return this;\n     }\n \n-    public WriteBuilder createWriterFunc(Function<Schema, DatumWriter<?>> writerFunction) {\n+    public WriteBuilder createWriterFunc(Function<Schema, MetricsAwareDatumWriter<?>> writerFunction) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "394a34c4aeaa090a701b241592d168fb4e869958"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MzI0NjU2", "url": "https://github.com/apache/iceberg/pull/1946#pullrequestreview-557324656", "createdAt": "2020-12-22T19:42:07Z", "commit": {"oid": "03a1b420dca114002ed3c648825d97265e86ce26"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b6a15acb992826b3f40fe8235ff4196b138af3c", "author": {"user": {"login": "yyanyy", "name": null}}, "url": "https://github.com/apache/iceberg/commit/6b6a15acb992826b3f40fe8235ff4196b138af3c", "committedDate": "2021-01-05T20:37:35Z", "message": "create MetricsAwareDatumWriter and some refactors for Avro"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03a1b420dca114002ed3c648825d97265e86ce26", "author": {"user": {"login": "yyanyy", "name": null}}, "url": "https://github.com/apache/iceberg/commit/03a1b420dca114002ed3c648825d97265e86ce26", "committedDate": "2020-12-18T23:48:31Z", "message": "use metrics config in appender factory"}, "afterCommit": {"oid": "6b6a15acb992826b3f40fe8235ff4196b138af3c", "author": {"user": {"login": "yyanyy", "name": null}}, "url": "https://github.com/apache/iceberg/commit/6b6a15acb992826b3f40fe8235ff4196b138af3c", "committedDate": "2021-01-05T20:37:35Z", "message": "create MetricsAwareDatumWriter and some refactors for Avro"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1ODA3Nzgx", "url": "https://github.com/apache/iceberg/pull/1946#pullrequestreview-565807781", "createdAt": "2021-01-11T23:03:18Z", "commit": {"oid": "6b6a15acb992826b3f40fe8235ff4196b138af3c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQyMzowMzoxOFrOIRqqLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQyMzowMzoxOFrOIRqqLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM5NTYzMQ==", "bodyText": "nit: \"the shorter seq is first\" is a bit confusing to me, maybe \"is smaller\" is a better word.", "url": "https://github.com/apache/iceberg/pull/1946#discussion_r555395631", "createdAt": "2021-01-11T23:03:18Z", "author": {"login": "jackye1995"}, "path": "api/src/main/java/org/apache/iceberg/types/Comparators.java", "diffHunk": "@@ -272,6 +276,30 @@ public int compare(ByteBuffer buf1, ByteBuffer buf2) {\n     }\n   }\n \n+  private static class UnsignedByteArrayComparator implements Comparator<byte[]> {\n+    private static final UnsignedByteArrayComparator INSTANCE = new UnsignedByteArrayComparator();\n+\n+    private UnsignedByteArrayComparator() {\n+    }\n+\n+    @Override\n+    public int compare(byte[] array1, byte[] array2) {\n+      int len = Math.min(array1.length, array2.length);\n+\n+      // find the first difference and return\n+      for (int i = 0; i < len; i += 1) {\n+        // Conversion to int is what Byte.toUnsignedInt would do\n+        int cmp = Integer.compare(((int) array1[i]) & 0xff, ((int) array2[i]) & 0xff);\n+        if (cmp != 0) {\n+          return cmp;\n+        }\n+      }\n+\n+      // if there are no differences, then the shorter seq is first", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b6a15acb992826b3f40fe8235ff4196b138af3c"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ba8097e7965e7cdfaaf1f605552e4c27a4a0fb6", "author": {"user": {"login": "yyanyy", "name": null}}, "url": "https://github.com/apache/iceberg/commit/1ba8097e7965e7cdfaaf1f605552e4c27a4a0fb6", "committedDate": "2021-01-12T02:28:53Z", "message": "minor comment update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3NzcwMTIx", "url": "https://github.com/apache/iceberg/pull/1946#pullrequestreview-567770121", "createdAt": "2021-01-14T00:40:25Z", "commit": {"oid": "1ba8097e7965e7cdfaaf1f605552e4c27a4a0fb6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxOTQxODM2", "url": "https://github.com/apache/iceberg/pull/1946#pullrequestreview-581941836", "createdAt": "2021-02-03T01:53:46Z", "commit": {"oid": "1ba8097e7965e7cdfaaf1f605552e4c27a4a0fb6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTo1Mzo0NlrOIes0GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTo1Mzo0NlrOIes0GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTA2MjQyNQ==", "bodyText": "This should also include metrics from the rowWriter, right?", "url": "https://github.com/apache/iceberg/pull/1946#discussion_r569062425", "createdAt": "2021-02-03T01:53:46Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/avro/Avro.java", "diffHunk": "@@ -363,6 +378,11 @@ public void write(PositionDelete<D> delete, Encoder out) throws IOException {\n       POS_WRITER.write(delete.pos(), out);\n       rowWriter.write(delete.row(), out);\n     }\n+\n+    @Override\n+    public Stream<FieldMetrics> metrics() {\n+      return Stream.concat(PATH_WRITER.metrics(), POS_WRITER.metrics());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ba8097e7965e7cdfaaf1f605552e4c27a4a0fb6"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxOTQyNzAy", "url": "https://github.com/apache/iceberg/pull/1946#pullrequestreview-581942702", "createdAt": "2021-02-03T01:56:01Z", "commit": {"oid": "1ba8097e7965e7cdfaaf1f605552e4c27a4a0fb6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTo1NjowMVrOIes7Gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTo1NjowMVrOIes7Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTA2NDIxOA==", "bodyText": "Nit: Does this need a newline? I think it would all fit.", "url": "https://github.com/apache/iceberg/pull/1946#discussion_r569064218", "createdAt": "2021-02-03T01:56:01Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/avro/AvroFileAppender.java", "diffHunk": "@@ -57,7 +66,10 @@ public void add(D datum) {\n \n   @Override\n   public Metrics metrics() {\n-    return new Metrics(numRecords, null, null, null);\n+    Preconditions.checkState(isClosed,\n+        \"Cannot return metrics while appending to an open file.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ba8097e7965e7cdfaaf1f605552e4c27a4a0fb6"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxOTQzMzYy", "url": "https://github.com/apache/iceberg/pull/1946#pullrequestreview-581943362", "createdAt": "2021-02-03T01:57:48Z", "commit": {"oid": "1ba8097e7965e7cdfaaf1f605552e4c27a4a0fb6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTo1Nzo0OFrOIetAUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTo1Nzo0OFrOIetAUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTA2NTU1NA==", "bodyText": "Minor: I don't think this needs to be a MetricsAwareDatumWriter, right? It isn't in the type signature, so we should name it just datumWriter.", "url": "https://github.com/apache/iceberg/pull/1946#discussion_r569065554", "createdAt": "2021-02-03T01:57:48Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/avro/AvroFileAppender.java", "diffHunk": "@@ -77,15 +89,16 @@ public void close() throws IOException {\n     if (writer != null) {\n       writer.close();\n       this.writer = null;\n+      isClosed = true;\n     }\n   }\n \n   @SuppressWarnings(\"unchecked\")\n   private static <D> DataFileWriter<D> newAvroWriter(\n-      Schema schema, PositionOutputStream stream, Function<Schema, DatumWriter<?>> createWriterFunc,\n+      Schema schema, PositionOutputStream stream, DatumWriter<?> metricsAwareDatumWriter,\n       CodecFactory codec, Map<String, String> metadata) throws IOException {\n     DataFileWriter<D> writer = new DataFileWriter<>(\n-        (DatumWriter<D>) createWriterFunc.apply(schema));\n+        (DatumWriter<D>) metricsAwareDatumWriter);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ba8097e7965e7cdfaaf1f605552e4c27a4a0fb6"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxOTQ0MjU2", "url": "https://github.com/apache/iceberg/pull/1946#pullrequestreview-581944256", "createdAt": "2021-02-03T02:00:00Z", "commit": {"oid": "1ba8097e7965e7cdfaaf1f605552e4c27a4a0fb6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3277, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}