{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5MTYxOTk3", "number": 1353, "title": "Core: check that project schema and selected columns cannot be specified at the same time", "bodyText": "Fixes #1304", "createdAt": "2020-08-18T02:29:43Z", "url": "https://github.com/apache/iceberg/pull/1353", "merged": true, "mergeCommit": {"oid": "67251c028e0fd2e687f1ec847badec55a4e5a34c"}, "closed": true, "closedAt": "2020-09-08T20:36:54Z", "author": {"login": "JingsongLi"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAPrapAFqTQ2OTg5ODM0Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFb7g_AH2gAyNDY5MTYxOTk3OjI0MDdlZDc4YzFiNTg1ODg2YTNmZGYzZDVjZGI0MmUwZDg2NjkwNTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODk4MzQ2", "url": "https://github.com/apache/iceberg/pull/1353#pullrequestreview-469898346", "createdAt": "2020-08-18T23:33:14Z", "commit": {"oid": "ef53511af73cd0cf317658242fc4564e01acbbc8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMzozMzoxNFrOHCqLKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMzozMzoxNFrOHCqLKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1MDE4Nw==", "bodyText": "We would normally use a Precondition check here:\nPreconditions.checkState(context.selectedColumns() == null, \"Cannot ...\");\nI was also going to say that I think we should check the reverse as well, in case project is called before select, but it looks like the projection is tracked outside of the context for some reason. I don't think that's quite right. We probably want to move project to the context as well.\n@edgarRd, do you know why project doesn't use the scan context?", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r472550187", "createdAt": "2020-08-18T23:33:14Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseTableScan.java", "diffHunk": "@@ -159,6 +159,10 @@ public TableScan option(String property, String value) {\n \n   @Override\n   public TableScan project(Schema projectedSchema) {\n+    if (context.selectedColumns() != null) {\n+      throw new IllegalStateException(\"Cannot project schema when selected columns is specified.\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef53511af73cd0cf317658242fc4564e01acbbc8"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMzk5MTQz", "url": "https://github.com/apache/iceberg/pull/1353#pullrequestreview-481399143", "createdAt": "2020-09-03T00:25:13Z", "commit": {"oid": "a08cb105f0f9a0d8596ad71480c17643ced5657a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwMDoyNToxNFrOHMQeMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwMDoyNToxNFrOHMQeMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYxNDgzNA==", "bodyText": "Nit: should be Cannot select columns when projection schema is set, and you can omit the ending .", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r482614834", "createdAt": "2020-09-03T00:25:14Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableScanContext.java", "diffHunk": "@@ -107,16 +112,27 @@ boolean returnColumnStats() {\n \n   TableScanContext shouldReturnColumnStats(boolean returnColumnStats) {\n     return new TableScanContext(snapshotId, rowFilter, ignoreResiduals,\n-        caseSensitive, returnColumnStats, selectedColumns, options, fromSnapshotId, toSnapshotId);\n+        caseSensitive, returnColumnStats, projectedSchema, selectedColumns, options, fromSnapshotId, toSnapshotId);\n   }\n \n   Collection<String> selectedColumns() {\n     return selectedColumns;\n   }\n \n   TableScanContext selectColumns(Collection<String> columns) {\n+    Preconditions.checkState(projectedSchema == null, \"Cannot selected columns when project schema is specified.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a08cb105f0f9a0d8596ad71480c17643ced5657a"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMzk5MzU5", "url": "https://github.com/apache/iceberg/pull/1353#pullrequestreview-481399359", "createdAt": "2020-09-03T00:26:00Z", "commit": {"oid": "a08cb105f0f9a0d8596ad71480c17643ced5657a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwMDoyNjowMFrOHMQe_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwMDoyNjowMFrOHMQe_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYxNTAzOA==", "bodyText": "How about Cannot set projection schema when columns are selected", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r482615038", "createdAt": "2020-09-03T00:26:00Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableScanContext.java", "diffHunk": "@@ -107,16 +112,27 @@ boolean returnColumnStats() {\n \n   TableScanContext shouldReturnColumnStats(boolean returnColumnStats) {\n     return new TableScanContext(snapshotId, rowFilter, ignoreResiduals,\n-        caseSensitive, returnColumnStats, selectedColumns, options, fromSnapshotId, toSnapshotId);\n+        caseSensitive, returnColumnStats, projectedSchema, selectedColumns, options, fromSnapshotId, toSnapshotId);\n   }\n \n   Collection<String> selectedColumns() {\n     return selectedColumns;\n   }\n \n   TableScanContext selectColumns(Collection<String> columns) {\n+    Preconditions.checkState(projectedSchema == null, \"Cannot selected columns when project schema is specified.\");\n     return new TableScanContext(snapshotId, rowFilter, ignoreResiduals,\n-        caseSensitive, colStats, columns, options, fromSnapshotId, toSnapshotId);\n+        caseSensitive, colStats, null, columns, options, fromSnapshotId, toSnapshotId);\n+  }\n+\n+  Schema projectedSchema() {\n+    return projectedSchema;\n+  }\n+\n+  TableScanContext project(Schema schema) {\n+    Preconditions.checkState(selectedColumns == null, \"Cannot project schema when selected columns is specified.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a08cb105f0f9a0d8596ad71480c17643ced5657a"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNDAwNDI3", "url": "https://github.com/apache/iceberg/pull/1353#pullrequestreview-481400427", "createdAt": "2020-09-03T00:29:43Z", "commit": {"oid": "a08cb105f0f9a0d8596ad71480c17643ced5657a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwMDoyOTo0M1rOHMQjHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwMDoyOTo0M1rOHMQjHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYxNjA5Mw==", "bodyText": "I don't understand why select only works for data table scans. I updated this method to use the schema that is passed into the constructor and all Iceberg tests pass. By updating this to use the schema passed in instead of the table schema, we can support either project or select, depending on what the caller chooses.\nThen we can remove the overrides that throw UnsupportedOperationException.", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r482616093", "createdAt": "2020-09-03T00:29:43Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseTableScan.java", "diffHunk": "@@ -284,6 +284,8 @@ public String toString() {\n   private Schema lazyColumnProjection() {\n     Collection<String> selectedColumns = context.selectedColumns();\n     if (selectedColumns != null) {\n+      // select columns only works for data table scans, so it is OK to select on table.schema().\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a08cb105f0f9a0d8596ad71480c17643ced5657a"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNDAxNDYy", "url": "https://github.com/apache/iceberg/pull/1353#pullrequestreview-481401462", "createdAt": "2020-09-03T00:30:18Z", "commit": {"oid": "a08cb105f0f9a0d8596ad71480c17643ced5657a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwMDozMDoxOFrOHMQjyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwMDozMDoxOFrOHMQjyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYxNjI2NQ==", "bodyText": "Nit: I find this more readable if the blank line is before the else to distinguish between the previous block and the else case.", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r482616265", "createdAt": "2020-09-03T00:30:18Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseTableScan.java", "diffHunk": "@@ -301,6 +303,9 @@ private Schema lazyColumnProjection() {\n       requiredFieldIds.addAll(selectedIds);\n \n       return TypeUtil.select(table.schema(), requiredFieldIds);\n+    } else if (context.projectedSchema() != null) {\n+\n+      return context.projectedSchema();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a08cb105f0f9a0d8596ad71480c17643ced5657a"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ceb2c4083dc8c0db6e9e022f344d67cca88b2639", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/iceberg/commit/ceb2c4083dc8c0db6e9e022f344d67cca88b2639", "committedDate": "2020-09-03T04:06:48Z", "message": "Core: check that cannot project schema when selected columns is specified"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9857a492d9f0d1a72657f4682c31a0700c83ab2d", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/iceberg/commit/9857a492d9f0d1a72657f4682c31a0700c83ab2d", "committedDate": "2020-09-03T04:06:48Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70f76bb73ae362244730e0cbec993d9210c46d1d", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/iceberg/commit/70f76bb73ae362244730e0cbec993d9210c46d1d", "committedDate": "2020-09-03T04:06:48Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a08cb105f0f9a0d8596ad71480c17643ced5657a", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/iceberg/commit/a08cb105f0f9a0d8596ad71480c17643ced5657a", "committedDate": "2020-08-20T03:52:46Z", "message": "Address comments"}, "afterCommit": {"oid": "70f76bb73ae362244730e0cbec993d9210c46d1d", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/iceberg/commit/70f76bb73ae362244730e0cbec993d9210c46d1d", "committedDate": "2020-09-03T04:06:48Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5011fbf8a1e7586b6a6632f845175597faf429e4", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/iceberg/commit/5011fbf8a1e7586b6a6632f845175597faf429e4", "committedDate": "2020-09-03T04:11:53Z", "message": "Add comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bc6137db8a1fa7db1d798b7051cf39b48ae90df", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/iceberg/commit/1bc6137db8a1fa7db1d798b7051cf39b48ae90df", "committedDate": "2020-09-03T05:52:31Z", "message": "Minor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxOTQ2MDIx", "url": "https://github.com/apache/iceberg/pull/1353#pullrequestreview-481946021", "createdAt": "2020-09-03T15:17:44Z", "commit": {"oid": "1bc6137db8a1fa7db1d798b7051cf39b48ae90df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNToxNzo0NFrOHMrjPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNToxNzo0NFrOHMrjPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1ODQ5Mg==", "bodyText": "I'm not sure I understand why this is added. Shouldn't the filter (which is unbound) be bound to the scan's schema and not the underlying table's schema?", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r483058492", "createdAt": "2020-09-03T15:17:44Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseTableScan.java", "diffHunk": "@@ -106,6 +106,14 @@ protected abstract TableScan newRefinedScan(\n       TableOperations ops, Snapshot snapshot, Expression rowFilter,\n       boolean ignoreResiduals, boolean caseSensitive, boolean colStats);\n \n+  /**\n+   * The {@link #filter(Expression)} is based on the table records. So the data table scan need select all of the\n+   * filter columns, other scans don't need to.\n+   */\n+  protected boolean isDataTableScan() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bc6137db8a1fa7db1d798b7051cf39b48ae90df"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxOTQ2NjAx", "url": "https://github.com/apache/iceberg/pull/1353#pullrequestreview-481946601", "createdAt": "2020-09-03T15:18:17Z", "commit": {"oid": "1bc6137db8a1fa7db1d798b7051cf39b48ae90df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNToxODoxN1rOHMrlLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNToxODoxN1rOHMrlLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1ODk5MA==", "bodyText": "Why not do this for all table scans?", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r483058990", "createdAt": "2020-09-03T15:18:17Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseTableScan.java", "diffHunk": "@@ -286,21 +294,26 @@ private Schema lazyColumnProjection() {\n     if (selectedColumns != null) {\n       Set<Integer> requiredFieldIds = Sets.newHashSet();\n \n-      // all of the filter columns are required\n-      requiredFieldIds.addAll(\n-          Binder.boundReferences(table.schema().asStruct(),\n-              Collections.singletonList(context.rowFilter()), context.caseSensitive()));\n+      if (isDataTableScan()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bc6137db8a1fa7db1d798b7051cf39b48ae90df"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2407ed78c1b585886a3fdf3d5cdb42e0d8669050", "author": {"user": {"login": "JingsongLi", "name": "Jingsong Lee"}}, "url": "https://github.com/apache/iceberg/commit/2407ed78c1b585886a3fdf3d5cdb42e0d8669050", "committedDate": "2020-09-04T02:39:18Z", "message": "Address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4074, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}