{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0NTExOTgy", "number": 1975, "title": "Core: add sort order id to content file", "bodyText": "This change adds sort_order_id to content file, and allow read and write of this attribute in manifest entry. The logic of populating sort order id in writers from table attribute is not included here and will be the main focus for the next PR, as doing so will likely requires a lot of signature changes.\nQuestions\n\nNot sure if sort order should be nullable by default or  0 (fromunsorted_order): decided as nullable for now, as I think positional delete files shouldn't have sort order (since they should be sorted by file_path and position per spec)\nDo we want only sort order id, or actual sort order struct? Id itself is good for comparison but when merging data/delete files I think we do need the actual sort order struct. Without including it in manifest entries, I think we may need to do an additional lookup of the table to fetch it, which could slow down the query.\nFor the next PR, do we assume the table's current sort order id is the authoritative place to get sort order information when adding a new file?  I wonder if engine is ever possible/allowed to override the default sort order to unsorted and pass it back to data/delete writer.", "createdAt": "2020-12-23T02:45:19Z", "url": "https://github.com/apache/iceberg/pull/1975", "merged": true, "mergeCommit": {"oid": "9bd18f4667c51c0c74d26a26dfbac83da22942c3"}, "closed": true, "closedAt": "2021-02-03T01:46:52Z", "author": {"login": "yyanyy"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdo1lDngH2gAyNTQ0NTExOTgyOmQ4Y2Y4NTJiMDMwYTE4OGU1N2M3ZTJlOTJlNmE1YjVmOGM2NDU5YTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd2WQmFgFqTU4MTkzODMyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d8cf852b030a188e57c7e2e92e6a5b5f8c6459a3", "author": {"user": {"login": "yyanyy", "name": null}}, "url": "https://github.com/apache/iceberg/commit/d8cf852b030a188e57c7e2e92e6a5b5f8c6459a3", "committedDate": "2020-12-23T02:19:39Z", "message": "Core: add sort order id to content file interface"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MjY2MjM2", "url": "https://github.com/apache/iceberg/pull/1975#pullrequestreview-559266236", "createdAt": "2020-12-28T19:03:01Z", "commit": {"oid": "d8cf852b030a188e57c7e2e92e6a5b5f8c6459a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxOTowMzowMlrOIMADaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxOTowMzowMlrOIMADaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ1NDY5Ng==", "bodyText": "What about withSortOrder? Is there a case where we would only have the ID and not the SortOrder? Just trying to think of what will be convenient. We could always expose both methods.", "url": "https://github.com/apache/iceberg/pull/1975#discussion_r549454696", "createdAt": "2020-12-28T19:03:02Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/DataFiles.java", "diffHunk": "@@ -268,6 +271,11 @@ public Builder withEncryptionKeyMetadata(EncryptionKeyMetadata newKeyMetadata) {\n       return withEncryptionKeyMetadata(newKeyMetadata.buffer());\n     }\n \n+    public Builder withSortOrderId(int newSortOrderId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8cf852b030a188e57c7e2e92e6a5b5f8c6459a3"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MjY3NTMy", "url": "https://github.com/apache/iceberg/pull/1975#pullrequestreview-559267532", "createdAt": "2020-12-28T19:07:19Z", "commit": {"oid": "d8cf852b030a188e57c7e2e92e6a5b5f8c6459a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxOTowNzoxOVrOIMAH-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxOTowNzoxOVrOIMAH-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ1NTg2Ng==", "bodyText": "We will also need to add this to the spec.", "url": "https://github.com/apache/iceberg/pull/1975#discussion_r549455866", "createdAt": "2020-12-28T19:07:19Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/DataFile.java", "diffHunk": "@@ -61,11 +61,12 @@\n       \"Splittable offsets\");\n   Types.NestedField EQUALITY_IDS = optional(135, \"equality_ids\", ListType.ofRequired(136, IntegerType.get()),\n       \"Equality comparison field IDs\");\n+  Types.NestedField SORT_ORDER_ID = optional(140, \"sort_order_id\", IntegerType.get(), \"Sort order ID\");\n \n   int PARTITION_ID = 102;\n   String PARTITION_NAME = \"partition\";\n   String PARTITION_DOC = \"Partition data tuple, schema based on the partition spec\";\n-  // NEXT ID TO ASSIGN: 140\n+  // NEXT ID TO ASSIGN: 141", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8cf852b030a188e57c7e2e92e6a5b5f8c6459a3"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MjY3ODM2", "url": "https://github.com/apache/iceberg/pull/1975#pullrequestreview-559267836", "createdAt": "2020-12-28T19:08:15Z", "commit": {"oid": "d8cf852b030a188e57c7e2e92e6a5b5f8c6459a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxOTowODoxNVrOIMAI9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxOTowODoxNVrOIMAI9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ1NjExNw==", "bodyText": "Could you add this after equalityFieldIds instead of here? The copy methods should be last because they aren't fields in the file.", "url": "https://github.com/apache/iceberg/pull/1975#discussion_r549456117", "createdAt": "2020-12-28T19:08:15Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/ContentFile.java", "diffHunk": "@@ -141,4 +141,13 @@\n    *         null value counts, or nan value counts\n    */\n   F copyWithoutStats();\n+\n+  /**\n+   * Returns the sort order id of this file, which describes how the file is ordered.\n+   * This information will be useful for merging data and equality delete files more efficiently\n+   * when they share the same sort order id.\n+   */\n+  default Integer sortOrderId() {\n+    return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8cf852b030a188e57c7e2e92e6a5b5f8c6459a3"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MjY3OTIx", "url": "https://github.com/apache/iceberg/pull/1975#pullrequestreview-559267921", "createdAt": "2020-12-28T19:08:33Z", "commit": {"oid": "d8cf852b030a188e57c7e2e92e6a5b5f8c6459a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxOTowODozM1rOIMAJUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxOTowODozM1rOIMAJUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ1NjIxMA==", "bodyText": "Do we need a default?", "url": "https://github.com/apache/iceberg/pull/1975#discussion_r549456210", "createdAt": "2020-12-28T19:08:33Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/ContentFile.java", "diffHunk": "@@ -141,4 +141,13 @@\n    *         null value counts, or nan value counts\n    */\n   F copyWithoutStats();\n+\n+  /**\n+   * Returns the sort order id of this file, which describes how the file is ordered.\n+   * This information will be useful for merging data and equality delete files more efficiently\n+   * when they share the same sort order id.\n+   */\n+  default Integer sortOrderId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8cf852b030a188e57c7e2e92e6a5b5f8c6459a3"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cda3d992ab0474fc24f9aa76da81722971c7e024", "author": {"user": {"login": "yyanyy", "name": null}}, "url": "https://github.com/apache/iceberg/commit/cda3d992ab0474fc24f9aa76da81722971c7e024", "committedDate": "2021-01-07T02:37:25Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3NzY0Mzg3", "url": "https://github.com/apache/iceberg/pull/1975#pullrequestreview-567764387", "createdAt": "2021-01-14T00:26:25Z", "commit": {"oid": "cda3d992ab0474fc24f9aa76da81722971c7e024"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQwMDoyNjoyNVrOITKcSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQwMDoyNjoyNVrOITKcSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njk2NDkzNw==", "bodyText": "nit: <p> after the line", "url": "https://github.com/apache/iceberg/pull/1975#discussion_r556964937", "createdAt": "2021-01-14T00:26:25Z", "author": {"login": "jackye1995"}, "path": "api/src/main/java/org/apache/iceberg/ContentFile.java", "diffHunk": "@@ -124,6 +124,14 @@\n    */\n   List<Integer> equalityFieldIds();\n \n+  /**\n+   * Returns the sort order id of this file, which describes how the file is ordered.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cda3d992ab0474fc24f9aa76da81722971c7e024"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxOTMwNjg0", "url": "https://github.com/apache/iceberg/pull/1975#pullrequestreview-581930684", "createdAt": "2021-02-03T01:36:13Z", "commit": {"oid": "cda3d992ab0474fc24f9aa76da81722971c7e024"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTozNjoxM1rOIesCGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTozNjoxM1rOIesCGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTA0OTYyNA==", "bodyText": "Nit: Can you remove this whitespace change? It isn't needed and could cause conflicts.", "url": "https://github.com/apache/iceberg/pull/1975#discussion_r569049624", "createdAt": "2021-02-03T01:36:13Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/ContentFile.java", "diffHunk": "@@ -141,4 +149,5 @@\n    *         null value counts, or nan value counts\n    */\n   F copyWithoutStats();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cda3d992ab0474fc24f9aa76da81722971c7e024"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxOTM2Mzg4", "url": "https://github.com/apache/iceberg/pull/1975#pullrequestreview-581936388", "createdAt": "2021-02-03T01:40:04Z", "commit": {"oid": "cda3d992ab0474fc24f9aa76da81722971c7e024"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTo0MDowNFrOIesJZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTo0MDowNFrOIesJZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTA1MTQ5NA==", "bodyText": "What about using value != null ? (int) value : 0?\nThat way, the order is always filled in as early as possible.", "url": "https://github.com/apache/iceberg/pull/1975#discussion_r569051494", "createdAt": "2021-02-03T01:40:04Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseFile.java", "diffHunk": "@@ -270,6 +273,9 @@ public void put(int i, Object value) {\n         this.equalityIds = ArrayUtil.toIntArray((List<Integer>) value);\n         return;\n       case 15:\n+        this.sortOrderId = (Integer) value;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cda3d992ab0474fc24f9aa76da81722971c7e024"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxOTM2NzEx", "url": "https://github.com/apache/iceberg/pull/1975#pullrequestreview-581936711", "createdAt": "2021-02-03T01:40:54Z", "commit": {"oid": "cda3d992ab0474fc24f9aa76da81722971c7e024"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTo0MDo1NFrOIesMLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTo0MDo1NFrOIesMLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTA1MjIwNQ==", "bodyText": "I think this can be an int because we have a default that is always valid, 0.", "url": "https://github.com/apache/iceberg/pull/1975#discussion_r569052205", "createdAt": "2021-02-03T01:40:54Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseFile.java", "diffHunk": "@@ -73,6 +73,7 @@ public PartitionData copy() {\n   private long[] splitOffsets = null;\n   private int[] equalityIds = null;\n   private byte[] keyMetadata = null;\n+  private Integer sortOrderId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cda3d992ab0474fc24f9aa76da81722971c7e024"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxOTM2ODkw", "url": "https://github.com/apache/iceberg/pull/1975#pullrequestreview-581936890", "createdAt": "2021-02-03T01:41:24Z", "commit": {"oid": "cda3d992ab0474fc24f9aa76da81722971c7e024"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTo0MToyNVrOIesNmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTo0MToyNVrOIesNmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTA1MjU3MA==", "bodyText": "Looks good.", "url": "https://github.com/apache/iceberg/pull/1975#discussion_r569052570", "createdAt": "2021-02-03T01:41:25Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/DataFiles.java", "diffHunk": "@@ -268,6 +271,13 @@ public Builder withEncryptionKeyMetadata(EncryptionKeyMetadata newKeyMetadata) {\n       return withEncryptionKeyMetadata(newKeyMetadata.buffer());\n     }\n \n+    public Builder withSortOrder(SortOrder newSortOrder) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cda3d992ab0474fc24f9aa76da81722971c7e024"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxOTM4MzI1", "url": "https://github.com/apache/iceberg/pull/1975#pullrequestreview-581938325", "createdAt": "2021-02-03T01:45:11Z", "commit": {"oid": "cda3d992ab0474fc24f9aa76da81722971c7e024"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3316, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}