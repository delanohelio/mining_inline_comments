{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0ODU0ODUy", "number": 1796, "title": "Core: Add table property to disable garbage collection", "bodyText": "This PR adds a table property to disable garbage collection.", "createdAt": "2020-11-20T17:35:21Z", "url": "https://github.com/apache/iceberg/pull/1796", "merged": true, "mergeCommit": {"oid": "3a0cc769a2f5859a0f930a7d9a026c86cd52546a"}, "closed": true, "closedAt": "2020-11-20T21:13:31Z", "author": {"login": "aokolnychyi"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdebGQZAFqTUzNTY1MDQyOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdedckggFqTUzNTc1NzUzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NjUwNDI4", "url": "https://github.com/apache/iceberg/pull/1796#pullrequestreview-535650428", "createdAt": "2020-11-20T17:49:14Z", "commit": {"oid": "9d0168cbfc551b43211f410aa8793dbc46eb1d0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNzo0OToxNFrOH3af1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNzo0OToxNFrOH3af1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg2Nzg2MQ==", "bodyText": "I like this. We can also add a property to require the action is used instead of the table operation to ensure that we use reachability instead of incremental changes.", "url": "https://github.com/apache/iceberg/pull/1796#discussion_r527867861", "createdAt": "2020-11-20T17:49:14Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/TableProperties.java", "diffHunk": "@@ -134,4 +134,7 @@ private TableProperties() {\n \n   public static final String ENGINE_HIVE_ENABLED = \"engine.hive.enabled\";\n   public static final boolean ENGINE_HIVE_ENABLED_DEFAULT = false;\n+\n+  public static final String GC_ENABLED = \"gc.enabled\";\n+  public static final boolean GC_ENABLED_DEFAULT = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d0168cbfc551b43211f410aa8793dbc46eb1d0b"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NjUwODIx", "url": "https://github.com/apache/iceberg/pull/1796#pullrequestreview-535650821", "createdAt": "2020-11-20T17:49:47Z", "commit": {"oid": "9d0168cbfc551b43211f410aa8793dbc46eb1d0b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NjU3MTE3", "url": "https://github.com/apache/iceberg/pull/1796#pullrequestreview-535657117", "createdAt": "2020-11-20T17:57:35Z", "commit": {"oid": "9d0168cbfc551b43211f410aa8793dbc46eb1d0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNzo1NzozNlrOH3a7Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNzo1NzozNlrOH3a7Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg3NDkxOQ==", "bodyText": "I think it's still ok to put in instructions for disabling this parameter as a workaround. Just helps a user to know how to unblock themselves just in case. Also nit: \"Cannot expire snapshots\" would follow our pattern for errors in other places", "url": "https://github.com/apache/iceberg/pull/1796#discussion_r527874919", "createdAt": "2020-11-20T17:57:36Z", "author": {"login": "RussellSpitzer"}, "path": "core/src/main/java/org/apache/iceberg/RemoveSnapshots.java", "diffHunk": "@@ -78,6 +81,13 @@ public void accept(String file) {\n   RemoveSnapshots(TableOperations ops) {\n     this.ops = ops;\n     this.base = ops.current();\n+\n+    ValidationException.check(\n+        PropertyUtil.propertyAsBoolean(base.properties(), GC_ENABLED, GC_ENABLED_DEFAULT),\n+        \"Not allowed to expire snapshots as the garbage collection is disabled for this table. \" +\n+        \"Make sure this table is the exclusive owner of its data files before allowing garbage collection. \" +\n+        \"If the table was created using the SNAPSHOT operation, it is not safe to expire snapshots in it since \" +\n+        \"this may remove files in the original table.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d0168cbfc551b43211f410aa8793dbc46eb1d0b"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NjU5NDMz", "url": "https://github.com/apache/iceberg/pull/1796#pullrequestreview-535659433", "createdAt": "2020-11-20T17:59:09Z", "commit": {"oid": "9d0168cbfc551b43211f410aa8793dbc46eb1d0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNzo1OTowOVrOH3bAIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNzo1OTowOVrOH3bAIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg3NjEzMA==", "bodyText": "nit 'the' not needed: Not allowed to expire snapshots as garbage collection is disabled for this table.", "url": "https://github.com/apache/iceberg/pull/1796#discussion_r527876130", "createdAt": "2020-11-20T17:59:09Z", "author": {"login": "RussellSpitzer"}, "path": "core/src/main/java/org/apache/iceberg/RemoveSnapshots.java", "diffHunk": "@@ -78,6 +81,13 @@ public void accept(String file) {\n   RemoveSnapshots(TableOperations ops) {\n     this.ops = ops;\n     this.base = ops.current();\n+\n+    ValidationException.check(\n+        PropertyUtil.propertyAsBoolean(base.properties(), GC_ENABLED, GC_ENABLED_DEFAULT),\n+        \"Not allowed to expire snapshots as the garbage collection is disabled for this table. \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d0168cbfc551b43211f410aa8793dbc46eb1d0b"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1Njg5MTEx", "url": "https://github.com/apache/iceberg/pull/1796#pullrequestreview-535689111", "createdAt": "2020-11-20T18:43:26Z", "commit": {"oid": "9d0168cbfc551b43211f410aa8793dbc46eb1d0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxODo0MzoyNlrOH3cnxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxODo0MzoyNlrOH3cnxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkwMjY2MQ==", "bodyText": "Hmm... I'm struggling a bit with someone being allowed to update this in certain cases. It seems like a very sharp edge to expose/suggest.", "url": "https://github.com/apache/iceberg/pull/1796#discussion_r527902661", "createdAt": "2020-11-20T18:43:26Z", "author": {"login": "jacques-n"}, "path": "core/src/main/java/org/apache/iceberg/RemoveSnapshots.java", "diffHunk": "@@ -78,6 +81,13 @@ public void accept(String file) {\n   RemoveSnapshots(TableOperations ops) {\n     this.ops = ops;\n     this.base = ops.current();\n+\n+    ValidationException.check(\n+        PropertyUtil.propertyAsBoolean(base.properties(), GC_ENABLED, GC_ENABLED_DEFAULT),\n+        \"Not allowed to expire snapshots as the garbage collection is disabled for this table. \" +\n+        \"Make sure this table is the exclusive owner of its data files before allowing garbage collection. \" +\n+        \"If the table was created using the SNAPSHOT operation, it is not safe to expire snapshots in it since \" +\n+        \"this may remove files in the original table.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg3NDkxOQ=="}, "originalCommit": {"oid": "9d0168cbfc551b43211f410aa8793dbc46eb1d0b"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd96e51f6863d04523fb48f4630f2f3309df9d11", "author": {"user": {"login": "aokolnychyi", "name": "Anton Okolnychyi"}}, "url": "https://github.com/apache/iceberg/commit/bd96e51f6863d04523fb48f4630f2f3309df9d11", "committedDate": "2020-11-20T20:09:46Z", "message": "Core: Add table property to disable garbage collection"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d0168cbfc551b43211f410aa8793dbc46eb1d0b", "author": {"user": {"login": "aokolnychyi", "name": "Anton Okolnychyi"}}, "url": "https://github.com/apache/iceberg/commit/9d0168cbfc551b43211f410aa8793dbc46eb1d0b", "committedDate": "2020-11-20T17:29:38Z", "message": "Core: Add table property to disable garbage collection"}, "afterCommit": {"oid": "bd96e51f6863d04523fb48f4630f2f3309df9d11", "author": {"user": {"login": "aokolnychyi", "name": "Anton Okolnychyi"}}, "url": "https://github.com/apache/iceberg/commit/bd96e51f6863d04523fb48f4630f2f3309df9d11", "committedDate": "2020-11-20T20:09:46Z", "message": "Core: Add table property to disable garbage collection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7219b184b9f4f780ef79e481411488bb811fd77b", "author": {"user": {"login": "aokolnychyi", "name": "Anton Okolnychyi"}}, "url": "https://github.com/apache/iceberg/commit/7219b184b9f4f780ef79e481411488bb811fd77b", "committedDate": "2020-11-20T20:12:45Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "593930576b55c2360542b81f2a3e49a06765805b", "author": {"user": {"login": "aokolnychyi", "name": "Anton Okolnychyi"}}, "url": "https://github.com/apache/iceberg/commit/593930576b55c2360542b81f2a3e49a06765805b", "committedDate": "2020-11-20T20:14:47Z", "message": "Fix check description"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NzU3NTM3", "url": "https://github.com/apache/iceberg/pull/1796#pullrequestreview-535757537", "createdAt": "2020-11-20T20:33:25Z", "commit": {"oid": "593930576b55c2360542b81f2a3e49a06765805b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3380, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}