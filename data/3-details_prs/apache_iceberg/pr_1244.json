{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NTA5MTY4", "number": 1244, "title": "Allow ExpireSnapshots to run without Deleting Files", "bodyText": "Previously ExpireSnapshots would always follow the expiration of Snapshots\nwith a deletion of local DataFiles and Manifests which were no longer relevant\nto the Table. This patch introduces an API to skip this deletion phase, which\nwas always run locally, and instead just expire the snapshots. This allows for\nfuture implementations which can read and remove unused files in parallel or\non distributed frameworks.", "createdAt": "2020-07-24T22:04:28Z", "url": "https://github.com/apache/iceberg/pull/1244", "merged": true, "mergeCommit": {"oid": "c5b08eb228499db089d5d4698dd241a60bad955c"}, "closed": true, "closedAt": "2020-07-28T19:40:51Z", "author": {"login": "RussellSpitzer"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4MQR4gFqTQ1NTIyNjEzNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5bG7PABqjM1OTU3Mzc2OTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjI2MTM2", "url": "https://github.com/apache/iceberg/pull/1244#pullrequestreview-455226136", "createdAt": "2020-07-24T23:02:28Z", "commit": {"oid": "7af6a37446c054d8983aae5db91350dd9c70e56b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzowMjoyOVrOG2_4fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzowMjoyOVrOG2_4fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMyMjk0Mg==", "bodyText": "It seems kind of counterintuitive to pass a deleteWith but still expect that the files won't be deleted?\nWhat about defining a default method instead which does nothing eg: doNothing, and make it available as a handy reference which people could use instead? So it would look something like table.expireSnapshots().deleteWith(doNothing)", "url": "https://github.com/apache/iceberg/pull/1244#discussion_r460322942", "createdAt": "2020-07-24T23:02:29Z", "author": {"login": "moulimukherjee"}, "path": "core/src/test/java/org/apache/iceberg/TestRemoveSnapshots.java", "diffHunk": "@@ -472,6 +472,55 @@ public void dataFilesCleanup() throws IOException {\n     Assert.assertTrue(\"FILE_B should be deleted\", deletedFiles.contains(FILE_B.path().toString()));\n   }\n \n+  @Test\n+  public void noDataFileCleanup() throws IOException {\n+    table.newFastAppend()\n+        .appendFile(FILE_A)\n+        .commit();\n+\n+    table.newFastAppend()\n+        .appendFile(FILE_B)\n+        .commit();\n+\n+    table.newRewrite()\n+        .rewriteFiles(ImmutableSet.of(FILE_B), ImmutableSet.of(FILE_D))\n+        .commit();\n+    long thirdSnapshotId = table.currentSnapshot().snapshotId();\n+\n+    table.newRewrite()\n+        .rewriteFiles(ImmutableSet.of(FILE_A), ImmutableSet.of(FILE_C))\n+        .commit();\n+    long fourthSnapshotId = table.currentSnapshot().snapshotId();\n+\n+    long t4 = System.currentTimeMillis();\n+    while (t4 <= table.currentSnapshot().timestampMillis()) {\n+      t4 = System.currentTimeMillis();\n+    }\n+\n+    List<ManifestFile> manifests = table.currentSnapshot().dataManifests();\n+\n+    ManifestFile newManifest = writeManifest(\n+        \"manifest-file-1.avro\",\n+        manifestEntry(Status.EXISTING, thirdSnapshotId, FILE_C),\n+        manifestEntry(Status.EXISTING, fourthSnapshotId, FILE_D));\n+\n+    RewriteManifests rewriteManifests = table.rewriteManifests();\n+    manifests.forEach(rewriteManifests::deleteManifest);\n+    rewriteManifests.addManifest(newManifest);\n+    rewriteManifests.commit();\n+\n+    Set<String> deletedFiles = Sets.newHashSet();\n+\n+    table.expireSnapshots()\n+        .deleteExpiredFiles(false)\n+        .expireOlderThan(t4)\n+        .deleteWith(deletedFiles::add)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7af6a37446c054d8983aae5db91350dd9c70e56b"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTQ3Njcz", "url": "https://github.com/apache/iceberg/pull/1244#pullrequestreview-455947673", "createdAt": "2020-07-27T16:33:55Z", "commit": {"oid": "7af6a37446c054d8983aae5db91350dd9c70e56b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNjozMzo1NVrOG3qWbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNjozMzo1NVrOG3qWbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxODczMg==", "bodyText": "Nit: No need for </p> in Javadoc.", "url": "https://github.com/apache/iceberg/pull/1244#discussion_r461018732", "createdAt": "2020-07-27T16:33:55Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/ExpireSnapshots.java", "diffHunk": "@@ -82,4 +82,16 @@\n    * @return this for method chaining\n    */\n   ExpireSnapshots deleteWith(Consumer<String> deleteFunc);\n+\n+  /**\n+   * Allows expiration of snapshots without any cleanup of underlying manifest or data files.\n+   * <p>\n+   * Allows control in removing data and manifest files which may be more efficiently removed using\n+   * a distributed framework through the actions API.\n+   * </p>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7af6a37446c054d8983aae5db91350dd9c70e56b"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTQ4Mzcx", "url": "https://github.com/apache/iceberg/pull/1244#pullrequestreview-455948371", "createdAt": "2020-07-27T16:34:50Z", "commit": {"oid": "7af6a37446c054d8983aae5db91350dd9c70e56b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNjozNDo1MFrOG3qYew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNjozNDo1MFrOG3qYew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxOTI1OQ==", "bodyText": "Should this be cleanExpiredFiles instead? I think that makes more sense because this actually avoids the work of finding the files that have expired, not calling delete for them. And that's what you call it elsewhere, so it makes sense to me.", "url": "https://github.com/apache/iceberg/pull/1244#discussion_r461019259", "createdAt": "2020-07-27T16:34:50Z", "author": {"login": "rdblue"}, "path": "api/src/main/java/org/apache/iceberg/ExpireSnapshots.java", "diffHunk": "@@ -82,4 +82,16 @@\n    * @return this for method chaining\n    */\n   ExpireSnapshots deleteWith(Consumer<String> deleteFunc);\n+\n+  /**\n+   * Allows expiration of snapshots without any cleanup of underlying manifest or data files.\n+   * <p>\n+   * Allows control in removing data and manifest files which may be more efficiently removed using\n+   * a distributed framework through the actions API.\n+   * </p>\n+   *\n+   * @param clean setting this to false will skip deleting expired manifests and files\n+   * @return this for method chaining\n+   */\n+  ExpireSnapshots deleteExpiredFiles(boolean clean);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7af6a37446c054d8983aae5db91350dd9c70e56b"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTUwNjkw", "url": "https://github.com/apache/iceberg/pull/1244#pullrequestreview-455950690", "createdAt": "2020-07-27T16:37:58Z", "commit": {"oid": "7af6a37446c054d8983aae5db91350dd9c70e56b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNjozNzo1OFrOG3qflQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNjozNzo1OFrOG3qflQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAyMTA3Nw==", "bodyText": "Why rewrite manifests? It seems like the intent was to rewrite manifests so that the manifests from the third and fourth snapshots can be deleted, then to add assertions that the metadata files are also not cleaned.", "url": "https://github.com/apache/iceberg/pull/1244#discussion_r461021077", "createdAt": "2020-07-27T16:37:58Z", "author": {"login": "rdblue"}, "path": "core/src/test/java/org/apache/iceberg/TestRemoveSnapshots.java", "diffHunk": "@@ -472,6 +472,55 @@ public void dataFilesCleanup() throws IOException {\n     Assert.assertTrue(\"FILE_B should be deleted\", deletedFiles.contains(FILE_B.path().toString()));\n   }\n \n+  @Test\n+  public void noDataFileCleanup() throws IOException {\n+    table.newFastAppend()\n+        .appendFile(FILE_A)\n+        .commit();\n+\n+    table.newFastAppend()\n+        .appendFile(FILE_B)\n+        .commit();\n+\n+    table.newRewrite()\n+        .rewriteFiles(ImmutableSet.of(FILE_B), ImmutableSet.of(FILE_D))\n+        .commit();\n+    long thirdSnapshotId = table.currentSnapshot().snapshotId();\n+\n+    table.newRewrite()\n+        .rewriteFiles(ImmutableSet.of(FILE_A), ImmutableSet.of(FILE_C))\n+        .commit();\n+    long fourthSnapshotId = table.currentSnapshot().snapshotId();\n+\n+    long t4 = System.currentTimeMillis();\n+    while (t4 <= table.currentSnapshot().timestampMillis()) {\n+      t4 = System.currentTimeMillis();\n+    }\n+\n+    List<ManifestFile> manifests = table.currentSnapshot().dataManifests();\n+\n+    ManifestFile newManifest = writeManifest(\n+        \"manifest-file-1.avro\",\n+        manifestEntry(Status.EXISTING, thirdSnapshotId, FILE_C),\n+        manifestEntry(Status.EXISTING, fourthSnapshotId, FILE_D));\n+\n+    RewriteManifests rewriteManifests = table.rewriteManifests();\n+    manifests.forEach(rewriteManifests::deleteManifest);\n+    rewriteManifests.addManifest(newManifest);\n+    rewriteManifests.commit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7af6a37446c054d8983aae5db91350dd9c70e56b"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTUxMDc1", "url": "https://github.com/apache/iceberg/pull/1244#pullrequestreview-455951075", "createdAt": "2020-07-27T16:38:30Z", "commit": {"oid": "7af6a37446c054d8983aae5db91350dd9c70e56b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNjozODozMVrOG3qgvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNjozODozMVrOG3qgvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAyMTM3NQ==", "bodyText": "It would be good to have an assertion for at least one of the manifests that isn't deleted as well.\nAlternatively, you could just assert that deletedFiles.isEmpty()", "url": "https://github.com/apache/iceberg/pull/1244#discussion_r461021375", "createdAt": "2020-07-27T16:38:31Z", "author": {"login": "rdblue"}, "path": "core/src/test/java/org/apache/iceberg/TestRemoveSnapshots.java", "diffHunk": "@@ -472,6 +472,55 @@ public void dataFilesCleanup() throws IOException {\n     Assert.assertTrue(\"FILE_B should be deleted\", deletedFiles.contains(FILE_B.path().toString()));\n   }\n \n+  @Test\n+  public void noDataFileCleanup() throws IOException {\n+    table.newFastAppend()\n+        .appendFile(FILE_A)\n+        .commit();\n+\n+    table.newFastAppend()\n+        .appendFile(FILE_B)\n+        .commit();\n+\n+    table.newRewrite()\n+        .rewriteFiles(ImmutableSet.of(FILE_B), ImmutableSet.of(FILE_D))\n+        .commit();\n+    long thirdSnapshotId = table.currentSnapshot().snapshotId();\n+\n+    table.newRewrite()\n+        .rewriteFiles(ImmutableSet.of(FILE_A), ImmutableSet.of(FILE_C))\n+        .commit();\n+    long fourthSnapshotId = table.currentSnapshot().snapshotId();\n+\n+    long t4 = System.currentTimeMillis();\n+    while (t4 <= table.currentSnapshot().timestampMillis()) {\n+      t4 = System.currentTimeMillis();\n+    }\n+\n+    List<ManifestFile> manifests = table.currentSnapshot().dataManifests();\n+\n+    ManifestFile newManifest = writeManifest(\n+        \"manifest-file-1.avro\",\n+        manifestEntry(Status.EXISTING, thirdSnapshotId, FILE_C),\n+        manifestEntry(Status.EXISTING, fourthSnapshotId, FILE_D));\n+\n+    RewriteManifests rewriteManifests = table.rewriteManifests();\n+    manifests.forEach(rewriteManifests::deleteManifest);\n+    rewriteManifests.addManifest(newManifest);\n+    rewriteManifests.commit();\n+\n+    Set<String> deletedFiles = Sets.newHashSet();\n+\n+    table.expireSnapshots()\n+        .deleteExpiredFiles(false)\n+        .expireOlderThan(t4)\n+        .deleteWith(deletedFiles::add)\n+        .commit();\n+\n+    Assert.assertFalse(\"FILE_A should not be deleted\", deletedFiles.contains(FILE_A.path().toString()));\n+    Assert.assertFalse(\"FILE_B should not be deleted\", deletedFiles.contains(FILE_B.path().toString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7af6a37446c054d8983aae5db91350dd9c70e56b"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTg1ODAw", "url": "https://github.com/apache/iceberg/pull/1244#pullrequestreview-455985800", "createdAt": "2020-07-27T17:24:05Z", "commit": {"oid": "7af6a37446c054d8983aae5db91350dd9c70e56b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c76e3cb999606296e812b51ed2271a232f2ae3f3", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/c76e3cb999606296e812b51ed2271a232f2ae3f3", "committedDate": "2020-07-28T15:42:43Z", "message": "Allow ExpireSnapshots to run without Deleting Files\n\nPreviously ExpireSnapshots would always follow the expiration of Snapshots\nwith a deletion of local DataFiles and Manifests which were no longer relevant\nto the Table. This patch introduces an API to skip this deletion phase, which\nwas always run locally, and instead just expire the snapshots. This allows for\nfuture implementations which can read and remove unused files in parallel or\non distributed frameworks."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7af6a37446c054d8983aae5db91350dd9c70e56b", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/7af6a37446c054d8983aae5db91350dd9c70e56b", "committedDate": "2020-07-24T20:13:16Z", "message": "Allow ExpireSnapshots to run without Deleting Files\n\nPreviously ExpireSnapshots would always follow the expiration of Snapshots\nwith a deletion of local DataFiles and Manifests which were no longer relevant\nto the Table. This patch introduces an API to skip this deletion phase, which\nwas always run locally, and instead just expire the snapshots. This allows for\nfuture implementations which can read and remove unused files in parallel or\non distributed frameworks."}, "afterCommit": {"oid": "16db43aac5cc80a4991b9597f99638d8809b1dad", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/16db43aac5cc80a4991b9597f99638d8809b1dad", "committedDate": "2020-07-28T16:21:41Z", "message": "Comments from Review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2ODE2NjYw", "url": "https://github.com/apache/iceberg/pull/1244#pullrequestreview-456816660", "createdAt": "2020-07-28T16:40:49Z", "commit": {"oid": "16db43aac5cc80a4991b9597f99638d8809b1dad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjo0MDo0OVrOG4VPtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjo0MDo0OVrOG4VPtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcyMTUyNw==", "bodyText": "nit: is this added deliberately?", "url": "https://github.com/apache/iceberg/pull/1244#discussion_r461721527", "createdAt": "2020-07-28T16:40:49Z", "author": {"login": "aokolnychyi"}, "path": "api/src/main/java/org/apache/iceberg/ExpireSnapshots.java", "diffHunk": "@@ -97,4 +97,16 @@\n    * @return this for method chaining\n    */\n   ExpireSnapshots executeWith(ExecutorService executorService);\n+\n+  /**\n+   * Allows expiration of snapshots without any cleanup of underlying manifest or data files.\n+   * <p>\n+   * Allows control in removing data and manifest files which may be more efficiently removed using\n+   * a distributed framework through the actions API.\n+   * <p>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16db43aac5cc80a4991b9597f99638d8809b1dad"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2ODIyMjQ4", "url": "https://github.com/apache/iceberg/pull/1244#pullrequestreview-456822248", "createdAt": "2020-07-28T16:47:54Z", "commit": {"oid": "16db43aac5cc80a4991b9597f99638d8809b1dad"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16db43aac5cc80a4991b9597f99638d8809b1dad", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/16db43aac5cc80a4991b9597f99638d8809b1dad", "committedDate": "2020-07-28T16:21:41Z", "message": "Comments from Review"}, "afterCommit": {"oid": "015bda72d3bab4da58f85227129acb7320c271eb", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/015bda72d3bab4da58f85227129acb7320c271eb", "committedDate": "2020-07-28T16:55:01Z", "message": "Comments from Review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e533b4b94fb6e0fe411535ab4bef8751cb3586d3", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/e533b4b94fb6e0fe411535ab4bef8751cb3586d3", "committedDate": "2020-07-28T18:54:36Z", "message": "Comments from Review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "015bda72d3bab4da58f85227129acb7320c271eb", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/015bda72d3bab4da58f85227129acb7320c271eb", "committedDate": "2020-07-28T16:55:01Z", "message": "Comments from Review"}, "afterCommit": {"oid": "e533b4b94fb6e0fe411535ab4bef8751cb3586d3", "author": {"user": {"login": "RussellSpitzer", "name": "Russell Spitzer"}}, "url": "https://github.com/apache/iceberg/commit/e533b4b94fb6e0fe411535ab4bef8751cb3586d3", "committedDate": "2020-07-28T18:54:36Z", "message": "Comments from Review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4333, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}