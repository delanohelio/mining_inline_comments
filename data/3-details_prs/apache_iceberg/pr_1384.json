{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczNzI1MTY4", "number": 1384, "title": "Remove a wrong check for commit operation", "bodyText": "Related to issue: #1370\nI think this is check is just to reduce the commit times, but it may cause some other problems.", "createdAt": "2020-08-26T08:00:30Z", "url": "https://github.com/apache/iceberg/pull/1384", "merged": true, "mergeCommit": {"oid": "8fddd4a89e25dd5ff74069ab17d62dfcbe638b14"}, "closed": true, "closedAt": "2020-09-03T16:19:46Z", "author": {"login": "simonsssu"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdC07QKAFqTQ3NjE3MTA2OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFKhJpgBqjM3MjMwODMwNDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2MTcxMDY4", "url": "https://github.com/apache/iceberg/pull/1384#pullrequestreview-476171068", "createdAt": "2020-08-27T00:04:51Z", "commit": {"oid": "030673c685440e0cf2c3a3f3ca0dcbab04fad43d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwMDowNDo1MVrOHHmK2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwMDowNDo1MVrOHHmK2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzcyNzQ0OA==", "bodyText": "How about also updating internalApply so that it does this check?\nThis is intended to only modify the table and run a commit if the table changes. But you're right that when combined with a transaction, this will cause a failure because commit is not called at all.\nBut we still want to avoid unnecessary commits. To do that, internalApply should do this check on the new TableMetadata it produces. If the new metadata has the same set of manifests as the original, then it should return the original. That will cause the commit to be skipped in most cases because the actual commit logic inside of ops.commit checks whether the metadata is the same as the base metadata and returns if it is.", "url": "https://github.com/apache/iceberg/pull/1384#discussion_r477727448", "createdAt": "2020-08-27T00:04:51Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/RemoveSnapshots.java", "diffHunk": "@@ -156,10 +156,7 @@ public void commit() {\n         .onlyRetryOn(CommitFailedException.class)\n         .run(item -> {\n           TableMetadata updated = internalApply();\n-          // only commit the updated metadata if at least one snapshot was removed\n-          if (updated.snapshots().size() != base.snapshots().size()) {\n-            ops.commit(base, updated);\n-          }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "030673c685440e0cf2c3a3f3ca0dcbab04fad43d"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84c933595d2772581df1126659dd8bf43cba4449", "author": {"user": null}, "url": "https://github.com/apache/iceberg/commit/84c933595d2772581df1126659dd8bf43cba4449", "committedDate": "2020-08-31T03:44:45Z", "message": "Change check to allow same metadata in commitTransaction"}, "afterCommit": {"oid": "298bef92260e76550b14944c7d081add06bfc0ac", "author": {"user": null}, "url": "https://github.com/apache/iceberg/commit/298bef92260e76550b14944c7d081add06bfc0ac", "committedDate": "2020-08-31T09:13:05Z", "message": "Change check in commit transaction to allow pass same meta"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NDY3OTc1", "url": "https://github.com/apache/iceberg/pull/1384#pullrequestreview-478467975", "createdAt": "2020-08-31T09:46:36Z", "commit": {"oid": "298bef92260e76550b14944c7d081add06bfc0ac"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwOTo0NjozNlrOHJx4_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMTozMTo1NVrOHJ1I_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAxNjYzNw==", "bodyText": "nit: useless change.", "url": "https://github.com/apache/iceberg/pull/1384#discussion_r480016637", "createdAt": "2020-08-31T09:46:36Z", "author": {"login": "chenjunjiedada"}, "path": "core/src/main/java/org/apache/iceberg/BaseTransaction.java", "diffHunk": "@@ -451,7 +452,6 @@ public void commit(TableMetadata underlyingBase, TableMetadata metadata) {\n       }\n \n       BaseTransaction.this.current = metadata;\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "298bef92260e76550b14944c7d081add06bfc0ac"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA0OTI0MA==", "bodyText": "Can we compare the snapshot ID\uff1f", "url": "https://github.com/apache/iceberg/pull/1384#discussion_r480049240", "createdAt": "2020-08-31T10:56:12Z", "author": {"login": "chenjunjiedada"}, "path": "core/src/main/java/org/apache/iceberg/RemoveSnapshots.java", "diffHunk": "@@ -138,10 +138,23 @@ public ExpireSnapshots executeDeleteWith(ExecutorService executorService) {\n   private TableMetadata internalApply() {\n     this.base = ops.refresh();\n \n-    return base.removeSnapshotsIf(snapshot ->\n+    TableMetadata updated = base.removeSnapshotsIf(snapshot ->\n         idsToRemove.contains(snapshot.snapshotId()) ||\n         (expireOlderThan != null && snapshot.timestampMillis() < expireOlderThan &&\n             !idsToRetain.contains(snapshot.snapshotId())));\n+\n+    List<Snapshot> updateSnapshots = updated.snapshots();\n+    List<Snapshot> baseSnapshots = base.snapshots();\n+    if (updateSnapshots.size() != baseSnapshots.size()) {\n+      return updated;\n+    } else {\n+      for (int i = 0; i < baseSnapshots.size(); i += 1) {\n+        if (!updateSnapshots.get(i).equals(baseSnapshots.get(i))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "298bef92260e76550b14944c7d081add06bfc0ac"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA2OTg4NA==", "bodyText": "You could keep the commitTransaction", "url": "https://github.com/apache/iceberg/pull/1384#discussion_r480069884", "createdAt": "2020-08-31T11:31:55Z", "author": {"login": "chenjunjiedada"}, "path": "core/src/test/java/org/apache/iceberg/TestCreateTransaction.java", "diffHunk": "@@ -267,10 +267,6 @@ public void testCreateDetectsUncommittedChangeOnCommit() throws IOException {\n         TestTables.metadataVersion(\"uncommitted_change\"));\n \n     txn.updateProperties().set(\"test-property\", \"test-value\"); // not committed\n-\n-    AssertHelpers.assertThrows(\"Should reject commit when last operation has not committed\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "298bef92260e76550b14944c7d081add06bfc0ac"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "298bef92260e76550b14944c7d081add06bfc0ac", "author": {"user": null}, "url": "https://github.com/apache/iceberg/commit/298bef92260e76550b14944c7d081add06bfc0ac", "committedDate": "2020-08-31T09:13:05Z", "message": "Change check in commit transaction to allow pass same meta"}, "afterCommit": {"oid": "610c1238fa4a63a24592710e858a1d995f3d9299", "author": {"user": null}, "url": "https://github.com/apache/iceberg/commit/610c1238fa4a63a24592710e858a1d995f3d9299", "committedDate": "2020-08-31T12:40:10Z", "message": "Change check in commit transaction to allow pass same meta"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4ODE4MzQz", "url": "https://github.com/apache/iceberg/pull/1384#pullrequestreview-478818343", "createdAt": "2020-08-31T17:49:53Z", "commit": {"oid": "610c1238fa4a63a24592710e858a1d995f3d9299"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzo0OTo1M1rOHKCiYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzo0OTo1M1rOHKCiYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI4OTM3OQ==", "bodyText": "I don't think this block is needed. The contract of removeSnapshotsIf is to only remove snapshots or return the list unmodified. We can rely on that and just check that the size hasn't changed.", "url": "https://github.com/apache/iceberg/pull/1384#discussion_r480289379", "createdAt": "2020-08-31T17:49:53Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/RemoveSnapshots.java", "diffHunk": "@@ -138,10 +138,23 @@ public ExpireSnapshots executeDeleteWith(ExecutorService executorService) {\n   private TableMetadata internalApply() {\n     this.base = ops.refresh();\n \n-    return base.removeSnapshotsIf(snapshot ->\n+    TableMetadata updated = base.removeSnapshotsIf(snapshot ->\n         idsToRemove.contains(snapshot.snapshotId()) ||\n         (expireOlderThan != null && snapshot.timestampMillis() < expireOlderThan &&\n             !idsToRetain.contains(snapshot.snapshotId())));\n+\n+    List<Snapshot> updateSnapshots = updated.snapshots();\n+    List<Snapshot> baseSnapshots = base.snapshots();\n+    if (updateSnapshots.size() != baseSnapshots.size()) {\n+      return updated;\n+    } else {\n+      for (int i = 0; i < baseSnapshots.size(); i += 1) {\n+        if (!updateSnapshots.get(i).equals(baseSnapshots.get(i))) {\n+          return updated;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "610c1238fa4a63a24592710e858a1d995f3d9299"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4ODIxOTg5", "url": "https://github.com/apache/iceberg/pull/1384#pullrequestreview-478821989", "createdAt": "2020-08-31T17:55:14Z", "commit": {"oid": "610c1238fa4a63a24592710e858a1d995f3d9299"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzo1NToxNVrOHKCtqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzo1NToxNVrOHKCtqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI5MjI2NQ==", "bodyText": "I think this test case is still valid.\nThe problem is that this was previously assuming that the table metadata would change when each of the operations in a transaction is committed. That's not necessarily the case.\nInstead of getting rid of the check that each operation committed, we just need to track that it committed differently. I think that means we should replace lastBase in BaseTransaction with a boolean hasComitted that gets set to false each time a new operation is created inside of checkLastOperationCommitted.", "url": "https://github.com/apache/iceberg/pull/1384#discussion_r480292265", "createdAt": "2020-08-31T17:55:15Z", "author": {"login": "rdblue"}, "path": "core/src/test/java/org/apache/iceberg/TestCreateTransaction.java", "diffHunk": "@@ -268,9 +268,13 @@ public void testCreateDetectsUncommittedChangeOnCommit() throws IOException {\n \n     txn.updateProperties().set(\"test-property\", \"test-value\"); // not committed\n \n-    AssertHelpers.assertThrows(\"Should reject commit when last operation has not committed\",\n-        IllegalStateException.class, \"Cannot commit transaction: last operation has not committed\",\n-        txn::commitTransaction);\n+    txn.commitTransaction();\n+\n+    // nothing to commit.\n+    Assert.assertNull(\"Starting a create transaction should not commit metadata\",\n+        TestTables.readMetadata(\"uncommitted_change\"));\n+    Assert.assertNull(\"Should have no metadata version\",\n+        TestTables.metadataVersion(\"uncommitted_change\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "610c1238fa4a63a24592710e858a1d995f3d9299"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4ODIzODcx", "url": "https://github.com/apache/iceberg/pull/1384#pullrequestreview-478823871", "createdAt": "2020-08-31T17:58:06Z", "commit": {"oid": "610c1238fa4a63a24592710e858a1d995f3d9299"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzo1ODowNlrOHKCzuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzo1ODowNlrOHKCzuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI5MzgxNg==", "bodyText": "This isn't correct:\n\nSkipping the commit should be done in TableOperations, not here. This logic is incorrect because lastBase is not the current table state, it is the state after the previous operation in the transaction. This logic would skip the rest of the operations in a transaction if the last one didn't make any changes.\nThis still needs to check that the last operation had commit called on it. Otherwise, incomplete operations could be added and would be ignored instead of raising exceptions.", "url": "https://github.com/apache/iceberg/pull/1384#discussion_r480293816", "createdAt": "2020-08-31T17:58:06Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/BaseTransaction.java", "diffHunk": "@@ -200,9 +200,10 @@ public ExpireSnapshots expireSnapshots() {\n \n   @Override\n   public void commitTransaction() {\n-    Preconditions.checkState(lastBase != current,\n-        \"Cannot commit transaction: last operation has not committed\");\n-\n+    if (lastBase == current) {\n+      LOG.info(\"Nothing to commit.\");\n+      return;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "610c1238fa4a63a24592710e858a1d995f3d9299"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2eb2c43b7f0d47eccb3287c72e508f8a9e959738", "author": {"user": null}, "url": "https://github.com/apache/iceberg/commit/2eb2c43b7f0d47eccb3287c72e508f8a9e959738", "committedDate": "2020-09-03T06:19:44Z", "message": "Fix commit failed if retainLast larger than current snapshot nums"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "610c1238fa4a63a24592710e858a1d995f3d9299", "author": {"user": null}, "url": "https://github.com/apache/iceberg/commit/610c1238fa4a63a24592710e858a1d995f3d9299", "committedDate": "2020-08-31T12:40:10Z", "message": "Change check in commit transaction to allow pass same meta"}, "afterCommit": {"oid": "2eb2c43b7f0d47eccb3287c72e508f8a9e959738", "author": {"user": null}, "url": "https://github.com/apache/iceberg/commit/2eb2c43b7f0d47eccb3287c72e508f8a9e959738", "committedDate": "2020-09-03T06:19:44Z", "message": "Fix commit failed if retainLast larger than current snapshot nums"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4114, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}