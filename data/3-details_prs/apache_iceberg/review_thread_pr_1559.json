{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MDU2MDE0", "number": 1559, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NDo1NVrOErDpVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNjoyMzowOFrOEzYMqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTgzOTU5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NDo1NVrOHdm_eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NDo1NVrOHdm_eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgwOTU5Mg==", "bodyText": "I would go for an uniq name here so 2 concurrent commits will not interfere", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500809592", "createdAt": "2020-10-07T07:54:55Z", "author": {"login": "pvary"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,25 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      if (fs.exists(versionHintFile)) {\n+        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a09525b142ae249a2e4e75df0aae8eaf75a242f"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTg0NjAyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NjoyOFrOHdnDWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NjoyOFrOHdnDWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgxMDU4NA==", "bodyText": "Formatting checks might fail here.\nI have learned that it is worth to run checkstyle checks before committing:\n./gradlew build -x test", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500810584", "createdAt": "2020-10-07T07:56:28Z", "author": {"login": "pvary"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,25 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      if (fs.exists(versionHintFile)) {\n+        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );\n+        writeFileToPath(fs, tempVersionHintFile);\n+        fs.delete(versionHintFile, false);\n+        fs.rename(tempVersionHintFile, versionHintFile);\n+      } else {\n+        writeFileToPath(fs, versionHintFile);\n+      }\n     } catch (IOException e) {\n       LOG.warn(\"Failed to update version hint\", e);\n     }\n   }\n \n+  private void writeFileToPath(FileSystem fs, Path path) throws IOException{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a09525b142ae249a2e4e75df0aae8eaf75a242f"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTg0OTg5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NzozMFrOHdnFxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1NzozMFrOHdnFxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgxMTIwNQ==", "bodyText": "We might want to close the stream here (try with resources block can help)", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500811205", "createdAt": "2020-10-07T07:57:30Z", "author": {"login": "pvary"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,25 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      if (fs.exists(versionHintFile)) {\n+        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );\n+        writeFileToPath(fs, tempVersionHintFile);\n+        fs.delete(versionHintFile, false);\n+        fs.rename(tempVersionHintFile, versionHintFile);\n+      } else {\n+        writeFileToPath(fs, versionHintFile);\n+      }\n     } catch (IOException e) {\n       LOG.warn(\"Failed to update version hint\", e);\n     }\n   }\n \n+  private void writeFileToPath(FileSystem fs, Path path) throws IOException{\n+    FSDataOutputStream out = fs.create(path, true /* overwrite */);\n+    out.write(String.valueOf(path).getBytes(StandardCharsets.UTF_8));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a09525b142ae249a2e4e75df0aae8eaf75a242f"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNTg1MTgyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1ODowMVrOHdnG9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwNzo1ODowMVrOHdnG9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgxMTUwOQ==", "bodyText": "Again concurrency can be problematic here", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500811509", "createdAt": "2020-10-07T07:58:01Z", "author": {"login": "pvary"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,25 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      if (fs.exists(versionHintFile)) {\n+        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );\n+        writeFileToPath(fs, tempVersionHintFile);\n+        fs.delete(versionHintFile, false);\n+        fs.rename(tempVersionHintFile, versionHintFile);\n+      } else {\n+        writeFileToPath(fs, versionHintFile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a09525b142ae249a2e4e75df0aae8eaf75a242f"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNjE5NDM1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwOToyMzowM1rOHdqaiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMToyNjozN1rOHdut4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2NTY3Mg==", "bodyText": "I wouldn't set overwrite to true to ensure this doesn't break anything. (In practice it won't, but it should be much clearer with overwrite = false.)", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500865672", "createdAt": "2020-10-07T09:23:03Z", "author": {"login": "HeartSaVioR"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -295,22 +295,19 @@ private void writeVersionHint(int versionToWrite) {\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n     try {\n-      if (fs.exists(versionHintFile)) {\n-        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );\n-        writeFileToPath(fs, tempVersionHintFile);\n-        fs.delete(versionHintFile, false);\n-        fs.rename(tempVersionHintFile, versionHintFile);\n-      } else {\n-        writeFileToPath(fs, versionHintFile);\n-      }\n+      Path tempVersionHintFile = metadataPath(UUID.randomUUID().toString() + \"-version-hint.temp\");\n+      writeVersionToPath(fs, tempVersionHintFile, versionToWrite);\n+      fs.delete(versionHintFile, false);\n+      fs.rename(tempVersionHintFile, versionHintFile);\n     } catch (IOException e) {\n       LOG.warn(\"Failed to update version hint\", e);\n     }\n   }\n \n-  private void writeFileToPath(FileSystem fs, Path path) throws IOException{\n-    FSDataOutputStream out = fs.create(path, true /* overwrite */);\n-    out.write(String.valueOf(path).getBytes(StandardCharsets.UTF_8));\n+  private void writeVersionToPath(FileSystem fs, Path path, int versionToWrite) throws IOException {\n+    try (FSDataOutputStream out = fs.create(path, true /* overwrite */)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09fa44bf01463a36ae22ad384abe75c84809a3a1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzNjE2Mg==", "bodyText": "Thanks for the review. Done", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500936162", "createdAt": "2020-10-07T11:26:37Z", "author": {"login": "lcspinter"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -295,22 +295,19 @@ private void writeVersionHint(int versionToWrite) {\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n     try {\n-      if (fs.exists(versionHintFile)) {\n-        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );\n-        writeFileToPath(fs, tempVersionHintFile);\n-        fs.delete(versionHintFile, false);\n-        fs.rename(tempVersionHintFile, versionHintFile);\n-      } else {\n-        writeFileToPath(fs, versionHintFile);\n-      }\n+      Path tempVersionHintFile = metadataPath(UUID.randomUUID().toString() + \"-version-hint.temp\");\n+      writeVersionToPath(fs, tempVersionHintFile, versionToWrite);\n+      fs.delete(versionHintFile, false);\n+      fs.rename(tempVersionHintFile, versionHintFile);\n     } catch (IOException e) {\n       LOG.warn(\"Failed to update version hint\", e);\n     }\n   }\n \n-  private void writeFileToPath(FileSystem fs, Path path) throws IOException{\n-    FSDataOutputStream out = fs.create(path, true /* overwrite */);\n-    out.write(String.valueOf(path).getBytes(StandardCharsets.UTF_8));\n+  private void writeVersionToPath(FileSystem fs, Path path, int versionToWrite) throws IOException {\n+    try (FSDataOutputStream out = fs.create(path, true /* overwrite */)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2NTY3Mg=="}, "originalCommit": {"oid": "09fa44bf01463a36ae22ad384abe75c84809a3a1"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMjEwNTA1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMToxNDo1NlrOHnepBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMToxNDo1NlrOHnepBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1ODUzNQ==", "bodyText": "Boolean parameters need inline comments to explain what they are. What does false here do?", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r511158535", "createdAt": "2020-10-23T21:14:56Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,22 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      Path tempVersionHintFile = metadataPath(UUID.randomUUID().toString() + \"-version-hint.temp\");\n+      writeVersionToPath(fs, tempVersionHintFile, versionToWrite);\n+      fs.delete(versionHintFile, false);\n+      fs.rename(tempVersionHintFile, versionHintFile);\n     } catch (IOException e) {\n       LOG.warn(\"Failed to update version hint\", e);\n     }\n   }\n \n+  private void writeVersionToPath(FileSystem fs, Path path, int versionToWrite) throws IOException {\n+    try (FSDataOutputStream out = fs.create(path, false)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f087434f602e8644353fc798369d11bd78387c29"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzA5Mjg4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNjoyMzowOFrOHqkC1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNjoyNzozNVrOHqkPvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM5Mjc5MQ==", "bodyText": "This one needs a comment to clarify false as well.", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r514392791", "createdAt": "2020-10-29T16:23:08Z", "author": {"login": "rdblue"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,22 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      Path tempVersionHintFile = metadataPath(UUID.randomUUID().toString() + \"-version-hint.temp\");\n+      writeVersionToPath(fs, tempVersionHintFile, versionToWrite);\n+      fs.delete(versionHintFile, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "716e86b182abff566aeb7e032924627ec97c36d6"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM5NjA5NQ==", "bodyText": "Thanks. Fixed it.", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r514396095", "createdAt": "2020-10-29T16:27:35Z", "author": {"login": "lcspinter"}, "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,22 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      Path tempVersionHintFile = metadataPath(UUID.randomUUID().toString() + \"-version-hint.temp\");\n+      writeVersionToPath(fs, tempVersionHintFile, versionToWrite);\n+      fs.delete(versionHintFile, false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM5Mjc5MQ=="}, "originalCommit": {"oid": "716e86b182abff566aeb7e032924627ec97c36d6"}, "originalPosition": 9}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3573, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}