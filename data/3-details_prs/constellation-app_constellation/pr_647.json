{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1OTc4MDE0", "number": 647, "title": "Feature/issue 574 invalid delimited import", "bodyText": "Description of the Change\nHandle potential errors that could occur when importing delimited files, these are grouped into 3 categories:\n\nInvalid files are selected to add to source files.\nFiles that are already listed in source pane become invalid or are deleted and are selected by user in source pane.\nFiles that are already listed in source pane become invalid or are deleted and user presses import button.\n\nThe basic approahc is to try and elimiate invalid files as early as possible, but still be aware that files can change subsequent to being selected.\nRather than letting unhandled exceptions bubble up to the plugin code, catch these invalid files and use neat error dialogs that come to the front of screen, rather than being hidden under the Import Delimited File dialog.\nIe:\n\n\n\nAlternate Designs\nLeaving code as is and allowign errors to be thrown.\nWhy Should This Be In Core?\nBetter user experience for users importing delimited files.\nBenefits\nAs above\nPossible Drawbacks\nNone known\nVerification Process\nTesting of the following:\n\nInvalid files are selected to add to source files.\n\n\nOpen Delimited File Importer, select JSON or XML (easy to generate invalid test files for these) press the plus button, and select one valid and one invalid file.\nconfirm a warning dialog is displayed, and that after pressong OK, only the valid file is added to the list in the source pane.\n\n\nFiles that are already listed in source pane become invalid or are deleted and are selected by user in source pane.|\n\n\nOpen Delimited File Importer, select JSON or XML (easy to generate invalid test files for these) press the plus button, and select two valid files.\nConfirm no errors are detected and both appear in the source file list.\nOn disk delete or invalidate the contents of the file NOT being previewed in the source pane.\nSelect the now invalid (or missing) file in the source pane and confirm an warning dialog is displayed and that the file is removed from the source pane\n\n3a. Files that are already listed in source pane become invalid or are deleted and user presses import button.\n\nOpen Delimited File Importer, select JSON or XML (easy to generate invalid test files for these) press the plus button, and select two valid files.\nConfirm no errors are detected and both appear in the source file list.\nMap one or more fileds in the action pane.\nInvalidate or delete one of the files on disk and press the Import button.\nConfirm a warning dialog is shown and no exception dialogs thrown.\n\n3b. Files that are already listed in source pane become invalid or are deleted and user presses import button.\n\nOpen Delimited File Importer, select JSON or XML (easy to generate invalid test files for these) press the plus button, and select two valid files.\nConfirm no errors are detected and both appear in the source file list.\nMap one or more fileds in the action pane.\nConfirm an info dialog is shown documenting number of rows imported. (Note rows could be duplicated, so number of data rows does not always equate to number of nodes/edges).\n\nApplicable Issues\n#574\n#606", "createdAt": "2020-07-08T05:23:14Z", "url": "https://github.com/constellation-app/constellation/pull/647", "merged": true, "mergeCommit": {"oid": "6afad9c6220bb361a7a1f98543e15912f147ff46"}, "closed": true, "closedAt": "2020-07-10T13:08:12Z", "author": {"login": "serpens24"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyb7kkAH2gAyNDQ1OTc4MDE0OmUzODg3YjhkYjM1ZWY4ODU3M2MwODQ4MDYyMDlkYTlhN2Q0YmJmZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczix9vAH2gAyNDQ1OTc4MDE0OjMyN2MyZmIyYjhhODM0OGU1ZTFkMzk1NWM4ODk5MTAyZWJhYWRiMTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e3887b8db35ef88573c084806209da9a7d4bbfe8", "author": {"user": null}, "url": "https://github.com/constellation-app/constellation/commit/e3887b8db35ef88573c084806209da9a7d4bbfe8", "committedDate": "2020-07-07T01:54:48Z", "message": "Update SourcePane.java\n\nAdded checks for invalid file import selection."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fdf467c36c3e44a6dc7761632b8c5e6e47a8642", "author": {"user": null}, "url": "https://github.com/constellation-app/constellation/commit/0fdf467c36c3e44a6dc7761632b8c5e6e47a8642", "committedDate": "2020-07-07T01:56:52Z", "message": "Update SourcePane.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "327592a821a9c05f8ef544004c0a1b0ef94b1d3f", "author": {"user": null}, "url": "https://github.com/constellation-app/constellation/commit/327592a821a9c05f8ef544004c0a1b0ef94b1d3f", "committedDate": "2020-07-07T01:58:45Z", "message": "Update SourcePane.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52ee68c0c5f66a016d907cbfa6778b08a1b0e52d", "author": {"user": null}, "url": "https://github.com/constellation-app/constellation/commit/52ee68c0c5f66a016d907cbfa6778b08a1b0e52d", "committedDate": "2020-07-07T02:04:37Z", "message": "Update SourcePane.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e00b11be1fd592f5bb70af5152aa77bc0a419f49", "author": {"user": null}, "url": "https://github.com/constellation-app/constellation/commit/e00b11be1fd592f5bb70af5152aa77bc0a419f49", "committedDate": "2020-07-07T22:47:18Z", "message": "As much as possible try to avoid issues when swapping between existing file list items if they have been corrupted/deleted under the covers."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6278e521866181f54695d863ceaa9687a3b6110", "author": {"user": null}, "url": "https://github.com/constellation-app/constellation/commit/b6278e521866181f54695d863ceaa9687a3b6110", "committedDate": "2020-07-08T04:47:27Z", "message": "Added common alert dialog handling to be used. Handle invalid files in source list when import is pressed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0ed1241df96ddc172ce6a01c4af777aad3396d8", "author": {"user": {"login": "serpens24", "name": "serpens2406"}}, "url": "https://github.com/constellation-app/constellation/commit/d0ed1241df96ddc172ce6a01c4af777aad3396d8", "committedDate": "2020-07-08T05:24:46Z", "message": "Merge branch 'master' into feature/Issue_574-Invalid-Delimited-Import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "512236173af54168b8afcf45485d54c704187fcd", "author": {"user": null}, "url": "https://github.com/constellation-app/constellation/commit/512236173af54168b8afcf45485d54c704187fcd", "committedDate": "2020-07-08T06:00:53Z", "message": "SonarQube fixes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NDM2NDcx", "url": "https://github.com/constellation-app/constellation/pull/647#pullrequestreview-444436471", "createdAt": "2020-07-08T06:05:59Z", "commit": {"oid": "512236173af54168b8afcf45485d54c704187fcd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNjowNTo1OVrOGuZXqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNjoxNzozMVrOGuZm8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwMzMzOQ==", "bodyText": "Add Final String warningMsg", "url": "https://github.com/constellation-app/constellation/pull/647#discussion_r451303339", "createdAt": "2020-07-08T06:05:59Z", "author": {"login": "aldebaran30701"}, "path": "CoreImportExportPlugins/src/au/gov/asd/tac/constellation/plugins/importexport/delimited/ImportController.java", "diffHunk": "@@ -449,9 +470,19 @@ private void updateSampleData() {\n                 currentColumns = new String[columns.length + 1];\n                 System.arraycopy(columns, 0, currentColumns, 1, columns.length);\n                 currentColumns[0] = \"Row\";\n-            } catch (IOException ex) {\n-                final NotifyDescriptor nd = new NotifyDescriptor.Message(ex.getMessage(), NotifyDescriptor.WARNING_MESSAGE);\n-                DialogDisplayer.getDefault().notify(nd);\n+            } catch (FileNotFoundException ex) {\n+                String warningMsg = \"The following file could not be found and has been excluded from the import set:\\n  \" + sampleFile.getPath();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "512236173af54168b8afcf45485d54c704187fcd"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwMzQwMQ==", "bodyText": "Add a final", "url": "https://github.com/constellation-app/constellation/pull/647#discussion_r451303401", "createdAt": "2020-07-08T06:06:14Z", "author": {"login": "aldebaran30701"}, "path": "CoreImportExportPlugins/src/au/gov/asd/tac/constellation/plugins/importexport/delimited/ImportController.java", "diffHunk": "@@ -449,9 +470,19 @@ private void updateSampleData() {\n                 currentColumns = new String[columns.length + 1];\n                 System.arraycopy(columns, 0, currentColumns, 1, columns.length);\n                 currentColumns[0] = \"Row\";\n-            } catch (IOException ex) {\n-                final NotifyDescriptor nd = new NotifyDescriptor.Message(ex.getMessage(), NotifyDescriptor.WARNING_MESSAGE);\n-                DialogDisplayer.getDefault().notify(nd);\n+            } catch (FileNotFoundException ex) {\n+                String warningMsg = \"The following file could not be found and has been excluded from the import set:\\n  \" + sampleFile.getPath();\n+                LOGGER.log(Level.INFO, warningMsg);\n+                displayAlert(\"Invalid file selected\", warningMsg, Alert.AlertType.WARNING);\n+                files.remove(sampleFile);\n+                stage.getSourcePane().removeFile(sampleFile);\n+            }\n+            catch (IOException ex) {\n+                String warningMsg = \"The following file could not be parsed and has been excluded from the import set:\\n  \" + sampleFile.getPath();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "512236173af54168b8afcf45485d54c704187fcd"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwMzkyOQ==", "bodyText": "Make parameters final", "url": "https://github.com/constellation-app/constellation/pull/647#discussion_r451303929", "createdAt": "2020-07-08T06:07:49Z", "author": {"login": "aldebaran30701"}, "path": "CoreImportExportPlugins/src/au/gov/asd/tac/constellation/plugins/importexport/delimited/ImportDelimitedPlugin.java", "diffHunk": "@@ -112,6 +115,58 @@ public PluginParameters createParameters() {\n \n         return params;\n     }\n+    \n+    /**\n+     * Build up an import summary dialog detailing successful and unsuccessful file imports.\n+     * \n+     * @param title Title to add to status dialog\n+     * @param importedRows Number of rows successfully imported (from valid files)\n+     * @param validFilenames List of filenames that were imported from\n+     * @param invalidFilenames List of files that couldn't be opened/parsed. We try to limit this possibility by pre-screening\n+     *                         files during the initial file selection.\n+     */\n+    private void displaySummaryAlert(int importedRows, List<String> validFilenames, List<String> invalidFilenames) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "512236173af54168b8afcf45485d54c704187fcd"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwNDc0OQ==", "bodyText": "Make both lists final", "url": "https://github.com/constellation-app/constellation/pull/647#discussion_r451304749", "createdAt": "2020-07-08T06:10:23Z", "author": {"login": "aldebaran30701"}, "path": "CoreImportExportPlugins/src/au/gov/asd/tac/constellation/plugins/importexport/delimited/ImportDelimitedPlugin.java", "diffHunk": "@@ -124,33 +179,50 @@ protected void edit(final GraphWriteMethods graph, final PluginInteraction inter\n         final PluginParameters parserParameters = (PluginParameters) parameters.getParameters().get(PARSER_PARAMETER_IDS_PARAMETER_ID).getObjectValue();\n         final List<Integer> newVertices = new ArrayList<>();\n         boolean positionalAtrributesExist = false;\n+        List<String> validFiles = new ArrayList<>();\n+        List<String> invalidFiles = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "512236173af54168b8afcf45485d54c704187fcd"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwNDg5Mg==", "bodyText": "final", "url": "https://github.com/constellation-app/constellation/pull/647#discussion_r451304892", "createdAt": "2020-07-08T06:10:42Z", "author": {"login": "aldebaran30701"}, "path": "CoreImportExportPlugins/src/au/gov/asd/tac/constellation/plugins/importexport/delimited/ImportDelimitedPlugin.java", "diffHunk": "@@ -124,33 +179,50 @@ protected void edit(final GraphWriteMethods graph, final PluginInteraction inter\n         final PluginParameters parserParameters = (PluginParameters) parameters.getParameters().get(PARSER_PARAMETER_IDS_PARAMETER_ID).getObjectValue();\n         final List<Integer> newVertices = new ArrayList<>();\n         boolean positionalAtrributesExist = false;\n+        List<String> validFiles = new ArrayList<>();\n+        List<String> invalidFiles = new ArrayList<>();\n+        int importRows = 0;\n \n         for (final File file : files) {\n             interaction.setProgress(0, 0, \"Reading File: \" + file.getName(), true);\n             List<String[]> data = null;\n+            \n             try {\n                 data = parser.parse(new InputSource(file), parserParameters);\n+                importRows = importRows + data.size() - 1;\n+                validFiles.add(file.getPath());\n+                LOGGER.log(Level.INFO, \"Imported {0} rows of data from file {1}. {2} total rows imported\", new Object[]{(data.size() - 1), file.getPath(), importRows});\n+            } catch (FileNotFoundException ex) {\n+                String errorMsg = file.getPath() + \" could not be found. Ignoring file during import.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "512236173af54168b8afcf45485d54c704187fcd"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwNDk0MQ==", "bodyText": "final", "url": "https://github.com/constellation-app/constellation/pull/647#discussion_r451304941", "createdAt": "2020-07-08T06:10:53Z", "author": {"login": "aldebaran30701"}, "path": "CoreImportExportPlugins/src/au/gov/asd/tac/constellation/plugins/importexport/delimited/ImportDelimitedPlugin.java", "diffHunk": "@@ -124,33 +179,50 @@ protected void edit(final GraphWriteMethods graph, final PluginInteraction inter\n         final PluginParameters parserParameters = (PluginParameters) parameters.getParameters().get(PARSER_PARAMETER_IDS_PARAMETER_ID).getObjectValue();\n         final List<Integer> newVertices = new ArrayList<>();\n         boolean positionalAtrributesExist = false;\n+        List<String> validFiles = new ArrayList<>();\n+        List<String> invalidFiles = new ArrayList<>();\n+        int importRows = 0;\n \n         for (final File file : files) {\n             interaction.setProgress(0, 0, \"Reading File: \" + file.getName(), true);\n             List<String[]> data = null;\n+            \n             try {\n                 data = parser.parse(new InputSource(file), parserParameters);\n+                importRows = importRows + data.size() - 1;\n+                validFiles.add(file.getPath());\n+                LOGGER.log(Level.INFO, \"Imported {0} rows of data from file {1}. {2} total rows imported\", new Object[]{(data.size() - 1), file.getPath(), importRows});\n+            } catch (FileNotFoundException ex) {\n+                String errorMsg = file.getPath() + \" could not be found. Ignoring file during import.\";\n+                LOGGER.log(Level.INFO, errorMsg);\n+                invalidFiles.add(file.getPath());\n             } catch (IOException ex) {\n-                throw new PluginException(this, PluginNotificationLevel.ERROR, \"Error reading file: \" + file.getName(), ex);\n+                String errorMsg = file.getPath() + \" could not be parsed. Removing file during import.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "512236173af54168b8afcf45485d54c704187fcd"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwNTk0MA==", "bodyText": "May as well add a final here\nfor (final File file : newFiles) {", "url": "https://github.com/constellation-app/constellation/pull/647#discussion_r451305940", "createdAt": "2020-07-08T06:13:54Z", "author": {"login": "aldebaran30701"}, "path": "CoreImportExportPlugins/src/au/gov/asd/tac/constellation/plugins/importexport/delimited/SourcePane.java", "diffHunk": "@@ -155,11 +161,24 @@ public SourcePane(final ImportController importController) {\n                     SourcePane.this.importFileParserComboBox.setDisable(true);\n                 }\n                 ObservableList<File> files = FXCollections.observableArrayList(fileListView.getItems());\n+                String warningMsg = \"The following files could not be parsed and have been excluded from import set:\";\n+                boolean foundInvalidFile = false;\n                 for (File file : newFiles) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "512236173af54168b8afcf45485d54c704187fcd"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwNjcwNQ==", "bodyText": "I know this isn't your change but maybe adding a final here?", "url": "https://github.com/constellation-app/constellation/pull/647#discussion_r451306705", "createdAt": "2020-07-08T06:15:55Z", "author": {"login": "aldebaran30701"}, "path": "CoreImportExportPlugins/src/au/gov/asd/tac/constellation/plugins/importexport/delimited/SourcePane.java", "diffHunk": "@@ -155,11 +161,24 @@ public SourcePane(final ImportController importController) {\n                     SourcePane.this.importFileParserComboBox.setDisable(true);\n                 }\n                 ObservableList<File> files = FXCollections.observableArrayList(fileListView.getItems());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "512236173af54168b8afcf45485d54c704187fcd"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwNzI1MA==", "bodyText": "final", "url": "https://github.com/constellation-app/constellation/pull/647#discussion_r451307250", "createdAt": "2020-07-08T06:17:31Z", "author": {"login": "aldebaran30701"}, "path": "CoreImportExportPlugins/src/au/gov/asd/tac/constellation/plugins/importexport/delimited/SourcePane.java", "diffHunk": "@@ -252,6 +268,16 @@ public void setParameters(final PluginParameters parameters) {\n             parametersPane.getChildren().add(pluginParametersPane);\n         }\n     }\n+    \n+    /** Allow a file to be removed from fileListView. This would be triggered by code in InputController if the file\n+     * was found to be missing or invalid - these checks are triggered when a new file is selected in the fileListView.\n+     * @param file The file to remove.\n+     */\n+    public void removeFile(File file) {\n+        ObservableList<File> files = fileListView.getItems();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "512236173af54168b8afcf45485d54c704187fcd"}, "originalPosition": 117}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ba441a08914817bc793c64f644c2e0e6b6b749f", "author": {"user": null}, "url": "https://github.com/constellation-app/constellation/commit/9ba441a08914817bc793c64f644c2e0e6b6b749f", "committedDate": "2020-07-08T07:27:42Z", "message": "aldebaran review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MjA4MTQ2", "url": "https://github.com/constellation-app/constellation/pull/647#pullrequestreview-445208146", "createdAt": "2020-07-09T00:10:05Z", "commit": {"oid": "9ba441a08914817bc793c64f644c2e0e6b6b749f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4b743b8418bdc2fe98c71027e543388a51485b2", "author": {"user": {"login": "formalhaut69", "name": null}}, "url": "https://github.com/constellation-app/constellation/commit/e4b743b8418bdc2fe98c71027e543388a51485b2", "committedDate": "2020-07-09T01:32:02Z", "message": "Fixed the help icon"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "327c2fb2b8a8348e5e1d3955c8899102ebaadb17", "author": {"user": {"login": "arcturus2", "name": null}}, "url": "https://github.com/constellation-app/constellation/commit/327c2fb2b8a8348e5e1d3955c8899102ebaadb17", "committedDate": "2020-07-10T12:27:34Z", "message": "Merge branch 'master' into feature/Issue_574-Invalid-Delimited-Import"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3587, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}