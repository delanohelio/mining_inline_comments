{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3MzYzNTQz", "number": 832, "title": "Bugfix/issue189 copy to new graph", "bodyText": "Description of the Change\nBugfix for issue #189\nAdded logic as described in the ticket and some unit tests to cover the changes\nAlternate Designs\nDesign discussed in ticket #189\nWhy Should This Be In Core?\nBugfix\nBenefits\nPossible Drawbacks\nHave not added code to test for long filenames and the prompt the user may encounter.\nVerification Process\nAdded unit test\nApplicable Issues\n#189", "createdAt": "2020-09-01T22:07:19Z", "url": "https://github.com/constellation-app/constellation/pull/832", "merged": true, "mergeCommit": {"oid": "4180763b4a916c56fe5a580453fcc5265e490c3a"}, "closed": true, "closedAt": "2020-10-21T06:53:36Z", "author": {"login": "GCHQDeveloper601"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBIdDYAH2gAyNDc3MzYzNTQzOmZjNWEwZjkzNTdlZGUzNDA0ODE0NjZmZjRhNjY0NWEwYjg5ODA3NjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUnu_ugFqTUxMzM1NjE0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fc5a0f9357ede340481466ff4a6645a0b8980766", "author": {"user": {"login": "GCHQDeveloper601", "name": null}}, "url": "https://github.com/constellation-app/constellation/commit/fc5a0f9357ede340481466ff4a6645a0b8980766", "committedDate": "2020-08-21T17:42:08Z", "message": "Added functions to handle copy to nw files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "364292cb5e7d94c2aa08d15a143ba733737bb501", "author": {"user": {"login": "GCHQDeveloper601", "name": null}}, "url": "https://github.com/constellation-app/constellation/commit/364292cb5e7d94c2aa08d15a143ba733737bb501", "committedDate": "2020-08-21T17:45:29Z", "message": "Merge remote-tracking branch 'upstream/master' into issue189_copy_to_new_graph"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "584f1feeb4ee560b851a9af692a5396875b4322e", "author": {"user": {"login": "GCHQDeveloper601", "name": null}}, "url": "https://github.com/constellation-app/constellation/commit/584f1feeb4ee560b851a9af692a5396875b4322e", "committedDate": "2020-08-22T09:48:23Z", "message": "Moved the regex pattern into the function as expect this to not be the used\nvery often so saving on space. Can move this back to a static if this is \ndeemed to be a better choice."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3d428f99e5e190f671cd72a9d927b3aa49f59f6", "author": {"user": {"login": "GCHQDeveloper601", "name": null}}, "url": "https://github.com/constellation-app/constellation/commit/b3d428f99e5e190f671cd72a9d927b3aa49f59f6", "committedDate": "2020-08-22T10:00:05Z", "message": "Code formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c036a6eeb5db127139eb69fd1f33683a20541a76", "author": {"user": {"login": "GCHQDeveloper601", "name": null}}, "url": "https://github.com/constellation-app/constellation/commit/c036a6eeb5db127139eb69fd1f33683a20541a76", "committedDate": "2020-09-01T19:08:07Z", "message": "Merge remote-tracking branch 'upstream/master' into bugfix/issue189_copy_to_new_graph"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afac24c30ab2db181567b36af8e5fac0411ad99b", "author": {"user": {"login": "GCHQDeveloper601", "name": null}}, "url": "https://github.com/constellation-app/constellation/commit/afac24c30ab2db181567b36af8e5fac0411ad99b", "committedDate": "2020-09-01T22:02:37Z", "message": "Fixing some logic errors and adding some unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMzI5MTI5", "url": "https://github.com/constellation-app/constellation/pull/832#pullrequestreview-480329129", "createdAt": "2020-09-02T01:59:04Z", "commit": {"oid": "afac24c30ab2db181567b36af8e5fac0411ad99b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMTo1OTowNVrOHLPTWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMjoxOTowMVrOHLQDaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU0NzA5Ng==", "bodyText": "Since the constructor is private, I would move the instantiation of this constant to the declaration in line 54.\nTo the constructor, I would then add throw new IllegalStateException(\"Utility class\")", "url": "https://github.com/constellation-app/constellation/pull/832#discussion_r481547096", "createdAt": "2020-09-02T01:59:05Z", "author": {"login": "antares1470"}, "path": "CoreGraphFile/src/au/gov/asd/tac/constellation/graph/file/GraphObjectUtilities.java", "diffHunk": "@@ -29,11 +36,28 @@\n  */\n public class GraphObjectUtilities {\n \n+    private static final GraphObjectUtilities graphObjectUtilities = new GraphObjectUtilities();\n+\n+    private GraphObjectUtilities() {\n+        //Adding private to remove code smell\n+        COPY_NAME_MATCHER = Pattern.compile(COPY_STRING_PATTERN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afac24c30ab2db181567b36af8e5fac0411ad99b"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU1NjA4OA==", "bodyText": "Based on what I could see from the usage, I think it would be better to make relevant functions and variables being called static rather than creating a static instance of the class within itself (doing a bit of testing, it seems to work the same).", "url": "https://github.com/constellation-app/constellation/pull/832#discussion_r481556088", "createdAt": "2020-09-02T02:13:36Z", "author": {"login": "antares1470"}, "path": "CoreGraphFile/src/au/gov/asd/tac/constellation/graph/file/GraphObjectUtilities.java", "diffHunk": "@@ -29,11 +36,28 @@\n  */\n public class GraphObjectUtilities {\n \n+    private static final GraphObjectUtilities graphObjectUtilities = new GraphObjectUtilities();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afac24c30ab2db181567b36af8e5fac0411ad99b"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU1OTAwNg==", "bodyText": "if you move the instantiation of COPY_NAME_MATCHER out of the constructor, you should be able to uncomment this line and remove the line above it (you'll probably need to make COPY_NAME_MATCHER  static)", "url": "https://github.com/constellation-app/constellation/pull/832#discussion_r481559006", "createdAt": "2020-09-02T02:18:23Z", "author": {"login": "antares1470"}, "path": "CoreGraphFile/src/au/gov/asd/tac/constellation/graph/file/GraphObjectUtilities.java", "diffHunk": "@@ -61,15 +85,54 @@\n      */\n     public static GraphDataObject createMemoryDataObject(final String name, final boolean numbered) {\n         GraphDataObject gdo = null;\n+        final FileObject root = FILE_SYSTEM.getRoot();\n         try {\n-            final String fnam = numbered ? String.format(\"%s%d%s\", name, ++fileCounter, GraphDataObject.FILE_EXTENSION) : String.format(\"%s%s\", name, GraphDataObject.FILE_EXTENSION);\n-            final FileObject root = FILE_SYSTEM.getRoot();\n+            String fnam = graphObjectUtilities.getNewFileName(name, numbered, root);\n+            while (graphObjectUtilities.isFileNameDuplicateInMemory(fnam, root)) {\n+                //If after all of the above the filename already exists in memory, start again.\n+                fnam = graphObjectUtilities.getNewFileName(fnam, numbered, root);\n+            }\n+            while (fnam.length() >= FILENAME_LENGTH_LIMIT) {\n+                fnam = (String) JOptionPane.showInputDialog(null,\n+                        CHOOSE_FILENAME,\n+                        FILENAME_TITLE,\n+                        JOptionPane.INFORMATION_MESSAGE,\n+                        null,\n+                        null,\n+                        fnam);\n+            }\n+            fnam = String.format(\"%s%s\", fnam, GraphDataObject.FILE_EXTENSION);\n             final FileObject fo = FileUtil.createData(root, fnam);\n             gdo = (GraphDataObject) DataObject.find(fo);\n         } catch (IOException ex) {\n             Exceptions.printStackTrace(ex);\n         }\n-\n         return gdo;\n     }\n+\n+    private String getNewFileName(final String name, final boolean numbered, final FileObject root) {\n+        final List<FileObject> files = Arrays.stream(root.getChildren()).filter(file -> file.getName().equals(name)).collect(Collectors.toList());\n+        if (files.size() > 0) {\n+            if (name.endsWith(COPY_STRING)) {\n+                return String.format(\"%s (%d)\", name, 1);\n+            }\n+\n+            final Matcher matcher = Pattern.compile(COPY_STRING_PATTERN).matcher(name);\n+            //final Matcher matcher =  COPY_NAME_MATCHER.matcher(name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afac24c30ab2db181567b36af8e5fac0411ad99b"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU1OTQwMw==", "bodyText": "Change this to !files.isEmpty(). Should also be able to omit the brackets", "url": "https://github.com/constellation-app/constellation/pull/832#discussion_r481559403", "createdAt": "2020-09-02T02:19:01Z", "author": {"login": "antares1470"}, "path": "CoreGraphFile/src/au/gov/asd/tac/constellation/graph/file/GraphObjectUtilities.java", "diffHunk": "@@ -61,15 +85,54 @@\n      */\n     public static GraphDataObject createMemoryDataObject(final String name, final boolean numbered) {\n         GraphDataObject gdo = null;\n+        final FileObject root = FILE_SYSTEM.getRoot();\n         try {\n-            final String fnam = numbered ? String.format(\"%s%d%s\", name, ++fileCounter, GraphDataObject.FILE_EXTENSION) : String.format(\"%s%s\", name, GraphDataObject.FILE_EXTENSION);\n-            final FileObject root = FILE_SYSTEM.getRoot();\n+            String fnam = graphObjectUtilities.getNewFileName(name, numbered, root);\n+            while (graphObjectUtilities.isFileNameDuplicateInMemory(fnam, root)) {\n+                //If after all of the above the filename already exists in memory, start again.\n+                fnam = graphObjectUtilities.getNewFileName(fnam, numbered, root);\n+            }\n+            while (fnam.length() >= FILENAME_LENGTH_LIMIT) {\n+                fnam = (String) JOptionPane.showInputDialog(null,\n+                        CHOOSE_FILENAME,\n+                        FILENAME_TITLE,\n+                        JOptionPane.INFORMATION_MESSAGE,\n+                        null,\n+                        null,\n+                        fnam);\n+            }\n+            fnam = String.format(\"%s%s\", fnam, GraphDataObject.FILE_EXTENSION);\n             final FileObject fo = FileUtil.createData(root, fnam);\n             gdo = (GraphDataObject) DataObject.find(fo);\n         } catch (IOException ex) {\n             Exceptions.printStackTrace(ex);\n         }\n-\n         return gdo;\n     }\n+\n+    private String getNewFileName(final String name, final boolean numbered, final FileObject root) {\n+        final List<FileObject> files = Arrays.stream(root.getChildren()).filter(file -> file.getName().equals(name)).collect(Collectors.toList());\n+        if (files.size() > 0) {\n+            if (name.endsWith(COPY_STRING)) {\n+                return String.format(\"%s (%d)\", name, 1);\n+            }\n+\n+            final Matcher matcher = Pattern.compile(COPY_STRING_PATTERN).matcher(name);\n+            //final Matcher matcher =  COPY_NAME_MATCHER.matcher(name);\n+            if (matcher.matches()) {\n+                final String fileNamePart = matcher.group(1);\n+                final int copyNum = Integer.parseInt(matcher.group(2));\n+                return String.format(\"%s (%d)\", fileNamePart, copyNum + 1);\n+            }\n+            return String.format(\"%s - Copy\", name);\n+        }\n+        return numbered ? String.format(\"%s%d\", name, ++fileCounter) : String.format(\"%s\", name);\n+    }\n+\n+    private boolean isFileNameDuplicateInMemory(final String name, final FileObject root) {\n+\n+        final String tempName = FilenameUtils.getBaseName(name);\n+        final List<FileObject> files = Arrays.stream(root.getChildren()).filter(file -> file.getName().equals(tempName)).collect(Collectors.toList());\n+        return (files.size() > 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afac24c30ab2db181567b36af8e5fac0411ad99b"}, "originalPosition": 103}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMzkyNzAy", "url": "https://github.com/constellation-app/constellation/pull/832#pullrequestreview-481392702", "createdAt": "2020-09-03T00:05:08Z", "commit": {"oid": "afac24c30ab2db181567b36af8e5fac0411ad99b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "886c73ba4558e2e0c95913107202dd23f2334d6a", "author": {"user": {"login": "GCHQDeveloper601", "name": null}}, "url": "https://github.com/constellation-app/constellation/commit/886c73ba4558e2e0c95913107202dd23f2334d6a", "committedDate": "2020-09-04T18:09:20Z", "message": "Adding changes to reflect the comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81de89a9d099c6eafca43197363d16d800f43204", "author": {"user": {"login": "GCHQDeveloper601", "name": null}}, "url": "https://github.com/constellation-app/constellation/commit/81de89a9d099c6eafca43197363d16d800f43204", "committedDate": "2020-09-04T18:10:56Z", "message": "Removing empty contructor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMTc4MDAx", "url": "https://github.com/constellation-app/constellation/pull/832#pullrequestreview-483178001", "createdAt": "2020-09-06T22:41:35Z", "commit": {"oid": "81de89a9d099c6eafca43197363d16d800f43204"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQyMjo0MTozNVrOHNsenQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQyMjo0MTozNVrOHNsenQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDEyMjI2OQ==", "bodyText": "will want !files.isEmpty() here", "url": "https://github.com/constellation-app/constellation/pull/832#discussion_r484122269", "createdAt": "2020-09-06T22:41:35Z", "author": {"login": "antares1470"}, "path": "CoreGraphFile/src/au/gov/asd/tac/constellation/graph/file/GraphObjectUtilities.java", "diffHunk": "@@ -129,10 +121,10 @@ private String getNewFileName(final String name, final boolean numbered, final F\n         return numbered ? String.format(\"%s%d\", name, ++fileCounter) : String.format(\"%s\", name);\n     }\n \n-    private boolean isFileNameDuplicateInMemory(final String name, final FileObject root) {\n+    private static boolean isFileNameDuplicateInMemory(final String name, final FileObject root) {\n \n         final String tempName = FilenameUtils.getBaseName(name);\n         final List<FileObject> files = Arrays.stream(root.getChildren()).filter(file -> file.getName().equals(tempName)).collect(Collectors.toList());\n-        return (files.size() > 0);\n+        return files.isEmpty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81de89a9d099c6eafca43197363d16d800f43204"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29f76620c12aa702fcea342493c0239a0733c4cc", "author": {"user": {"login": "GCHQDeveloper601", "name": null}}, "url": "https://github.com/constellation-app/constellation/commit/29f76620c12aa702fcea342493c0239a0733c4cc", "committedDate": "2020-09-09T20:36:25Z", "message": "Reversed Boolean check to give correct response for empty files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48881e3220c2715db6e3e29b044b78a6839d2fea", "author": {"user": {"login": "GCHQDeveloper601", "name": null}}, "url": "https://github.com/constellation-app/constellation/commit/48881e3220c2715db6e3e29b044b78a6839d2fea", "committedDate": "2020-09-09T20:37:57Z", "message": "Merge branch 'master' of github.com:constellation-app/constellation into bugfix/issue189_copy_to_new_graph"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTgyNDEy", "url": "https://github.com/constellation-app/constellation/pull/832#pullrequestreview-513182412", "createdAt": "2020-10-20T22:31:08Z", "commit": {"oid": "48881e3220c2715db6e3e29b044b78a6839d2fea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMzU2MTQ4", "url": "https://github.com/constellation-app/constellation/pull/832#pullrequestreview-513356148", "createdAt": "2020-10-21T06:53:21Z", "commit": {"oid": "48881e3220c2715db6e3e29b044b78a6839d2fea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3490, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}