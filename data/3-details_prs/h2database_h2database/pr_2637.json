{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxNjQzMjk2", "number": 2637, "title": "Add table not found candidates in error message", "bodyText": "Hello,\nthis is an attempt to implement #2108 and a similar item from the roadmap.\nI am not sure about using three error codes for the same kind of error. On the other hand this way a machine can interpret the error code and understand the explanation as well.\nI couldn't execute the complete test suite (see PR #2636) so I hope it will build and pass all the tests on Travis.\nLooking forward to your comments.\nI wrote the code, it's mine, and I'm contributing it to H2 for distribution multiple-licensed under the MPL 2.0, and the EPL 1.0 (https://h2database.com/html/license.html).", "createdAt": "2020-05-21T23:51:49Z", "url": "https://github.com/h2database/h2database/pull/2637", "merged": true, "mergeCommit": {"oid": "1d02e84d6bdd0a72cfb4c3eae0baac814c9e4935"}, "closed": true, "closedAt": "2020-05-23T10:34:02Z", "author": {"login": "resident-uhlig"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjme9_gH2gAyNDIxNjQzMjk2OmQxYzdjNTQ1YWI4MzY4NWJmZjg0NTlkMjlkOGFkYjIxYjMyMzI4ZmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcj04-yAH2gAyNDIxNjQzMjk2OjVjM2QwNDRjMjNiNTlhNTc3NjkyNGE0ZTY1MGFmNDIxN2EyZjQ5OWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d1c7c545ab83685bff8459d29d8adb21b32328fe", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/d1c7c545ab83685bff8459d29d8adb21b32328fe", "committedDate": "2020-05-21T23:43:39Z", "message": "feat: #2108 possible candidates if table not found"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5930a67743f7213cfc64aeb22842bb05713927c6", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/5930a67743f7213cfc64aeb22842bb05713927c6", "committedDate": "2020-05-21T23:43:39Z", "message": "feat: #2108 possible candidates if table not found"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2416d21664296aa7c991502733e1ed64bfb6f97e", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/2416d21664296aa7c991502733e1ed64bfb6f97e", "committedDate": "2020-05-21T23:43:39Z", "message": "feat: #2108 don't look for candidates when CASE_INSENSITIVE_IDENTIFIERS=TRUE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97c0bac9b21913f1e8dc6259d46e088ba935adff", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/97c0bac9b21913f1e8dc6259d46e088ba935adff", "committedDate": "2020-05-21T23:43:39Z", "message": "test: #2108 enable tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e74c9773333a5645278e06787678682c9f1f9782", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/e74c9773333a5645278e06787678682c9f1f9782", "committedDate": "2020-05-21T23:43:39Z", "message": "fix: #2108 use DbSettings instead of StaticSettings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb136626e9b2ad859ca13a5ff95d9a907024fd7d", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/eb136626e9b2ad859ca13a5ff95d9a907024fd7d", "committedDate": "2020-05-21T23:43:39Z", "message": "feat: table or view not found if DB is empty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8bb653d789a4ca5febd49110f4972bf70ac4882", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/f8bb653d789a4ca5febd49110f4972bf70ac4882", "committedDate": "2020-05-21T23:43:39Z", "message": "refactor: #2108 rename method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4be49d58bf86df47caf4e599da1a3028fa319c1", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/e4be49d58bf86df47caf4e599da1a3028fa319c1", "committedDate": "2020-05-21T23:43:39Z", "message": "feat: #2108 German translation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c701acb41473ffd026a4e83fd93b33ae605c9dee", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/c701acb41473ffd026a4e83fd93b33ae605c9dee", "committedDate": "2020-05-21T23:45:24Z", "message": "docs: #2108 changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a86f506a73345976bb9338646a38db827df38539", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/a86f506a73345976bb9338646a38db827df38539", "committedDate": "2020-05-21T23:45:24Z", "message": "refactor: #2108 return exception to be thrown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89a3409a4525b7ef8347c3d004fe162720989747", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/89a3409a4525b7ef8347c3d004fe162720989747", "committedDate": "2020-05-21T23:45:24Z", "message": "docs: remove \"table not found when database is empty\"  from roadmap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e68e6084669a55c94b6b2ef3df1f62c72fba822", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/0e68e6084669a55c94b6b2ef3df1f62c72fba822", "committedDate": "2020-05-21T23:45:24Z", "message": "fix: tests for table not found"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NTk0MTk4", "url": "https://github.com/h2database/h2database/pull/2637#pullrequestreview-416594198", "createdAt": "2020-05-22T01:32:29Z", "commit": {"oid": "0e68e6084669a55c94b6b2ef3df1f62c72fba822"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwMTozMjoyOVrOGZH-9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwMTo0NTozMVrOGZILIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5ODM4OQ==", "bodyText": "_1 suffix almost everywhere means that error code has one parameter. Use different names for exceptions. They are also expected to be self-descriptive.\n\n\nVendor-specific codes can't start with '0', '1', '2', '3', '4', 'A', 'B', 'C', 'D', 'E', 'F', 'G', or 'H'. Don't use 42S here, add some plain 90*** codes instead.", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r428998389", "createdAt": "2020-05-22T01:32:29Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/api/ErrorCode.java", "diffHunk": "@@ -2229,6 +2255,8 @@ public static String getState(int errorCode) {\n         // 42: syntax error or access rule violation\n         case TABLE_OR_VIEW_ALREADY_EXISTS_1: return \"42S01\";\n         case TABLE_OR_VIEW_NOT_FOUND_1: return \"42S02\";\n+        case TABLE_OR_VIEW_NOT_FOUND_2: return \"42S03\";\n+        case TABLE_OR_VIEW_NOT_FOUND_3: return \"42S04\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e68e6084669a55c94b6b2ef3df1f62c72fba822"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5ODcxNw==", "bodyText": "This field (unlike fields above) is not expected to be read when database is null, to we don't need it. Setting can be read from the database only when necessary.", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r428998717", "createdAt": "2020-05-22T01:33:56Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/command/Parser.java", "diffHunk": "@@ -739,6 +744,11 @@\n      */\n     private final boolean identifiersToUpper;\n \n+    /**\n+     * @see org.h2.engine.DbSettings#caseInsensitiveIdentifiers\n+     */\n+    private final boolean caseInsensitiveIdentifiers;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e68e6084669a55c94b6b2ef3df1f62c72fba822"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5OTEyOQ==", "bodyText": "Please, remove this list, additional complications for the main code path are unwanted. You can build a list only if nothing was found.\nPass  name of the schema when known as String to getTableOrViewNotFoundDbException(), and pass null to it when unknown to iterate over getCurrentSchemaName() and getSchemaSearchPath() in that method.", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r428999129", "createdAt": "2020-05-22T01:35:42Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/command/Parser.java", "diffHunk": "@@ -8601,14 +8613,16 @@ private Table readTableOrView() {\n     }\n \n     private Table readTableOrView(String tableName) {\n+        final List<Schema> schemas = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e68e6084669a55c94b6b2ef3df1f62c72fba822"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5OTQ0MQ==", "bodyText": "Don't use streams here, they are slow (it doesn't matter here) and unreadable when there are multiple operations at once.\nIt looks like you can use Database.getFirstUserTable() here.", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r428999441", "createdAt": "2020-05-22T01:36:49Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/command/Parser.java", "diffHunk": "@@ -8620,13 +8634,46 @@ private Table readTableOrView(String tableName) {\n                     if (table != null) {\n                         return table;\n                     }\n+                    schemas.add(s);\n                 }\n             }\n         }\n         if (isDualTable(tableName)) {\n             return new DualTable(database);\n         }\n-        throw DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+\n+        throw getTableOrViewNotFoundDbException(schemas, tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(final List<Schema> schemas, final String tableName) {\n+        if (schemas.stream().map(Schema::getAllTablesAndViews).noneMatch(not(Collection::isEmpty))) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_3, tableName);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e68e6084669a55c94b6b2ef3df1f62c72fba822"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMDQ1Mg==", "bodyText": "Don't use streams here too, nobody will ever try to review it.\nAlso use StringUtils.toUpperEnglish(String) here, that's how H2 works in case-insensitive mode, this code is expected to be compatible with it. Conversions to lower/upper case can be unequal due to large amount of specially handled characters in Unicode, and, unfortunately, conversions are locale-specific even for some ASCII characters.\nI also don't understand what are you trying to do with ` characters.", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429000452", "createdAt": "2020-05-22T01:41:14Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/command/Parser.java", "diffHunk": "@@ -8620,13 +8634,46 @@ private Table readTableOrView(String tableName) {\n                     if (table != null) {\n                         return table;\n                     }\n+                    schemas.add(s);\n                 }\n             }\n         }\n         if (isDualTable(tableName)) {\n             return new DualTable(database);\n         }\n-        throw DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+\n+        throw getTableOrViewNotFoundDbException(schemas, tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(final List<Schema> schemas, final String tableName) {\n+        if (schemas.stream().map(Schema::getAllTablesAndViews).noneMatch(not(Collection::isEmpty))) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_3, tableName);\n+        }\n+\n+        final java.util.Set<String> candidates =\n+            caseInsensitiveIdentifiers ?\n+                Collections.emptySet() :\n+                findQuotedTableNameCandidates(schemas, tableName);\n+\n+        if (candidates.isEmpty()) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+        }\n+\n+        return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_2,\n+            tableName,\n+            String.join(\", \", candidates));\n+    }\n+\n+    private java.util.Set<String> findQuotedTableNameCandidates(final List<Schema> schemas, final String tableName) {\n+        final String lcTableName = tableName.toLowerCase();\n+        return schemas.stream()\n+            .map(Schema::getAllTablesAndViews)\n+            .flatMap(Collection::stream)\n+            .map(Table::getName)\n+            .filter(c -> lcTableName.equals(c.toLowerCase()))\n+            .sorted()\n+            .map(c -> \"`\" + c + \"`\")\n+            .collect(Collectors.toCollection(TreeSet::new));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e68e6084669a55c94b6b2ef3df1f62c72fba822"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMDg2OQ==", "bodyText": "Add ERROR_CODE=#ENGLISH_MESSAGE to all remaining localization files.", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429000869", "createdAt": "2020-05-22T01:42:56Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/res/_messages_en.prop", "diffHunk": "@@ -29,6 +29,8 @@\n 42602=Invalid name {0}\n 42S01=Table {0} already exists\n 42S02=Table {0} not found\n+42S03=Table {0} not found (candidates are: {1})\n+42S04=Table {0} not found (this database is empty)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e68e6084669a55c94b6b2ef3df1f62c72fba822"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMTAyMw==", "bodyText": "Please, remove this class, we don't need it in the main code.", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429001023", "createdAt": "2020-05-22T01:43:34Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/util/StreamUtils.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package org.h2.util;\r\n+\r\n+import java.util.function.Predicate;\r\n+\r\n+public abstract class StreamUtils {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e68e6084669a55c94b6b2ef3df1f62c72fba822"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMTI3NA==", "bodyText": "Add a copyright header:\n/*\n * Copyright 2004-2020 H2 Group. Multiple-Licensed under the MPL 2.0,\n * and the EPL 1.0 (https://h2database.com/html/license.html).\n * Initial Developer: H2 Group\n */", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429001274", "createdAt": "2020-05-22T01:44:41Z", "author": {"login": "katzyn"}, "path": "h2/src/test/org/h2/test/db/TestAlterTableNotFound.java", "diffHunk": "@@ -0,0 +1,170 @@\n+package org.h2.test.db;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e68e6084669a55c94b6b2ef3df1f62c72fba822"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMTM5Nw==", "bodyText": "Use 4 character for indentation (8 for wrapped lines).", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429001397", "createdAt": "2020-05-22T01:45:11Z", "author": {"login": "katzyn"}, "path": "h2/src/test/org/h2/test/db/TestAlterTableNotFound.java", "diffHunk": "@@ -0,0 +1,170 @@\n+package org.h2.test.db;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.SQLException;\r\n+import java.sql.Statement;\r\n+import org.h2.jdbc.JdbcConnection;\r\n+import org.h2.test.TestBase;\r\n+import org.h2.test.TestDb;\r\n+\r\n+public class TestAlterTableNotFound extends TestDb {\r\n+\r\n+  /**\r\n+   * Run just this test.\r\n+   *\r\n+   * @param a ignored\r\n+   */\r\n+  public static void main(String... a) throws Exception {\r\n+    TestBase.createCaller().init().testFromMain();\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e68e6084669a55c94b6b2ef3df1f62c72fba822"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMTUwNQ==", "bodyText": "Header, indentation.", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429001505", "createdAt": "2020-05-22T01:45:31Z", "author": {"login": "katzyn"}, "path": "h2/src/test/org/h2/test/db/TestSelectTableNotFound.java", "diffHunk": "@@ -0,0 +1,177 @@\n+package org.h2.test.db;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e68e6084669a55c94b6b2ef3df1f62c72fba822"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a072f54edaeb93a24e82f9169e071be678a4e2a", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/8a072f54edaeb93a24e82f9169e071be678a4e2a", "committedDate": "2020-05-22T12:44:06Z", "message": "chore: make spellchecker happier"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c82acea00a3a6ae477f1e0bb384bd00fc13ac00", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/7c82acea00a3a6ae477f1e0bb384bd00fc13ac00", "committedDate": "2020-05-22T12:48:27Z", "message": "feat: #2637 fallbacks for missing translations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5af206166bfaa88ca759e2cd0b87dc70e5541b2c", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/5af206166bfaa88ca759e2cd0b87dc70e5541b2c", "committedDate": "2020-05-22T12:55:40Z", "message": "refactor: better names for table not found constants"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23649b928065c222d71bbc542a4642da8aa8062b", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/23649b928065c222d71bbc542a4642da8aa8062b", "committedDate": "2020-05-22T14:10:05Z", "message": "refactor: avoid additional complications for the main code path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f5d162eeb109bc2b7bf5b64f087557f2bd20e2f", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/0f5d162eeb109bc2b7bf5b64f087557f2bd20e2f", "committedDate": "2020-05-22T14:25:51Z", "message": "fix: additional error codes for table or view not found"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/d944b9792b09446cfbeb55e71860c1f9b9e60fbf", "committedDate": "2020-05-22T14:41:24Z", "message": "test: updated error codes for table not found"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2OTgzNDk5", "url": "https://github.com/h2database/h2database/pull/2637#pullrequestreview-416983499", "createdAt": "2020-05-22T15:05:57Z", "commit": {"oid": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNTowNTo1OFrOGZahSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNToxMTowM1rOGZarsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMjA5MQ==", "bodyText": "Please, don't use final modifiers for fields and local variables.", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429302091", "createdAt": "2020-05-22T15:05:58Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/command/Parser.java", "diffHunk": "@@ -8626,7 +8629,68 @@ private Table readTableOrView(String tableName) {\n         if (isDualTable(tableName)) {\n             return new DualTable(database);\n         }\n-        throw DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+\n+        throw getTableOrViewNotFoundDbException(tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(final String tableName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMzI1MA==", "bodyText": "Pass candidates to findTableNameCandidates() instead of allocation of own set it in.", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429303250", "createdAt": "2020-05-22T15:08:10Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/command/Parser.java", "diffHunk": "@@ -8626,7 +8629,68 @@ private Table readTableOrView(String tableName) {\n         if (isDualTable(tableName)) {\n             return new DualTable(database);\n         }\n-        throw DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+\n+        throw getTableOrViewNotFoundDbException(tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(final String tableName) {\n+        if (schemaName != null) {\n+            return getTableOrViewNotFoundDbException(schemaName, tableName);\n+        }\n+\n+        final String currentSchemaName = session.getCurrentSchemaName();\n+        final String[] schemaSearchPath = session.getSchemaSearchPath();\n+        if (schemaSearchPath == null) {\n+            return getTableOrViewNotFoundDbException(Collections.singleton(currentSchemaName), tableName);\n+        }\n+\n+        final LinkedHashSet<String> schemaNames = new LinkedHashSet<>();\n+        schemaNames.add(currentSchemaName);\n+        schemaNames.addAll(Arrays.asList(schemaSearchPath));\n+        return getTableOrViewNotFoundDbException(schemaNames, tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(final String schemaName, final String tableName) {\n+        return getTableOrViewNotFoundDbException(Collections.singleton(schemaName), tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(\n+            final java.util.Set<String> schemaNames, final String tableName) {\n+        if (database == null || database.getFirstUserTable() == null) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_DATABASE_EMPTY_1, tableName);\n+        }\n+\n+        if (database.getSettings().caseInsensitiveIdentifiers) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+        }\n+\n+        final java.util.Set<String> candidates = new TreeSet<>();\n+        for (final String schemaName : schemaNames) {\n+            candidates.addAll(findTableNameCandidates(schemaName, tableName));\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMzMwMw==", "bodyText": "Wrapped lines are indented with 8 spaces in sources of H2.", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429303303", "createdAt": "2020-05-22T15:08:15Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/command/Parser.java", "diffHunk": "@@ -8626,7 +8629,68 @@ private Table readTableOrView(String tableName) {\n         if (isDualTable(tableName)) {\n             return new DualTable(database);\n         }\n-        throw DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+\n+        throw getTableOrViewNotFoundDbException(tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(final String tableName) {\n+        if (schemaName != null) {\n+            return getTableOrViewNotFoundDbException(schemaName, tableName);\n+        }\n+\n+        final String currentSchemaName = session.getCurrentSchemaName();\n+        final String[] schemaSearchPath = session.getSchemaSearchPath();\n+        if (schemaSearchPath == null) {\n+            return getTableOrViewNotFoundDbException(Collections.singleton(currentSchemaName), tableName);\n+        }\n+\n+        final LinkedHashSet<String> schemaNames = new LinkedHashSet<>();\n+        schemaNames.add(currentSchemaName);\n+        schemaNames.addAll(Arrays.asList(schemaSearchPath));\n+        return getTableOrViewNotFoundDbException(schemaNames, tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(final String schemaName, final String tableName) {\n+        return getTableOrViewNotFoundDbException(Collections.singleton(schemaName), tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(\n+            final java.util.Set<String> schemaNames, final String tableName) {\n+        if (database == null || database.getFirstUserTable() == null) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_DATABASE_EMPTY_1, tableName);\n+        }\n+\n+        if (database.getSettings().caseInsensitiveIdentifiers) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+        }\n+\n+        final java.util.Set<String> candidates = new TreeSet<>();\n+        for (final String schemaName : schemaNames) {\n+            candidates.addAll(findTableNameCandidates(schemaName, tableName));\n+        }\n+\n+        if (candidates.isEmpty()) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+        }\n+\n+        return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_WITH_CANDIDATES_2,\n+            tableName,\n+            String.join(\", \", candidates));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMzg3MA==", "bodyText": "DATABASE_TO_UPPER=FALSE is enough.", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429303870", "createdAt": "2020-05-22T15:09:24Z", "author": {"login": "katzyn"}, "path": "h2/src/test/org/h2/test/db/TestAlterTableNotFound.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Copyright 2004-2020 H2 Group. Multiple-Licensed under the MPL 2.0,\n+ * and the EPL 1.0 (https://h2database.com/html/license.html).\n+ * Initial Developer: H2 Group\n+ */\n+package org.h2.test.db;\n+\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import org.h2.jdbc.JdbcConnection;\n+import org.h2.test.TestBase;\n+import org.h2.test.TestDb;\n+\n+public class TestAlterTableNotFound extends TestDb {\n+\n+    /**\n+     * Run just this test.\n+     *\n+     * @param a ignored\n+     */\n+    public static void main(String... a) throws Exception {\n+        TestBase.createCaller().init().testFromMain();\n+    }\n+\n+    @Override\n+    public void test() throws Exception {\n+        testWithoutAnyCandidate();\n+        testWithoutAnyCandidateWhenDatabaseToLower();\n+        testWithoutAnyCandidateWhenDatabaseToUpper();\n+        testWithoutAnyCandidateWhenCaseInsensitiveIdentifiers();\n+        testWithOneCandidate();\n+        testWithOneCandidateWhenDatabaseToLower();\n+        testWithOneCandidateWhenDatabaseToUpper();\n+        testWithOneCandidateWhenCaseInsensitiveIdentifiers();\n+        testWithTwoCandidates();\n+    }\n+\n+    private void testWithoutAnyCandidate() throws SQLException {\n+        deleteDb(getTestName());\n+        final Connection conn = getJdbcConnection(\"DATABASE_TO_LOWER=false;DATABASE_TO_UPPER=false\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwNDc1Mw==", "bodyText": "DATABASE_TO_LOWER=TRUE is enough.", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429304753", "createdAt": "2020-05-22T15:11:03Z", "author": {"login": "katzyn"}, "path": "h2/src/test/org/h2/test/db/TestAlterTableNotFound.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Copyright 2004-2020 H2 Group. Multiple-Licensed under the MPL 2.0,\n+ * and the EPL 1.0 (https://h2database.com/html/license.html).\n+ * Initial Developer: H2 Group\n+ */\n+package org.h2.test.db;\n+\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import org.h2.jdbc.JdbcConnection;\n+import org.h2.test.TestBase;\n+import org.h2.test.TestDb;\n+\n+public class TestAlterTableNotFound extends TestDb {\n+\n+    /**\n+     * Run just this test.\n+     *\n+     * @param a ignored\n+     */\n+    public static void main(String... a) throws Exception {\n+        TestBase.createCaller().init().testFromMain();\n+    }\n+\n+    @Override\n+    public void test() throws Exception {\n+        testWithoutAnyCandidate();\n+        testWithoutAnyCandidateWhenDatabaseToLower();\n+        testWithoutAnyCandidateWhenDatabaseToUpper();\n+        testWithoutAnyCandidateWhenCaseInsensitiveIdentifiers();\n+        testWithOneCandidate();\n+        testWithOneCandidateWhenDatabaseToLower();\n+        testWithOneCandidateWhenDatabaseToUpper();\n+        testWithOneCandidateWhenCaseInsensitiveIdentifiers();\n+        testWithTwoCandidates();\n+    }\n+\n+    private void testWithoutAnyCandidate() throws SQLException {\n+        deleteDb(getTestName());\n+        final Connection conn = getJdbcConnection(\"DATABASE_TO_LOWER=false;DATABASE_TO_UPPER=false\");\n+        final Statement stat = conn.createStatement();\n+        stat.execute(\"CREATE TABLE T2 ( ID INT IDENTITY )\");\n+        try {\n+            stat.execute(\"ALTER TABLE t1 DROP COLUMN ID\");\n+            fail(\"Table `t1` was accessible but should not have been.\");\n+        } catch (SQLException e) {\n+            final String message = e.getMessage();\n+            assertContains(message, \"Table \\\"t1\\\" not found;\");\n+        }\n+\n+        conn.close();\n+        deleteDb(getTestName());\n+    }\n+\n+    private void testWithoutAnyCandidateWhenDatabaseToLower() throws SQLException {\n+        deleteDb(getTestName());\n+        final Connection conn = getJdbcConnection(\"DATABASE_TO_LOWER=true;DATABASE_TO_UPPER=false\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2OTkzNjA4", "url": "https://github.com/h2database/h2database/pull/2637#pullrequestreview-416993608", "createdAt": "2020-05-22T15:19:57Z", "commit": {"oid": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNToxOTo1N1rOGZa-RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNToxOTo1N1rOGZa-RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwOTUwOA==", "bodyText": "Use SQL command here.\nhttps://h2database.com/html/commands.html#set_schema_search_path", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429309508", "createdAt": "2020-05-22T15:19:57Z", "author": {"login": "katzyn"}, "path": "h2/src/test/org/h2/test/db/TestSelectTableNotFound.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2004-2020 H2 Group. Multiple-Licensed under the MPL 2.0,\n+ * and the EPL 1.0 (https://h2database.com/html/license.html).\n+ * Initial Developer: H2 Group\n+ */\n+package org.h2.test.db;\n+\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import org.h2.engine.Session;\n+import org.h2.jdbc.JdbcConnection;\n+import org.h2.test.TestBase;\n+import org.h2.test.TestDb;\n+\n+public class TestSelectTableNotFound extends TestDb {\n+\n+    /**\n+     * Run just this test.\n+     *\n+     * @param a ignored\n+     */\n+    public static void main(String... a) throws Exception {\n+        TestBase.createCaller().init().testFromMain();\n+    }\n+\n+    @Override\n+    public void test() throws Exception {\n+        testWithoutAnyCandidate();\n+        testWithOneCandidate();\n+        testWithTwoCandidates();\n+        testWithSchema();\n+        testWithSchemaSearchPath();\n+        testWhenSchemaIsEmpty();\n+        testWithSchemaWhenSchemaIsEmpty();\n+        testWithSchemaSearchPathWhenSchemaIsEmpty();\n+    }\n+\n+    private void testWithoutAnyCandidate() throws SQLException {\n+        deleteDb(getTestName());\n+        final Connection conn = getJdbcConnection();\n+        final Statement stat = conn.createStatement();\n+        stat.execute(\"CREATE TABLE T2 ( ID INT IDENTITY )\");\n+        try {\n+            stat.executeQuery(\"SELECT 1 FROM t1\");\n+            fail(\"Table `t1` was accessible but should not have been.\");\n+        } catch (SQLException e) {\n+            final String message = e.getMessage();\n+            assertContains(message, \"Table \\\"t1\\\" not found;\");\n+        }\n+\n+        conn.close();\n+        deleteDb(getTestName());\n+    }\n+\n+    private void testWithOneCandidate() throws SQLException {\n+        deleteDb(getTestName());\n+        final Connection conn = getJdbcConnection();\n+        final Statement stat = conn.createStatement();\n+        stat.execute(\"CREATE TABLE T1 ( ID INT IDENTITY )\");\n+        try {\n+            stat.executeQuery(\"SELECT 1 FROM t1\");\n+            fail(\"Table `t1` was accessible but should not have been.\");\n+        } catch (SQLException e) {\n+            final String message = e.getMessage();\n+            assertContains(message, \"Table \\\"t1\\\" not found (candidates are: \\\"T1\\\")\");\n+        }\n+\n+        conn.close();\n+        deleteDb(getTestName());\n+    }\n+\n+    private void testWithTwoCandidates() throws SQLException {\n+        deleteDb(getTestName());\n+        final Connection conn = getJdbcConnection();\n+        final Statement stat = conn.createStatement();\n+        stat.execute(\"CREATE TABLE Toast ( ID INT IDENTITY )\");\n+        stat.execute(\"CREATE TABLE TOAST ( ID INT IDENTITY )\");\n+        try {\n+            stat.executeQuery(\"SELECT 1 FROM toast\");\n+            fail(\"Table `toast` was accessible but should not have been.\");\n+        } catch (SQLException e) {\n+            final String message = e.getMessage();\n+            assertContains(message, \"Table \\\"toast\\\" not found (candidates are: \\\"TOAST, Toast\\\")\");\n+        }\n+\n+        conn.close();\n+        deleteDb(getTestName());\n+    }\n+\n+    private void testWithSchema() throws SQLException {\n+        deleteDb(getTestName());\n+        final Connection conn = getJdbcConnection();\n+        final Statement stat = conn.createStatement();\n+        stat.execute(\"CREATE TABLE T1 ( ID INT IDENTITY )\");\n+        try {\n+            stat.executeQuery(\"SELECT 1 FROM PUBLIC.t1\");\n+            fail(\"Table `t1` was accessible but should not have been.\");\n+        } catch (SQLException e) {\n+            final String message = e.getMessage();\n+            assertContains(message, \"Table \\\"t1\\\" not found (candidates are: \\\"T1\\\")\");\n+        }\n+\n+        conn.close();\n+        deleteDb(getTestName());\n+    }\n+\n+    private void testWithSchemaSearchPath() throws SQLException {\n+        deleteDb(getTestName());\n+        final JdbcConnection conn = getJdbcConnection();\n+        final Session session = (Session) conn.getSession();\n+        session.setSchemaSearchPath(new String[]{ \"PUBLIC\" });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf"}, "originalPosition": 112}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f95052894b282e6dce6f534dacd5796b94e472c8", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/f95052894b282e6dce6f534dacd5796b94e472c8", "committedDate": "2020-05-22T15:42:24Z", "message": "style: remove final"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d387bfed1e6222a7a543c4592e6dada9c8542737", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/d387bfed1e6222a7a543c4592e6dada9c8542737", "committedDate": "2020-05-22T15:48:20Z", "message": "refactor: use one single TreeSet instance to collect candidates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f1829ff0aeda84e21ff66655846d5600dfc99cd", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/2f1829ff0aeda84e21ff66655846d5600dfc99cd", "committedDate": "2020-05-22T16:08:40Z", "message": "test: removed redundant DB settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c3d044c23b59a5776924a4e650af4217a2f499b", "author": {"user": {"login": "resident-uhlig", "name": "Sven Uhlig"}}, "url": "https://github.com/h2database/h2database/commit/5c3d044c23b59a5776924a4e650af4217a2f499b", "committedDate": "2020-05-22T16:30:44Z", "message": "Merge branch 'master' of github.com:h2database/h2database into feature/table-not-found-candidates"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3871, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}