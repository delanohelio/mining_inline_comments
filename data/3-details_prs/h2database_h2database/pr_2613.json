{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0OTU3NzM1", "number": 2613, "title": "Add support for TZH and TZM in TO_CHAR function", "bodyText": "Addresses #2609", "createdAt": "2020-05-07T22:47:51Z", "url": "https://github.com/h2database/h2database/pull/2613", "merged": true, "mergeCommit": {"oid": "b903ccb2cd42ab9f8a6be57fdd26dc2380432a30"}, "closed": true, "closedAt": "2020-06-22T09:54:54Z", "author": {"login": "paroxysm"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcexP1LgH2gAyNDE0OTU3NzM1OmQ3YzQwMGQ3ZjkyYzA3ODJhZTkwOTdhMjI5ZmE4NmFhYjQ2OGMyOGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcto4pYgH2gAyNDE0OTU3NzM1OjdmYzkwNDM0YmM3OGU5NmE2ZmI2MDRlNzBkODhlZmMxZWUwN2MwYzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d7c400d7f92c0782ae9097a229fa86aab468c28f", "author": {"user": null}, "url": "https://github.com/h2database/h2database/commit/d7c400d7f92c0782ae9097a229fa86aab468c28f", "committedDate": "2020-05-06T23:26:27Z", "message": "ADD:\nSupport for TZH/TZM tokens in TO_CHAR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef07daf781b71946804860c8a87e5902cd437544", "author": {"user": null}, "url": "https://github.com/h2database/h2database/commit/ef07daf781b71946804860c8a87e5902cd437544", "committedDate": "2020-05-07T00:06:01Z", "message": "ADD:\nSupport for TZH/TZM tokens in TO_CHAR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97351b7dda7a9b32b11b7ecd73e0a30f39603c19", "author": {"user": null}, "url": "https://github.com/h2database/h2database/commit/97351b7dda7a9b32b11b7ecd73e0a30f39603c19", "committedDate": "2020-05-07T00:06:24Z", "message": "Merge remote-tracking branch 'origin/master'\n\n# Conflicts:\n#\th2/src/test/org/h2/test/db/TestFunctions.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a40a273508dc786cf9a0c34d4aaa855e632b558", "author": {"user": null}, "url": "https://github.com/h2database/h2database/commit/9a40a273508dc786cf9a0c34d4aaa855e632b558", "committedDate": "2020-05-07T01:30:31Z", "message": "FIXED: incorrect output when using negative offsets."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "509bd451c9b890e5500884993cbffedf896ea92f", "author": {"user": null}, "url": "https://github.com/h2database/h2database/commit/509bd451c9b890e5500884993cbffedf896ea92f", "committedDate": "2020-05-07T21:31:42Z", "message": "Remove server-side only code from DateTimeUtils.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4eac17a0a0650d4bff9c0daf5ec4cb7d21c7148", "author": {"user": null}, "url": "https://github.com/h2database/h2database/commit/e4eac17a0a0650d4bff9c0daf5ec4cb7d21c7148", "committedDate": "2020-05-07T22:22:53Z", "message": "Add a few more test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3OTY3MzY2", "url": "https://github.com/h2database/h2database/pull/2613#pullrequestreview-407967366", "createdAt": "2020-05-08T03:06:03Z", "commit": {"oid": "e4eac17a0a0650d4bff9c0daf5ec4cb7d21c7148"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwMzowNjowM1rOGSXYrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwMzoxNDowMlrOGSXg5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkxMDcwMg==", "bodyText": "Increase visibility of DateTimeFunctions.extractIntegerField() and use it here (DateTimeFunctions.extractIntegerField(session, DateTimeFunctions.TIMEZONE_HOUR, value);.\n\n\nPass StringBuilder directly to this method and to printTimeZoneHoursFromOffsetSeconds().\n\n\nInline printTimeZoneHoursFromOffsetSeconds() into this method.\n\n\nIf resulting method will be not very large, inline it into toCharDateTime().", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r421910702", "createdAt": "2020-05-08T03:06:03Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/expression/function/ToChar.java", "diffHunk": "@@ -546,6 +546,54 @@ private static String getTimeZone(Session session, Value value, boolean tzd) {\n         }\n     }\n \n+    private static String getTimeZoneHours(Session session, Value value) {\n+        if(value instanceof ValueTimestampTimeZone) {\n+            return printTimeZoneHoursFromOffsetSeconds(((ValueTimestampTimeZone) value).getTimeZoneOffsetSeconds());\n+        } else if( value instanceof ValueTimeTimeZone) {\n+            return printTimeZoneHoursFromOffsetSeconds( ((ValueTimeTimeZone)value).getTimeZoneOffsetSeconds());\n+        } else {\n+            TimeZoneProvider tz = session.currentTimeZone();\n+            ValueTimestamp v = (ValueTimestamp) value.convertTo(TypeInfo.TYPE_TIMESTAMP, session);\n+            return printTimeZoneHoursFromOffsetSeconds(tz.getTimeZoneOffsetLocal(v.getDateValue(), v.getTimeNanos()));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4eac17a0a0650d4bff9c0daf5ec4cb7d21c7148"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkxMDk2Mw==", "bodyText": "The same here.", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r421910963", "createdAt": "2020-05-08T03:06:58Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/expression/function/ToChar.java", "diffHunk": "@@ -546,6 +546,54 @@ private static String getTimeZone(Session session, Value value, boolean tzd) {\n         }\n     }\n \n+    private static String getTimeZoneHours(Session session, Value value) {\n+        if(value instanceof ValueTimestampTimeZone) {\n+            return printTimeZoneHoursFromOffsetSeconds(((ValueTimestampTimeZone) value).getTimeZoneOffsetSeconds());\n+        } else if( value instanceof ValueTimeTimeZone) {\n+            return printTimeZoneHoursFromOffsetSeconds( ((ValueTimeTimeZone)value).getTimeZoneOffsetSeconds());\n+        } else {\n+            TimeZoneProvider tz = session.currentTimeZone();\n+            ValueTimestamp v = (ValueTimestamp) value.convertTo(TypeInfo.TYPE_TIMESTAMP, session);\n+            return printTimeZoneHoursFromOffsetSeconds(tz.getTimeZoneOffsetLocal(v.getDateValue(), v.getTimeNanos()));\n+        }\n+    }\n+\n+    private static String getTimeZoneMinutes(Session session, Value value) {\n+        if(value instanceof ValueTimestampTimeZone) {\n+            return printTimeZoneMinutesFromOffsetSeconds(((ValueTimestampTimeZone) value).getTimeZoneOffsetSeconds());\n+        } else if( value instanceof ValueTimeTimeZone) {\n+            return printTimeZoneMinutesFromOffsetSeconds( ((ValueTimeTimeZone)value).getTimeZoneOffsetSeconds());\n+        } else {\n+            TimeZoneProvider tz = session.currentTimeZone();\n+            ValueTimestamp v = (ValueTimestamp) value.convertTo(TypeInfo.TYPE_TIMESTAMP, session);\n+            return printTimeZoneMinutesFromOffsetSeconds(tz.getTimeZoneOffsetLocal(v.getDateValue(), v.getTimeNanos()));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4eac17a0a0650d4bff9c0daf5ec4cb7d21c7148"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkxMTAyNw==", "bodyText": "Please, remove this extra line.", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r421911027", "createdAt": "2020-05-08T03:07:16Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/util/DateTimeUtils.java", "diffHunk": "@@ -1077,6 +1077,7 @@ public static String timeZoneNameFromOffsetSeconds(int offsetSeconds) {\n         return b.toString();\n     }\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4eac17a0a0650d4bff9c0daf5ec4cb7d21c7148"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkxMjgwNQ==", "bodyText": "Please, add space after if and move // Week comment below.", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r421912805", "createdAt": "2020-05-08T03:14:02Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/expression/function/ToChar.java", "diffHunk": "@@ -831,6 +879,14 @@ public static String toCharDateTime(Session session, Value value, String format,\n \n                 // Week\n \n+            } else if(containsAt(format, i, \"TZH\") != null) {\n+                output.append(getTimeZoneHours(session, value));\n+                i += 3;\n+\n+            } else if(containsAt(format, i, \"TZM\") != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4eac17a0a0650d4bff9c0daf5ec4cb7d21c7148"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a04618cdff10e2f589caefe33d80da4ed564460c", "author": {"user": null}, "url": "https://github.com/h2database/h2database/commit/a04618cdff10e2f589caefe33d80da4ed564460c", "committedDate": "2020-06-22T03:12:48Z", "message": "- addressing review items"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NTc5ODk1", "url": "https://github.com/h2database/h2database/pull/2613#pullrequestreview-434579895", "createdAt": "2020-06-22T03:16:26Z", "commit": {"oid": "a04618cdff10e2f589caefe33d80da4ed564460c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwMzoxNjoyN1rOGmwzlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwMzoxOTozMVrOGmw1nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5ODcwOA==", "bodyText": "Please, remove result and b, there is no need for their allocation. You can append everything to the output directly.", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r443298708", "createdAt": "2020-06-22T03:16:27Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/expression/function/ToChar.java", "diffHunk": "@@ -828,9 +828,32 @@ public static String toCharDateTime(Session session, Value value, String format,\n             } else if (containsAt(format, i, \"TZD\") != null) {\n                 output.append(getTimeZone(session, value, true));\n                 i += 3;\n+            } else if (containsAt(format, i, \"TZH\") != null) {\n+                String result;\n+                int hours = DateTimeFunctions.extractIntegerField(session, value, DateTimeFunctions.TIMEZONE_HOUR);\n+                StringBuilder b = new StringBuilder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a04618cdff10e2f589caefe33d80da4ed564460c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5OTIyOA==", "bodyText": "output.append(\"00\") / StringUtils.appendTwoDigits(output, mins).\nAlso add a space between if and ( here and above.", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r443299228", "createdAt": "2020-06-22T03:19:31Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/expression/function/ToChar.java", "diffHunk": "@@ -828,9 +828,32 @@ public static String toCharDateTime(Session session, Value value, String format,\n             } else if (containsAt(format, i, \"TZD\") != null) {\n                 output.append(getTimeZone(session, value, true));\n                 i += 3;\n+            } else if (containsAt(format, i, \"TZH\") != null) {\n+                String result;\n+                int hours = DateTimeFunctions.extractIntegerField(session, value, DateTimeFunctions.TIMEZONE_HOUR);\n+                StringBuilder b = new StringBuilder();\n+                b.append( hours < 0 ? '-' : '+');\n+                hours = Math.abs(hours);\n+                if(hours == 0) {\n+                    result = b.append(\"00\").toString();\n+                } else {\n+                    result = StringUtils.appendTwoDigits(b, hours).toString();\n+                }\n+                output.append(result);\n+                i += 3;\n \n-                // Week\n+            } else if (containsAt(format, i, \"TZM\") != null) {\n+                String result;\n+                int mins = Math.abs(DateTimeFunctions.extractIntegerField(session, value, DateTimeFunctions.TIMEZONE_MINUTE));\n+                if(mins == 0) {\n+                    result = \"00\";\n+                } else {\n+                    result = StringUtils.appendTwoDigits(new StringBuilder(), mins).toString();\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a04618cdff10e2f589caefe33d80da4ed564460c"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "869b5bd0e34f6976f9fd52ef50a51d479eb6e82f", "author": {"user": null}, "url": "https://github.com/h2database/h2database/commit/869b5bd0e34f6976f9fd52ef50a51d479eb6e82f", "committedDate": "2020-06-22T03:59:26Z", "message": "Merge remote-tracking branch 'upstream/master'\n\n# Conflicts:\n#\th2/src/main/org/h2/expression/function/DateTimeFunction.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01c36497b5ad2015712b2536df969a1dc28c036a", "author": {"user": null}, "url": "https://github.com/h2database/h2database/commit/01c36497b5ad2015712b2536df969a1dc28c036a", "committedDate": "2020-06-22T04:02:38Z", "message": "- addressing more review items"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NTkxMjY1", "url": "https://github.com/h2database/h2database/pull/2613#pullrequestreview-434591265", "createdAt": "2020-06-22T04:07:02Z", "commit": {"oid": "01c36497b5ad2015712b2536df969a1dc28c036a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNDowNzowMlrOGmxXAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNDowNzowMlrOGmxXAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwNzc3OQ==", "bodyText": "BTW, what is the point of this condition? Unconditional StringUtils.appendTwoDigits(output, hours) should produce the same result, or I'm missing something?", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r443307779", "createdAt": "2020-06-22T04:07:02Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/expression/function/ToChar.java", "diffHunk": "@@ -835,9 +835,27 @@ public static String toCharDateTime(Session session, Value value, String format,\n             } else if (containsAt(format, i, \"TZD\") != null) {\n                 output.append(getTimeZone(session, value, true));\n                 i += 3;\n+            } else if (containsAt(format, i, \"TZH\") != null) {\n+                int hours = DateTimeFunction.extractDateTime(session, value, DateTimeFunction.TIMEZONE_HOUR);\n+                output.append( hours < 0 ? '-' : '+');\n+                hours = Math.abs(hours);\n+                if (hours == 0) {\n+                    output.append(\"00\");\n+                } else {\n+                  StringUtils.appendTwoDigits(output, hours);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01c36497b5ad2015712b2536df969a1dc28c036a"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fc90434bc78e96a6fb604e70d88efc1ee07c0c0", "author": {"user": null}, "url": "https://github.com/h2database/h2database/commit/7fc90434bc78e96a6fb604e70d88efc1ee07c0c0", "committedDate": "2020-06-22T04:10:45Z", "message": "- clean up un-necessary code even further."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3865, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}