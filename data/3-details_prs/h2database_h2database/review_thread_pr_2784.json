{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MDQ5MjYx", "number": 2784, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMToyMzo0NFrOETo1Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjo0ODoyOVrOETqe7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDI3MzUxOnYy", "diffSide": "RIGHT", "path": "h2/src/main/org/h2/mode/FunctionsOracle.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMToyMzo0NFrOG5e8eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMToyMzo0NFrOG5e8eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyOTAxNg==", "bodyText": "You can simply compare result of getString() with null, there is no need to check value type.", "url": "https://github.com/h2database/h2database/pull/2784#discussion_r462929016", "createdAt": "2020-07-30T11:23:44Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/mode/FunctionsOracle.java", "diffHunk": "@@ -128,10 +142,40 @@ protected Value getValueWithArgs(SessionLocal session, Expression[] args) {\n         case TO_TIMESTAMP_TZ:\n             result = ToDateParser.toTimestampTz(session, v0.getString(), v1 == null ? null : v1.getString());\n             break;\n+        case REGEXP_REPLACE:\n+            Boolean replaceBackslashRefs = session.getMode().regexpReplaceBackslashReferences;\n+            String regexpResult = regexpReplace(replaceBackslashRefs, v0, v1, v2, v3, v4, v5);\n+            result = ValueVarchar.get(regexpResult, session);\n+            break;\n         default:\n             throw DbException.throwInternalError(\"type=\" + info.type);\n         }\n         return result;\n     }\n \n+    private static String regexpReplace(Boolean replaceBackslashRefs, Value ... args) {\n+        String input = args[0].getString();\n+        String regexp = args[1].getValueType() != Value.NULL ? args[1].getString() : \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c45412fc8001d4274cfab99655a59ee64ea58fb4"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDI3ODE3OnYy", "diffSide": "RIGHT", "path": "h2/src/main/org/h2/mode/FunctionsOracle.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMToyNToxMlrOG5e_QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMTo0OTozMFrOG5frVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyOTcyOQ==", "bodyText": "What are you trying to do here? Fourth argument may only be integer in Oracle, or I'm missing something?", "url": "https://github.com/h2database/h2database/pull/2784#discussion_r462929729", "createdAt": "2020-07-30T11:25:12Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/mode/FunctionsOracle.java", "diffHunk": "@@ -128,10 +142,40 @@ protected Value getValueWithArgs(SessionLocal session, Expression[] args) {\n         case TO_TIMESTAMP_TZ:\n             result = ToDateParser.toTimestampTz(session, v0.getString(), v1 == null ? null : v1.getString());\n             break;\n+        case REGEXP_REPLACE:\n+            Boolean replaceBackslashRefs = session.getMode().regexpReplaceBackslashReferences;\n+            String regexpResult = regexpReplace(replaceBackslashRefs, v0, v1, v2, v3, v4, v5);\n+            result = ValueVarchar.get(regexpResult, session);\n+            break;\n         default:\n             throw DbException.throwInternalError(\"type=\" + info.type);\n         }\n         return result;\n     }\n \n+    private static String regexpReplace(Boolean replaceBackslashRefs, Value ... args) {\n+        String input = args[0].getString();\n+        String regexp = args[1].getValueType() != Value.NULL ? args[1].getString() : \"\";\n+        String replacement = args[2].getValueType() != Value.NULL ? args[2].getString() : \"\";\n+        if (replaceBackslashRefs) {\n+            replacement = StringUtils.replaceBackslashReferences(replacement);\n+        }\n+        int position = 1;\n+        int occurrence = 0;\n+        String regexpMode = \"\";\n+\n+        if (args[3] != null) {\n+            if (args[3].getValueType() == Value.VARCHAR) {\n+                regexpMode = args[3].getString() == null ? args[3].getString() : \"\";\n+            } else if (args[3].getValueType() == Value.INTEGER) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c45412fc8001d4274cfab99655a59ee64ea58fb4"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkzNTYwMg==", "bodyText": "in oracle - yes. I was trying to not break the logic if someone relies on default h2 regexp_replace logic in oracle mode", "url": "https://github.com/h2database/h2database/pull/2784#discussion_r462935602", "createdAt": "2020-07-30T11:37:49Z", "author": {"login": "RomanBoyars"}, "path": "h2/src/main/org/h2/mode/FunctionsOracle.java", "diffHunk": "@@ -128,10 +142,40 @@ protected Value getValueWithArgs(SessionLocal session, Expression[] args) {\n         case TO_TIMESTAMP_TZ:\n             result = ToDateParser.toTimestampTz(session, v0.getString(), v1 == null ? null : v1.getString());\n             break;\n+        case REGEXP_REPLACE:\n+            Boolean replaceBackslashRefs = session.getMode().regexpReplaceBackslashReferences;\n+            String regexpResult = regexpReplace(replaceBackslashRefs, v0, v1, v2, v3, v4, v5);\n+            result = ValueVarchar.get(regexpResult, session);\n+            break;\n         default:\n             throw DbException.throwInternalError(\"type=\" + info.type);\n         }\n         return result;\n     }\n \n+    private static String regexpReplace(Boolean replaceBackslashRefs, Value ... args) {\n+        String input = args[0].getString();\n+        String regexp = args[1].getValueType() != Value.NULL ? args[1].getString() : \"\";\n+        String replacement = args[2].getValueType() != Value.NULL ? args[2].getString() : \"\";\n+        if (replaceBackslashRefs) {\n+            replacement = StringUtils.replaceBackslashReferences(replacement);\n+        }\n+        int position = 1;\n+        int occurrence = 0;\n+        String regexpMode = \"\";\n+\n+        if (args[3] != null) {\n+            if (args[3].getValueType() == Value.VARCHAR) {\n+                regexpMode = args[3].getString() == null ? args[3].getString() : \"\";\n+            } else if (args[3].getValueType() == Value.INTEGER) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyOTcyOQ=="}, "originalCommit": {"oid": "c45412fc8001d4274cfab99655a59ee64ea58fb4"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk0MTAxMg==", "bodyText": "We don't provide that level of backward compatibility for compatibility modes.", "url": "https://github.com/h2database/h2database/pull/2784#discussion_r462941012", "createdAt": "2020-07-30T11:49:30Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/mode/FunctionsOracle.java", "diffHunk": "@@ -128,10 +142,40 @@ protected Value getValueWithArgs(SessionLocal session, Expression[] args) {\n         case TO_TIMESTAMP_TZ:\n             result = ToDateParser.toTimestampTz(session, v0.getString(), v1 == null ? null : v1.getString());\n             break;\n+        case REGEXP_REPLACE:\n+            Boolean replaceBackslashRefs = session.getMode().regexpReplaceBackslashReferences;\n+            String regexpResult = regexpReplace(replaceBackslashRefs, v0, v1, v2, v3, v4, v5);\n+            result = ValueVarchar.get(regexpResult, session);\n+            break;\n         default:\n             throw DbException.throwInternalError(\"type=\" + info.type);\n         }\n         return result;\n     }\n \n+    private static String regexpReplace(Boolean replaceBackslashRefs, Value ... args) {\n+        String input = args[0].getString();\n+        String regexp = args[1].getValueType() != Value.NULL ? args[1].getString() : \"\";\n+        String replacement = args[2].getValueType() != Value.NULL ? args[2].getString() : \"\";\n+        if (replaceBackslashRefs) {\n+            replacement = StringUtils.replaceBackslashReferences(replacement);\n+        }\n+        int position = 1;\n+        int occurrence = 0;\n+        String regexpMode = \"\";\n+\n+        if (args[3] != null) {\n+            if (args[3].getValueType() == Value.VARCHAR) {\n+                regexpMode = args[3].getString() == null ? args[3].getString() : \"\";\n+            } else if (args[3].getValueType() == Value.INTEGER) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyOTcyOQ=="}, "originalCommit": {"oid": "c45412fc8001d4274cfab99655a59ee64ea58fb4"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDQ1MjcwOnYy", "diffSide": "RIGHT", "path": "h2/src/main/org/h2/expression/function/Function.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjoyMjoxM1rOG5gpFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjoyMjoxM1rOG5gpFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk1NjgyMA==", "bodyText": "Use == instead of equals() for enumerations.", "url": "https://github.com/h2database/h2database/pull/2784#discussion_r462956820", "createdAt": "2020-07-30T12:22:13Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/expression/function/Function.java", "diffHunk": "@@ -776,8 +776,20 @@ protected Value getValueWithArgs(SessionLocal session, Expression[] args) {\n             String input = v0.getString();\n             String regexp = v1.getString();\n             String replacement = v2.getString();\n-            String regexpMode = v3 != null ? v3.getString() : null;\n-            result = regexpReplace(session, input, regexp, replacement, regexpMode);\n+\n+            if (ModeEnum.Oracle.equals(session.getMode().getEnum())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37ea132f0b85c245548b26cfda55e3fce4a32b86"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDQ2NzQ1OnYy", "diffSide": "RIGHT", "path": "h2/src/main/org/h2/expression/function/Function.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjoyNjozN1rOG5gyHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjoyNjozN1rOG5gyHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk1OTEzNQ==", "bodyText": "if (v4 != null) {\n    throw DbException.get(ErrorCode.INVALID_PARAMETER_COUNT_2, info.name, \"3..4\");\n}\nif (v0 == ValueNull.INSTANCE || v1 == ValueNull.INSTANCE || v2 == ValueNull.INSTANCE || v3 == ValueNull.INSTANCE) {\n    result = ValueNull.INSTANCE;\n} else {\n    \u2026\n}", "url": "https://github.com/h2database/h2database/pull/2784#discussion_r462959135", "createdAt": "2020-07-30T12:26:37Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/expression/function/Function.java", "diffHunk": "@@ -776,8 +776,20 @@ protected Value getValueWithArgs(SessionLocal session, Expression[] args) {\n             String input = v0.getString();\n             String regexp = v1.getString();\n             String replacement = v2.getString();\n-            String regexpMode = v3 != null ? v3.getString() : null;\n-            result = regexpReplace(session, input, regexp, replacement, regexpMode);\n+\n+            if (ModeEnum.Oracle.equals(session.getMode().getEnum())) {\n+                if (replacement == null) {\n+                    replacement = \"\";\n+                }\n+                int position = v3 != null ? v3.getInt() : 1;\n+                int occurrence = v4 != null ? v4.getInt() : 0;\n+                String regexpMode = v5 != null ? v5.getString() : null;\n+                result = regexpReplace(session, input, regexp, replacement, position, occurrence,\n+                        regexpMode);\n+            } else {\n+                String regexpMode = v3 != null ? v3.getString() : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37ea132f0b85c245548b26cfda55e3fce4a32b86"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDQ3MDA0OnYy", "diffSide": "RIGHT", "path": "h2/src/main/org/h2/expression/function/Function.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjoyNzoyNFrOG5gzvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjoyNzoyNFrOG5gzvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk1OTU1MQ==", "bodyText": "Please, indent wrapped lines with 8 additional spaces. Don't align arguments, such alignment breaks code style checks.", "url": "https://github.com/h2database/h2database/pull/2784#discussion_r462959551", "createdAt": "2020-07-30T12:27:24Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/expression/function/Function.java", "diffHunk": "@@ -1513,8 +1525,9 @@ private static MessageDigest hashImpl(Value value, MessageDigest md) {\n         }\n     }\n \n-    private static Value regexpReplace(SessionLocal session, String input, String regexp, String replacement,\n-            String regexpMode) {\n+    private static Value regexpReplace(SessionLocal session, String input, String regexp,\n+                                       String replacement, int position, int occurrence,\n+                                       String regexpMode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37ea132f0b85c245548b26cfda55e3fce4a32b86"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDQ5Nzk2OnYy", "diffSide": "RIGHT", "path": "h2/src/test/org/h2/test/scripts/functions/string/regex-replace.sql", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjozNToyNlrOG5hEYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjozNToyNlrOG5hEYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2MzgwOA==", "bodyText": "You need to additionally test your implementation with 5 and 6 arguments and with empty strings in other arguments too.\nIf your IDE has some built-in code coverage tool, run it with TestScript class and make sure that all new conditions are covered with tests.", "url": "https://github.com/h2database/h2database/pull/2784#discussion_r462963808", "createdAt": "2020-07-30T12:35:26Z", "author": {"login": "katzyn"}, "path": "h2/src/test/org/h2/test/scripts/functions/string/regex-replace.sql", "diffHunk": "@@ -15,6 +15,18 @@ select regexp_replace('Sylvain', 'S..', 'TOTO', 'mni');\n set mode oracle;\n > ok\n \n+select regexp_replace('.1.2.3.4', '[^0-9]', '', 1, 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37ea132f0b85c245548b26cfda55e3fce4a32b86"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDUzNjIzOnYy", "diffSide": "RIGHT", "path": "h2/src/main/org/h2/expression/function/Function.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjo0NjoxNFrOG5hblA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjo0NjoxNFrOG5hblA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2OTc0OA==", "bodyText": "I guess you need to check result of find() method.", "url": "https://github.com/h2database/h2database/pull/2784#discussion_r462969748", "createdAt": "2020-07-30T12:46:14Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/expression/function/Function.java", "diffHunk": "@@ -1534,11 +1547,21 @@ private static Value regexpReplace(SessionLocal session, String input, String re\n         }\n         boolean isInPostgreSqlMode = Mode.ModeEnum.PostgreSQL.equals(mode.getEnum());\n         int flags = makeRegexpFlags(regexpMode, isInPostgreSqlMode);\n+        if (isInPostgreSqlMode && ( regexpMode == null || regexpMode.isEmpty() || !regexpMode.contains(\"g\"))) {\n+            occurrence = 1;\n+        }\n         try {\n-            Matcher matcher = Pattern.compile(regexp, flags).matcher(input);\n-            return ValueVarchar.get(isInPostgreSqlMode && (regexpMode == null || regexpMode.indexOf('g') < 0) ?\n-                    matcher.replaceFirst(replacement) : matcher.replaceAll(replacement),\n-                    session);\n+            Matcher matcher = Pattern.compile(regexp, flags).matcher(input).region(position - 1, input.length());\n+            if (occurrence == 0) {\n+                return ValueVarchar.get(matcher.replaceAll(replacement), session);\n+            } else {\n+                for(int i = 0; i < occurrence; i++) {\n+                    matcher.find();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37ea132f0b85c245548b26cfda55e3fce4a32b86"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDU0NDQ1OnYy", "diffSide": "RIGHT", "path": "h2/src/main/org/h2/expression/function/Function.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjo0ODoyOVrOG5hgpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjo0ODoyOVrOG5hgpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3MTA0Nw==", "bodyText": "Please, don't compile a new Pattern for the same regular expression here. Try to use an existing Matcher directly.", "url": "https://github.com/h2database/h2database/pull/2784#discussion_r462971047", "createdAt": "2020-07-30T12:48:29Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/expression/function/Function.java", "diffHunk": "@@ -1534,11 +1547,21 @@ private static Value regexpReplace(SessionLocal session, String input, String re\n         }\n         boolean isInPostgreSqlMode = Mode.ModeEnum.PostgreSQL.equals(mode.getEnum());\n         int flags = makeRegexpFlags(regexpMode, isInPostgreSqlMode);\n+        if (isInPostgreSqlMode && ( regexpMode == null || regexpMode.isEmpty() || !regexpMode.contains(\"g\"))) {\n+            occurrence = 1;\n+        }\n         try {\n-            Matcher matcher = Pattern.compile(regexp, flags).matcher(input);\n-            return ValueVarchar.get(isInPostgreSqlMode && (regexpMode == null || regexpMode.indexOf('g') < 0) ?\n-                    matcher.replaceFirst(replacement) : matcher.replaceAll(replacement),\n-                    session);\n+            Matcher matcher = Pattern.compile(regexp, flags).matcher(input).region(position - 1, input.length());\n+            if (occurrence == 0) {\n+                return ValueVarchar.get(matcher.replaceAll(replacement), session);\n+            } else {\n+                for(int i = 0; i < occurrence; i++) {\n+                    matcher.find();\n+                }\n+                int startIndex = matcher.start();\n+                return ValueVarchar.get(input.substring(0, startIndex) + input.substring(startIndex).replaceFirst(regexp,\n+                        replacement), session);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37ea132f0b85c245548b26cfda55e3fce4a32b86"}, "originalPosition": 66}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2116, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}