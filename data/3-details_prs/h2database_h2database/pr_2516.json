{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMzkwODYx", "number": 2516, "title": "SHUTDOWN IMMEDIATELY should be a normal shut down", "bodyText": "Fix for #2507\nThis PR unifies code path and behaviour of different flavours of SHUTDOWN command.\nSHUTDOWN IMMEDIATELY corrected implementation follows the same path as other flavours of SHUTDOWN command.\nOld code path involved Database.shutdownImmediately() call, but it is the same call that is used in emergencies, like OOME or if underlying MVStore found to be closed. This code path also did MVStore.closeImmediately(), and that can leave database without latest changes, even corrupted.\nThis new common code path has some changes too.\nIf any session has prepared, but not committed transaction, then such transaction is left alone (neither committed, nor rolled back) and will show up is \"in doubt\" upon next start. This was the behaviour of SHUTDOWN IMMEDIATELY, but regular one use to roll back such transactions, and only commit it's own.\nAnother change - behaviour of Connection.close() when database has been shutdown already by this or another connection. There is no exception is thrown any more, where it used to be DATABASE_IS_CLOSED (90098), if it's after \"SHUTDOWN IMMEDIATELY\", but after regular shutdown Connection.close() did not throw any exception.", "createdAt": "2020-03-18T11:54:01Z", "url": "https://github.com/h2database/h2database/pull/2516", "merged": true, "mergeCommit": {"oid": "4ffaf4de29255a45c9faa9ec8f060b661e5086ac"}, "closed": true, "closedAt": "2020-03-18T19:17:19Z", "author": {"login": "andreitokar"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOaqrPAH2gAyMzkwMzkwODYxOmFiMjJkYmM2YzU0ODQ2MzQ5MTg4Nzc5YjBjYzQzNDg4MzhiNjEzMWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO3RLlAH2gAyMzkwMzkwODYxOjc1YWUyMmYyNWMzODlmZDkzYzZhNWFmYTljNWZlMTQwM2RmZGEyYzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ab22dbc6c54846349188779b0cc4348838b6131f", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/ab22dbc6c54846349188779b0cc4348838b6131f", "committedDate": "2020-03-17T04:05:10Z", "message": "fix too aggressive removal info collection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0dfad3a5992d9f5b14cc99e20701180d12be555", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/f0dfad3a5992d9f5b14cc99e20701180d12be555", "committedDate": "2020-03-18T03:43:25Z", "message": "fix TestAutoSever in big mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2a5587a1a28404096565004474f52d095176f99", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/c2a5587a1a28404096565004474f52d095176f99", "committedDate": "2020-03-18T03:43:50Z", "message": "fix for #2507 SHUTDOWN IMMEDIATELY"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d55b6e29e9eb3444d6705b099748096c11845056", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/d55b6e29e9eb3444d6705b099748096c11845056", "committedDate": "2020-03-18T04:22:57Z", "message": "do not test for exceptions on Connection.close() after shut down"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2ODM5NjY3", "url": "https://github.com/h2database/h2database/pull/2516#pullrequestreview-376839667", "createdAt": "2020-03-18T13:01:59Z", "commit": {"oid": "d55b6e29e9eb3444d6705b099748096c11845056"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMzowMTo1OVrOF4D4eQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMzowMTo1OVrOF4D4eQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMyODE4NQ==", "bodyText": "It looks like indentation is too large here and below.", "url": "https://github.com/h2database/h2database/pull/2516#discussion_r394328185", "createdAt": "2020-03-18T13:01:59Z", "author": {"login": "katzyn"}, "path": "h2/src/test/org/h2/test/server/TestAutoServer.java", "diffHunk": "@@ -72,42 +72,40 @@ private void testAutoServer(boolean port) throws Exception {\n             url += \";AUTO_SERVER_PORT=11111\";\n         }\n         String user = getUser(), password = getPassword();\n-        Connection connServer = getConnection(url + \";OPEN_NEW=TRUE\",\n-                user, password);\n-\n-        int i = ITERATIONS;\n-        for (; i > 0; i--) {\n-            Thread.sleep(100);\n-            SortedProperties prop = SortedProperties.loadProperties(\n-                    getBaseDir() + \"/\" + getTestName() + \".lock.db\");\n-            String key = prop.getProperty(\"id\");\n-            String server = prop.getProperty(\"server\");\n-            if (server != null) {\n-                String u2 = url.substring(url.indexOf(';'));\n-                u2 = \"jdbc:h2:tcp://\" + server + \"/\" + key + u2;\n-                Connection conn = DriverManager.getConnection(u2, user, password);\n-                conn.close();\n-                int gotPort = Integer.parseInt(server.substring(server.lastIndexOf(':') + 1));\n-                if (port) {\n-                    assertEquals(11111, gotPort);\n+        Connection connServer = getConnection(url + \";OPEN_NEW=TRUE\", user, password);\n+            int i = ITERATIONS;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d55b6e29e9eb3444d6705b099748096c11845056"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2ODQ3NDU0", "url": "https://github.com/h2database/h2database/pull/2516#pullrequestreview-376847454", "createdAt": "2020-03-18T13:12:13Z", "commit": {"oid": "d55b6e29e9eb3444d6705b099748096c11845056"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMzoxMjoxM1rOF4EQ7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMzoxMjoxM1rOF4EQ7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMzNDQ0NA==", "bodyText": "Such line wrapping looks weird, it's better to place compactMode == 0 on the same line with && conditions to group all operands of logical AND together and have logical OR operands on different lines.\nIndentation of line 481 has one extra space character, build script will complain about it.", "url": "https://github.com/h2database/h2database/pull/2516#discussion_r394334444", "createdAt": "2020-03-18T13:12:13Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/pagestore/PageStore.java", "diffHunk": "@@ -477,7 +477,8 @@ public synchronized void compact(int compactMode) {\n             return;\n         }\n         if (SysProperties.MODIFY_ON_WRITE && readMode &&\n-                compactMode == 0) {\n+                compactMode == 0 ||\n+                 compactMode == CommandInterface.SHUTDOWN_IMMEDIATELY) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d55b6e29e9eb3444d6705b099748096c11845056"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75ae22f25c389fd93c6a5afa9c5fe1403dfda2c1", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/75ae22f25c389fd93c6a5afa9c5fe1403dfda2c1", "committedDate": "2020-03-18T13:24:34Z", "message": "indentation fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3844, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}