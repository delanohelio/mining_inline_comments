{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1MjQ3Mzc1", "number": 2737, "title": "Assorted changes", "bodyText": "Minor optimizations in some methods of InformationSchemaTable and in some other places. For example, check for presence of user tables doesn't allocate list of all tables any more.\n\n\nResult of DatabaseMetaData.supportsPositionedInsert(), supportsPositionedUpdate(), and supportsMultipleOpenResults() is corrected.\n\n\nUndocumented Session.lastTriggerIdentity field and related methods are removed. I can't find any discussions about them over the Internet, they violate specification of SCOPE_IDENTITY and don't look like something useful. Perhaps this feature was used by somebody as a some workaround in archaic versions of H2. Now H2 has simple sane reliable way to return generated keys from a trigger without any special methods or functions, there is no need to use internal API for them.\n\n\nMVTableEngine is removed. Its inner classes are moved into own files. Initialization methods of storage engines are reorganized. getPageStore() is not used any more to initialize the default MVStore engine, now it is for PageStore only.\n\n\nMany issues with incorrect usage of System.nanoTime() are fixed. Code in some places relied on positive returned values, but positive values aren't guaranteed. Code in many places was unable to handle overflow, but overflow is also allowed by specification of nanoTime(). I didn't check its usage it test cases and tools, however.", "createdAt": "2020-07-07T08:28:36Z", "url": "https://github.com/h2database/h2database/pull/2737", "merged": true, "mergeCommit": {"oid": "14c696c68517e9e2f7ca61ed7dfad0aef8fbbbc5"}, "closed": true, "closedAt": "2020-07-07T11:04:04Z", "author": {"login": "katzyn"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyGPpagH2gAyNDQ1MjQ3Mzc1Ojc5MjMyY2Q1NzU1NjExZWJlMTM0YTk5ZmExZGMyYjE5NGU3YmJmNmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyjQrBgH2gAyNDQ1MjQ3Mzc1OmQ5NzdmMDY1OTk0MGY3NGY3NmNkODRhNDlhN2E4ODQxYmRiZjY5OTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "79232cd5755611ebe134a99fa1dc2b194e7bbf6f", "author": {"user": {"login": "katzyn", "name": "Evgenij Ryazanov"}}, "url": "https://github.com/h2database/h2database/commit/79232cd5755611ebe134a99fa1dc2b194e7bbf6f", "committedDate": "2020-07-06T00:38:49Z", "message": "Extract checkMetaTables() from initMetaTable() to allow inline optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60cc04bef0674c844896038a21f9c94ef34d638c", "author": {"user": {"login": "katzyn", "name": "Evgenij Ryazanov"}}, "url": "https://github.com/h2database/h2database/commit/60cc04bef0674c844896038a21f9c94ef34d638c", "committedDate": "2020-07-06T01:30:15Z", "message": "Don't check index conditions twice in InformationSchemaTable.indexes()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "211b4dc8ae429c0c88c384377a227914249c632a", "author": {"user": {"login": "katzyn", "name": "Evgenij Ryazanov"}}, "url": "https://github.com/h2database/h2database/commit/211b4dc8ae429c0c88c384377a227914249c632a", "committedDate": "2020-07-06T01:42:53Z", "message": "Don't check index conditions twice in InformationSchemaTable.columns()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc4e90a60fb3a82ec3143d862564458f63417c83", "author": {"user": {"login": "katzyn", "name": "Evgenij Ryazanov"}}, "url": "https://github.com/h2database/h2database/commit/cc4e90a60fb3a82ec3143d862564458f63417c83", "committedDate": "2020-07-06T05:42:23Z", "message": "Don't use Database.getAllTablesAndViews() when not necessary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b1ff08873977955ea83da547902681741dca52b", "author": {"user": {"login": "katzyn", "name": "Evgenij Ryazanov"}}, "url": "https://github.com/h2database/h2database/commit/5b1ff08873977955ea83da547902681741dca52b", "committedDate": "2020-07-06T08:47:17Z", "message": "Return false from supportsPositioned*() and supportsMultipleOpenResults()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b93aa2335edf4ce59acda7a1ab509de16610e5d3", "author": {"user": {"login": "katzyn", "name": "Evgenij Ryazanov"}}, "url": "https://github.com/h2database/h2database/commit/b93aa2335edf4ce59acda7a1ab509de16610e5d3", "committedDate": "2020-07-06T10:23:00Z", "message": "Remove lastTriggerIdentity and test normal generated keys from a trigger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4e7d72b6677064da773c5aba9cab5ac844f095c", "author": {"user": {"login": "katzyn", "name": "Evgenij Ryazanov"}}, "url": "https://github.com/h2database/h2database/commit/a4e7d72b6677064da773c5aba9cab5ac844f095c", "committedDate": "2020-07-07T01:19:42Z", "message": "Remove MVTableEngine wrapper and create Store directly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa2a6e6763e64d964e0e1a87a83eaa98872eee9a", "author": {"user": {"login": "katzyn", "name": "Evgenij Ryazanov"}}, "url": "https://github.com/h2database/h2database/commit/aa2a6e6763e64d964e0e1a87a83eaa98872eee9a", "committedDate": "2020-07-07T01:38:30Z", "message": "Inline Database.openDatabase() into constructor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb6d65e0382aa787e02f7c084b45bbcb4dde9946", "author": {"user": {"login": "katzyn", "name": "Evgenij Ryazanov"}}, "url": "https://github.com/h2database/h2database/commit/bb6d65e0382aa787e02f7c084b45bbcb4dde9946", "committedDate": "2020-07-07T02:00:20Z", "message": "Extract assertion code from Database.lockMeta() into own method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b28c0d6c1549eab57a466794ac33ce0fc1a4be3", "author": {"user": {"login": "katzyn", "name": "Evgenij Ryazanov"}}, "url": "https://github.com/h2database/h2database/commit/9b28c0d6c1549eab57a466794ac33ce0fc1a4be3", "committedDate": "2020-07-07T07:39:00Z", "message": "Fix System.nanoTime() comparison in the main code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNjgyMTM4", "url": "https://github.com/h2database/h2database/pull/2737#pullrequestreview-443682138", "createdAt": "2020-07-07T08:40:20Z", "commit": {"oid": "b93aa2335edf4ce59acda7a1ab509de16610e5d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwODo0MDoyMFrOGt0siA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwODo0MDoyMFrOGt0siA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwMjQ3Mg==", "bodyText": "I think you broke a valid use-case of scope_identity(), which this test was checking .e.g see\nhttps://stackoverflow.com/a/1920640/6591", "url": "https://github.com/h2database/h2database/pull/2737#discussion_r450702472", "createdAt": "2020-07-07T08:40:20Z", "author": {"login": "grandinj"}, "path": "h2/src/test/org/h2/test/jdbc/TestPreparedStatement.java", "diffHunk": "@@ -564,49 +562,6 @@ private void testUUIDAsJavaObject(Connection conn) throws SQLException {\n         stat.execute(\"drop table test_uuid\");\n     }\n \n-    /**\n-     * A trigger that creates a sequence value.\n-     */\n-    public static class SequenceTrigger implements Trigger {\n-\n-        @Override\n-        public void fire(Connection conn, Object[] oldRow, Object[] newRow)\n-                throws SQLException {\n-            conn.setAutoCommit(false);\n-            conn.createStatement().execute(\"call next value for seq\");\n-        }\n-\n-        @Override\n-        public void init(Connection conn, String schemaName,\n-                String triggerName, String tableName, boolean before, int type) {\n-            // ignore\n-        }\n-\n-    }\n-\n-    private void testScopedGeneratedKey(Connection conn) throws SQLException {\n-        Statement stat = conn.createStatement();\n-        stat.execute(\"create table test(id identity)\");\n-        stat.execute(\"create sequence seq start with 1000\");\n-        stat.execute(\"create trigger test_ins after insert on test call \\\"\" +\n-                SequenceTrigger.class.getName() + \"\\\"\");\n-        stat.execute(\"insert into test values(null)\", Statement.RETURN_GENERATED_KEYS);\n-        ResultSet rs = stat.getGeneratedKeys();\n-        rs.next();\n-        // Generated key\n-        assertEquals(1, rs.getLong(1));\n-        stat.execute(\"insert into test values(100)\");\n-        rs = stat.getGeneratedKeys();\n-        // No generated keys\n-        assertFalse(rs.next());\n-        // Value from sequence from trigger\n-        rs = stat.executeQuery(\"select scope_identity()\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b93aa2335edf4ce59acda7a1ab509de16610e5d3"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d977f0659940f74f76cd84a49a7a8841bdbf6994", "author": {"user": {"login": "katzyn", "name": "Evgenij Ryazanov"}}, "url": "https://github.com/h2database/h2database/commit/d977f0659940f74f76cd84a49a7a8841bdbf6994", "committedDate": "2020-07-07T10:27:11Z", "message": "Update changelog"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4274, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}