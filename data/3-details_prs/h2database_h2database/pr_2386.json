{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNzU1NDY4", "number": 2386, "title": "Chunk occupancy mask", "bodyText": "Determination of dead chunks is now done by actual counting of live pages within it, but chunks overwrite - process of moving all live pages from sparsely populated chunks into a new one is still using trees scanning to determine which pages are still live within the chunk. This is extremely expensive in terms of I/O operations.\nThis PR changes the strategy of this process by introducing \"table of content\" (ToC) and occupancy bitmask for each chunk. ToC is an array of (map id, page offset, page length) written at the end of each chunk (with it's offset written into chunk header/metadata). ToCs are cached in a separate 1MB LIRR cache. Occupancy bitmask has one bit-per-page set to 1 for the dead pages. It resides in memory as part of a chunk structure and also persisted as part of chunk's metadata. Also sequential page number within a chunk is written at the end of each page.\nMaintaining those two structures will fully avoid maps scanning during chunk rewrite, since we can directly enumerate all live pages within the chunk (scanning occupancy bitmask) and find their offset and owning map from ToC.\nI did a simple experiment of building table with three UUID indexed fields and 50,000,000 rows in 100,000 row batches with 10 sec intervals in-between to allow for housekeeping. Every 5,000,000 rows SHUTDOW DEFRAG is executed. It show 3-fold reduction in reads and 2-fold write reduction compare to master. Database file growth also slows down significantly.", "createdAt": "2020-01-09T03:47:41Z", "url": "https://github.com/h2database/h2database/pull/2386", "merged": true, "mergeCommit": {"oid": "602c463c4618aff4f936ba2b28b94bf0908c11c9"}, "closed": true, "closedAt": "2020-01-12T16:52:37Z", "author": {"login": "andreitokar"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4KUq7gH2gAyMzYwNzU1NDY4OmYxMGZjOTQwYTkzODJiMGY5ZTdiZDY4Y2EzZWIxNmU1NjRjODg3YmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb5YI7QgH2gAyMzYwNzU1NDY4OmNiMWVkYjc1NjllZTQzZWI4MDk0YmJkZmIyYTk0MDQzODA2ZTU1MjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f10fc940a9382b0f9e7bd68ca3eb16e564c887be", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/f10fc940a9382b0f9e7bd68ca3eb16e564c887be", "committedDate": "2020-01-08T00:36:19Z", "message": "Introduce chunk's table of content, switch to explicit page liveliness tracking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e8897d7f37f2e2be43b901a43a0590bc62311d1", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/4e8897d7f37f2e2be43b901a43a0590bc62311d1", "committedDate": "2020-01-08T00:36:19Z", "message": "improve chunk rewriting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5885ef2e740ca28b2318cd6ccb1d61925f7d9d3c", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/5885ef2e740ca28b2318cd6ccb1d61925f7d9d3c", "committedDate": "2020-01-08T00:36:19Z", "message": "backward compatibility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8fff5c6c7cdd8f273d139602f5ef432d4937a66", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/b8fff5c6c7cdd8f273d139602f5ef432d4937a66", "committedDate": "2020-01-08T00:36:19Z", "message": "minor fixes, mute assertion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1439b575b5f93e9e1db69277bccbd7e3b8ca05b1", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/1439b575b5f93e9e1db69277bccbd7e3b8ca05b1", "committedDate": "2020-01-08T00:36:20Z", "message": "prevent infinite loop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b61a58abb32c498caadd83d5eb77ce3a7910cb58", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/b61a58abb32c498caadd83d5eb77ce3a7910cb58", "committedDate": "2020-01-08T00:36:20Z", "message": "expose ToC cache hit rate in meta table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6591874b53fdf395feba38c9d7c94de080a9b9e0", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/6591874b53fdf395feba38c9d7c94de080a9b9e0", "committedDate": "2020-01-08T00:36:20Z", "message": "Remove faulty assertion. Purge dead chunk/pages from cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9e0c9f64074186077461ce40ba2a9b9f93f9149", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/b9e0c9f64074186077461ce40ba2a9b9f93f9149", "committedDate": "2020-01-08T00:36:20Z", "message": "Expand DecisionMaker's context. Eliminate unneccessary page rewrites."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "274db3b430259df47dea7688e4ab0fd997a0e1b2", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/274db3b430259df47dea7688e4ab0fd997a0e1b2", "committedDate": "2020-01-08T00:36:20Z", "message": "fix NPE when cache is disabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97ff43bff3f49efdf8ddc1e2b0f7ac1fd046965b", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/97ff43bff3f49efdf8ddc1e2b0f7ac1fd046965b", "committedDate": "2020-01-08T00:36:20Z", "message": "RewriteDecisionMaker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7c28864e604047c9df77a28b95e9405d9233e8c", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/d7c28864e604047c9df77a28b95e9405d9233e8c", "committedDate": "2020-01-08T00:36:20Z", "message": "empty chunks handling in readStoreHeader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68fc8ccc7f647d0f3a0ae529adcccbe93aff80f3", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/68fc8ccc7f647d0f3a0ae529adcccbe93aff80f3", "committedDate": "2020-01-08T00:36:20Z", "message": "rewritable chunks fill rate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d85ecddd40b4d45562246523d998da25853aceae", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/d85ecddd40b4d45562246523d998da25853aceae", "committedDate": "2020-01-08T00:36:20Z", "message": "page rewriting for meta did not worked"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aad5555f7aea985926eaee2ee1d51331a4de23df", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/aad5555f7aea985926eaee2ee1d51331a4de23df", "committedDate": "2020-01-08T00:36:20Z", "message": "move pageNo from ToC into page itself"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3a0518132db40e54623219fe80d4b1abe86318f", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/e3a0518132db40e54623219fe80d4b1abe86318f", "committedDate": "2020-01-08T00:36:20Z", "message": "fix failure (chunk reading) in MVStoreTools"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94fcfcd387b8b98dff4a4411ba266428a623e265", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/94fcfcd387b8b98dff4a4411ba266428a623e265", "committedDate": "2020-01-08T00:36:20Z", "message": "cope withe case when pageNo == -1 (backward compatibility)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMjg5OTQx", "url": "https://github.com/h2database/h2database/pull/2386#pullrequestreview-340289941", "createdAt": "2020-01-09T04:59:14Z", "commit": {"oid": "94fcfcd387b8b98dff4a4411ba266428a623e265"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwNDo1OToxNFrOFbq92w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwNTowMTo0M1rOFbq_XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU1OTgzNQ==", "bodyText": "We have StringUtils.convertBytesToHex() for this purpose.", "url": "https://github.com/h2database/h2database/pull/2386#discussion_r364559835", "createdAt": "2020-01-09T04:59:14Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/mvstore/DataUtils.java", "diffHunk": "@@ -1106,6 +1149,56 @@ public static int readHexInt(Map<String, ?> map, String key, int defaultValue) {\n         }\n     }\n \n+    public static String hexEncodeBytes(byte[] bytes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94fcfcd387b8b98dff4a4411ba266428a623e265"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU2MDIyMA==", "bodyText": "StringUtils.convertHexToBytes().", "url": "https://github.com/h2database/h2database/pull/2386#discussion_r364560220", "createdAt": "2020-01-09T05:01:43Z", "author": {"login": "katzyn"}, "path": "h2/src/main/org/h2/mvstore/DataUtils.java", "diffHunk": "@@ -1106,6 +1149,56 @@ public static int readHexInt(Map<String, ?> map, String key, int defaultValue) {\n         }\n     }\n \n+    public static String hexEncodeBytes(byte[] bytes) {\n+        StringBuilder sb = new StringBuilder(bytes.length * 2);\n+        for (byte b : bytes) {\n+            sb.append(getHexDigitFor(b >> 4));\n+            sb.append(getHexDigitFor(b));\n+        }\n+        return sb.toString();\n+    }\n+\n+    private static char getHexDigitFor(int digit) {\n+        digit &= 0xF;\n+        return (char)((digit < 10 ? '0' : 'a' - 10) + digit);\n+    }\n+\n+    public static byte[] parseHexBytes(Map<String, ?> map, String key) {\n+        Object v = map.get(key);\n+        if (v == null) {\n+            return null;\n+        }\n+        String s = (String)v;\n+        try {\n+            int length = s.length();\n+            byte[] data = new byte[length / 2];\n+            for(int i = 0; i < length; i += 2) {\n+                data[i / 2] = (byte)((hexValueOf(s.charAt(i)) << 4)\n+                                    | hexValueOf(s.charAt(i + 1)));\n+            }\n+            return data;\n+        } catch (NumberFormatException e) {\n+            throw newIllegalStateException(ERROR_FILE_CORRUPT,\n+                    \"Error parsing the value {0}\", v, e);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94fcfcd387b8b98dff4a4411ba266428a623e265"}, "originalPosition": 134}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f78c77a6add42e4e058a1430d1dfaee68b4c5d3", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/7f78c77a6add42e4e058a1430d1dfaee68b4c5d3", "committedDate": "2020-01-11T12:52:15Z", "message": "use StringUtils.convertHexToBytes()/convertBytesToHex()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb1edb7569ee43eb8094bbdfb2a94043806e5526", "author": {"user": {"login": "andreitokar", "name": "Andrei Tokar"}}, "url": "https://github.com/h2database/h2database/commit/cb1edb7569ee43eb8094bbdfb2a94043806e5526", "committedDate": "2020-01-11T19:16:05Z", "message": "Backward compatibility: move pageNo to the end, beyond compressed area and exclude it from pageLength"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3893, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}