{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1NDY4MTM3", "number": 1628, "title": "Download sources for the masses", "bodyText": "Fixes redhat-developer/vscode-java#1664\nDownload maven-central artifact's sources on-demand\n\nSigned-off-by: Fred Bricon fbricon@gmail.com\n[rgrunber@redhat.com]: Fix testDynamicSourceLookups()\n\nMove testcase from HoverHandlerTest to InvisibleProjectBuildSupportTest\nSet up the external library after project import to mimic approach\nin other invisible projects\nSigned-off-by: Roland Grunberg rgrunber@redhat.com\n\n@fbricon\nBased on #1580 .", "createdAt": "2020-12-09T21:13:06Z", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628", "merged": true, "mergeCommit": {"oid": "6dd38fab589649500e3854ae56711929afa091dd"}, "closed": true, "closedAt": "2021-01-15T04:04:50Z", "author": {"login": "rgrunber"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmasDAAFqTU1MjQxODY1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABduO1pQgBqjQxODU5ODExNzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNDE4NjUz", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#pullrequestreview-552418653", "createdAt": "2020-12-15T12:53:29Z", "commit": {"oid": "8d699751aaebc5fa470683d4e316e0b2693c1f95"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMjo1MzoyOVrOIGJa9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMzozNjozNVrOIGLNfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxNjcyNw==", "bodyText": "Missing copyright header", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r543316727", "createdAt": "2020-12-15T12:53:29Z", "author": {"login": "testforstephen"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/MavenPropertiesIdentifier.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.eclipse.jdt.ls.core.internal;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d699751aaebc5fa470683d4e316e0b2693c1f95"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM0MTI5Ng==", "bodyText": "Since this file is only used by MavenSourceDownloader, how about moving it to the package org.eclipse.jdt.ls.core.internal.managers?", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r543341296", "createdAt": "2020-12-15T13:29:48Z", "author": {"login": "testforstephen"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/MavenPropertiesIdentifier.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.eclipse.jdt.ls.core.internal;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxNjcyNw=="}, "originalCommit": {"oid": "8d699751aaebc5fa470683d4e316e0b2693c1f95"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM0NjA0Ng==", "bodyText": "Looks like MavenPropertiesIdentifier and MavenCentralIdentifier share some common interface, how about extracting to an interface such as IMavenArtifactIdentifier?\npublic interface IMavenArtifactIdentifier {\n    public ArtifactKey identify(IPath path, IProgressMonitor monitor);\n\n    public ArtifactKey identify(File file, IProgressMonitor monitor);\n}", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r543346046", "createdAt": "2020-12-15T13:36:35Z", "author": {"login": "testforstephen"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/MavenPropertiesIdentifier.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.eclipse.jdt.ls.core.internal;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Enumeration;\n+import java.util.Properties;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipFile;\n+\n+import org.eclipse.core.runtime.IPath;\n+import org.eclipse.core.runtime.IProgressMonitor;\n+import org.eclipse.m2e.core.embedder.ArtifactKey;\n+\n+\n+public class MavenPropertiesIdentifier {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d699751aaebc5fa470683d4e316e0b2693c1f95"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d699751aaebc5fa470683d4e316e0b2693c1f95", "author": {"user": {"login": "fbricon", "name": "Fred Bricon"}}, "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/8d699751aaebc5fa470683d4e316e0b2693c1f95", "committedDate": "2020-12-09T21:07:35Z", "message": "Download sources for the masses\n\n- Fixes redhat-developer/vscode-java#1664\n- Download maven-central artifact's sources on-demand\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>\n[rgrunber@redhat.com]: Fix testDynamicSourceLookups()\n- Move testcase from HoverHandlerTest to InvisibleProjectBuildSupportTest\n- Set up the external library after project import to mimic approach\n  in other invisible projects\nSigned-off-by: Roland Grunberg <rgrunber@redhat.com>"}, "afterCommit": {"oid": "112110bac02b0601cd4ae4ce05baf7a0c28e8643", "author": {"user": {"login": "fbricon", "name": "Fred Bricon"}}, "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/112110bac02b0601cd4ae4ce05baf7a0c28e8643", "committedDate": "2021-01-04T20:35:16Z", "message": "Download sources for the masses\n\n- Fixes redhat-developer/vscode-java#1664\n- Download maven-central artifact's sources on-demand\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>\n[rgrunber@redhat.com]: Fix testDynamicSourceLookups()\n- Move testcase from HoverHandlerTest to InvisibleProjectBuildSupportTest\n- Set up the external library after project import to mimic approach\n  in other invisible projects\n- Create IMavenArtifactIdentifier to be implemented by\n  MavenPropertiesIdentifier and MavenCentralIdentifier\nSigned-off-by: Roland Grunberg <rgrunber@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMTgwNjYx", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#pullrequestreview-563180661", "createdAt": "2021-01-07T03:01:13Z", "commit": {"oid": "112110bac02b0601cd4ae4ce05baf7a0c28e8643"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwMzowMToxM1rOIPdflQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwMzowMToxM1rOIPdflQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA4Mjc3Mw==", "bodyText": "Need a PR in the client side to expose the new preference key.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r553082773", "createdAt": "2021-01-07T03:01:13Z", "author": {"login": "testforstephen"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -129,6 +129,11 @@\n \t * Preference key to enable/disable downloading Maven source artifacts.\n \t */\n \tpublic static final String MAVEN_DOWNLOAD_SOURCES = \"java.maven.downloadSources\";\n+\t/**\n+\t * Preference key to enable/disable downloading source artifacts for Eclipse\n+\t * projects.\n+\t */\n+\tpublic static final String ECLIPSE_DOWNLOAD_SOURCES = \"java.eclipse.downloadSources\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112110bac02b0601cd4ae4ce05baf7a0c28e8643"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0NDM5NzM1", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#pullrequestreview-564439735", "createdAt": "2021-01-08T17:17:58Z", "commit": {"oid": "112110bac02b0601cd4ae4ce05baf7a0c28e8643"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOFQxNzoxNzo1OFrOIQadYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOFQxNzoxNzo1OFrOIQadYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4MTYzMw==", "bodyText": "Ran into a potential issue here. For Eclipse projects, classpath entries can be relative also :\n<classpathentry kind=\"lib\" path=\"lib/remark.jar\"/> , which resolves to a path (workspace-relative) of /$project/lib/remark.jar here, and ultimately fails. I think getLocation() resolves the absolute path the way we want so I'll try that.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r554081633", "createdAt": "2021-01-08T17:17:58Z", "author": {"login": "rgrunber"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/MavenSourceDownloader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.core.internal.managers;\n+\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.core.resources.IFile;\n+import org.eclipse.core.resources.ResourcesPlugin;\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IPath;\n+import org.eclipse.core.runtime.IProgressMonitor;\n+import org.eclipse.jdt.core.IClassFile;\n+import org.eclipse.jdt.core.IJavaElement;\n+import org.eclipse.jdt.core.IPackageFragmentRoot;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.m2e.core.embedder.ArtifactKey;\n+import org.eclipse.m2e.jdt.IClasspathManager;\n+import org.eclipse.m2e.jdt.MavenJdtPlugin;\n+import org.eclipse.m2e.jdt.internal.BuildPathManager;\n+\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+\n+/**\n+ * {@link ISourceDownloader} implementation based on m2e's\n+ * {@link IClasspathManager}' source download facilities.\n+ *\n+ * @author Fred Bricon\n+ *\n+ */\n+public class MavenSourceDownloader implements ISourceDownloader {\n+\n+\tprivate static Cache<String, Boolean> downloadRequestsCache = CacheBuilder.newBuilder().maximumSize(100).expireAfterWrite(1, TimeUnit.HOURS).build();\n+\tprivate static final int MAX_TIME_MILLIS = 3000;\n+\n+\t@Override\n+\tpublic void discoverSource(IClassFile classFile, IProgressMonitor monitor) throws CoreException {\n+\t\tif (classFile == null) {\n+\t\t\treturn;\n+\t\t}\n+\t\tIJavaElement element = classFile;\n+\t\twhile (element.getParent() != null) {\n+\t\t\telement = element.getParent();\n+\t\t\tif (element instanceof IPackageFragmentRoot) {\n+\t\t\t\tfinal IPackageFragmentRoot fragment = (IPackageFragmentRoot) element;\n+\t\t\t\tIPath attachmentPath = fragment.getSourceAttachmentPath();\n+\t\t\t\tif (attachmentPath != null && !attachmentPath.isEmpty() && attachmentPath.toFile().exists()) {\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t\tif (fragment.isArchive()) {\n+\t\t\t\t\tIFile file = ResourcesPlugin.getWorkspace().getRoot().getFile(fragment.getPath());\n+\t\t\t\t\tIPath path = file.getFullPath();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112110bac02b0601cd4ae4ce05baf7a0c28e8643"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10aa622f589b692faccdea98389d34c042ee5a1e", "author": {"user": {"login": "fbricon", "name": "Fred Bricon"}}, "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/10aa622f589b692faccdea98389d34c042ee5a1e", "committedDate": "2021-01-08T20:34:11Z", "message": "Download sources for the masses\n\n- Fixes redhat-developer/vscode-java#1664\n- Download maven-central artifact's sources on-demand\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>\n[rgrunber@redhat.com]: Fix testDynamicSourceLookups()\n- Move testcase from HoverHandlerTest to InvisibleProjectBuildSupportTest\n- Set up the external library after project import to mimic approach\n  in other invisible projects\n- Create IMavenArtifactIdentifier to be implemented by\n  MavenPropertiesIdentifier and MavenCentralIdentifier\nSigned-off-by: Roland Grunberg <rgrunber@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "112110bac02b0601cd4ae4ce05baf7a0c28e8643", "author": {"user": {"login": "fbricon", "name": "Fred Bricon"}}, "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/112110bac02b0601cd4ae4ce05baf7a0c28e8643", "committedDate": "2021-01-04T20:35:16Z", "message": "Download sources for the masses\n\n- Fixes redhat-developer/vscode-java#1664\n- Download maven-central artifact's sources on-demand\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>\n[rgrunber@redhat.com]: Fix testDynamicSourceLookups()\n- Move testcase from HoverHandlerTest to InvisibleProjectBuildSupportTest\n- Set up the external library after project import to mimic approach\n  in other invisible projects\n- Create IMavenArtifactIdentifier to be implemented by\n  MavenPropertiesIdentifier and MavenCentralIdentifier\nSigned-off-by: Roland Grunberg <rgrunber@redhat.com>"}, "afterCommit": {"oid": "10aa622f589b692faccdea98389d34c042ee5a1e", "author": {"user": {"login": "fbricon", "name": "Fred Bricon"}}, "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/10aa622f589b692faccdea98389d34c042ee5a1e", "committedDate": "2021-01-08T20:34:11Z", "message": "Download sources for the masses\n\n- Fixes redhat-developer/vscode-java#1664\n- Download maven-central artifact's sources on-demand\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>\n[rgrunber@redhat.com]: Fix testDynamicSourceLookups()\n- Move testcase from HoverHandlerTest to InvisibleProjectBuildSupportTest\n- Set up the external library after project import to mimic approach\n  in other invisible projects\n- Create IMavenArtifactIdentifier to be implemented by\n  MavenPropertiesIdentifier and MavenCentralIdentifier\nSigned-off-by: Roland Grunberg <rgrunber@redhat.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1062, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}