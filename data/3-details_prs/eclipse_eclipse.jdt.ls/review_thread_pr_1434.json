{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzNjcxNDc1", "number": 1434, "reviewThreads": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMjo1NDoxMFrOD5zUmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxOToyNDo1OVrOD98M4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxOTM2MjgzOnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMjo1NDoxMFrOGRRibA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQxNjo1MjowMlrOGTFvmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc2NjMxNg==", "bodyText": "please remove that check", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r420766316", "createdAt": "2020-05-06T12:54:10Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.URL;\n+import java.net.URLConnection;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+\n+public class WrapperValidator {\n+\n+\tprivate static final String DISTRIBUTION_URL = \"distributionUrl\";\n+\tprivate static final String GRADLE_WRAPPER_PROPERTIES = \"gradle/wrapper/gradle-wrapper.properties\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate final boolean DISABLED = Boolean.getBoolean(\"gradle.wrapper.check.disabled\");\n+\tprivate HashProvider hashProvider;\n+\tprotected static Cache<String, String> downloadRequestsCache = CacheBuilder.newBuilder().maximumSize(100).expireAfterWrite(1, TimeUnit.HOURS).build();\n+\n+\n+\tpublic WrapperValidator() {\n+\t\tthis(new HashProvider());\n+\t}\n+\n+\tpublic WrapperValidator(HashProvider hashProvider) {\n+\t\tthis.hashProvider = hashProvider;\n+\t}\n+\n+\tpublic String checkWrapper(String baseDir) throws IOException, NoSuchAlgorithmException {\n+\t\tif (DISABLED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8df1aed87ae777b75799d2bda49b2ca404e54926"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY3MDIzMg==", "bodyText": "Removed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r422670232", "createdAt": "2020-05-10T16:52:02Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.URL;\n+import java.net.URLConnection;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+\n+public class WrapperValidator {\n+\n+\tprivate static final String DISTRIBUTION_URL = \"distributionUrl\";\n+\tprivate static final String GRADLE_WRAPPER_PROPERTIES = \"gradle/wrapper/gradle-wrapper.properties\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate final boolean DISABLED = Boolean.getBoolean(\"gradle.wrapper.check.disabled\");\n+\tprivate HashProvider hashProvider;\n+\tprotected static Cache<String, String> downloadRequestsCache = CacheBuilder.newBuilder().maximumSize(100).expireAfterWrite(1, TimeUnit.HOURS).build();\n+\n+\n+\tpublic WrapperValidator() {\n+\t\tthis(new HashProvider());\n+\t}\n+\n+\tpublic WrapperValidator(HashProvider hashProvider) {\n+\t\tthis.hashProvider = hashProvider;\n+\t}\n+\n+\tpublic String checkWrapper(String baseDir) throws IOException, NoSuchAlgorithmException {\n+\t\tif (DISABLED) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc2NjMxNg=="}, "originalCommit": {"oid": "8df1aed87ae777b75799d2bda49b2ca404e54926"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxOTM2NzU4OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMjo1NToxOFrOGRRlXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQxNjo1Njo1NVrOGTFxyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc2NzA2OA==", "bodyText": "validator should instead accept a list of authorized sha256s, provided via preferences", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r420767068", "createdAt": "2020-05-06T12:55:18Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.URL;\n+import java.net.URLConnection;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+\n+public class WrapperValidator {\n+\n+\tprivate static final String DISTRIBUTION_URL = \"distributionUrl\";\n+\tprivate static final String GRADLE_WRAPPER_PROPERTIES = \"gradle/wrapper/gradle-wrapper.properties\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate final boolean DISABLED = Boolean.getBoolean(\"gradle.wrapper.check.disabled\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8df1aed87ae777b75799d2bda49b2ca404e54926"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY3MDc5Mg==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r422670792", "createdAt": "2020-05-10T16:56:55Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.URL;\n+import java.net.URLConnection;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+\n+public class WrapperValidator {\n+\n+\tprivate static final String DISTRIBUTION_URL = \"distributionUrl\";\n+\tprivate static final String GRADLE_WRAPPER_PROPERTIES = \"gradle/wrapper/gradle-wrapper.properties\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate final boolean DISABLED = Boolean.getBoolean(\"gradle.wrapper.check.disabled\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc2NzA2OA=="}, "originalCommit": {"oid": "8df1aed87ae777b75799d2bda49b2ca404e54926"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxOTM4ODc3OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMzowMDoxNlrOGRRysg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQxNjo1MjoyNVrOGTFvyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc3MDQ4Mg==", "bodyText": "no. we should instead check the checksum exists in :\n1- a cache version of https://services.gradle.org/versions/all\n2- a live version of https://services.gradle.org/versions/all, if it wasn't found in the cache\nThis is fairly similar to https://github.com/gradle/wrapper-validation-action/blob/master/src/checksums.ts, but with a local cache", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r420770482", "createdAt": "2020-05-06T13:00:16Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.URL;\n+import java.net.URLConnection;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+\n+public class WrapperValidator {\n+\n+\tprivate static final String DISTRIBUTION_URL = \"distributionUrl\";\n+\tprivate static final String GRADLE_WRAPPER_PROPERTIES = \"gradle/wrapper/gradle-wrapper.properties\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate final boolean DISABLED = Boolean.getBoolean(\"gradle.wrapper.check.disabled\");\n+\tprivate HashProvider hashProvider;\n+\tprotected static Cache<String, String> downloadRequestsCache = CacheBuilder.newBuilder().maximumSize(100).expireAfterWrite(1, TimeUnit.HOURS).build();\n+\n+\n+\tpublic WrapperValidator() {\n+\t\tthis(new HashProvider());\n+\t}\n+\n+\tpublic WrapperValidator(HashProvider hashProvider) {\n+\t\tthis.hashProvider = hashProvider;\n+\t}\n+\n+\tpublic String checkWrapper(String baseDir) throws IOException, NoSuchAlgorithmException {\n+\t\tif (DISABLED) {\n+\t\t\treturn null;\n+\t\t}\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\treturn wrapperJar.toString() + \" doesn't exist.\";\n+\t\t}\n+\t\tPath wrapperProperties = Paths.get(baseDir, GRADLE_WRAPPER_PROPERTIES);\n+\t\tif (!wrapperProperties.toFile().exists()) {\n+\t\t\treturn wrapperProperties.toString() + \" doesn't exist.\";\n+\t\t}\n+\t\ttry (InputStream is = new FileInputStream(wrapperProperties.toFile())) {\n+\t\t\tProperties props = new Properties();\n+\t\t\tprops.load(is);\n+\t\t\tString distributionUrl = props.getProperty(DISTRIBUTION_URL);\n+\t\t\tif (distributionUrl == null) {\n+\t\t\t\treturn \"Invalid the distributionUrl property\";\n+\t\t\t}\n+\t\t\tString sha256Url = distributionUrl.replace(\"-bin.zip\",\"\").replace(\"-all.zip\", \"\") + \"-wrapper.jar.sha256\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8df1aed87ae777b75799d2bda49b2ca404e54926"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY3MDI4Mg==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r422670282", "createdAt": "2020-05-10T16:52:25Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.URL;\n+import java.net.URLConnection;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+\n+public class WrapperValidator {\n+\n+\tprivate static final String DISTRIBUTION_URL = \"distributionUrl\";\n+\tprivate static final String GRADLE_WRAPPER_PROPERTIES = \"gradle/wrapper/gradle-wrapper.properties\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate final boolean DISABLED = Boolean.getBoolean(\"gradle.wrapper.check.disabled\");\n+\tprivate HashProvider hashProvider;\n+\tprotected static Cache<String, String> downloadRequestsCache = CacheBuilder.newBuilder().maximumSize(100).expireAfterWrite(1, TimeUnit.HOURS).build();\n+\n+\n+\tpublic WrapperValidator() {\n+\t\tthis(new HashProvider());\n+\t}\n+\n+\tpublic WrapperValidator(HashProvider hashProvider) {\n+\t\tthis.hashProvider = hashProvider;\n+\t}\n+\n+\tpublic String checkWrapper(String baseDir) throws IOException, NoSuchAlgorithmException {\n+\t\tif (DISABLED) {\n+\t\t\treturn null;\n+\t\t}\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\treturn wrapperJar.toString() + \" doesn't exist.\";\n+\t\t}\n+\t\tPath wrapperProperties = Paths.get(baseDir, GRADLE_WRAPPER_PROPERTIES);\n+\t\tif (!wrapperProperties.toFile().exists()) {\n+\t\t\treturn wrapperProperties.toString() + \" doesn't exist.\";\n+\t\t}\n+\t\ttry (InputStream is = new FileInputStream(wrapperProperties.toFile())) {\n+\t\t\tProperties props = new Properties();\n+\t\t\tprops.load(is);\n+\t\t\tString distributionUrl = props.getProperty(DISTRIBUTION_URL);\n+\t\t\tif (distributionUrl == null) {\n+\t\t\t\treturn \"Invalid the distributionUrl property\";\n+\t\t\t}\n+\t\t\tString sha256Url = distributionUrl.replace(\"-bin.zip\",\"\").replace(\"-all.zip\", \"\") + \"-wrapper.jar.sha256\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc3MDQ4Mg=="}, "originalCommit": {"oid": "8df1aed87ae777b75799d2bda49b2ca404e54926"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxOTM5OTI2OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMzowMzowMVrOGRR5Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQxNjo1NzowOFrOGTFx3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc3MjE1NQ==", "bodyText": "I'd rather throw an exception here", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r420772155", "createdAt": "2020-05-06T13:03:01Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.URL;\n+import java.net.URLConnection;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+\n+public class WrapperValidator {\n+\n+\tprivate static final String DISTRIBUTION_URL = \"distributionUrl\";\n+\tprivate static final String GRADLE_WRAPPER_PROPERTIES = \"gradle/wrapper/gradle-wrapper.properties\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate final boolean DISABLED = Boolean.getBoolean(\"gradle.wrapper.check.disabled\");\n+\tprivate HashProvider hashProvider;\n+\tprotected static Cache<String, String> downloadRequestsCache = CacheBuilder.newBuilder().maximumSize(100).expireAfterWrite(1, TimeUnit.HOURS).build();\n+\n+\n+\tpublic WrapperValidator() {\n+\t\tthis(new HashProvider());\n+\t}\n+\n+\tpublic WrapperValidator(HashProvider hashProvider) {\n+\t\tthis.hashProvider = hashProvider;\n+\t}\n+\n+\tpublic String checkWrapper(String baseDir) throws IOException, NoSuchAlgorithmException {\n+\t\tif (DISABLED) {\n+\t\t\treturn null;\n+\t\t}\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\treturn wrapperJar.toString() + \" doesn't exist.\";\n+\t\t}\n+\t\tPath wrapperProperties = Paths.get(baseDir, GRADLE_WRAPPER_PROPERTIES);\n+\t\tif (!wrapperProperties.toFile().exists()) {\n+\t\t\treturn wrapperProperties.toString() + \" doesn't exist.\";\n+\t\t}\n+\t\ttry (InputStream is = new FileInputStream(wrapperProperties.toFile())) {\n+\t\t\tProperties props = new Properties();\n+\t\t\tprops.load(is);\n+\t\t\tString distributionUrl = props.getProperty(DISTRIBUTION_URL);\n+\t\t\tif (distributionUrl == null) {\n+\t\t\t\treturn \"Invalid the distributionUrl property\";\n+\t\t\t}\n+\t\t\tString sha256Url = distributionUrl.replace(\"-bin.zip\",\"\").replace(\"-all.zip\", \"\") + \"-wrapper.jar.sha256\";\n+\t\t\tString checksum = hashProvider.getChecksum(wrapperJar.toFile());\n+\t\t\tString remoteChecksum = downloadRequestsCache.getIfPresent(sha256Url);\n+\t\t\tif (remoteChecksum == null) {\n+\t\t\t\tURL url = new URL(sha256Url);\n+\t\t\t\tBufferedReader in = null;\n+\t\t\t\ttry {\n+\t\t\t\t\tURLConnection urlConnection = url.openConnection();\n+\t\t\t\t\tin = new BufferedReader(new InputStreamReader(urlConnection.getInputStream()));\n+\t\t\t\t\tremoteChecksum = in.readLine();\n+\t\t\t\t\tdownloadRequestsCache.put(sha256Url, remoteChecksum);\n+\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\tJavaLanguageServerPlugin.logException(\"sha256url='\" + sha256Url + \"'. You can try to add '-Dgradle.wrapper.check.disabled=true' to 'java.jdt.ls.vmargs'\", e);\n+\t\t\t\t} finally {\n+\t\t\t\t\tif (in != null) {\n+\t\t\t\t\t\tin.close();\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tif (remoteChecksum != null && remoteChecksum.equals(checksum)) {\n+\t\t\t\treturn null;\n+\t\t\t} else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8df1aed87ae777b75799d2bda49b2ca404e54926"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY3MDgxMw==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r422670813", "createdAt": "2020-05-10T16:57:08Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.URL;\n+import java.net.URLConnection;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+\n+public class WrapperValidator {\n+\n+\tprivate static final String DISTRIBUTION_URL = \"distributionUrl\";\n+\tprivate static final String GRADLE_WRAPPER_PROPERTIES = \"gradle/wrapper/gradle-wrapper.properties\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate final boolean DISABLED = Boolean.getBoolean(\"gradle.wrapper.check.disabled\");\n+\tprivate HashProvider hashProvider;\n+\tprotected static Cache<String, String> downloadRequestsCache = CacheBuilder.newBuilder().maximumSize(100).expireAfterWrite(1, TimeUnit.HOURS).build();\n+\n+\n+\tpublic WrapperValidator() {\n+\t\tthis(new HashProvider());\n+\t}\n+\n+\tpublic WrapperValidator(HashProvider hashProvider) {\n+\t\tthis.hashProvider = hashProvider;\n+\t}\n+\n+\tpublic String checkWrapper(String baseDir) throws IOException, NoSuchAlgorithmException {\n+\t\tif (DISABLED) {\n+\t\t\treturn null;\n+\t\t}\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\treturn wrapperJar.toString() + \" doesn't exist.\";\n+\t\t}\n+\t\tPath wrapperProperties = Paths.get(baseDir, GRADLE_WRAPPER_PROPERTIES);\n+\t\tif (!wrapperProperties.toFile().exists()) {\n+\t\t\treturn wrapperProperties.toString() + \" doesn't exist.\";\n+\t\t}\n+\t\ttry (InputStream is = new FileInputStream(wrapperProperties.toFile())) {\n+\t\t\tProperties props = new Properties();\n+\t\t\tprops.load(is);\n+\t\t\tString distributionUrl = props.getProperty(DISTRIBUTION_URL);\n+\t\t\tif (distributionUrl == null) {\n+\t\t\t\treturn \"Invalid the distributionUrl property\";\n+\t\t\t}\n+\t\t\tString sha256Url = distributionUrl.replace(\"-bin.zip\",\"\").replace(\"-all.zip\", \"\") + \"-wrapper.jar.sha256\";\n+\t\t\tString checksum = hashProvider.getChecksum(wrapperJar.toFile());\n+\t\t\tString remoteChecksum = downloadRequestsCache.getIfPresent(sha256Url);\n+\t\t\tif (remoteChecksum == null) {\n+\t\t\t\tURL url = new URL(sha256Url);\n+\t\t\t\tBufferedReader in = null;\n+\t\t\t\ttry {\n+\t\t\t\t\tURLConnection urlConnection = url.openConnection();\n+\t\t\t\t\tin = new BufferedReader(new InputStreamReader(urlConnection.getInputStream()));\n+\t\t\t\t\tremoteChecksum = in.readLine();\n+\t\t\t\t\tdownloadRequestsCache.put(sha256Url, remoteChecksum);\n+\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\tJavaLanguageServerPlugin.logException(\"sha256url='\" + sha256Url + \"'. You can try to add '-Dgradle.wrapper.check.disabled=true' to 'java.jdt.ls.vmargs'\", e);\n+\t\t\t\t} finally {\n+\t\t\t\t\tif (in != null) {\n+\t\t\t\t\t\tin.close();\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tif (remoteChecksum != null && remoteChecksum.equals(checksum)) {\n+\t\t\t\treturn null;\n+\t\t\t} else {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc3MjE1NQ=="}, "originalCommit": {"oid": "8df1aed87ae777b75799d2bda49b2ca404e54926"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxOTQwMjIyOnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporterTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMzowMzo0OFrOGRR7HA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQxNjo1Mjo0NVrOGTFv8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc3MjYzNg==", "bodyText": "needs to move to a WrapperValidatorTest class", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r420772636", "createdAt": "2020-05-06T13:03:48Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporterTest.java", "diffHunk": "@@ -158,6 +159,14 @@ public void testDisableGradleWrapper() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testGradleWrapper() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8df1aed87ae777b75799d2bda49b2ca404e54926"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc3MzE5OQ==", "bodyText": "also need to add tests checking we can actually detect suspicious wrappers", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r420773199", "createdAt": "2020-05-06T13:04:35Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporterTest.java", "diffHunk": "@@ -158,6 +159,14 @@ public void testDisableGradleWrapper() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testGradleWrapper() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc3MjYzNg=="}, "originalCommit": {"oid": "8df1aed87ae777b75799d2bda49b2ca404e54926"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY3MDMyMw==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r422670323", "createdAt": "2020-05-10T16:52:45Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporterTest.java", "diffHunk": "@@ -158,6 +159,14 @@ public void testDisableGradleWrapper() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testGradleWrapper() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc3MjYzNg=="}, "originalCommit": {"oid": "8df1aed87ae777b75799d2bda49b2ca404e54926"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxOTQyODkyOnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMzoxMDoyMFrOGRSLoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQxNjo1NDoyOVrOGTFwvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc3Njg2NQ==", "bodyText": "A meaningful error message should eventually bubble up to the client. Listing all suspicious wrappers (if we find several)", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r420776865", "createdAt": "2020-05-06T13:10:20Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "diffHunk": "@@ -105,7 +108,18 @@ private void importDir(Path rootFolder, IProgressMonitor monitor) {\n \n \tpublic static GradleDistribution getGradleDistribution(Path rootFolder) {\n \t\tif (JavaLanguageServerPlugin.getPreferencesManager() != null && JavaLanguageServerPlugin.getPreferencesManager().getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n-\t\t\treturn GradleDistribution.fromBuild();\n+\t\t\tWrapperValidator validator = new WrapperValidator();\n+\t\t\ttry {\n+\t\t\t\tString result = validator.checkWrapper(rootFolder.toFile().getAbsolutePath());\n+\t\t\t\tif (result == null) {\n+\t\t\t\t\tWrapperGradleDistribution gradleDistribution = GradleDistribution.fromBuild();\n+\t\t\t\t\treturn gradleDistribution;\n+\t\t\t\t} else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8df1aed87ae777b75799d2bda49b2ca404e54926"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjY3MDUyNg==", "bodyText": "Fixed. We use/check only jars included to WrapperGradleDistribution.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r422670526", "createdAt": "2020-05-10T16:54:29Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "diffHunk": "@@ -105,7 +108,18 @@ private void importDir(Path rootFolder, IProgressMonitor monitor) {\n \n \tpublic static GradleDistribution getGradleDistribution(Path rootFolder) {\n \t\tif (JavaLanguageServerPlugin.getPreferencesManager() != null && JavaLanguageServerPlugin.getPreferencesManager().getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n-\t\t\treturn GradleDistribution.fromBuild();\n+\t\t\tWrapperValidator validator = new WrapperValidator();\n+\t\t\ttry {\n+\t\t\t\tString result = validator.checkWrapper(rootFolder.toFile().getAbsolutePath());\n+\t\t\t\tif (result == null) {\n+\t\t\t\t\tWrapperGradleDistribution gradleDistribution = GradleDistribution.fromBuild();\n+\t\t\t\t\treturn gradleDistribution;\n+\t\t\t\t} else {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc3Njg2NQ=="}, "originalCommit": {"oid": "8df1aed87ae777b75799d2bda49b2ca404e54926"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MzAxODc0OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/JobHelpers.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzoxMDoxOVrOGUwxng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDowMDo0N1rOGVBdAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQyMzgzOA==", "bodyText": "waitForLoadingGradleVersionJob", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r424423838", "createdAt": "2020-05-13T13:10:19Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/JobHelpers.java", "diffHunk": "@@ -210,6 +210,10 @@ public static void waitForJobs(String jobFamily, IProgressMonitor monitor) {\n \t\t}\n \t}\n \n+\tpublic static void waitForLoadingGradleJobs() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fef3cf9718efc81e513ed692e218332fe74e4e9f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5NzA4OQ==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r424697089", "createdAt": "2020-05-13T20:00:47Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/JobHelpers.java", "diffHunk": "@@ -210,6 +210,10 @@ public static void waitForJobs(String jobFamily, IProgressMonitor monitor) {\n \t\t}\n \t}\n \n+\tpublic static void waitForLoadingGradleJobs() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQyMzgzOA=="}, "originalCommit": {"oid": "fef3cf9718efc81e513ed692e218332fe74e4e9f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MzA0MTYxOnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzoxNToyOVrOGUw_5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0Mjo0NlrOGXmsQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQyNzQ5Mw==", "bodyText": "java.imports.gradle.wrapper.checksums", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r424427493", "createdAt": "2020-05-13T13:15:29Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -209,6 +213,15 @@\n \t */\n \tpublic static final String SELECTIONRANGE_ENABLED_KEY = \"java.selectionRange.enabled\";\n \n+\t/**\n+\t * A named preference that holds the allowed gradle wrapper sha256 checksums.\n+\t * <p>\n+\t * Value is of type <code>String</code>: list of checksums.\n+\t * </p>\n+\t */\n+\tpublic static final String JAVA_GRADLE_WRAPPER_SHA256_KEY = \"java.gradle.wrapper.sha256.checksums\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fef3cf9718efc81e513ed692e218332fe74e4e9f"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwNDM1Mg==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427404352", "createdAt": "2020-05-19T15:42:46Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -209,6 +213,15 @@\n \t */\n \tpublic static final String SELECTIONRANGE_ENABLED_KEY = \"java.selectionRange.enabled\";\n \n+\t/**\n+\t * A named preference that holds the allowed gradle wrapper sha256 checksums.\n+\t * <p>\n+\t * Value is of type <code>String</code>: list of checksums.\n+\t * </p>\n+\t */\n+\tpublic static final String JAVA_GRADLE_WRAPPER_SHA256_KEY = \"java.gradle.wrapper.sha256.checksums\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQyNzQ5Mw=="}, "originalCommit": {"oid": "fef3cf9718efc81e513ed692e218332fe74e4e9f"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDAwNTkzOnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjo1MDowNVrOGU6qmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDowMTowMlrOGVBdnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4NTg4Mg==", "bodyText": "you need to check if client supports actionable notifications and specifically supports gradle wrapper management", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r424585882", "createdAt": "2020-05-13T16:50:05Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "diffHunk": "@@ -107,13 +113,37 @@ private void importDir(Path rootFolder, IProgressMonitor monitor) {\n \t}\n \n \tpublic static GradleDistribution getGradleDistribution(Path rootFolder) {\n-\t\tif (JavaLanguageServerPlugin.getPreferencesManager() != null && JavaLanguageServerPlugin.getPreferencesManager().getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n-\t\t\treturn GradleDistribution.fromBuild();\n+\t\tPreferenceManager preferencesManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\tif (preferencesManager != null && preferencesManager.getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n+\t\t\tWrapperValidator validator = new WrapperValidator();\n+\t\t\ttry {\n+\t\t\t\tValidationResult result = validator.checkWrapper(rootFolder.toFile().getAbsolutePath());\n+\t\t\t\tif (result.isValid()) {\n+\t\t\t\t\tWrapperGradleDistribution gradleDistribution = GradleDistribution.fromBuild();\n+\t\t\t\t\treturn gradleDistribution;\n+\t\t\t\t} else {\n+\t\t\t\t\tif (!WrapperValidator.getDisallowed().contains(result.getSha256())) {\n+\t\t\t\t\t\tProjectsManager pm = JavaLanguageServerPlugin.getProjectsManager();\n+\t\t\t\t\t\tif (pm != null && pm.getConnection() != null) {\n+\t\t\t\t\t\t\t//@formatter:off\n+\t\t\t\t\t\t\tString message = \"__GRADLE_WRAPPER_SHA256__\";\n+\t\t\t\t\t\t\tActionableNotification notification = new ActionableNotification()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60b458349b780484594682b93dffaf2db16e2f0f"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4NjEzMw==", "bodyText": "else need to send a regular notification to the client", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r424586133", "createdAt": "2020-05-13T16:50:29Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "diffHunk": "@@ -107,13 +113,37 @@ private void importDir(Path rootFolder, IProgressMonitor monitor) {\n \t}\n \n \tpublic static GradleDistribution getGradleDistribution(Path rootFolder) {\n-\t\tif (JavaLanguageServerPlugin.getPreferencesManager() != null && JavaLanguageServerPlugin.getPreferencesManager().getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n-\t\t\treturn GradleDistribution.fromBuild();\n+\t\tPreferenceManager preferencesManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\tif (preferencesManager != null && preferencesManager.getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n+\t\t\tWrapperValidator validator = new WrapperValidator();\n+\t\t\ttry {\n+\t\t\t\tValidationResult result = validator.checkWrapper(rootFolder.toFile().getAbsolutePath());\n+\t\t\t\tif (result.isValid()) {\n+\t\t\t\t\tWrapperGradleDistribution gradleDistribution = GradleDistribution.fromBuild();\n+\t\t\t\t\treturn gradleDistribution;\n+\t\t\t\t} else {\n+\t\t\t\t\tif (!WrapperValidator.getDisallowed().contains(result.getSha256())) {\n+\t\t\t\t\t\tProjectsManager pm = JavaLanguageServerPlugin.getProjectsManager();\n+\t\t\t\t\t\tif (pm != null && pm.getConnection() != null) {\n+\t\t\t\t\t\t\t//@formatter:off\n+\t\t\t\t\t\t\tString message = \"__GRADLE_WRAPPER_SHA256__\";\n+\t\t\t\t\t\t\tActionableNotification notification = new ActionableNotification()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4NTg4Mg=="}, "originalCommit": {"oid": "60b458349b780484594682b93dffaf2db16e2f0f"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY3MTY2NQ==", "bodyText": "... specifically supports gradle wrapper management\n\nWe check it at https://github.com/eclipse/eclipse.jdt.ls/pull/1434/files/60b458349b780484594682b93dffaf2db16e2f0f#diff-e696f471c869cd239fd5dbb142db81efR117", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r424671665", "createdAt": "2020-05-13T19:13:42Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "diffHunk": "@@ -107,13 +113,37 @@ private void importDir(Path rootFolder, IProgressMonitor monitor) {\n \t}\n \n \tpublic static GradleDistribution getGradleDistribution(Path rootFolder) {\n-\t\tif (JavaLanguageServerPlugin.getPreferencesManager() != null && JavaLanguageServerPlugin.getPreferencesManager().getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n-\t\t\treturn GradleDistribution.fromBuild();\n+\t\tPreferenceManager preferencesManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\tif (preferencesManager != null && preferencesManager.getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n+\t\t\tWrapperValidator validator = new WrapperValidator();\n+\t\t\ttry {\n+\t\t\t\tValidationResult result = validator.checkWrapper(rootFolder.toFile().getAbsolutePath());\n+\t\t\t\tif (result.isValid()) {\n+\t\t\t\t\tWrapperGradleDistribution gradleDistribution = GradleDistribution.fromBuild();\n+\t\t\t\t\treturn gradleDistribution;\n+\t\t\t\t} else {\n+\t\t\t\t\tif (!WrapperValidator.getDisallowed().contains(result.getSha256())) {\n+\t\t\t\t\t\tProjectsManager pm = JavaLanguageServerPlugin.getProjectsManager();\n+\t\t\t\t\t\tif (pm != null && pm.getConnection() != null) {\n+\t\t\t\t\t\t\t//@formatter:off\n+\t\t\t\t\t\t\tString message = \"__GRADLE_WRAPPER_SHA256__\";\n+\t\t\t\t\t\t\tActionableNotification notification = new ActionableNotification()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4NTg4Mg=="}, "originalCommit": {"oid": "60b458349b780484594682b93dffaf2db16e2f0f"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5NzI0Nw==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r424697247", "createdAt": "2020-05-13T20:01:02Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "diffHunk": "@@ -107,13 +113,37 @@ private void importDir(Path rootFolder, IProgressMonitor monitor) {\n \t}\n \n \tpublic static GradleDistribution getGradleDistribution(Path rootFolder) {\n-\t\tif (JavaLanguageServerPlugin.getPreferencesManager() != null && JavaLanguageServerPlugin.getPreferencesManager().getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n-\t\t\treturn GradleDistribution.fromBuild();\n+\t\tPreferenceManager preferencesManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\tif (preferencesManager != null && preferencesManager.getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n+\t\t\tWrapperValidator validator = new WrapperValidator();\n+\t\t\ttry {\n+\t\t\t\tValidationResult result = validator.checkWrapper(rootFolder.toFile().getAbsolutePath());\n+\t\t\t\tif (result.isValid()) {\n+\t\t\t\t\tWrapperGradleDistribution gradleDistribution = GradleDistribution.fromBuild();\n+\t\t\t\t\treturn gradleDistribution;\n+\t\t\t\t} else {\n+\t\t\t\t\tif (!WrapperValidator.getDisallowed().contains(result.getSha256())) {\n+\t\t\t\t\t\tProjectsManager pm = JavaLanguageServerPlugin.getProjectsManager();\n+\t\t\t\t\t\tif (pm != null && pm.getConnection() != null) {\n+\t\t\t\t\t\t\t//@formatter:off\n+\t\t\t\t\t\t\tString message = \"__GRADLE_WRAPPER_SHA256__\";\n+\t\t\t\t\t\t\tActionableNotification notification = new ActionableNotification()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4NTg4Mg=="}, "originalCommit": {"oid": "60b458349b780484594682b93dffaf2db16e2f0f"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDAxMjA2OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjo1MTozOFrOGU6uhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjo1MTozOFrOGU6uhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4Njg4Ng==", "bodyText": "ChecksumWrapper", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r424586886", "createdAt": "2020-05-13T16:51:38Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -1367,4 +1443,9 @@ public Preferences setStaticImportOnDemandThreshold(int staticImportOnDemandThre\n \t\tdefEclipsePrefs.put(CodeStyleConfiguration.ORGIMPORTS_STATIC_ONDEMANDTHRESHOLD, String.valueOf(this.staticImportOnDemandThreshold));\n \t\treturn this;\n \t}\n+\n+\tclass Sha256 {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60b458349b780484594682b93dffaf2db16e2f0f"}, "originalPosition": 160}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDAxMjU5OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjo1MTo0OVrOGU6u4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDowMToxN1rOGVBeIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4Njk3OA==", "bodyText": "checksum", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r424586978", "createdAt": "2020-05-13T16:51:49Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -1367,4 +1443,9 @@ public Preferences setStaticImportOnDemandThreshold(int staticImportOnDemandThre\n \t\tdefEclipsePrefs.put(CodeStyleConfiguration.ORGIMPORTS_STATIC_ONDEMANDTHRESHOLD, String.valueOf(this.staticImportOnDemandThreshold));\n \t\treturn this;\n \t}\n+\n+\tclass Sha256 {\n+\t\tprivate String sha256;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60b458349b780484594682b93dffaf2db16e2f0f"}, "originalPosition": 161}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5NzM3Ng==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r424697376", "createdAt": "2020-05-13T20:01:17Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -1367,4 +1443,9 @@ public Preferences setStaticImportOnDemandThreshold(int staticImportOnDemandThre\n \t\tdefEclipsePrefs.put(CodeStyleConfiguration.ORGIMPORTS_STATIC_ONDEMANDTHRESHOLD, String.valueOf(this.staticImportOnDemandThreshold));\n \t\treturn this;\n \t}\n+\n+\tclass Sha256 {\n+\t\tprivate String sha256;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4Njk3OA=="}, "originalCommit": {"oid": "60b458349b780484594682b93dffaf2db16e2f0f"}, "originalPosition": 161}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDAyMTczOnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/DownloadChecksumJob.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjo1NDoyOFrOGU61Ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDowMTozM1rOGVBepw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4ODU5OA==", "bodyText": "HttpURLConnection connection = (HttpURLConnection) obj.openConnection();\ntry (AutoCloseable closer = () -> connection.disconnect()) {", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r424588598", "createdAt": "2020-05-13T16:54:28Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/DownloadChecksumJob.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.concurrent.BlockingQueue;\n+import java.util.concurrent.LinkedBlockingQueue;\n+\n+import org.eclipse.core.runtime.IProgressMonitor;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.core.runtime.SubMonitor;\n+import org.eclipse.core.runtime.jobs.Job;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.gradle.api.UncheckedIOException;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class DownloadChecksumJob extends Job {\n+\n+\tpublic static final String WRAPPER_VALIDATOR_JOBS = \"WrapperValidatorJobs\";\n+\n+\tprivate final BlockingQueue<String> queue = new LinkedBlockingQueue<>();\n+\n+\tpublic DownloadChecksumJob() {\n+\t\tsuper(\"Download gradle sha256\");\n+\t}\n+\n+\t/* (non-Javadoc)\n+\t * @see org.eclipse.core.runtime.jobs.Job#run(org.eclipse.core.runtime.IProgressMonitor)\n+\t */\n+\t@Override\n+\tprotected IStatus run(IProgressMonitor monitor) {\n+\t\tint totalWork = 2 * queue.size();\n+\t\tSubMonitor subMonitor = SubMonitor.convert(monitor, totalWork);\n+\t\twhile (!queue.isEmpty() && !monitor.isCanceled()) {\n+\t\t\tString urlStr = queue.poll();\n+\t\t\tURL url;\n+\t\t\ttry {\n+\t\t\t\turl = new URL(urlStr);\n+\t\t\t} catch (MalformedURLException e1) {\n+\t\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + urlStr);\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\t\t\tsubMonitor.setTaskName(url.toString());\n+\t\t\tHttpURLConnection connection = null;\n+\t\t\tInputStreamReader reader = null;\n+\t\t\ttry {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60b458349b780484594682b93dffaf2db16e2f0f"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5NzUxMQ==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r424697511", "createdAt": "2020-05-13T20:01:33Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/DownloadChecksumJob.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.concurrent.BlockingQueue;\n+import java.util.concurrent.LinkedBlockingQueue;\n+\n+import org.eclipse.core.runtime.IProgressMonitor;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.core.runtime.SubMonitor;\n+import org.eclipse.core.runtime.jobs.Job;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.gradle.api.UncheckedIOException;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class DownloadChecksumJob extends Job {\n+\n+\tpublic static final String WRAPPER_VALIDATOR_JOBS = \"WrapperValidatorJobs\";\n+\n+\tprivate final BlockingQueue<String> queue = new LinkedBlockingQueue<>();\n+\n+\tpublic DownloadChecksumJob() {\n+\t\tsuper(\"Download gradle sha256\");\n+\t}\n+\n+\t/* (non-Javadoc)\n+\t * @see org.eclipse.core.runtime.jobs.Job#run(org.eclipse.core.runtime.IProgressMonitor)\n+\t */\n+\t@Override\n+\tprotected IStatus run(IProgressMonitor monitor) {\n+\t\tint totalWork = 2 * queue.size();\n+\t\tSubMonitor subMonitor = SubMonitor.convert(monitor, totalWork);\n+\t\twhile (!queue.isEmpty() && !monitor.isCanceled()) {\n+\t\t\tString urlStr = queue.poll();\n+\t\t\tURL url;\n+\t\t\ttry {\n+\t\t\t\turl = new URL(urlStr);\n+\t\t\t} catch (MalformedURLException e1) {\n+\t\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + urlStr);\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\t\t\tsubMonitor.setTaskName(url.toString());\n+\t\t\tHttpURLConnection connection = null;\n+\t\t\tInputStreamReader reader = null;\n+\t\t\ttry {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4ODU5OA=="}, "originalCommit": {"oid": "60b458349b780484594682b93dffaf2db16e2f0f"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NjY5ODk3OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMTo1OToyN1rOGWz8dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0MzoxNlrOGXmtjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU3MjkxNg==", "bodyText": "move to utility class", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426572916", "createdAt": "2020-05-18T11:59:27Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate CoreException getException(Exception e) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, e.getMessage(), e);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate static File getVersionCacheFile() {\n+\t\treturn new File(System.getProperty(\"user.home\"), \".tooling/gradle/versions.json\");\n+\t}\n+\n+\tpublic static File getSha256CacheFile() {\n+\t\tFile file = new File(System.getProperty(\"user.home\"), \".tooling/gradle/sha256cache\");\n+\t\tfile.mkdirs();\n+\t\treturn file;\n+\t}\n+\n+\tpublic String getChecksum(File file) throws IOException, NoSuchAlgorithmException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 202}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwNDY4Ng==", "bodyText": "Fixed", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427404686", "createdAt": "2020-05-19T15:43:16Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate CoreException getException(Exception e) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, e.getMessage(), e);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate static File getVersionCacheFile() {\n+\t\treturn new File(System.getProperty(\"user.home\"), \".tooling/gradle/versions.json\");\n+\t}\n+\n+\tpublic static File getSha256CacheFile() {\n+\t\tFile file = new File(System.getProperty(\"user.home\"), \".tooling/gradle/sha256cache\");\n+\t\tfile.mkdirs();\n+\t\treturn file;\n+\t}\n+\n+\tpublic String getChecksum(File file) throws IOException, NoSuchAlgorithmException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU3MjkxNg=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 202}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NjcxODg1OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjowNTo0M1rOGW0I3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0MzozMFrOGXmuLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU3NjA5NQ==", "bodyText": "use StatusFactory.newErrorStatus\nWe prolly need a new ExceptionFactory class, with methods like\npublic static CoreException newException(String message) {\n   return new CoreException(StatusFactory.newErrorStatus(message));\n}", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426576095", "createdAt": "2020-05-18T12:05:43Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 183}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwNDg0NQ==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427404845", "createdAt": "2020-05-19T15:43:30Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU3NjA5NQ=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 183}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NjcyMzcwOnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjowNzoxNFrOGW0L_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0NjowOFrOGXm1ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU3Njg5NA==", "bodyText": "again move to factory like:\npublic static CoreException newException(Exception exception) {\n   return new CoreException(StatusFactory.newErrorStatus(exception.getMessage(), exception));\n}", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426576894", "createdAt": "2020-05-18T12:07:14Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate CoreException getException(Exception e) throws CoreException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwNjczMA==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427406730", "createdAt": "2020-05-19T15:46:08Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate CoreException getException(Exception e) throws CoreException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU3Njg5NA=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 187}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NjcyNjI2OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjowNzo1NFrOGW0Ndw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0NjoyMVrOGXm2Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU3NzI3MQ==", "bodyText": ".tooling/gradle/checksums", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426577271", "createdAt": "2020-05-18T12:07:54Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate CoreException getException(Exception e) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, e.getMessage(), e);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate static File getVersionCacheFile() {\n+\t\treturn new File(System.getProperty(\"user.home\"), \".tooling/gradle/versions.json\");\n+\t}\n+\n+\tpublic static File getSha256CacheFile() {\n+\t\tFile file = new File(System.getProperty(\"user.home\"), \".tooling/gradle/sha256cache\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 197}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwNjkzNQ==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427406935", "createdAt": "2020-05-19T15:46:21Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate CoreException getException(Exception e) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, e.getMessage(), e);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate static File getVersionCacheFile() {\n+\t\treturn new File(System.getProperty(\"user.home\"), \".tooling/gradle/versions.json\");\n+\t}\n+\n+\tpublic static File getSha256CacheFile() {\n+\t\tFile file = new File(System.getProperty(\"user.home\"), \".tooling/gradle/sha256cache\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU3NzI3MQ=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 197}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NjczMTAwOnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/DownloadChecksumJob.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjowOTozMlrOGW0Qkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0NjozOVrOGXm3IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU3ODA2Nw==", "bodyText": "Download Gradle Wrapper checksums", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426578067", "createdAt": "2020-05-18T12:09:32Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/DownloadChecksumJob.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.concurrent.BlockingQueue;\n+import java.util.concurrent.LinkedBlockingQueue;\n+\n+import org.eclipse.core.runtime.IProgressMonitor;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.core.runtime.SubMonitor;\n+import org.eclipse.core.runtime.jobs.Job;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.gradle.api.UncheckedIOException;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.io.CharStreams;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class DownloadChecksumJob extends Job {\n+\n+\tpublic static final String WRAPPER_VALIDATOR_JOBS = \"WrapperValidatorJobs\";\n+\n+\tprivate final BlockingQueue<String> queue = new LinkedBlockingQueue<>();\n+\n+\tpublic DownloadChecksumJob() {\n+\t\tsuper(\"Download gradle sha256\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwNzEzNw==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427407137", "createdAt": "2020-05-19T15:46:39Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/DownloadChecksumJob.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.concurrent.BlockingQueue;\n+import java.util.concurrent.LinkedBlockingQueue;\n+\n+import org.eclipse.core.runtime.IProgressMonitor;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.core.runtime.SubMonitor;\n+import org.eclipse.core.runtime.jobs.Job;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.gradle.api.UncheckedIOException;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.io.CharStreams;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class DownloadChecksumJob extends Job {\n+\n+\tpublic static final String WRAPPER_VALIDATOR_JOBS = \"WrapperValidatorJobs\";\n+\n+\tprivate final BlockingQueue<String> queue = new LinkedBlockingQueue<>();\n+\n+\tpublic DownloadChecksumJob() {\n+\t\tsuper(\"Download gradle sha256\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU3ODA2Nw=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1Njc0OTcxOnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/DownloadChecksumJob.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjoxNToyOVrOGW0ckA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0NzowM1rOGXm4Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4MTEzNg==", "bodyText": "add\npublic boolean isEmpty() {\n  return queue.isEmpty();\n}", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426581136", "createdAt": "2020-05-18T12:15:29Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/DownloadChecksumJob.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.concurrent.BlockingQueue;\n+import java.util.concurrent.LinkedBlockingQueue;\n+\n+import org.eclipse.core.runtime.IProgressMonitor;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.core.runtime.SubMonitor;\n+import org.eclipse.core.runtime.jobs.Job;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.gradle.api.UncheckedIOException;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.io.CharStreams;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class DownloadChecksumJob extends Job {\n+\n+\tpublic static final String WRAPPER_VALIDATOR_JOBS = \"WrapperValidatorJobs\";\n+\n+\tprivate final BlockingQueue<String> queue = new LinkedBlockingQueue<>();\n+\n+\tpublic DownloadChecksumJob() {\n+\t\tsuper(\"Download gradle sha256\");\n+\t}\n+\n+\t/* (non-Javadoc)\n+\t * @see org.eclipse.core.runtime.jobs.Job#run(org.eclipse.core.runtime.IProgressMonitor)\n+\t */\n+\t@Override\n+\tprotected IStatus run(IProgressMonitor monitor) {\n+\t\tint totalWork = 2 * queue.size();\n+\t\tSubMonitor subMonitor = SubMonitor.convert(monitor, totalWork);\n+\t\twhile (!queue.isEmpty() && !monitor.isCanceled()) {\n+\t\t\tString urlStr = queue.poll();\n+\t\t\tURL url;\n+\t\t\ttry {\n+\t\t\t\turl = new URL(urlStr);\n+\t\t\t} catch (MalformedURLException e1) {\n+\t\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + urlStr);\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\t\t\tsubMonitor.setTaskName(url.toString());\n+\t\t\tfinal HttpURLConnection connection;\n+\t\t\ttry {\n+\t\t\t\tconnection = (HttpURLConnection) url.openConnection();\n+\t\t\t\tconnection.setConnectTimeout(10000);\n+\t\t\t\tconnection.setReadTimeout(10000);\n+\t\t\t} catch (IOException e) {\n+\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\t\t\ttry (AutoCloseable closer = (() -> connection.disconnect()); InputStreamReader reader = new InputStreamReader(connection.getInputStream(), Charsets.UTF_8);) {\n+\t\t\t\tString sha256 = CharStreams.toString(reader);\n+\t\t\t\tFile sha256File = new File(WrapperValidator.getSha256CacheFile(), WrapperValidator.getFileName(urlStr));\n+\t\t\t\twrite(sha256File, sha256);\n+\t\t\t\tWrapperValidator.getAllowed().add(sha256);\n+\t\t\t\tsubMonitor.worked(2);\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tthrow new UncheckedIOException(\"Cannot download Gradle sha256 checksum: \" + url.toString(), e);\n+\t\t\t}\n+\t\t}\n+\t\tsubMonitor.done();\n+\t\treturn Status.OK_STATUS;\n+\t}\n+\n+\tpublic void add(String urlStr) {\n+\t\tqueue.add(urlStr);\n+\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwNzQyMw==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427407423", "createdAt": "2020-05-19T15:47:03Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/DownloadChecksumJob.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.concurrent.BlockingQueue;\n+import java.util.concurrent.LinkedBlockingQueue;\n+\n+import org.eclipse.core.runtime.IProgressMonitor;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.core.runtime.SubMonitor;\n+import org.eclipse.core.runtime.jobs.Job;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.gradle.api.UncheckedIOException;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.io.CharStreams;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class DownloadChecksumJob extends Job {\n+\n+\tpublic static final String WRAPPER_VALIDATOR_JOBS = \"WrapperValidatorJobs\";\n+\n+\tprivate final BlockingQueue<String> queue = new LinkedBlockingQueue<>();\n+\n+\tpublic DownloadChecksumJob() {\n+\t\tsuper(\"Download gradle sha256\");\n+\t}\n+\n+\t/* (non-Javadoc)\n+\t * @see org.eclipse.core.runtime.jobs.Job#run(org.eclipse.core.runtime.IProgressMonitor)\n+\t */\n+\t@Override\n+\tprotected IStatus run(IProgressMonitor monitor) {\n+\t\tint totalWork = 2 * queue.size();\n+\t\tSubMonitor subMonitor = SubMonitor.convert(monitor, totalWork);\n+\t\twhile (!queue.isEmpty() && !monitor.isCanceled()) {\n+\t\t\tString urlStr = queue.poll();\n+\t\t\tURL url;\n+\t\t\ttry {\n+\t\t\t\turl = new URL(urlStr);\n+\t\t\t} catch (MalformedURLException e1) {\n+\t\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + urlStr);\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\t\t\tsubMonitor.setTaskName(url.toString());\n+\t\t\tfinal HttpURLConnection connection;\n+\t\t\ttry {\n+\t\t\t\tconnection = (HttpURLConnection) url.openConnection();\n+\t\t\t\tconnection.setConnectTimeout(10000);\n+\t\t\t\tconnection.setReadTimeout(10000);\n+\t\t\t} catch (IOException e) {\n+\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\t\t\ttry (AutoCloseable closer = (() -> connection.disconnect()); InputStreamReader reader = new InputStreamReader(connection.getInputStream(), Charsets.UTF_8);) {\n+\t\t\t\tString sha256 = CharStreams.toString(reader);\n+\t\t\t\tFile sha256File = new File(WrapperValidator.getSha256CacheFile(), WrapperValidator.getFileName(urlStr));\n+\t\t\t\twrite(sha256File, sha256);\n+\t\t\t\tWrapperValidator.getAllowed().add(sha256);\n+\t\t\t\tsubMonitor.worked(2);\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tthrow new UncheckedIOException(\"Cannot download Gradle sha256 checksum: \" + url.toString(), e);\n+\t\t\t}\n+\t\t}\n+\t\tsubMonitor.done();\n+\t\treturn Status.OK_STATUS;\n+\t}\n+\n+\tpublic void add(String urlStr) {\n+\t\tqueue.add(urlStr);\n+\t}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4MTEzNg=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1Njc1NDQ2OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjoxNzowMVrOGW0ftA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjoxNzowMVrOGW0ftA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4MTk0MA==", "bodyText": "I don't like performing stuff like that here in the setter. For later: use a preference listener to do that kind of things", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426581940", "createdAt": "2020-05-18T12:17:01Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -888,6 +941,25 @@ public Preferences setJavaCompletionFavoriteMembers(List<String> javaCompletionF\n \t\treturn this;\n \t}\n \n+\tpublic Preferences putSha256(List<String> sha256Allowed, List<String> sha256Disallowed) {\n+\t\tList<String> oldAllowed = this.sha256Allowed;\n+\t\tList<String> oldDisallowed = this.sha256Disallowed;\n+\t\tWrapperValidator.getAllowed().clear();\n+\t\tthis.sha256Allowed = sha256Allowed;\n+\t\tWrapperValidator.getDisallowed().clear();\n+\t\tif (sha256Disallowed != null) {\n+\t\t\tWrapperValidator.getDisallowed().addAll(sha256Disallowed);\n+\t\t}\n+\t\tthis.sha256Disallowed = sha256Disallowed;\n+\t\tProjectsManager projectsManager = JavaLanguageServerPlugin.getProjectsManager();\n+\t\tif (projectsManager != null && (!Objects.equals(oldAllowed, this.sha256Allowed) || !Objects.equals(oldDisallowed, this.sha256Disallowed))) {\n+\t\t\tfor (IProject project : ProjectUtils.getGradleProjects()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 134}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1Njc3MDQ0OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjoyMTo1MlrOGW0pyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0NzoxNlrOGXm4yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4NDUyMg==", "bodyText": "if (!downloadJob.isEmpty()) {\n   downloadJob.schedule();\n}", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426584522", "createdAt": "2020-05-18T12:21:52Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwNzU2MQ==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427407561", "createdAt": "2020-05-19T15:47:16Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4NDUyMg=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 137}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1Njc4NTk0OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjoyNjoxMFrOGW0zMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0OTo1NFrOGXm_1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4NjkyOQ==", "bodyText": "NoSuchAlgorithmException should be safely swallowed since SHA-256 should always be supported, unless I'm wrong", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426586929", "createdAt": "2020-05-18T12:26:10Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate CoreException getException(Exception e) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, e.getMessage(), e);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate static File getVersionCacheFile() {\n+\t\treturn new File(System.getProperty(\"user.home\"), \".tooling/gradle/versions.json\");\n+\t}\n+\n+\tpublic static File getSha256CacheFile() {\n+\t\tFile file = new File(System.getProperty(\"user.home\"), \".tooling/gradle/sha256cache\");\n+\t\tfile.mkdirs();\n+\t\treturn file;\n+\t}\n+\n+\tpublic String getChecksum(File file) throws IOException, NoSuchAlgorithmException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 202}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwOTM2Nw==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427409367", "createdAt": "2020-05-19T15:49:54Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate CoreException getException(Exception e) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, e.getMessage(), e);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate static File getVersionCacheFile() {\n+\t\treturn new File(System.getProperty(\"user.home\"), \".tooling/gradle/versions.json\");\n+\t}\n+\n+\tpublic static File getSha256CacheFile() {\n+\t\tFile file = new File(System.getProperty(\"user.home\"), \".tooling/gradle/sha256cache\");\n+\t\tfile.mkdirs();\n+\t\treturn file;\n+\t}\n+\n+\tpublic String getChecksum(File file) throws IOException, NoSuchAlgorithmException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4NjkyOQ=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 202}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1Njc4OTgwOnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjoyNzoxMFrOGW01gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0NzozM1rOGXm5kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4NzUyMQ==", "bodyText": "return immutable Set", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426587521", "createdAt": "2020-05-18T12:27:10Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate CoreException getException(Exception e) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, e.getMessage(), e);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate static File getVersionCacheFile() {\n+\t\treturn new File(System.getProperty(\"user.home\"), \".tooling/gradle/versions.json\");\n+\t}\n+\n+\tpublic static File getSha256CacheFile() {\n+\t\tFile file = new File(System.getProperty(\"user.home\"), \".tooling/gradle/sha256cache\");\n+\t\tfile.mkdirs();\n+\t\treturn file;\n+\t}\n+\n+\tpublic String getChecksum(File file) throws IOException, NoSuchAlgorithmException {\n+\t\tMessageDigest messageDigest = MessageDigest.getInstance(SHA256);\n+\t\ttry (DigestInputStream dis = new DigestInputStream(new FileInputStream(file), messageDigest)) {\n+\t\t\tbyte[] bytes = new byte[32768];\n+\t\t\twhile (dis.read(bytes) != -1) {\n+\t\t\t\t;\n+\t\t\t}\n+\t\t\tmessageDigest = dis.getMessageDigest();\n+\t\t}\n+\t\tStringBuilder result = new StringBuilder();\n+\t\tfor (byte b : messageDigest.digest()) {\n+\t\t\tresult.append(String.format(\"%02x\", b));\n+\t\t}\n+\t\treturn result.toString();\n+\t}\n+\n+\tpublic static Set<String> getAllowed() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 218}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwNzc2MA==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427407760", "createdAt": "2020-05-19T15:47:33Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate CoreException getException(Exception e) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, e.getMessage(), e);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate static File getVersionCacheFile() {\n+\t\treturn new File(System.getProperty(\"user.home\"), \".tooling/gradle/versions.json\");\n+\t}\n+\n+\tpublic static File getSha256CacheFile() {\n+\t\tFile file = new File(System.getProperty(\"user.home\"), \".tooling/gradle/sha256cache\");\n+\t\tfile.mkdirs();\n+\t\treturn file;\n+\t}\n+\n+\tpublic String getChecksum(File file) throws IOException, NoSuchAlgorithmException {\n+\t\tMessageDigest messageDigest = MessageDigest.getInstance(SHA256);\n+\t\ttry (DigestInputStream dis = new DigestInputStream(new FileInputStream(file), messageDigest)) {\n+\t\t\tbyte[] bytes = new byte[32768];\n+\t\t\twhile (dis.read(bytes) != -1) {\n+\t\t\t\t;\n+\t\t\t}\n+\t\t\tmessageDigest = dis.getMessageDigest();\n+\t\t}\n+\t\tStringBuilder result = new StringBuilder();\n+\t\tfor (byte b : messageDigest.digest()) {\n+\t\t\tresult.append(String.format(\"%02x\", b));\n+\t\t}\n+\t\treturn result.toString();\n+\t}\n+\n+\tpublic static Set<String> getAllowed() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4NzUyMQ=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 218}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1Njc5MDIwOnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjoyNzoxN1rOGW01wA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0OTo0MVrOGXm_RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4NzU4NA==", "bodyText": "return immutable Set", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426587584", "createdAt": "2020-05-18T12:27:17Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate CoreException getException(Exception e) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, e.getMessage(), e);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate static File getVersionCacheFile() {\n+\t\treturn new File(System.getProperty(\"user.home\"), \".tooling/gradle/versions.json\");\n+\t}\n+\n+\tpublic static File getSha256CacheFile() {\n+\t\tFile file = new File(System.getProperty(\"user.home\"), \".tooling/gradle/sha256cache\");\n+\t\tfile.mkdirs();\n+\t\treturn file;\n+\t}\n+\n+\tpublic String getChecksum(File file) throws IOException, NoSuchAlgorithmException {\n+\t\tMessageDigest messageDigest = MessageDigest.getInstance(SHA256);\n+\t\ttry (DigestInputStream dis = new DigestInputStream(new FileInputStream(file), messageDigest)) {\n+\t\t\tbyte[] bytes = new byte[32768];\n+\t\t\twhile (dis.read(bytes) != -1) {\n+\t\t\t\t;\n+\t\t\t}\n+\t\t\tmessageDigest = dis.getMessageDigest();\n+\t\t}\n+\t\tStringBuilder result = new StringBuilder();\n+\t\tfor (byte b : messageDigest.digest()) {\n+\t\t\tresult.append(String.format(\"%02x\", b));\n+\t\t}\n+\t\treturn result.toString();\n+\t}\n+\n+\tpublic static Set<String> getAllowed() {\n+\t\treturn allowed;\n+\t}\n+\n+\t/**\n+\t * @return the disallowed\n+\t */\n+\tpublic static Set<String> getDisallowed() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 225}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwOTIyMA==", "bodyText": "Fixed", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427409220", "createdAt": "2020-05-19T15:49:41Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate CoreException getException(Exception e) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, e.getMessage(), e);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate static File getVersionCacheFile() {\n+\t\treturn new File(System.getProperty(\"user.home\"), \".tooling/gradle/versions.json\");\n+\t}\n+\n+\tpublic static File getSha256CacheFile() {\n+\t\tFile file = new File(System.getProperty(\"user.home\"), \".tooling/gradle/sha256cache\");\n+\t\tfile.mkdirs();\n+\t\treturn file;\n+\t}\n+\n+\tpublic String getChecksum(File file) throws IOException, NoSuchAlgorithmException {\n+\t\tMessageDigest messageDigest = MessageDigest.getInstance(SHA256);\n+\t\ttry (DigestInputStream dis = new DigestInputStream(new FileInputStream(file), messageDigest)) {\n+\t\t\tbyte[] bytes = new byte[32768];\n+\t\t\twhile (dis.read(bytes) != -1) {\n+\t\t\t\t;\n+\t\t\t}\n+\t\t\tmessageDigest = dis.getMessageDigest();\n+\t\t}\n+\t\tStringBuilder result = new StringBuilder();\n+\t\tfor (byte b : messageDigest.digest()) {\n+\t\t\tresult.append(String.format(\"%02x\", b));\n+\t\t}\n+\t\treturn result.toString();\n+\t}\n+\n+\tpublic static Set<String> getAllowed() {\n+\t\treturn allowed;\n+\t}\n+\n+\t/**\n+\t * @return the disallowed\n+\t */\n+\tpublic static Set<String> getDisallowed() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4NzU4NA=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 225}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1Njc5NjE2OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjoyODo1MFrOGW05Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0Nzo0NVrOGXm6LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4ODUwNw==", "bodyText": "no, getAllowed() should be immutable", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426588507", "createdAt": "2020-05-18T12:28:50Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -888,6 +941,25 @@ public Preferences setJavaCompletionFavoriteMembers(List<String> javaCompletionF\n \t\treturn this;\n \t}\n \n+\tpublic Preferences putSha256(List<String> sha256Allowed, List<String> sha256Disallowed) {\n+\t\tList<String> oldAllowed = this.sha256Allowed;\n+\t\tList<String> oldDisallowed = this.sha256Disallowed;\n+\t\tWrapperValidator.getAllowed().clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwNzkxNg==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427407916", "createdAt": "2020-05-19T15:47:45Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -888,6 +941,25 @@ public Preferences setJavaCompletionFavoriteMembers(List<String> javaCompletionF\n \t\treturn this;\n \t}\n \n+\tpublic Preferences putSha256(List<String> sha256Allowed, List<String> sha256Disallowed) {\n+\t\tList<String> oldAllowed = this.sha256Allowed;\n+\t\tList<String> oldDisallowed = this.sha256Disallowed;\n+\t\tWrapperValidator.getAllowed().clear();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4ODUwNw=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 125}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1Njc5ODE0OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjoyOToxM1rOGW06ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0Nzo1OVrOGXm6wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4ODc3OA==", "bodyText": "no, getDisallowed() should be immutable", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426588778", "createdAt": "2020-05-18T12:29:13Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -888,6 +941,25 @@ public Preferences setJavaCompletionFavoriteMembers(List<String> javaCompletionF\n \t\treturn this;\n \t}\n \n+\tpublic Preferences putSha256(List<String> sha256Allowed, List<String> sha256Disallowed) {\n+\t\tList<String> oldAllowed = this.sha256Allowed;\n+\t\tList<String> oldDisallowed = this.sha256Disallowed;\n+\t\tWrapperValidator.getAllowed().clear();\n+\t\tthis.sha256Allowed = sha256Allowed;\n+\t\tWrapperValidator.getDisallowed().clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4OTc4Ng==", "bodyText": "there should be a WrapperValidator.clear() method that encapsulates allowed.clear() &  disallowed.clear()", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426589786", "createdAt": "2020-05-18T12:31:07Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -888,6 +941,25 @@ public Preferences setJavaCompletionFavoriteMembers(List<String> javaCompletionF\n \t\treturn this;\n \t}\n \n+\tpublic Preferences putSha256(List<String> sha256Allowed, List<String> sha256Disallowed) {\n+\t\tList<String> oldAllowed = this.sha256Allowed;\n+\t\tList<String> oldDisallowed = this.sha256Disallowed;\n+\t\tWrapperValidator.getAllowed().clear();\n+\t\tthis.sha256Allowed = sha256Allowed;\n+\t\tWrapperValidator.getDisallowed().clear();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4ODc3OA=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwODA2NQ==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427408065", "createdAt": "2020-05-19T15:47:59Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -888,6 +941,25 @@ public Preferences setJavaCompletionFavoriteMembers(List<String> javaCompletionF\n \t\treturn this;\n \t}\n \n+\tpublic Preferences putSha256(List<String> sha256Allowed, List<String> sha256Disallowed) {\n+\t\tList<String> oldAllowed = this.sha256Allowed;\n+\t\tList<String> oldDisallowed = this.sha256Disallowed;\n+\t\tWrapperValidator.getAllowed().clear();\n+\t\tthis.sha256Allowed = sha256Allowed;\n+\t\tWrapperValidator.getDisallowed().clear();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4ODc3OA=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NjgwNjg5OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjozMTo0N1rOGW0_qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0ODoxOFrOGXm7hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5MDEyMw==", "bodyText": "No, expose/use a static  WrapperValidator.disallow(sha256Disallowed) instead", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426590123", "createdAt": "2020-05-18T12:31:47Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -888,6 +941,25 @@ public Preferences setJavaCompletionFavoriteMembers(List<String> javaCompletionF\n \t\treturn this;\n \t}\n \n+\tpublic Preferences putSha256(List<String> sha256Allowed, List<String> sha256Disallowed) {\n+\t\tList<String> oldAllowed = this.sha256Allowed;\n+\t\tList<String> oldDisallowed = this.sha256Disallowed;\n+\t\tWrapperValidator.getAllowed().clear();\n+\t\tthis.sha256Allowed = sha256Allowed;\n+\t\tWrapperValidator.getDisallowed().clear();\n+\t\tif (sha256Disallowed != null) {\n+\t\t\tWrapperValidator.getDisallowed().addAll(sha256Disallowed);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwODI2Mw==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427408263", "createdAt": "2020-05-19T15:48:18Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -888,6 +941,25 @@ public Preferences setJavaCompletionFavoriteMembers(List<String> javaCompletionF\n \t\treturn this;\n \t}\n \n+\tpublic Preferences putSha256(List<String> sha256Allowed, List<String> sha256Disallowed) {\n+\t\tList<String> oldAllowed = this.sha256Allowed;\n+\t\tList<String> oldDisallowed = this.sha256Disallowed;\n+\t\tWrapperValidator.getAllowed().clear();\n+\t\tthis.sha256Allowed = sha256Allowed;\n+\t\tWrapperValidator.getDisallowed().clear();\n+\t\tif (sha256Disallowed != null) {\n+\t\t\tWrapperValidator.getDisallowed().addAll(sha256Disallowed);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5MDEyMw=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NjgzNTU3OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjozOTo0M1rOGW1RRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0ODozNFrOGXm8Ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5NDYzMQ==", "bodyText": "it should be possible to override that value, for testing purposes, like\nString checksumCache = System.getProperty(\"gradle.checksum.cacheDir\");\nif (checksumCache == null){\n  checksumCache = System.getProperty(\"user.home\"), \".tooling/gradle/checksums\");\n}\nFile checksumCacheDir =  new File(checksumCache);\nchecksumCacheDir.mkdirs();\nreturn checksumCacheDir;", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426594631", "createdAt": "2020-05-18T12:39:43Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate CoreException getException(Exception e) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, e.getMessage(), e);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate static File getVersionCacheFile() {\n+\t\treturn new File(System.getProperty(\"user.home\"), \".tooling/gradle/versions.json\");\n+\t}\n+\n+\tpublic static File getSha256CacheFile() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 196}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwODQ0Mw==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427408443", "createdAt": "2020-05-19T15:48:34Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/internal/gradle/checksums/WrapperValidator.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.internal.gradle.checksums;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.security.DigestInputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.core.runtime.OperationCanceledException;\n+import org.eclipse.core.runtime.Status;\n+import org.eclipse.jdt.ls.core.internal.IConstants;\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.jdt.ls.core.internal.preferences.PreferenceManager;\n+\n+import com.google.common.base.Charsets;\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicate;\n+import com.google.common.collect.FluentIterable;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.io.CharStreams;\n+import com.google.common.io.Closeables;\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ *\n+ * @author snjeza\n+ *\n+ */\n+public class WrapperValidator {\n+\n+\tprivate static final String WRAPPER_CHECKSUM_URL = \"wrapperChecksumUrl\";\n+\tprivate static final String GRADLE_WRAPPER_JAR = \"gradle/wrapper/gradle-wrapper.jar\";\n+\tprivate static final String SHA256 = \"SHA-256\";\n+\n+\tprivate static Set<String> allowed = new HashSet<>();\n+\tprivate static Set<String> disallowed = new HashSet<>();\n+\tprivate static AtomicBoolean downloaded = new AtomicBoolean(false);\n+\n+\tpublic WrapperValidator() {\n+\t}\n+\n+\tpublic ValidationResult checkWrapper(String baseDir) throws CoreException {\n+\t\tPath wrapperJar = Paths.get(baseDir, GRADLE_WRAPPER_JAR);\n+\t\tif (!wrapperJar.toFile().exists()) {\n+\t\t\tthrow getException(wrapperJar.toString() + \" doesn't exist.\");\n+\t\t}\n+\t\tif (!downloaded.get() || allowed.isEmpty()) {\n+\t\t\tPreferenceManager preferenceManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\t\tif (preferenceManager != null && preferenceManager.getPreferences().getSha256Allowed() != null) {\n+\t\t\t\tgetAllowed().addAll(preferenceManager.getPreferences().getSha256Allowed());\n+\t\t\t}\n+\t\t\tFile versionFile = getVersionCacheFile();\n+\t\t\tif (!versionFile.exists()) {\n+\t\t\t\tJobHelpers.waitForLoadingGradleVersionJob();\n+\t\t\t}\n+\t\t\tif (versionFile.exists()) {\n+\t\t\t\tInputStreamReader reader = null;\n+\t\t\t\ttry {\n+\t\t\t\t\treader = new InputStreamReader(new FileInputStream(versionFile), Charsets.UTF_8);\n+\t\t\t\t\tString json = CharStreams.toString(reader);\n+\t\t\t\t\tGson gson = new GsonBuilder().create();\n+\t\t\t\t\tTypeToken<List<Map<String, String>>> typeToken = new TypeToken<List<Map<String, String>>>() {\n+\t\t\t\t\t};\n+\t\t\t\t\tList<Map<String, String>> versions = gson.fromJson(json, typeToken.getType());\n+\t\t\t\t\t//@formatter:off\n+\t\t\t\t\tImmutableList<String> wrapperChecksumUrls = FluentIterable\n+\t\t\t\t\t\t.from(versions)\n+\t\t\t\t\t\t.filter(new Predicate<Map<String, String>>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic boolean apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL) != null;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t\t.transform(new Function<Map<String, String>, String>() {\n+\t\t\t\t\t\t\t@Override\n+\t\t\t\t\t\t\tpublic String apply(Map<String, String> input) {\n+\t\t\t\t\t\t\t\treturn input.get(WRAPPER_CHECKSUM_URL);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t})\n+\t\t\t\t\t.toList();\n+\t\t\t\t\t// @formatter:on\n+\t\t\t\t\tDownloadChecksumJob downloadJob = new DownloadChecksumJob();\n+\t\t\t\t\tint count = 0;\n+\t\t\t\t\tfor (String wrapperChecksumUrl : wrapperChecksumUrls) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tString fileName = getFileName(wrapperChecksumUrl);\n+\t\t\t\t\t\t\tif (fileName == null) {\n+\t\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tFile sha256File = new File(getSha256CacheFile(), fileName);\n+\t\t\t\t\t\t\tif (!sha256File.exists() || sha256File.lastModified() < versionFile.lastModified()) {\n+\t\t\t\t\t\t\t\tcount++;\n+\t\t\t\t\t\t\t\tif (count > 20) {\n+\t\t\t\t\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\t\t\t\t\tdownloadJob = new DownloadChecksumJob();\n+\t\t\t\t\t\t\t\t\tcount = 0;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tdownloadJob.add(wrapperChecksumUrl);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString sha256 = read(sha256File);\n+\t\t\t\t\t\t\t\tallowed.add(sha256);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t\tdownloadJob.schedule();\n+\t\t\t\t\tJobHelpers.waitForJobs(DownloadChecksumJob.WRAPPER_VALIDATOR_JOBS, new NullProgressMonitor());\n+\t\t\t\t\tdownloaded.set(true);\n+\t\t\t\t} catch (IOException | OperationCanceledException e) {\n+\t\t\t\t\tthrow getException(e);\n+\t\t\t\t} finally {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tCloseables.close(reader, false);\n+\t\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\t\t// ignore\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\ttry {\n+\t\t\tString sha256 = getChecksum(wrapperJar.toFile());\n+\t\t\treturn new ValidationResult(wrapperJar.toString(), sha256, allowed.contains(sha256));\n+\t\t} catch (NoSuchAlgorithmException | IOException e) {\n+\t\t\tthrow getException(e);\n+\t\t}\n+\t}\n+\n+\tpublic static String getFileName(String url) {\n+\t\tint index = url.lastIndexOf(\"/\");\n+\t\tif (index < 0 || url.length() < index + 1) {\n+\t\t\tJavaLanguageServerPlugin.logInfo(\"Invalid wrapper URL \" + url);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn url.substring(index + 1);\n+\t}\n+\n+\tprivate static String read(File file) {\n+\t\tOptional<String> firstLine;\n+\t\ttry {\n+\t\t\tfirstLine = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst();\n+\t\t} catch (IOException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(e);\n+\t\t\treturn null;\n+\t\t}\n+\t\tif (firstLine.isPresent()) {\n+\t\t\treturn firstLine.get();\n+\t\t}\n+\t\treturn null;\n+\t}\n+\n+\tprivate CoreException getException(String message) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, message);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate CoreException getException(Exception e) throws CoreException {\n+\t\tIStatus status = new Status(IStatus.ERROR, IConstants.PLUGIN_ID, e.getMessage(), e);\n+\t\treturn new CoreException(status);\n+\t}\n+\n+\tprivate static File getVersionCacheFile() {\n+\t\treturn new File(System.getProperty(\"user.home\"), \".tooling/gradle/versions.json\");\n+\t}\n+\n+\tpublic static File getSha256CacheFile() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5NDYzMQ=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 196}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1Njg0MjcxOnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/managers/WrapperValidatorTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjo0MTozMlrOGW1Viw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0ODo0N1rOGXm81w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5NTcyMw==", "bodyText": "all tests should set System.setProperty(\"gradle.checksum.cacheDir\", \"target/gradle/checksums\")", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426595723", "createdAt": "2020-05-18T12:41:32Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/managers/WrapperValidatorTest.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.core.internal.managers;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.io.File;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.preferences.Preferences;\n+import org.eclipse.jdt.ls.internal.gradle.checksums.ValidationResult;\n+import org.eclipse.jdt.ls.internal.gradle.checksums.WrapperValidator;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+/**\n+ * @author snjeza\n+ *\n+ */\n+@RunWith(MockitoJUnitRunner.class)\n+public class WrapperValidatorTest extends AbstractGradleBasedTest{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwODU5OQ==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427408599", "createdAt": "2020-05-19T15:48:47Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/managers/WrapperValidatorTest.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.core.internal.managers;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.io.File;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.preferences.Preferences;\n+import org.eclipse.jdt.ls.internal.gradle.checksums.ValidationResult;\n+import org.eclipse.jdt.ls.internal.gradle.checksums.WrapperValidator;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+/**\n+ * @author snjeza\n+ *\n+ */\n+@RunWith(MockitoJUnitRunner.class)\n+public class WrapperValidatorTest extends AbstractGradleBasedTest{", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5NTcyMw=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NzcyNTgyOnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNjowNjozOFrOGW9-vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0OTowMlrOGXm9eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjczNzM0Mg==", "bodyText": "gradle/checksum/prompt", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426737342", "createdAt": "2020-05-18T16:06:38Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "diffHunk": "@@ -107,13 +114,44 @@ private void importDir(Path rootFolder, IProgressMonitor monitor) {\n \t}\n \n \tpublic static GradleDistribution getGradleDistribution(Path rootFolder) {\n-\t\tif (JavaLanguageServerPlugin.getPreferencesManager() != null && JavaLanguageServerPlugin.getPreferencesManager().getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n-\t\t\treturn GradleDistribution.fromBuild();\n+\t\tPreferenceManager preferencesManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\tif (preferencesManager != null && preferencesManager.getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n+\t\t\tWrapperValidator validator = new WrapperValidator();\n+\t\t\ttry {\n+\t\t\t\tValidationResult result = validator.checkWrapper(rootFolder.toFile().getAbsolutePath());\n+\t\t\t\tif (result.isValid()) {\n+\t\t\t\t\tWrapperGradleDistribution gradleDistribution = GradleDistribution.fromBuild();\n+\t\t\t\t\treturn gradleDistribution;\n+\t\t\t\t} else {\n+\t\t\t\t\tif (!WrapperValidator.getDisallowed().contains(result.getChecksum())) {\n+\t\t\t\t\t\tProjectsManager pm = JavaLanguageServerPlugin.getProjectsManager();\n+\t\t\t\t\t\tif (pm != null && pm.getConnection() != null) {\n+\t\t\t\t\t\t\tif (preferencesManager.getClientPreferences().isActionableNotificationSupported()) {\n+\t\t\t\t\t\t\t\t//@formatter:off\n+\t\t\t\t\t\t\t\tString message = \"__GRADLE_WRAPPER_CHECKSUM__\";\n+\t\t\t\t\t\t\t\tActionableNotification notification = new ActionableNotification()\n+\t\t\t\t\t\t\t\t\t.withSeverity(MessageType.Warning)\n+\t\t\t\t\t\t\t\t\t.withMessage(message)\n+\t\t\t\t\t\t\t\t\t.withData(asList(result.getWrapperJar(), result.getChecksum()));\n+\t\t\t\t\t\t\t\tpm.getConnection().sendActionableNotification(notification);\n+\t\t\t\t\t\t\t\t//@formatter:on\n+\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString id = \"gradle/checksum\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwODc2Mg==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427408762", "createdAt": "2020-05-19T15:49:02Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "diffHunk": "@@ -107,13 +114,44 @@ private void importDir(Path rootFolder, IProgressMonitor monitor) {\n \t}\n \n \tpublic static GradleDistribution getGradleDistribution(Path rootFolder) {\n-\t\tif (JavaLanguageServerPlugin.getPreferencesManager() != null && JavaLanguageServerPlugin.getPreferencesManager().getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n-\t\t\treturn GradleDistribution.fromBuild();\n+\t\tPreferenceManager preferencesManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\tif (preferencesManager != null && preferencesManager.getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n+\t\t\tWrapperValidator validator = new WrapperValidator();\n+\t\t\ttry {\n+\t\t\t\tValidationResult result = validator.checkWrapper(rootFolder.toFile().getAbsolutePath());\n+\t\t\t\tif (result.isValid()) {\n+\t\t\t\t\tWrapperGradleDistribution gradleDistribution = GradleDistribution.fromBuild();\n+\t\t\t\t\treturn gradleDistribution;\n+\t\t\t\t} else {\n+\t\t\t\t\tif (!WrapperValidator.getDisallowed().contains(result.getChecksum())) {\n+\t\t\t\t\t\tProjectsManager pm = JavaLanguageServerPlugin.getProjectsManager();\n+\t\t\t\t\t\tif (pm != null && pm.getConnection() != null) {\n+\t\t\t\t\t\t\tif (preferencesManager.getClientPreferences().isActionableNotificationSupported()) {\n+\t\t\t\t\t\t\t\t//@formatter:off\n+\t\t\t\t\t\t\t\tString message = \"__GRADLE_WRAPPER_CHECKSUM__\";\n+\t\t\t\t\t\t\t\tActionableNotification notification = new ActionableNotification()\n+\t\t\t\t\t\t\t\t\t.withSeverity(MessageType.Warning)\n+\t\t\t\t\t\t\t\t\t.withMessage(message)\n+\t\t\t\t\t\t\t\t\t.withData(asList(result.getWrapperJar(), result.getChecksum()));\n+\t\t\t\t\t\t\t\tpm.getConnection().sendActionableNotification(notification);\n+\t\t\t\t\t\t\t\t//@formatter:on\n+\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tString id = \"gradle/checksum\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjczNzM0Mg=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NzczNDE0OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNjowODo0MFrOGW-EBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0OToxOVrOGXm-Uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjczODY5Mw==", "bodyText": "this is not sufficient. Some clients may support actionable notifications, but we don't know if they support gradle wrapper checksum management too.\nI'd suggest to test for \"gradleChecksumWrapperPromptSupport\":\"true\" instead. If it's not supported, then do something like:\n//@formatter:off\nString message = GRADLE_WRAPPER_CHEKSUM_WARNING_TEMPLATE.replaceAll(\"@wrapper@\", result.getWrapperJar()).replaceAll(\"@checksum@\", result.getChecksum());\n//@formatter:on\npm.getConnection().showMessage(new MessageParams(MessageType.Error, message));\nWith\n\t//@formatter:off\n\tpublic static final String GRADLE_WRAPPER_CHEKSUM_WARNING_TEMPLATE =\n\t\t\t\"Security Warning! The gradle wrapper '@wrapper@' could be malicious. \"\n\t\t\t+ \"If you trust it, please add \\n\"\n\t\t\t+ \"`{\\\"sha256\\\": \\\"@checksum@\\\",\"\n\t\t\t+ \"\\n\\\"allowed\\\": true}`\"\n\t\t\t+ \"\\n to the `java.import.gradle.wrapper.checksums` preference.\"\n\t\t\t+ \"\"\n\t\t\t.replaceAll(\"\\n\", System.lineSeparator());\n\t//@formatter:on", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r426738693", "createdAt": "2020-05-18T16:08:40Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "diffHunk": "@@ -107,13 +114,44 @@ private void importDir(Path rootFolder, IProgressMonitor monitor) {\n \t}\n \n \tpublic static GradleDistribution getGradleDistribution(Path rootFolder) {\n-\t\tif (JavaLanguageServerPlugin.getPreferencesManager() != null && JavaLanguageServerPlugin.getPreferencesManager().getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n-\t\t\treturn GradleDistribution.fromBuild();\n+\t\tPreferenceManager preferencesManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\tif (preferencesManager != null && preferencesManager.getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n+\t\t\tWrapperValidator validator = new WrapperValidator();\n+\t\t\ttry {\n+\t\t\t\tValidationResult result = validator.checkWrapper(rootFolder.toFile().getAbsolutePath());\n+\t\t\t\tif (result.isValid()) {\n+\t\t\t\t\tWrapperGradleDistribution gradleDistribution = GradleDistribution.fromBuild();\n+\t\t\t\t\treturn gradleDistribution;\n+\t\t\t\t} else {\n+\t\t\t\t\tif (!WrapperValidator.getDisallowed().contains(result.getChecksum())) {\n+\t\t\t\t\t\tProjectsManager pm = JavaLanguageServerPlugin.getProjectsManager();\n+\t\t\t\t\t\tif (pm != null && pm.getConnection() != null) {\n+\t\t\t\t\t\t\tif (preferencesManager.getClientPreferences().isActionableNotificationSupported()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwODk3OQ==", "bodyText": "Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427408979", "createdAt": "2020-05-19T15:49:19Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "diffHunk": "@@ -107,13 +114,44 @@ private void importDir(Path rootFolder, IProgressMonitor monitor) {\n \t}\n \n \tpublic static GradleDistribution getGradleDistribution(Path rootFolder) {\n-\t\tif (JavaLanguageServerPlugin.getPreferencesManager() != null && JavaLanguageServerPlugin.getPreferencesManager().getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n-\t\t\treturn GradleDistribution.fromBuild();\n+\t\tPreferenceManager preferencesManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\tif (preferencesManager != null && preferencesManager.getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n+\t\t\tWrapperValidator validator = new WrapperValidator();\n+\t\t\ttry {\n+\t\t\t\tValidationResult result = validator.checkWrapper(rootFolder.toFile().getAbsolutePath());\n+\t\t\t\tif (result.isValid()) {\n+\t\t\t\t\tWrapperGradleDistribution gradleDistribution = GradleDistribution.fromBuild();\n+\t\t\t\t\treturn gradleDistribution;\n+\t\t\t\t} else {\n+\t\t\t\t\tif (!WrapperValidator.getDisallowed().contains(result.getChecksum())) {\n+\t\t\t\t\t\tProjectsManager pm = JavaLanguageServerPlugin.getProjectsManager();\n+\t\t\t\t\t\tif (pm != null && pm.getConnection() != null) {\n+\t\t\t\t\t\t\tif (preferencesManager.getClientPreferences().isActionableNotificationSupported()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjczODY5Mw=="}, "originalCommit": {"oid": "71622b72f686a484942499b2922add895a8c0ee2"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MTk1NTY4OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo1NzowMFrOGXnUBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNjoyOToxM1rOGXorhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxNDUzMw==", "bodyText": "please delete", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427414533", "createdAt": "2020-05-19T15:57:00Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "diffHunk": "@@ -107,13 +126,51 @@ private void importDir(Path rootFolder, IProgressMonitor monitor) {\n \t}\n \n \tpublic static GradleDistribution getGradleDistribution(Path rootFolder) {\n-\t\tif (JavaLanguageServerPlugin.getPreferencesManager() != null && JavaLanguageServerPlugin.getPreferencesManager().getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n-\t\t\treturn GradleDistribution.fromBuild();\n+\t\tPreferenceManager preferencesManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\tif (preferencesManager != null && preferencesManager.getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n+\t\t\tWrapperValidator validator = new WrapperValidator();\n+\t\t\ttry {\n+\t\t\t\tValidationResult result = validator.checkWrapper(rootFolder.toFile().getAbsolutePath());\n+\t\t\t\tif (result.isValid()) {\n+\t\t\t\t\tWrapperGradleDistribution gradleDistribution = GradleDistribution.fromBuild();\n+\t\t\t\t\treturn gradleDistribution;\n+\t\t\t\t} else {\n+\t\t\t\t\tif (!WrapperValidator.contains(result.getChecksum())) {\n+\t\t\t\t\t\tProjectsManager pm = JavaLanguageServerPlugin.getProjectsManager();\n+\t\t\t\t\t\tif (pm != null && pm.getConnection() != null) {\n+\t\t\t\t\t\t\tif (preferencesManager.getClientPreferences().isGradleChecksumWrapperPromptSupport()) {\n+\t\t\t\t\t\t\t\tif (preferencesManager.getClientPreferences().isActionableNotificationSupported()) {\n+\t\t\t\t\t\t\t\t\t//@formatter:off\n+\t\t\t\t\t\t\t\t\tString message = \"__GRADLE_WRAPPER_CHECKSUM__\";\n+\t\t\t\t\t\t\t\t\tActionableNotification notification = new ActionableNotification()\n+\t\t\t\t\t\t\t\t\t\t.withSeverity(MessageType.Warning)\n+\t\t\t\t\t\t\t\t\t\t.withMessage(message)\n+\t\t\t\t\t\t\t\t\t\t.withData(asList(result.getWrapperJar(), result.getChecksum()));\n+\t\t\t\t\t\t\t\t\tpm.getConnection().sendActionableNotification(notification);\n+\t\t\t\t\t\t\t\t\t//@formatter:on\n+\n+\t\t\t\t\t\t\t\t} else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c12552fc7302b8ffebebed2dba9038dca453400a"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzNjkzNQ==", "bodyText": "What to delete? Fixed.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427436935", "createdAt": "2020-05-19T16:29:13Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java", "diffHunk": "@@ -107,13 +126,51 @@ private void importDir(Path rootFolder, IProgressMonitor monitor) {\n \t}\n \n \tpublic static GradleDistribution getGradleDistribution(Path rootFolder) {\n-\t\tif (JavaLanguageServerPlugin.getPreferencesManager() != null && JavaLanguageServerPlugin.getPreferencesManager().getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n-\t\t\treturn GradleDistribution.fromBuild();\n+\t\tPreferenceManager preferencesManager = JavaLanguageServerPlugin.getPreferencesManager();\n+\t\tif (preferencesManager != null && preferencesManager.getPreferences().isGradleWrapperEnabled() && Files.exists(rootFolder.resolve(\"gradlew\"))) {\n+\t\t\tWrapperValidator validator = new WrapperValidator();\n+\t\t\ttry {\n+\t\t\t\tValidationResult result = validator.checkWrapper(rootFolder.toFile().getAbsolutePath());\n+\t\t\t\tif (result.isValid()) {\n+\t\t\t\t\tWrapperGradleDistribution gradleDistribution = GradleDistribution.fromBuild();\n+\t\t\t\t\treturn gradleDistribution;\n+\t\t\t\t} else {\n+\t\t\t\t\tif (!WrapperValidator.contains(result.getChecksum())) {\n+\t\t\t\t\t\tProjectsManager pm = JavaLanguageServerPlugin.getProjectsManager();\n+\t\t\t\t\t\tif (pm != null && pm.getConnection() != null) {\n+\t\t\t\t\t\t\tif (preferencesManager.getClientPreferences().isGradleChecksumWrapperPromptSupport()) {\n+\t\t\t\t\t\t\t\tif (preferencesManager.getClientPreferences().isActionableNotificationSupported()) {\n+\t\t\t\t\t\t\t\t\t//@formatter:off\n+\t\t\t\t\t\t\t\t\tString message = \"__GRADLE_WRAPPER_CHECKSUM__\";\n+\t\t\t\t\t\t\t\t\tActionableNotification notification = new ActionableNotification()\n+\t\t\t\t\t\t\t\t\t\t.withSeverity(MessageType.Warning)\n+\t\t\t\t\t\t\t\t\t\t.withMessage(message)\n+\t\t\t\t\t\t\t\t\t\t.withData(asList(result.getWrapperJar(), result.getChecksum()));\n+\t\t\t\t\t\t\t\t\tpm.getConnection().sendActionableNotification(notification);\n+\t\t\t\t\t\t\t\t\t//@formatter:on\n+\n+\t\t\t\t\t\t\t\t} else {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxNDUzMw=="}, "originalCommit": {"oid": "c12552fc7302b8ffebebed2dba9038dca453400a"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2Mjc2MDY2OnYy", "diffSide": "RIGHT", "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/managers/WrapperValidatorTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxOToyNDo1OVrOGXvTkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxOTo1Njo1OFrOGXwXcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU0NTQ4OA==", "bodyText": "java.nio.file.NoSuchFileException: /Users/fbricon/Dev/projects/eclipse.jdt.ls/org.eclipse.jdt.ls.tests/target/gradle/checksums/gradle-6.4-wrapper.jar.sha256\nat org.eclipse.jdt.ls.core.internal.managers.WrapperValidatorTest.testGradleWrapper(WrapperValidatorTest.java:63)", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427545488", "createdAt": "2020-05-19T19:24:59Z", "author": {"login": "fbricon"}, "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/managers/WrapperValidatorTest.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.core.internal.managers;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.io.File;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.preferences.Preferences;\n+import org.eclipse.jdt.ls.internal.gradle.checksums.ValidationResult;\n+import org.eclipse.jdt.ls.internal.gradle.checksums.WrapperValidator;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+/**\n+ * @author snjeza\n+ *\n+ */\n+@RunWith(MockitoJUnitRunner.class)\n+public class WrapperValidatorTest extends AbstractGradleBasedTest{\n+\n+\t@Before\n+\tpublic void setProperty() throws Exception {\n+\t\tSystem.setProperty(\"gradle.checksum.cacheDir\", \"target/gradle/checksums\");\n+\t}\n+\n+\t@After\n+\tpublic void clearProperty() {\n+\t\tSystem.clearProperty(\"gradle.checksum.cacheDir\");\n+\t}\n+\n+\t@Test\n+\tpublic void testGradleWrapper() throws Exception {\n+\t\tFile file = new File(getSourceProjectDirectory(), \"gradle/simple-gradle\");\n+\t\tassertTrue(file.isDirectory());\n+\t\tValidationResult result = new WrapperValidator().checkWrapper(file.getAbsolutePath());\n+\t\tassertTrue(result.isValid());\n+\t\tFile sha256Directory = WrapperValidator.getSha256CacheFile();\n+\t\t// test cache\n+\t\tfile = new File(sha256Directory, \"gradle-6.4-wrapper.jar.sha256\");\n+\t\tString sha256 = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst().get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d89de8c6afdb17ccc671030bdb31c84dced2336"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU2Mjg2Ng==", "bodyText": "See #1450", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1434#discussion_r427562866", "createdAt": "2020-05-19T19:56:58Z", "author": {"login": "snjeza"}, "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/managers/WrapperValidatorTest.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.core.internal.managers;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.io.File;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.preferences.Preferences;\n+import org.eclipse.jdt.ls.internal.gradle.checksums.ValidationResult;\n+import org.eclipse.jdt.ls.internal.gradle.checksums.WrapperValidator;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+/**\n+ * @author snjeza\n+ *\n+ */\n+@RunWith(MockitoJUnitRunner.class)\n+public class WrapperValidatorTest extends AbstractGradleBasedTest{\n+\n+\t@Before\n+\tpublic void setProperty() throws Exception {\n+\t\tSystem.setProperty(\"gradle.checksum.cacheDir\", \"target/gradle/checksums\");\n+\t}\n+\n+\t@After\n+\tpublic void clearProperty() {\n+\t\tSystem.clearProperty(\"gradle.checksum.cacheDir\");\n+\t}\n+\n+\t@Test\n+\tpublic void testGradleWrapper() throws Exception {\n+\t\tFile file = new File(getSourceProjectDirectory(), \"gradle/simple-gradle\");\n+\t\tassertTrue(file.isDirectory());\n+\t\tValidationResult result = new WrapperValidator().checkWrapper(file.getAbsolutePath());\n+\t\tassertTrue(result.isValid());\n+\t\tFile sha256Directory = WrapperValidator.getSha256CacheFile();\n+\t\t// test cache\n+\t\tfile = new File(sha256Directory, \"gradle-6.4-wrapper.jar.sha256\");\n+\t\tString sha256 = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst().get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU0NTQ4OA=="}, "originalCommit": {"oid": "3d89de8c6afdb17ccc671030bdb31c84dced2336"}, "originalPosition": 63}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3550, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}