{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNTAyMjg4", "number": 1552, "title": "Fix semantic tokens offset due to document updates", "bodyText": "Fixes part of redhat-developer/vscode-java#1597.\nSee redhat-developer/vscode-java#1632 for the second part of the fix.\nThis is done by getting the token line and column number directly from its compilation unit, rather than the document, which for whatever reason gets out-of-sync during frequent updates.", "createdAt": "2020-09-21T19:11:03Z", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1552", "merged": true, "mergeCommit": {"oid": "8b7e12d9815a57b1f77bd3cb048a0333eecd9e6d"}, "closed": true, "closedAt": "2020-09-27T05:44:54Z", "author": {"login": "0dinD"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLIQiDAH2gAyNDkwNTAyMjg4OmQ4ZTc1MzM5YWMxZDkzNDM5MjZiNmJkYjc1ZWZjOTcxYjA1YmQ5ZTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdM2ovbAFqTQ5NzA0ODA5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d8e75339ac1d9343926b6bdb75efc971b05bd9e1", "author": {"user": {"login": "0dinD", "name": null}}, "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/d8e75339ac1d9343926b6bdb75efc971b05bd9e1", "committedDate": "2020-09-21T19:07:42Z", "message": "Fix semantic tokens offset due to document updates\n\nSigned-off-by: 0dinD <zerodind@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTIzMzg1", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1552#pullrequestreview-493123385", "createdAt": "2020-09-22T04:42:02Z", "commit": {"oid": "d8e75339ac1d9343926b6bdb75efc971b05bd9e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNDo0MjowMlrOHVqB9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNDo0MjowMlrOHVqB9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3MDc3Mg==", "bodyText": "Looks good. But not sure whether it can fix the problem completely.\nAs my understanding, both document and CompilationUnit are a snapshot of the document at some point. The difference is CompilationUnit is the AST tree parsed from the document at some point. I'm curious how the fix can guarantee it's not out-of-sync.", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1552#discussion_r492470772", "createdAt": "2020-09-22T04:42:02Z", "author": {"login": "testforstephen"}, "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/commands/SemanticTokensCommand.java", "diffHunk": "@@ -38,22 +34,17 @@ public static SemanticTokens provide(String uri) {\n \t}\n \n \tprivate static SemanticTokens doProvide(String uri) {\n-\t\tIDocument document = null;\n-\n \t\tITypeRoot typeRoot = JDTUtils.resolveTypeRoot(uri);\n-\t\tif (typeRoot != null) {\n-\t\t\ttry {\n-\t\t\t\tdocument = JsonRpcHelpers.toDocument(typeRoot.getBuffer());\n-\t\t\t} catch (JavaModelException e) {\n-\t\t\t\tJavaLanguageServerPlugin.logException(\"Failed to provide semantic tokens for \" + uri, e);\n-\t\t\t}\n-\t\t}\n-\t\tif (document == null) {\n+\t\tif (typeRoot == null) {\n \t\t\treturn new SemanticTokens(Collections.emptyList());\n \t\t}\n \n-\t\tSemanticTokensVisitor collector = new SemanticTokensVisitor(document, SemanticTokenManager.getInstance());\n \t\tCompilationUnit root = CoreASTProvider.getInstance().getAST(typeRoot, CoreASTProvider.WAIT_YES, new NullProgressMonitor());\n+\t\tif (root == null) {\n+\t\t\treturn new SemanticTokens(Collections.emptyList());\n+\t\t}\n+\n+\t\tSemanticTokensVisitor collector = new SemanticTokensVisitor(root, SemanticTokenManager.getInstance());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8e75339ac1d9343926b6bdb75efc971b05bd9e1"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDQ4MDkw", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1552#pullrequestreview-497048090", "createdAt": "2020-09-27T03:43:42Z", "commit": {"oid": "d8e75339ac1d9343926b6bdb75efc971b05bd9e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1003, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}