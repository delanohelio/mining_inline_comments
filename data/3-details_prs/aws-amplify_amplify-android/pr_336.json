{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2MTMwNzU3", "number": 336, "title": "Implement offline interpret", "bodyText": "Issue #, if available:\nDescription of changes:\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-03-31T07:26:18Z", "url": "https://github.com/aws-amplify/amplify-android/pull/336", "merged": true, "mergeCommit": {"oid": "922340e1a7bbc5c55f8b55458df04acb8cd25b16"}, "closed": true, "closedAt": "2020-04-07T16:56:49Z", "author": {"login": "raphkim"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcS3eMwgH2gAyMzk2MTMwNzU3OmVmYTJiMWQ3MTkyYzE1NjAzMzc1NjRkMDMyYjVlMGYzZDRiYzVlYTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVWRwiAFqTM4OTMxMTI0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "efa2b1d7192c1560337564d032b5e0f3d4bc5ea1", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/efa2b1d7192c1560337564d032b5e0f3d4bc5ea1", "committedDate": "2020-03-30T23:54:29Z", "message": "Add TFLite implementation of interpret"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/5659d810c6a31ed93e939dcee18df4cc3ce5a20a", "committedDate": "2020-03-31T01:55:39Z", "message": "Add basic escape hatch implementation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MDEyNTk4", "url": "https://github.com/aws-amplify/amplify-android/pull/336#pullrequestreview-385012598", "createdAt": "2020-03-31T18:50:57Z", "commit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "state": "COMMENTED", "comments": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxODo1MDo1N1rOF-jkRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDoxNjoxMFrOF-miCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzODc1Nw==", "bodyText": "Alternately: aws-predictions-tensorflow isn't a lot longer, but is unambiguous in its meaning. You must have weighed this, yourself. What are you your thoughts?", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401138757", "createdAt": "2020-03-31T18:50:57Z", "author": {"login": "jamesonwilliams"}, "path": "settings.gradle", "diffHunk": "@@ -18,13 +18,13 @@ include ':core'\n // Plugin Modules\n include ':aws-analytics-pinpoint'\n include ':aws-api'\n-include ':aws-storage-s3'\n include ':aws-datastore'\n+include ':aws-predictions-tfl'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzOTEzOA==", "bodyText": "Maybe this came in from a bad merge or rebase? These lines are not present in master. We don't want to add back in Retrolambda.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401139138", "createdAt": "2020-03-31T18:51:37Z", "author": {"login": "jamesonwilliams"}, "path": "build.gradle", "diffHunk": "@@ -85,6 +87,9 @@ subprojects { project ->\n }\n \n private void configureAndroidLibrary(Project project) {\n+    project.apply plugin: 'me.tatarka.retrolambda'\n+    project.retrolambda.jvmArgs += '-Dretrolambda.quiet=true'\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzOTY3MQ==", "bodyText": "It's 16 in master. I think you had a bad rebase or something.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401139671", "createdAt": "2020-03-31T18:52:33Z", "author": {"login": "jamesonwilliams"}, "path": "build.gradle", "diffHunk": "@@ -44,7 +45,7 @@ task clean(type: Delete) {\n ext {\n     buildToolsVersion = \"29.0.2\"\n     compileSdkVersion = 29\n-    minSdkVersion = 16\n+    minSdkVersion = 15", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzOTg2Mw==", "bodyText": "(Bad rebase)", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401139863", "createdAt": "2020-03-31T18:52:52Z", "author": {"login": "jamesonwilliams"}, "path": "build.gradle", "diffHunk": "@@ -20,7 +20,8 @@ buildscript {\n     }\n \n     dependencies {\n-        classpath 'com.android.tools.build:gradle:3.6.1'\n+        classpath 'com.android.tools.build:gradle:3.6.0'\n+        classpath 'me.tatarka:gradle-retrolambda:3.7.1'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0MDg3NQ==", "bodyText": "Should we brand \"Tensorflow\" in its public name?\nPOM_NAME=Amplify Framework for Android - Offline Predictions from Tensorflow", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401140875", "createdAt": "2020-03-31T18:54:23Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/gradle.properties", "diffHunk": "@@ -0,0 +1,4 @@\n+POM_ARTIFACT_ID=aws-predictions-tfl\n+POM_NAME=Amplify Framework for Android - Offline Predictions", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0MTQ1MA==", "bodyText": "Should be namespaced to Tenworflow somehow, like the plugin is. .predictions.tensorflow, probably.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401141450", "createdAt": "2020-03-31T18:55:22Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/AndroidManifest.xml", "diffHunk": "@@ -0,0 +1,17 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<!--\n+   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\").\n+   You may not use this file except in compliance with the License.\n+   A copy of the License is located at\n+\n+    http://aws.amazon.com/apache2.0\n+\n+   or in the \"license\" file accompanying this file. This file is distributed\n+   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+   express or implied. See the License for the specific language governing\n+   permissions and limitations under the License.\n+-->\n+\n+<manifest package=\"com.amplifyframework.predictions\" />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0NDk5MA==", "bodyText": "Is there a special property of the TreeMap<>() that you need, or can you use the more standard HashMap<>()?", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401144990", "createdAt": "2020-03-31T19:01:06Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/TFLitePredictionsEscapeHatch.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions;\n+\n+import androidx.annotation.NonNull;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+/**\n+ * An escape hatch to give low-level access to Tensorflow interpreter.\n+ */\n+public final class TFLitePredictionsEscapeHatch {\n+    private final Map<String, Interpreter> interpreters;\n+\n+    TFLitePredictionsEscapeHatch(@NonNull Map<String, Interpreter> interpreters) {\n+        this.interpreters = new TreeMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0NzAyNQ==", "bodyText": "I like this. I think on the API category, though, we just have the escape hatch as Map<String, ApiWhatever>. Here, the equivalent would be like Map<String, Interpreter>, instead of this encapsulating class. Just pointing it out. I do like the encapsulation.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401147025", "createdAt": "2020-03-31T19:04:30Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/TFLitePredictionsEscapeHatch.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions;\n+\n+import androidx.annotation.NonNull;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+/**\n+ * An escape hatch to give low-level access to Tensorflow interpreter.\n+ */\n+public final class TFLitePredictionsEscapeHatch {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0Nzc0Nw==", "bodyText": "We have a convention emerging around these names. I wonder if it would have been better to call this InterpretOptions.default(), or InterpretOptions.defaultOptions(), or just even InterpretOptions.create() (without any funny business).\nWell, default() isn't an option, sorry. default is a keyword.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401147747", "createdAt": "2020-03-31T19:05:48Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/TFLitePredictionsPlugin.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions;\n+\n+import android.content.Context;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.operation.InterpretOperation;\n+import com.amplifyframework.predictions.operation.TFLiteInterpretOperation;\n+import com.amplifyframework.predictions.options.InterpretOptions;\n+import com.amplifyframework.predictions.request.TFLiteTextClassificationRequest;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+import com.amplifyframework.predictions.service.TFLitePredictionsService;\n+\n+import org.json.JSONObject;\n+\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * A plugin for Predictions category that uses models from\n+ * Tensorflow lite to carry out tasks offline.\n+ */\n+public final class TFLitePredictionsPlugin extends PredictionsPlugin<TFLitePredictionsEscapeHatch> {\n+    private static final String TFL_PREDICTIONS_PLUGIN_KEY = \"tflPredictionsPlugin\";\n+\n+    private final ExecutorService executorService;\n+\n+    private TFLitePredictionsService predictionsService;\n+\n+    public TFLitePredictionsPlugin() {\n+        this.executorService = Executors.newCachedThreadPool();\n+    }\n+\n+    @NonNull\n+    @Override\n+    public String getPluginKey() {\n+        return TFL_PREDICTIONS_PLUGIN_KEY;\n+    }\n+\n+    @Override\n+    public void configure(\n+            @NonNull JSONObject pluginConfiguration,\n+            @NonNull Context context\n+    ) throws AmplifyException {\n+        this.predictionsService = new TFLitePredictionsService(context);\n+    }\n+\n+    @Nullable\n+    @Override\n+    public TFLitePredictionsEscapeHatch getEscapeHatch() {\n+        return new TFLitePredictionsEscapeHatch(predictionsService.getInterpreters());\n+    }\n+\n+    @NonNull\n+    @Override\n+    public InterpretOperation<?> interpret(\n+            @NonNull String text,\n+            @NonNull Consumer<InterpretResult> onSuccess,\n+            @NonNull Consumer<PredictionsException> onError\n+    ) {\n+        final InterpretOptions options = InterpretOptions.defaultInstance();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0ODg5MQ==", "bodyText": "This is confusing, it reads like {@link SentimentType} is the input, not the output. Can you clarify wording?", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401148891", "createdAt": "2020-03-31T19:07:53Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/adapter/SentimentTypeAdapter.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.adapter;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.amplifyframework.predictions.models.SentimentType;\n+\n+import java.util.Locale;\n+\n+/**\n+ * Utility to convert third-party {@link SentimentType} equivalent", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE1MTU3NA==", "bodyText": "In this PR, you are inconsistently applying Objects.requireNonNull(...) when you label a param as @NonNull. So far, we have been using the requireNonNull for at least all user-provided fields (as this one.)", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401151574", "createdAt": "2020-03-31T19:12:32Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/request/TFLiteTextClassificationRequest.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.request;\n+\n+import androidx.annotation.NonNull;\n+\n+import java.util.Objects;\n+\n+/**\n+ * Simple request instance for text classification operation.\n+ */\n+public final class TFLiteTextClassificationRequest {\n+    private final String text;\n+\n+    /**\n+     * Constructs an instance of {@link TFLiteTextClassificationRequest}.\n+     * @param text the text to classify\n+     */\n+    public TFLiteTextClassificationRequest(@NonNull String text) {\n+        this.text = Objects.requireNonNull(text);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE1MzQyMw==", "bodyText": "release() or cleanup()? These sound more resource-management-y than close() (what did I open?)", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401153423", "createdAt": "2020-03-31T19:15:41Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/service/TFLitePredictionsService.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.service;\n+\n+import android.content.Context;\n+import androidx.annotation.NonNull;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * Predictions service that uses Tensorflow lite's\n+ * pre-trained models to make predictions offline.\n+ */\n+public final class TFLitePredictionsService {\n+\n+    private final TFLiteTextClassificationService textClassificationService;\n+\n+    /**\n+     * Constructs an instance of {@link TFLitePredictionsService}.\n+     * @param context Android context\n+     */\n+    public TFLitePredictionsService(@NonNull Context context) {\n+        this.textClassificationService = new TFLiteTextClassificationService(context);\n+    }\n+\n+    public void classify(\n+            @NonNull String text,\n+            @NonNull Consumer<InterpretResult> onSuccess,\n+            @NonNull Consumer<PredictionsException> onError\n+    ) {\n+        textClassificationService.classify(text, onSuccess, onError);\n+    }\n+\n+    /**\n+     * Free up resources used by Tensorflow lite.\n+     */\n+    public void close() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE1Mzc3OQ==", "bodyText": "MAX_SENTENCE_LEN", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401153779", "createdAt": "2020-03-31T19:16:18Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/service/TFLiteTextClassificationService.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.service;\n+\n+import android.content.Context;\n+import android.content.res.AssetFileDescriptor;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.ByteBuffer;\n+import java.nio.MappedByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from Tensorflow lite.\n+ */\n+final class TFLiteTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+    private static final String MODEL_PATH = \"text_classification.tflite\";\n+    private static final String DICTIONARY_PATH = \"text_classification_vocab.txt\";\n+    private static final String LABEL_PATH = \"text_classification_labels.txt\";\n+\n+    // The maximum length of an input sentence.\n+    private static final int SENTENCE_LEN = 256;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE1NDE5MQ==", "bodyText": "DELIMETER_REGEX?", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401154191", "createdAt": "2020-03-31T19:17:04Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/service/TFLiteTextClassificationService.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.service;\n+\n+import android.content.Context;\n+import android.content.res.AssetFileDescriptor;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.ByteBuffer;\n+import java.nio.MappedByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from Tensorflow lite.\n+ */\n+final class TFLiteTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+    private static final String MODEL_PATH = \"text_classification.tflite\";\n+    private static final String DICTIONARY_PATH = \"text_classification_vocab.txt\";\n+    private static final String LABEL_PATH = \"text_classification_labels.txt\";\n+\n+    // The maximum length of an input sentence.\n+    private static final int SENTENCE_LEN = 256;\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    // Simple delimiter to split words.\n+    private static final String SIMPLE_SPACE_OR_PUNCTUATION = \"[ ,.!?\\n]\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE3NDQxOQ==", "bodyText": "By convention, move any/all class initialization into constructor; keep field declarations as is.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401174419", "createdAt": "2020-03-31T19:53:12Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/service/TFLiteTextClassificationService.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.service;\n+\n+import android.content.Context;\n+import android.content.res.AssetFileDescriptor;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.ByteBuffer;\n+import java.nio.MappedByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from Tensorflow lite.\n+ */\n+final class TFLiteTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+    private static final String MODEL_PATH = \"text_classification.tflite\";\n+    private static final String DICTIONARY_PATH = \"text_classification_vocab.txt\";\n+    private static final String LABEL_PATH = \"text_classification_labels.txt\";\n+\n+    // The maximum length of an input sentence.\n+    private static final int SENTENCE_LEN = 256;\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    // Simple delimiter to split words.\n+    private static final String SIMPLE_SPACE_OR_PUNCTUATION = \"[ ,.!?\\n]\";\n+\n+    /*\n+     * Reserved values in ImdbDataSet dictionary:\n+     * dictionary[\"<PAD>\"] = 0      used for padding\n+     * dictionary[\"<START>\"] = 1    mark for the start of a sentence\n+     * dictionary[\"<UNKNOWN>\"] = 2  mark for unknown words (OOV)\n+     */\n+    private static final String PAD = \"<PAD>\";\n+    private static final String START = \"<START>\";\n+    private static final String UNKNOWN = \"<UNKNOWN>\";\n+\n+    private final Map<String, Integer> dictionary = new HashMap<>();\n+    private final List<String> labels = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE3NTIyNA==", "bodyText": "This one can be final, too.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401175224", "createdAt": "2020-03-31T19:54:31Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/service/TFLiteTextClassificationService.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.service;\n+\n+import android.content.Context;\n+import android.content.res.AssetFileDescriptor;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.ByteBuffer;\n+import java.nio.MappedByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from Tensorflow lite.\n+ */\n+final class TFLiteTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+    private static final String MODEL_PATH = \"text_classification.tflite\";\n+    private static final String DICTIONARY_PATH = \"text_classification_vocab.txt\";\n+    private static final String LABEL_PATH = \"text_classification_labels.txt\";\n+\n+    // The maximum length of an input sentence.\n+    private static final int SENTENCE_LEN = 256;\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    // Simple delimiter to split words.\n+    private static final String SIMPLE_SPACE_OR_PUNCTUATION = \"[ ,.!?\\n]\";\n+\n+    /*\n+     * Reserved values in ImdbDataSet dictionary:\n+     * dictionary[\"<PAD>\"] = 0      used for padding\n+     * dictionary[\"<START>\"] = 1    mark for the start of a sentence\n+     * dictionary[\"<UNKNOWN>\"] = 2  mark for unknown words (OOV)\n+     */\n+    private static final String PAD = \"<PAD>\";\n+    private static final String START = \"<START>\";\n+    private static final String UNKNOWN = \"<UNKNOWN>\";\n+\n+    private final Map<String, Integer> dictionary = new HashMap<>();\n+    private final List<String> labels = new ArrayList<>();\n+\n+    private final Context context;\n+\n+    private Interpreter tflite;\n+    private AtomicBoolean loaded;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE3NjUwNQ==", "bodyText": "Not in the constructor. You should always decouple object instantiation from doing \"real\" work. Particularly if its something hardcore like reading big files from disk.\nA better pattern would be to use this class like:\nClassifier classifier = new TensorflowClassifier();\nclassifier.loadModels();", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401176505", "createdAt": "2020-03-31T19:56:54Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/service/TFLiteTextClassificationService.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.service;\n+\n+import android.content.Context;\n+import android.content.res.AssetFileDescriptor;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.ByteBuffer;\n+import java.nio.MappedByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from Tensorflow lite.\n+ */\n+final class TFLiteTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+    private static final String MODEL_PATH = \"text_classification.tflite\";\n+    private static final String DICTIONARY_PATH = \"text_classification_vocab.txt\";\n+    private static final String LABEL_PATH = \"text_classification_labels.txt\";\n+\n+    // The maximum length of an input sentence.\n+    private static final int SENTENCE_LEN = 256;\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    // Simple delimiter to split words.\n+    private static final String SIMPLE_SPACE_OR_PUNCTUATION = \"[ ,.!?\\n]\";\n+\n+    /*\n+     * Reserved values in ImdbDataSet dictionary:\n+     * dictionary[\"<PAD>\"] = 0      used for padding\n+     * dictionary[\"<START>\"] = 1    mark for the start of a sentence\n+     * dictionary[\"<UNKNOWN>\"] = 2  mark for unknown words (OOV)\n+     */\n+    private static final String PAD = \"<PAD>\";\n+    private static final String START = \"<START>\";\n+    private static final String UNKNOWN = \"<UNKNOWN>\";\n+\n+    private final Map<String, Integer> dictionary = new HashMap<>();\n+    private final List<String> labels = new ArrayList<>();\n+\n+    private final Context context;\n+\n+    private Interpreter tflite;\n+    private AtomicBoolean loaded;\n+\n+    /**\n+     * Constructs an instance of service to perform text\n+     * sentiment interpretation using Tensorflow Lite\n+     * interpreter.\n+     * @param context the Android context for loading model\n+     */\n+    TFLiteTextClassificationService(Context context) {\n+        this.context = context;\n+        this.loaded = new AtomicBoolean(false);\n+\n+        try {\n+            // Try loading assets now if possible\n+            loadIfNotLoaded();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE3Nzg5Mg==", "bodyText": "Blargh. I wish this could say like Consumer<TextClassification> or something. Just talking out loud - please disregard as desired - what if we had a TextClassification extends InterpretResult?", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401177892", "createdAt": "2020-03-31T19:59:21Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/service/TFLiteTextClassificationService.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.service;\n+\n+import android.content.Context;\n+import android.content.res.AssetFileDescriptor;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.ByteBuffer;\n+import java.nio.MappedByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from Tensorflow lite.\n+ */\n+final class TFLiteTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+    private static final String MODEL_PATH = \"text_classification.tflite\";\n+    private static final String DICTIONARY_PATH = \"text_classification_vocab.txt\";\n+    private static final String LABEL_PATH = \"text_classification_labels.txt\";\n+\n+    // The maximum length of an input sentence.\n+    private static final int SENTENCE_LEN = 256;\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    // Simple delimiter to split words.\n+    private static final String SIMPLE_SPACE_OR_PUNCTUATION = \"[ ,.!?\\n]\";\n+\n+    /*\n+     * Reserved values in ImdbDataSet dictionary:\n+     * dictionary[\"<PAD>\"] = 0      used for padding\n+     * dictionary[\"<START>\"] = 1    mark for the start of a sentence\n+     * dictionary[\"<UNKNOWN>\"] = 2  mark for unknown words (OOV)\n+     */\n+    private static final String PAD = \"<PAD>\";\n+    private static final String START = \"<START>\";\n+    private static final String UNKNOWN = \"<UNKNOWN>\";\n+\n+    private final Map<String, Integer> dictionary = new HashMap<>();\n+    private final List<String> labels = new ArrayList<>();\n+\n+    private final Context context;\n+\n+    private Interpreter tflite;\n+    private AtomicBoolean loaded;\n+\n+    /**\n+     * Constructs an instance of service to perform text\n+     * sentiment interpretation using Tensorflow Lite\n+     * interpreter.\n+     * @param context the Android context for loading model\n+     */\n+    TFLiteTextClassificationService(Context context) {\n+        this.context = context;\n+        this.loaded = new AtomicBoolean(false);\n+\n+        try {\n+            // Try loading assets now if possible\n+            loadIfNotLoaded();\n+        } catch (PredictionsException exception) {\n+            // Ignore if it fails to load during configuration.\n+\n+            // This may sound weird, but we want the model to be loaded in as soon as possible.\n+            // But we don't want to throw an error that needs to be caught at configuration time,\n+            // since these models are supposed to be optional.\n+        }\n+    }\n+\n+    /**\n+     * Gets the associated service key of this service for\n+     * identification.\n+     * @return the service key\n+     */\n+    @NonNull\n+    String getServiceKey() {\n+        return SERVICE_KEY;\n+    }\n+\n+    /**\n+     * Classifies text to analyze associated sentiments.\n+     * @param text the text to classify\n+     * @param onSuccess notified when classification succeeds\n+     * @param onError notified when classification fails\n+     */\n+    void classify(\n+            @NonNull String text,\n+            @NonNull Consumer<InterpretResult> onSuccess,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE3OTg3Mg==", "bodyText": "The model loading in this category is analogous to the initialization work, in the DataStore.\nI added some lifecycle to accomodate this kind of stuff.\nconfigure() on the plugin reads the config file and instantiates some classes.\nintialize() can be used for this kind of heavy-lifting stuff, though.\nCheckout the afterInitializion() method in DataStore. We could externalize this utility into core. Then, both categories could use it.\nRight now, the logic is like:\n\nTry to load models at start up.\nBefore doing anything, try again.\n\nAnd its sort of relaxed about sequencing/error handling.\nWith the new approach, it'd be more like:\n\nTry to load model at initialization. If it fails, pass back error.\nDefer all operations until after that one initialization attempt succeeds/fails.\nOnly ever try to initialize at a single point in time during the operation of the system.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401179872", "createdAt": "2020-03-31T20:03:10Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/service/TFLiteTextClassificationService.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.service;\n+\n+import android.content.Context;\n+import android.content.res.AssetFileDescriptor;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.ByteBuffer;\n+import java.nio.MappedByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from Tensorflow lite.\n+ */\n+final class TFLiteTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+    private static final String MODEL_PATH = \"text_classification.tflite\";\n+    private static final String DICTIONARY_PATH = \"text_classification_vocab.txt\";\n+    private static final String LABEL_PATH = \"text_classification_labels.txt\";\n+\n+    // The maximum length of an input sentence.\n+    private static final int SENTENCE_LEN = 256;\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    // Simple delimiter to split words.\n+    private static final String SIMPLE_SPACE_OR_PUNCTUATION = \"[ ,.!?\\n]\";\n+\n+    /*\n+     * Reserved values in ImdbDataSet dictionary:\n+     * dictionary[\"<PAD>\"] = 0      used for padding\n+     * dictionary[\"<START>\"] = 1    mark for the start of a sentence\n+     * dictionary[\"<UNKNOWN>\"] = 2  mark for unknown words (OOV)\n+     */\n+    private static final String PAD = \"<PAD>\";\n+    private static final String START = \"<START>\";\n+    private static final String UNKNOWN = \"<UNKNOWN>\";\n+\n+    private final Map<String, Integer> dictionary = new HashMap<>();\n+    private final List<String> labels = new ArrayList<>();\n+\n+    private final Context context;\n+\n+    private Interpreter tflite;\n+    private AtomicBoolean loaded;\n+\n+    /**\n+     * Constructs an instance of service to perform text\n+     * sentiment interpretation using Tensorflow Lite\n+     * interpreter.\n+     * @param context the Android context for loading model\n+     */\n+    TFLiteTextClassificationService(Context context) {\n+        this.context = context;\n+        this.loaded = new AtomicBoolean(false);\n+\n+        try {\n+            // Try loading assets now if possible\n+            loadIfNotLoaded();\n+        } catch (PredictionsException exception) {\n+            // Ignore if it fails to load during configuration.\n+\n+            // This may sound weird, but we want the model to be loaded in as soon as possible.\n+            // But we don't want to throw an error that needs to be caught at configuration time,\n+            // since these models are supposed to be optional.\n+        }\n+    }\n+\n+    /**\n+     * Gets the associated service key of this service for\n+     * identification.\n+     * @return the service key\n+     */\n+    @NonNull\n+    String getServiceKey() {\n+        return SERVICE_KEY;\n+    }\n+\n+    /**\n+     * Classifies text to analyze associated sentiments.\n+     * @param text the text to classify\n+     * @param onSuccess notified when classification succeeds\n+     * @param onError notified when classification fails\n+     */\n+    void classify(\n+            @NonNull String text,\n+            @NonNull Consumer<InterpretResult> onSuccess,\n+            @NonNull Consumer<PredictionsException> onError\n+    ) {\n+        final Sentiment sentiment;\n+        try {\n+            loadIfNotLoaded();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4MTM4Nw==", "bodyText": "trivial -- when you have such a small amount of code for the payload, you can inline it:\nonSuccess.accept(InterpretResult.builder()\n    .sentiment(sentiment)\n    .build());\n\nActually, you could probably even bring that whole thing up into the try block:\ntry {\n    onSuccess.accept(InterpretResult.builder()\n        .sentiment(fetchSentiment(text))\n        .build());\n} catch (PredictionsException sentimentDetectionFailure) {\n    onError.accept(sentimentDetectionFailure);\n}", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401181387", "createdAt": "2020-03-31T20:05:51Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/service/TFLiteTextClassificationService.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.service;\n+\n+import android.content.Context;\n+import android.content.res.AssetFileDescriptor;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.ByteBuffer;\n+import java.nio.MappedByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from Tensorflow lite.\n+ */\n+final class TFLiteTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+    private static final String MODEL_PATH = \"text_classification.tflite\";\n+    private static final String DICTIONARY_PATH = \"text_classification_vocab.txt\";\n+    private static final String LABEL_PATH = \"text_classification_labels.txt\";\n+\n+    // The maximum length of an input sentence.\n+    private static final int SENTENCE_LEN = 256;\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    // Simple delimiter to split words.\n+    private static final String SIMPLE_SPACE_OR_PUNCTUATION = \"[ ,.!?\\n]\";\n+\n+    /*\n+     * Reserved values in ImdbDataSet dictionary:\n+     * dictionary[\"<PAD>\"] = 0      used for padding\n+     * dictionary[\"<START>\"] = 1    mark for the start of a sentence\n+     * dictionary[\"<UNKNOWN>\"] = 2  mark for unknown words (OOV)\n+     */\n+    private static final String PAD = \"<PAD>\";\n+    private static final String START = \"<START>\";\n+    private static final String UNKNOWN = \"<UNKNOWN>\";\n+\n+    private final Map<String, Integer> dictionary = new HashMap<>();\n+    private final List<String> labels = new ArrayList<>();\n+\n+    private final Context context;\n+\n+    private Interpreter tflite;\n+    private AtomicBoolean loaded;\n+\n+    /**\n+     * Constructs an instance of service to perform text\n+     * sentiment interpretation using Tensorflow Lite\n+     * interpreter.\n+     * @param context the Android context for loading model\n+     */\n+    TFLiteTextClassificationService(Context context) {\n+        this.context = context;\n+        this.loaded = new AtomicBoolean(false);\n+\n+        try {\n+            // Try loading assets now if possible\n+            loadIfNotLoaded();\n+        } catch (PredictionsException exception) {\n+            // Ignore if it fails to load during configuration.\n+\n+            // This may sound weird, but we want the model to be loaded in as soon as possible.\n+            // But we don't want to throw an error that needs to be caught at configuration time,\n+            // since these models are supposed to be optional.\n+        }\n+    }\n+\n+    /**\n+     * Gets the associated service key of this service for\n+     * identification.\n+     * @return the service key\n+     */\n+    @NonNull\n+    String getServiceKey() {\n+        return SERVICE_KEY;\n+    }\n+\n+    /**\n+     * Classifies text to analyze associated sentiments.\n+     * @param text the text to classify\n+     * @param onSuccess notified when classification succeeds\n+     * @param onError notified when classification fails\n+     */\n+    void classify(\n+            @NonNull String text,\n+            @NonNull Consumer<InterpretResult> onSuccess,\n+            @NonNull Consumer<PredictionsException> onError\n+    ) {\n+        final Sentiment sentiment;\n+        try {\n+            loadIfNotLoaded();\n+            sentiment = fetchSentiment(text);\n+        } catch (PredictionsException exception) {\n+            onError.accept(exception);\n+            return;\n+        }\n+\n+        InterpretResult result = InterpretResult.builder()\n+                .sentiment(sentiment)\n+                .build();\n+        onSuccess.accept(result);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 140}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4MTcwNw==", "bodyText": "Which assets?", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401181707", "createdAt": "2020-03-31T20:06:27Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/service/TFLiteTextClassificationService.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.service;\n+\n+import android.content.Context;\n+import android.content.res.AssetFileDescriptor;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.ByteBuffer;\n+import java.nio.MappedByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from Tensorflow lite.\n+ */\n+final class TFLiteTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+    private static final String MODEL_PATH = \"text_classification.tflite\";\n+    private static final String DICTIONARY_PATH = \"text_classification_vocab.txt\";\n+    private static final String LABEL_PATH = \"text_classification_labels.txt\";\n+\n+    // The maximum length of an input sentence.\n+    private static final int SENTENCE_LEN = 256;\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    // Simple delimiter to split words.\n+    private static final String SIMPLE_SPACE_OR_PUNCTUATION = \"[ ,.!?\\n]\";\n+\n+    /*\n+     * Reserved values in ImdbDataSet dictionary:\n+     * dictionary[\"<PAD>\"] = 0      used for padding\n+     * dictionary[\"<START>\"] = 1    mark for the start of a sentence\n+     * dictionary[\"<UNKNOWN>\"] = 2  mark for unknown words (OOV)\n+     */\n+    private static final String PAD = \"<PAD>\";\n+    private static final String START = \"<START>\";\n+    private static final String UNKNOWN = \"<UNKNOWN>\";\n+\n+    private final Map<String, Integer> dictionary = new HashMap<>();\n+    private final List<String> labels = new ArrayList<>();\n+\n+    private final Context context;\n+\n+    private Interpreter tflite;\n+    private AtomicBoolean loaded;\n+\n+    /**\n+     * Constructs an instance of service to perform text\n+     * sentiment interpretation using Tensorflow Lite\n+     * interpreter.\n+     * @param context the Android context for loading model\n+     */\n+    TFLiteTextClassificationService(Context context) {\n+        this.context = context;\n+        this.loaded = new AtomicBoolean(false);\n+\n+        try {\n+            // Try loading assets now if possible\n+            loadIfNotLoaded();\n+        } catch (PredictionsException exception) {\n+            // Ignore if it fails to load during configuration.\n+\n+            // This may sound weird, but we want the model to be loaded in as soon as possible.\n+            // But we don't want to throw an error that needs to be caught at configuration time,\n+            // since these models are supposed to be optional.\n+        }\n+    }\n+\n+    /**\n+     * Gets the associated service key of this service for\n+     * identification.\n+     * @return the service key\n+     */\n+    @NonNull\n+    String getServiceKey() {\n+        return SERVICE_KEY;\n+    }\n+\n+    /**\n+     * Classifies text to analyze associated sentiments.\n+     * @param text the text to classify\n+     * @param onSuccess notified when classification succeeds\n+     * @param onError notified when classification fails\n+     */\n+    void classify(\n+            @NonNull String text,\n+            @NonNull Consumer<InterpretResult> onSuccess,\n+            @NonNull Consumer<PredictionsException> onError\n+    ) {\n+        final Sentiment sentiment;\n+        try {\n+            loadIfNotLoaded();\n+            sentiment = fetchSentiment(text);\n+        } catch (PredictionsException exception) {\n+            onError.accept(exception);\n+            return;\n+        }\n+\n+        InterpretResult result = InterpretResult.builder()\n+                .sentiment(sentiment)\n+                .build();\n+        onSuccess.accept(result);\n+    }\n+\n+    private Sentiment fetchSentiment(String text) throws PredictionsException {\n+        float[][] input;\n+        float[][] output;\n+\n+        // Pre-process input text\n+        try {\n+            input = tokenizeInputText(text);\n+            output = new float[1][labels.size()];\n+        } catch (IllegalArgumentException exception) {\n+            throw new PredictionsException(\n+                    \"Tensorflow Lite failed to make inference.\",\n+                    exception,\n+                    \"Verify that the assets are loaded.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4MzE4Mg==", "bodyText": "should this be called fetchPredominantSentiment?", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401183182", "createdAt": "2020-03-31T20:08:56Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/service/TFLiteTextClassificationService.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.service;\n+\n+import android.content.Context;\n+import android.content.res.AssetFileDescriptor;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.ByteBuffer;\n+import java.nio.MappedByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from Tensorflow lite.\n+ */\n+final class TFLiteTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+    private static final String MODEL_PATH = \"text_classification.tflite\";\n+    private static final String DICTIONARY_PATH = \"text_classification_vocab.txt\";\n+    private static final String LABEL_PATH = \"text_classification_labels.txt\";\n+\n+    // The maximum length of an input sentence.\n+    private static final int SENTENCE_LEN = 256;\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    // Simple delimiter to split words.\n+    private static final String SIMPLE_SPACE_OR_PUNCTUATION = \"[ ,.!?\\n]\";\n+\n+    /*\n+     * Reserved values in ImdbDataSet dictionary:\n+     * dictionary[\"<PAD>\"] = 0      used for padding\n+     * dictionary[\"<START>\"] = 1    mark for the start of a sentence\n+     * dictionary[\"<UNKNOWN>\"] = 2  mark for unknown words (OOV)\n+     */\n+    private static final String PAD = \"<PAD>\";\n+    private static final String START = \"<START>\";\n+    private static final String UNKNOWN = \"<UNKNOWN>\";\n+\n+    private final Map<String, Integer> dictionary = new HashMap<>();\n+    private final List<String> labels = new ArrayList<>();\n+\n+    private final Context context;\n+\n+    private Interpreter tflite;\n+    private AtomicBoolean loaded;\n+\n+    /**\n+     * Constructs an instance of service to perform text\n+     * sentiment interpretation using Tensorflow Lite\n+     * interpreter.\n+     * @param context the Android context for loading model\n+     */\n+    TFLiteTextClassificationService(Context context) {\n+        this.context = context;\n+        this.loaded = new AtomicBoolean(false);\n+\n+        try {\n+            // Try loading assets now if possible\n+            loadIfNotLoaded();\n+        } catch (PredictionsException exception) {\n+            // Ignore if it fails to load during configuration.\n+\n+            // This may sound weird, but we want the model to be loaded in as soon as possible.\n+            // But we don't want to throw an error that needs to be caught at configuration time,\n+            // since these models are supposed to be optional.\n+        }\n+    }\n+\n+    /**\n+     * Gets the associated service key of this service for\n+     * identification.\n+     * @return the service key\n+     */\n+    @NonNull\n+    String getServiceKey() {\n+        return SERVICE_KEY;\n+    }\n+\n+    /**\n+     * Classifies text to analyze associated sentiments.\n+     * @param text the text to classify\n+     * @param onSuccess notified when classification succeeds\n+     * @param onError notified when classification fails\n+     */\n+    void classify(\n+            @NonNull String text,\n+            @NonNull Consumer<InterpretResult> onSuccess,\n+            @NonNull Consumer<PredictionsException> onError\n+    ) {\n+        final Sentiment sentiment;\n+        try {\n+            loadIfNotLoaded();\n+            sentiment = fetchSentiment(text);\n+        } catch (PredictionsException exception) {\n+            onError.accept(exception);\n+            return;\n+        }\n+\n+        InterpretResult result = InterpretResult.builder()\n+                .sentiment(sentiment)\n+                .build();\n+        onSuccess.accept(result);\n+    }\n+\n+    private Sentiment fetchSentiment(String text) throws PredictionsException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4MzkyMQ==", "bodyText": "This method looks like it's doing some interesting stuff. Can you add a little Javadoc above it, to orient the reader? \"We need the input in format (what format?) But, it's in (what format?). So we (perform transformations?).\"", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401183921", "createdAt": "2020-03-31T20:10:12Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/service/TFLiteTextClassificationService.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.service;\n+\n+import android.content.Context;\n+import android.content.res.AssetFileDescriptor;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.ByteBuffer;\n+import java.nio.MappedByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from Tensorflow lite.\n+ */\n+final class TFLiteTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+    private static final String MODEL_PATH = \"text_classification.tflite\";\n+    private static final String DICTIONARY_PATH = \"text_classification_vocab.txt\";\n+    private static final String LABEL_PATH = \"text_classification_labels.txt\";\n+\n+    // The maximum length of an input sentence.\n+    private static final int SENTENCE_LEN = 256;\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    // Simple delimiter to split words.\n+    private static final String SIMPLE_SPACE_OR_PUNCTUATION = \"[ ,.!?\\n]\";\n+\n+    /*\n+     * Reserved values in ImdbDataSet dictionary:\n+     * dictionary[\"<PAD>\"] = 0      used for padding\n+     * dictionary[\"<START>\"] = 1    mark for the start of a sentence\n+     * dictionary[\"<UNKNOWN>\"] = 2  mark for unknown words (OOV)\n+     */\n+    private static final String PAD = \"<PAD>\";\n+    private static final String START = \"<START>\";\n+    private static final String UNKNOWN = \"<UNKNOWN>\";\n+\n+    private final Map<String, Integer> dictionary = new HashMap<>();\n+    private final List<String> labels = new ArrayList<>();\n+\n+    private final Context context;\n+\n+    private Interpreter tflite;\n+    private AtomicBoolean loaded;\n+\n+    /**\n+     * Constructs an instance of service to perform text\n+     * sentiment interpretation using Tensorflow Lite\n+     * interpreter.\n+     * @param context the Android context for loading model\n+     */\n+    TFLiteTextClassificationService(Context context) {\n+        this.context = context;\n+        this.loaded = new AtomicBoolean(false);\n+\n+        try {\n+            // Try loading assets now if possible\n+            loadIfNotLoaded();\n+        } catch (PredictionsException exception) {\n+            // Ignore if it fails to load during configuration.\n+\n+            // This may sound weird, but we want the model to be loaded in as soon as possible.\n+            // But we don't want to throw an error that needs to be caught at configuration time,\n+            // since these models are supposed to be optional.\n+        }\n+    }\n+\n+    /**\n+     * Gets the associated service key of this service for\n+     * identification.\n+     * @return the service key\n+     */\n+    @NonNull\n+    String getServiceKey() {\n+        return SERVICE_KEY;\n+    }\n+\n+    /**\n+     * Classifies text to analyze associated sentiments.\n+     * @param text the text to classify\n+     * @param onSuccess notified when classification succeeds\n+     * @param onError notified when classification fails\n+     */\n+    void classify(\n+            @NonNull String text,\n+            @NonNull Consumer<InterpretResult> onSuccess,\n+            @NonNull Consumer<PredictionsException> onError\n+    ) {\n+        final Sentiment sentiment;\n+        try {\n+            loadIfNotLoaded();\n+            sentiment = fetchSentiment(text);\n+        } catch (PredictionsException exception) {\n+            onError.accept(exception);\n+            return;\n+        }\n+\n+        InterpretResult result = InterpretResult.builder()\n+                .sentiment(sentiment)\n+                .build();\n+        onSuccess.accept(result);\n+    }\n+\n+    private Sentiment fetchSentiment(String text) throws PredictionsException {\n+        float[][] input;\n+        float[][] output;\n+\n+        // Pre-process input text\n+        try {\n+            input = tokenizeInputText(text);\n+            output = new float[1][labels.size()];\n+        } catch (IllegalArgumentException exception) {\n+            throw new PredictionsException(\n+                    \"Tensorflow Lite failed to make inference.\",\n+                    exception,\n+                    \"Verify that the assets are loaded.\"\n+            );\n+        }\n+\n+        // Run inference.\n+        tflite.run(input, output);\n+\n+        // Find the predominant sentiment\n+        Sentiment sentiment = null;\n+        for (int i = 0; i < labels.size(); i++) {\n+            SentimentType sentimentType = SentimentTypeAdapter.fromTensorflow(labels.get(i));\n+            float confidenceScore = output[0][i] * PERCENT;\n+            if (sentiment == null || sentiment.getConfidence() < confidenceScore) {\n+                sentiment = Sentiment.builder()\n+                        .value(sentimentType)\n+                        .confidence(confidenceScore)\n+                        .build();\n+            }\n+        }\n+        return sentiment;\n+    }\n+\n+    @SuppressWarnings(\"ConstantConditions\")\n+    private float[][] tokenizeInputText(String text) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 178}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4NzMzOA==", "bodyText": "You have a number of different components that have a similar lifecycle: load(), isLoaded().\nYou could make a Loadable interface:\n// V = value type for thing that is loaded, e.g. a Map<String, Integer> dictionary, etc.\ninterface Loadable<V> {\n    void load();\n    void unload();\n    boolean isLoaded();\n    onLoaded(Consumer<V> valueConsumer);\n    onUnloaded(Action unloadAction);\n    @Nullable V value()\n}\n\nIf you have somehting like this, you can externalize all of these details into small little template files and compartmentalize the load/validation logic into them.\nThen the classification refers to them more like:\nfor (Loadable<?> dependency : LOADABLES) {\n    if (!dependency.isLoaded()) {\n        dependency.load();\n    }\n}\n\nI guess you'd want this to happen as a down-stream result of the call-chain from thePlugin<?>'s initialize() lifecycle method.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401187338", "createdAt": "2020-03-31T20:16:10Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/service/TFLiteTextClassificationService.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.service;\n+\n+import android.content.Context;\n+import android.content.res.AssetFileDescriptor;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.io.BufferedReader;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.ByteBuffer;\n+import java.nio.MappedByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from Tensorflow lite.\n+ */\n+final class TFLiteTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+    private static final String MODEL_PATH = \"text_classification.tflite\";\n+    private static final String DICTIONARY_PATH = \"text_classification_vocab.txt\";\n+    private static final String LABEL_PATH = \"text_classification_labels.txt\";\n+\n+    // The maximum length of an input sentence.\n+    private static final int SENTENCE_LEN = 256;\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    // Simple delimiter to split words.\n+    private static final String SIMPLE_SPACE_OR_PUNCTUATION = \"[ ,.!?\\n]\";\n+\n+    /*\n+     * Reserved values in ImdbDataSet dictionary:\n+     * dictionary[\"<PAD>\"] = 0      used for padding\n+     * dictionary[\"<START>\"] = 1    mark for the start of a sentence\n+     * dictionary[\"<UNKNOWN>\"] = 2  mark for unknown words (OOV)\n+     */\n+    private static final String PAD = \"<PAD>\";\n+    private static final String START = \"<START>\";\n+    private static final String UNKNOWN = \"<UNKNOWN>\";\n+\n+    private final Map<String, Integer> dictionary = new HashMap<>();\n+    private final List<String> labels = new ArrayList<>();\n+\n+    private final Context context;\n+\n+    private Interpreter tflite;\n+    private AtomicBoolean loaded;\n+\n+    /**\n+     * Constructs an instance of service to perform text\n+     * sentiment interpretation using Tensorflow Lite\n+     * interpreter.\n+     * @param context the Android context for loading model\n+     */\n+    TFLiteTextClassificationService(Context context) {\n+        this.context = context;\n+        this.loaded = new AtomicBoolean(false);\n+\n+        try {\n+            // Try loading assets now if possible\n+            loadIfNotLoaded();\n+        } catch (PredictionsException exception) {\n+            // Ignore if it fails to load during configuration.\n+\n+            // This may sound weird, but we want the model to be loaded in as soon as possible.\n+            // But we don't want to throw an error that needs to be caught at configuration time,\n+            // since these models are supposed to be optional.\n+        }\n+    }\n+\n+    /**\n+     * Gets the associated service key of this service for\n+     * identification.\n+     * @return the service key\n+     */\n+    @NonNull\n+    String getServiceKey() {\n+        return SERVICE_KEY;\n+    }\n+\n+    /**\n+     * Classifies text to analyze associated sentiments.\n+     * @param text the text to classify\n+     * @param onSuccess notified when classification succeeds\n+     * @param onError notified when classification fails\n+     */\n+    void classify(\n+            @NonNull String text,\n+            @NonNull Consumer<InterpretResult> onSuccess,\n+            @NonNull Consumer<PredictionsException> onError\n+    ) {\n+        final Sentiment sentiment;\n+        try {\n+            loadIfNotLoaded();\n+            sentiment = fetchSentiment(text);\n+        } catch (PredictionsException exception) {\n+            onError.accept(exception);\n+            return;\n+        }\n+\n+        InterpretResult result = InterpretResult.builder()\n+                .sentiment(sentiment)\n+                .build();\n+        onSuccess.accept(result);\n+    }\n+\n+    private Sentiment fetchSentiment(String text) throws PredictionsException {\n+        float[][] input;\n+        float[][] output;\n+\n+        // Pre-process input text\n+        try {\n+            input = tokenizeInputText(text);\n+            output = new float[1][labels.size()];\n+        } catch (IllegalArgumentException exception) {\n+            throw new PredictionsException(\n+                    \"Tensorflow Lite failed to make inference.\",\n+                    exception,\n+                    \"Verify that the assets are loaded.\"\n+            );\n+        }\n+\n+        // Run inference.\n+        tflite.run(input, output);\n+\n+        // Find the predominant sentiment\n+        Sentiment sentiment = null;\n+        for (int i = 0; i < labels.size(); i++) {\n+            SentimentType sentimentType = SentimentTypeAdapter.fromTensorflow(labels.get(i));\n+            float confidenceScore = output[0][i] * PERCENT;\n+            if (sentiment == null || sentiment.getConfidence() < confidenceScore) {\n+                sentiment = Sentiment.builder()\n+                        .value(sentimentType)\n+                        .confidence(confidenceScore)\n+                        .build();\n+            }\n+        }\n+        return sentiment;\n+    }\n+\n+    @SuppressWarnings(\"ConstantConditions\")\n+    private float[][] tokenizeInputText(String text) {\n+        float[] tmp = new float[SENTENCE_LEN];\n+\n+        int index = 0;\n+        tmp[index++] = dictionary.get(START);\n+\n+        for (String word : text.split(SIMPLE_SPACE_OR_PUNCTUATION)) {\n+            if (index >= SENTENCE_LEN) {\n+                break;\n+            }\n+\n+            tmp[index++] = dictionary.containsKey(word)\n+                    ? dictionary.get(word)\n+                    : dictionary.get(UNKNOWN);\n+        }\n+\n+        // Padding and wrapping.\n+        Arrays.fill(tmp, index, SENTENCE_LEN - 1, dictionary.get(PAD));\n+        return new float[][]{tmp};\n+    }\n+\n+    @WorkerThread\n+    private synchronized void loadIfNotLoaded() throws PredictionsException {\n+        if (loaded.get()) {\n+            return;\n+        }\n+        loadModel();\n+        loadDictionary();\n+        loadLabels();\n+        loaded.set(true);\n+    }\n+\n+    @WorkerThread\n+    private synchronized void loadModel() throws PredictionsException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 211}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MDc3NDk2", "url": "https://github.com/aws-amplify/amplify-android/pull/336#pullrequestreview-385077496", "createdAt": "2020-03-31T20:25:19Z", "commit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDoyNToxOVrOF-m3Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMDoyNToxOVrOF-m3Iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MjczOQ==", "bodyText": "In software, there's always a choice, between \"Fail fast\" and \"degrade gracefully.\"\nWith exception handling, sometimes we see this as \"bubble up the error,\" versus. \"return null.\"\nWith object construction - here, this enum factory - we have the same sort of thing to consider.  We can either:\n\nThrow an error if the input is unknown/invalid. Perhaps, InvalidArgumentException.\nDegrade to an UNKNOWN, type, like you are.\n\nI think the key thing to consider is this: Is the system useful/usable when the value is UNKNOWN? If not, maybe we should \"fail fast.\"", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r401192739", "createdAt": "2020-03-31T20:25:19Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tfl/src/main/java/com/amplifyframework/predictions/adapter/SentimentTypeAdapter.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.adapter;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.amplifyframework.predictions.models.SentimentType;\n+\n+import java.util.Locale;\n+\n+/**\n+ * Utility to convert third-party {@link SentimentType} equivalent\n+ * into Amplify-compatible data structure.\n+ */\n+public final class SentimentTypeAdapter {\n+    @SuppressWarnings(\"checkstyle:all\") private SentimentTypeAdapter() {}\n+\n+    /**\n+     * Converts the sentiment string returned by Tensorflow Lite\n+     * Interpreter into a format supported by Amplify Predictions.\n+     * @param sentiment Sentiment type returned by AWS Comprehend\n+     * @return Amplify's {@link SentimentType} enum\n+     */\n+    @NonNull\n+    public static SentimentType fromTensorflow(@NonNull String sentiment) {\n+        switch (sentiment.toLowerCase(Locale.US)) {\n+            case \"positive\":\n+                return SentimentType.POSITIVE;\n+            case \"negative\":\n+                return SentimentType.NEGATIVE;\n+            default:\n+                return SentimentType.UNKNOWN;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659d810c6a31ed93e939dcee18df4cc3ce5a20a"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7062b59d32180becf6e57878ba344b531390b47b", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/7062b59d32180becf6e57878ba344b531390b47b", "committedDate": "2020-03-31T21:42:25Z", "message": "Fix build.gradle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74d077ddf0ce27be8e7dfffe1e1daa498f17c020", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/74d077ddf0ce27be8e7dfffe1e1daa498f17c020", "committedDate": "2020-03-31T21:46:51Z", "message": "Rename module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bdda23a43591666be2abc07ea8b0cad11cd30dd", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/0bdda23a43591666be2abc07ea8b0cad11cd30dd", "committedDate": "2020-03-31T22:38:51Z", "message": "Rename tensorflow package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f918dbc068b1fb7f9278ea1656d7d1fd17a4299f", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/f918dbc068b1fb7f9278ea1656d7d1fd17a4299f", "committedDate": "2020-03-31T22:43:53Z", "message": "Clarify brand name for TensorFlow Lite"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8416287255a82a0db8fc3f693bc85c6cfb7cb68", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/e8416287255a82a0db8fc3f693bc85c6cfb7cb68", "committedDate": "2020-03-31T22:50:24Z", "message": "Fix import order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fccd229506df082712b03fb2084710e8ab456294", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/fccd229506df082712b03fb2084710e8ab456294", "committedDate": "2020-03-31T23:32:29Z", "message": "Apply suggestions from Jameson (without load changes)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "fccd229506df082712b03fb2084710e8ab456294", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/fccd229506df082712b03fb2084710e8ab456294", "committedDate": "2020-03-31T23:32:29Z", "message": "Apply suggestions from Jameson (without load changes)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "017386b9fcea4dde2908519ac0b37a50fbf74aae", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/017386b9fcea4dde2908519ac0b37a50fbf74aae", "committedDate": "2020-04-02T20:29:05Z", "message": "Add blocking logic on initialization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NTIwMTk1", "url": "https://github.com/aws-amplify/amplify-android/pull/336#pullrequestreview-387520195", "createdAt": "2020-04-03T19:20:28Z", "commit": {"oid": "017386b9fcea4dde2908519ac0b37a50fbf74aae"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxOToyMDoyOFrOGAk_jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxOTo1MDoxOVrOGAmSYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI1OTI3OQ==", "bodyText": "Should get a missing Javadoc warning from Checkstyle on this, no?", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403259279", "createdAt": "2020-04-03T19:20:28Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/TensorFlowPredictionsPlugin.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow;\n+\n+import android.content.Context;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.PredictionsPlugin;\n+import com.amplifyframework.predictions.operation.InterpretOperation;\n+import com.amplifyframework.predictions.options.InterpretOptions;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+import com.amplifyframework.predictions.tensorflow.operation.TensorFlowInterpretOperation;\n+import com.amplifyframework.predictions.tensorflow.request.TensorFlowTextClassificationRequest;\n+import com.amplifyframework.predictions.tensorflow.service.TensorFlowPredictionsService;\n+\n+import org.json.JSONObject;\n+\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * A plugin for Predictions category that uses models from\n+ * TensorFlow Lite to carry out tasks offline.\n+ */\n+public final class TensorFlowPredictionsPlugin extends PredictionsPlugin<TensorFlowPredictionsEscapeHatch> {\n+    private static final String TFL_PREDICTIONS_PLUGIN_KEY = \"tflPredictionsPlugin\";\n+\n+    private final ExecutorService executorService;\n+\n+    private TensorFlowPredictionsService predictionsService;\n+\n+    public TensorFlowPredictionsPlugin() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017386b9fcea4dde2908519ac0b37a50fbf74aae"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI1OTc2Ng==", "bodyText": "\"tensorFlowPrecitionsPlugin\"?", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403259766", "createdAt": "2020-04-03T19:21:38Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/TensorFlowPredictionsPlugin.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow;\n+\n+import android.content.Context;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.PredictionsPlugin;\n+import com.amplifyframework.predictions.operation.InterpretOperation;\n+import com.amplifyframework.predictions.options.InterpretOptions;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+import com.amplifyframework.predictions.tensorflow.operation.TensorFlowInterpretOperation;\n+import com.amplifyframework.predictions.tensorflow.request.TensorFlowTextClassificationRequest;\n+import com.amplifyframework.predictions.tensorflow.service.TensorFlowPredictionsService;\n+\n+import org.json.JSONObject;\n+\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * A plugin for Predictions category that uses models from\n+ * TensorFlow Lite to carry out tasks offline.\n+ */\n+public final class TensorFlowPredictionsPlugin extends PredictionsPlugin<TensorFlowPredictionsEscapeHatch> {\n+    private static final String TFL_PREDICTIONS_PLUGIN_KEY = \"tflPredictionsPlugin\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017386b9fcea4dde2908519ac0b37a50fbf74aae"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI2MTgyNQ==", "bodyText": "As per other PR, you could consider using a ContextProvider @FunctionalInterface to work around the ordering of object construction, e.g.\npublic final class TensorFlowPredictionsPlugin {\n    public TensortFlowPredictionsPlugin() {\n        this.predictionsService = new TensorFlowPredictionsService(() -> context);   \n    }\n}\n\nfinal class TensorFlowPredictionsService {\n    private final ContextResovler contextResolver;\n    TensorFlowPredictionsService(ContextResolver contextResolver) {\n        this.contextResovler = contextResovler;\n    }\n\n    public void someCategoryBehaviorImpl() {\n        // Oh, we need it now ...\n        Context resolvedContext = contextResolver.resolveContext();\n    }\n\n    @FunctionalItnerface interface ContextResolver {\n        Context resolveContext();\n    }\n}", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403261825", "createdAt": "2020-04-03T19:25:41Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/TensorFlowPredictionsPlugin.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow;\n+\n+import android.content.Context;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.PredictionsPlugin;\n+import com.amplifyframework.predictions.operation.InterpretOperation;\n+import com.amplifyframework.predictions.options.InterpretOptions;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+import com.amplifyframework.predictions.tensorflow.operation.TensorFlowInterpretOperation;\n+import com.amplifyframework.predictions.tensorflow.request.TensorFlowTextClassificationRequest;\n+import com.amplifyframework.predictions.tensorflow.service.TensorFlowPredictionsService;\n+\n+import org.json.JSONObject;\n+\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * A plugin for Predictions category that uses models from\n+ * TensorFlow Lite to carry out tasks offline.\n+ */\n+public final class TensorFlowPredictionsPlugin extends PredictionsPlugin<TensorFlowPredictionsEscapeHatch> {\n+    private static final String TFL_PREDICTIONS_PLUGIN_KEY = \"tflPredictionsPlugin\";\n+\n+    private final ExecutorService executorService;\n+\n+    private TensorFlowPredictionsService predictionsService;\n+\n+    public TensorFlowPredictionsPlugin() {\n+        this.executorService = Executors.newCachedThreadPool();\n+    }\n+\n+    @NonNull\n+    @Override\n+    public String getPluginKey() {\n+        return TFL_PREDICTIONS_PLUGIN_KEY;\n+    }\n+\n+    @Override\n+    public void configure(\n+            JSONObject pluginConfiguration,\n+            @NonNull Context context\n+    ) throws AmplifyException {\n+        this.predictionsService = new TensorFlowPredictionsService(context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017386b9fcea4dde2908519ac0b37a50fbf74aae"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI2MjY2NQ==", "bodyText": "(Suppression not needed anymore)", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403262665", "createdAt": "2020-04-03T19:27:21Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/adapter/SentimentTypeAdapter.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.adapter;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.amplifyframework.predictions.models.SentimentType;\n+\n+import java.util.Locale;\n+\n+/**\n+ * Utility to convert third-party sentiment feature equivalent\n+ * into Amplify-compatible data structure (i.e. {@link SentimentType}).\n+ */\n+public final class SentimentTypeAdapter {\n+    @SuppressWarnings(\"checkstyle:all\") private SentimentTypeAdapter() {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017386b9fcea4dde2908519ac0b37a50fbf74aae"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI2NDg3MA==", "bodyText": "If we have isLoaded(), technically the caller knows all they need to. We could make this @NonNull, and have it throw if there's no loaded value. So then the usage would be:\nif (loadable.isLoaded()) {\n    loadable.getValue(); // This works!\n} else {\n    loadable.getValue(); // This throw.\n}\n\nugh also, we have to start using get in front of accessors. Can you scrub all of your work for this, haha? I hate it, but Kotlin interop, loves it. I'm more flexible than the computer programming language, so have to go with what it wants. :-D", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403264870", "createdAt": "2020-04-03T19:30:07Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/asset/Loadable.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.asset;\n+\n+import androidx.annotation.Nullable;\n+\n+import com.amplifyframework.core.Action;\n+import com.amplifyframework.core.Consumer;\n+\n+/**\n+ * Defines the behavior of a loadable resource.\n+ * @param <V> the data type of the resource being loaded\n+ * @param <E> the error type for this resource\n+ */\n+public interface Loadable<V, E extends Exception> {\n+    /**\n+     * Begin loading the resources.\n+     */\n+    void load();\n+\n+    /**\n+     * Free up the loaded resources.\n+     */\n+    void unload();\n+\n+    /**\n+     * Return true if the resources are fully loaded.\n+     * @return true if the resources are fully loaded\n+     */\n+    boolean isLoaded();\n+\n+    /**\n+     * Sets the consumer of the loaded value to be\n+     * triggered upon load completion.\n+     * @param onLoaded the consumer of the loaded value\n+     * @return this loadable instance for chaining\n+     */\n+    Loadable<V, E> onLoaded(Consumer<V> onLoaded);\n+\n+    /**\n+     * Sets the consumer of an error which will be triggered\n+     * upon encountering an error while loading/unloading.\n+     * @param onError the consumer of the thrown exception\n+     * @return this loadable instance for chaining\n+     */\n+    Loadable<V, E> onError(Consumer<E> onError);\n+\n+    /**\n+     * Sets the action item to be triggered upon unload\n+     * completion.\n+     * @param onUnloaded the action to invoke upon unload\n+     * @return this loadable instance for chaining\n+     */\n+    Loadable<V, E> onUnloaded(Action onUnloaded);\n+\n+    /**\n+     * Gets the loaded value. Null if the resource was\n+     * not loaded or fully loaded yet.\n+     * @return the loaded value\n+     */\n+    @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017386b9fcea4dde2908519ac0b37a50fbf74aae"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI2NjAyMQ==", "bodyText": "onLoadError(...), or onErrorLoading(...)?\n(Also, if you don't actually need all of these bells and whistles, feel free to strip some out. I may have gone overboard when I initially spec'd out this Loadable in the last round of PR feedback ...)\nOhhh. Or, maybe we should have:\nvoid onLoaded(Consumer<V> loadedValue, Consumer<E> failureToLoad);\n\nvoid onUnloaded(Action unloadAction, Consumer<E> failureToUnload);\n\n^^ Note, technically the unload could fail too, so we should include an error consumer for it, as well. But, by the time we have these four hooks, we probably don't want four seaprate APIs on Loadable. We can distill success/failure actions into just the two, though: onLoad, onUnload.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403266021", "createdAt": "2020-04-03T19:31:43Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/asset/Loadable.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.asset;\n+\n+import androidx.annotation.Nullable;\n+\n+import com.amplifyframework.core.Action;\n+import com.amplifyframework.core.Consumer;\n+\n+/**\n+ * Defines the behavior of a loadable resource.\n+ * @param <V> the data type of the resource being loaded\n+ * @param <E> the error type for this resource\n+ */\n+public interface Loadable<V, E extends Exception> {\n+    /**\n+     * Begin loading the resources.\n+     */\n+    void load();\n+\n+    /**\n+     * Free up the loaded resources.\n+     */\n+    void unload();\n+\n+    /**\n+     * Return true if the resources are fully loaded.\n+     * @return true if the resources are fully loaded\n+     */\n+    boolean isLoaded();\n+\n+    /**\n+     * Sets the consumer of the loaded value to be\n+     * triggered upon load completion.\n+     * @param onLoaded the consumer of the loaded value\n+     * @return this loadable instance for chaining\n+     */\n+    Loadable<V, E> onLoaded(Consumer<V> onLoaded);\n+\n+    /**\n+     * Sets the consumer of an error which will be triggered\n+     * upon encountering an error while loading/unloading.\n+     * @param onError the consumer of the thrown exception\n+     * @return this loadable instance for chaining\n+     */\n+    Loadable<V, E> onError(Consumer<E> onError);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017386b9fcea4dde2908519ac0b37a50fbf74aae"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI2ODkwOA==", "bodyText": "You can have this just take a dependency on Android's Assets directly, if that's all you need.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403268908", "createdAt": "2020-04-03T19:35:34Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/asset/TextClassificationDictionary.java", "diffHunk": "@@ -0,0 +1,247 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.asset;\n+\n+import android.content.Context;\n+import android.content.res.AssetManager;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Action;\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Loads the list of words and their numerical indices that the\n+ * text classifier can recognize.\n+ *\n+ * The file being loaded should be in the format of:\n+ * <pre>\n+ * &#60;PAD&#62; 0\n+ * &#60;START&#62; 1\n+ * &#60;UNKNOWN&#62; 2\n+ * word 3\n+ * word 4\n+ * ...\n+ * </pre>\n+ */\n+public class TextClassificationDictionary implements Loadable<Map<String, Integer>, PredictionsException> {\n+    private static final String DICTIONARY_PATH = \"text_classification_vocab.txt\";\n+\n+    // The maximum length of an input sentence.\n+    private static final int MAX_SENTENCE_LENGTH = 256;\n+\n+    // Simple delimiter to split words.\n+    private static final String DELIMITER_REGEX = \"[ ,.!?\\n]\";\n+\n+    /*\n+     * Reserved values in ImdbDataSet dictionary:\n+     * dictionary[\"<PAD>\"] = 0      used for padding\n+     * dictionary[\"<START>\"] = 1    mark for the start of a sentence\n+     * dictionary[\"<UNKNOWN>\"] = 2  mark for unknown words (OOV)\n+     */\n+    private static final String PAD = \"<PAD>\";\n+    private static final String START = \"<START>\";\n+    private static final String UNKNOWN = \"<UNKNOWN>\";\n+\n+    private final AssetManager assets;\n+    private final Map<String, Integer> dictionary;\n+\n+    private Consumer<Map<String, Integer>> onLoaded;\n+    private Consumer<PredictionsException> onError;\n+    private Action onUnloaded;\n+    private boolean loaded;\n+\n+    /**\n+     * Constructs a loader for text classification dictionary.\n+     * @param context the Android context\n+     */\n+    public TextClassificationDictionary(@NonNull Context context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017386b9fcea4dde2908519ac0b37a50fbf74aae"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI3NDE5MA==", "bodyText": "You could probablly even wrap this stuff up into its own Loadable, a Loadable<List<Loadable<?, PredictionsException>>, PredictionsException>. (Lol, that type.) But basically, a loadable that is able to load a list of loadables.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403274190", "createdAt": "2020-04-03T19:42:01Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/service/TensorFlowTextClassificationService.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.service;\n+\n+import android.content.Context;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+import com.amplifyframework.predictions.tensorflow.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.tensorflow.asset.Loadable;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationDictionary;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationLabels;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationModel;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from TensorFlow Lite.\n+ */\n+final class TensorFlowTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    private final TextClassificationModel interpreter;\n+    private final TextClassificationDictionary dictionary;\n+    private final TextClassificationLabels labels;\n+    private final List<Loadable<?, PredictionsException>> assets;\n+    private final CountDownLatch loaded;\n+\n+    private PredictionsException loadingError;\n+\n+    /**\n+     * Constructs an instance of service to perform text\n+     * sentiment interpretation using TensorFlow Lite\n+     * interpreter.\n+     * @param context the Android context\n+     */\n+    TensorFlowTextClassificationService(@NonNull Context context) {\n+        this.interpreter = new TextClassificationModel(context);\n+        this.dictionary = new TextClassificationDictionary(context);\n+        this.labels = new TextClassificationLabels(context);\n+\n+        this.assets = Arrays.asList(interpreter, dictionary, labels);\n+        this.loaded = new CountDownLatch(assets.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017386b9fcea4dde2908519ac0b37a50fbf74aae"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI3NTcwOQ==", "bodyText": "Hm, alright. Yea. You could even set an initial value for this, like \"Not yet initialized\", and then clear it back to null, after intiailization was done. That way the category behaviors could throw that kind of message if need be, too, with your existing control flow.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403275709", "createdAt": "2020-04-03T19:44:02Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/service/TensorFlowTextClassificationService.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.service;\n+\n+import android.content.Context;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+import com.amplifyframework.predictions.tensorflow.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.tensorflow.asset.Loadable;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationDictionary;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationLabels;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationModel;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from TensorFlow Lite.\n+ */\n+final class TensorFlowTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    private final TextClassificationModel interpreter;\n+    private final TextClassificationDictionary dictionary;\n+    private final TextClassificationLabels labels;\n+    private final List<Loadable<?, PredictionsException>> assets;\n+    private final CountDownLatch loaded;\n+\n+    private PredictionsException loadingError;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017386b9fcea4dde2908519ac0b37a50fbf74aae"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI4MDQ4Mg==", "bodyText": "Code that is more algorithmic in nature like this is well suited for unit test coverage.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403280482", "createdAt": "2020-04-03T19:50:19Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/service/TensorFlowTextClassificationService.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.service;\n+\n+import android.content.Context;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+import com.amplifyframework.predictions.tensorflow.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.tensorflow.asset.Loadable;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationDictionary;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationLabels;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationModel;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from TensorFlow Lite.\n+ */\n+final class TensorFlowTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    private final TextClassificationModel interpreter;\n+    private final TextClassificationDictionary dictionary;\n+    private final TextClassificationLabels labels;\n+    private final List<Loadable<?, PredictionsException>> assets;\n+    private final CountDownLatch loaded;\n+\n+    private PredictionsException loadingError;\n+\n+    /**\n+     * Constructs an instance of service to perform text\n+     * sentiment interpretation using TensorFlow Lite\n+     * interpreter.\n+     * @param context the Android context\n+     */\n+    TensorFlowTextClassificationService(@NonNull Context context) {\n+        this.interpreter = new TextClassificationModel(context);\n+        this.dictionary = new TextClassificationDictionary(context);\n+        this.labels = new TextClassificationLabels(context);\n+\n+        this.assets = Arrays.asList(interpreter, dictionary, labels);\n+        this.loaded = new CountDownLatch(assets.size());\n+\n+        for (Loadable<?, PredictionsException> asset : assets) {\n+            asset.onLoaded(onLoad -> this.loaded.countDown());\n+            asset.onError(error -> this.loadingError = error);\n+        }\n+    }\n+\n+    /**\n+     * Gets the associated service key of this service for\n+     * identification.\n+     * @return the service key\n+     */\n+    @NonNull\n+    String getServiceKey() {\n+        return SERVICE_KEY;\n+    }\n+\n+    @WorkerThread\n+    synchronized void loadIfNotLoaded() {\n+        for (Loadable<?, PredictionsException> asset : assets) {\n+            asset.load();\n+        }\n+    }\n+\n+    /**\n+     * Classifies text to analyze associated sentiments.\n+     * @param text the text to classify\n+     * @param onSuccess notified when classification succeeds\n+     * @param onError notified when classification fails\n+     */\n+    void classify(\n+            @NonNull String text,\n+            @NonNull Consumer<InterpretResult> onSuccess,\n+            @NonNull Consumer<PredictionsException> onError\n+    ) {\n+        // Escape early if the initialization failed\n+        if (loadingError != null) {\n+            onError.accept(loadingError);\n+            return;\n+        }\n+\n+        // Wait for initialization to complete\n+        // TODO: encapsulate blocking logic elsewhere\n+        try {\n+            loaded.await();\n+        } catch (InterruptedException exception) {\n+            onError.accept(new PredictionsException(\n+                    \"Text classification service initialization was interrupted.\",\n+                    \"Please wait for the required assets to be fully loaded.\"\n+            ));\n+        }\n+\n+        try {\n+            final Sentiment sentiment = fetchSentiment(text);\n+            onSuccess.accept(InterpretResult.builder()\n+                    .sentiment(sentiment)\n+                    .build());\n+        } catch (PredictionsException exception) {\n+            onError.accept(exception);\n+        }\n+    }\n+\n+    private Sentiment fetchSentiment(String text) throws PredictionsException {\n+        float[][] input;\n+        float[][] output;\n+\n+        try {\n+            // Pre-process input text\n+            input = dictionary.tokenizeInputText(text);\n+            output = new float[1][labels.size()];\n+\n+            // Run inference.\n+            interpreter.run(input, output);\n+        } catch (IllegalArgumentException exception) {\n+            throw new PredictionsException(\n+                    \"TensorFlow Lite failed to make an inference.\",\n+                    exception,\n+                    \"Verify that the label size matches the output size of the model.\"\n+            );\n+        }\n+\n+        // Find the predominant sentiment\n+        Sentiment sentiment = null;\n+        for (int i = 0; i < labels.size(); i++) {\n+            SentimentType sentimentType = SentimentTypeAdapter.fromTensorFlow(labels.get(i));\n+            float confidenceScore = output[0][i] * PERCENT;\n+            if (sentiment == null || sentiment.getConfidence() < confidenceScore) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017386b9fcea4dde2908519ac0b37a50fbf74aae"}, "originalPosition": 157}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee6d387ded54dd2a102e7efa6d034f95924e6008", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/ee6d387ded54dd2a102e7efa6d034f95924e6008", "committedDate": "2020-04-05T01:25:42Z", "message": "Merge branch 'master' of https://github.com/aws-amplify/amplify-android into interpret-tf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a4b80c26a019c6b5c225dfb9e1b284d4a18d5c4", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/6a4b80c26a019c6b5c225dfb9e1b284d4a18d5c4", "committedDate": "2020-04-05T09:08:00Z", "message": "Apply Jameson's suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NzgyODA2", "url": "https://github.com/aws-amplify/amplify-android/pull/336#pullrequestreview-387782806", "createdAt": "2020-04-05T05:32:30Z", "commit": {"oid": "ee6d387ded54dd2a102e7efa6d034f95924e6008"}, "state": "DISMISSED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNVQwNTozMjozMVrOGA883Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwMToxNjoyMFrOGBFMqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY1MTgwNQ==", "bodyText": "Somewhere before here, you want to call Immutable.of(...). I'd suggest doing it before your last assignment, in the constructor.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403651805", "createdAt": "2020-04-05T05:32:31Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/TensorFlowPredictionsEscapeHatch.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow;\n+\n+import androidx.annotation.NonNull;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * An escape hatch to give low-level access to TensorFlow interpreter.\n+ */\n+public final class TensorFlowPredictionsEscapeHatch {\n+    private final Map<String, Interpreter> interpreters;\n+\n+    TensorFlowPredictionsEscapeHatch(@NonNull Map<String, Interpreter> interpreters) {\n+        this.interpreters = new HashMap<>();\n+\n+        // Only insert non-null interpreters from the map\n+        for (String service : interpreters.keySet()) {\n+            final Interpreter interpreter = interpreters.get(service);\n+            if (interpreter != null) {\n+                this.interpreters.put(service, interpreter);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Return a map of pre-trained TensorFlow Lite interpreters\n+     * used by the plugin.\n+     * @return the map of {service key -> interpreter}\n+     */\n+    public Map<String, Interpreter> getInterpreters() {\n+        return interpreters;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee6d387ded54dd2a102e7efa6d034f95924e6008"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY1MTkxOA==", "bodyText": "final ?", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403651918", "createdAt": "2020-04-05T05:33:56Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/asset/TextClassificationDictionary.java", "diffHunk": "@@ -0,0 +1,247 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.asset;\n+\n+import android.content.Context;\n+import android.content.res.AssetManager;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Action;\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Loads the list of words and their numerical indices that the\n+ * text classifier can recognize.\n+ *\n+ * The file being loaded should be in the format of:\n+ * <pre>\n+ * &#60;PAD&#62; 0\n+ * &#60;START&#62; 1\n+ * &#60;UNKNOWN&#62; 2\n+ * word 3\n+ * word 4\n+ * ...\n+ * </pre>\n+ */\n+public class TextClassificationDictionary implements Loadable<Map<String, Integer>, PredictionsException> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee6d387ded54dd2a102e7efa6d034f95924e6008"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4MzY5Mw==", "bodyText": "nit: probably V, E extends Throwable> (for both onLoaded(...) and onUnloaded(...).", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403783693", "createdAt": "2020-04-06T00:54:12Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/asset/Loadable.java", "diffHunk": "@@ -44,33 +44,29 @@\n \n     /**\n      * Sets the consumer of the loaded value to be\n-     * triggered upon load completion.\n+     * triggered upon load completion. Triggers the\n+     * error consumer upon encountering an error while\n+     * loading.\n      * @param onLoaded the consumer of the loaded value\n+     * @param onLoadError the consumer of the thrown exception\n      * @return this loadable instance for chaining\n      */\n-    Loadable<V, E> onLoaded(Consumer<V> onLoaded);\n-\n-    /**\n-     * Sets the consumer of an error which will be triggered\n-     * upon encountering an error while loading/unloading.\n-     * @param onError the consumer of the thrown exception\n-     * @return this loadable instance for chaining\n-     */\n-    Loadable<V, E> onError(Consumer<E> onError);\n+    Loadable<V, E> onLoaded(Consumer<V> onLoaded, Consumer<E> onLoadError);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a4b80c26a019c6b5c225dfb9e1b284d4a18d5c4"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NDA3OA==", "bodyText": "I wouldn't bother with the != null check, and I'd aim to have onLoadError as a required non-null field. Consider what happens otherwise, this catch statement is functionally equivalent to:\n} catch (PredictionsException exception) {\n    // Gulp!\n}\n\n(Same comment for various Loadable implementations in this PR.)", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403784078", "createdAt": "2020-04-06T00:57:13Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/asset/TextClassificationLabels.java", "diffHunk": "@@ -92,8 +91,8 @@ public synchronized void load() {\n             }\n             loaded = true;\n         } catch (PredictionsException exception) {\n-            if (onError != null) {\n-                onError.accept(exception);\n+            if (onLoadError != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a4b80c26a019c6b5c225dfb9e1b284d4a18d5c4"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NDM1OA==", "bodyText": "Yea, I won't argue with that. You could be right.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403784358", "createdAt": "2020-04-06T00:59:10Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/service/TensorFlowTextClassificationService.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.service;\n+\n+import android.content.Context;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+import com.amplifyframework.predictions.tensorflow.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.tensorflow.asset.Loadable;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationDictionary;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationLabels;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationModel;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from TensorFlow Lite.\n+ */\n+final class TensorFlowTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    private final TextClassificationModel interpreter;\n+    private final TextClassificationDictionary dictionary;\n+    private final TextClassificationLabels labels;\n+    private final List<Loadable<?, PredictionsException>> assets;\n+    private final CountDownLatch loaded;\n+\n+    private PredictionsException loadingError;\n+\n+    /**\n+     * Constructs an instance of service to perform text\n+     * sentiment interpretation using TensorFlow Lite\n+     * interpreter.\n+     * @param context the Android context\n+     */\n+    TensorFlowTextClassificationService(@NonNull Context context) {\n+        this.interpreter = new TextClassificationModel(context);\n+        this.dictionary = new TextClassificationDictionary(context);\n+        this.labels = new TextClassificationLabels(context);\n+\n+        this.assets = Arrays.asList(interpreter, dictionary, labels);\n+        this.loaded = new CountDownLatch(assets.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI3NDE5MA=="}, "originalCommit": {"oid": "017386b9fcea4dde2908519ac0b37a50fbf74aae"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NjkyMA==", "bodyText": "(TLDR, \"Okay, please write the tests soon!\")\n\nIn the recent work on Auth, one of our developers decided to split up his work into different PRs for source and test. We could potentially use that same model for this Predictions, too. But, I just want to be sure there is a concrete plan to follow up with tests next.\nIt is a best practice to build unit/component tests around the same time as the source code. The developer is most familiar with the source code at this time, and can catch the most bugs. This is also the most frugal time to write tests, for the same reason (no context switching.)\nPersonally, I get worried when I write too much source code without unit/component coverage. My memory happens to be slightly worse than the average person. Regardless, I know that I made (at least a few!) mistakes, or held some false assumptions, forgot edge cases, etc. Software is complex, and it becomes unmanageable very very quickly without guardrails. At a certain point, the complexity becomes overwhelming and I'm no longer able to see how a code base functions. That's a very scary place to be - as an engineer, as a stakeholder in a software business. Unit/component tests are one of best tools I have personally found to help define functional baselines between a project's layers of complexity.", "url": "https://github.com/aws-amplify/amplify-android/pull/336#discussion_r403786920", "createdAt": "2020-04-06T01:16:20Z", "author": {"login": "jamesonwilliams"}, "path": "aws-predictions-tensorflow/src/main/java/com/amplifyframework/predictions/tensorflow/service/TensorFlowTextClassificationService.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.tensorflow.service;\n+\n+import android.content.Context;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.WorkerThread;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.predictions.PredictionsException;\n+import com.amplifyframework.predictions.models.Sentiment;\n+import com.amplifyframework.predictions.models.SentimentType;\n+import com.amplifyframework.predictions.result.InterpretResult;\n+import com.amplifyframework.predictions.tensorflow.adapter.SentimentTypeAdapter;\n+import com.amplifyframework.predictions.tensorflow.asset.Loadable;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationDictionary;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationLabels;\n+import com.amplifyframework.predictions.tensorflow.asset.TextClassificationModel;\n+\n+import org.tensorflow.lite.Interpreter;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+\n+/**\n+ * An implementation of text classification service using\n+ * pre-trained model from TensorFlow Lite.\n+ */\n+final class TensorFlowTextClassificationService {\n+    private static final String SERVICE_KEY = \"textClassifier\";\n+\n+    // Percentage multiplier\n+    private static final int PERCENT = 100;\n+\n+    private final TextClassificationModel interpreter;\n+    private final TextClassificationDictionary dictionary;\n+    private final TextClassificationLabels labels;\n+    private final List<Loadable<?, PredictionsException>> assets;\n+    private final CountDownLatch loaded;\n+\n+    private PredictionsException loadingError;\n+\n+    /**\n+     * Constructs an instance of service to perform text\n+     * sentiment interpretation using TensorFlow Lite\n+     * interpreter.\n+     * @param context the Android context\n+     */\n+    TensorFlowTextClassificationService(@NonNull Context context) {\n+        this.interpreter = new TextClassificationModel(context);\n+        this.dictionary = new TextClassificationDictionary(context);\n+        this.labels = new TextClassificationLabels(context);\n+\n+        this.assets = Arrays.asList(interpreter, dictionary, labels);\n+        this.loaded = new CountDownLatch(assets.size());\n+\n+        for (Loadable<?, PredictionsException> asset : assets) {\n+            asset.onLoaded(onLoad -> this.loaded.countDown());\n+            asset.onError(error -> this.loadingError = error);\n+        }\n+    }\n+\n+    /**\n+     * Gets the associated service key of this service for\n+     * identification.\n+     * @return the service key\n+     */\n+    @NonNull\n+    String getServiceKey() {\n+        return SERVICE_KEY;\n+    }\n+\n+    @WorkerThread\n+    synchronized void loadIfNotLoaded() {\n+        for (Loadable<?, PredictionsException> asset : assets) {\n+            asset.load();\n+        }\n+    }\n+\n+    /**\n+     * Classifies text to analyze associated sentiments.\n+     * @param text the text to classify\n+     * @param onSuccess notified when classification succeeds\n+     * @param onError notified when classification fails\n+     */\n+    void classify(\n+            @NonNull String text,\n+            @NonNull Consumer<InterpretResult> onSuccess,\n+            @NonNull Consumer<PredictionsException> onError\n+    ) {\n+        // Escape early if the initialization failed\n+        if (loadingError != null) {\n+            onError.accept(loadingError);\n+            return;\n+        }\n+\n+        // Wait for initialization to complete\n+        // TODO: encapsulate blocking logic elsewhere\n+        try {\n+            loaded.await();\n+        } catch (InterruptedException exception) {\n+            onError.accept(new PredictionsException(\n+                    \"Text classification service initialization was interrupted.\",\n+                    \"Please wait for the required assets to be fully loaded.\"\n+            ));\n+        }\n+\n+        try {\n+            final Sentiment sentiment = fetchSentiment(text);\n+            onSuccess.accept(InterpretResult.builder()\n+                    .sentiment(sentiment)\n+                    .build());\n+        } catch (PredictionsException exception) {\n+            onError.accept(exception);\n+        }\n+    }\n+\n+    private Sentiment fetchSentiment(String text) throws PredictionsException {\n+        float[][] input;\n+        float[][] output;\n+\n+        try {\n+            // Pre-process input text\n+            input = dictionary.tokenizeInputText(text);\n+            output = new float[1][labels.size()];\n+\n+            // Run inference.\n+            interpreter.run(input, output);\n+        } catch (IllegalArgumentException exception) {\n+            throw new PredictionsException(\n+                    \"TensorFlow Lite failed to make an inference.\",\n+                    exception,\n+                    \"Verify that the label size matches the output size of the model.\"\n+            );\n+        }\n+\n+        // Find the predominant sentiment\n+        Sentiment sentiment = null;\n+        for (int i = 0; i < labels.size(); i++) {\n+            SentimentType sentimentType = SentimentTypeAdapter.fromTensorFlow(labels.get(i));\n+            float confidenceScore = output[0][i] * PERCENT;\n+            if (sentiment == null || sentiment.getConfidence() < confidenceScore) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI4MDQ4Mg=="}, "originalCommit": {"oid": "017386b9fcea4dde2908519ac0b37a50fbf74aae"}, "originalPosition": 157}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2936285c2670275fc027cbdba6b096fc4807c120", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/2936285c2670275fc027cbdba6b096fc4807c120", "committedDate": "2020-04-06T23:11:08Z", "message": "Minor edits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzExMjQ4", "url": "https://github.com/aws-amplify/amplify-android/pull/336#pullrequestreview-389311248", "createdAt": "2020-04-07T16:55:48Z", "commit": {"oid": "2936285c2670275fc027cbdba6b096fc4807c120"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2624, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}