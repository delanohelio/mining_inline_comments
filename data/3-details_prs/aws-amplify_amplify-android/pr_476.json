{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5MDMyNTMw", "number": 476, "title": "[aws-datastore] Additional logging", "bodyText": "Adds more detailed logging about the system state.\nChanges some existing logs to verbose, which is not printed in\nproduction, by default.\nGeneral strategy is to log lifecycle events at INFO (visible to\nproduction), recoverable failures as WARN. Everything else as VERBOSE.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-05-16T22:45:13Z", "url": "https://github.com/aws-amplify/amplify-android/pull/476", "merged": true, "mergeCommit": {"oid": "157d5a4fa0fe7a7008411f2437ddeb617afe01c5"}, "closed": true, "closedAt": "2020-05-17T03:52:20Z", "author": {"login": "jamesonwilliams"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABch-hiqAH2gAyNDE5MDMyNTMwOmE0N2Y1ODk4ZDhiYzVlMTM0ZDQzODk3MzkyZWJlOTkzOTk5YTc0NDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABciDBiTAH2gAyNDE5MDMyNTMwOmY3ZjdlZjA3Yjg1ZWMyM2M0M2MzNGJlZTZlMDZkZTNmMWUxNjY3ZjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a47f5898d8bc5e134d43897392ebe993999a7443", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/a47f5898d8bc5e134d43897392ebe993999a7443", "committedDate": "2020-05-16T22:36:20Z", "message": "[aws-datastore] Additional logging\n\nAdds more detailed logging about the system state.\n\nChanges some existing logs to verbose, which is not printed in\nproduction, by defualt.\n\nGeneral strategy is to log lifecycle events at INFO (visible to\nproduction), recoverable failures as WARN. Everything else as VERBOSE."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTE0MTUx", "url": "https://github.com/aws-amplify/amplify-android/pull/476#pullrequestreview-413114151", "createdAt": "2020-05-16T23:01:17Z", "commit": {"oid": "a47f5898d8bc5e134d43897392ebe993999a7443"}, "state": "APPROVED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQyMzowMToxN1rOGWdGVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQyMzoxNDoyNlrOGWdJNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODYxNQ==", "bodyText": "removed", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426198615", "createdAt": "2020-05-16T23:01:17Z", "author": {"login": "jpignata"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationOutbox.java", "diffHunk": "@@ -150,19 +147,20 @@\n      */\n     @NonNull\n     <T extends Model> Completable remove(PendingMutation<T> pendingMutation) {\n-        // defer() creation of the Completable until someone subscribe()s via remove() method.\n-        // At that time, create() a Completable that wraps a call to LocalStorageAdapter#delete(...).\n-        return Completable.defer(() -> Completable.create(subscriber -> {\n-            // Convert the PendingMutation into a Record\n-            PendingMutation.PersistentRecord record = converter.toRecord(pendingMutation);\n-            // Delete it.\n+        return Completable.defer(() -> Completable.create(subscriber ->\n             storage.delete(\n-                record,\n+                converter.toRecord(pendingMutation),\n                 StorageItemChange.Initiator.SYNC_ENGINE,\n-                ignored -> subscriber.onComplete(),\n-                subscriber::onError\n-            );\n-        }));\n+                deletionResult -> {\n+                    LOG.verbose(\"Successfully remove pending mutation from mutation outbox: \" + pendingMutation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a47f5898d8bc5e134d43897392ebe993999a7443"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODY1NQ==", "bodyText": "Can some details about the error also be logged?", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426198655", "createdAt": "2020-05-16T23:02:17Z", "author": {"login": "jpignata"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java", "diffHunk": "@@ -77,22 +76,24 @@\n             // Update the metadata for it\n             .andThen(save(metadata))\n             // Let the world know that we've done a good thing.\n-            .andThen(announceSuccessfulMerge(modelWithMetadata));\n+            .doOnComplete(() -> {\n+                announceSuccessfulMerge(modelWithMetadata);\n+                LOG.verbose(\"Remote model update was sync'd down into local storage: \" + modelWithMetadata);\n+            })\n+            .doOnError(failure ->\n+                LOG.warn(\"Failed to sync remote model into local storage: \" + modelWithMetadata)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a47f5898d8bc5e134d43897392ebe993999a7443"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODY4NA==", "bodyText": "\ud83d\udc4d Noise-ish.", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426198684", "createdAt": "2020-05-16T23:02:39Z", "author": {"login": "jpignata"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/model/ModelHelper.java", "diffHunk": "@@ -55,7 +55,7 @@ private ModelHelper() {\n             final Method fieldGetter = modelClass.getMethod(getterName);\n             return fieldGetter.invoke(model);\n         } catch (Exception exception) {\n-            LOGGER.warn(String.format(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a47f5898d8bc5e134d43897392ebe993999a7443"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODc5Mw==", "bodyText": "Since we're doing two things now, is it worth just inlining? Or is this used elsewhere? If it is, any downside to hoisting the log statement out of it?", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426198793", "createdAt": "2020-05-16T23:04:54Z", "author": {"login": "jpignata"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java", "diffHunk": "@@ -77,22 +76,24 @@\n             // Update the metadata for it\n             .andThen(save(metadata))\n             // Let the world know that we've done a good thing.\n-            .andThen(announceSuccessfulMerge(modelWithMetadata));\n+            .doOnComplete(() -> {\n+                announceSuccessfulMerge(modelWithMetadata);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a47f5898d8bc5e134d43897392ebe993999a7443"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODk3Mg==", "bodyText": "Sorry, I can't help it.", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426198972", "createdAt": "2020-05-16T23:07:44Z", "author": {"login": "jpignata"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -72,8 +71,11 @@\n      * it again later, when network conditions become favorable again.\n      */\n     void startDrainingMutationOutbox() {\n-        disposable.add(\n+        ongoingOperationsDispoable.add(\n             mutationOutbox.observe()\n+                .doOnSubscribe(disposable ->\n+                    LOG.info(\"Started processing the mutation outbox. Pending mutations will be published to cloud.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a47f5898d8bc5e134d43897392ebe993999a7443"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTAwNw==", "bodyText": "Do we usually indent string concatenation additional lines? Thought I saw that in other PRs.", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426199007", "createdAt": "2020-05-16T23:08:20Z", "author": {"login": "jpignata"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -97,10 +99,14 @@ void startDrainingMutationOutbox() {\n             .flatMapCompletable(merger::merge)\n             // Lastly, remove the item from the outbox, so we don't process it again.\n             .andThen(mutationOutbox.remove(mutationOutboxItem))\n-            .andThen(Completable.fromAction(() -> {\n-                LOG.info(\"Pending mutation was published up to Cloud: \" + mutationOutboxItem);\n+            .doOnComplete(() -> {\n+                LOG.verbose(\n+                    \"Pending mutation was published to cloud successfully, \" +\n+                    \"and removed from the mutation outbox: \" + mutationOutboxItem", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a47f5898d8bc5e134d43897392ebe993999a7443"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTA1OA==", "bodyText": "I've found this recovery suggestion dubious thus far (though I don't have a suggestion here).", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426199058", "createdAt": "2020-05-16T23:09:34Z", "author": {"login": "jpignata"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -179,24 +187,25 @@ void stopDrainingMutationOutbox() {\n      */\n     private <T extends Model> Single<ModelWithMetadata<T>> publishWithStrategy(\n             PendingMutation<T> mutation, PublicationStrategy<T> publicationStrategy) {\n-        return Single.defer(() -> Single.create(subscriber -> {\n+        T mutatedItem = mutation.getMutatedItem();\n+        String modelClassName = mutation.getClassOfMutatedItem().getSimpleName();\n+        return Single.defer(() -> Single.create(subscriber ->\n             publicationStrategy.publish(\n-                mutation.getMutatedItem(),\n+                mutatedItem,\n                 result -> {\n                     if (!result.hasErrors() && result.hasData()) {\n                         subscriber.onSuccess(result.getData());\n                         return;\n                     }\n-                    String modelName = mutation.getClassOfMutatedItem().getSimpleName();\n                     subscriber.onError(new DataStoreException(\n                         \"Mutation failed. Failed mutation = \" + mutation + \". \" +\n                             \"AppSync response contained errors = \" + result.getErrors(),\n-                        \"Verify that your AppSync endpoint is able to store \" + modelName + \" models.\"\n+                        \"Verify that your AppSync endpoint is able to store \" + modelClassName + \" models.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a47f5898d8bc5e134d43897392ebe993999a7443"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTExNw==", "bodyText": "Assume you'll update this prior to merging, just a flag to remind you.", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426199117", "createdAt": "2020-05-16T23:10:11Z", "author": {"login": "jpignata"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -35,6 +37,8 @@\n  * and {@link AppSync}.\n  */\n public final class Orchestrator {\n+    private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:aws-datastore\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a47f5898d8bc5e134d43897392ebe993999a7443"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTE4Mg==", "bodyText": "Formatting seems a little off.", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426199182", "createdAt": "2020-05-16T23:11:26Z", "author": {"login": "jpignata"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SubscriptionProcessor.java", "diffHunk": "@@ -115,14 +125,13 @@ void startSubscriptions() {\n             ));\n             latch.await(SUBSCRIPTION_START_TIMEOUT_MS, TimeUnit.MILLISECONDS);\n         })\n-        .doOnError(exception -> {\n-            LOG.warn(\"An error occurred with one of the subscriptions to the remote DataStore for \" +\n-                \"model \" + clazz.getSimpleName() + \" \" + subscriptionType.name(),\n-                exception.getCause());\n-        })\n-        .onErrorResumeNext(next -> {\n-            next.onComplete();\n-        })\n+        .doOnError(subscriptionError ->\n+            LOG.warn(String.format(Locale.US,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a47f5898d8bc5e134d43897392ebe993999a7443"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTM1MQ==", "bodyText": "Same here - can we get some detailed logged or are they logged elsewhere?", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426199351", "createdAt": "2020-05-16T23:14:26Z", "author": {"login": "jpignata"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java", "diffHunk": "@@ -161,11 +164,15 @@ private SyncTime filterOutOldSyncTimes(SyncTime lastSyncTime) throws DataStoreEx\n     private <T extends Model> Single<Iterable<ModelWithMetadata<T>>> syncModel(\n             Class<T> modelClass, SyncTime syncTime) {\n         final Long lastSyncTimeAsLong = syncTime.exists() ? syncTime.toLong() : null;\n-        return Single.create(emitter -> {\n+        return Single.<Iterable<ModelWithMetadata<T>>>create(emitter -> {\n             final Cancelable cancelable =\n                 appSync.sync(modelClass, lastSyncTimeAsLong, metadataEmitter(emitter), emitter::onError);\n             emitter.setDisposable(asDisposable(cancelable));\n-        });\n+        }).doOnSuccess(results ->\n+            LOG.verbose(\"Successfully sync'd down cloud state for model type = \" + modelClass.getSimpleName())\n+        ).doOnError(failureToSync ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a47f5898d8bc5e134d43897392ebe993999a7443"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4210af30dbc2ade550ef3f4ca163a0b5361baeed", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/4210af30dbc2ade550ef3f4ca163a0b5361baeed", "committedDate": "2020-05-17T01:30:49Z", "message": "Address PR feedback from jpignata"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTIyNjkw", "url": "https://github.com/aws-amplify/amplify-android/pull/476#pullrequestreview-413122690", "createdAt": "2020-05-17T02:46:42Z", "commit": {"oid": "4210af30dbc2ade550ef3f4ca163a0b5361baeed"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QwMjo0Njo0MlrOGWd1ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QwMjo0NzoyNlrOGWd16g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxMDc1NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final CompositeDisposable ongoingOperationsDispoable;\n          \n          \n            \n                private final CompositeDisposable ongoingOperationsDisposable;", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426210755", "createdAt": "2020-05-17T02:46:42Z", "author": {"login": "rjuliano"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -41,15 +41,14 @@\n  * {@link AppSync}. The responses to these mutations are themselves forwarded to the Merger,\n  * which may again modify the store.\n  */\n-@SuppressWarnings(\"CodeBlock2Expr\")\n final class MutationProcessor {\n     private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:aws-datastore\");\n \n     private final VersionRepository versionRepository;\n     private final Merger merger;\n     private final AppSync appSync;\n     private final MutationOutbox mutationOutbox;\n-    private final CompositeDisposable disposable;\n+    private final CompositeDisposable ongoingOperationsDispoable;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4210af30dbc2ade550ef3f4ca163a0b5361baeed"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxMDc5NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ongoingOperationsDispoable.add(\n          \n          \n            \n                    ongoingOperationsDisposable.add(", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426210794", "createdAt": "2020-05-17T02:47:26Z", "author": {"login": "rjuliano"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -72,8 +71,14 @@\n      * it again later, when network conditions become favorable again.\n      */\n     void startDrainingMutationOutbox() {\n-        disposable.add(\n+        ongoingOperationsDispoable.add(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4210af30dbc2ade550ef3f4ca163a0b5361baeed"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7f7ef07b85ec23c43c34bee6e06de3f1e1667f1", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/f7f7ef07b85ec23c43c34bee6e06de3f1e1667f1", "committedDate": "2020-05-17T03:50:54Z", "message": "Fix typo"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2499, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}