{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM3MzU2NjMz", "number": 1051, "title": "fix(aws-datastore): MutationProcessor - Resolve out-of-sync model  version", "bodyText": "Fixes #1050\nDataStore model mutation responses from AppSync are being discarded and the model _version is not being updated properly in the local store. Once that is fixed, outbox mutations for SerializedModels will crash during save because they are missing the modelSchema property.\nThe discard is happening due to code that removes outstanding mutations and code that checks for outstanding mutations before proceeding are being called in the opposite order as desired.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-12-11T20:16:39Z", "url": "https://github.com/aws-amplify/amplify-android/pull/1051", "merged": true, "mergeCommit": {"oid": "2393c0f20f4a49ad1a213121984a63171673c0eb"}, "closed": true, "closedAt": "2020-12-13T21:07:27Z", "author": {"login": "kjones"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlNArCAH2gAyNTM3MzU2NjMzOjRmNDNkNTU4ZTNkODNiMTM4OTk1MzVkYjQ3YjZlNTZjZTgxZGVkYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdl3ty9AFqTU1MDk2MDI5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4f43d558e3d83b13899535db47b6e56ce81deda7", "author": {"user": {"login": "kjones", "name": "Ken Jones"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/4f43d558e3d83b13899535db47b6e56ce81deda7", "committedDate": "2020-12-11T19:21:56Z", "message": "MutationProcessor - Fix missing schema on SerializedModel mutations."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjc1MDA3", "url": "https://github.com/aws-amplify/amplify-android/pull/1051#pullrequestreview-550675007", "createdAt": "2020-12-12T01:37:09Z", "commit": {"oid": "4f43d558e3d83b13899535db47b6e56ce81deda7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMTozNzowOVrOIEYtvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMTozNzowOVrOIEYtvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3MDE0Mw==", "bodyText": "You could also fix merger.merge() to not do anything until subscribed to.", "url": "https://github.com/aws-amplify/amplify-android/pull/1051#discussion_r541470143", "createdAt": "2020-12-12T01:37:09Z", "author": {"login": "kjones"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -134,12 +134,13 @@ private Completable drainMutationOutbox() {\n         return mutationOutbox.markInFlight(mutationOutboxItem.getMutationId())\n             // Then, put it \"into flight\"\n             .andThen(publishToNetwork(mutationOutboxItem)\n+                .map(modelWithMetadata -> ensureModelHasSchema(mutationOutboxItem, modelWithMetadata))\n                 .flatMapCompletable(modelWithMetadata ->\n                     // Once the server knows about it, it's safe to remove from the outbox.\n                     // This is done before merging, because the merger will refuse to merge\n                     // if there are outstanding mutations in the outbox.\n                     mutationOutbox.remove(mutationOutboxItem.getMutationId())\n-                        .andThen(merger.merge(modelWithMetadata))\n+                        .andThen(Completable.defer(() -> merger.merge(modelWithMetadata)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f43d558e3d83b13899535db47b6e56ce81deda7"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwOTYwMjky", "url": "https://github.com/aws-amplify/amplify-android/pull/1051#pullrequestreview-550960292", "createdAt": "2020-12-13T21:07:14Z", "commit": {"oid": "4f43d558e3d83b13899535db47b6e56ce81deda7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3368, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}