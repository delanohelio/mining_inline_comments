{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzOTQyOTEw", "number": 656, "title": "chore(datastore): Use AppSyncGraphQLRequest instead of SimpleGraphQLRequest for sync queries", "bodyText": "This is the first step towards adding pagination support in DataStore.  We need to use AppSyncGraphQLRequest instead of SimpleGraphQLRequest, so that we can use the deserialize the response as an AppSyncPaginatedResult using AppSyncPaginatedResultDeserializer.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-07-20T23:39:23Z", "url": "https://github.com/aws-amplify/amplify-android/pull/656", "merged": true, "mergeCommit": {"oid": "5608dc37c802549874f7a43a07fd48332d61da13"}, "closed": true, "closedAt": "2020-07-22T22:42:22Z", "author": {"login": "richardmcclellan"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc25RC8AH2gAyNDUzOTQyOTEwOjBmMGIxY2QxOTZmMDc5YTllNGQxMWJmYjhiNThhYjdlY2E0ODUzZjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3hbczAFqTQ1MzY4Njc0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9", "committedDate": "2020-07-20T22:21:12Z", "message": "Use AppSyncGraphQLRequest instead of SimpleGraphQLRequest for sync queries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMTQyNjQy", "url": "https://github.com/aws-amplify/amplify-android/pull/656#pullrequestreview-452142642", "createdAt": "2020-07-21T05:47:26Z", "commit": {"oid": "0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo0NzoyNlrOG0pAOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo1NDoxOFrOG0pJOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MDkzOQ==", "bodyText": "Almost certainly not a comment for this PR, but while I'm here:\nI hadn't thought about this at the time, but get, list, sync: these are really verbs from the AppSync domain, aren't they? GraphQL itself has no such pre-defined operation types. Should we aim to move the QueryType enum into aws-api-appsync?", "url": "https://github.com/aws-amplify/amplify-android/pull/656#discussion_r457850939", "createdAt": "2020-07-21T05:47:26Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/api/graphql/QueryType.java", "diffHunk": "@@ -27,7 +27,12 @@\n     /**\n      * GraphQL query list.\n      */\n-    LIST;\n+    LIST,\n+\n+    /**\n+     * GraphQL query sync.\n+     */\n+    SYNC;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MTExMg==", "bodyText": "An AWSTimestamp in the wild! How cool :-D", "url": "https://github.com/aws-amplify/amplify-android/pull/656#discussion_r457851112", "createdAt": "2020-07-21T05:47:56Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/resources/delta-sync-request-document-for-post.txt", "diffHunk": "@@ -1,6 +1,9 @@\n-query SyncPosts {\n-  syncPosts(lastSync: 123123123) {\n+query SyncPosts($lastSync: AWSTimestamp) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MTQ5Mg==", "bodyText": "nit-pick: consider wrapping on the =, not on the ..", "url": "https://github.com/aws-amplify/amplify-android/pull/656#discussion_r457851492", "createdAt": "2020-07-21T05:49:02Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java", "diffHunk": "@@ -69,10 +73,10 @@ public void validateRequestGenerationForDeltaSync() throws DataStoreException {\n     @Test\n     public void validateRequestGenerationForPagination() throws DataStoreException {\n         final String nextToken = Resources.readAsString(\"base-sync-request-next-token-value.txt\").trim();\n-        assertEquals(\n-            Resources.readAsString(\"base-sync-request-paginating-blog-owners.txt\"),\n-            AppSyncRequestFactory.buildSyncDoc(BlogOwner.class, null, nextToken)\n-        );\n+        final GraphQLRequest<Iterable<Post>> request = AppSyncRequestFactory\n+                .buildSyncRequest(BlogOwner.class, null, nextToken);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MTcyOA==", "bodyText": "Just java.util.Collections here, not the Emory repackaged one.", "url": "https://github.com/aws-amplify/amplify-android/pull/656#discussion_r457851728", "createdAt": "2020-07-21T05:49:46Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java", "diffHunk": "@@ -30,6 +31,8 @@\n \n import java.util.Map;\n \n+import edu.emory.mathcs.backport.java.util.Collections;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MjkyNA==", "bodyText": "What are the possible resolutions for T, here -- Iterable<String>, and importantly, some upcoming type of paginated result?", "url": "https://github.com/aws-amplify/amplify-android/pull/656#discussion_r457852924", "createdAt": "2020-07-21T05:53:17Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactory.java", "diffHunk": "@@ -85,70 +84,32 @@ private AppSyncRequestFactory() {}\n      * @throws DataStoreException On Failure to inspect\n      */\n     @NonNull\n-    static <T extends Model> String buildSyncDoc(\n-            @NonNull final Class<T> modelClass,\n+    static <T, M extends Model> AppSyncGraphQLRequest<T> buildSyncRequest(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MzI0MA==", "bodyText": "You have your little type factory gizmo where you can do like TypeFactory.of(Iterable.class, String.class) right? That'd remove the gson import from the top of the doc, which would be cool from an encapsulation standpoint.", "url": "https://github.com/aws-amplify/amplify-android/pull/656#discussion_r457853240", "createdAt": "2020-07-21T05:54:18Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactory.java", "diffHunk": "@@ -85,70 +84,32 @@ private AppSyncRequestFactory() {}\n      * @throws DataStoreException On Failure to inspect\n      */\n     @NonNull\n-    static <T extends Model> String buildSyncDoc(\n-            @NonNull final Class<T> modelClass,\n+    static <T, M extends Model> AppSyncGraphQLRequest<T> buildSyncRequest(\n+            @NonNull final Class<M> modelClass,\n             @Nullable final Long lastSync,\n             @SuppressWarnings(\"SameParameterValue\") @Nullable final String nextToken)\n             throws DataStoreException {\n \n-        final StringBuilder doc = new StringBuilder();\n-\n-        ModelSchema schema;\n         try {\n-            schema = ModelSchema.fromModelClass(modelClass);\n-        } catch (AmplifyException amplifyException) {\n-            throw new DataStoreException(\"Failed to get fields for model.\",\n-                    amplifyException, \"Validate your model file.\");\n-        }\n-        final String capitalizedPluralName = Casing.capitalizeFirst(schema.getPluralName());\n-\n-        int indent = 0;\n-        // Outer container, e.g. query SyncBlogPost {\n-        doc.append(\"query Sync\").append(capitalizedPluralName).append(\" {\\n\");\n-\n-        // Inner directive, e.g. syncBlogPosts(\n-        doc.append(padBy(++indent)).append(\"sync\").append(capitalizedPluralName);\n+            AppSyncGraphQLRequest.Builder builder = AppSyncGraphQLRequest.builder()\n+                    .modelClass(modelClass)\n+                    .operation(QueryType.SYNC)\n+                    .requestOptions(new DataStoreGraphQLRequestOptions())\n+                    .responseType(new TypeToken<Iterable<String>>(){}.getType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f0b1cd196f079a9e4d11bfb8b58ab7eca4853f9"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd8ba92197a811034bbda03aef4870990d12cc7f", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/bd8ba92197a811034bbda03aef4870990d12cc7f", "committedDate": "2020-07-22T20:43:14Z", "message": "PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNjg2NzQz", "url": "https://github.com/aws-amplify/amplify-android/pull/656#pullrequestreview-453686743", "createdAt": "2020-07-22T21:08:46Z", "commit": {"oid": "bd8ba92197a811034bbda03aef4870990d12cc7f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1873, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}