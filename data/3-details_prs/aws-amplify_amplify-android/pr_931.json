{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNDAzMjk3", "number": 931, "title": "chore(aws-datastore): clarify hub event names", "bodyText": "The DataStoreChannelEventName enumeration contained two generations of\nevent names:\n\nAn initial set, which included RECEIVED_FROM_CLOUD, and\nPUBLISHED_TO_CLOUD;\nA larger set, containing many more, exposing various internal\ndetails of the synchronization engine.\n\nThe later work partly duplicated the original work.\nThis commit removes the PUBLISHED_TO_CLOUD, which was duplicated by\nthe OUTBOX_MUTATION_PROCESSED,  and renames the\nRECEIVED_FROM_CLOUD event to SUBSCRIPTION_DATA_PROCESSED.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-10-27T01:29:44Z", "url": "https://github.com/aws-amplify/amplify-android/pull/931", "merged": true, "mergeCommit": {"oid": "653d8cf65c9a45944860bb88d1929f8d45bddfd6"}, "closed": true, "closedAt": "2020-10-27T17:27:02Z", "author": {"login": "jamesonwilliams"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWenFsgH2gAyNTEwNDAzMjk3OmJjMzU1MmE1NjczNzgzNjk4OTYzZGY1ZWI2Y2QwODBiNzcwNjJlZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWsE58gFqTUxNzkzNDM2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bc3552a5673783698963df5eb6cd080b77062ed1", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/bc3552a5673783698963df5eb6cd080b77062ed1", "committedDate": "2020-10-27T01:23:25Z", "message": "chore(aws-datastore): clarify hub event names\n\nThe `DataStoreChannelEventName` enumeration contained two generations of\nevent names:\n\n 1. An initial set, which included `RECEIVED_FROM_CLOUD`, and\n    `PUBLISHED_TO_CLOUD`;\n 2. A larger set, containing many more, exposing various internal\n    details of the syncrhonization engine.\n\nThe work that went in for (2) was partially duplicate of (2).\n\nThis commit *removes* the `PUBLISHED_TO_CLOUD`, which was duplicated by\nthe `OUTBOX_MUTATION_PROCESSED` event in phase (2).\n\nThis commit *renames* the `RECEIVED_FROM_CLOUD` event to\n`SUBSCRIPTION_DATA_PROCESSED`."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTI4ODA2", "url": "https://github.com/aws-amplify/amplify-android/pull/931#pullrequestreview-517928806", "createdAt": "2020-10-27T16:53:25Z", "commit": {"oid": "bc3552a5673783698963df5eb6cd080b77062ed1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTM0MzYy", "url": "https://github.com/aws-amplify/amplify-android/pull/931#pullrequestreview-517934362", "createdAt": "2020-10-27T16:58:50Z", "commit": {"oid": "bc3552a5673783698963df5eb6cd080b77062ed1"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjo1ODo1MFrOHpG03A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNzowMzoyNFrOHpHBbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg2NTUwMA==", "bodyText": "can we clarify that this is not shared across the platforms and that this is for internal use only?", "url": "https://github.com/aws-amplify/amplify-android/pull/931#discussion_r512865500", "createdAt": "2020-10-27T16:58:50Z", "author": {"login": "raphkim"}, "path": "core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java", "diffHunk": "@@ -51,14 +42,16 @@\n     NETWORK_STATUS(\"networkStatus\"),\n \n     /**\n-     * The websocket connection has been established and all the graphql subscriptions too.\n+     * The WebSocket connection has been established, in addition to all of the GraphQL\n+     * subscriptions it hosts.\n      */\n     SUBSCRIPTIONS_ESTABLISHED(\"subscriptionsEstablished\"),\n \n     /**\n-     * The DataStore as a whole (not just the sync piece) is ready. At this point all data is available.\n+     * The server sent the client data over the WebSocket subscription. The data was\n+     * successfully melded back into the local store.\n      */\n-    READY(\"ready\"),\n+    SUBSCRIPTION_DATA_PROCESSED(\"subscriptionDataProcessed\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc3552a5673783698963df5eb6cd080b77062ed1"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg2NjczMQ==", "bodyText": "wouldn't this have been a stronger assertion?", "url": "https://github.com/aws-amplify/amplify-android/pull/931#discussion_r512866731", "createdAt": "2020-10-27T17:00:29Z", "author": {"login": "raphkim"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/MutationProcessorTest.java", "diffHunk": "@@ -154,11 +153,7 @@ public void canDrainMutationOutbox() throws DataStoreException {\n         mutationProcessor.startDrainingMutationOutbox();\n \n         // Assert: the event was published\n-        List<HubEvent<?>> events = accumulator.await();\n-        assertEquals(1, events.size());\n-        @SuppressWarnings(\"unchecked\")\n-        PendingMutation<BlogOwner> mutation = (PendingMutation<BlogOwner>) events.get(0).getData();\n-        assertEquals(createTony, mutation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc3552a5673783698963df5eb6cd080b77062ed1"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg2NzM0Mg==", "bodyText": "where was this being used before?", "url": "https://github.com/aws-amplify/amplify-android/pull/931#discussion_r512867342", "createdAt": "2020-10-27T17:01:24Z", "author": {"login": "raphkim"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java", "diffHunk": "@@ -180,22 +180,4 @@\n             }\n         }, failure -> onNotPresent.call());\n     }\n-\n-    /**\n-     * The strategy to use while merging. Whether to consider the contents of the mutation\n-     * outbox before saving data locally, or, to ignore it.\n-     */\n-    enum MergeStrategy {\n-        /**\n-         * When merging, the contents of the mutation outbox will *not* be considered.\n-         */\n-        IGNORE_PENDING_MUTATIONS,\n-\n-        /**\n-         * When merging, the contents of the mutation outbox will be considered.\n-         * If there is already a pending mutation in the mutation outbox, for a model of the\n-         * same ID as the model being merged -- then the merge will *not* modify the existing model.\n-         */\n-        CONSIDER_PENDING_MUTATIONS\n-    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc3552a5673783698963df5eb6cd080b77062ed1"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg2ODcxNg==", "bodyText": "should we put all these inside TestHubEventFilters as isProcessed() and isReceived() for consistency?", "url": "https://github.com/aws-amplify/amplify-android/pull/931#discussion_r512868716", "createdAt": "2020-10-27T17:03:24Z", "author": {"login": "raphkim"}, "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/AWSDataStorePluginInstrumentedTest.java", "diffHunk": "@@ -195,34 +195,42 @@ public void syncDownFromCloudIsWorking() throws AmplifyException {\n     private <T extends Model> HubEventFilter publicationOf(T model) {\n         return event -> {\n             DataStoreChannelEventName actualEventName = DataStoreChannelEventName.fromString(event.getName());\n-            if (!DataStoreChannelEventName.PUBLISHED_TO_CLOUD.equals(actualEventName)) {\n+            if (!DataStoreChannelEventName.OUTBOX_MUTATION_PROCESSED.equals(actualEventName)) {\n                 return false;\n             }\n-            @SuppressWarnings(\"unchecked\")\n-            PendingMutation<T> pendingMutation = (PendingMutation<T>) event.getData();\n-            if (pendingMutation == null) {\n-                return false;\n-            } else if (!model.getClass().isAssignableFrom(pendingMutation.getMutatedItem().getClass())) {\n-                return false;\n-            }\n-            return model.getId().equals(pendingMutation.getMutatedItem().getId());\n+            return hasModelData(model, (OutboxMutationEvent<? extends Model>) event.getData());\n         };\n     }\n \n     private <T extends Model> HubEventFilter receiptOf(T model) {\n         return event -> {\n             DataStoreChannelEventName actualEventName = DataStoreChannelEventName.fromString(event.getName());\n-            if (!DataStoreChannelEventName.RECEIVED_FROM_CLOUD.equals(actualEventName)) {\n-                return false;\n-            }\n-            @SuppressWarnings(\"unchecked\")\n-            ModelWithMetadata<T> modelWithMetadata = (ModelWithMetadata<T>) event.getData();\n-            if (modelWithMetadata == null) {\n-                return false;\n-            } else if (!model.getClass().isAssignableFrom(modelWithMetadata.getModel().getClass())) {\n+            if (!DataStoreChannelEventName.SUBSCRIPTION_DATA_PROCESSED.equals(actualEventName)) {\n                 return false;\n             }\n-            return model.getId().equals(modelWithMetadata.getModel().getId());\n+            return hasModelData(model, (ModelWithMetadata<? extends Model>) event.getData());\n         };\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc3552a5673783698963df5eb6cd080b77062ed1"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1789, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}