{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyOTc5MTM1", "number": 858, "title": "fix(aws-datastore): make subscription timeout model count dependent", "bodyText": "Issue #, if available:\n#854\nDescription of changes:\n\nOrchestrator operations now have timeout that depends on the number of models.\nOrchestrator now throws TimeoutException if blockingAwait() times out.\nSubscription processor operations also have timeout that depends on the number of models.\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-09-25T10:24:00Z", "url": "https://github.com/aws-amplify/amplify-android/pull/858", "merged": true, "mergeCommit": {"oid": "bf26d5c2d6bef73264fa15ca8d3fb791c44aff46"}, "closed": true, "closedAt": "2020-10-06T17:37:29Z", "author": {"login": "raphkim"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMTI3CAH2gAyNDkyOTc5MTM1OjljNzIxYjU0YTU0NDA0NGNlMzhlYzJhYmEyMDNiMGViZjJiNDg5MWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPypJpAFqTUwMjYyNjg1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9c721b54a544044ce38ec2aba203b0ebf2b4891e", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/9c721b54a544044ce38ec2aba203b0ebf2b4891e", "committedDate": "2020-09-25T10:22:12Z", "message": "make orchestrator timeout model count dependent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTE0OTQ4", "url": "https://github.com/aws-amplify/amplify-android/pull/858#pullrequestreview-496514948", "createdAt": "2020-09-25T15:14:12Z", "commit": {"oid": "9c721b54a544044ce38ec2aba203b0ebf2b4891e"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a35a6302434e8014d19280f143f87a82f3f32710", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/a35a6302434e8014d19280f143f87a82f3f32710", "committedDate": "2020-09-25T17:42:17Z", "message": "add timeout extension to subscription processor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e7255e2c944c993331b21f95537e4ec96b0f3cd", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/5e7255e2c944c993331b21f95537e4ec96b0f3cd", "committedDate": "2020-09-25T18:06:24Z", "message": "adjust time unit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2Nzk0MDY4", "url": "https://github.com/aws-amplify/amplify-android/pull/858#pullrequestreview-496794068", "createdAt": "2020-09-25T20:13:06Z", "commit": {"oid": "5e7255e2c944c993331b21f95537e4ec96b0f3cd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMDoxMzowNlrOHYRLGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMDoxNDo0OVrOHYRNuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTI0MQ==", "bodyText": "Here, the timeout is being applied \"outside of\" stopApiSync(). For startApiSync(), though, the timeout is applied inside, on the syncProcessor.hydrate(). Is there any way to change this, so that the blocking timeout happens at the same abstraction level, on start/stop APIs, as opposed to on stop, and on a detail of start?", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r495209241", "createdAt": "2020-09-25T20:13:06Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -305,9 +321,12 @@ private Completable startApiSync() {\n \n     private void stopApiSyncBlocking() {\n         try {\n-            stopApiSync()\n+            boolean subscribed = stopApiSync()\n                 .subscribeOn(startStopScheduler)\n-                .blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                .blockingAwait(adjustedTimeoutSeconds, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e7255e2c944c993331b21f95537e4ec96b0f3cd"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTkxMw==", "bodyText": "I could be wrong, here, but I believe this timeout should be way shorter. Starting the subscription to the local storage should be O(ms), to complete a CPU-bound operation.\nThe sync and subscription timeouts are different. Both involve k-many network operations. They're like the opposite, basically.\nShould the storage observer timeout be more like ~2 seconds?", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r495209913", "createdAt": "2020-09-25T20:14:49Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -241,11 +251,14 @@ private Completable transitionToApiSync(Mode current) {\n     private void startObservingStorageChanges() {\n         LOG.info(\"Starting to observe local storage changes.\");\n         try {\n-            mutationOutbox.load()\n+            boolean subscribed = mutationOutbox.load()\n                 .andThen(Completable.create(emitter -> {\n                     storageObserver.startObservingStorageChanges(emitter::onComplete);\n                     currentMode.set(Mode.LOCAL_ONLY);\n-                })).blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                })).blockingAwait(adjustedTimeoutSeconds, TimeUnit.SECONDS);\n+            if (!subscribed) {\n+                throw new TimeoutException(\"Subscription timed out.\");\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e7255e2c944c993331b21f95537e4ec96b0f3cd"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2ODE5MDE5", "url": "https://github.com/aws-amplify/amplify-android/pull/858#pullrequestreview-496819019", "createdAt": "2020-09-25T20:30:51Z", "commit": {"oid": "5e7255e2c944c993331b21f95537e4ec96b0f3cd"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMDozMDo1MVrOHYRoBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMToyMDozMlrOHYTCBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxNjY0Ng==", "bodyText": "I think that sounds about right. This chunk of code reads from the sqlite db and loads any existing mutations into memory and then starts observing any new changes after that. 2 seconds should be sufficient here since it's not really dependent on the number of models", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r495216646", "createdAt": "2020-09-25T20:30:51Z", "author": {"login": "rjuliano"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -241,11 +251,14 @@ private Completable transitionToApiSync(Mode current) {\n     private void startObservingStorageChanges() {\n         LOG.info(\"Starting to observe local storage changes.\");\n         try {\n-            mutationOutbox.load()\n+            boolean subscribed = mutationOutbox.load()\n                 .andThen(Completable.create(emitter -> {\n                     storageObserver.startObservingStorageChanges(emitter::onComplete);\n                     currentMode.set(Mode.LOCAL_ONLY);\n-                })).blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                })).blockingAwait(adjustedTimeoutSeconds, TimeUnit.SECONDS);\n+            if (!subscribed) {\n+                throw new TimeoutException(\"Subscription timed out.\");\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTkxMw=="}, "originalCommit": {"oid": "5e7255e2c944c993331b21f95537e4ec96b0f3cd"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIyMTIwMQ==", "bodyText": "Probably need a different error message here since stopApiSync is not just related to subscriptions. It also stops the mutation processor.", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r495221201", "createdAt": "2020-09-25T20:42:21Z", "author": {"login": "rjuliano"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -305,9 +321,12 @@ private Completable startApiSync() {\n \n     private void stopApiSyncBlocking() {\n         try {\n-            stopApiSync()\n+            boolean subscribed = stopApiSync()\n                 .subscribeOn(startStopScheduler)\n-                .blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                .blockingAwait(adjustedTimeoutSeconds, TimeUnit.SECONDS);\n+            if (!subscribed) {\n+                throw new TimeoutException(\"Subscription timed out.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e7255e2c944c993331b21f95537e4ec96b0f3cd"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIzOTY4Ng==", "bodyText": "For the start scenario, we also have to take into account that we block inside the SubscriptionProcessor as well as on the call to syncProcessor.hydrate() as you pointed out. So if we move the timeout higher in the call hierarchy (for start), we'll have to make sure that timeout is doubled since the worst case scenario would be for both SubscriptionProcessor and SyncProcessor to take numberOfModels* TIMEOUT_SECONDS_PER_MODEL seconds", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r495239686", "createdAt": "2020-09-25T21:20:32Z", "author": {"login": "rjuliano"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -305,9 +321,12 @@ private Completable startApiSync() {\n \n     private void stopApiSyncBlocking() {\n         try {\n-            stopApiSync()\n+            boolean subscribed = stopApiSync()\n                 .subscribeOn(startStopScheduler)\n-                .blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                .blockingAwait(adjustedTimeoutSeconds, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTI0MQ=="}, "originalCommit": {"oid": "5e7255e2c944c993331b21f95537e4ec96b0f3cd"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d29b25a43e3313b44f273da6e5174347a7b594f4", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/d29b25a43e3313b44f273da6e5174347a7b594f4", "committedDate": "2020-10-01T16:26:21Z", "message": "reduce local storage observe timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "452158568309a34aab4e18e9722e77c2b4529e43", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/452158568309a34aab4e18e9722e77c2b4529e43", "committedDate": "2020-10-01T16:45:50Z", "message": "redescribe error message for stop api sync timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwODYyNDM0", "url": "https://github.com/aws-amplify/amplify-android/pull/858#pullrequestreview-500862434", "createdAt": "2020-10-02T05:05:54Z", "commit": {"oid": "452158568309a34aab4e18e9722e77c2b4529e43"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNTowNTo1NFrOHbhWjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNTowNzo0MlrOHbhXxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYyMDA0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new TimeoutException(\"Subscription timed out.\");\n          \n          \n            \n                            throw new TimeoutException(\"Timed out while preparing local-only mode.\");", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r498620047", "createdAt": "2020-10-02T05:05:54Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -241,11 +252,14 @@ private Completable transitionToApiSync(Mode current) {\n     private void startObservingStorageChanges() {\n         LOG.info(\"Starting to observe local storage changes.\");\n         try {\n-            mutationOutbox.load()\n+            boolean subscribed = mutationOutbox.load()\n                 .andThen(Completable.create(emitter -> {\n                     storageObserver.startObservingStorageChanges(emitter::onComplete);\n                     currentMode.set(Mode.LOCAL_ONLY);\n-                })).blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                })).blockingAwait(LOCAL_OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+            if (!subscribed) {\n+                throw new TimeoutException(\"Subscription timed out.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "452158568309a34aab4e18e9722e77c2b4529e43"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYyMDE1NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                throw new TimeoutException(\"Subscription timed out.\");\n          \n          \n            \n                                throw new TimeoutException(\"Timed out while performing initial model sync.\");", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r498620155", "createdAt": "2020-10-02T05:06:32Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -272,8 +286,11 @@ private Completable startApiSync() {\n \n             LOG.debug(\"About to hydrate...\");\n             try {\n-                syncProcessor.hydrate()\n-                    .blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                boolean subscribed = syncProcessor.hydrate()\n+                    .blockingAwait(adjustedTimeoutSeconds, TimeUnit.SECONDS);\n+                if (!subscribed) {\n+                    throw new TimeoutException(\"Subscription timed out.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "452158568309a34aab4e18e9722e77c2b4529e43"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYyMDI2Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new TimeoutException(\"Operation timed out.\");\n          \n          \n            \n                            throw new TimeoutException(\"Timed out while waiting for API synchronization to end.\");", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r498620262", "createdAt": "2020-10-02T05:07:03Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -305,9 +322,12 @@ private Completable startApiSync() {\n \n     private void stopApiSyncBlocking() {\n         try {\n-            stopApiSync()\n+            boolean stopped = stopApiSync()\n                 .subscribeOn(startStopScheduler)\n-                .blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                .blockingAwait(LOCAL_OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+            if (!stopped) {\n+                throw new TimeoutException(\"Operation timed out.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "452158568309a34aab4e18e9722e77c2b4529e43"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYyMDM1OQ==", "bodyText": "This is probably actually be a network op, since it has to send the stop messages on the WebSocket subscription. May want to use the long timeout for this one.", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r498620359", "createdAt": "2020-10-02T05:07:42Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -305,9 +322,12 @@ private Completable startApiSync() {\n \n     private void stopApiSyncBlocking() {\n         try {\n-            stopApiSync()\n+            boolean stopped = stopApiSync()\n                 .subscribeOn(startStopScheduler)\n-                .blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                .blockingAwait(LOCAL_OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "452158568309a34aab4e18e9722e77c2b4529e43"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4f8141f0d769ee91f8fabb1d83c5491f961a349", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/e4f8141f0d769ee91f8fabb1d83c5491f961a349", "committedDate": "2020-10-05T21:15:16Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Jameson Williams <jhwill@amazon.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "e4f8141f0d769ee91f8fabb1d83c5491f961a349", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/e4f8141f0d769ee91f8fabb1d83c5491f961a349", "committedDate": "2020-10-05T21:15:16Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Jameson Williams <jhwill@amazon.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNjI2ODUy", "url": "https://github.com/aws-amplify/amplify-android/pull/858#pullrequestreview-502626852", "createdAt": "2020-10-06T06:46:18Z", "commit": {"oid": "e4f8141f0d769ee91f8fabb1d83c5491f961a349"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1702, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}