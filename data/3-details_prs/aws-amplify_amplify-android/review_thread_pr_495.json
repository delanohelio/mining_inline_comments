{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwNTg3MDcx", "number": 495, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMTozOTo1M1rOD-LOww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMTo1OToxMVrOD-Lmzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTIyMzA3OnYy", "diffSide": "RIGHT", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutbox.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMTozOTo1M1rOGYHfMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTo0MTo1M1rOGYSEGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk0MTY4Mg==", "bodyText": "There's only ever one in our current design, but I guess in the future that should not be true.", "url": "https://github.com/aws-amplify/amplify-android/pull/495#discussion_r427941682", "createdAt": "2020-05-20T11:39:53Z", "author": {"login": "jpignata"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutbox.java", "diffHunk": "@@ -51,14 +53,16 @@\n     private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:aws-datastore\");\n \n     private final LocalStorageAdapter storage;\n-    private final Queue<PendingMutation<? extends Model>> mutationQueue;\n+    private final LinkedList<PendingMutation<? extends Model>> mutationQueue;\n+    private final Set<TimeBasedUuid> inFlightMutations;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99a40c87e1c8508582d8c44eab9f9ac5517c1322"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODExNDk2OA==", "bodyText": "Since we have serialized all of our calls into this class, I think that's true, right now, yea. Set may not have been the most appropriate choice for the current usage / behavior.", "url": "https://github.com/aws-amplify/amplify-android/pull/495#discussion_r428114968", "createdAt": "2020-05-20T15:41:53Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutbox.java", "diffHunk": "@@ -51,14 +53,16 @@\n     private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:aws-datastore\");\n \n     private final LocalStorageAdapter storage;\n-    private final Queue<PendingMutation<? extends Model>> mutationQueue;\n+    private final LinkedList<PendingMutation<? extends Model>> mutationQueue;\n+    private final Set<TimeBasedUuid> inFlightMutations;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk0MTY4Mg=="}, "originalCommit": {"oid": "99a40c87e1c8508582d8c44eab9f9ac5517c1322"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTI1MzkzOnYy", "diffSide": "RIGHT", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMTo0OTo0N1rOGYHyTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTo0ODo1M1rOGYSXoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk0NjU3NQ==", "bodyText": "Quick question - if somehow there's a failure between the server getting it and this remove from outbox step, will it gracefully ignore the duplicate transaction next time the outbox attempts to perform it?", "url": "https://github.com/aws-amplify/amplify-android/pull/495#discussion_r427946575", "createdAt": "2020-05-20T11:49:47Z", "author": {"login": "TrekSoft"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -115,13 +115,17 @@ private Completable drainMutationOutbox() {\n      * @return A Completable that emits success when the item is processed, emits failure, otherwise\n      */\n     private <T extends Model> Completable processOutboxItem(PendingMutation<T> mutationOutboxItem) {\n-        // First, publish the mutation over the network.\n-        return publishToNetwork(mutationOutboxItem)\n-            .flatMapCompletable(mutation ->\n-                // Once the server knows about it, it's safe to remove from the outbox.\n-                // This is done before merging, because the merger will refuse to merge\n-                // if there are outstanding mutations in the outbox.\n-                mutationOutbox.remove(mutationOutboxItem).andThen(merger.merge(mutation))\n+        // First, mark the item as in-flight.\n+        return mutationOutbox.markInFlight(mutationOutboxItem.getMutationId())\n+            // Then, put it \"into flight\"\n+            .andThen(publishToNetwork(mutationOutboxItem)\n+                .flatMapCompletable(modelWithMetadata ->\n+                    // Once the server knows about it, it's safe to remove from the outbox.\n+                    // This is done before merging, because the merger will refuse to merge\n+                    // if there are outstanding mutations in the outbox.\n+                    mutationOutbox.remove(mutationOutboxItem.getMutationId())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99a40c87e1c8508582d8c44eab9f9ac5517c1322"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1MjI5MA==", "bodyText": "My suspicion is if we get into this state, the outbox will be indefinitely wedged. We have some work to do here to make the outbox a) concurrent b) resilient", "url": "https://github.com/aws-amplify/amplify-android/pull/495#discussion_r427952290", "createdAt": "2020-05-20T12:00:29Z", "author": {"login": "jpignata"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -115,13 +115,17 @@ private Completable drainMutationOutbox() {\n      * @return A Completable that emits success when the item is processed, emits failure, otherwise\n      */\n     private <T extends Model> Completable processOutboxItem(PendingMutation<T> mutationOutboxItem) {\n-        // First, publish the mutation over the network.\n-        return publishToNetwork(mutationOutboxItem)\n-            .flatMapCompletable(mutation ->\n-                // Once the server knows about it, it's safe to remove from the outbox.\n-                // This is done before merging, because the merger will refuse to merge\n-                // if there are outstanding mutations in the outbox.\n-                mutationOutbox.remove(mutationOutboxItem).andThen(merger.merge(mutation))\n+        // First, mark the item as in-flight.\n+        return mutationOutbox.markInFlight(mutationOutboxItem.getMutationId())\n+            // Then, put it \"into flight\"\n+            .andThen(publishToNetwork(mutationOutboxItem)\n+                .flatMapCompletable(modelWithMetadata ->\n+                    // Once the server knows about it, it's safe to remove from the outbox.\n+                    // This is done before merging, because the merger will refuse to merge\n+                    // if there are outstanding mutations in the outbox.\n+                    mutationOutbox.remove(mutationOutboxItem.getMutationId())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk0NjU3NQ=="}, "originalCommit": {"oid": "99a40c87e1c8508582d8c44eab9f9ac5517c1322"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2MDYxNQ==", "bodyText": "I would think with the conditions on Updates and Deletes (or ID check on Create) it'd be fairly simple to avoid this being a problem if we aren't already. But yeah definitely not a launch blocker if we aren't since it's an edge case we could follow up with a fix for.", "url": "https://github.com/aws-amplify/amplify-android/pull/495#discussion_r427960615", "createdAt": "2020-05-20T12:15:51Z", "author": {"login": "TrekSoft"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -115,13 +115,17 @@ private Completable drainMutationOutbox() {\n      * @return A Completable that emits success when the item is processed, emits failure, otherwise\n      */\n     private <T extends Model> Completable processOutboxItem(PendingMutation<T> mutationOutboxItem) {\n-        // First, publish the mutation over the network.\n-        return publishToNetwork(mutationOutboxItem)\n-            .flatMapCompletable(mutation ->\n-                // Once the server knows about it, it's safe to remove from the outbox.\n-                // This is done before merging, because the merger will refuse to merge\n-                // if there are outstanding mutations in the outbox.\n-                mutationOutbox.remove(mutationOutboxItem).andThen(merger.merge(mutation))\n+        // First, mark the item as in-flight.\n+        return mutationOutbox.markInFlight(mutationOutboxItem.getMutationId())\n+            // Then, put it \"into flight\"\n+            .andThen(publishToNetwork(mutationOutboxItem)\n+                .flatMapCompletable(modelWithMetadata ->\n+                    // Once the server knows about it, it's safe to remove from the outbox.\n+                    // This is done before merging, because the merger will refuse to merge\n+                    // if there are outstanding mutations in the outbox.\n+                    mutationOutbox.remove(mutationOutboxItem.getMutationId())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk0NjU3NQ=="}, "originalCommit": {"oid": "99a40c87e1c8508582d8c44eab9f9ac5517c1322"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODExOTk2OQ==", "bodyText": "I'm afraid this will wedge things, too.\nThe likelihood of the local write failing should be very low, for what it's worth.\nThe likelihood of the network call failing is orders of magnitude higher.\nWe should come back to this.", "url": "https://github.com/aws-amplify/amplify-android/pull/495#discussion_r428119969", "createdAt": "2020-05-20T15:48:53Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -115,13 +115,17 @@ private Completable drainMutationOutbox() {\n      * @return A Completable that emits success when the item is processed, emits failure, otherwise\n      */\n     private <T extends Model> Completable processOutboxItem(PendingMutation<T> mutationOutboxItem) {\n-        // First, publish the mutation over the network.\n-        return publishToNetwork(mutationOutboxItem)\n-            .flatMapCompletable(mutation ->\n-                // Once the server knows about it, it's safe to remove from the outbox.\n-                // This is done before merging, because the merger will refuse to merge\n-                // if there are outstanding mutations in the outbox.\n-                mutationOutbox.remove(mutationOutboxItem).andThen(merger.merge(mutation))\n+        // First, mark the item as in-flight.\n+        return mutationOutbox.markInFlight(mutationOutboxItem.getMutationId())\n+            // Then, put it \"into flight\"\n+            .andThen(publishToNetwork(mutationOutboxItem)\n+                .flatMapCompletable(modelWithMetadata ->\n+                    // Once the server knows about it, it's safe to remove from the outbox.\n+                    // This is done before merging, because the merger will refuse to merge\n+                    // if there are outstanding mutations in the outbox.\n+                    mutationOutbox.remove(mutationOutboxItem.getMutationId())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk0NjU3NQ=="}, "originalCommit": {"oid": "99a40c87e1c8508582d8c44eab9f9ac5517c1322"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTI2MzMwOnYy", "diffSide": "RIGHT", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutbox.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMTo1Mjo0MlrOGYH4PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTo1ODoxNlrOGYSxnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk0ODA5Mw==", "bodyText": "Curious - for LinkedList I imagine these are identical and probably implemented using each other. What was the intent for this change for my education?", "url": "https://github.com/aws-amplify/amplify-android/pull/495#discussion_r427948093", "createdAt": "2020-05-20T11:52:42Z", "author": {"login": "jpignata"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutbox.java", "diffHunk": "@@ -229,12 +251,13 @@ private void removeFromQueue(String modelId) {\n     public Completable load() {\n         return Completable.defer(() -> Completable.create(emitter -> {\n             semaphore.acquire();\n+            inFlightMutations.clear();\n             mutationQueue.clear();\n             storage.query(PendingMutation.PersistentRecord.class,\n                 results -> {\n                     while (results.hasNext()) {\n                         try {\n-                            mutationQueue.offer(converter.fromRecord(results.next()));\n+                            mutationQueue.addLast(converter.fromRecord(results.next()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99a40c87e1c8508582d8c44eab9f9ac5517c1322"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEyNjYyMQ==", "bodyText": "Since LinkedList implements/extends a few different base types, it is actually kind of a mess. I believe these four methods all behave identically:\n\nadd()\naddLast()\nofferLast()\noffer()\n\nJava Queue itself provides the add() and offer(). The two methods differ subtly in how they communicate failure modes.\nI decided to use addLast() because its enqueuing behavior is communicated with the least ambiguity, of the four.", "url": "https://github.com/aws-amplify/amplify-android/pull/495#discussion_r428126621", "createdAt": "2020-05-20T15:58:16Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutbox.java", "diffHunk": "@@ -229,12 +251,13 @@ private void removeFromQueue(String modelId) {\n     public Completable load() {\n         return Completable.defer(() -> Completable.create(emitter -> {\n             semaphore.acquire();\n+            inFlightMutations.clear();\n             mutationQueue.clear();\n             storage.query(PendingMutation.PersistentRecord.class,\n                 results -> {\n                     while (results.hasNext()) {\n                         try {\n-                            mutationQueue.offer(converter.fromRecord(results.next()));\n+                            mutationQueue.addLast(converter.fromRecord(results.next()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk0ODA5Mw=="}, "originalCommit": {"oid": "99a40c87e1c8508582d8c44eab9f9ac5517c1322"}, "originalPosition": 145}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTI4NDYyOnYy", "diffSide": "RIGHT", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutbox.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMTo1OToxMVrOGYIFzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTo0Njo0M1rOGYSRuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1MTU2Ng==", "bodyText": "The name updateQueue is kind of right (in that many operations against a queue will change it), but I wonder if there's a more expressive name that would be more obvious to a future reader such as addOrUpdateQueueItem.", "url": "https://github.com/aws-amplify/amplify-android/pull/495#discussion_r427951566", "createdAt": "2020-05-20T11:59:11Z", "author": {"login": "jpignata"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutbox.java", "diffHunk": "@@ -188,17 +189,39 @@ private Completable unknownMutationType(PendingMutation.Type unknownType) {\n         }));\n     }\n \n+    private <T extends Model> void updateQueue(PendingMutation<T> pendingMutation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99a40c87e1c8508582d8c44eab9f9ac5517c1322"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODExODQ1Nw==", "bodyText": "Agree! \"Update the foo\" is never very descriptive. Will rephrase.", "url": "https://github.com/aws-amplify/amplify-android/pull/495#discussion_r428118457", "createdAt": "2020-05-20T15:46:43Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutbox.java", "diffHunk": "@@ -188,17 +189,39 @@ private Completable unknownMutationType(PendingMutation.Type unknownType) {\n         }));\n     }\n \n+    private <T extends Model> void updateQueue(PendingMutation<T> pendingMutation) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1MTU2Ng=="}, "originalCommit": {"oid": "99a40c87e1c8508582d8c44eab9f9ac5517c1322"}, "originalPosition": 81}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1281, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}