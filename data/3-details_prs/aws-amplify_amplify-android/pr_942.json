{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNzcwNzI2", "number": 942, "title": "feat(datastore) swallow unauthorized errors for subscriptions", "bodyText": "When a user is not authorized to read a model, an Unauthorized error is returned when trying to start a subscription.   This error is emitted on the SubscriptionProcessor buffer, which results in all subscriptions being cancelled.  To allow these users to still use DataStore, with a subset of models, this PR modifies this behavior to swallow Unauthorized errors before they reach the buffer.   Other types of errors will still be emitted and result in the same behavior.\nSpecific changes:\n\nAdded a subclass of DataStoreException, DataStoreException.GraphQLResponseException, so we can hold the List<GraphQLResponse.Error> objects from the response.\nWhen the subscription's onFailure callback is called, emit it to the buffer iff it's not an Unauthorized exception.\nUpdated SubscriptionEndpoint to stop waiting for a \"start_ack\" message after receiving an \"error\", and ensured that the onStart() callback is not called.  Without this change, the timeout after not getting a \"start_ack\" was blowing everything up.\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-10-30T05:40:45Z", "url": "https://github.com/aws-amplify/amplify-android/pull/942", "merged": true, "mergeCommit": {"oid": "08063881af772a7a569b8ee92fd84c1a2713ba54"}, "closed": true, "closedAt": "2020-10-30T18:56:15Z", "author": {"login": "richardmcclellan"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXgAprAH2gAyNTEyNzcwNzI2OmM4MWM5MDRiZWFiYzBiMmU4MmM4MjNjNDBiZTE3NWI3MjEyMWFkMzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXrVUlABqjM5NDI2NDk1ODc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c81c904beabc0b2e82c823c40be175b72121ad32", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/c81c904beabc0b2e82c823c40be175b72121ad32", "committedDate": "2020-10-30T05:35:10Z", "message": "feat(datastore) subscription processor should not fail due to an Unauthorized error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTAyNzI1", "url": "https://github.com/aws-amplify/amplify-android/pull/942#pullrequestreview-520902725", "createdAt": "2020-10-30T17:48:11Z", "commit": {"oid": "c81c904beabc0b2e82c823c40be175b72121ad32"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNzo0ODoxMlrOHrZ_hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNzo1MToxMVrOHraGag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI3NjY3OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return errors;\n          \n          \n            \n                        return Immutable.of(errors);", "url": "https://github.com/aws-amplify/amplify-android/pull/942#discussion_r515276679", "createdAt": "2020-10-30T17:48:12Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/datastore/DataStoreException.java", "diffHunk": "@@ -51,4 +56,61 @@ public DataStoreException(\n     ) {\n         super(message, recoverySuggestion);\n     }\n+\n+    /**\n+     * Exception thrown by DataStore category plugins used to represent a GraphQLResponse containing errors.\n+     */\n+    public static final class GraphQLResponseException extends DataStoreException {\n+        private static final long serialVersionUID = 1L;\n+\n+        private final List<GraphQLResponse.Error> errors;\n+\n+        /**\n+         * Constructs a new exception using the provided message and list of errors.\n+         * @param message Explains the reason for the exception\n+         * @param errors List of errors from GraphQLResponse\n+         */\n+        public GraphQLResponseException(String message, @NonNull List<GraphQLResponse.Error> errors) {\n+            super(message, \"See attached list of GraphQLResponse.Error objects.\");\n+            this.errors = Objects.requireNonNull(errors);\n+        }\n+\n+        /**\n+         * Returns the errors.\n+         * @return the errors.\n+         */\n+        @NonNull\n+        public List<GraphQLResponse.Error> getErrors() {\n+            return errors;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c81c904beabc0b2e82c823c40be175b72121ad32"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI3ODQ0Mg==", "bodyText": "If we consume the InterruptedException will we leave the thread in an indeterminate state? Will the thread hang?", "url": "https://github.com/aws-amplify/amplify-android/pull/942#discussion_r515278442", "createdAt": "2020-10-30T17:51:11Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -317,27 +325,35 @@ private String buildConnectionRequestUrl() throws ApiException {\n             this.responseType = responseType;\n             this.subscriptionReadyAcknowledgment = new CountDownLatch(1);\n             this.subscriptionCompletionAcknowledgement = new CountDownLatch(1);\n+            this.failed = false;\n         }\n \n         void acknowledgeSubscriptionReady() {\n             subscriptionReadyAcknowledgment.countDown();\n         }\n \n+        void acknowledgeSubscriptionFailure() {\n+            failed = true;\n+            subscriptionReadyAcknowledgment.countDown();\n+        }\n+\n         boolean awaitSubscriptionReady() {\n             try {\n                 if (!subscriptionReadyAcknowledgment.await(ACKNOWLEDGEMENT_TIMEOUT, TimeUnit.SECONDS)) {\n                     dispatchError(new ApiException(\n-                        \"Subscription not acknowledged.\",\n+                        \"Timed out waiting for subscription start_ack.\",\n                         AmplifyException.TODO_RECOVERY_SUGGESTION\n                     ));\n                     return false;\n+                } else if (failed) {\n+                    // An error was already dispatched at the time of failure, so don't dispatch a second one.\n+                    return false;\n                 }\n             } catch (InterruptedException interruptedException) {\n-                dispatchError(new ApiException(\n-                    \"Failure awaiting subscription acknowledgement.\",\n-                    interruptedException,\n-                    AmplifyException.TODO_RECOVERY_SUGGESTION\n-                ));\n+                // Triggered when the Future created in SubscriptionOperation is cancelled, which happens when the\n+                // subscription Observable is disposed, which happens when a SUBSCRIPTION_ERROR occurs.  Don't dispatch\n+                // any error because the caller has likely already been disposed.\n+                LOG.warn(\"Thread interrupted awaiting subscription acknowledgement.\", interruptedException);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c81c904beabc0b2e82c823c40be175b72121ad32"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a5302f3eba1366634af7bd8bf5f6c3c5a5f5dc0", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/3a5302f3eba1366634af7bd8bf5f6c3c5a5f5dc0", "committedDate": "2020-10-30T18:46:34Z", "message": "Update core/src/main/java/com/amplifyframework/datastore/DataStoreException.java\n\nCo-authored-by: Jameson Williams <jhwill@amazon.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "3a5302f3eba1366634af7bd8bf5f6c3c5a5f5dc0", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/3a5302f3eba1366634af7bd8bf5f6c3c5a5f5dc0", "committedDate": "2020-10-30T18:46:34Z", "message": "Update core/src/main/java/com/amplifyframework/datastore/DataStoreException.java\n\nCo-authored-by: Jameson Williams <jhwill@amazon.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1794, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}