{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMDE4ODQ0", "number": 497, "title": "Auth Integration for Storage", "bodyText": "Replaces Storage's direct dependence on AWSMobileClient with a provider which gets an instance of that from the Auth plugin.\nFor now the integration tests still directly rely on AWSMobileClient - cleared this with Jameson as being something we can address after GA.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-05-20T21:04:08Z", "url": "https://github.com/aws-amplify/amplify-android/pull/497", "merged": true, "mergeCommit": {"oid": "51f90581cdce2ff343436427633dca4cefef4fc3"}, "closed": true, "closedAt": "2020-05-21T00:09:21Z", "author": {"login": "TrekSoft"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchojF9gH2gAyNDIxMDE4ODQ0OmExMTM4ZjlmZjRkNDA2YTZkNDc2OGRjYWIwNTY0ZTE4ODU3YmExOTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjSHNkAH2gAyNDIxMDE4ODQ0OjVhNTBkOGRkZTVlMzgwOTZiYWFmM2Q3NWVkZjRmOGNkNDY2NjFjMmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a1138f9ff4d406a6d4768dcab0564e18857ba192", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/a1138f9ff4d406a6d4768dcab0564e18857ba192", "committedDate": "2020-05-15T21:00:07Z", "message": "Adds Options Object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92260c39c69746cf9af8b2a5efcf1f39d927ee45", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/92260c39c69746cf9af8b2a5efcf1f39d927ee45", "committedDate": "2020-05-19T00:22:15Z", "message": "Adds signInWithWebUI and signInWithSocialWebUI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a374cd97a4853d96f06aca4862e9ce5ec65fbff0", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/a374cd97a4853d96f06aca4862e9ce5ec65fbff0", "committedDate": "2020-05-19T00:38:33Z", "message": "Merge remote-tracking branch 'origin/master' into ddaudeli/HostedUI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3ddc7d337a38d317f364c9c9a795908daa74b1f", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/a3ddc7d337a38d317f364c9c9a795908daa74b1f", "committedDate": "2020-05-20T19:56:51Z", "message": "Integrates Auth Category in Storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05df99a5d00d6f5c7c816d2f503e70b3e9395d7b", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/05df99a5d00d6f5c7c816d2f503e70b3e9395d7b", "committedDate": "2020-05-20T20:54:07Z", "message": "Removes last instance of AWSMobileClient directly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37fd7172c29d186e72e10164f55b70a0f07d3d4e", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/37fd7172c29d186e72e10164f55b70a0f07d3d4e", "committedDate": "2020-05-20T20:58:45Z", "message": "Merge remote-tracking branch 'origin/master' into ddaudeli/AuthIntegration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c", "committedDate": "2020-05-20T21:03:01Z", "message": "Fixes comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NzE0OTQx", "url": "https://github.com/aws-amplify/amplify-android/pull/497#pullrequestreview-415714941", "createdAt": "2020-05-20T21:07:57Z", "commit": {"oid": "ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTowNzo1N1rOGYd2QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMToxNjo0OFrOGYeGTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwODAzMw==", "bodyText": "extra line", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428308033", "createdAt": "2020-05-20T21:07:57Z", "author": {"login": "raphkim"}, "path": "aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/AWSAuthProvider.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.storage.s3;\n+\n+import com.amplifyframework.storage.StorageException;\n+\n+import com.amazonaws.auth.AWSCredentialsProvider;\n+\n+/**\n+ * Internal interface for providing AWS specific Auth information.\n+ */\n+public interface AWSAuthProvider {\n+    /**\n+     * Get the identity ID of the currently logged in user if they are registered in identity pools.\n+     * @return the identity ID of the currently logged in user.\n+     * @throws StorageException  If the proper Auth plugin isn't added or identity id is unavailable\n+     */\n+    String getIdentityId() throws StorageException;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwOTM1MQ==", "bodyText": "Nit: why do both plugin and service need the reference to the auth provider? If the service is going to have access to it, then the plugin shouldn't need it right?\nAlso, you should keep only one reference of MobileClientAWSAuthProvider() rather than instantiating two separately.", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428309351", "createdAt": "2020-05-20T21:10:43Z", "author": {"login": "raphkim"}, "path": "aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/AWSS3StoragePlugin.java", "diffHunk": "@@ -82,22 +80,27 @@\n      * Constructs the AWS S3 Storage Plugin initializing the executor service.\n      */\n     public AWSS3StoragePlugin() {\n-        this(\n-            (context, region, bucket) ->\n-                    new AWSS3StorageService(context, region, bucket, false),\n-            () -> AWSMobileClient.getInstance().getIdentityId()\n-        );\n+        this((context, region, bucket) ->\n+                new AWSS3StorageService(context, region, bucket, new MobileClientAWSAuthProvider(), false),\n+                new MobileClientAWSAuthProvider());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxMjE0MA==", "bodyText": "Nit: AWSMobileClientAuthProvider instead?", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428312140", "createdAt": "2020-05-20T21:16:48Z", "author": {"login": "raphkim"}, "path": "aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/MobileClientAWSAuthProvider.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.storage.s3;\n+\n+import com.amplifyframework.core.Amplify;\n+import com.amplifyframework.storage.StorageException;\n+\n+import com.amazonaws.auth.AWSCredentialsProvider;\n+import com.amazonaws.mobile.client.AWSMobileClient;\n+\n+/**\n+ * Static utility class internal to the plugin to interface with Auth.\n+ */\n+public final class MobileClientAWSAuthProvider implements AWSAuthProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NzMxNDA1", "url": "https://github.com/aws-amplify/amplify-android/pull/497#pullrequestreview-415731405", "createdAt": "2020-05-20T21:35:07Z", "commit": {"oid": "ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTozNTowOFrOGYeoaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTozNzoxOFrOGYesZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMDg3Mg==", "bodyText": "I think the Identity ID is actually a Cognito thing, not an AWS thing. So, your interface maybe should be called CognitoIdentityProvider.", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428320872", "createdAt": "2020-05-20T21:35:08Z", "author": {"login": "jamesonwilliams"}, "path": "aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/AWSAuthProvider.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.storage.s3;\n+\n+import com.amplifyframework.storage.StorageException;\n+\n+import com.amazonaws.auth.AWSCredentialsProvider;\n+\n+/**\n+ * Internal interface for providing AWS specific Auth information.\n+ */\n+public interface AWSAuthProvider {\n+    /**\n+     * Get the identity ID of the currently logged in user if they are registered in identity pools.\n+     * @return the identity ID of the currently logged in user.\n+     * @throws StorageException  If the proper Auth plugin isn't added or identity id is unavailable\n+     */\n+    String getIdentityId() throws StorageException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMTg5NA==", "bodyText": "Can you scope this to only the new auth lines that throw it?\nfinal String maybeVar;\ntry {\n   maybeVar = getIt();\n} catch (StorageException varNotAvailable) {\n   blowUp();\n}\n// maybeVar is now a legit var.", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428321894", "createdAt": "2020-05-20T21:37:18Z", "author": {"login": "jamesonwilliams"}, "path": "aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/operation/AWSS3StorageDownloadFileOperation.java", "diffHunk": "@@ -76,11 +81,20 @@ public void start() {\n             return;\n         }\n \n-        String serviceKey = S3Keys.createServiceKey(\n-                getRequest().getAccessLevel(),\n-                getRequest().getTargetIdentityId(),\n-                getRequest().getKey()\n-        );\n+        String serviceKey;\n+\n+        try {\n+            serviceKey = S3Keys.createServiceKey(\n+                    getRequest().getAccessLevel(),\n+                    getRequest().getTargetIdentityId() != null\n+                            ? getRequest().getTargetIdentityId()\n+                            : awsAuthProvider.getIdentityId(),\n+                    getRequest().getKey()\n+            );\n+        } catch (StorageException exception) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35d6818d931a5730a2d079d26992249ec8e25863", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/35d6818d931a5730a2d079d26992249ec8e25863", "committedDate": "2020-05-20T23:58:26Z", "message": "Addresses PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a50d8dde5e38096baaf3d75edf4f8cd46661c2d", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/5a50d8dde5e38096baaf3d75edf4f8cd46661c2d", "committedDate": "2020-05-20T23:59:36Z", "message": "More PR feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2528, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}