{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4NDQ0NDIy", "number": 251, "title": "[DataStore] Use Hub notifications to communicate Sync Engine events", "bodyText": "Previously, DataStore instrumentation tests were using Sleep to wait an\narbitrary amount of time for synchronization tasks to complete. See the\nnew statement in Sleep.java about why waiting for a random amount of\ntime is a bad strategy for synchronization. Instead, DataStore\nsynchronization events are now published to the Hub.\nSome test utilities are added to help await Hub events, in tests.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-01-29T09:05:53Z", "url": "https://github.com/aws-amplify/amplify-android/pull/251", "merged": true, "mergeCommit": {"oid": "9029c78c59559977565c5b5aa726e423493a4314"}, "closed": true, "closedAt": "2020-02-03T21:45:33Z", "author": {"login": "jamesonwilliams"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_CHHAAH2gAyMzY4NDQ0NDIyOjZmNjA2NWUwNTc4OTgzOGNkM2RhNDU1MDQ3YTA1ZmMwMGZiOThjNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_e4ESgFqTM1MTA0NjMxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/6f6065e05789838cd3da455047a05fc00fb98c77", "committedDate": "2020-01-29T08:59:44Z", "message": "[DataStore] Use Hub notifications to communicate Sync Engine events\n\nPreviously, DataStore instrumentation tests were using Sleep to wait an\narbitrary amount of time for synchronization tasks to complete. See the\nnew statement in Sleep.java about why waiting for a random amount of\ntime is a bad strategy for synchronization. Instead, DataStore\nsynchronization events are now published to the Hub.\n\nSome test utilities are added to help await Hub events, in tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNTIyNTU4", "url": "https://github.com/aws-amplify/amplify-android/pull/251#pullrequestreview-350522558", "createdAt": "2020-01-30T00:46:13Z", "commit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwMDo0NjoxNFrOFjcXsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwMDo0NjoxNFrOFjcXsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcwOTI5OQ==", "bodyText": "What's a Charley model?", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372709299", "createdAt": "2020-01-30T00:46:14Z", "author": {"login": "undefobj"}, "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/AWSDataStorePluginInstrumentedTest.java", "diffHunk": "@@ -91,8 +116,8 @@ public void blogOwnerSavedIntoDataStoreIsThenQueriableInRemoteAppSyncApi() throw\n             .build();\n         dataStore.save(localCharley);\n \n-        // Wait a bit. TODO: this is lame; how to tell deterministically when sync engine has sync'd?\n-        Sleep.milliseconds(NETWORK_OP_TIMEOUT_MS + DATA_STORE_OP_TIMEOUT_MS);\n+        // Wait for a Hub event telling us that our Charley model got published to the cloud.\n+        outboundModelEventAccumulator.takeOne();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNTI0NDI1", "url": "https://github.com/aws-amplify/amplify-android/pull/251#pullrequestreview-350524425", "createdAt": "2020-01-30T00:52:25Z", "commit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwMDo1MjoyNVrOFjcdfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwMDo1MjoyNVrOFjcdfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMDc4Mw==", "bodyText": "One thought here is do we want to have this on a channel for DataStore or API? We've already seen customers asking about using the API category and DataStore together, so there might be merit to having everything going over the API channel for events from AppSync. OTOH we could always publish to both or switch it later. Food for thought.", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372710783", "createdAt": "2020-01-30T00:52:25Z", "author": {"login": "undefobj"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/network/SyncEngine.java", "diffHunk": "@@ -137,6 +140,11 @@ private void startModelSubscriptions() {\n                         AmplifyException.TODO_RECOVERY_SUGGESTION\n                     );\n             }\n+\n+            // Notify Hub that we just updated the local storage.\n+            HubEvent<? extends Model> receivedFromCloudEvent =\n+                HubEvent.create(DataStoreChannelEventName.RECEIVED_FROM_CLOUD, mutation.model());\n+            Amplify.Hub.publish(HubChannel.DATASTORE, receivedFromCloudEvent);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNTI0Nzkx", "url": "https://github.com/aws-amplify/amplify-android/pull/251#pullrequestreview-350524791", "createdAt": "2020-01-30T00:53:43Z", "commit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwMDo1Mzo0M1rOFjcevg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwMDo1Mzo0M1rOFjcevg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMTEwMg==", "bodyText": "Is this just for local debugging and should we remove?", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372711102", "createdAt": "2020-01-30T00:53:43Z", "author": {"login": "undefobj"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/network/SyncEngine.java", "diffHunk": "@@ -151,7 +159,12 @@ private void startDrainingChangeJournal() {\n                 .flatMapSingle(this::publishToNetwork)\n                 .flatMapSingle(storageItemChangeJournal::remove)\n                 .subscribe(\n-                    processedChange -> LOG.info(\"Change processed successfully! \" + processedChange),\n+                    processedChange -> {\n+                        LOG.info(\"Change processed successfully! \" + processedChange);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNTI1MjAx", "url": "https://github.com/aws-amplify/amplify-android/pull/251#pullrequestreview-350525201", "createdAt": "2020-01-30T00:55:05Z", "commit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwMDo1NTowNlrOFjcgNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwMDo1NTowNlrOFjcgNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMTQ3Ng==", "bodyText": "I like this but do we have a similar structure on iOS that we could align with names? @palpatim @drochetti", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372711476", "createdAt": "2020-01-30T00:55:06Z", "author": {"login": "undefobj"}, "path": "core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.amplifyframework.hub.HubCategory;\n+import com.amplifyframework.hub.HubChannel;\n+import com.amplifyframework.hub.HubEvent;\n+\n+import java.util.Objects;\n+\n+/**\n+ * An enumeration of the names of events relating the the {@link DataStoreCategory},\n+ * that are published via {@link HubCategory#publish(HubChannel, HubEvent)} on the\n+ * {@link HubChannel#DATASTORE} channel.\n+ */\n+public enum DataStoreChannelEventName {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNTI1OTcz", "url": "https://github.com/aws-amplify/amplify-android/pull/251#pullrequestreview-350525973", "createdAt": "2020-01-30T00:57:42Z", "commit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwMDo1Nzo0MlrOFjcijw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwMDo1Nzo0MlrOFjcijw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMjA3OQ==", "bodyText": "Another thing that we are looking at is \"local only models\" which do not get sync'd to the cloud. A few customers have been asking about this and @drochetti and Manuel are doing a design. In that case we might want to still publish to hub for state management in your app, so it's worth keeping that in mind for the list of possible events - e.g. PUBLISHED_TO_LOCAL", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372712079", "createdAt": "2020-01-30T00:57:42Z", "author": {"login": "undefobj"}, "path": "core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.amplifyframework.hub.HubCategory;\n+import com.amplifyframework.hub.HubChannel;\n+import com.amplifyframework.hub.HubEvent;\n+\n+import java.util.Objects;\n+\n+/**\n+ * An enumeration of the names of events relating the the {@link DataStoreCategory},\n+ * that are published via {@link HubCategory#publish(HubChannel, HubEvent)} on the\n+ * {@link HubChannel#DATASTORE} channel.\n+ */\n+public enum DataStoreChannelEventName {\n+    /**\n+     * An item in the local storage has been published to the cloud.\n+     * An event that uses this value for {@link HubEvent#getName()} will contain a model object\n+     * in the {@link HubEvent#getData()}.\n+     */\n+    PUBLISHED_TO_CLOUD(\"published_to_cloud\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNTI2OTMz", "url": "https://github.com/aws-amplify/amplify-android/pull/251#pullrequestreview-350526933", "createdAt": "2020-01-30T01:00:49Z", "commit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwMTowMDo0OVrOFjclsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwMTowMDo0OVrOFjclsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMjg4Mw==", "bodyText": "I'm not sure if we ever got the filter implemented fully in Hub on Android, just an FYI", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372712883", "createdAt": "2020-01-30T01:00:49Z", "author": {"login": "undefobj"}, "path": "testutils/src/main/java/com/amplifyframework/testutils/HubAccumulator.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.testutils;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.amplifyframework.core.Amplify;\n+import com.amplifyframework.hub.HubChannel;\n+import com.amplifyframework.hub.HubEvent;\n+import com.amplifyframework.hub.HubEventFilter;\n+import com.amplifyframework.hub.HubEventFilters;\n+import com.amplifyframework.hub.SubscriptionToken;\n+\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CountDownLatch;\n+\n+/**\n+ * Accumulates {@link HubEvent}s received on a {@link HubChannel}, into an in-memory\n+ * buffer. These may be queried by tests in a synchronous way to check if they have arrived.\n+ */\n+@SuppressWarnings({\"unused\", \"UnusedReturnValue\"})\n+public final class HubAccumulator {\n+    private final HubChannel channel;\n+    private final HubEventFilter filter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNTI4MTI3", "url": "https://github.com/aws-amplify/amplify-android/pull/251#pullrequestreview-350528127", "createdAt": "2020-01-30T01:04:47Z", "commit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMDQ2MzE3", "url": "https://github.com/aws-amplify/amplify-android/pull/251#pullrequestreview-351046317", "createdAt": "2020-01-30T18:30:33Z", "commit": {"oid": "6f6065e05789838cd3da455047a05fc00fb98c77"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2813, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}