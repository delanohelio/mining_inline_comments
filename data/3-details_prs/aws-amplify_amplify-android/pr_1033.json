{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0ODA2NjE3", "number": 1033, "title": "fix(aws-datastore): deleting nonexistent model instance no longer fails", "bodyText": "Description of changes:\nSQLiteStorageAdapter now checks if item exists before attempting delete. If not, then operation \"succeeds\" and returns a dummy item change instance, but does not publish any change.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-12-09T00:08:34Z", "url": "https://github.com/aws-amplify/amplify-android/pull/1033", "merged": true, "mergeCommit": {"oid": "017bacb6e4af1e4eb6164f23339f4d6d559ece5a"}, "closed": true, "closedAt": "2020-12-09T00:36:56Z", "author": {"login": "raphkim"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkTQZggH2gAyNTM0ODA2NjE3OjgzZjgxYjA1ODhkMDIxNDMzMWU3OWNkZDg1NGMwMzhmYjQyMjlmNTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkTed5gFqTU0Nzc0MTM3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "83f81b0588d0214331e79cdd854c038fb4229f56", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/83f81b0588d0214331e79cdd854c038fb4229f56", "committedDate": "2020-12-09T00:04:37Z", "message": "no longer fail on attempting to delete nonexistent model"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "936037e71df30edeb70863059ff6ee946b08fdcb", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/936037e71df30edeb70863059ff6ee946b08fdcb", "committedDate": "2020-12-09T00:04:37Z", "message": "add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fcb0524433352b7b6735ec34e27632192e7202c", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/9fcb0524433352b7b6735ec34e27632192e7202c", "committedDate": "2020-12-09T00:08:54Z", "message": "minor whitespace fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NzM4MTA3", "url": "https://github.com/aws-amplify/amplify-android/pull/1033#pullrequestreview-547738107", "createdAt": "2020-12-09T00:11:44Z", "commit": {"oid": "9fcb0524433352b7b6735ec34e27632192e7202c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwMDoxMTo0NFrOIB8K6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwMDoxMTo0NFrOIB8K6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkwNTMyMg==", "bodyText": "Much better error message here!", "url": "https://github.com/aws-amplify/amplify-android/pull/1033#discussion_r538905322", "createdAt": "2020-12-09T00:11:44Z", "author": {"login": "richardmcclellan"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/sqlite/SQLiteStorageAdapter.java", "diffHunk": "@@ -499,22 +513,18 @@ public void query(\n                     return;\n                 }\n \n-                DataStoreException problem = null;\n                 synchronized (sqlCommand.getCompiledSqlStatement()) {\n                     final SQLiteStatement compiledSqlStatement = sqlCommand.getCompiledSqlStatement();\n                     compiledSqlStatement.clearBindings();\n                     bindStatementToValues(sqlCommand, null);\n                     // executeUpdateDelete returns the number of rows affected.\n                     final int rowsDeleted = compiledSqlStatement.executeUpdateDelete();\n-                    if (rowsDeleted != 1) {\n-                        problem = new DataStoreException(\n-                            \"Wanted to delete one row, but deleted \" + rowsDeleted + \" rows.\",\n-                            \"This is likely a bug. Please report to AWS.\"\n-                        );\n-                    }\n                     compiledSqlStatement.clearBindings();\n-                    if (problem != null) {\n-                        throw problem;\n+                    if (rowsDeleted == 0) {\n+                        throw new DataStoreException(\n+                            \"Failed to meet condition. Model was not deleted.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fcb0524433352b7b6735ec34e27632192e7202c"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NzM4Njkw", "url": "https://github.com/aws-amplify/amplify-android/pull/1033#pullrequestreview-547738690", "createdAt": "2020-12-09T00:13:14Z", "commit": {"oid": "9fcb0524433352b7b6735ec34e27632192e7202c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NzQxMTkz", "url": "https://github.com/aws-amplify/amplify-android/pull/1033#pullrequestreview-547741193", "createdAt": "2020-12-09T00:19:35Z", "commit": {"oid": "9fcb0524433352b7b6735ec34e27632192e7202c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwMDoxOTozNlrOIB8W9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwMDoxOTozNlrOIB8W9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkwODQwNw==", "bodyText": "Two questions here:\nDoes this mean we perform two operations on SQL? A lookup and the a delete? Performance wise that\u2019s probably okay for our delete API. Might have implications for atomicity of the operation.\nSecond more important - should we fire an event on the observe method here? Would the sync engine care about observing this case?", "url": "https://github.com/aws-amplify/amplify-android/pull/1033#discussion_r538908407", "createdAt": "2020-12-09T00:19:36Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/sqlite/SQLiteStorageAdapter.java", "diffHunk": "@@ -481,6 +481,20 @@ public void query(\n                 final SQLiteTable sqliteTable = SQLiteTable.fromSchema(modelSchema);\n                 final String primaryKeyName = sqliteTable.getPrimaryKeyColumnName();\n \n+                if (!dataExistsInSQLiteTable(sqliteTable.getName(), primaryKeyName, item.getId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fcb0524433352b7b6735ec34e27632192e7202c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NzQxMzc5", "url": "https://github.com/aws-amplify/amplify-android/pull/1033#pullrequestreview-547741379", "createdAt": "2020-12-09T00:19:59Z", "commit": {"oid": "9fcb0524433352b7b6735ec34e27632192e7202c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3353, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}