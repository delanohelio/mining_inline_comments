{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5OTI2MDkz", "number": 1014, "title": "fix(aws-datastore): idempotent deletions from merger", "bodyText": "When deletions are merged to the local store, the storage adapter might\nthrow an error, if there's nothing left to delete.\nThe existing code tries to work around this by first checking if there\nis a matching instance before attempting to delete it.\nInstead, we will swallow deletion failures and log a verbose message.\nResolves: #1011\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-12-01T02:18:23Z", "url": "https://github.com/aws-amplify/amplify-android/pull/1014", "merged": true, "mergeCommit": {"oid": "da10afb167e10a77df7ed344d4e01eefebf73ac4"}, "closed": true, "closedAt": "2020-12-01T15:44:14Z", "author": {"login": "jamesonwilliams"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhwUEbAH2gAyNTI5OTI2MDkzOmQxYmFjYWUyODc4NDNlNDhhNWVlYTkyMjE4NWZhYjgyMTRhMjIxMDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh70PqAFqTU0MjAyNjQ0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d1bacae287843e48a5eea922185fab8214a22109", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/d1bacae287843e48a5eea922185fab8214a22109", "committedDate": "2020-12-01T02:14:06Z", "message": "fix(aws-datastore): idempotent deletions from merger\n\nWhen deletions are merged to the local store, the storage adapter might\nthrow an error, if there's nothing left to delete.\n\nThe existing code tries to work around this by first checking if there\nis a matching instance before attempting to delete it.\n\nInstead, we will swallow deletion failures and log a verbose message.\n\nResolves: https://github.com/aws-amplify/amplify-android/issues/1011"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNDQ2NDMz", "url": "https://github.com/aws-amplify/amplify-android/pull/1014#pullrequestreview-541446433", "createdAt": "2020-12-01T02:37:01Z", "commit": {"oid": "d1bacae287843e48a5eea922185fab8214a22109"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMDA4MTE2", "url": "https://github.com/aws-amplify/amplify-android/pull/1014#pullrequestreview-542008116", "createdAt": "2020-12-01T15:20:46Z", "commit": {"oid": "d1bacae287843e48a5eea922185fab8214a22109"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNToyMDo0NlrOH8x-nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNToyMDo0NlrOH8x-nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ5NTQ1NQ==", "bodyText": "This PR has two main changes:\n\nRemove the ifPresent(...) check;\nOnly log this failure, instead of calling emitter.onError(...).", "url": "https://github.com/aws-amplify/amplify-android/pull/1014#discussion_r533495455", "createdAt": "2020-12-01T15:20:46Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java", "diffHunk": "@@ -128,63 +126,35 @@\n     }\n \n     // Delete a model.\n-    private <T extends Model> Completable delete(T model, Consumer<StorageItemChange<T>> onStorageItemChange) {\n-        return Completable.defer(() -> Completable.create(emitter -> {\n-            // First, check if the thing exists.\n-            // If we don't, we'll get an exception saying basically,\n-            // \"failed to delete a non-existing thing.\"\n-            ifPresent(model,\n-                () -> localStorageAdapter.delete(\n-                    model,\n-                    StorageItemChange.Initiator.SYNC_ENGINE,\n-                    QueryPredicates.all(),\n-                    storageItemChange -> {\n-                        onStorageItemChange.accept(storageItemChange);\n-                        emitter.onComplete();\n-                    },\n-                    emitter::onError\n-                ),\n-                emitter::onComplete\n-            );\n-        }));\n+    private <T extends Model> Completable delete(T model, Consumer<StorageItemChange.Type> changeTypeConsumer) {\n+        return Completable.create(emitter ->\n+            localStorageAdapter.delete(model, StorageItemChange.Initiator.SYNC_ENGINE, QueryPredicates.all(),\n+                storageItemChange -> {\n+                    changeTypeConsumer.accept(storageItemChange.type());\n+                    emitter.onComplete();\n+                },\n+                failure -> {\n+                    LOG.verbose(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1bacae287843e48a5eea922185fab8214a22109"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMDI2NDQz", "url": "https://github.com/aws-amplify/amplify-android/pull/1014#pullrequestreview-542026443", "createdAt": "2020-12-01T15:38:12Z", "commit": {"oid": "d1bacae287843e48a5eea922185fab8214a22109"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3333, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}