{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxMDY1NTAx", "number": 961, "title": "fix: properly support flutter online scenarios", "bodyText": "Previous work to support online-sync mode from Flutter had been vetted\nwith the HybridCloudSyncInstrumentationTest. This test was using\nModelSchema.fromClass(), which would still store a Class<T> in the\nmodelClass. As a result, the test was giving false optimism as to the\nfunctionality in the code base.\nA change is made to pull ModelSchema from JSON files, in the ./assets\ndirectory, instead. Driven by this updated tests, a number of additional\nclasses are updated to become aware of ModelSchema and SerializedModel.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-11-14T21:57:50Z", "url": "https://github.com/aws-amplify/amplify-android/pull/961", "merged": true, "mergeCommit": {"oid": "8ccb280c0418853731f46fe709bda857d7b7765e"}, "closed": true, "closedAt": "2020-11-18T18:22:29Z", "author": {"login": "jamesonwilliams"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcjKNygH2gAyNTIxMDY1NTAxOjI0ODE3NjY1YzY2OTJjYjk5Yzg3NmUzMWE2ZTUzZjI4ODUyNTNjZTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddw9MFgFqTUzMzY0MzI4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/24817665c6692cb99c876e31a6e53f2885253ce0", "committedDate": "2020-11-14T22:04:57Z", "message": "fix: properly support flutter online scenarios\n\nPrevious work to support online-sync mode from Flutter had been vetted\nwith the HybridCloudSyncInstrumentationTest. This test was using\nModelSchema.fromClass(), which will still store a Class<T> in the\nmodelClass. As a result, the test was giving false optimism as to the\nfunctionality in the code base.\n\nA change is made to pull ModelSchema from JSON files, in the ./assets\ndirectory, instead. Driven by this updated tests, a number of additional\nclasses are updated to become aware of ModelSchema and SerializedModel."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/24817665c6692cb99c876e31a6e53f2885253ce0", "committedDate": "2020-11-14T22:04:57Z", "message": "fix: properly support flutter online scenarios\n\nPrevious work to support online-sync mode from Flutter had been vetted\nwith the HybridCloudSyncInstrumentationTest. This test was using\nModelSchema.fromClass(), which will still store a Class<T> in the\nmodelClass. As a result, the test was giving false optimism as to the\nfunctionality in the code base.\n\nA change is made to pull ModelSchema from JSON files, in the ./assets\ndirectory, instead. Driven by this updated tests, a number of additional\nclasses are updated to become aware of ModelSchema and SerializedModel."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNjA4MDk3", "url": "https://github.com/aws-amplify/amplify-android/pull/961#pullrequestreview-530608097", "createdAt": "2020-11-14T22:13:17Z", "commit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQyMjoxMzoxN1rOHzOB6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQyMjoxMzoxN1rOHzOB6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ2OTI4OQ==", "bodyText": "The response from AppSync doesn't contain any information about what type it is. Previously, we used to know this because of the <T>. Now, I have to hack the modelSchema back in at this higher level. The SubscriptionProcessor knows which subscription the data came back on, so it can append the schema, here.", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r523469289", "createdAt": "2020-11-14T22:13:17Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SubscriptionProcessor.java", "diffHunk": "@@ -224,7 +224,19 @@ void startDrainingMutationBuffer(Action onPipelineBroken) {\n                 .doOnSubscribe(disposable ->\n                     LOG.info(\"Starting processing subscription data buffer.\")\n                 )\n-                .flatMapCompletable(mutation -> merger.merge(mutation.modelWithMetadata()))\n+                .flatMapCompletable(mutation -> {\n+                    ModelWithMetadata<? extends Model> original = mutation.modelWithMetadata();\n+                    if (original.getModel() instanceof SerializedModel) {\n+                        SerializedModel originalModel = (SerializedModel) original.getModel();\n+                        SerializedModel newModel = SerializedModel.builder()\n+                            .serializedData(originalModel.getSerializedData())\n+                            .modelSchema(mutation.modelSchema())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNjA4MTEw", "url": "https://github.com/aws-amplify/amplify-android/pull/961#pullrequestreview-530608110", "createdAt": "2020-11-14T22:13:32Z", "commit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQyMjoxMzozMlrOHzOB-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQyMjoxMzozMlrOHzOB-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ2OTMwNQ==", "bodyText": "Same basic situation as in the SubscriptionProcessor.", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r523469305", "createdAt": "2020-11-14T22:13:32Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java", "diffHunk": "@@ -140,9 +141,20 @@ private Completable createHydrationTask(ModelSchema schema) {\n                 // Sync all the pages\n                 return syncModel(schema, lastSyncTime)\n                     // For each ModelWithMetadata, merge it into the local store.\n-                    .flatMapCompletable(modelWithMetadata ->\n-                        merger.merge(modelWithMetadata, metricsAccumulator::increment)\n-                    )\n+                    .flatMapCompletable(original -> {\n+                        ModelWithMetadata<? extends Model> updated;\n+                        if (original.getModel() instanceof SerializedModel) {\n+                            SerializedModel originalModel = (SerializedModel) original.getModel();\n+                            SerializedModel newModel = SerializedModel.builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNjA4MTgy", "url": "https://github.com/aws-amplify/amplify-android/pull/961#pullrequestreview-530608182", "createdAt": "2020-11-14T22:15:19Z", "commit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQyMjoxNToxOVrOHzOCoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQyMjoxNToxOVrOHzOCoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ2OTQ3Mw==", "bodyText": "The key change in this PR is that the schema are being read from JSON. The JSON files no longer say com.path.to.some.generated.java.model.JavaPojo. (Previously, the test had passed, with those queues.)\nNow, the stated type for a model is a serialized model.", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r523469473", "createdAt": "2020-11-14T22:15:19Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/HybridCloudSyncInstrumentationTest.java", "diffHunk": "@@ -116,11 +116,12 @@ public void setup() throws AmplifyException {\n         api = SynchronousApi.delegatingTo(apiCategory);\n         appSync = SynchronousAppSync.using(AppSyncClient.via(apiCategory));\n \n+        schemaProvider = SchemaLoader.loadFromAssetsDirectory(\"schemas/commentsblog\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNjA4MjM2", "url": "https://github.com/aws-amplify/amplify-android/pull/961#pullrequestreview-530608236", "createdAt": "2020-11-14T22:16:35Z", "commit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQyMjoxNjozNlrOHzODAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQyMjoxNjozNlrOHzODAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ2OTU2OA==", "bodyText": "This utility is used by the SchemaLoader. The schema loader reads the schema JSON from disk with this list(...) utility. It will then build ModelSchema instances, from each.", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r523469568", "createdAt": "2020-11-14T22:16:36Z", "author": {"login": "jamesonwilliams"}, "path": "testutils/src/main/java/com/amplifyframework/testutils/Assets.java", "diffHunk": "@@ -79,5 +81,30 @@ public static Bitmap readAsBitmap(final String name) throws RuntimeException {\n             throw new RuntimeException(\"Failed to load asset \" + name, ioException);\n         }\n     }\n-}\n \n+    /**\n+     * Lists the files in the assets directory.\n+     * @param path Directory path under assets/.\n+     * @return A list of files found\n+     */\n+    @NonNull\n+    public static List<String> list(String path) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTM4MTg4", "url": "https://github.com/aws-amplify/amplify-android/pull/961#pullrequestreview-531538188", "createdAt": "2020-11-16T17:19:36Z", "commit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTg4NDQ2", "url": "https://github.com/aws-amplify/amplify-android/pull/961#pullrequestreview-531588446", "createdAt": "2020-11-16T18:22:11Z", "commit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODoyMjoxMVrOH0LswA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODoyMjoxMVrOH0LswA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3OTY4MA==", "bodyText": "Hmm, why is this change necessary?  Shouldn't the SerializedModelAdapter already handle this?\nIf this is needed here, then I think we would probably also need a similar change in any other adapter that deserializes a Class that could contain a Model (e.g. PaginatedResult, Iterable, GraphQLResponse)", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r524479680", "createdAt": "2020-11-16T18:22:11Z", "author": {"login": "richardmcclellan"}, "path": "aws-api-appsync/src/main/java/com/amplifyframework/datastore/appsync/ModelWithMetadataAdapter.java", "diffHunk": "@@ -60,7 +61,15 @@ public static void register(@NonNull GsonBuilder builder) {\n             throw new JsonParseException(\"Expected a parameterized type during ModelWithMetadata deserialization.\");\n         }\n \n-        Model model = context.deserialize(json, modelClassType);\n+        final Model model;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxOTAyNDAy", "url": "https://github.com/aws-amplify/amplify-android/pull/961#pullrequestreview-531902402", "createdAt": "2020-11-16T23:20:47Z", "commit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNjQzMjg5", "url": "https://github.com/aws-amplify/amplify-android/pull/961#pullrequestreview-533643289", "createdAt": "2020-11-18T16:43:19Z", "commit": {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3315, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}