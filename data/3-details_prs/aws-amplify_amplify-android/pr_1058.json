{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNTM4Nzk2", "number": 1058, "title": "fix(aws-datastore): ignore foreign key error during sync", "bodyText": "Issue #, if available:\nPartially addresses #1013\nBy ignoring foreign key constraint violation during sync, #1013 issue no longer crashes DataStore.\nEven with the best effort to ensure that the foreign key constraints are met on the client side, it is possible that the remote storage simply does not enforce foreign key violation. This guarantees the possibility of encountering a foreign key constraint violation during sync to be non-zero (e.g. cascading deletion failed halfway while publishing; a race condition arose from multi-device operation; or an entry was inserted directly to remote store). There are two options to deal with a failure during initial sync:\n\nIssue a DELETE mutation on the orphaned remote model that caused the crash.\nIgnore the error.\n\nThe first option is not ideal because this directly assumes that the orphaned entry in remote store is invalid, which may not always be true. DataStore client should never delete customer data unless the DELETE operation was directly issued.\nThe second option is more feasible because it leaves the data safely in cloud while avoiding a fatal crash. Since it does not directly affect customer data, we do not need to provide an explicit error handler to the customer.\nDescription of changes:\nChecks if sync failure was caused by SQLite constraint violation, and if so log the details and continue without crashing.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-12-17T01:20:25Z", "url": "https://github.com/aws-amplify/amplify-android/pull/1058", "merged": true, "mergeCommit": {"oid": "54646bd988020ef9a23d18526984398213c40415"}, "closed": true, "closedAt": "2020-12-17T21:38:48Z", "author": {"login": "raphkim"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm44vYgH2gAyNTQxNTM4Nzk2OjRmNDExZGU4MDA2NzgxOGQyYWUzMTdlODM3NjZlODZlY2U5YmM5ZmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnJ6Q4AFqTU1NDk3ODg4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4f411de80067818d2ae317e83766e86ece9bc9fa", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/4f411de80067818d2ae317e83766e86ece9bc9fa", "committedDate": "2020-12-17T01:03:01Z", "message": "swallow foreign key error during sync"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MjU5MDgz", "url": "https://github.com/aws-amplify/amplify-android/pull/1058#pullrequestreview-554259083", "createdAt": "2020-12-17T03:44:31Z", "commit": {"oid": "4f411de80067818d2ae317e83766e86ece9bc9fa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMzo0NDozMlrOIHjWMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMzo0NDozMlrOIHjWMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc5MDA2Ng==", "bodyText": "I think we should avoid putting stuff in the core module unless it'l be used widely. Even though this is a generic utility, it might be better suited to the DataStore module, where it won't add size to the core artifact (if, for example, someone uses Auth, without DataStore.)", "url": "https://github.com/aws-amplify/amplify-android/pull/1058#discussion_r544790066", "createdAt": "2020-12-17T03:44:32Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/util/Error.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.util;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f411de80067818d2ae317e83766e86ece9bc9fa"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0Nzc3NjEz", "url": "https://github.com/aws-amplify/amplify-android/pull/1058#pullrequestreview-554777613", "createdAt": "2020-12-17T16:34:02Z", "commit": {"oid": "4f411de80067818d2ae317e83766e86ece9bc9fa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNjozNDowM1rOIH-Jsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNjozNDowM1rOIH-Jsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIyOTIzNQ==", "bodyText": "I would expect a class named Error to be instantiable, and to represent a particular error.  What about calling this something like ErrorInspector, or ThrowableInspector, or ErrorCause (and rename containsCause to just contains)?   Just a thought.  I think I like ErrorInspector the best, though I don't feel too strongly.", "url": "https://github.com/aws-amplify/amplify-android/pull/1058#discussion_r545229235", "createdAt": "2020-12-17T16:34:03Z", "author": {"login": "richardmcclellan"}, "path": "core/src/main/java/com/amplifyframework/util/Error.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.util;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import java.util.Objects;\n+\n+/**\n+ * Utility class to provide helpful functions to use on throwable instances.\n+ */\n+public final class Error {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f411de80067818d2ae317e83766e86ece9bc9fa"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0ODA0MTc2", "url": "https://github.com/aws-amplify/amplify-android/pull/1058#pullrequestreview-554804176", "createdAt": "2020-12-17T17:03:09Z", "commit": {"oid": "4f411de80067818d2ae317e83766e86ece9bc9fa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNzowMzowOVrOIH_e1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNzowMzowOVrOIH_e1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1MTAyOQ==", "bodyText": "Swallowing SQLiteConstraintException errors makes sense, but I think we also need to make sure that we do NOT announce a successful merge.\nI think you could do this by doing the announceSuccessfulMerge with andThen, instead of doOnComplete.  That way, it will only happen if there are no errors with the save.\nIt could even make sense to broadcast a new SUBSCRIPTION_DATA_FAILED event if a SQLiteConstraintException is thrown, but I don't think we need that just yet.", "url": "https://github.com/aws-amplify/amplify-android/pull/1058#discussion_r545251029", "createdAt": "2020-12-17T17:03:09Z", "author": {"login": "richardmcclellan"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java", "diffHunk": "@@ -109,6 +111,15 @@\n                 announceSuccessfulMerge(modelWithMetadata);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f411de80067818d2ae317e83766e86ece9bc9fa"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f526504c240ffd1393c510b53920c6b5282f5907", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/f526504c240ffd1393c510b53920c6b5282f5907", "committedDate": "2020-12-17T20:46:20Z", "message": "address pr comments and add test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0OTc4ODg5", "url": "https://github.com/aws-amplify/amplify-android/pull/1058#pullrequestreview-554978889", "createdAt": "2020-12-17T20:53:04Z", "commit": {"oid": "f526504c240ffd1393c510b53920c6b5282f5907"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3376, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}