{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NjI4ODYw", "number": 459, "title": "[aws-datastore] Fix unhandled exceptions when no API is available", "bodyText": "Overview\nThis PR addresses an issue where the developer has added both the DataStore and API plugins to Amplify but has not yet pushed the backend infrastructure (or an error happens while communicating with AppSync)\nWith this change, even if there are errors on the remote sync process startup, the app will not crash and local store will still be available.\nChanges\nRemoteModelMutations\nModified the observe function to return a merged obervable that contains one child observer per model type/subscription type combination. If any of these children fail, we log the error as a warning and complete.\nSyncProcessor\nUpdated the hydrate function to handle errors by logging and forcing a the onComplete event.\nIdeally, with both of these, the next step would be to implement a retry strategy. First step is to prevent the app from crashing if an unhandled exception occurs on startup.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-05-13T21:42:53Z", "url": "https://github.com/aws-amplify/amplify-android/pull/459", "merged": true, "mergeCommit": {"oid": "8357925c79e0f01d949929d0c4b452362b5a0489"}, "closed": true, "closedAt": "2020-05-15T19:31:10Z", "author": {"login": "rjuliano"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg_3uugH2gAyNDE3NjI4ODYwOmY4M2IwNmMyZmQ5YjdkYWJhMTE3YzYyYWM4Mjk4OTYwMTY3MzU3YzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchnBEhgFqTQxMjkwNDE0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f83b06c2fd9b7daba117c62ac8298960167357c6", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/f83b06c2fd9b7daba117c62ac8298960167357c6", "committedDate": "2020-05-13T21:36:33Z", "message": "[aws-datastore] Prevent host app from crashing on unhandled exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMzI0NzA3", "url": "https://github.com/aws-amplify/amplify-android/pull/459#pullrequestreview-411324707", "createdAt": "2020-05-13T21:50:03Z", "commit": {"oid": "f83b06c2fd9b7daba117c62ac8298960167357c6"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMTo1MDowNFrOGVExaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMjowNDowNFrOGVFInA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1MTQ2NA==", "bodyText": "This can be a desirable behavior. As an SDK, we cant escalate errors back to the user, and let them decide what to do with them. If the user does catch (Throwable e) { /* gobble gobble */ } - well, that's their choice.", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r424751464", "createdAt": "2020-05-13T21:50:04Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java", "diffHunk": "@@ -83,6 +89,34 @@ private AWSDataStorePlugin(\n             @NonNull ModelSchemaRegistry modelSchemaRegistry,\n             @NonNull ApiCategory api,\n             @Nullable DataStoreConfiguration userProvidedConfiguration) {\n+        // See https://github.com/ReactiveX/RxJava/wiki/What's-different-in-2.0#error-handling\n+        // Without this, the host app crashes on an unhandled exception.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f83b06c2fd9b7daba117c62ac8298960167357c6"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1MzQ5Mg==", "bodyText": "I'm worried about including this, for two reasons.\n\nOperational Correctness.\n\na. I think we should let errors propagate to the user. If they come from our library, we address them as bugs. If they come from the user's usage, the user can easily identify them, and fix them. (Or, they can catch (Throwable e) { /* gobble gobble */}, but that's their choice, not our prescription.)\nb.  Is this the right time and place to be calling this RxJavaPlugins.setErrorHandler? What if the user also uses Rx (most do), and wants to call RxJavaPlugins.setErrorHandler in their app? What if we calls ours at time t1, and the they call theirs at time t2, and the relationship is difficult to detect and understand? Have we even picked the right t1?\n\nMaintainability.\n\na. This is a big list of different types of exceptions. There will be many types of exceptions. Each will come with some business rules. This code block will end up being a free for all where we encode business rules for unrelated software components.\nb. More basically, this shouldn't be inlined right into the plugin, it should be some external handler class. At most, the AWSDataStorePlugin might do RxJavaPlugins.setErrorHandler(DataStoreErrorHandler::handle)\nTo that point, should this not be the error handler callback that we just added with the config work? Instead of this custom, inline, handler?", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r424753492", "createdAt": "2020-05-13T21:54:51Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java", "diffHunk": "@@ -83,6 +89,34 @@ private AWSDataStorePlugin(\n             @NonNull ModelSchemaRegistry modelSchemaRegistry,\n             @NonNull ApiCategory api,\n             @Nullable DataStoreConfiguration userProvidedConfiguration) {\n+        // See https://github.com/ReactiveX/RxJava/wiki/What's-different-in-2.0#error-handling\n+        // Without this, the host app crashes on an unhandled exception.\n+        RxJavaPlugins.setErrorHandler(e -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f83b06c2fd9b7daba117c62ac8298960167357c6"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NTA3NQ==", "bodyText": "At a high level, it might make sense to allow the system to continue operating, if the orchestrator cannot start.\nBut, this code is a little hard to follow. Why do you need the errorOccured flag? Wouldn't onErrorComplete() be ~approximately enough for this whole PR?", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r424755075", "createdAt": "2020-05-13T21:58:46Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -97,12 +101,28 @@ public Orchestrator(\n      */\n     @NonNull\n     public Completable start() {\n+        AtomicBoolean errorOccurred = new AtomicBoolean(false);\n         return Completable.fromAction(() -> {\n+            LOG.debug(\"Start observing changes made to local store.\");\n             storageObserver.startObservingStorageChanges();\n+            LOG.debug(\"Establishing subscriptions with remote data store.\");\n             subscriptionProcessor.startSubscriptions();\n-            syncProcessor.hydrate().blockingAwait();\n-            mutationProcessor.startDrainingMutationOutbox();\n-            subscriptionProcessor.startDrainingMutationBuffer();\n+            LOG.debug(\"Start initial sync from remote data store.\");\n+            syncProcessor\n+                .hydrate()\n+                .doOnError(error -> {\n+                    LOG.warn(\"Unable to perform initial synchronization.\", error);\n+                    errorOccurred.set(true);\n+                }).doOnComplete(() -> {\n+                    if (!errorOccurred.get()) {\n+                        LOG.debug(\"Starting MutationProcessor and SubscriptionProcessor.\");\n+                        mutationProcessor.startDrainingMutationOutbox();\n+                        subscriptionProcessor.startDrainingMutationBuffer();\n+                    }\n+                })\n+                // This will prevent the host app from crashing if no API is configured.\n+                .onErrorComplete()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f83b06c2fd9b7daba117c62ac8298960167357c6"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NTIzNA==", "bodyText": "Please use org.junit.Assert.assertEquals.", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r424755234", "createdAt": "2020-05-13T21:59:05Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java", "diffHunk": "@@ -40,8 +43,14 @@\n \n import java.util.Collections;\n \n+import io.reactivex.Completable;\n+\n import static androidx.test.core.app.ApplicationProvider.getApplicationContext;\n+import static junit.framework.TestCase.assertEquals;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f83b06c2fd9b7daba117c62ac8298960167357c6"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NTQxMQ==", "bodyText": "Where is the unchecked call in this method?", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r424755411", "createdAt": "2020-05-13T21:59:29Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java", "diffHunk": "@@ -61,14 +69,14 @@\n      * the SyncProcessor is running. Otherwise, either the SyncProcessor is *not*\n      * running, or it is running but not functioning as we expect it to.\n      */\n+    @SuppressWarnings(\"unchecked\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f83b06c2fd9b7daba117c62ac8298960167357c6"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NjAyMw==", "bodyText": "I think we should start splitting tests out into other classes. The ones I have in here right now are related to model synchronization. Probably AWSDataStorePluginTest was a bad name to begin with. All in all, the plugin does a lot of different stuff. I think we are ultimately funneling all of our high level tests into this class and its going to end up having a lot of unrelated stuff and being a bit of a maintenance issue.", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r424756023", "createdAt": "2020-05-13T22:00:52Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java", "diffHunk": "@@ -52,7 +61,6 @@\n @RunWith(RobolectricTestRunner.class)\n public final class AWSDataStorePluginTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f83b06c2fd9b7daba117c62ac8298960167357c6"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NjQ3NA==", "bodyText": "You may find utility in the DataStoreCategoryConfigurator . Er, maybe thats in androidTest though isn't it...", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r424756474", "createdAt": "2020-05-13T22:01:50Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java", "diffHunk": "@@ -79,8 +87,10 @@ public void setup() {\n     @Test\n     public void configureAndInitializeInLocalMode() throws AmplifyException {\n         //Configure DataStore with an empty config (All defaults)\n-        awsDataStorePlugin.configure(new JSONObject(), context);\n-        awsDataStorePlugin.initialize(context);\n+        ApiCategory emptyApiCategory = spy(ApiCategory.class);\n+        AWSDataStorePlugin standAloneDataStorePlugin = new AWSDataStorePlugin(modelProvider, emptyApiCategory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f83b06c2fd9b7daba117c62ac8298960167357c6"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NzQwNA==", "bodyText": "I think you could do blockingGet(), save the return value, and then do if (returnedValue != null) throw returnedValue;", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r424757404", "createdAt": "2020-05-13T22:04:04Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java", "diffHunk": "@@ -93,18 +103,57 @@ public void configureAndInitializeInLocalMode() throws AmplifyException {\n      */\n     @Test\n     public void configureAndInitializeInApiMode() throws JSONException, AmplifyException {\n-        Amplify.addPlugin(mockApiPlugin());\n-        JSONObject amplifyJson = new JSONObject().put(\"api\", new JSONObject());\n-        AmplifyConfiguration configuration = AmplifyConfiguration.fromJson(amplifyJson);\n-        Amplify.configure(configuration, context);\n-\n-        JSONObject pluginJson = new JSONObject()\n+        ApiCategory mockApiCategory = mockApiCategoryWithGraphQlApi();\n+        JSONObject dataStorePluginJson = new JSONObject()\n             .put(\"syncIntervalInMinutes\", 60);\n-        awsDataStorePlugin.configure(pluginJson, context);\n+        AWSDataStorePlugin awsDataStorePlugin = new AWSDataStorePlugin(modelProvider, mockApiCategory);\n+        awsDataStorePlugin.configure(dataStorePluginJson, context);\n         awsDataStorePlugin.initialize(context);\n         assertSyncProcessorStarted();\n     }\n \n+    /**\n+     * Simulate a situation where the user has added the API plugin, but it's\n+     * either not pushed or exceptions occur while trying to start up the sync processes.\n+     * The outcome is that the local store should still be available and the\n+     * host app should not crash.\n+     * @throws JSONException If an exception occurs while building the JSON configuration.\n+     * @throws AmplifyException If an exception occurs setting up the mock API\n+     */\n+    @Test\n+    public void configureAndInitializeInApiModeWithoutApi() throws JSONException, AmplifyException {\n+        ApiCategory mockApiCategory = mockApiPluginWithExceptions();\n+        JSONObject dataStorePluginJson = new JSONObject()\n+            .put(\"syncIntervalInMinutes\", 60);\n+        AWSDataStorePlugin awsDataStorePlugin = new AWSDataStorePlugin(modelProvider, mockApiCategory);\n+        awsDataStorePlugin.configure(dataStorePluginJson, context);\n+        awsDataStorePlugin.initialize(context);\n+\n+        // Trick the DataStore since it's not getting initialized as part of the Amplify.initialize call chain\n+        Amplify.Hub.publish(HubChannel.DATASTORE, HubEvent.create(InitializationStatus.SUCCEEDED));\n+\n+        Person person1 = createPerson(\"Test\", \"Dummy I\");\n+        Completable.fromSingle(single -> { // Save a record to local store\n+            awsDataStorePlugin.save(person1, itemSaved -> {\n+                assertNotNull(itemSaved.item().getId());\n+                assertEquals(person1.getLastName(), itemSaved.item().getLastName());\n+                single.onSuccess(true);\n+            }, single::onError);\n+        }).andThen(\n+            Completable.fromSingle(single -> { // Verify the record has been saved\n+                awsDataStorePlugin.query(Person.class, results -> {\n+                    Person actualPerson = results.next();\n+                    assertNotNull(actualPerson);\n+                    assertFalse(results.hasNext()); // We should only have one result.\n+                    assertEquals(person1, actualPerson);\n+                    single.onSuccess(true);\n+                }, single::onError);\n+            })\n+        ).doOnError(error -> {\n+            fail(error.getMessage());\n+        }).blockingAwait();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f83b06c2fd9b7daba117c62ac8298960167357c6"}, "originalPosition": 133}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "590082c76d44100f35f54dab2a154509f9eb763c", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/590082c76d44100f35f54dab2a154509f9eb763c", "committedDate": "2020-05-14T11:11:22Z", "message": "Rollback first attempt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9782914425b4fc850f8bafe7016cb66a77edeb97", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/9782914425b4fc850f8bafe7016cb66a77edeb97", "committedDate": "2020-05-15T13:13:55Z", "message": "[aws-datastore] Fix startup issues when in standalone mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fcc442f4d3bcca61615430e00a38016a337c71f", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/4fcc442f4d3bcca61615430e00a38016a337c71f", "committedDate": "2020-05-15T13:27:25Z", "message": "Checkstyle and remote unnecessary change to Orchestrator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNzIyMjc1", "url": "https://github.com/aws-amplify/amplify-android/pull/459#pullrequestreview-412722275", "createdAt": "2020-05-15T14:55:50Z", "commit": {"oid": "4fcc442f4d3bcca61615430e00a38016a337c71f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e407dfe3c64d021461d02d431c55ac497fe1325", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/2e407dfe3c64d021461d02d431c55ac497fe1325", "committedDate": "2020-05-15T17:44:12Z", "message": "Rebased and added error handler to SubscriptionProcessor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ca709c62217b32f7039dfef9464927713442638", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/5ca709c62217b32f7039dfef9464927713442638", "committedDate": "2020-05-15T17:48:58Z", "message": "deleted ghost file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODYxMDI0", "url": "https://github.com/aws-amplify/amplify-android/pull/459#pullrequestreview-412861024", "createdAt": "2020-05-15T18:06:38Z", "commit": {"oid": "5ca709c62217b32f7039dfef9464927713442638"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxODowNjozOFrOGWO37Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxODowNjozOFrOGWO37Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2NTU0OQ==", "bodyText": "super minor nit: \"datastore\" vs. \"data store\"", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r425965549", "createdAt": "2020-05-15T18:06:38Z", "author": {"login": "TrekSoft"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SubscriptionProcessor.java", "diffHunk": "@@ -115,6 +115,14 @@ void startSubscriptions() {\n             ));\n             latch.await(SUBSCRIPTION_START_TIMEOUT_MS, TimeUnit.MILLISECONDS);\n         })\n+        .doOnError(exception -> {\n+            LOG.warn(\"An error occurred with one of the subscriptions to the remote data store for \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ca709c62217b32f7039dfef9464927713442638"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODYxNjc1", "url": "https://github.com/aws-amplify/amplify-android/pull/459#pullrequestreview-412861675", "createdAt": "2020-05-15T18:07:38Z", "commit": {"oid": "5ca709c62217b32f7039dfef9464927713442638"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODYzNDg1", "url": "https://github.com/aws-amplify/amplify-android/pull/459#pullrequestreview-412863485", "createdAt": "2020-05-15T18:10:38Z", "commit": {"oid": "5ca709c62217b32f7039dfef9464927713442638"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxODoxMDozOFrOGWO_Mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxODoxODozMlrOGWPOOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2NzQxMA==", "bodyText": "Actually, neither!\nIt's the DataStore.", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r425967410", "createdAt": "2020-05-15T18:10:38Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SubscriptionProcessor.java", "diffHunk": "@@ -115,6 +115,14 @@ void startSubscriptions() {\n             ));\n             latch.await(SUBSCRIPTION_START_TIMEOUT_MS, TimeUnit.MILLISECONDS);\n         })\n+        .doOnError(exception -> {\n+            LOG.warn(\"An error occurred with one of the subscriptions to the remote data store for \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2NTU0OQ=="}, "originalCommit": {"oid": "5ca709c62217b32f7039dfef9464927713442638"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2Nzc2OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOG.warn(\"An error occurred with one of the subscriptions to the remote data store for \" +\n          \n          \n            \n                        LOG.warn(\"An error occurred with one of the subscriptions to the remote DataStore for \" +", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r425967769", "createdAt": "2020-05-15T18:11:20Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SubscriptionProcessor.java", "diffHunk": "@@ -115,6 +115,14 @@ void startSubscriptions() {\n             ));\n             latch.await(SUBSCRIPTION_START_TIMEOUT_MS, TimeUnit.MILLISECONDS);\n         })\n+        .doOnError(exception -> {\n+            LOG.warn(\"An error occurred with one of the subscriptions to the remote data store for \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ca709c62217b32f7039dfef9464927713442638"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2ODYzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"model \"+clazz.getSimpleName()+\" \"+subscriptionType.name(),\n          \n          \n            \n                            \"model \" + clazz.getSimpleName() + \" \" + subscriptionType.name(),", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r425968636", "createdAt": "2020-05-15T18:13:04Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SubscriptionProcessor.java", "diffHunk": "@@ -115,6 +115,14 @@ void startSubscriptions() {\n             ));\n             latch.await(SUBSCRIPTION_START_TIMEOUT_MS, TimeUnit.MILLISECONDS);\n         })\n+        .doOnError(exception -> {\n+            LOG.warn(\"An error occurred with one of the subscriptions to the remote data store for \" +\n+                \"model \"+clazz.getSimpleName()+\" \"+subscriptionType.name(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ca709c62217b32f7039dfef9464927713442638"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2OTAxMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import static junit.framework.TestCase.assertEquals;\n          \n          \n            \n            import static org.junit.Assert.assertEquals;", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r425969011", "createdAt": "2020-05-15T18:13:49Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java", "diffHunk": "@@ -40,8 +43,14 @@\n \n import java.util.Collections;\n \n+import io.reactivex.Completable;\n+\n import static androidx.test.core.app.ApplicationProvider.getApplicationContext;\n+import static junit.framework.TestCase.assertEquals;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ca709c62217b32f7039dfef9464927713442638"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2OTE4Nw==", "bodyText": "Sounds good to me", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r425969187", "createdAt": "2020-05-15T18:14:16Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java", "diffHunk": "@@ -52,7 +61,6 @@\n @RunWith(RobolectricTestRunner.class)\n public final class AWSDataStorePluginTest {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NjAyMw=="}, "originalCommit": {"oid": "f83b06c2fd9b7daba117c62ac8298960167357c6"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2OTkxMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @SuppressWarnings(\"unchecked\")\n          \n      \n    \n    \n  \n\nI'd expect it to be on the class, though -- or on one of the @Test. Here one the @Before, it doesn't seem like it suppressing anything inside of this particular method.", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r425969911", "createdAt": "2020-05-15T18:15:48Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java", "diffHunk": "@@ -61,14 +69,14 @@\n      * the SyncProcessor is running. Otherwise, either the SyncProcessor is *not*\n      * running, or it is running but not functioning as we expect it to.\n      */\n+    @SuppressWarnings(\"unchecked\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ca709c62217b32f7039dfef9464927713442638"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk3MTI1Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    }).blockingAwait();\n          \n          \n            \n                    }).blockingAwait(OPERATION_TIMEOUT_MS, TimeUnit.MILLISECONDS);\n          \n      \n    \n    \n  \n\n^ This won't quite work via the \"accept a change\" UX, unfortunately.\nAnyway, this will help prevent our test from hanging indefinitely in case something goes wrong.", "url": "https://github.com/aws-amplify/amplify-android/pull/459#discussion_r425971257", "createdAt": "2020-05-15T18:18:32Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java", "diffHunk": "@@ -93,18 +103,57 @@ public void configureAndInitializeInLocalMode() throws AmplifyException {\n      */\n     @Test\n     public void configureAndInitializeInApiMode() throws JSONException, AmplifyException {\n-        Amplify.addPlugin(mockApiPlugin());\n-        JSONObject amplifyJson = new JSONObject().put(\"api\", new JSONObject());\n-        AmplifyConfiguration configuration = AmplifyConfiguration.fromJson(amplifyJson);\n-        Amplify.configure(configuration, context);\n-\n-        JSONObject pluginJson = new JSONObject()\n+        ApiCategory mockApiCategory = mockApiCategoryWithGraphQlApi();\n+        JSONObject dataStorePluginJson = new JSONObject()\n             .put(\"syncIntervalInMinutes\", 60);\n-        awsDataStorePlugin.configure(pluginJson, context);\n+        AWSDataStorePlugin awsDataStorePlugin = new AWSDataStorePlugin(modelProvider, mockApiCategory);\n+        awsDataStorePlugin.configure(dataStorePluginJson, context);\n         awsDataStorePlugin.initialize(context);\n         assertSyncProcessorStarted();\n     }\n \n+    /**\n+     * Simulate a situation where the user has added the API plugin, but it's\n+     * either not pushed or exceptions occur while trying to start up the sync processes.\n+     * The outcome is that the local store should still be available and the\n+     * host app should not crash.\n+     * @throws JSONException If an exception occurs while building the JSON configuration.\n+     * @throws AmplifyException If an exception occurs setting up the mock API\n+     */\n+    @Test\n+    public void configureAndInitializeInApiModeWithoutApi() throws JSONException, AmplifyException {\n+        ApiCategory mockApiCategory = mockApiPluginWithExceptions();\n+        JSONObject dataStorePluginJson = new JSONObject()\n+            .put(\"syncIntervalInMinutes\", 60);\n+        AWSDataStorePlugin awsDataStorePlugin = new AWSDataStorePlugin(modelProvider, mockApiCategory);\n+        awsDataStorePlugin.configure(dataStorePluginJson, context);\n+        awsDataStorePlugin.initialize(context);\n+\n+        // Trick the DataStore since it's not getting initialized as part of the Amplify.initialize call chain\n+        Amplify.Hub.publish(HubChannel.DATASTORE, HubEvent.create(InitializationStatus.SUCCEEDED));\n+\n+        Person person1 = createPerson(\"Test\", \"Dummy I\");\n+        Completable.fromSingle(single -> { // Save a record to local store\n+            awsDataStorePlugin.save(person1, itemSaved -> {\n+                assertNotNull(itemSaved.item().getId());\n+                assertEquals(person1.getLastName(), itemSaved.item().getLastName());\n+                single.onSuccess(true);\n+            }, single::onError);\n+        }).andThen(\n+            Completable.fromSingle(single -> { // Verify the record has been saved\n+                awsDataStorePlugin.query(Person.class, results -> {\n+                    Person actualPerson = results.next();\n+                    assertNotNull(actualPerson);\n+                    assertFalse(results.hasNext()); // We should only have one result.\n+                    assertEquals(person1, actualPerson);\n+                    single.onSuccess(true);\n+                }, single::onError);\n+            })\n+        ).doOnError(error -> {\n+            fail(error.getMessage());\n+        }).blockingAwait();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ca709c62217b32f7039dfef9464927713442638"}, "originalPosition": 133}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec40b11b32d53147a76f1043f17a471709a0e261", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/ec40b11b32d53147a76f1043f17a471709a0e261", "committedDate": "2020-05-15T18:56:54Z", "message": "Apply suggestions from code review\r\n\r\nminor PR fixes\n\nCo-authored-by: Jameson Williams <jhwill@amazon.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a804eba4f824486645f65061c5bf23fbdb36d896", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/a804eba4f824486645f65061c5bf23fbdb36d896", "committedDate": "2020-05-15T19:06:10Z", "message": "Checkstyle and other minor tweaks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTA0MTQ2", "url": "https://github.com/aws-amplify/amplify-android/pull/459#pullrequestreview-412904146", "createdAt": "2020-05-15T19:13:03Z", "commit": {"oid": "a804eba4f824486645f65061c5bf23fbdb36d896"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2485, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}