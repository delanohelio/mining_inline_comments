{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5MzAyNjAy", "number": 596, "title": "GraphQLRequestFactory refactor & add owner based auth support to API category", "bodyText": "Summary:\n\nFix for #186.  If the model has @AuthRule with an AuthStrategy.OWNER auth strategy, then:\n\nownerField (defaults to owner) is added to selection set if it isn't explicitly set in the schema.  This is done in SelectionSet.java Removed per feedback from @lawmicha.\nownerField (defaults to owner) is added as a variable on subscriptions, with a value of CognitoUserPoolsAuthProvider.getUsername(), iff the SubscriptionType is protected by the @AuthRule.  For example, an onCreate subscription request only adds username if create mutations are protected (specified via modelOperations). This is done in AWSApiPlugin.subscription and AppSyncGraphQLRequest.setAuthProvider.   If the auth plugin is not configured or cognito user pools are not configured on the API, an exception is thrown on request construction.\nFor mutations, the model object is serialized as a request variable.  If ownerField (defaults to owner) is defined, but set to null, we filter it out of the request object since it will be hydrated automatically by AppSync.\n\n\nRefactored AppSyncGraphQLRequestFactory so that request construction is more extensible, and no longer relies on long StringBuilders.\n\nGraphQLRequest is now abstract.  SimpleGraphQLRequest is a concrete implementation with the same constructors previously in GraphQLRequest, and is still used by aws-datastore.  AppSyncGraphQLRequest is a concrete implementation in aws-api where the bulk of the GraphQL document construction takes place now.\nOperationType is a new interface implemented by QueryType, MutationType, and SubscriptionType.   To build an AppSyncGraphQLRequest, simply pass the OperationType to the builder.\nSome minor whitespace changes were made in the expected request.json files due to the request string construction refactor.\n\n\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-06-24T16:01:03Z", "url": "https://github.com/aws-amplify/amplify-android/pull/596", "merged": true, "mergeCommit": {"oid": "4ad707a4c8f0975d271e3631deb4d9de6f3ef000"}, "closed": true, "closedAt": "2020-07-13T21:51:08Z", "author": {"login": "richardmcclellan"}, "timelineItems": {"totalCount": 46, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcubfclgH2gAyNDM5MzAyNjAyOjkyODI1MTBlOTFhZTNiZGQyN2Q3ZTQwYmQwZWE0M2NkZjk3YjIwN2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0oCYigH2gAyNDM5MzAyNjAyOmFhYzcyZGNkMWRiZWU1OWFlMTJkNTU4ZDZmOTVlMjY5YTUyZDQyZTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9282510e91ae3bdd27d7e40bd0ea43cdf97b207a", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/9282510e91ae3bdd27d7e40bd0ea43cdf97b207a", "committedDate": "2020-06-24T15:08:23Z", "message": "Rename Quotes to Wrap and add a couple more helper methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc411298dad9b61e63c9a7f238500fb96842ab1c", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/bc411298dad9b61e63c9a7f238500fb96842ab1c", "committedDate": "2020-06-24T15:08:23Z", "message": "feat(api): refactor GraphQlRequestFactory and add owner based auth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cb0042952b45cddea52c87ab0a9b9e18880275a", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/2cb0042952b45cddea52c87ab0a9b9e18880275a", "committedDate": "2020-06-24T22:06:53Z", "message": "Fix integration test failures"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDczOTE5", "url": "https://github.com/aws-amplify/amplify-android/pull/596#pullrequestreview-437073919", "createdAt": "2020-06-24T23:31:00Z", "commit": {"oid": "2cb0042952b45cddea52c87ab0a9b9e18880275a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMzozMTowMFrOGomfSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMzozMTowMFrOGomfSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyNjgyNA==", "bodyText": "Nice adaptation, here!!", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r445226824", "createdAt": "2020-06-24T23:31:00Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/util/Wrap.java", "diffHunk": "@@ -18,10 +18,10 @@\n import androidx.annotation.Nullable;\n \n /**\n- * A utility to wrap strings into quotes.\n+ * A utility to wrap strings.\n  */\n-public final class Quotes {\n-    private Quotes() {}\n+public final class Wrap {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cb0042952b45cddea52c87ab0a9b9e18880275a"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9", "committedDate": "2020-06-29T22:01:28Z", "message": "Merge from main"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMDA2NTMx", "url": "https://github.com/aws-amplify/amplify-android/pull/596#pullrequestreview-440006531", "createdAt": "2020-06-30T13:21:32Z", "commit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMzoyMTozMlrOGq8Aig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDoxNTo1M1rOGq-hCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY3NjU1NA==", "bodyText": "Maybe a different name for this method?\nWhen I saw the call to this from the subscribe method, I assumed you were going to set the authProvider in the request object; however, that's already done in the constructor. If my understanding is correct, this method would be more like a setOwner (or something along those lines)", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r447676554", "createdAt": "2020-06-30T13:21:32Z", "author": {"login": "rjuliano"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLRequest.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.annotation.NonNull;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.api.ApiException;\n+import com.amplifyframework.api.aws.appsync.GsonVariablesSerializer;\n+import com.amplifyframework.api.aws.sigv4.CognitoUserPoolsAuthProvider;\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.OperationType;\n+import com.amplifyframework.api.graphql.QueryType;\n+import com.amplifyframework.api.graphql.SubscriptionType;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelOperation;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.Casing;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * A request against an AppSync GraphQL endpoint.\n+ * @param <R> The type of data contained in the GraphQLResponse expected from this request.\n+ */\n+public final class AppSyncGraphQLRequest<R> extends GraphQLRequest<R> {\n+    private static final int DEFAULT_LEVEL_DEPTH = 2;\n+\n+    private final ModelSchema modelSchema;\n+    private final OperationType operationType;\n+    private final SelectionSet.Node selectionSet;\n+    private final Map<String, Object> variables;\n+    private final Map<String, String> variableTypes;\n+\n+    /**\n+     * Constructor for AppSyncGraphQLRequest.\n+     * @throw AmplifyException if a ModelSchema can't be derived from the provided model class\n+     */\n+    private AppSyncGraphQLRequest(Builder builder) throws AmplifyException {\n+        super(builder.responseType, new GsonVariablesSerializer());\n+        this.modelSchema = ModelSchema.fromModelClass(builder.modelClass);\n+        SelectionSet.Node set = SelectionSet.fromModelClass(builder.modelClass, DEFAULT_LEVEL_DEPTH);\n+        if (QueryType.LIST.equals(builder.operationType)) {\n+            set = SelectionSet.wrapPagination(set);\n+        }\n+        this.selectionSet = set;\n+        this.operationType = builder.operationType;\n+        this.variables = builder.variables;\n+        this.variableTypes = builder.variableTypes;\n+    }\n+\n+    /**\n+     * Copy constructor for an AppSyncGraphQLRequest.\n+     * @param request request to copy.\n+     * @param <R> response type.\n+     */\n+    public <R> AppSyncGraphQLRequest(AppSyncGraphQLRequest<R> request) {\n+        super(request);\n+        this.modelSchema = request.modelSchema;\n+        this.operationType = request.operationType;\n+        this.selectionSet = new SelectionSet.Node(request.selectionSet);\n+        this.variables = new HashMap<>(request.variables);\n+        this.variableTypes = new HashMap<>(request.variableTypes);\n+    }\n+\n+    @Override\n+    public <R> AppSyncGraphQLRequest<R> copy() {\n+        return new AppSyncGraphQLRequest<R>(this);\n+    }\n+\n+    @Override\n+    public Map<String, Object> getVariables() {\n+        return this.variables;\n+    }\n+\n+    /**\n+     * Used for setting a variable on the request.\n+     * @param key variable name\n+     * @param type type of variable value\n+     * @param value variable value\n+     */\n+    public void setVariable(String key, String type, String value) {\n+        this.variables.put(key, value);\n+        this.variableTypes.put(key, type);\n+    }\n+\n+    /**\n+     * Used to add owner argument from authProvider if needed.\n+     * @param authProvider CognitoUserPoolsAuthProvider for obtaining the username to set as the owner field.\n+     * @throws ApiException if request requires owner argument and authProvider or authProvider.getUsername() is null.\n+     */\n+    public void setAuthProvider(CognitoUserPoolsAuthProvider authProvider) throws ApiException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcwMjYyNA==", "bodyText": "Pretty clever indeed. \ud83d\udc4d", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r447702624", "createdAt": "2020-06-30T13:56:16Z", "author": {"login": "rjuliano"}, "path": "core/src/main/java/com/amplifyframework/util/Wrap.java", "diffHunk": "@@ -18,10 +18,10 @@\n import androidx.annotation.Nullable;\n \n /**\n- * A utility to wrap strings into quotes.\n+ * A utility to wrap strings.\n  */\n-public final class Quotes {\n-    private Quotes() {}\n+public final class Wrap {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyNjgyNA=="}, "originalCommit": {"oid": "2cb0042952b45cddea52c87ab0a9b9e18880275a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcxNzY0Mw==", "bodyText": "I noticed that nextToken was removed as an input from the query in one of the test cases (query-person-by-predicate.txt ) and I don't see that accounted for anywhere. Is that by design?", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r447717643", "createdAt": "2020-06-30T14:15:53Z", "author": {"login": "rjuliano"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLRequest.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.annotation.NonNull;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.api.ApiException;\n+import com.amplifyframework.api.aws.appsync.GsonVariablesSerializer;\n+import com.amplifyframework.api.aws.sigv4.CognitoUserPoolsAuthProvider;\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.OperationType;\n+import com.amplifyframework.api.graphql.QueryType;\n+import com.amplifyframework.api.graphql.SubscriptionType;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelOperation;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.Casing;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * A request against an AppSync GraphQL endpoint.\n+ * @param <R> The type of data contained in the GraphQLResponse expected from this request.\n+ */\n+public final class AppSyncGraphQLRequest<R> extends GraphQLRequest<R> {\n+    private static final int DEFAULT_LEVEL_DEPTH = 2;\n+\n+    private final ModelSchema modelSchema;\n+    private final OperationType operationType;\n+    private final SelectionSet.Node selectionSet;\n+    private final Map<String, Object> variables;\n+    private final Map<String, String> variableTypes;\n+\n+    /**\n+     * Constructor for AppSyncGraphQLRequest.\n+     * @throw AmplifyException if a ModelSchema can't be derived from the provided model class\n+     */\n+    private AppSyncGraphQLRequest(Builder builder) throws AmplifyException {\n+        super(builder.responseType, new GsonVariablesSerializer());\n+        this.modelSchema = ModelSchema.fromModelClass(builder.modelClass);\n+        SelectionSet.Node set = SelectionSet.fromModelClass(builder.modelClass, DEFAULT_LEVEL_DEPTH);\n+        if (QueryType.LIST.equals(builder.operationType)) {\n+            set = SelectionSet.wrapPagination(set);\n+        }\n+        this.selectionSet = set;\n+        this.operationType = builder.operationType;\n+        this.variables = builder.variables;\n+        this.variableTypes = builder.variableTypes;\n+    }\n+\n+    /**\n+     * Copy constructor for an AppSyncGraphQLRequest.\n+     * @param request request to copy.\n+     * @param <R> response type.\n+     */\n+    public <R> AppSyncGraphQLRequest(AppSyncGraphQLRequest<R> request) {\n+        super(request);\n+        this.modelSchema = request.modelSchema;\n+        this.operationType = request.operationType;\n+        this.selectionSet = new SelectionSet.Node(request.selectionSet);\n+        this.variables = new HashMap<>(request.variables);\n+        this.variableTypes = new HashMap<>(request.variableTypes);\n+    }\n+\n+    @Override\n+    public <R> AppSyncGraphQLRequest<R> copy() {\n+        return new AppSyncGraphQLRequest<R>(this);\n+    }\n+\n+    @Override\n+    public Map<String, Object> getVariables() {\n+        return this.variables;\n+    }\n+\n+    /**\n+     * Used for setting a variable on the request.\n+     * @param key variable name\n+     * @param type type of variable value\n+     * @param value variable value\n+     */\n+    public void setVariable(String key, String type, String value) {\n+        this.variables.put(key, value);\n+        this.variableTypes.put(key, type);\n+    }\n+\n+    /**\n+     * Used to add owner argument from authProvider if needed.\n+     * @param authProvider CognitoUserPoolsAuthProvider for obtaining the username to set as the owner field.\n+     * @throws ApiException if request requires owner argument and authProvider or authProvider.getUsername() is null.\n+     */\n+    public void setAuthProvider(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        for (AuthRule authRule : modelSchema.getAuthRules()) {\n+            if (isOwnerArgumentRequired(authRule.getOperationsOrDefault())) {\n+                setVariable(authRule.getOwnerFieldOrDefault(), \"String!\", getUsername(authProvider));\n+            }\n+        }\n+    }\n+\n+    private String getUsername(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        if (authProvider == null) {\n+            throw new ApiException(\n+                    \"Attempted to subscribe to a model with owner based authorization without a Cognito provider\",\n+                    \"Did you add the AWSCognitoAuthPlugin to Amplify before configuring it?\"\n+            );\n+        }\n+        String username = authProvider.getUsername();\n+        if (username == null) {\n+            throw new ApiException(\n+                    \"Attempted to subscribe to a model with owner based authorization without a username\",\n+                    \"Make sure that a user is logged in before subscribing to a model with owner based auth\"\n+            );\n+        }\n+        return username;\n+    }\n+\n+    private boolean isOwnerArgumentRequired(List<ModelOperation> operations) {\n+        if (SubscriptionType.ON_CREATE.equals(operationType) && operations.contains(ModelOperation.CREATE)) {\n+            return true;\n+        }\n+        if (SubscriptionType.ON_UPDATE.equals(operationType) && operations.contains(ModelOperation.UPDATE)) {\n+            return true;\n+        }\n+        if (SubscriptionType.ON_DELETE.equals(operationType) && operations.contains(ModelOperation.DELETE)) {\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     *  Returns String value used for GraphQL \"query\" in HTTP request body.\n+     *\n+     *  Sample return value:\n+     *      subscription OnCreatePerson(owner: String!, nextToken: String) {\n+     *            onCreatePerson(owner: $owner, nextToken: $nextToken) {\n+     *               age dob first_name id last_name relationship owner\n+     *            }\n+     *       }\n+     *\n+     * @return String value used for GraphQL \"query\" in HTTP request body\n+     */\n+    @Override\n+    public String getQuery() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 166}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNTU2ODM0", "url": "https://github.com/aws-amplify/amplify-android/pull/596#pullrequestreview-440556834", "createdAt": "2020-07-01T05:32:56Z", "commit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "state": "COMMENTED", "comments": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwNTozMjo1N1rOGrXV9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwNjoxMDo1M1rOGrYClw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyNDQwNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            onSubscriptionFailure.accept(exception);\n          \n          \n            \n                            onSubscriptionFailure.accept(exception);\n          \n          \n            \n                            return new NoOpCancelable();\n          \n      \n    \n    \n  \n\n?", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448124407", "createdAt": "2020-07-01T05:32:57Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -255,7 +257,20 @@ public void configure(\n             return null;\n         }\n \n-        SubscriptionOperation<T> operation = SubscriptionOperation.<T>builder()\n+        if (graphQLRequest instanceof AppSyncGraphQLRequest) {\n+            try {\n+                AppSyncGraphQLRequest<R> request = (AppSyncGraphQLRequest<R>) graphQLRequest;\n+                CognitoUserPoolsAuthProvider cognitoProvider = authProvider.getCognitoUserPoolsAuthProvider();\n+                if (cognitoProvider == null) {\n+                    cognitoProvider = new DefaultCognitoUserPoolsAuthProvider();\n+                }\n+                request.setAuthProvider(cognitoProvider);\n+            } catch (ApiException exception) {\n+                onSubscriptionFailure.accept(exception);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyNDY3MQ==", "bodyText": "Hm. I'd spect the factory to return a SelectionSet itself, not an inner type?\nYou could swap, and have a SelectionSet.Factory, an inner class that can create SelectionSet (what used to the be .Node bit)?", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448124671", "createdAt": "2020-07-01T05:33:58Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLRequest.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.annotation.NonNull;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.api.ApiException;\n+import com.amplifyframework.api.aws.appsync.GsonVariablesSerializer;\n+import com.amplifyframework.api.aws.sigv4.CognitoUserPoolsAuthProvider;\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.OperationType;\n+import com.amplifyframework.api.graphql.QueryType;\n+import com.amplifyframework.api.graphql.SubscriptionType;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelOperation;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.Casing;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * A request against an AppSync GraphQL endpoint.\n+ * @param <R> The type of data contained in the GraphQLResponse expected from this request.\n+ */\n+public final class AppSyncGraphQLRequest<R> extends GraphQLRequest<R> {\n+    private static final int DEFAULT_LEVEL_DEPTH = 2;\n+\n+    private final ModelSchema modelSchema;\n+    private final OperationType operationType;\n+    private final SelectionSet.Node selectionSet;\n+    private final Map<String, Object> variables;\n+    private final Map<String, String> variableTypes;\n+\n+    /**\n+     * Constructor for AppSyncGraphQLRequest.\n+     * @throw AmplifyException if a ModelSchema can't be derived from the provided model class\n+     */\n+    private AppSyncGraphQLRequest(Builder builder) throws AmplifyException {\n+        super(builder.responseType, new GsonVariablesSerializer());\n+        this.modelSchema = ModelSchema.fromModelClass(builder.modelClass);\n+        SelectionSet.Node set = SelectionSet.fromModelClass(builder.modelClass, DEFAULT_LEVEL_DEPTH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyNTA0MA==", "bodyText": "Could you pass an OperationType into the factory method, and then have it figure this stuff out internally?\nLike:\nthis.selectionSet = SelectionSet.create(builder.modelClass, operationType, DEFAULT_LEVEL_DEPTH)", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448125040", "createdAt": "2020-07-01T05:35:11Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLRequest.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.annotation.NonNull;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.api.ApiException;\n+import com.amplifyframework.api.aws.appsync.GsonVariablesSerializer;\n+import com.amplifyframework.api.aws.sigv4.CognitoUserPoolsAuthProvider;\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.OperationType;\n+import com.amplifyframework.api.graphql.QueryType;\n+import com.amplifyframework.api.graphql.SubscriptionType;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelOperation;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.Casing;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * A request against an AppSync GraphQL endpoint.\n+ * @param <R> The type of data contained in the GraphQLResponse expected from this request.\n+ */\n+public final class AppSyncGraphQLRequest<R> extends GraphQLRequest<R> {\n+    private static final int DEFAULT_LEVEL_DEPTH = 2;\n+\n+    private final ModelSchema modelSchema;\n+    private final OperationType operationType;\n+    private final SelectionSet.Node selectionSet;\n+    private final Map<String, Object> variables;\n+    private final Map<String, String> variableTypes;\n+\n+    /**\n+     * Constructor for AppSyncGraphQLRequest.\n+     * @throw AmplifyException if a ModelSchema can't be derived from the provided model class\n+     */\n+    private AppSyncGraphQLRequest(Builder builder) throws AmplifyException {\n+        super(builder.responseType, new GsonVariablesSerializer());\n+        this.modelSchema = ModelSchema.fromModelClass(builder.modelClass);\n+        SelectionSet.Node set = SelectionSet.fromModelClass(builder.modelClass, DEFAULT_LEVEL_DEPTH);\n+        if (QueryType.LIST.equals(builder.operationType)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyNjQ0NQ==", "bodyText": "These are great recovery suggestions, nice.", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448126445", "createdAt": "2020-07-01T05:39:54Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLRequest.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.annotation.NonNull;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.api.ApiException;\n+import com.amplifyframework.api.aws.appsync.GsonVariablesSerializer;\n+import com.amplifyframework.api.aws.sigv4.CognitoUserPoolsAuthProvider;\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.OperationType;\n+import com.amplifyframework.api.graphql.QueryType;\n+import com.amplifyframework.api.graphql.SubscriptionType;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelOperation;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.Casing;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * A request against an AppSync GraphQL endpoint.\n+ * @param <R> The type of data contained in the GraphQLResponse expected from this request.\n+ */\n+public final class AppSyncGraphQLRequest<R> extends GraphQLRequest<R> {\n+    private static final int DEFAULT_LEVEL_DEPTH = 2;\n+\n+    private final ModelSchema modelSchema;\n+    private final OperationType operationType;\n+    private final SelectionSet.Node selectionSet;\n+    private final Map<String, Object> variables;\n+    private final Map<String, String> variableTypes;\n+\n+    /**\n+     * Constructor for AppSyncGraphQLRequest.\n+     * @throw AmplifyException if a ModelSchema can't be derived from the provided model class\n+     */\n+    private AppSyncGraphQLRequest(Builder builder) throws AmplifyException {\n+        super(builder.responseType, new GsonVariablesSerializer());\n+        this.modelSchema = ModelSchema.fromModelClass(builder.modelClass);\n+        SelectionSet.Node set = SelectionSet.fromModelClass(builder.modelClass, DEFAULT_LEVEL_DEPTH);\n+        if (QueryType.LIST.equals(builder.operationType)) {\n+            set = SelectionSet.wrapPagination(set);\n+        }\n+        this.selectionSet = set;\n+        this.operationType = builder.operationType;\n+        this.variables = builder.variables;\n+        this.variableTypes = builder.variableTypes;\n+    }\n+\n+    /**\n+     * Copy constructor for an AppSyncGraphQLRequest.\n+     * @param request request to copy.\n+     * @param <R> response type.\n+     */\n+    public <R> AppSyncGraphQLRequest(AppSyncGraphQLRequest<R> request) {\n+        super(request);\n+        this.modelSchema = request.modelSchema;\n+        this.operationType = request.operationType;\n+        this.selectionSet = new SelectionSet.Node(request.selectionSet);\n+        this.variables = new HashMap<>(request.variables);\n+        this.variableTypes = new HashMap<>(request.variableTypes);\n+    }\n+\n+    @Override\n+    public <R> AppSyncGraphQLRequest<R> copy() {\n+        return new AppSyncGraphQLRequest<R>(this);\n+    }\n+\n+    @Override\n+    public Map<String, Object> getVariables() {\n+        return this.variables;\n+    }\n+\n+    /**\n+     * Used for setting a variable on the request.\n+     * @param key variable name\n+     * @param type type of variable value\n+     * @param value variable value\n+     */\n+    public void setVariable(String key, String type, String value) {\n+        this.variables.put(key, value);\n+        this.variableTypes.put(key, type);\n+    }\n+\n+    /**\n+     * Used to add owner argument from authProvider if needed.\n+     * @param authProvider CognitoUserPoolsAuthProvider for obtaining the username to set as the owner field.\n+     * @throws ApiException if request requires owner argument and authProvider or authProvider.getUsername() is null.\n+     */\n+    public void setAuthProvider(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        for (AuthRule authRule : modelSchema.getAuthRules()) {\n+            if (isOwnerArgumentRequired(authRule.getOperationsOrDefault())) {\n+                setVariable(authRule.getOwnerFieldOrDefault(), \"String!\", getUsername(authProvider));\n+            }\n+        }\n+    }\n+\n+    private String getUsername(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        if (authProvider == null) {\n+            throw new ApiException(\n+                    \"Attempted to subscribe to a model with owner based authorization without a Cognito provider\",\n+                    \"Did you add the AWSCognitoAuthPlugin to Amplify before configuring it?\"\n+            );\n+        }\n+        String username = authProvider.getUsername();\n+        if (username == null) {\n+            throw new ApiException(\n+                    \"Attempted to subscribe to a model with owner based authorization without a username\",\n+                    \"Make sure that a user is logged in before subscribing to a model with owner based auth\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyNzQzNA==", "bodyText": "Since there are three repeated control flow stanzas, maybe it is time to reconsider the input data type, so that you can re-use the control flow.\nList<Pair<SubscriptionType, ModelOperation>> pairs = Arrays.asList(\n    Pair.create(SubscriptionType.ON_CREATE, ModelOperation.CREATE),\n    Pair.create(SubscriptionType.ON_UPDATE, ModelOperation.UPDATE),\n    Pair.create(SubscriptionType.ON_DELETE, ModelOperation.DELETE)\n);\nfor (Pair<SubscriptionType, ModelOperation> pair : pairs) {\n    if (pair.getFirst().equals(operationType) && operations.contains(pair.getSecond())) {\n        return true;\n    }\n}\nreturn false;\nActually, meh. DAMP, YAGNI, KISS... I think it's just more complicated.", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448127434", "createdAt": "2020-07-01T05:43:29Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLRequest.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.annotation.NonNull;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.api.ApiException;\n+import com.amplifyframework.api.aws.appsync.GsonVariablesSerializer;\n+import com.amplifyframework.api.aws.sigv4.CognitoUserPoolsAuthProvider;\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.OperationType;\n+import com.amplifyframework.api.graphql.QueryType;\n+import com.amplifyframework.api.graphql.SubscriptionType;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelOperation;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.Casing;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * A request against an AppSync GraphQL endpoint.\n+ * @param <R> The type of data contained in the GraphQLResponse expected from this request.\n+ */\n+public final class AppSyncGraphQLRequest<R> extends GraphQLRequest<R> {\n+    private static final int DEFAULT_LEVEL_DEPTH = 2;\n+\n+    private final ModelSchema modelSchema;\n+    private final OperationType operationType;\n+    private final SelectionSet.Node selectionSet;\n+    private final Map<String, Object> variables;\n+    private final Map<String, String> variableTypes;\n+\n+    /**\n+     * Constructor for AppSyncGraphQLRequest.\n+     * @throw AmplifyException if a ModelSchema can't be derived from the provided model class\n+     */\n+    private AppSyncGraphQLRequest(Builder builder) throws AmplifyException {\n+        super(builder.responseType, new GsonVariablesSerializer());\n+        this.modelSchema = ModelSchema.fromModelClass(builder.modelClass);\n+        SelectionSet.Node set = SelectionSet.fromModelClass(builder.modelClass, DEFAULT_LEVEL_DEPTH);\n+        if (QueryType.LIST.equals(builder.operationType)) {\n+            set = SelectionSet.wrapPagination(set);\n+        }\n+        this.selectionSet = set;\n+        this.operationType = builder.operationType;\n+        this.variables = builder.variables;\n+        this.variableTypes = builder.variableTypes;\n+    }\n+\n+    /**\n+     * Copy constructor for an AppSyncGraphQLRequest.\n+     * @param request request to copy.\n+     * @param <R> response type.\n+     */\n+    public <R> AppSyncGraphQLRequest(AppSyncGraphQLRequest<R> request) {\n+        super(request);\n+        this.modelSchema = request.modelSchema;\n+        this.operationType = request.operationType;\n+        this.selectionSet = new SelectionSet.Node(request.selectionSet);\n+        this.variables = new HashMap<>(request.variables);\n+        this.variableTypes = new HashMap<>(request.variableTypes);\n+    }\n+\n+    @Override\n+    public <R> AppSyncGraphQLRequest<R> copy() {\n+        return new AppSyncGraphQLRequest<R>(this);\n+    }\n+\n+    @Override\n+    public Map<String, Object> getVariables() {\n+        return this.variables;\n+    }\n+\n+    /**\n+     * Used for setting a variable on the request.\n+     * @param key variable name\n+     * @param type type of variable value\n+     * @param value variable value\n+     */\n+    public void setVariable(String key, String type, String value) {\n+        this.variables.put(key, value);\n+        this.variableTypes.put(key, type);\n+    }\n+\n+    /**\n+     * Used to add owner argument from authProvider if needed.\n+     * @param authProvider CognitoUserPoolsAuthProvider for obtaining the username to set as the owner field.\n+     * @throws ApiException if request requires owner argument and authProvider or authProvider.getUsername() is null.\n+     */\n+    public void setAuthProvider(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        for (AuthRule authRule : modelSchema.getAuthRules()) {\n+            if (isOwnerArgumentRequired(authRule.getOperationsOrDefault())) {\n+                setVariable(authRule.getOwnerFieldOrDefault(), \"String!\", getUsername(authProvider));\n+            }\n+        }\n+    }\n+\n+    private String getUsername(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        if (authProvider == null) {\n+            throw new ApiException(\n+                    \"Attempted to subscribe to a model with owner based authorization without a Cognito provider\",\n+                    \"Did you add the AWSCognitoAuthPlugin to Amplify before configuring it?\"\n+            );\n+        }\n+        String username = authProvider.getUsername();\n+        if (username == null) {\n+            throw new ApiException(\n+                    \"Attempted to subscribe to a model with owner based authorization without a username\",\n+                    \"Make sure that a user is logged in before subscribing to a model with owner based auth\"\n+            );\n+        }\n+        return username;\n+    }\n+\n+    private boolean isOwnerArgumentRequired(List<ModelOperation> operations) {\n+        if (SubscriptionType.ON_CREATE.equals(operationType) && operations.contains(ModelOperation.CREATE)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyODk2Mg==", "bodyText": "We have the Empty utility in core:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (this.operations == null || this.operations.isEmpty()) {\n          \n          \n            \n                    if (Empty.check(this.operations)) {", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448128962", "createdAt": "2020-07-01T05:48:38Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/core/model/AuthRule.java", "diffHunk": "@@ -100,16 +102,23 @@ public String getGroupClaim() {\n      * @return name of a {@link ModelField} of type String or array of Strings which specifies a group or list of groups\n      * which should have access.\n      */\n-    public String getGroupsField() {\n-        return this.groupsField;\n+    public String getGroupsFieldOrDefault() {\n+        return TextUtils.isEmpty(this.groupsField) ? \"groups\" : this.groupsField;\n     }\n \n     /**\n      * Specifies which {@link ModelOperation}s are protected by this {@link AuthRule}.  Any operations not included in\n      * the list are not protected by default.\n      * @return list of {@link ModelOperation}s for which this {@link AuthRule} should apply.\n      */\n-    public ModelOperation[] getOperations() {\n+    public List<ModelOperation> getOperationsOrDefault() {\n+        if (this.operations == null || this.operations.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEzMDI4Ng==", "bodyText": "Should the OperationType be an enum, if there is a constrained set of values that can be returned here?\nIf you need to maintain the interface for other purposes, perhaps you can do it likeso:\ninterface Operation {\n    OperationType getOperationType();\n}\n\nenum OperationType {\n    QUERY(\"query\"),\n    SUBSCRIPTION(\"subscription\"),\n    MuTATION(\"mutation\");\n}\n\n/* open */ class Mutation implements Operation {\n    @Override\n    public OperationType getOperationType() {\n        return OperationType.MUTATION;\n    }\n}\n...\nOr -- to get the per-operation-type enum involved, too:\ninterface Operation<E extends Enum<E>> {\n    E getOperationType();\n}\n\nabstract class Mutation implements Operation<MutationType> {\n    // Implementer must return MutationType.CREATE, etc.\n    abstract MutationType getOperationType();\n}\n\nenum MutationType {\n    // Like you have it right now\n}\n...", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448130286", "createdAt": "2020-07-01T05:52:53Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/api/graphql/OperationType.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.graphql;\n+\n+/**\n+ * Represents a GraphQL operation type.\n+ */\n+public interface OperationType {\n+    /**\n+     * Returns the name of the operation to be used in the GraphQL document (i.e. query, subscription, or mutation).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEzMTgwOA==", "bodyText": "A few opportunities for Wrap.inDoubleQuotes, here?", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448131808", "createdAt": "2020-07-01T05:57:52Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/api/graphql/GraphQLRequest.java", "diffHunk": "@@ -86,73 +60,33 @@ public GraphQLRequest(\n      * @param <R> The type of data contained in the GraphQLResponse expected from this request.\n      * @return Copy of the GraphQLRequest object\n      */\n-    public <R> GraphQLRequest<R> copy() {\n-        return new GraphQLRequest<R>(this);\n-    }\n+    public abstract <R> GraphQLRequest<R> copy();\n \n     /**\n-     * Processes query parameters into a query string to\n-     * be used as HTTP request body.\n-     * @return processed query string\n+     * Returns the GraphQL document which is set as \"query\" in the request.\n+     * @return the GraphQL document which is set as \"query\" in the request.\n      */\n-    public String getContent() {\n-        final StringBuilder completeQuery = new StringBuilder();\n-        final StringBuilder realQuery = new StringBuilder();\n-\n-        completeQuery.append(\"{\\\"query\\\":\")\n-                .append(\"\\\"\");\n-\n-        realQuery.append(document\n-                .replace(\"\\\"\", \"\\\\\\\"\")\n-                .replace(\"\\n\", \"\\\\n\")\n-        );\n-\n-        for (String fragment : fragments) {\n-            realQuery\n-                    .append(\"fragment \")\n-                    .append(fragment);\n-        }\n-\n-        completeQuery.append(realQuery)\n-                .append(\"\\\"\")\n-                .append(\",\")\n-                .append(\"\\\"variables\\\":\");\n-\n-        if (variables.isEmpty()) {\n-            completeQuery.append(\"null\");\n-        } else {\n-            completeQuery.append(variablesSerializer.serialize(this.variables));\n-        }\n-\n-        completeQuery.append(\"}\");\n-        String contentString = completeQuery.toString();\n-\n-        while (contentString.contains(\"\\\\\\\\\")) {\n-            contentString = contentString.replace(\"\\\\\\\\\", \"\\\\\");\n-        }\n-\n-        return contentString + \"\\n\";\n-    }\n+    public abstract String getQuery();\n \n     /**\n-     * Attaches variable key-value pair.\n-     * @param key variable name\n-     * @param value variable value\n-     * @return this query object for chaining\n+     * Returns Map of variables to be serialized and set as \"variables\" in the request.\n+     * @return Map of variables to be serialized and set as \"variables\" in the request.\n      */\n-    public GraphQLRequest<R> putVariable(String key, Object value) {\n-        variables.put(key, value);\n-        return this;\n-    }\n+    public abstract Map<String, Object> getVariables();\n \n     /**\n-     * Attaches a fragment.\n-     * @param fragment fragment\n-     * @return this query object for chaining\n+     * Processes query parameters into a query string to\n+     * be used as HTTP request body.\n+     * @return processed query string\n      */\n-    public GraphQLRequest<R> addFragment(String fragment) {\n-        fragments.add(fragment);\n-        return this;\n+    public String getContent() {\n+        String query = getQuery()\n+                .replace(\"\\\"\", \"\\\\\\\"\")\n+                .replace(\"\\n\", \"\\\\n\");\n+\n+        return Wrap.inBraces(TextUtils.join(\", \", Arrays.asList(\n+            \"\\\"query\\\": \\\"\" + query + \"\\\"\",\n+            \"\\\"variables\\\": \" + (getVariables().isEmpty() ? null : variablesSerializer.serialize(getVariables())))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEzMjE3Mg==", "bodyText": "Did you consider overriding the Object#clone()? Though, perhaps you can't enforce the extending class to implement it, since it is already present in Object as a non-abstract method?", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448132172", "createdAt": "2020-07-01T05:59:06Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/api/graphql/GraphQLRequest.java", "diffHunk": "@@ -86,73 +60,33 @@ public GraphQLRequest(\n      * @param <R> The type of data contained in the GraphQLResponse expected from this request.\n      * @return Copy of the GraphQLRequest object\n      */\n-    public <R> GraphQLRequest<R> copy() {\n-        return new GraphQLRequest<R>(this);\n-    }\n+    public abstract <R> GraphQLRequest<R> copy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEzMzAyMA==", "bodyText": "Are you able to get rid of the .trim() by modifying the contents of the selection-set-post.txt?", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448133020", "createdAt": "2020-07-01T06:01:51Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/test/java/com/amplifyframework/api/aws/SelectionSetTest.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.testmodels.commentsblog.Post;\n+import com.amplifyframework.testmodels.ownerauth.OwnerAuth;\n+import com.amplifyframework.testutils.Resources;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+@RunWith(RobolectricTestRunner.class)\n+public class SelectionSetTest {\n+    /**\n+     * Test that selection set serialization works as expected.\n+     * @throws AmplifyException if a ModelSchema can't be derived from Post.class\n+     */\n+    @Test\n+    public void selectionSetSerializesToExpectedValue() throws AmplifyException {\n+        SelectionSet.Node selectionSet = SelectionSet.fromModelClass(Post.class, 2);\n+        assertEquals(Resources.readAsString(\"selection-set-post.txt\").trim(), selectionSet.toString().trim());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEzMzI3Mw==", "bodyText": "Can you add - chars to this file name, so its easier to read?", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448133273", "createdAt": "2020-07-01T06:02:43Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/test/java/com/amplifyframework/api/aws/AWSApiPluginTest.java", "diffHunk": "@@ -222,6 +237,63 @@ public void graphQlMutationGetsResponse() throws JSONException, ApiException {\n         assertEquals(expectedName, actualResponse.getData().getName());\n     }\n \n+    /**\n+     * Test that owner variable is added to subscription when needed.\n+     * @throws JSONException from JSONAssert.assertEquals\n+     */\n+    @Test\n+    public void graphQlSubscriptionAddsOwnerVariable() throws JSONException {\n+        GraphQLRequest<OwnerAuth> request = ModelSubscription.onCreate(OwnerAuth.class);\n+        plugin.subscribe(request,\n+            subscriptionId -> { },\n+            response -> { },\n+            exception -> { },\n+            EmptyAction.instance());\n+\n+        JSONAssert.assertEquals(Resources.readAsString(\"request-ownerauth.json\"),\n+                request.getContent(),\n+                true);\n+    }\n+\n+    /**\n+     * Verify that the custom owner field variable is added to subscription when needed.\n+     * @throws JSONException from JSONAssert.assertEquals\n+     */\n+    @Test\n+    public void graphQLSubscriptionAddsCustomOwnerField() throws JSONException {\n+        GraphQLRequest<OwnerAuthCustomField> request = ModelSubscription.onUpdate(OwnerAuthCustomField.class);\n+        plugin.subscribe(request,\n+            subscriptionId -> { },\n+            response -> { },\n+            exception -> { },\n+            EmptyAction.instance());\n+\n+        JSONAssert.assertEquals(Resources.readAsString(\"request-ownerauthcustomfield.json\"),\n+                request.getContent(),\n+                true);\n+    }\n+\n+    /**\n+     * Verify that the `owner` variable is only added if the type of subscription (onCreate, onUpdate, onDelete) is\n+     * protected by owner based auth.  This test uses OwnerAuthReadUpdateOnly which protects create, and delete\n+     * operations, but not update, so an onUpdate subscription is not expected to include the `owner` variable.\n+     *\n+     * @throws JSONException from JSONAssert.assertEquals\n+     */\n+    @Test\n+    public void graphQLSubscriptionDoesntAddOwnerFieldIfTypeIsNotProtected() throws JSONException {\n+        GraphQLRequest<OwnerAuthReadUpdateOnly> request = ModelSubscription.onUpdate(OwnerAuthReadUpdateOnly.class);\n+        plugin.subscribe(request,\n+            subscriptionId -> { },\n+            response -> { },\n+            exception -> { },\n+            EmptyAction.instance());\n+\n+        JSONAssert.assertEquals(Resources.readAsString(\"request-ownerauthreadupdateonly.json\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEzMzYzNA==", "bodyText": "Do we have an EmptyConsumer or NoOpConsumer somewhere, right now? I think so. If you use the EmptyAction.instance(), it would be nice to keep all of these in a similar manner of expression. (Same for above, in this test file, too.)", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448133634", "createdAt": "2020-07-01T06:03:54Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/test/java/com/amplifyframework/api/aws/AWSApiPluginTest.java", "diffHunk": "@@ -222,6 +237,63 @@ public void graphQlMutationGetsResponse() throws JSONException, ApiException {\n         assertEquals(expectedName, actualResponse.getData().getName());\n     }\n \n+    /**\n+     * Test that owner variable is added to subscription when needed.\n+     * @throws JSONException from JSONAssert.assertEquals\n+     */\n+    @Test\n+    public void graphQlSubscriptionAddsOwnerVariable() throws JSONException {\n+        GraphQLRequest<OwnerAuth> request = ModelSubscription.onCreate(OwnerAuth.class);\n+        plugin.subscribe(request,\n+            subscriptionId -> { },\n+            response -> { },\n+            exception -> { },\n+            EmptyAction.instance());\n+\n+        JSONAssert.assertEquals(Resources.readAsString(\"request-ownerauth.json\"),\n+                request.getContent(),\n+                true);\n+    }\n+\n+    /**\n+     * Verify that the custom owner field variable is added to subscription when needed.\n+     * @throws JSONException from JSONAssert.assertEquals\n+     */\n+    @Test\n+    public void graphQLSubscriptionAddsCustomOwnerField() throws JSONException {\n+        GraphQLRequest<OwnerAuthCustomField> request = ModelSubscription.onUpdate(OwnerAuthCustomField.class);\n+        plugin.subscribe(request,\n+            subscriptionId -> { },\n+            response -> { },\n+            exception -> { },\n+            EmptyAction.instance());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEzNDA2NQ==", "bodyText": "if (!Empty.check(nodes)) {", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448134065", "createdAt": "2020-07-01T06:05:20Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SelectionSet.java", "diffHunk": "@@ -0,0 +1,185 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.AuthStrategy;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.FieldFinder;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.ParameterizedType;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+/**\n+ * Class for creating and serializing a selection set within a GraphQL document.\n+ */\n+final class SelectionSet {\n+    private static final String ITEMS_KEY = \"items\";\n+    private static final String NEXT_TOKEN_KEY = \"nextToken\";\n+\n+    // This class should not be instantiated\n+    private SelectionSet() {}\n+\n+    /**\n+     * Returns selection set containing the fields of the provided model class, as well as nested models.\n+     * @param modelClass model class\n+     * @return selection set containing all of the fields of the provided model class\n+     * @throws AmplifyException if a ModelSchema cannot be created from the provided model class.\n+     */\n+    public static Node fromModelClass(Class<? extends Model> modelClass, int depth) throws AmplifyException {\n+        return new Node(null, getModelFields(modelClass, depth));\n+    }\n+\n+    /**\n+     * Expects a {@link Node} containing {@link Model} fields as nodes, and returns a new root node with two children:\n+     *  - \"items\" with nodes being the children of the provided node.\n+     *  - \"nextToken\"\n+     *\n+     * @param node a root node, with a value of null, and pagination fields\n+     * @return\n+     */\n+    public static Node wrapPagination(Node node) {\n+        return new Node(null, wrapPagination(node.nodes));\n+    }\n+\n+    private static Set<Node> wrapPagination(Set<Node> nodes) {\n+        Set<Node> paginatedSet = new HashSet<>();\n+        paginatedSet.add(new Node(ITEMS_KEY, nodes));\n+        paginatedSet.add(new Node(NEXT_TOKEN_KEY, null));\n+        return paginatedSet;\n+    }\n+\n+    @SuppressWarnings(\"unchecked\") // Cast to Class<Model>\n+    private static Set<Node> getModelFields(Class<? extends Model> clazz, int depth)\n+            throws AmplifyException {\n+        if (depth < 0) {\n+            return new HashSet<>();\n+        }\n+\n+        Set<Node> result = new HashSet<>();\n+        ModelSchema schema = ModelSchema.fromModelClass(clazz);\n+        for (Field field : FieldFinder.findFieldsIn(clazz)) {\n+            String fieldName = field.getName();\n+            if (schema.getAssociations().containsKey(fieldName)) {\n+                if (List.class.isAssignableFrom(field.getType())) {\n+                    if (depth >= 1) {\n+                        ParameterizedType listType = (ParameterizedType) field.getGenericType();\n+                        Class<Model> listTypeClass = (Class<Model>) listType.getActualTypeArguments()[0];\n+                        Set<Node> fields = wrapPagination(getModelFields(listTypeClass, depth - 1));\n+                        result.add(new Node(fieldName, fields));\n+                    }\n+                } else if (depth >= 1) {\n+                    Set<Node> fields = getModelFields((Class<Model>) field.getType(), depth - 1);\n+                    result.add(new Node(fieldName, fields));\n+                }\n+            } else {\n+                result.add(new Node(fieldName, null));\n+            }\n+            for (AuthRule authRule : schema.getAuthRules()) {\n+                if (AuthStrategy.OWNER.equals(authRule.getAuthStrategy())) {\n+                    result.add(new Node(authRule.getOwnerFieldOrDefault(), null));\n+                    break;\n+                }\n+            }\n+        }\n+        return result;\n+    }\n+\n+    static final class Node {\n+        private final String value;\n+        private final Set<Node> nodes;\n+\n+        /**\n+         * Copy constructor.\n+         * @param node node to copy\n+         */\n+        Node(Node node) {\n+            this.value = node.value;\n+            this.nodes = new HashSet<>(node.nodes);\n+        }\n+\n+        private Node(String value, Set<Node> nodes) {\n+            this.value = value;\n+            this.nodes = nodes;\n+        }\n+\n+        /**\n+         * Generate the String value of the SelectionSet used in the GraphQL query document.\n+         *\n+         * Sample return value:\n+         *   items {\n+         *     foo\n+         *     bar\n+         *     modelName {\n+         *       foo\n+         *       bar\n+         *     }\n+         *   }\n+         *   nextToken\n+         *\n+         * @return String value of the selection set for a GraphQL query document.\n+         */\n+        @Override\n+        public String toString() {\n+            List<String> fieldsList = new ArrayList<>();\n+            StringBuilder builder = new StringBuilder();\n+\n+            if (value != null) {\n+                builder.append(value);\n+            }\n+\n+            if (nodes != null && nodes.size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEzNDM4MQ==", "bodyText": "Nice docs", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448134381", "createdAt": "2020-07-01T06:06:15Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SelectionSet.java", "diffHunk": "@@ -0,0 +1,185 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.AuthStrategy;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.FieldFinder;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.ParameterizedType;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+/**\n+ * Class for creating and serializing a selection set within a GraphQL document.\n+ */\n+final class SelectionSet {\n+    private static final String ITEMS_KEY = \"items\";\n+    private static final String NEXT_TOKEN_KEY = \"nextToken\";\n+\n+    // This class should not be instantiated\n+    private SelectionSet() {}\n+\n+    /**\n+     * Returns selection set containing the fields of the provided model class, as well as nested models.\n+     * @param modelClass model class\n+     * @return selection set containing all of the fields of the provided model class\n+     * @throws AmplifyException if a ModelSchema cannot be created from the provided model class.\n+     */\n+    public static Node fromModelClass(Class<? extends Model> modelClass, int depth) throws AmplifyException {\n+        return new Node(null, getModelFields(modelClass, depth));\n+    }\n+\n+    /**\n+     * Expects a {@link Node} containing {@link Model} fields as nodes, and returns a new root node with two children:\n+     *  - \"items\" with nodes being the children of the provided node.\n+     *  - \"nextToken\"\n+     *\n+     * @param node a root node, with a value of null, and pagination fields\n+     * @return\n+     */\n+    public static Node wrapPagination(Node node) {\n+        return new Node(null, wrapPagination(node.nodes));\n+    }\n+\n+    private static Set<Node> wrapPagination(Set<Node> nodes) {\n+        Set<Node> paginatedSet = new HashSet<>();\n+        paginatedSet.add(new Node(ITEMS_KEY, nodes));\n+        paginatedSet.add(new Node(NEXT_TOKEN_KEY, null));\n+        return paginatedSet;\n+    }\n+\n+    @SuppressWarnings(\"unchecked\") // Cast to Class<Model>\n+    private static Set<Node> getModelFields(Class<? extends Model> clazz, int depth)\n+            throws AmplifyException {\n+        if (depth < 0) {\n+            return new HashSet<>();\n+        }\n+\n+        Set<Node> result = new HashSet<>();\n+        ModelSchema schema = ModelSchema.fromModelClass(clazz);\n+        for (Field field : FieldFinder.findFieldsIn(clazz)) {\n+            String fieldName = field.getName();\n+            if (schema.getAssociations().containsKey(fieldName)) {\n+                if (List.class.isAssignableFrom(field.getType())) {\n+                    if (depth >= 1) {\n+                        ParameterizedType listType = (ParameterizedType) field.getGenericType();\n+                        Class<Model> listTypeClass = (Class<Model>) listType.getActualTypeArguments()[0];\n+                        Set<Node> fields = wrapPagination(getModelFields(listTypeClass, depth - 1));\n+                        result.add(new Node(fieldName, fields));\n+                    }\n+                } else if (depth >= 1) {\n+                    Set<Node> fields = getModelFields((Class<Model>) field.getType(), depth - 1);\n+                    result.add(new Node(fieldName, fields));\n+                }\n+            } else {\n+                result.add(new Node(fieldName, null));\n+            }\n+            for (AuthRule authRule : schema.getAuthRules()) {\n+                if (AuthStrategy.OWNER.equals(authRule.getAuthStrategy())) {\n+                    result.add(new Node(authRule.getOwnerFieldOrDefault(), null));\n+                    break;\n+                }\n+            }\n+        }\n+        return result;\n+    }\n+\n+    static final class Node {\n+        private final String value;\n+        private final Set<Node> nodes;\n+\n+        /**\n+         * Copy constructor.\n+         * @param node node to copy\n+         */\n+        Node(Node node) {\n+            this.value = node.value;\n+            this.nodes = new HashSet<>(node.nodes);\n+        }\n+\n+        private Node(String value, Set<Node> nodes) {\n+            this.value = value;\n+            this.nodes = nodes;\n+        }\n+\n+        /**\n+         * Generate the String value of the SelectionSet used in the GraphQL query document.\n+         *\n+         * Sample return value:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEzNDU2Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        this.value = node.value;\n          \n          \n            \n                        this.nodes = new HashSet<>(node.nodes);\n          \n          \n            \n                        this(value, new HashSset<>(node.nodes));", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448134566", "createdAt": "2020-07-01T06:06:52Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SelectionSet.java", "diffHunk": "@@ -0,0 +1,185 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.AuthStrategy;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.FieldFinder;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.ParameterizedType;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+/**\n+ * Class for creating and serializing a selection set within a GraphQL document.\n+ */\n+final class SelectionSet {\n+    private static final String ITEMS_KEY = \"items\";\n+    private static final String NEXT_TOKEN_KEY = \"nextToken\";\n+\n+    // This class should not be instantiated\n+    private SelectionSet() {}\n+\n+    /**\n+     * Returns selection set containing the fields of the provided model class, as well as nested models.\n+     * @param modelClass model class\n+     * @return selection set containing all of the fields of the provided model class\n+     * @throws AmplifyException if a ModelSchema cannot be created from the provided model class.\n+     */\n+    public static Node fromModelClass(Class<? extends Model> modelClass, int depth) throws AmplifyException {\n+        return new Node(null, getModelFields(modelClass, depth));\n+    }\n+\n+    /**\n+     * Expects a {@link Node} containing {@link Model} fields as nodes, and returns a new root node with two children:\n+     *  - \"items\" with nodes being the children of the provided node.\n+     *  - \"nextToken\"\n+     *\n+     * @param node a root node, with a value of null, and pagination fields\n+     * @return\n+     */\n+    public static Node wrapPagination(Node node) {\n+        return new Node(null, wrapPagination(node.nodes));\n+    }\n+\n+    private static Set<Node> wrapPagination(Set<Node> nodes) {\n+        Set<Node> paginatedSet = new HashSet<>();\n+        paginatedSet.add(new Node(ITEMS_KEY, nodes));\n+        paginatedSet.add(new Node(NEXT_TOKEN_KEY, null));\n+        return paginatedSet;\n+    }\n+\n+    @SuppressWarnings(\"unchecked\") // Cast to Class<Model>\n+    private static Set<Node> getModelFields(Class<? extends Model> clazz, int depth)\n+            throws AmplifyException {\n+        if (depth < 0) {\n+            return new HashSet<>();\n+        }\n+\n+        Set<Node> result = new HashSet<>();\n+        ModelSchema schema = ModelSchema.fromModelClass(clazz);\n+        for (Field field : FieldFinder.findFieldsIn(clazz)) {\n+            String fieldName = field.getName();\n+            if (schema.getAssociations().containsKey(fieldName)) {\n+                if (List.class.isAssignableFrom(field.getType())) {\n+                    if (depth >= 1) {\n+                        ParameterizedType listType = (ParameterizedType) field.getGenericType();\n+                        Class<Model> listTypeClass = (Class<Model>) listType.getActualTypeArguments()[0];\n+                        Set<Node> fields = wrapPagination(getModelFields(listTypeClass, depth - 1));\n+                        result.add(new Node(fieldName, fields));\n+                    }\n+                } else if (depth >= 1) {\n+                    Set<Node> fields = getModelFields((Class<Model>) field.getType(), depth - 1);\n+                    result.add(new Node(fieldName, fields));\n+                }\n+            } else {\n+                result.add(new Node(fieldName, null));\n+            }\n+            for (AuthRule authRule : schema.getAuthRules()) {\n+                if (AuthStrategy.OWNER.equals(authRule.getAuthStrategy())) {\n+                    result.add(new Node(authRule.getOwnerFieldOrDefault(), null));\n+                    break;\n+                }\n+            }\n+        }\n+        return result;\n+    }\n+\n+    static final class Node {\n+        private final String value;\n+        private final Set<Node> nodes;\n+\n+        /**\n+         * Copy constructor.\n+         * @param node node to copy\n+         */\n+        Node(Node node) {\n+            this.value = node.value;\n+            this.nodes = new HashSet<>(node.nodes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEzNDgwMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private Map<String, Object> variables;\n          \n          \n            \n                    private Map<String, String> variableTypes;\n          \n          \n            \n                    private final Map<String, Object> variables;\n          \n          \n            \n                    private final Map<String, String> variableTypes;", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448134802", "createdAt": "2020-07-01T06:07:43Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLRequest.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.annotation.NonNull;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.api.ApiException;\n+import com.amplifyframework.api.aws.appsync.GsonVariablesSerializer;\n+import com.amplifyframework.api.aws.sigv4.CognitoUserPoolsAuthProvider;\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.OperationType;\n+import com.amplifyframework.api.graphql.QueryType;\n+import com.amplifyframework.api.graphql.SubscriptionType;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelOperation;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.Casing;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * A request against an AppSync GraphQL endpoint.\n+ * @param <R> The type of data contained in the GraphQLResponse expected from this request.\n+ */\n+public final class AppSyncGraphQLRequest<R> extends GraphQLRequest<R> {\n+    private static final int DEFAULT_LEVEL_DEPTH = 2;\n+\n+    private final ModelSchema modelSchema;\n+    private final OperationType operationType;\n+    private final SelectionSet.Node selectionSet;\n+    private final Map<String, Object> variables;\n+    private final Map<String, String> variableTypes;\n+\n+    /**\n+     * Constructor for AppSyncGraphQLRequest.\n+     * @throw AmplifyException if a ModelSchema can't be derived from the provided model class\n+     */\n+    private AppSyncGraphQLRequest(Builder builder) throws AmplifyException {\n+        super(builder.responseType, new GsonVariablesSerializer());\n+        this.modelSchema = ModelSchema.fromModelClass(builder.modelClass);\n+        SelectionSet.Node set = SelectionSet.fromModelClass(builder.modelClass, DEFAULT_LEVEL_DEPTH);\n+        if (QueryType.LIST.equals(builder.operationType)) {\n+            set = SelectionSet.wrapPagination(set);\n+        }\n+        this.selectionSet = set;\n+        this.operationType = builder.operationType;\n+        this.variables = builder.variables;\n+        this.variableTypes = builder.variableTypes;\n+    }\n+\n+    /**\n+     * Copy constructor for an AppSyncGraphQLRequest.\n+     * @param request request to copy.\n+     * @param <R> response type.\n+     */\n+    public <R> AppSyncGraphQLRequest(AppSyncGraphQLRequest<R> request) {\n+        super(request);\n+        this.modelSchema = request.modelSchema;\n+        this.operationType = request.operationType;\n+        this.selectionSet = new SelectionSet.Node(request.selectionSet);\n+        this.variables = new HashMap<>(request.variables);\n+        this.variableTypes = new HashMap<>(request.variableTypes);\n+    }\n+\n+    @Override\n+    public <R> AppSyncGraphQLRequest<R> copy() {\n+        return new AppSyncGraphQLRequest<R>(this);\n+    }\n+\n+    @Override\n+    public Map<String, Object> getVariables() {\n+        return this.variables;\n+    }\n+\n+    /**\n+     * Used for setting a variable on the request.\n+     * @param key variable name\n+     * @param type type of variable value\n+     * @param value variable value\n+     */\n+    public void setVariable(String key, String type, String value) {\n+        this.variables.put(key, value);\n+        this.variableTypes.put(key, type);\n+    }\n+\n+    /**\n+     * Used to add owner argument from authProvider if needed.\n+     * @param authProvider CognitoUserPoolsAuthProvider for obtaining the username to set as the owner field.\n+     * @throws ApiException if request requires owner argument and authProvider or authProvider.getUsername() is null.\n+     */\n+    public void setAuthProvider(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        for (AuthRule authRule : modelSchema.getAuthRules()) {\n+            if (isOwnerArgumentRequired(authRule.getOperationsOrDefault())) {\n+                setVariable(authRule.getOwnerFieldOrDefault(), \"String!\", getUsername(authProvider));\n+            }\n+        }\n+    }\n+\n+    private String getUsername(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        if (authProvider == null) {\n+            throw new ApiException(\n+                    \"Attempted to subscribe to a model with owner based authorization without a Cognito provider\",\n+                    \"Did you add the AWSCognitoAuthPlugin to Amplify before configuring it?\"\n+            );\n+        }\n+        String username = authProvider.getUsername();\n+        if (username == null) {\n+            throw new ApiException(\n+                    \"Attempted to subscribe to a model with owner based authorization without a username\",\n+                    \"Make sure that a user is logged in before subscribing to a model with owner based auth\"\n+            );\n+        }\n+        return username;\n+    }\n+\n+    private boolean isOwnerArgumentRequired(List<ModelOperation> operations) {\n+        if (SubscriptionType.ON_CREATE.equals(operationType) && operations.contains(ModelOperation.CREATE)) {\n+            return true;\n+        }\n+        if (SubscriptionType.ON_UPDATE.equals(operationType) && operations.contains(ModelOperation.UPDATE)) {\n+            return true;\n+        }\n+        if (SubscriptionType.ON_DELETE.equals(operationType) && operations.contains(ModelOperation.DELETE)) {\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     *  Returns String value used for GraphQL \"query\" in HTTP request body.\n+     *\n+     *  Sample return value:\n+     *      subscription OnCreatePerson(owner: String!, nextToken: String) {\n+     *            onCreatePerson(owner: $owner, nextToken: $nextToken) {\n+     *               age dob first_name id last_name relationship owner\n+     *            }\n+     *       }\n+     *\n+     * @return String value used for GraphQL \"query\" in HTTP request body\n+     */\n+    @Override\n+    public String getQuery() {\n+        String inputTypeString = \"\";\n+        String inputParameterString = \"\";\n+        if (variableTypes.size() > 0) {\n+            List<String> inputKeys = new ArrayList<>(variableTypes.keySet());\n+            Collections.sort(inputKeys);\n+\n+            List<String> inputTypes = new ArrayList<>();\n+            List<String> inputParameters = new ArrayList<>();\n+            for (String key : inputKeys) {\n+                inputTypes.add(\"$\" + key + \": \" + variableTypes.get(key));\n+                inputParameters.add(key + \": $\" + key);\n+            }\n+\n+            inputTypeString = Wrap.inParentheses(TextUtils.join(\", \", inputTypes));\n+            inputParameterString = Wrap.inParentheses(TextUtils.join(\", \", inputParameters));\n+        }\n+\n+        String modelName = modelSchema.getName();\n+        String operationString = new StringBuilder()\n+                .append(Casing.from(Casing.CaseType.SCREAMING_SNAKE_CASE).to(Casing.CaseType.CAMEL_CASE)\n+                        .convert(operationType.toString()))\n+                .append(modelName)\n+                .append(QueryType.LIST.equals(operationType) ? \"s\" : \"\")\n+                .append(inputParameterString)\n+                .append(selectionSet.toString())\n+                .toString();\n+\n+        String queryString = new StringBuilder()\n+                .append(operationType.getOperationName())\n+                .append(\" \")\n+                .append(Casing.from(Casing.CaseType.SCREAMING_SNAKE_CASE).to(Casing.CaseType.PASCAL_CASE)\n+                        .convert(operationType.toString()))\n+                .append(modelName)\n+                .append(inputTypeString)\n+                .append(\" \")\n+                .append(Wrap.inBraces(operationString))\n+                .toString();\n+\n+        return queryString;\n+    }\n+\n+    @Override\n+    public boolean equals(Object object) {\n+        if (this == object) {\n+            return true;\n+        }\n+\n+        if (object == null || getClass() != object.getClass()) {\n+            return false;\n+        }\n+        if (!super.equals(object)) {\n+            return false;\n+        }\n+        AppSyncGraphQLRequest<?> that = (AppSyncGraphQLRequest<?>) object;\n+        return ObjectsCompat.equals(modelSchema, that.modelSchema) &&\n+                ObjectsCompat.equals(operationType, that.operationType) &&\n+                ObjectsCompat.equals(selectionSet, that.selectionSet) &&\n+                ObjectsCompat.equals(variables, that.variables) &&\n+                ObjectsCompat.equals(variableTypes, that.variableTypes);\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return ObjectsCompat.hash(super.hashCode(), modelSchema, operationType, selectionSet, variables, variableTypes);\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return \"AppSyncGraphQLRequest{\" +\n+                \"modelSchema=\" + modelSchema +\n+                \", operationType=\" + operationType +\n+                \", selectionSet=\" + selectionSet +\n+                \", variables=\" + variables +\n+                \", variableTypes=\" + variableTypes +\n+                super.toString() +\n+                '}';\n+    }\n+\n+    /**\n+     * Create a new AppSyncGraphQLRequest builder.\n+     * @return a new AppSyncGraphQLRequest builder.\n+     */\n+    public static AppSyncGraphQLRequest.Builder builder() {\n+        return new Builder();\n+    }\n+\n+    static final class Builder {\n+        private Class<? extends Model> modelClass;\n+        private OperationType operationType;\n+        private Type responseType;\n+        private Map<String, Object> variables;\n+        private Map<String, String> variableTypes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 258}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEzNTIzMA==", "bodyText": "Hm, is this gonna work? It'll output something like GraphQLRequest { ... } in the middle. Would it be better to just access the super.fields directly to flatten them inline with these others?", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448135230", "createdAt": "2020-07-01T06:09:06Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLRequest.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.annotation.NonNull;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.api.ApiException;\n+import com.amplifyframework.api.aws.appsync.GsonVariablesSerializer;\n+import com.amplifyframework.api.aws.sigv4.CognitoUserPoolsAuthProvider;\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.OperationType;\n+import com.amplifyframework.api.graphql.QueryType;\n+import com.amplifyframework.api.graphql.SubscriptionType;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelOperation;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.Casing;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * A request against an AppSync GraphQL endpoint.\n+ * @param <R> The type of data contained in the GraphQLResponse expected from this request.\n+ */\n+public final class AppSyncGraphQLRequest<R> extends GraphQLRequest<R> {\n+    private static final int DEFAULT_LEVEL_DEPTH = 2;\n+\n+    private final ModelSchema modelSchema;\n+    private final OperationType operationType;\n+    private final SelectionSet.Node selectionSet;\n+    private final Map<String, Object> variables;\n+    private final Map<String, String> variableTypes;\n+\n+    /**\n+     * Constructor for AppSyncGraphQLRequest.\n+     * @throw AmplifyException if a ModelSchema can't be derived from the provided model class\n+     */\n+    private AppSyncGraphQLRequest(Builder builder) throws AmplifyException {\n+        super(builder.responseType, new GsonVariablesSerializer());\n+        this.modelSchema = ModelSchema.fromModelClass(builder.modelClass);\n+        SelectionSet.Node set = SelectionSet.fromModelClass(builder.modelClass, DEFAULT_LEVEL_DEPTH);\n+        if (QueryType.LIST.equals(builder.operationType)) {\n+            set = SelectionSet.wrapPagination(set);\n+        }\n+        this.selectionSet = set;\n+        this.operationType = builder.operationType;\n+        this.variables = builder.variables;\n+        this.variableTypes = builder.variableTypes;\n+    }\n+\n+    /**\n+     * Copy constructor for an AppSyncGraphQLRequest.\n+     * @param request request to copy.\n+     * @param <R> response type.\n+     */\n+    public <R> AppSyncGraphQLRequest(AppSyncGraphQLRequest<R> request) {\n+        super(request);\n+        this.modelSchema = request.modelSchema;\n+        this.operationType = request.operationType;\n+        this.selectionSet = new SelectionSet.Node(request.selectionSet);\n+        this.variables = new HashMap<>(request.variables);\n+        this.variableTypes = new HashMap<>(request.variableTypes);\n+    }\n+\n+    @Override\n+    public <R> AppSyncGraphQLRequest<R> copy() {\n+        return new AppSyncGraphQLRequest<R>(this);\n+    }\n+\n+    @Override\n+    public Map<String, Object> getVariables() {\n+        return this.variables;\n+    }\n+\n+    /**\n+     * Used for setting a variable on the request.\n+     * @param key variable name\n+     * @param type type of variable value\n+     * @param value variable value\n+     */\n+    public void setVariable(String key, String type, String value) {\n+        this.variables.put(key, value);\n+        this.variableTypes.put(key, type);\n+    }\n+\n+    /**\n+     * Used to add owner argument from authProvider if needed.\n+     * @param authProvider CognitoUserPoolsAuthProvider for obtaining the username to set as the owner field.\n+     * @throws ApiException if request requires owner argument and authProvider or authProvider.getUsername() is null.\n+     */\n+    public void setAuthProvider(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        for (AuthRule authRule : modelSchema.getAuthRules()) {\n+            if (isOwnerArgumentRequired(authRule.getOperationsOrDefault())) {\n+                setVariable(authRule.getOwnerFieldOrDefault(), \"String!\", getUsername(authProvider));\n+            }\n+        }\n+    }\n+\n+    private String getUsername(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        if (authProvider == null) {\n+            throw new ApiException(\n+                    \"Attempted to subscribe to a model with owner based authorization without a Cognito provider\",\n+                    \"Did you add the AWSCognitoAuthPlugin to Amplify before configuring it?\"\n+            );\n+        }\n+        String username = authProvider.getUsername();\n+        if (username == null) {\n+            throw new ApiException(\n+                    \"Attempted to subscribe to a model with owner based authorization without a username\",\n+                    \"Make sure that a user is logged in before subscribing to a model with owner based auth\"\n+            );\n+        }\n+        return username;\n+    }\n+\n+    private boolean isOwnerArgumentRequired(List<ModelOperation> operations) {\n+        if (SubscriptionType.ON_CREATE.equals(operationType) && operations.contains(ModelOperation.CREATE)) {\n+            return true;\n+        }\n+        if (SubscriptionType.ON_UPDATE.equals(operationType) && operations.contains(ModelOperation.UPDATE)) {\n+            return true;\n+        }\n+        if (SubscriptionType.ON_DELETE.equals(operationType) && operations.contains(ModelOperation.DELETE)) {\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     *  Returns String value used for GraphQL \"query\" in HTTP request body.\n+     *\n+     *  Sample return value:\n+     *      subscription OnCreatePerson(owner: String!, nextToken: String) {\n+     *            onCreatePerson(owner: $owner, nextToken: $nextToken) {\n+     *               age dob first_name id last_name relationship owner\n+     *            }\n+     *       }\n+     *\n+     * @return String value used for GraphQL \"query\" in HTTP request body\n+     */\n+    @Override\n+    public String getQuery() {\n+        String inputTypeString = \"\";\n+        String inputParameterString = \"\";\n+        if (variableTypes.size() > 0) {\n+            List<String> inputKeys = new ArrayList<>(variableTypes.keySet());\n+            Collections.sort(inputKeys);\n+\n+            List<String> inputTypes = new ArrayList<>();\n+            List<String> inputParameters = new ArrayList<>();\n+            for (String key : inputKeys) {\n+                inputTypes.add(\"$\" + key + \": \" + variableTypes.get(key));\n+                inputParameters.add(key + \": $\" + key);\n+            }\n+\n+            inputTypeString = Wrap.inParentheses(TextUtils.join(\", \", inputTypes));\n+            inputParameterString = Wrap.inParentheses(TextUtils.join(\", \", inputParameters));\n+        }\n+\n+        String modelName = modelSchema.getName();\n+        String operationString = new StringBuilder()\n+                .append(Casing.from(Casing.CaseType.SCREAMING_SNAKE_CASE).to(Casing.CaseType.CAMEL_CASE)\n+                        .convert(operationType.toString()))\n+                .append(modelName)\n+                .append(QueryType.LIST.equals(operationType) ? \"s\" : \"\")\n+                .append(inputParameterString)\n+                .append(selectionSet.toString())\n+                .toString();\n+\n+        String queryString = new StringBuilder()\n+                .append(operationType.getOperationName())\n+                .append(\" \")\n+                .append(Casing.from(Casing.CaseType.SCREAMING_SNAKE_CASE).to(Casing.CaseType.PASCAL_CASE)\n+                        .convert(operationType.toString()))\n+                .append(modelName)\n+                .append(inputTypeString)\n+                .append(\" \")\n+                .append(Wrap.inBraces(operationString))\n+                .toString();\n+\n+        return queryString;\n+    }\n+\n+    @Override\n+    public boolean equals(Object object) {\n+        if (this == object) {\n+            return true;\n+        }\n+\n+        if (object == null || getClass() != object.getClass()) {\n+            return false;\n+        }\n+        if (!super.equals(object)) {\n+            return false;\n+        }\n+        AppSyncGraphQLRequest<?> that = (AppSyncGraphQLRequest<?>) object;\n+        return ObjectsCompat.equals(modelSchema, that.modelSchema) &&\n+                ObjectsCompat.equals(operationType, that.operationType) &&\n+                ObjectsCompat.equals(selectionSet, that.selectionSet) &&\n+                ObjectsCompat.equals(variables, that.variables) &&\n+                ObjectsCompat.equals(variableTypes, that.variableTypes);\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return ObjectsCompat.hash(super.hashCode(), modelSchema, operationType, selectionSet, variables, variableTypes);\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return \"AppSyncGraphQLRequest{\" +\n+                \"modelSchema=\" + modelSchema +\n+                \", operationType=\" + operationType +\n+                \", selectionSet=\" + selectionSet +\n+                \", variables=\" + variables +\n+                \", variableTypes=\" + variableTypes +\n+                super.toString() +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 241}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEzNTgzMQ==", "bodyText": "In hindsight, I was having too much fun when I made this Casing utility. But I think my intention was that you could import CaseType directly, for the most readability:\nCasing.from(CaseType.SCREAMING_SNAKE_CASE, ...)", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448135831", "createdAt": "2020-07-01T06:10:53Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLRequest.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.annotation.NonNull;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.api.ApiException;\n+import com.amplifyframework.api.aws.appsync.GsonVariablesSerializer;\n+import com.amplifyframework.api.aws.sigv4.CognitoUserPoolsAuthProvider;\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.OperationType;\n+import com.amplifyframework.api.graphql.QueryType;\n+import com.amplifyframework.api.graphql.SubscriptionType;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelOperation;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.Casing;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * A request against an AppSync GraphQL endpoint.\n+ * @param <R> The type of data contained in the GraphQLResponse expected from this request.\n+ */\n+public final class AppSyncGraphQLRequest<R> extends GraphQLRequest<R> {\n+    private static final int DEFAULT_LEVEL_DEPTH = 2;\n+\n+    private final ModelSchema modelSchema;\n+    private final OperationType operationType;\n+    private final SelectionSet.Node selectionSet;\n+    private final Map<String, Object> variables;\n+    private final Map<String, String> variableTypes;\n+\n+    /**\n+     * Constructor for AppSyncGraphQLRequest.\n+     * @throw AmplifyException if a ModelSchema can't be derived from the provided model class\n+     */\n+    private AppSyncGraphQLRequest(Builder builder) throws AmplifyException {\n+        super(builder.responseType, new GsonVariablesSerializer());\n+        this.modelSchema = ModelSchema.fromModelClass(builder.modelClass);\n+        SelectionSet.Node set = SelectionSet.fromModelClass(builder.modelClass, DEFAULT_LEVEL_DEPTH);\n+        if (QueryType.LIST.equals(builder.operationType)) {\n+            set = SelectionSet.wrapPagination(set);\n+        }\n+        this.selectionSet = set;\n+        this.operationType = builder.operationType;\n+        this.variables = builder.variables;\n+        this.variableTypes = builder.variableTypes;\n+    }\n+\n+    /**\n+     * Copy constructor for an AppSyncGraphQLRequest.\n+     * @param request request to copy.\n+     * @param <R> response type.\n+     */\n+    public <R> AppSyncGraphQLRequest(AppSyncGraphQLRequest<R> request) {\n+        super(request);\n+        this.modelSchema = request.modelSchema;\n+        this.operationType = request.operationType;\n+        this.selectionSet = new SelectionSet.Node(request.selectionSet);\n+        this.variables = new HashMap<>(request.variables);\n+        this.variableTypes = new HashMap<>(request.variableTypes);\n+    }\n+\n+    @Override\n+    public <R> AppSyncGraphQLRequest<R> copy() {\n+        return new AppSyncGraphQLRequest<R>(this);\n+    }\n+\n+    @Override\n+    public Map<String, Object> getVariables() {\n+        return this.variables;\n+    }\n+\n+    /**\n+     * Used for setting a variable on the request.\n+     * @param key variable name\n+     * @param type type of variable value\n+     * @param value variable value\n+     */\n+    public void setVariable(String key, String type, String value) {\n+        this.variables.put(key, value);\n+        this.variableTypes.put(key, type);\n+    }\n+\n+    /**\n+     * Used to add owner argument from authProvider if needed.\n+     * @param authProvider CognitoUserPoolsAuthProvider for obtaining the username to set as the owner field.\n+     * @throws ApiException if request requires owner argument and authProvider or authProvider.getUsername() is null.\n+     */\n+    public void setAuthProvider(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        for (AuthRule authRule : modelSchema.getAuthRules()) {\n+            if (isOwnerArgumentRequired(authRule.getOperationsOrDefault())) {\n+                setVariable(authRule.getOwnerFieldOrDefault(), \"String!\", getUsername(authProvider));\n+            }\n+        }\n+    }\n+\n+    private String getUsername(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        if (authProvider == null) {\n+            throw new ApiException(\n+                    \"Attempted to subscribe to a model with owner based authorization without a Cognito provider\",\n+                    \"Did you add the AWSCognitoAuthPlugin to Amplify before configuring it?\"\n+            );\n+        }\n+        String username = authProvider.getUsername();\n+        if (username == null) {\n+            throw new ApiException(\n+                    \"Attempted to subscribe to a model with owner based authorization without a username\",\n+                    \"Make sure that a user is logged in before subscribing to a model with owner based auth\"\n+            );\n+        }\n+        return username;\n+    }\n+\n+    private boolean isOwnerArgumentRequired(List<ModelOperation> operations) {\n+        if (SubscriptionType.ON_CREATE.equals(operationType) && operations.contains(ModelOperation.CREATE)) {\n+            return true;\n+        }\n+        if (SubscriptionType.ON_UPDATE.equals(operationType) && operations.contains(ModelOperation.UPDATE)) {\n+            return true;\n+        }\n+        if (SubscriptionType.ON_DELETE.equals(operationType) && operations.contains(ModelOperation.DELETE)) {\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     *  Returns String value used for GraphQL \"query\" in HTTP request body.\n+     *\n+     *  Sample return value:\n+     *      subscription OnCreatePerson(owner: String!, nextToken: String) {\n+     *            onCreatePerson(owner: $owner, nextToken: $nextToken) {\n+     *               age dob first_name id last_name relationship owner\n+     *            }\n+     *       }\n+     *\n+     * @return String value used for GraphQL \"query\" in HTTP request body\n+     */\n+    @Override\n+    public String getQuery() {\n+        String inputTypeString = \"\";\n+        String inputParameterString = \"\";\n+        if (variableTypes.size() > 0) {\n+            List<String> inputKeys = new ArrayList<>(variableTypes.keySet());\n+            Collections.sort(inputKeys);\n+\n+            List<String> inputTypes = new ArrayList<>();\n+            List<String> inputParameters = new ArrayList<>();\n+            for (String key : inputKeys) {\n+                inputTypes.add(\"$\" + key + \": \" + variableTypes.get(key));\n+                inputParameters.add(key + \": $\" + key);\n+            }\n+\n+            inputTypeString = Wrap.inParentheses(TextUtils.join(\", \", inputTypes));\n+            inputParameterString = Wrap.inParentheses(TextUtils.join(\", \", inputParameters));\n+        }\n+\n+        String modelName = modelSchema.getName();\n+        String operationString = new StringBuilder()\n+                .append(Casing.from(Casing.CaseType.SCREAMING_SNAKE_CASE).to(Casing.CaseType.CAMEL_CASE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 186}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMzUzODkz", "url": "https://github.com/aws-amplify/amplify-android/pull/596#pullrequestreview-441353893", "createdAt": "2020-07-02T05:09:24Z", "commit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNTowOToyNFrOGr9pSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNTowOToyNFrOGr9pSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc1MTk0Ng==", "bodyText": "So I can't explain why we have to set owner: String! and the value on graphQL document/variables. We already intercept the request with the token which contains all of this information, so shouldn't the service already know how to retrieve the token and check if the user is authorized? Why do both? @SwaySway tried to explain this to me once and it had something to do with how subscriptions work. There is the initial connection that contains the auth token on the request header and then on each subscription message, it probably requires the owner value to be used as a filter to check if the data can be passed back to the subscriber?\nSo from trying out different auth rules with \"allow: owner\", it turns out, as long as the operation is specified then the correlating operation's subscription requires the owner value to be present. This is what you have written here. The callout here is that this does not work for all auth rules. I don't think this should block this PR from shipping as this is just a limitation that we can document and increase in functionality later.\nThe problem is when there are auth rules with \"allow: groups, groups: [\"SomeGroup\"]\".\ntype ApprovedBlog @model @auth(rules: [{allow: groups, groups: [\"ApprovedBloggers\"], operations: [read, create]}]) {\n  id: ID!\n  blogId: String\n}\n\nApprovedBlog can only be read and created by users in the \"ApprovedBloggers\" group. (Uh, i'm not sure what this means for others not in the group, maybe they can update and delete ApprovedBlog objects if they have access to the id of the object? not sure)\nNone of the generated subscription operations require the owner field\nonCreateApprovedBlog: ApprovedBlog\nonUpdateApprovedBlog: ApprovedBlog\nonDeleteApprovedBlog: ApprovedBlog\n\nI have user1 not in the group and user2 in the group.\nBoth logged in users create a subscription without the owner:\nsubscription onCreaeApprovedBlog {\n\tonCreateApprovedBlog {\n    id\n    blogId\n  }  \n}\n\nuser1 fails with\nError: {\n    \"errors\": [\n        {\n            \"message\": \"Connection failed: {\\\"errors\\\":[{\\\"errorType\\\":\\\"Unauthorized\\\",\\\"message\\\":\\\"Not Authorized to access onCreateApprovedBlog on type Subscription\\\"}]}\"\n        }\n    ]\n}\n\nuser2 is able to create a subscription connection.\nSince models with static groups auth rules do not require the owner to be passed in, the check for isOwnerArgumentRequired should be: authRule's allow == owner && SubscriptionType match ModelOperation\non iOS it's done in decorateIfOwnerAuthStrategy and there are other related issues to keep in mind which may or may not be relevant on Android related to having both \"allow: owner\" and \"allow: groups\"", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448751946", "createdAt": "2020-07-02T05:09:24Z", "author": {"login": "lawmicha"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLRequest.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.annotation.NonNull;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.api.ApiException;\n+import com.amplifyframework.api.aws.appsync.GsonVariablesSerializer;\n+import com.amplifyframework.api.aws.sigv4.CognitoUserPoolsAuthProvider;\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.OperationType;\n+import com.amplifyframework.api.graphql.QueryType;\n+import com.amplifyframework.api.graphql.SubscriptionType;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelOperation;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.Casing;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * A request against an AppSync GraphQL endpoint.\n+ * @param <R> The type of data contained in the GraphQLResponse expected from this request.\n+ */\n+public final class AppSyncGraphQLRequest<R> extends GraphQLRequest<R> {\n+    private static final int DEFAULT_LEVEL_DEPTH = 2;\n+\n+    private final ModelSchema modelSchema;\n+    private final OperationType operationType;\n+    private final SelectionSet.Node selectionSet;\n+    private final Map<String, Object> variables;\n+    private final Map<String, String> variableTypes;\n+\n+    /**\n+     * Constructor for AppSyncGraphQLRequest.\n+     * @throw AmplifyException if a ModelSchema can't be derived from the provided model class\n+     */\n+    private AppSyncGraphQLRequest(Builder builder) throws AmplifyException {\n+        super(builder.responseType, new GsonVariablesSerializer());\n+        this.modelSchema = ModelSchema.fromModelClass(builder.modelClass);\n+        SelectionSet.Node set = SelectionSet.fromModelClass(builder.modelClass, DEFAULT_LEVEL_DEPTH);\n+        if (QueryType.LIST.equals(builder.operationType)) {\n+            set = SelectionSet.wrapPagination(set);\n+        }\n+        this.selectionSet = set;\n+        this.operationType = builder.operationType;\n+        this.variables = builder.variables;\n+        this.variableTypes = builder.variableTypes;\n+    }\n+\n+    /**\n+     * Copy constructor for an AppSyncGraphQLRequest.\n+     * @param request request to copy.\n+     * @param <R> response type.\n+     */\n+    public <R> AppSyncGraphQLRequest(AppSyncGraphQLRequest<R> request) {\n+        super(request);\n+        this.modelSchema = request.modelSchema;\n+        this.operationType = request.operationType;\n+        this.selectionSet = new SelectionSet.Node(request.selectionSet);\n+        this.variables = new HashMap<>(request.variables);\n+        this.variableTypes = new HashMap<>(request.variableTypes);\n+    }\n+\n+    @Override\n+    public <R> AppSyncGraphQLRequest<R> copy() {\n+        return new AppSyncGraphQLRequest<R>(this);\n+    }\n+\n+    @Override\n+    public Map<String, Object> getVariables() {\n+        return this.variables;\n+    }\n+\n+    /**\n+     * Used for setting a variable on the request.\n+     * @param key variable name\n+     * @param type type of variable value\n+     * @param value variable value\n+     */\n+    public void setVariable(String key, String type, String value) {\n+        this.variables.put(key, value);\n+        this.variableTypes.put(key, type);\n+    }\n+\n+    /**\n+     * Used to add owner argument from authProvider if needed.\n+     * @param authProvider CognitoUserPoolsAuthProvider for obtaining the username to set as the owner field.\n+     * @throws ApiException if request requires owner argument and authProvider or authProvider.getUsername() is null.\n+     */\n+    public void setAuthProvider(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        for (AuthRule authRule : modelSchema.getAuthRules()) {\n+            if (isOwnerArgumentRequired(authRule.getOperationsOrDefault())) {\n+                setVariable(authRule.getOwnerFieldOrDefault(), \"String!\", getUsername(authProvider));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 118}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMzY5MjUz", "url": "https://github.com/aws-amplify/amplify-android/pull/596#pullrequestreview-441369253", "createdAt": "2020-07-02T05:57:02Z", "commit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNTo1NzowMlrOGr-aWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNTo1NzowMlrOGr-aWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc2NDUwNw==", "bodyText": "on iOS, the selection set is only generated from the fields from the Model. We don't actually add it in based on the auth rule's owner field. The reason why we do not add it in is because it's up to the developer to decide whether that data is returned in their Model\nFor example\n\nDeveloper has annotated the Model with Auth directive with \"allow: owner\" and by default it sets ownerField to \"owner\". They do not add it to their model like\n\ntype Model @model @auth { allow: owner } {\n   id: ID!\n   content: String\n   // missing owner\n}\n\nModel only contains id and content, so if the selection set had the owner field added, it would just be dropped when deserializing\nDataStore sync to cloud does custom deserialization to separate out into Model and MutationSyncMetadata (containinig version and deleted). Even if ownerField is added to the selection set, and the value is returned in the response, it would just be ignored\n\nDeveloper sets it on their model\n\ntype Model @model @auth { allow: owner } {\n   id: ID!\n   content: String\n   owner: String\n}\n\nCodegen generates Model with id, content, and owner. SelectionSet contains all three fields because it's generated from the Model's fields. Does not care about the auth rules\n\nDeveloper sets a custom ownerField, but not on their model\n\ntype Model @model @auth { allow: owner, ownerField: \"customOwner\" } {\n   id: ID!\n   content: String\n   // missing customOwner\n}\n\nI don't think a developer would ever do this since they are trying to reference a custom owner field in the Model but have not specified it in their model. If they want a custom owner field, they should specify it like in scenario 4 below\n\nDeveloper sets a custom ownerField and adds it to the model\n\ntype Model @model @auth { allow: owner, ownerField: \"customOwner\" } {\n   id: ID!\n   content: String\n   customOwner: String\n}\n\nCodegen generates Model with id, content, and customOwner. SelectionSet contains all three fields because it's generated from the Model's fields. Does not care about the auth rules.\nowner field on the Model should be optional\nwhen you specify the owner field on the Model, whether it's \"owner\" or \"customOwner\", it has to be optional since it's automatically managed (API intercept the request with the token). Making it required means the caller needs to add it in the request somehow.\nFor scenario 2 and 4, does that mean this code is adding duplicate owner fields to the selection set?", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448764507", "createdAt": "2020-07-02T05:57:02Z", "author": {"login": "lawmicha"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SelectionSet.java", "diffHunk": "@@ -0,0 +1,185 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.AuthStrategy;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.FieldFinder;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.ParameterizedType;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+/**\n+ * Class for creating and serializing a selection set within a GraphQL document.\n+ */\n+final class SelectionSet {\n+    private static final String ITEMS_KEY = \"items\";\n+    private static final String NEXT_TOKEN_KEY = \"nextToken\";\n+\n+    // This class should not be instantiated\n+    private SelectionSet() {}\n+\n+    /**\n+     * Returns selection set containing the fields of the provided model class, as well as nested models.\n+     * @param modelClass model class\n+     * @return selection set containing all of the fields of the provided model class\n+     * @throws AmplifyException if a ModelSchema cannot be created from the provided model class.\n+     */\n+    public static Node fromModelClass(Class<? extends Model> modelClass, int depth) throws AmplifyException {\n+        return new Node(null, getModelFields(modelClass, depth));\n+    }\n+\n+    /**\n+     * Expects a {@link Node} containing {@link Model} fields as nodes, and returns a new root node with two children:\n+     *  - \"items\" with nodes being the children of the provided node.\n+     *  - \"nextToken\"\n+     *\n+     * @param node a root node, with a value of null, and pagination fields\n+     * @return\n+     */\n+    public static Node wrapPagination(Node node) {\n+        return new Node(null, wrapPagination(node.nodes));\n+    }\n+\n+    private static Set<Node> wrapPagination(Set<Node> nodes) {\n+        Set<Node> paginatedSet = new HashSet<>();\n+        paginatedSet.add(new Node(ITEMS_KEY, nodes));\n+        paginatedSet.add(new Node(NEXT_TOKEN_KEY, null));\n+        return paginatedSet;\n+    }\n+\n+    @SuppressWarnings(\"unchecked\") // Cast to Class<Model>\n+    private static Set<Node> getModelFields(Class<? extends Model> clazz, int depth)\n+            throws AmplifyException {\n+        if (depth < 0) {\n+            return new HashSet<>();\n+        }\n+\n+        Set<Node> result = new HashSet<>();\n+        ModelSchema schema = ModelSchema.fromModelClass(clazz);\n+        for (Field field : FieldFinder.findFieldsIn(clazz)) {\n+            String fieldName = field.getName();\n+            if (schema.getAssociations().containsKey(fieldName)) {\n+                if (List.class.isAssignableFrom(field.getType())) {\n+                    if (depth >= 1) {\n+                        ParameterizedType listType = (ParameterizedType) field.getGenericType();\n+                        Class<Model> listTypeClass = (Class<Model>) listType.getActualTypeArguments()[0];\n+                        Set<Node> fields = wrapPagination(getModelFields(listTypeClass, depth - 1));\n+                        result.add(new Node(fieldName, fields));\n+                    }\n+                } else if (depth >= 1) {\n+                    Set<Node> fields = getModelFields((Class<Model>) field.getType(), depth - 1);\n+                    result.add(new Node(fieldName, fields));\n+                }\n+            } else {\n+                result.add(new Node(fieldName, null));\n+            }\n+            for (AuthRule authRule : schema.getAuthRules()) {\n+                if (AuthStrategy.OWNER.equals(authRule.getAuthStrategy())) {\n+                    result.add(new Node(authRule.getOwnerFieldOrDefault(), null));\n+                    break;\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMzc2Mjk4", "url": "https://github.com/aws-amplify/amplify-android/pull/596#pullrequestreview-441376298", "createdAt": "2020-07-02T06:14:16Z", "commit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNjoxNDoxNlrOGr-xVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNjoxNDoxNlrOGr-xVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc3MDM4OA==", "bodyText": "This is what iOS is currently doing as well, using the username as the identityClaim and we have opened a feature request to support more than just the default identityClaim type when using the auth directive", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r448770388", "createdAt": "2020-07-02T06:14:16Z", "author": {"login": "lawmicha"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLRequest.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.annotation.NonNull;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.api.ApiException;\n+import com.amplifyframework.api.aws.appsync.GsonVariablesSerializer;\n+import com.amplifyframework.api.aws.sigv4.CognitoUserPoolsAuthProvider;\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.OperationType;\n+import com.amplifyframework.api.graphql.QueryType;\n+import com.amplifyframework.api.graphql.SubscriptionType;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelOperation;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.Casing;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * A request against an AppSync GraphQL endpoint.\n+ * @param <R> The type of data contained in the GraphQLResponse expected from this request.\n+ */\n+public final class AppSyncGraphQLRequest<R> extends GraphQLRequest<R> {\n+    private static final int DEFAULT_LEVEL_DEPTH = 2;\n+\n+    private final ModelSchema modelSchema;\n+    private final OperationType operationType;\n+    private final SelectionSet.Node selectionSet;\n+    private final Map<String, Object> variables;\n+    private final Map<String, String> variableTypes;\n+\n+    /**\n+     * Constructor for AppSyncGraphQLRequest.\n+     * @throw AmplifyException if a ModelSchema can't be derived from the provided model class\n+     */\n+    private AppSyncGraphQLRequest(Builder builder) throws AmplifyException {\n+        super(builder.responseType, new GsonVariablesSerializer());\n+        this.modelSchema = ModelSchema.fromModelClass(builder.modelClass);\n+        SelectionSet.Node set = SelectionSet.fromModelClass(builder.modelClass, DEFAULT_LEVEL_DEPTH);\n+        if (QueryType.LIST.equals(builder.operationType)) {\n+            set = SelectionSet.wrapPagination(set);\n+        }\n+        this.selectionSet = set;\n+        this.operationType = builder.operationType;\n+        this.variables = builder.variables;\n+        this.variableTypes = builder.variableTypes;\n+    }\n+\n+    /**\n+     * Copy constructor for an AppSyncGraphQLRequest.\n+     * @param request request to copy.\n+     * @param <R> response type.\n+     */\n+    public <R> AppSyncGraphQLRequest(AppSyncGraphQLRequest<R> request) {\n+        super(request);\n+        this.modelSchema = request.modelSchema;\n+        this.operationType = request.operationType;\n+        this.selectionSet = new SelectionSet.Node(request.selectionSet);\n+        this.variables = new HashMap<>(request.variables);\n+        this.variableTypes = new HashMap<>(request.variableTypes);\n+    }\n+\n+    @Override\n+    public <R> AppSyncGraphQLRequest<R> copy() {\n+        return new AppSyncGraphQLRequest<R>(this);\n+    }\n+\n+    @Override\n+    public Map<String, Object> getVariables() {\n+        return this.variables;\n+    }\n+\n+    /**\n+     * Used for setting a variable on the request.\n+     * @param key variable name\n+     * @param type type of variable value\n+     * @param value variable value\n+     */\n+    public void setVariable(String key, String type, String value) {\n+        this.variables.put(key, value);\n+        this.variableTypes.put(key, type);\n+    }\n+\n+    /**\n+     * Used to add owner argument from authProvider if needed.\n+     * @param authProvider CognitoUserPoolsAuthProvider for obtaining the username to set as the owner field.\n+     * @throws ApiException if request requires owner argument and authProvider or authProvider.getUsername() is null.\n+     */\n+    public void setAuthProvider(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        for (AuthRule authRule : modelSchema.getAuthRules()) {\n+            if (isOwnerArgumentRequired(authRule.getOperationsOrDefault())) {\n+                setVariable(authRule.getOwnerFieldOrDefault(), \"String!\", getUsername(authProvider));\n+            }\n+        }\n+    }\n+\n+    private String getUsername(CognitoUserPoolsAuthProvider authProvider) throws ApiException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9"}, "originalPosition": 123}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bab4cdd592eb95795f0cd6dff22d5324f30db36a", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/bab4cdd592eb95795f0cd6dff22d5324f30db36a", "committedDate": "2020-07-07T01:27:09Z", "message": "Merge branch 'main' into rm/ownerauth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59018cdb7f0e9d7e253b6206dc8f0cba002fe141", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/59018cdb7f0e9d7e253b6206dc8f0cba002fe141", "committedDate": "2020-07-07T07:07:16Z", "message": "Rename setAuthProvider to setOwner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "961866975bac76962ce64276093c0bd5406eced3", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/961866975bac76962ce64276093c0bd5406eced3", "committedDate": "2020-07-07T07:16:35Z", "message": "Early return if failure instead of starting a GraphQLOperation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a25e3c6230436b98b62866620061493fafa49c27", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/a25e3c6230436b98b62866620061493fafa49c27", "committedDate": "2020-07-07T07:25:18Z", "message": "Pass OperationType into SelectionSet so it can figure out when to wrap with pagination details internally"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e48a5f9c83e2402ff8c55b5b4a44968cd3b70c5", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/7e48a5f9c83e2402ff8c55b5b4a44968cd3b70c5", "committedDate": "2020-07-07T07:30:16Z", "message": "Refactor SelectionSet.Node copy constructor to call other constructor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29764599cd2da945a1a0fd13980acd347f8ec09d", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/29764599cd2da945a1a0fd13980acd347f8ec09d", "committedDate": "2020-07-07T07:33:15Z", "message": "Make variables final on AppSyncGraphQLRequest.Builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73c064cc0de31e807091af8084b1015c38825571", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/73c064cc0de31e807091af8084b1015c38825571", "committedDate": "2020-07-07T07:35:21Z", "message": "Fix AppSyncGraphQLRequest toString implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16eabc24bb64e59d2ca01c0c4410ddfd1b7cbf53", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/16eabc24bb64e59d2ca01c0c4410ddfd1b7cbf53", "committedDate": "2020-07-07T07:44:06Z", "message": "Use static import to make casing conversion less verbose"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6929030ed2b5892a3fb94f0de33d3c68303cfe6", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/c6929030ed2b5892a3fb94f0de33d3c68303cfe6", "committedDate": "2020-07-07T07:50:20Z", "message": "Fix SelectionSetTest failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "235af37bb7fcb3585a3d1db16e9eb17b337df717", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/235af37bb7fcb3585a3d1db16e9eb17b337df717", "committedDate": "2020-07-07T08:01:04Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3e879beb0b61359cbda571990acc9ade94aa1b9", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/f3e879beb0b61359cbda571990acc9ade94aa1b9", "committedDate": "2020-07-07T08:01:13Z", "message": "Revert \"Use static import to make casing conversion less verbose\"\n\nThis reverts commit 16eabc24bb64e59d2ca01c0c4410ddfd1b7cbf53."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71a2e1b15bf9a6e6e2883ee68af9203487e0c7a6", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/71a2e1b15bf9a6e6e2883ee68af9203487e0c7a6", "committedDate": "2020-07-07T08:26:07Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNzkwMjY2", "url": "https://github.com/aws-amplify/amplify-android/pull/596#pullrequestreview-443790266", "createdAt": "2020-07-07T11:11:35Z", "commit": {"oid": "71a2e1b15bf9a6e6e2883ee68af9203487e0c7a6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c80f4624b4e5ada6f508bb1dab6406001fece689", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/c80f4624b4e5ada6f508bb1dab6406001fece689", "committedDate": "2020-07-07T17:52:31Z", "message": "Move factory methods to inner class of SelectionSet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "787dc8bed952dbe0487a07a65f393257e45528e2", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/787dc8bed952dbe0487a07a65f393257e45528e2", "committedDate": "2020-07-07T19:06:33Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "884dd9c13dc0bb2e66858b5d492ac1e6ca4a9a25", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/884dd9c13dc0bb2e66858b5d492ac1e6ca4a9a25", "committedDate": "2020-07-07T21:04:54Z", "message": "Empty.check instead of isEmpty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d7cd964ad4fac23a45c2c1a618986469576c918", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/9d7cd964ad4fac23a45c2c1a618986469576c918", "committedDate": "2020-07-07T22:32:15Z", "message": "Added Empty.check String helper method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d72f886cde8a4afc109dbe13e46d26ea3f28662", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/2d72f886cde8a4afc109dbe13e46d26ea3f28662", "committedDate": "2020-07-07T22:33:18Z", "message": "Add check so that owner is only added for AuthStrategy.OWNER"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10ba2fd502d498bf9d25c9f5e59edbdf382ef4b0", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/10ba2fd502d498bf9d25c9f5e59edbdf382ef4b0", "committedDate": "2020-07-07T22:33:42Z", "message": "Add unit tests for adding owner field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59b1f34358c56f36358e89fdfa2bd97e0cb57a64", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/59b1f34358c56f36358e89fdfa2bd97e0cb57a64", "committedDate": "2020-07-07T22:34:59Z", "message": "Remove addition of owner field to selection set per mdlaws feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66d5d65ba21d7b2046180673f1fb1ed0458124a6", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/66d5d65ba21d7b2046180673f1fb1ed0458124a6", "committedDate": "2020-07-08T00:00:05Z", "message": "Add logic to filter out owner field if null for mutations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64f2b284f89ea3509dc3ca35ef759abbb2873e37", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/64f2b284f89ea3509dc3ca35ef759abbb2873e37", "committedDate": "2020-07-08T00:30:03Z", "message": "Fix AWSApiPluginTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65a4652743e0919b3f177624a29bb08947a73294", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/65a4652743e0919b3f177624a29bb08947a73294", "committedDate": "2020-07-08T00:34:06Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c28a1d6cb9b189e47f59b562673f0b9f42405aa", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/6c28a1d6cb9b189e47f59b562673f0b9f42405aa", "committedDate": "2020-07-08T00:57:59Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MzQ1MjYw", "url": "https://github.com/aws-amplify/amplify-android/pull/596#pullrequestreview-444345260", "createdAt": "2020-07-08T01:02:10Z", "commit": {"oid": "6c28a1d6cb9b189e47f59b562673f0b9f42405aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMTowMjoxMFrOGuUjEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMTowMjoxMFrOGuUjEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNDMzNw==", "bodyText": "The \"not mocked\" error can be fixed by using @RunWith(RobolectricTestRunner.class).\nThe Robolectric test runner includes a version of the Android APIs that can run on the host JVM -- not the phone's ART/JVM.\nThe downside is that Robolectric tests are slower.\nTo make this comment accurate, we should really go through hand update all references to TextUtils.isEmpty, and try to strip off the test-runners, to see if the tests will run after the change.\nOverall it seems reasonable -- avoiding TextUtils basically means faster unit tests (if the source code doesn't use any other Android-y stuff, and so Robolectric annotations could be removed from the class.)", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r451224337", "createdAt": "2020-07-08T01:02:10Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/util/Empty.java", "diffHunk": "@@ -49,9 +48,9 @@ public static boolean check(@Nullable Map<?, ?> map) {\n      * Returns true if str is null or empty.\n      *\n      * TextUtils.isEmpty() provides the same behavior, but throws an exception when called from a unit test, since the\n-     *  Android library is not available in unit tests.  Empty.check() is preferred to allow for unit testing.\n-     *\n-     * @see <a href=\"http://tools.android.com/tech-docs/unit-testing-support#TOC-Method-...-not-mocked.\">documentation</a> for more details.\n+     *  Android library is not available in unit tests.  Empty.check() is preferred to allow for unit testing.  See\n+     *  <a href=\"http://tools.android.com/tech-docs/unit-testing-support#TOC-Method-...-not-mocked.\">Android\n+     *  tools documentation</a> for details.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c28a1d6cb9b189e47f59b562673f0b9f42405aa"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54581b2527f1c7b08e282a0304bf470eefd3e0cf", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/54581b2527f1c7b08e282a0304bf470eefd3e0cf", "committedDate": "2020-07-08T06:04:30Z", "message": "Use Empty.check utility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4ef088b58bf9cc89c8342c3716c2496b60d831c", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/c4ef088b58bf9cc89c8342c3716c2496b60d831c", "committedDate": "2020-07-08T14:48:28Z", "message": "dashes in test resource file names for readability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f12b652d29f0e35368f637658bb827bdbe5a5cdc", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/f12b652d29f0e35368f637658bb827bdbe5a5cdc", "committedDate": "2020-07-08T15:15:13Z", "message": "Use Wrap.inDoubleQuotes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a54299117ce9a884cd560a540dcf7c14464d59af", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/a54299117ce9a884cd560a540dcf7c14464d59af", "committedDate": "2020-07-08T16:39:41Z", "message": "dont use trim in SelectionSetTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aba24dcfa7b5c02bda89bc622271c7eee7896b0e", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/aba24dcfa7b5c02bda89bc622271c7eee7896b0e", "committedDate": "2020-07-08T16:47:25Z", "message": "Use NoOpConsumer.create()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f33c7cf47ff1c6fb59e0eec4bc626c7283f19b9", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/5f33c7cf47ff1c6fb59e0eec4bc626c7283f19b9", "committedDate": "2020-07-08T16:50:00Z", "message": "Use Empty.check everywhere"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "737ca35d7722c8272d268dd94a2c6f03d5a78ebb", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/737ca35d7722c8272d268dd94a2c6f03d5a78ebb", "committedDate": "2020-07-08T19:44:46Z", "message": "Create Operation enum representing GraphQL operations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5854555b5199366fddd274c6f77ce5262bb4de1d", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/5854555b5199366fddd274c6f77ce5262bb4de1d", "committedDate": "2020-07-08T23:38:48Z", "message": "Merge branch 'main' into rm/ownerauth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc8f0f46783cf83e45956f115aac0bb8696504e2", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/dc8f0f46783cf83e45956f115aac0bb8696504e2", "committedDate": "2020-07-11T03:23:34Z", "message": "Capitalize first letter of modelName"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2Nzc5NzI4", "url": "https://github.com/aws-amplify/amplify-android/pull/596#pullrequestreview-446779728", "createdAt": "2020-07-11T05:25:57Z", "commit": {"oid": "dc8f0f46783cf83e45956f115aac0bb8696504e2"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwNToyNTo1N1rOGwKlIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODo1NTozM1rOGw1llw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE1ODE3Ng==", "bodyText": "We should remove all setters added in this PR. The style of the existing code base is to have:\nImmutableObject newCopy = oldCopy.builder().withSomeChange(newItemValue).build();", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r453158176", "createdAt": "2020-07-11T05:25:57Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -255,7 +257,21 @@ public void configure(\n             return null;\n         }\n \n-        SubscriptionOperation<T> operation = SubscriptionOperation.<T>builder()\n+        if (graphQLRequest instanceof AppSyncGraphQLRequest) {\n+            try {\n+                AppSyncGraphQLRequest<R> request = (AppSyncGraphQLRequest<R>) graphQLRequest;\n+                CognitoUserPoolsAuthProvider cognitoProvider = authProvider.getCognitoUserPoolsAuthProvider();\n+                if (cognitoProvider == null) {\n+                    cognitoProvider = new DefaultCognitoUserPoolsAuthProvider();\n+                }\n+                request.setOwner(cognitoProvider);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc8f0f46783cf83e45956f115aac0bb8696504e2"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE1ODIyMg==", "bodyText": "Can you return a NoOpOperation or something? Or are the other ones already returning null, I forget?", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r453158222", "createdAt": "2020-07-11T05:26:31Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -255,7 +257,21 @@ public void configure(\n             return null;\n         }\n \n-        SubscriptionOperation<T> operation = SubscriptionOperation.<T>builder()\n+        if (graphQLRequest instanceof AppSyncGraphQLRequest) {\n+            try {\n+                AppSyncGraphQLRequest<R> request = (AppSyncGraphQLRequest<R>) graphQLRequest;\n+                CognitoUserPoolsAuthProvider cognitoProvider = authProvider.getCognitoUserPoolsAuthProvider();\n+                if (cognitoProvider == null) {\n+                    cognitoProvider = new DefaultCognitoUserPoolsAuthProvider();\n+                }\n+                request.setOwner(cognitoProvider);\n+            } catch (ApiException exception) {\n+                onSubscriptionFailure.accept(exception);\n+                return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc8f0f46783cf83e45956f115aac0bb8696504e2"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE1ODMzNA==", "bodyText": "setVariable -- a variable of a set? Or (the verb, 2p imperative) \"do set\" a thing called a variable? should this just be .variable, to match the style of the others?", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r453158334", "createdAt": "2020-07-11T05:28:17Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLRequest.java", "diffHunk": "@@ -0,0 +1,299 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import android.text.TextUtils;\n+import androidx.annotation.NonNull;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.api.ApiException;\n+import com.amplifyframework.api.aws.appsync.GsonVariablesSerializer;\n+import com.amplifyframework.api.aws.sigv4.CognitoUserPoolsAuthProvider;\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.OperationType;\n+import com.amplifyframework.api.graphql.QueryType;\n+import com.amplifyframework.api.graphql.SubscriptionType;\n+import com.amplifyframework.core.model.AuthRule;\n+import com.amplifyframework.core.model.AuthStrategy;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelOperation;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.util.Casing;\n+import com.amplifyframework.util.Wrap;\n+\n+import java.lang.reflect.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * A request against an AppSync GraphQL endpoint.\n+ * @param <R> The type of data contained in the GraphQLResponse expected from this request.\n+ */\n+public final class AppSyncGraphQLRequest<R> extends GraphQLRequest<R> {\n+    private static final int DEFAULT_DEPTH = 2;\n+\n+    private final ModelSchema modelSchema;\n+    private final OperationType operationType;\n+    private final SelectionSet selectionSet;\n+    private final Map<String, Object> variables;\n+    private final Map<String, String> variableTypes;\n+\n+    /**\n+     * Constructor for AppSyncGraphQLRequest.\n+     * @throw AmplifyException if a ModelSchema can't be derived from the provided model class\n+     */\n+    private AppSyncGraphQLRequest(Builder builder) throws AmplifyException {\n+        super(builder.responseType, new GsonVariablesSerializer());\n+        this.modelSchema = ModelSchema.fromModelClass(builder.modelClass);\n+        this.selectionSet = SelectionSet.Factory.fromModelClass(builder.modelClass,\n+                builder.operationType,\n+                DEFAULT_DEPTH);\n+        this.operationType = builder.operationType;\n+        this.variables = builder.variables;\n+        this.variableTypes = builder.variableTypes;\n+    }\n+\n+    /**\n+     * Copy constructor for an AppSyncGraphQLRequest.\n+     * @param request request to copy.\n+     * @param <R> response type.\n+     */\n+    public <R> AppSyncGraphQLRequest(AppSyncGraphQLRequest<R> request) {\n+        super(request);\n+        this.modelSchema = request.modelSchema;\n+        this.operationType = request.operationType;\n+        this.selectionSet = new SelectionSet(request.selectionSet);\n+        this.variables = new HashMap<>(request.variables);\n+        this.variableTypes = new HashMap<>(request.variableTypes);\n+    }\n+\n+    @Override\n+    public <R> AppSyncGraphQLRequest<R> copy() {\n+        return new AppSyncGraphQLRequest<R>(this);\n+    }\n+\n+    @Override\n+    public Map<String, Object> getVariables() {\n+        return this.variables;\n+    }\n+\n+    /**\n+     * Used for setting a variable on the request.\n+     * @param key variable name\n+     * @param type type of variable value\n+     * @param value variable value\n+     */\n+    public void setVariable(String key, String type, String value) {\n+        this.variables.put(key, value);\n+        this.variableTypes.put(key, type);\n+    }\n+\n+    /**\n+     * Used to add owner argument from authProvider if needed.\n+     * @param authProvider CognitoUserPoolsAuthProvider for obtaining the username to set as the owner field.\n+     * @throws ApiException if request requires owner argument and authProvider or authProvider.getUsername() is null.\n+     */\n+    public void setOwner(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        for (AuthRule authRule : modelSchema.getAuthRules()) {\n+            if (isOwnerArgumentRequired(authRule)) {\n+                setVariable(authRule.getOwnerFieldOrDefault(), \"String!\", getUsername(authProvider));\n+            }\n+        }\n+    }\n+\n+    private String getUsername(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+        if (authProvider == null) {\n+            throw new ApiException(\n+                    \"Attempted to subscribe to a model with owner based authorization without a Cognito provider\",\n+                    \"Did you add the AWSCognitoAuthPlugin to Amplify before configuring it?\"\n+            );\n+        }\n+        String username = authProvider.getUsername();\n+        if (username == null) {\n+            throw new ApiException(\n+                    \"Attempted to subscribe to a model with owner based authorization without a username\",\n+                    \"Make sure that a user is logged in before subscribing to a model with owner based auth\"\n+            );\n+        }\n+        return username;\n+    }\n+\n+    private boolean isOwnerArgumentRequired(AuthRule authRule) {\n+        if (!AuthStrategy.OWNER.equals(authRule.getAuthStrategy())) {\n+            return false;\n+        }\n+        List<ModelOperation> operations = authRule.getOperationsOrDefault();\n+        if (SubscriptionType.ON_CREATE.equals(operationType) && operations.contains(ModelOperation.CREATE)) {\n+            return true;\n+        }\n+        if (SubscriptionType.ON_UPDATE.equals(operationType) && operations.contains(ModelOperation.UPDATE)) {\n+            return true;\n+        }\n+        if (SubscriptionType.ON_DELETE.equals(operationType) && operations.contains(ModelOperation.DELETE)) {\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     *  Returns String value used for GraphQL \"query\" in HTTP request body.\n+     *\n+     *  Sample return value:\n+     *      subscription OnCreatePerson(owner: String!, nextToken: String) {\n+     *            onCreatePerson(owner: $owner, nextToken: $nextToken) {\n+     *               age dob first_name id last_name relationship owner\n+     *            }\n+     *       }\n+     *\n+     * @return String value used for GraphQL \"query\" in HTTP request body\n+     */\n+    @Override\n+    public String getQuery() {\n+        String inputTypeString = \"\";\n+        String inputParameterString = \"\";\n+        if (variableTypes.size() > 0) {\n+            List<String> inputKeys = new ArrayList<>(variableTypes.keySet());\n+            Collections.sort(inputKeys);\n+\n+            List<String> inputTypes = new ArrayList<>();\n+            List<String> inputParameters = new ArrayList<>();\n+            for (String key : inputKeys) {\n+                inputTypes.add(\"$\" + key + \": \" + variableTypes.get(key));\n+                inputParameters.add(key + \": $\" + key);\n+            }\n+\n+            inputTypeString = Wrap.inParentheses(TextUtils.join(\", \", inputTypes));\n+            inputParameterString = Wrap.inParentheses(TextUtils.join(\", \", inputParameters));\n+        }\n+\n+        String modelName = Casing.capitalizeFirst(modelSchema.getName());\n+        String operationString = new StringBuilder()\n+                .append(Casing.from(Casing.CaseType.SCREAMING_SNAKE_CASE).to(Casing.CaseType.CAMEL_CASE)\n+                        .convert(operationType.toString()))\n+                .append(modelName)\n+                .append(QueryType.LIST.equals(operationType) ? \"s\" : \"\")\n+                .append(inputParameterString)\n+                .append(selectionSet.toString())\n+                .toString();\n+\n+        String queryString = new StringBuilder()\n+                .append(operationType.getOperation().getName())\n+                .append(\" \")\n+                .append(Casing.from(Casing.CaseType.SCREAMING_SNAKE_CASE).to(Casing.CaseType.PASCAL_CASE)\n+                        .convert(operationType.toString()))\n+                .append(modelName)\n+                .append(inputTypeString)\n+                .append(\" \")\n+                .append(Wrap.inBraces(operationString))\n+                .toString();\n+\n+        return queryString;\n+    }\n+\n+    @Override\n+    public boolean equals(Object object) {\n+        if (this == object) {\n+            return true;\n+        }\n+\n+        if (object == null || getClass() != object.getClass()) {\n+            return false;\n+        }\n+        if (!super.equals(object)) {\n+            return false;\n+        }\n+        AppSyncGraphQLRequest<?> that = (AppSyncGraphQLRequest<?>) object;\n+        return ObjectsCompat.equals(modelSchema, that.modelSchema) &&\n+                ObjectsCompat.equals(operationType, that.operationType) &&\n+                ObjectsCompat.equals(selectionSet, that.selectionSet) &&\n+                ObjectsCompat.equals(variables, that.variables) &&\n+                ObjectsCompat.equals(variableTypes, that.variableTypes);\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return ObjectsCompat.hash(super.hashCode(), modelSchema, operationType, selectionSet, variables, variableTypes);\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return \"AppSyncGraphQLRequest{\" +\n+                \"modelSchema=\" + modelSchema +\n+                \", operationType=\" + operationType +\n+                \", selectionSet=\" + selectionSet +\n+                \", variables=\" + variables +\n+                \", variableTypes=\" + variableTypes +\n+                \", responseType=\" + getResponseType() +\n+                \", variablesSerializer=\" + getVariablesSerializer() +\n+                '}';\n+    }\n+\n+    /**\n+     * Create a new AppSyncGraphQLRequest builder.\n+     * @return a new AppSyncGraphQLRequest builder.\n+     */\n+    public static AppSyncGraphQLRequest.Builder builder() {\n+        return new Builder();\n+    }\n+\n+    static final class Builder {\n+        private Class<? extends Model> modelClass;\n+        private OperationType operationType;\n+        private Type responseType;\n+        private final Map<String, Object> variables;\n+        private final Map<String, String> variableTypes;\n+\n+        Builder() {\n+            this.variables = new HashMap<>();\n+            this.variableTypes = new HashMap<>();\n+        }\n+\n+        Builder modelClass(@NonNull Class<? extends Model> modelClass) {\n+            this.modelClass = Objects.requireNonNull(modelClass);\n+            return Builder.this;\n+        }\n+\n+        Builder operationType(@NonNull OperationType operationType) {\n+            this.operationType = Objects.requireNonNull(operationType);\n+            return Builder.this;\n+        }\n+\n+        Builder responseType(@NonNull Type responseType) {\n+            this.responseType = Objects.requireNonNull(responseType);\n+            return Builder.this;\n+        }\n+\n+        Builder setVariable(@NonNull String key, String type, Object value) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc8f0f46783cf83e45956f115aac0bb8696504e2"}, "originalPosition": 284}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg2MjQ2OA==", "bodyText": "Are these named in reverse? Should an Operation have a getOperationType(), which returns an OperationType.SUBSCRIPTION, etc.?", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r453862468", "createdAt": "2020-07-13T18:55:00Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/api/graphql/Operation.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.graphql;\n+\n+/**\n+ * Represents a GraphQL operation.\n+ */\n+public enum Operation {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc8f0f46783cf83e45956f115aac0bb8696504e2"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg2MjgwNw==", "bodyText": "Collections.emptyMap()", "url": "https://github.com/aws-amplify/amplify-android/pull/596#discussion_r453862807", "createdAt": "2020-07-13T18:55:33Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/api/graphql/SimpleGraphQLRequest.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.graphql;\n+\n+import androidx.core.util.ObjectsCompat;\n+\n+import java.lang.reflect.Type;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * A basic implementation of GraphQLRequest, which takes a document String, and variables Map.\n+ * @param <R> Type of R, the data contained in the GraphQLResponse expected from this request\n+ */\n+public final class SimpleGraphQLRequest<R> extends GraphQLRequest<R> {\n+    private final String document;\n+    private final Map<String, Object> variables;\n+\n+    /**\n+     * Constructor for SimpleGraphQLRequest.\n+     * @param document document String for request\n+     * @param responseType Type of R, the data contained in the GraphQLResponse expected from this request\n+     * @param variablesSerializer an object which can take a map of variables and serialize it properly\n+     */\n+    public SimpleGraphQLRequest(\n+            String document,\n+            Type responseType,\n+            VariablesSerializer variablesSerializer\n+    ) {\n+        this(document, new HashMap<>(), responseType, variablesSerializer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc8f0f46783cf83e45956f115aac0bb8696504e2"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aac72dcd1dbee59ae12d558d6f95e269a52d42e4", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/aac72dcd1dbee59ae12d558d6f95e269a52d42e4", "committedDate": "2020-07-13T21:08:57Z", "message": "emptyMap instead of new HashMap"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1825, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}