{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNjkwMzEx", "number": 227, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzoxNDoyN1rODWsnqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzo0Mjo0OVrODWs7ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MTI2MzEzOnYy", "diffSide": "RIGHT", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzoxNDoyN1rOFbmvNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzoxNDoyN1rOFbmvNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5MDU1MA==", "bodyText": "Maybe, instead, \"Verify that there is a model in the datastore that matches the provided predicate.\" ?", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364490550", "createdAt": "2020-01-08T23:14:27Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "diffHunk": "@@ -81,21 +81,36 @@ public void initialize(\n     public <T extends Model> void save(\n             @NonNull final T item,\n             @NonNull final StorageItemChange.Initiator initiator,\n-            @NonNull final QueryPredicate predicate,\n+            @Nullable final QueryPredicate predicate,\n             @NonNull final Consumer<StorageItemChange.Record> onSuccess,\n             @NonNull final Consumer<DataStoreException> onError\n     ) {\n-        items.add(item);\n-        StorageItemChange.Record save = StorageItemChange.<T>builder()\n-                .item(item)\n-                .itemClass((Class<T>) item.getClass())\n-                .type(StorageItemChange.Type.SAVE)\n-                .predicate(predicate)\n-                .initiator(initiator)\n-                .build()\n-                .toRecord(storageItemChangeConverter);\n-        changeRecordStream.onNext(save);\n-        onSuccess.accept(save);\n+        final int index = indexOf(item);\n+        if (index > -1) {\n+            // Update\n+            Model savedItem = items.get(index);\n+            if (predicate == null || predicate.evaluate(savedItem)) {\n+                items.remove(index);\n+                save(item, initiator, predicate, onSuccess, onError);\n+                return;\n+            }\n+            onError.accept(new DataStoreException(\n+                    \"Conditional check failed.\",\n+                    \"Verify the saved models.\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a888221d77168ae8ee39a7f7b90f453486d689f"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MTI2NTE2OnYy", "diffSide": "RIGHT", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzoxNTozN1rOFbmwfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzoyNToxMlrOFbm7uQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5MDg3Nw==", "bodyText": "You can cut out this inner body, and make it a helper method called update(..), perhaps? This will help keep the line length of the save(...) method down. However, if they re-use tons of the same params, it might end up being too minor of a savings.", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364490877", "createdAt": "2020-01-08T23:15:37Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "diffHunk": "@@ -81,21 +81,36 @@ public void initialize(\n     public <T extends Model> void save(\n             @NonNull final T item,\n             @NonNull final StorageItemChange.Initiator initiator,\n-            @NonNull final QueryPredicate predicate,\n+            @Nullable final QueryPredicate predicate,\n             @NonNull final Consumer<StorageItemChange.Record> onSuccess,\n             @NonNull final Consumer<DataStoreException> onError\n     ) {\n-        items.add(item);\n-        StorageItemChange.Record save = StorageItemChange.<T>builder()\n-                .item(item)\n-                .itemClass((Class<T>) item.getClass())\n-                .type(StorageItemChange.Type.SAVE)\n-                .predicate(predicate)\n-                .initiator(initiator)\n-                .build()\n-                .toRecord(storageItemChangeConverter);\n-        changeRecordStream.onNext(save);\n-        onSuccess.accept(save);\n+        final int index = indexOf(item);\n+        if (index > -1) {\n+            // Update", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a888221d77168ae8ee39a7f7b90f453486d689f"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5Mzc1Mw==", "bodyText": "yea that's the conclusion i've reached: that they share too many parameters to actually take advantage of this", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364493753", "createdAt": "2020-01-08T23:25:12Z", "author": {"login": "raphkim"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "diffHunk": "@@ -81,21 +81,36 @@ public void initialize(\n     public <T extends Model> void save(\n             @NonNull final T item,\n             @NonNull final StorageItemChange.Initiator initiator,\n-            @NonNull final QueryPredicate predicate,\n+            @Nullable final QueryPredicate predicate,\n             @NonNull final Consumer<StorageItemChange.Record> onSuccess,\n             @NonNull final Consumer<DataStoreException> onError\n     ) {\n-        items.add(item);\n-        StorageItemChange.Record save = StorageItemChange.<T>builder()\n-                .item(item)\n-                .itemClass((Class<T>) item.getClass())\n-                .type(StorageItemChange.Type.SAVE)\n-                .predicate(predicate)\n-                .initiator(initiator)\n-                .build()\n-                .toRecord(storageItemChangeConverter);\n-        changeRecordStream.onNext(save);\n-        onSuccess.accept(save);\n+        final int index = indexOf(item);\n+        if (index > -1) {\n+            // Update", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5MDg3Nw=="}, "originalCommit": {"oid": "3a888221d77168ae8ee39a7f7b90f453486d689f"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MTI2Njk2OnYy", "diffSide": "RIGHT", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzoxNjozN1rOFbmxjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzoxNjozN1rOFbmxjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5MTE0OQ==", "bodyText": "Same as above, consider breaking this stuff out into a helper method called create. The semantics would become like \"A save is either an update, or a create, depending on whether or not index is non-zero.\"\n} else {\n  create(...);\n}", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364491149", "createdAt": "2020-01-08T23:16:37Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "diffHunk": "@@ -81,21 +81,36 @@ public void initialize(\n     public <T extends Model> void save(\n             @NonNull final T item,\n             @NonNull final StorageItemChange.Initiator initiator,\n-            @NonNull final QueryPredicate predicate,\n+            @Nullable final QueryPredicate predicate,\n             @NonNull final Consumer<StorageItemChange.Record> onSuccess,\n             @NonNull final Consumer<DataStoreException> onError\n     ) {\n-        items.add(item);\n-        StorageItemChange.Record save = StorageItemChange.<T>builder()\n-                .item(item)\n-                .itemClass((Class<T>) item.getClass())\n-                .type(StorageItemChange.Type.SAVE)\n-                .predicate(predicate)\n-                .initiator(initiator)\n-                .build()\n-                .toRecord(storageItemChangeConverter);\n-        changeRecordStream.onNext(save);\n-        onSuccess.accept(save);\n+        final int index = indexOf(item);\n+        if (index > -1) {\n+            // Update\n+            Model savedItem = items.get(index);\n+            if (predicate == null || predicate.evaluate(savedItem)) {\n+                items.remove(index);\n+                save(item, initiator, predicate, onSuccess, onError);\n+                return;\n+            }\n+            onError.accept(new DataStoreException(\n+                    \"Conditional check failed.\",\n+                    \"Verify the saved models.\"));\n+        } else {\n+            // Insert", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a888221d77168ae8ee39a7f7b90f453486d689f"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MTI2OTc3OnYy", "diffSide": "RIGHT", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzoxODowMFrOFbmzLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzozMzo0OVrOFbnFow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5MTU2Ng==", "bodyText": "You could invert this expression, and put the error handling in the body.\nThen, do your happy path back -4 indentation to the left.\ne.g.\nif (unlikeBadThing) {\n    announce(\"Hey no fair...\");\n    return;\n}\n// otherwise\nperformBusiness();\nasUsual();\netc();", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364491566", "createdAt": "2020-01-08T23:18:00Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "diffHunk": "@@ -144,22 +159,23 @@ public void initialize(\n             @NonNull final Consumer<StorageItemChange.Record> onSuccess,\n             @NonNull final Consumer<DataStoreException> onError\n     ) {\n-        for (Model savedItem : items) {\n-            if (savedItem.getId().equals(item.getId())\n-                    && (predicate == null || predicate.evaluate(item))) {\n-                items.remove(item);\n-                StorageItemChange.Record deletion = StorageItemChange.<T>builder()\n-                        .item((T) savedItem)\n-                        .itemClass((Class<T>) savedItem.getClass())\n-                        .type(StorageItemChange.Type.DELETE)\n-                        .predicate(predicate)\n-                        .initiator(initiator)\n-                        .build()\n-                        .toRecord(storageItemChangeConverter);\n-                changeRecordStream.onNext(deletion);\n-                onSuccess.accept(deletion);\n-                return;\n-            }\n+        final int index = indexOf(item);\n+        if (index > -1 && (predicate == null || predicate.evaluate(item))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a888221d77168ae8ee39a7f7b90f453486d689f"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5NjI5MQ==", "bodyText": "good idea. Also caught a bug where i checked the predicate condition against item to delete rather than on the already stored item.", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364496291", "createdAt": "2020-01-08T23:33:49Z", "author": {"login": "raphkim"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "diffHunk": "@@ -144,22 +159,23 @@ public void initialize(\n             @NonNull final Consumer<StorageItemChange.Record> onSuccess,\n             @NonNull final Consumer<DataStoreException> onError\n     ) {\n-        for (Model savedItem : items) {\n-            if (savedItem.getId().equals(item.getId())\n-                    && (predicate == null || predicate.evaluate(item))) {\n-                items.remove(item);\n-                StorageItemChange.Record deletion = StorageItemChange.<T>builder()\n-                        .item((T) savedItem)\n-                        .itemClass((Class<T>) savedItem.getClass())\n-                        .type(StorageItemChange.Type.DELETE)\n-                        .predicate(predicate)\n-                        .initiator(initiator)\n-                        .build()\n-                        .toRecord(storageItemChangeConverter);\n-                changeRecordStream.onNext(deletion);\n-                onSuccess.accept(deletion);\n-                return;\n-            }\n+        final int index = indexOf(item);\n+        if (index > -1 && (predicate == null || predicate.evaluate(item))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5MTU2Ng=="}, "originalCommit": {"oid": "3a888221d77168ae8ee39a7f7b90f453486d689f"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MTMxNDU5OnYy", "diffSide": "RIGHT", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzo0Mjo0OVrOFbnOfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzo0NDozM1rOFbnQNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5ODU1OA==", "bodyText": "I think you need a return; here, too, afteryou fire onError.accept(...).", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364498558", "createdAt": "2020-01-08T23:42:49Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "diffHunk": "@@ -160,23 +160,30 @@ public void initialize(\n             @NonNull final Consumer<DataStoreException> onError\n     ) {\n         final int index = indexOf(item);\n-        if (index > -1 && (predicate == null || predicate.evaluate(item))) {\n-            Model savedItem = items.remove(index);\n-            StorageItemChange.Record deletion = StorageItemChange.<T>builder()\n-                    .item((T) savedItem)\n-                    .itemClass((Class<T>) savedItem.getClass())\n-                    .type(StorageItemChange.Type.DELETE)\n-                    .predicate(predicate)\n-                    .initiator(initiator)\n-                    .build()\n-                    .toRecord(storageItemChangeConverter);\n-            changeRecordStream.onNext(deletion);\n-            onSuccess.accept(deletion);\n-        } else {\n+        if (index < 0) {\n             onError.accept(new DataStoreException(\n-                    \"Item does not exist or conditional check failed.\",\n-                    \"Verify the saved models.\"));\n+                    \"This item was not found in the datastore: \" + item.toString(),\n+                    \"Use save() function to create models to store.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57f4de60dea81f97f7b78e866fe2a2576adc8ab3"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5ODk5Ng==", "bodyText": "AHA! pushed the change right before this comment ;)", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364498996", "createdAt": "2020-01-08T23:44:33Z", "author": {"login": "raphkim"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "diffHunk": "@@ -160,23 +160,30 @@ public void initialize(\n             @NonNull final Consumer<DataStoreException> onError\n     ) {\n         final int index = indexOf(item);\n-        if (index > -1 && (predicate == null || predicate.evaluate(item))) {\n-            Model savedItem = items.remove(index);\n-            StorageItemChange.Record deletion = StorageItemChange.<T>builder()\n-                    .item((T) savedItem)\n-                    .itemClass((Class<T>) savedItem.getClass())\n-                    .type(StorageItemChange.Type.DELETE)\n-                    .predicate(predicate)\n-                    .initiator(initiator)\n-                    .build()\n-                    .toRecord(storageItemChangeConverter);\n-            changeRecordStream.onNext(deletion);\n-            onSuccess.accept(deletion);\n-        } else {\n+        if (index < 0) {\n             onError.accept(new DataStoreException(\n-                    \"Item does not exist or conditional check failed.\",\n-                    \"Verify the saved models.\"));\n+                    \"This item was not found in the datastore: \" + item.toString(),\n+                    \"Use save() function to create models to store.\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5ODU1OA=="}, "originalCommit": {"oid": "57f4de60dea81f97f7b78e866fe2a2576adc8ab3"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1504, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}