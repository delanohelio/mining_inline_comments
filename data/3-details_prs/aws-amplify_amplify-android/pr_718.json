{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MzQyMDE4", "number": 718, "title": "fix(aws-datastore): remove insert statement cache", "bodyText": "Issue #, if available:\n#595\nDescription of changes:\nRemoved caching logic for insert statements:\nWhen the SQLiteStorageAdapter was first written, small optimization logic was added to cache insert statements during initialization. These statements were to be re-used whenever new entries were being entered in a table. Currently, no other types of sqlite statements are cached like this, and are generated on the spot whenever they are called.\nWhen the database was updated with new tables, it caused a chicken-and-egg problem between generating insert statements and updating the database. To prevent this problem, the original optimization logic is removed in this PR so that insert statements are prepared on the spot like the other types of sqlite operations.\nNo explicit tests were written, but I was able to confirm the fix with @rjuliano 's suggestion for reproducing the bug.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-08-11T20:35:45Z", "url": "https://github.com/aws-amplify/amplify-android/pull/718", "merged": true, "mergeCommit": {"oid": "c5dfb8cbf8d2fde3342fa11ae09b316048abde96"}, "closed": true, "closedAt": "2020-08-12T19:42:22Z", "author": {"login": "raphkim"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc98d6FAH2gAyNDY2MzQyMDE4OmY4MTQzYzMzY2U3NDdmMWJjMjhiZGQyYTUxOTQ3NGE1YTNmOWI3YjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-OGHKAH2gAyNDY2MzQyMDE4OjNjMTRkZTY5Y2I4MTM1N2FkNzlmZTM4OWY4Nzk0YzBlMmUxNTMxOGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f8143c33ce747f1bc28bdd2a519474a5a3f9b7b4", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/f8143c33ce747f1bc28bdd2a519474a5a3f9b7b4", "committedDate": "2020-08-11T20:02:26Z", "message": "fix(aws-datastore): remove insert statement cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NDE0Njc0", "url": "https://github.com/aws-amplify/amplify-android/pull/718#pullrequestreview-465414674", "createdAt": "2020-08-11T20:44:09Z", "commit": {"oid": "f8143c33ce747f1bc28bdd2a519474a5a3f9b7b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NDE1Nzcw", "url": "https://github.com/aws-amplify/amplify-android/pull/718#pullrequestreview-465415770", "createdAt": "2020-08-11T20:45:49Z", "commit": {"oid": "f8143c33ce747f1bc28bdd2a519474a5a3f9b7b4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMDo0NTo0OVrOG_ImXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMDo0NTo0OVrOG_ImXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg1NDM2Ng==", "bodyText": "Can you delete the getInsertSqlPreparedStatements() method itself now too?", "url": "https://github.com/aws-amplify/amplify-android/pull/718#discussion_r468854366", "createdAt": "2020-08-11T20:45:49Z", "author": {"login": "richardmcclellan"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/sqlite/SQLiteStorageAdapter.java", "diffHunk": "@@ -217,17 +212,6 @@ public synchronized void initialize(\n                 databaseConnectionHandle = sqliteStorageHelper.getWritableDatabase();\n                 this.sqlCommandFactory = new SQLiteCommandFactory(modelSchemaRegistry, databaseConnectionHandle);\n \n-                /*\n-                 * Create INSERT INTO TABLE_NAME statements for all SQL tables\n-                 * and compile them and store in an in-memory map. Later, when a\n-                 * {@link #save(T, Consumer, Consumer)} operation needs to insert\n-                 * an object (sql rows) into the database, it can bind the input\n-                 * values with the prepared insert statement.\n-                 *\n-                 * This is done to improve performance of database write operations.\n-                 */\n-                this.insertSqlPreparedStatements = getInsertSqlPreparedStatements();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8143c33ce747f1bc28bdd2a519474a5a3f9b7b4"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62aab2f79435e04648bf9ab935ba012f5e92c2a4", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/62aab2f79435e04648bf9ab935ba012f5e92c2a4", "committedDate": "2020-08-11T21:23:50Z", "message": "remove unused method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NDQyOTQz", "url": "https://github.com/aws-amplify/amplify-android/pull/718#pullrequestreview-465442943", "createdAt": "2020-08-11T21:30:23Z", "commit": {"oid": "f8143c33ce747f1bc28bdd2a519474a5a3f9b7b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bef0d791bffb690412ade5085535681682b1ace1", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/bef0d791bffb690412ade5085535681682b1ace1", "committedDate": "2020-08-11T22:20:34Z", "message": "introduce new model to model provider to force db update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7876b7c9538eb05ac9d1a268472fc8f50eff9f0", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/a7876b7c9538eb05ac9d1a268472fc8f50eff9f0", "committedDate": "2020-08-12T03:36:17Z", "message": "Merge branch 'main' of https://github.com/aws-amplify/amplify-android into sqlite-update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c14de69cb81357ad79fe389f8794c0e2e15318a", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/3c14de69cb81357ad79fe389f8794c0e2e15318a", "committedDate": "2020-08-12T16:34:44Z", "message": "Merge branch 'main' of https://github.com/aws-amplify/amplify-android into sqlite-update"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1943, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}