{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNjc3MTg2", "number": 608, "title": "ci: improve integration test retry logic", "bodyText": "With these changes, I was able to get a green checkmark on the integrationtest step 4 out of 5 times.  The one failure was because the emulator didn't start.\n\nIntegration tests now run one module at a time (e.g. ./gradlew aws-api:connectedDebugAndroidTest instead of ./gradlew connectedDebugAndroidTest, and retry logic is applied at the module level.  So, if an aws-api integration test fails, it only retries aws-api, instead of the whole suite.\nUpdated hash for codecov.io/bash script, since there was an update to the script.\n\nI have a hunch that the main reason for the improvement here is actually not because of modularizing retries, but because the tasks are not running in parallel anymore.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-06-26T16:28:34Z", "url": "https://github.com/aws-amplify/amplify-android/pull/608", "merged": true, "mergeCommit": {"oid": "b11c8e8a51afd3bf730b33a3ed0fa950b281fc30"}, "closed": true, "closedAt": "2020-06-26T23:51:09Z", "author": {"login": "richardmcclellan"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcu4lvHAH2gAyNDQwNjc3MTg2OjIwYjcyZmQyMmY2YWJiNTE3MmE4OGIxYjQzNTJjY2IwM2ViMzY1ZGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvMJx-ABqjM0ODg0NDM2NTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "20b72fd22f6abb5172a88b1b4352ccb03eb365db", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/20b72fd22f6abb5172a88b1b4352ccb03eb365db", "committedDate": "2020-06-26T01:02:30Z", "message": "Retry integration tests, one module at a time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a651c0e48bb6fb482d89ef923b27470f90fe8a55", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/a651c0e48bb6fb482d89ef923b27470f90fe8a55", "committedDate": "2020-06-26T01:53:09Z", "message": "Add ./"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a92bfda9d5bea72d81e06fde65adaaa24bfa382", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/2a92bfda9d5bea72d81e06fde65adaaa24bfa382", "committedDate": "2020-06-26T02:23:37Z", "message": "Debugging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40057b68183cbb9a5fcb968fd17f3ff5a6e683e5", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/40057b68183cbb9a5fcb968fd17f3ff5a6e683e5", "committedDate": "2020-06-26T02:37:29Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bfe40a7802bef0c8e30d4e283b80748ed48861b", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/1bfe40a7802bef0c8e30d4e283b80748ed48861b", "committedDate": "2020-06-26T02:47:44Z", "message": "Remove debug code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ae191578423da4a9ce9fba09c7de3a945a2ba61", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/2ae191578423da4a9ce9fba09c7de3a945a2ba61", "committedDate": "2020-06-26T03:03:14Z", "message": "Add logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9d5562f15fc465656bd58d9d076ba06893081bb", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/c9d5562f15fc465656bd58d9d076ba06893081bb", "committedDate": "2020-06-26T03:09:56Z", "message": "more logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9be069f4b1bffa6a052aabfacc4e58d13cbb4d2a", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/9be069f4b1bffa6a052aabfacc4e58d13cbb4d2a", "committedDate": "2020-06-26T03:32:01Z", "message": "Fix indents"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b69a21cd1c3354122417d9db05000195732d0d9", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/3b69a21cd1c3354122417d9db05000195732d0d9", "committedDate": "2020-06-26T06:22:32Z", "message": "printf instead of echo so that \\n works"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80faab09b7af58694f08398cad1173c8a55bed6d", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/80faab09b7af58694f08398cad1173c8a55bed6d", "committedDate": "2020-06-26T06:30:19Z", "message": "Update expected hash as codecov.io/bash script appears to have changed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7a4716f7cdbf5891098c40e7cc54e8431571852", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/e7a4716f7cdbf5891098c40e7cc54e8431571852", "committedDate": "2020-06-26T07:48:51Z", "message": "Add our own timeout, shorter than the circleci timeout, so we can retry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38542db090899606837f77bb868e210488cf51ef", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/38542db090899606837f77bb868e210488cf51ef", "committedDate": "2020-06-26T15:05:06Z", "message": "Revert \"Add our own timeout, shorter than the circleci timeout, so we can retry\"\n\nThis reverts commit e7a4716f7cdbf5891098c40e7cc54e8431571852."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0165d7d7e69429e29f3b4ab76b30721ddbfeb960", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/0165d7d7e69429e29f3b4ab76b30721ddbfeb960", "committedDate": "2020-06-26T15:16:34Z", "message": "circle test 1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cdb124c0d61f5892dba073d67278bacb1b6c146", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/0cdb124c0d61f5892dba073d67278bacb1b6c146", "committedDate": "2020-06-26T15:16:45Z", "message": "circle test 2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1380b8631faa836b150056bd0c719bd947b8786", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/e1380b8631faa836b150056bd0c719bd947b8786", "committedDate": "2020-06-26T15:16:54Z", "message": "circle test 3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed29dd406d4687998347fa1496ddcf6dbc241bcc", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/ed29dd406d4687998347fa1496ddcf6dbc241bcc", "committedDate": "2020-06-26T16:48:59Z", "message": "Fix logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "964c7a5f489296eef0aa42431d708d19f0fae616", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/964c7a5f489296eef0aa42431d708d19f0fae616", "committedDate": "2020-06-26T17:35:31Z", "message": "logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa84929e9565513f82d60d0c437fa154dd766201", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/aa84929e9565513f82d60d0c437fa154dd766201", "committedDate": "2020-06-26T17:39:50Z", "message": "logging and comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cbd3efd0a9c6b6a2a7659b50ba0fd52e6c58b43", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/2cbd3efd0a9c6b6a2a7659b50ba0fd52e6c58b43", "committedDate": "2020-06-26T18:33:20Z", "message": "Intentionally make a test fail to confirm circle task also fails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f2d18d8d5a01482cc83498a8d2d52c612e50543", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/9f2d18d8d5a01482cc83498a8d2d52c612e50543", "committedDate": "2020-06-26T18:33:54Z", "message": "Revert \"Intentionally make a test fail to confirm circle task also fails\"\n\nThis reverts commit 2cbd3efd0a9c6b6a2a7659b50ba0fd52e6c58b43."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NTcyNTE1", "url": "https://github.com/aws-amplify/amplify-android/pull/608#pullrequestreview-438572515", "createdAt": "2020-06-26T20:22:17Z", "commit": {"oid": "9f2d18d8d5a01482cc83498a8d2d52c612e50543"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMDoyMjoxOFrOGptoqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMDoyNTo1OVrOGptuZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5MjQ4OQ==", "bodyText": "So this might change more than we expected. Should we vendor this? What's the right (and secure) way? @jamesonwilliams", "url": "https://github.com/aws-amplify/amplify-android/pull/608#discussion_r446392489", "createdAt": "2020-06-26T20:22:18Z", "author": {"login": "jpignata"}, "path": ".circleci/config.yml", "diffHunk": "@@ -118,15 +118,15 @@ jobs:\n             .circleci/copy-configs\n       - run:\n           name: Run integration test\n-          command: .circleci/retry.sh 3 ./gradlew connectedDebugAndroidTest --no-daemon\n+          command: .circleci/run-integration-tests.sh\n       - run:\n           name: Store coverage data\n           command: |\n               .circleci/retry.sh 3 ./gradlew jacocoFullReport --no-daemon\n               tmp_file=\"$(mktemp)\"\n               curl -s https://codecov.io/bash > \"$tmp_file\"\n               actual_hash=\"$(cat $tmp_file | cksum | cut -f 1 -d\\ )\"\n-              expected_hash='2175291078'\n+              expected_hash='261829867'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f2d18d8d5a01482cc83498a8d2d52c612e50543"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5MzUwNg==", "bodyText": "I know this wasn't your code, but I think you need parentheses here. See shellcheck's wiki. Might be a good thing to run on shell scripts we modify.", "url": "https://github.com/aws-amplify/amplify-android/pull/608#discussion_r446393506", "createdAt": "2020-06-26T20:24:52Z", "author": {"login": "jpignata"}, "path": ".circleci/retry.sh", "diffHunk": "@@ -1,23 +1,25 @@\n #!/bin/bash\n # Usage: retry.sh <max_tries> <command to run>\n \n+tag=\"RETRY\"\n readonly max_tries=$1\n readonly command=\"${@: 2}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f2d18d8d5a01482cc83498a8d2d52c612e50543"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5Mzk1Nw==", "bodyText": "Nit: missing double quotes on the variable", "url": "https://github.com/aws-amplify/amplify-android/pull/608#discussion_r446393957", "createdAt": "2020-06-26T20:25:59Z", "author": {"login": "jpignata"}, "path": ".circleci/run-integration-tests.sh", "diffHunk": "@@ -0,0 +1,22 @@\n+#!/bin/bash\n+\n+tag=\"RUN_INTEGRATION_TESTS\"\n+return_code=0\n+\n+# List all available gradle tasks, grep for the integration test tasks, and then use cut to strip the task description\n+# and just return the name of the task, one for each module (e.g. aws-api:connectedDebugAndroidTest)\n+tasks=($(./gradlew tasks --all | grep connectedDebugAndroidTest | cut -d \" \" -f 1))\n+\n+# Run the integration tests for each module.  Make up to 3 attempts on each module before failing.\n+for task in \"${tasks[@]}\"; do\n+  echo \"$tag: Starting $task\"\n+  .circleci/retry.sh 3 ./gradlew $task --no-daemon", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f2d18d8d5a01482cc83498a8d2d52c612e50543"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba9931a4c12a1e998461011907144ccfb74844a6", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/ba9931a4c12a1e998461011907144ccfb74844a6", "committedDate": "2020-06-26T22:24:15Z", "message": "Fix shellcheck issues"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "ba9931a4c12a1e998461011907144ccfb74844a6", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/ba9931a4c12a1e998461011907144ccfb74844a6", "committedDate": "2020-06-26T22:24:15Z", "message": "Fix shellcheck issues"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1839, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}