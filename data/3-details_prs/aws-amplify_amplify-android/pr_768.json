{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0OTI0MjE1", "number": 768, "title": "feat(rxbindings) Create operation for subscription", "bodyText": "Issue #, if available:\nDescription of changes:\nCreated an operation class to address the subscription use case. The callback-style API invokes an onStart consumer with the subscriptionId. To align with iOS that aspect of the functionality will look a bit different the rxbindings for the API category.\nThe RxSubscriptionOperation will have two methods that return observables.\n\nobserveSubscriptionData: emits one event for each item received via the subscription.\nobserveConnectionState: when the onStart callback is triggered by the API category, we will publish a message to the observable and will save the subscriptionId as a property of the RxSubscriptionOperation. This will enable customer to listen for a start event if they wish, and also aligns our async functionality with the  iOS implementation.\n\nTo still provide access to the subscriptionId, the RxSubscriptionOperation also has a getSubscriptionId(), which consumers can use if they need that data.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-08-27T20:11:40Z", "url": "https://github.com/aws-amplify/amplify-android/pull/768", "merged": true, "mergeCommit": {"oid": "3013026bab63349702d8fd93b892c0d4e8812968"}, "closed": true, "closedAt": "2020-08-28T13:55:40Z", "author": {"login": "rjuliano"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDF2KzAH2gAyNDc0OTI0MjE1OjcwN2RlMGU0N2MxMjAzNjIyY2Y3NWY1Mzg2N2ExNjMyZGM0M2ZlOWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDVBf1gH2gAyNDc0OTI0MjE1OjAwYTU4ZTI4NTY3ZTE5MTc4OTdlMGEzZjlmZjQ0MmNlOGM0YTZhN2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "707de0e47c1203622cf75f53867a1632dc43fe9e", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/707de0e47c1203622cf75f53867a1632dc43fe9e", "committedDate": "2020-08-27T19:47:42Z", "message": "feat(rxbindings) Create operation for subscriptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6e9fe246eeb4ad18009cccb8f4b81392ec459c5", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/d6e9fe246eeb4ad18009cccb8f4b81392ec459c5", "committedDate": "2020-08-27T21:05:51Z", "message": "Merge branch 'feature/rxbindings' into rjuliano/rx-subscriptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9a635a4981fcad8056553f37c5e0264ea22b137", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/f9a635a4981fcad8056553f37c5e0264ea22b137", "committedDate": "2020-08-27T22:21:20Z", "message": "Fix  access modifiers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3d18f0d123f78a41c1dbf1489186e48f519a674", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/a3d18f0d123f78a41c1dbf1489186e48f519a674", "committedDate": "2020-08-27T23:08:19Z", "message": "Added test for cancellation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MjIzMTcy", "url": "https://github.com/aws-amplify/amplify-android/pull/768#pullrequestreview-477223172", "createdAt": "2020-08-28T03:51:13Z", "commit": {"oid": "a3d18f0d123f78a41c1dbf1489186e48f519a674"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwMzo1MToxM1rOHIolsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwMzo1OToyNFrOHIoszg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxNTY2Ng==", "bodyText": "Is this access level escalation required, for the implementation class? (The public methods will still be public.)", "url": "https://github.com/aws-amplify/amplify-android/pull/768#discussion_r478815666", "createdAt": "2020-08-28T03:51:13Z", "author": {"login": "jamesonwilliams"}, "path": "rxbindings/src/main/java/com/amplifyframework/rx/RxApiBinding.java", "diffHunk": "@@ -26,16 +26,19 @@\n import com.amplifyframework.api.rest.RestOptions;\n import com.amplifyframework.api.rest.RestResponse;\n import com.amplifyframework.core.Amplify;\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.core.async.Cancelable;\n import com.amplifyframework.rx.RxAdapters.CancelableBehaviors;\n \n import io.reactivex.rxjava3.core.Observable;\n import io.reactivex.rxjava3.core.Single;\n+import io.reactivex.rxjava3.subjects.BehaviorSubject;\n \n /**\n  * An implementation of the RxApiCategoryBehavior which satisfies the API contract by wrapping\n  * {@link ApiCategoryBehavior} in Rx primitives.\n  */\n-final class RxApiBinding implements RxApiCategoryBehavior {\n+public final class RxApiBinding implements RxApiCategoryBehavior {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3d18f0d123f78a41c1dbf1489186e48f519a674"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxNTkyNA==", "bodyText": "does it need to be public?", "url": "https://github.com/aws-amplify/amplify-android/pull/768#discussion_r478815924", "createdAt": "2020-08-28T03:52:16Z", "author": {"login": "jamesonwilliams"}, "path": "rxbindings/src/main/java/com/amplifyframework/rx/RxApiBinding.java", "diffHunk": "@@ -168,4 +173,83 @@\n             CancelableBehaviors.StreamEmitter<String, T, ApiException> method) {\n         return CancelableBehaviors.toObservable(method);\n     }\n+\n+    /**\n+     * A class that represents a subscription operation and exposes\n+     * observables for consumers to listen to subscription data and\n+     * status events.\n+     * @param <T> The type representing the subscription data.\n+     */\n+    public static final class RxSubscriptionOperation<T> implements Cancelable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3d18f0d123f78a41c1dbf1489186e48f519a674"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxNjIyNg==", "bodyText": "Maybe do this as an inner class (FooConsumer extends Consumer), and initialize it inside the constructor body? S.t. private final Consumer<String> onConnected; is up with the other ordinary declarations?", "url": "https://github.com/aws-amplify/amplify-android/pull/768#discussion_r478816226", "createdAt": "2020-08-28T03:53:39Z", "author": {"login": "jamesonwilliams"}, "path": "rxbindings/src/main/java/com/amplifyframework/rx/RxApiBinding.java", "diffHunk": "@@ -168,4 +173,83 @@\n             CancelableBehaviors.StreamEmitter<String, T, ApiException> method) {\n         return CancelableBehaviors.toObservable(method);\n     }\n+\n+    /**\n+     * A class that represents a subscription operation and exposes\n+     * observables for consumers to listen to subscription data and\n+     * status events.\n+     * @param <T> The type representing the subscription data.\n+     */\n+    public static final class RxSubscriptionOperation<T> implements Cancelable {\n+        private BehaviorSubject<ConnectionState> connectionStateSubject;\n+        private Observable<T> subscriptionData;\n+        private Cancelable amplifyOperation;\n+        private String subscriptionId;\n+\n+        private Consumer<String> onConnected = new Consumer<String>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3d18f0d123f78a41c1dbf1489186e48f519a674"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxNjkyMg==", "bodyText": "Is there any way to bundle this into the ConnectionState object?", "url": "https://github.com/aws-amplify/amplify-android/pull/768#discussion_r478816922", "createdAt": "2020-08-28T03:56:43Z", "author": {"login": "jamesonwilliams"}, "path": "rxbindings/src/main/java/com/amplifyframework/rx/RxApiBinding.java", "diffHunk": "@@ -168,4 +173,83 @@\n             CancelableBehaviors.StreamEmitter<String, T, ApiException> method) {\n         return CancelableBehaviors.toObservable(method);\n     }\n+\n+    /**\n+     * A class that represents a subscription operation and exposes\n+     * observables for consumers to listen to subscription data and\n+     * status events.\n+     * @param <T> The type representing the subscription data.\n+     */\n+    public static final class RxSubscriptionOperation<T> implements Cancelable {\n+        private BehaviorSubject<ConnectionState> connectionStateSubject;\n+        private Observable<T> subscriptionData;\n+        private Cancelable amplifyOperation;\n+        private String subscriptionId;\n+\n+        private Consumer<String> onConnected = new Consumer<String>() {\n+            @Override\n+            public void accept(@NonNull String subscriptionId) {\n+                RxSubscriptionOperation.this.subscriptionId = subscriptionId;\n+                connectionStateSubject.onNext(ConnectionState.CONNECTED);\n+            }\n+        };\n+\n+        RxSubscriptionOperation(CancelableBehaviors.StreamEmitter<String, T, ApiException> callbacks) {\n+            connectionStateSubject = BehaviorSubject.create();\n+            subscriptionData = Observable.create(emitter -> {\n+                amplifyOperation = callbacks.streamTo(onConnected::accept,\n+                                                      emitter::onNext,\n+                                                      emitter::onError,\n+                                                      emitter::onComplete);\n+            });\n+        }\n+\n+        /**\n+         * Returns an {@link Observable} which consumers can use to\n+         * retrieve data received by the subscription operation.\n+         * @return Reference to the {@link Observable} with subscription data.\n+         */\n+        public Observable<T> observeSubscriptionData() {\n+            return subscriptionData;\n+        }\n+\n+        /**\n+         * Once the subscription starts, this method returns\n+         * the value of the subscriptionId.\n+         * @return The value of the subscriptionId.\n+         */\n+        public String getSubscriptionId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3d18f0d123f78a41c1dbf1489186e48f519a674"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxNzMxNg==", "bodyText": "@palpatim notes:\n\nFWIW, we also notify on \"connecting\" and \"disconnected\" states. \"Connecting\" isn't terribly meaningful, and \"disconnected\" degrades to a completion on the subscription data publisher, so that may not be necessary in Android\n\nNot sure if we need to do this today -- or can defer.", "url": "https://github.com/aws-amplify/amplify-android/pull/768#discussion_r478817316", "createdAt": "2020-08-28T03:58:34Z", "author": {"login": "jamesonwilliams"}, "path": "rxbindings/src/main/java/com/amplifyframework/rx/RxApiBinding.java", "diffHunk": "@@ -168,4 +173,83 @@\n             CancelableBehaviors.StreamEmitter<String, T, ApiException> method) {\n         return CancelableBehaviors.toObservable(method);\n     }\n+\n+    /**\n+     * A class that represents a subscription operation and exposes\n+     * observables for consumers to listen to subscription data and\n+     * status events.\n+     * @param <T> The type representing the subscription data.\n+     */\n+    public static final class RxSubscriptionOperation<T> implements Cancelable {\n+        private BehaviorSubject<ConnectionState> connectionStateSubject;\n+        private Observable<T> subscriptionData;\n+        private Cancelable amplifyOperation;\n+        private String subscriptionId;\n+\n+        private Consumer<String> onConnected = new Consumer<String>() {\n+            @Override\n+            public void accept(@NonNull String subscriptionId) {\n+                RxSubscriptionOperation.this.subscriptionId = subscriptionId;\n+                connectionStateSubject.onNext(ConnectionState.CONNECTED);\n+            }\n+        };\n+\n+        RxSubscriptionOperation(CancelableBehaviors.StreamEmitter<String, T, ApiException> callbacks) {\n+            connectionStateSubject = BehaviorSubject.create();\n+            subscriptionData = Observable.create(emitter -> {\n+                amplifyOperation = callbacks.streamTo(onConnected::accept,\n+                                                      emitter::onNext,\n+                                                      emitter::onError,\n+                                                      emitter::onComplete);\n+            });\n+        }\n+\n+        /**\n+         * Returns an {@link Observable} which consumers can use to\n+         * retrieve data received by the subscription operation.\n+         * @return Reference to the {@link Observable} with subscription data.\n+         */\n+        public Observable<T> observeSubscriptionData() {\n+            return subscriptionData;\n+        }\n+\n+        /**\n+         * Once the subscription starts, this method returns\n+         * the value of the subscriptionId.\n+         * @return The value of the subscriptionId.\n+         */\n+        public String getSubscriptionId() {\n+            return subscriptionId;\n+        }\n+\n+        /**\n+         * Returns an {@link Observable} which consumers can use to\n+         * receive notfication about the status of the subscription connection. Currently,\n+         * only {@link ConnectionState#CONNECTED} is emitted.\n+         * @return Reference to the {@link Observable} that receives connection events.\n+         */\n+        public Observable<ConnectionState> observeConnectionState() {\n+            return connectionStateSubject;\n+        }\n+\n+        @Override\n+        public void cancel() {\n+            if (amplifyOperation != null) {\n+                amplifyOperation.cancel();\n+            }\n+            connectionStateSubject.onComplete();\n+        }\n+\n+        /**\n+         * Enum representing connection states of a\n+         * subscription operation.\n+         */\n+        public enum ConnectionState {\n+            /**\n+             * The subscription successfully established a connection and is\n+             * ready to receive data.\n+             */\n+            CONNECTED", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3d18f0d123f78a41c1dbf1489186e48f519a674"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxNzQ4Ng==", "bodyText": "I'd add an import ...  for RxSubscriptionOperation.. directly just to cut down on some of this boiler plate a tiny bit.", "url": "https://github.com/aws-amplify/amplify-android/pull/768#discussion_r478817486", "createdAt": "2020-08-28T03:59:24Z", "author": {"login": "jamesonwilliams"}, "path": "rxbindings/src/test/java/com/amplifyframework/rx/RxApiBindingTest.java", "diffHunk": "@@ -225,12 +228,20 @@ public void subscribeStartsEmitsValuesAndCompletes() throws InterruptedException\n         );\n \n         // Act: subscribe via binding\n-        TestObserver<GraphQLResponse<Model>> observer =\n-            rxApi.subscribe(request).test();\n+        RxApiBinding.RxSubscriptionOperation<GraphQLResponse<Model>> rxOperation = rxApi.subscribe(request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3d18f0d123f78a41c1dbf1489186e48f519a674"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a16b4d18938ac33c6400f8a8dc106f6f6bf6210b", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/a16b4d18938ac33c6400f8a8dc106f6f6bf6210b", "committedDate": "2020-08-28T12:52:08Z", "message": "Changed event to an object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca72c90eef05603d7185a85d1d1af3a1c124ab28", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/ca72c90eef05603d7185a85d1d1af3a1c124ab28", "committedDate": "2020-08-28T13:20:59Z", "message": "Created a class to hold rx-operation objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "875558a31fa598bf2311a12d09234104764aa5ee", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/875558a31fa598bf2311a12d09234104764aa5ee", "committedDate": "2020-08-28T13:24:04Z", "message": "Make RxApiBinding package private"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00a58e28567e1917897e0a3f9ff442ce8c4a6a7c", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/00a58e28567e1917897e0a3f9ff442ce8c4a6a7c", "committedDate": "2020-08-28T13:28:39Z", "message": "Add static import"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3416, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}