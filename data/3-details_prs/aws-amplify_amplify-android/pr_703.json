{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0MTUwNjk5", "number": 703, "title": "feature(core): allow additional platforms in amplify config", "bodyText": "Description of changes:\n\nUpdate AmplifyConfiguration to use a builder pattern and deprecate the other publicly exposed constructors.\nAllow passing in additional platforms as parameters to building an Amplify configuration\nAdd global UserAgent configure() method\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-08-06T16:59:38Z", "url": "https://github.com/aws-amplify/amplify-android/pull/703", "merged": true, "mergeCommit": {"oid": "ff4700bb51f4db8ab2655c46f28a71a2e766128e"}, "closed": true, "closedAt": "2020-08-11T09:46:23Z", "author": {"login": "raphkim"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8KZdkAH2gAyNDY0MTUwNjk5OjEwODI0YTU4YmI0N2QwY2ViMzE4MTgyMmNmZmM0YmVmM2RiYTYzOTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9ogE1AH2gAyNDY0MTUwNjk5OjdmZjZmOGFhZTM3NDEzNzBiYTZmNDg2ZmI2YTNjODllODUxNzFkZDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "10824a58bb47d0ceb3181822cffc4bef3dba6392", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/10824a58bb47d0ceb3181822cffc4bef3dba6392", "committedDate": "2020-08-06T07:08:24Z", "message": "implement builder for additional platforms in amplify config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37842a0fa0c9718fdb2339ffb95beaf10465f2a7", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/37842a0fa0c9718fdb2339ffb95beaf10465f2a7", "committedDate": "2020-08-06T09:07:54Z", "message": "Make UserAgent work without configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e974d1ab731c2482edd9781d65e863e2ba71b41", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/8e974d1ab731c2482edd9781d65e863e2ba71b41", "committedDate": "2020-08-06T09:29:46Z", "message": "Rename test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/fd30c34e6b51474838c669d53662227b5702a662", "committedDate": "2020-08-06T09:43:34Z", "message": "checkstyle fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyODE3Mzg4", "url": "https://github.com/aws-amplify/amplify-android/pull/703#pullrequestreview-462817388", "createdAt": "2020-08-06T19:33:21Z", "commit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxOTozMzoyMVrOG9BcRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxOTozMzoyMVrOG9BcRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYzOTk0Mw==", "bodyText": "Maybe consider moving the loadConfigFile method into the Builder and create a builder method for AmplifyConfiguration that creates an instance of that Builder. So the callers would do something like this:\nAmplifyConfiguration\n    .builder() \n    .fromConfigFile(context)\n    .forCategoryType(<category type>)\n    .build();\n\nIt would be a bit more consistent with how other builders are structured throughout the framework.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r466639943", "createdAt": "2020-08-06T19:33:21Z", "author": {"login": "rjuliano"}, "path": "core/src/main/java/com/amplifyframework/core/AmplifyConfiguration.java", "diffHunk": "@@ -189,5 +227,101 @@ public CategoryConfiguration forCategoryType(@NonNull CategoryType categoryType)\n             return categoryConfiguration;\n         }\n     }\n+\n+    /**\n+     * Loads a builder for an {@link AmplifyConfiguration} from an amplifyconfiguration.json file.\n+     *\n+     * @param context Context needed for reading JSON file\n+     * @return An Amplify configuration builder instance\n+     * @throws AmplifyException If there is a problem in the config file\n+     */\n+    @NonNull\n+    public static Builder loadConfigFile(@NonNull Context context) throws AmplifyException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "originalPosition": 182}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyODI4NDkx", "url": "https://github.com/aws-amplify/amplify-android/pull/703#pullrequestreview-462828491", "createdAt": "2020-08-06T19:50:20Z", "commit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxOTo1MDoyMVrOG9B_jA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMDowMDo1NFrOG9CUMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY0ODk3Mg==", "bodyText": "It's not clear from the name loadConfigFile that this will return a Foo.Builder, instead of a Foo.\nI suggest to name this like builderFromConfigFile(...), or something like that.\nAlternately, you could do like AmplifyConfiguration.builder(context, resourceId), without playing any naming games. This way it's clear you'll return a builder.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r466648972", "createdAt": "2020-08-06T19:50:21Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/androidTest/java/com/amplifyframework/api/aws/TestApiCategory.java", "diffHunk": "@@ -61,7 +61,8 @@ static ApiCategory fromConfiguration(@RawRes int resourceId) throws AmplifyExcep\n                 )\n         );\n         CategoryConfiguration apiConfiguration =\n-            AmplifyConfiguration.fromConfigFile(context, resourceId)\n+            AmplifyConfiguration.loadConfigFile(context, resourceId)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY0OTI1OA==", "bodyText": "In theory this should be clear enough, since its the only one in the aws-api module. But, either way.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r466649258", "createdAt": "2020-08-06T19:50:50Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/test/java/com/amplifyframework/api/aws/AWSApiPluginUserAgentTest.java", "diffHunk": "@@ -45,7 +45,7 @@\n  * in {@link AWSApiPlugin}.\n  */\n @RunWith(RobolectricTestRunner.class)\n-public final class UserAgentTest {\n+public final class AWSApiPluginUserAgentTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1MDIyMg==", "bodyText": "You don't need to pass this in the JSONObject, if you will keep it as a static method.\nThe only reason you'd need to populate this in the JSONObject is if the UserAgent is an instance, that you would not be able to access from anywhere else, and has some instance-specific state, right here in this code location.\nIf you can call UserAgent.string() from any place, you might as well do so from the OkHttp interceptor, directly.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r466650222", "createdAt": "2020-08-06T19:52:39Z", "author": {"login": "jamesonwilliams"}, "path": "aws-auth-cognito/src/test/java/com/amplifyframework/auth/cognito/AuthComponentTest.java", "diffHunk": "@@ -147,7 +148,9 @@ public void setup() throws AmplifyException {\n     public void testConfigure() throws AmplifyException, JSONException {\n         UserStateDetails userStateDetails = new UserStateDetails(UserState.SIGNED_OUT, null);\n         Context context = getApplicationContext();\n-        JSONObject pluginConfig = new JSONObject().put(\"TestKey\", \"TestVal\");\n+        JSONObject pluginConfig = new JSONObject()\n+                .put(\"TestKey\", \"TestVal\")\n+                .put(\"UserAgentOverride\", UserAgent.string());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1MDc4OA==", "bodyText": "Here, you might say when this enum would be used. It's curious, since we're in the amplify-android code base. When would we not use it? That'd be good doc, here.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r466650788", "createdAt": "2020-08-06T19:53:50Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/Platform.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework;\n+\n+/**\n+ * Enum to represent various platforms that use Amplify library for\n+ * tracking usage metrics.\n+ */\n+public enum Platform {\n+    /**\n+     * Represents the Android platform.\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1MTA0OA==", "bodyText": "Likewise, we can already tell it represents Flutter. But, here, we could document that Flutter calls Android, and we need a way to distinguish it, blah blah blah.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r466651048", "createdAt": "2020-08-06T19:54:24Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/Platform.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework;\n+\n+/**\n+ * Enum to represent various platforms that use Amplify library for\n+ * tracking usage metrics.\n+ */\n+public enum Platform {\n+    /**\n+     * Represents the Android platform.\n+     */\n+    ANDROID(\"amplify-android\"),\n+\n+    /**\n+     * Represents the Flutter platform.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1MTM5Nw==", "bodyText": "Actually, now that I think of it, I can re-use this mechanism for Rx Bindings, so that we can get a sense for how many people are calling through Rx. (Currently, I  assume not many. But maybe after I put up the docs.)", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r466651397", "createdAt": "2020-08-06T19:55:08Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/Platform.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework;\n+\n+/**\n+ * Enum to represent various platforms that use Amplify library for\n+ * tracking usage metrics.\n+ */\n+public enum Platform {\n+    /**\n+     * Represents the Android platform.\n+     */\n+    ANDROID(\"amplify-android\"),\n+\n+    /**\n+     * Represents the Flutter platform.\n+     */\n+    FLUTTER(\"amplify-flutter\");\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1MTkxNQ==", "bodyText": "Just pass the platforms, not the entire configuration. Like UserAgent.setPlatformVersions(configuration.getPlatformVersions()) (or whatever). This way, the UserAgent sin't coupled to the AmplifyConfiguration.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r466651915", "createdAt": "2020-08-06T19:56:07Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/core/Amplify.java", "diffHunk": "@@ -126,6 +127,9 @@ public static void configure(@NonNull final AmplifyConfiguration configuration,\n                 );\n             }\n \n+            // Configure User-Agent utility\n+            UserAgent.configure(configuration);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1MjA2Mg==", "bodyText": "platformVersions?", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r466652062", "createdAt": "2020-08-06T19:56:24Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/core/AmplifyConfiguration.java", "diffHunk": "@@ -53,81 +57,115 @@\n     private static final String DEFAULT_IDENTIFIER = \"amplifyconfiguration\";\n \n     private final Map<String, CategoryConfiguration> categoryConfigurations;\n+    private final Map<Platform, String> additionalPlatforms;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1MjU5Mw==", "bodyText": "As mentioned elsewhere, we need to better distinguish, by naming, methods that return Foo, vs. methods that return Foo.Builder.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r466652593", "createdAt": "2020-08-06T19:57:33Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/core/AmplifyConfiguration.java", "diffHunk": "@@ -189,5 +227,101 @@ public CategoryConfiguration forCategoryType(@NonNull CategoryType categoryType)\n             return categoryConfiguration;\n         }\n     }\n+\n+    /**\n+     * Loads a builder for an {@link AmplifyConfiguration} from an amplifyconfiguration.json file.\n+     *\n+     * @param context Context needed for reading JSON file\n+     * @return An Amplify configuration builder instance\n+     * @throws AmplifyException If there is a problem in the config file\n+     */\n+    @NonNull\n+    public static Builder loadConfigFile(@NonNull Context context) throws AmplifyException {\n+        return loadConfigFile(context, getConfigResourceId(context));\n+    }\n+\n+    /**\n+     * Loads a builder for an {@link AmplifyConfiguration} from a particular configuration file.\n+     * @param context Android Context\n+     * @param configFileResourceId\n+     *        The Android resource ID of a raw resource which contains\n+     *        an amplify configuration as JSON\n+     * @return An Amplify configuration builder instance\n+     * @throws AmplifyException If there is a problem in the config file\n+     */\n+    @NonNull\n+    public static Builder loadConfigFile(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "originalPosition": 196}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1MjgwNg==", "bodyText": "We mostly haven't used .with for builders in this project. How about addAdditionalPlatform?", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r466652806", "createdAt": "2020-08-06T19:58:02Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/core/AmplifyConfiguration.java", "diffHunk": "@@ -189,5 +227,101 @@ public CategoryConfiguration forCategoryType(@NonNull CategoryType categoryType)\n             return categoryConfiguration;\n         }\n     }\n+\n+    /**\n+     * Loads a builder for an {@link AmplifyConfiguration} from an amplifyconfiguration.json file.\n+     *\n+     * @param context Context needed for reading JSON file\n+     * @return An Amplify configuration builder instance\n+     * @throws AmplifyException If there is a problem in the config file\n+     */\n+    @NonNull\n+    public static Builder loadConfigFile(@NonNull Context context) throws AmplifyException {\n+        return loadConfigFile(context, getConfigResourceId(context));\n+    }\n+\n+    /**\n+     * Loads a builder for an {@link AmplifyConfiguration} from a particular configuration file.\n+     * @param context Android Context\n+     * @param configFileResourceId\n+     *        The Android resource ID of a raw resource which contains\n+     *        an amplify configuration as JSON\n+     * @return An Amplify configuration builder instance\n+     * @throws AmplifyException If there is a problem in the config file\n+     */\n+    @NonNull\n+    public static Builder loadConfigFile(\n+            @NonNull Context context,\n+            @RawRes int configFileResourceId\n+    ) throws AmplifyException {\n+        return loadJson(readInputJson(Objects.requireNonNull(context), configFileResourceId));\n+    }\n+\n+    /**\n+     * Loads a builder for {@link AmplifyConfiguration} directly from an {@link JSONObject}.\n+     * Users should prefer loading from resources files via {@link #loadConfigFile(Context)},\n+     * or {@link #loadConfigFile(Context, int)}.\n+     * @param json A JSON object\n+     * @return An Amplify configuration builder instance\n+     * @throws AmplifyException If the JSON does not represent a valid AmplifyConfiguration\n+     */\n+    @NonNull\n+    public static Builder loadJson(@NonNull JSONObject json) throws AmplifyException {\n+        return loadCategoryConfigs(configsFromJson(Objects.requireNonNull(json)));\n+    }\n+\n+    /**\n+     * Loads a builder for {@link AmplifyConfiguration} directly from a map of\n+     * {@link CategoryConfiguration}.\n+     * @param configs A map of category configurations by category name.\n+     * @return An Amplify configuration builder instance\n+     */\n+    @VisibleForTesting\n+    @NonNull\n+    public static Builder loadCategoryConfigs(Map<String, CategoryConfiguration> configs) {\n+        return new Builder(configs);\n+    }\n+\n+    /**\n+     * Builder for AmplifyConfiguration with an option to specify additional platforms.\n+     */\n+    public static final class Builder {\n+        private final Map<String, CategoryConfiguration> categoryConfiguration;\n+        private final Map<Platform, String> additionalPlatforms;\n+\n+        private Builder(Map<String, CategoryConfiguration> categoryConfiguration) {\n+            this.categoryConfiguration = categoryConfiguration;\n+            this.additionalPlatforms = new LinkedHashMap<>();\n+        }\n+\n+        /**\n+         * Add an additional platform and its version to be used for tracking\n+         * usage metrics and return the builder.\n+         * Note: Do not add \"amplify-android\", as it is already accounted for.\n+         * @param platform Additional platform that uses this library.\n+         * @param version Version number associated with the additional platform.\n+         * @return this builder instance.\n+         */\n+        @NonNull\n+        public Builder withAdditionalPlatform(@NonNull Platform platform, @NonNull String version) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "originalPosition": 249}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1MzI5NQ==", "bodyText": "// Usage metrics are stored in a field with VARCHAR(254)", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r466653295", "createdAt": "2020-08-06T19:58:57Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/util/UserAgent.java", "diffHunk": "@@ -20,26 +20,83 @@\n import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n \n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.Platform;\n+import com.amplifyframework.core.Amplify;\n+import com.amplifyframework.core.AmplifyConfiguration;\n import com.amplifyframework.core.BuildConfig;\n+import com.amplifyframework.logging.Logger;\n+\n+import java.util.Map;\n \n /**\n  * A utility to construct a User-Agent header, to be sent with all network operations.\n  */\n public final class UserAgent {\n+    private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:core\");\n+    private static final int SIZE_LIMIT = 254; // VARCHAR(254)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1NDI1Nw==", "bodyText": "should this just be part of string()?", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r466654257", "createdAt": "2020-08-06T20:00:54Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/util/UserAgent.java", "diffHunk": "@@ -20,26 +20,83 @@\n import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n \n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.Platform;\n+import com.amplifyframework.core.Amplify;\n+import com.amplifyframework.core.AmplifyConfiguration;\n import com.amplifyframework.core.BuildConfig;\n+import com.amplifyframework.logging.Logger;\n+\n+import java.util.Map;\n \n /**\n  * A utility to construct a User-Agent header, to be sent with all network operations.\n  */\n public final class UserAgent {\n+    private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:core\");\n+    private static final int SIZE_LIMIT = 254; // VARCHAR(254)\n+\n     private static String instance = null;\n \n     private UserAgent() {}\n \n+    /**\n+     * Configure User-Agent singleton with Amplify configuration instance.\n+     * @param configuration An Amplify configuration instance.\n+     * @throws AmplifyException If called twice or user-agent exceeds size limit.\n+     */\n+    public static synchronized void configure(@NonNull AmplifyConfiguration configuration)\n+            throws AmplifyException {\n+        // Block any sub-sequent configuration call.\n+        if (instance != null) {\n+            throw new AmplifyException(\n+                    \"User-Agent was already configured successfully.\",\n+                    \"User-Agent is configured internally during Amplify configuration. \" +\n+                            \"This method should not be called externally.\"\n+            );\n+        }\n+\n+        // Pre-pend the additional platforms before Android user-agent\n+        final StringBuilder userAgent = new StringBuilder();\n+        for (Map.Entry<Platform, String> platform : configuration.getAdditionalPlatforms().entrySet()) {\n+            userAgent.append(String.format(\"%s/%s \",\n+                    platform.getKey().getLibraryName(),\n+                    platform.getValue()));\n+        }\n+        userAgent.append(androidUserAgent());\n+\n+        // The character limit for our User-Agent header is 254 characters.\n+        // HTTP does not impose a maximum, but the AWS SDKs & Tools database\n+        // that stores metrics records declares user-agent as a VARCHAR(254)\n+        if (userAgent.length() > SIZE_LIMIT) {\n+            throw new AmplifyException(\n+                    \"User-Agent exceeds the size limit of VARCHAR(254).\",\n+                    AmplifyException.REPORT_BUG_TO_AWS_SUGGESTION\n+            );\n+        }\n+\n+        instance = userAgent.toString();\n+    }\n+\n     /**\n      * Gets a String to use as the value of a User-Agent header.\n      * @return A value for a User-Agent header.\n+     * @throws RuntimeException If called before {@link #configure(AmplifyConfiguration)}.\n      */\n     @SuppressLint(\"SyntheticAccessor\")\n     @NonNull\n     public static String string() {\n         if (instance == null) {\n-            instance = new UserAgent.Builder()\n-                .libraryName(\"amplify-android\")\n+            LOG.debug(\"User-Agent is not yet configured. Returning default Android user-agent.\");\n+            return androidUserAgent();\n+        }\n+\n+        return instance;\n+    }\n+\n+    private static String androidUserAgent() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd30c34e6b51474838c669d53662227b5702a662"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1962a86e7ec1f8ce91e4a4b53aa5603b1ad63b8b", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/1962a86e7ec1f8ce91e4a4b53aa5603b1ad63b8b", "committedDate": "2020-08-07T08:27:19Z", "message": "Address Jameson's PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a9adbfbb7a938bcc24a3c9fe1313d71f4abe128", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/8a9adbfbb7a938bcc24a3c9fe1313d71f4abe128", "committedDate": "2020-08-07T08:58:25Z", "message": "Revert auth unit test fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f936b6b4e6874bad1469514b6d328285a9cf761", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/3f936b6b4e6874bad1469514b6d328285a9cf761", "committedDate": "2020-08-07T17:42:34Z", "message": "Merge branch 'main' of https://github.com/aws-amplify/amplify-android into flutter-user-agent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNzg4OTQ5", "url": "https://github.com/aws-amplify/amplify-android/pull/703#pullrequestreview-463788949", "createdAt": "2020-08-08T08:34:53Z", "commit": {"oid": "3f936b6b4e6874bad1469514b6d328285a9cf761"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwODozNDo1M1rOG9vftA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwODo1MjoyN1rOG9wAtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5NDQ4NA==", "bodyText": "For these ones, I think you can keep around the factory method. Just have it proxy to the builder.\ne.g.\npublic final class AmplfiyConfiguration {\n    private AmplifyConfiguration(..., ..,) { /* make one, privately */ }\n\n    public static AmplifyConfiguration fromConfigFile(Context context, \\@ResId int resourceId) {\n        return builder(conext, resourceId).build();\n    }\n\n    public static Builder builder(Context context, \\@ResId int resourceId) {\n        reutrn new Builder(contetx, resourceId);\n    }\n\n    ...\n    public static final class Builder {\n        ...\n        AmplifyConifguration build() { ... }\n    }\n}\nIf you do this, you'll cleanup the PR diff quite a bit too. There's a number of ~unnecessary changes to use the new builder, when you could just keep the factory, for most uses.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r467394484", "createdAt": "2020-08-08T08:34:53Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/androidTest/java/com/amplifyframework/api/aws/TestApiCategory.java", "diffHunk": "@@ -61,7 +61,8 @@ static ApiCategory fromConfiguration(@RawRes int resourceId) throws AmplifyExcep\n                 )\n         );\n         CategoryConfiguration apiConfiguration =\n-            AmplifyConfiguration.fromConfigFile(context, resourceId)\n+            AmplifyConfiguration.builder(context, resourceId)\n+                .build()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f936b6b4e6874bad1469514b6d328285a9cf761"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5NTE2Nw==", "bodyText": "Is this the right package? Is there a more specific one you can use? What about .core, at least?\nOr what about moving to an inner enum of the AmplifyConfiguration?", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r467395167", "createdAt": "2020-08-08T08:36:22Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/Platform.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f936b6b4e6874bad1469514b6d328285a9cf761"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5NjcxOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Uses default android user-agent if {@link #configure(Map)} was not called yet.\n          \n          \n            \n                 * Uses default Android user-agent if {@link #configure(Map)} has not been called yet.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r467396719", "createdAt": "2020-08-08T08:39:43Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/util/UserAgent.java", "diffHunk": "@@ -20,26 +20,83 @@\n import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n \n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.Platform;\n+import com.amplifyframework.core.Amplify;\n import com.amplifyframework.core.BuildConfig;\n+import com.amplifyframework.logging.Logger;\n+\n+import java.util.Map;\n \n /**\n  * A utility to construct a User-Agent header, to be sent with all network operations.\n  */\n public final class UserAgent {\n+    private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:core\");\n+    private static final int SIZE_LIMIT = 254; // VARCHAR(254)\n+\n     private static String instance = null;\n \n     private UserAgent() {}\n \n+    /**\n+     * Configure User-Agent singleton with Amplify configuration instance.\n+     * @param platformVersions A map of additional platforms that are calling this library\n+     *                         and their respective versions.\n+     * @throws AmplifyException If called twice or user-agent exceeds size limit.\n+     */\n+    public static synchronized void configure(@NonNull Map<Platform, String> platformVersions)\n+            throws AmplifyException {\n+        // Block any sub-sequent configuration call.\n+        if (instance != null) {\n+            throw new AmplifyException(\n+                    \"User-Agent was already configured successfully.\",\n+                    \"User-Agent is configured internally during Amplify configuration. \" +\n+                            \"This method should not be called externally.\"\n+            );\n+        }\n+\n+        // Pre-pend the additional platforms before Android user-agent\n+        final StringBuilder userAgent = new StringBuilder();\n+        for (Map.Entry<Platform, String> platform : platformVersions.entrySet()) {\n+            userAgent.append(String.format(\"%s/%s \",\n+                    platform.getKey().getLibraryName(),\n+                    platform.getValue()));\n+        }\n+        userAgent.append(forAndroid());\n+\n+        // The character limit for our User-Agent header is 254 characters.\n+        // HTTP does not impose a maximum, but the AWS SDKs & Tools database\n+        // that stores metrics records declares user-agent as a VARCHAR(254)\n+        if (userAgent.length() > SIZE_LIMIT) {\n+            throw new AmplifyException(\n+                    \"User-Agent exceeds the size limit of VARCHAR(254).\",\n+                    AmplifyException.REPORT_BUG_TO_AWS_SUGGESTION\n+            );\n+        }\n+\n+        instance = userAgent.toString();\n+    }\n+\n     /**\n      * Gets a String to use as the value of a User-Agent header.\n+     * Uses default android user-agent if {@link #configure(Map)} was not called yet.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f936b6b4e6874bad1469514b6d328285a9cf761"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5ODE0OA==", "bodyText": "If you move Platform to be AmplifyConifguration.Platform, then do something like:\nLinkedHashMap<String, String> paltformVersions.= new LinkedHashMap<>();\nfor (Map.Entry<Platform, String> provided : inputVersions.entrySet()) {\n    platformVersion.put(provided.getKey().name(), provided.getValue());\n}\n\nThen you could break the type dependency and just have String-to-String map on this API.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r467398148", "createdAt": "2020-08-08T08:42:35Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/util/UserAgent.java", "diffHunk": "@@ -20,26 +20,83 @@\n import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n \n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.Platform;\n+import com.amplifyframework.core.Amplify;\n import com.amplifyframework.core.BuildConfig;\n+import com.amplifyframework.logging.Logger;\n+\n+import java.util.Map;\n \n /**\n  * A utility to construct a User-Agent header, to be sent with all network operations.\n  */\n public final class UserAgent {\n+    private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:core\");\n+    private static final int SIZE_LIMIT = 254; // VARCHAR(254)\n+\n     private static String instance = null;\n \n     private UserAgent() {}\n \n+    /**\n+     * Configure User-Agent singleton with Amplify configuration instance.\n+     * @param platformVersions A map of additional platforms that are calling this library\n+     *                         and their respective versions.\n+     * @throws AmplifyException If called twice or user-agent exceeds size limit.\n+     */\n+    public static synchronized void configure(@NonNull Map<Platform, String> platformVersions)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f936b6b4e6874bad1469514b6d328285a9cf761"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5ODc5MA==", "bodyText": "If we're talking about  \"user agents\" in this Platform.java, maybe it should be an inner enum of UserAgent.java?", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r467398790", "createdAt": "2020-08-08T08:44:01Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/Platform.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework;\n+\n+/**\n+ * Enum to represent various platforms that use Amplify library for\n+ * tracking usage metrics.\n+ */\n+public enum Platform {\n+    /**\n+     * This is the default platform that will be included in every user-agent", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f936b6b4e6874bad1469514b6d328285a9cf761"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5OTAwNQ==", "bodyText": "If you talk about construction, include a link to the method used to do so.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r467399005", "createdAt": "2020-08-08T08:44:25Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/Platform.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework;\n+\n+/**\n+ * Enum to represent various platforms that use Amplify library for\n+ * tracking usage metrics.\n+ */\n+public enum Platform {\n+    /**\n+     * This is the default platform that will be included in every user-agent\n+     * that is generated by this library.\n+     * A user should never be using this enum to specify their platform version\n+     * to avoid redundancy.\n+     */\n+    ANDROID(\"amplify-android\"),\n+\n+    /**\n+     * The Flutter library calls on Android Amplify. This enum should be specified\n+     * during the construction of an Amplify configuration object to indicate that", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f936b6b4e6874bad1469514b6d328285a9cf761"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5OTU4Nw==", "bodyText": "If order matters, you may want to use LinkedHashMap on the LHS of all uses. The Liskov principle is about using the type of least specificity. But for your use case, if ordering is essential, Map is not the type of least specificity.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r467399587", "createdAt": "2020-08-08T08:45:34Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/core/AmplifyConfiguration.java", "diffHunk": "@@ -53,81 +57,115 @@\n     private static final String DEFAULT_IDENTIFIER = \"amplifyconfiguration\";\n \n     private final Map<String, CategoryConfiguration> categoryConfigurations;\n+    private final Map<Platform, String> platformVersions;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f936b6b4e6874bad1469514b6d328285a9cf761"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5OTkyNA==", "bodyText": "I think it's still useful; I'd leave it, and use it around the code base.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r467399924", "createdAt": "2020-08-08T08:46:16Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/core/AmplifyConfiguration.java", "diffHunk": "@@ -53,81 +57,115 @@\n     private static final String DEFAULT_IDENTIFIER = \"amplifyconfiguration\";\n \n     private final Map<String, CategoryConfiguration> categoryConfigurations;\n+    private final Map<Platform, String> platformVersions;\n \n     /**\n      * Constructs a new AmplifyConfiguration object.\n      * @param configs Category configurations\n+     * @deprecated Construction should be done with a builder.\n      */\n+    @Deprecated\n     @SuppressWarnings(\"WeakerAccess\") // These are created and accessed as public API\n     public AmplifyConfiguration(@NonNull Map<String, CategoryConfiguration> configs) {\n+        this(configs, new LinkedHashMap<>());\n+    }\n+\n+    private AmplifyConfiguration(\n+            Map<String, CategoryConfiguration> configs,\n+            Map<Platform, String> platformVersions\n+    ) {\n         this.categoryConfigurations = new HashMap<>();\n         this.categoryConfigurations.putAll(configs);\n+        this.platformVersions = platformVersions;\n     }\n \n     /**\n      * Build an {@link AmplifyConfiguration} directly from an {@link JSONObject}.\n-     * Users should prefer loading from resources files via {@link #fromConfigFile(Context)},\n-     * or {@link #fromConfigFile(Context, int)}.\n+     *\n      * @param json A JSON object\n      * @return An AmplifyConfiguration\n      * @throws AmplifyException If the JSON does not represent a valid AmplifyConfiguration\n+     * @deprecated This method is now deprecated in favor of {@link #builder(JSONObject)}.\n      */\n+    @Deprecated\n     @NonNull\n     public static AmplifyConfiguration fromJson(@NonNull JSONObject json) throws AmplifyException {\n-        final List<CategoryConfiguration> possibleConfigs = Arrays.asList(\n-            new AnalyticsCategoryConfiguration(),\n-            new ApiCategoryConfiguration(),\n-            new AuthCategoryConfiguration(),\n-            new DataStoreCategoryConfiguration(),\n-            new HubCategoryConfiguration(),\n-            new LoggingCategoryConfiguration(),\n-            new PredictionsCategoryConfiguration(),\n-            new StorageCategoryConfiguration()\n-        );\n-\n-        final Map<String, CategoryConfiguration> actualConfigs = new HashMap<>();\n-        try {\n-            for (CategoryConfiguration possibleConfig : possibleConfigs) {\n-                String categoryJsonKey = possibleConfig.getCategoryType().getConfigurationKey();\n-                if (json.has(categoryJsonKey)) {\n-                    possibleConfig.populateFromJSON(json.getJSONObject(categoryJsonKey));\n-                    actualConfigs.put(categoryJsonKey, possibleConfig);\n-                }\n-            }\n-        } catch (JSONException error) {\n-            throw new AmplifyException(\n-                \"Could not parse amplifyconfiguration.json \",\n-                error, \"Check any modifications made to the file.\"\n-            );\n-        }\n-        return new AmplifyConfiguration(Immutable.of(actualConfigs));\n+        return builder(json).build();\n     }\n \n     /**\n      * Creates an AmplifyConfiguration from an amplifyconfiguration.json file.\n+     *\n      * @param context Context needed for reading JSON file\n      * @return An Amplify configuration instance\n      * @throws AmplifyException If there is a problem in the config file\n+     * @deprecated This method is now deprecated in favor of\n+     *          {@link AmplifyConfiguration#builder(Context)}.\n      */\n     @SuppressWarnings(\"WeakerAccess\")\n+    @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f936b6b4e6874bad1469514b6d328285a9cf761"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQwMDMwMQ==", "bodyText": "Ditto, you have builder(..., ...).build() around the codebase, so why not just keep this and use it, since it's cleaner looking.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r467400301", "createdAt": "2020-08-08T08:47:03Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/core/AmplifyConfiguration.java", "diffHunk": "@@ -53,81 +57,115 @@\n     private static final String DEFAULT_IDENTIFIER = \"amplifyconfiguration\";\n \n     private final Map<String, CategoryConfiguration> categoryConfigurations;\n+    private final Map<Platform, String> platformVersions;\n \n     /**\n      * Constructs a new AmplifyConfiguration object.\n      * @param configs Category configurations\n+     * @deprecated Construction should be done with a builder.\n      */\n+    @Deprecated\n     @SuppressWarnings(\"WeakerAccess\") // These are created and accessed as public API\n     public AmplifyConfiguration(@NonNull Map<String, CategoryConfiguration> configs) {\n+        this(configs, new LinkedHashMap<>());\n+    }\n+\n+    private AmplifyConfiguration(\n+            Map<String, CategoryConfiguration> configs,\n+            Map<Platform, String> platformVersions\n+    ) {\n         this.categoryConfigurations = new HashMap<>();\n         this.categoryConfigurations.putAll(configs);\n+        this.platformVersions = platformVersions;\n     }\n \n     /**\n      * Build an {@link AmplifyConfiguration} directly from an {@link JSONObject}.\n-     * Users should prefer loading from resources files via {@link #fromConfigFile(Context)},\n-     * or {@link #fromConfigFile(Context, int)}.\n+     *\n      * @param json A JSON object\n      * @return An AmplifyConfiguration\n      * @throws AmplifyException If the JSON does not represent a valid AmplifyConfiguration\n+     * @deprecated This method is now deprecated in favor of {@link #builder(JSONObject)}.\n      */\n+    @Deprecated\n     @NonNull\n     public static AmplifyConfiguration fromJson(@NonNull JSONObject json) throws AmplifyException {\n-        final List<CategoryConfiguration> possibleConfigs = Arrays.asList(\n-            new AnalyticsCategoryConfiguration(),\n-            new ApiCategoryConfiguration(),\n-            new AuthCategoryConfiguration(),\n-            new DataStoreCategoryConfiguration(),\n-            new HubCategoryConfiguration(),\n-            new LoggingCategoryConfiguration(),\n-            new PredictionsCategoryConfiguration(),\n-            new StorageCategoryConfiguration()\n-        );\n-\n-        final Map<String, CategoryConfiguration> actualConfigs = new HashMap<>();\n-        try {\n-            for (CategoryConfiguration possibleConfig : possibleConfigs) {\n-                String categoryJsonKey = possibleConfig.getCategoryType().getConfigurationKey();\n-                if (json.has(categoryJsonKey)) {\n-                    possibleConfig.populateFromJSON(json.getJSONObject(categoryJsonKey));\n-                    actualConfigs.put(categoryJsonKey, possibleConfig);\n-                }\n-            }\n-        } catch (JSONException error) {\n-            throw new AmplifyException(\n-                \"Could not parse amplifyconfiguration.json \",\n-                error, \"Check any modifications made to the file.\"\n-            );\n-        }\n-        return new AmplifyConfiguration(Immutable.of(actualConfigs));\n+        return builder(json).build();\n     }\n \n     /**\n      * Creates an AmplifyConfiguration from an amplifyconfiguration.json file.\n+     *\n      * @param context Context needed for reading JSON file\n      * @return An Amplify configuration instance\n      * @throws AmplifyException If there is a problem in the config file\n+     * @deprecated This method is now deprecated in favor of\n+     *          {@link AmplifyConfiguration#builder(Context)}.\n      */\n     @SuppressWarnings(\"WeakerAccess\")\n+    @Deprecated\n     @NonNull\n     public static AmplifyConfiguration fromConfigFile(@NonNull Context context) throws AmplifyException {\n-        return fromConfigFile(context, getConfigResourceId(context));\n+        return builder(context, getConfigResourceId(context)).build();\n     }\n \n     /**\n      * Creates an AmplifyConfiguration from a particular configuration file.\n+     *\n      * @param context Android Context\n      * @param configFileResourceId\n      *        The Android resource ID of a raw resource which contains\n      *        an amplify configuration as JSON\n      * @return An Amplify configuration instance\n      * @throws AmplifyException If there is a problem in the config file\n+     * @deprecated This method is now deprecated in favor of\n+     *          {@link AmplifyConfiguration#builder(Context, int)}.\n      */\n+    @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f936b6b4e6874bad1469514b6d328285a9cf761"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQwMTE3Nw==", "bodyText": "Order matters right? LinkedHashMap as a return type here? Also: will Immutable respect that? Or does it return a generic Map? May need to use generics and change it to liek:\npublic static <T, M extends Map<T>> M of(M map) {\n    ...\n}", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r467401177", "createdAt": "2020-08-08T08:48:54Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/core/AmplifyConfiguration.java", "diffHunk": "@@ -53,81 +57,115 @@\n     private static final String DEFAULT_IDENTIFIER = \"amplifyconfiguration\";\n \n     private final Map<String, CategoryConfiguration> categoryConfigurations;\n+    private final Map<Platform, String> platformVersions;\n \n     /**\n      * Constructs a new AmplifyConfiguration object.\n      * @param configs Category configurations\n+     * @deprecated Construction should be done with a builder.\n      */\n+    @Deprecated\n     @SuppressWarnings(\"WeakerAccess\") // These are created and accessed as public API\n     public AmplifyConfiguration(@NonNull Map<String, CategoryConfiguration> configs) {\n+        this(configs, new LinkedHashMap<>());\n+    }\n+\n+    private AmplifyConfiguration(\n+            Map<String, CategoryConfiguration> configs,\n+            Map<Platform, String> platformVersions\n+    ) {\n         this.categoryConfigurations = new HashMap<>();\n         this.categoryConfigurations.putAll(configs);\n+        this.platformVersions = platformVersions;\n     }\n \n     /**\n      * Build an {@link AmplifyConfiguration} directly from an {@link JSONObject}.\n-     * Users should prefer loading from resources files via {@link #fromConfigFile(Context)},\n-     * or {@link #fromConfigFile(Context, int)}.\n+     *\n      * @param json A JSON object\n      * @return An AmplifyConfiguration\n      * @throws AmplifyException If the JSON does not represent a valid AmplifyConfiguration\n+     * @deprecated This method is now deprecated in favor of {@link #builder(JSONObject)}.\n      */\n+    @Deprecated\n     @NonNull\n     public static AmplifyConfiguration fromJson(@NonNull JSONObject json) throws AmplifyException {\n-        final List<CategoryConfiguration> possibleConfigs = Arrays.asList(\n-            new AnalyticsCategoryConfiguration(),\n-            new ApiCategoryConfiguration(),\n-            new AuthCategoryConfiguration(),\n-            new DataStoreCategoryConfiguration(),\n-            new HubCategoryConfiguration(),\n-            new LoggingCategoryConfiguration(),\n-            new PredictionsCategoryConfiguration(),\n-            new StorageCategoryConfiguration()\n-        );\n-\n-        final Map<String, CategoryConfiguration> actualConfigs = new HashMap<>();\n-        try {\n-            for (CategoryConfiguration possibleConfig : possibleConfigs) {\n-                String categoryJsonKey = possibleConfig.getCategoryType().getConfigurationKey();\n-                if (json.has(categoryJsonKey)) {\n-                    possibleConfig.populateFromJSON(json.getJSONObject(categoryJsonKey));\n-                    actualConfigs.put(categoryJsonKey, possibleConfig);\n-                }\n-            }\n-        } catch (JSONException error) {\n-            throw new AmplifyException(\n-                \"Could not parse amplifyconfiguration.json \",\n-                error, \"Check any modifications made to the file.\"\n-            );\n-        }\n-        return new AmplifyConfiguration(Immutable.of(actualConfigs));\n+        return builder(json).build();\n     }\n \n     /**\n      * Creates an AmplifyConfiguration from an amplifyconfiguration.json file.\n+     *\n      * @param context Context needed for reading JSON file\n      * @return An Amplify configuration instance\n      * @throws AmplifyException If there is a problem in the config file\n+     * @deprecated This method is now deprecated in favor of\n+     *          {@link AmplifyConfiguration#builder(Context)}.\n      */\n     @SuppressWarnings(\"WeakerAccess\")\n+    @Deprecated\n     @NonNull\n     public static AmplifyConfiguration fromConfigFile(@NonNull Context context) throws AmplifyException {\n-        return fromConfigFile(context, getConfigResourceId(context));\n+        return builder(context, getConfigResourceId(context)).build();\n     }\n \n     /**\n      * Creates an AmplifyConfiguration from a particular configuration file.\n+     *\n      * @param context Android Context\n      * @param configFileResourceId\n      *        The Android resource ID of a raw resource which contains\n      *        an amplify configuration as JSON\n      * @return An Amplify configuration instance\n      * @throws AmplifyException If there is a problem in the config file\n+     * @deprecated This method is now deprecated in favor of\n+     *          {@link AmplifyConfiguration#builder(Context, int)}.\n      */\n+    @Deprecated\n     @NonNull\n     public static AmplifyConfiguration fromConfigFile(\n             @NonNull Context context, @RawRes int configFileResourceId) throws AmplifyException {\n-        return fromJson(readInputJson(context, configFileResourceId));\n+        return builder(context, configFileResourceId).build();\n+    }\n+\n+    /**\n+     * Obtain a map of additional platforms that are using this library\n+     * for tracking usage metrics.\n+     * @return A map of additional platforms and their versions.\n+     */\n+    @NonNull\n+    public Map<Platform, String> getPlatformVersions() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f936b6b4e6874bad1469514b6d328285a9cf761"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQwMjkzNQ==", "bodyText": "Be sure to include @Nullable and @NonNull on every input and output of any public method in this file. Kotlin will suck, if you don't, and most of our customers use Kotlin.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r467402935", "createdAt": "2020-08-08T08:52:27Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/core/AmplifyConfiguration.java", "diffHunk": "@@ -19,8 +19,10 @@\n import android.content.res.Resources;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f936b6b4e6874bad1469514b6d328285a9cf761"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61fa134554cbd63d1741b445d7962c13233cce8b", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/61fa134554cbd63d1741b445d7962c13233cce8b", "committedDate": "2020-08-10T16:42:31Z", "message": "Updates to latest SDK version (#708)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c8ef1b59421a968916d2717264e218703371fd9", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/9c8ef1b59421a968916d2717264e218703371fd9", "committedDate": "2020-08-10T16:42:31Z", "message": "chore: update readme to point to latest release (#709)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ff9693bd7561be1eaaac24c21b62de86ff6bc4a", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/4ff9693bd7561be1eaaac24c21b62de86ff6bc4a", "committedDate": "2020-08-10T16:44:58Z", "message": "Address PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eedfb5397b06c9c271dcc232f67712dfeec113df", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/eedfb5397b06c9c271dcc232f67712dfeec113df", "committedDate": "2020-08-10T16:47:09Z", "message": "Remove deprecated tags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84471661eb2dcb41d761d3a55ce5c552e61c4603", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/84471661eb2dcb41d761d3a55ce5c552e61c4603", "committedDate": "2020-08-10T17:19:15Z", "message": "Revert change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NDI3MTI2", "url": "https://github.com/aws-amplify/amplify-android/pull/703#pullrequestreview-464427126", "createdAt": "2020-08-10T17:22:46Z", "commit": {"oid": "84471661eb2dcb41d761d3a55ce5c552e61c4603"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzoyMjo0NlrOG-YJEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzoyMjo0NlrOG-YJEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA2MDQzNQ==", "bodyText": "Uh oh, looks like a rebasing issue.", "url": "https://github.com/aws-amplify/amplify-android/pull/703#discussion_r468060435", "createdAt": "2020-08-10T17:22:46Z", "author": {"login": "jamesonwilliams"}, "path": "README.md", "diffHunk": "@@ -63,15 +63,15 @@ dependencies section:\n \n ```groovy\n dependencies {\n-    implementation 'com.amplifyframework:core:1.0.0'\n+    implementation 'com.amplifyframework:core:1.1.2'\n \n     // Only specify modules that provide functionality your app will use\n-    implementation 'com.amplifyframework:aws-analytics-pinpoint:1.0.0'\n-    implementation 'com.amplifyframework:aws-api:1.0.0'\n-    implementation 'com.amplifyframework:aws-auth-cognito:1.0.0'\n-    implementation 'com.amplifyframework:aws-datastore:1.0.0'\n-    implementation 'com.amplifyframework:aws-predictions:1.0.0'\n-    implementation 'com.amplifyframework:aws-storage-s3:1.0.0'\n+    implementation 'com.amplifyframework:aws-analytics-pinpoint:1.1.2'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84471661eb2dcb41d761d3a55ce5c552e61c4603"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c52084ed3014b0088846cfc040d11c55afec3a6", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/2c52084ed3014b0088846cfc040d11c55afec3a6", "committedDate": "2020-08-10T17:28:32Z", "message": "Merge branch 'main' of https://github.com/aws-amplify/amplify-android into flutter-user-agent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df41258b0906c4fdfd0c6349325c8f93cf328548", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/df41258b0906c4fdfd0c6349325c8f93cf328548", "committedDate": "2020-08-10T17:40:38Z", "message": "Re-revert the changes from earlier commits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ed468c954c708953554f0a7c0b3516bca9030d1", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/6ed468c954c708953554f0a7c0b3516bca9030d1", "committedDate": "2020-08-10T17:43:15Z", "message": "Minor fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NDQ1MjUw", "url": "https://github.com/aws-amplify/amplify-android/pull/703#pullrequestreview-464445250", "createdAt": "2020-08-10T17:47:47Z", "commit": {"oid": "6ed468c954c708953554f0a7c0b3516bca9030d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04c96ccd713dd796276376d3d8c0c610bb675d58", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/04c96ccd713dd796276376d3d8c0c610bb675d58", "committedDate": "2020-08-10T19:50:48Z", "message": "Add unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ee0e9e5277f72752531fe043e2a4e04c03a4fdd", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/8ee0e9e5277f72752531fe043e2a4e04c03a4fdd", "committedDate": "2020-08-10T20:15:18Z", "message": "Add instrumentation test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ff6f8aae3741370ba6f486fb6a3c89e85171dd5", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/7ff6f8aae3741370ba6f486fb6a3c89e85171dd5", "committedDate": "2020-08-10T20:46:42Z", "message": "add unit test for size limit check"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1922, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}